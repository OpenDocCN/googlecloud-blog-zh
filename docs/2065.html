<html>
<head>
<title>Correlate statement logs in CloudSQL for Postgres with connection sessions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将CloudSQL for Postgres中的语句日志与连接会话相关联</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/correlate-statement-logs-in-cloudsql-for-postgres-with-connection-sessions-5bae4ade38f5?source=collection_archive---------0-----------------------#2022-01-23">https://medium.com/google-cloud/correlate-statement-logs-in-cloudsql-for-postgres-with-connection-sessions-5bae4ade38f5?source=collection_archive---------0-----------------------#2022-01-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1f60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章是<a class="ae jd" href="https://minherz.medium.com/how-cloud-logging-works-series-3aab7e7a1eed" rel="noopener">云日志如何工作</a>系列的一部分。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/6ba46b09523cb1f87a418919b8d5175e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Tqd1ndxNDIVDmHxd"/></div></div></figure><p id="7f69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">CloudSQL for Postgres的特性是将PostgreSQL日志接收到云日志中进行进一步处理。可以使用<a class="ae jd" href="https://cloud.google.com/sql/docs/postgres/flags" rel="noopener ugc nofollow" target="_blank">数据库标志</a>，具体来说就是<a class="ae jd" href="https://cloud.google.com/sql/docs/postgres/pg-audit#enable-auditing-flag" rel="noopener ugc nofollow" target="_blank"> cloudsql.enable_pgaudit </a>来启用。然而，捕获的日志与您可能习惯的离线日志不同。这是因为CloudSQL不支持所有日志相关的配置。例如，CloudSQL for Postgres不支持“log_line_prefix”标志(2022年1月勾选)。在某些情况下，这可以使用CloudSQL的其他功能来缓解。例如，CloudSQL实例标签可以用来替代在每个日志条目前添加应用程序名称。剩下的挑战之一是将日志条目和执行的SQL语句与特定的客户端应用程序会话相关联。本地PostgreSQL可以<a class="ae jd" href="https://www.postgresql.org/docs/current/runtime-config-logging.html#GUC-LOG-LINE-PREFIX" rel="noopener ugc nofollow" target="_blank">配置</a>为每个日志条目添加客户端的“远程主机名或IP地址”前缀。在CloudSQL中，该信息仅在与连接相关的日志条目中可用。要拥有它们，实例必须启用<a class="ae jd" href="https://www.postgresql.org/docs/current/static/runtime-config-logging.html#RUNTIME-CONFIG-LOGGING-WHAT" rel="noopener ugc nofollow" target="_blank"> log_connections </a>数据库标志。</p><p id="d8be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有一种方法可以在SQL语句日志条目和连接日志条目之间创建关联，并将每个执行的语句链接到特定的客户端。pgAudit获取的每个SQL语句日志条目在请求的有效负载中都包含一个名为<code class="du jq jr js jt b">databaseSessionId</code>的字段:</p><pre class="jf jg jh ji fd ju jt jv jw aw jx bi"><span id="6b33" class="jy jz hi jt b fi ka kb l kc kd">request: {<br/>   <a class="ae jd" href="http://twitter.com/type" rel="noopener ugc nofollow" target="_blank">@type</a>: "type.googleapis.com/google.cloud.sql.audit.v1.PgAuditEntry"    <br/>   auditClass: "READ"    <br/>   auditType: "SESSION"    <br/>   chunkCount: 1    <br/>   chunkIndex: 1    <br/>   command: "SELECT"    <br/>   database: "postgres"    <br/>   <strong class="jt hj">databaseSessionId</strong>: 245    <br/>   object: ""    <br/>   objectType: ""    <br/>   parameter: "&lt;not logged&gt;"    <br/>   statement: "SELECT * FROM TEST;"    <br/>   statementId: 2    <br/>   substatementId: 1    <br/>   user: "postgres"    <br/>}</span></pre><p id="e180" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此标识符与连接日志条目的消息有效负载前缀中的值相关联:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ke"><img src="../Images/cce60178adb660d822c8b7d94d1c63da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4CUtwD_m6Z2sfiedZWrKCg.png"/></div></div></figure><p id="3722" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用云日志<a class="ae jd" href="https://cloud.google.com/logging/docs/view/logging-query-language" rel="noopener ugc nofollow" target="_blank">查询语言</a>应该可以找到所有相关的日志条目。如果相关日志被<a class="ae jd" href="https://cloud.google.com/logging/docs/export/bigquery" rel="noopener ugc nofollow" target="_blank">导出到BigQuery </a>，那么就可以创建一个视图，将会话信息添加到每个语句中。</p><p id="12c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">顺便提一下，如果到CloudSQL实例的连接是通过<a class="ae jd" href="https://cloud.google.com/sql/docs/mysql/sql-proxy" rel="noopener ugc nofollow" target="_blank"> Cloud sql-proxy </a>完成的，那么可能需要额外的关联步骤，因为代理连接隐藏了客户端细节。如果你对如何做感兴趣，请告诉我。</p></div></div>    
</body>
</html>