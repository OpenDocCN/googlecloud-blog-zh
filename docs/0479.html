<html>
<head>
<title>MGOB — A MongoDB backup agent for Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MGOB——Kubernetes的MongoDB备份代理</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/mgob-a-mongodb-backup-agent-for-kubernetes-cfc9b30c6c92?source=collection_archive---------2-----------------------#2018-01-02">https://medium.com/google-cloud/mgob-a-mongodb-backup-agent-for-kubernetes-cfc9b30c6c92?source=collection_archive---------2-----------------------#2018-01-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="53a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">MGOB是一个开源的MongoDB备份自动化工具，使用golang构建在mongodump之上。</p><p id="36f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我开始从事这项工作的主要原因是，我希望有一个配备了Prometheus的备份代理，我可以作为StatefulSet运行，并以只能从Kubernetes内部访问的各种MongoDB服务器为目标。</p><p id="a076" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">特点:</p><ul class=""><li id="2f52" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">计划备份</li><li id="f3a7" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">本地备份保留</li><li id="d137" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">上传到S3对象存储(Minio &amp; AWS)</li><li id="c9ba" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">上传到Google云存储</li><li id="d072" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">上传到SFTP</li><li id="7890" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">通过电子邮件和Slack发送通知</li><li id="ab6b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">普罗米修斯仪器</li><li id="291c" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">用于本地备份和日志的http文件服务器</li></ul><p id="26e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是使用StatefulSets和PersistentVolumeClaims在Google Kubernetes引擎上设置MGOB以自动化MongoDB备份的分步指南。</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/1c19c93dbac2a4ef4159e1a892ef8595.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0m2p-rRBy058P25M1X5-0g.png"/></div></div></figure><p id="9de1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">先决条件:</p><ul class=""><li id="a822" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">GKE集群最低版本1.8</li><li id="9d5a" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">kubctl管理配置</li></ul><p id="870e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们开始之前，将mgob存储库和<code class="du kd ke kf kg b">cd</code>克隆到<code class="du kd ke kf kg b">k8s</code>目录:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="bad9" class="kl km hi kg b fi kn ko l kp kq">$ git clone <a class="ae kr" href="https://github.com/stefanprodan/mgob.git" rel="noopener ugc nofollow" target="_blank">https://github.com/stefanprodan/mgob.git</a><br/>$ cd mgob/k8s</span></pre><h2 id="906d" class="kl km hi bd ks kt ku kv kw kx ky kz la iq lb lc ld iu le lf lg iy lh li lj lk bi translated">用k8s-mongo-sidecar创建一个MongoDB副本集</h2><p id="67fd" class="pw-post-body-paragraph if ig hi ih b ii ll ik il im lm io ip iq ln is it iu lo iw ix iy lp ja jb jc hb bi translated">让我们创建一个MongoDB集群，看看备份代理是如何工作的。</p><p id="422a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建<code class="du kd ke kf kg b">db</code>名称空间:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="66cb" class="kl km hi kg b fi kn ko l kp kq">$ kubectl apply -f ./namespace.yaml <br/>namespace "db" created</span></pre><p id="cec7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建<code class="du kd ke kf kg b">ssd</code>和<code class="du kd ke kf kg b">hdd</code>存储类:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="fe58" class="kl km hi kg b fi kn ko l kp kq">$ kubectl apply -f ./storage.yaml <br/>storageclass "ssd" created<br/>storageclass "hdd" created</span></pre><p id="8d05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建<code class="du kd ke kf kg b">startup-script</code> <em class="lq">守护进程设置</em>以在所有主机上禁用hugepage:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="5b2b" class="kl km hi kg b fi kn ko l kp kq">$ kubectl apply -f ./mongo-ds.yaml <br/>daemonset "startup-script" created</span></pre><p id="2526" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个3节点<em class="lq">副本集</em>，每个副本配置一个1Gi SSD磁盘:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="4d6e" class="kl km hi kg b fi kn ko l kp kq">$ kubectl apply -f ./mongo-rs.yaml <br/>service "mongo" created<br/>statefulset "mongo" created<br/>clusterrole "default" configured<br/>serviceaccount "default" configured<br/>clusterrolebinding "system:serviceaccount:db:default" configured</span></pre><p id="99db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的命令为Mongo <em class="lq">副本集</em>创建了一个<em class="lq">无头服务</em>和一个<em class="lq">有状态集</em>，并为Mongo sidecar创建了一个<em class="lq">服务帐户</em>。每个pod包含一个Mongo实例和一个sidecar。边车将初始化<em class="lq">副本集</em>，并在pod启动后立即添加rs成员。您可以安全地放大或缩小<em class="lq">有状态集</em>的副本，边车将添加或删除rs成员。</p><p id="047c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过查看边车日志来监控rs初始化:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="6c7b" class="kl km hi kg b fi kn ko l kp kq">$ kubectl -n db logs mongo-0 mongo-sidecar<br/>Using mongo port: 27017<br/>Starting up mongo-k8s-sidecar<br/>The cluster domain 'cluster.local' was successfully verified.<br/>Pod has been elected for replica set initialization<br/>initReplSet 10.52.2.127:27017</span></pre><p id="1167" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用<code class="du kd ke kf kg b">kubectl</code>检查新创建的集群:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="41c6" class="kl km hi kg b fi kn ko l kp kq">$ kubectl -n db get pods --selector=role=mongo<br/>NAME         READY     STATUS    RESTARTS   AGE<br/>po/mongo-0   2/2       Running   0          8m<br/>po/mongo-1   2/2       Running   0          7m<br/>po/mongo-2   2/2       Running   0          6m</span></pre><p id="119f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">连接到在<code class="du kd ke kf kg b">mongo-0</code> pod中运行的容器，创建一个<code class="du kd ke kf kg b">test</code>数据库并插入一些数据:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="ea35" class="kl km hi kg b fi kn ko l kp kq">$ kubectl -n db exec -it mongo-0 -c mongod mongo<br/>rs0:PRIMARY&gt; use test<br/>rs0:PRIMARY&gt; db.inventory.insert({item: "one", val: "two" })<br/>WriteResult({ "nInserted" : 1 })</span></pre><p id="559b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个MongoDB副本都有自己的DNS地址，如<code class="du kd ke kf kg b">&lt;pod-name&gt;.&lt;service-name&gt;.&lt;namespace&gt;</code>所示。如果您需要从另一个名称空间访问<em class="lq">副本集</em>，请使用以下连接url:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="28c8" class="kl km hi kg b fi kn ko l kp kq">mongodb://mongo-0.mongo.db,mongo-1.mongo.db,mongo-2.mongo.db:27017/dbname_?</span></pre><p id="d894" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过在默认命名空间中创建临时pod来测试连接性:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="9300" class="kl km hi kg b fi kn ko l kp kq">$ kubectl run -it --rm --restart=Never mongo-cli --image=mongo --command -- /bin/bash<br/>root@mongo-cli:/# mongo "mongodb://mongo-0.mongo.db,mongo-1.mongo.db,mongo-2.mongo.db:27017/test"<br/>rs0:PRIMARY&gt; db.getCollectionNames()<br/>[ "inventory" ]</span></pre><p id="a3a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">mongo-k8s边车<a class="ae kr" href="https://github.com/cvallance/mongo-k8s-sidecar" rel="noopener ugc nofollow" target="_blank">只处理复制集供应。如果你想在GKE上运行一个分片集群，看看</a><a class="ae kr" href="https://github.com/pkdone/gke-mongodb-shards-demo" rel="noopener ugc nofollow" target="_blank">PK done/gke-MongoDB-shards-demo</a>。</p><h2 id="9ebc" class="kl km hi bd ks kt ku kv kw kx ky kz la iq lb lc ld iu le lf lg iy lh li lj lk bi translated">配置和部署MGOB</h2><p id="0276" class="pw-post-body-paragraph if ig hi ih b ii ll ik il im lm io ip iq ln is it iu lo iw ix iy lp ja jb jc hb bi translated">首先让我们创建两个数据库<code class="du kd ke kf kg b">test1</code>和<code class="du kd ke kf kg b">test2</code>:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="ccff" class="kl km hi kg b fi kn ko l kp kq">$ kubectl -n db exec -it mongo-0 -c mongod mongo<br/>rs0:PRIMARY&gt; use test1<br/>rs0:PRIMARY&gt; db.inventory.insert({item: "one", val: "two" })<br/>WriteResult({ "nInserted" : 1 })<br/>rs0:PRIMARY&gt; use test2<br/>rs0:PRIMARY&gt; db.inventory.insert({item: "one", val: "two" })<br/>WriteResult({ "nInserted" : 1 })</span></pre><p id="0343" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个配置图，为<code class="du kd ke kf kg b">test1</code>安排每分钟备份，为<code class="du kd ke kf kg b">test2</code>安排每两分钟备份:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="1630" class="kl km hi kg b fi kn ko l kp kq">kind: ConfigMap<br/>apiVersion: v1<br/>metadata:<br/>  labels:<br/>    role: backup<br/>  name: mgob-config<br/>  namespace: db<br/>data:<br/>  test1.yml: |<br/>    target:<br/>      host: "mongo-0.mongo.db,mongo-1.mongo.db,mongo-2.mongo.db"<br/>      port: 27017<br/>      database: "test1"<br/>    scheduler:<br/>      cron: "* * * * *"<br/>      retention: 5<br/>      timeout: 60<br/>  test2.yml: |<br/>    target:<br/>      host: "mongo-0.mongo.db,mongo-1.mongo.db,mongo-2.mongo.db"<br/>      port: 27017<br/>      database: "test2"<br/>    scheduler:<br/>      cron: "*/2 * * * *"<br/>      retention: 10<br/>      timeout: 60</span></pre><p id="d2a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您有一个分片集群，请确保在<code class="du kd ke kf kg b">host</code>字段中使用mongos地址。MGOB也可以针对受密码保护的数据库，您可以在<code class="du kd ke kf kg b">database</code>之后添加用户名和密码字段。</p><p id="1aa5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">应用配置:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="3a57" class="kl km hi kg b fi kn ko l kp kq">kubectl apply -f ./mgob-cfg.yaml</span></pre><p id="0b50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用两个磁盘部署mgob <em class="lq">无头服务</em>和<em class="lq">有状态集</em>，3Gi用于长期备份存储，1Gi用于运行备份的临时存储:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="29e1" class="kl km hi kg b fi kn ko l kp kq">kubectl apply -f ./mgob-dep.yaml</span></pre><p id="874b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要监视备份，您可以流式传输mgob日志:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="0473" class="kl km hi kg b fi kn ko l kp kq">$ kubectl -n db logs -f mgob-0 <br/>msg="Backup started" plan=test1 <br/>msg="Backup finished in 261.76829ms archive test1-1514491560.gz size 307 B" plan=test1 <br/>msg="Next run at 2017-12-28 20:07:00 +0000 UTC" plan=test1 <br/>msg="Backup started" plan=test2<br/>msg="Backup finished in 266.635088ms archive test2-1514491560.gz size 313 B" plan=test2 <br/>msg="Next run at 2017-12-28 20:08:00 +0000 UTC" plan=test2</span></pre><p id="dbf5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者您可以<code class="du kd ke kf kg b">curl</code>mgob API:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="05ae" class="kl km hi kg b fi kn ko l kp kq">kubectl -n db exec -it mgob-0 -- curl mgob-0.mgob.db:8090/status</span></pre><p id="eeb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们为<code class="du kd ke kf kg b">test2</code>数据库运行一个按需备份:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="d472" class="kl km hi kg b fi kn ko l kp kq">kubectl -n db exec -it mgob-0 -- curl -XPOST mgob-0.mgob.db:8090/backup/test2<br/>{"plan":"test2","file":"test2-1514492080.gz","duration":"61.109042ms","size":"313 B","timestamp":"2017-12-28T20:14:40.604057546Z"}</span></pre><p id="7447" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以从mgob容器中还原备份。Exec进入mgob并确定您想要恢复的备份，备份在<code class="du kd ke kf kg b">/storage/&lt;plan-name&gt;</code>中。</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="eb25" class="kl km hi kg b fi kn ko l kp kq">$ kubectl -n db exec -it mgob-0 /bin/bash<br/>ls -lh /storage/test1<br/>-rw-r--r--    307 Dec 28 20:23 test1-1514492580.gz<br/>-rw-r--r--    162 Dec 28 20:23 test1-1514492580.log<br/>-rw-r--r--    307 Dec 28 20:24 test1-1514492640.gz<br/>-rw-r--r--    162 Dec 28 20:24 test1-1514492640.log</span></pre><p id="a618" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<code class="du kd ke kf kg b">mongorestore</code>连接到您的MongoDB服务器并恢复备份:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="3f75" class="kl km hi kg b fi kn ko l kp kq">$ kubectl -n db exec -it mgob-0 /bin/bash<br/>mongorestore --gzip --archive=/storage/test1/test1-1514492640.gz --host mongo-0.mongo.db:27017 --drop</span></pre><h2 id="dde0" class="kl km hi bd ks kt ku kv kw kx ky kz la iq lb lc ld iu le lf lg iy lh li lj lk bi translated">监控和警报</h2><p id="3495" class="pw-post-body-paragraph if ig hi ih b ii ll ik il im lm io ip iq ln is it iu lo iw ix iy lp ja jb jc hb bi translated">对于每个备份计划，您可以通过电子邮件或Slack配置警报:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="ea34" class="kl km hi kg b fi kn ko l kp kq"># Email notifications (optional)<br/>smtp:<br/>  server: smtp.company.com<br/>  port: 465<br/>  username: user<br/>  password: secret<br/>  from: mgob@company.com<br/>  to:<br/>    - devops@company.com<br/>    - alerts@company.com<br/># Slack notifications (optional)<br/>slack:<br/>  url: <a class="ae kr" href="https://hooks.slack.com/services/xxxx/xxx/xx" rel="noopener ugc nofollow" target="_blank">https://hooks.slack.com/services/xxxx/xxx/xx</a><br/>  channel: devops-alerts<br/>  username: mgob<br/>  # 'true' to notify only on failures <br/>  warnOnly: false</span></pre><p id="aa3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Mgob在<code class="du kd ke kf kg b">/metrics</code>端点上公开普罗米修斯指标。</p><p id="54a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">成功/失败的备份计数器:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="b402" class="kl km hi kg b fi kn ko l kp kq">mgob_scheduler_backup_total{plan="test1",status="200"} 8<br/>mgob_scheduler_backup_total{plan="test2",status="500"} 2</span></pre><p id="065e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">备份持续时间:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="696d" class="kl km hi kg b fi kn ko l kp kq">mgob_scheduler_backup_latency{plan="test1",status="200",quantile="0.5"} 2.149668417<br/>mgob_scheduler_backup_latency{plan="test1",status="200",quantile="0.9"} 2.39848413<br/>mgob_scheduler_backup_latency{plan="test1",status="200",quantile="0.99"} 2.39848413</span></pre><h2 id="b494" class="kl km hi bd ks kt ku kv kw kx ky kz la iq lb lc ld iu le lf lg iy lh li lj lk bi translated">备份到GCP存储桶</h2><p id="e68b" class="pw-post-body-paragraph if ig hi ih b ii ll ik il im lm io ip iq ln is it iu lo iw ix iy lp ja jb jc hb bi translated">对于长期备份存储，您可以使用GCP存储桶，因为这比将所有备份保存在磁盘上更便宜。</p><p id="eb79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，您需要从<code class="du kd ke kf kg b">API &amp; Services</code>页面创建一个GCP服务帐户密钥。下载JSON文件，重命名为<code class="du kd ke kf kg b">service-account.json</code>。</p><p id="dc4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将JSON文件作为秘密存储在<code class="du kd ke kf kg b">db</code>名称空间中:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="b08d" class="kl km hi kg b fi kn ko l kp kq">kubectl -n db create secret generic gcp-key --from-file=service-account.json=service-account.json</span></pre><p id="c351" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从GCP web UI中，导航到<em class="lq">存储</em>并创建一个名为<code class="du kd ke kf kg b">mgob</code>的区域存储桶。如果存储桶名称被占用，您需要在<code class="du kd ke kf kg b">mgob-gstore-cfg.yaml</code>文件中更改它:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="ca9e" class="kl km hi kg b fi kn ko l kp kq">kind: ConfigMap<br/>apiVersion: v1<br/>metadata:<br/>  labels:<br/>    role: mongo-backup<br/>  name: mgob-gstore-config<br/>  namespace: db<br/>data:<br/>  test.yml: |<br/>    target:<br/>      host: "mongo-0.mongo.db,mongo-1.mongo.db,mongo-2.mongo.db"<br/>      port: 27017<br/>      database: "test"<br/>    scheduler:<br/>      cron: "*/1 * * * *"<br/>      retention: 1<br/>      timeout: 60<br/>    gcloud:<br/>      bucket: "mgob"<br/>      keyFilePath: /etc/mgob/service-account.json</span></pre><p id="8fb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">应用配置:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="e370" class="kl km hi kg b fi kn ko l kp kq">kubectl apply -f ./mgob-gstore-cfg.yaml</span></pre><p id="ab6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将带有<code class="du kd ke kf kg b">gcp-key</code>机密映射的mgob部署到卷:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="b32a" class="kl km hi kg b fi kn ko l kp kq">kubectl apply -f ./mgob-gstore-dep.yaml</span></pre><p id="0e32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一分钟后，备份将上传到GCP存储桶:</p><pre class="js jt ju jv fd kh kg ki kj aw kk bi"><span id="c66f" class="kl km hi kg b fi kn ko l kp kq">$ kubectl -n db logs -f mgob-0 <br/>msg="Google Cloud SDK 181.0.0 bq 2.0.27 core 2017.11.28 gsutil 4.28"<br/>msg="Backup started" plan=test<br/>msg="GCloud upload finished Copying file:///storage/test/test-1514544660.gz"</span></pre><h2 id="c895" class="kl km hi bd ks kt ku kv kw kx ky kz la iq lb lc ld iu le lf lg iy lh li lj lk bi translated">结论</h2><p id="4265" class="pw-post-body-paragraph if ig hi ih b ii ll ik il im lm io ip iq ln is it iu lo iw ix iy lp ja jb jc hb bi translated">如果您使用MGOB在Kubernetes上运行MongoDB，您可以轻松地安排保留备份，将它们上传到GCP存储并设置警报。如果您对改进MGOB有任何建议，请在<a class="ae kr" href="https://github.com/stefanprodan/mgob" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上提交问题或PR。非常欢迎投稿！</p></div></div>    
</body>
</html>