<html>
<head>
<title>Importing data from GCS to Bigquery (via Spark BQ connector) using Dataproc Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dataproc无服务器将数据从GCS导入Bigquery(通过Spark BQ连接器)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/importing-data-from-gcs-to-bigquery-via-spark-bq-connector-using-dataproc-serverless-25e29f84888d?source=collection_archive---------2-----------------------#2022-11-23">https://medium.com/google-cloud/importing-data-from-gcs-to-bigquery-via-spark-bq-connector-using-dataproc-serverless-25e29f84888d?source=collection_archive---------2-----------------------#2022-11-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/0c64cbe368912a30b2179f0bd6aa1d02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*a2FFhxDQwXPJMWJy.png"/></div></div></figure><p id="12f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在无服务器处理时代，在专用集群上运行Spark作业会增加更多的处理开销，并占用开发人员宝贵的开发时间。将完全托管的随需应变服务器与Spark jobs结合使用，有助于开发人员专注于核心应用程序逻辑，在框架上花费很少或没有时间。谷歌的Dataproc Serverless就是谷歌云平台提供的这样一款产品。</p><p id="b260" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将数据从异构数据源引入Bigquery时，最常见的接收模式是使用GCS作为着陆区，在将数据加载到bigquery表(ETL)或直接加载到bigquery表并进行转换(ELT)之前，可以从这里转换数据。</p><p id="ecd7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本文中，我们将讨论无服务器Dataproc如何帮助将数据从GCS加载到bigquery，用于ETL或ELT目的。</p><h1 id="6702" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">主要优势</h1><ol class=""><li id="397e" class="km kn hi is b it ko ix kp jb kq jf kr jj ks jn kt ku kv kw bi translated">使用<strong class="is hj"> Dataproc无服务器</strong>运行Spark批处理工作负载，无需管理Spark框架。</li><li id="266c" class="km kn hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated"><a class="ae lc" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/src/main/java/com/google/cloud/dataproc/templates/gcs/GCStoBigquery.java" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">gcstobiqquery</strong></a>模板是开源的，配置驱动的，随时可以使用。执行代码只需要GCS凭证。</li><li id="0c4f" class="km kn hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">支持的文件格式有Avro、Parquet和CSV。</li><li id="e813" class="km kn hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated"><a class="ae lc" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/src/main/java/com/google/cloud/dataproc/templates/bigquery/BigQueryToGCS.java" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> BigqueryToGCS </strong> </a>模板可以反过来使用，即通过JDBC将数据从数据库导出到GCS存储桶。</li></ol><h1 id="e980" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">使用</h1><ol class=""><li id="a098" class="km kn hi is b it ko ix kp jb kq jf kr jj ks jn kt ku kv kw bi translated">如果你要使用“默认的”由GCP生成的VPC网络，请确保你已经启用了私有谷歌访问子网。您仍然需要启用如下的私人访问。</li></ol><figure class="le lf lg lh fd ij er es paragraph-image"><div class="er es ld"><img src="../Images/cb458f67d72301f15b6a6e6d42008504.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/0*3kMJOzRgSwikqm-L.png"/></div></figure><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="9c95" class="ln jp hi lj b fi lo lp l lq lr">gcloud compute networks subnets update default --region=us-central1 --enable-private-ip-google-access</span></pre><p id="9ed9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.为jar文件创建一个GCS存储桶和暂存位置。</p><p id="8477" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.在预装了<a class="ae lc" href="https://cloud.google.com/shell/docs/how-cloud-shell-works" rel="noopener ugc nofollow" target="_blank">各种工具</a>的云壳中克隆git repo。或者使用任何预装JDK 8+，Maven和Git的机器。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="b783" class="ln jp hi lj b fi lo lp l lq lr">git clone <a class="ae lc" href="https://github.com/GoogleCloudPlatform/dataproc-templates.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/dataproc-templates.git</a>cd dataproc-templates/java</span></pre><p id="bcdd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.获取身份验证凭据(以提交作业)。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="50ef" class="ln jp hi lj b fi lo lp l lq lr">gcloud auth application-default login</span></pre><p id="777e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.执行GCSToBigquery模板。<br/>例如:</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="71db" class="ln jp hi lj b fi lo lp l lq lr">export GCP_PROJECT=my-gcp-project<br/>export REGION=us-central1<br/>export GCS_STAGING_LOCATION=gs://staging-bucket \<br/>export JARS=gs://jar-location/mysql-connector-java-8.0.29.jar<br/>java/bin/start.sh \<br/>-- --template GCSTOBIGQUERY \<br/>--templateProperty project.id=&lt;gcp-project-id&gt; \<br/>--templateProperty gcs.bigquery.input.location=&lt;gcs path&gt; \<br/>--templateProperty gcs.bigquery.input.format=&lt;csv|parquet|avro|orc&gt; \<br/>--templateProperty gcs.bigquery.output.dataset=&lt;datasetId&gt; \<br/>--templateProperty gcs.bigquery.output.table=&lt;tableName&gt; \<br/>--templateProperty gcs.bigquery.temp.bucket.name=&lt;bigquery temp bucket name&gt;</span></pre><p id="2dd1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意</strong>:如果尚未启用，它会要求您启用Dataproc Api。</p><p id="f31d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.到目前为止，这个过程将把数据从您的gcs位置加载到bigquery。如果您想要转换数据，模板提供了一种方法，一旦将源数据加载到数据集中，就可以对其执行自定义sql。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="c8d7" class="ln jp hi lj b fi lo lp l lq lr">--templateProperty gcs.bigquery.temp.table='temporary_view_name' <br/>--templateProperty gcs.bigquery.temp.query='select * from global_temp.temporary_view_name'</span></pre><p id="e09a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上述属性负责在将数据加载到BigQuery时应用一些spark sql转换。唯一需要记住的是，Spark临时视图的名称和查询中的表名应该完全匹配。否则，将会出现如下错误:“找不到表或视图”</p></div></div>    
</body>
</html>