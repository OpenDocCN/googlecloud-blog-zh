<html>
<head>
<title>Developing With Containers Done Right</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">正确使用容器进行开发</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/developing-with-containers-done-right-831a4bae1d28?source=collection_archive---------0-----------------------#2018-12-09">https://medium.com/google-cloud/developing-with-containers-done-right-831a4bae1d28?source=collection_archive---------0-----------------------#2018-12-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/56a1a2ec00c0bb8eeb78f828c66ca4f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*cFb5OnMpZl9rYlXzgsGhYw.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated">建造和运输。建造和运输。冲洗并重复。</figcaption></figure><p id="1f5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这篇文章的目标是为开发人员和开发团队建立一个无缝的、非侵入性的工作流程，通过GKE来使用Kubernetes。该工作流最终将以一种安全的、最低特权的格式，不加修改地集成到一组不可信和可信环境中。唯一的补充是，开发人员可能不会自己直接提供集群，尽管这取决于组织和如何建立信任。以下是我们将构建的内容:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es jo"><img src="../Images/8b2ce451ee2b6f341d097e2aa40f1653.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ls-BsgqmUhUtTZ0m"/></div></div></figure><p id="8e88" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意，如果愿意的话，完全可以利用外部Git存储库(例如GitHub)来代替云源代码存储库。Google Cloud Build可以直接从GitHub、Google Source Repository(基于git)或BitBucket获取。</p><p id="a55b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这篇文章假设你已经安装了gcloud，并且有一个GCP项目。由于这是一次性安装，我强烈推荐使用Google Cloud Shell，因为它已经预装和配置好了一切。一旦您浏览完本指南，您就可以留在本地。如果您没有gcloud或GCP项目来尝试这一点，请查看以下内容:</p><ul class=""><li id="530a" class="jy jz hi is b it iu ix iy jb ka jf kb jj kc jn kd ke kf kg bi translated">安装gcloud(很简单):https://cloud.google.com/sdk/docs/downloads-interactive<a class="ae kh" href="https://cloud.google.com/sdk/docs/downloads-interactive" rel="noopener ugc nofollow" target="_blank"/></li><li id="884c" class="jy jz hi is b it ki ix kj jb kk jf kl jj km jn kd ke kf kg bi translated">谷歌云免费层(无附加条件):【https://tinyurl.com/ycsln48r T4】</li></ul><p id="7590" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们开始吧。调配GKE群集(这将花费3分钟或更少的时间！):</p><pre class="jp jq jr js fd kn ko kp kq aw kr bi"><span id="ddd8" class="ks kt hi ko b fi ku kv l kw kx">gcloud container clusters create dev-cluster --zone=us-central1-a</span></pre><p id="d240" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">检索群集凭据:</p><pre class="jp jq jr js fd kn ko kp kq aw kr bi"><span id="dd78" class="ks kt hi ko b fi ku kv l kw kx">gcloud container clusters get-credentials dev-cluster --zone=us-central1-a</span></pre><p id="5cdd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于Google Cloud热衷于最小特权和安全性，我们需要给予云构建许可来部署到我们的集群:</p><pre class="jp jq jr js fd kn ko kp kq aw kr bi"><span id="0a55" class="ks kt hi ko b fi ku kv l kw kx">PROJECT="$(gcloud projects describe \<br/>    $(gcloud config get-value core/project -q) --format='get(projectNumber)')"</span><span id="1108" class="ks kt hi ko b fi ky kv l kw kx">gcloud projects add-iam-policy-binding $PROJECT --member=serviceAccount:$PROJECT@cloudbuild.gserviceaccount.com --role=roles/container.developer</span></pre><p id="518c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们来看看示例repo，它包含一个基本的web应用程序、一些Kubernetes部署清单和一个cloudbuild.yaml文件，该文件允许我们利用Google Cloud Build进行自动构建，并通过简单的Git推送部署到Kubernetes集群中:</p><pre class="jp jq jr js fd kn ko kp kq aw kr bi"><span id="5a4a" class="ks kt hi ko b fi ku kv l kw kx">git clone <a class="ae kh" href="https://github.com/tariq-islam/hello-world-nginx" rel="noopener ugc nofollow" target="_blank">https://github.com/tariq-islam/hello-world-nginx</a> -b devflow</span><span id="523f" class="ks kt hi ko b fi ky kv l kw kx">cd hello-world-nginx</span></pre><p id="3e08" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们开始迭代开发之前，我们需要在集群中快速实例化我们的初始部署，以便将来的部署有所参考，我们有一个一致的终点，这样我们就不必担心以后的事情:</p><pre class="jp jq jr js fd kn ko kp kq aw kr bi"><span id="7b39" class="ks kt hi ko b fi ku kv l kw kx">kubectl apply -f .</span></pre><p id="1a55" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们把这些代码放到Google Source Repository (GSR)中，这是一个托管在GCP的git repo。如果你想使用你已经拥有的另一个代码树，或者将这个代码树复制到你的GitHub中，你也可以使用GitHub源代码库。对于这些说明，我们假设是GSR。通过运行以下命令开始:</p><pre class="jp jq jr js fd kn ko kp kq aw kr bi"><span id="88bd" class="ks kt hi ko b fi ku kv l kw kx">gcloud source repos create hello-world-nginx</span></pre><p id="5a5f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们对新创建的GSR repo进行身份验证，并将我们的代码添加到:</p><pre class="jp jq jr js fd kn ko kp kq aw kr bi"><span id="71ee" class="ks kt hi ko b fi ku kv l kw kx">git config --global credential.https://source.developers.google.com.helper gcloud.sh</span><span id="961a" class="ks kt hi ko b fi ky kv l kw kx">git remote add google <a class="ae kh" href="https://source.developers.google.com/p/certstudy-env/r/hello-world-nginx" rel="noopener ugc nofollow" target="_blank">https://source.developers.google.com/p/&lt;YOUR PROJECT ID&gt;/r/hello-world-nginx</a></span><span id="b592" class="ks kt hi ko b fi ky kv l kw kx">git push --all google</span></pre><p id="2e5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想使用不同的代码树，只需复制cloudbuild.yaml和cloudbuild-deploy.yaml文件，从现在开始，说明是类似的，只是不是在GSR中创建新的repo，而是创建Google Cloud Build触发器，直接指向GitHub repo，而不是我们现在要做的GSR中的repo。</p><p id="5cbe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">导航到Google Cloud Build(并在提示时启用API):</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es kz"><img src="../Images/54e67737b3bd9aacb063d999748c54ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*D6EAxa7w2DLTXmqt"/></div></div></figure><p id="48be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在“云构建”页面上，通过单击左侧导航栏上的图标导航至“触发器”页面:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es la"><img src="../Images/e17d6807ee899a86026e16680b040050.png" data-original-src="https://miro.medium.com/v2/resize:fit:452/0*hwQSd91b_oDwAk0_"/></div></figure><p id="f070" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">选择“创建触发器”</p><p id="e904" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下一页选择“云源存储库”:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es lb"><img src="../Images/24007d28b5d62122526cdc5eadd3a40c.png" data-original-src="https://miro.medium.com/v2/resize:fit:838/0*rAsUJjk59GjRMASJ"/></div></div></figure><p id="42ed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从下一页的列表中选择“hello-world-nginx”repo。</p><p id="d8fe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此时，为您的触发器提供以下信息:</p><ol class=""><li id="6ce2" class="jy jz hi is b it iu ix iy jb ka jf kb jj kc jn lc ke kf kg bi translated">名字</li><li id="0194" class="jy jz hi is b it ki ix kj jb kk jf kl jj km jn lc ke kf kg bi translated">分支(保留默认通配符)</li><li id="9414" class="jy jz hi is b it ki ix kj jb kk jf kl jj km jn lc ke kf kg bi translated">选择“cloudbuild.yaml”</li><li id="3647" class="jy jz hi is b it ki ix kj jb kk jf kl jj km jn lc ke kf kg bi translated">指定“cloudbuild-deploy.yaml ”,因为我们希望构建我们的映像并将其部署到我们的GKE集群</li><li id="b673" class="jy jz hi is b it ki ix kj jb kk jf kl jj km jn lc ke kf kg bi translated">选择“创建触发器”</li></ol><p id="e584" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是cloudbuild-deploy.yaml文件，它将为您的触发器提供从源构建映像并将其部署到集群所需的信息:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es ld"><img src="../Images/d622b131eb9aa87567c5390a45cf02b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_COItVOzctHcz_ucHoEM_Q.png"/></div></div></figure><p id="c611" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，有几个带尖括号的地方需要填写您的区域、项目名称和集群名称的信息。完成后，提交并推送您的更新，云构建应该会根据您的推送触发和部署。那是你的心流。按下按钮，几秒钟后您就可以开始部署了。这篇文章只是带你完成一次性设置，然后你可以设置它，忘记它，专注于你的代码，同时享受以容器为中心的开发的好处。</p><p id="faf4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个流程有十几种排列方式，这取决于你想在本地管理和定制多少，或者让谷歌云为你管理多少。这恰好是主要利用Google Cloud工具的最自动化和最直接的工作流。这里可以进行优化，比如构建缓存以加快构建速度，但这是一个很好的起点。</p><p id="2afd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">哦，如果你没有从cloudconfig-deploy.yaml定义中注意到，我们没有使用docker在Cloud Build中构建我们的容器。</p><p id="b12b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们用的是Kaniko :) 。</p><p id="1586" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">致谢:</p><ul class=""><li id="6a54" class="jy jz hi is b it iu ix iy jb ka jf kb jj kc jn kd ke kf kg bi translated">此处使用的代码回购原本是分叉自:【https://github.com/mattes/hello-world-nginx】T2</li></ul></div></div>    
</body>
</html>