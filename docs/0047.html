<html>
<head>
<title>Service Discovery and Configuration on Google Cloud Platform — Spoiler: It’s built in!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google云平台上的服务发现和配置——剧透:它是内置的！</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/service-discovery-and-configuration-on-google-cloud-platform-spoiler-it-s-built-in-c741eef6fec2?source=collection_archive---------0-----------------------#2016-01-07">https://medium.com/google-cloud/service-discovery-and-configuration-on-google-cloud-platform-spoiler-it-s-built-in-c741eef6fec2?source=collection_archive---------0-----------------------#2016-01-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2453" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几乎所有分布式云架构都需要服务发现和配置。您不需要硬编码服务的IP地址，也不需要将您的客户端秘密压入git(这都是可怕的事情)，而是依靠一个安全、一致和分散的系统来管理这些配置和环境变量。</p><p id="51f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">许多不同的服务提供这种功能；想到的前三名是<a class="ae jd" href="https://zookeeper.apache.org/" rel="noopener ugc nofollow" target="_blank">动物园管理员</a>、<a class="ae jd" href="https://github.com/coreos/etcd" rel="noopener ugc nofollow" target="_blank"> etcd </a>和<a class="ae jd" href="https://www.consul.io/" rel="noopener ugc nofollow" target="_blank">领事</a>。所有这些真的很棒，有些甚至提供额外的服务，如基于DNS的发现，但它们需要您在您的项目中维护和运行它们，更不用说它们以CPU时间和磁盘空间的形式花费金钱了！</p><p id="d86a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我让你大吃一惊。你知道谷歌云基本上免费给你这个服务吗？是的，你没听错，它就内置在你的谷歌云项目中！最棒的是，你可以在我们所有的计算平台上使用它:应用引擎、计算引擎和容器引擎。</p><p id="0ca6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">叫<a class="ae jd" href="https://cloud.google.com/compute/docs/metadata?hl=en" rel="noopener ugc nofollow" target="_blank">元数据服务器</a>，挺<a class="ae jd" href="https://ahmetalpbalkan.com/blog/comparison-of-instance-metadata-services/" rel="noopener ugc nofollow" target="_blank">牛逼的</a>。</p><h1 id="46a8" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">那么怎么用呢？</h1><p id="dae3" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">元数据有两种类型，<strong class="ih hj">实例元数据</strong>和<strong class="ih hj">项目元数据</strong>。</p><p id="9f92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">实例元数据</strong>主要用于计算引擎。它提供了关于实例的信息，如IP地址、区域、机器类型、网络等。您还可以在创建实例时设置一些自定义元数据。这些环境数据对你的应用非常有用。</p><p id="3846" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">项目元数据</strong>可以被任何app使用；甚至不需要运行在谷歌云平台上！它为您的应用程序(或多个应用程序)提供了一组共享的环境变量和配置，它们可以以安全的方式访问。它使用您已经在App Engine、Compute Engine和Container Engine上使用的内置OAuth和服务帐户，因此它超级容易使用！这是我将在这篇文章的剩余部分关注的。</p><h1 id="2e57" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置项目元数据:</h1><p id="d669" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">设置元数据最简单的方法是使用gcloud命令行工具或web上的<a class="ae jd" href="https://console.cloud.google.com/compute/metadata" rel="noopener ugc nofollow" target="_blank">开发者控制台</a>。如果你想自动化这些东西，你也可以使用<a class="ae jd" href="https://cloud.google.com/compute/docs/api/libraries?hl=en#google_api_client_libraries" rel="noopener ugc nofollow" target="_blank">计算引擎API </a>。</p><p id="7795" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://console.cloud.google.com/compute/metadata" rel="noopener ugc nofollow" target="_blank">开发者控制台</a>不言自明:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/143f9c0a2a401b85c8c19e5be35f8b6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fLzBAtTHnG-dR8LEedAHrQ.png"/></div></div></figure><p id="c078" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是使用命令行的方法:</p><h2 id="ca29" class="kt jf hi bd jg ku kv kw jk kx ky kz jo iq la lb js iu lc ld jw iy le lf ka lg bi translated">添加或更新:</h2><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="0ea7" class="kt jf hi li b fi lm ln l lo lp">$ gcloud compute project-info add-metadata --metadata &lt;KEY&gt;=&lt;VALUE&gt;</span></pre><h2 id="ffde" class="kt jf hi bd jg ku kv kw jk kx ky kz jo iq la lb js iu lc ld jw iy le lf ka lg bi translated">删除:</h2><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="6a1b" class="kt jf hi li b fi lm ln l lo lp">$ gcloud compute project-info remove-metadata --key &lt;KEY&gt;</span></pre><h1 id="f07d" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">获取项目元数据:</h1><h1 id="6efa" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">计算引擎、容器引擎和托管虚拟机</h1><p id="a6be" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">借助计算引擎、容器引擎和托管虚拟机，您可以通过一个神奇的URL来获取元数据。身份验证是透明的！你只需要记住设置“Metadata-Flavor”头。</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="8dbb" class="kt jf hi li b fi lm ln l lo lp">$ curl “http://metadata/computeMetadata/v1/project/&lt;KEY&gt;/" \<br/>     -H “Metadata-Flavor: Google”</span></pre><p id="3510" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这意味着您可以使用任何能够调用REST API的编程语言(即所有的调用)来查询元数据服务器！</p><h1 id="0d71" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">应用引擎和其他一切</h1><p id="c130" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">神奇的URL仅适用于计算引擎、容器引擎和托管虚拟机。如果在App Engine中运行或者进行本地开发，需要使用OAuth安全地连接到元数据服务器。</p><p id="49ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最简单的方法是使用一个<a class="ae jd" href="https://cloud.google.com/compute/docs/api/libraries?hl=en#google_api_client_libraries" rel="noopener ugc nofollow" target="_blank">计算引擎API </a>库。对于运行在Google Cloud上的所有东西，您应该能够使用应用程序默认凭证来连接到服务。否则，您可以下载一个JSON密钥文件(称为服务帐户)并使用它进行身份验证。</p><p id="a516" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://developers.google.com/identity/protocols/OAuth2" rel="noopener ugc nofollow" target="_blank">这里有一个关于连接和验证Google APIs的很好的资源，你可以参考。</a></p><p id="856b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://github.com/thesandlord/samples/tree/master/app-engine-metadata" rel="noopener ugc nofollow" target="_blank">我还在Go </a>中编写了一些示例代码，演示了App Engine应用程序如何访问元数据服务器。只需使用<em class="lq"> getMetadata </em>函数获取所有元数据！</p><h1 id="6ba4" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">但是等等！还有呢！</h1><p id="45aa" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在我结束之前，我想谈谈一个超级酷的特性:“等待改变”。这使您能够在元数据值改变时获得更新！点击查看详情<a class="ae jd" href="https://cloud.google.com/compute/docs/metadata?hl=en#waitforchange" rel="noopener ugc nofollow" target="_blank">。由于应用引擎的性质，这可能不会在那里工作得很好，但它将在计算引擎、容器引擎和托管虚拟机上工作得很好。</a></p><p id="88a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望这条信息对你有用。这绝对是谷歌云平台的一颗隐藏的宝石，也是我们不太谈论的东西！</p></div></div>    
</body>
</html>