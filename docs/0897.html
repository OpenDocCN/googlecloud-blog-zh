<html>
<head>
<title>Simple serverless data pipeline on Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google云平台上简单的无服务器数据管道</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/simple-serverless-data-pipeline-on-google-cloud-platform-ab8941ce0f8e?source=collection_archive---------0-----------------------#2019-01-31">https://medium.com/google-cloud/simple-serverless-data-pipeline-on-google-cloud-platform-ab8941ce0f8e?source=collection_archive---------0-----------------------#2019-01-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f0f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我以前的<a class="ae jd" rel="noopener" href="/google-cloud/bigquery-public-datasets-metadata-788c2c3897b2">文章</a>中，我写了关于创建数据管道来定期获取关于BigQuery公共数据集的信息，并将它们插入到一个BigQuery表中。在这篇文章中，我想描述它是如何设计的。这不是火箭科学，而是如何创建无服务器管道的例子。一切运行在谷歌云平台上，成本0美元。完整代码在这里<a class="ae jd" href="https://github.com/zdenulo/bigquery_public_datasets_metadata" rel="noopener ugc nofollow" target="_blank">https://github . com/zde nulo/big query _ public _ datasets _ metadata</a>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/6d6897d8610d4aacbc2a8718c403c6aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*6ooCrJjCszf4o6jK.png"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">管道图</figcaption></figure><p id="a058" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将简要描述如何设置每个组件。</p><h2 id="6cb9" class="jq jr hi bd js jt ju jv jw jx jy jz ka iq kb kc kd iu ke kf kg iy kh ki kj kk bi translated">云调度程序</h2><p id="3237" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">云调度器定期触发云发布/订阅上的主题，云发布/订阅在主要部分发生的地方执行云功能(从BigQuery读取信息并写回)。云调度程序可以通过HTTP请求直接触发云功能，但它不是通过发布/订阅来触发，因为这样一来，云功能不会暴露于互联网，而是只能通过发布/订阅来触发。小小的安保细节。</p><p id="0a45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在云调度程序中创建作业的命令将触发发布主题为:</p><pre class="jf jg jh ji fd kq kr ks kt aw ku bi"><span id="80bb" class="jq jr hi kr b fi kv kw l kx ky">gcloud alpha scheduler jobs create pubsub bq-public-dataset-job --schedule="0 */4 * * *" --topic="bq-ingest" --message-body=" "</span></pre><p id="5555" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">带输出:</p><pre class="jf jg jh ji fd kq kr ks kt aw ku bi"><span id="eb09" class="jq jr hi kr b fi kv kw l kx ky">pubsubTarget:<br/>  data: IA==<br/>  topicName: projects/adventures-on-gcp/topics/bq-ingest<br/>retryConfig:<br/>  maxBackoffDuration: 3600s<br/>  maxDoublings: 16<br/>  maxRetryDuration: 0s<br/>  minBackoffDuration: 5s<br/>schedule: 0 */4 * * *<br/>state: ENABLED<br/>timeZone: Etc/UTC<br/>userUpdateTime: '2019-01-14T22:32:59Z'</span></pre><p id="44b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者使用web用户界面:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es kz"><img src="../Images/2576a5f820b166a6ee2d99198aee7ad9.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/0*p7wJ32wu6kwb-_6z.png"/></div></figure><p id="068e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于这些设置，云调度程序将每4小时在整点向PubSub发布消息。次要的细节是，当我通过gcloud创建调度程序作业时，pubsub消息(有效负载)的内容可以是一个空格" "(它不接受空字符串)。当它通过Web UI完成时，有效负载中的一些文本需要被写入。</p><h2 id="9a8c" class="jq jr hi bd js jt ju jv jw jx jy jz ka iq kb kc kd iu ke kf kg iy kh ki kj kk bi translated">公共订阅</h2><p id="db25" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">下一步是创建在云调度程序设置中定义的发布订阅主题。</p><pre class="jf jg jh ji fd kq kr ks kt aw ku bi"><span id="8019" class="jq jr hi kr b fi kv kw l kx ky">gcloud pubsub topics create bq-ingest</span></pre><p id="303e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">带输出:</p><pre class="jf jg jh ji fd kq kr ks kt aw ku bi"><span id="2343" class="jq jr hi kr b fi kv kw l kx ky">Created topic [projects/adventures-on-gcp/topics/bq-ingest].</span></pre><h2 id="d358" class="jq jr hi bd js jt ju jv jw jx jy jz ka iq kb kc kd iu ke kf kg iy kh ki kj kk bi translated">云函数</h2><p id="b5ba" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">下一步是创建和上传云函数，每当消息发布到我们在云调度程序中创建的发布订阅主题时，该函数都会运行。代码在<a class="ae jd" href="https://github.com/zdenulo/bigquery_public_datasets_metadata/blob/master/bq_metadata.py" rel="noopener ugc nofollow" target="_blank"> Github </a>上，主脚本由3部分组成。第一步是从公共数据集获取数据，第二步是将数据上传到Google云存储，第三步是启动将数据从该文件上传到BigQuery的作业。</p><p id="7e5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从文件夹代码通过gcloud上传到云功能:</p><pre class="jf jg jh ji fd kq kr ks kt aw ku bi"><span id="176c" class="jq jr hi kr b fi kv kw l kx ky">gcloud functions deploy bq_public_metadata  --runtime python37<br/>--trigger-topic bq-ingest --timeout 540</span></pre><p id="8d5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我选择运行时为Python 3.7，因为我有用Python写的脚本，接下来是我在上一步中创建的PubSub主题。最后，我将超时设置为540秒，因为脚本需要更长的时间来获取数据，这样函数就不会超时。bq_public_metadata是云函数的名称，也是main.py文件中函数的名称。</p><p id="bd6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仅此而已。</p></div></div>    
</body>
</html>