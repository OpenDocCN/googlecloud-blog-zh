# 探索 PCI 和 PCIe 的细微差别

> 原文：<https://medium.com/google-cloud/exploring-the-nuances-of-pci-and-pcie-7edf44acef94?source=collection_archive---------0----------------------->

在谷歌云，我们最近开始向 GCP 客户提供使用 GPU 的能力。但在我们这样做之前，我们需要 100%确定这些通过 PCI Express (PCIe)连接的设备不会受到威胁。这导致我们的团队探索 PCIe 规范及其前身 PCI 规范的细微差别，为构建一个软件模糊器来测试拟议的设备做准备。以下是我们发现的一些例子，重点是安全性。

# 然后:PCI

如果您在 90 年代在计算机中安装新的声卡、网络卡或视频卡，它可能是根据旧的 PCI 标准构建的，该标准描述了如何通过物理线路将这些设备链接到计算机的其他部分。

PCI 在当时是令人兴奋的。PCI 设备比按照以前的 ISA 标准制造的设备更容易安装。当 ISA 设备插入 I/O 总线时，计算机可以通过总线上的匹配地址进行通信来访问它。但是很难预先知道什么设备会响应请求，设备在 I/O 空间中的位置，计算机是否有正确的驱动程序与 ISA 卡交互，或者设备是否能避免相互冲突。

PCI 通过引入“配置空间”的概念改变了这一点，配置空间是设备区域上的一组寄存器，它允许系统向卡请求有关自身的信息，并相应地做出响应。

PCI 也比它的前辈有更大的带宽，因此它很快变得无处不在。然而，随着时间的推移，PCI 的局限性变得更加明显:

*   一组 PCI 设备的速度被限制为总线上最慢设备的速度。连接一个过时的外围设备会降低所有设备的速度。
*   与此同时，随着千兆位以太网的普及，对速度的需求空前高涨，而 PCI 设备却跟不上。

需要一个新的标准。

# 现在:PCIe

为了克服 PCI 的局限性，PCIe 需要解决总线共享和总线争用的问题。

当多个设备在同一个 PCI 总线上时，PCI 被迫“减速”并与总线上最慢设备的速度相匹配。PCIe 用一些电子小聪明来解决这个问题。通过使用 [8b/10b 线路代码](https://en.wikipedia.org/wiki/8b/10b_encoding)对数据进行编码，PCIe 能够在一个信号中对数据和时钟信息进行编码，无需外部时钟，大大增加了潜在带宽。([PCIe](https://en.wikipedia.org/wiki/PCI_Express#History_and_revisions)的更新版本在此基础上继续改进；PCIe 3.0 及更高版本采用 128b/130b 编码，传输速率更快。)

此外，PCIe 需要一种方法来处理高速数据流。如果一个设备没有足够的缓冲来包含它想要的所有数据——比如说，高清视频——那么你自然会希望该设备持续传输数据。然而，当该设备忙于传输大量数据时，它会束缚总线，阻止所有其他设备做任何事情。PCIe 通过允许*数据包分段*来解决这个问题，将数据流分解成更小的数据包，这些数据包可以通过 PCIe 结构下的事务层协议进行传输。

因此，更容易把 PCIe 想象成一个网络，而不是一条物理总线。每个设备都有一个地址，规范描述了流量控制、错误检测和重新传输的功能，这些功能在 PCI 中都不存在。

对于像 GPU 这样对性能敏感的设备来说，这都是好消息。然而，它也引入了一系列的安全问题。

# 聚焦 PCIe

安全社区已经注意到，[标准和规范通常以可证明的设计漏洞的形式包含容易获得的成果](http://cc.thinkst.com/talk/view/50835/)。我们的团队花了大量的时间梳理规范，寻找要防御的边缘案例和缺口。

在规范中一个无关紧要的部分，有一个例子是关于多播 TLP 的说明:

"除了 ACS 源验证，ACS 访问控制不适用于多播 TLP(见 6.14 节)，对它们没有影响。"

这些 TLP 必须免于 ACS 控制是不直观的。幸运的是，通过将设备分配到允许相互多播的“多播组”,有一个单独的机制来保护多播 TLP。然而，这需要系统设计者和管理员进行额外的规划和努力。

仔细阅读 PCIe 规范揭示了多个类似的边缘案例，这对确保这些设备的安全至关重要。

**规格复杂性**

[PCIe 规范](https://members.pcisig.com/wg/PCI-SIG/document/download/8257)跨越了一千多页，涵盖了错误处理、数据和事务层设计、物理链路结构、几十个功能寄存器等等——这还只是规范。规范的实现可能会有所不同，并引入额外的复杂性。要了解该规范在特定器件中如何实现的细节——哪些寄存器对应于哪些 PCIe 设置，哪些寄存器由基址寄存器访问，等等——您必须打开该器件的手册。这些手册通常包含数百个附加页面，安全团队在测试设备时需要参考这些页面。

**勘误表和更新**

PCIe 现在是一个老标准。最初创建于 2003 年，十多年来一直在修订、更新和扩展，[最近一次更新是在 2016 年 12 月](https://pcisig.com/specifications/pciexpress?field_technology_value%5B%5D=express&speclib=)。另外，[每个版本都有大量的勘误表](https://pcisig.com/sites/default/files/specification_documents/PCIe_Base_r3%201_Errata_2015-09-18_clean.pdf)。从安全的角度来看，这些更改中的大部分是无害的，但是检查将漏洞作为其他更改的意外后果引入的修订仍然很重要。

**网络架构**

PCIe 像一个网络一样运行，以 TLP(事务层数据包)和 DLLPs(数据链路层数据包)的形式完成自己的协议。这种方法有一些安全好处。如果 PCIe 设备使用传统的硬件总线，就没有有效的方法来处理不可信的设备——没有办法知道数据访问来自哪里。相比之下，网络体系结构允许我们查看每个数据包的源 ID 和目的 ID，并允许我们在每个交换机上管理是否希望数据包继续前进到目的地。这提供了一种降低恶意设备行为风险的机制。但是，这也导致了额外的复杂性，必须小心管理以限制安全风险。

**有限集成安全性**

PCIe 有一套被称为访问控制服务(ACS)的功能，这个名称表明它可能为保护 PCIe 设备提供一个方便、明确的解决方案。然而，PCIe 工作组并没有一套正式的指导原则，来说明在云中安全运行设备需要 ACS 设置的哪些子集。此外，查看最初的 ACS 提案，我们会发现设备安全性只是 ACS 目的的一部分。所描述的一些项目是面向安全的，例如下游组件之间请求的权限验证，但其他项目则侧重于优雅地处理损坏或故障设备，例如减轻数据包损坏的影响。发生故障的设备会造成伤害；然而，恶意设备也是一个严重的问题。我们着重于探索 ACS 作为防范有动机的攻击者的安全措施的功效。

以此为背景，我们开始建造我们的 fuzzer。有关我们如何做到这一点的更多信息，请查看谷歌云平台博客上的[“模糊 PCI Express:明文安全”](https://cloudplatform.googleblog.com/2017/02/fuzzing-PCI-Express-security-in-plaintext.html)。