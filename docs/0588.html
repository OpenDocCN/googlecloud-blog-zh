<html>
<head>
<title>A Guide to Deploy Elasticsearch Cluster on Google Kubernetes Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google Kubernetes引擎上部署Elasticsearch集群的指南</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/a-guide-to-deploy-elasticsearch-cluster-on-google-kubernetes-engine-52f67743ee98?source=collection_archive---------0-----------------------#2018-04-26">https://medium.com/google-cloud/a-guide-to-deploy-elasticsearch-cluster-on-google-kubernetes-engine-52f67743ee98?source=collection_archive---------0-----------------------#2018-04-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d8e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个简单的指南，帮助你在Google Kubernetes引擎上部署Elasticsearch集群。本指南应该适用于任何Kubernetes集群，只需对持久卷部分进行简单调整。</p><p id="b85d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">总体步骤如下所示:</p><ol class=""><li id="eb0d" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">通过<a class="ae jd" href="https://kubernetes.io/docs/concepts/storage/storage-classes/" rel="noopener ugc nofollow" target="_blank">存储类</a>启用持久卷。</li><li id="33af" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">通过<a class="ae jd" href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services" rel="noopener ugc nofollow" target="_blank">无头服务</a>启用Elasticsearch节点发现。</li><li id="1610" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">通过<a class="ae jd" href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" rel="noopener ugc nofollow" target="_blank">有状态集</a>部署Elasticsearch集群。</li></ol><h1 id="4d28" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">1.持久卷</h1><p id="fab9" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">第一步是在集群上创建一个存储类。用以下内容创建名为<code class="du kv kw kx ky b">storage.yaml</code>的新文件:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="ee3b" class="lh jt hi ky b fi li lj l lk ll">kind: StorageClass<br/>apiVersion: storage.k8s.io/v1<br/>metadata:<br/>  name: ssd<br/>provisioner: kubernetes.io/gce-pd<br/>parameters:<br/>  type: pd-ssd<br/>  zone: asia-southeast1-a</span></pre><p id="1745" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，我们使用的存储类<code class="du kv kw kx ky b">provisioner</code>是GCE ( <code class="du kv kw kx ky b">kubernetes.io/gce-pd</code>)，具有以下参数:</p><ol class=""><li id="4078" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated"><code class="du kv kw kx ky b">type: pd-ssd</code>启用SSD作为持久磁盘。您可以用<code class="du kv kw kx ky b">type: pd-standard</code>更新参数类型，使标准磁盘成为持久磁盘</li><li id="5ab2" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><code class="du kv kw kx ky b">zone: asia-southeast1-a</code>为计算区。您可以将其更新到您计算区域。您也可以将<code class="du kv kw kx ky b">zones</code>参数用于多个区域，如下所示:<code class="du kv kw kx ky b">zones: asia-southeast1-a, asia-southeast1-b</code>。</li></ol><p id="d8be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后使用以下命令启用存储类:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="6246" class="lh jt hi ky b fi li lj l lk ll">kubectl apply -f storage.yaml</span></pre><p id="9835" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该能够在<a class="ae jd" href="https://console.cloud.google.com/kubernetes/storage" rel="noopener ugc nofollow" target="_blank">控制面板</a>上看到存储类:</p><figure class="kz la lb lc fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lm"><img src="../Images/7132de1ce60e466cfa9fb026c53aee2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W1ne7-zQtj4CY7IcaiUStA.png"/></div></div><figcaption class="lu lv et er es lw lx bd b be z dx translated">my Laniakea集群上的存储类</figcaption></figure><p id="3430" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您在非Google Kubernetes引擎上部署Elasticsearch集群，请更新置备程序和参数。您可以在<a class="ae jd" href="https://kubernetes.io/docs/concepts/storage/storage-classes/#parameters" rel="noopener ugc nofollow" target="_blank">这里的</a>中看到可用的供应器和参数。本指南的其余部分将适用于任何Kubernetes集群。</p><h1 id="8f36" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">2.弹性搜索节点发现</h1><p id="d16c" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">第二步是通过headless服务启用elasticsearch节点发现。创建名为<code class="du kv kw kx ky b">service.yaml</code>的新文件，内容如下:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="eb48" class="lh jt hi ky b fi li lj l lk ll">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: es<br/>  labels:<br/>    service: elasticsearch<br/>spec:<br/>  clusterIP: None<br/>  ports:<br/>  - port: 9200<br/>    name: serving<br/>  - port: 9300<br/>    name: node-to-node<br/>  selector:<br/>    service: elasticsearch</span></pre><p id="3ccc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后使用以下命令启用无头服务:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="73f5" class="lh jt hi ky b fi li lj l lk ll">kubectl apply -f service.yaml</span></pre><p id="9839" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该能够在仪表板上看到该服务:</p><figure class="kz la lb lc fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es ly"><img src="../Images/f181a4a99966a0c29a469cce9915c44e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d4G6UfjqDOmz2dtKpUaqyw.png"/></div></div><figcaption class="lu lv et er es lw lx bd b be z dx translated">laniakea集群上的ES headless服务</figcaption></figure><p id="7afb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在kubernetes集群中，每个带有标签<code class="du kv kw kx ky b">service: elasticsearch</code>的pod都应该可以通过<code class="du kv kw kx ky b">$PODNAME.es.default.cluster.local</code>访问。这将有助于我们的弹性搜索节点发现彼此并形成一个集群。</p><h1 id="b306" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">3.弹性搜索集群</h1><p id="26e4" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">最后一步是使用StatefulSet部署elasticsearch集群。创建名为<code class="du kv kw kx ky b">elasticsearch.yaml</code>的新文件，内容如下:</p><figure class="kz la lb lc fd ln"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="569d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要部署Elasticsearch集群，运行以下命令:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="e7c0" class="lh jt hi ky b fi li lj l lk ll">kubectl apply -f elasticsearch.yaml</span></pre><p id="0057" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">群集准备就绪可能需要一些时间，这取决于群集的大小。您可以通过访问<a class="ae jd" href="https://console.cloud.google.com/kubernetes/workload" rel="noopener ugc nofollow" target="_blank">工作负载仪表板</a>来查看集群是否准备就绪。</p><p id="f7af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您的集群已准备好，您可以通过port-forward访问其中一个elasticsearch节点来检查集群是否已创建:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="a0b1" class="lh jt hi ky b fi li lj l lk ll">kubectl port-forward elasticsearch-0 9200:9200</span></pre><p id="8691" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将把所有对<a class="ae jd" href="http://localhost:9200" rel="noopener ugc nofollow" target="_blank"> http://localhost:9200 </a>的请求转发到elasticsearch-0节点。然后:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="90cc" class="lh jt hi ky b fi li lj l lk ll">curl <a class="ae jd" href="http://10.20.8.3:9200/_cluster/state?pretty" rel="noopener ugc nofollow" target="_blank">http://localhost:9200/_cluster/state?pretty</a></span></pre><p id="1c2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它应该向您显示该集群由5个弹性搜索节点组成。</p><p id="64b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！现在你可以欣赏我最喜欢的gif了:</p><figure class="kz la lb lc fd ln"><div class="bz dy l di"><div class="mb ma l"/></div><figcaption class="lu lv et er es lw lx bd b be z dx">😊</figcaption></figure></div></div>    
</body>
</html>