<html>
<head>
<title>Identity Federation for Gitlab CI and Google Cloud APIs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Gitlab CI和Google Cloud APIs的身份联盟</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/identity-federation-for-gitlab-ci-and-google-cloud-apis-33aa4ec6989e?source=collection_archive---------1-----------------------#2022-02-14">https://medium.com/google-cloud/identity-federation-for-gitlab-ci-and-google-cloud-apis-33aa4ec6989e?source=collection_archive---------1-----------------------#2022-02-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/458c106cc0c27dea59f2e680bf5d7426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_dFfxfuekuhEc_2528wgbA.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由阿古斯·迪特里希在<a class="ae iu" href="https://unsplash.com/s/photos/passport?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="cbf6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从您的持续集成(CI)管道中安全地使用Google Cloud APIs可能是一个挑战。尤其是当您在CI环境中进行基础设施即代码(IAC)时。<a class="ae iu" href="https://cloud.google.com/iam/docs/workload-identity-federation" rel="noopener ugc nofollow" target="_blank">Workload Identity Federation</a>是一个很棒的解决方案，它支持大多数OpenID连接提供商。工作负载身份联合支持应用程序替换服务帐户密钥&amp;使用临时凭证访问GCP资源</p><p id="fd7e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">遗憾的是，在Gitlab的OpenID连接提供程序的实现中有一个小的差距。颁发者缺少URL的模式部分(Gitlab问题跟踪器中的<a class="ae iu" href="https://gitlab.com/gitlab-org/gitlab/-/issues/335186" rel="noopener ugc nofollow" target="_blank">标签</a>)。Workload Identity Federation目前也不支持不能从互联网访问的私有Gitlab实例。</p><p id="ca17" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">许多团队试图用不同的方法来解决这个问题。我们见过的最常见的设置是导出服务帐户密钥并将它们存储在Gitlab中。你应该尽量避免哪个<a class="ae iu" href="https://cloud.google.com/iam/docs/best-practices-for-managing-service-account-keys" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="820b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一些Gitlab用户开始为每个repo/team设置一个基于GCE VM的runner来分离权限。但是这仍然会导致分支机构的意外部署，并且会导致巨大的成本。</p><p id="1b2a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们观察到的另一种方法，也是使用跑步者的模拟。这通常是通过给予VM的服务运行者模拟其他服务帐户的许可来实现的。然后从管道中选择所需的服务帐户。与之前的方法相比，这是一种优化，但仍然不是最佳的。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jt"><img src="../Images/8c532dc4265574aec312fdb8e6571820.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WYy2DB5WsUpMcpcBbtmZeQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Sapro架构的高级概述</figcaption></figure><p id="fbdd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://www.linkedin.com/in/alexmeissner/" rel="noopener ugc nofollow" target="_blank"> Alex Meissner </a>和我决定创建一个简单的解决方案，名为<a class="ae iu" href="https://github.com/GoogleCloudPlatform/professional-services/tree/main/tools/service-account-provider" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> Sapro </strong> </a> <strong class="ix hj"> </strong>(服务帐户提供商的简称)，它为您提供了一个端点，用于根据服务帐户的IAM访问令牌交换Gitlab CI JWTs。Sapro是一个简单的基于Golang的服务，你可以在Google Cloud Run上运行。您可以使用存储在Google云存储中的YAML文件在存储库和分支级别上配置服务帐户的使用。以下是Sapro的配置示例:</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="c128" class="kd ke hi jz b fi kf kg l kh ki"># Configure the issuers and the JWKS that Sapro should accept, the JWKS can either be resolved via HTTP or from the containers filesystem<br/>issuers:<br/>  - name: gitlab.com    <br/>    jwks_url: "https://gitlab.com/-/jwks" </span><span id="ed03" class="kd ke hi jz b fi kj kg l kh ki"># The pipelines and which service accounts they should be able to access <br/>pipelines:<br/>  - name: "group/repo"<br/>    branches:<br/>      # you can use * to wildcard all branches<br/>      - ref: * <br/>        service_accounts:<br/>           - desiredsa@project_id.iam.gserviceaccount.com     </span></pre><p id="bb78" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当然，我们的方法有一些缺点，但我们认为它产生的价值大于缺点。使用Sapro，您可以使用一组共享的构建运行器节点，这些节点可以用最少的权限运行。这允许您避免空闲的运行器节点，从而提高您的成本效率，并减少您的平均构建等待时间。理想情况下，您可以将Sapro与基于Docker或Kubernetes的runners结合起来，以利用动态集群伸缩来获得优势，这通常会增加构建的可重复性。</p><p id="4cd1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://github.com/GoogleCloudPlatform/professional-services/tree/main/tools/service-account-provider" rel="noopener ugc nofollow" target="_blank"> repo </a>包含了一个使用Terraform设置的例子，但是基本上你可以使用<em class="kk"> curl </em>来获取一个访问令牌，以此来交换一个作业的JWT令牌。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="aac0" class="kd ke hi jz b fi kf kg l kh ki">curl -H "Gitlab-Token: ${CI_JOB_JWT}" "https://sapro.cloudrun/access?sa=${SERVICE_ACCOUNT}"</span></pre><p id="0dca" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Sapro将检查JWT中引用的分支机构是否受保护，并查找回购、分支机构和服务账户是否有有效的组合。如果有，云运行服务将模拟目标服务帐户并创建访问令牌。然后，您可以使用访问令牌来部署您的基础设施，将您的Docker容器映像部署到工件注册表，或者持续交付到云运行和GKE。</p><div class="kl km ez fb kn ko"><a href="https://github.com/GoogleCloudPlatform/professional-services/tree/main/tools/service-account-provider" rel="noopener  ugc nofollow" target="_blank"><div class="kp ab dw"><div class="kq ab kr cl cj ks"><h2 class="bd hj fi z dy kt ea eb ku ed ef hh bi translated">主要的专业服务/工具/服务客户提供商…</h2><div class="kv l"><h3 class="bd b fi z dy kt ea eb ku ed ef dx translated">SAPRO允许从有限权限环境中为服务帐户请求令牌。Gitlab CI JWT代币…</h3></div><div class="kw l"><p class="bd b fp z dy kt ea eb ku ed ef dx translated">github.com</p></div></div><div class="kx l"><div class="ky l kz la lb kx lc io ko"/></div></div></a></div></div></div>    
</body>
</html>