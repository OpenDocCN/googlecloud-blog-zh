<html>
<head>
<title>Few tips and tricks about GCE startup scripts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于GCE启动脚本的一些提示和技巧</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/few-tips-and-tricks-with-gce-startup-script-323433e2b5ee?source=collection_archive---------0-----------------------#2021-05-04">https://medium.com/google-cloud/few-tips-and-tricks-with-gce-startup-script-323433e2b5ee?source=collection_archive---------0-----------------------#2021-05-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="846f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Google Cloud中，可以为虚拟机配置一个启动脚本，该脚本将在虚拟机每次启动时启动。运行启动脚本很容易，有很多博客文章描述了如何做，包括GCP公共文档。启动脚本为您提供了一个通用的问题解决方案，用于定义每次虚拟机启动时要运行的命令。像任何事情一样，很少有警告。</p><h1 id="63ff" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">一次性启动脚本</h1><p id="cebd" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">AWS提供了区分EC2启动和启动事件的功能。这提供了仅在EC2实例首次引导时运行脚本的功能。GCE不直接提供这个功能。然而，方法很简单让脚本的运行有条件。实现它的最简单方法是在脚本执行结束时创建一个空文件，并以文件存在作为启动脚本执行的条件:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="1ffb" class="kq jf hi km b fi kr ks l kt ku">if [[ -f /etc/startup_was_launched ]]; then exit 0; fi<br/>…<br/>touch /etc/startup_was_launched</span></pre><p id="fd02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一种方法是利用GCE实例元数据的<a class="ae jd" href="https://cloud.google.com/compute/docs/storing-retrieving-metadata#guest_attributes" rel="noopener ugc nofollow" target="_blank">客户属性</a>。它的工作方式与文件类似，但是测试必须向元数据服务器发送REST API调用。使用guest属性不太理想，因为在文件由root创建和拥有时，任何人都可以读取和修改它们。</p><h1 id="4489" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">如何知道启动脚本运行完毕？</h1><p id="6212" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">有时，当您编写运行虚拟机的shell脚本或其他自动化程序时，您需要弄清楚启动脚本何时结束运行。例如，在虚拟机启动后，你可能需要做一些动作<em class="kv">，虚拟机上所有需要启动的东西都在运行。目前还没有可管理的解决方案。您可以使用云日志记录来捕获启动脚本输出，并查找以“startup-script”开头的行:</em></p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a9aa" class="kq jf hi km b fi kr ks l kt ku"># INSTANCE_ID=$(gcloud compute instances describe $VM_NAME \<br/>    --zone=$VM_ZONE --format=”value(id)”)<br/># gcloud logging read "resource.type=gce_instance AND \<br/>    resource.labels.instance_id=\"$INSTANCE_ID\" AND\   <br/>    jsonPayload.message=~\"^startup-script:\""</span></pre><p id="f827" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，这些行表示执行事件，并不捕获执行实际完成的时间，因此不可能确定启动脚本的所有命令何时结束运行。另一种方法是应用前面的建议，使用文件或guest属性作为启动脚本执行结束的标记。要使用它，启动脚本应该知道这个标记，并在开始时重置它。还应仔细选择标记，以避免在GCP管理活动中被破坏(例如，禁用虚拟机上的来宾元数据)或被虚拟机操作系统的维护流程删除。由<a class="kw kx ge" href="https://medium.com/u/a255b051be06?source=post_page-----323433e2b5ee--------------------------------" rel="noopener" target="_blank"> Nazia Mahimi </a>提出的另一种方法是通过运行以下命令来捕获串行输出:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="8604" class="kq jf hi km b fi kr ks l kt ku"># gcloud compute instances get-serial-port-output $VM_NAME \<br/>    --zone=$VM_ZONE | grep \<br/>    "&lt;instance_name&gt; systemd: Startup finished"</span></pre><p id="9ed5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该命令可以在VM启动后定期启动，以检查启动脚本是否执行完毕。它也不需要对启动脚本进行任何修改来清理和设置结束脚本标记。这种方法有几个考虑因素。(1)它要求允许到GCE实例的串行端口连接。如果你的GCP组织强制执行<code class="du ky kz la km b">constraints/compute.disableSerialPortAccess</code>组织。策略约束该命令将不起作用。(2)考虑到最小化攻击面的安全实践以及虚拟机已经提供SSH/RDP连接的事实，没有理由开放另一个连接选项。</p><p id="2bb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">推荐的解决方案是使用现有的SSH/RDP连接来解析启动脚本的执行日志。日志被捕获到<code class="du ky kz la km b">/var/log/syslog</code>中，可以通过查找带有<code class="du ky kz la km b">"startup-script exit status"</code>的行来查询:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="07f3" class="kq jf hi km b fi kr ks l kt ku">grep -m 1 “startup-script exit status” /var/log/syslog</span></pre><p id="fdad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">状态被捕获为0(成功)或1(失败),并且可以从捕获的行中解析。请注意检查时间戳，以确保它是最近发生的，并且您没有从上一次重启中捕获日志行。</p><p id="6790" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要运行此行，您需要能够在虚拟机上运行SSH命令:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="7dfc" class="kq jf hi km b fi kr ks l kt ku">gcloud compute ssh $VM_NAME --zone=$VM_ZONE --ssh-flag="-q" \<br/>    --command='grep -m 1 "startup-script exit status" /var/log/syslog' 2&gt;&amp;-</span></pre><p id="e192" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您执行命令时，如果VM没有启动或者SSH端口不可用，那么<code class="du ky kz la km b">2&gt;&amp;-</code>保证您不会得到<code class="du ky kz la km b">gcloud</code>错误输出。</p><p id="7e7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用下面的bash脚本探测shell脚本在第一次启动时完成。它提供了等待“正确”日志条目的进度指示壁:</p><figure class="kh ki kj kk fd lb"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="c4d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于多次虚拟机重启，该脚本将无法正常工作，因为它将总是捕获第一次出现的<code class="du ky kz la km b">"startup-script exit status"</code>并将退出。引入时间阈值(在以下示例中为5分钟)并自下而上反转系统日志解析可以解决问题(假设虚拟机不会频繁重启):</p><figure class="kh ki kj kk fd lb"><div class="bz dy l di"><div class="lc ld l"/></div></figure><h1 id="73cd" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">在启动脚本中使用环境变量</h1><p id="6224" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">可以将自定义值注入到启动脚本中。然而，当启动脚本创建一个应该使用一些环境变量的shell脚本文件时，这可能是一个障碍。以下命令创建了一个具有<code class="du ky kz la km b">/etc/sample.sh</code> shell脚本的虚拟机:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="5d6b" class="kq jf hi km b fi kr ks l kt ku">gcloud compute instances create $VM_NAME --zone=$VM_ZONE \<br/>    --metadata startup-script='#!/bin/bash<br/>cat &gt; /etc/sample.sh &lt;&lt;EOF<br/>#!/bin/bash<br/>echo "my home directory is at $HOME"<br/>EOF'</span></pre><p id="366e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ky kz la km b">/etc/sample.sh</code>的预期内容是:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="1b32" class="kq jf hi km b fi kr ks l kt ku">#!/bin/bash<br/>echo "my home directory is at $HOME"</span></pre><p id="0215" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是运行上面的启动脚本会产生看起来像这样的<code class="du ky kz la km b">/etc/sample.sh</code>:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="1d09" class="kq jf hi km b fi kr ks l kt ku">#!/bin/bash<br/>echo "my home directory is at "</span></pre><p id="d9e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是因为$HOME将按照自定义值注入逻辑被计算为一个空字符串(在VM实例的元数据中没有这样的键)。解决方案就是对美元符号进行转义，这样shell脚本就会像预期的那样:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="6d34" class="kq jf hi km b fi kr ks l kt ku">gcloud compute instances create $VM_NAME --zone=$VM_ZONE \<br/>    --metadata startup-script='#!/bin/bash<br/>cat &gt; /etc/sample.sh &lt;&lt;EOF<br/>#! /bin/bash<br/>echo "my home directory is at \$HOME"<br/>EOF'</span></pre><p id="77e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">享受启动脚本<a class="ae jd" href="https://emojipedia.org/thumbs-up/" rel="noopener ugc nofollow" target="_blank">👍</a></p></div></div>    
</body>
</html>