<html>
<head>
<title>Call Cloud Run from App Script: The easy way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从应用程序脚本调用云运行:简单的方法</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/call-cloud-run-from-app-script-the-easy-way-70677086efa1?source=collection_archive---------0-----------------------#2021-07-13">https://medium.com/google-cloud/call-cloud-run-from-app-script-the-easy-way-70677086efa1?source=collection_archive---------0-----------------------#2021-07-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f94f41f019dd099248836c33e7b217be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b_M-RECN9rHvQsR4uRfoTA.png"/></div></div></figure><p id="1a14" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谷歌是一家拥有大量应用程序的大公司，你可以通过API接触到这些应用程序。为了利用和复制这些产品的功能，您可以<strong class="is hj">将它们组合在一起</strong>和<strong class="is hj">创造出更大的</strong>！然而，<strong class="is hj">并不那么简单</strong>:每个产品都有完整的文档记录，但是连接它们的<strong class="is hj">认证部分</strong>却模糊不清、过期或缺失。</p><h1 id="6823" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">生成访问令牌</h1><p id="99e8" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">令人欣慰的是，当你想插入Google Workspace产品和Google Cloud APIs时，<strong class="is hj">使用开箱即用的方法非常容易</strong>。</p><p id="d190" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您使用应用程序脚本时，您可以调用一个方法来生成访问令牌(OAuth令牌)</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="6615" class="la jp hi kw b fi lb lc l ld le">ScriptApp.getOAuthToken();</span></pre><p id="84c3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">容易，不是吗？</p><h1 id="55ce" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">谷歌云API调用</h1><p id="0d1d" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">不，没那么简单…试着写一段简单的代码。去https://script.google.com/开始一个新项目</p><p id="ba36" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将这段代码复制到您的函数中</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="3bba" class="la jp hi kw b fi lb lc l ld le">function myFunction() {</span><span id="31a1" class="la jp hi kw b fi lg lc l ld le">var options = {<br/>  'method' : 'get',<br/>  'headers': {"Authorization":"Bearer "+ScriptApp.getOAuthToken()},<br/>}</span><span id="cf94" class="la jp hi kw b fi lg lc l ld le">var response =   UrlFetchApp.fetch("https://cloudresourcemanager.googleapis.com/v1/projects/&lt;PROJECT_ID&gt;",options);</span><span id="4888" class="la jp hi kw b fi lg lc l ld le">  Logger.log(response.getContentText());<br/>}</span></pre><p id="18eb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lh">用您的谷歌云项目ID </em>替换 <code class="du li lj lk kw b"><em class="lh">PROJECT_ID</em></code> <em class="lh"/></p><p id="9d16" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">保存并运行您的代码。接受权限，您应该会得到一个403错误，因为范围不足。</p><h2 id="96b2" class="la jp hi bd jq ll lm ln ju lo lp lq jy jb lr ls kc jf lt lu kg jj lv lw kk lx bi translated">范围问题</h2><p id="0f81" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">显然是的，你在一个应用程序脚本产品中，而<strong class="is hj">你在另一个产品</strong>中请求一个API，具有另一个范围。你需要将<a class="ae lf" href="https://developers.google.com/identity/protocols/oauth2/scopes" rel="noopener ugc nofollow" target="_blank">云平台范围</a>添加到你的app中。</p><p id="0cc1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，转到<code class="du li lj lk kw b">Project Settings</code>，点击<code class="du li lj lk kw b">Show "appscript.json" manifest file in editor</code>框</p><figure class="kr ks kt ku fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/f3eee09c128c7abfa92423ae7728b98e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LEefDb8PMOMA81sMsHieGw.png"/></div></div></figure><p id="701a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">回到编辑器，一个新文件出现了</p><figure class="kr ks kt ku fd ij er es paragraph-image"><div class="er es lz"><img src="../Images/02b460d5d27583ea1f1f05ef561aad42.png" data-original-src="https://miro.medium.com/v2/resize:fit:940/format:webp/1*wiCz1IxNvH4AFy6-IMQY-A.png"/></div></figure><p id="6922" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">打开它，并在其中添加云平台范围。<strong class="is hj">你的文件应该看起来像那个</strong></p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="258c" class="la jp hi kw b fi lb lc l ld le">{<br/>  "timeZone": "Europe/Paris",<br/>  "dependencies": {},<br/>  "exceptionLogging": "STACKDRIVER",<br/>  "runtimeVersion": "V8",<br/>  <strong class="kw hj">"oauthScopes": [<br/>    "https://www.googleapis.com/auth/cloud-platform"<br/>  ]</strong><br/>}</span></pre><p id="7a94" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">再次运行您的脚本。<br/> <strong class="is hj"> <em class="lh">又失败了！！！！</em> </strong></p><p id="5c35" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这次你<strong class="is hj">没有权限范围运行App脚本中的脚本，</strong>你只有云平台范围，没有App脚本的默认范围。<br/>所以，<strong class="is hj">把它加到像</strong>那样的示波器上</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="b9ac" class="la jp hi kw b fi lb lc l ld le">{<br/>  "timeZone": "Europe/Paris",<br/>  "dependencies": {},<br/>  "exceptionLogging": "STACKDRIVER",<br/>  "runtimeVersion": "V8",<br/>  <strong class="kw hj">"oauthScopes": [<br/>    "https://www.googleapis.com/auth/cloud-platform",<br/>    "https://www.googleapis.com/auth/script.external_request"<br/>  ]</strong><br/>}</span></pre><p id="1a15" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后运行你的脚本，接受新的许可和… <strong class="is hj"> <br/> <em class="lh"> 403再次，API在一个项目号上不活动！！！</em>T45】</strong></p><p id="e698" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lh">你不知道的项目编号，当然不是“那么”简单！</em></p><h2 id="26c2" class="la jp hi bd jq ll lm ln ju lo lp lq jy jb lr ls kc jf lt lu kg jj lv lw kk lx bi translated">在API调用中请求正确的项目</h2><p id="d43c" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在引擎盖下，<strong class="is hj"> App Script为你创建了一个项目</strong>，没有激活任何Google Cloud APIs，因为<strong class="is hj">不是Google Cloud项目</strong>。所以，你需要<strong class="is hj">在App脚本配置中设置你的项目。</strong></p><p id="40a0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，请返回设置页面并点击<code class="du li lj lk kw b">Change Project</code></p><figure class="kr ks kt ku fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/6263b28bba4d60e98f6b8b21ad3ba477.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*24Ap-lINikFpr8_-SR2Uyg.png"/></div></div></figure><p id="61f7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并在字段中填入<strong class="is hj">项目编号</strong> <em class="lh">(不是项目ID。你可以在谷歌云控制台的主页上找到它)</em></p><p id="13f3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">回到你的脚本并运行它。<br/> <strong class="is hj">轰，管用！！</strong></p></div><div class="ab cl mb mc gp md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="hb hc hd he hf"><p id="6d1d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">太好了，现在我们可以用访问令牌调用Google Cloud APIs了。<br/>让我们调用云运行服务来创建<strong class="is hj">我的工作区应用和动态定制后端之间的交互</strong>。</p><h1 id="586b" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">云运行身份验证要求</h1><p id="7514" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">与需要访问令牌的Google Cloud APIs不同，<strong class="is hj">云运行服务需要身份令牌(JWT) </strong>来认证和授权请求者。<br/> <strong class="is hj"> <em class="lh">安全部署的云功能也是一样；对于受IAP </em>保护的App引擎</strong></p><p id="6e28" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以，不用担心，我们可以使用App脚本的<strong class="is hj">内置函数</strong></p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="58d1" class="la jp hi kw b fi lb lc l ld le">ScriptApp.getIdentityToken()</span></pre><p id="36c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lh">真的这么简单吗？</em> <br/> <strong class="is hj">当然不是</strong>。我已经在<a class="ae lf" rel="noopener" href="/google-cloud/the-2-limits-of-iam-service-on-google-cloud-7db213277d9c">这篇文章</a>和其他一些文章中谈到了这个话题。<strong class="is hj"> Google Cloud Run认证并不是那么简单，如果使用用户凭证的话就复杂了。</strong></p><h1 id="acc9" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">服务客户解决方案</h1><p id="a9a1" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">最简单的方法是使用服务帐户。<br/> <strong class="is hj">当然不是一个服务账号密钥文件！！</strong> <br/>保护应用程序脚本文档中的文件似乎很困难，如果我们可以避免使用服务帐户密钥文件，这是一个糟糕的做法。<strong class="is hj"> <em class="lh">我们会有不同的做法。</em>T45】</strong></p><p id="e0c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我已经在<a class="ae lf" rel="noopener" href="/google-cloud/service-account-credentials-api-a-solution-to-different-issues-dc7434037115">这篇文章</a> <strong class="is hj">中描述了一个不为人知的API:服务帐户凭证API <br/> </strong>，我们将重用它！我们需要</p><ul class=""><li id="137f" class="mi mj hi is b it iu ix iy jb mk jf ml jj mm jn mn mo mp mq bi translated">具有<strong class="is hj">调用云运行服务</strong>权限的服务帐户(roles/run.invoker)</li><li id="5d4e" class="mi mj hi is b it mr ix ms jb mt jf mu jj mv jn mn mo mp mq bi translated">安全部署云运行<strong class="is hj">服务</strong> ( <code class="du li lj lk kw b">--no-allow-unauthenticated</code>)</li><li id="eb98" class="mi mj hi is b it mr ix ms jb mt jf mu jj mv jn mn mo mp mq bi translated">授予应用程序脚本用户的<strong class="is hj">服务帐户令牌创建者角色(roles/iam . serviceaccountokencreator)。<br/> <em class="lh">所需的权限没有在所有者角色中设置，即使您是项目所有者，也需要这个额外的角色</em></strong></li></ul></div><div class="ab cl mb mc gp md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="hb hc hd he hf"><p id="26dd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一步是<strong class="is hj">通过服务帐户凭证API请求服务帐户</strong>上的身份令牌。<br/> <em class="lh">我们用当前令牌的访问令牌</em>  <em class="lh">执行这个</em> <strong class="is hj"> <em class="lh"> Google Cloud API调用，如前所见</em></strong></p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="696a" class="la jp hi kw b fi lb lc l ld le">var options = {<br/>  'method' : 'post',<br/>  'headers': {"Authorization":"Bearer "+ScriptApp.getOAuthToken()},<br/>  'contentType': 'application/json',<br/>  'payload': '{"includeEmail":true, <br/>    "audience": "AUDIENCE"}'<br/>}</span><span id="0eed" class="la jp hi kw b fi lg lc l ld le">var response = UrlFetchApp.fetch("https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/&lt;SERVICE_ACCOUNT_EMAIL&gt;:generateIdToken",options)</span><span id="53c6" class="la jp hi kw b fi lg lc l ld le">Logger.log(JSON.parse(response.getContentText()).token);</span></pre><p id="d171" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lh"/><code class="du li lj lk kw b"><em class="lh">AUDIENCE</em></code><em class="lh">是云运行服务的原始URL</em></p><p id="3b0f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该部分打印身份令牌。现在，您必须<strong class="is hj">使用授权头中的身份令牌调用您的云运行服务</strong></p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="e136" class="la jp hi kw b fi lb lc l ld le">var options = {<br/>  'method' : 'get',<br/>  'headers': {"Authorization":"Bearer " + <br/>    JSON.parse(response.getContentText()).token},<br/>}</span><span id="4cd7" class="la jp hi kw b fi lg lc l ld le">var response = UrlFetchApp.fetch("&lt;CLOUD_RUN_URL&gt;",options);</span><span id="2abb" class="la jp hi kw b fi lg lc l ld le">Logger.log(response.getContentText());</span></pre><p id="c1c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">运行您的脚本，然后<strong class="is hj">嘣！你拿到了！</strong></p><h1 id="4465" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">一致认证</h1><p id="683e" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">最后，产品之间的<strong class="is hj">通信不是</strong>那么简单，而是所有产品之间的<strong class="is hj">认证逻辑和机制是一致的</strong>。你需要使用正确的令牌类型和正确的作用域。没有什么是神奇的，而且“这么简单”。</p><p id="9434" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我希望这篇文章能够<strong class="is hj">简化你的多谷歌产品解决方案</strong>，让你制作出令人敬畏的低代码工作空间应用程序，并与谷歌云集成！</p></div></div>    
</body>
</html>