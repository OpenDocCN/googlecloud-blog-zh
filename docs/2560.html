<html>
<head>
<title>Cloud Armor Setup and Configuration on GKE Hosted Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GKE托管应用上的云装甲设置和配置</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-armor-setup-and-configuration-on-gke-hosted-application-9fe8847a0c0f?source=collection_archive---------0-----------------------#2022-11-27">https://medium.com/google-cloud/cloud-armor-setup-and-configuration-on-gke-hosted-application-9fe8847a0c0f?source=collection_archive---------0-----------------------#2022-11-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d2fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd"> WAF &amp;来自谷歌云平台的DDoS防护</em></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/57738349267fc71d109b11444740cab6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XaQ9qCWawTssiGk7L4sE-A.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">使用云装甲的安全性</figcaption></figure><blockquote class="ju jv jw"><p id="b2bc" class="if ig jd ih b ii ij ik il im in io ip jx ir is it jy iv iw ix jz iz ja jb jc hb bi translated">C <!-- --> loud Armor最近检测并缓解了4600万HTTPs QPS攻击，证明了其作为企业级解决方案的可靠性。更多细节可以在这里找到<a class="ae ka" href="https://www.youtube.com/redirect?event=video_description&amp;redir_token=QUFFLUhqbUU5dUNxdWt0QXpwQzhFc3g3V0lyOUwySkxrUXxBQ3Jtc0tsQWxwWm9HSnY0NWdiRmNKNFF6UEZILWFlUEU1MTh5cWNSd3NNdnBxbVB2NFBQUnBUb1d4bm5nbUZ6RTQzbmluSjhWV1hJZDNvOF9fT0xORUJVR2ZhNUlsbk1KRWRMS2c2d0lOUC1Qdm9Fb0V3VW5ZTQ&amp;q=https%3A%2F%2Fgoo.gle%2F3RJCDc2&amp;v=_b_I-mJ3Sjk" rel="noopener ugc nofollow" target="_blank">。</a></p></blockquote><p id="5089" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章将谈论什么是云装甲以及如何在GCP控制台设置它的一些基础知识。然后，我将展示在GKE托管的应用程序上应用云防护策略所需的配置。查看来自GCP的<a class="ae ka" href="https://cloud.google.com/armor#section-5" rel="noopener ugc nofollow" target="_blank">官方文档</a>来了解云甲的细节。</p><p id="6774" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">什么是云甲？</strong></p><p id="bdd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cloud Armor是一种网络安全解决方案，可以保护您的应用免受第3层/第4层网络或基于协议的体积DDoS攻击。它还能够支持第7层保护。Cloud Armor还是一个Web应用防火墙，可以检测和缓解安全规则中预定义的常见<a class="ae ka" href="https://owasp.org/www-project-top-ten/" rel="noopener ugc nofollow" target="_blank"> OWASP TOP 10 </a>等漏洞。您可以保护您的应用程序免受SQL注入攻击、跨站点脚本攻击和不同的DDoS攻击，如协议攻击、应用程序攻击和容量攻击。Google Cloud Armor与外部负载平衡器协同工作，并包含内置安全策略。</p><p id="f182" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">主要特性</strong></p><p id="2312" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud Armor的一些关键特性包括:</p><ol class=""><li id="f6c4" class="kb kc hi ih b ii ij im in iq kd iu ke iy kf jc kg kh ki kj bi translated">限速</li><li id="7e28" class="kb kc hi ih b ii kk im kl iq km iu kn iy ko jc kg kh ki kj bi translated">Bot管理</li><li id="4d34" class="kb kc hi ih b ii kk im kl iq km iu kn iy ko jc kg kh ki kj bi translated">适应性保护</li><li id="2cbd" class="kb kc hi ih b ii kk im kl iq km iu kn iy ko jc kg kh ki kj bi translated">基于IP和基于地理的访问控制</li><li id="c5c5" class="kb kc hi ih b ii kk im kl iq km iu kn iy ko jc kg kh ki kj bi translated">命名IP列表</li></ol><p id="047f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考<a class="ae ka" href="https://cloud.google.com/armor#section-1" rel="noopener ugc nofollow" target="_blank">文档</a>了解所有支持功能的详细信息。</p><p id="c17f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">如何设置云甲？</strong></p><p id="00bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用GUI方法来设置云甲。也可以使用gcloud SDK和API进行设置。IaC也可用于供应。</p><p id="9248" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">进入GCP仪表板&gt;搜索云装甲&gt;启用API(确保您在正确的项目中)</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kp"><img src="../Images/1ef1dd819f9147e7c124b6ff64221bcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mEVS0F_bPLdD9X771-u1lQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">云装甲仪表板</figcaption></figure><ol class=""><li id="d197" class="kb kc hi ih b ii ij im in iq kd iu ke iy kf jc kg kh ki kj bi translated">创建安全策略</li></ol><p id="528b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击<em class="jd">创建策略，</em>打开下一页。命名策略。</p><p id="a059" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择策略类型作为后端安全策略，因为它也可以应用于边缘位置。默认规则可以应用于所有允许或阻止的请求。选项选择<em class="jd">拒绝</em> <em class="jd">状态</em>如403、404或502。这些是带有更多选项的必填字段，可以进一步配置，如规则和目标。可以配置规则并将其附加到目标。自适应保护选项是可用的，它基本上使用后端机器学习模型来检查潜在攻击的流量异常。检测到异常时，它可以即时创建规则来阻止特定流量。点击<em class="jd">创建策略</em>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kq"><img src="../Images/204dd8b583ddbaa7b2b6138fd8423d07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hu2WuMTLY86KRHe4VWR2PQ.png"/></div></div></figure><p id="fbe5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">等效gcloud命令:</p><pre class="jf jg jh ji fd kr ks kt bn ku kv bi"><span id="6f0f" class="kw kx hi ks b be ky kz l la lb">gcloud compute security-policies create my-policy-1 \<br/>--description "Policy for deny"</span></pre><p id="6b52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.创建规则</p><p id="ab41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了默认的策略基本规则之外，每个规则都有自己的允许和拒绝操作。通常当基本规则是允许时，策略规则将是拒绝。</p><p id="5df4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的规则示例指定允许IP地址违反基本策略拒绝规则，该规则拒绝所有其他请求。这是一个基本规则，同样你可以创建更高级的规则。下一步是定义评估规则的优先级。首先评估优先级较高的规则。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kp"><img src="../Images/f577ec46e400631cc11f9c1662cc8175.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UzkPfhBuVUwnplWqFxtHAg.png"/></div></div></figure><p id="4997" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置该规则的等效命令行如下所示:</p><pre class="jf jg jh ji fd kr ks kt bn ku kv bi"><span id="8e13" class="kw kx hi ks b be ky kz l la lb">gcloud compute security-policies rules create 5000 \<br/>    --project=project-a-3410500 \<br/>    --action=allow --security-policy=my-policy-1 \<br/>    --expression=inIpRange\(origin.ip,\ \'1.1.1.1/32\'\) <br/>    --description=My\ IP\ Address</span></pre><p id="4f47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如:你想拒绝来自中国地区的所有请求，下面是要使用的规则。更多细节可以在这里找到<a class="ae ka" href="https://cloud.google.com/armor/docs/rules-language-reference#preconfigured-rules" rel="noopener ugc nofollow" target="_blank">。</a></p><pre class="jf jg jh ji fd kr ks kt bn ku kv bi"><span id="e73a" class="kw kx hi ks b be ky kz l la lb">origin.region_code == 'CN'</span></pre><p id="89de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.将策略与目标相关联</p><p id="582c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建策略后，您可以将策略与目标相关联。目标可以是任何基于非CDN HTTP(s)的后端负载平衡器服务。只需选择“Add Policy to NEW Target ”,它就会列出项目中的负载平衡器。您可以向sam策略添加多个后端目标。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kp"><img src="../Images/398c92e1c402ab1b3e69359823653d2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jFwhXiyBEE7EyvyjWNBsrQ.png"/></div></div></figure><p id="d356" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止，我们已经讨论了创建一个具有不同规则的云装甲策略，并与一个后端服务(负载平衡器)相关联。</p><p id="7f68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">考虑一个场景，我们的应用程序运行在GKE集群上，并通过负载平衡器类型的服务公开，最终在GCP创建了一个负载平衡器。我们可以通过定义一个定制的资源定义，通过一个名为后端配置的Kubernetes对象来更新这个特性。更多细节可以在<a class="ae ka" href="https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-features#configuring_ingress_features" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="c01a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">后端配置</strong></p><p id="2028" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个后端配置示例，它可以与GKE服务一起使用，将云装甲策略应用到运行在GKE上的应用程序。后端配置与服务关联。您还可以在后端配置中配置多个其他参数，您可以在这里找到<a class="ae ka" href="https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-features#configuring_ingress_features" rel="noopener ugc nofollow" target="_blank">。</a></p><pre class="jf jg jh ji fd kr ks kt bn ku kv bi"><span id="f730" class="kw kx hi ks b be ky kz l la lb">apiVersion: cloud.google.com/v1<br/>kind: BackendConfig<br/>metadata:<br/>  namespace: cloud-armor-how-to<br/>  name: my-backendconfig<br/>spec:<br/>  securityPolicy:<br/>    name: "my-policy-1"<br/>  healthCheck:<br/>    checkIntervalSec: 30<br/>    timeoutSec: 30<br/>    healthyThreshold: 1<br/>    unhealthyThreshold: 5<br/>    port: 80<br/>    type: HTTP<br/>    requestPath: /health</span></pre><p id="71cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置完成后，可以使用如下注释将backendconfig与服务相关联</p><pre class="jf jg jh ji fd kr ks kt bn ku kv bi"><span id="3b98" class="kw kx hi ks b be ky kz l la lb">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  annotations:<br/>    cloud.google.com/backend-config: '{"default": "my-backendconfig"}'<br/>...</span></pre><p id="a3e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇博客到此为止，我将演示云装甲如何监控和阻止GKE托管的应用程序的流量。快乐学习！！</p></div></div>    
</body>
</html>