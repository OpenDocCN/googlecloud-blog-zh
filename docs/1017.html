<html>
<head>
<title>Cloud Tasks for every HTTP target</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">每个HTTP目标的云任务</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-tasks-for-every-http-target-7f057c122957?source=collection_archive---------0-----------------------#2019-05-29">https://medium.com/google-cloud/cloud-tasks-for-every-http-target-7f057c122957?source=collection_archive---------0-----------------------#2019-05-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b622" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2017年5月21日,(在某种程度上)悄悄地宣布，对于云任务，有对HTTP目标的测试支持。我想在这篇文章中解释它的意思，因为我认为它值得更多的关注，但首先让我们回顾历史，了解整个背景。</p><p id="5c49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云任务是Google云平台上的一个产品，管理异步任务的调度。这意味着您将数据发布到具体的云任务队列，然后它将数据转发给执行任务处理的目标工作者。当您有长时间运行任务且不想延长响应时间时，这尤其方便。相反，您将长处理任务分派给任务队列，它将它转发给一个工人。</p><p id="36ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云任务历史在App Engine中开始。由于(标准)App Engine(GCP最老的产品)有60秒的响应限制，因此需要提供能够处理更长请求的服务。这是通过任务队列完成的，任务队列是App Engine中的一个集成服务。近年来，在将最初的应用引擎服务分离为独立产品的努力中，云任务是在最初支持应用引擎目标的情况下引入的，这仍然限制了对应用引擎使用的服务。</p><p id="35fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而从现在开始，云任务终于提供了对任何HTTP目标的支持，而不仅仅是App Engine(也不仅仅是Google Cloud)。这当然扩展了可用性，因为现在基本上任何URL都可以作为工作器使用。</p><h2 id="48ce" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">性能</h2><p id="b2e8" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">云任务有很好的特性，这应该让你开始考虑使用它们，以防你到目前为止还没有使用它们:</p><p id="e701" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">-使用指数补偿重试。如果任务工作器没有返回2xx响应，它将重复该任务预定的尝试次数。</p><p id="06da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">-暂停/恢复任务执行。例如，您部署了新的工作代码版本，但它没有按预期工作，您可以暂停任务执行</p><p id="7eeb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">-您可以设置每秒从队列中调度的最大任务数或可以调度的最大并发任务数。当您需要限制任务处理时，这很方便。例如，您有一个第三方API，它限制您每秒可以发出多少个请求，通过这些参数，您可以轻松地控制执行速度。</p><p id="aeb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">-推迟任务分派。当您创建一个任务时，它会被尽快分派进行处理。但是，您可以设置将来应该执行任务的执行日期。我承认我没有发现如果有约束的话，将来你可以推迟多长时间发货。</p><p id="8bf4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">-支持推送任务。在App Engine中，支持推和拉，但现在只支持推。</p><p id="20ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">-可以使用具体语言的客户端库以及REST API创建任务。</p><p id="3aec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">-价格。每月100万次免费手术。此后每500万美元收取0.4美元。</p><p id="400b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">-为web UI提供有关队列和已处理任务的信息。</p><p id="9b2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud上的另一个分布式消息平台是PubSub。当然，有相似之处也有不同之处，我就不赘述了，因为在你需要决定使用哪一个的情况下，有一个非常详细的云任务和云发布<a class="ae kd" href="https://cloud.google.com/tasks/docs/comp-pub-sub" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/tasks/docs/comp-pub-sub</a>的对比。可以说云任务有PubSub功能的子集。PubSub更受事件驱动，而云任务更关注web/后端。再次检查网址，以便更好地比较。</p><p id="a3af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于云任务是托管服务，它可以很好地与其他托管/无服务器产品配合，如云功能、云运行、应用引擎等。</p><h2 id="f316" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">从云任务开始</h2><p id="29be" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">要启动云任务，您需要使用Google Cloud SDK (gcloud)创建至少一个队列。重要的是要知道，当首次创建队列时，它还会提示您创建App Engine应用程序，因为此时云任务与为您的项目设置App Engine的区域相关联。这对于项目来说是不可更改的。因此，在您的应用引擎所在的区域(尽管您不必部署任何应用引擎应用程序，也不打算部署)，云任务也同样存在。</p><p id="68df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是第一个队列创建过程的样子，使用这个命令，我创建了队列“datasets-queue ”,它有10个最大并发调度，只有一个执行尝试。最大尝试次数的默认值是100，对于开发/测试来说，将它设置为1或类似的值是很有用的，因为如果一个任务由于某种原因失败了，它会一直重复100次(这可能会持续一整天)。当通过g Cloud使用云任务时，需要启用云任务API(这可以在队列创建期间完成)。</p><pre class="ke kf kg kh fd ki kj kk kl aw km bi"><span id="d78b" class="jd je hi kj b fi kn ko l kp kq">gcloud tasks queues create datasets-queue --max-concurrent-dispatches 10 --max-attempts 1<br/>API [cloudtasks.googleapis.com] not enabled on project [301020687502].<br/> Would you like to enable and retry (this will take a few minutes)? <br/>(y/N)?  y<br/><br/>Enabling service [cloudtasks.googleapis.com] on project [301020687502]...<br/>Waiting for async operation operations/acf.12adf55c-d1e1-40c2-ab93-00e534eaff57 to complete...<br/>Operation finished successfully. The following command can describe the Operation details:<br/> gcloud services operations describe operations/tmo-acf.12adf55c-d1e1-40c2-ab93-00e534eaff57<br/>There is no App Engine app in project [cz-open-data].<br/><br/>Would you like to create one (Y/n)?  <br/><br/>You are creating an app for project [cz-open-data].<br/>WARNING: Creating an App Engine application for a project is irreversible and the region<br/>cannot be changed. More information about regions is at<br/>&lt;https://cloud.google.com/appengine/docs/locations&gt;.<br/><br/>Please choose the region where you want your App Engine application <br/>located:<br/><br/> [1] asia-east2    (supports standard and flexible)<br/> [2] asia-northeast1 (supports standard and flexible)<br/> [3] asia-northeast2 (supports standard and flexible)<br/> [4] asia-south1   (supports standard and flexible)<br/> [5] australia-southeast1 (supports standard and flexible)<br/> [6] europe-west   (supports standard and flexible)<br/> [7] europe-west2  (supports standard and flexible)<br/> [8] europe-west3  (supports standard and flexible)<br/> [9] europe-west6  (supports standard and flexible)<br/> [10] northamerica-northeast1 (supports standard and flexible)<br/> [11] southamerica-east1 (supports standard and flexible)<br/> [12] us-central    (supports standard and flexible)<br/> [13] us-east1      (supports standard and flexible)<br/> [14] us-east4      (supports standard and flexible)<br/> [15] us-west2      (supports standard and flexible)<br/> [16] cancel<br/>Please enter your numeric choice:  8<br/><br/>Creating App Engine application in project [cz-open-data] and region [europe-west3]....done.                                                                      <br/>WARNING: You are managing queues with gcloud, do not use queue.yaml or queue.xml in the future. More details at: <a class="ae kd" href="https://cloud.google.com/cloud-tasks/docs/queue-yaml." rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/cloud-tasks/docs/queue-yaml.</a><br/>Created queue [datasets-queue].</span></pre><h2 id="52a4" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">示例使用案例</h2><p id="2494" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">对于我的一个个人项目，我正在收集捷克开放数据并上传到BigQuery，云任务是一个完美的工具，我可以向其分派任务，然后并行执行。</p><p id="4758" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实际上，这意味着作为一个输入，我有一个URL列表和一些其他元数据，它们被编码并发送到云任务。在用作HTTP目标的云函数中，完成了关于下载/上传的主要工作。</p><p id="ac96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我决定使用云函数，因为它们的并发度为1，这意味着对于每个请求，云函数实例都是单独启动的，因此它提供了更多的工作内存(最大2GB ),这是我在将文件下载到内存中时尽可能需要的。</p><p id="0f81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云函数执行以下操作:</p><ol class=""><li id="8ba6" class="kr ks hi ih b ii ij im in iq kt iu ku iy kv jc kw kx ky kz bi translated">从网站下载CSV文件</li><li id="26dd" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">如有必要，解压缩/解码</li><li id="d108" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">清除列名</li><li id="4223" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">将文件保存到云存储中</li><li id="87a3" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">运行BigQuery上载作业</li></ol><p id="a190" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将不包括云函数的代码，因为它有点长，但这里有一个我用来创建任务的代码。</p><pre class="ke kf kg kh fd ki kj kk kl aw km bi"><span id="90d6" class="jd je hi kj b fi kn ko l kp kq">from google.cloud import tasks_v2beta3<br/><br/>tasks = tasks_v2beta3.CloudTasksClient()<br/>tasks_parent = tasks.queue_path(GCP_PROJECT, 'europe-west3', 'datasets-queue')<br/><br/><br/>def create_task(data: Dict[str, str]):<br/>    task_data = {<br/>        'http_request': {<br/>            'http_method': 'POST',<br/>            'url': CF_URL,<br/>            'body': json.dumps(data).encode(),<br/>            'oidc_token': {'service_account_email': SERVICE_ACCOUNT_EMAIL}<br/>        }<br/>    }<br/>    return tasks.create_task(tasks_parent, task_data)</span></pre><h2 id="a7c3" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">安全性</h2><p id="f27a" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">创建任务工人的一个重要部分是保护他们，即只对想要的用户进行身份验证，以防止不必要的访问。云运行，应用引擎从一开始就支持这一点，而云功能通过IAM帐户控制访问仍处于alpha阶段。我在阅读这篇文章时发现了这种可能性。保护云功能的流程如下:</p><p id="4db6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建服务帐户</p><pre class="ke kf kg kh fd ki kj kk kl aw km bi"><span id="d579" class="jd je hi kj b fi kn ko l kp kq">gcloud iam service-accounts create tasks-creator --display-name="Creates tasks for upload"<br/>Created service account [tasks-creator].</span></pre><p id="3c91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为创建的服务帐户设置角色，并将其绑定到将用作任务工作者的云功能。</p><pre class="ke kf kg kh fd ki kj kk kl aw km bi"><span id="921d" class="jd je hi kj b fi kn ko l kp kq">~&gt; gcloud alpha functions add-iam-policy-binding  upload-dataset --member serviceAccount:tasks-creator@cz-open-data.iam.gserviceaccount.com --role roles/cloudfunctions.invoker --region europe-west1 --project cz-open-data<br/>bindings:<br/>- members:<br/>  - serviceAccount:tasks-creator@cz-open-data.iam.gserviceaccount.com<br/>  - allUsers<br/>  role: roles/cloudfunctions.invoker<br/>etag: BwWKA8atmFg=<br/>version: 1</span></pre><p id="9128" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从响应中可以看出，该函数还有角色“allUsers ”,这意味着任何人都可以调用它，所以我需要删除它。</p><pre class="ke kf kg kh fd ki kj kk kl aw km bi"><span id="2d02" class="jd je hi kj b fi kn ko l kp kq">~&gt;gcloud alpha functions remove-iam-policy-binding upload-dataset --member allUsers --role roles/cloudfunctions.invoker --region europe-west1 --project cz-open-data<br/>bindings:<br/>- members:<br/>  - serviceAccount:tasks-creator@cz-open-data.iam.gserviceaccount.com<br/>  role: roles/cloudfunctions.invoker</span></pre><p id="0035" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在只有任务创建者可以执行这个功能。</p><p id="f22c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面创建任务的代码中，我作为“oidc_token”服务帐户电子邮件传递，在本例中是“<a class="ae kd" href="mailto:tasks-creator@cz-open-data.iam.gserviceaccount.com&quot;" rel="noopener ugc nofollow" target="_blank">tasks-creator @ cz-open-data . iam . gserviceaccount . com”</a>。有了这个，云任务将创建适当的JWT令牌，云功能(或其他一些谷歌云服务)将自动解码和认证这是真棒。请注意，您不必下载密钥文件，并在初始化客户端或类似的使用，你只需要通过适当的电子邮件地址。</p><h2 id="b86a" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">Web用户界面</h2><p id="a315" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">Web UI提供了一个很好的界面，提供了有用的信息，比如队列设置或者任务执行的细节。</p><figure class="ke kf kg kh fd lg er es paragraph-image"><div class="er es lf"><img src="../Images/491e87baf4abd3dda99bb88012f77fed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*u9lQ5ceDTMJqHWhP.png"/></div></figure><figure class="ke kf kg kh fd lg er es paragraph-image"><div class="er es lf"><img src="../Images/f9c9fcac3c5eec7710430bcaffebff56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*xMth5hFh3C67Ymif.png"/></div></figure><p id="57e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这篇文章能启发你开始使用云任务(如果你还没有的话)。</p><p id="4a3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每周一我都会发布关于GCP的每周简讯，如果你想收到与谷歌云相关的新闻、文章和材料，请在https://www.gcpweekly.com/<a class="ae kd" href="https://www.gcpweekly.com/" rel="noopener ugc nofollow" target="_blank">订阅</a></p></div></div>    
</body>
</html>