<html>
<head>
<title>GCP Cloud Logging : How to Enable Data Access Audit For Selected Buckets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP云日志记录:如何为选定时段启用数据访问审计</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-cloud-logging-how-to-enable-data-access-audit-for-selected-buckets-aaec12556486?source=collection_archive---------1-----------------------#2022-10-04">https://medium.com/google-cloud/gcp-cloud-logging-how-to-enable-data-access-audit-for-selected-buckets-aaec12556486?source=collection_archive---------1-----------------------#2022-10-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/bca43b7c0fffa049510dd170048f347b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vELwSvfAY2q7vEWaTOcA_A.png"/></div></div></figure><p id="37ed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/logging/docs/audit#data-access" rel="noopener ugc nofollow" target="_blank">数据访问审计日志</a>用于跟踪和监控在任何GCP资源上创建、修改或读取用户数据或元数据的API调用。默认情况下，数据访问审计日志是禁用的(BigQuery数据访问审计日志除外)，因为它们会导致生成的日志数量激增，进而导致使用成本飙升。</p><p id="7c97" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/logging/docs/audit/configure-data-access#config-console-enable" rel="noopener ugc nofollow" target="_blank">点击此处</a>了解如何启用数据访问审计日志。您会注意到，工作流允许您选择要启用的审核日志的类型(管理员读取、数据读取和数据写入)以及免除审核日志记录的原则。例如，作为调度的一部分，您可能有一个从GCS存储桶中读取数据的Dataproc工作负载。如果您不想为Dataproc使用的服务帐户启用数据访问审计，那么在豁免原则下指定它。</p><p id="4a87" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但在启用数据访问审计日志时，您只能配置这些。如果您想从访问审计中免除某些存储桶，或者更进一步，阻止特定的操作，该怎么办呢？</p><p id="1476" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本帖中，我们将研究如何为选定的GCS存储桶启用数据访问审计，同时将同一项目中的其他存储桶排除在审计之外。</p><p id="b470" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个额外的过滤层将有助于控制日志成本。</p><h1 id="57d8" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">云日志如何工作的快速概述</h1><p id="6d13" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">谷歌云平台(GCP)中的所有日志活动都是通过日志API路由的。日志API使用一个健壮的架构来交付您需要的日志——可靠且准时。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ks"><img src="../Images/8f99a2307aa53edd960228784676a0b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B7SZJ06Ua9Ev5VCM.png"/></div></div></figure><p id="ca05" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">日志条目被发送到日志API，然后通过日志路由器。日志路由器包含定义“哪些”日志需要发送到“哪里”的接收器。</p><p id="3f94" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果接收器配置不正确，日志记录可能会成为您需要支付的最高费用之一。如果启用了数据访问审计日志记录，这一点尤其如此。</p><h1 id="166e" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">解决办法</h1><ul class=""><li id="f39f" class="kx ky hi is b it kn ix ko jb kz jf la jj lb jn lc ld le lf bi translated">一旦您启用了<a class="ae jo" href="https://cloud.google.com/logging/docs/audit#data-access" rel="noopener ugc nofollow" target="_blank">数据访问审计日志</a>，确保您已经免除了所有不需要记录其访问的主体。</li><li id="3c44" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">然后，导航到<strong class="is hj">日志记录- &gt;日志路由器(</strong><a class="ae jo" href="https://pantheon.corp.google.com/logs/router" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/logs/router</a>)</li></ul><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/df7296b789471df3c5d2a02451b2dd79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p6FugJC04-uDeSEppCyBDg.png"/></div></div></figure><ul class=""><li id="7cbc" class="kx ky hi is b it iu ix iy jb lm jf ln jj lo jn lc ld le lf bi translated">您将看到已经为您创建和定义了两个接收器:_Default和_Required</li><li id="c667" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated"><a class="ae jo" href="https://cloud.google.com/logging/docs/routing/overview#required-bucket" rel="noopener ugc nofollow" target="_blank"> _Required </a>是用于路由管理活动日志、系统审计日志和访问透明日志的接收器。该接收器既不能编辑也不能禁用。通过此接收器传送的日志不会产生任何费用。</li><li id="1208" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">_Default是发送所有其他日志(包括数据访问审核日志)的接收器。该接收器可以编辑，也可以禁用。点击3点下拉菜单并选择<strong class="is hj">“编辑水槽”</strong></li></ul><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/5de851493dca3cc50085b243870a14a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R2uy3Kfga1Aoobqr1PA2tg.png"/></div></div></figure><ul class=""><li id="b1c0" class="kx ky hi is b it iu ix iy jb lm jf ln jj lo jn lc ld le lf bi translated">查找标题为— <strong class="is hj">的部分，选择要从水槽中过滤的日志。</strong>您可以在这里定义希望路由器过滤掉哪些日志，而不发送到接收器中指定的目的地。</li></ul><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/3786c6b359592a073d63e1c9123aa06b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9QGgVjJGdCUg93D1yQ3w1Q.png"/></div></div></figure><ul class=""><li id="2b4b" class="kx ky hi is b it iu ix iy jb lm jf ln jj lo jn lc ld le lf bi translated">排除过滤器(以及包含过滤器)需要使用日志查询语言来定义</li><li id="7482" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">在上面的例子中，我定义了一个简单的排除规则，该规则过滤掉一个名为— <strong class="is hj"> demo-bucket </strong>的bucket中API活动产生的数据访问日志。</li></ul><pre class="kt ku kv kw fd lr ls lt lu aw lv bi"><span id="6a21" class="lw jq hi ls b fi lx ly l lz ma">resource.type="gcs_bucket"<br/>resource.labels.bucket_name="demo-bucket"</span></pre><ul class=""><li id="4543" class="kx ky hi is b it iu ix iy jb lm jf ln jj lo jn lc ld le lf bi translated">关于日志查询语言的详细文档可以在<a class="ae jo" href="https://cloud.google.com/logging/docs/view/logging-query-language" rel="noopener ugc nofollow" target="_blank">这里</a>找到</li><li id="b1d1" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">如果您不想使用预定义的<strong class="is hj"> _Default </strong>接收器，您可以创建一个新的接收器，并在那里指定您的自定义规则和条件。确保_Default接收器被禁用，否则日志将被路由到两个目标，从而导致成本增加。</li></ul><p id="97df" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">如果只想排除特定操作怎么办？</strong></p><p id="8b4c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">日志查询语言允许您不仅在资源级别查询日志，而且在操作级别查询日志，前提是在有效负载中定义了元数据。例如，您可以使用下面的查询来排除名为-demo-bucket的存储桶上的所有列表操作</p><pre class="kt ku kv kw fd lr ls lt lu aw lv bi"><span id="26d0" class="lw jq hi ls b fi lx ly l lz ma">resource.type="gcs_bucket"<br/>resource.labels.bucket_name="demo-bucket"<br/>logName="projects/&lt;project-name&gt;/logs/cloudaudit.googleapis.com%2Fdata_access"<br/>protoPayload.methodName="storage.objects.list"</span></pre><p id="0458" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">日志查询语言提供了编写各种复杂查询的机会，使您的过滤器根据您的需要变得通用或细粒度。</p><h1 id="a9ba" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">要记住的事情</h1><ul class=""><li id="cbf6" class="kx ky hi is b it kn ix ko jb kz jf la jj lb jn lc ld le lf bi translated">从接收器中排除的日志条目将继续使用条目。写入API配额，因为过滤发生在日志API接收条目之后</li><li id="219a" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">排除过滤器优先于包含过滤器。因此，如果任何日志条目与排除和包含过滤器重叠，该条目将被排除。</li><li id="7516" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">如果未指定过滤器，则默认情况下会路由所有日志。</li><li id="6728" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">当您排除一个日志条目时，既不会产生接收费用，也不会产生存储费用。</li></ul></div></div>    
</body>
</html>