<html>
<head>
<title>How to preserve your innovation speed and your budget with quotas APIs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何通过配额API保持您的创新速度和预算</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-preserve-your-innovation-speed-and-your-budget-with-quotas-apis-d20557d191ab?source=collection_archive---------0-----------------------#2021-03-16">https://medium.com/google-cloud/how-to-preserve-your-innovation-speed-and-your-budget-with-quotas-apis-d20557d191ab?source=collection_archive---------0-----------------------#2021-03-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/53a28f60a21aea5537533336cea5c4ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rar3siQC8r9RuMxfQsK4nA.png"/></div></div></figure><p id="152d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云有<strong class="is hj">许多好处，其中之一是创新速度</strong>，座右铭是“失败得快，迭代得更快”。事实上，云提供商提议<strong class="is hj">大量的服务来轻松测试和实验</strong>，而在本地环境中测试和实验同样会<strong class="is hj">昂贵或者不可能。</strong></p><ul class=""><li id="a1b8" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">使用Hadoop或Kubernetes创建集群</li><li id="f45e" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">使用图形加速器进行人工智能训练</li><li id="9550" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">部署全球应用程序，…</li></ul><p id="0440" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云平台是很棒的沙箱，你可以花几个小时去试验和尝试。然而，<strong class="is hj">资源并不是免费的</strong>！</p><blockquote class="kc"><p id="0b0e" class="kd ke hi bd kf kg kh ki kj kk kl jn dx translated">在专业网站上有周期性的坏消息，关于导致巨额账单的不良使用(或误用)。</p></blockquote><p id="1127" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">即使谷歌云<strong class="is hj">上的免费层级很慷慨</strong>，一些情况也会<strong class="is hj">导致昂贵的账单</strong>。这种情况让公司和高层管理人员感到害怕，对他们来说，最简单的解决方案是限制用户授权只使用平台的一个子集。<br/><strong class="is hj">不好的一面是，你限制了你的团队的自由和创新能力</strong><strong class="is hj"/>。</p><blockquote class="kc"><p id="89c9" class="kd ke hi bd kf kg kh ki kj kk kl jn dx translated">如何在控制预算和避免滥用的同时继续测试、试验和创新？</p></blockquote><p id="8b55" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">这个问题在你提供给你的用户和/或R&amp;D团队的沙盒/测试项目中尤其重要。</p><h1 id="f4d3" class="kr ks hi bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">谷歌云配额API</h1><p id="fc88" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">另一个<strong class="is hj">解决方案是限制每个服务的开销</strong>，而不是<strong class="is hj">用角色和权限来限制可用服务的集合</strong>。配额API的目的是<strong class="is hj">为每个服务上的可用资源</strong>设置一个上限。</p><p id="0a96" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我想重点介绍两个使用案例:</p><ul class=""><li id="5263" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">BigQuery</li><li id="a78b" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">计算引擎</li></ul><h2 id="05f1" class="lu ks hi bd kt lv lw lx kx ly lz ma lb jb mb mc lf jf md me lj jj mf mg ln mh bi translated">配额自动化</h2><p id="81b7" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">要在您的项目上自动实施配额定义，尤其是沙盒项目，您需要在创建或更新项目时自动设置配额。</p><p id="ce5c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以选择<strong class="is hj">通过API调用或者terraform </strong>来实现。我将介绍这两者，以帮助选择最适合您的用例以及现有项目创建/更新过程的方法。</p></div><div class="ab cl mi mj gp mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hb hc hd he hf"><h1 id="e05c" class="kr ks hi bd kt ku mp kw kx ky mq la lb lc mr le lf lg ms li lj lk mt lm ln lo bi translated">API测试和安全问题</h1><p id="baf4" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">在深入之前，你会看到<strong class="is hj">我使用了</strong> <code class="du mu mv mw mx b"><strong class="is hj">gcurl</strong></code> <strong class="is hj">命令</strong>，它是<code class="du mu mv mw mx b">curl</code>的别名，带有自动填充的安全头(为了方便使用)。你可以在配额API文档中找到如何创建它。</p><p id="aff0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">然而，我不喜欢那个解决方案</strong>，因为它要求我们创建一个服务帐户密钥文件；它暗示了所有可能的安全问题<strong class="is hj"/>。尽管我向谷歌云团队提出了请求，但危险的文档仍然存在。</p><p id="cd97" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以我建议<strong class="is hj">像这样使用你的用户账号</strong><em class="mz">(你需要事先用</em> <code class="du mu mv mw mx b"><em class="mz">gcloud auth init</em></code> <em class="mz">或</em> <code class="du mu mv mw mx b"><em class="mz">gcloud auth login</em></code> <em class="mz">)进行认证</em></p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="db36" class="lu ks hi mx b fi ni nj l nk nl">alias gcurl='curl \<br/>  -H "Authorization: Bearer $(gcloud auth print-access-token)" \<br/>  -H "Content-Type: application/json"'</span></pre><p id="c98e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者甚至通过假冒  <em class="mz">来<strong class="is hj">使用</strong> <a class="ae my" href="https://cloud.google.com/iam/docs/impersonating-service-accounts" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">服务帐户(确保您当前已验证的用户有正确的角色来假冒服务帐户)</strong></a></em></p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="3391" class="lu ks hi mx b fi ni nj l nk nl">alias gcurl='curl \<br/>  -H "Authorization: Bearer $(gcloud auth print-access-token \<br/>  <!-- -->--impersonate-service-account=totoyoyo@gdglyon-cloudrun.iam.gserviceaccount.com<!-- -->)" \<br/>  -H "Content-Type: application/json"'</span></pre><blockquote class="kc"><p id="f5cb" class="kd ke hi bd kf kg nm nn no np nq jn dx translated">保护秘密的最好方法，就是不要有秘密！</p></blockquote><p id="e620" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">所以，如果可以，<strong class="is hj">不要使用服务帐户密钥文件</strong> <em class="mz">(其中包含私有RSA密钥)</em>，除非<a class="ae my" rel="noopener" href="/google-cloud/the-2-limits-of-iam-service-on-google-cloud-7db213277d9c">达到IAM服务的极限</a></p></div><div class="ab cl mi mj gp mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hb hc hd he hf"><h1 id="8d57" class="kr ks hi bd kt ku mp kw kx ky mq la lb lc mr le lf lg ms li lj lk mt lm ln lo bi translated">BigQuery的配额</h1><p id="4d6f" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">BigQuery是一个很棒的玩具:<strong class="is hj">你可以在几秒钟内处理数Pb的数据</strong>！！数据科学家喜欢它，因为<strong class="is hj">他们现在可以实现以前在本地环境中</strong>无法实现的查询。</p><p id="034d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这太棒了，因为您<strong class="is hj">为您在每个查询</strong>中扫描的数据量付费，一天结束时的成本会迅速飙升<em class="mz">(我已经在一个下午看到了10万美元以上！).</em></p><p id="4a73" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">教育是一条正确的道路，但有时也会出现错误。而且没有犯错的余地，<strong class="is hj">用什么付什么。这就是为什么配额对于防止这种情况非常重要！</strong></p><h2 id="09d7" class="lu ks hi bd kt lv lw lx kx ly lz ma lb jb mb mc lf jf md me lj jj mf mg ln mh bi translated">API的BigQuery配额限制</h2><p id="6503" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">在BigQuery上设置配额之前，<strong class="is hj">知道存在哪些配额很重要</strong>。为此，您可以<a class="ae my" href="https://cloud.google.com/service-usage/docs/reference/rest/v1beta1/services.consumerQuotaMetrics.limits.consumerOverrides/list" rel="noopener ugc nofollow" target="_blank">列出配额</a> API中当前可用的配额。</p><p id="6603" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将慢慢开始，直到<strong class="is hj">在BigQuery服务</strong>上列出消费者配额。<em class="mz">我不得不承认，这个API开始时并不容易理解，因为它是通用的，需要适应所有产品的配额。</em></p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="e6a4" class="lu ks hi mx b fi ni nj l nk nl">gcurl https://serviceusage.googleapis.com/v1beta1/projects/&lt;projectId&gt;/services/bigquery.googleapis.com/consumerQuotaMetrics</span></pre><p id="734a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以看到许多您可以增加或减少的配额。<em class="mz">对于我们的用例，</em> <code class="du mu mv mw mx b"><em class="mz">Query usage</em></code> <em class="mz">配额是正确的。</em></p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="492b" class="lu ks hi mx b fi ni nj l nk nl">{<br/>      "name": "projects/751286965207/services/bigquery.googleapis.com/consumerQuotaMetrics/bigquery.googleapis.com%2Fquota%2Fquery%2Fusage",<br/>      <strong class="mx hj">"displayName": "Query usage",</strong><br/>      "consumerQuotaLimits": [<br/>        {<br/>          "name": <strong class="mx hj">"projects/751286965207/services/bigquery.googleapis.com/consumerQuotaMetrics/bigquery.googleapis.com%2Fquota%2Fquery%2Fusage/limits/%2Fd%2Fproject"</strong>,<br/>          <strong class="mx hj">"unit": "1/d/{project}"</strong>,<br/>          "metric": "bigquery.googleapis.com/quota/query/usage",<br/>          "quotaBuckets": [<br/>            {<br/>              "effectiveLimit": "9223372036854775807",<br/>              "defaultLimit": "9223372036854775807"<br/>            }<br/>          ],<br/>          "allowsQuotaIncreaseRequest": true<br/>        },<br/>        {<br/>          "name": <strong class="mx hj">"projects/751286965207/services/bigquery.googleapis.com/consumerQuotaMetrics/bigquery.googleapis.com%2Fquota%2Fquery%2Fusage/limits/%2Fd%2Fproject%2Fuser"</strong>,<br/>          <strong class="mx hj">"unit": "1/d/{project}/{user}",</strong><br/>          "metric": "bigquery.googleapis.com/quota/query/usage",<br/>          "quotaBuckets": [<br/>            {<br/>              "effectiveLimit": "9223372036854775807",<br/>              "defaultLimit": "9223372036854775807"<br/>            }<br/>          ],<br/>          "allowsQuotaIncreaseRequest": true<br/>        }</span></pre><p id="f160" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里有几个有趣的部分:</p><ul class=""><li id="e216" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">将<strong class="is hj">命名为</strong>，因为我们以后会重用它</li><li id="84e1" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">提供配额用途信息的<strong class="is hj">单元</strong>。我们这里有BigQuery查询使用限制:</li></ul><ol class=""><li id="383e" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn nr ju jv jw bi translated">每天和每个项目</li><li id="54b9" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn nr ju jv jw bi translated">每天、每个项目和每个用户</li></ol><p id="d0f8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第二个允许<strong class="is hj">限制项目</strong>的请求者，而不锁定其他人和整个项目本身。有趣的是，你有一个<strong class="is hj">共享项目，一些用户</strong>负责他们的支出，而不是其他人！</p><p id="2e60" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mz">您还可以查看有效和默认限制，以字节为单位。</em></p></div><div class="ab cl mi mj gp mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hb hc hd he hf"><p id="8164" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在有了配额的全称，使用<a class="ae my" href="https://cloud.google.com/service-usage/docs/reference/rest/v1beta1/services.consumerQuotaMetrics.limits.consumerOverrides/create" rel="noopener ugc nofollow" target="_blank"> ConsumerQuota API来创建自定义限额</a>将会更加容易。</p><p id="2d87" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，您需要<strong class="is hj">创建该机构来定义新的配额设置</strong></p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="ec8a" class="lu ks hi mx b fi ni nj l nk nl">{<br/>  "overrideValue":10000000000<br/>}</span></pre><p id="c8bc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mz">将配额设置为每个用户和每个项目每天10Gb</em></p><p id="f93b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">和到<code class="du mu mv mw mx b">POST</code>这个主体到带有<strong class="is hj">配额名称</strong>的服务使用API(在前面的部分中选择)。<em class="mz">使用</em> <code class="du mu mv mw mx b"><em class="mz">gcurl</em></code> <em class="mz">命令进行</em></p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="2806" class="lu ks hi mx b fi ni nj l nk nl">gcurl -d &lt;BODY&gt; \ https://serviceusage.googleapis.com/v1beta1/&lt;NAME&gt;/consumerOverrides</span></pre><p id="bb9a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您从未在BigQuery中为您的项目设置这个配额，<strong class="is hj">它将不会工作</strong>，因为您更改了超过10%的配额。你需要<strong class="is hj">添加一个</strong> <code class="du mu mv mw mx b"><strong class="is hj">force</strong></code> <strong class="is hj">布尔值为真</strong>作为你的URL的查询参数，就像这样</p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="c7c9" class="lu ks hi mx b fi ni nj l nk nl">gcurl -d &lt;BODY&gt; \ https://serviceusage.googleapis.com/v1beta1/&lt;NAME&gt;/consumerOverrides<a class="ae my" href="https://URL?force=true" rel="noopener ugc nofollow" target="_blank"><strong class="mx hj">?force=true</strong></a></span></pre></div><div class="ab cl mi mj gp mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hb hc hd he hf"><p id="dca5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦查询被接受，就会返回操作的ID。<strong class="is hj">像以前一样执行get查询，并查看更改。</strong></p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="e5f5" class="lu ks hi mx b fi ni nj l nk nl">"quotaBuckets": [<br/>            {<br/>              "effectiveLimit": "10000000000",<br/>              "defaultLimit": "9223372036854775807",<br/>              "consumerOverride": {<br/>                "name": "projects/751286965207/services/bigquery.googleapis.com/consumerQuotaMetrics/bigquery.googleapis.com%2Fquota%2Fquery%2Fusage/limits/%2Fd%2Fproject%2Fuser/<strong class="mx hj">consumerOverrides/Cg1RdW90YU92ZXJyaWRl</strong>",<br/>                "overrideValue": "10000000000"<br/>              }<br/>            }<br/>          ],</span></pre><p id="cb4b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你现在可以看到有效的限制，以及<code class="du mu mv mw mx b">consumerOverride</code>的新名字。你将<strong class="is hj">需要的这个全名</strong> <a class="ae my" href="https://cloud.google.com/service-usage/docs/reference/rest/v1beta1/services.consumerQuotaMetrics.limits.consumerOverrides/patch" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">【补丁】</strong> </a> <strong class="is hj">或者</strong> <a class="ae my" href="https://cloud.google.com/service-usage/docs/reference/rest/v1beta1/services.consumerQuotaMetrics.limits.consumerOverrides/delete" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">删除</strong> </a> <strong class="is hj">这个覆盖。</strong></p><h2 id="ef9e" class="lu ks hi bd kt lv lw lx kx ly lz ma lb jb mb mc lf jf md me lj jj mf mg ln mh bi translated">Terraform的BigQuery配额限制</h2><p id="98bb" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">Terraform是DevOps团队用来自动化项目基础设施的常用工具(IaC: Infra as Code)。你也可以用它<strong class="is hj">创建项目和配置环境</strong>。</p><p id="320e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里是之前用<a class="ae my" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/service_usage_consumer_quota_override" rel="noopener ugc nofollow" target="_blank">配额API terraform模块</a>进行POST API调用的例子</p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="deae" class="lu ks hi mx b fi ni nj l nk nl">provider "google" {<br/>  project = "&lt;PROJECT_ID&gt;"<br/>  region = "us-central"<br/>}</span><span id="6444" class="lu ks hi mx b fi ns nj l nk nl">resource "google_service_usage_consumer_quota_override" "override" {<br/>  provider = google-beta<br/>  project = "&lt;PROJECT_ID&gt;"<br/>  service = "bigquery.googleapis.com"<br/>  metric = "bigquery.googleapis.com%2Fquota%2Fquery%2Fusage"<br/>  limit = "%2Fd%2Fproject%2Fuser"<br/>  override_value = "10000000000"<br/>  force = true<br/>}</span></pre><p id="0a70" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mz">因为我</em> <strong class="is hj"> <em class="mz">使用我自己的凭证，我也不需要terraform的服务账号密钥文件</em> </strong> <em class="mz">。在您的工作站上，执行</em> <code class="du mu mv mw mx b"><em class="mz">gcloud auth application-default login</em></code> <em class="mz">到</em> <strong class="is hj"> <em class="mz">在您的运行时上下文</em> </strong> <em class="mz">中设置您的凭证。</em></p><p id="1702" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如你所见，你需要知道度量和极限名称。您无法猜测它们，需要使用GET API的<strong class="is hj">发现阶段</strong>来确定配额的完全限定名称。</p></div><div class="ab cl mi mj gp mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hb hc hd he hf"><h1 id="02f5" class="kr ks hi bd kt ku mp kw kx ky mq la lb lc mr le lf lg ms li lj lk mt lm ln lo bi translated">计算引擎的配额</h1><p id="ef19" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">就成本而言，计算引擎<strong class="is hj">没有BigQuery那么严重。它更具有累进性，成本会随着时间的推移而累积。然而，我已经看到坏演员<strong class="is hj">创建了几十个大型计算引擎实例来挖掘比特币</strong>。</strong></p><p id="43ca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mz"/><strong class="is hj"><em class="mz">不良演员得到了一个开发项目的服务账号密钥文件</em> </strong> <em class="mz">，保护得很差，用它创建了实例。</em> <strong class="is hj"> <em class="mz">这就是为什么</em> </strong> <em class="mz">，我强烈建议</em> <strong class="is hj"> <em class="mz">尽可能不要生成这些敏感文件！</em>T50】</strong></p><p id="7f35" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">希望Google Cloud <strong class="is hj">有自动监控和警报</strong>，以便在<strong class="is hj">出现可疑活动</strong>的情况下联系项目所有者。成本影响很低，但情况可能会更糟！</p></div><div class="ab cl mi mj gp mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hb hc hd he hf"><p id="cb16" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你仔细看看计算引擎CPU默认配额，一个<strong class="is hj">企业账户在几个地区可以使用多达2400个vcpu</strong>(N1家族)<strong class="is hj"/>！出于测试目的，仅在一个区域使用几个CPU就足够了。你可以<strong class="is hj">设置一个配额来限制那个</strong>。</p><p id="a419" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">同时，该配额将<strong class="is hj">减少(潜在的)攻击影响、服务误用</strong>，以及因疏忽的用户忘记停止资源而导致的固有<strong class="is hj">成本…</strong></p><h2 id="63eb" class="lu ks hi bd kt lv lw lx kx ly lz ma lb jb mb mc lf jf md me lj jj mf mg ln mh bi translated">按API计算引擎配额限制</h2><p id="de1d" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">与BigQuery一样，要从计算引擎上的配额开始，查看和发现消费者配额的GET查询是一个很好的起点。</p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="b228" class="lu ks hi mx b fi ni nj l nk nl">gcurl https://serviceusage.googleapis.com/v1beta1/projects/&lt;projectId&gt;/services/compute.googleapis.com/consumerQuotaMetrics</span></pre><p id="6ed1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">还有<strong class="is hj">吨配额</strong>，按地区，按CPU家族，按网络，按GPU家族，……<em class="mz">像这样，你可以比如</em> <strong class="is hj"> <em class="mz">在测试项目上丢弃使用某些CPU家族</em> </strong> <em class="mz">或者GPU</em></p><p id="f503" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我将只关注N1的CPU限制。你应该能看到这个</p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="0f21" class="lu ks hi mx b fi ni nj l nk nl">"name": "projects/751286965207/services/compute.googleapis.com/consumerQuotaMetrics/compute.googleapis.com%2Fcpus",<br/>"displayName": "CPUs",<br/>"consumerQuotaLimits": [<br/>  {<br/>    "name": "projects/553150410541/services/compute.googleapis.com/consumerQuotaMetrics/compute.googleapis.com%2Fcpus/limits/%2Fproject%2Fzone",<br/>    "unit": "1/{project}/{zone}",<br/>    "isPrecise": true,<br/>    "metric": "compute.googleapis.com/cpus",<br/>    "quotaBuckets": [<br/>      {<br/>        "effectiveLimit": "-1",<br/>        "defaultLimit": "-1"<br/>      }<br/>    ]<br/>  },<br/>  {<br/>    "name": "projects/751286965207/services/compute.googleapis.com/consumerQuotaMetrics/compute.googleapis.com%2Fcpus/limits/%2Fproject%2Fregion",<br/>    <strong class="mx hj">"unit": "1/{project}/{region}",</strong><br/>    "isPrecise": true,<br/>    "metric": "compute.googleapis.com/cpus",<br/>    "quotaBuckets": [<br/>      {<br/>        "effectiveLimit": "24",<br/>        "defaultLimit": "24"<br/>      },<br/>      {<br/>        <strong class="mx hj">"effectiveLimit": "2400",</strong><br/>        "defaultLimit": "2400",<br/>        "dimensions": {<br/>          "region": "asia-northeast1"<br/>        }<br/>      },<br/>      {<br/>        <strong class="mx hj">"effectiveLimit": "2400",</strong><br/>        "defaultLimit": "2400",<br/>        "dimensions": {<br/>          "region": "us-east1"<br/>        }<br/>      },<br/>      ......</span></pre><p id="b5ef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如您所见，没有定义的限制，因此默认限制是按地区强制执行的(查看<code class="du mu mv mw mx b">unit</code>字段):在许多地区高达<strong class="is hj">2400 vcpu N1</strong>！</p></div><div class="ab cl mi mj gp mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hb hc hd he hf"><p id="0608" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们减少它！获得一个<code class="du mu mv mw mx b">name</code>字段的副本，并定义<strong class="is hj">这个新的覆盖体</strong>，这次用一个<code class="du mu mv mw mx b">dimensions</code>:region。</p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="7f4b" class="lu ks hi mx b fi ni nj l nk nl">{<br/>  "overrideValue": "5",<br/>  "dimensions": {<br/>    "region": "us-east1"<br/>  }<br/>}</span></pre><p id="b1fb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mz">在美国东部地区将最大CPU设置为5</em></p><p id="f4dc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并将其发布到配额API。</p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="6c19" class="lu ks hi mx b fi ni nj l nk nl">gcurl -d &lt;BODY&gt; \ https://serviceusage.googleapis.com/v1beta1/&lt;NAME&gt;/consumerOverrides</span></pre><p id="836d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mz">与BigQuery部分的模式相同，只是配额的名称发生了变化。</em></p><p id="f123" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在成功调用<em class="mz">(不要忘记</em> <code class="du mu mv mw mx b"><em class="mz">force</em></code> <em class="mz"> query param) </em>之后，您可以执行另一个get到API来检查更新。<strong class="is hj">只有us-east1地区被更改。</strong></p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="0e9a" class="lu ks hi mx b fi ni nj l nk nl">{<br/>  <strong class="mx hj">"effectiveLimit": "5",</strong><br/>  "defaultLimit": "2400",<br/>  "consumerOverride": {<br/>    "name": "projects/751286965207/services/compute.googleapis.com/consumerQuotaMetrics/compute.googleapis.com%2Fcpus/limits/%2Fproject%2Fregion/consumerOverrides/Cg1RdW90YU92ZXJyaWRlGhIKBnJlZ2lvbhIIdXMtZWFzdDE=",<br/>    <strong class="mx hj">"overrideValue": "5"</strong><br/>  },<br/>  "dimensions": {<br/>    "region": "us-east1"<br/>  }<br/>},</span></pre></div><div class="ab cl mi mj gp mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hb hc hd he hf"><p id="d1fb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您还可以<strong class="is hj">在所有地区实施配额</strong>。为此，删除正文中的<code class="du mu mv mw mx b">dimensions</code>,为所有地区设置统一的配额。<strong class="is hj">如果你想只允许使用一个区域，那就很难了</strong>:</p><ol class=""><li id="6ed9" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn nr ju jv jw bi translated">将所有区域设置为0</li><li id="ab1c" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn nr ju jv jw bi translated">在特定区域设置不同的配额，以便只允许使用它。</li></ol><h2 id="352b" class="lu ks hi bd kt lv lw lx kx ly lz ma lb jb mb mc lf jf md me lj jj mf mg ln mh bi translated">使用Terraform计算引擎配额限制</h2><p id="e2e3" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">你可以用terraform达到同样的效果。<br/>同样，您需要准确地知道您想要覆盖的服务、指标和限制名称。GET API请求的第一个发现步骤不是可选的！</p><pre class="na nb nc nd fd ne mx nf ng aw nh bi"><span id="f409" class="lu ks hi mx b fi ni nj l nk nl">provider "google" {<br/>  project = "&lt;PROJECT_ID&gt;"<br/>  region = "us-central"<br/>}</span><span id="e6d2" class="lu ks hi mx b fi ns nj l nk nl">resource "google_service_usage_consumer_quota_override" "override" {<br/>  provider = google-beta<br/>  project = "&lt;PROJECT_ID&gt;"<br/>  service = "compute.googleapis.com"<br/>  metric = "compute.googleapis.com%2Fcpus"<br/>  limit = "%2Fproject%2Fregion"<br/>  override_value = "5"<br/>  dimensions = {<br/>    region = "us-east1"<br/>  }<br/>  force = true<br/>}</span></pre></div><div class="ab cl mi mj gp mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hb hc hd he hf"><h1 id="bc24" class="kr ks hi bd kt ku mp kw kx ky mq la lb lc mr le lf lg ms li lj lk mt lm ln lo bi translated">不再惧怕创新，拥抱创新！</h1><p id="36f0" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">有了Quotas API，您现在可以<strong class="is hj">限制每个服务和每个项目<strong class="is hj">的可用资源量，而不会将授权限制在某些服务</strong>上，因为您担心它们可能的成本！<br/>如果你的数据科学家需要GPU，没问题，但他们只能在一个地区得到几个，而不是每个地区几十个！</strong></p><p id="fffd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您甚至可以<strong class="is hj">使用terraform模块</strong>自动执行这些配额限制，针对每种类型的环境、每个文件夹或任何您想要的内容<strong class="is hj">。</strong></p><p id="5a67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你<strong class="is hj">不再有理由害怕来自你团队的创新</strong>，你只需要<strong class="is hj">鼓励并拥抱它</strong>！</p></div></div>    
</body>
</html>