<html>
<head>
<title>Time series analytics with BigQuery part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用BigQuery的时间序列分析第2部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/time-series-analytics-with-bigquery-part-2-b143a34102b5?source=collection_archive---------2-----------------------#2020-12-11">https://medium.com/google-cloud/time-series-analytics-with-bigquery-part-2-b143a34102b5?source=collection_archive---------2-----------------------#2020-12-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="02ad" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">定义滑动窗口和会话窗口</h2></div><p id="ccda" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jt">这是关于在BigQuery上实现时间序列分析功能的系列文章中的第二篇。</em></p><p id="23a8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae ju" rel="noopener" href="/google-cloud/time-series-analytics-with-bigquery-f65867c1ce74"> <strong class="iz hj">用BigQuery进行时间序列分析</strong> </a></p></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><p id="d78c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">(2021年1月7日更新:本文中的用户定义函数已被添加到<a class="ae ju" href="https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs/community" rel="noopener ugc nofollow" target="_blank"> BigQuery社区UDF</a>中，并略有改动。例如，<a class="ae ju" href="https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs/community#ts_slidets-timestamp-period-int64-duration-int64" rel="noopener ugc nofollow" target="_blank">滑动时间窗口功能</a>可通过<code class="du kc kd ke kf b">bqutil.fn.ts_slide()</code>调用</p><p id="8211" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在第一篇文章中，您使用现在的<a class="ae ju" href="https://github.com/GoogleCloudPlatform/bigquery-utils/blob/master/udfs/community/ts_tumble.sql" rel="noopener ugc nofollow" target="_blank">开源</a>翻转函数在<a class="ae ju" href="https://cloud.google.com/dataflow/docs/reference/sql/streaming-extensions#tumble" rel="noopener ugc nofollow" target="_blank">固定时间窗口</a>上执行了时间聚合。在之前工作的基础上，我们现在来看看如何实现<a class="ae ju" href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#sliding-windows" rel="noopener ugc nofollow" target="_blank">滑动</a> ( <a class="ae ju" href="https://cloud.google.com/dataflow/docs/reference/sql/streaming-extensions#hop" rel="noopener ugc nofollow" target="_blank">跳跃</a>)窗口和<a class="ae ju" href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/windows.html#session-windows" rel="noopener ugc nofollow" target="_blank">会话</a>窗口。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es kg"><img src="../Images/5041c43b326a35ef3288ae4f8a95491d.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/format:webp/1*Uv7X01_GAKYoiLkfhRl2rQ.png"/></div></figure><p id="1f2f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">创建滑动窗口功能</strong></p><p id="c845" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">与固定窗不同，推拉窗的设计是重叠的；例如，你可以每分钟查看股票价格的15分钟移动平均值。因此，一些数据点可能存在于多个窗口中。</p><p id="1686" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要实现该功能，必须知道多长时间(周期)启动一个新窗口，以及多长时间(持续时间)保持该窗口打开。此外，该函数需要返回一个数组来捕获数据点所属的每个窗口。</p><p id="b020" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在BigQuery控制台中创建<code class="du kc kd ke kf b">ts_slide()</code>函数。注意翻转功能的重用，<code class="du kc kd ke kf b">bqutil.fn.ts_tumble()</code>来对齐每个窗口的开始。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="e14c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">使用滑动窗</strong></p><p id="24e2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">直接使用时,<code class="du kc kd ke kf b">ts_slide()</code>将创建一个数组，代表该行所属的每个窗口。在这个例子中，对照两个滑动窗口计算来检查每一行；第一个每5分钟触发一个15分钟窗口，另一个每10分钟触发一个15分钟窗口。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="ko kp l"/></div></figure><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kq"><img src="../Images/dc52cf7169587b44eadc451aa276ac4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9POYnXIc5pFMInMD"/></div></div></figure><p id="9b42" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，这些窗口可以被<a class="ae ju" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/arrays#flattening_arrays" rel="noopener ugc nofollow" target="_blank">展平</a>并按窗口开始时间分组，以创建滚动指标。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="ko kp l"/></div></figure><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kv"><img src="../Images/cc03ab038cb845a04720acb9adb7055c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*q10ft5DBM2AolWw4"/></div></div></figure><p id="c262" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">创建会话窗口</strong></p><p id="6ae4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">会话窗口代表任意长的一系列活动，并通过一系列称为会话间隙的不活动来定义边界。然后，会话边界不是由窗口函数定义的，而是由数据点本身定义的。</p><p id="6a52" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，应用的技术需要将每一行与其相邻行进行比较，以确定该行是在前一行的会话中，还是新会话的开始。那么每一行都可以被赋予适当的会话标识符，作为另一个分析函数的一部分。</p><p id="753c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果某行属于现有会话，下面的便利函数将返回null，如果该行是新会话的开始，将返回时间戳。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="7602" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在可以将<code class="du kc kd ke kf b">ts_session_group()</code>函数与解析的<code class="du kc kd ke kf b">LAG()</code>函数进行比较，以识别每个会话的开始，并将<code class="du kc kd ke kf b">LAST_VALUE()</code>函数与每个记录与其所属的会话窗口相关联。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="ko kp l"/></div></figure><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kw"><img src="../Images/d9f74aa12c1558b62ffa933ebd97e914.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5hzSF_sLmRogVe0N"/></div></div></figure><p id="fcce" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">按会话组分组，您现在可以在会话窗口中聚合活动。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="ko kp l"/></div></figure><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kx"><img src="../Images/6be3ce4cd2851885340da3560923ed5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*H-DexArNH-rQY0vU"/></div></div></figure><p id="4ad2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">使用更大的时间序列数据集</strong></p><p id="5131" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">到目前为止，示例已经查看了一个只有几行的人造数据集。BigQuery包含2009年的Nasdaq样本数据，可用于测试时间序列窗口。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="ko kp l"/></div></figure><p id="53c3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你现在可以计算股票活动的滑动窗口。为了使结果更加清晰，查询将结果限制在<code class="du kc kd ke kf b">INTC</code>和<code class="du kc kd ke kf b">FITB</code>股票报价机。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="ko kp l"/></div></figure><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es ky"><img src="../Images/03f5043bb4137cbc6a2e99ecf6d6c8db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Vy9LqEAZgbGqf9FP"/></div></div></figure><p id="1099" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在来看看由5分钟活动间隙定义的交易时段的活动。低活性库存用于展示可变长度窗口。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="ko kp l"/></div></figure><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kz"><img src="../Images/adf42b3f90f32c772b07b0a6f41004f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sFnC89ZEEiWqn4bh"/></div></div></figure><p id="a588" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">下一步是什么</strong></p><p id="13c6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在以后的文章中，我将介绍近似连接，在不使用滚动窗口的情况下匹配时间戳。此外，我希望这篇文章中的函数能够很快添加到<a class="ae ju" href="https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs/community" rel="noopener ugc nofollow" target="_blank"> BigQuery社区UDF</a>中。</p></div></div>    
</body>
</html>