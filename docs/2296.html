<html>
<head>
<title>Streaming from Google Cloud Pub/Sub to Bigquery without the Middlemen</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Google Cloud Pub/Sub流至Bigquery，无需中间人</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/streaming-from-google-cloud-pub-sub-to-bigquery-without-the-middlemen-327ef24f4d15?source=collection_archive---------0-----------------------#2022-08-10">https://medium.com/google-cloud/streaming-from-google-cloud-pub-sub-to-bigquery-without-the-middlemen-327ef24f4d15?source=collection_archive---------0-----------------------#2022-08-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/2bddee68dc4b8ff7945035567f5b2352.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s3X-uy7hJtfvOtQrowt2pw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://unsplash.com/@mikeyb63?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">迈克尔·巴恩斯</a>在<a class="ae iu" href="https://unsplash.com/s/photos/bypass?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="7181" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要将数据从发布/订阅实时接收到BigQuery，必须利用数据流管道以及模式定义和所需的转换(如果有的话)。不过，如果只需要接收原始数据，或者不需要从发布/订阅转换到大查询，这也是一个挑战。</p><p id="df4e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，为了进一步简化这种简单的用例，谷歌现在已经通过<a class="ae iu" href="https://cloud.google.com/pubsub/docs/bigquery" rel="noopener ugc nofollow" target="_blank">“大查询订阅”</a>推出了来自Pub/Sub的直接流媒体功能。此外，发布/订阅主题模式提供了将发布/订阅消息写入具有兼容模式的BigQuery表的选项。如果没有为您的主题启用模式，消息将作为字节或字符串注册到给定的BigQuery表中。你可以在这里<a class="ae iu" href="https://cloud.google.com/pubsub/docs/bigquery" rel="noopener ugc nofollow" target="_blank">浏览它的细节，但是在这个博客中，我想做一个快速的设置来展示它的简单性，让你对它的实现更舒服。</a></p><p id="f2ab" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们考虑一个场景，您希望利用Google Cloud本机解决方案为CloudSQL MySQL表<em class="jt">【people】</em>到BigQuery构建一个简单的实时CDC管道，例如:</p><ul class=""><li id="404f" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated"><strong class="ix hj">“Debezium Server”</strong>用于捕获MySQL表的变更日志<em class="jt">“people”</em>。</li><li id="c925" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated"><strong class="ix hj">创建BigQuery表</strong><em class="jt">【people 2】</em>，CDC工作负载将被接收到该表中。</li><li id="a226" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated"><strong class="ix hj">使用与BigQuery表<em class="jt">“people 2”</em>兼容的Avro框架创建发布/订阅主题模式</strong>。</li><li id="5c17" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated"><strong class="ix hj">创建与Debezium服务器兼容的发布/订阅主题</strong>，附加到上述主题模式。</li><li id="63bb" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated"><strong class="ix hj">创建附加到上述发布/订阅主题的BigQuery订阅</strong>。</li><li id="1136" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated">启动Debezium服务器,这样它将开始把变更日志作为消息推送到相关的发布/订阅主题。</li><li id="1056" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated">相应的<strong class="ix hj">发布/订阅</strong>消息在被直接推送到提供的<strong class="ix hj">大查询</strong>表之前，利用附加的发布/订阅模式进行解码。</li></ul><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ki"><img src="../Images/ec84ba0e895bbe0b46f3dabaab57f7ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WxFyf9KxRoqHLbDyndWeUQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><strong class="bd kn">作者发布/订阅BigQuery直接流</strong></figcaption></figure><p id="5e4c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，让我们卷起袖子，开始同样的实施:</p><h2 id="0219" class="ko kp hi bd kn kq kr ks kt ku kv kw kx jg ky kz la jk lb lc ld jo le lf lg lh bi translated">设置和配置Debezium服务器:</h2><ul class=""><li id="28d3" class="ju jv hi ix b iy li jc lj jg lk jk ll jo lm js jz ka kb kc bi translated">下载并安装<a class="ae iu" href="https://repo1.maven.org/maven2/io/debezium/debezium-server-dist/1.9.5.Final/debezium-server-dist-1.9.5.Final.tar.gz" rel="noopener ugc nofollow" target="_blank"> Debezium服务器发行版</a>。</li><li id="02c4" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated">配置Debezium服务器<strong class="ix hj"> <em class="jt">”。/conf/application _ properties "</em></strong>，其中将包含与源、宿、格式&amp;适用转换相关的所有配置。</li><li id="842c" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated">以CloudSQL — MySQL数据库作为源，以Google Cloud PubSub作为消息传递基础设施的配置文件如下所示:</li></ul><pre class="kj kk kl km fd ln lo lp lq aw lr bi"><span id="4587" class="ko kp hi lo b fi ls lt l lu lv">debezium.sink.type=pubsub<br/>debezium.sink.pubsub.project.id=&lt;&lt;$PROJECT_ID&gt;&gt;<br/>debezium.source.connector.class=io.debezium.connector.mysql.MySqlConnector<br/>debezium.source.database.hostname=10.67.112.10<br/>debezium.source.database.port=3306<br/>debezium.source.database.user=root<br/>debezium.source.database.password=mysqldb<br/>debezium.source.database.server.id=373472625<br/>debezium.source.database.server.name=mysql<br/>debezium.source.database.include.list=test<br/>debezium.source.table.include.list=test.people<br/>debezium.source.database.history=io.debezium.relational.history.FileDatabaseHistory<br/>debezium.source.database.history.file.filename=data/history.dat<br/>debezium.source.offset.storage.file.filename=data/offsets.dat<br/>debezium.source.offset.flush.interval.ms=0<br/>debezium.source.transforms=unwrap<br/>debezium.source.transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordState<br/>debezium.source.transforms.unwrap.delete.handling.mode=rewrite<br/>debezium.source.key.converter.schemas.enable=false<br/>debezium.source.value.converter.schemas.enable=false</span></pre><ul class=""><li id="f31c" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated">基于BigQuery订阅<a class="ae iu" href="https://cloud.google.com/pubsub/docs/bigquery#schema_compatibility" rel="noopener ugc nofollow" target="_blank">模式兼容性</a>在BigQuery中创建目标表。</li></ul><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lw"><img src="../Images/5a61d71fe2a3f2c913837946486b11a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AQ7ALPfqqI55xGgchF_GuA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><strong class="bd kn">作者的BigQuery表定义</strong></figcaption></figure><ul class=""><li id="536b" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated">用Apache Avro框架创建发布/订阅模式<em class="jt">“MySQL _ bq”</em>。</li></ul><pre class="kj kk kl km fd ln lo lp lq aw lr bi"><span id="8c23" class="ko kp hi lo b fi ls lt l lu lv">{<br/>  "type": "record",<br/>  "name": "Avro",<br/>  "fields": [<br/>    {<br/>      "name": "id",<br/>      "type": "int"<br/>    },<br/>    {<br/>      "name": "first_name",<br/>      "type": "string"<br/>    },<br/>    {<br/>      "name": "last_name",<br/>      "type": "string"<br/>    },<br/>    {<br/>      "name": "email",<br/>      "type": "string"<br/>    },<br/>    {<br/>      "name": "zipcode",<br/>      "type": "int"<br/>    },<br/>    {<br/>      "name": "city",<br/>      "type": "string"<br/>    },<br/>    {<br/>      "name": "country",<br/>      "type": "string"<br/>    },<br/>    {<br/>      "name": "__deleted",<br/>      "type": "string"<br/>    }<br/>  ]<br/>}</span></pre><ul class=""><li id="1d1a" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated">创建与上述模式相关联的发布/订阅主题<em class="jt">“MySQL . test . people”</em>。</li></ul><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/d45af7b96d71d4dd970f36f82d87673b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8_rbykiyCj7ht8GnUxcRbw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><strong class="bd kn">由作者创建连接到mysql_bq模式的发布/订阅主题</strong></figcaption></figure><ul class=""><li id="7141" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated">将BigQuery订阅添加到发布/订阅主题中。</li></ul><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/ee86e2d3e2c84035646aad33708859cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DLjnQv39jAKM208u5lUkfg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><strong class="bd kn">发布/订阅BigQuery订阅，按作者</strong></figcaption></figure><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lz"><img src="../Images/2fbb7742de9f424b6acc1b1373ba585b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mxgoyK-uJEgKcQeAomXhXQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><strong class="bd kn">发布/订阅BigQuery订阅，按作者</strong></figcaption></figure><ul class=""><li id="b420" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated">启动Debezium服务器。</li></ul><pre class="kj kk kl km fd ln lo lp lq aw lr bi"><span id="4359" class="ko kp hi lo b fi ls lt l lu lv"><strong class="lo hj">&lt;&lt;Debezium_Server_Path/run.sh&gt;&gt;</strong></span></pre><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/f974276c2194560b9f16f82d96242914.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-csWtOTvfJ1yUayrfNHN0Q.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><strong class="bd kn">Debezium-服务器输出，作者</strong></figcaption></figure><ul class=""><li id="d0f1" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated"><strong class="ix hj">还有，Wollaaa… </strong>这里，我们在BigQuery中有表格格式的CDC数据。</li></ul><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/13a7fd569e388aed8d56a20d82210feb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UuftPXeFBNQM8ORiHL1RBA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><strong class="bd kn">作者从发布/订阅到BigQuery直播</strong></figcaption></figure></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><h1 id="1e71" class="mj kp hi bd kn mk ml mm kt mn mo mp kx mq mr ms la mt mu mv ld mw mx my lg mz bi translated">参考资料:</h1><div class="na nb ez fb nc nd"><a href="https://cloud.google.com/pubsub/docs/subscriber" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab dw"><div class="nf ab ng cl cj nh"><h2 class="bd hj fi z dy ni ea eb nj ed ef hh bi translated">选择订阅类型|云发布/订阅| Google云</h2><div class="nk l"><h3 class="bd b fi z dy ni ea eb nj ed ef dx translated">本文档概述了不同类型的订阅在发布/订阅中的工作方式。重点:了解一个…</h3></div><div class="nl l"><p class="bd b fp z dy ni ea eb nj ed ef dx translated">cloud.google.com</p></div></div><div class="nm l"><div class="nn l no np nq nm nr io nd"/></div></div></a></div><div class="na nb ez fb nc nd"><a href="https://cloud.google.com/pubsub/docs/bigquery" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab dw"><div class="nf ab ng cl cj nh"><h2 class="bd hj fi z dy ni ea eb nj ed ef hh bi translated">BigQuery订阅|云发布/订阅文档| Google云</h2><div class="nk l"><h3 class="bd b fi z dy ni ea eb nj ed ef dx translated">BigQuery订阅在收到消息时将其写入现有的BigQuery表。你不需要…</h3></div><div class="nl l"><p class="bd b fp z dy ni ea eb nj ed ef dx translated">cloud.google.com</p></div></div><div class="nm l"><div class="ns l no np nq nm nr io nd"/></div></div></a></div><div class="na nb ez fb nc nd"><a href="https://faun.pub/writing-a-pub-sub-stream-to-bigquery-401b44c86bf" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab dw"><div class="nf ab ng cl cj nh"><h2 class="bd hj fi z dy ni ea eb nj ed ef hh bi translated">将发布/订阅流写入BigQuery</h2><div class="nk l"><h3 class="bd b fi z dy ni ea eb nj ed ef dx translated">我们将探索Google云平台的两个重要组件:PubSub和BigQuery。</h3></div><div class="nl l"><p class="bd b fp z dy ni ea eb nj ed ef dx translated">faun.pub</p></div></div><div class="nm l"><div class="nt l no np nq nm nr io nd"/></div></div></a></div></div></div>    
</body>
</html>