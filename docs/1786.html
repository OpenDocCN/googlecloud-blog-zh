<html>
<head>
<title>Automating database migration on GCP with Ansible and Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Ansible和Terraform实现GCP数据库的自动迁移</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/automating-database-migration-on-gcp-with-ansible-and-terraform-2d7c094293cb?source=collection_archive---------0-----------------------#2021-02-03">https://medium.com/google-cloud/automating-database-migration-on-gcp-with-ansible-and-terraform-2d7c094293cb?source=collection_archive---------0-----------------------#2021-02-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="fdc4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据是新的石油。这就是为什么大公司会生成和处理数十亿的数据记录，以便详细了解客户的需求。这也不可避免地揭示了一些挑战(例如性能或高可用性)并推动了一些需求(例如迁移到云)。</p><h1 id="dfc4" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">迁移的需要，</h1><p id="62f5" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">是否从内部迁移到云；从云到云；或者对于云计算，拥有一个迁移策略对于高效响应您的业务增长至关重要。</p><h2 id="f8a8" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">自动化迁移，</h2><p id="562a" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">自动化迁移是DATA&amp;BI团队最终目标的一部分。这支持在<strong class="ih hj"> D </strong>数字<strong class="ih hj"> S </strong>服务<strong class="ih hj"> M </strong>市场管理和迁移数据即服务，这是一种端到端解决方案，用于:</p><ul class=""><li id="7aa4" class="ku kv hi ih b ii ij im in iq kw iu kx iy ky jc kz la lb lc bi translated">将数据库从一个环境(例如生产环境)备份和恢复到另一个环境(例如开发环境)。</li><li id="02a3" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">将数据从一个平台(例如Openstack)迁移到另一个平台(例如GCP)。</li></ul><h2 id="2897" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">在幕后，</h2><p id="a714" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">正如我们所看到的，这样做的必要性是显而易见的，过程也很容易描述。这就是为什么首先想到的是，这个工具能够完成工作的每一部分。然而，技术上这是不可能的。由于安全政策的原因，一个可以在云提供商和移动数据库之间跳跃的项目是不被允许的。即使是这样，从架构的角度来看也是不太好的——考虑到产品的复杂性和可维护性。</p><h2 id="f122" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">架构概述，</h2><p id="048a" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">分而治之，每个云提供商一个项目。让我们保持简单。</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es li"><img src="../Images/287765cc15f325a446083caeec9e46bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LuLyThatBD3alMwSZ-8WxA.png"/></div></div><figcaption class="lu lv et er es lw lx bd b be z dx translated">全球架构概述</figcaption></figure><h1 id="4ff1" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">路线图，</h1><p id="edab" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">在我们考虑在平台之间迁移数据库之前，我们必须先从环境入手(Poc、dev、re7和prod ),然后再将这些点连接起来:</p><ol class=""><li id="e442" class="ku kv hi ih b ii ij im in iq kw iu kx iy ky jc ly la lb lc bi translated">为每个云提供商提供服务:将数据库从一个环境备份和恢复到另一个环境。</li><li id="9d8f" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc ly la lb lc bi translated">一项服务，将作为平台之间的项目调度程序。</li></ol><p id="865e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们必须了解每个云提供商的工作方式，并考虑客户的反馈。这就是我们选择以这种方式运作的原因。在达到最终目标之前，我们还有很多东西要学。</p><h1 id="243c" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">谷歌云平台，优先</h1><p id="11be" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">出于财政和技术两方面的原因，我们必须首先把GCP的情况综合起来。</p><h2 id="6006" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">令人敬畏的项目</h2><p id="a548" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated"><strong class="ih hj">I</strong>n基础结构<strong class="ih hj"> a </strong> s <strong class="ih hj"> C </strong> ode部分以及<strong class="ih hj"> C </strong>配置<strong class="ih hj"> M </strong>管理部分由以下目录表示:</p><ul class=""><li id="5259" class="ku kv hi ih b ii ij im in iq kw iu kx iy ky jc kz la lb lc bi translated">太棒了-项目/地形。</li><li id="80ce" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">真棒-项目/ansible。</li></ul><p id="5dee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基础设施的创建和数据库从一个环境到另一个环境的迁移之间的流程是由gitlab-CI管道编排的。</p><h2 id="db36" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">用Terraform编码基础设施，</h2><p id="37fb" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">terraform工具负责创建必要的基础设施来执行数据库迁移。更准确地说，这包括:</p><ul class=""><li id="dd4f" class="ku kv hi ih b ii ij im in iq kw iu kx iy ky jc kz la lb lc bi translated">awesome-project/terraform/01-instances:创建一个VM (Runner)实例，通过它我们可以扮演我们的角色(脚本)。</li><li id="2f1d" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">awesome-project/terraform/02-storage:在环境之间创建一个共享的GCP存储桶。</li></ul><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lz"><img src="../Images/94499397d9b7f9803fefe01ac1a98441.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cOeWSCrxPuZTdi4Fwy66Kw.png"/></div></div><figcaption class="lu lv et er es lw lx bd b be z dx translated">GCP —建筑概述</figcaption></figure><h2 id="14c1" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">Ansible的配置管理，</h2><p id="5442" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">Ansible部分旨在通过一组共享相同上下文的脚本(Ansible角色)来定义要完成的操作:</p><ul class=""><li id="dd00" class="ku kv hi ih b ii ij im in iq kw iu kx iy ky jc kz la lb lc bi translated">awesome-project/ansi ble/roles/rn-d b-export:将数据库从源环境导出到GCP桶，即转储。</li><li id="f8c1" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">awesome-project/ansi ble/roles/rn-d b-import:将数据库从GCP存储桶导入到目标环境，恢复它。</li><li id="7c43" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">awesome-project/ansi ble/roles/rn-d b-import-export-common:共同的基本操作、先决条件(例如输入和规则验证、保险库请求)。</li></ul><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es ma"><img src="../Images/63dfe31ec1f1d830770714a7f2eef89e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ogq6KDtgZVvKvqngb8uSuA.png"/></div></div><figcaption class="lu lv et er es lw lx bd b be z dx translated">GCP —配置管理流程</figcaption></figure><h2 id="ccf6" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">最终结果，</h2><p id="ca03" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">客户端必须通过我们的<strong class="ih hj"> D </strong>数字<strong class="ih hj"> S </strong>服务<strong class="ih hj"> M </strong>市场提交一个带有不同输入的请求(例如source_env、database、target_env、service_id等。).</p><p id="0814" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦通过验证，gitlab-ci管道将负责所有的迁移过程。</p><h2 id="4cee" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">下一步，</h2><ul class=""><li id="4e96" class="ku kv hi ih b ii kb im kc iq mb iu mc iy md jc kz la lb lc bi translated">接近零的停机时间迁移。</li><li id="a2b8" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">持续反馈。</li><li id="f8b6" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">探索云提供商的DMS(数据库迁移服务)。</li></ul></div></div>    
</body>
</html>