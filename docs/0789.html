<html>
<head>
<title>Customizing Kubernetes Logging (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">定制Kubernetes日志记录(第1部分)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/customizing-kubernetes-logging-part-1-a1e5791dcda8?source=collection_archive---------0-----------------------#2018-10-09">https://medium.com/google-cloud/customizing-kubernetes-logging-part-1-a1e5791dcda8?source=collection_archive---------0-----------------------#2018-10-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2dc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在生产中调试应用程序时，您可以使用的最强大的工具之一就是日志。它们非常容易创建，给你自由输出你想要的任何东西，并且相对容易使用。然而，每个开发人员都喜欢自己的输出格式，这使得那些负责跨服务、应用程序甚至Kubernetes集群进行故障排除或分析的人员很难以结构化或一致的方式使用日志。让我们举一个非常简单的例子——输出一个值。</p><p id="dd38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我决定利用这个机会扩展我微薄的Python技能，并创建了一个简单的应用程序，除了随机生成日志消息之外，它几乎没做什么。具体来说，它输出一个简单的冒号分隔的消息，如下所示(如默认的Stackdriver日志记录查看器所示，没有任何修改):</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="17bb" class="jm jn hi ji b fi jo jp l jq jr">logging.error(“myError:” + randomString)</span></pre><p id="bafb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="06a3" class="jm jn hi ji b fi jo jp l jq jr">logging.warn("myWarning:" + randomString)</span></pre><p id="3f8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我真正关心的消息有两部分——冒号前后的部分。具体来说，我想知道错误和警告的值是否有区别！理想情况下，我只想将所有日志发送到BigQuery，并在那里进行分析——但是整个有效负载都在一个名为<em class="js"> textPayload </em>的字段中，并且我不具备SQL中的字符串解析技能。那现在怎么办？</p><p id="d6b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好吧，谢天谢地，Stackdriver最近开始支持结构化日志，你可以在这里<a class="ae jt" href="https://cloud.google.com/logging/docs/structured-logging" rel="noopener ugc nofollow" target="_blank">阅读全部内容</a>。另一个博客<a class="ae jt" href="https://cloud.google.com/blog/products/gcp/getting-more-value-from-your-stackdriver-logs-with-structured-data" rel="noopener ugc nofollow" target="_blank">帖子</a>也很好地描述了结构化日志的整体价值。对于我们这里的目的，我们希望使用结构化日志记录，通过正则表达式将一行分解成多个字段。坏消息是，现有的指令仅适用于虚拟机上运行的日志代理。让我们看看我们是否能在Kubernetes上做这个工作？</p><p id="7794" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 0 —设置集群并部署(“新”)日志记录</strong></p><p id="c2ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在GKE集群上部署Stackdriver日志记录非常简单，这里有很好的记录<a class="ae jt" href="https://cloud.google.com/monitoring/kubernetes-engine/customizing" rel="noopener ugc nofollow" target="_blank"/>。我不会在这里重复说明，但是我准确地遵循了它们，我建议您也这样做。我将假设您已经创建了您的集群，并从现在开始设置了您的kubectl上下文和凭证。</p><p id="1870" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1 —部署应用程序</strong></p><p id="b8e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们有了一个集群，我们需要在其上运行一些东西来生成我在这里讨论的那种日志。我已经在<a class="ae jt" href="https://github.com/yuriatgoogle/python-logging" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上发布了我的代码(请不要对我评头论足)。让我们将它部署到我们的集群中。</p><p id="4be9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们将克隆回购:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="1344" class="jm jn hi ji b fi jo jp l jq jr">$ git clone <a class="ae jt" href="https://github.com/yuriatgoogle/python-logging" rel="noopener ugc nofollow" target="_blank">https://github.com/yuriatgoogle/python-logging</a><br/>$ cd python-logging</span></pre><p id="e053" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将使用云构建来构建容器映像(在设置了<code class="du ju jv jw ji b">project_id</code>变量之后):</p><p id="fafe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ju jv jw ji b">$ gcloud container builds submit --tag gcr.io/${project_id}/python-logging:latest</code></p><p id="fa1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并通过检查云构建-&gt;构建历史中的构建历史来验证它是否工作:</p><figure class="jd je jf jg fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jx"><img src="../Images/e3f0163a271a310fcdd6314ca45d95d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1SDs3LRaSO6jc6Tr2P2myg.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx translated">成功了！</figcaption></figure><p id="596c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们准备部署。我已经提供了(非常简单的)。我在回购中使用的yaml文件。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="9b35" class="jm jn hi ji b fi jo jp l jq jr">$ kubectl create -f ./<a class="ae jt" href="https://k8s.io/docs/tasks/debug-application-cluster/counter-pod.yaml" rel="noopener ugc nofollow" target="_blank">p</a>ython-logging.yaml<br/>deployment "python-logging" created</span></pre><p id="1a1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们通过在部署前创建一个负载平衡器并测试它来确保我们可以访问部署:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="3c5a" class="jm jn hi ji b fi jo jp l jq jr">$ kubectl expose deployment python-logging --type=LoadBalancer<br/>service "python-logging" exposed</span><span id="b800" class="jm jn hi ji b fi kj jp l jq jr">$ kubectl get services<br/>NAME             TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE<br/>kubernetes       ClusterIP      10.47.240.1     &lt;none&gt;        443/TCP          47m<br/>python-logging   LoadBalancer   10.47.240.242   &lt;your IP&gt;     5000:32361/TCP   32s</span><span id="c927" class="jm jn hi ji b fi kj jp l jq jr">$ curl http://&lt;your IP&gt;:5000<br/>myDebug:4903403857</span></pre><p id="40ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，我们可以查看日志来确认我们要解决的问题。</p><figure class="jd je jf jg fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es kk"><img src="../Images/0447459a043451044ff2f70c5e10461e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8gXfkw0Gs17SQq7yl-uFTg.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx translated">选择日志</figcaption></figure><figure class="jd je jf jg fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es kl"><img src="../Images/17cc15167b8c809f284114f348d1d5ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6sN2bqKdfW7k_RUyfb1C5A.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx translated">所有内容都在textPayload中</figcaption></figure><p id="4edc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2 —部署自己的定制日志</strong></p><p id="9b11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在有趣的部分来了。我们将修改Stackdriver日志记录部署的configMap，以包含一个新的过滤模式，将我们的日志条目分成单独的字段。</p><p id="4063" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们看看我们的日志代理部署已经创建了什么:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="f304" class="jm jn hi ji b fi jo jp l jq jr">$ kubectl get ns<br/>NAME                 STATUS    AGE<br/>default              Active    11d<br/>kube-public          Active    11d<br/>kube-system          Active    11d<br/>stackdriver-agents   Active    3d</span><span id="ae4d" class="jm jn hi ji b fi kj jp l jq jr">$ kubectl get cm -n stackdriver-agents<br/>NAME                   DATA      AGE<br/>cluster-config         2         3d<br/>google-cloud-config    1         3d<br/>logging-agent-config   4         3d</span><span id="e575" class="jm jn hi ji b fi kj jp l jq jr">$ kubectl get ds -n stackdriver-agents<br/>NAME                         DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE<br/>stackdriver-logging-agent    3         3         3         3            3           &lt;none&gt;          3d<br/>stackdriver-metadata-agent   3         3         3         3            3           &lt;none&gt;          3d</span></pre><p id="1957" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们需要。yaml文件，它将允许我们修改这个配置。它可以在公共Stackdriver GitHub库<a class="ae jt" href="https://github.com/Stackdriver/kubernetes-configs" rel="noopener ugc nofollow" target="_blank">这里</a>获得。按照那里的说明，在对<em class="js"> logging-agent.yaml </em>文件进行更改之后，您需要重新编译<em class="js"> agents.yaml </em>文件。</p><p id="6bcd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一种选择是通过如下方式从部署中直接提取配置文件:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="aef2" class="jm jn hi ji b fi jo jp l jq jr">$ kubectl get cm logging-agent-config -n stackdriver-agents -o yaml &gt;&gt; cm.yaml</span></pre><p id="ea24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和deploymentSet:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="06fd" class="jm jn hi ji b fi jo jp l jq jr">$ kubectl get ds stackdriver-logging-agent -n stackdriver-agents -o yaml &gt;&gt; ds.yaml</span></pre><p id="dd59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果配置不能很好地“往返”,这可能会导致问题，所以我建议使用存储库中的文件。</p><p id="68d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们根本不需要修改deploymentSet，但是我们将更改configMap以包含一个新的过滤器来处理我们的日志条目。修改cm.yaml文件，在“containers.input.conf: |-”下添加Python输出的过滤器(添加粗体的3行)。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="0fc5" class="jm jn hi ji b fi jo jp l jq jr">&lt;filter reform.**&gt;<br/>  @type parser<br/>  format multi_format<br/><strong class="ji hj">  &lt;pattern&gt;<br/>    format /^(?&lt;severity&gt;.*):(?&lt;logger&gt;.*):(?&lt;outputName&gt;.*):(&lt;outputValue&gt;.*)/<br/>  &lt;/pattern&gt;</strong><br/>  &lt;pattern&gt;<br/>  format /^(?&lt;severity&gt;\w)(?&lt;time&gt;\d{4} [^\s]*)\s+(?&lt;pid&gt;\d+)\s+(&lt;source&gt;[^ \]]+)\] (?&lt;log&gt;.*)/<br/>  &lt;/pattern&gt;<br/>  &lt;pattern&gt;<br/>    format none<br/>  &lt;/pattern&gt;<br/>  reserve_data true <em class="js"># note that this doubles the size of the log, as both parsed and unparsed data would be kept. Set to “false” if you only care about the unparsed data.</em><br/>  suppress_parse_error_log true<br/>  key_name log<br/>&lt;/filter&gt;</span></pre><p id="5184" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建新的配置映射并重新部署代理:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="bb72" class="jm jn hi ji b fi jo jp l jq jr">$ kubectl replace -f ./cm.yaml --force &amp;&amp; kubectl delete pods -n stackdriver-agents -l app=stackdriver-logging-agent</span></pre><p id="e7a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那需要大约一分钟。完成后，您可以尝试刷新您的应用程序URL并再次检查Stackdriver日志记录。您的日志现在应该看起来像这样——注意，我们现在有一个<em class="js"> jsonPayload </em>字段，其中我们关心的值被分离出来。</p><figure class="jd je jf jg fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es km"><img src="../Images/64ee9a14f4a1dbd6639463da5e4c7fd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B-ItNFu5U1aXTq75JDXbAw.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx translated">那就好多了！</figcaption></figure><p id="d606" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3 —现在怎么办？</strong></p><p id="1251" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以，我们的日志现在是结构化的！这实际上让我做什么？好吧，让我们将这些导出到BigQuery，看看会得到什么。</p><figure class="jd je jf jg fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es kn"><img src="../Images/b2533b8cbf94cf92314522cce9a98fed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gOauC4sph_ITA2KXhKIG3Q.png"/></div></div></figure><p id="fe1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有两点需要注意:</p><p id="4941" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">a.已经创建了数据集和表——在我的例子中，表是为日志创建的，并以今天的日期命名。</p><p id="3057" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">b.jsonPayload中的每个字段都是表中单独的一列！</p><p id="770f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以做各种有趣的事情！我将展示一个基本的BigQuery查询，当消息只是一个警告时，它将对所有值进行平均:</p><figure class="jd je jf jg fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es ko"><img src="../Images/2c08d78a4f6b022ffb0d4f49b1d1a5b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HlNt2TZiawEiyzLTJzQ6Vw.png"/></div></div></figure><p id="6796" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您当然可以从这里开始，但是我想展示如何在GKE集群上定制日志配置，并使用Stackdriver日志生成结构化日志！</p><p id="0498" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第2部分中，我的计划是重新审视这个基本方法，并研究如何</p><ol class=""><li id="1967" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc ku kv kw kx bi translated">使用舵图部署</li><li id="6206" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">跨更大规模的集群和部署管理过滤器</li></ol><p id="d13c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">祝我好运！</p><p id="b2f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">资源</strong></p><p id="4adc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">K8s文档:<a class="ae jt" href="https://kubernetes.io/docs/tasks/debug-application-cluster/logging-stackdriver/#deploying" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/tasks/debug-application-cluster/logging-stack driver/# deploying</a></p><p id="c892" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">解决方案:<a class="ae jt" href="https://cloud.google.com/solutions/customizing-stackdriver-logs-fluentd" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/solutions/customizing-stack driver-logs-fluentd</a></p><p id="752f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Fluentd配置:<a class="ae jt" href="https://github.com/GoogleCloudPlatform/container-engine-customize-fluentd/tree/master/kubernetes" rel="noopener ugc nofollow" target="_blank">https://github . com/Google cloud platform/container-engine-customize-fluentd/tree/master/kubernetes</a></p><p id="0563" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Stackdriver结构化测井:<a class="ae jt" href="https://cloud.google.com/logging/docs/structured-logging" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/logging/docs/structured-logging</a></p><p id="ef5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">定制Kubernetes监控:<a class="ae jt" href="https://cloud.google.com/monitoring/kubernetes-engine/customizing" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/monitoring/Kubernetes-engine/定制</a></p></div></div>    
</body>
</html>