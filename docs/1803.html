<html>
<head>
<title>C++ Functions Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">C++函数框架</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/c-functions-framework-21f327fdee16?source=collection_archive---------0-----------------------#2021-02-16">https://medium.com/google-cloud/c-functions-framework-21f327fdee16?source=collection_archive---------0-----------------------#2021-02-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e2463a0e81e00f53c477b0ce2c8c188a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*33MENwPR9kYL4QY9D74Jng.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">带有文本“函数框架”的未更改的C++徽标。在<a class="ae iu" href="http://isocpp.org" rel="noopener ugc nofollow" target="_blank"><em class="iv">isocpp.org</em></a>了解更多关于标准C++的信息</figcaption></figure><p id="9cd3" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><a class="ae iu" href="https://github.com/GoogleCloudPlatform/functions-framework-cpp" rel="noopener ugc nofollow" target="_blank"> C++函数框架</a>是一个开源库，允许你用C++编写无服务器函数，并轻松部署到云运行。</p><p id="1764" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">在这篇博客中，我们将逐步安装框架并部署您的第一个无服务器C++函数。</p><h2 id="5ad5" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jh kf kg kh jl ki kj kk jp kl km kn ko bi translated">设置云壳</h2><p id="1ea5" class="pw-post-body-paragraph iw ix hi iy b iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp kt jr js jt hb bi translated">对于预装工具的稳定环境，让我们使用Cloud Shell—Google Cloud的在线Shell环境。</p><p id="72b3" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">这里开个全屏壳:<a class="ae iu" href="http://shell.cloud.google.com/?show=terminal" rel="noopener ugc nofollow" target="_blank">shell.cloud.google.com/?show=terminal</a></p><p id="0f5d" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">这个环境带有像<code class="du ku kv kw kx b">docker</code>和<code class="du ku kv kw kx b">pack</code>这样的工具，我们很快就会用到它们。您可以使用以下命令验证它们是否已安装:</p><pre class="ky kz la lb fd lc kx ld le aw lf bi"><span id="bbaf" class="ju jv hi kx b fi lg lh l li lj">docker --version<br/># Example output: Docker version 20.10.3, build 48d30b5<br/><br/>pack --version<br/># Example output: 0.17.0+git-d9cb4e7.build-2045</span></pre><h2 id="1912" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jh kf kg kh jl ki kj kk jp kl km kn ko bi translated">获取示例代码</h2><p id="34f7" class="pw-post-body-paragraph iw ix hi iy b iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp kt jr js jt hb bi translated">C++函数框架包括入门示例。在您的主目录中下载框架:</p><pre class="ky kz la lb fd lc kx ld le aw lf bi"><span id="120a" class="ju jv hi kx b fi lg lh l li lj">cd $HOME<br/>git clone <a class="ae iu" href="https://github.com/GoogleCloudPlatform/functions-framework-cpp" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/functions-framework-cpp</a></span></pre><p id="ffd8" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">本指南的其余部分将假设您在此repo的目录中发出命令:</p><pre class="ky kz la lb fd lc kx ld le aw lf bi"><span id="ba86" class="ju jv hi kx b fi lg lh l li lj">cd $HOME/functions-framework-cpp</span></pre><p id="f928" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我们将使用HTTP hello world示例，如下所示:</p><figure class="ky kz la lb fd ij"><div class="bz dy l di"><div class="lk ll l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">C++中的Hello World函数</figcaption></figure><blockquote class="lm ln lo"><p id="0f94" class="iw ix lp iy b iz ja jb jc jd je jf jg lq ji jj jk lr jm jn jo ls jq jr js jt hb bi translated">注意上面示例中函数框架的gcf HTTP请求和响应类以及<a class="ae iu" href="https://github.com/nlohmann/json" rel="noopener ugc nofollow" target="_blank"> nlohmann JSON解析</a>。</p></blockquote><h2 id="701f" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jh kf kg kh jl ki kj kk jp kl km kn ko bi translated">设置构建包</h2><p id="8b35" class="pw-post-body-paragraph iw ix hi iy b iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp kt jr js jt hb bi translated">我们将使用<a class="ae iu" href="https://buildpacks.io/" rel="noopener ugc nofollow" target="_blank"> Cloud Native Buildpacks </a>来创建将被部署到Cloud Run的容器映像。第一次运行这些命令可能需要几分钟，甚至一个小时，这取决于工作站的性能。</p><p id="5f2f" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">运行以下命令:</p><pre class="ky kz la lb fd lc kx ld le aw lf bi"><span id="c065" class="ju jv hi kx b fi lg lh l li lj">docker build -t gcf-cpp-develop -f build_scripts/Dockerfile .<br/>docker build -t gcf-cpp-runtime --target gcf-cpp-runtime -f build_scripts/Dockerfile build_scripts<br/>pack builder create gcf-cpp-builder:bionic --config pack/builder.toml<br/>pack config trusted-builders add gcf-cpp-builder:bionic<br/>pack config default-builder gcf-cpp-builder:bionic</span></pre><h2 id="b563" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jh kf kg kh jl ki kj kk jp kl km kn ko bi translated">在本地构建Docker映像</h2><p id="e20a" class="pw-post-body-paragraph iw ix hi iy b iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp kt jr js jt hb bi translated">设置完成后，使用<code class="du ku kv kw kx b">pack</code>命令用你的函数构建一个Docker镜像:</p><pre class="ky kz la lb fd lc kx ld le aw lf bi"><span id="f648" class="ju jv hi kx b fi lg lh l li lj">pack build \<br/>  --builder gcf-cpp-builder:bionic \<br/>  --env FUNCTION_SIGNATURE_TYPE=http \<br/>  --env TARGET_FUNCTION=hello_world_http \<br/>  --path examples/site/hello_world_http \<br/>  gcf-cpp-hello-world-http</span></pre><p id="4e91" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">如果一切顺利，您将看到以下响应:</p><pre class="ky kz la lb fd lc kx ld le aw lf bi"><span id="cfb6" class="ju jv hi kx b fi lg lh l li lj">Successfully built image gcf-cpp-hello-world-http</span></pre><h1 id="e608" class="lt jv hi bd jw lu lv lw ka lx ly lz ke ma mb mc kh md me mf kk mg mh mi kn mj bi translated">(可选)在本地测试容器</h1><p id="7207" class="pw-post-body-paragraph iw ix hi iy b iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp kt jr js jt hb bi translated">可选地，您可以在<code class="du ku kv kw kx b">localhost</code>测试您刚刚创建的Docker容器。运行我们刚刚构建的容器映像:</p><pre class="ky kz la lb fd lc kx ld le aw lf bi"><span id="3c53" class="ju jv hi kx b fi lg lh l li lj">ID=$(docker run --detach --rm -p 8080:8080 gcf-cpp-hello-world-http)</span></pre><p id="eb09" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">然后向您的容器发送一个HTTP请求:</p><pre class="ky kz la lb fd lc kx ld le aw lf bi"><span id="2298" class="ju jv hi kx b fi lg lh l li lj">curl <a class="ae iu" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a><br/># Output: Hello, World!</span></pre><p id="1833" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">不错！完成后，您可以使用以下方法清理容器:</p><pre class="ky kz la lb fd lc kx ld le aw lf bi"><span id="e193" class="ju jv hi kx b fi lg lh l li lj">docker kill "${ID}"</span></pre><h1 id="9923" class="lt jv hi bd jw lu lv lw ka lx ly lz ke ma mb mc kh md me mf kk mg mh mi kn mj bi translated">部署到云运行</h1><p id="73c5" class="pw-post-body-paragraph iw ix hi iy b iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp kt jr js jt hb bi translated">要部署到Cloud Run，我们首先需要构建容器并将其推送到Google Container Registry。</p><p id="946b" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">使用以下命令构建映像并推送到容器注册表:</p><pre class="ky kz la lb fd lc kx ld le aw lf bi"><span id="73ac" class="ju jv hi kx b fi lg lh l li lj">GOOGLE_CLOUD_PROJECT=$(gcloud config get-value project)<br/>pack build \<br/>  --builder gcf-cpp-builder:bionic \<br/>  --env FUNCTION_SIGNATURE_TYPE=http \<br/>  --env TARGET_FUNCTION=hello_world_http \<br/>  --path examples/site/hello_world_http \<br/>"gcr.io/$GOOGLE_CLOUD_PROJECT/gcf-cpp-hello-world-http"</span></pre><p id="a7e7" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">然后，部署到云运行，使用相同的<code class="du ku kv kw kx b">gcr.io</code> URL:</p><pre class="ky kz la lb fd lc kx ld le aw lf bi"><span id="f335" class="ju jv hi kx b fi lg lh l li lj">gcloud run deploy gcf-cpp-hello-world-http \<br/>    --project="${GOOGLE_CLOUD_PROJECT}" \<br/>    --image="gcr.io/${GOOGLE_CLOUD_PROJECT}/gcf-cpp-hello-world-http:latest" \<br/>    --region="us-central1" \<br/>    --platform="managed" \<br/>    --allow-unauthenticated</span></pre><p id="6ad2" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">获取公共运行服务的URL，并通过<code class="du ku kv kw kx b">cURL</code>发送请求:</p><pre class="ky kz la lb fd lc kx ld le aw lf bi"><span id="1d49" class="ju jv hi kx b fi lg lh l li lj">HTTP_SERVICE_URL=$(gcloud run services describe \<br/>    --project="${GOOGLE_CLOUD_PROJECT}" \<br/>    --platform="managed" \<br/>    --region="us-central1" \<br/>    --format="value(status.url)" \<br/>    gcf-cpp-hello-world-http)</span><span id="c896" class="ju jv hi kx b fi mk lh l li lj">curl -H "Authorization: Bearer $(gcloud auth print-identity-token)" "${HTTP_SERVICE_URL}"</span></pre><p id="3709" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">您应该会看到输出<code class="du ku kv kw kx b">Hello World!</code>。</p><p id="7b70" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">恭喜你，你给谷歌云部署了一个C++函数！🎉</p><h1 id="555b" class="lt jv hi bd jw lu lv lw ka lx ly lz ke ma mb mc kh md me mf kk mg mh mi kn mj bi translated">感谢阅读！</h1><p id="bc3c" class="pw-post-body-paragraph iw ix hi iy b iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp kt jr js jt hb bi translated">如果你认为这个项目很有趣，在<a class="ae iu" href="https://github.com/GoogleCloudPlatform/functions-framework-cpp" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上给它打个星，并查看大量的<a class="ae iu" href="https://github.com/GoogleCloudPlatform/functions-framework-cpp/tree/main/examples" rel="noopener ugc nofollow" target="_blank">示例和文档</a>。</p></div></div>    
</body>
</html>