<html>
<head>
<title>GCP CIS Benchmark Terraform Module Testing with Chef Inspec, Kitchen-Terraform &amp; GitHub Actions — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP CIS基准Terraform模块测试与Chef Inspec、Kitchen-terra form &amp; GitHub Actions—第1部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-cis-benchmark-terraform-module-testing-with-chef-inspec-kitchen-terraform-github-actions-d82dabde8290?source=collection_archive---------0-----------------------#2020-09-04">https://medium.com/google-cloud/gcp-cis-benchmark-terraform-module-testing-with-chef-inspec-kitchen-terraform-github-actions-d82dabde8290?source=collection_archive---------0-----------------------#2020-09-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/44550e83c74662efe6df9c145ba89e58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-jzxbxy5Nd0EjMxLmkWWKA.png"/></div></div></figure><p id="d0ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我开始摆弄<a class="ae jo" href="https://github.com/newcontext-oss/kitchen-terraform" rel="noopener ugc nofollow" target="_blank">厨房平台</a>，让<a class="ae jo" href="https://www.chef.io/products/chef-inspec" rel="noopener ugc nofollow" target="_blank">厨师检查</a>我的平台模块的测试和符合性。我目前使用的是<a class="ae jo" href="https://github.com/inspec/inspec-gcp" rel="noopener ugc nofollow" target="_blank"> inspec-gcp </a>资源包和<a class="ae jo" href="https://github.com/GoogleCloudPlatform/inspec-gcp-cis-benchmark" rel="noopener ugc nofollow" target="_blank"> inspec-gcp-cis-benchmark </a>概要文件。本文将重点讨论后者。这样做的驱动力是测试代码的不言而喻的好处，并把一些合理的基本安全标准转移到左边。</p><p id="a3dd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了简单起见，我想从你开始在Google中构建云基础设施时首先要做的事情开始。任何谷歌云平台服务的基础都是一个<a class="ae jo" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" rel="noopener ugc nofollow" target="_blank">项目</a>。我要讲的模块是<a class="ae jo" href="https://github.com/lzysh/terraform-google-project" rel="noopener ugc nofollow" target="_blank">这里是</a>供参考，涵盖了构建项目。这是一个合理的自以为是的terraform模块，适合我的一些用例；然而，我认为它展示了我正在尝试做的事情的例子，而不会太复杂和令人困惑。因为老实说，这对于像我这样的非开发人员、前运营思维的人来说很难。</p><p id="ee6c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">注意:我不会深入介绍设置Terraform、Ruby、Kitchen-Terraform、Chef Inspec等的基础知识。如果那是有趣的，让我知道，也许我能做另外一个职位。</em></p><h1 id="47bd" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated"><strong class="ak">“本地”开发:</strong></h1><p id="6c95" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">从软件开发的实践中学习，我们需要能够“本地”开发。当我在这里说本地时，我们可以认为它是谷歌云平台<a class="ae jo" href="https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy" rel="noopener ugc nofollow" target="_blank">资源层级</a>中的一个沙箱区域，在这里你可以安全地创建和构建基础设施。当您开始开发Terraform <a class="ae jo" href="https://www.terraform.io/docs/configuration/modules.html" rel="noopener ugc nofollow" target="_blank">模块</a>时，您很可能会在main.tf中看到类似这样的内容:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="5865" class="lc jr hi ky b fi ld le l lf lg"># Project Resource<br/># <a class="ae jo" href="https://www.terraform.io/docs/providers/google/r/google_project.html" rel="noopener ugc nofollow" target="_blank">https://www.terraform.io/docs/providers/google/r/google_project.html</a></span><span id="a06d" class="lc jr hi ky b fi lh le l lf lg">resource "google_project" "this" {<br/>  name                = var.project_id<br/>  project_id          = var.project_id<br/>  billing_account     = var.billing_id<br/>  folder_id           = "folders/${var.folder_id}"<br/>}</span></pre><p id="86da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">和一个variables.tf文件，如下所示:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="f851" class="lc jr hi ky b fi ld le l lf lg">variable "billing_id" {<br/>  description = "Billing ID for the project to use"<br/>  type        = string<br/>}</span><span id="3a39" class="lc jr hi ky b fi lh le l lf lg">variable "project_id" {<br/>  description = "Project ID (This will be used for the project name as well)"<br/>  type        = string<br/>}</span><span id="e6e2" class="lc jr hi ky b fi lh le l lf lg">variable "folder_id" {<br/>  description = "Folder ID for the project to be created in."<br/>  type        = string<br/>}</span></pre><p id="965d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在可以运行terraform并创建我们的谷歌云项目:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="bfc5" class="lc jr hi ky b fi ld le l lf lg">terraform init</span><span id="c8d5" class="lc jr hi ky b fi lh le l lf lg">terraform plan -out plan.out \<br/>-var=”billing_id=00000C-AZAZAZ-EFEFEF” \<br/>-var=”project_id=test-del-me-4876des” \<br/>-var=”folder_id=993877078800"</span><span id="e4a7" class="lc jr hi ky b fi lh le l lf lg">terraform apply plan.out</span></pre><p id="2b23" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在你已经启动并运行了一个项目，但是你可能会惊讶于你已经违反了一堆<a class="ae jo" href="https://www.cisecurity.org/cis-benchmarks/" rel="noopener ugc nofollow" target="_blank"> CIS基准</a>！感谢谷歌和人们在<a class="ae jo" href="https://github.com/GoogleCloudPlatform/inspec-gcp-cis-benchmark" rel="noopener ugc nofollow" target="_blank">inspec-GCP-cis-benchmark</a>GitHub知识库中所做的工作；我们可以测试一下！</p><p id="0744" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">注意:这不是一个官方支持的谷歌产品，但希望他们在社区的帮助下维护这个回购。</em></p><p id="1e5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我喜欢这个GitHub项目的第一点是，它直接针对一个特定的谷歌云项目运行。对我来说，这正是我想要运行测试的级别。稍后，我将详细介绍这一点，但是现在，让我们检查一下我们刚刚构建的项目，看看我们需要做什么:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="2142" class="lc jr hi ky b fi ld le l lf lg">inspec exec <a class="ae jo" href="https://github.com/GoogleCloudPlatform/inspec-gcp-cis-benchmark.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/inspec-gcp-cis-benchmark.git</a> \<br/>-t gcp:// — input gcp_project_id=test-del-me-4876des</span></pre><p id="aa1e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">运行该命令后，您将看到一个违规列表。本着测试驱动开发(TDD)的精神，我们有失败的测试，现在我们可以编码来修复它。我们将在下一篇文章中整合这一切。为了简单起见，让我们集中讨论其中的两个:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="af85" class="lc jr hi ky b fi ld le l lf lg">× cis-gcp-4.4-vms: [VMS] Ensure oslogin is enabled for a Project<br/>× cis-gcp-3.1-networking: [NETWORKING] Ensure the default network does not exist in a project</span></pre><p id="bddb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里的想法是，我们在过程中尽可能远地解决这些问题。我仍在“本地”开发如果你在默认网络上部署了一堆东西，三年后，你的安全团队说，我们需要让所有东西都符合CIS你将会有难以控制的操作工作量！现在让我们解决这些合规性问题。为此，我们可以在Terraform模块代码中添加几行代码。然后，您组织中使用它的每个人都将符合标准。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="e6fa" class="lc jr hi ky b fi ld le l lf lg"># Project Resource<br/># <a class="ae jo" href="https://www.terraform.io/docs/providers/google/r/google_project.html" rel="noopener ugc nofollow" target="_blank">https://www.terraform.io/docs/providers/google/r/google_project.html</a></span><span id="9f50" class="lc jr hi ky b fi lh le l lf lg">resource "google_project" "this" {<br/>  name                = var.project_id<br/>  project_id          = var.project_id<br/>  billing_account     = var.billing_id<br/>  folder_id           = "folders/${var.folder_id}"<br/>  auto_create_network = false<br/>}</span><span id="82a8" class="lc jr hi ky b fi lh le l lf lg"># Project Metadata Resource<br/># <a class="ae jo" href="https://www.terraform.io/docs/providers/google/r/compute_project_metadata.html" rel="noopener ugc nofollow" target="_blank">https://www.terraform.io/docs/providers/google/r/compute_project_metadata.html</a></span><span id="292b" class="lc jr hi ky b fi lh le l lf lg">resource "google_compute_project_metadata" "this" {<br/>  project = google_project.this.project_id<br/>  metadata = {<br/>    enable-oslogin = true<br/>  }<br/>}</span></pre><p id="5848" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，您可以销毁之前的项目，并使用下面的代码重新创建它，您将看到您已经通过了测试:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="8122" class="lc jr hi ky b fi ld le l lf lg">✔ cis-gcp-3.1-networking: [NETWORKING] Ensure the default network does not exist in a project<br/>✔ cis-gcp-4.4-vms: [VMS] Ensure oslogin is enabled for a Project</span></pre><p id="347a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不仅如此，我们还从:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="4de0" class="lc jr hi ky b fi ld le l lf lg">Profile Summary: 4 successful controls, 16 control failures, 21 controls skipped</span><span id="557f" class="lc jr hi ky b fi lh le l lf lg">Test Summary: 12 successful, 40 failures, 79 skipped</span></pre><p id="8218" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">收件人:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="a094" class="lc jr hi ky b fi ld le l lf lg">Profile Summary: 5 successful controls, 11 control failures, 22 controls skipped</span><span id="c5cc" class="lc jr hi ky b fi lh le l lf lg"><br/>Test Summary: 7 successful, 12 failures, 80 skipped</span></pre><p id="3756" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我觉得结果不言自明。在下一篇文章中，我们将关注厨房平台。</p></div></div>    
</body>
</html>