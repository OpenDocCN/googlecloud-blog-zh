<html>
<head>
<title>Deterministic encryption/decryption with Cloud KMS using DLP Plugin in Cloud Data Fusion</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在云数据融合中使用DLP插件的云KMS的确定性加密/解密</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/deterministic-encryption-decryption-with-cloud-kms-using-dlp-plugin-in-data-fusion-f237bd2aa5da?source=collection_archive---------2-----------------------#2022-11-26">https://medium.com/google-cloud/deterministic-encryption-decryption-with-cloud-kms-using-dlp-plugin-in-data-fusion-f237bd2aa5da?source=collection_archive---------2-----------------------#2022-11-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="f1f3" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">目标</strong>:为了加密和解密datafusion管道中的数据，可以使用DLP插件。这篇文章提供了在云KMS数据融合中进行确定性加密和解密的分步指南。</p></blockquote></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><h1 id="b6cc" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">步骤:</h1><h2 id="cea9" class="km jp hi bd jq kn ko kp ju kq kr ks jy kt ku kv kc kw kx ky kg kz la lb kk lc bi translated"><strong class="ak"> 1。KMS键</strong></h2><p id="abf5" class="pw-post-body-paragraph ii ij hi il b im ld io ip iq le is it kt lf iw ix kw lg ja jb kz lh je jf jg hb bi translated">管理加密密钥并使用这些密钥执行加密操作。</p><p id="f5d3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated"><strong class="il hj"> 1.1 </strong>进入安全→密钥管理。(如果未启用，请启用Api。)</p><p id="56e6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">你可以按照这里的步骤<a class="ae li" href="https://cloud.google.com/kms/docs/creating-keys#kms-create-symmetric-encrypt-decrypt-gcloud" rel="noopener ugc nofollow" target="_blank">或者继续下面的步骤。</a></p><p id="387d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated"><strong class="il hj"> 1.2 </strong>创建对称加密密钥，创建密钥环:</p><p id="e8ab" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated"><em class="ik">所需角色权限:cloud kms . key rings . create</em><a class="ae li" href="https://cloud.google.com/kms/docs/reference/permissions-and-roles" rel="noopener ugc nofollow" target="_blank"><em class="ik">参见</em> </a></p><p id="7652" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">从密钥管理创建一个密钥环。提及钥匙圈的名称和位置。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es lj"><img src="../Images/d4f0063e7e8f6a86d974ecc4fd97d9d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zge_bXsrD52HmqpfPef45g.png"/></div></div></figure><p id="9579" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated"><strong class="il hj"> 1.3 </strong>创建钥匙圈后，创建一把钥匙，并根据需要提及其他细节。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es lv"><img src="../Images/bf6e68f16586d3ff5fff93ff885fd06d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IpnegOT7V5WygUtQ"/></div></div></figure><p id="5b76" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">1.4复制密钥的资源名称，我们将在接下来的步骤中使用它。</p><pre class="lk ll lm ln fd lw lx ly bn lz ma bi"><span id="2a28" class="mb jp hi lx b be mc md l me mf">projects/xxxxxxx/locations/us-west1/keyRings/mytestkeyring/cryptoKeys/testkey</span></pre><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es mg"><img src="../Images/1a3324fcbe10826d2d1e60dc99a3c389.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Xt4hDU8tChQkKbag"/></div></div></figure><p id="ee25" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">1.5创建一个包装密钥(点击<a class="ae li" href="https://cloud.google.com/dlp/docs/create-wrapped-key" rel="noopener ugc nofollow" target="_blank">此链接</a>或继续此处) :</p><p id="505c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">在具有所需权限的用户的云外壳中，执行以下命令以获取包装的密钥:</p><p id="4537" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">a.</p><pre class="lk ll lm ln fd lw lx ly bn lz ma bi"><span id="4eb0" class="mb jp hi lx b be mc md l me mf">openssl rand -out "./aes_key.bin" 32<br/></span></pre><p id="01d5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">b.</p><pre class="lk ll lm ln fd lw lx ly bn lz ma bi"><span id="304f" class="mb jp hi lx b be mc md l me mf">base64 -i ./aes_key.bin</span></pre><p id="b2cd" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated"><em class="ik">是BASE64_ENCODED_AES_KEY，你得到的输出类似于下面:</em>uedo 6/yKx+zcg 2 cz 1 dbwpvzmvnk/c+jws 7 owpkmc/s =</p><p id="f934" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">c.要包装AES密钥，请使用curl向云KMS API发送以下请求</p><p id="62c0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated"><strong class="il hj">替换从步骤1.4和b返回的密钥</strong>和BASE64_ENCODED_AES_KEY</p><pre class="lk ll lm ln fd lw lx ly bn lz ma bi"><span id="9204" class="mb jp hi lx b be mc md l me mf">curl "https://cloudkms.googleapis.com/v1/projects/xxxxxx/locations/us-west1/keyRings/mytestkeyring/cryptoKeys/testkey:encrypt" \<br/>  --request "POST" \<br/>  --header "Authorization:Bearer $(gcloud auth application-default print-access-token)" \<br/>  --header "content-type: application/json" \<br/>  --data "{\"plaintext\": \"uEDo6/yKx+zCg2cZ1DBwpwvzMVNk/c+jWs7OwpkMc/s=\"}"</span></pre><p id="c2b2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">记下您得到的响应中密文的值。那是你包好的钥匙。我们将在接下来的步骤中使用它。</p><h2 id="e72e" class="km jp hi bd jq kn ko kp ju kq kr ks jy kt ku kv kc kw kx ky kg kz la lb kk lc bi translated"><strong class="ak"> 2 DLP模板</strong></h2><p id="bb3f" class="pw-post-body-paragraph ii ij hi il b im ld io ip iq le is it kt lf iw ix kw lg ja jb kz lh je jf jg hb bi translated">2.1要创建DLP模板，请转到安全→数据丢失防护。如果未启用，请启用Api。</p><p id="db2d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">2.2从配置选项卡创建模板。您可以按照步骤<a class="ae li" href="https://cloud.google.com/dlp/docs/creating-templates-inspect" rel="noopener ugc nofollow" target="_blank">这里的</a>来创建模板。</p><p id="2869" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">2.3创建模板后，复制路径如下:</p><blockquote class="if ig ih"><p id="f9d2" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">项目/xxxxxxx/位置/美国西部1/检查模板/模板1</p></blockquote><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es mh"><img src="../Images/c56c39e0c550f76fb5de0d5940edd220.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z5C7OB88VmlEMHrN29JxYA.png"/></div></div></figure><h2 id="92db" class="km jp hi bd jq kn ko kp ju kq kr ks jy kt ku kv kc kw kx ky kg kz la lb kk lc bi translated">3数据融合管道</h2><p id="73ee" class="pw-post-body-paragraph ii ij hi il b im ld io ip iq le is it kt lf iw ix kw lg ja jb kz lh je jf jg hb bi translated">启用数据融合api。完成后，使用数据融合→实例创建一个数据融合实例</p><p id="6462" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">授予云数据融合使用所选Dataproc服务帐户的权限。单击创建。</p><p id="24f3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">启动可能需要大约20分钟。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es mg"><img src="../Images/3cabdf4e92562f7963bca07d01a5949e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qiE3c8olk6W911qH"/></div></div></figure><p id="0cb3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">一旦实例启动，从顶部菜单进入HUB，搜索“数据丢失”，部署插件“数据丢失预防”</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es mi"><img src="../Images/f1c0fbd5b61f2b06caaaf07c68e818f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OBwY4ajJ_Uq-tLuU"/></div></div></figure><p id="3ad3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">从左侧菜单中选择“管道中的工作室”。我们将创建下面的管道。为了简单和理解，我们将在同一管道中加密和解密。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es mg"><img src="../Images/ba5dbf2f129e11f19a0fa4a43381d63c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CZ9dRchesJhBDKGd"/></div></div></figure><ol class=""><li id="c9fc" class="mj mk hi il b im in iq ir kt ml kw mm kz mn jg mo mp mq mr bi translated">来源:大查询</li></ol><p id="1ad0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">从源中选择大查询，在属性中浏览数据集和表。填写所需信息后，单击验证。您还可以检查输出模式。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es mg"><img src="../Images/2a133893510e9fd87af8860df88ba905.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*h5AqQi0B4rv9rdVv"/></div></div></figure><p id="9bb1" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">你可以在“转换”中看到DLP相关的转换。</p><p id="ee6b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">2.对于加密—从转换中选择Google DLP密文。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div class="er es ms"><img src="../Images/9c9d66380b354d8225b87960fd14b9f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/0*1t63M4Xse9NWfFtW"/></div></figure><p id="57e6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">连接一个大查询源和DLP编校。大查询源的列将在DLP编校中可用。</p><ul class=""><li id="c8a1" class="mj mk hi il b im in iq ir kt ml kw mm kz mn jg mt mp mq mr bi translated">在“属性”部分，选择“是”以使用自定义模板*</li><li id="ef13" class="mj mk hi il b im mu iq mv kt mw kw mx kz my jg mt mp mq mr bi translated">并粘贴步骤2.1中的模板路径，提到相同的资源位置。</li><li id="1d47" class="mj mk hi il b im mu iq mv kt mw kw mx kz my jg mt mp mq mr bi translated">在匹配中选择确定性加密，并选择要加密的输入字段。</li><li id="9de9" class="mj mk hi il b im mu iq mv kt mw kw mx kz my jg mt mp mq mr bi translated">使用加密密钥类型作为“KMS包装密钥”。</li><li id="56f7" class="mj mk hi il b im mu iq mv kt mw kw mx kz my jg mt mp mq mr bi translated">分别提及步骤1.4、1.5.c中的KMS资源ID和包装密钥。</li><li id="674f" class="mj mk hi il b im mu iq mv kt mw kw mx kz my jg mt mp mq mr bi translated">使用您选择的代理键。</li></ul><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es mg"><img src="../Images/695b1a4c970987a180900ae3d28e8cca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*y67uSrYbvOOuSJMC"/></div></div></figure><p id="294b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">3.对于解密—从转换中使用DLP decrypt，并提及与加密相同的所有细节。</p><p id="79c6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">4.Sink:从sink中选择Big query并浏览sink表。确保它具有与DLP decrypt的输出相同的匹配模式。</p><p id="8472" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">确保验证每个节点。此外，授予DLP和KMS相关角色所需的权限。</p><p id="30a9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated"><em class="ik">【在使用具有KMS包装密钥的确定性加密时，云KMS密钥加密器/解密器角色必须被授予云数据丢失防护服务代理】</em></p><p id="cbc7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">转到预览部分并运行。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es mg"><img src="../Images/5ededb1e89d2b878fb8933dfce3d0f99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*08IqEGVR1z1mI66N"/></div></div></figure><p id="e881" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">成功后，使用预览数据检查样本结果。其中a1列是加密的。这是谷歌DLP编校的输出。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es mg"><img src="../Images/aa2f4aee238c8641d49a11d143094c83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QTVMupS4rBQEx8EQ"/></div></div></figure><p id="91c0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">下面是解密后的预览数据。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es mg"><img src="../Images/2267687703e5357ada9a00f5e7fd1220.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*F2NUwuy2AHZXKkFA"/></div></div></figure><p id="360c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kt iv iw ix kw iz ja jb kz jd je jf jg hb bi translated">您可以在源和接收器之间添加更多的转换。完成后，使用deploy部署管道。</p></div></div>    
</body>
</html>