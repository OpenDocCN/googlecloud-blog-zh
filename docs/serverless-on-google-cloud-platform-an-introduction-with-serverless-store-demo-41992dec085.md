# Google 云平台上的无服务器:无服务器商店演示简介

> 原文：<https://medium.com/google-cloud/serverless-on-google-cloud-platform-an-introduction-with-serverless-store-demo-41992dec085?source=collection_archive---------0----------------------->

> 本文是谷歌云平台上的*无服务器:无服务器商店演示指南*的开篇。它在无服务器商店的背景下简要讨论了无服务器计算及其模式，无服务器商店是一个 web 电子商务演示应用程序，用于在 Google 云平台上展示无服务器产品和服务。**无服务器商店不是谷歌的官方产品。**
> 
> 无服务器商店亮相[谷歌云全球数字大会 2019](https://cloudonair.withgoogle.com/events/app-dev) 。查看主题演讲和分组讨论录音，了解更多信息。

# 什么是服务器？

部署一项服务曾经是一项巨大的承诺:为了让一切正常运行，开发人员和运营商必须构建一台服务器，安装操作系统和网络，安装各种依赖项，并为未来数年(如果不是更长的话)的升级和维护做准备。如今，许多开发人员选择使用谷歌、亚马逊和其他云服务提供商提供的虚拟机，利用他们在硬件和网络方面的经验来实现更好、更安全和更可靠的服务部署。尽管如此，虚拟机仍然是服务器；它们以虚拟化的形式运行在云上的事实并没有消除繁重的服务器管理工作负载。此外，虚拟机部署需要仔细的容量规划，而且是按秒计费的；换句话说，每一个空闲的内核和 RAM 单元都是对预算的浪费。

![](img/04f659f6ed0054d3faffeba290837311.png)

无服务器计算承诺了一个(几乎)完全没有服务器管理的随用随付的未来。无服务器平台从开发人员那里获取代码，并执行所有部署任务(联网、依赖、维护等)。)自动退居幕后。无服务器计算提供的最大优势是部署无需额外配置即可自行扩展；在运行时，你的应用程序将总是精确地计算出它们需要的东西(当然，在可理解的误差范围内)。

这并不是说无服务器计算对于每种使用情况都是理想的解决方案。走向无服务器意味着你信任谷歌云平台、AWS 或其他云服务提供商为你管理你的大部分计算堆栈，并期望它们按照你希望的那样运行，但在某些场景下可能并非如此。更重要的是，你的应用的架构对无服务器计算如何保持其无服务器管理的可轻松扩展的承诺有很大的影响:例如，如果你使用基于虚拟机的数据库后端解决方案，如[云 SQL](https://cloud.google.com/sql/) 实例，随着你的无服务器功能部署，其可扩展性将受到 SQL 实例性能的严重限制，如果你不够小心，可能会发生[意外错误](https://cloud.google.com/functions/docs/sql#best_practices_for_cloud_sql_in_cloud_functions)。

## 无服务器和 FaaS(作为服务运行)

AWS Lambda 和 Google Cloud Functions 越来越受欢迎，这让许多人认为 FaaS (Function as a Service)是无服务器计算的同义词。FaaS 平台从开发者那里拿一个功能，构建成 app，部署在云端；它倡导一种非常特殊的应用程序开发模式，即应用程序被分解为一组功能，通过(托管)网关进行分组，用户通过在线提供的静态 HTML 文件进行访问:

![](img/17872ba4d06cc7c1e3dea1af8a8c5f35.png)

有效地将后端转换为 API 服务，这种签名架构享受无服务器计算的所有好处(很少或没有服务器管理、可伸缩性、低成本)，并在不同的级别上实现团队协作(例如，UI 设计现在是分离的；团队成员可以各自处理自己的功能，而不是完整的应用程序)。许多开发人员已经成功地采用了这种模式，并且用最少的努力创造了引人注目的体验。

但是有一个问题。与一般的无服务器计算一样，这种独特的设计并不适合所有的用例，并且存在可怕的碎片化风险:如果没有仔细的协调，开发人员可能会最终获得大量难以评估、监控、维护、协调和保持完整画面的功能，在许多方面类似于 100，000 块拼图。建筑也相当新；开发人员和团队需要一些时间来适应，他们可能需要彻底检查他们的工作流来适应。

[无服务器和 FaaS 不一定是同一个](https://hackernoon.com/the-serverless-series-what-is-serverless-d651fbacf3f4)，强行采用功能思维模式是危险的。建议开发人员尝试无服务器解决方案，并将其集成到他们最熟悉的应用程序中。对于全面了解无服务器计算的团队来说，只使用函数从头构建一个服务可能是可以的；然而，那些对无服务器计算感兴趣但还不太习惯的人应该考虑采用混合方法，首先将一些选定的兼容工作负载迁移到无服务器平台。毕竟，无服务器是一个灵活的误称。

# 事件驱动计算

一般来说，应用程序中的代码是按顺序执行的。序列(或执行路径)本质上是在部署中具体化的契约，由输入(请求)触发，以输出(响应)结束。输入、输出和序列在契约中不可分割地捆绑在一起；一旦部署，就无法修改。开发人员将不得不修改代码并重新部署。

事件驱动计算计划打破契约，释放序列中涉及的所有部分。部件现在在完成时发出一个事件(一条带有执行上下文的消息);他们很少关心接下来会发生什么，并将后续步骤留给交付事件的人来决定，对于云原生应用程序，这通常是一个数据/事件流解决方案，如[谷歌云发布/订阅](https://cloud.google.com/pubsub/)和[阿帕奇卡夫卡](https://kafka.apache.org/)。发送事件的部分是事件发布者，接收事件的部分成为事件订阅者。

这种发布者/订阅者模式允许更大的开发自由度和更容易的团队协作。现在无需重新部署就可以热插拔/交换代码块，开发人员可以轻松地将多个订阅者添加到同一个事件流中，从而创建一个扇出结构。这种结构最突出的一个用例是实时数据分析:

![](img/0d4fd6284e8707181e6d4a76d33a9a88.png)

传统上，数据分析师通常通过自动生成的日志文件批量处理数据。应用程序执行一个序列，将详细信息写入日志记录代理(作为序列的一个步骤)，数据分析团队从这些代理中提取洞察力，延迟是可以理解的。然而，在事件驱动的系统中，一旦作为订阅者之一连接到事件流，数据分析团队就可以在不中断正常操作的情况下实时获得他们需要的数据。如果连接到实时数据处理和仓储解决方案，如[谷歌云数据流](https://cloud.google.com/dataflow/)和[谷歌大查询](https://cloud.google.com/bigquery/)，开发人员也可以进行实时分析。

数据/事件流解决方案本身也为应用程序开发提供了很大的帮助。例如，您可以设置 Google Cloud Pub/Sub，当其中一个用户遇到暂时的技术问题时，它会自动重新尝试发送邮件。云发布/订阅还支持[快照](https://cloud.google.com/pubsub/docs/reference/rest/v1/Snapshot)，使开发人员能够及时返回并回放事件，这在测试新代码时特别有用。

事件驱动计算特别适合无服务器计算。事件是无服务器部署的自然触发器；更重要的是，无服务器计算平台(几乎)无限的可伸缩性允许消息队列尽可能快地传递事件，省去了基于 VM 的部署中常见的容量规划的麻烦。

## 同步操作

打破顺序代码执行的契约有一些严重的复杂性，其中最重要的是输入(请求)和输出(响应)的分离。在事件驱动的计算世界中，请求和响应以两个独立的维度到达；无论是谁发出请求，都不一定会得到响应。对于异步操作来说，这通常是好的:当人们在他们的社交 feed 中发布一张新照片时，他们通常不希望它立即出现在他们朋友的 feed 中；快速反馈是赞赏的，但不是必需的。然而，同步操作是一个不同的故事。当人们打开一个网站时，他们希望页面能尽快加载；在内容显示出来之前，不能执行任何其他操作。不幸的是，事件驱动的计算在这种情况下不能很好地工作，因为当事件被发布时，请求被认为是服务的；开发人员必须手动检索响应。

有许多解决这个问题的方案，尽管没有一个是完美的。常见的策略包括在整个应用程序中使用静态生成的页面，在事件发布后立即轮询系统以获得结果，并在需要时为同步操作设置专用的异步例程(例如，当人们请求网页时，首先同步准备它，然后将事件发布到消息队列，以便事件订阅者可以跟踪该操作)。再一次，由开发人员自己决定他们愿意在事件驱动计算上走多远；对于一些应用程序来说，这可能是一个天堂般的解决方案。

# 关于无服务器商店演示

如前所述，无服务器商店是一个电子商务应用程序，旨在展示谷歌云平台上的无服务器产品和服务。请注意，这仅用于演示目的，并不一定反映应用程序开发中的最佳实践。

无服务器商店采用完全无服务器的架构。它运行在谷歌提供的两个无服务器计算平台上，[谷歌应用引擎](https://cloud.google.com/appengine/)和[谷歌云功能](https://cloud.google.com/functions/)，以及所有的组件、存储、数据分析、机器学习/人工智能等。，受托管服务支持。根本不涉及任何虚拟机。该应用程序是可扩展的，你只需支付应用程序使用的费用。

无服务器商店由应用程序和功能组成。它是一个混合体，以一个标准的(传统的，如果你可以的话)Python [flask](http://flask.pocoo.org/) web 应用为核心，通过云功能提供许多关键和补充功能。对于喜欢 FaaS 模式的人来说，用相对较少的努力就可以使无服务器存储完全基于功能；您还可以轻松地将其恢复为 web 应用程序，完全不需要云功能工作人员，为虚拟机部署做好准备。

此外，无服务器商店对应用中的所有异步操作采用事件驱动计算。同步操作，比如列出产品，仍然是按顺序执行的。希望这种方法可以帮助感兴趣的开发人员轻松进入事件驱动计算，这是一种相当新的模式，并更好地发现它的好处和局限性。

# 建筑一瞥

![](img/5548ff9b0e0283a99f518c8b0278c770.png)

您可以在这些主题演讲中观看无服务器商店[的现场演示。](https://cloudonair.withgoogle.com/events/app-dev/)

[在此下载项目](https://github.com/GoogleCloudPlatform/serverless-store-demo)。

# 开始之前

*   创建一个新的谷歌云平台项目。如果您喜欢使用现有的方法，请跳过此步骤:

1.  使用您的谷歌帐户登录[谷歌云控制台](https://console.cloud.google.com/)。
2.  点击页面顶部的**选择一个项目**或您现有项目的名称。
3.  点击**新建项目**，按照屏幕提示进行操作。

*   启用计费。谷歌云平台为新客户提供 300 美元信用，您的使用可能有资格获得谷歌云平台免费层。有关更多信息，请参见 [GCP 自由层](https://cloud.google.com/free/)。
*   [安装谷歌云 SDK](https://cloud.google.com/sdk/) 。

# 下一步是什么

以下指南简要介绍了无服务器商店演示应用程序中使用的每种产品和服务，并解释了它们如何集成到应用程序中。按照他们设置无服务器商店:

*   [设置无服务器存储:身份验证、存储、事件流和第三方 API](/@ratrosy/set-up-serverless-store-part-1-auth-storage-event-streaming-and-third-party-apis-c4274a408574)(Firebase 身份验证、云存储、云 Firestore、云发布/订阅和第三方 API)
*   [建立无服务器商店:机器学习、人工智能、数据分析和数据可视化](/@ratrosy/set-up-serverless-store-part-2-machine-learning-api-data-analytics-and-data-visualization-c1399f92b4c8) (Cloud Vision API、Cloud AutoML、DialogFlow +Google Assistant 集成、BigQuery 和 Data Studio)
*   [设置无服务器商店:无服务器计算、管理工具和 Cron 作业](/@ratrosy/set-up-serverless-store-part-3-computing-cron-jobs-and-management-tools-34d51475df70)(应用引擎、云功能、云调度程序、堆栈驱动程序日志记录、堆栈驱动程序监控和堆栈驱动程序跟踪)

有关无服务器商店的一些提示和注意事项，请参见[进一步讨论](/@ratrosy/set-up-serverless-store-further-discussion-ea6c4d04167a)。

[观看谷歌全球数字大会 2019](https://cloudonair.withgoogle.com/events/app-dev) 。