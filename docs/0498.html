<html>
<head>
<title>How to schedule a BigQuery ETL job with Dataprep</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Dataprep调度BigQuery ETL作业</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-schedule-a-bigquery-etl-job-with-dataprep-b1c314883ab9?source=collection_archive---------0-----------------------#2018-01-21">https://medium.com/google-cloud/how-to-schedule-a-bigquery-etl-job-with-dataprep-b1c314883ab9?source=collection_archive---------0-----------------------#2018-01-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9ecc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">BigQuery用户界面允许您执行各种操作——运行交互式查询、另存为表格、导出到表格等。—但是没有办法(目前还没有！)安排查询在特定时间或周期运行。Graham Polley最近运气很好，想出了四个解决办法，都是无服务器的，并且涉及其他GCP产品。但是在我看来，他错过了ETL工作的明显赢家——它灵活、强大、不涉及编码，并且即使在BigQuery团队推出了运行预定查询的能力之后，您也可能希望它出现在您的工具包中。</p><p id="8826" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:BigQuery现在有调度查询，所以请使用它，这样您可以将数据保存在BigQuery中，并利用它的规模和功能。</strong></p><p id="eaf9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文中的方法只有在您进行转换(ETL中的T)时才有用:</p><ol class=""><li id="b747" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">在BigQuery UI中，将所需的查询保存为视图。</li><li id="05b3" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">在Cloud Dataprep中，用BigQuery源代码编写一个新的配方。可选地，向您的配方添加一些转换。例如，您可能想要添加一些公式、去重复、转换等。</li><li id="46e2" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">将转换结果导出到云存储上的BigQuery表或CSV文件</li><li id="4566" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">安排Dataprep流定期运行</li></ol><p id="8b09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果当您尝试复制这些步骤时，UI有所不同，只需稍微搜索一下。功能可能就在那里，只是在不同的地方。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/e6bfaf75a7a990ef3d29cd10e866ad6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MHl6GKkrTznD4z6Jhg02CQ.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">实际上，安排一个定期运行的查询很容易。</figcaption></figure><h1 id="e072" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">1.将BigQuery查询另存为视图</h1><p id="bde4" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">我将演示如何使用一个从公共天气数据集中提取最近天气的查询，因此将它输入到BigQuery UI中，然后另存为视图:</p><pre class="jt ju jv jw fd ll lm ln lo aw lp bi"><span id="2a4e" class="lq kj hi lm b fi lr ls l lt lu">#standardSQL<br/>SELECT<br/>  date,<br/>  MAX(prcp) AS prcp,<br/>  MAX(tmin) AS tmin,<br/>  MAX(tmax) AS tmax<br/>FROM (<br/>  SELECT<br/>    wx.date AS date,<br/>    IF (wx.element = 'PRCP',<br/>      wx.value/10,<br/>      NULL) AS prcp,<br/>    IF (wx.element = 'TMIN',<br/>      wx.value/10,<br/>      NULL) AS tmin,<br/>    IF (wx.element = 'TMAX',<br/>      wx.value/10,<br/>      NULL) AS tmax<br/>  FROM<br/>    `bigquery-public-data.ghcn_d.ghcnd_2018` AS wx<br/>  WHERE<br/>    id = 'USW00094846'<br/>    AND DATE_DIFF(CURRENT_DATE(), wx.date, DAY) &lt; 15 )<br/>GROUP BY<br/>  date<br/>ORDER BY<br/>  date ASC</span></pre><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es lv"><img src="../Images/b6e98a4e6c0e2081611989ac7da0cfd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_0_JONH5UDEmy1Gr_amOXQ.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">将查询另存为视图</figcaption></figure><h1 id="2765" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">2.在Cloud Dataprep中，编写一个新的配方</h1><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es lw"><img src="../Images/920d0ffbfb08b9a80580a7ddb5db9989.png" data-original-src="https://miro.medium.com/v2/resize:fit:1052/format:webp/1*_Kk5E1b9Cgh3QV925oJPXA.png"/></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">步骤1:从GCP web控制台启动Dataprep</figcaption></figure><h2 id="0334" class="lq kj hi bd kk lx ly lz ko ma mb mc ks iq md me kw iu mf mg la iy mh mi le mj bi translated">创建新流程</h2><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es mk"><img src="../Images/8ba553f660220a3c7f7dfd9057e88dbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FQbKNQgWisnW5zLJj_jPiQ.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">食谱是流程的一部分</figcaption></figure><h2 id="aba7" class="lq kj hi bd kk lx ly lz ko ma mb mc ks iq md me kw iu mf mg la iy mh mi le mj bi translated">将BigQuery视图作为Dataprep数据集导入</h2><p id="cd59" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">单击Import Datasets，按照UI流程进入BigQuery数据集，并将新创建的current_weather视图作为Dataprep数据集导入。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es ml"><img src="../Images/5e6e7e5f3548013791307fb91e138944.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KoU1hYVUZ4qlLfPc02JhxA.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">将current_weather BigQuery视图作为Dataprep数据集导入</figcaption></figure><h2 id="3f59" class="lq kj hi bd kk lx ly lz ko ma mb mc ks iq md me kw iu mf mg la iy mh mi le mj bi translated">添加新配方并编辑它</h2><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es mm"><img src="../Images/f205025ef41af3914863c37825727010.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*k-4EGQsWcHpA-kaVuxWofQ.png"/></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">向配方中添加步骤</figcaption></figure><h2 id="5935" class="lq kj hi bd kk lx ly lz ko ma mb mc ks iq md me kw iu mf mg la iy mh mi le mj bi translated">添加配方步骤以进一步转换数据</h2><p id="572d" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">点击“Edit recipe”后，Dataprep将取出数据集的一个样本，并向您显示列、它们的分布等。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es mn"><img src="../Images/8519a579df7f19190aac942c7d9f4f31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iD8MPrHPMHh5D7vwb-faZg.png"/></div></div></figure><p id="e481" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击蓝色加号按钮，向配方添加一个步骤。我们将删除数据列为空的所有行:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es mo"><img src="../Images/332f5f92e5c9a585ff6746cec94293c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xIFtuiF39KT7uNrGNMc9jg.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">编写删除转换来删除符合条件的行</figcaption></figure><p id="8710" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，当您编写公式时，Dataprep会向您显示哪些行/列会受到影响。</p><h1 id="392c" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">3.运行作业以导出数据</h1><p id="0f83" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">点击“运行作业”。默认情况下，在云存储上创建一个CSV文件，但是我们可以通过单击铅笔(“编辑”)图标将其更改为BigQuery:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es mp"><img src="../Images/64432e2432210de6e692e4523e594990.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*joXAykcZmetL5PiJfUe16g.png"/></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">在BigQuery中将作业的输出更改为写入数据集</figcaption></figure><p id="38b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单击“运行作业”运行一次。这里，我们要求作业在每次运行时删除并替换表，但是正如您所看到的，还有其他选项。这作为数据流作业运行，即规模化和分布式。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es mq"><img src="../Images/39719e8e4a4e37a839043c8a8c4d786a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W0DcIcE9q8vLssqCSYZGsA.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">Dataprep流作为数据流作业运行！使用数据流不需要写Java/Python。</figcaption></figure><h1 id="f61c" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">4.安排作业定期运行</h1><p id="449d" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">转到Dataprep UI的“流”部分，并点击您的新流旁边的三个按钮。您将看到一个添加时间表的选项:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es mr"><img src="../Images/16e7e97d3154c4c24045b4972248be36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UkmEPAThKkLvh239pZkl8Q.png"/></div></div></figure><p id="e3e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选项包括每日、每周等。而且还支持crontab格式，以获得更大的灵活性:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es ms"><img src="../Images/f6075b58d925fd5a6a6f9b7b69827878.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9xS5Yvz0BQCJQD8E6x3Bzg.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">安排作业定期运行</figcaption></figure><p id="06a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！</p></div></div>    
</body>
</html>