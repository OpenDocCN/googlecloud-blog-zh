<html>
<head>
<title>Resize Persistent Disk in Google Container Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在谷歌容器引擎中调整持久磁盘的大小</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/resize-persistent-disk-in-google-container-engine-414825d68554?source=collection_archive---------1-----------------------#2017-10-16">https://medium.com/google-cloud/resize-persistent-disk-in-google-container-engine-414825d68554?source=collection_archive---------1-----------------------#2017-10-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c5aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前，似乎没有任何自动化的方式来支持GKE持久磁盘的大小调整。换句话说，你不能简单地跑:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="a60e" class="jm jn hi ji b fi jo jp l jq jr">$ gcloud compute disks resize my-disk-1 --size=1TB</span></pre><p id="3900" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让库伯内特斯集装箱把它捡起来…</p><p id="64ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我有两种不同的情况。第一，我在deployment.yaml中定义了一个分区号，因为我从一个具有预定义大小和分区的映像构建了持久磁盘；第二，我没有从映像构建，只是创建了没有分区信息的持久磁盘。我们来谈谈前者是这样创造出来的:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="53f9" class="jm jn hi ji b fi jo jp l jq jr">$ gcloud compute images create jenkins-home-image --source-uri \<br/><a class="ae js" href="https://storage.googleapis.com/solutions-public-assets/jenkins-cd/jenkins-home-v3.tar.gz" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/solutions-public-assets/jenkins-cd/jenkins-home-v3.tar.gz</a></span><span id="6605" class="jm jn hi ji b fi jt jp l jq jr">$ gcloud compute disks create --size=50GB jenkins-home \ <br/>--image jenkins-home-image</span></pre><p id="02c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里需要注意一些事情。这张图是10G。如果映像有一个预定义的大小和分区，就像这个一样，那么即使在创建它的时候将持久磁盘的大小设置为50G，您仍然需要使用fdisk并调整大小。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="a0e6" class="jm jn hi ji b fi jo jp l jq jr">WARNING: Some requests generated warnings:</span><span id="0f6c" class="jm jn hi ji b fi jt jp l jq jr">- Disk size: '50 GB' is larger than image size: '10 GB'. You might need to resize the root repartition manually if the operating system does not support automatic resizing. See https://cloud.google.com/compute/docs/disks/persistent-disks#repartitionrootpd for details.</span></pre><p id="528e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是yaml:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="22fc" class="jm jn hi ji b fi jo jp l jq jr">volumes:<br/> - gcePersistentDisk:<br/>    fsType: ext4<br/>    partition: 1<br/>    pdName: jenkins-home<br/>   name: jenkins-home</span></pre><p id="6750" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以…我必须登录到运行容器的虚拟机实例，并实际运行fdisk。首先删除分区，然后用相同的起始扇区号重新创建分区，然后写入分区。</p><p id="d7e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过运行lsbk找到该设备:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="478b" class="jm jn hi ji b fi jo jp l jq jr">$ lsblk |grep -1 kubernetes<br/>sdb       8:16   0   50G  0 disk<br/>└─sdb1    8:17   0   50G  0 part /home/kubernetes/containerized_mounter/rootfs/var/lib/kubelet/pods/c195bc3a-b055-11e7-9337-42010a8e001b/volumes/kubernetes.io~gce-pd/my-home</span></pre><p id="b911" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后做你的fdisk如上所述的东西，再次注意开始扇区，并使用相同的，否则你会被软管..</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="72c9" class="jm jn hi ji b fi jo jp l jq jr">fdisk /dev/sdb</span><span id="6f7a" class="jm jn hi ji b fi jt jp l jq jr">Welcome to fdisk (util-linux 2.28.2).<br/>Changes will remain in memory only, until you decide to write them.<br/>Be careful before using the write command.</span><span id="fd11" class="jm jn hi ji b fi jt jp l jq jr">Command (m for help): p<br/>Disk /dev/sdb: 100 GiB, 107374182400 bytes, 209715200 sectors<br/>Units: sectors of 1 * 512 = 512 bytes<br/>Sector size (logical/physical): 512 bytes / 4096 bytes<br/>I/O size (minimum/optimal): 4096 bytes / 4096 bytes<br/>Disklabel type: dos<br/>Disk identifier: 0x642e6196</span><span id="356a" class="jm jn hi ji b fi jt jp l jq jr">Device     Boot Start      End  Sectors Size Id Type<br/>/dev/sdb1        2048 20971519 20969472  10G 83 Linux</span><span id="6b7a" class="jm jn hi ji b fi jt jp l jq jr">Command (m for help): d<br/>Selected partition 1<br/>Partition 1 has been deleted.</span><span id="4d99" class="jm jn hi ji b fi jt jp l jq jr">Command (m for help): n<br/>Partition type<br/>   p   primary (0 primary, 0 extended, 4 free)<br/>   e   extended (container for logical partitions)<br/>Select (default p): p<br/>Partition number (1-4, default 1): <br/>First sector (2048-209715199, default 2048): <br/>Last sector, +sectors or +size{K,M,G,T,P} (2048-209715199, default 209715199):</span><span id="9950" class="jm jn hi ji b fi jt jp l jq jr">Created a new partition 1 of type 'Linux' and of size 100 GiB.</span><span id="e3d1" class="jm jn hi ji b fi jt jp l jq jr">Command (m for help): p<br/>Disk /dev/sdh: 100 GiB, 107374182400 bytes, 209715200 sectors<br/>Units: sectors of 1 * 512 = 512 bytes<br/>Sector size (logical/physical): 512 bytes / 4096 bytes<br/>I/O size (minimum/optimal): 4096 bytes / 4096 bytes<br/>Disklabel type: dos<br/>Disk identifier: 0x642e6196</span><span id="629e" class="jm jn hi ji b fi jt jp l jq jr">Device     Boot Start       End   Sectors  Size Id Type<br/>/dev/sdb1        2048 209715199 209713152  100G 83 Linux</span><span id="bdb2" class="jm jn hi ji b fi jt jp l jq jr">Command (m for help): w<br/>The partition table has been altered.<br/>Calling ioctl() to re-read partition table.<br/>Re-reading the partition table failed.: Device or resource busy</span><span id="0138" class="jm jn hi ji b fi jt jp l jq jr">The kernel still uses the old table. The new table will be used at the next reboot or after you run partprobe(8) or kpartx(8).</span></pre><p id="7688" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后你可以运行:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="2291" class="jm jn hi ji b fi jo jp l jq jr">$ partx -u /dev/sdb</span></pre><p id="c613" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我这样做了，我就可以在设备上运行resize2fs了:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="bf2c" class="jm jn hi ji b fi jo jp l jq jr">$ resize2fs /dev/sdb1</span></pre><p id="4222" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在运行fdisk之前，resize2fs只会让您知道您已经使用了所有的块。一旦所有这些都完成了，你应该能够从你的容器里面看到正确的尺寸。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="20da" class="jm jn hi ji b fi jo jp l jq jr">$ kubectl exec jenkins-3730059860-td55q --namespace jenkins \<br/>-c master -- df -h<br/>Fetching cluster endpoint and auth data.<br/>kubeconfig entry generated for iac-test-cluster.<br/>Filesystem      Size  Used Avail Use% Mounted on<br/>overlay          95G  3.7G   91G   4% /<br/>tmpfs           1.9G     0  1.9G   0% /dev<br/>tmpfs           1.9G     0  1.9G   0% /sys/fs/cgroup<br/>/dev/sda1        95G  3.7G   91G   4% /etc/hosts<br/>/dev/sdb1        <strong class="ji hj">50G</strong>  353M   47G   1% /var/jenkins_home</span></pre><p id="b81d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">后一种情况非常简单。我可以简单地登录虚拟机并运行resize2fs。集装箱很快就发现了它。这些磁盘是这样创建:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="fb0d" class="jm jn hi ji b fi jo jp l jq jr">$ gcloud compute disks create --size=50GB my-data</span></pre><p id="a9ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">yaml在这里:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="757a" class="jm jn hi ji b fi jo jp l jq jr">volumes:<br/> - gcePersistentDisk:<br/>    fsType: ext4<br/>    pdName: my-data<br/>   name: my-data</span></pre><p id="f324" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以希望在我们等待的时候:</p><p id="7cdd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae js" href="https://github.com/kubernetes/kubernetes/issues/35941" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes/kubernetes/issues/35941</a></p><p id="9a71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">..以上是有帮助的。</p></div></div>    
</body>
</html>