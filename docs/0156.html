<html>
<head>
<title>A Survival Guide for Containerizing your Infrastructure — Part 1: Why switch?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基础设施容器化生存指南—第1部分:为什么要转换？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/a-survival-guide-for-containerizing-your-infrastructure-part-1-why-switch-8e8dee9fc66?source=collection_archive---------0-----------------------#2016-10-04">https://medium.com/google-cloud/a-survival-guide-for-containerizing-your-infrastructure-part-1-why-switch-8e8dee9fc66?source=collection_archive---------0-----------------------#2016-10-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d823" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">阅读:我们如何通过仅用7天时间从亚马逊网络服务(AWS)切换到谷歌云平台(GCP)上的Docker容器，将服务器成本削减了75%，并极大地简化了我们的持续集成和部署(CI/CD)。</p><p id="b66d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">为什么你会想读这篇文章:</em></p><ol class=""><li id="3c5e" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">您希望确信您的基础设施使用/切换到Docker/Kubernetes的优点。</li><li id="773f" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">您希望在AWS或Heroku账单上省钱(我们将AWS账单削减了75%！)</li><li id="6cc7" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">您即将开始从AWS过渡到GCP，或者正在开始一个新项目，并希望在这个过程中节省一些时间和头痛。</li></ol><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/3452787fc59b2f0984a25d8e4110bb80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v5Q2tCUDrjWwVB3prkcRfA.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">怀疑？你应该害怕！一开始我也是…</figcaption></figure><blockquote class="ki kj kk"><p id="efb6" class="if ig jd ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">声明:我绝不是devops专家。以下是我作为一名全栈开发人员一头扎进新领域的经历，特别是Docker、Kubernetes和GCP的谷歌容器引擎(GKE)。我写这篇文章的主要原因是为了展示这些新工具是多么容易使用，以及我能够多快地迁移我们的生产架构。我欢迎任何更正、编辑和建议！</p></blockquote><h1 id="6433" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">为什么要集装箱化？</h1><p id="8c2f" class="pw-post-body-paragraph if ig hi ih b ii lm ik il im ln io ip iq lo is it iu lp iw ix iy lq ja jb jc hb bi translated">微服务风靡一时(至少今年如此)，容器在使其可行方面发挥了重要作用。阅读微服务的<a class="ae lr" href="http://martinfowler.com/articles/microservices.html" rel="noopener ugc nofollow" target="_blank">优点</a>和<a class="ae lr" href="http://martinfowler.com/articles/microservice-trade-offs.html" rel="noopener ugc nofollow" target="_blank">缺点</a>，或者如果你是这个话题的新手，听听<a class="ae lr" href="http://a16z.com/2016/09/01/microservices/" rel="noopener ugc nofollow" target="_blank">这个伟大的a16z播客</a>。但是，即使您不想将您的整体应用程序分解成微服务，为您的应用程序的主要架构组件(您的API、前端web应用程序、异步任务工作器、缓存等)利用容器仍然可以提供一些大的优势。那么到底什么是容器呢？</p><blockquote class="ls"><p id="489b" class="lt lu hi bd lv lw lx ly lz ma mb jc dx translated">容器(n):一个密封的软件包，可以快速启动，以标准化的方式运行，本质上是无状态的。</p></blockquote><p id="3f00" class="pw-post-body-paragraph if ig hi ih b ii mc ik il im md io ip iq me is it iu mf iw ix iy mg ja jb jc hb bi translated">容器易于分发，因为它们封装了所有的依赖项，并且可以快速启动/关闭。与虚拟机不同，它们实际上不是完整的操作系统(事实上，多个容器可以在同一个操作系统上运行)。他们避免<strong class="ih hj">网络</strong> <strong class="ih hj">冲突</strong>因为每个容器都有自己的IP地址，他们避免<strong class="ih hj">版本</strong> <strong class="ih hj">冲突</strong>因为每个容器只打包<em class="jd">它需要的</em>库依赖项。</p><blockquote class="ki kj kk"><p id="2697" class="if ig jd ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">例如:如果你熟悉python，你会知道virtualenvs对于在同一个系统上运行多个python应用以避免库版本冲突是至关重要的。有了containers <strong class="ih hj">,您可以告别virtualenvs </strong>,因为您将为每个python应用程序创建不同的容器，每个容器安装自己的依赖项。容器是虚拟的。</p></blockquote><p id="15ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不过在我看来，真正的优势在于Kubernetes，这是一个开源系统，旨在协调你闪亮的新容器之间的<strong class="ih hj">创建、生命周期和</strong> <strong class="ih hj">通信。</strong></p><h2 id="cb8e" class="mh kp hi bd kq mi mj mk ku ml mm mn ky iq mo mp lc iu mq mr lg iy ms mt lk mu bi translated">话太多了…给我看看图片！</h2><p id="2df9" class="pw-post-body-paragraph if ig hi ih b ii lm ik il im ln io ip iq lo is it iu lp iw ix iy lq ja jb jc hb bi translated">在我们深入Kubernetes之前，让我们先回顾一下您可能熟悉的设置。下面是AWS上的一个示例设置，在EC2实例上NGINX后面有一个Django API，另一个实例接受异步任务(Rabbit broker + Celery workers ),并且都可以访问Amazon关系数据库服务(RDS)上的Postgres数据库。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es mv"><img src="../Images/7ce8d08fb16b8af498e95d8996f9c7dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:982/format:webp/1*UgAvHlZFJ7UDiVYQR_jlmQ.png"/></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">AWS上的简单设置</figcaption></figure><p id="0fb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您是一家没有多少devops经验的小型创业公司，那么您设置API组件的思维过程可能如下所示:</p><ul class=""><li id="3739" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc mw jk jl jm bi translated">步骤1: <strong class="ih hj"> </strong>登录AWS web控制台，通过选择一个基本linux映像并指定实例大小来启动一个新的EC2实例。<strong class="ih hj">注意:您每月的账单很大程度上取决于您选择的实例大小。</strong></li><li id="aa9c" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc mw jk jl jm bi translated">步骤2: <strong class="ih hj"> </strong> SSH进入实例并安装所需的包(例如NGINX、python、django)，然后克隆repo的主分支并启动服务。</li><li id="2e6e" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc mw jk jl jm bi translated">第三步:祈祷你的实例永远不会关闭，祈祷你永远不需要改变你的实例的大小，祈祷你的团队中没有人在没有将它记录在“那一个服务器配置google doc”中的情况下对实例进行配置改变。</li></ul><p id="4ea9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> %$ &amp; #！我们有流量，需要规模化！</strong></p><ul class=""><li id="70f0" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc mw jk jl jm bi translated">第4步:右键单击您的实例并“启动更多这样的实例”，然后重复第2步。手动创建一个弹性负载平衡器，并向其中添加API实例。</li><li id="f422" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc mw jk jl jm bi translated">第五步:迅速意识到这是不可持续的，并开始阅读关于自动配置服务器的Chef和进行代码部署和新版本发布的Ansible和AWS CloudFormation的文章，这些文章让你的拼凑架构更具声明性。</li></ul><p id="f6f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你最终成功了，你可能会得到如下结果。这种设置并不简单，如果在实际需要之前就构建，那肯定是大材小用:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es mx"><img src="../Images/45d0a17587b01c488d63d55f87a0cad3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P1TfMcMyc9gwVlHOpsWhfw.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">AWS上的期望状态</figcaption></figure><p id="8877" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，由于EC2实例未得到充分利用，您可能会<strong class="ih hj">扔掉辛苦赚来的现金</strong>……特别是如果您像我们一样，制作了保守的大型实例，这样您就不必在以后经历垂直扩展的麻烦。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es my"><img src="../Images/970abbe974052580a995ecc7c7eb38c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:798/1*UxFgTEx0I4MK9obTxG6_xw.gif"/></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">未充分利用您的EC2实例</figcaption></figure><p id="314c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">听起来熟悉吗？就我个人而言，我对Chef、Ansible和AWS工具集的了解远远超过了我的预期，这让我有这样的感觉:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es mz"><img src="../Images/9f236937e420f6c853d0383eefb52c35.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/1*MoKLLt-zpe1ozfWyk-4V7A.gif"/></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">在AWS上配置EC2实例是什么感觉</figcaption></figure><h1 id="f0fe" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">更好的方法</h1><p id="5bf7" class="pw-post-body-paragraph if ig hi ih b ii lm ik il im ln io ip iq lo is it iu lp iw ix iy lq ja jb jc hb bi translated">好消息是有希望！<strong class="ih hj">仅用了7天(和漫长的夜晚)</strong>我<strong class="ih hj"> </strong>就能够(a)复制我们现有的部署架构，并且(b)通过容器化我们的设置来大幅改进它。当然，<a class="ae lr" href="https://Tripstr.com" rel="noopener ugc nofollow" target="_blank">我的创业公司</a>最近被GCP创业项目<a class="ae lr" href="https://cloud.google.com/developers/startups/" rel="noopener ugc nofollow" target="_blank">接受，所以我们有很强的动力去转换(免费GCP积分！).事后看来，无论如何都是值得的。</a></p><p id="d2dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是在谷歌容器引擎(GKE)上使用Kubernetes的相同设置:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es na"><img src="../Images/3900f44211c63687cace5c5e87cd4d14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mpAo0Bz7Zz5KpoS21lc5bA.png"/></div></div></figure><ul class=""><li id="6fbf" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc mw jk jl jm bi translated"><strong class="ih hj">可伸缩性是默认的。</strong>联网、负载平衡和复制是Kubernetes上的<em class="jd">一等公民</em> <strong class="ih hj"> </strong>。<strong class="ih hj">部署</strong>指定要复制的Docker映像、复制次数，并定义测试容器就绪性的端点。服务除了定义要公开的端口(内部或外部)之外，还处理部署的负载平衡。</li></ul><blockquote class="ki kj kk"><p id="7b1c" class="if ig jd ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">想让6个API容器在线，而不是3个？用“副本:6”修补您的部署配置，然后给自己来一杯冷饮。甚至还有对自动缩放的支持。</p></blockquote><ul class=""><li id="9aee" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc mw jk jl jm bi translated"><strong class="ih hj">资源效率。</strong>你可以看到每个主要组件都被转换成了一个容器。与其猜测每个组件的资源需求，不如将整个集群(您在上面看到的一切)视为一个以简单声明格式定义的<em class="jd">单个逻辑单元</em> <strong class="ih hj"> </strong>。然后，您决定向整个集群授予多少资源(vCPUs的数量和大小),这些资源将在整个集群中平均分配给各个容器。<strong class="ih hj">这一根本性转变包含了我们大部分的成本节约。</strong></li><li id="863c" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc mw jk jl jm bi translated"><strong class="ih hj">简化的持续集成和部署(CI/CD)。</strong>通过将必要的依赖项和应用程序代码打包到容器中，<em class="jd">您完全不需要学习复杂的工具，如Chef(用于服务器配置)和Ansible(用于代码部署)！</em>将一个简单的部署脚本放入CircleCI，该脚本(1)使用您最新的应用程序代码构建一个容器映像，以及(2)修补您的Kubernetes配置以指向新的容器映像，瞧，您的新映像将在您的容器车队中推广。</li></ul><blockquote class="ki kj kk"><p id="0969" class="if ig jd ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">你是一个Heroku用户吗？你在想“但是我付钱给Heroku让他帮我管理这一切！”是的，Heroku提供了自动的可扩展性和无缝的部署管道。但我相信你也知道，你为它们支付了额外费用。我没有足够的数据来支持它，但是我冒昧地猜测，通过转换成容器，您会看到类似的(如果不是更大的)成本节约，并且最终您会得到更多的灵活性。</p></blockquote><p id="4c46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请记住，上面的示例只是将主要组件转换为容器…合乎逻辑的下一步是为每个组件提供完整的微服务。但是一旦你在GKE，这就变成了应用层的挑战。</p><p id="8d3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，细节是魔鬼，学习一个新系统从来都不容易<strong class="ih hj">，但是一旦你掌握了它，你就会开始有这样的感觉:</strong></p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es mz"><img src="../Images/958ce674461ebe1dbd22831220a704c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/1*lmDmE5CWJYcyVkLruZcXMA.gif"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">在GKE上配置Kubernetes是什么感觉</figcaption></figure><p id="015f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">总有不好的一面。消除状态是容器化的最大原因之一，但有时你的手是被迫的。在我们的例子中，我们之前一直使用专门配置的Postgres数据库，并安装了PostGIS以满足我们的地理空间需求。Google的支持团队推荐了一个运行Postgres的Docker容器，该容器附带了一个持久磁盘作为持久卷(Kubernetes术语)。从哲学上来说，就是感觉不对！当然，我们可以尝试转换到Google Cloud SQL这样的服务，但我们的目标是尽可能少地重构应用程序(从而节省时间和金钱)。到目前为止，这对我们来说是有效的。</p><p id="4f51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">公平地说，我应该注意到AWS也有一个<a class="ae lr" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank">容器服务</a>，你可以在这里读到它和GKE <a class="ae lr" href="https://www.quora.com/Whats-the-difference-between-Kubernetes-and-AWS-EC2-Container-Service-What-are-they-each-used-for-Pros-Cons" rel="noopener ugc nofollow" target="_blank">之间的一些区别。但这就是容器的美妙之处…如果AWS为我们提供了足够强大的动力来转换，这应该是相对简单的。</a></p><h1 id="b070" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated"><strong class="ak">回顾:集装箱运输在GKE的主要优势</strong></h1><ol class=""><li id="325e" class="je jf hi ih b ii lm im ln iq nb iu nc iy nd jc jj jk jl jm bi translated"><strong class="ih hj">便携。</strong>任何运行Docker引擎的系统都可以以完全相同的方式运行你的容器<strong class="ih hj">，无论是在GKE、AWS还是在你的个人笔记本电脑上。你甚至可以用一个叫做minikube的东西在你的笔记本电脑上复制你的整个Kubernetes配器…这非常了不起。这意味着(a)对您的部署更有信心,( b)对任何其他支持容器的基础设施提供商来说，切换成本可以忽略不计。</strong></li><li id="fd12" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><strong class="ih hj">陈述性的。</strong>以一种简单的、声明性的格式定义你的架构的状态(容器、网络、可伸缩性的数量)，学习曲线相对较小。避免学习Chef和Ansible等复杂的devops工具，<strong class="ih hj">停止手动配置服务器。</strong></li><li id="c651" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><strong class="ih hj">高效。</strong>在集群级与单个组件级定义您的系统资源需求可以显著节约成本并降低复杂性。</li><li id="5247" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><strong class="ih hj">成熟。</strong> <em class="jd">等一下……一个全新的技术怎么可能成熟？诚然，Kubernetes相对较新，但谷歌已经在这些工具中倾注了几十年从自己的后端系统中学习的经验。以伐木为例。在默认情况下(没有自定义配置)，来自所有容器的stdout和stderr在Google Cloud Logging上以<strong class="ih hj">漂亮的、聚合的、带标签的格式</strong>显示。我在几秒钟内就从“好了，是时候考虑对所有这些容器进行日志记录了”的想法变成了“天哪，我的日志记录已经比以往任何时候都好了”。</em></li></ol><p id="bfc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署软件可能是产品运输中最令人生畏的部分之一。您的目标是在新功能上线时消除意外，无论您是部署较小的副本更改还是推出全新的功能。同样，您需要准备好与您的用户群无缝扩展。我曾多次为自己的初创公司运送产品，从个人经验来看，我可以说集装箱化是一个巨大的飞跃，即使你刚刚开始一个全新的项目。</p><p id="fd74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">准备好转换了吗？请稍后回来阅读第2部分:技巧、窍门和陷阱。</p><p id="26f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">如果您喜欢，请点击💚所以其他人会在媒体上看到这个。</em></p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es ne"><img src="../Images/3a456cae1a8a06196ce99e8f4a751fc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*sOT4F2vAxDtfO5qhBkUoLQ.gif"/></div></div></figure></div></div>    
</body>
</html>