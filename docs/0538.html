<html>
<head>
<title>Simple Clickstream Tracker System using Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google云平台的简单点击流追踪系统</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/clickstream-tracker-system-using-google-cloud-platform-28933149ae4c?source=collection_archive---------0-----------------------#2018-03-16">https://medium.com/google-cloud/clickstream-tracker-system-using-google-cloud-platform-28933149ae4c?source=collection_archive---------0-----------------------#2018-03-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/069d1708054f2d524085170f60d26674.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7lVEvFq_M-PMm78NxPmDQg.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">印度尼西亚西爪哇省苏梅当县西贺兰河</figcaption></figure><h1 id="b2b7" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">概观</h1><p id="4ee5" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">我的灵感来自名为热图的云服务，它提供点击流服务，从存储你的点击流数据开始，直到使用他们的仪表板进行分析服务。在这种情况下，我想在后端建立一个类似的系统，我将使用谷歌云平台(GCP)服务来实现这种技术。</p><p id="bc27" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">我将在这些服务的基础上构建点击流技术的基础设施:</p><ul class=""><li id="6294" class="kv kw hi ju b jv kq jz kr kd kx kh ky kl kz kp la lb lc ld bi translated">云功能，对生产者和消费者都适用。生产者将由HTTP触发器触发，另一方面消费者将由云发布/订阅主题触发器触发</li><li id="4c6a" class="kv kw hi ju b jv le jz lf kd lg kh lh kl li kp la lb lc ld bi translated">云发布订阅，用于生产者和消费者之间的消息传递</li><li id="e85d" class="kv kw hi ju b jv le jz lf kd lg kh lh kl li kp la lb lc ld bi translated">云数据存储，用于有效负载旅程的终端，有效负载存储在该服务中</li><li id="3485" class="kv kw hi ju b jv le jz lf kd lg kh lh kl li kp la lb lc ld bi translated">StackDriver，帮你监控云功能执行的日志</li></ul><p id="0d70" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">下图描述了GCP点击流跟踪器组件之间的关系:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lj"><img src="../Images/2985b4c27813fd2d512558316ab7b4c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X0neJdaxKkro-lyTT41Ddg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">谷歌云平台上的点击流跟踪器架构</figcaption></figure><p id="881f" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">您可以按照下面的说明来部署此存储库中存在的clickstreamTrackerGCP:<a class="ae lo" href="https://bitbucket.org/ridwanbejo/clickstreamtrackergcp" rel="noopener ugc nofollow" target="_blank">https://bitbucket.org/ridwanbejo/clickstreamtrackergcp</a></p><h1 id="6d58" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">说明</h1><h2 id="af2e" class="lp iv hi bd iw lq lr ls ja lt lu lv je kd lw lx ji kh ly lz jm kl ma mb jq mc bi translated">1.生产者的云功能</h2><p id="f8e5" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">-创建新的云函数，名称为<strong class="ju hj">` storeclicstreamproducer`</strong>，内存大小为<strong class="ju hj"> `128 MB` </strong> <br/> -在触发器部分选择HTTP触发器，以接收来自客户端的HTTP请求，例如来自web浏览器、邮递员或其他服务。<br/> -在<strong class="ju hj"> `index.js` </strong>部分，请将index.js中的代码复制到这个存储库中</p><pre class="lk ll lm ln fd md me mf mg aw mh bi"><span id="8c20" class="lp iv hi me b fi mi mj l mk ml">// Imports the Google Cloud client library<br/>const PubSub = require(`@google-cloud/pubsub`);<br/><br/>// Your Google Cloud Platform project ID<br/>const projectId = 'serverlessid';<br/><br/>// Instantiates a client<br/>const pubsubClient = new PubSub({<br/>  projectId: projectId,<br/>});<br/><br/>exports.storeClickStreamProducer = (req, res) =&gt; {<br/>  if (req.body.mouse_position_x === undefined &amp;&amp; req.body.mouse_position_y === undefined) {<br/>    <br/>    res.status(400).send('Bad message!');<br/>  <br/>  } else {<br/>    const dataBuffer = Buffer.from(JSON.stringify(req.body));<br/>    const topicName = "clickstreamTracker";<br/><br/>  pubsubClient<br/>    .topic(topicName)<br/>    .publisher()<br/>    .publish(dataBuffer)<br/>    .then(results =&gt; {<br/>      const messageId = results[0];<br/>      console.log(`Message ${messageId} published.`);<br/>    })<br/>    .catch(err =&gt; {<br/>      console.error('ERROR:', err);<br/>    });<br/><br/>    res.status(200).send(req.body);<br/>    <br/>  }<br/>};</span></pre><p id="09fa" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">-移动到<strong class="ju hj"> `package.json` </strong>选项卡，然后将此json结构复制到文本区域:</p><pre class="lk ll lm ln fd md me mf mg aw mh bi"><span id="ed66" class="lp iv hi me b fi mi mj l mk ml">{<br/> “name”: “storeClickStreamProducer”,<br/> “version”: “0.0.1”,<br/> “dependencies”: {<br/> “<a class="ae lo" href="http://twitter.com/google" rel="noopener ugc nofollow" target="_blank">@google</a>-cloud/pubsub”: “0.16.4”<br/> }<br/>}</span></pre><p id="d769" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">-云函数将自动安装云函数所需的NPM包<br/> -在<strong class="ju hj"> `Function to execute` </strong>输入栏中键入<strong class="ju hj">` storeclicstreamproducer `</strong>,将代码中的函数指向云函数运行时。终于按下了保存键！<br/> -创建功能后，您可以做任何事情。您可以编辑、删除、复制、测试和查看函数<br/>的日志——现在您的云函数自动连接到Stackdriver，并且该函数可以将有效负载发送到PubSub。但是您需要首先创建PubSub主题。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/248d42f0fab1635d401969772338a0bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3XM0sVvqVvBU8d2Jkiydjw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">生产者代码和配置</figcaption></figure><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/3e5d1e2b8a5f010a95c66fd3dfb7b50a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pMluRmVmFkk3Y95gmzWgWA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">生产者监控仪表板</figcaption></figure><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mn"><img src="../Images/7e080387e1db87cf95e36c0256df57b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yAnUv3CQFR778vvZw8zQhw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">生产者执行日志</figcaption></figure><h2 id="2c4d" class="lp iv hi bd iw lq lr ls ja lt lu lv je kd lw lx ji kh ly lz jm kl ma mb jq mc bi translated">2.PubSub上的主题和订阅</h2><p id="a2b0" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">-打开左侧菜单<br/>中的PubSub菜单-创建名为<strong class="ju hj"> `clickstreamTracker` </strong> <br/>的新主题-添加指向您的帐户的<strong class="ju hj"> `PubSub Admin` </strong>的权限，以使您的云功能删除该PubSub上的有效负载<br/> -新主题已准备好接收来自另一个GCP服务的订阅<br/> -我们将在下一节中连接云功能与PubSub。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/7f9cebbdad0efc0f080b0893cf6e31a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Js8_ufDfnA_GbNXHBHSqRQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">主题在发布订阅仪表板中创建的点击流跟踪器</figcaption></figure><h2 id="195a" class="lp iv hi bd iw lq lr ls ja lt lu lv je kd lw lx ji kh ly lz jm kl ma mb jq mc bi translated">3.面向消费者的云功能</h2><p id="8f25" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">-创建名为<strong class="ju hj">` storeclicstreamconsumer`</strong>且内存大小为<strong class="ju hj"> `128 MB` </strong> <br/>的新云函数-在触发器部分选择云发布/订阅主题<br/> -选择在前面部分创建的发布/订阅，主题为<strong class="ju hj">` clickstreamtracker `</strong><br/>-在<strong class="ju hj"> `index.js` </strong>部分，请复制此存储库中consumer.js内的代码</p><pre class="lk ll lm ln fd md me mf mg aw mh bi"><span id="4d07" class="lp iv hi me b fi mi mj l mk ml">// Imports the Google Cloud client library<br/>const PubSub = require(`@google-cloud/pubsub`);<br/>const Datastore = require('@google-cloud/datastore');<br/><br/>// Your Google Cloud Platform project ID<br/>const projectId = 'serverlessid';<br/><br/>// Instantiates a client<br/>const pubsubClient = new PubSub({<br/>  projectId: projectId,<br/>});<br/><br/>// Creates a client<br/>const datastore = new Datastore({<br/>  projectId: projectId,<br/>});<br/><br/>const subscriptionName = 'myclickstreamTrackerSubscription';<br/>const timeout = 60;<br/><br/>// References an existing subscription<br/>const subscription = pubsubClient.subscription(subscriptionName);<br/>const uuidv4 = require('uuid/v4');<br/><br/>exports.storeClickstreamConsumer = (event, callback) =&gt; {<br/>    // The Cloud Pub/Sub Message object.<br/>    const pubsubMessage = event.data;<br/><br/>    // Do something with the message<br/>    console.log(JSON.parse(Buffer.from(pubsubMessage.data, 'base64').toString()));<br/>  <br/>    // The kind for the new entity<br/>    const kind = 'clickstream';<br/>  <br/>    // The name/ID for the new entity<br/>    const name = uuidv4();<br/>    console.log(name);<br/>  <br/>    <br/>  // The Cloud Datastore key for the new entity<br/>  const clickstreamDataKey = datastore.key([kind, name]);<br/><br/>  // Prepares the new entity<br/>  const clickstreamData = {<br/>    key: clickstreamDataKey,<br/>    data: JSON.parse(Buffer.from(pubsubMessage.data, 'base64').toString()),<br/>  };<br/><br/>  // Saves the entity<br/>  datastore<br/>    .save(clickstreamData)<br/>    .then(() =&gt; {<br/>      console.log(`Saved ${clickstreamData.key.name}`);<br/>    })<br/>    .catch(err =&gt; {<br/>      console.error('ERROR:', err);<br/>    });<br/>  <br/>    <br/>  <br/>    // Don't forget to call the callback.<br/>    callback();<br/>};</span></pre><p id="3cbf" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">-移动到<strong class="ju hj"> `package.json` </strong>选项卡，然后将此json结构复制到文本区域:</p><pre class="lk ll lm ln fd md me mf mg aw mh bi"><span id="3405" class="lp iv hi me b fi mi mj l mk ml"><br/>{<br/> “name”: “storeClickStreamConsumer”,<br/> “version”: “0.0.1”,<br/> “dependencies”: {<br/> “<a class="ae lo" href="http://twitter.com/google" rel="noopener ugc nofollow" target="_blank">@google</a>-cloud/datastore”: “1.3.4”,<br/> “<a class="ae lo" href="http://twitter.com/google" rel="noopener ugc nofollow" target="_blank">@google</a>-cloud/pubsub”: “0.16.4”<br/> }<br/>}</span></pre><p id="a93a" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">-云函数将自动安装云函数所需的NPM包<br/> -在<strong class="ju hj"> `Function to execute` </strong>输入栏中键入<strong class="ju hj">` storeclicstreamconsumer`</strong>,将代码中的函数指向云函数运行时。终于按下了保存键！<br/> -创建功能后，您可以做任何事情。您可以编辑、删除、复制、测试和查看函数<br/>的日志-现在您的云函数自动连接到Stackdriver，该函数可以从PubSub接收有效负载，然后将该有效负载存储到云数据存储<br/> -现在您可以选择<strong class="ju hj"> `View Logs` </strong>选项卡来查看来自您所选择的Pub/Sub的传入消息。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/bb4a6fe719296e9d5d7b4016c208eeda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9vMfHmCEN8mn6KyEK8U7HA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">消费者代码和配置</figcaption></figure><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/5b0ad6de2f2508a15ce406b9d682210d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fT8hyaAYj-Ilkqnpz_0k9w.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">消费者功能监控</figcaption></figure><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/39c5832135774f8d77357e613c8cf28e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O34nbAgHyeOX4RHNx7CN6Q.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">消费者功能日志</figcaption></figure><h2 id="2396" class="lp iv hi bd iw lq lr ls ja lt lu lv je kd lw lx ji kh ly lz jm kl ma mb jq mc bi translated">4.云数据存储</h2><p id="6ea8" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">-在云数据存储的控制面板中没有太多配置，您只需选择想要查看的实体<br/> -您可以在控制面板中的<strong class="ju hj"> `clickstream` </strong>实体上浏览数据集，只要有效负载成功存储在云数据存储上</p><h1 id="8cd8" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">它是如何工作的？</h1><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mq"><img src="../Images/f2df5699dcf6adde71008b4c1c2ff8f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9bO3jpPnaDCD7vFMt11e7w.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">点击流跟踪的生产者和消费者准备就绪</figcaption></figure><p id="6075" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">首先，我们发送具有如下示例所示结构的有效负载:</p><pre class="lk ll lm ln fd md me mf mg aw mh bi"><span id="1e61" class="lp iv hi me b fi mi mj l mk ml">{<br/> “mouse_position_x”: 1241,<br/> “mouse_position_y”: 6678,<br/> “sourceUrl”: “<a class="ae lo" href="http://localhost:8000/register" rel="noopener ugc nofollow" target="_blank">https://www.example-online-shop.com/p</a>roduct/12345",<br/> “createdAt”: “2018–03–11 23:00:00”<br/>}</span></pre><p id="f8cd" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">基本上，生产者从浏览器接收包含鼠标位置、鼠标访问的URL页面以及事件创建时间的有效载荷。然后，通过HTTP触发，成为生产者云功能接收该有效载荷并将该消息排队到云发布/订阅。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/8746a625546c504b0a41c1af692d6ee2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x5yXgzjDbQ-KdCQ9EKnwRw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">在谷歌云功能上将有效载荷发送给点击流生产者</figcaption></figure><p id="a8e4" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">排队的消息将由成为消费者的云功能消费，然后解析来自发布/订阅的有效载荷，最后有效载荷将存储在云数据存储中的<strong class="ju hj">`点击流`</strong>实体中。稍后，您可以使用GQL或云数据存储库，基于保留在云数据存储中的数据集构建任何东西。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/923b5c2069f92771133685d43e7de4a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zqEIUMZasmc3h2l37PDlyg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">浏览已经存储在云数据存储浏览器上的点击流数据</figcaption></figure><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/9169572ac22abdf17db613327e10f65f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BSwNkXoxdRlW6NvCqRP2hg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">在云数据存储浏览器上浏览点击流数据详细信息</figcaption></figure><p id="a9bb" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">感谢您关注我的帖子。我也在<a class="ae lo" href="https://medium.com/serverless-indonesia" rel="noopener">无服务器上用印度尼西亚语写这篇文章。ID介质</a>。</p><blockquote class="mt mu mv"><p id="e885" class="js jt mw ju b jv kq jx jy jz kr kb kc mx ks kf kg my kt kj kk mz ku kn ko kp hb bi translated">非常感谢<a class="na nb ge" href="https://medium.com/u/ae0b7472e817?source=post_page-----28933149ae4c--------------------------------" rel="noopener" target="_blank"> Tajhul Faijin Aliyudin </a>允许我使用他的GCP自由级账户，也感谢<a class="na nb ge" href="https://medium.com/u/2f6060739de2?source=post_page-----28933149ae4c--------------------------------" rel="noopener" target="_blank"> fajri abdillah </a>建立无服务器的指导。ID社区。</p></blockquote></div></div>    
</body>
</html>