<html>
<head>
<title>How-to: Dataform in Google Cloud — part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">操作方法:Google Cloud中的数据表单—第1部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-dataform-in-google-cloud-part-1-86bce30216fd?source=collection_archive---------0-----------------------#2022-10-20">https://medium.com/google-cloud/how-to-dataform-in-google-cloud-part-1-86bce30216fd?source=collection_archive---------0-----------------------#2022-10-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div class="er es hg"><img src="../Images/b20dc8fb61ab816e924828265b9b9654.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/format:webp/1*y52gJiTM6FlKVGzl-vmYLw.png"/></div></figure><div class=""/><p id="9008" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">大约一年前，在为一家零售商创建分析解决方案时，我有机会使用Dataform(开源CLI版本)。在那个时候，我最终将最重要的功能包装为Go中的REST API，并使用Cloud Scheduler来调用基于标签的必要转换。该解决方案的每个部分都通过Terraform部署在GCP。嗯，Google选择了几乎相同的云工作流方法作为云调度器的包装器。</p><p id="56e6" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">看起来Google在2022年悄悄地发布了Dataform的预览版。在此之前，Dataform要么只作为开源CLI版本提供，要么作为一个具有漂亮的依赖关系图等的web应用程序提供。</p></div><div class="ab cl jk jl gp jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="hb hc hd he hf"><h1 id="db3d" class="jr js hp bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">为什么是数据形式？</h1><p id="1369" class="pw-post-body-paragraph im in hp io b ip kp ir is it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj hb bi translated">为什么应该考虑使用数据形式？这些年来，云存储的价格大幅下降，使得原始数据的保存变得可以承受，这导致了从老式的ETL(在加载之前进行转换)到全新的ELT(在数据加载之后应用转换)的过渡。数据转换对于许多数据驱动的组织来说起着至关重要的作用。Dataform为您提供了以下功能，我建议您了解一下:</p><ul class=""><li id="adec" class="ku kv hp io b ip iq it iu ix kw jb kx jf ky jj kz la lb lc bi translated">从表定义、视图到转换的SQL都存储在SCM中</li><li id="0cdd" class="ku kv hp io b ip ld it le ix lf jb lg jf lh jj kz la lb lc bi translated">可以用断言来验证转换</li><li id="d341" class="ku kv hp io b ip ld it le ix lf jb lg jf lh jj kz la lb lc bi translated">增量表功能确保只处理自上次转换以来添加的行(需要对源表和目标表进行适当的分区，以最小化成本)。</li><li id="5f8c" class="ku kv hp io b ip ld it le ix lf jb lg jf lh jj kz la lb lc bi translated">可以利用JS片段来重用您不希望跨转换复制和粘贴的代码片段</li><li id="106f" class="ku kv hp io b ip ld it le ix lf jb lg jf lh jj kz la lb lc bi translated">通过使用变量来分离环境的可能性(尽管在预览版的控制台中似乎不支持)。</li></ul><h1 id="22db" class="jr js hp bd jt ju li jw jx jy lj ka kb kc lk ke kf kg ll ki kj kk lm km kn ko bi translated">文件夹结构</h1><p id="a2ad" class="pw-post-body-paragraph im in hp io b ip kp ir is it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj hb bi translated">由于数据表单项目的大小可能会迅速增长，我的建议是从适当的文件夹结构开始:</p><ul class=""><li id="bcff" class="ku kv hp io b ip iq it iu ix kw jb kx jf ky jj kz la lb lc bi translated"><code class="du ln lo lp lq b">definitions</code>文件夹是存储<code class="du ln lo lp lq b">sqlx</code>文件的地方。该文件夹至少应该分为<code class="du ln lo lp lq b">reporting</code>和<code class="du ln lo lp lq b">sources</code>两个部分，前者定义数据表单创建的表和视图，后者引用BigQuery数据集和表来获取数据。</li><li id="b552" class="ku kv hp io b ip ld it le ix lf jb lg jf lh jj kz la lb lc bi translated"><code class="du ln lo lp lq b">includes</code>文件夹是存储可重用SQL块的JavaScript文件的地方。根据经验，您可能会出于不同的目的进行类似的转换。</li></ul><figure class="lr ls lt lu fd hk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><h1 id="7a9e" class="jr js hp bd jt ju li jw jx jy lj ka kb kc lk ke kf kg ll ki kj kk lm km kn ko bi translated"><strong class="ak">谷歌云设置</strong></h1><p id="565c" class="pw-post-body-paragraph im in hp io b ip kp ir is it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj hb bi translated">一旦您的git repo有了适当的文件夹结构、一些已定义的源以及要创建的表或视图，您就必须执行以下操作:</p><ul class=""><li id="9ddd" class="ku kv hp io b ip iq it iu ix kw jb kx jf ky jj kz la lb lc bi translated">启用负责运行数据表单编译的项目的<code class="du ln lo lp lq b">dataform.googleapis.com</code></li><li id="2c73" class="ku kv hp io b ip ld it le ix lf jb lg jf lh jj kz la lb lc bi translated">启用该API将为您提供一个格式为<code class="du ln lo lp lq b">service-{PROJECT_NUMBER}@gcp-sa-dataform.iam.gserviceaccount.com</code>的服务帐户，它将执行这些操作。确保授予服务帐户创建和读取相应数据集中的源表所需的权限。</li><li id="e812" class="ku kv hp io b ip ld it le ix lf jb lg jf lh jj kz la lb lc bi translated">为了支持git集成，需要一个个人访问令牌——存储在Secret Manager中。确保上面提到的服务帐户具有访问机密版本的必要权限。</li></ul><p id="e690" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦连接到Git存储库，数据表单仪表板应如下所示:</p><figure class="lr ls lt lu fd hk er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es lx"><img src="../Images/3b9d35f10faf6867eb48d9d8dff03d45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k__y43Lp-EzyUM-kQ3Ozfg.png"/></div></div></figure><p id="043c" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当按下存储库的名称时，可以创建一个开发工作区。下面是开发工作区的定义:</p><p id="cd0a" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="mc">开发工作区是Git存储库中文件的可编辑副本。开发工作区允许您在数据表单中遵循基于Git的开发过程。您在开发工作区中对文件进行的编辑开始时是未提交的更改，您可以提交这些更改，然后进行推送。</em></p><p id="8905" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在我们的例子中，由于所有的代码都已经在GitHub中，我们将把<code class="du ln lo lp lq b">main</code>分支的内容放入我们新创建的工作空间中。</p><h1 id="030c" class="jr js hp bd jt ju li jw jx jy lj ka kb kc lk ke kf kg ll ki kj kk lm km kn ko bi translated">数据表单设置</h1><p id="fc4d" class="pw-post-body-paragraph im in hp io b ip kp ir is it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj hb bi translated">为了使数据表单工作，repo中必须有两个文件。</p><p id="88c0" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">第一个是<code class="du ln lo lp lq b">dataform.json</code>文件，至少包括以下配置:</p><figure class="lr ls lt lu fd hk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><p id="8ec2" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这基本上告诉Dataform我们正在BigQuery项目<code class="du ln lo lp lq b">kubectl-blogposts</code>中进行转换。默认数据集是<code class="du ln lo lp lq b">dataform</code>，我们计划在<code class="du ln lo lp lq b">US</code>位置创建资源。</p><p id="1e47" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">数据表单正常工作所需的另一个文件是通过运行<code class="du ln lo lp lq b">npm i @dataform/core</code>生成的<code class="du ln lo lp lq b">package.json</code>。</p><h1 id="86a5" class="jr js hp bd jt ju li jw jx jy lj ka kb kc lk ke kf kg ll ki kj kk lm km kn ko bi translated">数据数据数据</h1><p id="be7d" class="pw-post-body-paragraph im in hp io b ip kp ir is it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj hb bi translated">出于本文的目的，我选择了公开可用的IMDB数据集(您可以在BigQuery的分析中心找到它，并将其添加到您的项目中)。在本教程中，我们将创建一个视图，其中包含一个用户和分析友好的表格，其中包含有关电影、发行年份、导演、演员、平均评级和评论数量的信息。</p><p id="941c" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们首先定义以下来源:</p><ul class=""><li id="3bea" class="ku kv hp io b ip iq it iu ix kw jb kx jf ky jj kz la lb lc bi translated"><code class="du ln lo lp lq b">definitions/sources/name_basics.sqlx</code>包含从人的id到实际姓名的映射</li><li id="7612" class="ku kv hp io b ip ld it le ix lf jb lg jf lh jj kz la lb lc bi translated"><code class="du ln lo lp lq b">definitions/sources/title_basics.sqlx</code>包含标题的一般信息</li><li id="4cdf" class="ku kv hp io b ip ld it le ix lf jb lg jf lh jj kz la lb lc bi translated"><code class="du ln lo lp lq b">definitions/sources/title_crew.sqlx</code>包含电影导演的信息</li><li id="56e2" class="ku kv hp io b ip ld it le ix lf jb lg jf lh jj kz la lb lc bi translated"><code class="du ln lo lp lq b">definitions/sources/title_principals.sqlx</code>包含演员信息</li><li id="bd00" class="ku kv hp io b ip ld it le ix lf jb lg jf lh jj kz la lb lc bi translated"><code class="du ln lo lp lq b">definitions/sources/title_ratings.sqlx</code>包含关于评级的信息</li></ul><p id="8971" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">典型的定义sqlx-file包含:</p><ul class=""><li id="2d34" class="ku kv hp io b ip iq it iu ix kw jb kx jf ky jj kz la lb lc bi translated"><code class="du ln lo lp lq b">declaration</code>类型</li><li id="0f4f" class="ku kv hp io b ip ld it le ix lf jb lg jf lh jj kz la lb lc bi translated">大查询术语中的<code class="du ln lo lp lq b">schema</code>或<em class="mc">数据集</em></li><li id="494c" class="ku kv hp io b ip ld it le ix lf jb lg jf lh jj kz la lb lc bi translated"><code class="du ln lo lp lq b">name</code>源表的名称</li></ul><figure class="lr ls lt lu fd hk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><h2 id="ae10" class="md js hp bd jt me mf mg jx mh mi mj kb ix mk ml kf jb mm mn kj jf mo mp kn mq bi translated">董事们</h2><p id="4b12" class="pw-post-body-paragraph im in hp io b ip kp ir is it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj hb bi translated">每部电影的导演都生活在<code class="du ln lo lp lq b">title_crew</code>表中逗号分隔的字段中。这给了我们一个创建视图<code class="du ln lo lp lq b">definitions/reporting/directors.sqlx</code>的机会，我们可以在最终产品中引用它。编写SQL，现在可以通过使用<code class="du ln lo lp lq b">ref</code>语法:<code class="du ln lo lp lq b">${ ref('title_principals')</code>来引用<code class="du ln lo lp lq b">title_crew</code>表。</p><p id="4488" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后，Dataform会将该引用转换为<code class="du ln lo lp lq b">project_id.dataset_name.table_name</code>。我们的directors视图将从<code class="du ln lo lp lq b">title_crew</code>表中交叉连接和取消嵌套<code class="du ln lo lp lq b">directors</code>列，并为我们提供一个更易于操作的视图。</p><figure class="lr ls lt lu fd hk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><h2 id="b27a" class="md js hp bd jt me mf mg jx mh mi mj kb ix mk ml kf jb mm mn kj jf mo mp kn mq bi translated">把所有的放在一起</h2><p id="d53b" class="pw-post-body-paragraph im in hp io b ip kp ir is it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj hb bi translated">由于本文不是关于解释SQL，Dataform将基于以下代码创建一个<code class="du ln lo lp lq b">definitions/reporting/movies.sqlx</code>视图作为最终结果:</p><figure class="lr ls lt lu fd hk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><p id="1cbf" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦主分支的代码被放入开发工作区，就可以随意执行所有的操作(这基本上意味着Dataform将创建所有的资源，不管它们被分配了哪些标签):</p><figure class="lr ls lt lu fd hk er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es mr"><img src="../Images/6014b5c5f7e9f2ab1766712796aee3ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QXUkpmNOFyaR3utZ2NTnYA.png"/></div></div></figure><p id="962f" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">检查执行过程，您会注意到所有的<code class="du ln lo lp lq b">.sqlx</code>文件都被处理到了目的地。对于每个表/视图/定义，可以看到细节和生成的SQL代码。</p><figure class="lr ls lt lu fd hk er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es ms"><img src="../Images/1dde7e424fe04424a4514aaa998682c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q2lY18RShucG-ZebtCoMgA.png"/></div></div><figcaption class="mt mu et er es mv mw bd b be z dx translated">成功执行工作流</figcaption></figure></div><div class="ab cl jk jl gp jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="hb hc hd he hf"><p id="a000" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Dataform是激发我的数据工程好奇心的工具，我不得不承认，现在看到它成为谷歌云的一部分真是太棒了。虽然仍然有点隐藏和不完善，但Dataform和其他东西一样，为您的数据工程师提供了适当的发布渠道。</p><p id="f928" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你有问题，请随时给我提问！<a class="ae mx" href="https://github.com/adriantr/dataform-gcp" rel="noopener ugc nofollow" target="_blank">将</a>链接到回购。</p></div></div>    
</body>
</html>