<html>
<head>
<title>Scheduled serverless dbt + BigQuery service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">预定的无服务器dbt + BigQuery服务</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/scheduled-serverless-dbt-bigquery-service-8cdca03ff238?source=collection_archive---------0-----------------------#2020-07-29">https://medium.com/google-cloud/scheduled-serverless-dbt-bigquery-service-8cdca03ff238?source=collection_archive---------0-----------------------#2020-07-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="dba9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的同事<a class="ae jd" href="https://twitter.com/felipehoffa" rel="noopener ugc nofollow" target="_blank"> Felipe Hoffa </a>最近发表了一篇名为<a class="ae jd" rel="noopener" href="/@hoffa/get-started-with-bigquery-and-dbt-the-easy-way-36b9d9735e35">开始使用BigQuery和dbt，简单的方法</a>的博客文章。更具体地说，他展示了如何在Google Cloud Shell中安装<a class="ae jd" href="https://getdbt.com/" rel="noopener ugc nofollow" target="_blank"> dbt </a>，配置它并手动运行它以在BigQuery中创建临时数据集。这对于测试dbt + BigQuery非常有用，但是如何在生产中运行这种设置呢？</p><p id="fa5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://docs.getdbt.com/docs/running-a-dbt-project/running-dbt-in-production/" rel="noopener ugc nofollow" target="_blank"> dbt文档</a>指出<strong class="ih hj">在生产中运行dbt仅仅意味着设置一个系统来按计划运行dbt作业，而不是从命令行手动运行dbt命令。</strong></p><p id="8928" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云壳只是云中的临时虚拟机，不适合生产工作负载。一个显而易见的解决方案是创建一个专用的VM，安装dbt，并在该VM上有某种cron作业来按计划运行dbt。这是可行的，但是谁愿意维护虚拟机呢？更不用说，即使dbt没有运行，你也需要为每秒的VM付费。太浪费了。我们可以做得更好。</p><p id="ecd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更好的解决方案是使用<a class="ae jd" href="https://cloud.google.com/run" rel="noopener ugc nofollow" target="_blank">云运行</a>。云运行是完全托管的，无需设置或维护虚拟机。它的定价模型是基于请求时间的，只有当dbt服务运行时你才会被收费。</p><p id="85e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博客文章中，我想向您展示如何获取Felipe的样本，并通过按计划将它作为无服务器云运行服务来运行，使其更适合生产。</p><h1 id="38ee" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">挑战</h1><p id="0bc0" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">将dbt作为云运行服务运行面临一些挑战，即:</p><ol class=""><li id="cd6d" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">dbt主要是一个命令行工具，而Cloud Run需要HTTP请求。如何从云运行服务调用dbt命令？</li><li id="3c9a" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">云运行运行容器。如何在容器中运行dbt？</li><li id="b1b7" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">如何用BigQuery认证dbt？OAuth适用于最终用户，但对于运行在云中的服务，它可能不是正确的解决方案。</li></ol><p id="729f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们按这个顺序来解决它们。</p><h1 id="b232" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">从云运行运行shell命令</h1><p id="9932" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">Cloud Run有一个关于如何从部署到Cloud Run的HTTP服务器运行shell命令的例子。它包括建立一个基于Go的HTTP服务器，该服务器在收到GET请求时简单地调用一个shell脚本。你可以在<a class="ae jd" href="https://github.com/meteatamel/cloudrun-tutorial/blob/master/dbt/invoke.go" rel="noopener ugc nofollow" target="_blank"> invoke.go </a>中查看详情。</p><p id="c748" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们的例子中，shell脚本<a class="ae jd" href="https://github.com/meteatamel/cloudrun-tutorial/blob/master/dbt/script.sh" rel="noopener ugc nofollow" target="_blank"> script.sh </a>简单地用概要文件文件夹调用dbt:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="7cae" class="le jf hi la b fi lf lg l lh li">#!/bin/sh dbt run --profiles-dir .</span></pre><h1 id="21ef" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">dbt的容器图像</h1><p id="158e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">dbt有一些您可以依赖的<a class="ae jd" href="https://hub.docker.com/r/fishtownanalytics/dbt/tags" rel="noopener ugc nofollow" target="_blank">基础映像</a>(尽管文档几乎不存在)。在容器中，我们希望包含带有<code class="du lj lk ll la b">script.sh</code>的HTTP服务器。我们还想包括dbt运行时。这是一个示例<a class="ae jd" href="https://github.com/meteatamel/cloudrun-tutorial/blob/master/dbt/Dockerfile" rel="noopener ugc nofollow" target="_blank"> Dockerfile </a>的工作原理:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="9e02" class="le jf hi la b fi lf lg l lh li">FROM golang:1.13 as builder<br/>WORKDIR /app<br/>COPY invoke.go ./<br/>RUN CGO_ENABLED=0 GOOS=linux go build -v -o server</span><span id="c57c" class="le jf hi la b fi lm lg l lh li">FROM fishtownanalytics/dbt:0.17.0<br/>USER root<br/>WORKDIR /dbt<br/>COPY --from=builder /app/server ./<br/>COPY script.sh ./<br/>COPY dbt_project ./</span><span id="af30" class="le jf hi la b fi lm lg l lh li">ENTRYPOINT "./server"</span></pre><p id="5020" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<code class="du lj lk ll la b">gcloud</code>构建容器:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="c7d9" class="le jf hi la b fi lf lg l lh li">export SERVICE_NAME=dbt-service</span><span id="bd80" class="le jf hi la b fi lm lg l lh li">gcloud builds submit \<br/>  --tag gcr.io/$(gcloud config get-value project)/${SERVICE_NAME}</span></pre><h1 id="c746" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">证明</h1><p id="fc5d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">默认情况下，Cloud Run使用计算引擎默认服务帐户，该帐户应该能够进行BigQuery调用。但是，最佳实践是通过分配具有更多受限IAM角色的专用服务帐户，为您的云运行服务分配更细粒度的权限。</p><p id="fb33" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们的例子中，云运行服务将只与BigQuery对话，所以让我们创建一个具有<code class="du lj lk ll la b">bigquery.admin</code>角色的服务帐户。您可能希望在生产中使用更细粒度的角色:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="050f" class="le jf hi la b fi lf lg l lh li">export SERVICE_ACCOUNT=dbt-sa</span><span id="d5ec" class="le jf hi la b fi lm lg l lh li">gcloud iam service-accounts create ${SERVICE_ACCOUNT} \<br/>   --display-name "DBT BigQuery Service Account"</span><span id="478c" class="le jf hi la b fi lm lg l lh li">gcloud projects add-iam-policy-binding \<br/>  $(gcloud config get-value project) \<br/>  --member=serviceAccount:${SERVICE_ACCOUNT}@$(gcloud config get-value project).iam.gserviceaccount.com \<br/>  --role=roles/bigquery.admin</span></pre><p id="2d67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将在部署云运行服务时使用此服务帐户。</p><h1 id="5b9c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">部署云运行服务</h1><p id="cd42" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在我们已经组装好了所有的组件，使用之前创建的服务帐户和<code class="du lj lk ll la b">no-allow-unauthenticated</code>标记将它部署到Cloud Run，使其成为私有服务:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="2833" class="le jf hi la b fi lf lg l lh li">gcloud run deploy ${SERVICE_NAME} \<br/>    --image gcr.io/$(gcloud config get-value project)/${SERVICE_NAME} \<br/>    --service-account ${SERVICE_ACCOUNT}@$(gcloud config get-value project).iam.gserviceaccount.com \<br/>    --no-allow-unauthenticated</span></pre><p id="de86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几秒钟后，您应该看到服务已部署并正在运行:</p><figure class="kv kw kx ky fd lo er es paragraph-image"><div class="er es ln"><img src="../Images/effdb57945097bedb27eb0fc75187ea8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/0*xMDYYColIUC7H93K.png"/></div></figure><p id="ec64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还应该看到服务是私有的:</p><figure class="kv kw kx ky fd lo er es paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="er es lr"><img src="../Images/04548bc1f091d37070d99c7c1208a7d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pIQ2pAIcrknNReCq.png"/></div></div></figure><h1 id="7a14" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">行程安排</h1><p id="8c3b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">最后一步是按计划调用云运行服务。您可以使用云调度程序来实现这一点。</p><p id="f2ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，确保启用了云调度器API:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="a303" class="le jf hi la b fi lf lg l lh li">gcloud services enable cloudscheduler.googleapis.com</span></pre><p id="62a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<code class="du lj lk ll la b">run.invoker</code>角色为云调度程序创建服务帐户:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="e66e" class="le jf hi la b fi lf lg l lh li">export SERVICE_ACCOUNT=dbt-scheduler-sa</span><span id="4599" class="le jf hi la b fi lm lg l lh li">gcloud iam service-accounts create ${SERVICE_ACCOUNT} \<br/>   --display-name "DBT Scheduler Service Account"<br/>gcloud run services add-iam-policy-binding ${SERVICE_NAME} \<br/>   --member=serviceAccount:${SERVICE_ACCOUNT}@$(gcloud config get-value project).iam.gserviceaccount.com \<br/>   --role=roles/run.invoker</span></pre><p id="ffa1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用服务帐户创建云调度程序作业，以每5分钟调用一次云运行服务:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="6137" class="le jf hi la b fi lf lg l lh li">export SERVICE_URL="$(gcloud run services list --platform managed --filter=${SERVICE_NAME} --format='value(URL)')"</span><span id="7e22" class="le jf hi la b fi lm lg l lh li">gcloud scheduler jobs create http ${SERVICE_NAME}-job --schedule "*/5 * * * *" \<br/>   --http-method=GET \<br/>   --uri=${SERVICE_URL} \<br/>   --oidc-service-account-email=${SERVICE_ACCOUNT}@$(gcloud config get-value project).iam.gserviceaccount.com \<br/>   --oidc-token-audience=${SERVICE_URL}</span></pre><p id="6795" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要测试是否调用了服务并创建了临时BigQuery数据集，您可以手动触发作业:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="5d6d" class="le jf hi la b fi lf lg l lh li">gcloud scheduler jobs run ${SERVICE_NAME}-job</span></pre><p id="ecdd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该看到在BigQuery控制台中创建了一个<code class="du lj lk ll la b">temp</code>数据集:</p><figure class="kv kw kx ky fd lo er es paragraph-image"><div class="er es lw"><img src="../Images/74036f350557cc63e074617720345fa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:528/format:webp/0*2RT1z1AwKbgL6KbG.png"/></div></figure></div><div class="ab cl lx ly gp lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hb hc hd he hf"><p id="943e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样。希望这篇博文能让你了解如何一起使用dbt + BigQuery + Cloud Run。这是一个非常简单的dbt工作，但是同样的设置可以用于更复杂的场景。你可以查看我的<a class="ae jd" href="https://github.com/meteatamel/cloudrun-tutorial" rel="noopener ugc nofollow" target="_blank">云运行教程</a>和它的<a class="ae jd" href="https://github.com/meteatamel/cloudrun-tutorial/blob/master/docs/scheduled-dbt-service-bigquery.md" rel="noopener ugc nofollow" target="_blank">预定云运行dbt服务的BigQuery </a>部分，了解这篇文章的所有代码。</p><p id="37db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在Twitter <a class="ae jd" href="https://twitter.com/meteatamel" rel="noopener ugc nofollow" target="_blank"> @meteatamel </a>上联系我，或者阅读我以前在<a class="ae jd" rel="noopener" href="/@meteatamel"> medium/@meteatamel </a>上的帖子。</p></div><div class="ab cl lx ly gp lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hb hc hd he hf"><p id="42d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="me">最初发布于</em><a class="ae jd" href="https://atamel.dev/posts/2020/07-29_scheduled_serverless_dbt_with_bigquery/" rel="noopener ugc nofollow" target="_blank"><em class="me">https://atamel . dev</em></a><em class="me">。</em></p></div></div>    
</body>
</html>