<html>
<head>
<title>Running the Cloud SQL Proxy as a Windows Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将云SQL代理作为Windows服务运行</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/running-the-cloud-sql-proxy-as-a-windows-service-2b7ef22afec8?source=collection_archive---------0-----------------------#2020-02-20">https://medium.com/google-cloud/running-the-cloud-sql-proxy-as-a-windows-service-2b7ef22afec8?source=collection_archive---------0-----------------------#2020-02-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f0e4edc01c89c534987492337b800a8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nRBNdxePZePNiIfL81Srxg.jpeg"/></div></div></figure><p id="b832" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云SQL代理提供了到云SQL数据库实例的快速、安全、加密的连接，无需管理允许的IP地址或SSL/TLS配置细节。这是一个小型的自包含可执行文件，你可以<a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/sql-proxy#install" rel="noopener ugc nofollow" target="_blank">免费下载</a>，它使用IAM认证进行简单的基于角色的访问管理。该代理非常适合本地开发和测试，因为一旦它运行，您的所有代码和客户端工具都可以连接到<code class="du jp jq jr js b">127.0.0.1</code>来访问您的数据库实例。</p><p id="6b98" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，如果您做过很多云SQL开发，您会知道很容易忘记“只需要让它运行起来”这一点如果您忘记在本地测试之前启动代理，您的代码最终会超时，并显示来自SQL驱动程序的错误消息。确切的错误可能因驱动程序而异，误导性的错误消息会导致更多的时间浪费。</p><p id="eb9e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你可以让代理作为后台服务一直运行，监听<code class="du jp jq jr js b">127.0.0.1</code>并为新的连接做好准备，这不是很好吗？更好的是，如果该服务能够在出错或重启时优雅地重启，那不是很好吗？</p><p id="08c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你<em class="jt">可以</em>让代理以这种方式工作，在这篇文章中，我将向你展示设置它是多么容易。如果您正在Windows机器上进行云SQL开发，这是一个很好的方法——您可以调用代理一次，它会一直运行并管理连接，直到您使用<code class="du jp jq jr js b">net stop</code>命令明确停止它。这种方法结合了完全托管服务的优点和本地数据库的便利性。</p><h1 id="d759" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">入门指南</h1><p id="77a9" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">如果您想按照本文中的示例进行操作，请按照我的<a class="ae jo" rel="noopener" href="/@dmahugh_70618/cloud-sql-setup-4fc72d3f33db"> Cloud SQL Setup </a>帖子中的说明创建一个数据库实例和服务帐户。请务必下载那里介绍的JSON凭证文件，因为您将需要它来进行代理认证。</p><p id="561e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于这个例子，我将使用一个用于SQL Server 的<a class="ae jo" href="https://cloud.google.com/sql/docs/sqlserver/" rel="noopener ugc nofollow" target="_blank">云SQL实例，尽管核心原则适用于其他云SQL数据库实例类型，如MySQL或PostgreSQL。</a></p><p id="303d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您已经有一个SQL Server数据库，您可以将它迁移到云SQL，并通过代理进行连接，如下所述。参见<a class="ae jo" href="https://cloud.google.com/blog/products/databases/migrate-your-microsoft-sql-server-workloads-to-google-cloud" rel="noopener ugc nofollow" target="_blank">将您的Microsoft SQL Server工作负载迁移到Google Cloud </a>，了解如何从内部服务或其他云服务迁移的简单分步说明。</p><h1 id="fad7" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">将代理作为服务安装</h1><p id="e34a" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">云SQL代理可执行文件目前不提供作为Windows服务运行的本机支持，但这不是问题，因为有各种开源服务管理器可以用来安装任何Windows可执行文件作为服务。</p><p id="42c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我最喜欢的是<a class="ae jo" href="http://nssm.cc/" rel="noopener ugc nofollow" target="_blank"> NSSM </a>，“非吸服务经理。”与大多数第三方服务管理器不同，NSSM可以监控正在运行的服务，并在服务停止响应时自动重启。它还提供了一个简单的配置GUI，以及用于自动配置的<a class="ae jo" href="http://nssm.cc/commands" rel="noopener ugc nofollow" target="_blank">命令行选项</a>。</p><p id="d3c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以在这里下载NSSM <a class="ae jo" href="http://nssm.cc/download" rel="noopener ugc nofollow" target="_blank">，文档可以在这里</a>获得<a class="ae jo" href="http://nssm.cc/usage" rel="noopener ugc nofollow" target="_blank">。将<code class="du jp jq jr js b">nssm.exe</code>可执行文件与云SQL代理可执行文件和您的服务帐户的JSON凭证文件放在一个文件夹中，您就可以开始了。</a></p><p id="25d9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建和管理Windows服务需要管理员访问权限，因此右键单击开始按钮并选择<strong class="is hj">Windows PowerShell(Admin)</strong>。然后使用此命令创建一个新服务:</p><pre class="kx ky kz la fd lb js lc ld aw le bi"><span id="6740" class="lf jv hi js b fi lg lh l li lj">.\nssm.exe install &lt;servicename&gt;</span></pre><p id="9db6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将会打开一个图形用户界面，引导您完成新服务的配置。有几个带有各种选项的选项卡，但是对于安装云SQL代理，您只需要在应用程序选项卡上输入路径、启动目录和参数选项。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/d98a96e82abceca67af359ac06540022.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zEUuixW9_Xn8kovic97oYQ.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx translated">将云SQL代理配置为Windows服务</figcaption></figure><p id="d7fd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">arguments选项设置为代理的命令行参数:数据库实例的名称、端口号(在本例中为1433，因为这是SQL Server的默认值)和凭证文件的名称。下面是语法:</p><pre class="kx ky kz la fd lb js lc ld aw le bi"><span id="d2dd" class="lf jv hi js b fi lg lh l li lj">-instances=&lt;instance-name&gt;=tcp:1433 -credential_file=&lt;filename&gt;.json</span></pre><p id="bcf4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意，我们在这里假设凭证文件与代理可执行文件在同一个文件夹中。如果它在不同的文件夹中，您需要在<code class="du jp jq jr js b">credential_file</code>参数中指定它的完整路径。</p><p id="82b8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">选择Install service，您应该会收到一条消息，提示服务安装成功。</p><h1 id="b7cf" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">正在启动服务</h1><p id="0faa" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">该服务现在<em class="jt">已安装</em>，但尚未启动。作为最后的设置步骤，在管理员提示符下使用以下命令启动服务:</p><pre class="kx ky kz la fd lb js lc ld aw le bi"><span id="0cf9" class="lf jv hi js b fi lg lh l li lj">net start &lt;service-name&gt;</span></pre><p id="c379" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是全部了！代理现在正在运行并监听连接(在本例中为<code class="du jp jq jr js b">127.0.0.1:1433</code>)。如果需要，它会自动重启，包括重启机器后。</p><p id="d5c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要验证服务是否正在运行，您可以使用PowerShell的<code class="du jp jq jr js b">Get-Service</code> cmdlet。输出可能很长，因为它包括了当前运行的每个服务，但是您可以使用一个<code class="du jp jq jr js b">where</code>子句来显示一个命名服务的状态，如下所示。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/c2c256d6f0c0523b2f176dd9d11a119f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WANfOvSUa8mCbUSQrV4pLg.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx translated">用Get-Service显示服务的状态</figcaption></figure><h1 id="cbef" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">使用代理服务</h1><p id="16ea" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">一旦代理作为服务运行，您机器上的任何其他程序或进程都可以在<code class="du jp jq jr js b">127.0.0.1</code>与云SQL通信。例如，下面的示例将随机名称和位置写入表中，然后运行查询来检索它们:</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/921cfe62d95cf30ea4c0f7f2d366c0d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o-r3h74cOJGuxMgeYegraQ.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx translated">通过作为Windows服务运行的代理连接到云SQL的本地代码示例</figcaption></figure><p id="6af4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该示例的连接使用SQL Server ODBC驱动程序进行连接，如下所示:</p><pre class="kx ky kz la fd lb js lc ld aw le bi"><span id="8af9" class="lf jv hi js b fi lg lh l li lj">CNXN = pyodbc.connect(<br/>    “DRIVER={ODBC Driver 17 for SQL Server};SERVER=127.0.0.1;”+<br/>    f”UID={DB_USER};PWD={DB_PASS}”,<br/>    autocommit=True,<br/>)<br/>CURSOR = CNXN.cursor()</span></pre><p id="f198" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您也可以从SQL Server Management Studio (SSMS)等工具进行连接:</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/0d5c80a68b872305e7fde9d714272f0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4ugZ8IHBEMxMsArqGw9gOA.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx translated">SSMS连接到作为Windows服务在本地运行的代理</figcaption></figure><p id="4098" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如上所示连接后，SSMS可以运行查询和管理数据库对象:</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/c5a4649ac60dea2acde0e90afa0fc243.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DavBeoH9FPO4zPy7WAgWlA.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx translated">使用SSMS运行SQL查询</figcaption></figure><h1 id="2a62" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">停止并删除服务</h1><p id="c3fe" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">要停止代理服务，请在PowerShell管理提示符下使用以下命令:</p><pre class="kx ky kz la fd lb js lc ld aw le bi"><span id="4bd2" class="lf jv hi js b fi lg lh l li lj">net stop &lt;service-name&gt;</span></pre><p id="a72c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该服务仍在安装和配置中，因此如果需要，您可以使用<code class="du jp jq jr js b">net start</code>来重启它。</p><p id="5d6a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要永久删除该服务，请使用以下NSSM命令:</p><pre class="kx ky kz la fd lb js lc ld aw le bi"><span id="24ec" class="lf jv hi js b fi lg lh l li lj">.\nssm.exe remove &lt;service-name&gt; confirm</span></pre><p id="6c4a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，提醒一句:代理使用安全加密与您的云SQL实例通信，但是在<code class="du jp jq jr js b">127.0.0.1</code>到代理的本地连接是<em class="jt">而不是</em>加密的。在上述场景中，这不是问题，因为我们在本地的Windows机器上工作，但是您应该避免在您不信任的网络上公开代理。要了解从外部应用程序连接时的最佳实践，请参阅关于使用代理服务器从外部应用程序连接的文档。</p></div></div>    
</body>
</html>