<html>
<head>
<title>Setup and Invoke Cloud Functions using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python设置和调用云函数</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/setup-and-invoke-cloud-functions-using-python-e801a8633096?source=collection_archive---------1-----------------------#2020-06-23">https://medium.com/google-cloud/setup-and-invoke-cloud-functions-using-python-e801a8633096?source=collection_archive---------1-----------------------#2020-06-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/639f14536bb46be0c08d610e9c0523e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*DLZ1doo_6uXIhqOASDsCOw.png"/></div></figure><p id="bc0b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">哦，我学习云函数的乐趣。探索本应使事情变得简单的无服务器服务，这实际上很有趣，但也令人沮丧，而且绝对具有启发性。诚然，我已经经历了足够长的时间，知道总是有斜升，即使它很简单。</p><p id="cbc4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Cloud Functions是一项服务，允许你在谷歌云服务器上运行代码，而无需处理服务器配置或扩展。这是一种“随用随付”的方法，意味着您要为自己使用的东西付费，这有助于优化成本。我已经开始将它用于一些我需要多次运行的功能，这就是它非常有价值的地方。有一个学习曲线，尤其是在连接不同的服务时，这篇文章涵盖了这些主题的关键学习。</p><ul class=""><li id="7aa6" class="jk jl hi io b ip iq it iu ix jm jb jn jf jo jj jp jq jr js bi translated">在云函数中运行之前在本地测试代码</li><li id="5ab6" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated">使用HTTP触发器和Python设置云函数</li><li id="0d61" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated">从您的笔记本电脑调用云功能</li><li id="06c7" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated">错误故障排除和身份验证</li><li id="6dba" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated">费用</li></ul><p id="c7ed" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">本文假设您已经在本地安装了gcloud SDK，并且已经安装了Google Cloud项目。我有以前关于这些话题的帖子。我在函数中使用了Python 3.7，在Mac上进行本地开发。</p><h1 id="e7da" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">本地模拟云功能</h1><p id="cf84" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">如果你想在运行云函数之前测试你的代码，那么你可以用Python的函数框架来测试。</p><h2 id="2cda" class="lc jz hi bd ka ld le lf ke lg lh li ki ix lj lk km jb ll lm kq jf ln lo ku lp bi translated">简单示例|未传递任何参数</h2><p id="9da0" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">在您的机器上安装带有pip的功能框架。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="07cb" class="lc jz hi lv b fi lz ma l mb mc">pip install functions-framework</span></pre><p id="db74" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">起草一个简单的例子，你可以像下面这样测试，并将其标记为<em class="md"> main.py </em>。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="a349" class="lc jz hi lv b fi lz ma l mb mc">def my_function(request):<br/>    return 'Hello World'</span></pre><p id="1bdb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要模拟云函数，请在终端中运行functions-framework命令。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="aafd" class="lc jz hi lv b fi lz ma l mb mc">functions-framework --target my_function</span></pre><p id="f994" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可以传入一些标志进行调整，例如文件名(— source)和它指向的端口(— port)。并在开发时使用— debug标志获得更详细的帮助。</p><p id="9d77" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后调用curl在本地调用它，查看HTTP触发器如何工作，或者在浏览器窗口中运行它。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="41c0" class="lc jz hi lv b fi lz ma l mb mc">curl <a class="ae lb" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a></span><span id="8b88" class="lc jz hi lv b fi me ma l mb mc">OR for the browser</span><span id="2ffd" class="lc jz hi lv b fi me ma l mb mc">http://localhost:8080</span></pre><p id="0599" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">链接中最上面的<a class="ae lb" href="https://stackoverflow.com/questions/53693987/test-python-google-cloud-functions-locally/53700497" rel="noopener ugc nofollow" target="_blank">堆栈溢出响应</a>是我提取上面代码的地方。当您引入包并希望了解这些包如何工作以及检查与其他服务的连接时，模拟云功能尤其有价值。此外，这也是一个很好的框架，可以用来测试本地运行的云。</p><h2 id="f0bb" class="lc jz hi bd ka ld le lf ke lg lh li ki ix lj lk km jb ll lm kq jf ln lo ku lp bi translated">传递参数</h2><p id="5f50" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">下面是一个如何向云函数传递参数的例子。</p><p id="a3a7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用这个起始代码进行试验，并将其放入一个<em class="md"> main.py </em>文件中。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="259b" class="lc jz hi lv b fi lz ma l mb mc">def hello(request): <br/>    if request.args:<br/>        return f'Hello' + request.args.get('first') + request.args.get('last')+'\n'<br/>    elif request.get_json():<br/>        request_json = request.get_json()<br/>        return  f'Hello' + request_json['first'] + request_json['last']+'\n'<br/>    elif request.values:<br/>        request_data = request.values<br/>        return  f'Hello' + request_data['first'] + request_data['last']+'\n'<br/>    else:<br/>        return f'Hello World!'+'\n'</span></pre><p id="d07a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了测试它，你可以使用curl命令。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="b1d1" class="lc jz hi lv b fi lz ma l mb mc">curl <a class="ae lb" href="http://localhost:8080?first=My&amp;last=" rel="noopener ugc nofollow" target="_blank">http://localhost:8080?first=My&amp;last=</a>Name</span></pre><p id="ac9a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">或者您可以为Linux或Mac传递以下参数。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="eb85" class="lc jz hi lv b fi lz ma l mb mc">curl <a class="ae lb" href="http://localhost:8080?first=My&amp;last=" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a> -d<!-- --> ‘{“first”:”My”, “last”:”Name”}’</span></pre><p id="4644" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">或者您可以在浏览器中用相同的url调用它。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="bb03" class="lc jz hi lv b fi lz ma l mb mc"><a class="ae lb" href="http://localhost:8080?first=My&amp;last=" rel="noopener ugc nofollow" target="_blank">http://localhost:8080?first=My&amp;last=</a>Name</span></pre><h1 id="e495" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">设置云功能</h1><p id="522d" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">如果你想在一个实际的云函数中运行代码，你可以使用谷歌云控制台来设置你要运行的函数。也可以使用gcloud SDK发布代码。在这篇文章中，我坚持使用用户界面，但也可以随意查看这个<a class="ae lb" href="https://cloud.google.com/functions/docs/quickstart" rel="noopener ugc nofollow" target="_blank">链接</a>来获得更多关于从你的终端启动gcloud的信息。</p><p id="0245" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">转到谷歌云控制台和云功能仪表板。选择<em class="md">创建功能</em>。</p><figure class="lq lr ls lt fd ij er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mf"><img src="../Images/0e62dbc381645501bc53e8f57c9900b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f_ka56PaI-Gd6OQxesr--A.png"/></div></div></figure><p id="feff" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">填写用于<em class="md"> HTTP触发器</em>的<em class="md"> URL </em>中的函数名。还要选择要使用的触发器。还有其他的触发选项，但是对于这个例子，我坚持使用HTTP<em class="md"/>。</p><figure class="lq lr ls lt fd ij er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mk"><img src="../Images/90f77dbee0f7fdf4d74ce264611e4215.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bADjUsb3XaxcFRspAwycbQ.png"/></div></div></figure><p id="72b6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">调用该函数的url将发布在上图中的<em class="md"> URL </em>下。您可以直接在UI中测试它，在您的本地终端中卷曲它，通过浏览器运行它或者通过代码发布请求。</p><p id="7ee2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="md">认证</em>框是棘手的部分。如果选中，那么<strong class="io hj">任何人</strong>都可以调用该函数。这是一种测试它的方法，而不是处理身份验证，但要小心，因为它是开放的，任何人都可以找到url(包括机器人)来调用它，这可能会变得昂贵，因为它是按需付费。更多关于成本的信息，请见后文。请注意，它会自动被取消选中，如果你忘记了它，那么你可能会掉进兔子洞，我试图找出为什么我不能在没有身份验证的情况下调用。</p><figure class="lq lr ls lt fd ij er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es ml"><img src="../Images/11408218b21ab3eb800630b28940aa6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5yZUOmGaGte4mQkqpc0wcg.png"/></div></div></figure><p id="eeec" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在<em class="md">运行时</em>中，选择您想要为函数编码的语言，并在<em class="md"> MAIN下相应地为您的函数编码。PY </em>。当使用HTTP和Python时，你必须接受一个r <em class="md"> equest </em>对象，这样你就可以传入参数。你还需要填写<em class="md">要求。TXT </em>选项卡，包含您导入的任何需求，这些需求还不是Python标准包的一部分。</p><p id="e422" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在<em class="md">要执行的函数中，</em>将程序运行时需要执行的函数名放入您的代码中。已经有示例代码可以帮助您入门。</p><p id="2fe9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当你展开<em class="md">环境变量、联网、超时等等，</em>你会发现在<em class="md">联网</em>下的<em class="md">入口</em>T32】设置表明<em class="md">允许所有流量</em>。如果您没有选中上面的<em class="md">允许未认证调用</em>的复选框，但是确保选择了<em class="md">允许所有流量</em>(这是默认设置)，那么它仍然需要认证。这让我有点迷惑，我在下面重申一下。</p><figure class="lq lr ls lt fd ij er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mm"><img src="../Images/0fc26c822634a3aacaf497756aad5c66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_AE9vi3ToYwXlnO1tFB9RQ.png"/></div></div></figure><p id="53fa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">还有一个关于<em class="md">超时</em>的注意事项是，程序默认为60秒，如果在等待响应以完成处理，您最多可以在函数超时前获得9分钟。</p><p id="1872" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦该功能被设置，选择<strong class="io hj">创建</strong>，并给它几分钟时间让该功能在服务器上启动。当有一个绿色的检查圈时，就可以运行了。</p><figure class="lq lr ls lt fd ij er es paragraph-image"><div class="er es mn"><img src="../Images/1ba9a77d5f578e89d5b15fbd0f7afb87.png" data-original-src="https://miro.medium.com/v2/resize:fit:92/format:webp/1*QFyanQHtmk1m5NxNwR2VFw.png"/></div></figure><p id="52a3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果有错误，您可以随时返回并编辑该功能，然后<strong class="io hj">再次部署</strong>。</p><h1 id="095b" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">调用云函数</h1><p id="a87d" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">设置好该功能后，您可以调用/运行该功能。这一步对我来说更具挑战性，因为前面提到的<em class="md">认证</em>复选框以及Python请求如何处理<em class="md">数据</em> vs <em class="md"> json </em>术语。</p><h2 id="338f" class="lc jz hi bd ka ld le lf ke lg lh li ki ix lj lk km jb ll lm kq jf ln lo ku lp bi translated"><strong class="ak">所有用户访问</strong></h2><p id="939a" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">当授权任何人访问云函数时，您可以在代码中省略传递身份验证参数，下面提供了调用示例。</p><p id="e5d8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">终端<br/>终端</strong>无参数卷曲现有云函数。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="5f73" class="lc jz hi lv b fi lz ma l mb mc">curl <a class="ae lb" href="https://us-central1-w-data-pipelines-may20.cloudfunctions.net/product-func" rel="noopener ugc nofollow" target="_blank">https://[<em class="md">MYPROJECT</em>].cloudfunctions.net/[</a><em class="md">FUNC NAME</em>]</span></pre><p id="3edb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">卷曲一个接受参数的现有云函数。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="84dd" class="lc jz hi lv b fi lz ma l mb mc">curl <a class="ae lb" href="https://us-central1-w-data-pipelines-may20.cloudfunctions.net/product-func" rel="noopener ugc nofollow" target="_blank">https://[<em class="md">MYPROJECT</em>].cloudfunctions.net/[</a><em class="md">FUNC NAME</em>] -H “Content-Type:application/json” -d ‘{“first”:”Mae Carol”, “last”:”Jemison"}’</span></pre><p id="07d2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">将<em class="md"> MYPROJECT </em>替换为您的谷歌云项目id，将<em class="md"> FUNC名称</em>替换为设置中提到的云函数名称。</p><p id="955d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> Python代码<br/> </strong>在调用Python函数内部的url时，我使用了<em class="md"> requests </em>包来应用HTTP触发器，通过请求传入参数。</p><p id="d072" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">创造这些变量。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="c335" class="lc jz hi lv b fi lz ma l mb mc">url = "<a class="ae lb" href="https://us-central1-w-data-pipelines-may20.cloudfunctions.net/product-func" rel="noopener ugc nofollow" target="_blank">https://[<em class="md">MYPROJECT</em>].cloudfunctions.net/[</a><em class="md">FUNC NAME</em>]<br/>param = {“first”:”Mae Carol”, “last”:”Jemison"}</span></pre><p id="c828" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对云函数url进行请求调用。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="759e" class="lc jz hi lv b fi lz ma l mb mc">r = requests.post(url, <strong class="lv hj">json</strong>=param)</span></pre><p id="98bc" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您得到类似<em class="md">“您的客户端没有访问所请求的URL的权限”</em>的错误，尽管错误上说了什么，也不一定是授权。我发现上面真正的问题是我使用了关键字<em class="md">数据</em>并且没有将我的参数转换成<em class="md"> json </em>格式。当我将输入参数从<em class="md">数据</em>更改为<em class="md"> json </em>时，它工作了。</p><p id="612d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这是在我切换到json之前，我一直坚持使用的代码。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="2b14" class="lc jz hi lv b fi lz ma l mb mc">r = requests.post(url, <strong class="lv hj">data</strong>=param)</span></pre><p id="9383" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">数据不起作用的原因是因为我的原始代码没有解析数据标志下传入的参数的能力。这是我在将它添加到本文开头的示例中之前所缺少的代码。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="0f75" class="lc jz hi lv b fi lz ma l mb mc">request_data = request.values<br/>return  f'Hello' + request_data['first'] + request_data['last']+'\n'</span></pre><p id="5487" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果我用json.dump将参数转换成json，或者如果我传入将内容类型阐明为json的头，我也可以从我的示例中去掉上面的代码，继续使用data=param。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="261f" class="lc jz hi lv b fi lz ma l mb mc">import json<br/>r = requests.post(url, <strong class="lv hj">data</strong>=json.dump(param))</span></pre><p id="77e7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">运筹学</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="e239" class="lc jz hi lv b fi lz ma l mb mc">newHeaders = {'Content-type': 'application/json', 'Accept': 'text/plain'}<br/>headers=newHeaders<br/>r = requests.post(url, <strong class="lv hj">data</strong>=param, headers=newHeaders)</span></pre><h2 id="7559" class="lc jz hi bd ka ld le lf ke lg lh li ki ix lj lk km jb ll lm kq jf ln lo ku lp bi translated"><strong class="ak">授权访问</strong></h2><p id="a1ce" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">如前所述，我花了很长时间在认证兔子洞里，因为我一度认为我没有权限。关于这一点，有几件事是我最初实际上没有权限，因为我错过了那个<em class="md">认证</em> <strong class="io hj"> </strong>复选框，但是我也遇到了一些挑战，让令牌加载到我的Python代码中。</p><p id="841f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">终端<br/> </strong>我很快发现了下面的示例代码，它可以从我的笔记本电脑上调用我的云功能，并获取我的默认身份令牌，因为我已经配置了<em class="md"> gcloud </em>。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="088e" class="lc jz hi lv b fi lz ma l mb mc">curl -H “Authorization: Bearer $(gcloud auth print-identity-token)” <a class="ae lb" href="https://us-central1-w-data-pipelines-may20.cloudfunctions.net/product-func" rel="noopener ugc nofollow" target="_blank">https://[<em class="md">MYPROJECT</em>].cloudfunctions.net/[</a><em class="md">FUNC NAME</em>] -H “Content-Type:application/json” -d ‘{“first”:”Mae Carol”, “last”:”Jemison"}’</span></pre><p id="4718" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当我在Python中尝试这一点时，这就是它变得具有挑战性的地方。由于我的bash命令有效，它帮助我认识到将令牌加载到代码中是挑战的一部分。</p><p id="08fa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我试验了google-auth和google-oauth包。我甚至使用操作系统和子进程包直接从bash调用中提取令牌。我从尝试所有这些事情中学到的是，我无法获得一个令牌来加载google-auth和google-oauth，这是另一个问题。</p><p id="7d3c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如上所述，我遇到的一个错误是因为我需要在请求调用中用<em class="md"> json </em>交换<em class="md">数据</em>或者修改我的参数配置方式。</p><p id="0212" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我能够用os和子进程解析出我的令牌，这是我最终使用的子进程命令。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="9fa0" class="lc jz hi lv b fi lz ma l mb mc">import subprocess</span><span id="6d77" class="lc jz hi lv b fi me ma l mb mc">token = '{}'.format(subprocess.Popen(args="gcloud auth print-identity-token", stdout=subprocess.PIPE, shell=True).communicate()[0])[2:-3]</span></pre><p id="17f7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这是做这件事的好方法吗？有争议，最有可能是没有。但是它起作用了，我需要继续做其他的事情。反馈总是受欢迎的，如果我找到更好的方法，我会试着回到这里更新。</p><p id="9659" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用此代码通过身份验证令牌向云函数url发出请求，并且不带参数。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="1a4d" class="lc jz hi lv b fi lz ma l mb mc">r = requests.post(url, headers={"Authorization":"Bearer {}".format(token)})</span></pre><p id="9408" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用此代码通过身份验证令牌和params向云函数url发出请求。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="a1c4" class="lc jz hi lv b fi lz ma l mb mc">r = requests.post(url, json=param, headers={"Authorization":"Bearer {}".format(token)})</span></pre><p id="0cbe" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在<em class="md">请求</em>运行后，您可以检查它的运行情况。以下命令提供了关于令牌是否不正确以及请求是否以200或500或400范围代码中的某个值响应的见解。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="1dc6" class="lc jz hi lv b fi lz ma l mb mc">r.headers<br/>r.status_code</span></pre><h1 id="e9d3" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">疑难解答旁注</h1><h2 id="8047" class="lc jz hi bd ka ld le lf ke lg lh li ki ix lj lk km jb ll lm kq jf ln lo ku lp bi translated">身份验证|所有用户访问</h2><p id="bfd9" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">如果您在设置您的功能时第一次错过了<em class="md">身份验证</em>复选框，您可以使用<a class="ae lb" href="https://cloud.google.com/functions/docs/securing/managing-access-iam" rel="noopener ugc nofollow" target="_blank">通过IAM </a>管理访问中的这些指示，使任何人都可以使用它。记住要小心这种访问，并考虑使用it案例，如测试集成。</p><ol class=""><li id="6eb8" class="jk jl hi io b ip iq it iu ix jm jb jn jf jo jj mo jq jr js bi translated"><a class="ae lb" href="https://console.cloud.google.com/functions/" rel="noopener ugc nofollow" target="_blank">转到谷歌云控制台</a></li><li id="0813" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj mo jq jr js bi translated">单击要授予访问权限的功能旁边的复选框。</li><li id="2277" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj mo jq jr js bi translated">点击右上角的<strong class="io hj">显示信息面板</strong>显示<strong class="io hj">权限</strong>选项卡。</li><li id="1139" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj mo jq jr js bi translated">点击<strong class="io hj">添加成员</strong>。</li><li id="96db" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj mo jq jr js bi translated">在<strong class="io hj">新成员</strong>字段中，键入<code class="du mp mq mr lv b">allUsers</code>。</li><li id="3144" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj mo jq jr js bi translated">从<strong class="io hj">选择角色</strong>下拉菜单中选择角色<strong class="io hj">云功能&gt;云功能调用者</strong>。</li><li id="6c88" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj mo jq jr js bi translated">点击<strong class="io hj">保存</strong>。</li></ol><h2 id="d49f" class="lc jz hi bd ka ld le lf ke lg lh li ki ix lj lk km jb ll lm kq jf ln lo ku lp bi translated">身份验证|元数据令牌</h2><p id="3b7e" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">如果您正在运行来自Google云服务的云函数请求，那么会有一些说明，展示如何通过调用元数据服务来获取令牌。<a class="ae lb" href="https://cloud.google.com/functions/docs/securing/authenticating" rel="noopener ugc nofollow" target="_blank">认证开发者、功能和最终用户</a>下的文档更详细。下面是你可以在Python中使用的一些代码的一个例子。</p><pre class="lq lr ls lt fd lu lv lw lx aw ly bi"><span id="6823" class="lc jz hi lv b fi lz ma l mb mc">REGION = 'us-central1'<br/>PROJECT_ID = [PROJECT ID]<br/>RECEIVING_FUNCTION = [FUNC NAME]</span><span id="03ee" class="lc jz hi lv b fi me ma l mb mc">function_url = f'<a class="ae lb" rel="noopener ugc nofollow" target="_blank" href="/google-cloud/{REGION}-{PROJECT_ID}.cloudfunctions.net/{RECEIVING_FUNCTION}'">https://{REGION}-{PROJECT_ID}.cloudfunctions.net/{RECEIVING_FUNCTION}'</a><br/>metadata_server_url = \<br/>    '<a class="ae lb" href="http://metadata/computeMetadata/v1/instance/service-accounts/default/identity?audience='" rel="noopener ugc nofollow" target="_blank">http://metadata/computeMetadata/v1/instance/service-accounts/default/identity?audience='</a><br/>token_full_url = metadata_server_url + function_url<br/>token_headers = {'Metadata-Flavor': 'Google'}</span><span id="5ecf" class="lc jz hi lv b fi me ma l mb mc">token_response = requests.get(token_full_url, headers=token_headers)<br/>jwt = token_response.text<br/>function_headers = {'Authorization': f'bearer {jwt}'}<br/>r = requests.get(function_url, headers=function_headers)</span></pre><p id="3658" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当我试图在本地找出令牌时，我尝试了元数据，但遇到了其他错误，这让我很困惑。<em class="md">“URL超过最大重试次数”和“无法建立新连接”。</em>这让我陷入困惑，认为我需要改变云功能的配置。底线是，你必须在一个你可以像云计算一样调用它的服务上。</p><h2 id="415a" class="lc jz hi bd ka ld le lf ke lg lh li ki ix lj lk km jb ll lm kq jf ln lo ku lp bi translated">故障排除和记录</h2><p id="e978" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">当构建具有多个集成服务的东西时，如果可以的话，最好分解组件并在每个单独的服务上直接测试它们。我在上面分享过，云函数允许直接在UI中或者从命令行进行测试。如果你得到不清楚的错误，使用它。此外，尽可能使用日志记录。<a class="ae lb" href="https://cloud.google.com/logging/docs/setup/python" rel="noopener ugc nofollow" target="_blank">谷歌云提供日志</a>，你可以在平台的<strong class="io hj"> </strong>操作日志服务中看到更多关于如何设置记录的信息。详细的日志记录是您的朋友，可以帮助跟踪奇怪的错误。</p><p id="941d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你读过我以前的任何帖子，你可能知道我喜欢从小处着手，尽可能地在本地进行集成测试。在处理身份验证、配置差异和日志记录细节不足时，这可能是一个挑战。从小处着手，添加日志，单独测试每项服务，然后逐步发展。</p><h2 id="358c" class="lc jz hi bd ka ld le lf ke lg lh li ki ix lj lk km jb ll lm kq jf ln lo ku lp bi translated">减少时间和成本</h2><p id="3730" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">最后但同样重要的是，在使用HTTP trigger时，记得在你的云函数中使用<strong class="io hj"> return </strong>。这将确保函数在超时前结束运行。如果它能更快地完成功能，你就不想为它超时的时间付费。</p><h1 id="2997" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">费用</h1><p id="b5f7" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">使用云功能的总成本包括它被调用的次数、运行的时间、提供的资源数量以及是否有任何出站网络请求。所以等式是调用+计算时间+网络。免费层每月提供2M调用、100万秒的免费计算和5GB的免费互联网出口流量。此后，调用是每百万0.4美元的统一费率，网络是每GB 0.12美元的统一费率，计算时间是每GB秒0.0000025美元或第1层每GHz秒0.00001美元。要了解更多信息，您可以查看<a class="ae lb" href="https://cloud.google.com/functions/pricing" rel="noopener ugc nofollow" target="_blank">定价文档</a>，其中提供了更具体的示例和成本明细。</p><h1 id="19bc" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">包裹</h1><p id="6cad" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">我使用Python 3.7逐步完成了云函数的设置和调用。我分享了我经历过的陷阱，希望其他可能犯这些错误的人能够发现这一点，并看到如何比我在搜索时更快地解决问题。使用云函数时要记住的一个关键点是，当您需要对该函数进行许多许多调用并且该函数可以在不到9分钟的时间内完成时，使用它是很好的；不然你应该看看云跑之类的。</p><p id="1afa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">探索愉快。</p></div></div>    
</body>
</html>