<html>
<head>
<title>How to cruise through Database Migration Service on Google Cloud — the REST API way!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何浏览Google Cloud上的数据库迁移服务REST API方式！</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cruising-through-database-migration-service-on-google-cloud-the-rest-api-way-8164660a757b?source=collection_archive---------3-----------------------#2022-10-17">https://medium.com/google-cloud/cruising-through-database-migration-service-on-google-cloud-the-rest-api-way-8164660a757b?source=collection_archive---------3-----------------------#2022-10-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4729" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云计算的出现及其引发的数字化转型所造成的破坏，迫使当今的企业加快其云计算之旅。为了在市场中生存，对快速应用程序现代化的需求无疑让每个组织都保持警觉。数据库迁移是任何应用程序现代化不可或缺的一部分，因为将应用程序迁移到云中需要迁移附带的数据。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/02759ffa7222dddd7e082dc672005897.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fDhUi8-ZtIni9fa2jFetLQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">谷歌云数据库迁移服务</figcaption></figure><p id="bbff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jt translated"><span class="l ju jv jw bm jx jy jz ka kb di"> G </span> oogle云数据库迁移服务(或DMS)简化了数据库工作负载向云SQL(可靠、安全&amp;经济高效的云数据库)的迁移，无需为原生迁移支付额外的基本费用*。此外，它是完全托管的，不需要任何运营或管理开销。</p><p id="0ac8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kc">*有关成本考虑的更多详情，请参考下表1。</em></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kd"><img src="../Images/fbd176e6bcb27c68d3d82e886d764316.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*chbkHdCeIrprSzlZauQrKQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">表1</figcaption></figure><p id="ea31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将使用DMS REST API命令探索PostgreSQL实例及其数据库的端到端迁移。</p><blockquote class="ke kf kg"><p id="48c9" class="if ig kc ih b ii ij ik il im in io ip kh ir is it ki iv iw ix kj iz ja jb jc hb bi translated">注意:这是一个很长的阅读…想知道为什么我没有缩短这个…</p></blockquote><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kk"><img src="../Images/a22525d2576b44e66f92f8163773ca52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T2SFSeA-yrlCoSVRpK0GuQ.png"/></div></div></figure><p id="c10e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出于本文的目的，源PostgreSQL实例设置在GCE VM上。探险者参考<a class="ae kl" href="https://cloud.google.com/architecture/postgresql-migration-with-database-migration-service#creating_a_source_postgresql_instance" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es km"><img src="../Images/ded7ba80caa3d76193cbc32a10453dd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/1*NLYAz9TslHDeB6H-QmoIWw.gif"/></div></figure><p id="74e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jt translated"><span class="l ju jv jw bm jx jy jz ka kb di"> L </span>让我们从<strong class="ih hj">先决条件</strong>开始吧！</p><p id="0891" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在通过DMS迁移之前，必须对源实例和底层数据库应用以下几项配置:</p><ol class=""><li id="3748" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc ks kt ku kv bi translated">在源实例上安装<strong class="ih hj"> pglogical </strong>包并修改必要的配置。</li><li id="ce88" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">具有复制角色的<strong class="ih hj">用户(在本文中称为“迁移用户”)的可用性。</strong></li><li id="2b67" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated">在源实例上的每个数据库上安装<strong class="ih hj"> pglogical </strong>扩展，并授予迁移用户对这些数据库的适当权限。</li></ol><p id="5cae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有关源配置的详细步骤，请参考<a class="ae kl" href="https://cloud.google.com/database-migration/docs/postgres/configure-source-database" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><p id="8122" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，在Google云平台上的目标项目中启用“<strong class="ih hj">数据库迁移服务API</strong>”&amp;”<strong class="ih hj">云SQL Admin API </strong>”(这是我们巡游出航的必备)。可选地，如果我们需要目标云SQL和源数据库位于Google Cloud上的VPC之间的VPC对等，可能还需要启用“<strong class="ih hj">服务网络API </strong>”。启用此API有助于将云SQL实例配置为使用私有IP。稍后，我们将回到“<a class="ae kl" href="#5608" rel="noopener ugc nofollow"> <strong class="ih hj">连接方法</strong> </a>”，包括VPC对等和其他选项..所以我们现在不必为此烦恼！</p><p id="9a68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jt translated">用于执行数据库迁移服务API命令的ime。呜-呼！！</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lb"><img src="../Images/9df0d1f84f870f7dadb354cc0c7b4f46.png" data-original-src="https://miro.medium.com/v2/resize:fit:684/format:webp/1*rZ7C24Ab4Wcxr0C30RBl_Q.jpeg"/></div></figure><p id="fb85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">关键</strong> <strong class="ih hj">注意事项</strong>就本文而言:</p><ul class=""><li id="bbe3" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc lc kt ku kv bi translated">我们将使用<strong class="ih hj"> cURL </strong>从云Shell执行API命令。</li><li id="e8f1" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc lc kt ku kv bi translated">对于认证，我们使用<a class="ae kl" href="https://cloud.google.com/docs/authentication/rest" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">应用默认凭证</strong> </a>而不保存它们(<strong class="ih hj">g cloud auth Application-Default print-access-token</strong>)。随意使用<a class="ae kl" href="https://cloud.google.com/docs/authentication/api-keys" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> API键</strong> </a>或<a class="ae kl" href="#171c" rel="noopener ugc nofollow"> <strong class="ih hj">认证的其他首选方法来调用REST API</strong>。</a></li><li id="fba5" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc lc kt ku kv bi translated">对于PUT/POST请求，我们必须创建一个JSON文件，其中包含API执行所需的数据(数据文件是提供敏感数据的一种安全方式)。</li><li id="b29a" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc lc kt ku kv bi translated">数据文件的路径(如适用)将通过命令行提供，前面有<code class="du ld le lf lg b">@</code>字符，作为<code class="du ld le lf lg b">--data</code>参数。</li><li id="19de" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc lc kt ku kv bi translated">由于API是异步的，任何对象创建API命令都将立即返回，即使操作没有完成。这也适用于其他<strong class="ih hj">长时间运行的操作(LRO) </strong>，如迁移作业的验证。在这种情况下，使用<a class="ae kl" href="https://cloud.google.com/database-migration/docs/reference/rest/v1/projects.locations.operations" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> DMS API来管理操作</strong> </a>并在进入下一个相关步骤之前验证操作的完成。</li></ul><p id="ec34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jt translated">我会准备好…我们开始吧！</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lh"><img src="../Images/f4c075140a666e6f8bf5644de38068cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*PEchBLwjCS1gY7S9J0NJww.jpeg"/></div></figure><h2 id="d6fe" class="li lj hi bd lk ll lm ln lo lp lq lr ls iq lt lu lv iu lw lx ly iy lz ma mb mc bi translated">涉及的主要步骤的快速总结:</h2><ol class=""><li id="3cca" class="kn ko hi ih b ii md im me iq mf iu mg iy mh jc ks kt ku kv bi translated"><a class="ae kl" href="#dc67" rel="noopener ugc nofollow">为PostgreSQL创建源连接概要文件</a></li><li id="6908" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae kl" href="#607d" rel="noopener ugc nofollow">【可选:适用于所有LRO】运行状态验证</a></li><li id="543d" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae kl" href="#6b3b" rel="noopener ugc nofollow">为云SQL (Postgres)创建目标连接配置文件</a></li><li id="6017" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae kl" href="#b018" rel="noopener ugc nofollow">【可选:仅在需要VPC对等时适用】源实例&amp; VPC对等配置</a></li><li id="73aa" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae kl" href="#d26c" rel="noopener ugc nofollow">创建迁移作业</a></li><li id="7e5d" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae kl" href="#3435" rel="noopener ugc nofollow">【可选:推荐】迁移作业的验证</a></li><li id="20c4" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae kl" href="#3a8b" rel="noopener ugc nofollow">开始迁移作业</a></li><li id="ad35" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae kl" href="#c75b" rel="noopener ugc nofollow">[手动/自动]验证用于迁移的目标云SQL读取副本</a></li><li id="371f" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae kl" href="#68f8" rel="noopener ugc nofollow">推进迁移工作</a></li></ol><h2 id="dc67" class="li lj hi bd lk ll lm ln lo lp lq lr ls iq lt lu lv iu lw lx ly iy lz ma mb mc bi translated">1.为PostgreSQL创建源连接概要文件</h2><p id="38d5" class="pw-post-body-paragraph if ig hi ih b ii md ik il im me io ip iq mi is it iu mj iw ix iy mk ja jb jc hb bi translated">按顺序执行以下步骤，创建源连接配置文件。</p><p id="9cd4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> A .用创建一个数据文件。json扩展并将其上传到云shell: </strong>为了创建源连接配置文件，以下是作为数据文件提供的最低要求信息—不含SSL(但不建议用于生产) :</p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="ecea" class="li lj hi lg b fi mp mq l mr ms">{<br/>  "name": "&lt;n<strong class="lg hj">ame_for_the_sourceprofile&gt;</strong>",<br/>  "displayName": "<strong class="lg hj">&lt;display_name_for_the_profile&gt;</strong>",<br/>  "postgresql": {<br/>    "host": "<strong class="lg hj">&lt;host_machine_IP&gt;</strong>",<br/>    "port": 5432,<br/>    "username": "<strong class="lg hj">&lt;migration_username&gt;</strong>",<br/>    "password": "<strong class="lg hj">&lt;password_of_migration_user&gt;</strong>"<br/>  }<br/>}</span></pre><p id="802d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">* <em class="kc">适当替换粗体突出显示的文本。另外，请注意PostgreSQL使用的默认端口:5432。以下json示例:</em></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="b779" class="li lj hi lg b fi mp mq l mr ms">{<br/>  "name": "postgres-profile", <br/>  "displayName": "postgres profile",<br/>  "postgresql": {<br/>    "host": "0.1.2.3",<br/>    "port": 5432,<br/>    "username": "dbmig",<br/>    "password": "dbmigpwd"<br/>  }<br/>}</span></pre><p id="97ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> B .从云shell执行curl命令:</strong>一旦在步骤#A中创建的json被上传到云shell，执行下面的命令以在期望的GCP项目和区域中创建源连接概要文件:</p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="e13c" class="li lj hi lg b fi mp mq l mr ms">curl --header "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>     --header 'Content-Type: application/json' \<br/>     --data @<strong class="lg hj">&lt;path-to-fileuploaded_in_stepA&gt;/&lt;filename&gt;</strong> \<br/>     -X POST \<br/>     https://datamigration.googleapis.com/v1/projects/<strong class="lg hj">&lt;target_gcp_project&gt;</strong>/locations/<strong class="lg hj">&lt;target_gcp_region&gt;</strong>/connectionProfiles?connectionProfileId=<strong class="lg hj">&lt;source_connection_profile_name_from_stepA&gt;</strong></span></pre><p id="fe2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">* <em class="kc">适当替换粗体突出显示的文本。下面的命令示例:</em></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="5e33" class="li lj hi lg b fi mp mq l mr ms">curl --header "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>     --header 'Content-Type: application/json' \<br/>     --data @./create_profile_postgres.json \<br/>     -X POST \<br/>     https://datamigration.googleapis.com/v1/projects/mydmsproject-sn/locations/us-central1/connectionProfiles?connectionProfileId=postgres-profile</span></pre><p id="558e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> C .检查来自云外壳的命令的响应:</strong>响应将返回一个operationId(因为这是一个长时间运行的异步操作)，它可用于在创建目标连接配置文件之前验证上面的创建操作的状态。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mt"><img src="../Images/8fb8efa73d6c9073b590656779f40018.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UGHxpHz87SwpLVVyvPvyjw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">来自云壳的响应</figcaption></figure><p id="c626" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> D .从GCP控制台验证概要文件的创建:</strong>如果操作成功完成，也可以从GCP控制台验证源概要文件的创建(另一种通过管理操作进行验证的方法在步骤#2中讨论，它适用于任何返回operationID的REST API)。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mu"><img src="../Images/09116ff8c13c203823ad03e34502b047.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rbu_eEccVDSXM8_ircoIjw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">源连接配置文件</figcaption></figure><h2 id="607d" class="li lj hi bd lk ll lm ln lo lp lq lr ls iq lt lu lv iu lw lx ly iy lz ma mb mc bi translated">2.[可选:适用于所有LRO]运行状态验证</h2><p id="1642" class="pw-post-body-paragraph if ig hi ih b ii md ik il im me io ip iq mi is it iu mj iw ix iy mk ja jb jc hb bi translated">按顺序执行以下步骤，使用GET方法获取有关operationId的信息。</p><p id="66c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kc">注意:还有其他列出/取消/删除操作的方法，不在我们讨论的范围内。</em></p><p id="b13e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> A .从云外壳执行curl命令:</strong>执行以下命令来验证给定operationId的状态:</p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="fee7" class="li lj hi lg b fi mp mq l mr ms">curl -X GET \</span><span id="4b8b" class="li lj hi lg b fi mv mq l mr ms">-H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>     https://datamigration.googleapis.com/v1/projects/<strong class="lg hj">&lt;same_as_target_gcp_project&gt;</strong>/locations/<strong class="lg hj">&lt;same_as_target_gcp_region&gt;</strong>/operations/<strong class="lg hj">&lt;operationId_for_any_LRO&gt;</strong></span></pre><p id="58e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">* <em class="kc">适当替换粗体突出显示的文本。下面的命令示例:</em></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="158f" class="li lj hi lg b fi mp mq l mr ms">curl -X GET \</span><span id="a300" class="li lj hi lg b fi mv mq l mr ms">-H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \</span><span id="aec2" class="li lj hi lg b fi mv mq l mr ms">https://datamigration.googleapis.com/v1/projects/mydmsproject-sn/locations/us-central1/operations/operation-1663145358291-5e89f344a7205-94235201-f4fed53c</span></pre><p id="1a47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> B .在操作进行中查看云壳命令的响应:</strong>如果操作进行中，响应将返回详细信息，字段为<strong class="ih hj">“完成”:false </strong>。在响应元数据部分需要注意的关键字段是"<strong class="ih hj">动词</strong>(操作的名称—验证、创建、升级等。)和“<strong class="ih hj">目标</strong>”(资源标识符)。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mw"><img src="../Images/61da045d07d9f967d2ba6efc987cd68b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q_42n0Gc1YhbwapZy6J8zg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">来自云壳的响应</figcaption></figure><p id="661c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> C .检查来自云壳的命令对操作完成的响应:</strong>响应将返回已完成操作的细节，具有字段<strong class="ih hj">“done】:true</strong>和任意一个适当的结果字段:<strong class="ih hj">“error”</strong>(在执行失败的情况下)<strong class="ih hj"> </strong>或<strong class="ih hj">“response”</strong>(在成功执行的情况下)。在响应元数据部分要注意的关键字段是“<strong class="ih hj">动词</strong>”(操作的名称—验证、创建、升级等。)和“<strong class="ih hj">目标</strong>”(资源标识符)。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mx"><img src="../Images/17eba8ab9033b9a6342e227793f802eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kh55o52Tgd4HV64xwJtUXQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">云外壳对失败操作的响应(迁移作业验证)</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es my"><img src="../Images/4c47b8121395baa1169d4a7da9fe8250.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s90NQQhGu3W1P-E1jQ82wA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">来自云外壳的成功操作响应(connectionProfile创建)</figcaption></figure><h2 id="6b3b" class="li lj hi bd lk ll lm ln lo lp lq lr ls iq lt lu lv iu lw lx ly iy lz ma mb mc bi translated">3.为云SQL (Postgres)创建目标连接配置文件</h2><p id="f849" class="pw-post-body-paragraph if ig hi ih b ii md ik il im me io ip iq mi is it iu mj iw ix iy mk ja jb jc hb bi translated">目标配置文件创建外部主连接配置文件(用后缀“_master”标识)以及读取副本(创建期间提供的数据库版本)。实际数据迁移发生在读取复制副本上，然后提升为主复制副本。External master只是一个链接到源数据库的占位符，可能有不同的数据库版本——这应该完全没问题！</p><p id="fb9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按顺序执行以下步骤，创建目标连接配置文件。</p><p id="aa83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> A .用创建一个数据文件。json扩展并将其上传到云shell: </strong>要创建目的地连接配置文件，请使用以下信息创建一个数据文件:</p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="6dbe" class="li lj hi lg b fi mp mq l mr ms">{ "name":"<strong class="lg hj">&lt;name_for_the_targetprofile&gt;</strong>",<br/>  "displayName": "<strong class="lg hj">&lt;display_name_for_the_profile&gt;</strong>",<br/>  "cloudsql": {<br/>    "settings": {<br/>      "databaseVersion": "<strong class="lg hj">&lt;target_database_version&gt;</strong>",<br/>      "tier": "<strong class="lg hj">&lt;machine_type&gt;</strong>",<br/>      "activationPolicy": "<strong class="lg hj">&lt;ALWAYS_or_NEVER&gt;</strong>",<br/>      "autoStorageIncrease": <strong class="lg hj">&lt;true_or_false&gt;</strong>,<br/>      "zone": "<strong class="lg hj">&lt;target_gcp_zone_in_project_region&gt;</strong>",<br/>      "sourceId": "<strong class="lg hj">&lt;source_connection_profile_identifier_fromStep1&gt;</strong>",<br/>      "rootPassword":"<strong class="lg hj">&lt;setup_root_password_here&gt;</strong>"<br/>    }<br/>  }<br/>}</span></pre><p id="3300" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">* <em class="kc">适当替换粗体突出显示的文本。下面是一个始终活动的连接的json示例(设置</em> "activationPolicy": "NEVER "，如果该实例需要关闭而不考虑传入的连接请求<em class="kc"> ) : </em></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="23bd" class="li lj hi lg b fi mp mq l mr ms">{ "name":"new2-target-postgres-profile",<br/>  "displayName": "new2 target postgres profile",<br/>  "cloudsql": {<br/>    "settings": {<br/>      "databaseVersion": "POSTGRES_12",<br/>      "tier": "db-custom-1-3840",<br/>      "activationPolicy": "ALWAYS",<br/>      "autoStorageIncrease": false,<br/>      "zone": "us-central1-b",<br/>      "sourceId": "projects/mydmsproject-sn/locations/us-central1/connectionProfiles/postgres-profile",<br/>      "rootPassword":"mytargetpwd"<br/>    }<br/>  }<br/>}</span></pre><p id="ba9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> B .从云shell执行curl命令:</strong>一旦在步骤#A中创建的json被上传到云shell，执行下面的命令以在期望的GCP项目和区域中创建目的地连接概要文件(与步骤<strong class="ih hj"> 1相同的命令)。B </strong>):</p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="bdbc" class="li lj hi lg b fi mp mq l mr ms">curl --header "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>     --header 'Content-Type: application/json' \<br/>     --data @<strong class="lg hj">&lt;path-to-fileuploaded_in_StepA&gt;/&lt;filename&gt;</strong> \<br/>     -X POST \<br/>     https://datamigration.googleapis.com/v1/projects/<strong class="lg hj">&lt;target_gcp_project&gt;</strong>/locations/<strong class="lg hj">&lt;target_gcp_region&gt;</strong>/connectionProfiles?connectionProfileId=<strong class="lg hj">&lt;destination_connection_profile_name_from_stepA&gt;</strong></span></pre><p id="5ced" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">* <em class="kc">适当替换粗体突出显示的文本。下面的命令示例:</em></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="7d2c" class="li lj hi lg b fi mp mq l mr ms">curl --header "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>--header 'Content-Type: application/json' \<br/>--data @./create_profile_target_postgres.json \<br/>-X POST \<br/>https://datamigration.googleapis.com/v1/projects/mydmsproject-sn/locations/us-central1/connectionProfiles?connectionProfileId=new2-target-postgres-profile</span></pre><p id="f2c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> C .查看云壳对命令的响应:</strong> Response将返回operationId(类似于<strong class="ih hj">步骤1。C) </strong>，可以在进入下一步之前确认完成。</p><p id="60c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> D .从GCP控制台验证概要文件创建:</strong>成功完成后，还可以从GCP控制台验证目标云SQL(主服务器和读取副本)的创建。但是，与源配置文件不同，目标配置文件不会显示在GCP控制台上。connectionProfiles的GET/LIST方法可用于检索有关它们的信息。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mz"><img src="../Images/7bfbc27dceb4121eaa2a0a044c7de671.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X-o2qz8mxflzLE7FNdlczA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">目标云SQL实例</figcaption></figure><p id="23e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们已经完成了三分之一的流程…</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es km"><img src="../Images/8bd3e8e66bcf437506fc6c7c9917e2df.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/1*0eENCU06IE37UBx73ksH0w.gif"/></div></figure><p id="8695" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">继续前进！</p><h2 id="b018" class="li lj hi bd lk ll lm ln lo lp lq lr ls iq lt lu lv iu lw lx ly iy lz ma mb mc bi translated">4.[可选:仅在需要VPC对等时适用]对等的源实例和VPC配置</h2><p id="3eb8" class="pw-post-body-paragraph if ig hi ih b ii md ik il im me io ip iq mi is it iu mj iw ix iy mk ja jb jc hb bi translated">为了确保源数据库实例和目标数据库实例之间的成功连接，在创建迁移作业之前，必须应用以下配置更改:</p><ol class=""><li id="dfd0" class="kn ko hi ih b ii ij im in iq kp iu kq iy kr jc ks kt ku kv bi translated"><strong class="ih hj">配置私有服务访问:</strong>假设“服务网络API”已经启用，导航到VPC网络页面上的源VPC，并将其编辑为a)。<a class="ae kl" href="https://cloud.google.com/vpc/docs/configure-private-services-access#procedure" rel="noopener ugc nofollow" target="_blank">分配IP范围</a>和b)。<a class="ae kl" href="https://cloud.google.com/vpc/docs/configure-private-services-access#creating-connection" rel="noopener ugc nofollow" target="_blank">创建到分配范围</a>的私有连接。如果省略此步骤，将不会创建迁移作业。</li><li id="4287" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><strong class="ih hj">在源VPC上配置防火墙规则，以允许来自目标CloudSQL的连接:</strong>向源VPC添加防火墙规则，以允许目标CloudSQL在端口5432(在步骤1中创建源配置文件时配置的端口)上的传出IP地址。</li><li id="a2a4" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><strong class="ih hj">编辑源实例配置文件(pg_hba.conf) </strong> : SSH到安装源PostgreSQL的GCE虚拟机，编辑pg_hba.conf文件以允许目标CloudSQL的传出IP地址。</li></ol><p id="f06c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kc">注意:如果不执行上面的步骤# 2和#3，迁移作业仍将被创建，但是，它将在验证/启动阶段失败，并显示错误:“连接到源数据库失败。请确保连接配置文件上的连接信息正确，并且源数据库可以访问。解决问题，然后开始迁移作业。</em></p><h2 id="d26c" class="li lj hi bd lk ll lm ln lo lp lq lr ls iq lt lu lv iu lw lx ly iy lz ma mb mc bi translated">5.迁移作业的创建</h2><p id="f847" class="pw-post-body-paragraph if ig hi ih b ii md ik il im me io ip iq mi is it iu mj iw ix iy mk ja jb jc hb bi translated">让我们快速探究一下在源和目标数据库实例之间建立连接的可能方法。</p><blockquote class="ke kf kg"><p id="5608" class="if ig kc ih b ii ij ik il im in io ip kh ir is it ki iv iw ix kj iz ja jb jc hb bi translated"><strong class="ih hj">连接方法</strong></p><p id="19b7" class="if ig kc ih b ii ij ik il im in io ip kh ir is it ki iv iw ix kj iz ja jb jc hb bi translated">创建迁移作业时，支持以下3种连接方法来建立源数据库和目标数据库之间的连接:</p><p id="4ab2" class="if ig kc ih b ii ij ik il im in io ip kh ir is it ki iv iw ix kj iz ja jb jc hb bi translated">1.VpcPeeringConnectivity:该选项需要Google Cloud中源数据库所在的VPC的详细信息。这用于在云SQL和提供的VPC之间建立VPC对等连接。</p><p id="a3c1" class="if ig kc ih b ii ij ik il im in io ip kh ir is it ki iv iw ix kj iz ja jb jc hb bi translated">2.ReverseSshConnectivity*:该选项用于在源数据库和目标数据库之间创建反向SSH隧道。这种方法依赖于一个Bastion服务器来建立反向SSH隧道，最终还会在云SQL私有网络和VPC之间建立VPC对等。</p><p id="8927" class="if ig kc ih b ii ij ik il im in io ip kh ir is it ki iv iw ix kj iz ja jb jc hb bi translated">3.StaticIpConnectivity * *:当源数据库需要允许来自目标数据库的公共IP的传入连接时，使用此选项。</p><p id="e25f" class="if ig kc ih b ii ij ik il im in io ip kh ir is it ki iv iw ix kj iz ja jb jc hb bi translated">*关于使用此选项创建迁移作业的更多详细信息，本文不做介绍。</p><p id="a43b" class="if ig kc ih b ii ij ik il im in io ip kh ir is it ki iv iw ix kj iz ja jb jc hb bi translated">* *这是默认设置，不需要额外配置。</p></blockquote><p id="e416" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经了解了连接方法，让我们按顺序执行以下步骤，用VpcPeeringConnectivity创建一个迁移作业。</p><p id="49be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> A .用创建一个数据文件。json扩展并将其上传到云shell: </strong>对于创建迁移作业，下面是作为数据文件提供的最低要求信息—对于VpcPeeringConnectivity(对于StaticIpConnectivity，只需省略字段:“vpcPeeringConnectivity”):</p><p id="d3a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kc">注意:</em> <strong class="ih hj"> <em class="kc">【类型】:PostgreSQL不支持ONE_TIME </em> </strong> <em class="kc">，在撰写本文时。</em></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="b083" class="li lj hi lg b fi mp mq l mr ms">{<br/>   "name":"<strong class="lg hj">&lt;name_for_the_migrationjob&gt;</strong>",<br/>   "displayName":"<strong class="lg hj">&lt;display_name_for_the_job&gt;</strong>",<br/>   "type":"CONTINUOUS",<br/>   "source":"<strong class="lg hj">&lt;source_connection_profile_identifier_fromstep1&gt;</strong>",<br/>   "destination":"<strong class="lg hj">&lt;destination_connection_profile_identifier_fromstep3</strong>&gt;",<br/>   "sourceDatabase":{<br/>      "provider":"DATABASE_PROVIDER_UNSPECIFIED",<br/>      "engine":"POSTGRESQL"<br/>   },<br/>   "destinationDatabase":{<br/>      "provider":"CLOUDSQL",<br/>      "engine":"POSTGRESQL"<br/>   },<br/>   "vpcPeeringConnectivity":{<br/>      "vpc":"<strong class="lg hj">&lt;name_of_vpc_containing_source_database_instance&gt;</strong>"<br/>   }<br/>  }</span></pre><p id="dca7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">* <em class="kc">适当替换粗体突出显示的文本。以下json示例:</em></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="ce68" class="li lj hi lg b fi mp mq l mr ms">{<br/>   "name":"postgres-migration-job",<br/>   "displayName":"postgres migration job",<br/>   "type":"CONTINUOUS",<br/>   "source":"projects/mydmsproject-sn/locations/us-central1/connectionProfiles/postgres-profile",<br/>   "destination":"projects/mydmsproject-sn/locations/us-central1/connectionProfiles/new2-target-postgres-profile",<br/>   "sourceDatabase":{<br/>      "provider":"DATABASE_PROVIDER_UNSPECIFIED",<br/>      "engine":"POSTGRESQL"<br/>   },<br/>   "destinationDatabase":{<br/>      "provider":"CLOUDSQL",<br/>      "engine":"POSTGRESQL"<br/>   },<br/>   "vpcPeeringConnectivity":{<br/>      "vpc":"mydmsproject-sn-vpc-source"<br/>   }<br/>  }</span></pre><p id="8326" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> B .从云shell执行curl命令:</strong>一旦在步骤#A中创建的json被上传到云shell，执行下面的命令以在期望的GCP项目和区域中创建迁移作业:</p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="2f14" class="li lj hi lg b fi mp mq l mr ms">curl --header "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>--header 'Content-Type: application/json' \<br/>--data @./<strong class="lg hj">&lt;path-to-fileuploaded_in_StepA&gt;/&lt;filename&gt;</strong> \<br/>-X POST \<br/>https://datamigration.googleapis.com/v1/projects/&lt;<strong class="lg hj">same_as_target_gcp_project&gt;</strong>/locations/<strong class="lg hj">&lt;same_as_target_gcp_region&gt;</strong>/migrationJobs?migrationJobId=<strong class="lg hj">&lt;id_of_the_migration_job&gt;</strong>&amp;requestId=<strong class="lg hj">&lt;unique_id_for_request&gt;</strong></span></pre><p id="20c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">* <em class="kc">适当替换粗体突出显示的文本。下面的命令示例:</em></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="5d54" class="li lj hi lg b fi mp mq l mr ms">curl --header "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>--header 'Content-Type: application/json' \<br/>--data @./create_migjob_postgres.json \<br/>-X POST \<br/>https://datamigration.googleapis.com/v1/projects/mydmsproject-sn/locations/us-central1/migrationJobs?migrationJobId=postgres-migjob&amp;requestId=mypostgresjob1</span></pre><p id="bf66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> C .查看云壳的命令响应:</strong>返回operationId(类似于<strong class="ih hj">步骤1。C) </strong>，只是目标字段将是迁移作业的路径。</p><p id="a728" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> D .从GCP控制台验证作业创建:</strong>也可以从GCP控制台验证迁移作业的创建。</p><p id="e065" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kc">注意:如果在此阶段没有启用“</em> <strong class="ih hj"> <em class="kc">”服务网络API</em></strong><em class="kc">”(VPC对等所必需的)，作业创建将失败，并显示错误消息:“无法创建子网。消费者&lt;项目Id &gt;应在生成默认身份之前启用服务:服务联网”。如果启用了API，但未配置</em> <a class="ae kl" href="#dfd0" rel="noopener ugc nofollow"> <strong class="ih hj"> <em class="kc">私有服务访问</em> </strong> </a> <em class="kc">，作业可能会失败，并显示错误信息:“无法创建子网。请从消费者&lt;项目Id &gt;网络&lt;源_ vpc _网络&gt;再次创建与服务‘Service Networking . Google APIs . com’的服务网络连接。</em></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es na"><img src="../Images/6f6cf94dd0acbaa11e50de2408a0a059.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Um9nS1uswi3AytxSoyUqcw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">快速查看迁移作业</figcaption></figure><h2 id="3435" class="li lj hi bd lk ll lm ln lo lp lq lr ls iq lt lu lv iu lw lx ly iy lz ma mb mc bi translated">6.[可选:推荐]迁移作业的验证</h2><p id="f653" class="pw-post-body-paragraph if ig hi ih b ii md ik il im me io ip iq mi is it iu mj iw ix iy mk ja jb jc hb bi translated">按顺序执行以下步骤，以验证迁移作业。此步骤执行所有预验证，以确保迁移作业设置正确，并且将成功启动和运行。在开始迁移作业之前，验证迁移作业是一种很好的做法。</p><p id="4380" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> A .从云外壳执行curl命令:</strong>迁移作业创建成功后，执行以下命令验证该迁移作业:</p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="ebf8" class="li lj hi lg b fi mp mq l mr ms">curl --header "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>     -X POST<br/>https://datamigration.googleapis.com/v1/projects/&lt;<strong class="lg hj">same_as_target_gcp_project&gt;</strong>/locations/<strong class="lg hj">&lt;same_as_target_gcp_region&gt;</strong>/migrationJobs/<strong class="lg hj">&lt;id_of_the_migration_job_created_in_step5&gt;:verify</strong></span></pre><p id="ff43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">* <em class="kc">适当替换粗体突出显示的文本。下面的命令示例:</em></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="a364" class="li lj hi lg b fi mp mq l mr ms">curl --header "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>     -X POST https://datamigration.googleapis.com/v1/projects/mydmsproject-sn/locations/us-central1/migrationJobs/postgres-migjob:verify</span></pre><p id="224a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> B .查看来自云外壳的命令响应:</strong>响应将类似于<strong class="ih hj">步骤2。b或者第二步。C </strong>，取决于操作是正在进行还是已经完成。不应该执行第7步到第9步，除非响应返回一个json，带有字段<strong class="ih hj">“done】:true，</strong>，以及名为<strong class="ih hj">“response”</strong>的结果字段，表明执行成功。</p><p id="e71e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> C .从GCP控制台验证作业验证状态:</strong>一旦长时间运行的操作成功完成，也可以从GCP控制台验证迁移作业的状态，如果作业出错，它将显示在控制台上。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nb"><img src="../Images/0628caefcf3734a4fdb9577846d27e2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gKV1o4a3og0x8fi6uKDyuw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">迁移作业验证失败的示例视图</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nc"><img src="../Images/01ba2f128a29f1591e6ac9fde56a104d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kWxC_oXd5XA44EXYwyOl-g.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">迁移作业成功验证的示例视图</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es nd"><img src="../Images/7b1bc801434af4efe9e73ee7b2da42bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:888/format:webp/1*xkp6LCChYfrjs5es64Qd8w.png"/></div></figure><h2 id="3a8b" class="li lj hi bd lk ll lm ln lo lp lq lr ls iq lt lu lv iu lw lx ly iy lz ma mb mc bi translated">7.开始迁移作业</h2><p id="c8b9" class="pw-post-body-paragraph if ig hi ih b ii md ik il im me io ip iq mi is it iu mj iw ix iy mk ja jb jc hb bi translated">在迁移作业开始时，会拍摄源数据库的初始快照，并将转储文件加载到目标中。在初始加载后，CDC会持续处理，直到决定将正在进行的流量切换到目标，并将读取副本提升为主副本，我们将在第8步中介绍这一点。</p><p id="4144" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们已经验证了我们的迁移作业没有任何错误，让我们继续执行以下步骤来启动迁移作业。</p><p id="8aa3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kc">注意:如果迁移作业设置不正确(可能是由于源中缺少扩展、未启用适当的API等原因。)，启动迁移作业可能会导致错误。因此，最好在开始之前验证迁移作业。</em></p><p id="136a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> A .从云外壳执行curl命令:</strong>一旦成功验证了迁移作业，就执行下面的命令来启动迁移作业(语法类似于步骤#6中的验证命令):</p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="a041" class="li lj hi lg b fi mp mq l mr ms">curl --header "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>     -X POST https://datamigration.googleapis.com/v1/projects/mydmsproject-sn/locations/us-central1/migrationJobs/postgres-migjob:start</span></pre><p id="17fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> B .查看来自云外壳的命令响应:</strong>响应将类似于<strong class="ih hj">步骤2。b或者第二步。C </strong>，取决于操作是正在进行还是已经完成。</p><p id="ea3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> C .从GCP控制台验证作业执行状态:</strong>如果作业启动时没有任何错误，也可以从GCP控制台验证迁移作业的状态。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ne"><img src="../Images/29149982559f7d060a26ef31694dbc24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*deYncaowd-YTZ3b9Szso4Q.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">正在开始的<strong class="bd lk">连续</strong>迁移作业的示例视图</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nf"><img src="../Images/8ad33130affd94e5349fbd4c446f8906.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*In7HVIfdSeDLZVYiaCKt4A.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">成功运行的<strong class="bd lk">连续</strong>迁移作业的示例视图</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ng"><img src="../Images/c25fe703b70c914db56f0e2f75987308.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GawX1xMpJi3oronCrj07ww.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">失败的<strong class="bd lk">连续</strong>迁移作业的示例视图(这是验证步骤派上用场的地方)</figcaption></figure><h2 id="c75b" class="li lj hi bd lk ll lm ln lo lp lq lr ls iq lt lu lv iu lw lx ly iy lz ma mb mc bi translated">8.[手动/自动]验证用于迁移的目标云SQL读取副本</h2><p id="7a14" class="pw-post-body-paragraph if ig hi ih b ii md ik il im me io ip iq mi is it iu mj iw ix iy mk ja jb jc hb bi translated">建议在将目标云SQL读取复制副本提升为主副本之前，验证所有迁移的数据库以确保迁移成功。</p><p id="834f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是作为本文的一部分执行的步骤，用于验证目标SQL读取复制副本的升级准备情况。</p><p id="fc21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> A .验证通过1创建的目标数据库。GCP控制台或2。云壳使用cURL命令:</strong></p><p id="0c3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1.导航到GCP控制台上的SQL实例页面，并选择打开目标读取副本</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ng"><img src="../Images/19219af93ca02f98a9dc024a83396c15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*klYWynHbL3lv57TYTsqIeA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">A.云SQL目标数据库</figcaption></figure><p id="ec37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.从云外壳通过<strong class="ih hj"> </strong> curl执行<strong class="ih hj">云SQL API </strong>命令，并验证响应</p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="0e91" class="li lj hi lg b fi mp mq l mr ms">curl -X GET \<br/>     -H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>     https://sqladmin.googleapis.com/v1/projects/<strong class="lg hj">&lt;same_as_target_gcp_project&gt;</strong>/instances/<strong class="lg hj">&lt;name_for_the_targetprofile_created_in_step3&gt;</strong>/databases</span></pre><p id="8f93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">* <em class="kc">适当替换粗体突出显示的文本。下面的命令示例:</em></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="852b" class="li lj hi lg b fi mp mq l mr ms">curl -X GET \<br/>     -H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>     https://sqladmin.googleapis.com/v1/projects/mydmsproject-sn/instances/new2-target-postgres-profile/databases</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nh"><img src="../Images/e8a6d57daba84bedd01357c1a98b9115.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V6vB93aonxJLZcug0suSqw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">来自云壳的响应</figcaption></figure><p id="77f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> B .登录到目标数据库并验证数据:</strong>验证跨所有目标数据库迁移了正确的信息。跨表的数据应该与源表中的数据相匹配。下面的屏幕截图显示了准确迁移的一个表(没有主键)的数据，以及在information_schema上运行的查询，以确认目标表是在源中按原样创建的(即没有主键)。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ni"><img src="../Images/18a6fb7c1e91b25fde2205f25a3ea635.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gr8R4hKfzdoDi69fqHWmVA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">云SQL上目标数据库中的数据</figcaption></figure><h2 id="68f8" class="li lj hi bd lk ll lm ln lo lp lq lr ls iq lt lu lv iu lw lx ly iy lz ma mb mc bi translated">9.促进迁移工作</h2><p id="42bf" class="pw-post-body-paragraph if ig hi ih b ii md ik il im me io ip iq mi is it iu mj iw ix iy mk ja jb jc hb bi translated">升级迁移作业会断开目标云SQL实例与源的连接，并将读取复制副本实例转换为主实例(读/写模式)。现在，我们已经验证了迁移目标没有任何错误，让我们继续执行以下步骤，将云SQL读取复制副本提升为主实例。</p><p id="0023" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> A .从云外壳执行curl命令:</strong>一旦目的地验证成功迁移(和/或决定将流量切换到目的地云SQL实例)，执行以下示例命令将读取副本提升为主副本(语法类似于步骤#6中的验证命令):</p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="dae5" class="li lj hi lg b fi mp mq l mr ms">curl --header "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>     -X POST https://datamigration.googleapis.com/v1/projects/mydmsproject-sn/locations/us-central1/migrationJobs/postgres-migjob:promote</span></pre><p id="7805" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> B .查看来自云shell的命令响应:</strong>响应将类似于<strong class="ih hj">步骤2。b或者第二步。C </strong>，取决于操作是正在进行还是已经完成。</p><p id="43a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> C .从GCP控制台验证作业执行状态:</strong>当升级正在进行时(停机时间)，作业的状态将为“升级正在进行中”。一旦迁移作业无任何错误地完成未完成更改的处理，迁移作业的状态将更改为“已完成”,并且可以从GCP控制台进行验证。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nj"><img src="../Images/34b0da003a71529a7c4de4dc924d0a5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*azZ2aVbLHruoo2HeyOqIFg.png"/></div></div></figure><p id="3f6b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> D .从GCP控制台验证云SQL实例的状态:</strong>在GCP控制台上，验证外部主服务器和主云SQL实例(以前的读取副本)之间的链接不再存在。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nk"><img src="../Images/570973fb93ae363d02f06734b0c9c94c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bd5dq70yJKYur4qhnmPA4g.png"/></div></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nl"><img src="../Images/107a20b03acee9de40e3721a67ad28c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SdDkq4KF8gi9ehTBgXw5VA.png"/></div></div></figure><p id="bccc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jt translated"><span class="l ju jv jw bm jx jy jz ka kb di"> B </span> onus部分有一些需要了解的命令和参考链接，可以随时派上用场！</p><h2 id="73a8" class="li lj hi bd lk ll lm ln lo lp lq lr ls iq lt lu lv iu lw lx ly iy lz ma mb mc bi translated">快速命令</h2><ol class=""><li id="545e" class="kn ko hi ih b ii md im me iq mf iu mg iy mh jc ks kt ku kv bi translated"><strong class="ih hj">删除连接配置文件:</strong></li></ol><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="e5c8" class="li lj hi lg b fi mp mq l mr ms">curl -X DELETE \<br/>     -H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>     https://datamigration.googleapis.com/v1/projects/&lt;<strong class="lg hj">gcp_project_that_contains_theprofile&gt;</strong>/locations/<strong class="lg hj">&lt;gcp_region_of_theprofile&gt;</strong>/connectionProfiles/<strong class="lg hj">&lt;name_of_the_profile_to_delete&gt;</strong></span></pre><p id="324b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2。删除迁移作业:</strong></p><p id="2de1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kc">注意:目标CloudSQL连接概要文件也会随着迁移作业而被删除。</em></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="3920" class="li lj hi lg b fi mp mq l mr ms">curl -X DELETE \<br/>     -H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \<br/>     https://datamigration.googleapis.com/v1/projects/&lt;<strong class="lg hj">gcp_project_that_contains_thejob&gt;</strong>/locations/<strong class="lg hj">&lt;gcp_region_of_thejob&gt;</strong>/migrationJobs/<strong class="lg hj">&lt;name_of_the_job_to_delete&gt;</strong></span></pre><p id="31e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3。列出项目位置中的所有连接配置文件:</strong></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="b1d9" class="li lj hi lg b fi mp mq l mr ms">curl -X GET \<br/>     -H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \</span><span id="06b4" class="li lj hi lg b fi mv mq l mr ms">https://datamigration.googleapis.com/v1/projects/&lt;<strong class="lg hj">gcp_project_to_listprofiles&gt;</strong>/locations/<strong class="lg hj">&lt;gcp_region_to_listprofiles&gt;</strong>/connectionProfiles</span></pre><p id="f0ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 4。列出项目中的所有迁移作业-位置:</strong></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="8b4f" class="li lj hi lg b fi mp mq l mr ms">curl -X GET \<br/>     -H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \</span><span id="69a9" class="li lj hi lg b fi mv mq l mr ms">https://datamigration.googleapis.com/v1/projects/&lt;<strong class="lg hj">gcp_project_to_listjobs&gt;</strong>/locations/<strong class="lg hj">&lt;gcp_region_to_listjobs&gt;</strong>/migrationJobs</span></pre><p id="2a74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 5。获取特定连接配置文件的详细信息:</strong></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="d51b" class="li lj hi lg b fi mp mq l mr ms">curl -X GET \<br/>     -H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \</span><span id="f8ff" class="li lj hi lg b fi mv mq l mr ms">https://datamigration.googleapis.com/v1/projects/&lt;<strong class="lg hj">gcp_project_of_theprofile&gt;</strong>/locations/<strong class="lg hj">&lt;gcp_region_of_theprofile&gt;</strong>/connectionProfiles/<strong class="lg hj">&lt;name_of_the_connection_profile&gt;</strong></span></pre><p id="de49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 6。获取特定迁移作业的详细信息:</strong></p><pre class="je jf jg jh fd ml lg mm mn aw mo bi"><span id="9995" class="li lj hi lg b fi mp mq l mr ms">curl -X GET \<br/>     -H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \</span><span id="ae84" class="li lj hi lg b fi mv mq l mr ms">https://datamigration.googleapis.com/v1/projects/&lt;<strong class="lg hj">gcp_project_of_thejob&gt;</strong>/locations/<strong class="lg hj">&lt;gcp_region_of_thejob&gt;</strong>/migrationJobs/<strong class="lg hj">&lt;name_of_the_migration_job&gt;</strong></span></pre><h2 id="171c" class="li lj hi bd lk ll lm ln lo lp lq lr ls iq lt lu lv iu lw lx ly iy lz ma mb mc bi translated">参考链接</h2><ol class=""><li id="3b57" class="kn ko hi ih b ii md im me iq mf iu mg iy mh jc ks kt ku kv bi translated"><a class="ae kl" href="https://cloud.google.com/architecture/postgresql-migration-with-database-migration-service" rel="noopener ugc nofollow" target="_blank">使用DMS迁移PostgreSQL】</a></li><li id="7a56" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae kl" href="https://cloud.google.com/database-migration/docs/postgres/quickstart" rel="noopener ugc nofollow" target="_blank">postgres数据库迁移快速入门</a></li><li id="8977" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae kl" href="https://cloud.google.com/database-migration/docs/reference/rest" rel="noopener ugc nofollow" target="_blank">数据库迁移服务REST API</a></li><li id="beb4" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae kl" href="https://cloud.google.com/database-migration/docs/postgres/diagnose-issues" rel="noopener ugc nofollow" target="_blank">调试迁移作业的问题</a></li><li id="8358" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae kl" href="https://cloud.google.com/sql/docs/postgres/configure-ssl-instance#rest-v1_1" rel="noopener ugc nofollow" target="_blank"> SSL/TLS证书设置</a>(不作为本文的一部分)</li><li id="3fd0" class="kn ko hi ih b ii kw im kx iq ky iu kz iy la jc ks kt ku kv bi translated"><a class="ae kl" href="https://cloud.google.com/docs/authentication/" rel="noopener ugc nofollow" target="_blank">为调用REST APIs设置认证</a></li></ol><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es nm"><img src="../Images/413a274c1b1fe5834759d5899a9aace8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/format:webp/1*ilj7Aysr3MY923DreWXIAg.png"/></div></figure><p id="6b97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">快乐学习！</p></div></div>    
</body>
</html>