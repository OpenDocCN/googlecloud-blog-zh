<html>
<head>
<title>Visualising BigQuery Query Plans</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可视化BigQuery查询计划</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/visualising-bigquery-41bf6833b98?source=collection_archive---------0-----------------------#2019-05-16">https://medium.com/google-cloud/visualising-bigquery-41bf6833b98?source=collection_archive---------0-----------------------#2019-05-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="487b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Tldr:在<a class="ae jd" href="https://bqvisualiser.appspot.com" rel="noopener ugc nofollow" target="_blank">https://bqvisualiser.appspot.com</a>上可视化大查询的执行</p><p id="5117" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">BigQuery是一个强大的工具，可以使用标准SQL查询非常大(万亿和千万亿字节规模)的数据集。它通过将查询并行化为多个分片的工作负载来实现这一点，从而实现惊人的规模和速度。</p><p id="c62e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，有时查询比想象的要长。BigQuery UI在理解查询是如何执行的方面提供了一些支持，但是理解发生了什么仍然是一个挑战</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/ae303cdcc491d3d78ee25122b9f461ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:850/format:webp/1*70E54mc31YRQ_ocQk1AiEQ.png"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">这是一个大问题</figcaption></figure><p id="d98a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我有一个客户，他运行一个包含多个子查询和连接的复杂查询。查询需要几个小时才能完成，我们需要了解发生了什么。因此，我最终编写了一个工具，它接受查询计划并将其显示为一棵树，帮助我们跟踪正在发生的事情。BigQuery Visualiser就是这样诞生的。</p><h1 id="ed44" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">BQVisualiser是如何工作的？</h1><p id="3846" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">BqVisualiser显示BigQuery查询的queryplan。queryplan与每个查询一起存储，可以从BigQuery控制台访问。您可以从命令行将queryplans下载到您的PC上。BqVisualiser使您能够通过BigQuery REST API直接检索项目的查询计划。</p><p id="cf01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">访问https://bqvisualiser.appspot.com<a class="ae jd" href="https://bqvisualiser.appspot.com" rel="noopener ugc nofollow" target="_blank">上的Bq可视化器</a></p><h1 id="5940" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">BqVisualiser帮助我们的一些用例</h1><h1 id="cbdd" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">无意中使用了WITH子句</h1><p id="7f32" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax#with-clause" rel="noopener ugc nofollow" target="_blank"> WITH子句是查询语法</a>的强大简化器。但是，需要理解的是，它相当于一个宏，在后续的SELECT中，每次引用WITH子句都会导致该SQL被单独执行。</p><p id="fe08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是导致客户端问题的查询的概念结构:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es kt"><img src="../Images/06fed159ca3323d245a691ec05f37b78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oz93kwu_gmHAOPGC"/></div></div></figure><p id="9b09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">top WITH子句导致13亿条记录被读取和传递。这个WITH子句被另外两个WITH子句引用，这两个子句又被引用。</p><p id="66b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查询分析器立即展开所有的WITH子句，实际的查询看起来更像这样:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ky"><img src="../Images/a6a57319df4917becfb678a472310931.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jxLarwsebuGyTX3p"/></div></div></figure><p id="7866" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如您所见，13亿条记录被读取了6次，这并不好。</p><p id="a526" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将queryplan加载到BigQuery Visualiser显示了所有细节的复杂性:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es kz"><img src="../Images/7efaa8d7e76bc87d1f3bda9755432fd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lHqXLkVpzCUCTpU0"/></div></div></figure><p id="3eb4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以看到查询图似乎重复了几次，它看起来像一个分形，尽管是一个均值…</p><p id="f48d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于这种认识，客户决定在中间表中具体化顶部的查询，这极大地改善了结果。</p><h1 id="7309" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">相同的查询突然需要更长时间</h1><p id="ab35" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">一个客户端每天晚上运行一个查询，只需不到3个小时即可完成。突然，同一个问题花了4个多小时。</p><p id="c27e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">BqVisualiser提供了执行的甘特图。看一下，很明显，与旧的运行相比，新的运行中的大多数join步骤要多运行30–40%。</p><p id="5bb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">特别是一个步骤，包含总共超过16列的连接和组，需要1小时20分钟，而以前需要56分钟。看看慢速游戏的平均等待时间是36分钟对25秒</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es la"><img src="../Images/4558390b713d897282e64098a5f481d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:874/0*vKgsOWLABpTm4TSA"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">快速运行加入/分组方式</figcaption></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lb"><img src="../Images/7780034b5f6aa371a52a33a08884fcdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/0*iLg183FLAggBN-SV"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">慢速运行加入/分组方式</figcaption></figure><p id="f6b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这导致我们在queryplan的execution statistics选项卡中查看总的<em class="lc">槽毫秒</em>对e <em class="lc">失效毫秒</em>:</p><p id="2fea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最佳查询:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ld"><img src="../Images/c2d08b5294a31570269722582899dd3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/0*52TRl-aT9Pr92i79"/></div></figure><p id="dca0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">慢速查询</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es le"><img src="../Images/889533838eb45cc001b4d273ef8cc5e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:740/0*q7nzZ4S4W_xLteT1"/></div></figure><p id="eece" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> totalSlotMs </strong>度量是对资源使用情况的测量。它提供了对多少计算容量使用了多长时间的洞察。</p><p id="fd77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这两个实例中，估计的槽的差异是一个严重的指标，表明存在对可用槽的争用，这也由工作人员过多的等待时间所支持。这位客户订购了2000个插槽的固定费率(<a class="ae jd" href="https://cloud.google.com/bigquery/pricing" rel="noopener ugc nofollow" target="_blank"> <em class="lc">把它想象成一个只为您的组织</em> </a>保留的查询集群)，结果是另一个作业在同一时间(大约午夜)运行。由于BigQuery服务试图为所有作业公平地分配插槽，这导致该查询的可用插槽较少，因此需要更长时间才能完成。</p><p id="9171" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过查看客户的查询时间表修复了此问题，因为此特定查询对其日常报告至关重要。</p><h1 id="ba3f" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">使用BQVisualiser</h1><p id="c4c6" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">使用BqVisualiser最简单的方法是在<a class="ae jd" href="https://bqvisualiser.appspot.com" rel="noopener ugc nofollow" target="_blank">https://bqvisualiser.appspot.com</a>上访问它</p><p id="f5e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要登录Google Cloud。</p><h1 id="8cbc" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">从Google Cloud打开一个查询计划</h1><ol class=""><li id="4eac" class="lf lg hi ih b ii ko im kp iq lh iu li iy lj jc lk ll lm ln bi translated">选择标签为“选择作业”的选项卡</li><li id="4211" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">点击“获取项目”按钮</li><li id="fd49" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">(可选)键入过滤器表达式</li><li id="9c7b" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">在下拉选项卡中选择一个项目</li><li id="e3ba" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">单击列出作业</li></ol><p id="df5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意:如果您不想在这里进行身份验证，您也可以上传一个queryplan。可以使用bq命令下载查询计划:</p><pre class="jf jg jh ji fd lt lu lv lw aw lx bi"><span id="c901" class="ly jr hi lu b fi lz ma l mb mc">bq - format=prettyjson show -j bquxjob_yourjobid &gt; mybqjob.export.json</span></pre><p id="5852" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您将看到下面的查询列表。单击要调查的查询的Get按钮。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es md"><img src="../Images/5c57d598182ff62d8f63018dbfee1d75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_qEgn2m9s00i_OvzJmoXVg.png"/></div></div></figure><p id="6596" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将打开带有查询计划的树选项卡</p><h1 id="1d79" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">树形视图</h1><p id="be9e" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">主视图是树形视图:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es me"><img src="../Images/08c8991a7717e334f2cba5fc33ab7e26.png" data-original-src="https://miro.medium.com/v2/resize:fit:730/0*XVwguZ3f8y2UPDU3"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">树形视图</figcaption></figure><p id="672b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">顶部节点代表一个数据源。所有其他节点都是BigQuery处理阶段。</p><p id="2abe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择单个节点会给出该阶段的详细信息:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es mf"><img src="../Images/2fa1ec5d2ed1c062f311220478827096.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tLLDS40Bw8LEX2UDs0KWbw.png"/></div></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">阶段详细信息显示</figcaption></figure><h1 id="6bc3" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">计时标签</h1><p id="e5b6" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">该选项卡提供了执行时间的甘特图视图。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es mg"><img src="../Images/c7b97fe126b0f8cb059cfdd05864a33e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xHksRFfpDcMk0tHf"/></div></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">阶段执行时间的甘特图</figcaption></figure><p id="9018" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在此示例中，Join+阶段运行了0.7秒</p><h1 id="fd6a" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">底部标签</h1><p id="2ede" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">底部是一组选项卡，显示整体查询的详细信息:</p><ol class=""><li id="ec46" class="lf lg hi ih b ii ij im in iq mh iu mi iy mj jc lk ll lm ln bi translated">概观</li><li id="509a" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">状态</li><li id="4f97" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">使用的SQL</li><li id="8d65" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">进度计时</li><li id="bec7" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">统计数字</li><li id="38d8" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">查询设置</li></ol><h1 id="8146" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">BqVisualiser是开源的</h1><p id="3a2a" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">BQVisualiser是开源的。这是一个Angular SPA，您可以在任何appserver/webserver上托管它。它可以在以下位置找到</p><p id="99c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://github.com/GoogleCloudPlatform/professional-services/tree/master/tools/bq-visualizer" rel="noopener ugc nofollow" target="_blank">https://github . com/Google cloud platform/professional-services/tree/master/tools/bq-visualizer</a></p><p id="6d04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在自己的github回购上留了一个叉:<a class="ae jd" href="https://github.com/smeyn/professional-services/tree/master/tools/bq-visualizer" rel="noopener ugc nofollow" target="_blank">https://github . com/smeyn/professional-services/tree/master/tools/bq-visualizer</a></p><p id="1eb5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(这一个倾向于有错误修正的较新版本)</p><h1 id="7577" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">了解关于BigQuery的更多信息</h1><p id="877a" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">阅读BigQuery的PM写的这篇伟大的文章:<a class="ae jd" rel="noopener" href="/google-cloud/the-12-components-of-google-bigquery-c2b49829a7c7">Google big query的12个组成部分</a></p></div></div>    
</body>
</html>