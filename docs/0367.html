<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://medium.com/google-cloud/apache-airflow-how-to-add-a-connection-to-google-cloud-with-cli-af2cc8df138d?source=collection_archive---------0-----------------------#2017-08-30">https://medium.com/google-cloud/apache-airflow-how-to-add-a-connection-to-google-cloud-with-cli-af2cc8df138d?source=collection_archive---------0-----------------------#2017-08-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="8e73" class="hg hh hi bd hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie bi translated">Apache Airflow:如何使用CLI添加到Google Cloud的连接</h2><p id="db9f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip hs iq ir is hw it iu iv ia iw ix iy iz hb bi translated">为了从airflow operators连接到google云平台，我们需要注册一个连接。虽然我们当然可以通过airflow web UI为GCP添加一个，但是airflow-1.8.2rc1或更低版本的CLI不能与类型不符合URL模式名称规则的RFC的连接一起工作。</p><p id="2c32" class="pw-post-body-paragraph if ig hi ih b ii ja ik il im jb io ip hs jc ir is hw jd iu iv ia je ix iy iz hb bi translated">今天，我想描述一下如何以气流为变通方法添加到google云平台的连接。</p><h1 id="07e7" class="jf hh hi bd hj jg jh ji hn jj jk jl hr jm jn jo hv jp jq jr hz js jt ju id jv bi translated"><strong class="ak">TL；博士</strong></h1><ul class=""><li id="69c0" class="jw jx hi ih b ii ij im in hs jy hw jz ia ka iz kb kc kd ke bi translated">气流-1.8.2rc1以下不允许我们添加类型无效的连接，比如<code class="du kf kg kh ki b">google_cloud_platform.</code></li><li id="f9a4" class="jw jx hi ih b ii kj im kk hs kl hw km ia kn iz kb kc kd ke bi translated">制作一个airflow DAG添加一个到google cloud的连接调用一个python函数在DAG内部添加一个像<a class="ae ko" href="https://gist.github.com/yu-iskw/42f9f0aa6f2ff0a2a375d43881e13b49" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/Yu-iskw/42 f 9 f 0 aa 6 f f2f 0a 2 a 375d 43881 e 13 b 49</a>。</li></ul><h1 id="c41b" class="jf hh hi bd hj jg jh ji hn jj jk jl hr jm jn jo hv jp jq jr hz js jt ju id jv bi translated">动机</h1><p id="3567" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip hs iq ir is hw it iu iv ia iw ix iy iz hb bi translated">如今，用docker和kubernetes这样的容器技术来管理一个系统环境是相当自然的。在这种情况下，在使用airflow CLI构建docker映像时，如何添加连接是最重要的要点之一，如下所示:</p><p id="6003" class="pw-post-body-paragraph if ig hi ih b ii ja ik il im jb io ip hs jc ir is hw jd iu iv ia je ix iy iz hb bi translated">Airflow CLI当然允许我们添加连接，但是airflow-1.8.2rc1或更低版本不支持不遵循URL模式命名规则的RFC的连接类型。这就是为什么我们需要一个变通方法来添加到谷歌云平台的连接。</p><blockquote class="kp kq kr"><p id="bec9" class="if ig ks ih b ii ja ik il im jb io ip kt jc ir is ku jd iu iv kv je ix iy iz hb bi translated">方案名称由一系列字符组成。小写字母<br/>“a”—“z”，数字，以及字符加号(“+”)，句号<br/>(“.”)，以及连字符(“-”)。为了弹性，解释URL的程序<br/>应该将大写字母视为等同于方案名称中的小写字母(例如，允许“http”以及“HTTP”)。</p><p id="5b24" class="if ig ks ih b ii ja ik il im jb io ip kt jc ir is ku jd iu iv kv je ix iy iz hb bi translated">被<a class="ae ko" href="https://www.ietf.org/rfc/rfc1738.txt" rel="noopener ugc nofollow" target="_blank">https://www.ietf.org/rfc/rfc1738.txt</a>引用</p></blockquote><pre class="kw kx ky kz fd la ki lb lc aw ld bi"><span id="f7cf" class="hg hh hi ki b fi le lf l lg lh"># It works<br/>airflow connections -add --conn_id mysql_conn --conn_url mysql://mysql-host:3306</span><span id="ba7a" class="hg hh hi ki b fi li lf l lg lh"># It doesn't work<br/>airflow connections -add --conn_id google_cloud_default --conn_url google_cloud_platform://xxxxx</span></pre><h1 id="c2ac" class="jf hh hi bd hj jg jh ji hn jj jk jl hr jm jn jo hv jp jq jr hz js jt ju id jv bi translated">如何使用内部API添加连接？</h1><p id="5552" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip hs iq ir is hw it iu iv ia iw ix iy iz hb bi translated">在airflow CLI中挖掘添加一个连接，这意味着<code class="du kf kg kh ki b">airflow connections -add</code>，我理解我们可以直接在airflow的元数据DB中添加一个连接。</p><ol class=""><li id="8db1" class="jw jx hi ih b ii ja im jb hs lj hw lk ia ll iz lm kc kd ke bi translated">事先在<code class="du kf kg kh ki b">/var/local/google_cloud_default.json</code>找到一个合适的服务帐户凭证JSON。请根据您的情况随意修改。</li><li id="ba20" class="jw jx hi ih b ii kj im kk hs kl hw km ia kn iz lm kc kd ke bi translated">创建一个python函数来添加到GCP的连接，如下所示，其中连接id是<code class="du kf kg kh ki b">google_cloud_platform</code>。您必须用自己的ID替换GCP项目ID。</li></ol><pre class="kw kx ky kz fd la ki lb lc aw ld bi"><span id="94eb" class="hg hh hi ki b fi le lf l lg lh"><strong class="ki ln">def </strong>add_gcp_connection<strong class="ki ln">(</strong>ds<strong class="ki ln">, **</strong>kwargs<strong class="ki ln">):<br/>    """"Add a airflow connection for GCP"""<br/>    </strong>new_conn <strong class="ki ln">= </strong>Connection<strong class="ki ln">(<br/>        </strong>conn_id<strong class="ki ln">=</strong>get_default_google_cloud_connection_id<strong class="ki ln">(),<br/>        </strong>conn_type<strong class="ki ln">=</strong>'google_cloud_platform'<strong class="ki ln">,<br/>    )<br/>    </strong>scopes <strong class="ki ln">= [<br/>        </strong>"https://www.googleapis.com/auth/pubsub"<strong class="ki ln">,<br/>        </strong>"https://www.googleapis.com/auth/datastore"<strong class="ki ln">,<br/>        </strong>"https://www.googleapis.com/auth/bigquery"<strong class="ki ln">,<br/>        </strong>"https://www.googleapis.com/auth/devstorage.read_write"<strong class="ki ln">,<br/>        </strong>"https://www.googleapis.com/auth/logging.write"<strong class="ki ln">,<br/>        </strong>"https://www.googleapis.com/auth/cloud-platform"<strong class="ki ln">,<br/>    ]<br/>    </strong>conn_extra <strong class="ki ln">= {<br/>        </strong>"extra__google_cloud_platform__scope"<strong class="ki ln">: </strong>","<strong class="ki ln">.</strong>join<strong class="ki ln">(</strong>scopes<strong class="ki ln">),<br/>        </strong>"extra__google_cloud_platform__project"<strong class="ki ln">: "your-gcp-project</strong>"<strong class="ki ln">,<br/>        </strong>"extra__google_cloud_platform__key_path"<strong class="ki ln">: </strong>'/var/local/google_cloud_default.json'<br/>    <strong class="ki ln">}<br/>    </strong>conn_extra_json <strong class="ki ln">= </strong>json<strong class="ki ln">.</strong>dumps<strong class="ki ln">(</strong>conn_extra<strong class="ki ln">)<br/>    </strong>new_conn<strong class="ki ln">.</strong>set_extra<strong class="ki ln">(</strong>conn_extra_json<strong class="ki ln">)<br/><br/>    </strong>session <strong class="ki ln">= </strong>settings<strong class="ki ln">.</strong>Session<strong class="ki ln">()<br/>    if not (</strong>session<strong class="ki ln">.</strong>query<strong class="ki ln">(</strong>Connection<strong class="ki ln">).</strong>filter<strong class="ki ln">(</strong>Connection<strong class="ki ln">.</strong>conn_id <strong class="ki ln">== </strong>new_conn<strong class="ki ln">.</strong>conn_id<strong class="ki ln">).</strong>first<strong class="ki ln">()):<br/>        </strong>session<strong class="ki ln">.</strong>add<strong class="ki ln">(</strong>new_conn<strong class="ki ln">)<br/>        </strong>session<strong class="ki ln">.</strong>commit<strong class="ki ln">()<br/>    else:<br/>        </strong>msg <strong class="ki ln">= </strong>'\n\tA connection with `conn_id`={conn_id} already exists\n'<br/>        msg <strong class="ki ln">= </strong>msg<strong class="ki ln">.</strong>format<strong class="ki ln">(</strong>conn_id<strong class="ki ln">=</strong>new_conn<strong class="ki ln">.</strong>conn_id<strong class="ki ln">)<br/>        print(</strong>msg<strong class="ki ln">)</strong></span></pre><h1 id="5cf4" class="jf hh hi bd hj jg jh ji hn jj jk jl hr jm jn jo hv jp jq jr hz js jt ju id jv bi translated">如何制作气流DAG</h1><p id="f887" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip hs iq ir is hw it iu iv ia iw ix iy iz hb bi translated">我们创建了一个python函数来添加到谷歌云平台的连接，然后我们将制作一个气流DAG。我们需要通过DAG调用该函数的原因是，设置连接气流元数据数据库的配置有点复杂。我认为从DAG调用它是使用该配置最简单的方法。</p><p id="594e" class="pw-post-body-paragraph if ig hi ih b ii ja ik il im jb io ip hs jc ir is hw jd iu iv ia je ix iy iz hb bi translated">在DAG中，我们要做的就是用<code class="du kf kg kh ki b">PythonOperator</code>做一个任务来调用函数添加一个连接。由于DAG不应该是一个调度作业，我们应该将<code class="du kf kg kh ki b">schedule_interval</code>设置为<code class="du kf kg kh ki b">@once</code>或<code class="du kf kg kh ki b">None</code>。</p><pre class="kw kx ky kz fd la ki lb lc aw ld bi"><span id="654b" class="hg hh hi ki b fi le lf l lg lh">dag <strong class="ki ln">= </strong>DAG<strong class="ki ln">(<br/>    </strong>'add_gcp_connection'<strong class="ki ln">,<br/>    </strong>default_args<strong class="ki ln">=</strong>default_args<strong class="ki ln">,<br/>    </strong>schedule_interval<strong class="ki ln">=</strong>"@once"<strong class="ki ln">)<br/><br/></strong># Task to add a connection<br/>t1 <strong class="ki ln">= </strong>PythonOperator<strong class="ki ln">(<br/>    </strong>dag<strong class="ki ln">=</strong>dag<strong class="ki ln">,<br/>    </strong>task_id<strong class="ki ln">=</strong>'add_gcp_connection_python'<strong class="ki ln">,<br/>    </strong>python_callable<strong class="ki ln">=</strong>add_gcp_connection<strong class="ki ln">,<br/>    </strong>provide_context<strong class="ki ln">=</strong>True<strong class="ki ln">,<br/>)</strong></span></pre><h1 id="ea7f" class="jf hh hi bd hj jg jh ji hn jj jk jl hr jm jn jo hv jp jq jr hz js jt ju id jv bi translated">供应气流时如何添加连接</h1><p id="1810" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip hs iq ir is hw it iu iv ia iw ix iy iz hb bi translated">如您所知，airflow允许我们使用airflow CLI运行特定任务。嵌入以下命令，例如在您的<code class="du kf kg kh ki b">Dockerfile</code>中，您可以添加一个其类型不允许与airflow CLI相关的连接。</p><pre class="kw kx ky kz fd la ki lb lc aw ld bi"><span id="1645" class="hg hh hi ki b fi le lf l lg lh">airflow run add_gcp_connection add_gcp_connection_python 2001-01-01</span></pre><h1 id="c4bd" class="jf hh hi bd hj jg jh ji hn jj jk jl hr jm jn jo hv jp jq jr hz js jt ju id jv bi translated">未来作品</h1><p id="d7d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip hs iq ir is hw it iu iv ia iw ix iy iz hb bi translated">我们气流社区正在解决这个问题:<a class="ae ko" href="https://issues.apache.org/jira/browse/AIRFLOW-1330" rel="noopener ugc nofollow" target="_blank">https://issues.apache.org/jira/browse/AIRFLOW-1330</a>。我相信我们会将该功能发布为气流-1.9。希望大家期待！</p></div></div>    
</body>
</html>