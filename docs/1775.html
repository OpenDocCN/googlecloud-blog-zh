<html>
<head>
<title>Using Terraform to trigger Dataflow? Here is how to pass any Dataflow runner option to your job using Flex Templates</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Terraform触发数据流？以下是如何使用Flex模板将任何数据流运行器选项传递到您的工作中</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-terraform-to-trigger-dataflow-2698a4814196?source=collection_archive---------3-----------------------#2021-01-25">https://medium.com/google-cloud/using-terraform-to-trigger-dataflow-2698a4814196?source=collection_archive---------3-----------------------#2021-01-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/7940d1463dc603293af79644c1ea61a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eILmHOdFECTfAjWB"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@spacex?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> SpaceX </a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="bb50" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在许多可以用来触发数据流作业的不同方法中，Terraform比较受欢迎。Terraform使用<a class="ae iu" href="https://cloud.google.com/dataflow/docs/reference/rest" rel="noopener ugc nofollow" target="_blank">数据流API </a>来触发数据流作业。这意味着您只能启动模板。但是由于有了<a class="ae iu" href="https://cloud.google.com/dataflow/docs/guides/templates/using-flex-templates" rel="noopener ugc nofollow" target="_blank"> Dataflow Flex模板</a>，这实际上并没有对你可以启动的工作种类施加限制。如果你的代码不是一个模板，就用一个启动容器包装它，使用Flex模板。</p><p id="317b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，并非所有的情况都是乐观的。如果您将部署数据流管道的<a class="ae iu" href="https://cloud.google.com/dataflow/docs/guides/specifying-exec-params" rel="noopener ugc nofollow" target="_blank">选项</a>与Terraform资源提供的选项进行比较(常规模板的<a class="ae iu" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/dataflow_job" rel="noopener ugc nofollow" target="_blank">选项</a>，flex模板的<a class="ae iu" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/dataflow_flex_template_job" rel="noopener ugc nofollow" target="_blank">选项</a>，您会注意到数据流运行器可以接受的选项与您使用Terraform传递的选项之间存在差距。</p><p id="b322" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们如何弥合这一差距？</p><p id="bdb1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有几种方法可以将选项传递给数据流管道。命令行不是唯一的方法。您可以始终以编程方式设置流道选项。为此，您可以使用类<code class="du jt ju jv jw b"><a class="ae iu" href="https://beam.apache.org/releases/javadoc/2.27.0/org/apache/beam/runners/dataflow/options/DataflowPipelineOptions.html" rel="noopener ugc nofollow" target="_blank">DataflowPipelineOptions</a></code>(在Java中)或<code class="du jt ju jv jw b"><a class="ae iu" href="https://beam.apache.org/releases/pydoc/2.27.0/_modules/apache_beam/options/pipeline_options.html#GoogleCloudOptions" rel="noopener ugc nofollow" target="_blank">GooogleCloudOptions</a></code>(在Python中)。</p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><p id="c3a0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如何使用这些类来设置数据流选项？问题是，这些数据流选项中有许多没有使用Terraform资源公开。但是您可以使用<code class="du jt ju jv jw b">DataflowPipelineOptions</code>或<code class="du jt ju jv jw b">GoogleCloudOptions</code>从代码中设置它们。</p><p id="cbec" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Python中，我们可以使用<code class="du jt ju jv jw b">view_as</code>对<code class="du jt ju jv jw b">GoogleCloudOptions</code>进行“造型”:</p><figure class="ke kf kg kh fd ij"><div class="bz dy l di"><div class="ki kj l"/></div></figure><p id="3f30" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Java中，我们需要做更多的改变。</p><p id="ae49" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，如果你正在使用由<a class="ae iu" href="https://beam.apache.org/get-started/quickstart-java/" rel="noopener ugc nofollow" target="_blank"> Apache Beam Quickstart </a>提供的默认<code class="du jt ju jv jw b">pom.xml</code>文件，你将需要确保数据流依赖在编译时可用。确保将其包含在您的<code class="du jt ju jv jw b">&lt;dependencies&gt;</code>部分:</p><pre class="ke kf kg kh fd kk jw kl km aw kn bi"><span id="03b4" class="ko kp hi jw b fi kq kr l ks kt">&lt;dependency&gt;<br/>  &lt;groupId&gt;org.apache.beam&lt;/groupId&gt;<br/>  &lt;artifactId&gt;beam-runners-google-cloud-dataflow-java&lt;/artifactId&gt;<br/>  &lt;version&gt;${beam.version}&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="90bc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦你有了这种依赖，你应该能够在你的管道中使用<code class="du jt ju jv jw b">DataflowPipelineOptions</code>。您可以将常规的<code class="du jt ju jv jw b">PipelineOptions</code>转换为<code class="du jt ju jv jw b">DataflowPipelineOptions</code>，并设置数据流参数:</p><figure class="ke kf kg kh fd ij"><div class="bz dy l di"><div class="ki kj l"/></div></figure><p id="f938" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">通过这些示例，您可以设置此表中包含的任何数据流运行程序选项:<a class="ae iu" href="https://cloud.google.com/dataflow/docs/guides/specifying-exec-params#setting-other-cloud-dataflow-pipeline-options" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/data flow/docs/guides/specifying-exec-params # setting-other-cloud-data flow-pipeline-options</a></p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><p id="cc23" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">是的，很好，但是所有的代码片段都有硬编码的数据流选项，您想知道如何在运行时设置这些选项。</p><p id="2cc8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你写的是常规模板，<strong class="ix hj">就不能</strong>。</p><p id="0dcc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用常规模板，您的管道选项将是<code class="du jt ju jv jw b">ValueProviders</code>，您将需要在创建管道之前尝试“获取”它们(调用<em class="ku"> get </em>方法)。那会给你一个错误，<em class="ku"> get </em>只在你的管道已经在运行的时候才起作用。</p><p id="44a3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是不用担心，你可以用<strong class="ix hj">数据流灵活模板</strong>解决这个问题。</p><p id="5345" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Flex模板中，你可以有“普通的”运行时选项(不是<code class="du jt ju jv jw b">ValueProvider</code>)，你可以像“普通的”工作一样编写代码，而不必处理任何与模板相关的事情。一旦你写了代码，你需要用一个<em class="ku">启动器容器</em>包装它。</p><p id="dfcb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">数据流文档中有一个如何将你的代码转换成Flex模板的例子，以及Google提供的关于容器的所有细节:<a class="ae iu" href="https://cloud.google.com/dataflow/docs/guides/templates/using-flex-templates" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/data flow/docs/guides/templates/using-Flex-templates</a></p><p id="04e5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用Flex模板，您可以公开一个定制选项，比如<code class="du jt ju jv jw b">--i-want-streaming-engine</code>，获取它的值，然后将其传递给Dataflow options对象。</p><p id="6378" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，在Terraform中，您将在您的<code class="du jt ju jv jw b">parameters</code>部分中指定该选项:</p><figure class="ke kf kg kh fd ij"><div class="bz dy l di"><div class="ki kj l"/></div></figure></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><p id="d4bf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以更新您的选项来读取您的自定义选项，然后将它们的值传递给相应的数据流选项。</p><p id="cea3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，在Python中，我们可以做如下事情:</p><figure class="ke kf kg kh fd ij"><div class="bz dy l di"><div class="ki kj l"/></div></figure><p id="6a33" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Java中的对等词是:</p><figure class="ke kf kg kh fd ij"><div class="bz dy l di"><div class="ki kj l"/></div></figure></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><p id="8269" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">数据流变化很快，新的功能和选项以一定的频率出现。并非所有这些选项都可以立即从Terraform资源和模块中获得，以便与您的数据流模板一起使用。但是，您总是可以从代码中以编程方式设置这些选项。</p><p id="2c5b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您使用常规数据流模板，这些运行器选项必须硬编码在您的源代码中。这是因为管道选项只能通过<em class="ku">值提供者</em>获得，在运行时无法恢复，只有在管道已经启动之后。</p><p id="85a5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是如果你使用Dataflow Flex模板，这不是问题。只需在管道中添加一个普通的定制选项，并编写一些代码将这些值传递给数据流选项对象。然后只需在您的<code class="du jt ju jv jw b">google_dataflow_flex_template_job</code>的<code class="du jt ju jv jw b">parameters</code>部分设置您的自定义选项，您将能够使用任何数据流选项，无论它们是否可通过Terraform获得。</p></div></div>    
</body>
</html>