<html>
<head>
<title>Kubernetes: Cluster Autoscaler</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:集群自动缩放</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/kubernetes-cluster-autoscaler-f1948a0f686d?source=collection_archive---------1-----------------------#2018-06-05">https://medium.com/google-cloud/kubernetes-cluster-autoscaler-f1948a0f686d?source=collection_archive---------1-----------------------#2018-06-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="faa3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">自动缩放是Kubernetes的一个巨大的(并且已经上市的)特性。当你的网站/应用程序/API/项目变得很大，大量的请求开始涌入，你不必袖手旁观你的电脑和管理你的服务器，相反，Kubernetes只是为你管理这些。您可以通过多种方式控制这种自动缩放，并围绕它找到最佳实践。这就是本文的目的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/5cbe09480d3d73e8668e58581b7a905a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*P8Frvw4Nvhrv_LwPnru5-w.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">节点来了</figcaption></figure><p id="398a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jp">如果你还没有通读甚至阅读过本系列</em>  <em class="jp">的第一部分</em> <a class="ae jq" rel="noopener" href="/@jonbcampos/kubernetes-day-one-30a80b5dcb29"> <em class="jp">，你可能会感到困惑，不知道代码在哪里，或者之前做了什么。记住这里假设你正在使用</em> </a><a class="ae jq" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> <em class="jp"> GCP </em> </a> <em class="jp">和</em><a class="ae jq" href="https://cloud.google.com/kubernetes-engine/" rel="noopener ugc nofollow" target="_blank"><em class="jp">GKE</em></a><em class="jp">。我将始终提供代码和如何测试代码是按预期工作。</em></p><div class="jr js ez fb jt ju"><a rel="noopener follow" target="_blank" href="/@jonbcampos/kubernetes-day-one-30a80b5dcb29"><div class="jv ab dw"><div class="jw ab jx cl cj jy"><h2 class="bd hj fi z dy jz ea eb ka ed ef hh bi translated">库伯内特:第一天</h2><div class="kb l"><h3 class="bd b fi z dy jz ea eb ka ed ef dx translated">这是Kubernetes帖子的必选步骤之一。如果你对Kubernetes感兴趣，你可能已经读过100本了…</h3></div><div class="kc l"><p class="bd b fp z dy jz ea eb ka ed ef dx translated">medium.com</p></div></div><div class="kd l"><div class="ke l kf kg kh kd ki jj ju"/></div></div></a></div><h1 id="c52c" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">什么是集群自动缩放？</h1><p id="5e92" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">Cluster Autoscaler是一个内置于Kubernetes的系统，它可以监视集群的大小，并根据集群的需求调整正在运行的节点数量。它通过观察集群的使用情况来做到这一点，当需要新的pod或由于缺乏资源而失败时，Cluster Autoscaler会向池中添加更多节点。如果您有太多的资源，那么集群自动伸缩甚至可以删除节点，为您节省一些钱。根据您的需求，您甚至可以将集群的规模降至零，尽管至少会有1个虚拟机始终运行来管理集群。</p><h1 id="3f54" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">让我们扩大规模</h1><p id="798e" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">出于本文的目的，我将展示用Kubernetes创建集群自动缩放器的两种方法。我们将了解的第一种方法是何时创建集群。第二种方式是当您已经创建了一个集群，并且需要在事后添加扩展时。</p><h2 id="0c82" class="lm kk hi bd kl ln lo lp kp lq lr ls kt iq lt lu kx iu lv lw lb iy lx ly lf lz bi translated">在集群创建期间</h2><p id="4c4a" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">设置自动伸缩的第一种方法，也是更简单的方法，是在创建Kubernetes集群时正确地进行。正如你在下面的代码中看到的，为你的集群设置<strong class="ih hj"> enable-autoscaling </strong>标签和一个max/min就很简单。</p><pre class="je jf jg jh fd ma mb mc md aw me bi"><span id="3ab3" class="lm kk hi mb b fi mf mg l mh mi">echo "creating container engine cluster"<br/>gcloud container clusters create ${CLUSTER_NAME} \<br/>    --preemptible \<br/>    --zone ${INSTANCE_ZONE} \<br/>    --scopes cloud-platform \<br/>    <strong class="mb hj">--enable-autoscaling --min-nodes 0 --max-nodes 10</strong> \<br/>    --num-nodes 3</span></pre><p id="b5be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过陈述您的<strong class="ih hj">最小节点</strong>和<strong class="ih hj">最大节点</strong>，您为集群的节点扩展提供了一些界限。对于较小的团队来说，<strong class="ih hj">最大节点数</strong>非常重要，因为如果你不小心的话，它会增加成本。</p><h2 id="2cb0" class="lm kk hi bd kl ln lo lp kp lq lr ls kt iq lt lu kx iu lv lw lb iy lx ly lf lz bi translated">集群创建后</h2><p id="6eb5" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">好吧，我们承认吧。你搞砸了。您有一个正在运行的集群，但您忘记添加<strong class="ih hj"> enable-autoscaling </strong>标记。你不想删除一切，重新开始，但你想要的是自动缩放的好处。不过不要担心。您不需要清除所有内容并重新开始，您只需要为您的Kubernetes集群创建一个节点池，并给它一些界限。</p><pre class="je jf jg jh fd ma mb mc md aw me bi"><span id="8afb" class="lm kk hi mb b fi mf mg l mh mi">echo "adding autoscaling node pool"<br/><strong class="mb hj">gcloud container node-pools create ${CLUSTER_NAME}-pool \<br/>    --cluster ${CLUSTER_NAME} \<br/>    --enable-autoscaling --min-nodes 0 --max-nodes 10 \<br/>    --zone ${INSTANCE_ZONE}</strong></span></pre><p id="8c9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不太痛苦。但我们在这里谈论的是节点，而不是豆荚。我们能爬上我们的豆荚吗？缩放窗格和缩放节点有区别吗？</p><h1 id="d430" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">水平机架扩展与集群自动扩展</h1><p id="d358" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">如果你看过Kubernetes的其他帖子，你可能已经看到了节点被扩展和pod被扩展的奇怪混合——需要注意的是，这些是不同的系统。一些作者甚至错误地展示了集群自动缩放，同时谈论了他们的pod如何缩放。请务必理解这种差异，因为它会影响与运行集群相关的成本。</p><blockquote class="mj mk ml"><p id="74e6" class="if ig jp ih b ii ij ik il im in io ip mm ir is it mn iv iw ix mo iz ja jb jc hb bi translated">集群自动缩放扩展Pods运行的节点。</p><p id="208e" class="if ig jp ih b ii ij ik il im in io ip mm ir is it mn iv iw ix mo iz ja jb jc hb bi translated"><a class="ae jq" rel="noopener" href="/@jonbcampos/kubernetes-horizontal-pod-scaling-190e95c258f5">水平机架扩展</a>根据资源指标扩展机架。</p></blockquote><h1 id="51ba" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">演示时间</h1><p id="3d3c" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">为了了解这在一个全新的集群上是如何进行的，让我们从实际运行代码开始。正如我在本系列中的早期文章一样，在下面的链接中，您可以根据自己的需要查看和定制许多优秀的bash脚本。</p><h2 id="1fdb" class="lm kk hi bd kl ln lo lp kp lq lr ls kt iq lt lu kx iu lv lw lb iy lx ly lf lz bi translated">使用自动缩放创建集群</h2><p id="e475" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">首先，我们可以创建一个新的Kubernetes集群，默认情况下集群自动伸缩已经打开。</p><pre class="je jf jg jh fd ma mb mc md aw me bi"><span id="5ded" class="lm kk hi mb b fi mf mg l mh mi">$ git clone <a class="ae jq" href="https://github.com/jonbcampos/kubernetes-series.git" rel="noopener ugc nofollow" target="_blank">https://github.com/jonbcampos/kubernetes-series.git</a><br/>$ cd ~/<a class="ae jq" href="https://github.com/jonbcampos/kubernetes-series/tree/master/autoscaling/scripts" rel="noopener ugc nofollow" target="_blank">kubernetes-series/autoscaling/scripts</a><br/>$ sh <a class="ae jq" href="https://github.com/jonbcampos/kubernetes-series/blob/master/autoscaling/scripts/startup.sh" rel="noopener ugc nofollow" target="_blank">startup.sh</a> # with autoscaling</span></pre><h2 id="5e39" class="lm kk hi bd kl ln lo lp kp lq lr ls kt iq lt lu kx iu lv lw lb iy lx ly lf lz bi translated">事后添加自动缩放</h2><p id="8391" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">或者我们可以创建一个没有集群自动缩放的Kubernetes集群，然后添加/编辑集群自动缩放器。</p><pre class="je jf jg jh fd ma mb mc md aw me bi"><span id="25b9" class="lm kk hi mb b fi mf mg l mh mi">$ git clone <a class="ae jq" href="https://github.com/jonbcampos/kubernetes-series.git" rel="noopener ugc nofollow" target="_blank">https://github.com/jonbcampos/kubernetes-series.git</a><br/>$ cd ~/<a class="ae jq" href="https://github.com/jonbcampos/kubernetes-series/tree/master/autoscaling/scripts" rel="noopener ugc nofollow" target="_blank">kubernetes-series/autoscaling/scripts</a><br/>$ # sh <a class="ae jq" href="https://github.com/jonbcampos/kubernetes-series/blob/master/autoscaling/scripts/startup_wo_autoscaling.sh" rel="noopener ugc nofollow" target="_blank">startup_wo_autoscaling.sh</a> # without autoscaling<br/>$ # sh <a class="ae jq" href="https://github.com/jonbcampos/kubernetes-series/blob/master/autoscaling/scripts/add_autoscaling.sh" rel="noopener ugc nofollow" target="_blank">add_autoscaling.sh</a> # add autoscaling <strong class="mb hj">after</strong> creation</span></pre><h2 id="055a" class="lm kk hi bd kl ln lo lp kp lq lr ls kt iq lt lu kx iu lv lw lb iy lx ly lf lz bi translated">打扫</h2><p id="fb7b" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">当你运行完这些文件后，我建议你一定要运行拆卸脚本，这样你就不会给你的GCP账户增加额外的费用。</p><pre class="je jf jg jh fd ma mb mc md aw me bi"><span id="80fc" class="lm kk hi mb b fi mf mg l mh mi">$ cd ~/kubernetes-series/autoscaling/scripts # if necessary<br/>$ sh <a class="ae jq" href="https://github.com/jonbcampos/kubernetes-series/blob/master/autoscaling/scripts/teardown.sh" rel="noopener ugc nofollow" target="_blank">teardown.sh</a></span></pre><h1 id="9c63" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">集群扩展最佳实践</h1><p id="0701" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">云计算和Kubernetes经常遇到的一个问题是，如何确定虚拟机实例的最佳大小，因为你也有这个自动伸缩系统来帮助处理负载。嗯，我去了谷歌的来源，听听他们是怎么做的，答案就像你希望的那样简单。</p><blockquote class="mj mk ml"><p id="6d0b" class="if ig jp ih b ii ij ik il im in io ip mm ir is it mn iv iw ix mo iz ja jb jc hb bi translated">让虚拟机尽可能小，以便运行您的应用程序。水平扩展比垂直扩展更便宜/高效。</p></blockquote><p id="eead" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这意味着您完全可以停止强调虚拟机的大小，而是专注于使您的应用程序具有可伸缩性。如果您可以轻松地上下旋转应用程序的实例，那么您就可以充分利用Kubernetes。</p><h1 id="8822" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">关闭</h1><p id="4ec9" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">这篇文章与围绕<a class="ae jq" rel="noopener" href="/@jonbcampos/kubernetes-horizontal-pod-scaling-190e95c258f5">水平Pod定标器</a>的另一篇文章齐头并进。如果这激发了你对扩展的兴趣，我会推荐你朝那个方向前进。</p><p id="4a6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi mp translated"><span class="l mq mr ms bm mt mu mv mw mx di"> H </span>你是否发现Kubernetes很难扩展？<br/>你是如何解决Kubernetes秤的问题的？</p></div><div class="ab cl my mz gp na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="hb hc hd he hf"><h1 id="7546" class="kj kk hi bd kl km nf ko kp kq ng ks kt ku nh kw kx ky ni la lb lc nj le lf lg bi translated">本系列的其他文章</h1><div class="jr js ez fb jt ju"><a rel="noopener follow" target="_blank" href="/@jonbcampos/kubernetes-day-one-30a80b5dcb29"><div class="jv ab dw"><div class="jw ab jx cl cj jy"><h2 class="bd hj fi z dy jz ea eb ka ed ef hh bi translated">库伯内特:第一天</h2><div class="kb l"><h3 class="bd b fi z dy jz ea eb ka ed ef dx translated">这是Kubernetes帖子的必选步骤之一。如果你对Kubernetes感兴趣，你可能已经读过100本了…</h3></div><div class="kc l"><p class="bd b fp z dy jz ea eb ka ed ef dx translated">medium.com</p></div></div><div class="kd l"><div class="ke l kf kg kh kd ki jj ju"/></div></div></a></div><div class="jr js ez fb jt ju"><a rel="noopener follow" target="_blank" href="/@jonbcampos/kubernetes-horizontal-pod-scaling-190e95c258f5"><div class="jv ab dw"><div class="jw ab jx cl cj jy"><h2 class="bd hj fi z dy jz ea eb ka ed ef hh bi translated">Kubernetes:水平Pod缩放</h2><div class="kb l"><h3 class="bd b fi z dy jz ea eb ka ed ef dx translated">通过Pod自动扩展，您的Kubernetes集群可以监控现有Pod的负载，并确定我们是否需要更多…</h3></div><div class="kc l"><p class="bd b fp z dy jz ea eb ka ed ef dx translated">medium.com</p></div></div><div class="kd l"><div class="nk l kf kg kh kd ki jj ju"/></div></div></a></div><div class="jr js ez fb jt ju"><a rel="noopener follow" target="_blank" href="/@jonbcampos/kubernetes-readiness-probe-83f8a06d33d3"><div class="jv ab dw"><div class="jw ab jx cl cj jy"><h2 class="bd hj fi z dy jz ea eb ka ed ef hh bi translated">Kubernetes:就绪探测</h2><div class="kb l"><h3 class="bd b fi z dy jz ea eb ka ed ef dx translated">如果对这个特性有任何疑问，我写这篇文章是为了说明这不是一个…</h3></div><div class="kc l"><p class="bd b fp z dy jz ea eb ka ed ef dx translated">medium.com</p></div></div><div class="kd l"><div class="nl l kf kg kh kd ki jj ju"/></div></div></a></div></div><div class="ab cl my mz gp na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="hb hc hd he hf"><p id="ec05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jq" href="http://jonbcampos.com/" rel="noopener ugc nofollow" target="_blank">乔纳森·坎波斯</a>是一个狂热的开发者，也是学习新事物的爱好者。我相信我们应该不断学习、成长和失败。我总是开发社区的支持者，并且总是愿意提供帮助。因此，如果你对这个故事有任何问题或意见，请在下面提出。在<a class="ae jq" href="https://www.linkedin.com/in/jonbcampos/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>或<a class="ae jq" href="https://twitter.com/jonbcampos" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上与我联系，并提及这个故事。</p></div></div>    
</body>
</html>