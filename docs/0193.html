<html>
<head>
<title>Code Cooking: Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">代码烹饪:Kubernetes</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/code-cooking-kubernetes-e715728a578c?source=collection_archive---------0-----------------------#2017-01-25">https://medium.com/google-cloud/code-cooking-kubernetes-e715728a578c?source=collection_archive---------0-----------------------#2017-01-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b6b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">欢迎来到克里斯蒂昂大厨的代码烹饪！</p><p id="faf1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">今天我们要准备一个美味的网络汉堡。它将以HTML为基础，由Kubernetes在nginx上提供服务。汉堡通常与快餐联系在一起，所以我们要确保它可以立即食用。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/843a86c8fb84bd2114331eeabf2feef9.png" data-original-src="https://miro.medium.com/v2/resize:fit:672/format:webp/1*2ovISdJzulKtXeMGUiZMNA.jpeg"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">博克！博克！博克！</figcaption></figure><p id="c1ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从收集我们的原料和工具开始。我们需要在本地厨房安装这些工具:</p><ul class=""><li id="3008" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated"><a class="ae jy" href="https://www.docker.com/products/overview" rel="noopener ugc nofollow" target="_blank">码头工人</a></li><li id="5429" class="jp jq hi ih b ii jz im ka iq kb iu kc iy kd jc ju jv jw jx bi translated"><a class="ae jy" href="https://cloud.google.com/sdk/docs/quickstarts" rel="noopener ugc nofollow" target="_blank"> gcloud </a></li><li id="b5c6" class="jp jq hi ih b ii jz im ka iq kb iu kc iy kd jc ju jv jw jx bi translated"><a class="ae jy" href="https://cloud.google.com/container-engine/docs/quickstart#install_the_gcloud_command-line_interface" rel="noopener ugc nofollow" target="_blank">库贝克特尔</a></li><li id="b804" class="jp jq hi ih b ii jz im ka iq kb iu kc iy kd jc ju jv jw jx bi translated"><a class="ae jy" href="https://httpd.apache.org/docs/2.4/programs/ab.html" rel="noopener ugc nofollow" target="_blank"> ab </a></li><li id="acce" class="jp jq hi ih b ii jz im ka iq kb iu kc iy kd jc ju jv jw jx bi translated"><a class="ae jy" href="https://stedolan.github.io/jq/download/" rel="noopener ugc nofollow" target="_blank"> jq </a></li></ul><p id="feb5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我假设您对这些工具至少有一点经验。如果没有:阅读一些文档，熟悉一些基础知识，或者如果你想冒险的话，就开始吧！</p><p id="2487" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我最喜欢的服务代码的方式是谷歌云平台。为了做准备，我在console.cloud.google.com上创建了一个名为代码烹饪的项目。今天我想用Kubernetes。Kubernetes将为我们管理码头集装箱。让我们开始构建一个不错的集群:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="8ebe" class="kj kk hi kf b fi kl km l kn ko">gcloud container clusters create code-cooking</span></pre><p id="37ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这给了我们3个来自谷歌的服务器，我们可以在上面运行我们的汉堡应用程序。</p><p id="063d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当这些全新的服务器预热时，我们准备代码。为此，我们创建了<code class="du kp kq kr kf b">static/index.html</code>并按了几个键，使它看起来像这样:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="d076" class="kj kk hi kf b fi kl km l kn ko">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>  &lt;h1&gt;Best burger in town!&lt;/h1&gt;<br/>&lt;/html&gt;</span></pre><p id="6d34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那看起来不是已经很美味了吗？不，不是的！你不能像那样提供生食。让我们把它放在nginx中。取一个新文件，命名为<code class="du kp kq kr kf b">nginx.conf</code>，然后输入:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="6209" class="kj kk hi kf b fi kl km l kn ko">server {<br/>    listen 80;<br/>    server_name localhost;</span><span id="d0c1" class="kj kk hi kf b fi ks km l kn ko">    location / {<br/>        root /usr/share/nginx/html;<br/>        index index.html;</span><span id="2bec" class="kj kk hi kf b fi ks km l kn ko">        expires 1h;<br/>        add_header Cache-Control "public";<br/>    }<br/>}</span></pre><p id="7d77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们处于超级打字模式时，让我们也创建一个<code class="du kp kq kr kf b">Dockerfile</code>:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="5d39" class="kj kk hi kf b fi kl km l kn ko">FROM nginx<br/>COPY nginx.conf /etc/nginx/conf.d/default.conf<br/>COPY static /usr/share/nginx/html</span></pre><p id="8de4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">哇，我们已经有一个集群和三个文件:<code class="du kp kq kr kf b">Dockerfile</code>、<code class="du kp kq kr kf b">nginx.conf</code>和<code class="du kp kq kr kf b">static/index.html</code>。进展得太快了。</p></div><div class="ab cl kt ku gp kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hb hc hd he hf"><p id="3080" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">进入下一部分。是时候让Docker做它的事情了:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="1137" class="kj kk hi kf b fi kl km l kn ko">docker build -t eu.gcr.io/code-cooking/burger:0.1 .</span></pre><p id="2277" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这使得Docker为我们建立了一个容器，里面有我们的汉堡应用程序。我们用名称和版本标记容器，这样我们以后就能找到它。</p><p id="d633" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让它煮3秒钟，然后把它放入Google容器注册表:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="4c0f" class="kj kk hi kf b fi kl km l kn ko">gcloud docker -- push eu.gcr.io/code-cooking/burger:0.1</span></pre><p id="9a9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好吃，你闻到了吗？我相信你的客人已经迫不及待想看看你的最新作品了。我们可以使用我们的奇特工具kubectl来设置我们的服务器:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="5601" class="kj kk hi kf b fi kl km l kn ko">kubectl run burger --image=eu.gcr.io/code-cooking/burger:0.1 --port=80 --replicas=3</span><span id="40a5" class="kj kk hi kf b fi ks km l kn ko">kubectl expose deployment burger --port=80 --type=LoadBalancer</span></pre><p id="0b39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将创建我们的burger应用程序的3个副本，在我们的集群上运行它们，并通过端口80上的负载平衡器向外界展示它们。</p><p id="f7e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启动你的汉堡应用程序会非常快，但是第一次创建一个负载平衡器可能需要一分钟左右。请继续关注我们的汉堡服务，看看那个懒惰的负载平衡器何时最终获得外部IP:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="be61" class="kj kk hi kf b fi kl km l kn ko">kubectl get service burger --watch</span></pre><p id="0e70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦开始，你就可以上菜了！记住总是先品尝你的作品:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="2482" class="kj kk hi kf b fi kl km l kn ko">ab -n 1000 -c 10 http://&lt;the external ip of the burger service&gt;/</span></pre><p id="8160" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，我在大约40毫秒内得到我的汉堡。</p></div><div class="ab cl kt ku gp kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hb hc hd he hf"><p id="17a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是等等，我们可以做得更好。我喜欢旅行，当我旅行时，有时我想吃汉堡。我刚刚制作的这个汉堡服务器碰巧在欧洲，因为我在那里创建了集群。但是当我在美国的时候，我不想一路回到欧洲去买汉堡。如果我们也能在那边吃到这些美味的汉堡呢？让我告诉你:我们可以做到这一点！</p><p id="e0ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们来看看世界另一端的人们为了得到我的汉堡都经历了什么。在俄勒冈州和日本制造一些机器:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="34c7" class="kj kk hi kf b fi kl km l kn ko">gcloud compute instances create oregon-test --zone us-west1-a<br/>gcloud compute instances create japan-test --zone asia-northeast1-a</span></pre><p id="cc00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">宋承宪合二为一:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="2aef" class="kj kk hi kf b fi kl km l kn ko">gcloud compute ssh japan-test --zone asia-northeast1-a</span></pre><p id="28bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和<code class="du kp kq kr kf b">sudo apt-get install apache2-utils -y</code>来安装<code class="du kp kq kr kf b">ab</code>。</p><p id="43d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们再次运行我们的<code class="du kp kq kr kf b">ab</code>测试，看看味道如何:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="5a0a" class="kj kk hi kf b fi kl km l kn ko">ab -n 1000 -c 10 http://&lt;the external ip of the burger service&gt;/</span></pre><p id="a4c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">天哪，这太可怕了:俄勒冈州需要279毫秒，而日本需要4.59毫秒。这只是一个汉堡！想象一下，对于那些穷人来说，得到一个HTML汉堡、一份CSS开胃菜、一份图片沙拉和一大块JS甜点是什么感觉？恐怖啊！</p><p id="90c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为一个好厨师，我知道我不能让我的客人等那么久。有几个选项可以解决这个问题，因为我们讨论的是静态内容，最简单的方法是添加一个CDN。开始了。</p><p id="f58d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们首先删除我们的普通负载平衡器，并用不同的服务替换它:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="56e8" class="kj kk hi kf b fi kl km l kn ko">kubectl delete svc burger<br/>kubectl expose deployment burger --target-port=80 --type=NodePort</span></pre><p id="e67f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这允许我们将它连接到入口<a class="ae jy" href="https://kubernetes.io/docs/user-guide/ingress/" rel="noopener ugc nofollow" target="_blank"/>。入口的好处是你可以为它启用<a class="ae jy" href="https://cloud.google.com/cdn/" rel="noopener ugc nofollow" target="_blank">谷歌CDN </a>，这使得一切都非常快。</p><p id="7256" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了创建入口，我们创建了一个名为… <code class="du kp kq kr kf b">ingress.yaml</code>的文件！我们在里面放了这个:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="a29d" class="kj kk hi kf b fi kl km l kn ko">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: burger-ingress<br/>spec:<br/>  backend:<br/>    serviceName: burger<br/>    servicePort: 80</span></pre><p id="eee8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在集群上设置它:<code class="du kp kq kr kf b">kubectl create -f ingress.yaml</code>，像以前一样，我们可以观察它，直到它有一个地址:<code class="du kp kq kr kf b">kubectl get ing --watch</code></p><p id="1b50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">入口有点像我们之前看到的负载平衡器，除了入口使用<a class="ae jy" href="https://cloud.google.com/compute/docs/load-balancing/http/" rel="noopener ugc nofollow" target="_blank"> http负载平衡器</a>而不是<a class="ae jy" href="https://cloud.google.com/compute/docs/load-balancing/network/" rel="noopener ugc nofollow" target="_blank">网络负载平衡器</a>。</p><p id="0e65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在是时候添加神奇的成分了:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="08d8" class="kj kk hi kf b fi kl km l kn ko">BACKEND=$(kubectl get ing burger-ingress -o json | jq -j '.metadata.annotations."ingress.kubernetes.io/backends"' | jq -j 'keys[0]')</span><span id="683a" class="kj kk hi kf b fi ks km l kn ko">gcloud compute backend-services update $BACKEND --enable-cdn</span></pre><p id="c31f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Tada！这是我的大招，你在其他任何一本食谱上都找不到。基本上，它查看我们刚刚创建的入口，并使用<code class="du kp kq kr kf b"><a class="ae jy" href="https://stedolan.github.io/jq/" rel="noopener ugc nofollow" target="_blank">jq</a></code>(伟大的工具btw)对其进行分割，因此我们最终只得到<a class="ae jy" href="https://cloud.google.com/compute/docs/load-balancing/http/backend-service" rel="noopener ugc nofollow" target="_blank">后端</a>。我们告诉<code class="du kp kq kr kf b">gcloud</code>在后端启用CDN，我们就完成了。</p><p id="1299" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们来看看不同之处:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="00cd" class="kj kk hi kf b fi kl km l kn ko">ab -n 1000 -c 10 http://&lt;the address of our burger ingress&gt;/</span></pre><p id="c293" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在在欧洲，我只需31毫秒就能拿到汉堡。如果我们在日本的虚拟机上进行同样的测试，我们可以在34毫秒内完成，这比我们之前看到的459毫秒要好得多。在俄勒冈州的虚拟机上进行测试，我们甚至可以在1毫秒内获得服务！</p><p id="3142" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于谷歌的CDN服务器现在获得了所有的点击率，我们最初的3个服务器将很难再获得任何流量。这意味着我们可以将它们缩小到1:</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="de2c" class="kj kk hi kf b fi kl km l kn ko">kubectl scale deployment burger --replicas=1</span></pre></div><div class="ab cl kt ku gp kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hb hc hd he hf"><p id="8907" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你只记得这个节目中的三件事，记住这个:</p><ul class=""><li id="8bdd" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">你可以用Kubernetes做美味的东西</li><li id="877d" class="jp jq hi ih b ii jz im ka iq kb iu kc iy kd jc ju jv jw jx bi translated">汉堡需要快速供应</li><li id="bcfd" class="jp jq hi ih b ii jz im ka iq kb iu kc iy kd jc ju jv jw jx bi translated">如果您使用入口，您可以启用Google CDN</li></ul><p id="618c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在你知道了。祝你好运！</p></div></div>    
</body>
</html>