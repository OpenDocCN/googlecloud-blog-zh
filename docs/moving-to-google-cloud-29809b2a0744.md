# 转向谷歌云

> 原文：<https://medium.com/google-cloud/moving-to-google-cloud-29809b2a0744?source=collection_archive---------1----------------------->

## 在 Google Cloud 上部署可扩展的 Go APIs

由于我已经在 Go 中做了很多项目，并且不再有一群优秀的 devops 人员来支持我，使用 App Engine 在 Google Cloud 上发布我的应用程序似乎是一个显而易见的选择。我终于带着我最大的项目到达了一个令人愉快的地方，但是在这个过程中我遇到了一些障碍。这篇文章旨在分享一些好的、坏的和丑陋的经历，希望能帮助其他面临同样挑战的人。

## 入门指南

值得称赞的是，谷歌的界面很好，干净，相对来说用户友好(在我看来比 AWS 更友好)。)设置我的项目相当容易，上传我的第一个微服务也不是什么大挑战。我主要是通过试错来做的，但还是很容易。

## 专有包和其他故事

虽然我说谷歌似乎是托管 Go 应用程序的明显地方(毕竟是他们发明了这种语言)，但我对他们对核心 Go 库的实现变化如此之大感到有点惊讶。例如，永别了，原木，我爱你。Google 实现了自己的日志库，它位于相同的名称空间，但是实现了完全不同的接口。再见 Printf，你好 Infof，Errorf 等。即使他们使用了相同的名字，签名也会不同，因为 App Engine 中的所有东西都需要[上下文](https://golang.org/pkg/context/)，但是这种改变看起来是没有必要的。

在大多数情况下，这个价格是值得付出的——一旦你切换到应用引擎日志工具，界面真的很好——但这确实意味着，如果你认为你会成功地提取所有的专有资源并保持你的主机选项开放，你就错了。谷歌已经全心全意地接受了通过专有包来锁定供应商。

另一个极端的例子是 API(看起来有些笨拙，因为我还没有找到他们为什么这样做的解释)。如果你想打一个外部 API，你需要通过一个 Google API 代理，使用他们专有的库 urlfetch。许多供应商已经构建了工具来支持这一点，但是也有明显的例外。例如，我还没有找到允许自定义 http 客户端的 Go oAth1 库，所以我的 Twitter bot 没有在迁移中存活下来。

## 开发环境

幸运的是，我的是一个全新的项目，所以适应这些古怪的包装并不太痛苦。然而，一个副作用是，你必须在本地运行 Google 的开发环境，这样专有的包才能工作。这似乎是一个相当活跃的发展领域，因为在我构建 MVP 的四周时间里，一个重大的版本变化伴随着一些突破性的改变。例如，在旧版本中，如果您更改了一个文件，正在运行的服务将像 CI 工具一样自动重建和更新。在新版本中，您需要关闭并重启开发环境。在许多情况下，新的选项更加稳定，但是它确实需要一些时间来适应和一些侦查工作来弄清楚当我转换时发生了什么。开发环境也可能使同时运行多个微服务变得棘手——这可能使任何需要多个微服务的流程的功能测试变得具有挑战性。

## 按比例增加

所以在这之后，我的应用就上线了。像所有的 API 开发者一样，我完全相信只需要我的 alpha 版本就能带来飞速发展的应用。我需要准备好装货！我需要扩展！幸运的是，这就是 App Engine 的用途，对吗？也去吗？

所以我组装了一个简单的负载测试器，具有可配置的并发连接数(我想我可以使用现成的负载测试器，但是因为它只需要不到 100 行代码，所以我想我应该自己编写。)我沮丧地发现，即使并发数量相对较少(在我的例子中是 8 个), API 也开始抛出随机 500。这很奇怪——我配置了自动伸缩，而我的数据库却毫不费力。会发生什么？

这个问题花了整整两周才解决，这是我唯一一次差点放弃这个项目。首先，Go 开发者(我拒绝使用 Gopher 这个词——它听起来有极端的贬义)不阅读《用 Go 构建数据库驱动的应用程序的终极指南》的人是在欺骗自己，他们没有写出关于这个主题的最有用的 40 页。我对这种语言还比较陌生，它向我展示了一些关于如何管理数据库连接池的陷阱，这些陷阱让我非常头疼。然后我发现了一篇小小的 [Google FAQ 文章](https://cloud.google.com/sql/faq)，事后想起提到“应用引擎实例不能有超过 12 个并发连接。”

十二个真的不算多。特别是考虑到 Go 的 sql 包可以为一个事务打开两个连接。这意味着每个实例只有六个有效连接？什么是实例？我认为 App Engine 是一个完美的云工具——就像 AWS Lambda 一样，我再也不用担心物理甚至虚拟的盒子了。没有那么多。原来这些盒子仍然非常活跃。谷歌云论坛上的一些好心人给我指出了 T2 的这篇文章，不知何故我在注册时错过了。这篇文章告诉你实例是如何融入 App Engine 的巨大云团中的，并且通过 app.yaml 中相对少量的前期工作，实例可以被再次置于黑暗之中。在我的例子中，就是将每个实例限制为 5 个并发请求。一旦我做到了这一点，我就慢慢地调整我的负载测试器，并且没有错误地通过了 400 个并发请求(在 400 个之后我停止了测试)。太棒了。它还融化了我的笔记本电脑，甚至我的 gig home 互联网连接。

## 安全性

我现在非常致力于在我的制作工作中使用谷歌云。是时候让它看起来更专业了，特别是，使用我自己的域名而不是 appspot.com。我从我通常提供 DNS 服务的 name.com 那里给自己买了一个 SSL 证书，并试着上传。然而，没有地方上传中间证书，所以如果我试图导航到我的任何端点，我仍然会收到浏览器警告。我正在构建一个 API，所以这不是超级严重的，但它有点烦人，我不知道为什么会这样。

我决定在这个过程中测试一下谷歌自己的域名服务，看看它是否处理得更好。不幸的是，它仍然是非常基本的，所以它似乎不值得切换。我现在又开始使用 appspot.com 网址了，但我对未来仍抱有希望。

## 支持

所以现在我有了一个应用程序，正在运行，并且非常可扩展。然而，我对更多宇宙力量的渴望并没有减少。为了进一步扩展，我需要能够提升我的数据库。我目前正在使用云 SQL(穿着云衣服的 MySQL)，但我对[云扳手](https://cloud.google.com/spanner/)非常感兴趣，因为如果事情按计划进行，我计划的应用程序可能会有包含数亿条记录的表(甚至更多行，因为我的表是不可变的)。遗憾的是，我需要等待，因为 Cloud Spanner 的 Go 库仍然处于 alpha 阶段，甚至对我来说也有点太原始了。

然而，证明谷歌一直在监视我们(尽管大多是善意的)，就在这个时候，我收到了一封来自谷歌云代表的电子邮件，起初，我以为这只是销售，但在她打了一个电话，我们进行了简短的交谈后，我意识到我现在拥有了 AWS 从未向我提供的真正的问题和帮助资源。我不需要在 Twitter 上好战(虽然如果我不这样做，我会是一个边缘案例)。我不需要在每件事上都贴上惊人的 [miles ward](https://medium.com/u/7b83ae4b14bf?source=post_page-----29809b2a0744--------------------------------) 标签，希望他会同情我，把我保释出来。

## 网的网

这是一个过程，我遇到了更多的问题(比如我的数据库没有发出警报就用完了存储)，但总的来说，Google Cloud 已经成为一个非常棒的产品。UI 相对直观，功能丰富，看起来相当健壮。我最大的批评是入口非常陡峭，虽然详细的文档非常好，但有一个“缺失的手册”,即高质量的快速入门指南。他们可能会从上面提到的终极指南中借鉴一句谚语——它可能有正确的长度和深度。如果外面有这种东西，我希望有人能寄给我。我可能会因为第一次错过它而自责，但如果现在能知道我是否还错过了什么，那就太好了。