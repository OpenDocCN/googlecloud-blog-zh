<html>
<head>
<title>Building SQL pipelines in BigQuery with Dataform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用数据表单在BigQuery中构建SQL管道</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/building-sql-pipelines-in-bigquery-with-dataform-part-1-9e96f14ec664?source=collection_archive---------0-----------------------#2020-12-09">https://medium.com/google-cloud/building-sql-pipelines-in-bigquery-with-dataform-part-1-9e96f14ec664?source=collection_archive---------0-----------------------#2020-12-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="bcf9" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用SQL协作转换、记录和安排数据集</h2></div><p id="88f3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们越来越多地看到从构建ETL管道(在数据加载到BigQuery之前，大部分转换在Spark或Dataflow等工具中进行)到ELT管道(在BigQuery内部进行)的转变。原因是:( 1)业务用户更容易编写SQL ;( 2)与其他数据处理技术相比，BigQuery的伸缩性更好，成本更低。</p><p id="e8bc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，用SQL编写所有转换代码的问题是，它可能变得难以维护。你有多少次在几个月后回到一个项目，面对一堆视图、表格、用户定义的函数和脚本，困惑地挠头？</p><p id="4053" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就是为什么拥有一个支持转换代码方面的最佳实践的环境是非常有用的——您想要应用于任何代码的相同类型的最佳实践:文档、可重用性、可读性、断言、单元测试、源代码控制等等。Dataform，最近被Google Cloud收购，即将成为Google Cloud数据分析产品组合的一部分，提供了这样一个环境。对所有用户都是免费的。</p><h2 id="314b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">1.安装数据表单</h2><p id="a1a0" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在GCP控制台中，打开CloudShell(它是顶部蓝色丝带中的&gt;图标)。然后，使用NPM安装数据表单:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="55d7" class="jt ju hi ky b fi lc ld l le lf">npm i -g <a class="ae lg" href="http://twitter.com/dataform/cli" rel="noopener ugc nofollow" target="_blank">@dataform/cli</a></span></pre><h2 id="3de6" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">2.初始化数据表单项目</h2><p id="09b0" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">然后创建一个新的数据表单项目(我称之为bikes_weather):</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="2af7" class="jt ju hi ky b fi lc ld l le lf">dataform init bigquery bikes_weather \<br/>    --default-database $(gcloud config get-value project) \<br/>    --include-schedules</span></pre><p id="d5af" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此时，项目已经创建，具有Dataform推荐的文件结构:</p><figure class="kt ku kv kw fd li er es paragraph-image"><div class="er es lh"><img src="../Images/aa0fd908df0d34696a131892b066f23e.png" data-original-src="https://miro.medium.com/v2/resize:fit:488/format:webp/1*aEbfgBsU5uw3JY1GOkaQqw.png"/></div></figure><h2 id="6769" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">3.为BigQuery设置身份验证</h2><p id="f1eb" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">前往<a class="ae lg" href="https://console.cloud.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/iam-admin/serviceaccounts</a>并创建一个服务帐户。赋予该帐户BigQuery Admin的角色(以便Dataform可以创建新表等。).然后，将JSON密钥下载到项目中，并将文件上传到CloudShell。</p><p id="01f8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，在CloudShell中，键入:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="52c9" class="jt ju hi ky b fi lc ld l le lf">cd bikes_weather<br/>dataform init-creds bigquery</span></pre><p id="154e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当询问时，提供JSON密钥文件的路径。然后确保将密钥文件添加到。gitignore，这样你就不会错误地签入它。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="d52e" class="jt ju hi ky b fi lc ld l le lf">echo filename.json &gt; .gitignore<br/>git add -f .gitignore</span></pre><h2 id="3f00" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">4.设置原始来源</h2><p id="0da5" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">让我们首先为名为definitions/sources/weather . sqlx的源添加一个定义。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="19df" class="jt ju hi ky b fi lc ld l le lf">config {<br/>  type: "declaration",<br/>  database: "bigquery-public-data",<br/>  schema: "ghcn_d",<br/>  name: "ghcnd_2020",<br/>  description: "Weather data from Global Historical Climate Network (GHCN) in 2020"<br/>}</span></pre><p id="0124" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">基本上，这是存在于BigQuery表“big query-public-data . ghcn _ d . GH CND _ 2020”中的原始数据</p><p id="3fe9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这些数据看起来像这样:</p><figure class="kt ku kv kw fd li er es paragraph-image"><div class="er es ll"><img src="../Images/790352ab0ef7d7750a139ef8f0c83b12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*rsT2-gn7jywGGPAejcb1jQ.png"/></div></figure><p id="a0de" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它需要准备好才能有用。让我们接下来做那件事。</p><h2 id="8618" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">5.准备数据</h2><p id="37f5" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">创建一个名为definitions/staging/NYC _ weather . sqlx的文件。该文件将获取原始数据并将其格式化为纽约市可用的天气数据，格式如下:</p><figure class="kt ku kv kw fd li er es paragraph-image"><div class="er es lm"><img src="../Images/ca081a6e149c772ddc469e974983a816.png" data-original-src="https://miro.medium.com/v2/resize:fit:890/format:webp/1*WyRmiFfYyOkARS6F6OLDcQ.png"/></div></figure><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="efb3" class="jt ju hi ky b fi lc ld l le lf">config {<br/>  type: "table",<br/>  schema: "staging",<br/>  description: "Cleaned up data corresponding to New York City",<br/>  // column level documentation, defined in includes/docs.js<br/>  // columns: docs.nyc_weather<br/>}</span><span id="34ee" class="jt ju hi ky b fi ln ld l le lf">SELECT<br/>  date,<br/>  MAX(prcp) AS rain_mm,<br/>  MIN(tmin) AS tmin_celsius,<br/>  MAX(tmax) AS tmax_celsius<br/>FROM (<br/>  SELECT<br/>    wx.date AS date,<br/>    IF (wx.element = 'PRCP', wx.value/10, NULL) AS prcp,<br/>    IF (wx.element = 'TMIN', wx.value/10, NULL) AS tmin,<br/>    IF (wx.element = 'TMAX', wx.value/10, NULL) AS tmax<br/>  FROM<br/>    <strong class="ky hj">${ref("ghcnd_2020")}</strong> AS wx<br/>  WHERE<br/>    wx.id = 'USW00094728'<br/>)<br/>GROUP BY<br/>  date</span></pre><p id="932c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们要求Dataform为我们创建一个表(我们也可以要求它创建一个视图)。事实上，我们甚至可以让Dataform对它为我们创建的表进行分区和集群:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="c12b" class="jt ju hi ky b fi lc ld l le lf">config {<br/>  type: "table",<br/>  bigquery: {<br/>    partitionBy: "date",<br/>    clusterBy: ["tmin_celsius", "tmax_celsius"]<br/>  }<br/>}</span></pre><p id="ffd8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将使用我们指定的查询来创建视图。有两点需要注意。首先，表的FROM子句是对weather.sqlx中的表名的引用。文档在includes/docs.js中指定如下:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="a83f" class="jt ju hi ky b fi lc ld l le lf">const DATE = {<br/>  date: `The date (UTC)`<br/>};</span><span id="8315" class="jt ju hi ky b fi ln ld l le lf">const RAIN_MM = {<br/>  rain_mm: `Daily rainfall, in mm`<br/>};</span><span id="606a" class="jt ju hi ky b fi ln ld l le lf">const TMIN_CELSIUS = {<br/>  tmin_celsius: `Daily minimum temperature, in Celsius`<br/>};</span><span id="945f" class="jt ju hi ky b fi ln ld l le lf">const TMAX_CELSIUS = {<br/>  tmax_celsius: `Daily maximum temperature, in Celsius`<br/>};</span><span id="985b" class="jt ju hi ky b fi ln ld l le lf">// group documentation by table<br/>const nyc_weather = {<br/>  ...DATE,<br/>  ...RAIN_MM,<br/>  ...TMIN_CELSIUS,<br/>  ...TMAX_CELSIUS,<br/>};</span><span id="933b" class="jt ju hi ky b fi ln ld l le lf">module.exports = {<br/>  nyc_weather<br/>}</span></pre><p id="2f30" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">基本上，我们定义列，然后定义视图(nyc_weather)。这个想法是，列名在项目中是唯一的，并出现在多个视图和表中。</p><h2 id="1c43" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">6.编译和试运行</h2><p id="9e52" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">让我们试一试。首先，通过在命令行上键入以下命令来编译项目:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="ffeb" class="jt ju hi ky b fi lc ld l le lf">dataform compile</span></pre><p id="f673" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您应该看到Dataform告诉您将创建一个数据集staging.nyc_weather作为表。</p><p id="a7a4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您还可以检查依赖关系:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="9200" class="jt ju hi ky b fi lc ld l le lf">dataform run --dry-run</span></pre><h2 id="ea36" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">6.奔跑</h2><p id="3077" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">运行它来创建我们想要的视图和表。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="6d09" class="jt ju hi ky b fi lc ld l le lf">dataform run</span></pre><p id="b59f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">事实上，这张桌子是为我们创造的:</p><figure class="kt ku kv kw fd li er es paragraph-image"><div class="er es lo"><img src="../Images/88e0a64dfa9b2f6d8e5f0bd1a3fa4102.png" data-original-src="https://miro.medium.com/v2/resize:fit:918/format:webp/1*Y0lfWgcSa8V9MmswbBNqsQ.png"/></div></figure><h2 id="d428" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">7.使用数据表单web用户界面</h2><p id="bb12" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">然而，数据表单的真正用户体验来自于web用户界面。为此，您需要一个Git存储库(这是与您的团队成员协作的方式)。</p><p id="b879" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">去我的Git库(https://github.com/lakshmanok/bikes_weather)并把它放入你的GitHub账户。</p><p id="4777" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，在<a class="ae lg" href="https://dataform.co," rel="noopener ugc nofollow" target="_blank">https://dataform.co，</a>登录，进入用户设置，链接你的GitHub账户。</p><p id="58f7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从项目列表中，从Git存储库导入并导入my repo的fork。</p><p id="ebfa" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">指定您的GCP项目id来设置BigQuery。您必须上传服务帐户JSON文件。</p><h2 id="b482" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">8.构建SQL管道以创建报表</h2><p id="267c" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">让我们建立一个管道来创建一个关于纽约人在工作日和周末骑自行车的行为，以及天气对他们行为的影响的报告。</p><figure class="kt ku kv kw fd li er es paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="er es lp"><img src="../Images/96f681b404c260225248dc777a06e7a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CLnv9XO35rPupfThm2QUaw.png"/></div></div></figure><h2 id="602a" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">9.准备纽约自行车数据</h2><p id="d6f7" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">单击Sources旁边的三个点，创建一个新文件。将此文件命名为nyc_citibike.sqlx。创建一个空文件并将其放入内容:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="c898" class="jt ju hi ky b fi lc ld l le lf">config {<br/>  type: "declaration",<br/>  database: "bigquery-public-data",<br/>  schema: "new_york_citibike",<br/>  name: "citibike_trips",<br/>  description: "New York bicycle rentals"<br/>}</span></pre><p id="67e8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，创建staging/bicycle_trips.sqlx作为视图，并输入以下内容:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="dffb" class="jt ju hi ky b fi lc ld l le lf">config {<br/>  type: "view",<br/>  schema: "staging",<br/>  description: "Bicycle rental data corresponding to New York City",<br/>}</span><span id="5d17" class="jt ju hi ky b fi ln ld l le lf">select <br/>  EXTRACT(DATE from TIMESTAMP(starttime, 'UTC')) as date,<br/>  DATETIME_DIFF(stoptime, starttime, SECOND) AS duration<br/>from <br/>${ref("citibike_trips")}<br/>LIMIT 10</span></pre><p id="f778" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意，右边的菜单编译查询，让您预览结果，等等。一旦查询成功，就删除LIMIT子句。</p><p id="2054" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个查询给出了在纽约骑自行车旅行的日期和持续时间。请注意，我将时间转换为UTC，以匹配天气数据。</p><p id="ee1b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，创建包含以下内容的reports/bikes_weather.sqlx:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="b7b8" class="jt ju hi ky b fi lc ld l le lf">config {<br/>  type: "view",<br/>  schema: "staging",<br/>  description: "Bicycle trip count and duration by weather",<br/>}</span><span id="23c8" class="jt ju hi ky b fi ln ld l le lf">select <br/>  date,<br/>  AVG(duration) AS avg_duration,<br/>  COUNT(duration) AS num_trips,<br/>  ANY_VALUE(rain_mm &gt; 5) AS rainy,<br/>  ANY_VALUE(tmin_celsius + tmax_celsius)/2 AS temperature<br/>from <br/>  ${ref("bicycle_trips")}<br/>JOIN<br/>  ${ref("nyc_weather")}<br/>USING(date)<br/>GROUP BY date</span></pre><p id="78ca" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是一个连接。Dataform将要求您创建依赖项，以确保天气数据存在(回想一下，我们希望它是一个表)。</p><h2 id="a0db" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">10.运行它</h2><p id="6b29" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">单击依赖关系树，以可视化图表的形式显示数据是如何创建的。</p><p id="1538" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">视图本身看起来是这样的:</p><figure class="kt ku kv kw fd li er es paragraph-image"><div class="er es lu"><img src="../Images/7fe9521784dd91cb23e86314c942d634.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*bjl2mzZ3fKgkENl64rF3pg.png"/></div></figure><p id="ceec" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您可以将这个视图作为BI工具的输入。</p><p id="1381" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您也可以点击“创建时间表”来安排整个过程。</p><p id="dd83" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">尽情享受吧！目前的代码在<a class="ae lg" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/tree/master/blogs/dataform/bikes_weather" rel="noopener ugc nofollow" target="_blank">https://github . com/Google cloud platform/big query-oreilly-book/tree/master/blogs/data form/bikes _ weather</a></p><h2 id="335a" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">p.s .数据表单与UDF:</h2><p id="59f8" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">我在Twitter上遇到的一个问题是，你什么时候会使用数据表单，什么时候会使用用户自定义函数。两者都允许你重用代码。但是，Dataform允许您定义项目，并在项目的团队成员之间重用SQL代码/表定义/列文档/标记。UDF只允许您重用SQL代码，但是允许您全局共享SQL函数(不仅仅是在一个项目中)。</p></div></div>    
</body>
</html>