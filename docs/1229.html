<html>
<head>
<title>Monitoring and alerting on bytes sent from Google Cloud Storage buckets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">对从Google云存储桶发送的字节进行监控和警报</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/monitoring-bytes-sent-from-google-cloud-storage-buckets-e5324660111c?source=collection_archive---------0-----------------------#2019-12-20">https://medium.com/google-cloud/monitoring-bytes-sent-from-google-cloud-storage-buckets-e5324660111c?source=collection_archive---------0-----------------------#2019-12-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="33e5" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">放弃</h1><p id="e567" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我是一名谷歌人，具体在谷歌云工作。这里陈述的所有观点都是我自己的，而不是谷歌公司的。</p><h1 id="1705" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="5df1" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我经常与客户讨论如何留意他们从谷歌云存储桶的出口。您可能会关心这一指标有几个原因:</p><ul class=""><li id="7975" class="kb kc hi jf b jg kd jk ke jo kf js kg jw kh ka ki kj kk kl bi translated">您的存储桶是公开可用的，并且您想要监控从中传输数据的速率。</li><li id="2319" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">你的桶是CDN的来源，在那里你会有缓存填充的费用，要么来自CDN，要么只是互联网出口费用。</li><li id="5c8c" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">您的存储桶的默认和/或主要存储类别是近线或冷线，您希望监控读取以控制检索成本。</li></ul><p id="cf1b" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">幸运的是，使用GCP内置的Stackdriver很容易监控这一点。它被表示为度量<code class="du ku kv kw kx b">storage.googleapis.com/network/sent_bytes_count</code>。在本文中，我将向您展示如何在Google Cloud web UI中为这个指标设置监控和警报。</p><h1 id="18c4" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">如何设置Stackdriver指标</h1><p id="4fa0" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">您需要做的第一件事是捕捉和可视化指标。首先，转到Stackdriver监控。你可以在GCP控制台的汉堡菜单中找到这个。图标看起来像这样:</p><figure class="kz la lb lc fd ld er es paragraph-image"><div class="er es ky"><img src="../Images/afe4f69eee000e3bfa856a02e32de563.png" data-original-src="https://miro.medium.com/v2/resize:fit:672/format:webp/1*pi5p1sZeV-UZDKhcp_UFwg.png"/></div><figcaption class="lg lh et er es li lj bd b be z dx translated">Stackdriver监视按钮的外观。</figcaption></figure><p id="c0b0" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">在Stackdriver Monitoring页面中，单击Metrics explorer。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lk"><img src="../Images/346856c61b6607f65cbdd7a90f7150c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:732/format:webp/1*_PRkJBs28gRJxp9mJ8rDSw.png"/></div></div></figure><p id="4a1d" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">现在，您应该可以选择“查找资源类型和指标”在这里输入<code class="du ku kv kw kx b">storage.googleapis.com/network</code>,您应该会看到发送和接收的字节的度量。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lp"><img src="../Images/e4e1ded163b68b22394827522c8ac392.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6MW4x97snApkwHmjxCPV0Q.png"/></div></div></figure><p id="f408" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">一开始不知道自己想要哪一个可能会很困惑。容易记住的是，度量是从桶的角度来看的，所以<strong class="jf hj">发送的</strong>字节是对象读取，而<strong class="jf hj">接收的</strong>字节是对象写入。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lq"><img src="../Images/f023532286b8ceadd309d1859429f8c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kP0iQMkLO8CnAT7e5ddWNA.png"/></div></div></figure><p id="ad31" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">点击<code class="du ku kv kw kx b">sent_bytes_count</code>指标将其选中。然后，您将能够设置过滤器和其他设置。</p><p id="a46b" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">对于<strong class="jf hj">过滤器</strong>，思考一下什么是可以查看的有用范围。你只关心一个桶吗？一个位置的所有桶？都在一个项目里？选择任何适合您的用例。请记住，在过滤之后，您可以执行<strong class="jf hj">分组</strong>，因此如果您想单独查看一个项目中的所有存储桶，您可以通过<code class="du ku kv kw kx b">project_id</code>进行过滤，然后通过<code class="du ku kv kw kx b">bucket_name</code>进行分组。</p><p id="e276" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">还要记住，您可以将<strong class="jf hj">通配符</strong>放到过滤器中。例如，要过滤到一个bucket名称前缀，您可以添加一个类似于<code class="du ku kv kw kx b">=~"prefix-.*"</code>的过滤器。</p><p id="eebb" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">最后，确保您使用了<strong class="jf hj"> sum </strong>聚合器。<code class="du ku kv kw kx b">sent_bytes_count</code>是一个“增量”指标，意味着它是自上次采样以来发送的新字节数。例如，如果您在第0分钟发送1MB，然后在第1分钟发送1MB，则两个样本都将读取1MB(与第1分钟读取2MB相反，此时发送的字节数)。因此，如果将这些数据汇总到前五分钟，您可能需要对样本求和，以准确了解这五分钟内发送的字节数。</p><p id="5612" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">现在，您应该有一个从存储桶发送的<strong class="jf hj">字节</strong>的漂亮图形，如下所示:</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lr"><img src="../Images/6ccf790a74a0a514d9cd490ea4bd8cf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6U9I3bJKsgl3czXOGKf2XQ.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">典型的GCS铲斗出口图。</figcaption></figure><p id="9c7b" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">点击保存图表，将图表放在仪表板上以便于查看。</p><p id="f3b2" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">注意:以每秒<em class="ls">位</em>来讨论网络吞吐量是很常见的。<strong class="jf hj">这个图形既不是位的，也不是由第二个</strong>组成的。这是每分钟字节数。请确保在此数量和与您的工作相关的任何网络吞吐量之间进行适当的转换(例如:<a class="ae lt" href="https://www.wolframalpha.com/input/?i=1GB+per+minute+in+Mbps" rel="noopener ugc nofollow" target="_blank"> 1GB/min为133Mib/s </a>。</p><h1 id="f705" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">如何在指标上设置预警</h1><p id="f3ae" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">除非您<em class="ls">真的</em>喜欢看图表，否则您接下来要做的事情就是在指标上设置一个警报，这样您就可以知道它何时超过了指定的阈值。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div class="er es lu"><img src="../Images/8becb257a7a40281049f17532aaff3f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/format:webp/1*IdQwoMZOTUSNjHasFnMSxw.png"/></div></figure><p id="c627" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">值得一提的是，根据我的经验，这个指标是准确的，但略有延迟。样本大小是60秒，所以即使样本是即时发送的，您也总是会看到过去大约30秒的时间。实际上，我发现我的数据比当前时间落后几分钟。因此，我希望在达到阈值后的5分钟左右，我会收到警报。我认为这已经够快了，但还是值得理解。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div class="er es lv"><img src="../Images/808d1a5ca858422c9c7abac966ff42a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:520/format:webp/1*aewkO9TroAKhQg0k-FlPIA.png"/></div></figure><p id="389f" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">首先，转到Stackdriver UI的<strong class="jf hj">报警</strong>部分。找到<code class="du ku kv kw kx b">CREATE POLICY</code>按钮并点击它。</p><p id="09d4" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">给你的警报策略起一个相关的名字，比如“带宽警报”</p><p id="43bd" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">接下来，您需要添加一个条件。添加条件很像创建图表。选择<code class="du ku kv kw kx b">storage.googleapis.com/network/sent_bytes_count</code>指标，并根据您的情况调整过滤器和分组。然后，您将添加一个<strong class="jf hj">配置</strong>来指定警报条件。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lw"><img src="../Images/dd15eddfd797cea7b80be15bc195af00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Stiv9b0VpNSYhiCljjup4A.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">一个警报配置示例，一分钟内从存储桶中读取超过1gb的数据。</figcaption></figure><p id="672d" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">上面显示的警报配置在您从<strong class="jf hj">目标</strong>设置中获得的时间序列中，对于出口警报会很好地工作。请注意，您设置“分组依据”值的方式会对此警报的工作方式产生很大影响。例如:</p><ul class=""><li id="df44" class="kb kc hi jf b jg kd jk ke jo kf js kg jw kh ka ki kj kk kl bi translated">如果您筛选了项目…</li><li id="49bb" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">并按存储桶名称分组…</li><li id="6e31" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">只有当单个铲斗超过每分钟1gb时，才会触发此警报。</li></ul><p id="c3fa" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">另一方面…</p><ul class=""><li id="02ce" class="kb kc hi jf b jg kd jk ke jo kf js kg jw kh ka ki kj kk kl bi translated">如果你过滤了多个项目，比如<code class="du ku kv kw kx b">project_id ~= project1|project2</code> …</li><li id="8ce2" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">如果这些项目的总量<em class="ls"/>超过每分钟1gb，将触发此警报。</li></ul><p id="b254" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">接下来，您需要添加一个通知通道。<a class="ae lt" href="https://cloud.google.com/monitoring/support/notification-options" rel="noopener ugc nofollow" target="_blank">有很多方法可以配置这些</a>，文档中有详细说明。</p><p id="7673" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">说到文档，最后一个选项是在通知中为警报提供一些文档。用待命人员或队友容易理解的术语解释警报的意义是一个好主意。</p><p id="e6e1" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">下面是我的警报的配置方式:</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lx"><img src="../Images/cf62ccc9a97925164cb5233f7a97b66d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vJlPOk7HMUku-PmpjfPc4g.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">从我的项目的任何GCS存储桶以1GB/分钟的速度流出的警报配置。</figcaption></figure><p id="91c8" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">我强烈建议设置几个带有分级警报阈值的条件，接近您所关心的任何限制。换句话说，如果您认为1TB/min是一个需要人工关注的阈值，则为750GB/min设置一个条件，为875GB/min设置另一个条件。这样，尽管度量延迟、通知延迟、反应时间等引入了延迟，人类也能够在超出真实目标之前查看。</p><p id="2a2f" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">我希望这篇文章能够帮助您，并祝您在云中度过愉快的一天！</p></div></div>    
</body>
</html>