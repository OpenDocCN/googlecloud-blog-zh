<html>
<head>
<title>BigQuery: Set up limits and custom quotas through API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery:通过API设置限制和自定义配额</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bigquery-set-up-limits-and-custom-quotas-through-api-629f77438b7e?source=collection_archive---------1-----------------------#2020-01-06">https://medium.com/google-cloud/bigquery-set-up-limits-and-custom-quotas-through-api-629f77438b7e?source=collection_archive---------1-----------------------#2020-01-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/5c863e8268558360ebd14269aefe3fd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*16ymYv9B5qoHX1qRBFQIig.png"/></div></div></figure><p id="73dd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">BigQuery是Google云平台上的<strong class="is hj">Pb级数据仓库</strong>。您可以自由轻松地加载大量数据，存储成本非常实惠，90天后自动切换到冷存储。</p><p id="f808" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您使用<strong class="is hj">按需定价时，成本基于查询在查询中扫描的数据量</strong> <a class="ae jo" href="https://cloud.google.com/bigquery/pricing#on_demand_pricing" rel="noopener ugc nofollow" target="_blank">(对于更便宜的位置，每TB大约5美元)</a>。当<strong class="is hj">您拥有太字节或太字节时，它会变得非常昂贵</strong>！</p><h1 id="346c" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">成本优化</h1><p id="afeb" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">为了优化数据组织并减少扫描的数据量，<strong class="is hj">您可以对任何字段</strong> 上的数据进行聚类和/或 <a class="ae jo" rel="noopener" href="/google-cloud/partition-on-any-field-with-bigquery-840f8aa1aaab?source=---------2------------------"> <strong class="is hj">分区。您还可以在查询的<code class="du ks kt ku kv b">where</code>子句中<a class="ae jo" href="https://cloud.google.com/bigquery/docs/managing-partitioned-tables#require-filter" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">要求分区过滤器</strong> </a>。目标是迫使请求者询问自己关于扫描的数据以优化查询。</strong></a></p><p id="efa5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，<strong class="is hj">没有任何东西强迫请求者聪明地使用分区字段</strong>或<strong class="is hj">防止对它的不良使用</strong>。因此，在每个请求中要求分区字段可能是无用的，并且仍然可以扫描整个数据。</p><h1 id="bccd" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">扫描数据量的自定义配额</h1><p id="980d" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">为了防止由于缺少分区或分区使用不当而扫描大量数据，Google允许<strong class="is hj">为每个用户或每个项目设置</strong> <a class="ae jo" href="https://cloud.google.com/bigquery/docs/custom-quotas" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">自定义数据</strong> <strong class="is hj">扫描量</strong>。太平洋时间每天午夜，配额重置为0。</a></p><p id="8c38" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">设定配额很容易</p><ul class=""><li id="8846" class="kw kx hi is b it iu ix iy jb ky jf kz jj la jn lb lc ld le bi translated">转到<a class="ae jo" href="https://console.cloud.google.com/iam-admin/quotas" rel="noopener ugc nofollow" target="_blank">配额页面</a></li><li id="63ec" class="kw kx hi is b it lf ix lg jb lh jf li jj lj jn lb lc ld le bi translated">仅选择BigQuery服务</li><li id="5155" class="kw kx hi is b it lf ix lg jb lh jf li jj lj jn lb lc ld le bi translated">寻找<code class="du ks kt ku kv b">Query usage per day per user</code>或<code class="du ks kt ku kv b">Query usage per day</code>并选择它<em class="lk">(点击线路)</em></li><li id="b492" class="kw kx hi is b it lf ix lg jb lh jf li jj lj jn lb lc ld le bi translated">点击<code class="du ks kt ku kv b">Edit Quotas</code></li><li id="999c" class="kw kx hi is b it lf ix lg jb lh jf li jj lj jn lb lc ld le bi translated">在右侧设置极限，验证并<code class="du ks kt ku kv b">Submit</code></li></ul><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/3a02240a10af85daf18416868e56d1f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*x8Fe5mE4GfgDzzTLRK_p5g.gif"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">使用控制台设置自定义配额</figcaption></figure><blockquote class="lu"><p id="f33b" class="lv lw hi bd lx ly lz ma mb mc md jn dx translated">每台主机都很完美，但如何大规模实现呢？</p></blockquote><h1 id="958f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka me kc kd ke mf kg kh ki mg kk kl km bi translated">自动化配额限制</h1><p id="b5ed" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我的公司是全球性的(50多个国家)，有数千个GCP项目(3k+)和BigQuery表(100k+)，数百个子公司，以及许多不同的内部和外部IT团队和数据科学家。与我在总部的同事一起，我们为<strong class="is hj">培训做了很多工作，帮助和协助用户防止错误和意外成本</strong>。但这还不够。</p><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mh"><img src="../Images/f49a445489af0476775b2dc9f31ac0fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jOofcANGz5hNL-MerMkFqg.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">2019年BigQuery成本</figcaption></figure><p id="3dae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，我们决定对所有开发和测试项目设置一个限制，对于生产，只有当负责项目的团队提出要求时才这样做。为此，<strong class="is hj">我们想要使用</strong> <a class="ae jo" href="https://cloud.google.com/service-infrastructure/docs/service-management/reference/rest/" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">服务管理API </strong> </a> <strong class="is hj"> </strong>并且我们尝试了所有记录的端点… <strong class="is hj">不可能通过API更新配额！！</strong></p><blockquote class="lu"><p id="6828" class="lv lw hi bd lx ly mi mj mk ml mm jn dx translated">如何更新成千上万的项目？以及如何将这一点自动应用到新的上？</p></blockquote><h1 id="dd13" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka me kc kd ke mf kg kh ki mg kk kl km bi translated">未记录的API用法</h1><p id="e8fe" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">陷入了一个死胡同，我试图理解<strong class="is hj">API如何在控制台</strong>中工作，这要感谢Chrome的开发者模式，并且<strong class="is hj">我找到了一个变通办法。</strong></p><p id="8345" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="lk">重要提示</em> </strong> <em class="lk">:以下解释未经谷歌文档化，可随时更改或被屏蔽，恕不另行通知。</em> <strong class="is hj"> <em class="lk">慎用。</em> </strong></p><h2 id="f5ed" class="mn jq hi bd jr mo mp mq jv mr ms mt jz jb mu mv kd jf mw mx kh jj my mz kl na bi translated">API原则</h2><p id="9674" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">要调用这个API，请使用这个URL。<em class="lk">用自己的项目ID替换</em> <code class="du ks kt ku kv b"><em class="lk">PROJECT_ID</em></code> <em class="lk">。</em></p><pre class="lm ln lo lp fd nb kv nc nd aw ne bi"><span id="2d02" class="mn jq hi kv b fi nf ng l nh ni"><a class="ae jo" href="https://servicemanagement.googleapis.com/v1/s" rel="noopener ugc nofollow" target="_blank">https://servicemanagement.googleapis.com/v1/s</a>ervices/<a class="ae jo" href="http://bigquery-json.googleapis.com/projectSettings/gbl-imt-homerider-basguillaueb?updateMask=quotaSettings.consumerOverrides%5B%22QueryUsagePerDay%22%5D&amp;alt=json" rel="noopener ugc nofollow" target="_blank">bigquery-json.googleapis.com/projectSettings/PROJECT_ID?updateMask=quotaSettings.consumerOverrides%5B%22QueryUsagePerDay%22%5D</a></span></pre><p id="2f9c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lk">如果您想设置每个用户而不是每个项目的限制</em>，请用 <code class="du ks kt ku kv b"><em class="lk">QueryUsagePerUserPerDay</em></code> <em class="lk">替换值</em> <code class="du ks kt ku kv b"><em class="lk">QueryUsagePerDay</em></code> <em class="lk"/></p><p id="7d9c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">API是安全的</strong>，您必须在请求中提供HTTP承载访问令牌。调用<strong class="is hj">使用HTTP动词</strong> <code class="du ks kt ku kv b"><strong class="is hj">PATCH</strong></code>并且您必须呈现<code class="du ks kt ku kv b"><strong class="is hj">application/json</strong></code> <strong class="is hj">内容类型主体</strong>。</p><p id="8d02" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">限制以MB为单位。在这里，主体将该项目的限制设置为每天150Tb。<em class="lk">用自己的项目ID替换</em> <code class="du ks kt ku kv b"><em class="lk">PROJECT_ID</em></code> <em class="lk">。</em></p><pre class="lm ln lo lp fd nb kv nc nd aw ne bi"><span id="86ce" class="mn jq hi kv b fi nf ng l nh ni">{<br/>  "quotaSettings": <br/>  {<br/>    "adminOverrides":{},<br/>    "consumerOverrides":<br/>    {<br/>      "QueryUsagePerDay":   <br/>      {<br/>        "limit":"151380224"<br/>      }<br/>    },<br/>    "force":true<br/>  },<br/>  "consumerProjectId":"PROJECT_ID",<br/>  "serviceName":"<a class="ae jo" href="http://bigquery-json.googleapis.com/" rel="noopener ugc nofollow" target="_blank">bigquery-json.googleapis.com</a>"<br/>}</span></pre><p id="6b66" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lk">如果您想设置每个用户而不是每个项目的限制</em>，请将值 <code class="du ks kt ku kv b"><em class="lk">QueryUsagePerDay</em></code> <em class="lk">替换为</em> <code class="du ks kt ku kv b"><em class="lk">QueryUsagePerUserPerDay</em></code> <em class="lk"/></p><h2 id="9292" class="mn jq hi bd jr mo mp mq jv mr ms mt jz jb mu mv kd jf mw mx kh jj my mz kl na bi translated">把它们放在一起</h2><p id="883a" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">为了试验这个API，使用<code class="du ks kt ku kv b">curl</code>进行调用。创建一个文件名为<code class="du ks kt ku kv b">data</code>、内容为前一个主体的文件。然后，运行这个命令(例如在Cloud Shell上)。<em class="lk">用自己的项目ID替换</em> <code class="du ks kt ku kv b"><em class="lk">PROJECT_ID</em></code> <em class="lk">。</em></p><pre class="lm ln lo lp fd nb kv nc nd aw ne bi"><span id="7faf" class="mn jq hi kv b fi nf ng l nh ni">curl -d @data \<br/>  -H "content-type: application/json" \<br/>  -H "Authorization: Bearer $(gcloud auth print-access-token)" \<br/>  -X PATCH \<br/>  "<a class="ae jo" href="https://servicemanagement.googleapis.com/v1/s" rel="noopener ugc nofollow" target="_blank">https://servicemanagement.googleapis.com/v1/s</a>ervices/<a class="ae jo" href="http://bigquery-json.googleapis.com/projectSettings/gbl-imt-homerider-basguillaueb?updateMask=quotaSettings.consumerOverrides%5B%22QueryUsagePerDay%22%5D&amp;alt=json" rel="noopener ugc nofollow" target="_blank">bigquery-json.googleapis.com/projectSettings/PROJECT_ID?updateMask=quotaSettings.consumerOverrides%5B%22QueryUsagePerDay%22%5D</a>"</span></pre><p id="8da4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">答案是操作的ID</p><pre class="lm ln lo lp fd nb kv nc nd aw ne bi"><span id="6b00" class="mn jq hi kv b fi nf ng l nh ni">{<br/>  "name": "operations/tmo-quf.9d6e6e04-28fd-4147-8fee-dea59764b5d0"<br/>}</span></pre><p id="b744" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">检查控制台</p><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nj"><img src="../Images/5c1698f5322e6d661164aadd9b4e7e05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gkEWQaCGKlAXEC2GUSIwXA.png"/></div></div></figure><p id="6274" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">太好了，</strong>那个<strong class="is hj">管用</strong>！</p></div><div class="ab cl nk nl gp nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="hb hc hd he hf"><h1 id="5147" class="jp jq hi bd jr js nr ju jv jw ns jy jz ka nt kc kd ke nu kg kh ki nv kk kl km bi translated">小心使用</h1><p id="ebc8" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">现在，<strong class="is hj">您可以编写这个配额API </strong>的脚本，并将它包含在您所有的自动化项目创建中，并执行您现有项目的更新。</p><p id="eb7c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，<strong class="is hj">请记住，这是一种黑客行为，这种解决方案的可行性没有保证</strong>。</p></div></div>    
</body>
</html>