<html>
<head>
<title>Cloud Run and Secret Manager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云运行和秘密管理器</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-run-and-secret-manager-3c5d43a72e87?source=collection_archive---------0-----------------------#2022-06-02">https://medium.com/google-cloud/cloud-run-and-secret-manager-3c5d43a72e87?source=collection_archive---------0-----------------------#2022-06-02</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><div class=""/><figure class="ew ey ih ii ij ik es et paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="es et ig"><img src="../Images/0aa79267e647aae98080dfe9dfc5d3d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sbV5qc9tjigMOTpcSzaxJw.png"/></div></div></figure><p id="3e51" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated"><a class="ae jp" href="https://cloud.google.com/run" rel="noopener ugc nofollow" target="_blank"> Cloud Run </a>是一个了不起的产品——一个完全无服务的产品，它代表你启动和管理容器。它处理伸缩性和并发性、安全性等等。它可能最类似于亚马逊的<a class="ae jp" href="https://aws.amazon.com/fargate/" rel="noopener ugc nofollow" target="_blank"> Fargate </a>产品，但也与<a class="ae jp" href="https://aws.amazon.com/lambda" rel="noopener ugc nofollow" target="_blank"> Lambda </a>重叠。</p><p id="955d" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">我在玩GCP <a class="ae jp" href="https://cloud.google.com/secret-manager" rel="noopener ugc nofollow" target="_blank">秘密经理</a>，我想我会分享如何在使用云运行时利用它。最后还贴了一些不错的参考博文。</p><p id="0893" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">示例代码使用了<a class="ae jp" href="https://clojurescript.org/" rel="noopener ugc nofollow" target="_blank"> Clojurescript </a>。我是函数式编程的忠实粉丝，一般来说是Clojure。如果您不熟悉Clojure，它是一个LISP派生程序，运行在JVM之上。Clojurescript将transpiles转换成Javascript，因此可以利用社区可用的巨大节点包。看看<a class="ae jp" href="https://shadow-cljs.github.io/docs/UsersGuide.html" rel="noopener ugc nofollow" target="_blank"> Shadow-CLJS </a>，它使得将javascript库导入Clojurescript成为一个简单的过程。</p><h1 id="b29d" class="jq jr hj bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">你好，世界</h1><p id="a000" class="pw-post-body-paragraph ir is hj it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hc bi translated">我们将创建一个简单的web服务器。它将从秘密经理那里读入一个秘密。如果失败，它将寻找一个名为<code class="dv kt ku kv kw b">TARGET</code>的环境变量。如果失败，它将简单地用<code class="dv kt ku kv kw b">Hello, World!</code>来响应。</p><p id="577b" class="pw-post-body-paragraph ir is hj it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hc bi translated">云运行允许将环境变量传递到您的运行容器中。与secret manager没有直接集成，所以必须通过API调用。有趣的是，<a class="ae jp" href="https://cloud.google.com/build/docs/securing-builds/use-secrets" rel="noopener ugc nofollow" target="_blank">云构建</a>，<em class="kx"/>允许秘密作为环境变量被注入。这简化了事情，尽管可以说环境变量在涉及敏感数据时是危险的工具；因为它们很容易通过日志或内存转储暴露出来。尽管如此，如果你想要的东西需要很少的编码，云构建与Secret Manager的集成是一条路要走。</p><h1 id="a8e4" class="jq jr hj bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">部署容器</h1><p id="48ce" class="pw-post-body-paragraph ir is hj it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hc bi translated">我在本地构建了我的容器，并把它放到了谷歌容器注册中心。这简单而有效，但我会把<a class="ae jp" href="https://cloud.google.com/build" rel="noopener ugc nofollow" target="_blank">云构建</a>作为CI/CD系统，用于比简单演示更高级的东西。</p><pre class="ky kz la lb fe lc kw ld le aw lf bi"><span id="28c9" class="lg jr hj kw b fj lh li l lj lk">$ gcloud run deploy hello-secret --image gcr.io/nicks-playground-3141/hello-secret:0.4 --platform managed<br/>Deploying container to Cloud Run service [hello-secret] in project [nicks-playground-3141] region [us-central1]<br/>✓ Deploying... Done.<br/>  ✓ Creating Revision...<br/>  ✓ Routing traffic...<br/>Done.<br/>Service [hello-secret] revision [hello-secret-00010-qit] has been deployed and is serving 100 percent of traffic.<br/>Service URL: https://hello-secret-hrhyswd3ya-uc.a.run.app</span><span id="32a6" class="lg jr hj kw b fj ll li l lj lk"># Test against URL<br/>$ curl https://hello-secret-hrhyswd3ya-uc.a.run.app/<br/>Hello, World!</span></pre><h1 id="f505" class="jq jr hj bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">部署时将环境变量注入到容器中</h1><pre class="ky kz la lb fe lc kw ld le aw lf bi"><span id="5a95" class="lg jr hj kw b fj lh li l lj lk">$ gcloud run deploy hello-secret --set-env-vars TARGET=GALAXY \<br/>--image gcr.io/nicks-playground-3141/hello-secret:0.4 --platform managed</span><span id="1f4d" class="lg jr hj kw b fj ll li l lj lk"># Test aginst URL<br/>$ curl https://hello-secret-hrhyswd3ya-uc.a.run.app/<br/>Hello, GALAXY!</span></pre><h1 id="91b3" class="jq jr hj bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">创建秘密</h1><p id="6c83" class="pw-post-body-paragraph ir is hj it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hc bi translated">让我们在秘密管理器中创建一个秘密:</p><pre class="ky kz la lb fe lc kw ld le aw lf bi"><span id="7ec4" class="lg jr hj kw b fj lh li l lj lk">$ gcloud secrets create TARGET \<br/>    --replication-policy="automatic"</span><span id="baf6" class="lg jr hj kw b fj ll li l lj lk">$ echo -n "Universe" | \<br/>    gcloud secrets versions add TARGET  --data-file=-</span><span id="4a98" class="lg jr hj kw b fj ll li l lj lk"># Verify the secret<br/>$ gcloud secrets versions access 1 --secret="TARGET"<br/>Universe</span></pre><h1 id="9c8f" class="jq jr hj bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">将IAM权限更新为从Secret Manager中读取</h1><p id="62f2" class="pw-post-body-paragraph ir is hj it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hc bi translated">我第一次尝试时没有这样做，当然失败了。您可以为您的云运行容器创建一个具有适当权限的新服务帐户。或者，您可以扩展Cloud Run使用的<a class="ae jp" href="https://cloud.google.com/run/docs/securing/service-identity" rel="noopener ugc nofollow" target="_blank">默认</a>服务帐户的功能——我在这里就是这么做的。这<strong class="it hk">不</strong>被认为是最佳实践，因为你不希望所有的容器都被允许读取所有的秘密。然而，对于这个项目，这是一个可以接受的选择。</p><pre class="ky kz la lb fe lc kw ld le aw lf bi"><span id="5ae6" class="lg jr hj kw b fj lh li l lj lk">$ gcloud iam service-accounts add-iam-policy-binding nicks-playground-3141 \<br/>--member="serviceAccount:659824402950-compute@developer.gserviceaccount.com" \<br/>--role="roles/secretmanager.secretAccessor"</span></pre><h1 id="d06b" class="jq jr hj bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">重新启动服务，并测试</h1><pre class="ky kz la lb fe lc kw ld le aw lf bi"><span id="590a" class="lg jr hj kw b fj lh li l lj lk">$ curl https://hello-secret-hrhyswd3ya-uc.a.run.app<br/>Hello, Universe!</span></pre><h1 id="91b2" class="jq jr hj bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">排除故障</h1><p id="155a" class="pw-post-body-paragraph ir is hj it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hc bi translated">GCP日志控制台是惊人的，强大的眼睛糖果。但是，如果您想简单地跟踪日志，因为您的程序会将日志发送到STDOUT，您可以执行以下命令:</p><pre class="ky kz la lb fe lc kw ld le aw lf bi"><span id="1675" class="lg jr hj kw b fj lh li l lj lk">gcloud beta logging tail "resource.type=cloud_run_revision AND \<br/>resource.labels.service_name=hello-secret AND \<br/>severity&gt;=DEFAULT" \<br/>--format="default(timestamp,resource["labels"]["service_name"],textPayload)"</span></pre><h1 id="47e2" class="jq jr hj bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">Clojurescript</h1><p id="9507" class="pw-post-body-paragraph ir is hj it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hc bi translated">对于那些想看看Clojurescript代码的人来说，这个库位于Github <a class="ae jp" href="https://github.com/nbrandaleone/hello-secret" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><pre class="ky kz la lb fe lc kw ld le aw lf bi"><span id="05ea" class="lg jr hj kw b fj lh li l lj lk">(ns server.main<br/>  (:require<br/>    ["@google-cloud/secret-manager" :as Secret]<br/>    ["express" :as express]<br/>    [taoensso.timbre :as log]))<br/><br/>(defn get-word []<br/>  "determine the TARGET value, to follow 'hello' if secret-manager fails"<br/>  (let [t (get (env) "TARGET" "World")] t))<br/><br/>(defn secret-api []<br/>  "Calls GCP Secret Manager, using a JS promise<br/>   Use an atom to store state. Probably shouldn't, but it make things<br/>   a bit easier to test."<br/>  (let [client (Secret/SecretManagerServiceClient.)]<br/>    (-&gt; (.accessSecretVersion client (clj-&gt;js {:name mysecret}))<br/>      (.then (fn [name]<br/>               (let [payload (first name)] <br/>                 (reset! word (str (.. payload -payload -data)))))<br/>             (fn [] (do<br/>                      (reset! word (get-word))<br/>                      (log/debug "Secret Manager Promise rejected")))))))</span></pre></div><div class="ab cl lm ln gq lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="hc hd he hf hg"><ul class=""><li id="8610" class="lt lu hj it b iu iv iy iz jc lv jg lw jk lx jo ly lz ma mb bi translated"><a class="ae jp" href="https://www.inthepocket.com/blog/google-cloud-secret-manager-a-better-place-for-your-secrets" rel="noopener ugc nofollow" target="_blank">谷歌云秘密管理器:储存秘密的好地方</a></li><li id="c9c0" class="lt lu hj it b iu mc iy md jc me jg mf jk mg jo ly lz ma mb bi translated"><a class="ae jp" href="https://dev.to/googlecloud/serverless-mysteries-with-secret-manager-libraries-on-google-cloud-3a1p" rel="noopener ugc nofollow" target="_blank">Google Cloud上的Secret Manager Libraries带来了更少的秘密</a></li><li id="b516" class="lt lu hj it b iu mc iy md jc me jg mf jk mg jo ly lz ma mb bi translated"><a class="ae jp" rel="noopener" href="/google-cloud/secret-manager-improve-cloud-run-security-without-changing-the-code-634f60c541e6"> Secret Manager:不改变代码提高云运行安全性</a></li></ul></div></div>    
</body>
</html>