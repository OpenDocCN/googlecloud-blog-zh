<html>
<head>
<title>How to ssh into your GCE machine without a public IP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在没有公共IP的情况下ssh到您的GCE机器</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-ssh-into-your-gce-machine-without-a-public-ip-4d78bd23309e?source=collection_archive---------0-----------------------#2020-08-24">https://medium.com/google-cloud/how-to-ssh-into-your-gce-machine-without-a-public-ip-4d78bd23309e?source=collection_archive---------0-----------------------#2020-08-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div class="er es hg"><img src="../Images/ca5a6a4b0646c382ad3ec2de46707eaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:830/format:webp/1*jaaMFxUKdVD_8xxcio8o3w.png"/></div></figure><div class=""/><h1 id="8282" class="im in hp bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">介绍</h1><p id="2682" class="pw-post-body-paragraph jk jl hp jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在本文中，我将向您展示如何在没有公共IP的情况下，仅使用内部IP通过ssh访问您的计算引擎机器。</p><h1 id="4d4b" class="im in hp bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">在我们开始之前…</h1><p id="6f59" class="pw-post-body-paragraph jk jl hp jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在开始之前，我将补充几个重要的概念，说明我们如何实现这一目标。</p><p id="b9a5" class="pw-post-body-paragraph jk jl hp jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">如今，越来越多的公司使用额外的VPN层、MFA、安全流程、防火墙、路由器等，以验证谁需要访问服务器或应用程序。</p><p id="7949" class="pw-post-body-paragraph jk jl hp jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">Google在GCP创建了包含几个安全产品的BeyondCorp实现，我们在这里使用的是T2的身份识别代理T3(IAP)。</p><h2 id="0cd9" class="ko in hp bd io kp kq kr is ks kt ku iw jv kv kw ja jz kx ky je kd kz la ji lb bi translated"><strong class="ak">博彦科技</strong></h2><blockquote class="lc ld le"><p id="2ba5" class="jk jl lf jm b jn ki jp jq jr kj jt ju lg kk jx jy lh kl kb kc li km kf kg kh hb bi translated">BeyondCorp是Google对零信任安全模型的实现，它建立在Google八年零信任网络的基础上，结合了来自社区的想法和最佳实践。通过将访问控制从网络边界转移到个人用户和设备，BeyondCorp允许员工、承包商和其他用户从几乎任何位置更安全地工作，而不需要传统的<strong class="jm hq"> VPN </strong>。</p><p id="3781" class="jk jl lf jm b jn ki jp jq jr kj jt ju lg kk jx jy lh kl kb kc li km kf kg kh hb bi translated">BeyondCorp最初是谷歌的一项内部举措，目的是让每一名员工都能在不使用VPN的情况下，在不受信任的网络上工作。大多数谷歌员工每天都在使用BeyondCorp，为谷歌的核心基础设施提供基于用户和设备的认证和授权。</p></blockquote><h2 id="093c" class="ko in hp bd io kp kq kr is ks kt ku iw jv kv kw ja jz kx ky je kd kz la ji lb bi translated">身份感知代理</h2><blockquote class="lc ld le"><p id="eb43" class="jk jl lf jm b jn ki jp jq jr kj jt ju lg kk jx jy lh kl kb kc li km kf kg kh hb bi translated">IAP允许您为HTTPS访问的应用程序建立一个中央授权层，因此您可以使用应用程序级访问控制模型，而不是依赖网络级防火墙。</p><p id="2289" class="jk jl lf jm b jn ki jp jq jr kj jt ju lg kk jx jy lh kl kb kc li km kf kg kh hb bi translated">IAP政策可在您的组织中扩展。您可以集中定义访问策略，并将其应用于所有应用程序和资源。当您指派一个专门的团队来创建和实施策略时，您可以保护您的项目免受任何应用程序中不正确的策略定义或实现的影响。</p></blockquote><p id="62e4" class="pw-post-body-paragraph jk jl hp jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">Max Saltonstall 写了一个非常好的帖子，解释了关于IAP和BeyondCorp的更多细节，你可以在这里查看<a class="ae kn" rel="noopener" href="/google-cloud/what-is-beyondcorp-what-is-identity-aware-proxy-de525d9b3f90"/>。</p><h1 id="21c2" class="im in hp bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">履行</h1><h2 id="c5f1" class="ko in hp bd io kp kq kr is ks kt ku iw jv kv kw ja jz kx ky je kd kz la ji lb bi translated">开始前</h2><p id="046b" class="pw-post-body-paragraph jk jl hp jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">你将需要一个GCP项目，所以如果你还没有创建，你可以按照以下步骤:</p><ol class=""><li id="91be" class="ll lm hp jm b jn ki jr kj jv ln jz lo kd lp kh lq lr ls lt bi translated">转到云控制台中的<strong class="jm hq">管理资源</strong>页面。<br/> <a class="ae kn" href="https://console.cloud.google.com/cloud-resource-manager" rel="noopener ugc nofollow" target="_blank">转到管理资源页面</a></li><li id="ed30" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">在页面顶部的<strong class="jm hq">选择组织</strong>下拉列表中，选择要在其中创建项目的组织。如果您是免费试用用户，请跳过这一步，因为此列表不会出现。</li><li id="fd3c" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">点击<strong class="jm hq">创建项目</strong>。</li><li id="2597" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">在出现的<strong class="jm hq">新项目</strong>窗口中，输入项目名称并选择适用的计费账户。项目名称只能包含字母、数字、单引号、连字符、空格或感叹号，并且必须在4到30个字符之间。</li><li id="d0f3" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">在<strong class="jm hq">位置</strong>框中输入上级组织或文件夹。该资源将成为新项目的分层父项目。</li><li id="e551" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">当您输入完新项目的详细信息后，点击<strong class="jm hq">创建</strong>。</li></ol><h2 id="06fc" class="ko in hp bd io kp kq kr is ks kt ku iw jv kv kw ja jz kx ky je kd kz la ji lb bi translated">创建您的GCE实例</h2><ol class=""><li id="a77e" class="ll lm hp jm b jn jo jr js jv lz jz ma kd mb kh lq lr ls lt bi translated">在Google Cloud控制台中，转到<strong class="jm hq">虚拟机实例</strong>页面。</li><li id="30f9" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated"><a class="ae kn" href="https://console.cloud.google.com/compute/instances" rel="noopener ugc nofollow" target="_blank">转到虚拟机实例页面</a></li><li id="7754" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">选择您的项目并点击<strong class="jm hq">继续</strong>。</li><li id="ecf8" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">点击<strong class="jm hq">创建实例</strong>。</li><li id="6e96" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">为实例指定一个<strong class="jm hq">名称</strong>。</li><li id="acba" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">为您的实例选择一个<strong class="jm hq">机器配置</strong>。我建议您使用<a class="ae kn" href="https://cloud.google.com/free" rel="noopener ugc nofollow" target="_blank"> <em class="lf"> f1-micro </em>实例，这样您就可以使用您的自由层</a></li><li id="2235" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">在<strong class="jm hq">引导盘</strong>部分，我们将使用默认的Debian。</li><li id="6202" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">在<strong class="jm hq">联网</strong>部分，确保将<strong class="jm hq">外部IP </strong>更改为<strong class="jm hq">无</strong>并点击完成。</li><li id="bb0e" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated"><strong class="jm hq">不要</strong>点击允许HTTP流量或允许HTTPS流量</li><li id="e1ba" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">将所有其他参数保留为默认值。</li><li id="4d09" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">点击<strong class="jm hq">创建</strong>按钮，创建并启动实例。</li></ol><h2 id="dc9f" class="ko in hp bd io kp kq kr is ks kt ku iw jv kv kw ja jz kx ky je kd kz la ji lb bi translated">嘘嘘</h2><p id="9e0c" class="pw-post-body-paragraph jk jl hp jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">您可以使用下面的按钮尝试ssh，但是您将面临未授权的<em class="lf">即使您是项目的<strong class="jm hq">所有者</strong></em></p><figure class="md me mf mg fd hk er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es mc"><img src="../Images/90655c6fbef3a991e28c45cfb1399669.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VixGAAtjD-2OxGaYlWfE1Q.png"/></div></div></figure><figure class="md me mf mg fd hk er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es ml"><img src="../Images/ca6e461167c7e06ea634c62ab7162565.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fHIS2wGS6tD9Xf5Y5u79sQ.png"/></div></div><figcaption class="mm mn et er es mo mp bd b be z dx translated">ssh按钮</figcaption></figure><p id="1ed2" class="pw-post-body-paragraph jk jl hp jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">发生这种情况是因为<strong class="jm hq">所有者</strong>角色没有<strong class="jm hq"><em class="lf">IAP . tunnelinstances . accessviaiap</em></strong>权限，所以让我们为我们的用户添加这个权限。</p><h2 id="d38d" class="ko in hp bd io kp kq kr is ks kt ku iw jv kv kw ja jz kx ky je kd kz la ji lb bi translated"><strong class="ak">启用IAP </strong></h2><p id="8d45" class="pw-post-body-paragraph jk jl hp jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">首先，确保您启用了IAP API</p><ol class=""><li id="1446" class="ll lm hp jm b jn ki jr kj jv ln jz lo kd lp kh lq lr ls lt bi translated">转到云控制台<strong class="jm hq"> API </strong>库。</li><li id="269a" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">从项目列表中，选择要使用的项目。</li><li id="47e6" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">在<strong class="jm hq"> API </strong>库中，选择<strong class="jm hq">云身份感知代理API </strong></li><li id="e47b" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">在<strong class="jm hq"> API </strong>页面，点击<strong class="jm hq">启用</strong>如果仍然没有。</li></ol><figure class="md me mf mg fd hk er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es mq"><img src="../Images/18866ddf00c0fb9ad8f30ff91112e4b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vX9DI5UOrOkEDEVVTiCD6g.png"/></div></div></figure><h2 id="2170" class="ko in hp bd io kp kq kr is ks kt ku iw jv kv kw ja jz kx ky je kd kz la ji lb bi translated">向您的用户添加IAP角色</h2><ol class=""><li id="6f5b" class="ll lm hp jm b jn jo jr js jv lz jz ma kd mb kh lq lr ls lt bi translated">转到IAM</li><li id="c215" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">授予角色<strong class="jm hq"> IAP安全隧道用户</strong></li></ol><figure class="md me mf mg fd hk er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es mr"><img src="../Images/f1e6a3e99382e1e65ed47517e4647623.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yrWMJhTDfEJdnEavBZRLAQ.png"/></div></div></figure><p id="7621" class="pw-post-body-paragraph jk jl hp jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">→您也可以在此页面 e上检查所有<a class="ae kn" href="https://cloud.google.com/iap/docs/managing-access#roles" rel="noopener ugc nofollow" target="_blank"> IAP角色。</a></p><h2 id="5fa8" class="ko in hp bd io kp kq kr is ks kt ku iw jv kv kw ja jz kx ky je kd kz la ji lb bi translated">再唱一遍，检查一下魔术！</h2><p id="6e94" class="pw-post-body-paragraph jk jl hp jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">你可以试着点击按钮<em class="lf"> ssh </em>并在浏览器中使用终端…</p><figure class="md me mf mg fd hk er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es mc"><img src="../Images/90655c6fbef3a991e28c45cfb1399669.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VixGAAtjD-2OxGaYlWfE1Q.png"/></div></div></figure><p id="8245" class="pw-post-body-paragraph jk jl hp jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">…或者您可以在终端上使用<em class="lf"> gcloud </em>命令</p><blockquote class="ms"><p id="885f" class="mt mu hp bd mv mw mx my mz na nb kh dx translated"><strong class="ak"><em class="nc">g cloud compute ssh—zone "&lt;region&gt;【ssh-IAP】—tunnel-through-IAP—project "&lt;project _ ID&gt;</em></strong></p></blockquote><p id="ba0c" class="pw-post-body-paragraph jk jl hp jm b jn nd jp jq jr ne jt ju jv nf jx jy jz ng kb kc kd nh kf kg kh hb bi translated">如果您喜欢复制和粘贴，也可以在UI中看到这个命令</p><figure class="md me mf mg fd hk er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es ni"><img src="../Images/fe2c71a9842fd35980341d5024872699.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TNzgzyuL81K0hdo463rYyg.png"/></div></div></figure><figure class="md me mf mg fd hk er es paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="er es nj"><img src="../Images/6a6b4a24a198e5758ef8f041ad4cfa64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w_CCjjt3wF4KS1YJl_O-NQ.png"/></div></div></figure></div><div class="ab cl nk nl gp nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="hb hc hd he hf"><h1 id="9073" class="im in hp bd io ip nr ir is it ns iv iw ix nt iz ja jb nu jd je jf nv jh ji jj bi translated">打扫</h1><ol class=""><li id="d915" class="ll lm hp jm b jn jo jr js jv lz jz ma kd mb kh lq lr ls lt bi translated">删除实例</li><li id="69b6" class="ll lm hp jm b jn lu jr lv jv lw jz lx kd ly kh lq lr ls lt bi translated">如果您不想再使用该项目，请将其删除。</li></ol><h1 id="ccf6" class="im in hp bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">结论</h1><p id="64e7" class="pw-post-body-paragraph jk jl hp jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">IAP使我们能够将实例放在离互联网很近的地方，并且仍然以安全的方式ssh到其中。</p><p id="d329" class="pw-post-body-paragraph jk jl hp jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">使用<em class="lf"> gcloud </em>命令，我们甚至不需要创建自己的公钥/私钥，因为该工具完成了创建新的</p><p id="6186" class="pw-post-body-paragraph jk jl hp jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">您可以在<em class="lf"> ~/登记您的机器。ssh </em>文件夹通常称为<em class="lf"> google_compute_engine </em>，也在<em class="lf"> GCE - &gt; metadata - &gt; ssh键上。</em></p><p id="432f" class="pw-post-body-paragraph jk jl hp jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">如果有任何问题，请告诉我！</p></div></div>    
</body>
</html>