<html>
<head>
<title>Recommendations for IP address failover for high availability on Google Compute Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google计算引擎上实现高可用性的IP地址故障转移建议</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/recommendations-for-high-availability-failover-on-google-compute-engine-f4ff409fcf10?source=collection_archive---------1-----------------------#2018-10-24">https://medium.com/google-cloud/recommendations-for-high-availability-failover-on-google-compute-engine-f4ff409fcf10?source=collection_archive---------1-----------------------#2018-10-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a449" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">TL；DR: </strong>由于别名IP地址“滞留”在虚拟机上的可能性很小，因此使用路由实现高可用性是首选方法。</p><p id="e585" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当将内部高可用性应用迁移到Google云平台时，您经常需要在虚拟机之间移动固定IP地址，以模拟内部架构中浮动IP地址或虚拟IP地址的行为。如果主虚拟机上的服务或虚拟机本身出现故障，该IP地址将在一组通常为两个的虚拟机之间移动。</p><p id="eac9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于基于<a class="ae jd" href="https://en.wikipedia.org/wiki/Address_Resolution_Protocol#ARP_announcements," rel="noopener ugc nofollow" target="_blank">免费ARP </a>的内部解决方案无法在谷歌计算引擎上运行，文章<a class="ae jd" href="https://cloud.google.com/solutions/best-practices-floating-ip-addresses" rel="noopener ugc nofollow" target="_blank">浮动IP地址的最佳实践</a>提供了几种可以在这种情况下使用的解决方案。</p><p id="edfc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，该文章遗漏了使用别名IP地址的可能性，别名IP地址可以在同一子网的虚拟机之间移动。</p><p id="51e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，对于应用程序希望自己启动故障切换的情况，您是应该使用最佳做法白皮书中详述的使用路由的选项4，还是应该使用别名IP？</p><p id="5bf9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们来看看不同之处:</p><p id="1a98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用路由，当心跳代理想要启动故障转移时，它会删除一个路由，并添加指向新虚拟机实例的同一IP地址的另一个路由:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/2e75e8bb48635fdc735216ccb6ad26e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VDxVkUblQ3ZIQ_ExrWXSjQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">使用路由进行故障转移</figcaption></figure><p id="539e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种方法的主要缺点是虚拟/浮动IP地址需要在VPC使用的IP地址空间之外，并且这些地址不由GCP管理。这也意味着您需要使用<a class="ae jd" href="https://cloud.google.com/router/docs/how-to/advertising-overview" rel="noopener ugc nofollow" target="_blank">自定义路由广告</a>来通过VPN或专用/合作伙伴互连使用这些路由。故障转移需要两个API调用或gcloud命令来移动IP地址。</p><p id="1038" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，别名IP地址有什么不同:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/efc08653c3753308ae46bb46f857746d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q0k7DRGjnl3KZAZ11o-xjQ@2x.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">使用别名IP的故障转移</figcaption></figure><p id="f578" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">故障转移机制非常相似，您需要两个API调用或gcloud命令来在主虚拟机和辅助虚拟机之间移动IP地址。它似乎解决了基于路由选项的主要缺点，因为该地址是GCPs VPC地址范围的本地地址，可以从VPC内的任何地方寻址，并且可以通过VPN和专用/合作伙伴互连自动寻址。所以从各方面来看，这似乎都是一个更好的选择，不是吗？</p><p id="fbfd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">遗憾的是没有:</strong>别名IP地址是虚拟机的固有属性，因此它是虚拟机元数据的一部分，这也是高可用性配置可用性方面的最大缺点。在用户控制之外的某些罕见故障模式下，虚拟机可能变得完全不可访问，并且无法立即删除或修改包括元数据在内的虚拟机。因此，在这些情况下，<strong class="ih hj">用户可能无法暂时从故障虚拟机中删除别名IP </strong>地址，因此也无法将其添加到另一个虚拟机，因为每个别名IP地址在VPC中只能存在一次。</p><p id="6596" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，对于路由，路由是一个全局资源，不附属于VM，而是指向VM实例。因此，删除和创建路由的可能性不依赖于虚拟机及其元数据的可用性。此外，如果keepalive/heartbeat进程由于某种原因产生了意外结果，也可以通过创建具有较高优先级(这意味着较低的优先级值)的路由来手动覆盖该进程。</p><p id="b719" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于这种差异，建议使用路由而不是别名IP，即使这意味着手动管理IP地址空间。</p><p id="c557" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，为了达到最高的可用性，请确保在不同的<a class="ae jd" href="https://cloud.google.com/compute/docs/regions-zones/" rel="noopener ugc nofollow" target="_blank">区域</a>之间分配虚拟机实例，并查看<a class="ae jd" href="https://cloud.google.com/solutions/best-practices-floating-ip-addresses" rel="noopener ugc nofollow" target="_blank">最佳实践文档</a>中的其他选项是否更适合您的用例。</p></div></div>    
</body>
</html>