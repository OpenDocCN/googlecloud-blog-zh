<html>
<head>
<title>Using App Engine to start a Compute Engine VM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用应用引擎启动计算引擎虚拟机</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-app-engine-to-start-a-compute-engine-vm-be713c98d6a?source=collection_archive---------0-----------------------#2015-03-31">https://medium.com/google-cloud/using-app-engine-to-start-a-compute-engine-vm-be713c98d6a?source=collection_archive---------0-----------------------#2015-03-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/f5fcecdcbef46eeb75cdf58342e33292.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A_Co4L7jWAEvhv7aAs3sHA.jpeg"/></div></div></figure><div class=""/><p id="4e02" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有时我们不希望(或不需要)计算引擎实例每天24小时运行，但我们需要定期运行任务。为了解决这个问题，我们可以使用<strong class="is hu"> cron服务</strong>运行一个<strong class="is hu"> app引擎任务</strong>来启动<strong class="is hu"> VM实例</strong>。一旦VM启动，它可以有一个启动脚本来运行它需要的实际任务，然后停止机器。</p><h1 id="ddd8" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">虚拟机启动</h1><p id="ab68" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我们希望每天运行一次计划任务(比如说在午夜)以便启动。我将调用任务url <em class="kr"> /vm/start </em>，但是它可以是您想要的任何名称。以下是cron文件:</p><h2 id="fef3" class="ks jp ht bd jq kt ku kv ju kw kx ky jy jb kz la kc jf lb lc kg jj ld le kk lf bi translated">cron.yaml</h2><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="c8e3" class="ks jp ht ll b fi lp lq l lr ls">cron:<br/>- description: run instance<br/>  url: /vm/start<br/>  schedule: every day 00:00</span></pre><h2 id="fdb8" class="ks jp ht bd jq kt ku kv ju kw kx ky jy jb kz la kc jf lb lc kg jj ld le kk lf bi translated">端点处理程序</h2><p id="e475" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">一旦设置好，我们需要在appengine应用程序上调用url。我使用的是Flask framework，但它应该可以与您正在使用的任何东西一起工作:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="e8dd" class="ks jp ht ll b fi lp lq l lr ls"><strong class="ll hu">@app.route('/vm/start')</strong><br/><strong class="ll hu">def start_vm</strong>():<br/>    credentials = AppAssertionCredentials(scope='https://www.googleapis.com/auth/compute')<br/>    http = credentials.authorize(httplib2.Http(memcache))<br/>    compute = discovery.build('compute', 'v1', http=http)<br/>    <br/>    # Start the VM!<br/>    result = compute.instances().start(instance=INSTANCE_NAME, zone=INSTANCE_ZONE, project=PROJECT).execute()</span><span id="bcc4" class="ks jp ht ll b fi lt lq l lr ls">    logging.debug(result)<br/>    <strong class="ll hu">return </strong>json.dumps(result, indent=4)</span></pre><p id="841e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先你需要获得证书。由于我们是在GCP境内拨打电话，因此我们可以使用app engine服务帐户(您可以在此<a class="ae lu" href="https://developers.google.com/api-client-library/python/guide/google_app_engine#service-accounts" rel="noopener ugc nofollow" target="_blank">了解更多信息</a>)。然后我们使用google api客户端来构建和使用计算引擎api。就像调用实例开始方法一样简单。</p><h2 id="bff7" class="ks jp ht bd jq kt ku kv ju kw kx ky jy jb kz la kc jf lb lc kg jj ld le kk lf bi translated">配置访问</h2><p id="86c2" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">如果您尝试按原样运行代码，您将在日志中发现一条<em class="kr">遇到403禁止，原因为“accessNotConfigured”</em>的消息。我们需要为我们的项目启用计算引擎API。为此，转到<strong class="is hu"> API管理器</strong> &gt; <strong class="is hu">库</strong> &gt; <strong class="is hu">计算引擎API </strong>并点击<em class="kr">启用</em></p><p id="c68b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，在创建虚拟机时，我们需要设置对云API的访问权限</p><figure class="lg lh li lj fd hk er es paragraph-image"><div class="er es lv"><img src="../Images/fe0859755655018ff323864811d525c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/1*SWvuzYuoxcuGcg91vxozdg.png"/></div><figcaption class="lw lx et er es ly lz bd b be z dx translated">设置API访问权限。</figcaption></figure><p id="2da2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是启动虚拟机所需要的。一旦部署了一个简单的调用<a class="ae lu" href="http://your-project.appspot.com/vm/start" rel="noopener ugc nofollow" target="_blank">http://your-project.appspot.com/vm/start</a>就会启动虚拟机。</p><h1 id="9ce5" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">虚拟机停止</h1><p id="efc6" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">现在，启动脚本应该运行一些进程来完成您希望在此实例上完成的工作，然后最后一行应该像这样:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="03aa" class="ks jp ht ll b fi lp lq l lr ls">gcloud compute instances stop vm-instance --zone "YOUR-VM-ZONE"</span></pre><p id="2550" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这需要在创建虚拟机时进行配置:</p><figure class="lg lh li lj fd hk er es paragraph-image"><div class="er es ma"><img src="../Images/9ab29b5df5d0eeb414487f587203e135.png" data-original-src="https://miro.medium.com/v2/resize:fit:956/format:webp/1*4jtXVvTUShV6YZLB1HzHTw.png"/></div><figcaption class="lw lx et er es ly lz bd b be z dx translated">设置启动脚本</figcaption></figure></div><div class="ab cl mb mc gp md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="hb hc hd he hf"><p id="0e4c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想看这个例子的所有代码，你可以查看这个github repo。</p></div></div>    
</body>
</html>