<html>
<head>
<title>Infinite backup for Cloud Pub/Sub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云发布/订阅的无限备份</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/infinite-backup-for-cloud-pub-sub-62021b679c51?source=collection_archive---------1-----------------------#2017-06-11">https://medium.com/google-cloud/infinite-backup-for-cloud-pub-sub-62021b679c51?source=collection_archive---------1-----------------------#2017-06-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="58f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我喜欢使用<a class="ae jd" href="https://cloud.google.com/pubsub/" rel="noopener ugc nofollow" target="_blank">云发布/订阅</a>，尤其是它的无忧操作。每次和运行Kafka集群的人谈完话，听他们抱怨维持集群运行的运营成本太高，我就更加喜欢它了。但是Kafka确实有一个Cloud Pub/Sub没有的功能:能够永久存储你的流媒体数据。嗯……让我们做点什么，让我们以尽可能低的运营成本实现一个无限备份系统。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/7ce4aa74af6c5f1f0cc8d3e674738abf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QYlfHR7H4kF72hkvxmdUNw.jpeg"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">https://unsplash.com/photos/waAAaeC9hns<a class="ae jd" href="https://unsplash.com/photos/waAAaeC9hns" rel="noopener ugc nofollow" target="_blank"/></figcaption></figure><h2 id="803f" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">大查询存储</h2><p id="ef44" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我们首先需要的是无限的存储空间。显而易见的选择是云存储，因为它是最便宜的。但是它有一个限制，那就是它对于向其中输入数据不是很理想。另一个有无限存储空间的服务是BigQuery。令人惊讶的是，它的价格与云存储完全相同，并且它有一个流插入API。如果你在那个分区90天没有接收数据，它甚至会自动降低每个分区的<a class="ae jd" href="https://cloud.google.com/bigquery/pricing#long-term-storage" rel="noopener ugc nofollow" target="_blank">价格50% </a>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ku"><img src="../Images/212c96aca2928d61fa4745283131cd29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qhn8Kt6mVPlkbWjqNKjTaQ.png"/></div></div></figure><p id="e5d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你看看所有的特征，我想我们已经找到了理想的存储引擎。它甚至还有一个附加价值，那就是你有一个很好的网络界面，给你调试的能力和对你的流数据的一些洞察力。</p><p id="8db1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设计一个模式似乎很简单。只需将所有内容存储在发布/订阅消息中。幸运的是，BigQuery有一个<strong class="ih hj">二进制数据类型</strong>，所以我们可以存储任何类型的消息。我还喜欢存储消息和处理时间戳，这样至少可以知道消息是何时备份的。理想情况下，它们应该非常接近消息<strong class="ih hj">时间戳</strong>。我将不同的主题放入一个表中，所以我也将主题添加到模式中(您的需求可能会有所不同，可能需要为每个主题准备一个表)。另外，不要忘记备份潜在的<strong class="ih hj">属性</strong>，这些属性可能会附加到您的邮件中。</p><h2 id="4887" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">云数据流备份管道</h2><p id="834c" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">现在我们有了存储系统，我们需要一些东西来进行实际的备份。云数据流看起来是理想的候选，它使用了<a class="ae jd" href="https://beam.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Beam </a>模型，对于流和批处理具有相同的语义。这意味着当您希望以批处理模式从备份中读回数据时，可以重用相同的代码。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="a434" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/dataflow/" rel="noopener ugc nofollow" target="_blank">云数据流</a>也是一种托管服务，这有助于降低运营成本。因此，抛开所有的因素(云发布/订阅、大查询和云数据流)，我们现在必须考虑代码。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kx"><img src="../Images/4b61b9a2cc96447ffc187737e1fa6a03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ykMQoQR7aQWIsLJR_keT2w.png"/></div></div></figure><p id="9a4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这出奇的容易。阅读你想要备份的主题的<strong class="ih hj">发布/订阅</strong>是一个显而易见的事情。请注意，每个订阅<em class="ky">都有7天的保留期</em>，让您有足够的时间更新您的管道。接下来，<strong class="ih hj">将消息</strong>转换成一个TableRow，以便接收到BigQuery中，然后<strong class="ih hj">将</strong>所有订阅展平，这样就只有<strong class="ih hj">一个输出表</strong>。唯一棘手的是，您希望每天都有一个分区，但是我在以前的文章中已经提到了Apache Beam管道中的<a class="ae jd" rel="noopener" href="/google-cloud/bigquery-partitioning-with-beam-streams-97ec232a1fcc">自动BigQuery分区，所以这也解决了。</a></p><h2 id="66c7" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">结论</h2><p id="2901" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">这就是全部了。这是你可以构建的最简单的束管道之一，它能够同时处理几十个发布/订阅主题，并将备份流式传输到BigQuery。运行您的管道，您将获得以下优势:</p><ul class=""><li id="80d6" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc le lf lg lh bi translated">最便宜的邮件备份存储</li><li id="115e" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">储存90天后自动享受50%的折扣</li><li id="988b" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">7天发布/订阅缓冲</li><li id="d211" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">只有一个云数据流在运行</li></ul><p id="5e7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">也许它没有Kafka存储API那么强大，但它非常接近，而且不用担心运行Kafka集群。</p></div><div class="ab cl ln lo gp lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="hb hc hd he hf"><p id="bf6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在我的GitHub页面查看一个完整的工作示例，确保创建备份订阅并修改配置文件，如上例所示:</p><div class="lu lv ez fb lw lx"><a href="https://github.com/alexvanboxel/pubsub-backup" rel="noopener  ugc nofollow" target="_blank"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hj fi z dy mc ea eb md ed ef hh bi translated">alexvanboxel/pubsub-backup</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">通过在GitHub上创建一个帐户来为pubsub-backup开发做贡献。</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">github.com</p></div></div><div class="mg l"><div class="mh l mi mj mk mg ml jo lx"/></div></div></a></div><p id="1afd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在您可以放心地睡觉了，因为您知道您发布的所有消息都有备份。</p></div><div class="ab cl ln lo gp lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="hb hc hd he hf"><p id="93a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我很惊讶很少有人使用这个简单的技巧。一年多来，我一直在生产中成功地使用这种技术(尽管使用的是旧的BigQuery分区)。当Spotify在其文章“<a class="ae jd" href="https://labs.spotify.com/2017/04/26/reliable-export-of-cloud-pubsub-streams-to-cloud-storage/" rel="noopener ugc nofollow" target="_blank">可靠地将云发布/订阅流导出到云存储</a>”中公布其备份技术时，我非常高兴，但我对该解决方案的复杂性感到非常惊讶。我认为我的技术是可靠的，但是更容易编写和操作。也许当你在Spotify的规模上工作时，它会分崩离析，但当我达到那个点时，我会看到的。</p></div></div>    
</body>
</html>