<html>
<head>
<title>Local/Remote Authentication with Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google云平台进行本地/远程身份验证</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/local-remote-authentication-with-google-cloud-platform-afe3aa017b95?source=collection_archive---------0-----------------------#2019-04-18">https://medium.com/google-cloud/local-remote-authentication-with-google-cloud-platform-afe3aa017b95?source=collection_archive---------0-----------------------#2019-04-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8375" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">作者:</strong> <a class="ae jd" rel="noopener" href="/@theodoresiu7">萧</a>，<a class="ae jd" rel="noopener" href="/@danielrdeleo">丹尼尔</a></p><p id="15b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">更新(2021–03–24):考虑到安全性，特别是对于本地开发和直接面向用户的计算机，使用服务帐户JSONS可能不是最安全的。如</strong> <a class="ae jd" href="https://jryancanty.medium.com/stop-downloading-google-cloud-service-account-keys-1811d44a97d9" rel="noopener"> <strong class="ih hj">后的</strong> </a> <strong class="ih hj">等文章都主张类似的立场。虽然我们仍然建议使用GOOGLE_APPLICATION_CREDENTIALS的服务帐户JSONS在生产非GOOGLE云类型环境中运行代码，但我们建议使用gcloud auth application-default登录进行本地开发。我们已经删除了对“本地机器”上的服务帐户的引用，以反映这一变化。</strong></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/fa42e8b2457c6d32da39ba114442e2fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*NL7kHt0MIjRqUnkt2pgO8A.png"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">不正确的身份验证可能会阻止本地机器访问GCP资源</figcaption></figure><p id="3393" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本地或远程机器上设置谷歌云平台认证可能是一项令人困惑的任务。相对于用户帐户，您应该何时/如何使用服务帐户？你如何处理多个项目？不正确的身份验证也会导致权限被拒绝的错误。下面是一个抛出错误的示例:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="3826" class="jv jw hi jr b fi jx jy l jz ka">"Permission 'cloudkms.cryptoKeyVersions.useToEncrypt' denied for resource 'projects/myproject /locations/global/keyRings/myRing/cryptoKeys/myKey'.",</span><span id="096a" class="jv jw hi jr b fi kb jy l jz ka">"status": "PERMISSION_DENIED"</span></pre><p id="6316" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud Platform提供了以下从本地机器进行身份验证的方式:</p><ol class=""><li id="18d1" class="kc kd hi ih b ii ij im in iq ke iu kf iy kg jc kh ki kj kk bi translated">创建服务帐户，下载相应的JSON凭证文件，并将JSON文件路径的环境变量设置为<code class="du kl km kn jr b">GOOGLE_APPLICATION_CREDENTIALS</code>。</li><li id="439a" class="kc kd hi ih b ii ko im kp iq kq iu kr iy ks jc kh ki kj kk bi translated">使用<code class="du kl km kn jr b">gcloud auth application-default login</code>对用户身份进行认证(通过web流),但使用凭证作为服务帐户的代理。</li><li id="e1a1" class="kc kd hi ih b ii ko im kp iq kq iu kr iy ks jc kh ki kj kk bi translated">运行<code class="du kl km kn jr b">gcloud auth login</code>命令以用户身份认证(通过web flow)，然后授权gcloud和其他SDK工具访问Google云平台。注意，这个auth命令也是运行<code class="du kl km kn jr b">gcloud init</code>时运行的一组命令之一。</li><li id="fa8d" class="kc kd hi ih b ii ko im kp iq kq iu kr iy ks jc kh ki kj kk bi translated">当您的本地机器是嵌入式设备时，使用GCP服务特定的方法，例如生成用于<a class="ae jd" href="https://cloud.google.com/iot/docs/concepts/device-security#authentication" rel="noopener ugc nofollow" target="_blank">核心物联网认证</a>的私有/公共密钥对。这些特定于服务的示例超出了本文的范围。</li></ol><h1 id="61ba" class="kt jw hi bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">使用服务帐户</h1><p id="80df" class="pw-post-body-paragraph if ig hi ih b ii lq ik il im lr io ip iq ls is it iu lt iw ix iy lu ja jb jc hb bi translated">当以编程方式访问GCP资源时，应该使用GCP的服务帐户(例如:从脚本，使用google.cloud库的应用程序，点击GCP API等)..).如果你自己访问GCP，不要使用服务帐户，而是用你自己的谷歌用户身份认证！通过执行以下步骤，可以在本地计算机上创建和使用服务帐户进行身份验证:</p><p id="b0c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用GCP用户界面</strong></p><ol class=""><li id="4d22" class="kc kd hi ih b ii ij im in iq ke iu kf iy kg jc kh ki kj kk bi translated">登录你的GCP控制台<code class="du kl km kn jr b"><a class="ae jd" href="https://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com</a></code>，点击侧边栏的<code class="du kl km kn jr b">API's and Services &gt;&gt; Credentials</code>。</li><li id="e7b0" class="kc kd hi ih b ii ko im kp iq kq iu kr iy ks jc kh ki kj kk bi translated">你将被带到一个屏幕，在那里你可以点击<code class="du kl km kn jr b">Create Credentials &gt;&gt; Service Account Key</code>。在这里，您可以创建一个新的服务帐户(记住<a class="ae jd" href="https://cloud.google.com/iam/docs/granting-roles-to-service-accounts#granting_access_to_a_service_account_for_a_resource" rel="noopener ugc nofollow" target="_blank">附加适当的IAM角色</a>)并下载代表凭证的JSON密钥文件。</li></ol><p id="e59b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用gcloud命令行工具</strong></p><ol class=""><li id="e648" class="kc kd hi ih b ii ij im in iq ke iu kf iy kg jc kh ki kj kk bi translated">假设您已经使用<code class="du kl km kn jr b">gcloud auth login</code>认证为用户。然后，您可以使用<code class="du kl km kn jr b">gcloud config set project my-project</code>设置您的项目。</li><li id="2abb" class="kc kd hi ih b ii ko im kp iq kq iu kr iy ks jc kh ki kj kk bi translated">使用命令<code class="du kl km kn jr b">gcloud iam service-accounts create [SA-NAME] --display-name "[SA-DISPLAY-NAME]"</code>创建您的服务帐户，其中<code class="du kl km kn jr b">SA-NAME</code>是您的服务帐户名称，<code class="du kl km kn jr b">SA-DISPLAY-NAME</code>是显示友好名称。此时还应该为服务帐户分配适当的IAM角色<a class="ae jd" href="https://cloud.google.com/iam/docs/granting-roles-to-service-accounts#granting_access_to_a_service_account_for_a_resource" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="b25c" class="kc kd hi ih b ii ko im kp iq kq iu kr iy ks jc kh ki kj kk bi translated">下载代表凭证的JSON密钥文件<code class="du kl km kn jr b">gcloud iam service-accounts keys create ~/key.json<br/> --iam-account [SA-NAME]@[PROJECT-ID].iam.gserviceaccount.com</code></li></ol><p id="fa4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下载完密钥后，通过运行export命令将环境变量<code class="du kl km kn jr b">GOOGLE_APPLICATION_CREDENTIALS</code>设置为JSON的路径。例如:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="462d" class="jv jw hi jr b fi jx jy l jz ka">export GOOGLE_APPLICATION_CREDENTIALS=<!-- -->path/to/service_acct.json</span></pre><p id="642b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要更永久地设置您的凭据，如果您正在运行VM，请考虑将此命令添加到启动/引导脚本中。下面是BASH中的一个例子。</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="3fe3" class="jv jw hi jr b fi jx jy l jz ka">echo 'export GOOGLE_APPLICATION_CREDENTIALS = your/path/to/service_account_cred.json' &gt;&gt; ~/.bash_profile</span></pre><p id="d72d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用服务帐户并设置环境变量GOOGLE_APPLICATION_CREDENTIALS在gcloud上的优先级高于所有其他方法</strong>。<strong class="ih hj">更新(2021–03–24):考虑到安全性，特别是对于本地开发和直接面向用户的计算机，使用服务帐户JSONS可能不是最安全的。虽然我们仍然建议使用GOOGLE_APPLICATION_CREDENTIALS的服务帐户JSONS在生产类型环境中运行代码，但我们建议使用gcloud auth application-default登录进行本地开发。</strong></p><h1 id="9ad7" class="kt jw hi bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">使用gcloud auth应用程序-默认登录</h1><p id="ba13" class="pw-post-body-paragraph if ig hi ih b ii lq ik il im lr io ip iq ls is it iu lt iw ix iy lu ja jb jc hb bi translated"><code class="du kl km kn jr b">gcloud auth application-default login</code>命令创建一个名为<code class="du kl km kn jr b">application_default_credentials.json</code>的凭证JSON，嵌入在环境中的<code class="du kl km kn jr b">.config/</code>目录下。这种方法非常类似于上面的服务帐户方法，除了不是手动配置服务帐户和下载凭证的JSON文件，而是对用户进行身份验证并自动生成附加到用户的凭证。<strong class="ih hj">这不是推荐的方法</strong>，因为它的优先级低于设置<code class="du kl km kn jr b">GOOGLE_APPLICATION_CREDENTIALS</code>。<strong class="ih hj">更新(2021–03–24):考虑到本地机器的安全性，这是首选的身份验证方法。</strong></p><h1 id="171a" class="kt jw hi bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">作为用户进行身份验证</h1><p id="67a7" class="pw-post-body-paragraph if ig hi ih b ii lq ik il im lr io ip iq ls is it iu lt iw ix iy lu ja jb jc hb bi translated">运行<code class="du kl km kn jr b">gcloud auth login</code>或者按照<code class="du kl km kn jr b">gcloud init</code>登录流程将您认证为用户——但是这与上面两种使用服务帐户的方法有什么不同呢？</p><ol class=""><li id="5a7d" class="kc kd hi ih b ii ij im in iq ke iu kf iy kg jc kh ki kj kk bi translated">只有在以用户身份执行管理任务(例如，设置服务帐户、手动运行gsutil命令)时，才应进行用户身份验证，而不是在以编程方式访问GCP(如在Python或Go脚本中)时。</li><li id="eeb5" class="kc kd hi ih b ii ko im kp iq kq iu kr iy ks jc kh ki kj kk bi translated">与使用服务帐户方法不同，身份验证不是通过JSON文件完成的，而是通过令牌完成的。</li><li id="acf0" class="kc kd hi ih b ii ko im kp iq kq iu kr iy ks jc kh ki kj kk bi translated">通过使用<code class="du kl km kn jr b">gcloud auth login</code>或<code class="du kl km kn jr b">gcloud init</code>，gcloud、gsutil和bq命令开始作为用户帐户运行命令。也可以<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/auth/activate-service-account" rel="noopener ugc nofollow" target="_blank">将服务帐户</a>与所有这些工具一起使用。关于使用这些命令行工具进行身份验证的两种方法的一般指南可以在<a class="ae jd" href="https://cloud.google.com/sdk/docs/authorizing" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</li></ol><h1 id="947f" class="kt jw hi bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">什么优先？</h1><ol class=""><li id="8842" class="kc kd hi ih b ii lq im lr iq lv iu lw iy lx jc kh ki kj kk bi translated">如果运行gcloud、gsutil和bq命令行工具而没有作为服务帐户进行身份验证(这是运行<code class="du kl km kn jr b">gcloud auth login</code>或<code class="du kl km kn jr b">gcloud init</code>时的默认设置)，用户帐户将优先。</li><li id="baad" class="kc kd hi ih b ii ko im kp iq kq iu kr iy ks jc kh ki kj kk bi translated">如果以编程方式使用GCP资源(例如:在google.cloud库的脚本中)，将调用一个服务帐户，并且环境变量<code class="du kl km kn jr b">GOOGLE_APPLICATION_CREDENTIALS</code>优先于所有其他方法。</li><li id="41bb" class="kc kd hi ih b ii ko im kp iq kq iu kr iy ks jc kh ki kj kk bi translated">在服务帐户的情况下，如果没有找到<code class="du kl km kn jr b">GOOGLE_APPLICATION_CREDENTIALS</code>，将根据操作系统或使用的Google服务调用辅助应用程序默认凭证。例如，在Windows操作系统上，gcloud查找<code class="du kl km kn jr b">%APPDATA%/gcloud/application_default_credentials.json</code>，而在非Windows操作系统上，gcloud查找<code class="du kl km kn jr b">$HOME/.config/gcloud/application_default_credentials.json</code>。请参见此<a class="ae jd" href="https://cloud.google.com/sdk/docs/authorizing#finding_your_credential_files" rel="noopener ugc nofollow" target="_blank">链接</a>以搜索您的默认凭证列表。</li><li id="8a9c" class="kc kd hi ih b ii ko im kp iq kq iu kr iy ks jc kh ki kj kk bi translated">在诸如App Engine、Compute Engine或Google Kubernetes Engine的GCP资源上，查询元数据数据库以获取服务自己的凭证。</li></ol><p id="4939" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果不满足任何条件，GCP将无法通过身份验证，并且会遇到权限错误。</p><p id="3563" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">结论</strong></p><p id="ea7d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经验证了正确的实体已经通过了Google云平台的认证，您是否还会遇到同样的权限问题？如果是这样，请继续关注第2部分，在那里我们将讨论GCP服务权限。</p></div><div class="ab cl ly lz gp ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="hb hc hd he hf"><ol class=""><li id="0918" class="kc kd hi ih b ii ij im in iq ke iu kf iy kg jc kh ki kj kk bi translated">截至2019年4月发布本文时，存在一个已知的IAM策略错误，该错误会在删除服务帐户并重新创建同名的服务帐户时发生。删除时，已删除服务帐户的IAM策略绑定不会立即删除。需要手动删除然后重新添加服务帐户的策略绑定，以便向服务帐户正确授予IAM角色。</li></ol></div></div>    
</body>
</html>