<html>
<head>
<title>Google Cloud — Export Billing Data to BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Cloud —将账单数据导出到BigQuery</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-export-billing-data-to-bigquery-ce004fb87ce3?source=collection_archive---------1-----------------------#2022-05-09">https://medium.com/google-cloud/google-cloud-export-billing-data-to-bigquery-ce004fb87ce3?source=collection_archive---------1-----------------------#2022-05-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="44d2" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">FinOps是一种不断发展的云财务管理规则和文化实践，通过帮助工程、财务、技术和业务团队协作制定数据驱动的支出决策，使组织能够获得最大的商业价值。— <a class="ae jh" href="https://www.finops.org/introduction/what-is-finops/" rel="noopener ugc nofollow" target="_blank"> <em class="hi"> FinOps基金会</em> </a> <em class="hi">技术顾问委员会</em></p></blockquote><p id="f6a7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">换句话说，FinOps是一种实践，在这种实践中，用户获得他们的云消费的所有权，相应地管理他们的成本，并考虑他们的云支出如何影响商业价值。这涉及教育、可见性和共享最佳实践的结合。对于谷歌云的客户来说，FinOps策略的一部分是将计费数据导出到BigQuery中，使整个组织的成本可见。</p><p id="d88d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">谷歌云计费报告帮助您监控、优化和分析您的谷歌云成本。您可以使用它从Google控制台查看您的成本历史、成本趋势和预测成本。但是，为了进行更细致的分析，可以使用“<a class="ae jh" href="https://cloud.google.com/billing/docs/how-to/export-data-bigquery" rel="noopener ugc nofollow" target="_blank">将您的账单数据导出到BigQuery </a>”。将您的账单数据导出到BigQuery允许您使用BigQuery的查询功能对您的账单数据进行分割，并提供最可定制的分析形式。您可以使用高级查询微调您的分析，然后使用<a class="ae jh" href="https://cloud.google.com/billing/docs/how-to/visualize-data" rel="noopener ugc nofollow" target="_blank"> Data Studio </a>或<a class="ae jh" href="https://marketplace.looker.com/marketplace/detail/datatonic-gcp-billing-v2" rel="noopener ugc nofollow" target="_blank"> Looker </a>可视化您的结果。Google Cloud的<a class="ae jh" href="https://cloud.google.com/billing/docs/how-to/export-data-bigquery" rel="noopener ugc nofollow" target="_blank">建议</a>是在创建计费账户时设置计费导出。</p><p id="8eba" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">好处:</p><ul class=""><li id="a2d0" class="jl jm hi il b im in iq ir ji jn jj jo jk jp jg jq jr js jt bi translated">默认计费报表仪表板之外的成本分析。</li><li id="f68a" class="jl jm hi il b im ju iq jv ji jw jj jx jk jy jg jq jr js jt bi translated">创建自定义查询和仪表板。</li><li id="f9ff" class="jl jm hi il b im ju iq jv ji jw jj jx jk jy jg jq jr js jt bi translated">将数据导出到可视化工具或csv文件。</li><li id="eccc" class="jl jm hi il b im ju iq jv ji jw jj jx jk jy jg jq jr js jt bi translated">FinOps战略的一部分。</li></ul><h1 id="31ab" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">设置计费导出</h1><ol class=""><li id="b888" class="jl jm hi il b im kx iq ky ji kz jj la jk lb jg lc jr js jt bi translated">启用BigQuery数据传输服务API</li></ol><figure class="le lf lg lh fd li er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es ld"><img src="../Images/a4a2de2c1e8f18a465edd86a912e4a45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MymuN7J_cyd3LJ935EkKqA.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">BigQuery数据传输API</figcaption></figure><p id="f16e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">2.创建一个BigQuery数据集来管理您的所有账单数据。谷歌的建议是使用<a class="ae jh" href="https://cloud.google.com/bigquery/docs/locations#multi-regional-locations" rel="noopener ugc nofollow" target="_blank">多区域</a>选项，因为一些功能，如<a class="ae jh" href="https://cloud.google.com/billing/docs/how-to/export-data-bigquery-tables#detailed-usage-cost-data-schema" rel="noopener ugc nofollow" target="_blank">详细使用成本数据</a>仅在多区域位置受支持。单击项目ID旁边的3个点，然后选择“创建数据集”。</p><figure class="le lf lg lh fd li er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es ld"><img src="../Images/08bcaec9493d1260837b07282ec4bf3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lK8zS_kxc6IUeqjNvcCGVg.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">创建BigQuery数据集</figcaption></figure><p id="701a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">要创建数据集:</p><ul class=""><li id="cd17" class="jl jm hi il b im in iq ir ji jn jj jo jk jp jg jq jr js jt bi translated">输入数据集ID。这是用户定义的。</li><li id="95de" class="jl jm hi il b im ju iq jv ji jw jj jx jk jy jg jq jr js jt bi translated">选择一个数据位置。谷歌推荐是多地区的。</li><li id="c266" class="jl jm hi il b im ju iq jv ji jw jj jx jk jy jg jq jr js jt bi translated">确保清除了表过期选项。</li><li id="a138" class="jl jm hi il b im ju iq jv ji jw jj jx jk jy jg jq jr js jt bi translated">确保清除“使用客户管理的加密密钥(CMEK)”选项。</li></ul><figure class="le lf lg lh fd li er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es lt"><img src="../Images/86ca1667407b4f1816b64ba533f34c04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4S56mnezxYY_wBdnVxBTIg.png"/></div></div></figure><p id="0975" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您应该在BigQuery中的项目ID下看到create dataset。</p><figure class="le lf lg lh fd li er es paragraph-image"><div class="er es lu"><img src="../Images/7688cc41099b2e2670c39267ca89c024.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*pMYIKjpMosTMcsKeU7trrQ.png"/></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">已创建嵌套在项目ID下的数据集</figcaption></figure><p id="5a11" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">3.从计费菜单启用云计费导出到BigQuery数据集。选择<a class="ae jh" href="https://cloud.google.com/billing/docs/how-to/export-data-bigquery-tables#detailed-usage-cost-data-schema" rel="noopener ugc nofollow" target="_blank">标准使用成本或详细使用成本</a>中的一项。详细使用成本提供与标准使用成本相同的信息，以及提供资源级别数据的附加字段。</p><figure class="le lf lg lh fd li er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es ld"><img src="../Images/f271cd5a187e96b7df60c946fcfbbb44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SAjDfa6UsjX_1qT-g1GTkw.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">启用云计费导出选项</figcaption></figure><p id="49e1" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">在billing export配置中，选择BigQuery所在的项目，并选择您创建的数据集。</p><figure class="le lf lg lh fd li er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es lv"><img src="../Images/808c39bc3c7388bbd0f5cd79ce6b2612.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MNDEG4g6_sSP7KYIBQBTcA.png"/></div></div></figure><p id="cc84" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">Biling导出页面将显示启用和导出的项目。这些设置可以通过启用/禁用选项来更改。您还可以导出定价，这是适用于您的云计费帐户的定价数据。</p><figure class="le lf lg lh fd li er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es ld"><img src="../Images/93aa00b755db435d5713c7f1e37d22b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fDOk5fPkUNgpQh3C49Tb6g.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">计费导出选项</figcaption></figure><p id="58f2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">几分钟后，BigQuery数据集中自动创建了<a class="ae jh" href="https://cloud.google.com/billing/docs/how-to/export-data-bigquery-tables" rel="noopener ugc nofollow" target="_blank">账单数据表</a>。不要修改任何这些数据表。根据导出数据的类型，可能需要48小时才能开始看到数据。</p><figure class="le lf lg lh fd li er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es ld"><img src="../Images/5c4e64e0bda82ec7f0e1b8eacd40d146.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FhHVJUNA5kZ2iq7FCG7bDQ.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">BigQuery数据集收集导出的计费数据</figcaption></figure><p id="bc3c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">Google Cloud提供了几个<a class="ae jh" href="https://cloud.google.com/billing/docs/how-to/bq-examples" rel="noopener ugc nofollow" target="_blank">样本查询</a>你可以用来分析你的账单数据。</p><figure class="le lf lg lh fd li er es paragraph-image"><a href="https://cloud.google.com/billing/docs/how-to/bq-examples#sum-costs-per-invoice"><div class="er es lw"><img src="../Images/bc968a9fcd51faa0351ffc98c3dc2650.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FDGAmd16d59AcvGSZCDMCQ.png"/></div></a><figcaption class="lp lq et er es lr ls bd b be z dx translated">计算每张发票总成本的查询示例</figcaption></figure><h1 id="58f3" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">形象化</h1><p id="accb" class="pw-post-body-paragraph ii ij hi il b im kx io ip iq ky is it ji lx iw ix jj ly ja jb jk lz je jf jg hb bi translated">因为计费数据在BigQuery中，所以可以使用任何与BigQuery兼容的可视化工具。谷歌云推荐的两个工具是<a class="ae jh" href="https://marketplace.looker.com/marketplace/detail/datatonic-gcp-billing-v2" rel="noopener ugc nofollow" target="_blank"> Looker </a>和<a class="ae jh" href="https://cloud.google.com/billing/docs/how-to/visualize-data" rel="noopener ugc nofollow" target="_blank"> Data Studio </a>。Looker功能丰富，是两个选项中更灵活的一个。如果你需要快捷和免费，那么试试Data Studio。Data Studio也有一个<a class="ae jh" href="https://datastudio.google.com/u/0/reporting/1MJ0GHVvcHI6cRHwMKyeSK3r7UoabEHOH/page/WXzW" rel="noopener ugc nofollow" target="_blank">示例仪表板</a>，你可以复制它以便快速可视化。</p><h2 id="e804" class="ma ka hi bd kb mb mc md kf me mf mg kj ji mh mi kn jj mj mk kr jk ml mm kv mn bi translated">使用Data Studio可视化计费数据</h2><p id="0eb6" class="pw-post-body-paragraph ii ij hi il b im kx io ip iq ky is it ji lx iw ix jj ly ja jb jk lz je jf jg hb bi translated">在左侧，选择“(为我朗读)”。这显示了如何复制仪表板并将数据源更改为您创建的BigQuery表的说明。</p><figure class="le lf lg lh fd li er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es ld"><img src="../Images/d9fd298707c87d277bec282e87553e3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MaAKldrNxVyGZTLNeVbgEw.png"/></div></div></figure><pre class="le lf lg lh fd mo mp mq mr aw ms bi"><span id="945f" class="ma ka hi mp b fi mt mu l mv mw">TIP: To easily find the fully qualified table name, create a query in BigQuery</span></pre><figure class="le lf lg lh fd li er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es mx"><img src="../Images/14106905f26c11f37aaf091ea0e5f77d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TPkVek6sHnqjvzlXozJzHQ.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">创建查询时，会自动生成完全限定的表名</figcaption></figure><p id="2bd0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">当您重新连接并查看确认信息时，您应该会看到以下弹出屏幕。任何字段都不应更改。</p><figure class="le lf lg lh fd li er es paragraph-image"><div class="er es my"><img src="../Images/59ea84cb4de938891da4699cf0efb449.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*6tZpi1fuzwnVf-DMmkQAPw.png"/></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">确认连接到大查询</figcaption></figure><p id="b2dd" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">完成后，data studio将使用预构建的查询来可视化您的数据。</p><figure class="le lf lg lh fd li er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es ld"><img src="../Images/6451a5d2a8596b22c43ad35810652dcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mvp8iYdvNrYA_ktDkpSe1Q.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">使用Data Studio可视化计费数据</figcaption></figure></div><div class="ab cl mz na gp nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="hb hc hd he hf"><h2 id="a1d5" class="ma ka hi bd kb mb mc md kf me mf mg kj ji mh mi kn jj mj mk kr jk ml mm kv mn bi translated">进一步观察</h2><figure class="le lf lg lh fd li"><div class="bz dy l di"><div class="ng nh l"/></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">导出计费数据</figcaption></figure></div><div class="ab cl mz na gp nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="hb hc hd he hf"><pre class="le lf lg lh fd mo mp mq mr aw ms bi"><span id="ab0f" class="ma ka hi mp b fi mt mu l mv mw"><strong class="mp hj">Further Reading<br/></strong><a class="ae jh" href="https://cloud.google.com/billing/docs/how-to/export-data-bigquery" rel="noopener ugc nofollow" target="_blank">Google Cloud: Export Cloud Billing daa to BigQuery</a> <br/><a class="ae jh" href="https://cloud.google.com/billing/docs/how-to/export-data-bigquery-tables" rel="noopener ugc nofollow" target="_blank">Google Cloud: Understand BigQuery Cloud Billing Data Tables</a><br/><a class="ae jh" href="https://cloud.google.com/billing/docs/how-to/bq-examples" rel="noopener ugc nofollow" target="_blank">Google Cloud: Example Queries for Cloud Billing Data Export</a><br/><a class="ae jh" href="https://cloud.google.com/blog/products/gcp/labelling-and-grouping-your-google-cloud-platform-resources" rel="noopener ugc nofollow" target="_blank">Google Cloud: Labelling and grouping your Google Cloud Platform Resources</a><br/><a class="ae jh" href="https://cloud.google.com/billing/docs/how-to/visualize-data" rel="noopener ugc nofollow" target="_blank">Google Cloud: Visualize spend over time with Google Data Studio</a><br/><a class="ae jh" href="https://cloud.google.com/blog/topics/developers-practitioners/optimizing-your-google-cloud-spend-bigquery-and-looker" rel="noopener ugc nofollow" target="_blank">Google Cloud: Optimizing your Google Cloud spend with BigQuery and Looker</a><br/><a class="ae jh" rel="noopener" href="/google-cloud/visualize-gcp-billing-using-bigquery-and-data-studio-d3e695f90c08">Medium: Visualize GCP Billing using BigQuery and Data Studio</a> (2017) <a class="ae jh" href="https://www.finops.org/introduction/what-is-finops/" rel="noopener ugc nofollow" target="_blank">FinOps Foundation: What is FinOps?</a></span></pre></div></div>    
</body>
</html>