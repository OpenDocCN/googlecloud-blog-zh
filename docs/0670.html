<html>
<head>
<title>Using Google Cloud Deployment Manager shared types</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Cloud部署管理器共享类型</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-google-cloud-deployment-manager-shared-types-f5c3609687b0?source=collection_archive---------1-----------------------#2018-06-27">https://medium.com/google-cloud/using-google-cloud-deployment-manager-shared-types-f5c3609687b0?source=collection_archive---------1-----------------------#2018-06-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9a61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud Deployment Manager允许您使用YAML、python或Jinja2以声明格式自动创建/读取/更新/删除应用程序所需的所有资源。部署管理器模板允许使用构建块来创建通常一起部署的抽象资源或资源集。这种方法允许您将配置视为代码，并自动执行可重复的部署。</p><p id="9c62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，部署管理器支持一组<a class="ae jd" href="https://cloud.google.com/deployment-manager/docs/configuration/supported-resource-types" rel="noopener ugc nofollow" target="_blank">资源类型</a>，并且可以通过类型提供者进行扩展。默认的资源类型涵盖了许多常见的部署场景，比如创建GCP项目、设置VPC和部署GCE VM。</p><p id="49b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署管理器中一个有用的特性是能够注册第三方API，然后使用部署管理器通过API部署资源。这个概念被称为<a class="ae jd" href="https://cloud.google.com/deployment-manager/docs/configuration/type-providers/process-adding-api" rel="noopener ugc nofollow" target="_blank">类型提供者</a>，极大地扩展了自动化任意CRUD风格API的能力。这个功能非常有用，因为它允许您通过部署管理器模板使用任何GCP API，即使它们没有作为资源类型、处于alpha或beta版本的GCP API甚至您自己的API公开。</p><p id="3852" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，我最近想在Stackdriver Logging中为GCP组织的所有项目创建一个日志导出同步。项目同步是部署管理器中的默认资源类型，它使用<a class="ae jd" href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/projects.sinks/create" rel="noopener ugc nofollow" target="_blank"> projects.sync.create </a> API。但是，创建组织同步使用的是<a class="ae jd" href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/organizations.sinks/create" rel="noopener ugc nofollow" target="_blank">organizations . sync . create</a>API，它不是默认的资源类型。</p><p id="5290" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是类型提供者的亮点！为了通过部署管理器创建组织同步，我使用了类型提供者的概念。下面是我用来通过部署管理器创建组织同步的步骤。</p><h1 id="9082" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">第一步。找到API发现URL。</h1><p id="81e5" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">发现URL描述了API提供的CRUD操作。我使用了<a class="ae jd" href="https://developers.google.com/discovery/" rel="noopener ugc nofollow" target="_blank"> Google API发现服务</a>来查找相关的发现API，因为它涵盖了任何Google API。相应地，发现服务提供了一个<a class="ae jd" href="https://developers.google.com/apis-explorer/#search/discovery.apis.list/m/discovery/v1/discovery.apis.list" rel="noopener ugc nofollow" target="_blank"> API </a>本身来为Google APIs查找发现URL。</p><p id="cf44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，我使用<a class="ae jd" href="https://developers.google.com/apis-explorer/#search/discovery.apis.list/m/discovery/v1/discovery.apis.list?name=logging&amp;_h=2&amp;" rel="noopener ugc nofollow" target="_blank">发现服务API explorer </a>来搜索日志服务。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/dfc97f9aea0c75d863e18ef83c78afa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8RdLNvD3ILkklxqslGSBGQ.png"/></div></div></figure><p id="340a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">JSON响应在<em class="kt"> discoveryRestUrl </em>字段中列出了发现URL。</p><pre class="ki kj kk kl fd ku kv kw kx aw ky bi"><span id="170a" class="kz jf hi kv b fi la lb l lc ld">{<br/>  "kind": "discovery#directoryList",<br/>  "discoveryVersion": "v1",<br/>  "items": [<br/>   {<br/>    "kind": "discovery#directoryItem",<br/>    "id": "logging:v2",<br/>    "name": "logging",<br/>    "version": "v2",<br/>    "title": "Stackdriver Logging API",<br/>    "description": "Writes log entries and manages your Stackdriver Logging configuration.",<br/>    "discoveryRestUrl": "<a class="ae jd" href="https://logging.googleapis.com/$discovery/rest?version=v2" rel="noopener ugc nofollow" target="_blank">https://logging.googleapis.com/$discovery/rest?version=v2</a>",<br/>    "icons": {<br/>     "x16": "<a class="ae jd" href="https://www.gstatic.com/images/branding/product/1x/googleg_16dp.png" rel="noopener ugc nofollow" target="_blank">https://www.gstatic.com/images/branding/product/1x/googleg_16dp.png</a>",<br/>     "x32": "<a class="ae jd" href="https://www.gstatic.com/images/branding/product/1x/googleg_32dp.png" rel="noopener ugc nofollow" target="_blank">https://www.gstatic.com/images/branding/product/1x/googleg_32dp.png</a>"<br/>    },<br/>    "documentationLink": "<a class="ae jd" href="https://cloud.google.com/logging/docs/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/logging/docs/</a>",<br/>    "preferred": true<br/>   },<br/>   {<br/>    "kind": "discovery#directoryItem",<br/>    "id": "logging:v2beta1",<br/>    "name": "logging",<br/>    "version": "v2beta1",<br/>    "title": "Stackdriver Logging API",<br/>    "description": "Writes log entries and manages your Stackdriver Logging configuration.",<br/>    "discoveryRestUrl": "<a class="ae jd" href="https://logging.googleapis.com/$discovery/rest?version=v2beta1" rel="noopener ugc nofollow" target="_blank">https://logging.googleapis.com/$discovery/rest?version=v2beta1</a>",<br/>    "icons": {<br/>     "x16": "<a class="ae jd" href="https://www.gstatic.com/images/branding/product/1x/googleg_16dp.png" rel="noopener ugc nofollow" target="_blank">https://www.gstatic.com/images/branding/product/1x/googleg_16dp.png</a>",<br/>     "x32": "<a class="ae jd" href="https://www.gstatic.com/images/branding/product/1x/googleg_32dp.png" rel="noopener ugc nofollow" target="_blank">https://www.gstatic.com/images/branding/product/1x/googleg_32dp.png</a>"<br/>    },<br/>    "documentationLink": "<a class="ae jd" href="https://cloud.google.com/logging/docs/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/logging/docs/</a>",<br/>    "preferred": false<br/>   }<br/>  ]<br/>}</span></pre><p id="2c6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以看到discoveryRestUrl是<a class="ae jd" href="https://logging.googleapis.com/$discovery/rest?version=v2beta1." rel="noopener ugc nofollow" target="_blank">https://logging.googleapis.com/$discovery/rest?版本=v2beta1。</a></p><h1 id="4cc7" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">第二步。创建GCP类型提供程序。</h1><p id="5470" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">需要创建GCP类型提供程序，然后才能在部署管理器脚本中使用该类型。我使用下面的命令使用了<em class="kt"> gcloud </em>来创建类型提供者。</p><pre class="ki kj kk kl fd ku kv kw kx aw ky bi"><span id="8398" class="kz jf hi kv b fi la lb l lc ld">gcloud beta deployment-manager type-providers create sharedloggingv2type --descriptor-url='https://logging.googleapis.com/$discovery/rest?version=v2'</span><span id="f5f4" class="kz jf hi kv b fi le lb l lc ld">Waiting for insert [operation-1530042902553–56f90dfb2a1a8–5b28e068–54001af8]…done.<br/>Created type_provider [sharedloggingv2type].</span></pre><p id="bf4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我检查类型提供者是否被成功创建。</p><pre class="ki kj kk kl fd ku kv kw kx aw ky bi"><span id="a105" class="kz jf hi kv b fi la lb l lc ld">gcloud beta deployment-manager type-providers describe sharedloggingv2type</span><span id="3fa3" class="kz jf hi kv b fi le lb l lc ld">description: ''<br/>descriptorUrl: <a class="ae jd" href="https://logging.googleapis.com/$discovery/rest?version=v2" rel="noopener ugc nofollow" target="_blank">https://logging.googleapis.com/$discovery/rest?version=v2</a><br/>id: '6736148154336355577'<br/>insertTime: '2018-06-26T12:55:02.690-07:00'<br/>name: sharedloggingv2type<br/>operation:<br/>  endTime: '2018-06-26T12:55:04.301-07:00'<br/>  id: '4664553155367740665'<br/>  kind: deploymentmanager#operation<br/>  name: operation-1530042902553-56f90dfb2a1a8-5b28e068-54001af8<br/>  operationType: insert<br/>  progress: 100<br/>  startTime: '2018-06-26T12:55:02.947-07:00'<br/>  status: DONE<br/>  targetId: '6736148154336355577'<br/>  targetLink: <a class="ae jd" href="https://www.googleapis.com/deploymentmanager/v2beta/projects/compliance-logging-export/global/typeProviders/sharedloggingv2type" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/deploymentmanager/v2beta/projects/compliance-logging-export/global/typeProviders/sharedloggingv2type</a><br/>  user: <a class="ae jd" href="mailto:charles@baernation.com" rel="noopener ugc nofollow" target="_blank">charles@baernation.com</a><br/>selfLink: <a class="ae jd" href="https://www.googleapis.com/deploymentmanager/v2beta/projects/compliance-logging-export/global/typeProviders/sharedloggingv2type" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/deploymentmanager/v2beta/projects/compliance-logging-export/global/typeProviders/sharedloggingv2type</a></span></pre><h1 id="0717" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">第三步。构建YAML和金佳的配置文件。</h1><p id="d1e0" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">一旦创建了类型提供者，我就用它来创建部署管理器YAML文件。我将配置分成一个jinja模板和一个YAML文件，这样我就可以在其他YAML配置文件中重用jinja模板。这种方法允许我构建一个jinja模板库，我可以在我的YAML文件中使用它。这是我用过的<em class="kt">金佳</em> YAML的文件。</p><p id="4078" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kt">sink _ to _ GCS _ type _ provider . jinja:</em></p><pre class="ki kj kk kl fd ku kv kw kx aw ky bi"><span id="2d74" class="kz jf hi kv b fi la lb l lc ld">resources:<br/>- name:  {{ env["name"] }}<br/>  type: compliance-logging-export/sharedloggingv2type:organizations.sinks<br/>  properties:<br/>    parent: "{{ properties["parent"] }}"<br/>    uniqueWriterIdentity: {{ properties["uniqueWriterIdentity"] }}<br/>    name: {{ env["name"] }}<br/>    includeChildren: {{ properties["includechildren"] }}<br/>    outputVersionFormat: V2<br/>    destination: storage.googleapis.com/{{ properties["destination"] }}<br/>    filter: "{{ properties["filter"] }}"</span></pre><p id="05a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kt">sink _ type _ provider . YAML:</em></p><pre class="ki kj kk kl fd ku kv kw kx aw ky bi"><span id="a03a" class="kz jf hi kv b fi la lb l lc ld">imports: <br/>- path: sink_to_gcs_type_provider.jinja<br/>resources:<br/>- name: logging-sink-to-gcs<br/>  type: sink_to_gcs_type_provider.jinja<br/>  properties:<br/>    parent: "organizations/324989851234"<br/>    uniqueWriterIdentity: false<br/>    destination: gcp-org-sync-destination<br/>    filter:  'logName=\"/logs/cloudaudit.googleapis.com\" OR resource.type:\"gce\" OR resource.type=\"gcs_bucket\" OR resource.type=\"cloudsql_database\" OR resource.type=\"bigquery_resource\"' <br/>    includechildren: true</span></pre><h1 id="822c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">第四步。使用部署管理器。</h1><p id="5863" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">部署管理器使用项目的特定<a class="ae jd" href="https://cloud.google.com/deployment-manager/docs/access-control#access_control_for_deployment_manager" rel="noopener ugc nofollow" target="_blank">服务帐户</a>代表您执行命令。使用电子邮件可以识别服务帐户:</p><pre class="ki kj kk kl fd ku kv kw kx aw ky bi"><span id="9cc6" class="kz jf hi kv b fi la lb l lc ld">[PROJECT_NUMBER]@cloudservices.gserviceaccount.com</span></pre><p id="5b20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google APIs服务帐户被自动授予项目的编辑权限，但是我需要在组织级别添加IAM权限“<em class="kt">Logs Configuration Writer</em>”。我在控制台中添加了这个权限，如下图所示。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lf"><img src="../Images/a596330615a0eed5cd403d6994a9ae38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zi7J3b6513uImz7h6N3Cuw.png"/></div></div></figure><p id="3d1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建了类型提供者、部署管理器配置就绪并授予了IAM权限后，我执行了下面的gcloud命令行。</p><pre class="ki kj kk kl fd ku kv kw kx aw ky bi"><span id="6f48" class="kz jf hi kv b fi la lb l lc ld">gcloud beta deployment-manager deployments create org01 \<br/>  --config sink_type_provider.yaml</span><span id="753d" class="kz jf hi kv b fi le lb l lc ld">The fingerprint of the deployment is glReoqkjVxYCBcUiYkZD0g==<br/>Waiting for create [operation-1530103511980-56f9efc4d17e0-448fe1c7-88c56a9c]...done.                                                                                        <br/>Create operation operation-1530103511980-56f9efc4d17e0-448fe1c7-88c56a9c completed successfully.<br/>NAME                 TYPE                                                               STATE      ERRORS  INTENT<br/>logging-sink-to-gcs  compliance-logging-export/sharedloggingv2type:organizations.sinks  COMPLETED  []</span></pre><p id="6d76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我通过查看部署的结果来验证该命令是否成功。</p><pre class="ki kj kk kl fd ku kv kw kx aw ky bi"><span id="1618" class="kz jf hi kv b fi la lb l lc ld">gcloud beta deployment-manager deployments describe org01<br/><br/>fingerprint: i1EqFrvhmAA5_fcPbNmABA==<br/>id: '8898993182367169098'<br/>insertTime: '2018-06-27T05:35:49.206-07:00'<br/>manifest: manifest-1530102949238<br/>name: org01<br/>operation:<br/>  endTime: '2018-06-27T05:36:03.363-07:00'<br/>  name: operation-1530102948995-56f9edabe9fb9-210a870a-c006d6af<br/>  operationType: insert<br/>  progress: 100<br/>  startTime: '2018-06-27T05:35:49.786-07:00'<br/>  status: DONE<br/>  user: <a class="ae jd" href="mailto:charles@baernation.com" rel="noopener ugc nofollow" target="_blank">c@example.com</a></span></pre><p id="e7a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过列出组织同步，我验证了组织同步已成功创建。</p><pre class="ki kj kk kl fd ku kv kw kx aw ky bi"><span id="16f9" class="kz jf hi kv b fi la lb l lc ld">I verified that the organizational sync was successfully created by listing the organizational syncs.</span><span id="0f1c" class="kz jf hi kv b fi le lb l lc ld">gcloud logging sinks describe logging-sink-to-gcs \     <br/>    --organization="324989855333"</span><span id="3f78" class="kz jf hi kv b fi le lb l lc ld">destination: storage.googleapis.com/gcp-org-sync-destination<br/>includeChildren: true<br/>name: logging-sink-to-gcs<br/>outputVersionFormat: V2<br/>writerIdentity: serviceAccount:<a class="ae jd" href="mailto:o324989855333-777063@gcp-sa-logging.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">o324989855333-777063@gcp-sa-logging.iam.gserviceaccount.com</a></span></pre><p id="b031" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我使用上面返回的serviceAccount向GCS中的gcp-org-sync-destination bucket授予IAM权限“存储对象创建者”,这样sink就有适当的权限将日志写入目标。</p><p id="e03d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！这是一种强大的方法，可以将任何没有作为默认类型提供的GCP API、处于alpha或beta版本的GCP API，甚至您自己的API集成到deployment manager中。</p><p id="dd03" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考资料:</p><ul class=""><li id="3b1b" class="lg lh hi ih b ii ij im in iq li iu lj iy lk jc ll lm ln lo bi translated"><a class="ae jd" href="https://cloud.google.com/deployment-manager/docs/fundamentals" rel="noopener ugc nofollow" target="_blank">谷歌云部署管理器</a></li><li id="46cd" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><a class="ae jd" href="https://cloud.google.com/deployment-manager/docs/configuration/supported-resource-types" rel="noopener ugc nofollow" target="_blank">部署管理器资源类型</a></li><li id="c30b" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><a class="ae jd" href="https://cloud.google.com/deployment-manager/docs/configuration/type-providers/process-adding-api" rel="noopener ugc nofollow" target="_blank">部署管理器类型提供者</a></li><li id="6395" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><a class="ae jd" href="https://cloud.google.com/deployment-manager/docs/configuration/type-providers/api-requirements" rel="noopener ugc nofollow" target="_blank">部署管理器类型提供者需求</a></li><li id="b4c9" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><a class="ae jd" href="https://developers.google.com/discovery/" rel="noopener ugc nofollow" target="_blank">谷歌API发现服务</a></li><li id="eee7" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><a class="ae jd" href="https://cloud.google.com/solutions/design-patterns-for-exporting-stackdriver-logging" rel="noopener ugc nofollow" target="_blank">导出堆栈驱动日志的设计模式</a></li><li id="ddb5" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><a class="ae jd" href="https://cloud.google.com/logging/docs/reference/v2/rest/" rel="noopener ugc nofollow" target="_blank">谷歌云日志API </a></li></ul></div></div>    
</body>
</html>