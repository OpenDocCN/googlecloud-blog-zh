<html>
<head>
<title>Configure DAG-level Permissions in Cloud Composer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Cloud Composer中配置DAG级权限</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/configure-dag-level-permissions-in-cloud-composer-230368b152fe?source=collection_archive---------1-----------------------#2022-12-02">https://medium.com/google-cloud/configure-dag-level-permissions-in-cloud-composer-230368b152fe?source=collection_archive---------1-----------------------#2022-12-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/5e40c6f093cc738f1a798523604f6a35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*ZDKPjOjlKo4-VIhxTx0xwA.png"/></div></figure><p id="6710" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Cloud Composer通过向用户授予角色和权限，使用<a class="ae jk" href="https://cloud.google.com/composer/docs/how-to/access-control" rel="noopener ugc nofollow" target="_blank">身份和访问管理(IAM) </a>进行访问控制。一旦用户拥有足够的IAM权限来访问Cloud Composer环境，他们就可以访问该环境中默认可用的所有Dag。但是在大多数情况下，我们并不希望每个用户都能访问所有可用的Dag。例如，一些用户不想让其他用户运行他们的Dag或查看敏感信息等。</p><p id="523e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在本帖中，首先我们将回顾如何使用Cloud Composer和Airflow RBAC来创建Airflow自定义角色并将其分配给用户，从而实现对Airflow DAGs的访问控制。稍后我们将讨论这种方法的局限性，以及“每文件夹角色注册”如何解决这个问题。</p><h2 id="d7c8" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">气流RBAC</h2><p id="7920" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">气流RBAC是一个内置于气流中的模型，允许在气流UI和气流API中管理权限、用户和角色。它允许配置用户可以访问哪些Dag，以及允许哪些操作(读/编辑/删除)。</p><p id="e9ee" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">从气流1.10开始，气流引入了带有<a class="ae jk" href="https://airflow.apache.org/docs/apache-airflow/stable/security/access-control.html#default-roles" rel="noopener ugc nofollow" target="_blank">预建角色</a>的气流RBAC，以便于访问控制Dag。但是它有一个限制，即它只支持5个默认角色。但是后来在<a class="ae jk" href="https://airflow.apache.org/docs/apache-airflow/stable/release_notes.html#airflow-1-10-2-2019-01-19" rel="noopener ugc nofollow" target="_blank">气流1.10.2 </a>中，气流RBAC扩展到支持DAG级别ACL。</p><h2 id="1e94" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">先决条件</h2><p id="ba53" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">要访问Cloud Composer中的Airflow UI，用户必须在<a class="ae jk" href="https://cloud.google.com/iam/docs/understanding-roles#composer.user" rel="noopener ugc nofollow" target="_blank"> <em class="kl"> Cloud IAM </em> </a>中被授予适当的访问角色。</p><h2 id="9142" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated"><strong class="ak">使用气流RBAC配置DAG级权限</strong></h2><p id="5460" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">每次新用户第一次打开Cloud Composer环境的Airflow UI时，该用户都会自动在Airflow RBAC中注册。</p><p id="cf3b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">用户在Cloud Composer的气流RBAC中自动注册的默认角色是<a class="ae jk" href="https://airflow.apache.org/docs/apache-airflow/stable/security/access-control.html#op" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj"> Op </strong> </a>，这允许用户查看所有可用的Dag。</p><blockquote class="km kn ko"><p id="d0a9" class="im in kl io b ip iq ir is it iu iv iw kp iy iz ja kq jc jd je kr jg jh ji jj hb bi translated"><a class="ae jk" href="https://cloud.google.com/iam/docs/understanding-roles#composer.admin" rel="noopener ugc nofollow" target="_blank">需要Composer管理员</a> IAM权限来覆盖气流配置、添加新角色以及向用户分配任何角色。</p></blockquote><p id="8782" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们可以使用Airflow RBAC自定义角色添加每个DAG的权限，然后将这些角色分配给用户，从而将用户限制在特定DAG。有两种方法可以实现这一点:</p><ol class=""><li id="3503" class="ks kt hi io b ip iq it iu ix ku jb kv jf kw jj kx ky kz la bi translated"><a class="ae jk" href="https://airflow.apache.org/docs/apache-airflow/stable/security/access-control.html#custom-roles" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj"> <em class="kl">在气流UI </em> </strong> </a>中添加一个新的自定义角色，允许用户读取/编辑/删除某些Dag。</li><li id="a394" class="ks kt hi io b ip lb it lc ix ld jb le jf lf jj kx ky kz la bi translated">通过DAG本身的<a class="ae jk" href="https://cloud.google.com/composer/docs/airflow-rbac#dag-permissions-property" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj"> <em class="kl">访问控制属性</em> </strong> </a>指定角色和权限如下图所示:</li></ol><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lg"><img src="../Images/84f0e6e10c3f530f71698c7ae27a7e96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VEGB8RSSpecH-U5_wWg6gg.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">在DAG代码中添加访问控制属性</figcaption></figure><p id="4a93" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">限制<br/> </strong>这种方法将限制用户使用特定的Dag。在有许多Dag和角色的情况下，跨所有Dag维护一致的配置、向用户分配适当的角色可能是繁重的，并且可能导致错误。</p><p id="ac6b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在下一节中，我们将介绍实现DAG级别权限的另一种方法，这种方法可以减少开销，并介绍在Cloud Composer中配置它的步骤。</p><h2 id="f989" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">使用每个文件夹的角色注册配置DAG级别的权限</h2><p id="0085" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated"><a class="ae jk" href="https://cloud.google.com/composer/docs/composer-2/airflow-rbac#how_per-folder_roles_registration_works" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj">每文件夹角色注册</strong> </a> <strong class="io hj"> </strong>是一种自动配置角色及其DAG级权限的方式。在这种方法中，dag被分组到位于<em class="kl">/Dag</em>文件夹中的子文件夹中。这将在气流RBAC中为位于/dags文件夹中的每个子文件夹自动创建一个新角色，并授予此角色对该子文件夹中所有DAG的DAG级访问权限。以下是开始的方法:</p><blockquote class="km kn ko"><p id="3464" class="im in kl io b ip iq ir is it iu iv iw kp iy iz ja kq jc jd je kr jg jh ji jj hb bi translated">Composer 1:在Cloud Composer 1.18.12和更高版本的Airflow 2中，以及在Cloud Composer 1.13.4和更高版本的Airflow 1中，可以进行基于文件夹的角色注册。<br/>Composer 2:Cloud Composer 2 . 0 . 16及更高版本中提供了基于文件夹的角色注册。(<a class="ae jk" href="https://cloud.google.com/composer/docs/airflow-rbac#before_you_begin" rel="noopener ugc nofollow" target="_blank">来源</a>)</p></blockquote><p id="0a97" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">进入<strong class="io hj"> <em class="kl">导航</em> </strong>菜单- &gt; <strong class="io hj"> <em class="kl">作曲</em> </strong></p><p id="4f87" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">选择您的<strong class="io hj"> <em class="kl"> Composer环境</em> </strong> - &gt;转到“<strong class="io hj"> <em class="kl">气流配置覆盖</em> </strong>”选项卡。</p><p id="93a0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">添加如下所示的配置:</p><ul class=""><li id="2eb0" class="ks kt hi io b ip iq it iu ix ku jb kv jf kw jj lt ky kz la bi translated">将<strong class="io hj">段</strong>设置为<strong class="io hj"> <em class="kl"> webserver </em> </strong>，<strong class="io hj"> key </strong>设置为<strong class="io hj"><em class="kl">RBAC _ auto register _ per _ folder _ roles</em></strong>和<strong class="io hj"> value </strong>设置为<strong class="io hj"> <em class="kl"> True </em> </strong>。</li><li id="0efd" class="ks kt hi io b ip lb it lc ix ld jb le jf lf jj lt ky kz la bi translated">将<strong class="io hj">节</strong>设置为<strong class="io hj"> <em class="kl"> webserver </em> </strong>，<strong class="io hj"> key </strong>设置为<strong class="io hj"><em class="kl">RBAC _ user _ registration _ role</em></strong>和<strong class="io hj"> value </strong>设置为<strong class="io hj"> <em class="kl"> UserNoDags </em> </strong>。</li></ul><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lu"><img src="../Images/4fe1bf79c067be37635903925ddcffda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5dbZMI4HqJsAJ0MhYy4VEg.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">在Cloud composer中覆盖气流配置</figcaption></figure><p id="c86f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦<strong class="io hj"><em class="kl">RBAC _ User _ registration _ role</em></strong>更新为<strong class="io hj"><em class="kl">UserNoDags:</em></strong>Cloud Composer自动创建<em class="kl"> UserNoDags </em>角色，它相当于<a class="ae jk" href="https://airflow.apache.org/docs/apache-airflow/stable/security/access-control.html#user" rel="noopener ugc nofollow" target="_blank"> <em class="kl"> User </em> </a>角色，但无权访问任何Dag。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lv"><img src="../Images/59d3f1ec3ad291a6ccd97eef65cdc044.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ywxvp02rF1deq5g0DonFsA.png"/></div></div></figure><p id="f411" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，当新用户第一次打开Cloud Composer环境的Airflow UI时，他们会自动使用<em class="kl"> UserNoDags </em>而不是<em class="kl"> Op </em>进行注册，因此默认情况下没有任何Dag的权限。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lw"><img src="../Images/656030272f69bf334f39cca713410003.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HAP4gwEi_3alqH0fGNXMJA.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">添加了具有UserNoDags角色的新用户</figcaption></figure><p id="0fa8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">将<strong class="io hj"><em class="kl">RBAC _ auto register _ per _ folder _ roles</em></strong>更新为<strong class="io hj"><em class="kl">True:</em></strong>Cloud Composer基于DAGs子文件夹自动创建角色。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lx"><img src="../Images/c1f176092729b35a75a410bab09b9047.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tMAUfRIXsicx3ZnyqLsOYQ.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">在/dags中添加的子文件夹</figcaption></figure><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es ly"><img src="../Images/97149b306009bb1d2cc882e52b61f296.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ggc6x6GEwKo2erwiYN_Jrg.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">为每个子文件夹添加的角色</figcaption></figure><blockquote class="km kn ko"><p id="55a8" class="im in kl io b ip iq ir is it iu iv iw kp iy iz ja kq jc jd je kr jg jh ji jj hb bi translated"><strong class="io hj">顺便提一下</strong>，使用Dag创建子文件夹的用户不会自动获得相应的每个文件夹的角色。例如，如果用户创建了一个名为<strong class="io hj"> gcs_to_pubsub </strong>的子文件夹，他们的帐户不会获得<strong class="io hj"> gcs_to_pubsub </strong>角色。管理员必须在Airflow UI中授予此角色。</p></blockquote><p id="95dc" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最后一步是将这些每个文件夹的角色分配给相应的用户。只有具有管理员访问权限的用户才能向其他用户授予任何角色。可以通过Airflow UI或CLI分配角色。</p><p id="6952" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">进入<strong class="io hj"> <em class="kl">气流UI </em> </strong> - &gt; <strong class="io hj"> <em class="kl">安全</em>-</strong>-&gt;<strong class="io hj"><em class="kl">列表用户</em> </strong></p><p id="ca87" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">编辑用户并分配所需的角色。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lz"><img src="../Images/01d29d787340fead4d4eac002010573f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pNQAk8LeIeMthsNdJrbsdQ.png"/></div></div></figure><pre class="lh li lj lk fd ma mb mc bn md me bi"><span id="5a57" class="mf jm hi mb b be mg mh l mi mj">gcloud composer environments run &lt;ENVIRONMENT_NAME&gt; \<br/>--location &lt;LOCATION&gt; \<br/>users add-role -- -e &lt;USER_EMAIL&gt; -r &lt;ROLE_NAME&gt;</span></pre><p id="7c67" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦用户被分配了相应的基于子文件夹的角色，他们将只能看到属于该子文件夹的Dag。而具有管理员访问权限的用户可以查看所有Dag。</p><h2 id="63ab" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">结论</h2><p id="fbab" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">在本文中，我们看到了使用气流RBAC在Cloud Composer中配置DAG级别权限的不同方法及其局限性。然后，我们还讨论了每个文件夹的角色注册如何解决这个问题，以及我们如何使用它来管理DAG级别的访问控制。</p><h2 id="9f00" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">参考</h2><ul class=""><li id="796d" class="ks kt hi io b ip kg it kh ix mk jb ml jf mm jj lt ky kz la bi translated"><a class="ae jk" href="https://cloud.google.com/composer/docs/airflow-rbac#airflow-2" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/composer/docs/air flow-RBAC # air flow-2</a></li><li id="91e1" class="ks kt hi io b ip lb it lc ix ld jb le jf lf jj lt ky kz la bi translated"><a class="ae jk" href="https://cloud.google.com/composer/docs/overriding-airflow-configurations" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/composer/docs/overriding-air flow-configuration s</a></li></ul><p id="a91b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">希望你喜欢这篇文章，并发现它有用。你可以通过<a class="ae jk" href="http://www.linkedin.com/in/sunny-arora-2210" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系到我。</p></div></div>    
</body>
</html>