<html>
<head>
<title>Running a serverless batch workload on GCP with Cloud Scheduler, Cloud Functions, and Compute Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用云调度程序、云功能和计算引擎在GCP上运行无服务器批处理工作负载</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/running-a-serverless-batch-workload-on-gcp-with-cloud-scheduler-cloud-functions-and-compute-86c2bd573f25?source=collection_archive---------0-----------------------#2019-08-16">https://medium.com/google-cloud/running-a-serverless-batch-workload-on-gcp-with-cloud-scheduler-cloud-functions-and-compute-86c2bd573f25?source=collection_archive---------0-----------------------#2019-08-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7404" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本快速入门指南是一个系列的一部分，展示了如何利用Google云平台组件以更简单的方式运行批处理工作负载。熟悉AWS的人，有一个很棒的工具叫做<a class="ae jd" href="https://aws.amazon.com/batch/" rel="noopener ugc nofollow" target="_blank"> AWS Batch </a>，但是看看GCP的产品，我们如何能够以类似的方式运行批处理作业呢？<br/>让我们深入研究GCP文档:<a class="ae jd" href="https://cloud.google.com/docs/compare/aws/" rel="noopener ugc nofollow" target="_blank"> aws-comparison </a></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/9b14be3abaadeee6e0a7118ac9b57728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3TKqNsGGtlcXXicrHVL0lA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图一。AWS和GCP服务比较</figcaption></figure><p id="e191" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更深入地看文档…GCP推荐的完成这个用例的方法是:<a class="ae jd" href="https://cloud.google.com/solutions/reliable-task-scheduling-compute-engine" rel="noopener ugc nofollow" target="_blank">可靠-任务-调度-计算-引擎</a> <br/>快速总结:<strong class="ih hj">云调度器- &gt;发布/订阅- &gt;启动虚拟机</strong></p><p id="7a8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">文档中引用了一个启动和停止虚拟机的示例:<a class="ae jd" href="https://cloud.google.com/scheduler/docs/start-and-stop-compute-engine-instances-on-a-schedule" rel="noopener ugc nofollow" target="_blank">按计划启动和停止计算引擎实例</a></p><p id="12c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是这种方法有一个缺陷，在批处理工作负载完成后，虚拟机不会被删除，因此我们要支付存储成本。我们如何才能让它更高效，变成一个更加<strong class="ih hj">无服务器</strong>的解决方案？</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ju"><img src="../Images/6d4bf3f5c943e5d28e054b94455594b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/1*YfSt8_Cy_ZD1Ak65AnGdTA.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图二。有人举手提问</figcaption></figure><p id="aa1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">等等，你怎么能在同一个句子里谈论VM和serverless呢？有些东西闻起来有鱼腥味…</p><p id="69be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">的确如此，但这些问题很快就会得到解答，所以请继续关注我…</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es jv"><img src="../Images/bda6b8c0c175df15811e7156aa914d64.png" data-original-src="https://miro.medium.com/v2/resize:fit:452/1*pkhAgPBiLcpAko3tXu496Q.gif"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图3。吃爆米花的家伙</figcaption></figure></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><p id="d20e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我介绍一下我们将使用的解决方案，它使用<strong class="ih hj"> GCP </strong>组件，使批处理执行更加<strong class="ih hj">无服务器化</strong>:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kd"><img src="../Images/f361cb8b3f20af88d7fd32357addd85b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qahrk_AJlVAVe3giCse2vA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图4。预定批处理体系结构</figcaption></figure><blockquote class="ke kf kg"><p id="6bca" class="if ig kh ih b ii ij ik il im in io ip ki ir is it kj iv iw ix kk iz ja jb jc hb bi translated"><em class="hi">顺便说一下，将在本解决方案中使用的所有</em><strong class="ih hj"><em class="hi">GCP</em></strong><em class="hi">组件都有一个自由层=) </em></p></blockquote><h1 id="f26b" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">1 —云调度程序</h1><p id="5039" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">这是我们批处理过程的起点:</p><p id="6c4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kh">“云调度器是一款完全托管的企业级cron作业调度器。它允许您安排几乎任何作业，包括批处理、大数据作业、云基础架构操作等。您可以自动化一切，包括失败时的重试，以减少人工劳动和干预。Cloud Scheduler甚至可以作为单一平台，让您从一个位置管理所有自动化任务。”</em></p><p id="fdb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">进入<a class="ae jd" href="https://console.cloud.google.com/cloudschedule" rel="noopener ugc nofollow" target="_blank">页面</a>开始你的云调度配置。</p><p id="8852" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要配置我们的起点，我们需要开始创建云计划程序作业，这非常简单:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lo"><img src="../Images/2c27114f58ef7703cd276bbbc35725b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/1*iLOdgZII70jDxcDzhguzEQ.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图5。创建云计划程序作业</figcaption></figure><p id="8470" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里的重要字段有<strong class="ih hj">名称、频率、时区、目标、</strong>和<strong class="ih hj">主题</strong>。<strong class="ih hj"> </strong>现在，我们不需要担心有效负载，只需要在那里留下一个空的JSON，因为这个字段是必需的。</p><p id="89a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意<strong class="ih hj">时区</strong>和<strong class="ih hj">频率</strong>的cron表达式，这就是你的<strong class="ih hj">目标</strong>将被执行的时间。</p><p id="0abc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为<strong class="ih hj">目标，</strong>我们将使用<strong class="ih hj"> Pub/Sub </strong>和<strong class="ih hj"> </strong>当我们按<strong class="ih hj"> Create </strong>、<strong class="ih hj">T21时，我们将看到我们的调度作业信息:</strong></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lp"><img src="../Images/0656efbec9b086bf9606b0a14671fa02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pqX9y8CSXplQy5nO2GUlhQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图6。已创建云计划程序</figcaption></figure><p id="ec6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">借助云计划程序，您甚至可以使用<em class="kh">“立即运行”</em>选项手动触发<strong class="ih hj"> Target </strong>执行，但立即运行将返回错误。<strong class="ih hj">执行-批处理</strong>主题还不存在，我们来修正一下……</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="ce4b" class="kl km hi bd kn ko lq kq kr ks lr ku kv kw ls ky kz la lt lc ld le lu lg lh li bi translated">2 —发布/订阅</h1><p id="7403" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">我们将通过创建Pub/Sub主题来修复该错误，它将作为我们的中介:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lv"><img src="../Images/775bfb2cb7f1f87590b3747af9f5cc19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AKYtnSOYCXXPxVaJDkIKGA.jpeg"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图7。Pub/Sub主题充当中间人</figcaption></figure><p id="7980" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kh">“Cloud Pub/Sub是一个完全管理的实时消息服务，允许您在独立应用程序之间发送和接收消息。”</em></p><p id="a92a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到<a class="ae jd" href="https://console.cloud.google.com/cloudpubsub" rel="noopener ugc nofollow" target="_blank">此页面</a>启动Pub/Sub配置。</p><p id="e8c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建Pub/Sub主题就像填写主题名称一样简单！</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lw"><img src="../Images/87a50c24bb15aa2cac28f27454b8dde9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_YXdg0a5po0J0lW_2lma9Q.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图8。创建发布/子主题</figcaption></figure><p id="eb84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们按下<strong class="ih hj"> Create Topic </strong>时，我们的Pub/Sub <strong class="ih hj"> </strong>协调器已经准备好为下一个组件提供支持。</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="1b60" class="kl km hi bd kn ko lq kq kr ks lr ku kv kw ls ky kz la lt lc ld le lu lg lh li bi translated">3 —执行</h1><h2 id="bbb9" class="lx km hi bd kn ly lz ma kr mb mc md kv iq me mf kz iu mg mh ld iy mi mj lh mk bi translated">云功能将是一个达到Pub/Sub的手！</h2><p id="cf8a" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated"><em class="kh">“Google Cloud Functions是一款轻量级计算解决方案，可让开发人员创建响应Cloud事件的单一用途独立函数，而无需管理服务器或运行时环境。”</em></p><p id="6aff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以，我们来修改一下……一旦<strong class="ih hj">云调度器</strong>被触发，它就会向<strong class="ih hj"> Pub/Sub </strong>主题发布一条消息，启动<strong class="ih hj">云功能</strong>。</p><p id="d651" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们的<strong class="ih hj">云功能</strong>将创建一个<strong class="ih hj">计算引擎虚拟机</strong>，负责运行我们的批处理工作负载。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ml"><img src="../Images/191d53c4cf2e0c9f43f279d8205ca2dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1154/format:webp/1*ail7U35beSAym8tPCvC5cw.jpeg"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图9。给我看看代码迷因</figcaption></figure><p id="9d26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我们将用于运行Cloud Function的代码。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mm mn l"/></div></figure><p id="5824" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，我们使用的是<code class="du mo mp mq mr b">@google-cloud/compute</code>客户端库，这是我们执行引擎的核心，方法<code class="du mo mp mq mr b">createInstance</code>负责启动运行我们批处理进程的机器。<code class="du mo mp mq mr b">vmConfig</code>属性将包含我们虚拟机工作负载的所有指令，让我们深入研究一下…</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h2 id="c428" class="lx km hi bd kn ly lz ma kr mb mc md kv iq me mf kz iu mg mh ld iy mi mj lh mk bi translated">计算引擎</h2><p id="8ec7" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">对于我们的VM工作负载，我们选择了一个非常简单的用例，它向Stackdriver Logging发送“Hello World”消息。</p><p id="9123" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kh">“stack driver Logging允许您存储、搜索、分析、监控和警告来自Google Cloud Platform和Amazon Web Services (AWS)的日志数据和事件。我们的API还允许从任何来源获取任何定制日志数据。Stackdriver日志记录是一项完全托管的服务，可大规模执行，并可从数千个虚拟机接收应用程序和系统日志数据。更好的是，您可以实时分析所有日志数据。”</em></p><p id="0a39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看虚拟机将要执行的代码:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mm mn l"/></div></figure><p id="9852" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本上，我们在这里做3件事…</p><p id="6e50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第1行:向Stackdriver Logging <strong class="ih hj"> </strong>发送我们的“Hello World”消息，并告诉它写入<code class="du mo mp mq mr b">batch-execution</code>键，以便我们稍后可以跟踪它。</p><p id="f445" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第2行:从内部元数据端点检索下一行需要的<code class="du mo mp mq mr b">gcp_zone</code>。</p><blockquote class="ke kf kg"><p id="043c" class="if ig kh ih b ii ij ik il im in io ip ki ir is it kj iv iw ix kk iz ja jb jc hb bi translated">要了解更多关于<strong class="ih hj">检索实例元数据</strong>的信息，请访问官方<a class="ae jd" href="https://cloud.google.com/compute/docs/storing-retrieving-metadata" rel="noopener ugc nofollow" target="_blank">文档</a>。</p></blockquote><p id="5806" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第3行:</p><blockquote class="ke kf kg"><p id="0397" class="if ig kh ih b ii ij ik il im in io ip ki ir is it kj iv iw ix kk iz ja jb jc hb bi translated">知道虚拟机执行完毕的最佳演员是谁？那就是虚拟机本身！</p></blockquote><p id="1f98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里，我们在完成批处理工作负载后删除虚拟机。这就是我们如何使它成为无服务器的，或者尽可能接近的。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ms"><img src="../Images/03d16dd056bd8adf4783f161e5f19b81.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/1*_pGj3DixmBImxcAl_HWWdA.gif"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图10。一个激动人心的时刻</figcaption></figure><p id="e697" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">听起来不错，但是我们如何将该脚本放入虚拟机中，然后在我们的云功能上配置它呢？</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><p id="e048" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到<a class="ae jd" href="https://console.cloud.google.com/compute" rel="noopener ugc nofollow" target="_blank">此页面</a>启动您的计算引擎配置。</p><p id="0163" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到用户界面，我们将输入以下字段:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mt"><img src="../Images/5b4c90d711a79631d37d9916d4475490.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5nfvZphjQmAFwgtcgoIw7Q.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图11。计算引擎配置第1部分</figcaption></figure><blockquote class="ke kf kg"><p id="e3e4" class="if ig kh ih b ii ij ik il im in io ip ki ir is it kj iv iw ix kk iz ja jb jc hb bi translated">注意:记住使用一个<strong class="ih hj"> f1微实例</strong>，因为它有一个空闲层。</p></blockquote><p id="2392" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上图中，一切都保留默认值，我们将选择一个名为<strong class="ih hj">Compute-execute-batch-job</strong>的预配置服务帐户，这很重要，因为默认服务帐户没有删除计算引擎虚拟机的正确权限。</p><p id="3b47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看看服务帐户是如何配置的，最佳做法是仅添加这种工作负载所需的角色:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mu"><img src="../Images/6ee772ec8043cc3cb33c63cb64b722bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FWC7Q4IIjUulSafwW0_SoQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图12。具有自定义角色的服务帐户</figcaption></figure><p id="8c0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是如何使用<strong class="ih hj"> gcloud </strong>命令行创建服务帐户，您也可以使用<a class="ae jd" href="https://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank">云控制台</a>来完成此操作。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mm mn l"/></div></figure><blockquote class="ke kf kg"><p id="46bc" class="if ig kh ih b ii ij ik il im in io ip ki ir is it kj iv iw ix kk iz ja jb jc hb bi translated">要了解更多关于<strong class="ih hj">服务账户</strong>和<strong class="ih hj">角色</strong>的信息，请访问官方<a class="ae jd" href="https://cloud.google.com/compute/docs/access/service-accounts" rel="noopener ugc nofollow" target="_blank">文档</a>。</p></blockquote><p id="0557" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在服务帐户之后，向下滚动我们的计算引擎UI，我们有一个启动脚本<strong class="ih hj"> </strong>字段<strong class="ih hj"> </strong>，我们将在其中粘贴我们的工作负载脚本:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mv"><img src="../Images/280d841f9e47a1bc14d308243ecdd019.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cZTTE-ufbo3yZiZDieT-Og.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图13。计算引擎配置第2部分</figcaption></figure><p id="0917" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">记住一件事，是<strong class="ih hj">云函数</strong>要创建我们的虚拟机，所以我们不会点击<strong class="ih hj"> </strong>创建命令，而是点击上面图片中的<strong class="ih hj"> REST </strong>选项。</p><p id="b027" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过这样做，它将向我们展示可以在API调用中使用的完整JSON:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mw"><img src="../Images/1b57a2148118045d7ef564ae8b7c9fb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wdZ01F__5S5VTf1Nkz_FEA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图14。计算引擎等效剩余命令</figcaption></figure><p id="a461" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经有了用VM配置包装云函数<strong class="ih hj"> </strong>所需的东西，让我们回过头来用REST调用中的JSON更新它:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mm mn l"/></div></figure><blockquote class="ke kf kg"><p id="3130" class="if ig kh ih b ii ij ik il im in io ip ki ir is it kj iv iw ix kk iz ja jb jc hb bi translated"><em class="hi">注意:JSON中的一些字段可以被删除以使用默认值，所以它变得更小了，但是我想展示它是多么简单，你只需复制和粘贴即可。</em></p></blockquote><p id="3ca4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">记住从JSON属性的键中去掉双引号，并确保在属性<code class="du mo mp mq mr b">vmConfig</code>中使用的区域值与第5行中的<code class="du mo mp mq mr b">const zone</code>相同。同样，替换<code class="du mo mp mq mr b">const projectId</code>来使用你的项目。</p><p id="027b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们快到了！我们现在只需要部署我们的<strong class="ih hj">云函数</strong>并将其连接到<strong class="ih hj">发布/订阅</strong>主题，让我们使用UI来完成。</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><p id="cd69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">进入<a class="ae jd" href="https://console.cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">本页面</a>开始您的云功能配置。</p><p id="761a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看用户界面:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mx"><img src="../Images/c0bb1536250fddc53f26be979f9b860c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4MXndSzwLTBYJR-Kg251rA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图15。云功能UI</figcaption></figure><p id="27d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们主要有3个重要的字段:Trigger、Index.js和要执行的函数。</p><p id="728f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">触发器:这里我们可以选择选项来调用云函数，我们将选择我们的Pub/Sub主题<strong class="ih hj"> </strong> <code class="du mo mp mq mr b">execute-batch-process</code>。</p><p id="da3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Index.js tab:这个字段包含了调用云函数时将要执行的代码，所以在这里粘贴<code class="du mo mp mq mr b">create_instance_function</code>代码。</p><p id="fac8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要执行的函数:<strong class="ih hj"> </strong>使用<strong class="ih hj"> </strong>云函数运行时将被调用的方法的名称，<code class="du mo mp mq mr b">createInstance</code>。</p><p id="e6e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一件有时被遗忘的小事，因为Google Cloud通过云功能为我们管理一切，我们还需要像标准NodeJS应用程序一样提供<code class="du mo mp mq mr b">package.json</code>,因为我们在这种情况下使用javascript。</p><p id="03de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">代码如下:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mm mn l"/></div></figure><p id="c919" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将它添加到<strong class="ih hj"> package.json </strong>选项卡中:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es my"><img src="../Images/88c8bc3b4ef02a201ba3085fb87428bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:816/format:webp/1*jbWIz2sz_G7cEy6BMon6qw.png"/></div></figure><p id="59f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了成为好公民，我们将再次遵循最佳实践，并使用仅具有所需权限的服务帐户:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mz"><img src="../Images/68d517c7d1ea73496c412a68236f5b09.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/1*6W6hxYkQiGNtIr9KwXESqg.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图17。显示选定的服务帐户</figcaption></figure><p id="03e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">服务帐户<code class="du mo mp mq mr b">function-create-vm</code>配置了一个<strong class="ih hj">服务帐户用户角色</strong>和一个<strong class="ih hj">自定义角色</strong>，包含以下权限:</p><ul class=""><li id="8bc6" class="na nb hi ih b ii ij im in iq nc iu nd iy ne jc nf ng nh ni bi translated">计算.磁盘.创建</li><li id="635a" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated">compute . instances . addaccess config</li><li id="3248" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated">compute.instances.attachDisk</li><li id="040a" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated">计算.实例.创建</li><li id="1dd2" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated">compute.instances.setMetadata</li><li id="8a4a" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated">compute . instances . setserviceaccount</li><li id="1f4b" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated">compute.subnetworks.use</li><li id="9e61" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated">compute . subnetworks . useexternalip</li></ul><p id="b2fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好了，现在我们可以按<strong class="ih hj">创建</strong>😄，我们准备一起测试一切！</p><p id="72af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们会看到这样的情况:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es no"><img src="../Images/eb4c9fc81f8b6dab7551876419713a95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QYe_SYlGLO4_tuIWc4Oz_Q.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图18。成功创建云功能</figcaption></figure><p id="178d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我喜欢看到✔️的图标！</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><p id="6661" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们现在回到我们的<a class="ae jd" href="https://console.cloud.google.com/cloudscheduler" rel="noopener ugc nofollow" target="_blank">云调度作业</a>，并手动触发它，我们可以看到一切都在一起工作。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es np"><img src="../Images/b2b9745dbb71ffe418db36a939824713.png" data-original-src="https://miro.medium.com/v2/resize:fit:688/1*HChDmaUFBcqct2QqcWRb0Q.gif"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图19。引擎运行</figcaption></figure><p id="31c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几秒钟后转到计算引擎<a class="ae jd" href="https://console.cloud.google.com/compute" rel="noopener ugc nofollow" target="_blank">页面</a>，你会看到一个新的虚拟机正在运行，前缀为<strong class="ih hj">批处理-作业-执行器</strong>，后跟执行时间，这是一个小技巧，所以我们总是有一个唯一的名称，如果我们以后需要跟踪问题。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es nq"><img src="../Images/619f09a946aa15a7a2868bbd3a3996ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t9qWs-KsVupFSQZy_IVKDw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图20。正在创建虚拟机</figcaption></figure><p id="f081" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几秒钟后，您会看到虚拟机名称前的图标发生了变化，这是因为虚拟机正在被删除，一旦删除完成，虚拟机将从实例页面中消失。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es nr"><img src="../Images/94438b79f9201f0688c7f121ddf7be66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9b0BuG7WErvuU-PtL2X03g.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图21。正在删除的虚拟机</figcaption></figure><p id="4681" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，为了确保它确实做了一些事情，我们将堆栈驱动日志<a class="ae jd" href="https://console.cloud.google.com/logs" rel="noopener ugc nofollow" target="_blank">页面</a>，当我们过滤<code class="du mo mp mq mr b">batch-execution</code>键时，我们可以看到我们的<strong class="ih hj"> Hello World </strong>消息！👌🏻</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ns"><img src="../Images/8be2a890d7b5ab739a641a9771312b47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dafOkxphZSJCNQ3xKojPuw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图22。Stackdriver日志显示Hello World消息</figcaption></figure><blockquote class="ke kf kg"><p id="7130" class="if ig kh ih b ii ij ik il im in io ip ki ir is it kj iv iw ix kk iz ja jb jc hb bi translated">请记住，该批处理工作负载将根据以Chould scheduler<strong class="ih hj">频率</strong>编程的cron表达式按计划运行。</p></blockquote><h1 id="6616" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">今天就到这里吧！</h1><p id="dd70" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">这是展示如何使用Google云平台以更简单的方式运行批量工作负载的系列文章的第一篇。需要指出的是，我们在这里使用了计算引擎，但您也可以使用其他组件运行批处理，如带任务队列的应用引擎、GKE和GCP计算家族云运行的最新成员。</p><p id="cfa5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我们展示了一个非常简单的批处理工作负载来帮助您开始，为了使它无服务器，我们确保在它完成执行后删除了虚拟机。想想看，我们使用了其他无服务器组件，如云调度程序、发布/订阅和云功能，唯一的区别是GCP在管理资源，并为我们创建和删除这些资源……引用我一个朋友的话:<em class="kh">“无服务器解决方案永远不会是无服务器的。幕后总有一个服务器……”</em></p><p id="deda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢您的宝贵时间！请继续关注下一篇文章，我们将展示一个更复杂的工作负载，向这个解决方案添加Docker和容器注册表。干杯！</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><p id="5520" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[更新]第2部分已发布:</p><p id="3a5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/serverless-batch-workload-on-gcp-adding-docker-and-container-registry-to-the-mix-558f925e1de1">将Docker和集装箱注册添加到组合中</a></p><p id="9d45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[更新]谷歌宣布<a class="ae jd" href="https://cloud.google.com/workflows" rel="noopener ugc nofollow" target="_blank">无服务器工作流程</a></p><h1 id="59ff" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">参考</h1><ul class=""><li id="d315" class="na nb hi ih b ii lj im lk iq nt iu nu iy nv jc nf ng nh ni bi translated"><strong class="ih hj">面向AWS专业人员的谷歌云平台</strong>:<a class="ae jd" href="https://cloud.google.com/docs/compare/aws/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/docs/compare/aws/</a></li><li id="4efe" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated"><strong class="ih hj">具有云调度器的计算引擎上的可靠任务调度</strong>:<a class="ae jd" href="https://cloud.google.com/solutions/reliable-task-scheduling-compute-engine" rel="noopener ugc nofollow" target="_blank">https://Cloud . Google . com/solutions/Reliable-task-scheduling-Compute-Engine</a></li><li id="d333" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated"><strong class="ih hj">谷歌云平台免费层</strong>:<a class="ae jd" href="https://cloud.google.com/free/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/free/</a></li><li id="c155" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated"><strong class="ih hj">云调度快速入门</strong>:<a class="ae jd" href="https://cloud.google.com/scheduler/docs/quickstart" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/scheduler/docs/quickstart</a></li><li id="9cee" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated"><strong class="ih hj">发布/订阅文档</strong>:<a class="ae jd" href="https://cloud.google.com/pubsub/docs/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/pubsub/docs/</a></li><li id="a1fb" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated"><strong class="ih hj">云函数文档</strong>:<a class="ae jd" href="https://cloud.google.com/functions/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/functions/</a></li><li id="4b51" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated"><strong class="ih hj">计算引擎文档</strong>:【https://cloud.google.com/compute/ T2】</li><li id="ec14" class="na nb hi ih b ii nj im nk iq nl iu nm iy nn jc nf ng nh ni bi translated">https://cloud.google.com/logging/<strong class="ih hj">堆栈驱动测井文件</strong>:<a class="ae jd" href="https://cloud.google.com/logging/" rel="noopener ugc nofollow" target="_blank">T7】</a></li></ul></div></div>    
</body>
</html>