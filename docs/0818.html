<html>
<head>
<title>Using Cloud NAT with GKE Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过GKE集群使用云NAT</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-cloud-nat-with-gke-cluster-c82364546d9e?source=collection_archive---------0-----------------------#2018-11-16">https://medium.com/google-cloud/using-cloud-nat-with-gke-cluster-c82364546d9e?source=collection_archive---------0-----------------------#2018-11-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9fae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">构建NAT计算引擎实例并通过路由将私有GKE集群连接到互联网的时代已经一去不复返。但是如果我们将公共ip分配给集群节点，我的</em> <a class="ae je" rel="noopener" href="/@dwdraju/prevent-exposing-gke-node-ip-to-the-world-5942189b2836"> <em class="jd">上一篇关于使用NAT的文章</em> </a> <em class="jd">仍然适用。</em></p><p id="4039" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随着<a class="ae je" href="https://cloud.google.com/nat/docs/overview" rel="noopener ugc nofollow" target="_blank">云NAT </a>(测试版)的推出，没有公共ip(即私有实例)的计算引擎实例和GKE集群节点可以使用静态或动态ip地址通过云NAT连接到互联网。NAT网关是区域资源，可以配置为用于区域中的所有子网或选定子网。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/0dd25955c69b18abed7777a73fd6fe6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hG8-lgKZpaLAokyOmfnXPA.jpeg"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated"><em class="jv">图片:ciobulletin.com</em></figcaption></figure><p id="83a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本帖中，我们将介绍创建专用集群、创建NAT网关、测试连接和确认网关IP。</p><h2 id="8d1a" class="jw jx hi bd jy jz ka kb kc kd ke kf kg iq kh ki kj iu kk kl km iy kn ko kp kq bi translated">创建专用GKE集群</h2><p id="361b" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">我们将在<code class="du kw kx ky kz b">us-central1-b</code>区域创建名为<code class="du kw kx ky kz b">private-cluster</code>的群集。专用集群的主机应配备授权网络，否则我们无法连接到api服务器，即无法运行<code class="du kw kx ky kz b">kubectl</code>命令。</p><p id="83be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们用云壳ip做授权网吧。用<code class="du kw kx ky kz b">curl checkip.amazonaws.com</code>获取cloudshell的IP地址，并保存在下面的<code class="du kw kx ky kz b">[cloudshell-ip-address]</code>变量中。此外，根据需要调整其他参数。</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="3da4" class="jw jx hi kz b fi le lf l lg lh">gcloud container clusters create private-cluster \<br/>    --create-subnetwork name=private-cluster \<br/>    --enable-ip-alias \<br/>    --enable-private-nodes \<br/>    --master-ipv4-cidr 172.16.0.0/28 \<br/>    --enable-master-authorized-networks \<br/>    --master-authorized-networks [cloudshell-ip-address]<br/>    --no-enable-basic-auth \<br/>    --no-issue-client-certificate</span></pre><p id="d66b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启动并运行集群需要几分钟时间。前往<a class="ae je" href="https://console.cloud.google.com/kubernetes/list" rel="noopener ugc nofollow" target="_blank"> kubernetes列表页面</a>，点击<strong class="ih hj">连接</strong>新创建的集群，然后在云壳中运行。这将使用以下命令打开云外壳:</p><p id="fcd4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kw kx ky kz b">gcloud container clusters get-credentials private-cluster --zone us-central1-b</code></p><h2 id="fe45" class="jw jx hi bd jy jz ka kb kc kd ke kf kg iq kh ki kj iu kk kl km iy kn ko kp kq bi translated">尝试不使用NAT连接到互联网</h2><p id="c1ba" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">创建一个简单的curl部署来获取用于连接公共互联网的ip地址。</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="3623" class="jw jx hi kz b fi le lf l lg lh">kubectl run test-deploy --image dwdraju/alpine-curl-jq</span></pre><p id="eb49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果创建了pod，请签出</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="905c" class="jw jx hi kz b fi le lf l lg lh">kubectl get pods<br/>NAME                           READY     STATUS         RESTARTS   AGEtest-deploy-7857c9c7c9-ffpsl   0/1       ErrImagePull   0          18s</span></pre><p id="1510" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这意味着我们无法将任何映像拉至集群，因为没有任何节点拥有外部ip来连接docker registry。但是如果有权限的话，可以拉取<a class="ae je" href="https://cloud.google.com/container-registry/" rel="noopener ugc nofollow" target="_blank">云注册表</a>的镜像。</p><h2 id="5264" class="jw jx hi bd jy jz ka kb kc kd ke kf kg iq kh ki kj iu kk kl km iy kn ko kp kq bi translated">创建云NAT网关</h2><p id="545b" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">云NAT是谷歌云平台(GCP)提供的<strong class="ih hj">网络服务</strong>之一。转到NAT创建<a class="ae je" href="https://console.cloud.google.com/net-services/nat/add" rel="noopener ugc nofollow" target="_blank">页面</a>并开始添加细节。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es li"><img src="../Images/1fd8a505b82424c1358f8ac8eb0710b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h9nvdQewaDLDXWOYW0PFVw.png"/></div></div></figure><p id="676b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您没有云路由器，请从NAT添加页面添加一个，同时添加子网、区域。对于NAT映射，选择<strong class="ih hj">自定义</strong>并选择我们创建私有集群的子网，<strong class="ih hj">选择:全部</strong>或选择IP范围。</p><p id="3191" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于NAT ip地址，选择“自动”可以自由地向GCP平台添加ip地址，或者在同一区域创建新的静态IP以使用预定义的IP地址。点击<strong class="ih hj">创建</strong>并等待一段时间让NAT网关准备好。</p><p id="3570" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建新部署以检查集群是否可以从docker hub注册表中提取映像。</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="8b88" class="jw jx hi kz b fi le lf l lg lh">kubectl run nat-deploy --image dwdraju/alpine-curl-jq<br/>kubectl get pods</span></pre><p id="5c21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将会看到标有<strong class="ih hj">完成</strong>的pod状态。</p><p id="525d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">获取NAT的IP地址，确认其工作状态</strong></p><p id="a3e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行一个pod <code class="du kw kx ky kz b">get-ip-address</code>作为交互外壳</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="043c" class="jw jx hi kz b fi le lf l lg lh">kubectl run -i --tty get-ip-address --image=dwdraju/alpine-curl-jq --restart=Never</span></pre><p id="99dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在交互终端上，输入<code class="du kw kx ky kz b">curl checkip.amazonaws.com</code>,它将输出我们创建的NAT网关的ip地址。</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="a65d" class="jw jx hi kz b fi le lf l lg lh">kubectl run -i --tty get-ip-address --image=dwdraju/alpine-curl-jq --restart=Never<br/>If you don't see a command prompt, try pressing enter.<br/>/ # curl checkip.amazonaws.com<br/>104.198.47.200</span></pre><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es lj"><img src="../Images/bcba95531ff90a98d70b24f930697704.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*40RCHmqtys8yTAj3m4onYw.png"/></div></div></figure><p id="8b02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仅此而已！！通过这种方式，我们有了一个安全的集群，它不会被外界截获，但是我们的节点可以使用NAT IP地址获得公共互联网资源。如果您必须将kubernetes资源(pod)想要连接到的资源的ip地址列入白名单，这也很有帮助。</p><p id="8dc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">为了让计费不吓到你，删除集群和NAT网关:)</em></p></div></div>    
</body>
</html>