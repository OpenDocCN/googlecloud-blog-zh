<html>
<head>
<title>Managing Airflow Logs on Google Cloud Storage with Object Lifecycle Management</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用对象生命周期管理管理Google云存储上的气流日志</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/managing-airflow-logs-on-google-cloud-storage-with-object-lifecycle-management-a80befe8eeab?source=collection_archive---------2-----------------------#2022-08-15">https://medium.com/google-cloud/managing-airflow-logs-on-google-cloud-storage-with-object-lifecycle-management-a80befe8eeab?source=collection_archive---------2-----------------------#2022-08-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9604" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cloud Composer上的Airflow DAGs为每次运行在Google云存储上生成日志文件。那些计划频繁运行的日志往往会生成更多的日志，随着时间的推移，会导致存储成本更快地累积。应用CGS bucket生命周期规则是解决这个问题的一个可行方案，让我们来探索一下如何实现！</p><p id="ce52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">管理旧的历史日志的一个原因是成本优化。一个GCS存储桶的定价取决于几个因素，如<strong class="ih hj"><em class="jd"/></strong><strong class="ih hj"><em class="jd">处理</em> </strong>和<strong class="ih hj"> <em class="jd">联网</em> </strong>。存储和检索定价取决于为存储桶和对象选择的存储类别。关于GCS定价的详细指南<a class="ae je" href="https://cloud.google.com/storage/pricing" rel="noopener ugc nofollow" target="_blank">点击此处</a>。</p><h2 id="d4d3" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">GCS上气流日志的存储选项</h2><p id="66f0" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">使用Cloud Composer，存储桶和底层对象的默认存储类别设置为<strong class="ih hj">标准</strong>，具有这些<a class="ae je" href="https://cloud.google.com/storage/pricing#europe" rel="noopener ugc nofollow" target="_blank">定价</a>。对于经常访问的文件，标准存储是一个很好的选择。对于不经常访问或处理的内容，其他类可能更具成本效益，例如超过<strong class="ih hj"> <em class="jd"> n天</em> </strong>的日志。下面是摘自GCP用户界面的摘要，概括了每个存储类别的使用情形。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kf"><img src="../Images/669cd5dacca803143bdd6aca2b32d772.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xOZUK28PDIuPcubslsgv0w.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx translated">GCS桶可用的存储选项</figcaption></figure><p id="02db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">考虑一个使用案例，其中不需要访问超过30天的DAG日志，可能一年一次除外。<strong class="ih hj"> <em class="jd">是否可以将所有日志对象保存在同一个桶中，并为每个对象分配不同的存储类别？幸运的是，谷歌云存储支持这一点，我们可以根据生命周期规则自动切换对象的类！</em></strong></p><h2 id="a4be" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">关于GCS生命周期规则，您需要了解什么</h2><p id="9e58" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">当<a class="ae je" href="https://cloud.google.com/storage/docs/lifecycle" rel="noopener ugc nofollow" target="_blank">生命周期规则</a>被设置时，云存储将定期检查桶中所有匹配任何设置模式的对象，并执行适用于这些规则的所有操作。</p><p id="04d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">生命周期操作和模式是在整个存储桶的级别上定义和应用的，而不是在“文件夹”的级别上。应该小心定义模式，如前缀、后缀、存储类等..确保规则的粒度符合要求。您最不希望看到的是，动作溢出到同一个存储桶中与生命周期规则无关的其他对象。</p><p id="803d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一个细节是，GCS bucket需要预先启用对象版本控制，以便正确应用生命周期规则。截至撰写本文时，默认情况下，属于Cloud Composer实例的buckets上没有启用对象版本控制。您需要自己启用它。</p><p id="79d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这可以很容易地从UI或通过gsutil命令进行设置，比如</p><pre class="kg kh ki kj fd kv kw kx ky aw kz bi"><span id="a7df" class="jf jg hi kw b fi la lb l lc ld">gsutil versioning set on gs://my-awesome-gcs-bucket</span></pre><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es le"><img src="../Images/883f07a7dcfccab78dff0275e0dea3ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dg_wNHX-z7b9lQuhoisaww.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx translated">启用了对象版本控制的存储桶示例</figcaption></figure><p id="d08b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，对象生命周期管理是一个很大的话题，我建议在生产中使用它之前熟悉所有的概念。谷歌云存储上的官方文档是一个很好的开始。</p><h1 id="b518" class="lf jg hi bd jh lg lh li jl lj lk ll jp lm ln lo js lp lq lr jv ls lt lu jy lv bi translated">对气流日志应用生命周期规则</h1><p id="41ce" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">生命周期规则可以通过CLI ( <a class="ae je" href="https://cloud.google.com/storage/docs/lifecycle-configurations#gsutil" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> gsutil </strong> </a>)、GCS API和GCP UI来应用。在下面的例子中，我们将通过<a class="ae je" href="https://cloud.google.com/storage/docs/lifecycle-configurations#gsutil" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> gsutil </strong> </a>应用示例规则。</p><h2 id="4526" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">通过设置存储类别归档旧日志</h2><p id="03ea" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">默认情况下，GCS bucket为写入的任何新对象都有一个存储类，可以覆盖子对象的存储类。这很方便，因为较旧的日志仍然组织在同一个桶中，但是不同的存储类适合于它们预期的访问频率。</p><p id="7165" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">生命周期规则可以定义为一个JSON对象，由两个主要的配置块组成:<strong class="ih hj">动作</strong>和<strong class="ih hj">条件</strong>。对于超过30天的归档日志:</p><ul class=""><li id="1d4f" class="lw lx hi ih b ii ij im in iq ly iu lz iy ma jc mb mc md me bi translated">将action设置为<strong class="ih hj"> SetStorageClass </strong>以及该存储类的目标值<strong class="ih hj"> ARCHIVE </strong>。</li><li id="2ffa" class="lw lx hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated">将条件设置为多个标准，与气流桶中日志文件夹的结构相关。在这种情况下，我们感兴趣的是只捕获logs/*文件夹下的文件，这些文件已经使用<strong class="ih hj">标准</strong>(默认)类存储了<strong class="ih hj">至少30天</strong>。</li><li id="cf59" class="lw lx hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated">典型的气流日志文件路径将以(前缀)<strong class="ih hj"> logs/ </strong>开始，以<strong class="ih hj">结束(后缀)。日志</strong></li></ul><p id="5749" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个使用JSON语法的生命周期配置的例子。</p><pre class="kg kh ki kj fd kv kw kx ky aw kz bi"><span id="d573" class="jf jg hi kw b fi la lb l lc ld">{<br/>  "lifecycle": {<br/>    "rule": [<br/>      {<br/>        "action": {<br/>          "type": "SetStorageClass",<br/>          "storageClass": "ARCHIVE"<br/>        },<br/>        "condition": {<br/>          "matchesPrefix": [<br/>            "logs/"<br/>          ],<br/>          "matchesSuffix": [<br/>            ".log"<br/>          ],<br/>          "age": 30,<br/>          "matchesStorageClass": [<br/>            "STANDARD"<br/>          ]<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><p id="4717" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果期望更频繁地访问日志，您可能想要考虑其他类，如<strong class="ih hj">近线</strong>或<strong class="ih hj">冷线</strong>每个类的完整详细信息可从<a class="ae je" href="https://cloud.google.com/storage/docs/storage-classes#classes" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p><p id="6eba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以使用类似下面的命令，通过gsutil简单地应用生命周期配置。</p><pre class="kg kh ki kj fd kv kw kx ky aw kz bi"><span id="e0e0" class="jf jg hi kw b fi la lb l lc ld">gsutil lifecycle set my-lifecycle.json gs://my-awesome-airflow-bucket</span></pre><h2 id="8d7f" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">删除</h2><p id="df32" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">如果一段时间后不再需要日志，可以通过另一个规则简单地安排删除它们。这将遵循与上一个示例相同的结构。这里唯一的区别是动作被设置为<strong class="ih hj">删除</strong>。</p><pre class="kg kh ki kj fd kv kw kx ky aw kz bi"><span id="858a" class="jf jg hi kw b fi la lb l lc ld">{<br/>  "lifecycle": {<br/>    "rule": [<br/>      {<br/>        "action": {<br/>          "type": "Delete"<br/>        },<br/>        "condition": {<br/>          "matchesPrefix": [<br/>            "logs/"<br/>          ],<br/>          "matchesSuffix": [<br/>            ".log"<br/>          ],<br/>          "age": 365<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><h2 id="79e4" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">组合生命周期规则</h2><p id="1d6b" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">一个桶的生命周期可以由几个规则组成，这使您能够遵循一种混合方法来管理旧的气流日志。例如，一种方法可以是设置两个规则:</p><ol class=""><li id="0623" class="lw lx hi ih b ii ij im in iq ly iu lz iy ma jc mk mc md me bi translated">将超过30天的日志转换为<strong class="ih hj"> COLDLINE </strong>或<strong class="ih hj"> ARCHIVE </strong>存储类(取决于所需的访问频率)</li><li id="72ca" class="lw lx hi ih b ii mf im mg iq mh iu mi iy mj jc mk mc md me bi translated">365天后删除它们</li></ol><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es ml"><img src="../Images/6c4040cfdc42e5ded554a08f8d8ac00f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7_SIMpU3Z2ucOH1oIQaKIQ.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx translated">GCS日志管理的混合方法示例</figcaption></figure><p id="37c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就配置而言，这可以简单地转化为将我们之前定义的两个生命周期合并为一个具有多个规则的生命周期。</p><p id="3a02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个生命周期对象，多个规则对象添加到规则数组中。</p><pre class="kg kh ki kj fd kv kw kx ky aw kz bi"><span id="aa49" class="jf jg hi kw b fi la lb l lc ld">{<br/>  "lifecycle": {<br/>    "rule": [<br/>      {<br/>        "action": {<br/>          "type": "SetStorageClass",<br/>          "storageClass": "ARCHIVE"<br/>        },<br/>        "condition": {<br/>          "matchesPrefix": [<br/>            "logs/"<br/>          ],<br/>          "matchesSuffix": [<br/>            ".log"<br/>          ],<br/>          "age": 30,<br/>          "matchesStorageClass": [<br/>            "STANDARD"<br/>          ]<br/>        }<br/>      },<br/>      {<br/>        "action": {<br/>          "type": "Delete"<br/>        },<br/>        "condition": {<br/>          "matchesPrefix": [<br/>            "logs/"<br/>          ],<br/>          "matchesSuffix": [<br/>            ".log"<br/>          ],<br/>          "age": 365,<br/>          "matchesStorageClass": [<br/>            "ARCHIVE"<br/>          ]<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><p id="19ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">应用上面的配置，应该反映一个生命周期定义，看起来像下面的GCS用户界面。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es mm"><img src="../Images/d9ba286e0c8295d3f554a057868af58d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6x-pQPA8sEs7cdz1WRX-KA.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx translated">GCS时段UI上的组合生命周期规则示例</figcaption></figure><p id="203c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更精细的规则集也是可能的，例如基于对象年龄在不同存储类之间转换，直到最终删除。</p><h1 id="e2e4" class="lf jg hi bd jh lg lh li jl lj lk ll jp lm ln lo js lp lq lr jv ls lt lu jy lv bi translated">结束语</h1><p id="6f22" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">这是一个关于如何更有效地管理Google云存储上的气流日志的快速总结，而不是依赖于Cloud Composer设置的默认存储和保留。</p><p id="1efd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在文章中提到了存储成本，但并没有深入探讨成本节约的数字。这将取决于您的气流设置，例如</p><ul class=""><li id="1a4d" class="lw lx hi ih b ii ij im in iq ly iu lz iy ma jc mb mc md me bi translated">Dag的数量，</li><li id="8ae3" class="lw lx hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated">执行和记录频率</li><li id="9430" class="lw lx hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated">每个DAG生成的日志的大小。</li></ul><p id="ad7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我强烈建议运行一个评估练习，以更好地理解您的GCS成本和生命周期规则的潜在节约。</p><p id="12b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这篇文章对你有用，希望听到关于这篇文章或主题的任何反馈/想法/问题。</p></div></div>    
</body>
</html>