<html>
<head>
<title>Exporting Data from MongoDB to GCS Buckets using Dataproc Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dataproc无服务器将数据从MongoDB导出到GCS存储桶</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/exporting-data-from-mongodb-to-gcs-buckets-using-dataproc-serverless-64830fb15b51?source=collection_archive---------0-----------------------#2022-09-17">https://medium.com/google-cloud/exporting-data-from-mongodb-to-gcs-buckets-using-dataproc-serverless-64830fb15b51?source=collection_archive---------0-----------------------#2022-09-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ddd91c5744f6490986526d268aaa793e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*M8g_t_uk2CNMJde0.png"/></div></div></figure><p id="89b7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">每当涉及到内存中的数据处理时，Apache Spark通常是首选。但是，Spark提出了GCP的Dataproc集群的维护成本。这种维护Spark集群的开销在使用Spark执行新任务时造成了障碍。Google Cloud Community提出了Dataproc无服务器设计，允许我们在Dataproc集群上运行Spark作业，而不用担心维护Dataproc / Spark集群的开销。</p><p id="ee3d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Dataproc无服务器设计可用于运行各种Spark作业。一个主要的用例涉及到通过Google云存储(GCS)桶导入和导出数据。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es jo"><img src="../Images/9a993738035ba6cd8d02dfbdfaeeabfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:916/format:webp/0*tPA3KZ6ZcS1T2dWl.png"/></div></figure><p id="df37" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">MongoDB是一个非常著名的面向NoSQL文档的数据库。从MongoDB向一些云存储导出和导入数据是一个非常常见的用例，反之亦然。本文基本上涵盖了一个这样的用例，其中需要使用Dataproc无服务器设计方法将数据从MongoDB导出到GCS Buckets。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es jt"><img src="../Images/fb7f4959b67e03cde9625e859b6a26c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/format:webp/0*q7EluyPTHfZT8ZBw.png"/></div></figure><p id="810a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如今，许多公司使用MongoDB Atlas(不同云提供商上的MongoDB托管服务)，而不是自己管理MongoDB集群。因此，本文还将介绍如何使用Dataproc无服务器设计连接到MongoDB Atlas。</p><h1 id="1750" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">主要优势</h1><ol class=""><li id="3e1c" class="ks kt hi is b it ku ix kv jb kw jf kx jj ky jn kz la lb lc bi translated">这些模板是开源的，任何人都可以将其用于工作负载迁移。</li><li id="76ba" class="ks kt hi is b it ld ix le jb lf jf lg jj lh jn kz la lb lc bi translated">这些模板本质上是可定制的。这意味着，GitHub库可以非常容易地被克隆，并可以根据我们的要求通过相应的代码更改提前使用。</li><li id="d721" class="ks kt hi is b it ld ix le jb lf jf lg jj lh jn kz la lb lc bi translated">Dataproc无服务器设计将开发人员从管理Dataproc集群的麻烦中解放出来。</li><li id="7082" class="ks kt hi is b it ld ix le jb lf jf lg jj lh jn kz la lb lc bi translated">支持的文件格式有JSON、Avro、Parquet和CSV。</li><li id="280f" class="ks kt hi is b it ld ix le jb lf jf lg jj lh jn kz la lb lc bi translated">这些模板是配置驱动的，只需更改连接参数，就可以非常容易地用于类似的用例。</li></ol><h1 id="a40a" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">使用</h1><p id="c95f" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb li jd je jf lj jh ji jj lk jl jm jn hb bi translated">1.为jar文件创建一个GCS存储桶和暂存位置。</p><p id="445b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.在预装了<a class="ae ll" href="https://cloud.google.com/shell/docs/how-cloud-shell-works" rel="noopener ugc nofollow" target="_blank">各种工具</a>的云壳中克隆git repo。或者使用任何预装JDK 8+，Maven和Git的机器。</p><pre class="jp jq jr js fd lm ln lo lp aw lq bi"><span id="0905" class="lr jv hi ln b fi ls lt l lu lv">git clone <a class="ae ll" href="https://github.com/GoogleCloudPlatform/dataproc-templates.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/dataproc-templates.git</a><br/>cd dataproc-templates/python</span></pre><p id="0afb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.获取身份验证凭据(以提交作业)。</p><pre class="jp jq jr js fd lm ln lo lp aw lq bi"><span id="154a" class="lr jv hi ln b fi ls lt l lu lv">gcloud auth application-default login</span></pre><p id="955f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.执行MongoToGCS模板。<br/>例如:当需要连接MongoDB时:-</p><pre class="jp jq jr js fd lm ln lo lp aw lq bi"><span id="24dd" class="lr jv hi ln b fi ls lt l lu lv">export GCP_PROJECT=my-gcp-project<br/>export REGION=us-central1<br/>export GCS_STAGING_LOCATION=gs://staging-bucket<br/>export JARS="gs://jar_location/mongo-java-driver-3.9.1.jar,gs://jar_location/mongo-spark-connector_2.12-2.4.0.jar"<br/></span><span id="d522" class="lr jv hi ln b fi lw lt l lu lv">./bin/start.sh \<br/>-- --template=MONGOTOGCS \<br/>--mongo.gcs.output.format="avro" \<br/>--mongo.gcs.output.location="gs://GCS_Bucket_Name/mongogcsoutput" \<br/>--mongo.gcs.output.mode="overwrite" \<br/>--mongo.gcs.input.uri="mongodb://1.2.3.45:27017" \<br/>--mongo.gcs.input.database="demo" \<br/>--mongo.gcs.input.collection="analysis"</span></pre><p id="a43d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">例如:当需要与MongoDB Atlas连接时</p><pre class="jp jq jr js fd lm ln lo lp aw lq bi"><span id="ce53" class="lr jv hi ln b fi ls lt l lu lv">export GCP_PROJECT=my-gcp-project<br/>export REGION=us-central1<br/>export GCS_STAGING_LOCATION=gs://staging-bucket<br/>export JARS="gs://jar_location/mongo-java-driver-3.9.1.jar,gs://jar_location/mongo-spark-connector_2.12-2.4.0.jar"<br/></span><span id="3f32" class="lr jv hi ln b fi lw lt l lu lv">./bin/start.sh \<br/>-- --template=MONGOTOGCS \<br/>--mongo.gcs.output.format="avro" \<br/>--mongo.gcs.output.location="gs://GCS_Bucket_Name/mongogcsoutput" \<br/>--mongo.gcs.output.mode="overwrite" \<br/>--mongo.gcs.input.uri="mongodb+srv://&lt;username&gt;:&lt;password&gt;<a class="ae ll" href="mailto:root@hhasija.wnopa.mongodb.net" rel="noopener ugc nofollow" target="_blank">@hhasija.wnopa.mongodb.net</a>" \<br/>--mongo.gcs.input.database="demo" \<br/>--mongo.gcs.input.collection="analysis"</span></pre><p id="4850" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意</strong>:如果尚未启用，它会要求您启用Dataproc Api。</p><h1 id="93f3" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">计划批处理作业</h1><p id="2323" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb li jd je jf lj jh ji jj lk jl jm jn hb bi translated">GCP原生提供云调度器+云功能，可用于提交spark批处理作业。或者自我管理的软件，如linux cron tab，Jenkins等。也可以使用。</p><h1 id="340f" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">设置附加火花属性</h1><p id="6666" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb li jd je jf lj jh ji jj lk jl jm jn hb bi translated">如果您需要<a class="ae ll" href="https://cloud.google.com/dataproc-serverless/docs/concepts/properties" rel="noopener ugc nofollow" target="_blank">指定Dataproc无服务器支持的spark属性</a>,比如调整驱动程序、内核、执行器等的数量。</p><p id="7636" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以编辑start.sh文件中的<a class="ae ll" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/bin/start.sh#L50" rel="noopener ugc nofollow" target="_blank"> OPT_PROPERTIES </a>值。</p><p id="609d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">参考资料</strong><br/>https://medium . com/Google-cloud/importing-data-from-GCS-to-databases-via-JDBC-using-data proc-server less-7ed 75 eab 93 ba<br/>https://github.com/GoogleCloudPlatform/dataproc-templates</p><p id="c399" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">https://medium . com/Google-cloud/importing-data-from-GCS-to-MongoDB-using-data proc-server less-fed 58904633 a</p></div></div>    
</body>
</html>