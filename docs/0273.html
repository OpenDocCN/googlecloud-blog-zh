<html>
<head>
<title>GCP + GPUs 💙 Kubernetes (and Tensorflow)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP+GPU💙Kubernetes(和Tensorflow)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-gpus-juju-kubernetes-and-tensorflow-5f9f7fe38538?source=collection_archive---------1-----------------------#2017-05-04">https://medium.com/google-cloud/gcp-gpus-juju-kubernetes-and-tensorflow-5f9f7fe38538?source=collection_archive---------1-----------------------#2017-05-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6a5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我几周前写如何在Kubernetes 上部署<a class="ae jd" rel="noopener" href="/intuitionmachine/kubernetes-gpus-tensorflow-8696232862ca"> Tensorflow时，我利用AWS作为我的云基础。一位读者评论并询问如何在</a><a class="ae jd" href="https://cloud.google.com" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a>上设置GPU集群。</p><p id="4520" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我说过我会回答Vikas，所以这就是，在<a class="ae jd" href="https://cloud.google.com" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a>上用GPU部署<a class="ae jd" href="https://kubernetes.io" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>的方法。</p><h1 id="ee2c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">要求</h1><p id="6c46" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">要复制这篇文章，你需要:</p><ul class=""><li id="2742" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">了解工具<a class="ae jd" href="http://www.canonical.com" rel="noopener ugc nofollow" target="_blank"> Canonical </a>开发和使用:<a class="ae jd" href="http://www.ubuntu.com" rel="noopener ugc nofollow" target="_blank"> Ubuntu </a>和<a class="ae jd" href="https://jujucharms.com/" rel="noopener ugc nofollow" target="_blank">Juju</a>；</li><li id="443f" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">一个GCP的管理员帐户和足够的配额，以添加至少3个GPUs</li><li id="a4e1" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">对Kubernetes工具的理解:</li><li id="358e" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">安装了Juju的Ubuntu 16.04或更高版本、CentOS 6+、MacOS X或Windows 7+计算机。这个博客将会关注Ubuntu，但是你可以通过这个展示来遵循其他操作系统的指导方针。</li></ul><p id="bace" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您在部署时遇到任何问题，或者您有特定的需求，请通过IRC与我联系。我是Freenode #juju上的SaMnCo，<a class="ae jd" href="https://jujucharms.com/kubernetes" rel="noopener ugc nofollow" target="_blank"> CDK </a>团队的其他成员也可以在那里提供帮助。</p><h1 id="c542" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">准备您的环境</h1><p id="4c02" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">首先，让我们在您的机器上部署Juju以及一些有用的工具:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="218a" class="le jf hi la b fi lf lg l lh li">sudo add-apt-repository -y ppa:juju/devel<br/>sudo apt update<br/>sudo apt install -yqq juju jq git<br/>export SDK_SRC=https://dl.google.com/dl/cloudsdk/channels/rapid/downloads<br/>export SDK_VERSION=154.0.0<br/>wget ${SDK_SRC}/google-cloud-sdk-${SDK_VERSION}-linux-x86_64.tar.gz<br/>tar xfz google-cloud-sdk-${SDK_VERSION}-linux-x86_64.tar.gz &amp;&amp; \<br/>  google-cloud-sdk/install.sh<br/># This is interactive<br/>rm google-cloud-sdk-${SDK_VERSION}-linux-x86_64.tar.gz</span></pre><p id="7cdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按照<a class="ae jd" href="https://jujucharms.com/docs/2.1/help-google" rel="noopener ugc nofollow" target="_blank">本页</a>的说明，为Juju准备一个项目和您的GCP证书，并填写:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="f5c3" class="le jf hi la b fi lf lg l lh li">juju add-credential google</span></pre><p id="c7fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面一行是交互式的，将引导您完成整个过程。最后，让我们下载kubectl和helm</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="d043" class="le jf hi la b fi lf lg l lh li"># kubectl<br/>curl -LO <a class="ae jd" href="https://storage.googleapis.com/kubernetes-release/release/1.6.2/bin/linux/amd64/kubectl" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/1.6.2/bin/linux/amd64/kubectl</a><br/>chmod +x kubectl &amp;&amp; sudo mv kubectl /usr/local/bin/</span></pre><p id="90ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">克隆此存储库以访问源文档:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="b7ed" class="le jf hi la b fi lf lg l lh li">git clone <a class="ae jd" href="https://github.com/madeden/blogposts.git" rel="noopener ugc nofollow" target="_blank">https://github.com/madeden/blogposts.git</a><br/>cd blogposts/k8s-tensorflow</span></pre><p id="2734" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好吧！我们准备好了。</p><h1 id="2b85" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">部署集群</h1><p id="6fee" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">因为我们想使用GPU，就像AWS一样，我们需要小心我们正在使用的AZ。例如，在us-east1中，只有us-east1-d支持GPU。谷歌在这个页面上提供了关于这些地点的文档。</p><p id="e11b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GCE有一种非常特殊的方式来管理az和子网，并且不为支持GPU的机器提供实例类型(GPU可以在启动时添加到几乎任何实例类型中)。</p><p id="892e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，为了在GCE的GPU上部署K8s，您必须</p><ol class=""><li id="9ed8" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc lj kn ko kp bi translated">引导并部署Kubernetes的控制面板</li><li id="22f0" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc lj kn ko kp bi translated">手动创建GPU实例</li><li id="099b" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc lj kn ko kp bi translated">一旦启动，将这些机器添加到Juju</li><li id="09f0" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc lj kn ko kp bi translated">告诉Juju在他们身上部署工人</li></ol><p id="e732" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这禁止使用包，所以大部分部署将是手动的。让我们看看它是如何工作的:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="3180" class="le jf hi la b fi lf lg l lh li">juju bootstrap google/us-east1 <br/>juju add-model k8s</span></pre><p id="301f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">手动部署控制面板和仅用于CPU的第一个工作机</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="e03f" class="le jf hi la b fi lf lg l lh li">juju deploy cs:~containers/kubernetes-master-17<br/>juju deploy cs:~containers/etcd-29 --to 0<br/>juju deploy cs:~containers/easyrsa-8 --to lxd:0<br/>juju deploy cs:~containers/flannel-13<br/>juju deploy cs:~containers/kubernetes-worker-22<br/>juju expose kubernetes-master<br/>juju expose kubernetes-worker</span></pre><p id="acd2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">向项目添加Juju SSH密钥</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="de56" class="le jf hi la b fi lf lg l lh li">gcloud compute project-info add-metadata \<br/> --metadata-from-file sshKeys=~/.local/share/juju/ssh/juju_id_rsa_gce.pub</span></pre><p id="28f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注</strong>:这个。pub是为gce改编的默认juju_id_rsa.pub文件的副本，看起来像</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="28a8" class="le jf hi la b fi lf lg l lh li">ubuntu:ssh-rsa [KEY VALUE] ubuntu</span></pre><p id="2316" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里可以看到关于这个<a class="ae jd" href="https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys#project-wide" rel="noopener ugc nofollow" target="_blank">的官方文档。现在，使用以下内容创建所有计算机:</a></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="8872" class="le jf hi la b fi lf lg l lh li">for i in $(seq 1 1 3)<br/>do <br/> gcloud beta compute instances create kubernetes-worker-gpu-${i} \<br/>  --machine-type n1-standard-2 \<br/>  --zone us-east1-d \<br/>  --accelerator type=nvidia-tesla-k80,count=1 \<br/>  --image-family ubuntu-1604-lts \<br/>  --image-project ubuntu-os-cloud \<br/>  --maintenance-policy TERMINATE \<br/>  --metadata block-project-ssh-keys=FALSE \<br/>  --restart-on-failure<br/> sleep 5<br/>done</span></pre><p id="d846" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于每台机器，我们都会得到这样的答案:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="2b29" class="le jf hi la b fi lf lg l lh li">Created [<a class="ae jd" href="https://www.googleapis.com/compute/beta/projects/jaas-151616/zones/us-east1-d/instances/kubernetes-worker-gpu-2" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/compute/beta/projects/jaas-151616/zones/us-east1-d/instances/kubernetes-worker-gpu-2</a>].<br/>NAME                     ZONE        MACHINE_TYPE   PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP   STATUS<br/>kubernetes-worker-gpu-2  us-east1-d  n1-standard-2               10.142.0.5   35.185.74.56  RUNNING</span></pre><p id="3652" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">记下每台机器的公共IP地址</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="10f9" class="le jf hi la b fi lf lg l lh li">juju add-machine ssh:ubuntu@35.185.74.56 # use the Public IP</span></pre><p id="4c30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你会得到这样的答案</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="ecbf" class="le jf hi la b fi lf lg l lh li">WARNING Skipping CA server verification, using Insecure option<br/>created machine 2</span></pre><p id="8fe6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个阶段，Juju的状态如下:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="0b6b" class="le jf hi la b fi lf lg l lh li">$ juju status<br/>Model  Controller  Cloud/Region     Version      SLA<br/>k8s    k8s         google/us-east1  2.2-beta4.1  unsupported</span><span id="7a01" class="le jf hi la b fi lk lg l lh li">App                Version  Status   Scale  Charm              Store       Rev  OS      Notes<br/>easyrsa            3.0.1    active       1  easyrsa            jujucharms    8  ubuntu  <br/>etcd               2.3.8    blocked      1  etcd               jujucharms   29  ubuntu  <br/>kubernetes-master  1.6.1    blocked      1  kubernetes-master  jujucharms   17  ubuntu  <br/>kubernetes-worker  1.6.1    blocked      1  kubernetes-worker  jujucharms   22  ubuntu</span><span id="f3b6" class="le jf hi la b fi lk lg l lh li">Unit                  Workload  Agent  Machine  Public address  Ports  Message<br/>easyrsa/0*            active    idle   0/lxd/0  10.0.19.96             Certificate Authority ready.<br/>etcd/0*               blocked   idle   0        35.185.1.113           Missing relation to certificate authority.<br/>kubernetes-master/0*  blocked   idle   0        35.185.1.113           Relate kubernetes-master:kube-control kubernetes-worker:kube-control<br/>kubernetes-worker/0*  blocked   idle   1        35.185.118.158         Relate kubernetes-worker:kube-control kubernetes-master:kube-control</span><span id="115e" class="le jf hi la b fi lk lg l lh li">Machine  State    DNS             Inst id                Series  AZ          Message<br/>0        started  35.185.1.113    juju-f1c96a-0          xenial  us-east1-b  RUNNING<br/>0/lxd/0  started  10.0.19.96      juju-f1c96a-0-lxd-0    xenial              Container started<br/>1        started  35.185.118.158  juju-f1c96a-1          xenial  us-east1-c  RUNNING<br/>2        started  35.185.22.159   manual:35.185.22.159   xenial              Manually provisioned machine<br/>3        started  35.185.74.56    manual:35.185.74.56    xenial              Manually provisioned machine<br/>4        started  35.185.112.159  manual:35.185.112.159  xenial              Manually provisioned machine</span><span id="5a3b" class="le jf hi la b fi lk lg l lh li">Relation  Provides  Consumes  Type<br/>cluster   etcd      etcd      peer</span></pre><p id="37be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以注意到，我们将机器2到4作为手动实例添加。现在我们可以告诉juju将这些用于额外的工人:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="f9bb" class="le jf hi la b fi lf lg l lh li"># Adding all machines as workers<br/>for unit in $(seq 2 1 4)<br/>do<br/> juju add-unit kubernetes-worker --to ${unit}<br/>done</span><span id="f4fe" class="le jf hi la b fi lk lg l lh li"># Add Relations between charms<br/>juju add-relation kubernetes-master:kube-api-endpoint  kubernetes-worker:kube-api-endpoint<br/>juju add-relation kubernetes-master:kube-control  kubernetes-worker:kube-control<br/>juju add-relation kubernetes-master:certificates  easyrsa:client<br/>juju add-relation kubernetes-master:etcd  etcd:db<br/>juju add-relation kubernetes-worker:certificates  easyrsa:client<br/>juju add-relation etcd:certificates  easyrsa:client<br/>juju add-relation flannel:etcd  etcd:db<br/>juju add-relation flannel:cni  kubernetes-master:cni<br/>juju add-relation flannel:cni  kubernetes-worker:cni</span><span id="be59" class="le jf hi la b fi lk lg l lh li"># Watch results<br/>watch -c juju status --color</span></pre><figure class="kv kw kx ky fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es ll"><img src="../Images/a5dc4765919954cfaf724465a1a72095.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cnizn-fPo-05vLOdgvy1zQ.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">CUDA部署在手动部署的支持GPU的GCP实例上</figcaption></figure><p id="134c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们可以测试CUDA是否安装了</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="f783" class="le jf hi la b fi lf lg l lh li">juju ssh 2 "sudo nvidia-smi"<br/>Thu May  4 07:20:37 2017       <br/>+-----------------------------------------------------------------------------+<br/>| NVIDIA-SMI 375.51                 Driver Version: 375.51                    |<br/>|-------------------------------+----------------------+----------------------+<br/>| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |<br/>| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |<br/>|===============================+======================+======================|<br/>|   0  Tesla K80           Off  | 0000:00:04.0     Off |                    0 |<br/>| N/A   74C    P0    77W / 149W |      0MiB / 11439MiB |    100%      Default |<br/>+-------------------------------+----------------------+----------------------+<br/>                                                                               <br/>+-----------------------------------------------------------------------------+<br/>| Processes:                                                       GPU Memory |<br/>|  GPU       PID  Type  Process name                               Usage      |<br/>|=============================================================================|<br/>|  No running processes found                                                 |<br/>+-----------------------------------------------------------------------------+<br/>Connection to 35.185.22.159 closed.</span></pre><p id="bc54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们看看我们的集群是什么样子:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="b12c" class="le jf hi la b fi lf lg l lh li">juju scp kubernetes-master/0:config ~/.kube/config<br/>kubectl get nodes --show-labels<br/>NAME                      STATUS    AGE       VERSION   LABELS<br/>juju-f1c96a-1             Ready     28m       v1.6.1    beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=juju-f1c96a-1<br/>kubernetes-worker-gpu-1   Ready     17m       v1.6.1    beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,<strong class="la hj">cuda=true,gpu=true</strong>,kubernetes.io/hostname=kubernetes-worker-gpu-1<br/>kubernetes-worker-gpu-2   Ready     17m       v1.6.1    beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,<strong class="la hj">cuda=true,gpu=true</strong>,kubernetes.io/hostname=kubernetes-worker-gpu-2<br/>kubernetes-worker-gpu-3   Ready     17m       v1.6.1    beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,<strong class="la hj">cuda=true,gpu=true</strong>,kubernetes.io/hostname=kubernetes-worker-gpu-3</span></pre><p id="2731" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如你所看到的，标签已经被添加到节点中，<strong class="ih hj"> cuda=true </strong>和<strong class="ih hj"> gpu=true </strong>。现在，我们可以像往常一样部署我们的nvidia-smi作业</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="3298" class="le jf hi la b fi lf lg l lh li">kubectl create -f ./src/nvidia-smi.yaml</span></pre><p id="dc27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">过了一段时间，我们得到了日志:</p><figure class="kv kw kx ky fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lx"><img src="../Images/a302a97a7769154f2875c0fcf70661af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zWeyPK6UFYHzObwNuwMiNQ.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">GCP Kubernetes上的GPU工作负载</figcaption></figure><h1 id="b35e" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">结论</h1><p id="c9b1" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在我们在Kubernetes上有了一个合适的GPU集群，剩下的和我的其他实验类似。使用Helm，Kubernetes提供了一个适当的云抽象层，因此您可以安全地使用它来部署您最喜欢的GPU工作负载！</p><p id="0dec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽情享受吧！如果你喜欢这个或发现它有用，不要犹豫，按下小心脏按钮，它总是有帮助的:)</p></div></div>    
</body>
</html>