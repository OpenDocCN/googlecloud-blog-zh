<html>
<head>
<title>Back to Microservices with Istio (Part 2) — Authentication &amp; Authorization</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">回到使用Istio的微服务(第2部分)—身份验证和授权</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/back-to-microservices-with-istio-part-2-authentication-authorization-b079f77358ac?source=collection_archive---------0-----------------------#2019-02-26">https://medium.com/google-cloud/back-to-microservices-with-istio-part-2-authentication-authorization-b079f77358ac?source=collection_archive---------0-----------------------#2019-02-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/429f2e969049e2603df4627223344674.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JuAIrafN3tEwZ6MPaZsI2Q.jpeg"/></div></div></figure><blockquote class="iq ir is"><p id="d563" class="it iu iv iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">注意:</strong>这篇文章已经过时了。我的最新文章“<a class="ae js" href="https://www.freecodecamp.org/news/learn-istio-manage-microservices/" rel="noopener ugc nofollow" target="_blank">学习Istio——如何管理、保护和监控您的服务</a>”适用于最新版本的Istio。</p></blockquote><p id="9901" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated"><em class="iv">这是文章的第二部分“</em> <a class="ae js" rel="noopener" href="/@rinormaloku37/back-to-microservices-with-istio-part-1-827c872daa53"> <em class="iv">回微服务用Istio </em> </a> <em class="iv">”(跟随第二部分的先决条件是完成第一部分。)</em></p><p id="cea0" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">在第一篇文章中，我们建立了一个Kubernetes集群，在其中部署了<strong class="iw hj"> Istio </strong>和示例微服务应用程序“情绪分析”，以展示Istio的特性。</p><p id="a407" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">使用Istio，我们保持了较小的服务规模，并淘汰了以下层:重试、超时、断路器、跟踪、监控(如图1所示),此外，我们启用了高级测试和部署技术，如A/B测试、阴影和金丝雀部署。</p><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="er es jw"><img src="../Images/0f402ee9b115b1cd89f558c7b7c55400.png" data-original-src="https://miro.medium.com/v2/resize:fit:758/format:webp/1*rKvesxZlk_rlLAd5620Npw.png"/></div><figcaption class="kb kc et er es kd ke bd b be z dx translated">图一。微服仪式</figcaption></figure><p id="8d16" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">在本文中，我们将处理认证和授权的最后一层，使用Istio，这是一次愉快的经历！</p><h1 id="9570" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">Istio中的身份验证和授权</h1><p id="2cf2" class="pw-post-body-paragraph it iu hi iw b ix ld iz ja jb le jd je jt lf jh ji ju lg jl jm jv lh jp jq jr hb bi translated">我从来不相信认证和授权会让我兴奋！在技术领域，Istio可以做些什么来让这些话题变得有趣，更重要的是，为什么你也应该感到兴奋？</p><p id="a685" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated"><strong class="iw hj">答案很简单:</strong> Istio将这些责任从我们的服务转移到Envoy代理，当请求到达我们的服务时，它们已经被认证和授权，我们只需编写提供业务价值的代码。</p><p id="4bb6" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">听起来不错？让我们开始吧！</p><h1 id="4a39" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">使用Auth0进行身份验证</h1><p id="964d" class="pw-post-body-paragraph it iu hi iw b ix ld iz ja jb le jd je jt lf jh ji ju lg jl jm jv lh jp jq jr hb bi translated">作为身份和访问管理服务器，我们将使用Auth0，它有一个试用选项，使用起来很直观，我非常喜欢它！也就是说，同样的原则可以用于任何<a class="ae js" href="https://openid.net/developers/certified/" rel="noopener ugc nofollow" target="_blank"> OpenID Connect实现</a>，比如KeyCloak、IdentityServer等等。</p><p id="3664" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">首先，导航到<a class="ae js" href="https://manage.auth0.com" rel="noopener ugc nofollow" target="_blank"> Auth0 Portal </a>使用您的首选帐户登录，创建一个租户，导航到应用程序&gt;默认应用程序下，选择域名，如下图所示:</p><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="ab fe cl li"><img src="../Images/ad0eb2bc2e8f45e5b581a136a06594db.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ftKR9RCcLA32Us8HA6-47w.png"/></div><figcaption class="kb kc et er es kd ke bd b be z dx translated">图二。Auth0管理门户中的默认应用</figcaption></figure><p id="c4cf" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">更新文件<code class="du lj lk ll lm b">resource-manifests/istio/security/auth-policy.yaml</code>以使用您的域:</p><figure class="jx jy jz ka fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="415d" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">有了这个资源，pilot配置代理在将请求转发给服务之前对请求进行身份验证:<code class="du lj lk ll lm b"><strong class="iw hj">sa-web-app</strong></code>和<code class="du lj lk ll lm b"><strong class="iw hj">sa-feedback</strong></code>。同时，这不适用于服务<code class="du lj lk ll lm b"><strong class="iw hj">sa-frontend</strong></code>的使者，使我们能够得到未经认证的前端。要应用该策略，请执行以下命令:</p><pre class="jx jy jz ka fd lp lm lq lr aw ls bi"><span id="f3a9" class="lt kg hi lm b fi lu lv l lw lx"><strong class="lm hj">$ kubectl apply -f resource-manifests/istio/security/auth-policy.yaml<br/></strong>policy.authentication.istio.io “auth-policy” created</span></pre><p id="0763" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">回到页面做一个请求，你会看到以401 Unauthorized结尾，现在让我们从前端转发用户用Auth0认证。</p><h1 id="59f3" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">使用Auth0验证请求</h1><p id="9391" class="pw-post-body-paragraph it iu hi iw b ix ld iz ja jb le jd je jt lf jh ji ju lg jl jm jv lh jp jq jr hb bi translated">为了验证终端用户的请求，我们需要在Auth0中创建一个API，它代表经过验证的服务，即:评论、细节和评级。要创建API，请导航到<strong class="iw hj"> Auth0门户</strong>&gt;<strong class="iw hj">API</strong>&gt;<strong class="iw hj">创建API </strong>，如下图所示。</p><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="ab fe cl li"><img src="../Images/76df77a560cb35f114cf665949c43eba.png" data-original-src="https://miro.medium.com/v2/format:webp/1*5HTL6Ji4yVn1mmzFrsoquA.png"/></div><figcaption class="kb kc et er es kd ke bd b be z dx translated">图3。在Auth0中创建新的API</figcaption></figure><p id="c3b5" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">这里的重要信息是稍后在脚本中使用的标识符，如:</p><ul class=""><li id="0335" class="ly lz hi iw b ix iy jb jc jt ma ju mb jv mc jr md me mf mg bi translated"><strong class="iw hj">观众:</strong>{你的观众}</li></ul><p id="e466" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">其余需要的细节在Auth0门户的<strong class="iw hj">应用</strong>下，然后选择自动创建的与API同名的<strong class="iw hj">测试应用</strong>。</p><p id="02c4" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">在这里记下:</p><ul class=""><li id="555e" class="ly lz hi iw b ix iy jb jc jt ma ju mb jv mc jr md me mf mg bi translated"><strong class="iw hj">域:</strong>{您的域}</li><li id="979d" class="ly lz hi iw b ix mh jb mi jt mj ju mk jv ml jr md me mf mg bi translated"><strong class="iw hj">客户Id:</strong>{您的客户ID}</li></ul><p id="e2d2" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">在测试应用程序中向下滚动到<strong class="iw hj"> Allowed Callback URLs </strong>文本字段，在这里我们指定在认证完成后呼叫应该转发到的URL，在我们的例子中是:</p><p id="b743" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated"><code class="du lj lk ll lm b"><a class="ae js" rel="noopener ugc nofollow" target="_blank" href="/google-cloud/{EXTERNAL_IP}/callback">http://{EXTERNAL_IP}/callback</a></code></p><p id="4fef" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">添加对于<strong class="iw hj">允许的注销URL</strong>添加以下URL:</p><p id="ad51" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated"><code class="du lj lk ll lm b"><a class="ae js" rel="noopener ugc nofollow" target="_blank" href="/google-cloud/{EXTERNAL_IP}/logout">http://{EXTERNAL_IP}/logout</a></code></p><p id="9d9c" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">我们去前台吧。</p><h1 id="f8f1" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">更新前端</h1><p id="0833" class="pw-post-body-paragraph it iu hi iw b ix ld iz ja jb le jd je jt lf jh ji ju lg jl jm jv lh jp jq jr hb bi translated">签出到<code class="du lj lk ll lm b">[istio-mastery]</code>存储库的分支<strong class="iw hj"> auth0 </strong>。在此分支中，前端包含代码更改，将用户转发到Auth0进行身份验证，并在对其他服务的请求中使用JWT令牌，如下所示:</p><figure class="jx jy jz ka fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="545e" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">要更新前端以使用您的租户的详细信息，请导航至文件<code class="du lj lk ll lm b">sa-frontend/src/services/Auth.js</code>,并用我们之前记录的值替换以下值:</p><figure class="jx jy jz ka fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="1d14" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">应用程序准备就绪，在下面的命令中指定您的docker用户id，然后构建和部署更改:</p><pre class="jx jy jz ka fd lp lm lq lr aw ls bi"><span id="40ca" class="lt kg hi lm b fi lu lv l lw lx"><strong class="lm hj">$ docker build -f sa-frontend/Dockerfile \<br/> -t $DOCKER_USER_ID/sentiment-analysis-frontend:istio-auth0 \<br/> sa-frontend</strong></span><span id="28cc" class="lt kg hi lm b fi mm lv l lw lx"><strong class="lm hj">$ docker push $DOCKER_USER_ID/sentiment-analysis-frontend:istio-auth0</strong></span><span id="1950" class="lt kg hi lm b fi mm lv l lw lx"><strong class="lm hj">$ kubectl set image deployment/sa-frontend \<br/> sa-frontend=$DOCKER_USER_ID/sentiment-analysis-frontend:istio-auth0</strong></span></pre><p id="8335" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">试试这个应用吧！您将被转发到Auth0，在那里您必须登录(或注册),然后被转发回页面，并可以发出经过身份验证的请求。同时，如果您尝试早期的curl命令，您将得到一个401状态代码，表明该请求是未经授权的。</p><p id="b2f0" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">让我们更进一步，授权请求。</p><h1 id="f608" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">使用Auth0授权</h1><p id="f335" class="pw-post-body-paragraph it iu hi iw b ix ld iz ja jb le jd je jt lf jh ji ju lg jl jm jv lh jp jq jr hb bi translated">身份验证使我们能够知道用户是谁，但我们需要授权才能知道他们可以访问什么。Istio也为此提供了工具！</p><p id="d9ad" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">例如，我们将创建两组用户(如图24所示):</p><ul class=""><li id="1044" class="ly lz hi iw b ix iy jb jc jt ma ju mb jv mc jr md me mf mg bi translated"><strong class="iw hj">用户</strong>:只能访问SA-WebApp和SA-Frontend服务。</li><li id="4698" class="ly lz hi iw b ix mh jb mi jt mj ju mk jv ml jr md me mf mg bi translated"><strong class="iw hj">版主</strong>:谁可以访问所有三个服务。</li></ul><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="ab fe cl li"><img src="../Images/9b776e12123a5e73113c3aaa2f8318f4.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ywhs7Ccrmomw-_saf_Ny5Q.png"/></div><figcaption class="kb kc et er es kd ke bd b be z dx translated">图4。授权概念</figcaption></figure><p id="0d9d" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">为了创建用户组，我们将使用Auth0授权扩展，然后使用Istio为他们提供不同级别的访问权限。</p><h1 id="f313" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">安装和配置Auth0授权</h1><p id="1718" class="pw-post-body-paragraph it iu hi iw b ix ld iz ja jb le jd je jt lf jh ji ju lg jl jm jv lh jp jq jr hb bi translated">在Auth0门户中，导航到扩展并安装“Auth0 Authorization”扩展。安装完成后，导航到授权扩展，通过单击右上角的租户并选择菜单选项“配置”进行配置。启用群组，点击按钮<strong class="iw hj">发布规则</strong>。</p><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="ab fe cl li"><img src="../Images/d7506bb23915a38505327c2d05d18e6a.png" data-original-src="https://miro.medium.com/v2/format:webp/1*Ws7lIabKUyps3tiYri8NIg.png"/></div><figcaption class="kb kc et er es kd ke bd b be z dx translated">图5。激活令牌内容中的组</figcaption></figure><h1 id="0f86" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">创建组</h1><p id="3b83" class="pw-post-body-paragraph it iu hi iw b ix ld iz ja jb le jd je jt lf jh ji ju lg jl jm jv lh jp jq jr hb bi translated">在授权扩展中，导航到<strong class="iw hj">组</strong>并创建版主组。同时，我们将把所有经过身份验证的用户视为普通用户，因此没有必要创建额外的组。</p><p id="442d" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">选择版主组并点击添加成员，添加您的主帐户。让一些用户没有任何组来验证对他们的访问是禁止的。(您可以在Auth0门户&gt;用户&gt;创建用户中手动注册新用户)</p><h1 id="906e" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">向访问令牌添加组声明</h1><p id="ea99" class="pw-post-body-paragraph it iu hi iw b ix ld iz ja jb le jd je jt lf jh ji ju lg jl jm jv lh jp jq jr hb bi translated">用户被添加到组中，但此信息不会反映在访问令牌中。为了保持OpenID Connect一致性，同时返回组，我们需要<a class="ae js" href="https://auth0.com/docs/tokens/access-token#add-custom-claims" rel="noopener ugc nofollow" target="_blank">向令牌添加自定义命名空间声明</a>。这可以使用Auth0规则来完成。</p><p id="de35" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">要在Auth0门户中创建规则，请导航到Rules，单击“创建规则”并从模板中选择一个空规则<strong class="iw hj">。</strong></p><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="ab fe cl li"><img src="../Images/8bc8cdc286468c7dcdcc1f40749c6b9e.png" data-original-src="https://miro.medium.com/v2/format:webp/1*cYQlF2UIETjY85hV9Tixzw.png"/></div><figcaption class="kb kc et er es kd ke bd b be z dx translated">图6。创建新规则</figcaption></figure><p id="c939" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">粘贴下面的代码并保存名为“添加组声明”的新规则。</p><figure class="jx jy jz ka fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="40fa" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated"><strong class="iw hj">注意:</strong>这段代码选择授权扩展中定义的第一组用户，并将其作为自定义命名空间声明添加到访问令牌中。</p><p id="b1d8" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">返回到<strong class="iw hj">规则页面</strong>并验证您是否按此顺序获得了两个角色:</p><ul class=""><li id="db99" class="ly lz hi iw b ix iy jb jc jt ma ju mb jv mc jr md me mf mg bi translated">auth 0-授权-扩展</li><li id="4fbf" class="ly lz hi iw b ix mh jb mi jt mj ju mk jv ml jr md me mf mg bi translated">添加组索赔</li></ul><p id="aba8" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">顺序很重要，因为group字段是由<code class="du lj lk ll lm b"><strong class="iw hj">auth0-authorization-extension</strong></code>规则异步检索的，然后由第二个规则作为命名空间声明添加，产生了下面的访问令牌:</p><pre class="jx jy jz ka fd lp lm lq lr aw ls bi"><span id="f02d" class="lt kg hi lm b fi lu lv l lw lx">{<br/> "https://sa.io/group": "Moderators",<br/> "iss": "https://sentiment-analysis.eu.auth0.com/",<br/> "sub": "google-oauth2|196405271625531691872"<br/> // [shortened for brevity]<br/>}</span></pre><p id="852f" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">现在，我们必须配置特使代理，通过从返回的访问令牌中的声明<code class="du lj lk ll lm b">https://sa.io/group</code>中提取组来验证用户访问。那是下一节的主题，让我们移到那边去。</p><h1 id="f33c" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">在Istio中配置授权</h1><p id="17ad" class="pw-post-body-paragraph it iu hi iw b ix ld iz ja jb le jd je jt lf jh ji ju lg jl jm jv lh jp jq jr hb bi translated">为了获得授权，我们需要为Istio启用RBAC。为此，请对网格应用以下配置:</p><figure class="jx jy jz ka fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><ol class=""><li id="23ba" class="ly lz hi iw b ix iy jb jc jt ma ju mb jv mc jr mn me mf mg bi translated">仅对包含字段中指定的服务和/或命名空间启用RBAC。</li><li id="0fd5" class="ly lz hi iw b ix mh jb mi jt mj ju mk jv ml jr mn me mf mg bi translated">包括指定的服务列表。</li></ol><p id="31db" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">通过执行以下命令来应用配置:</p><pre class="jx jy jz ka fd lp lm lq lr aw ls bi"><span id="0e3a" class="lt kg hi lm b fi lu lv l lw lx"><strong class="lm hj">$ kubectl apply -f resource-manifests/istio/security/enable-rbac.yaml<br/></strong>rbacconfig.rbac.istio.io/default created</span></pre><p id="46e2" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">现在，所有服务都需要基于角色的访问控制，换句话说，对所有服务的访问都被拒绝，并将导致响应“RBAC:访问被拒绝”。允许授权用户访问将是下一节的主题。</p><h1 id="1880" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">配置常规用户访问</h1><p id="13c8" class="pw-post-body-paragraph it iu hi iw b ix ld iz ja jb le jd je jt lf jh ji ju lg jl jm jv lh jp jq jr hb bi translated">所有用户都应该能够访问<strong class="iw hj">SA-前端</strong>和<strong class="iw hj"> SA-WebApp </strong>服务，这是通过以下Istio资源实现的:</p><ul class=""><li id="d72d" class="ly lz hi iw b ix iy jb jc jt ma ju mb jv mc jr md me mf mg bi translated"><strong class="iw hj"> ServiceRole: </strong>指定用户拥有的权限</li><li id="0988" class="ly lz hi iw b ix mh jb mi jt mj ju mk jv ml jr md me mf mg bi translated"><strong class="iw hj"> ServiceRoleBinding: </strong>指定服务角色适用于谁。</li></ul><p id="4436" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">对于普通用户，我们将允许访问指定的服务:</p><figure class="jx jy jz ka fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="5865" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">并且使用<strong class="iw hj">常规用户绑定</strong>我们将把ServiceRole应用到我们页面的所有访问者:</p><figure class="jx jy jz ka fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="9ce4" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">哦！所有用户这意味着未经身份验证的用户可以SA WebApp？不，该策略仍将检查JWT令牌的有效性。😉</p><p id="daec" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">应用配置:</p><pre class="jx jy jz ka fd lp lm lq lr aw ls bi"><span id="9bcf" class="lt kg hi lm b fi lu lv l lw lx"><strong class="lm hj">$ kubectl apply -f resource-manifests/istio/security/user-role.yaml<br/></strong>servicerole.rbac.istio.io/regular-user created<br/>servicerolebinding.rbac.istio.io/regular-user-binding created</span></pre><h1 id="83ff" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">配置仲裁者用户访问</h1><p id="c136" class="pw-post-body-paragraph it iu hi iw b ix ld iz ja jb le jd je jt lf jh ji ju lg jl jm jv lh jp jq jr hb bi translated">对于我们的版主，我们希望能够访问所有服务:</p><figure class="jx jy jz ka fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="ba31" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">但是我们希望只将它绑定到那些访问令牌拥有等同于值仲裁者的声明<code class="du lj lk ll lm b">https://sa.io/group</code>的用户。</p><figure class="jx jy jz ka fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="39aa" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">要应用配置，请执行:</p><pre class="jx jy jz ka fd lp lm lq lr aw ls bi"><span id="d7cd" class="lt kg hi lm b fi lu lv l lw lx"><strong class="lm hj">$ kubectl apply -f resource-manifests/istio/security/mod-role.yaml<br/></strong>servicerole.rbac.istio.io/mod-user created<br/>servicerolebinding.rbac.istio.io/mod-user-binding created</span></pre><p id="8b02" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">由于特使中的缓存，授权规则可能需要几分钟才能生效，但在此之后，您将能够验证用户和版主具有不同的访问级别。</p><h1 id="09e9" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">第2部分—总结</h1><p id="d58a" class="pw-post-body-paragraph it iu hi iw b ix ld iz ja jb le jd je jt lf jh ji ju lg jl jm jv lh jp jq jr hb bi translated">说真的，你见过更简单的、零工作量的、可扩展的、安全的认证和授权概念吗？</p><p id="8a50" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">仅使用三种Istio资源(RbacConfig、ServiceRole和ServiceRoleBinding ),我们就可以对认证和授权终端用户访问我们的服务进行细粒度控制。</p><p id="a0f8" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">此外，我们将这些顾虑从我们的服务中转移给特使，我们:</p><ul class=""><li id="8379" class="ly lz hi iw b ix iy jb jc jt ma ju mb jv mc jr md me mf mg bi translated">减少安全问题和错误可能潜入的样板代码，</li><li id="94db" class="ly lz hi iw b ix mh jb mi jt mj ju mk jv ml jr md me mf mg bi translated">减少由于忘记注释而暴露一个端点的愚蠢情况。</li><li id="2373" class="ly lz hi iw b ix mh jb mi jt mj ju mk jv ml jr md me mf mg bi translated">您消除了每次添加新角色或权限时更新所有服务的连锁反应。</li><li id="483c" class="ly lz hi iw b ix mh jb mi jt mj ju mk jv ml jr md me mf mg bi translated">简单、安全、快速地添加新服务。</li></ul><h1 id="c583" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">结论</h1><p id="3e1d" class="pw-post-body-paragraph it iu hi iw b ix ld iz ja jb le jd je jt lf jh ji ju lg jl jm jv lh jp jq jr hb bi translated">Istio使您的团队能够再一次将他们的资源集中在提供商业价值上，而没有仪式性的服务开销，最终让他们回到<strong class="iw hj">微观</strong>。</p><p id="a63b" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">本文为您提供了坚实的知识和实际操作，让您在现实世界的项目中开始使用Istio。</p><p id="b399" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jt jg jh ji ju jk jl jm jv jo jp jq jr hb bi translated">我借此机会感谢你和我一起踏上这次旅程，这当然不容易，你能坚持下来真是太棒了。我很想在下面的评论中听到你的想法，也可以随时在rinormaloku.com的<a class="ae js" href="https://twitter.com/rinormaloku" rel="noopener ugc nofollow" target="_blank">推特</a>或我的页面<a class="ae js" href="https://rinormaloku.com" rel="noopener ugc nofollow" target="_blank">上联系我。</a></p></div></div>    
</body>
</html>