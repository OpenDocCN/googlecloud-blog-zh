<html>
<head>
<title>Troubleshooting Google Cloud SQL “Misleading” ERROR during restore</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">恢复期间Google Cloud SQL“误导性”错误故障排除</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/troubleshooting-google-cloud-sql-misleading-error-during-restore-2992033f165f?source=collection_archive---------0-----------------------#2022-08-14">https://medium.com/google-cloud/troubleshooting-google-cloud-sql-misleading-error-during-restore-2992033f165f?source=collection_archive---------0-----------------------#2022-08-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f496" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Google Cloud SQL误导性错误:(g Cloud . SQL . backups . restore)HTTPError 403:客户端未被授权进行此请求。</strong></p><p id="b943" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">错误:(g cloud . SQL . backups . restore)HTTPError 403:客户端无权进行此请求。</em> </strong></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/e251819496f05d4f3949cdc71fa7d164.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OjX8j_lfZwq9B4oB_0ThNw.png"/></div></div></figure><p id="c58c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您在恢复云SQL备份时出现上述错误，这肯定表明相关IAM用户缺乏恢复备份所需的权限，但有时此错误消息具有误导性，根本原因可能是其他原因。</p><p id="15cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">初步看来，这似乎是一个权限问题——恢复到不同项目的用户必须拥有目标项目的<em class="jd">cloud SQL . instances . restore backup</em>权限和源实例的<em class="jd"> cloudsql.backupRuns.get </em>权限。这些权限包含在云SQL管理员角色中。</p><p id="90d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">博客的范围仅限于同一个项目，因此让我们在现有云SQL实例上重新创建场景:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="0dea" class="jv jw hi jr b fi jx jy l jz ka"><strong class="jr hj"><em class="jd">$ gcloud sql instances list</em></strong></span><span id="8954" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">NAME DATABASE_VERSION LOCATION TIER PRIMARY_ADDRESS PRIVATE_ADDRESS STATUS</em></strong></span><span id="9808" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">pg-db11 POSTGRES_10 asia-south1-a db-custom-8–32768 XX.XXX.XX.XXX 10.45.193.230 RUNNABLE</em></strong></span><span id="2e9c" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">mymart2 MYSQL_5_7 asia-south1-a db-custom-4–26624–10.45.193.3 STOPPED</em></strong></span><span id="41bd" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">$</em></strong></span></pre><p id="ea20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我将把<em class="jd"> pg-db11 </em>的备份恢复到另一个实例pg-db22，然后让我们列出成功的备份，并选择其中一个备份进行恢复。</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="e7e3" class="jv jw hi jr b fi jx jy l jz ka"><strong class="jr hj"><em class="jd">$ gcloud sql backups list — instance pg-db11</em></strong></span><span id="641f" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">ID WINDOW_START_TIME ERROR STATUS INSTANCE</em></strong></span><span id="a98b" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">1660312099586 2022–08–12T13:48:19.586+00:00 — SUCCESSFUL pg-db11</em></strong></span><span id="f1e4" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">1659712251075 2022–08–05T15:10:51.075+00:00 — SUCCESSFUL pg-db11</em></strong></span></pre><p id="d3af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们验证实例是否存在:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="3007" class="jv jw hi jr b fi jx jy l jz ka"><strong class="jr hj"><em class="jd">$ gcloud sql instances list|grep pg-db22</em></strong></span><span id="026c" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">$</em></strong></span></pre><p id="2f6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以上结果表明目标实例不存在，如果我们尝试恢复该实例会怎样:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="0108" class="jv jw hi jr b fi jx jy l jz ka"><strong class="jr hj"><em class="jd">$ gcloud sql backups restore 1660312099586 \</em></strong></span><span id="63db" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">&gt; — restore-instance=pg-db22 \</em></strong></span><span id="b5e4" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">&gt; — backup-instance=pg-db11</em></strong></span><span id="b95a" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">All current data on the instance will be lost when the backup is restored.</em></strong></span><span id="e196" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">Do you want to continue (Y/n)? Y</em></strong></span><span id="1fad" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">ERROR: (gcloud.sql.backups.restore) HTTPError 403: The client is not authorized to make this request.</em></strong></span><span id="b726" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">$</em></strong></span></pre><p id="aebf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述错误表明当前gcloud用户缺乏所需的权限。因此，让我们检查用户是否拥有所需的权限:</p><p id="b643" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先确定当前gcloud环境的用户和服务帐户:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="4190" class="jv jw hi jr b fi jx jy l jz ka"><strong class="jr hj"><em class="jd">$ gcloud auth list</em></strong></span><span id="3c9a" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">Credentialed Accounts</em></strong></span><span id="d8a8" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">ACTIVE ACCOUNT</em></strong></span><span id="9169" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">* 664290125703-compute@developer.gserviceaccount.com</em></strong></span><span id="abd2" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">admin@shkm.altostrat.com</em></strong></span><span id="9742" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">To set the active account, run:</em></strong></span><span id="e14d" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">$ gcloud config set account `ACCOUNT`</em></strong></span><span id="1bca" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">$</em></strong></span></pre><p id="9a40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查上述用户是否具有云sql管理员角色。下面是上述输出的摘录，表明它已经具有所需的权限:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="87e5" class="jv jw hi jr b fi jx jy l jz ka"><strong class="jr hj"><em class="jd">$ gcloud projects get-iam-policy shailesh-1</em></strong></span><span id="0795" class="jv jw hi jr b fi kb jy l jz ka"><em class="jd">[output is truncated here for better visibility]</em><br/>.<br/>.<br/>.<br/>.<br/>.</span><span id="33d3" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">role: roles/cloudsql.admin</em></strong></span><span id="0873" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">- members:</em></strong></span><span id="ab36" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">- serviceAccount:664290125703-compute@developer.gserviceaccount.com</em></strong></span><span id="86bb" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">- user:admin@shkm.altostrat.com</em></strong></span><span id="5e80" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">role: roles/cloudsql.editor</em></strong></span><span id="1899" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">- members:</em></strong></span><span id="4cda" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">- user:admin@shkm.altostrat.com</em></strong></span><span id="7369" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">role: roles/cloudsql.instanceUser</em></strong></span><span id="1f94" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">- members:</em></strong></span><span id="596d" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">- serviceAccount:664290125703-compute@developer.gserviceaccount.com</em></strong></span><span id="07d0" class="jv jw hi jr b fi kb jy l jz ka"><em class="jd">[output is truncated here for better visibility]</em><br/>.<br/>.<br/>.<br/>.<br/>.<br/>.</span><span id="304a" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">version: 1</em></strong></span><span id="a93f" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">$</em></strong></span></pre><p id="6481" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述输出确认不存在权限问题，因为当前用户是"<strong class="ih hj"> <em class="jd">角色:roles/cloudsql.admin" </em> </strong>的一部分。</p><p id="6b1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看，根据最佳实践，我们是否已经有了一个目标实例。当您将备份恢复到不同的实例时，请记住以下限制和最佳做法:</p><ol class=""><li id="e0c1" class="kc kd hi ih b ii ij im in iq ke iu kf iy kg jc kh ki kj kk bi translated">目标实例必须与从中获取备份的实例具有相同的数据库版本。</li><li id="ae38" class="kc kd hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">目标实例的存储容量必须至少与正在备份的实例的容量一样大。使用的存储量无关紧要。您可以在控制台云SQL实例页面中看到实例的存储容量</li><li id="b3a1" class="kc kd hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">目标实例必须处于可运行状态。</li><li id="e1fb" class="kc kd hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">目标实例的核心数或内存量可以不同于从中进行备份的实例。</li><li id="cdf4" class="kc kd hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">目标实例可以与源实例位于不同的区域。</li><li id="50e2" class="kc kd hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">在停机期间，您仍然可以检索特定项目中的备份列表。</li></ol><p id="0214" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们验证目标云SQL SQL实例pg-db22是否存在:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="04c0" class="jv jw hi jr b fi jx jy l jz ka"><strong class="jr hj"><em class="jd">$ gcloud sql instances list|grep pg-db22</em></strong></span><span id="eb56" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">$</em></strong></span></pre><p id="e377" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的输出表明这个实例不存在，所以让我们按照上面指定的最佳实践来创建:目标实例必须具有与从中获取备份的实例相同的数据库版本。</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="c9f6" class="jv jw hi jr b fi jx jy l jz ka"><strong class="jr hj"><em class="jd">$ gcloud sql instances create pg-db22 — database-version=POSTGRES_10 — cpu=4 — memory=16GiB — zone=asia-south1-a — root-password=Welcome0</em></strong></span><span id="906f" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">Creating Cloud SQL instance…done.</em></strong></span><span id="41b4" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">Created [https://sqladmin.googleapis.com/sql/v1beta4/projects/shailesh-1/instances/pg-db22].</em></strong></span><span id="206d" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">NAME DATABASE_VERSION LOCATION TIER PRIMARY_ADDRESS PRIVATE_ADDRESS STATUS</em></strong></span><span id="f28a" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">pg-db22 POSTGRES_10 asia-south1-a db-custom-4–16384 XX.XXX.XX.XXX — RUNNABLE</em></strong></span><span id="0b7a" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">$</em></strong></span></pre><p id="5165" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们验证:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="4ff1" class="jv jw hi jr b fi jx jy l jz ka"><strong class="jr hj"><em class="jd">$ gcloud sql instances list|grep pg-db22</em></strong></span><span id="bd18" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">pg-db22 POSTGRES_10 asia-south1-a db-custom-4–16384 XX.XXX.XX.XXX — RUNNABLE</em></strong></span><span id="50ed" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">$</em></strong></span></pre><p id="0043" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们使用之前出现错误的命令进行恢复:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="92ae" class="jv jw hi jr b fi jx jy l jz ka"><strong class="jr hj"><em class="jd">$ gcloud sql backups restore 1660312099586 — restore-instance=pg-db22 — backup-instance=pg-db11</em></strong></span><span id="f304" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">All current data on the instance will be lost when the backup is restored.</em></strong></span><span id="f030" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">Do you want to continue (Y/n)? Y</em></strong></span><span id="4876" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">Restoring Cloud SQL instance…done.</em></strong></span><span id="98d2" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">Restored [https://sqladmin.googleapis.com/sql/v1beta4/projects/shailesh-1/instances/pg-db22].</em></strong></span><span id="a223" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">$</em></strong></span></pre><p id="8fcf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">耶，现在成功了:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="af01" class="jv jw hi jr b fi jx jy l jz ka"><strong class="jr hj"><em class="jd">$ gcloud sql instances list</em></strong></span><span id="5001" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">NAME DATABASE_VERSION LOCATION TIER PRIMARY_ADDRESS PRIVATE_ADDRESS STATUS</em></strong></span><span id="f40f" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">pg-db22 POSTGRES_10 asia-south1-a db-custom-4–16384 XX.XXX.XX.XXX — RUNNABLE</em></strong></span><span id="6c1e" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">pg-db11 POSTGRES_10 asia-south1-a db-custom-8–32768 XX.XXX.XX.XXX 10.45.193.230 RUNNABLE</em></strong></span><span id="813c" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">mymart2 MYSQL_5_7 asia-south1-a db-custom-4–26624–10.45.193.3 STOPPED</em></strong></span><span id="801e" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj"><em class="jd">$</em></strong></span></pre><p id="5ac0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这有所帮助。</p></div></div>    
</body>
</html>