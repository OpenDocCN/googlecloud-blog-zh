<html>
<head>
<title>Terraform CDK GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">地形CDK GCP</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/terraform-cdk-gcp-5455c481f364?source=collection_archive---------1-----------------------#2022-11-03">https://medium.com/google-cloud/terraform-cdk-gcp-5455c481f364?source=collection_archive---------1-----------------------#2022-11-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2536" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GCP CDK Terraform公司入门</p><p id="1556" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在过去的几个月里，我们被分配了围绕资源调配创建一些标准的任务。我们想写一些可以作为迁移一部分的机器。它们应该是从同一块布上剪下来的，同时让我们能够更快地旋转机器。我们用传统的terraform HCL编写代码；然而，我们尝试了另一种策略，我将在这里演示。另一个动机是为Google-Cloud写点东西，因为目前在GCP的terraform网站上还没有官方的入门指南。</p><h2 id="3e36" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">目标</h2><p id="352c" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">在这篇博客的结尾，我们将实现以下目标</p><ol class=""><li id="41ab" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated">可以根据请求创建机器的代码库</li><li id="cf28" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">验证输入变量并将其转换为对象</li><li id="348e" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">使用语言来自动化任务，这是CDKs背后的动机</li><li id="f8f0" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">一个真实的机器应该被创造出来</li><li id="5ba2" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">将文件作为一个对象来处理，而不是像标准地形代码中的地图一样</li></ol><h1 id="de48" class="kr je hi bd jf ks kt ku jj kv kw kx jn ky kz la jq lb lc ld jt le lf lg jw lh bi translated">要求</h1><p id="5702" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">使用terraform-cdk有一些硬性要求和语言依赖性。我把它们列在下面</p><ol class=""><li id="5627" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated">为了使用CDKTF，您需要:</li></ol><ul class=""><li id="8af4" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc li kj kk kl bi translated"><a class="ae lj" href="https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli" rel="noopener ugc nofollow" target="_blank"> Terraform CLI </a> (1.1+)。</li><li id="5455" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc li kj kk kl bi translated"><a class="ae lj" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>和npm v16+。</li></ul><p id="f839" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.有Tyepscript方面的经验者优先</p><p id="7bb4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.一些处理yaml文件的开发库</p><h1 id="926f" class="kr je hi bd jf ks kt ku jj kv kw kx jn ky kz la jq lb lc ld jt le lf lg jw lh bi translated">方法</h1><p id="0218" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">为了解决第一组问题，我们采用了GitOps工作流的方法。在这里，人们可以确定他们在YAML需要的资源，CDK可以为他们提供这些资源。然而，在企业级项目中，它必须得到are云操作团队的批准，以确保不会引入安全漏洞。我们将采取以下步骤来实现同样的目标</p><ol class=""><li id="219b" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated">安装CDK和地形。我们已经在terraform的<a class="ae lj" href="https://developer.hashicorp.com/terraform/tutorials/cdktf/cdktf-install#prerequisites" rel="noopener ugc nofollow" target="_blank">官方</a>页面记录了这一点</li><li id="c408" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">我们已经将代码保存在<a class="ae lj" href="https://github.com/shubhamkr619/ckdtf-gcp" rel="noopener ugc nofollow" target="_blank"> Github </a>中。这个代码是开放使用的</li><li id="23f9" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">您可以在gcp_projects文件夹下的yaml文件中定义所需的资源</li><li id="fbe8" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">执行代码并捕获输出</li></ol><h2 id="27f7" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">https://www.terraform.io/cdktf CDK<a class="ae lj" href="https://www.terraform.io/cdktf" rel="noopener ugc nofollow" target="_blank">安装</a></h2><p id="3442" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">一旦安装了node js，CDKTF就是另一个必须下载的外部程序。这可以使用NPM来完成</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="274f" class="jd je hi lp b fi lt lu l lv lw">$ npm install --global cdktf-cli@latest #installing the package</span><span id="581e" class="jd je hi lp b fi lx lu l lv lw">$ cdktf help # Verifying the installation </span><span id="de31" class="jd je hi lp b fi lx lu l lv lw"># Install npm package for GCP</span><span id="5574" class="jd je hi lp b fi lx lu l lv lw">$ npm install @cdktf/provider-google</span></pre><h2 id="d4a6" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">设置新项目</h2><p id="79df" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">CDKTF自带用于搭建新项目的命令。人们也可以从这个<a class="ae lj" href="https://developer.hashicorp.com/terraform/tutorials/cdktf/cdktf-install#quick-start-tutorial" rel="noopener ugc nofollow" target="_blank">链接</a>开始</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="8383" class="jd je hi lp b fi lt lu l lv lw">$ cdktf init --template=typescript --local</span><span id="54b8" class="jd je hi lp b fi lx lu l lv lw"># This step should add google provider <br/>$ cdktf provider add google</span><span id="2aec" class="jd je hi lp b fi lx lu l lv lw"># Verify </span><span id="22c8" class="jd je hi lp b fi lx lu l lv lw">$ cat cdktf.json <br/>{<br/>  "language": "typescript",<br/>  "app": "npx ts-node main.ts",<br/>  "projectId": "32bba6c6-91a9-4deb-879b-33f55335c2f7",<br/>  "sendCrashReports": "false",<br/>  "terraformProviders": [],<br/>  "terraformModules": [],<br/>  "context": {<br/>    "excludeStackIdFromLogicalIds": "true",<br/>    "allowSepCharsInLogicalIds": "true"<br/>  }<br/>}</span></pre><h2 id="6415" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">安装Yaml处理库</h2><p id="5041" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">我们正在尝试处理yaml文件，为此我们将使用<em class="ly"> js-yaml </em>。我们将安装它并将其存储在npm package.json文件中。此外，我们希望像java-log4j一样保存日志。我们将安装相同的另一个包，即<em class="ly"> log4js </em></p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="d5be" class="jd je hi lp b fi lt lu l lv lw"># install js-yaml  </span><span id="ac45" class="jd je hi lp b fi lx lu l lv lw">$ npm install --save <a class="ae lj" href="http://twitter.com/types/js-yaml" rel="noopener ugc nofollow" target="_blank">@types/js-yaml</a></span><span id="c1b9" class="jd je hi lp b fi lx lu l lv lw"># Log4js<br/>$ npm install --save <a class="ae lj" href="http://twitter.com/types/js-yaml" rel="noopener ugc nofollow" target="_blank">l</a>og4js</span></pre><h2 id="c116" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">设置凭据</h2><p id="9a80" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">在执行代码之前，必须设置凭证，使用<em class="ly"> gcloud auth login </em>进行设置。</p><h2 id="ecaf" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">让我们写一些代码</h2><p id="b339" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">我在<a class="ae lj" href="https://github.com/shubhamkr619/ckdtf-gcp" rel="noopener ugc nofollow" target="_blank"> Github </a>中写了一些代码，并将其公开。我将在这里解释这个想法，预处理，接口映射，然后创建地形对象。</p><p id="e184" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">预处理</strong></p><p id="ac25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们挑选一个操作员应该提供的yaml文件的例子，我已经制作了一个经过处理的例子文件，</p><figure class="lk ll lm ln fd ma er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es lz"><img src="../Images/159da5293b6b157d11cfd708d4714307.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QSVZKJfr0MfzdER_e7NhBg.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">project.yaml</figcaption></figure><figure class="lk ll lm ln fd ma er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es ml"><img src="../Images/bb002f20b428962d6b73af490e413d8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h4fz0triy6icklvKvSUppA.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">test.yaml文件</figcaption></figure><p id="c5b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将是我们可以处理的yaml文件。我来举例说明一下预处理代码。</p><figure class="lk ll lm ln fd ma er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es mm"><img src="../Images/1bb44196bcec02b53208ed1544664211.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kv7b7kOtvE-OZgpWFzLmQw.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">预处理. yaml</figcaption></figure><h1 id="5408" class="kr je hi bd jf ks kt ku jj kv kw kx jn ky kz la jq lb lc ld jt le lf lg jw lh bi translated">处理</h1><p id="816c" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">这里，我们只需要处理对象，即projectInfo。该对象将封装gcpObjects。使得处理过程对开发人员非常友好。</p><figure class="lk ll lm ln fd ma er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es mn"><img src="../Images/cffa282a33c5b92fe9d38eb38d4e975d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vcnvnGbj3jXftWWuDVdq1w.png"/></div></div></figure><h1 id="e03d" class="kr je hi bd jf ks kt ku jj kv kw kx jn ky kz la jq lb lc ld jt le lf lg jw lh bi translated">输出</h1><p id="a66a" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">我们必须执行两个命令，一个确保成功编译，另一个执行与terraform deploy相同的代码。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="8537" class="jd je hi lp b fi lt lu l lv lw">$ cdktf synth # compile the code and create the intermidiate file in cdktf.out folder<br/>$ cdktf deploy # executes the terraform apply </span></pre><figure class="lk ll lm ln fd ma er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es mo"><img src="../Images/abf3881b21875a8911c48455f3b5484a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VZ2GMA-15FVNcB9PNXjq3g.png"/></div></div></figure><h2 id="8b34" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">结论</h2><p id="678f" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">我们用这种方法取得了成功，减少了处理代码。它比terraform HCL的可变处理逻辑更具可读性。然而，它也不是没有缺陷，你必须了解像typescript和python这样的语言，代码质量必须像任何代码库一样保持，Git实践必须遵循，像分支和PR等。</p></div></div>    
</body>
</html>