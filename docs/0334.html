<html>
<head>
<title>How to make Ubuntu backups using Duplicity and Google Cloud Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Duplicity和谷歌云存储进行Ubuntu备份</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-make-ubuntu-backups-using-duplicity-and-google-cloud-storage-849edcc4196e?source=collection_archive---------0-----------------------#2017-07-12">https://medium.com/google-cloud/how-to-make-ubuntu-backups-using-duplicity-and-google-cloud-storage-849edcc4196e?source=collection_archive---------0-----------------------#2017-07-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="97b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我的第一篇媒体文章。我将主要写我在<a class="ae jd" href="https://openstate.eu/" rel="noopener ugc nofollow" target="_blank"> Open State Foundation </a>做开发者期间遇到的技术问题。</p><p id="91e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们最近不得不改变我们的备份策略。我们曾经使用<a class="ae jd" href="http://backuppc.sourceforge.net/" rel="noopener ugc nofollow" target="_blank"> BackupPC </a>将我们的服务器备份到我们办公室的一台服务器上。当我们的房东换了一家新的ISP，大幅提高了带宽和colo价格时，这就变得太贵了。因此，我们不得不将备份存储在异地。我们考虑过使用专用服务器，但是考虑到我们想要备份的数据量(2tb ), Google云存储更便宜。这主要是由于谷歌通过其<a class="ae jd" href="https://cloud.google.com/storage/archival/" rel="noopener ugc nofollow" target="_blank">近线存储</a>专门为备份/存档目的提供的价格(每月每GB 0.01美元)，尽管亚马逊也提供类似的服务，名为<a class="ae jd" href="https://aws.amazon.com/glacier/" rel="noopener ugc nofollow" target="_blank"> Glacier </a>。我们也可以选择Coldline，但这要求您在删除之前将数据存储至少90天，而Nearline只需要30天，这对于我们的备份来说足够了。</p><p id="c872" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们希望在将数据备份到谷歌的服务器之前对其进行加密，并选择了<a class="ae jd" href="http://duplicity.nongnu.org/" rel="noopener ugc nofollow" target="_blank"> Duplicity </a>，因为它是开源的，节省空间，自(2002年，实际上是自2007年)以来一直在不断发展<a class="ae jd" href="http://duplicity.nongnu.org/CHANGELOG" rel="noopener ugc nofollow" target="_blank">并支持谷歌云存储。</a></p><h2 id="c594" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">创建备份</h2><p id="e6fd" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">首先，创建一个谷歌云平台(GCP)账户，启用谷歌云存储(GCS)并创建一个新项目。然后<a class="ae jd" href="https://console.cloud.google.com/storage/create-bucket" rel="noopener ugc nofollow" target="_blank">创建一个bucket </a>并使用一个惟一的、不敏感的名称，因为您使用GCS与其他人共享这个名称空间！我们选择近线作为“默认存储类别”。不过在选择地点时要小心！<a class="ae jd" href="https://cloud.google.com/storage/pricing#storage-pricing" rel="noopener ugc nofollow" target="_blank">有些地方比其他地方</a>更贵，例如<em class="ke">欧洲-西方-2 </em>每月每GB 0.16美元，而<em class="ke">欧洲-西方-1 </em>每月每GB 0.01美元。因此，确定你想在哪个洲存储你的数据，如果确切的位置不重要，选择最便宜的位置。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kf"><img src="../Images/bfea23e72dbe8a869e46493476e20d42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w8DBEbmb9pIv6ywcE--pwg.png"/></div></div></figure><p id="82d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了让Duplicity访问GCS，我们将向该项目添加一个新成员(这必须是一个现有的谷歌帐户)。在IAM &amp; Admin页面上执行此操作。我们只给这个新成员两个限制性的<a class="ae jd" href="https://cloud.google.com/iam/docs/understanding-roles?hl=en_US#predefined_roles" rel="noopener ugc nofollow" target="_blank">角色</a>(即权限)<em class="ke">存储对象创建者</em>和<em class="ke">存储对象查看者。</em>这确保了文件/备份只能从服务器创建，而不能被覆盖或删除(例如，被获得服务器访问权限的黑客)。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div class="er es kr"><img src="../Images/7ecea9409b3efb827e185358228ff6d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*8jLDIT65_mXtz8ZRHWtNVw.png"/></div></figure><p id="83b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，以新创建成员的身份登录，转到“存储”&gt;“设置”，然后选择“互操作性”选项卡。单击“启用互操作性访问”并创建新密钥。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es ks"><img src="../Images/f7180fd3e0588d840f5f4ebf836eaa8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3VDpbzCthqgoTcQfLQFB7Q.png"/></div></div></figure><p id="ff7d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在SSH进入你的服务器，安装Duplicity和<a class="ae jd" href="https://github.com/boto/boto" rel="noopener ugc nofollow" target="_blank"> boto </a>:</p><pre class="kg kh ki kj fd kt ku kv kw aw kx bi"><span id="bc91" class="je jf hi ku b fi ky kz l la lb">sudo add-apt-repository ppa:duplicity-team/ppa<br/>sudo apt-get update<br/>sudo apt-get install -y duplicity<br/>sudo pip install boto</span></pre><p id="92e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用您刚刚创建的互操作性访问密钥添加环境变量，并提供一个安全的密码短语(用于加密/解密您的备份)。<a class="ae jd" href="https://askubuntu.com/questions/935103/etc-environment-changes-reload-immediatly-in-ubuntu-16-04-but-not-in-14-04" rel="noopener ugc nofollow" target="_blank">确保</a>虽然下面一行以<code class="du lc ld le ku b">session</code>开始，而不是<code class="du lc ld le ku b">/etc/pam.d/sudo</code>中的<code class="du lc ld le ku b">auth</code>。打开<code class="du lc ld le ku b">/etc/environment</code>并添加以下几行:</p><pre class="kg kh ki kj fd kt ku kv kw aw kx bi"><span id="35a7" class="je jf hi ku b fi ky kz l la lb">GS_ACCESS_KEY_ID="<strong class="ku hj">&lt;your_access_key&gt;</strong>"<br/>GS_SECRET_ACCESS_KEY="<strong class="ku hj">&lt;your_secret&gt;</strong>"<br/>PASSPHRASE="<strong class="ku hj">&lt;your_passphrase&gt;</strong>"</span></pre><p id="783a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加以下每日cronjob，它将对<code class="du lc ld le ku b">/home</code>进行完整备份(如果不存在)，执行每日增量备份，并在上次完整备份一个月后进行另一次完整备份。运行<code class="du lc ld le ku b">sudo crontab -e</code>并添加以下行:</p><pre class="kg kh ki kj fd kt ku kv kw aw kx bi"><span id="3775" class="je jf hi ku b fi ky kz l la lb">0 0 * * * sudo sh -c ‘duplicity --archive-dir /root/.cache/duplicity/ --full-if-older-than 1M /home gs://<strong class="ku hj">&lt;bucket_name&gt;</strong> &gt;&gt; /var/log/duplicity.log’</span></pre><p id="9242" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在你口是心非的命令中总是使用<code class="du lc ld le ku b">--archive-dir /root/.cache/duplicity/</code>。这确保了即使另一个用户运行duplicaty命令，duplicaty也使用相同的本地缓存。如果您不这样做，Duplicity将通过从云存储下载文件来重建本地缓存，这是您希望避免的，因为从GCS近线下载会产生成本。此外，您可以通过添加<code class="du lc ld le ku b">--exclude</code>选项来排除目录。最后，指定一个错误的bucket名称会导致创建一个新的bucket <strong class="ih hj">(!)</strong>将对其应用操作！因此，请始终检查您是否指定了正确的存储桶名称！</p><h2 id="20f6" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">删除旧备份</h2><p id="ad76" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">GCS Nearline要求您将数据存储至少30天(如果您提前删除，则仍需支付30天的费用)。因为我们每个月都会创建一个新的完整备份，所以我们将为超过40天的文件添加删除策略。这给了我们至少10天的时间来注意我们需要访问备份的情况。我们可以使用欺骗来删除旧的备份，但我们不希望服务器能够这样做，因为黑客可能会滥用这一点来扰乱我们的备份。</p><p id="dc7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">相反，我们使用GCS提供的<a class="ae jd" href="https://cloud.google.com/storage/docs/managing-lifecycles#configexamples" rel="noopener ugc nofollow" target="_blank">生命周期管理</a>。以下步骤需要在您自己的台式机/笔记本电脑上执行，您需要在那里安装<a class="ae jd" href="https://cloud.google.com/storage/docs/gsutil_install#sdk-install" rel="noopener ugc nofollow" target="_blank"> gsutil </a>(我建议遵循“将gsutil安装为Google Cloud SDK的一部分”一节)。用以下内容创建一个名为<code class="du lc ld le ku b">gcs-lifecycle-management.json</code>的文件:</p><pre class="kg kh ki kj fd kt ku kv kw aw kx bi"><span id="2ae4" class="je jf hi ku b fi ky kz l la lb">{<br/>  "lifecycle": {<br/>    "rule": [<br/>      {<br/>        "action": {"type": "Delete"},<br/>        "condition": {<br/>          "age": 40<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><p id="40cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用此命令设置生命周期策略:<br/> <code class="du lc ld le ku b">gsutil lifecycle set gcs-lifecycle-management.json gs://<strong class="ih hj">&lt;bucket_name&gt;</strong></code></p><p id="e294" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能希望设置<a class="ae jd" href="https://cloud.google.com/storage/docs/access-logs#delivery" rel="noopener ugc nofollow" target="_blank">日志</a>和<a class="ae jd" href="https://support.google.com/cloud/answer/7233314?hl=en&amp;ref_topic=7106112" rel="noopener ugc nofollow" target="_blank">计费</a> <a class="ae jd" href="https://support.google.com/cloud/answer/6293835?hl=en&amp;ref_topic=7106112" rel="noopener ugc nofollow" target="_blank">导出</a>，以便更深入地了解您的备份流程和成本。关于账单导出到BigQuery，看看这个<a class="ae jd" rel="noopener" href="/google-cloud/visualize-gcp-billing-using-bigquery-and-data-studio-d3e695f90c08">整洁的可重用仪表板</a>。</p><h2 id="f9a4" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">还原备份</h2><p id="a7ec" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">以下命令将向您展示如何恢复单个文件或整个备份。如果您在服务器上执行这些操作，请跳过这一部分，继续下面的重复命令。如果您想在另一台机器上执行它们(例如，因为服务器受到威胁，您需要恢复到不同的位置)，那么首先执行这些步骤。首先安装口是心非和boto。然后创建一个文件，姑且称之为<code class="du lc ld le ku b">env.txt</code>，在其中添加以下几行:</p><pre class="kg kh ki kj fd kt ku kv kw aw kx bi"><span id="31e7" class="je jf hi ku b fi ky kz l la lb">export GS_ACCESS_KEY_ID=<strong class="ku hj">"&lt;your_access_key&gt;</strong>"<br/>export GS_SECRET_ACCESS_KEY="<strong class="ku hj">&lt;your_secret&gt;</strong>"<br/>export PASSPHRASE="<strong class="ku hj">&lt;your_passphrase&gt;</strong>"</span></pre><p id="1899" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后运行<code class="du lc ld le ku b">source env.txt</code>，并在下面的恢复命令中的<code class="du lc ld le ku b">sudo</code>后添加<code class="du lc ld le ku b">-E</code>。一旦使用<code class="du lc ld le ku b">shred -uz env.txt</code>完成恢复，您可能想要粉碎<code class="du lc ld le ku b">env.txt</code>文件。</p><p id="1939" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">显示收集状态<br/> </strong>使用以下命令显示收集状态(例如，有多少个完整备份和增量备份，以及它们是何时制作的):</p><pre class="kg kh ki kj fd kt ku kv kw aw kx bi"><span id="d220" class="je jf hi ku b fi ky kz l la lb">sudo duplicity collection-status --archive-dir /root/.cache/duplicity/ gs://<strong class="ku hj">&lt;bucket_name&gt;</strong></span></pre><p id="6f89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">如何恢复单个文件<br/> </strong>首先列出所有文件来检索你想要恢复的文件的路径(当然除非你知道路径):</p><pre class="kg kh ki kj fd kt ku kv kw aw kx bi"><span id="be69" class="je jf hi ku b fi ky kz l la lb">sudo duplicity list-current-files --archive-dir /root/.cache/duplicity/ gs://<strong class="ku hj">&lt;bucket_name&gt;</strong></span></pre><p id="287e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后在以下命令中使用要恢复的文件的路径:</p><pre class="kg kh ki kj fd kt ku kv kw aw kx bi"><span id="cff4" class="je jf hi ku b fi ky kz l la lb">sudo duplicity restore --archive-dir /root/.cache/duplicity/ --file-to-restore <strong class="ku hj">&lt;path&gt;</strong> gs://<strong class="ku hj">&lt;bucket_name&gt;</strong> <strong class="ku hj">&lt;filename_to_restore_to&gt;</strong></span></pre><p id="3faa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">如何恢复所有文件<br/> </strong>恢复所有文件就是这么简单:</p><pre class="kg kh ki kj fd kt ku kv kw aw kx bi"><span id="b304" class="je jf hi ku b fi ky kz l la lb">sudo duplicity restore --archive-dir /root/.cache/duplicity/ gs://<strong class="ku hj">&lt;bucket_name&gt;</strong> <strong class="ku hj">&lt;dir_to_restore_to&gt;</strong></span></pre><p id="0ee9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的还原命令允许您从最新的备份中还原。如果您想使用使用<code class="du lc ld le ku b">collection-status</code>命令列出的旧备份，则添加<code class="du lc ld le ku b">--time</code>选项来指定该备份。关于如何格式化时间字符串，参见<code class="du lc ld le ku b">man duplicity</code>中的<strong class="ih hj">时间格式</strong>部分。</p><p id="01ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在极其紧急的情况下，删除40天后删除文件的生命周期管理策略<a class="ae jd" href="https://cloud.google.com/storage/docs/managing-lifecycles#disable" rel="noopener ugc nofollow" target="_blank">可能会很有用。简单地使用如上所示的相同的<code class="du lc ld le ku b">gsutil lifecycle set gcs-lifecycle-management.json gs://<strong class="ih hj">&lt;bucket_name&gt;</strong></code>命令，但是这次在<code class="du lc ld le ku b">gcs-lifecycle-management.json</code>中输入一个空的JSON对象<code class="du lc ld le ku b">{}</code>。</a></p><h2 id="4e4e" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">障碍和烦恼</h2><p id="5b83" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">GCS工作得很好，但仍需要一些润色。琐碎的任务不能通过他们的网站直接执行。例如，您不能对下图中看到的任何列进行排序，您不能一次下载多个文件，并且没有<em class="ke">全选</em>按钮。为了得到我想要的行为，找出正确的角色来选择和组合并不是一件小事。文档很好，但在有更多示例/不同用例的地方可以更详细。此外，有用的功能仍在测试中，例如<em class="ke">自定义角色</em>，所以我希望事情会有所改善！</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es lf"><img src="../Images/b22104c8166c9dd3d60647784b158b59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PmqKXNe8uDNyDQH3vO3tWw.png"/></div></div></figure><p id="1b9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样做备份对我们来说很顺利。有一件事仍然让我迷惑不解，那就是GCP的账单部分没有反映我们的使用成本，因为它仍然是0.00美元。我已经和谷歌的支持部门联系了一个星期，这是一次令人不满意的经历。虽然他们超级友好，但他们似乎缺乏有效处理这一问题的技能。他们反复询问相同的信息，在我最终升级到技术团队后，他们也开始建议无知的解决方案(“如果你在过去两天上传了数据，成本可能还没有反映出来”，…我已经与你联系了一周了！).</p><p id="3452" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在谷歌对一些非付费消费者服务的支持上有过糟糕的经历，但作为付费企业客户，我期望得到更好的支持。如果谷歌将其每年获得的数十亿利润中的一部分用于改善对他们的支持，那就太好了。</p><p id="e651" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">更新:</strong>1.5周后，谷歌支持得出结论，GCS近线的使用费用不应更新。这很奇怪，因为有几种方法可以查看您的当前成本，但我找不到任何声明近线成本不应显示的免责声明。还是那句话，如果谷歌加了这个功能就好了:)。</p><p id="875e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">更新2: </strong>三个多星期后，账单问题终于解决了！我必须说，谷歌的支持团队坚持解决这个问题，每隔几天就向我更新进展。谢谢！最后，我不得不启用谷歌云存储API，加上他们方面的一些变化，我现在终于看到了我为:D付出的代价！有趣的是，直到这次修复，费用才被记录下来，所以我得到了3-4周的免费存储XD。我很高兴我现在可以看到我的使用和相关费用的明细了！</p></div></div>    
</body>
</html>