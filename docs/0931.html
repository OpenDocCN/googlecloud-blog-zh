<html>
<head>
<title>Automated canary deployments with Flagger and Istio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Flagger和Istio自动部署金丝雀</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/automated-canary-deployments-with-flagger-and-istio-ac747827f9d1?source=collection_archive---------0-----------------------#2019-02-21">https://medium.com/google-cloud/automated-canary-deployments-with-flagger-and-istio-ac747827f9d1?source=collection_archive---------0-----------------------#2019-02-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="218e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">连续交付被接受为企业软件实践，并且是成熟的连续集成原则的自然发展。然而，持续部署仍然非常少见，这可能是由于管理的复杂性以及担心失败的部署会影响系统可用性。</p><p id="a75c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://github.com/weaveworks/flagger" rel="noopener ugc nofollow" target="_blank"> Flagger </a>是一个开源的Kubernetes运营商，旨在解决这种复杂性。它利用Istio的流量转移和Prometheus指标来分析应用在受控部署期间的行为，从而自动推广canary部署。</p><p id="2da9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Flagger可以针对以下部署策略运行自动化应用程序分析、升级和回滚:</p><ul class=""><li id="adb7" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">金丝雀(渐进式交通转移)</li><li id="5c2c" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">A/B测试(HTTP头和cookies流量路由)</li><li id="13e8" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">蓝色/绿色(流量开关或镜像)</li></ul><p id="f4d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于Canary部署和A/B测试，您需要一个第7层流量管理解决方案，如服务网格(Istio、Linkerd、App Mesh)或入口控制器(Contour、NGINX、Gloo)。对于蓝/绿部署，不需要服务网格或入口控制器。</p><p id="f2e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是在谷歌Kubernetes引擎(GKE)上设置和使用Flagger的分步指南。</p><h1 id="0ee1" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">Kubernetes集群设置</h1><p id="be3d" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">首先，您将使用Istio插件创建一个GKE集群(如果您没有GCP帐户，您可以在此注册<a class="ae jd" href="https://cloud.google.com/free/" rel="noopener ugc nofollow" target="_blank">获得免费积分)。</a></p><p id="3aac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">登录Google Cloud，创建一个项目并为其启用计费。安装<a class="ae jd" href="https://cloud.google.com/sdk/" rel="noopener ugc nofollow" target="_blank"> gcloud </a>命令行实用程序，用<code class="du kv kw kx ky b">gcloud init</code>配置你的项目。</p><p id="c013" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置默认项目、计算区域和区域(用您自己的项目替换<code class="du kv kw kx ky b">PROJECT_ID</code>):</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="26ab" class="lh jt hi ky b fi li lj l lk ll">gcloud config set project PROJECT_ID<br/>gcloud config set compute/region us-central1<br/>gcloud config set compute/zone us-central1-a</span></pre><p id="df6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启用GKE服务，并使用HPA和Istio附件创建集群:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="b364" class="lh jt hi ky b fi li lj l lk ll">gcloud services enable container.googleapis.com</span><span id="3c8d" class="lh jt hi ky b fi lm lj l lk ll">K8S_VERSION=$(gcloud beta container get-server-config --format=json | jq -r '.validMasterVersions[0]')</span><span id="bb1b" class="lh jt hi ky b fi lm lj l lk ll">gcloud beta container clusters create istio \<br/>--cluster-version=${K8S_VERSION} \<br/>--zone=us-central1-a \<br/>--num-nodes=2 \<br/>--machine-type=n1-standard-2 \<br/>--disk-size=30 \<br/>--enable-autorepair \<br/>--no-enable-cloud-logging \<br/>--no-enable-cloud-monitoring \<br/>--addons=HorizontalPodAutoscaling,Istio \<br/>--istio-config=auth=MTLS_PERMISSIVE</span></pre><p id="1808" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的命令将创建一个默认节点池，由两个<code class="du kv kw kx ky b">n1-standard-2</code> (vCPU: 2，RAM 7.5GB，DISK: 30GB)虚拟机组成。理想情况下，您会希望将Istio组件与您的工作负载隔离开来，但是在专用节点池上运行Istio pods并不容易。Istio清单被认为是只读的，GKE将撤消任何修改，如节点关联或pod反关联。</p><p id="c809" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为<code class="du kv kw kx ky b">kubectl</code>设置凭证:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="f75d" class="lh jt hi ky b fi li lj l lk ll">gcloud container clusters get-credentials istio</span></pre><p id="33e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建群集管理角色绑定:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="000e" class="lh jt hi ky b fi li lj l lk ll">kubectl create clusterrolebinding "cluster-admin-$(whoami)" \<br/>--clusterrole=cluster-admin \<br/>--user="$(gcloud config get-value core/account)"</span></pre><p id="77b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装<a class="ae jd" href="https://docs.helm.sh/using_helm/#installing-helm" rel="noopener ugc nofollow" target="_blank">舵</a>命令行工具:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="8d98" class="lh jt hi ky b fi li lj l lk ll">brew install kubernetes-helm</span></pre><p id="0da6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">家酿2.0现在也适用于Linux。</p><p id="4f28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为Tiller创建服务帐户和集群角色绑定:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="d561" class="lh jt hi ky b fi li lj l lk ll">kubectl -n kube-system create sa tiller &amp;&amp; \<br/>kubectl create clusterrolebinding tiller-cluster-rule \<br/>--clusterrole=cluster-admin \<br/>--serviceaccount=kube-system:tiller</span></pre><p id="507e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du kv kw kx ky b">kube-system</code>名称空间中部署Tiller:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="d93a" class="lh jt hi ky b fi li lj l lk ll">helm init --service-account tiller</span></pre><p id="4ddd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你应该考虑在舵柄和舵柄之间使用SSL，更多关于保护你的舵柄安装的信息，请参见<a class="ae jd" href="https://docs.helm.sh/using_helm/#securing-your-helm-installation" rel="noopener ugc nofollow" target="_blank"> docs.helm.sh </a>。</p><p id="4344" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过以下方式验证您的设置:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="f819" class="lh jt hi ky b fi li lj l lk ll">kubectl -n istio-system get svc</span></pre><p id="6bdc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几秒钟后，GCP应该会为<code class="du kv kw kx ky b">istio-ingressgateway</code>服务分配一个外部IP。</p><h1 id="143d" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">Istio入口网关设置</h1><p id="4389" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">使用Istio入口IP创建一个名为<code class="du kv kw kx ky b">istio-gateway</code>的静态IP地址:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="fa2f" class="lh jt hi ky b fi li lj l lk ll">export GATEWAY_IP=$(kubectl -n istio-system get svc/istio-ingressgateway -ojson | jq -r .status.loadBalancer.ingress[0].ip)</span><span id="f303" class="lh jt hi ky b fi lm lj l lk ll">gcloud compute addresses create istio-gateway --addresses ${GATEWAY_IP} --region us-central1</span></pre><p id="27f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，你需要一个互联网域名和访问你的DNS注册。添加两条A记录(用您的域替换<code class="du kv kw kx ky b">example.com</code>):</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="7c53" class="lh jt hi ky b fi li lj l lk ll">istio.example.com   A ${GATEWAY_IP}<br/>*.istio.example.com A ${GATEWAY_IP}</span></pre><p id="db55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证通配符DNS正在工作:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="ea22" class="lh jt hi ky b fi li lj l lk ll">watch host test.istio.example.com</span></pre><p id="9733" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个通用的Istio网关，在HTTP:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="6bc1" class="lh jt hi ky b fi li lj l lk ll"><strong class="ky hj">apiVersion</strong>: networking.istio.io/v1alpha3<br/><strong class="ky hj">kind</strong>: Gateway<br/><strong class="ky hj">metadata</strong>:<br/>  <strong class="ky hj">name</strong>: public-gateway<br/>  <strong class="ky hj">namespace</strong>: istio-system<br/><strong class="ky hj">spec</strong>:<br/>  <strong class="ky hj">selector</strong>:<br/>    <strong class="ky hj">istio</strong>: ingressgateway<br/>  <strong class="ky hj">servers</strong>:<br/>    - <strong class="ky hj">port</strong>:<br/>        <strong class="ky hj">number</strong>: 80<br/>        <strong class="ky hj">name</strong>: http<br/>        <strong class="ky hj">protocol</strong>: HTTP<br/>      <strong class="ky hj">hosts</strong>:<br/>        - "*"</span></pre><p id="930d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将上述资源保存为public-gateway.yaml，然后应用它:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="c99e" class="lh jt hi ky b fi li lj l lk ll">kubectl apply -f ./<!-- -->public-gateway<!-- -->.yaml</span></pre><p id="d2b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">没有SSL，任何生产系统都不应该在互联网上公开服务。要使用cert-manager、CloudDNS和Let's Encrypt保护Istio ingress网关，请阅读Flagger GKE <a class="ae jd" href="https://docs.flagger.app/install/flagger-install-on-google-cloud" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="d16c" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">安装Flagger</h1><p id="4876" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">GKE Istio附加组件不包括抓取Istio遥测服务的Prometheus实例。因为Flagger使用Istio HTTP指标来运行canary分析，所以您必须部署以下Prometheus配置，该配置类似于官方Istio Helm图表附带的配置。</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="ed7d" class="lh jt hi ky b fi li lj l lk ll">kubectl -n istio-system apply -f \<br/>https://storage.googleapis.com/gke-release/istio/release/1.0.6-gke.3/patches/install-prometheus.yaml</span></pre><p id="1f67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加旗手头盔储存库:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="308c" class="lh jt hi ky b fi li lj l lk ll">helm repo add flagger <a class="ae jd" href="https://flagger.app" rel="noopener ugc nofollow" target="_blank">https://flagger.app</a></span></pre><p id="57a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在启用松弛通知的情况下，在<code class="du kv kw kx ky b">istio-system</code>名称空间中部署Flagger:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="86c5" class="lh jt hi ky b fi li lj l lk ll">helm upgrade -i flagger flagger/flagger \<br/>--namespace=istio-system \<br/>--set metricsServer=http://prometheus.istio-system:9090 \<br/>--set slack.url=https://hooks.slack.com/services/YOUR-WEBHOOK-ID \<br/>--set slack.channel=general \<br/>--set slack.user=flagger</span></pre><p id="c3bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在任何名称空间中安装Flagger，只要它可以与端口9090上的Istio Prometheus服务对话。</p><p id="f521" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Flagger配有Grafana仪表板，用于金丝雀分析。在<code class="du kv kw kx ky b">istio-system</code>命名空间中安装Grafana:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="6bf0" class="lh jt hi ky b fi li lj l lk ll">helm upgrade -i flagger-grafana flagger/grafana \<br/>--namespace=istio-system \<br/>--set url=http://prometheus.istio-system:9090 \<br/>--set user=admin \<br/>--set password=change-me</span></pre><p id="1b66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过创建虚拟服务(用您的域替换<code class="du kv kw kx ky b">example.com</code>)通过公共网关公开Grafana:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="e006" class="lh jt hi ky b fi li lj l lk ll"><strong class="ky hj">apiVersion</strong>: networking.istio.io/v1alpha3<br/><strong class="ky hj">kind</strong>: VirtualService<br/><strong class="ky hj">metadata</strong>:<br/>  <strong class="ky hj">name</strong>: grafana<br/>  <strong class="ky hj">namespace</strong>: istio-system<br/><strong class="ky hj">spec</strong>:<br/>  <strong class="ky hj">hosts</strong>:<br/>    - "grafana.istio.example.com"<br/>  <strong class="ky hj">gateways</strong>:<br/>    - public-gateway.istio-system.svc.cluster.local<br/>  <strong class="ky hj">http</strong>:<br/>    - <strong class="ky hj">route</strong>:<br/>        - <strong class="ky hj">destination</strong>:<br/>            <strong class="ky hj">host</strong>: flagger-grafana</span></pre><p id="28f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将上述资源另存为grafana-virtual-service.yaml，然后应用它:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="a3fb" class="lh jt hi ky b fi li lj l lk ll">kubectl apply -f ./grafana-virtual-service.yaml</span></pre><p id="8696" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的浏览器中导航到<code class="du kv kw kx ky b">http://grafana.istio.example.com</code>，您将被重定向到Grafana的登录页面。</p><h1 id="bece" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">使用Flagger部署web应用程序</h1><p id="5040" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">Flagger采用Kubernetes部署和可选的水平pod自动缩放器(HPA)，然后创建一系列对象(Kubernetes部署、ClusterIP服务和Istio虚拟服务)。这些对象在网格上公开应用程序，并驱动金丝雀分析和提升。</p><figure class="kz la lb lc fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es ln"><img src="../Images/6920c1093cf047ec860a514b3f8c25b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dwICVz1w04jIMDdx8u1rjg.png"/></div></div></figure><p id="d322" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个启用Istio边车注入的测试命名空间:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="d289" class="lh jt hi ky b fi li lj l lk ll">kubectl create ns test<br/>kubectl label namespace test istio-injection=enabled</span></pre><p id="07ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建部署和水平窗格自动缩放器:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="7105" class="lh jt hi ky b fi li lj l lk ll">kubectl apply -k github.com/weaveworks/flagger//kustomize/podinfo</span></pre><p id="941a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署负载测试服务以在canary分析期间生成流量:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="69d5" class="lh jt hi ky b fi li lj l lk ll"><em class="lv">helm</em> upgrade -i flagger-loadtester flagger/loadtester --namepace=test</span></pre><p id="92e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建canary自定义资源(用您自己的域替换<code class="du kv kw kx ky b">example.com</code>):</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="81f6" class="lh jt hi ky b fi li lj l lk ll"><strong class="ky hj">apiVersion</strong>: flagger.app/v1beta1<br/><strong class="ky hj">kind</strong>: Canary<br/><strong class="ky hj">metadata</strong>:<br/>  <strong class="ky hj">name</strong>: podinfo<br/>  <strong class="ky hj">namespace</strong>: test<br/><strong class="ky hj">spec</strong>:<br/>  <strong class="ky hj">targetRef</strong>:<br/>    <strong class="ky hj">apiVersion</strong>: apps/v1<br/>    <strong class="ky hj">kind</strong>: Deployment<br/>    <strong class="ky hj">name</strong>: podinfo<br/>  <strong class="ky hj">progressDeadlineSeconds</strong>: 60<br/>  <strong class="ky hj">autoscalerRef</strong>:<br/>    <strong class="ky hj">apiVersion</strong>: autoscaling/v2beta1<br/>    <strong class="ky hj">kind</strong>: HorizontalPodAutoscaler<br/>    <strong class="ky hj">name</strong>: podinfo<br/>  <strong class="ky hj">service</strong>:<br/>    <strong class="ky hj">port</strong>: 9898<br/>    <strong class="ky hj">gateways</strong>:<br/>    - public-gateway.istio-system.svc.cluster.local<br/>    <strong class="ky hj">hosts</strong>:<br/>    - app.istio.example.com<br/>    <strong class="ky hj">trafficPolicy</strong>:<br/>      <strong class="ky hj">tls</strong>:<br/>        # use ISTIO_MUTUAL when mTLS is enabled<br/>        <strong class="ky hj">mode</strong>: DISABLE<br/>  <strong class="ky hj">analysis</strong>:<br/>    <strong class="ky hj">interval</strong>: 30s<br/>    <strong class="ky hj">threshold</strong>: 10<br/>    <strong class="ky hj">maxWeight</strong>: 50<br/>    <strong class="ky hj">stepWeight</strong>: 5<br/>    <strong class="ky hj">metrics</strong>:<br/>    - <strong class="ky hj">name</strong>: request-success-rate<br/>      <strong class="ky hj">threshold</strong>: 99<br/>      <strong class="ky hj">interval</strong>: 30s<br/>    - <strong class="ky hj">name</strong>: request-duration<br/>      <strong class="ky hj">threshold</strong>: 500<br/>      <strong class="ky hj">interval</strong>: 30s<br/>    <strong class="ky hj">webhooks</strong>:<br/>      - <strong class="ky hj">name</strong>: load-test<br/>        <strong class="ky hj">url</strong>: <a class="ae jd" href="http://flagger-loadtester.test/" rel="noopener ugc nofollow" target="_blank">http://flagger-loadtester.test/</a><br/>        <strong class="ky hj">timeout</strong>: 5s<br/>        <strong class="ky hj">metadata</strong>:<br/>          <strong class="ky hj">cmd</strong>: "hey -z 1m -q 10 -c 2 <a class="ae jd" href="http://podinfo.test:9898/" rel="noopener ugc nofollow" target="_blank">http://podinfo-canary.test:9898/</a>"</span></pre><p id="bd0e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将上述资源保存为podinfo-canary.yaml，然后应用它:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="a664" class="lh jt hi ky b fi li lj l lk ll">kubectl apply -f ./podinfo-canary.yaml</span></pre><p id="626c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果成功，上述分析将运行五分钟，同时每半分钟验证一次HTTP指标。您可以使用公式:<code class="du kv kw kx ky b">interval * (maxWeight / stepWeight)</code>确定验证和升级canary部署所需的最短时间。加那利CRD油田在这里被记载<a class="ae jd" href="https://docs.flagger.app/usage/how-it-works" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="33b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几秒钟后，Flagger将创建金丝雀对象:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="acce" class="lh jt hi ky b fi li lj l lk ll"><strong class="ky hj"># applied </strong><br/>deployment.apps/podinfo<br/>horizontalpodautoscaler.autoscaling/podinfo<br/>canary.flagger.app/podinfo</span><span id="bf22" class="lh jt hi ky b fi lm lj l lk ll"><strong class="ky hj"># generated</strong> <br/>deployment.apps/podinfo-primary<br/>horizontalpodautoscaler.autoscaling/podinfo-primary<br/>service/podinfo<br/>service/podinfo-canary<br/>service/podinfo-primary<br/>destinationrule.networking.istio.io/podinfo-canary<br/>destinationrule.networking.istio.io/podinfo-primary<br/>virtualservice.networking.istio.io/podinfo</span></pre><p id="2690" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开浏览器，导航到<code class="du kv kw kx ky b">app.istio.example.com</code>，你应该会看到<a class="ae jd" href="https://github.com/stefanprodan/k8s-podinfo" rel="noopener ugc nofollow" target="_blank">演示应用</a>的版本号。</p><h1 id="6b17" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">自动化金丝雀分析和推广</h1><p id="ffae" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">Flagger实现了一个控制循环，逐渐将流量转移到金丝雀，同时测量关键性能指标，如HTTP请求成功率、请求平均持续时间和pod运行状况。基于对KPI的分析，金丝雀被提升或中止，并且分析结果被发布到Slack。</p><figure class="kz la lb lc fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es lw"><img src="../Images/e9b28379d2c9ff894a419094f73134f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_zYeaM0nh4e-bpYGrzWeew.png"/></div></div></figure><p id="63c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">canary部署由以下任何对象的更改触发:</p><ul class=""><li id="0acf" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">部署PodSpec(容器映像、命令、端口、环境等)</li><li id="294a" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">作为卷装载或映射到环境变量的配置映射</li><li id="c05f" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">机密作为卷挂载或映射到环境变量</li></ul><p id="6939" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过更新容器映像触发canary部署:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="ccd8" class="lh jt hi ky b fi li lj l lk ll">kubectl -n test set image deployment/podinfo \<br/>podinfod=quay.io/stefanprodan/podinfo:3.1.1</span></pre><p id="40b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Flagger检测到部署版本发生了变化，并开始分析它:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="2675" class="lh jt hi ky b fi li lj l lk ll">kubectl -n test describe canary/podinfo<br/><br/>Events:<br/><br/>New revision detected podinfo.test<br/>Scaling up podinfo.test<br/>Waiting for podinfo.test rollout to finish: 0 of 1 updated replicas are available<br/>Advance podinfo.test canary weight 5<br/>Advance podinfo.test canary weight 10<br/>Advance podinfo.test canary weight 15<br/>Advance podinfo.test canary weight 20<br/>Advance podinfo.test canary weight 25<br/>Advance podinfo.test canary weight 30<br/>Advance podinfo.test canary weight 35<br/>Advance podinfo.test canary weight 40<br/>Advance podinfo.test canary weight 45<br/>Advance podinfo.test canary weight 50<br/>Copying podinfo.test template spec to podinfo-primary.test<br/>Waiting for podinfo-primary.test rollout to finish: 1 of 2 updated replicas are available<br/>Promotion completed! Scaling down podinfo.test</span></pre><p id="73a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在分析过程中，可以使用Grafana监控金丝雀的进程:</p><figure class="kz la lb lc fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es lx"><img src="../Images/5ffe6a6647bd361ef448616fdda9f0e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R-qsUDvkUoIPTZhFac-XAQ.png"/></div></div></figure><p id="3648" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，如果在canary分析期间对部署应用了新的更改，Flagger将重新开始分析阶段。</p><p id="9308" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">列出集群中的所有金丝雀，包括:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="72e2" class="lh jt hi ky b fi li lj l lk ll">watch kubectl get canaries --all-namespaces</span><span id="10b8" class="lh jt hi ky b fi lm lj l lk ll">NAMESPACE   NAME      STATUS        WEIGHT   LASTTRANSITIONTIME<br/>test        podinfo   Progressing   15       2019-01-16T14:05:07Z<br/>prod        frontend  Succeeded     0        2019-01-15T16:15:07Z<br/>prod        backend   Failed        0        2019-01-14T17:05:07Z</span></pre><p id="7ef2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您启用了宽限通知，您应该会收到以下消息:</p><figure class="kz la lb lc fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es ly"><img src="../Images/826f5a2bfb818942a0e09398b7d16a03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cnGRTWECDXlLLww3icrEcg.png"/></div></div></figure><h1 id="cfa2" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">自动回滚</h1><p id="132c" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">在canary分析期间，可能会生成合成的HTTP 500错误和高响应延迟，以测试Flagger是否暂停了部署。</p><p id="7d59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个tester pod并在其中执行:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="e5c1" class="lh jt hi ky b fi li lj l lk ll">kubectl -n test run tester \<br/>--image=quay.io/stefanprodan/podinfo:1.2.1 \<br/>-- ./podinfo --port=9898</span><span id="7ccf" class="lh jt hi ky b fi lm lj l lk ll">kubectl -n test exec -it tester-xx-xx sh</span></pre><p id="605d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">生成HTTP 500错误:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="384e" class="lh jt hi ky b fi li lj l lk ll">watch curl <a class="ae jd" href="http://podinfo-canary:9898/status/500" rel="noopener ugc nofollow" target="_blank">http://podinfo-canary:9898/status/500</a></span></pre><p id="4fc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">生成延迟:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="0bb3" class="lh jt hi ky b fi li lj l lk ll">watch curl <a class="ae jd" href="http://podinfo-canary:9898/delay/1" rel="noopener ugc nofollow" target="_blank">http://podinfo-canary:9898/delay/1</a></span></pre><p id="22a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当失败检查的数量达到canary分析阈值时，流量被路由回主节点，canary被调整为零，部署被标记为失败。</p><p id="b372" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">canary错误和延迟峰值已被记录为Kubernetes事件，并由Flagger以JSON格式记录:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="237f" class="lh jt hi ky b fi li lj l lk ll">kubectl -n istio-system logs deployment/flagger -f | jq .msg<br/><br/>Starting canary deployment for podinfo.test<br/>Advance podinfo.test canary weight 5<br/>Advance podinfo.test canary weight 10<br/>Advance podinfo.test canary weight 15<br/>Halt podinfo.test advancement success rate 69.17% &lt; 99%<br/>Halt podinfo.test advancement success rate 61.39% &lt; 99%<br/>Halt podinfo.test advancement success rate 55.06% &lt; 99%<br/>Halt podinfo.test advancement success rate 47.00% &lt; 99%<br/>Halt podinfo.test advancement success rate 37.00% &lt; 99%<br/>Halt podinfo.test advancement request duration 1.515s &gt; 500ms<br/>Halt podinfo.test advancement request duration 1.600s &gt; 500ms<br/>Halt podinfo.test advancement request duration 1.915s &gt; 500ms<br/>Halt podinfo.test advancement request duration 2.050s &gt; 500ms<br/>Halt podinfo.test advancement request duration 2.515s &gt; 500ms<br/>Rolling back podinfo.test failed checks threshold reached 10<br/>Canary failed! Scaling down podinfo.test</span></pre><p id="71dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您启用了可宽延时间通知，如果超过了进度截止日期，或者如果分析达到了最大失败检查数，您将收到一条消息:</p><figure class="kz la lb lc fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es lz"><img src="../Images/0c6c5d84a83705d90e4b47050188166b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dZGnVV22_AsGbrsfFQ72MQ.png"/></div></div></figure><h1 id="ef68" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">流量镜像</h1><p id="cb80" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">对于执行读取操作的应用程序，Flagger可以配置为使用流量镜像驱动canary释放。Istio流量镜像将复制每个传入的请求，将一个请求发送到主服务器，另一个发送到canary服务。来自主服务器的响应被发送回用户，来自金丝雀的响应被丢弃。对这两个请求都收集了指标，因此只有当canary指标在阈值范围内时，部署才会继续。</p><p id="467d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，镜像应该用于那些<strong class="ih hj">幂等的</strong>或者能够被处理两次(一次由主服务器处理，一次由金丝雀服务器处理)的请求。</p><p id="22e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过将<code class="du kv kw kx ky b">stepWeight/maxWeight</code>替换为<code class="du kv kw kx ky b">iterations</code>并将<code class="du kv kw kx ky b">canaryAnalysis.mirror</code>设置为<code class="du kv kw kx ky b">true</code>来启用镜像:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="1524" class="lh jt hi ky b fi li lj l lk ll"><strong class="ky hj">apiVersion</strong>: flagger.app/v1beta1<br/><strong class="ky hj">kind</strong>: Canary<br/><strong class="ky hj">spec</strong>:<br/>  <strong class="ky hj">analysis</strong>:<br/>    <strong class="ky hj">interval</strong>: 1m<br/>    <strong class="ky hj">threshold</strong>: 5<br/>    <strong class="ky hj">iterations: </strong>10<br/>    <strong class="ky hj">mirror: </strong>true<br/>    <strong class="ky hj">metrics</strong>:<br/>    - <strong class="ky hj">name</strong>: request-success-rate<br/>      <strong class="ky hj">threshold</strong>: 99<br/>      <strong class="ky hj">interval</strong>: 1m<br/>    - <strong class="ky hj">name</strong>: request-duration<br/>      <strong class="ky hj">threshold</strong>: 500<br/>      <strong class="ky hj">interval</strong>: 1m<br/>    <strong class="ky hj">webhooks</strong>:<br/>      - <strong class="ky hj">name</strong>: acceptance-test<br/>        <strong class="ky hj">type</strong>: pre-rollout<br/>        <strong class="ky hj">url</strong>: http://flagger-loadtester.test/<br/>        <strong class="ky hj">timeout</strong>: 30s<br/>        <strong class="ky hj">metadata</strong>:<br/>          <strong class="ky hj">type</strong>: bash<br/>          <strong class="ky hj">cmd</strong>: "curl -sd 't' podinfo-canary:9898/token | grep token"<br/>      - <strong class="ky hj">name</strong>: load-test<br/>        <strong class="ky hj">url</strong>: http://flagger-loadtester.test/<br/>        <strong class="ky hj">timeout</strong>: 5s<br/>        <strong class="ky hj">metadata</strong>:<br/>          <strong class="ky hj">cmd</strong>: "hey -z 1m -q 10 -c 2 http://podinfo.test:9898/"</span></pre><p id="5600" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用上述配置，Flagger将通过以下步骤运行canary发布:</p><ul class=""><li id="15a7" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">检测新版本(部署规范、机密或配置映射更改)</li><li id="3fa4" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">从零开始扩展金丝雀部署</li><li id="6879" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">等待HPA设置金丝雀最小复本</li><li id="ddc8" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">检查金丝雀豆荚健康状况</li><li id="f10d" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">运行验收测试</li><li id="4e06" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">如果测试失败，中止金丝雀释放</li><li id="8168" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">开始负载测试</li><li id="1824" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">将流量从主服务器镜像到金丝雀服务器</li><li id="b56b" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">每分钟检查一次请求成功率和请求持续时间</li><li id="d22a" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">如果达到度量检查失败阈值，则中止canary释放</li><li id="850c" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">达到迭代次数后停止流量镜像</li><li id="7dc5" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">将实时流量路由到金丝雀豆荚</li><li id="2aeb" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">提升金丝雀(更新主要机密、配置图和部署规范)</li><li id="b319" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">等待主部署展示完成</li><li id="c79a" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">等待HPA设置主最小复本</li><li id="8483" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">检查主pod运行状况</li><li id="f714" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">将实时流量切换回主流量</li><li id="fcea" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">缩放到零的金丝雀</li><li id="e643" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">发送带有金丝雀分析结果的通知</li></ul><p id="a2c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述过程可以扩展为<a class="ae jd" href="https://docs.flagger.app/usage/metrics#custom-metrics" rel="noopener ugc nofollow" target="_blank">自定义指标</a>检查、<a class="ae jd" href="https://docs.flagger.app/usage/webhooks" rel="noopener ugc nofollow" target="_blank"> webhooks </a>、<a class="ae jd" href="https://docs.flagger.app/usage/webhooks#manual-gating" rel="noopener ugc nofollow" target="_blank">手动提升</a>批准和<a class="ae jd" href="https://docs.flagger.app/usage/alerting" rel="noopener ugc nofollow" target="_blank"> Slack或MS团队</a>通知。</p><h1 id="c7fb" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">包扎</h1><p id="05e4" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">在Kubernetes上运行像Istio这样的服务网格可以为您提供自动的度量、日志和跟踪，但是工作负载的部署仍然依赖于外部工具。Flagger的目标是通过扩展Istio的<a class="ae jd" href="https://redmonk.com/jgovernor/2018/08/06/towards-progressive-delivery/" rel="noopener ugc nofollow" target="_blank">渐进式交付</a>功能来改变这种情况。</p><p id="0a4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Flagger与为Kubernetes制作的任何CI/CD解决方案兼容，canary分析可以很容易地用webhooks扩展，用于运行系统集成/验收测试、负载测试或任何其他定制验证。由于Flagger是声明性的，并对Kubernetes事件做出反应，因此它可以与<a class="ae jd" href="https://github.com/fluxcd/flux" rel="noopener ugc nofollow" target="_blank"> FluxCD </a>或<a class="ae jd" href="https://jenkins-x.io" rel="noopener ugc nofollow" target="_blank"> JenkinsX </a>一起用于GitOps管道。如果你使用的是JenkinsX，你可以使用jx插件安装Flagger。</p><p id="82d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Flagger由<a class="ae jd" href="https://www.weave.works" rel="noopener ugc nofollow" target="_blank"> Weaveworks </a>赞助，并为<a class="ae jd" href="https://www.weave.works/product/cloud/" rel="noopener ugc nofollow" target="_blank"> Weave Cloud </a>中的金丝雀部署提供动力。该项目正在GKE、EKS和采用kubeadm的裸机集群上进行测试。</p><p id="376a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您对改进Flagger有任何建议，请在GitHub上提交问题或PR，地址为<a class="ae jd" href="https://github.com/weaveworks/flagger" rel="noopener ugc nofollow" target="_blank"> weaveworks/flagger </a>。非常欢迎投稿！</p></div></div>    
</body>
</html>