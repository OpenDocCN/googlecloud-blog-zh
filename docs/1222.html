<html>
<head>
<title>Enabling GKE Workload Identity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">启用GKE工作量标识</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/enabling-gke-workload-identity-ad5dd586a811?source=collection_archive---------1-----------------------#2019-12-12">https://medium.com/google-cloud/enabling-gke-workload-identity-ad5dd586a811?source=collection_archive---------1-----------------------#2019-12-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7bed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">原载于</em><a class="ae je" href="https://pbhadani.com/posts/gke-workload-identity/" rel="noopener ugc nofollow" target="_blank"><em class="jd">【https://pbhadani.com】</em></a></p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><p id="d45c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博客中，我将讨论GKE工作负载身份特性以及为什么要使用这个特性。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es jm"><img src="../Images/44d367ab9ab393c5511dea24b72735bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BCjp2GqfKNluahXa.jpg"/></div></div></figure><h1 id="4460" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">有什么问题？</h1><p id="186e" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">在GKE上运行的应用程序必须通过身份验证才能使用谷歌服务，如谷歌云存储(GCS)、云SQL、BigQuery等。可以通过使用Kubernetes Secret space或不同的方法(如Vault)向应用程序提供服务帐户密钥JSON文件来进行身份验证。但是在这些方法中，服务帐户密钥JSON(有10年的寿命)必须以明文形式存储在pod中，或者以base64编码存储在Kubernetes的秘密空间中。还有，钥匙轮换的过程一定是在一个不是好玩的过程的地方。</p><p id="6e39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以通过将服务帐户附加到Kubernetes节点来避免使用服务帐户密钥，但是这样一来，在该节点上运行的所有pods都获得了相同的权限，这不是一件理想的事情。</p><h1 id="3943" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">目标？</h1><p id="b338" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">我们希望为一个Pod分配一个服务帐户，这样我们就可以隔离不同Pod的权限。</p><p id="16ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">万岁，我们在测试版中提供了工作负载标识功能，解决了GKE的这个问题。</p><h1 id="f035" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">那么，什么是工作负载身份呢？</h1><p id="223e" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">根据Google文档，“工作负载身份是从GKE访问Google云服务的推荐方式，因为它提高了安全性和可管理性。”</p><p id="085a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GKE工作负载身份允许我们将服务帐户附加到Kubernetes pod，并消除了在pod或集群中管理服务帐户凭证JSON文件的麻烦。</p><h1 id="0136" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">让我们在GKE集群中使用工作负载标识</h1><h1 id="3372" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">先决条件</h1><ol class=""><li id="1590" class="lb lc hi ih b ii kw im kx iq ld iu le iy lf jc lg lh li lj bi translated">如果你还没有在你的工作站上安装<code class="du lk ll lm ln b">gcloud</code>，那么参考我以前的博客<a class="ae je" href="https://pbhadani.com/posts/getting-started-wth-google-cloud-sdk/" rel="noopener ugc nofollow" target="_blank">来快速安装和运行它。<br/>或者，您可以使用</a><a class="ae je" href="https://cloud.google.com/shell/" rel="noopener ugc nofollow" target="_blank"> Google Cloud Shell </a>来运行这些命令。</li><li id="12af" class="lb lc hi ih b ii lo im lp iq lq iu lr iy ls jc lg lh li lj bi translated">请确保您是项目编辑者或项目所有者，或者有足够的权限运行以下命令。</li></ol><h1 id="3d34" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">设置GKE集群</h1><p id="5444" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">按照以下步骤创建新的GKE集群并启用工作负载标识。</p><ol class=""><li id="4269" class="lb lc hi ih b ii ij im in iq lt iu lu iy lv jc lg lh li lj bi translated">启用<a class="ae je" href="https://console.cloud.google.com/apis/api/iamcredentials.googleapis.com/" rel="noopener ugc nofollow" target="_blank">云IAM API </a>。</li><li id="7b02" class="lb lc hi ih b ii lo im lp iq lq iu lr iy ls jc lg lh li lj bi translated">安装并配置<code class="du lk ll lm ln b">gke-gcloud-auth-plugin</code>。</li></ol><p id="4e9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lk ll lm ln b">gke-gcloud-auth-plugin</code>是GKE新的Kubectl认证插件。请阅读<a class="ae je" href="https://cloud.google.com/blog/products/containers-kubernetes/kubectl-auth-changes-in-gke" rel="noopener ugc nofollow" target="_blank">文档</a>了解更多详情。</p><ul class=""><li id="5286" class="lb lc hi ih b ii ij im in iq lt iu lu iy lv jc lw lh li lj bi translated">安装插件</li></ul><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="f9ef" class="mb jz hi ln b fi mc md l me mf">gcloud components install gke-gcloud-auth-plugin</span></pre><p id="ed83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>如果<code class="du lk ll lm ln b">gcloud CLI component manager</code>被禁用，使用<code class="du lk ll lm ln b">yum</code>或<code class="du lk ll lm ln b">apt</code>包安装该插件。</p><p id="f914" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于Debian:</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="9c7d" class="mb jz hi ln b fi mc md l me mf">sudo apt-get install google-cloud-sdk-gke-gcloud-auth-plugin</span></pre><ul class=""><li id="f199" class="lb lc hi ih b ii ij im in iq lt iu lu iy lv jc lw lh li lj bi translated">配置插件</li></ul><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="5823" class="mb jz hi ln b fi mc md l me mf">echo "export USE_GKE_GCLOUD_AUTH_PLUGIN=True" &gt;&gt; ~/.bashrc</span><span id="0589" class="mb jz hi ln b fi mg md l me mf">source ~/.bashrc</span></pre><p id="686b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.设置GCP默认值。</p><ul class=""><li id="27c9" class="lb lc hi ih b ii ij im in iq lt iu lu iy lv jc lw lh li lj bi translated">设置GCP项目</li></ul><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="c071" class="mb jz hi ln b fi mc md l me mf"><strong class="ln hj">export</strong> GCP_PROJECT_ID=&lt;YOUR_GCP_PROJECT_ID&gt;</span><span id="04a8" class="mb jz hi ln b fi mg md l me mf">gcloud config <strong class="ln hj">set</strong> project $GCP_PROJECT_ID</span></pre><ul class=""><li id="86f7" class="lb lc hi ih b ii ij im in iq lt iu lu iy lv jc lw lh li lj bi translated">设置默认地区和区域</li></ul><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="bf05" class="mb jz hi ln b fi mc md l me mf">gcloud config <strong class="ln hj">set</strong> compute/region europe-west1</span><span id="873e" class="mb jz hi ln b fi mg md l me mf">gcloud config <strong class="ln hj">set</strong> compute/zone europe-west1-b</span></pre><p id="911c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.确保你已经安装了<code class="du lk ll lm ln b">kubectl</code>命令。</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="7d63" class="mb jz hi ln b fi mc md l me mf">sudo apt-get install kubectl</span></pre><p id="b0b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行以下命令进行验证。</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="e6fd" class="mb jz hi ln b fi mc md l me mf">kubectl <strong class="ln hj">help</strong></span></pre><p id="04b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>请参考文档:<a class="ae je" href="https://cloud.google.com/sdk/docs/components#external_package_managers" rel="noopener ugc nofollow" target="_blank">外部包管理器</a></p><p id="2a80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.创建新的Google服务帐户(GSA)。</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="77f0" class="mb jz hi ln b fi mc md l me mf">gcloud iam service-accounts create workload-identity-test</span></pre><p id="80a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>您可以使用现有的服务帐户。<br/>所需许可:<code class="du lk ll lm ln b">iam.serviceAccounts.create</code>GCP项目。</p><p id="7331" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.为应用程序所需的Google服务帐户添加权限。例如，<code class="du lk ll lm ln b">roles/storage.objectViewer</code></p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="729d" class="mb jz hi ln b fi mc md l me mf">gcloud projects add-iam-policy-binding $GCP_PROJECT_ID \ <br/>--member serviceAccount:workload-identity-test@${GCP_PROJECT_ID}.iam.gserviceaccount.com \ <br/>--role roles/storage.objectViewer</span></pre><p id="27d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.设置一个启用了<em class="jd">工作负载标识</em>的GKE集群。</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="fba7" class="mb jz hi ln b fi mc md l me mf"><strong class="ln hj">export</strong> GKE_CLUSTER_NAME=gke-wi</span><span id="4618" class="mb jz hi ln b fi mg md l me mf">gcloud container clusters create $GKE_CLUSTER_NAME \ <br/>--cluster-version=1.24 \ <br/>--workload-pool=$GCP_PROJECT_ID.svc.id.goog</span></pre><p id="a208" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong> GKE集群可能需要5-10分钟才能完全正常工作。需要的许可:<code class="du lk ll lm ln b">container.clusters.create</code>GCP项目。</p><p id="4aeb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">8.在您的终端上配置<code class="du lk ll lm ln b">kubectl</code>命令。</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="9dc5" class="mb jz hi ln b fi mc md l me mf">gcloud container clusters get-credentials $GKE_CLUSTER_NAME</span></pre><p id="7326" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>这将填充<code class="du lk ll lm ln b">~/.kube/config</code>文件。需要的许可:<code class="du lk ll lm ln b">container.clusters.get</code>GCP项目。</p><p id="82c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">9.(可选)如果不想使用<code class="du lk ll lm ln b">default</code>名称空间，可以创建一个Kubernetes名称空间。</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="4b63" class="mb jz hi ln b fi mc md l me mf">kubectl create namespace newspace</span></pre><p id="ef13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">10.创建Kubernetes服务帐户(KSA)。</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="fe26" class="mb jz hi ln b fi mc md l me mf">kubectl create serviceaccount \ <br/>--namespace newspace \ <br/>workload-identity-test-ksa</span></pre><p id="3d74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">11.绑定Google服务帐户(GSA)和Kubernetes服务帐户(KSA)，以便KSA可以使用授予GSA的权限。</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="f971" class="mb jz hi ln b fi mc md l me mf">gcloud iam service-accounts add-iam-policy-binding \ <br/>--role roles/iam.workloadIdentityUser \ <br/>--member "serviceAccount:${GCP_PROJECT_ID}.svc.id.goog[newspace/workload-identity-test-ksa]" \<br/>workload-identity-test@${GCP_PROJECT_ID}.iam.gserviceaccount.com</span></pre><p id="19f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">12.添加注释</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="c839" class="mb jz hi ln b fi mc md l me mf">kubectl annotate serviceaccount \ <br/>--namespace newspace \ <br/>workload-identity-test-ksa \ <br/>iam.gke.io/gcp-service-account=workload-identity-test@${GCP_PROJECT_ID}.iam.gserviceaccount.com</span></pre><p id="763b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">13.使用创建的KSA创建一个Pod以进行验证。</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="b813" class="mb jz hi ln b fi mc md l me mf">kubectl run --rm -it test-pod \<br/>--image google/cloud-sdk:slim \<br/>--namespace newspace \<br/>--overrides='{ "spec": { "serviceAccount": "workload-identity-test-ksa" }  }' sh</span></pre><p id="3f1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行上面的命令将登录到Pod并提供它的bash shell。现在运行以下命令，查看此pod配置了哪个服务帐户。</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="df13" class="mb jz hi ln b fi mc md l me mf">gcloud auth list</span></pre><p id="ccb6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这应该打印GSA名称。</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="7d22" class="mb jz hi ln b fi mc md l me mf">Credentialed Accounts <br/>ACTIVE   ACCOUNT <br/>*        workload-identity-test@workshop-demo-namwcb.iam.gserviceaccount.com</span></pre><h1 id="c1e1" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">清除</h1><p id="4bac" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">不要忘记清理资源，一旦你不再需要它。<br/>运行以下命令:</p><ol class=""><li id="03f4" class="lb lc hi ih b ii ij im in iq lt iu lu iy lv jc lg lh li lj bi translated">删除GKE群集。</li></ol><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="112c" class="mb jz hi ln b fi mc md l me mf">gcloud container clusters delete $GKE_CLUSTER_NAME</span></pre><p id="1983" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.删除Google服务帐户(GSA)。</p><pre class="jn jo jp jq fd lx ln ly lz aw ma bi"><span id="8dc7" class="mb jz hi ln b fi mc md l me mf">gcloud iam service-accounts delete workload-identity-test@${GCP_PROJECT_ID}.iam.gserviceaccount.com</span></pre></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><p id="ac78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这篇博客能帮助你熟悉工作负载身份，并在GKE上安全地部署应用。</p><p id="5a9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您有反馈或问题，请通过<a class="ae je" href="https://linkedin.com/in/pradeepbhadani" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>或<a class="ae je" href="https://twitter.com/bhadanipradeep" rel="noopener ugc nofollow" target="_blank"> Twitter </a>联系我。</p></div></div>    
</body>
</html>