<html>
<head>
<title>Composer, Sendgrid and Secrets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">作曲家、发送网格和秘密</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/composer-sendgrid-and-secrets-75e4b6e7581e?source=collection_archive---------0-----------------------#2022-01-31">https://medium.com/google-cloud/composer-sendgrid-and-secrets-75e4b6e7581e?source=collection_archive---------0-----------------------#2022-01-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d9d1f1ae7d7055843d26e834fd181e43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*T4HmFalSqTtVdrkj"/></div></div></figure><p id="18d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一位客户希望使用GCP作曲家(气流)在工作流失败时通过Sendgrid发送通知电子邮件。当一个人希望使用Sendgrid时，他必须提供一个ApiKey来证明你被授权发送电子邮件。客户端希望将Sendgrid API密钥存储在GCP机密中。本文向我们展示了实现这一目标的秘诀。</p><p id="de1b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，为了让工作流在失败时自动发送通知电子邮件，必须在DAG中声明这一点。</p><p id="7f21" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是一个这样做的DAG示例:</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="0197" class="jx jy hi jt b fi jz ka l kb kc">from airflow import DAG<br/>from airflow.operators.python_operator import PythonOperator<br/>from airflow.operators.bash import BashOperator<br/>from airflow.exceptions import AirflowFailException</span><span id="0412" class="jx jy hi jt b fi kd ka l kb kc"># These args will get passed on to each operator<br/># You can override them on a per-task basis during operator initialization<br/>default_args = {<br/>    'owner': 'airflow',<br/>    'depends_on_past': False,<br/>    'email': ['<a class="ae ke" href="mailto:jones@example.com" rel="noopener ugc nofollow" target="_blank">jones@example.com</a>'],<br/>    'email_on_failure': True,<br/>    'email_on_retry': True,<br/>    'retries': 1,<br/>    'retry_delay': timedelta(minutes=5),<br/>}<br/>with DAG(<br/>    'tutorial',<br/>    default_args=default_args,<br/>    description='A simple DAG',<br/>    schedule_interval=timedelta(days=1),<br/>    start_date=datetime(2021, 1, 1),<br/>    catchup=False,<br/>    tags=['example'],<br/>) as dag:</span><span id="84d5" class="jx jy hi jt b fi kd ka l kb kc">t1 = BashOperator(<br/>      task_id='print_date',<br/>      bash_command='date',<br/>    )</span><span id="70df" class="jx jy hi jt b fi kd ka l kb kc">def task_to_fail():<br/>        raise AirflowFailException("Forced Exception!")</span><span id="b225" class="jx jy hi jt b fi kd ka l kb kc">t2 = PythonOperator(dag=dag,<br/>      task_id='throw_exception',<br/>      python_callable=task_to_fail<br/>    )</span><span id="a2a5" class="jx jy hi jt b fi kd ka l kb kc">t1 &gt;&gt; t2</span></pre><p id="0345" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我想让你看的重点是:</p><ul class=""><li id="cc38" class="kf kg hi is b it iu ix iy jb kh jf ki jj kj jn kk kl km kn bi translated">DAG会抛出异常，因此整个工作流会失败。</li><li id="0409" class="kf kg hi is b it ko ix kp jb kq jf kr jj ks jn kk kl km kn bi translated">“<code class="du kt ku kv jt b">email_on_failure</code>”标志被设置为真。</li><li id="4886" class="kf kg hi is b it ko ix kp jb kq jf kr jj ks jn kk kl km kn bi translated">在“<code class="du kt ku kv jt b">email</code>”列表中提供了一个电子邮件地址，通知电子邮件将发送到该地址。</li></ul><p id="27c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们运行此DAG，我们会发现它会按预期失败，但是还有更多工作要做。我们还没有告诉作曲家如何发送电子邮件。发送电子邮件有多种方式，包括SMTP、Sendgrid等。</p><p id="f8c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">气流主要由名为<code class="du kt ku kv jt b">airflow.cfg</code>的配置文件驱动。这个文件基本上是一个名称/值对集，分成相关的部分。其中一个部分专门针对内部气流产生的电子邮件。两个参数是我们最感兴趣的。第一种叫做<code class="du kt ku kv jt b">email_backend</code>。这指定了发送电子邮件时要调用的逻辑。这使我们能够定制如何发送电子邮件。Apache已经提供了这样一个插件，它提供了到Sendgrid的钩子。第二个感兴趣的参数称为“<code class="du kt ku kv jt b">email_conn_id</code>”，用于提供气流连接名称。这个连接应该保存由<code class="du kt ku kv jt b">email_backend</code>引用的电子邮件子系统所需的参数。此连接id将用于获取允许气流使用Sendgrid所需的信息。出于我们的目的，我们希望<code class="du kt ku kv jt b">airflow.cfg</code>现在包括:</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="7d36" class="jx jy hi jt b fi jz ka l kb kc">[email]<br/>email_backend=airflow.providers.sendgrid.utils.emailer.send_email<br/>email_conn_id=sendgrid_default</span></pre><p id="48bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在菜谱的后面，我们将展示如何在Composer环境中设置这些值。</p><p id="5873" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当通过Airflow发送电子邮件时，该电子邮件将被视为源自某个源电子邮件地址，并且具有与该地址相关联的名称。如果这些参数是连接id的一部分就更好了，但遗憾的是事实并非如此。相反，使用两个环境变量来提供这些值:</p><ul class=""><li id="c576" class="kf kg hi is b it iu ix iy jb kh jf ki jj kj jn kk kl km kn bi translated">SENDGRID_MAIL_FROM=mycomposer@example.com</li><li id="4098" class="kf kg hi is b it ko ix kp jb kq jf kr jj ks jn kk kl km kn bi translated">SENDGRID _ MAIL _ SENDER =作曲家</li></ul><p id="a76a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">可能需要配置Sendgrid来授权来自源地址的电子邮件。</p><p id="3f92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此时，我们可以创建气流连接定义，我们的解决方案将运行；然而，我们想利用GCP秘密作为我们的安全信息的金库。为此，我们需要在我们的<code class="du kt ku kv jt b">airflow.cfg</code>文件中增加一个条目。</p><p id="0703" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了能够使用Secret manager，我们需要修改<code class="du kt ku kv jt b">airflow.cfg</code>以在secrets部分包含一个名为<code class="du kt ku kv jt b">secrets</code>的条目。这是用来命名一些插件逻辑，提供了一个存储秘密的钩子。气流为GCP秘密经理提供了一个插件。因此，<code class="du kt ku kv jt b">airflow.cfg</code>中的条目应为:</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="1025" class="jx jy hi jt b fi jz ka l kb kc">[secrets]<br/>backend=airflow.providers.google.cloud.secrets.secret_manager.CloudSecretManagerBackend</span></pre><p id="3144" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当这被配置时，当需要秘密时，气流将咨询GCP秘密管理器。连接定义也被视为机密。如果我们在Secret Manager中创建一个适当命名的条目，Airflow将使用该机密的值作为连接Id。该值必须以连接Id URL格式编码。</p><p id="8b57" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于Sendgrid，我们可以创建以下格式的值:</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="482f" class="jx jy hi jt b fi jz ka l kb kc">sendgrid://username:[SOME_API_KEY]@host</span></pre><p id="37fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">值中只检查API键。秘密的名字也是极其重要的。连接Id的机密名称的结构是:</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="364d" class="jx jy hi jt b fi jz ka l kb kc">airflow-connections-[CONNECTION_ID]</span></pre><p id="07d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就我们的目的而言，这意味着:</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="e904" class="jx jy hi jt b fi jz ka l kb kc">airflow-connections-sendgrid_default</span></pre><p id="aaf1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就这样…所有的部分都连接在一起了。</p><p id="4a6a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们将演示所有部件。</p><ol class=""><li id="064a" class="kf kg hi is b it iu ix iy jb kh jf ki jj kj jn kx kl km kn bi translated">创建新的Composer环境</li></ol><p id="54a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个新的GCP作曲家环境。接受大多数默认值。在我的测试中，我使用的是气流版本2.1.4。在确认之前，请确保指定气流配置覆盖和环境变量的值:</p><p id="e2e9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">气流配置覆盖</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="8f93" class="jx jy hi jt b fi jz ka l kb kc">[email]<br/>email_backend=airflow.providers.sendgrid.utils.emailer.send_email<br/>email_conn_id=sendgrid_default<br/>[secrets]<br/>backend=airflow.providers.google.cloud.secrets.secret_manager.CloudSecretManagerBackend<br/>[logging]<br/>logging_level=DEBUG</span></pre><p id="9fb8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">(注意，日志条目不是必需的，但是根据我的经验，它在开发/测试期间非常有价值)</p><p id="0557" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">环境变量</p><ul class=""><li id="09b3" class="kf kg hi is b it iu ix iy jb kh jf ki jj kj jn kk kl km kn bi translated">SENDGRID_MAIL_FROM=mycomposer@example.com</li><li id="e6cb" class="kf kg hi is b it ko ix kp jb kq jf kr jj ks jn kk kl km kn bi translated">SENDGRID _ MAIL _ SENDER =作曲家</li></ul><figure class="jo jp jq jr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ky"><img src="../Images/e1ea30d7a07bfb08ae490503a286257b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*p5_i7DNtLB8noCN7"/></div></div></figure><p id="ae82" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建Composer环境可能需要10-20分钟。</p><p id="d93f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.在GCP秘密管理器中创建一个秘密</p><p id="b4a3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在GCP秘密管理器中，创建一个名为<code class="du kt ku kv jt b">airflow-connections-sendgrid_default</code>的新秘密。将其值设置为</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="9837" class="jx jy hi jt b fi jz ka l kb kc">sendgrid://username:[SENDGRID_API_KEY]@host</span></pre><p id="a31c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.授权作曲家阅读秘密</p><p id="e726" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在运行时，Composer需要能够从秘密管理器中读取秘密的值。确保添加了IAM权限以允许访问。</p><p id="2ec8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.运行失败的DAG</p><p id="3002" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们现在运行一个配置为在失败时发送电子邮件的失败DAG，我们会发现已经发送了一封电子邮件。</p><p id="21b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另请参见:</p><ul class=""><li id="a7a6" class="kf kg hi is b it iu ix iy jb kh jf ki jj kj jn kk kl km kn bi translated"><a class="ae ke" href="https://airflow.apache.org/docs/apache-airflow/stable/howto/email-config.html" rel="noopener ugc nofollow" target="_blank">气流:邮件配置</a></li><li id="ec6c" class="kf kg hi is b it ko ix kp jb kq jf kr jj ks jn kk kl km kn bi translated"><a class="ae ke" href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html#email" rel="noopener ugc nofollow" target="_blank">气流:配置—电子邮件</a></li><li id="cbe4" class="kf kg hi is b it ko ix kp jb kq jf kr jj ks jn kk kl km kn bi translated"><a class="ae ke" href="https://cloud.google.com/composer/docs/composer-2/configure-secret-manager" rel="noopener ugc nofollow" target="_blank"> Docs:为您的环境配置Secret Manager】</a></li></ul></div></div>    
</body>
</html>