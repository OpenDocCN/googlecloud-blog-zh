<html>
<head>
<title>Global ingress in practice on Google Container Engine — Part 2: Demo</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google容器引擎的全球入口实践—第2部分:演示</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/global-ingress-in-practice-on-google-container-engine-part-2-demo-cf587765702?source=collection_archive---------0-----------------------#2017-09-20">https://medium.com/google-cloud/global-ingress-in-practice-on-google-container-engine-part-2-demo-cf587765702?source=collection_archive---------0-----------------------#2017-09-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/1048d3d2cf3504b87f5837b165579f73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OJVUtgtFOdUsoOF2."/></div></div></figure><p id="f1a5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本文是前几篇文章的后续，前几篇文章分别是:GCP 上的<a class="ae jo" rel="noopener" href="/google-cloud/global-kubernetes-in-3-steps-on-gcp-8a3585ec8547">全球Kubernetes三步曲，介绍了如何建立一个全球集群；以及</a><a class="ae jo" rel="noopener" href="/@cgrant/global-ingress-in-practice-on-google-container-engine-part-1-discussion-ccc1e5b27bd0">Google Container Engine上的Global ingress实践——第一部分:讨论</a>,讨论了如何将一个全球集群与Google LoadBalancer一起用于ingress。</p><p id="1973" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">源代码</strong> <br/>本演练的源代码可以在GitHub的<a class="ae jo" href="https://github.com/cgrant/global-k8s-ingress-with-gce-controller" rel="noopener ugc nofollow" target="_blank">这里找到</a></p><p id="3beb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这里，您会发现:<br/> - /app —演示中使用的应用程序代码<br/> - /cluster —一个配置联合集群的脚本<br/> - /deploy —我们将在演示中使用的k8s yaml文件</p><h1 id="aaa9" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">设置集群</h1><p id="69d7" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我在<a class="ae jo" rel="noopener" href="/google-cloud/global-kubernetes-in-3-steps-on-gcp-8a3585ec8547">Global Kubernetes in 3 Steps</a>帖子中详细介绍了这一点，并在<a class="ae jo" href="https://github.com/cgrant/global-k8s-ingress-with-gce-controller/blob/master/README.md" rel="noopener ugc nofollow" target="_blank"> README </a>中再次提供了这一点。这篇文章更多的是关于如何使用它，所以我不会在这里进入设置过程。</p><h1 id="32fe" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">部署应用程序和入口</h1><p id="3be5" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">首先，获取回购并在本地克隆它</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="ba18" class="lb jq hi kx b fi lc ld l le lf"><br/>git clone <a class="ae jo" href="https://github.com/cgrant/global-k8s-ingress-with-gce-controller" rel="noopener ugc nofollow" target="_blank">https://github.com/cgrant/global-k8s-ingress-with-gce-controller</a><br/>cd global-k8s-ingress-with-gce-controller<br/></span></pre><p id="b61d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于这个例子，我在/apps目录中提供了示例python应用程序。我已经预先构建了它们，并把它们发布到docker hub上。您应该能够自定义代码或交换您自己的图像。</p><p id="7ba0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">部署应用</strong></p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="1b1e" class="lb jq hi kx b fi lc ld l le lf">kubectl apply -f deploy/app-with-context.yaml<br/>kubectl apply -f deploy/simple-echo.yaml</span></pre><p id="a3bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如在第1部分中提到的，您需要在部署中显式设置NodePort值。我已经为你设置了30048和30050</p><p id="25d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">查看<a class="ae jo" href="https://console.cloud.google.com/kubernetes/workload" rel="noopener ugc nofollow" target="_blank">谷歌云控制台</a>中的工作负载页面</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lg"><img src="../Images/69ccf7ba06283cc1cb761dd36825960a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tlHhuld_TogUG01R_mA_IA.png"/></div></div></figure><p id="5b75" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">创建一个全球IP </strong> <br/>一旦部署了应用程序包，我们就可以考虑通过入口将它们连接在一起。</p><p id="a14a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们需要做的第一件事是为全局负载平衡器创建一个全局IP。</p><blockquote class="lh li lj"><p id="b7da" class="iq ir lk is b it iu iv iw ix iy iz ja ll jc jd je lm jg jh ji ln jk jl jm jn hb bi translated">这对于ingress在多个集群上工作至关重要。默认的临时IP只是区域性的，不允许适当的联合</p></blockquote><p id="2df7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个名为<code class="du lo lp lq kx b">ingress-ip</code>的全球ip</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="1630" class="lb jq hi kx b fi lc ld l le lf">gcloud compute addresses create ingress-ip — global</span></pre><p id="3b18" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">展开入口</strong></p><p id="b334" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在部署入口本身</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="4a2d" class="lb jq hi kx b fi lc ld l le lf">kubectl apply -f deploy/ingress.yaml</span></pre><p id="8a94" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将需要一段时间，大约5分钟，以便在全球范围内创建负载平衡器并通过所有运行状况检查。</p><p id="2582" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以在云控制台的<a class="ae jo" href="https://console.cloud.google.com/kubernetes/discovery" rel="noopener ugc nofollow" target="_blank">发现&amp;负载平衡页面</a>上查看进度</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/df113f28613d946ce8a8f5f04ea26f54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iZ4sXIqHwICgDp91RcKtEA.png"/></div></div></figure><p id="2c31" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">负载平衡器启动后，您可以访问以下URL:</p><p id="eb04" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">/<br/>/foo<br/>/foo/bar<br/>/echo<br/>/echo/any string</p><p id="c25f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从云控制台中的<a class="ae jo" href="https://console.cloud.google.com/kubernetes/discovery" rel="noopener ugc nofollow" target="_blank">发现&amp;负载平衡页面</a>中，单击负载平衡器名称了解详细信息。然后向下滚动到后端。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/99d285f66970e975ebea8d625ebf9fff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FjQZYK5tpDWG7Uj1Ug48Mg.png"/></div></div></figure><p id="aaa2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在你的入口yaml中，每个服务都有一个后端。继续点击其中一个后端</p><p id="5751" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">随着流量流向您的新服务，您可以在此页面上看到位置和其他指标的细分。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/28d903b94609645e6e49f36a48020902.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GBoxs_TTuOwWWOypq_k3kw.png"/></div></div></figure><p id="7c51" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就这样，你可以走了！</p><h1 id="c798" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">独立地</h1><p id="1313" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">这是演示的简短和甜蜜。一定要研究代码以理解其中的机制。也可以自己尝试更新</p><p id="ff72" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">继续部署您自己的服务，修改ingress.yaml并运行</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="dceb" class="lb jq hi kx b fi lc ld l le lf">kubectl apply -f deploy/ingress.yaml</span></pre><p id="16a1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">负载平衡器上的新服务需要几分钟才能出现，但是对现有服务的更改非常快</p><p id="6fca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">尝试将应用程序部署中的映像更新为新的内容，例如，我可能会更新“simple-echo.yaml”</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="b2f6" class="lb jq hi kx b fi lc ld l le lf">spec:<br/> containers:<br/> — name: simple-echo<br/> image: cgrant/simple-echo-server<br/>```</span></pre><p id="40ba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">到</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="3249" class="lb jq hi kx b fi lc ld l le lf">spec:<br/> containers:<br/> — name: simple-echo<br/> image: cgrant/simple-echo-server:version1<br/></span></pre><p id="21b7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后申请</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="c01c" class="lb jq hi kx b fi lc ld l le lf">kubectl apply -f deploy/simple-echo.yaml</span></pre><p id="ce0c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">容器会及时更新，您就万事俱备了！</p><p id="5503" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我真的很喜欢使用Kubernetes的原生谷歌云产品的能力。它消除了基础架构的许多麻烦，同时为我的应用程序提供了强大的托管工具。</p><p id="85d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">希望你喜欢。请留下任何意见或问题</p></div></div>    
</body>
</html>