<html>
<head>
<title>BigQuery Deduplication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">大查询重复数据删除</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bigquery-deduplication-14a1206efdbb?source=collection_archive---------0-----------------------#2019-09-10">https://medium.com/google-cloud/bigquery-deduplication-14a1206efdbb?source=collection_archive---------0-----------------------#2019-09-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e812" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你曾经在BigQuery中得到重复的行吗？</p><p id="b6cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将探索BigQuery中针对整个表和按分区进行重复数据删除的一些技术。它假设您有数据集事务。</p><h1 id="9e08" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">创建您的测试数据</h1><p id="f1d1" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">这将创建一个包含两列(date，v)的表。将有21天的数据(按日期划分)，每天将有一百万行。值v通常是唯一的，但是会有许多重复的值。</p><h2 id="16f8" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">创建数据</h2><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="d8d5" class="kg je hi kz b fi ld le l lf lg">CREATE OR REPLACE TABLE `transactions.testdata`<br/>PARTITION BY date<br/>AS SELECT<br/>  date,<br/>  CAST((i*2)+(2-FLOOR(RAND()*4.0)) AS INT64) AS v<br/>FROM<br/>  UNNEST(GENERATE_DATE_ARRAY(<br/>    CURRENT_DATE(),<br/>    DATE_ADD(CURRENT_DATE(), INTERVAL 20 DAY)<br/>  )) AS date<br/>  CROSS JOIN UNNEST(GENERATE_ARRAY(1, 1000000, 1)) AS i;</span></pre><h2 id="ce50" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">检查您的数据</h2><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="4b61" class="kg je hi kz b fi ld le l lf lg">SELECT<br/>  date,<br/>  COUNT(DISTINCT v) AS unique_values,<br/>  COUNT(*) AS value<br/>FROM<br/>  `transactions.testdata`<br/>GROUP BY<br/>  1;</span></pre><p id="a049" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些是输出的前十行。</p><figure class="ku kv kw kx fd li er es paragraph-image"><div class="er es lh"><img src="../Images/b16bdc155243c526f2c0f380c99447fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*w8_IaFgTHQ-Mcc4gRelsmQ.png"/></div></figure><p id="acdd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以看到(取决于RAND())有相当多的unique_values，但总是少于整整一百万。我们想删除重复的。</p><h1 id="ab08" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">对所有内容进行重复数据消除—简单的方法</h1><p id="33eb" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">最简单的方法是使用DISTINCT就地重新创建整个表。您需要对表使用相同的参数(PARTITION BY)。</p><h2 id="a5c7" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">重新创建表格</h2><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="4662" class="kg je hi kz b fi ld le l lf lg">CREATE OR REPLACE TABLE `transactions.testdata`<br/>PARTITION BY date<br/>AS SELECT DISTINCT * FROM `transactions.testdata`;</span></pre><p id="96a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这处理了大约320MB，消耗了2分15秒的槽时间。</p><h2 id="cb72" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">检查您的数据</h2><p id="43c8" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">运行查询以检查数据，结果显示该数据现在已消除重复数据:</p><figure class="ku kv kw kx fd li er es paragraph-image"><div class="er es ll"><img src="../Images/251ab282298b3bf5adbc76cbacaa7abf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*HDedcaJAOwoHIZL6RF3peg.png"/></div></figure><p id="eaf9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，如果您有分区，并且您正在追加到您的表，您不希望每次都对整个表进行重复数据删除。相反，您希望只对您的分区进行重复数据删除。但是怎么做呢？</p><h1 id="8fd0" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">对部分表进行重复数据删除—合并</h1><p id="e788" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">请重新运行该查询，再次创建该表，使其充满重复项。这样，您可以看到部分重复数据消除。</p><h2 id="2504" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">使用合并进行重复数据删除</h2><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="ba53" class="kg je hi kz b fi ld le l lf lg">MERGE `transactions.testdata` t<br/>USING (<br/>  SELECT DISTINCT *<br/>  FROM `transactions.testdata`<br/>  WHERE date=CURRENT_DATE()<br/>)<br/>ON FALSE<br/>WHEN NOT MATCHED BY SOURCE AND date=CURRENT_DATE() THEN DELETE<br/>WHEN NOT MATCHED BY TARGET THEN INSERT ROW</span></pre><p id="b7e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这处理了15.3MB，消耗了18秒的槽时间。由于有21天的数据，这是有意义的。</p><h2 id="57fc" class="kg je hi bd jf kh ki kj jj kk kl km jn iq kn ko jr iu kp kq jv iy kr ks jz kt bi translated">检查您的数据</h2><p id="063f" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">其中一天(即撰写本文时的当前日期)未进行重复数据消除，但其他几天都没有。果然不出所料！</p><figure class="ku kv kw kx fd li er es paragraph-image"><div class="er es lm"><img src="../Images/091d2e8144fda66a1710fa185ab95a58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*YvXdTWITX1jGdZI-zrBJbQ.png"/></div></figure><h1 id="8f1a" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="9884" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">在BigQuery中，跨整个表或表的一个子集(包括一个分区子集)对行进行重复数据删除非常容易。</p></div></div>    
</body>
</html>