<html>
<head>
<title>Start/Stop Compute Engine Instance from Cloud function</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从云功能启动/停止计算引擎实例</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/start-stop-compute-engine-instance-from-cloud-function-bf9ae5199609?source=collection_archive---------0-----------------------#2017-05-26">https://medium.com/google-cloud/start-stop-compute-engine-instance-from-cloud-function-bf9ae5199609?source=collection_archive---------0-----------------------#2017-05-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d33e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我设计了一个运行在Google计算引擎上的web服务来完成一些长时间的数据处理任务。数据将存储在云存储中，计算引擎上的服务将从云存储中获取数据。处理后，服务会将处理后的数据保存回云存储。并且，该服务没有被频繁使用。</p><p id="24fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们启动一个计算引擎实例，它将开始消耗我们的资源。为了节省成本，我需要尽量减少浪费。因此，我开始调查是否有办法只在我们需要时才启动计算引擎。</p><p id="e8ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从谷歌云平台文档中挖掘后，我发现:</p><div class="jd je ez fb jf jg"><a href="https://cloud.google.com/compute/docs/tutorials/nodejs-guide" rel="noopener  ugc nofollow" target="_blank"><div class="jh ab dw"><div class="ji ab jj cl cj jk"><h2 class="bd hj fi z dy jl ea eb jm ed ef hh bi translated">使用Node.js客户端库|计算引擎文档| Google云平台</h2><div class="jn l"><h3 class="bd b fi z dy jl ea eb jm ed ef dx translated">在计算引擎上部署Docker容器</h3></div><div class="jo l"><p class="bd b fp z dy jl ea eb jm ed ef dx translated">cloud.google.com</p></div></div></div></a></div><p id="d539" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个库允许我们访问计算引擎！我决定改变我的系统设计:当数据上传到云存储时，它触发云功能。云函数发送命令启动计算引擎处理数据。处理后，计算引擎触发云函数事件来停止计算引擎本身。通过这种设计，我们可以在不需要使用虚拟机时停止虚拟机，以节省资金。也就是说，只在需要时才启用虚拟机！</p><p id="300f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于云函数，我创建了两个函数:</p><p id="ee02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启动计算引擎:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="e3a3" class="jy jz hi ju b fi ka kb l kc kd">var http = require('http');</span><span id="3209" class="jy jz hi ju b fi ke kb l kc kd">var Compute = require('@google-cloud/compute');</span><span id="dc1e" class="jy jz hi ju b fi ke kb l kc kd">var compute = Compute();</span><span id="59f9" class="jy jz hi ju b fi ke kb l kc kd">exports.startInstance = function startInstance(req, res) {</span><span id="8d9c" class="jy jz hi ju b fi ke kb l kc kd">    var zone = compute.zone('<strong class="ju hj"><em class="kf">instance zone here</em></strong>');</span><span id="a90a" class="jy jz hi ju b fi ke kb l kc kd">    var vm = zone.vm('<strong class="ju hj"><em class="kf">instance name here</em></strong>');</span><span id="6f77" class="jy jz hi ju b fi ke kb l kc kd">    vm.start(function(err, operation, apiResponse) {</span><span id="e681" class="jy jz hi ju b fi ke kb l kc kd">        console.log('instance start successfully');<br/>    });</span><span id="7ac0" class="jy jz hi ju b fi ke kb l kc kd">res.status(200).send('Success start instance');</span><span id="f3df" class="jy jz hi ju b fi ke kb l kc kd">};</span></pre><p id="3240" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">package.json:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="28b3" class="jy jz hi ju b fi ka kb l kc kd">{</span><span id="88cc" class="jy jz hi ju b fi ke kb l kc kd">"name": "sample-http",</span><span id="2a8a" class="jy jz hi ju b fi ke kb l kc kd">"dependencies": {</span><span id="010d" class="jy jz hi ju b fi ke kb l kc kd">"@google-cloud/compute": "0.7.1"</span><span id="3a28" class="jy jz hi ju b fi ke kb l kc kd">},</span><span id="0215" class="jy jz hi ju b fi ke kb l kc kd">"version": "0.0.1"</span><span id="9782" class="jy jz hi ju b fi ke kb l kc kd">}</span></pre><p id="2f9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">停止计算引擎:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="c7a1" class="jy jz hi ju b fi ka kb l kc kd">var Compute = require('@google-cloud/compute');</span><span id="f8dc" class="jy jz hi ju b fi ke kb l kc kd">var compute = Compute();</span><span id="4442" class="jy jz hi ju b fi ke kb l kc kd">exports.stopInstance = function stopInstance(req, res) {</span><span id="1765" class="jy jz hi ju b fi ke kb l kc kd">    var zone = compute.zone('<strong class="ju hj"><em class="kf">instance zone here</em></strong>');</span><span id="2c57" class="jy jz hi ju b fi ke kb l kc kd">    var vm = zone.vm('<strong class="ju hj"><em class="kf">instance name here</em></strong>');</span><span id="da64" class="jy jz hi ju b fi ke kb l kc kd">    vm.stop(function(err, operation, apiResponse) {</span><span id="7bdc" class="jy jz hi ju b fi ke kb l kc kd">        console.log('instance stop successfully');</span><span id="ba38" class="jy jz hi ju b fi ke kb l kc kd">    });</span><span id="5654" class="jy jz hi ju b fi ke kb l kc kd">    res.status(200).send('Success stop instance');</span><span id="ad47" class="jy jz hi ju b fi ke kb l kc kd">};</span></pre><p id="0111" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">测试这些函数，您将看到您的实例开始/停止。这篇文章是我的一些有趣的尝试。对一个真正的系统设计可能没什么用，但对我来说会省钱！</p><p id="0ca8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前，我没有完成设计的完整流程，所以也许在了解更多关于谷歌云平台的信息后，我的服务的设计会再次改变。:)</p></div></div>    
</body>
</html>