<html>
<head>
<title>Bash Code Coverage Using Codecov with kcov &amp; Travis CI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Codecov和kcov &amp; Travis CI的Bash代码覆盖率</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bash-code-coverage-using-codecov-with-kcov-travis-ci-303f3356981c?source=collection_archive---------0-----------------------#2017-10-25">https://medium.com/google-cloud/bash-code-coverage-using-codecov-with-kcov-travis-ci-303f3356981c?source=collection_archive---------0-----------------------#2017-10-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0ad5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在Travis CI中的VM构建系统和获取gcloud的当前版本方面有一些限制，所以我做了一些小改动，并从<a class="ae jd" href="https://github.com/codecov/example-bash" rel="noopener ugc nofollow" target="_blank"> Codecov bash示例</a>中转移出来。</p><p id="ce3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我目前正在使用的travis.yml的一部分:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="2c89" class="jn jo hi jj b fi jp jq l jr js">sudo: false</span><span id="fd1b" class="jn jo hi jj b fi jt jq l jr js">addons:<br/>  apt:<br/>    packages:<br/>      - binutils-dev<br/>      - libcurl4-openssl-dev<br/>      - libdw-dev<br/>      - libiberty-dev</span><span id="5e2f" class="jn jo hi jj b fi jt jq l jr js">language: bash</span><span id="1088" class="jn jo hi jj b fi jt jq l jr js">env:<br/>- PATH=${PATH}:${HOME}/kcov/bin</span><span id="1be5" class="jn jo hi jj b fi jt jq l jr js">before_install:<br/>- wget <a class="ae jd" href="https://github.com/SimonKagstrom/kcov/archive/master.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/SimonKagstrom/kcov/archive/master.tar.gz</a></span><span id="d329" class="jn jo hi jj b fi jt jq l jr js">install:<br/>- tar xzf master.tar.gz<br/>- cd kcov-master<br/>- mkdir build<br/>- cd build<br/>- cmake -DCMAKE_INSTALL_PREFIX=${HOME}/kcov ..<br/>- make<br/>- make install<br/>- cd ../..<br/>- rm -rf kcov-master<br/>- mkdir -p coverage</span><span id="db3b" class="jn jo hi jj b fi jt jq l jr js">script:<br/>- kcov coverage test.sh</span><span id="8b0b" class="jn jo hi jj b fi jt jq l jr js">after_success:<br/>- bash &lt;(curl -s <a class="ae jd" href="https://codecov.io/bash" rel="noopener ugc nofollow" target="_blank">https://codecov.io/bash</a>)</span></pre><p id="37d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这对我来说没有任何问题。它摆脱了VM Travis CI构建系统，让我可以灵活地安装gcloud，而且速度也更快！对<a class="ae jd" href="https://docs.travis-ci.com/user/installing-dependencies/#Installing-Packages-on-Container-Based-Infrastructure" rel="noopener ugc nofollow" target="_blank">在基于容器的环境</a>上安装包的支持使这成为可能，允许我满足对<a class="ae jd" href="https://github.com/SimonKagstrom/kcov/blob/master/INSTALL.md" rel="noopener ugc nofollow" target="_blank"> kcov </a>的依赖。</p><p id="6790" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我还用一种超级简单的秒表方式测试了Travis CI中kcov的缓存..缓存测试运行大约需要1.12分钟，而下载和编译每个构建大约需要2:40分钟。</p><p id="947e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个更完整的travis.yml示例</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="ebbc" class="jn jo hi jj b fi jp jq l jr js">sudo: false</span><span id="8f40" class="jn jo hi jj b fi jt jq l jr js">addons:<br/>  apt:<br/>    packages:<br/>      - binutils-dev<br/>      - libcurl4-openssl-dev<br/>      - libdw-dev<br/>      - libiberty-dev</span><span id="6a10" class="jn jo hi jj b fi jt jq l jr js">language: bash</span><span id="5b26" class="jn jo hi jj b fi jt jq l jr js">cache:<br/>  directories:<br/>  - "${HOME}/google-cloud-sdk/"<br/>  - "${HOME}/kcov/"</span><span id="1941" class="jn jo hi jj b fi jt jq l jr js">env:<br/>- PATH=$PATH:${HOME}/google-cloud-sdk/bin:${HOME}/kcov/bin CLOUDSDK_CORE_DISABLE_PROMPTS=1</span><span id="afe2" class="jn jo hi jj b fi jt jq l jr js">before_install:<br/>- openssl aes-256-cbc -K $encrypted_c4d8f070a225_key -iv $encrypted_c4d8f070a225_iv<br/>  -in credentials.tar.gz.enc -out credentials.tar.gz -d<br/>- if [ ! -d "${HOME}/google-cloud-sdk/bin" ]; then rm -rf ${HOME}/google-cloud-sdk;<br/>  curl <a class="ae jd" href="https://sdk.cloud.google.com" rel="noopener ugc nofollow" target="_blank">https://sdk.cloud.google.com</a> | bash; fi<br/>- if [ ! -d "${HOME}/kcov/bin" ]; then wget <a class="ae jd" href="https://github.com/SimonKagstrom/kcov/archive/master.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/SimonKagstrom/kcov/archive/master.tar.gz</a>;<br/>  tar xzf master.tar.gz;<br/>  cd kcov-master;<br/>  mkdir build;<br/>  cd build;<br/>  cmake -DCMAKE_INSTALL_PREFIX=${HOME}/kcov ..;<br/>  make;<br/>  make install;<br/>  cd ../..;<br/>  rm -rf kcov-master;<br/>  mkdir -p coverage; fi<br/>- tar -xzf credentials.tar.gz<br/>- gcloud auth activate-service-account --key-file client-secret.json</span><span id="32ae" class="jn jo hi jj b fi jt jq l jr js">install:<br/>- gcloud -q components update</span><span id="ab28" class="jn jo hi jj b fi jt jq l jr js">script:<br/>#- kcov --exclude-path=ops-common coverage test.sh</span><span id="d8cc" class="jn jo hi jj b fi jt jq l jr js">after_success:<br/>- bash &lt;(curl -s <a class="ae jd" href="https://codecov.io/bash" rel="noopener ugc nofollow" target="_blank">https://codecov.io/bash</a>)</span><span id="b8e9" class="jn jo hi jj b fi jt jq l jr js">notifications:<br/>  slack: lzysh:0nheJvFHhsWdYlVVfdX0mRNu</span></pre><p id="e022" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我可能会测试一下这个配置，看看效果如何。如果一切正常，编写一些快速检查kcov更新的代码，并在需要时进行更新。</p><p id="9bc2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与实现代码覆盖的努力相比，即使是简单的GCP基础设施bash代码，代码覆盖的附加值也是相当高的，所以我要说去做吧！</p></div></div>    
</body>
</html>