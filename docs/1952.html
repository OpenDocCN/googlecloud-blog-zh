<html>
<head>
<title>Using GCP Cloud Asset Inventory Export to keep track of your GCP resources over time</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GCP云资产清单导出来随时跟踪您的GCP资源</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-gcp-cloud-asset-inventory-export-to-keep-track-of-your-gcp-resources-over-time-20fb6fa63c68?source=collection_archive---------0-----------------------#2021-09-01">https://medium.com/google-cloud/using-gcp-cloud-asset-inventory-export-to-keep-track-of-your-gcp-resources-over-time-20fb6fa63c68?source=collection_archive---------0-----------------------#2021-09-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d66d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌<a class="ae jd" href="https://cloud.google.com/asset-inventory" rel="noopener ugc nofollow" target="_blank">云资产清单</a>是一项伟大的服务，允许您查看、监控和分析您的GCP资产，让您可以选择导出任何时间点(最多35天)的整个清单的快照。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/e17448698c5aab9f9f4cfb814569f263.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZwEMUB7s8I9Tn9rTXAIRvA.jpeg"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">云资产清点:在一个地方发现、监控和分析您的所有资产。</figcaption></figure><p id="6085" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有时，您希望更长时间地跟踪您的资产，以便进行仪表盘操作或分析。下面显示的代码描述了一个每周将您的云资产清单导出到BigQuery的解决方案。</p><p id="b9bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该示例旨在导出项目级别的资源。这样做是为了保持示例的简单和独立。在实际使用中，当然需要一些改变:</p><ul class=""><li id="40ef" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">界定云功能的导出和IAM自定义角色/绑定的范围，以便在组织/文件夹级别导出数据；</li><li id="86cb" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">调整函数的重试和错误处理；</li><li id="56fe" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">将导出与您最喜欢的仪表板工具集成在一起。</li></ul><p id="5aba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是示例代码将创建的资源的高级概述:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ki"><img src="../Images/481e1e13d69ea72c7d65d261a45275f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JyzshEag_a5lNKaq4L-0kg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">示例创建的架构:云调度器、发布/订阅、云功能、资产库存、BigQuery。</figcaption></figure><p id="8c52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要运行这个例子，首先克隆<a class="ae jd" href="https://github.com/terraform-google-modules/cloud-foundation-fabric" rel="noopener ugc nofollow" target="_blank">Google Foundation Fabric Repository</a>并移动到<a class="ae jd" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric/tree/master/blueprints/cloud-operations/scheduled-asset-inventory-export-bq" rel="noopener ugc nofollow" target="_blank">blue prints/cloud-operations/scheduled-asset-inventory-export-bq</a>blue prints文件夹。</p><pre class="jf jg jh ji fd kj kk kl km aw kn bi"><span id="14af" class="ko kp hi kk b fi kq kr l ks kt">git clone https://github.com/terraform-google-modules/cloud-foundation-fabric.git<br/>cd blueprints/cloud-foundation-fabric/cloud-operations/scheduled-asset-inventory-export-bq</span></pre><p id="bed1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在正确的文件夹中，创建一个<code class="du ku kv kw kk b">terraform.tfvars</code>文件，用您选择的文本编辑器打开它，并至少指定以下变量:</p><pre class="jf jg jh ji fd kj kk kl km aw kn bi"><span id="3b1d" class="ko kp hi kk b fi kq kr l ks kt">cai_config     = {<br/>    bq_dataset = "cai"<br/>    bq_table   = "assets"<br/>}<br/>project_id     = "YOUR_PROJECT"<br/>billing_account = "111111-222222-333333"<br/>root_node       = "folders/112233445566"</span></pre><p id="44c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该脚本将部署现有项目中的所有资源，如果您想要创建一个新项目，请查看变量文件并相应地设置您的变量。</p><p id="60f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行初始化Terraform并应用更改:</p><pre class="jf jg jh ji fd kj kk kl km aw kn bi"><span id="8e44" class="ko kp hi kk b fi kq kr l ks kt">terraform init<br/>terraform apply</span></pre><p id="0331" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Terraform完成后，计划每周运行一次作业，提取数据并存储在Bigquery中。如果您想要运行测试，请打开云功能面板并点击<code class="du ku kv kw kk b">run now</code>按钮。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kx"><img src="../Images/82742d5cbfd5f0bac7c3a875fa576a14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-vw4ICPjot0R_JpD2_m41A.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">谷歌云调度控制台。</figcaption></figure><p id="7302" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦任务结束，您将能够在Bigquery上检查数据:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ky"><img src="../Images/edc991ec276f599a56f605f3a946bd58.png" data-original-src="https://miro.medium.com/v2/resize:fit:952/format:webp/1*wC-JlW6TGLNWTnVTS_g6LQ.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">查询导出到Bigquery的云资产清单数据的示例语句</figcaption></figure><h1 id="1aec" class="kz kp hi bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">后续步骤</h1><p id="0035" class="pw-post-body-paragraph if ig hi ih b ii lw ik il im lx io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">将云资产清单数据导出到BigQuery后，您可以创建管道或仪表板来分析或监控您的GCP资产。</p></div></div>    
</body>
</html>