<html>
<head>
<title>Access to Google Workspace documents from Cloud Build</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从云构建中访问Google Workspace文档</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/access-to-google-workspace-documents-from-cloud-build-3001c2883b66?source=collection_archive---------2-----------------------#2022-10-27">https://medium.com/google-cloud/access-to-google-workspace-documents-from-cloud-build-3001c2883b66?source=collection_archive---------2-----------------------#2022-10-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f91489e9ebe94cab085ceb1a7af15110.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BcveRMWBJQjBvar17v4qVA.png"/></div></div></figure><p id="b02f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现代代码开发<strong class="is hj">基于自动化</strong>，尤其是CI/CD管道(持续集成持续部署/交付)。在Google Cloud上，<a class="ae jo" href="https://cloud.google.com/build" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">Cloud Build</strong></a><strong class="is hj">是实现CI/CD的无服务器解决方案</strong>，提供了许多特性和高度可定制的管道。</p><p id="9c00" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在代码打包期间，您可能需要<strong class="is hj">依赖于其他数据，而不仅仅是您的代码</strong>，用于配置、丰富、定制、版本控制……新的数据源可以在数据库中，也可以在<strong class="is hj">Google Workspace文档中</strong>。</p><blockquote class="jp"><p id="902e" class="jq jr hi bd js jt ju jv jw jx jy jn dx translated">从Cloud Build访问Google Workspace文档并不容易！</p></blockquote><h1 id="2031" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">访问Google Workspace文档</h1><p id="95ca" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">在尝试访问文档之前，让我们先编写一个小的python脚本<strong class="is hj">来读取Google Sheet文档</strong></p><pre class="lg lh li lj fd lk lf ll lm aw ln bi"><span id="fdf2" class="lo ka hi lf b fi lp lq l lr ls">import google.auth<br/>from googleapiclient.discovery import build<br/>from googleapiclient.errors import HttpError<br/><br/># The ID and range of a sample spreadsheet.<br/>SAMPLE_SPREADSHEET_ID = 'YOUR_SHEET_ID'<br/>SAMPLE_RANGE_NAME = 'DATA!A2:E' #Example<br/><br/><br/>def main():<br/>    <em class="lt">"""Shows basic usage of the Sheets API.<br/>    Prints values from a sample spreadsheet.<br/>    """<br/><br/>    </em>creds, _ = google.auth.default()<br/>    try:<br/>        service = build('sheets', 'v4', credentials=creds)<br/>        # Call the Sheets API<br/>        sheet = service.spreadsheets()<br/>        result = sheet.values().get(spreadsheetId=SAMPLE_SPREADSHEET_ID,<br/>                                    range=SAMPLE_RANGE_NAME).execute()<br/>        values = result.get('values', [])<br/><br/>        if not values:<br/>            print('No data found.')<br/>            return<br/><br/>        print('Name, Major:')<br/>        for row in values:<br/>            # Print columns A and E<br/>            print('%s, %s' % (row[0], row[4]))<br/>    except HttpError as err:<br/>        print(err)<br/><br/><br/>if __name__ == '__main__':<br/>    main()</span></pre><p id="a297" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">安装依赖项(文件<code class="du lc ld le lf b">requirements.txt</code></p><pre class="lg lh li lj fd lk lf ll lm aw ln bi"><span id="649e" class="lo ka hi lf b fi lp lq l lr ls">google-api-python-client<br/>google-auth</span><span id="b7d1" class="lo ka hi lf b fi lu lq l lr ls"># Install dependencies with: pip3 install -r requirements.txt</span></pre><p id="3195" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以进行第一次尝试。</p><pre class="lg lh li lj fd lk lf ll lm aw ln bi"><span id="32c7" class="lo ka hi lf b fi lp lq l lr ls">python3 main.py</span></pre><p id="41dd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">失败……<code class="du lc ld le lf b">Insufficient scopes</code>。默认认证有<strong class="is hj">问题。</strong></p><p id="47ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您在您的环境中使用命令<code class="du lc ld le lf b">gcloud auth application-default login</code>、<strong class="is hj">验证自己时，您使用默认的作用域</strong>，它不包括Google Sheet作用域。让我们来解决这个问题</p></div><div class="ab cl lv lw gp lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hb hc hd he hf"><p id="584d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要确定个人账户的范围，你只需<strong class="is hj">明确定义范围</strong>和<a class="ae jo" href="https://developers.google.com/identity/protocols/oauth2/scopes" rel="noopener ugc nofollow" target="_blank">添加你想要的内容</a>以及谷歌云平台的内容。</p><pre class="lg lh li lj fd lk lf ll lm aw ln bi"><span id="eda9" class="lo ka hi lf b fi lp lq l lr ls">gcloud auth application-default login \<br/>--scopes='https://www.googleapis.com/auth/spreadsheets.readonly',\<br/>https://www.googleapis.com/auth/cloud-platform'</span></pre><p id="0f31" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并再次尝试您的代码。<strong class="is hj">这次成功了！！</strong></p><blockquote class="jp"><p id="aae5" class="jq jr hi bd js jt ju jv jw jx jy jn dx translated">完美！！让我们在云构建中使用这个脚本！</p></blockquote><h1 id="9fb5" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">天真的第一次尝试</h1><p id="ea87" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">要在云构建中运行Python脚本，您必须编写一个描述操作的<code class="du lc ld le lf b">cloudbuild.yaml</code>文件。我们将使用Python图像的单个步骤。</p><pre class="lg lh li lj fd lk lf ll lm aw ln bi"><span id="f292" class="lo ka hi lf b fi lp lq l lr ls">steps:<br/>  - name: 'python:slim-buster'<br/>    script: |<br/>      pip3 install -r requirements.txt<br/>      python3 main.py</span></pre><p id="1c4f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并运行构建；</p><pre class="lg lh li lj fd lk lf ll lm aw ln bi"><span id="cf29" class="lo ka hi lf b fi lp lq l lr ls">gcloud builds submit</span></pre><p id="c4fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">哦不，</strong> <code class="du lc ld le lf b">Insufficient scopes</code>！！但是这一次，<strong class="is hj">你不能作用于当前账号</strong>，因为它是元数据服务器提供的<a class="ae jo" href="https://cloud.google.com/compute/docs/metadata/overview" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="cf38" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们将代码更新为<strong class="is hj">以编程方式强制该范围</strong> <br/> <em class="lt">只更新</em> <code class="du lc ld le lf b"><em class="lt">creds</em></code> <em class="lt">变量定义。</em></p><pre class="lg lh li lj fd lk lf ll lm aw ln bi"><span id="4dad" class="lo ka hi lf b fi lp lq l lr ls">SCOPES = ['https://www.googleapis.com/auth/spreadsheets.readonly']<br/>creds, _ = google.auth.default(scopes=SCOPES)</span></pre><p id="812f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">再试一次。<strong class="is hj">不是更好……</strong></p><blockquote class="jp"><p id="831b" class="jq jr hi bd js jt ju jv jw jx jy jn dx translated">无法确定默认服务帐户的范围。我们试试别的吧！</p></blockquote><h1 id="e858" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">客户服务帐户尝试</h1><p id="38df" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">对于一些服务，比如Compute Engine，你不能在运行时改变默认服务账户<strong class="is hj">的作用域</strong>。</p><ul class=""><li id="f5d0" class="mc md hi is b it iu ix iy jb me jf mf jj mg jn mh mi mj mk bi translated">你必须停止虚拟机，<a class="ae jo" href="https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">改变作用域</strong> </a> <strong class="is hj">并重启它</strong>。<em class="lt">太无聊了</em></li></ul><p id="c64a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者，这是最有趣也是我最雄心勃勃的选择</p><ul class=""><li id="f1f8" class="mc md hi is b it iu ix iy jb me jf mf jj mg jn mh mi mj mk bi translated">您可以<a class="ae jo" href="https://cloud.google.com/compute/docs/access/service-accounts#associating_a_service_account_to_an_instance" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">使用客户管理服务账户</strong> </a>。然后，您可以在运行时随意确定服务帐户的范围！</li></ul></div><div class="ab cl lv lw gp lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hb hc hd he hf"><p id="b8c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以，让我们<a class="ae jo" href="https://cloud.google.com/build/docs/securing-builds/configure-user-specified-service-accounts" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">使用一个带有云构建的客户管理服务账户</strong> </a>。您必须创建一个服务帐户，并授予它正确的权限。</p><pre class="lg lh li lj fd lk lf ll lm aw ln bi"><span id="e8dd" class="lo ka hi lf b fi lp lq l lr ls">#Create the service account<br/>gcloud iam service-accounts create custom-sa</span><span id="44e5" class="lo ka hi lf b fi lu lq l lr ls">#Grant the permission <br/>gcloud projects add-iam-policy-binding \<br/>--member="serviceAccount:custom-sa@<strong class="lf hj">PROJECT_ID</strong>.iam.gserviceaccount.com" \<br/>--role="roles/storage.objectViewer" <strong class="lf hj">PROJECT_ID</strong></span><span id="4392" class="lo ka hi lf b fi lu lq l lr ls">gcloud projects add-iam-policy-binding \<br/>--member="serviceAccount:custom-sa@<strong class="lf hj">PROJECT_ID</strong>.iam.gserviceaccount.com" \<br/>--role="roles/logging.logWriter" <strong class="lf hj">PROJECT_ID</strong></span></pre><p id="f6d9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lt">用自己的项目ID </em>替换 <code class="du lc ld le lf b"><em class="lt">PROJECT_ID</em></code> <em class="lt"/></p><p id="cd84" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并像这样更新您的<code class="du lc ld le lf b">cloudbuild.yaml</code>文件</p><pre class="lg lh li lj fd lk lf ll lm aw ln bi"><span id="7517" class="lo ka hi lf b fi lp lq l lr ls">steps:<br/>  - name: 'python:slim-buster'<br/>    script: |<br/>        pip3 install -r requirements.txt<br/>        python3 main.py<br/>serviceAccount: 'projects/<strong class="lf hj">PROJECT_ID</strong>/serviceAccounts/custom-sa@<strong class="lf hj">PROJECT_ID</strong>.iam.gserviceaccount.com'<br/>options:<br/>  logging: CLOUD_LOGGING_ONLY</span></pre><p id="fef8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，做最后一次尝试……再失败一次 <code class="du lc ld le lf b">Insufficient scopes</code>。<strong class="is hj"> <em class="lt">为什么？？</em> </strong></p><blockquote class="jp"><p id="83d0" class="jq jr hi bd js jt ju jv jw jx jy jn dx translated">在云构建中无法更改运行时服务帐户的范围。下一个选择是什么？</p></blockquote><h1 id="0cee" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">模拟解决方案</h1><p id="4b97" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">因此，<strong class="is hj">元数据服务器无法生成具有不同作用域</strong>的令牌。<em class="lt">这个问题与我们一开始遇到的用户帐户问题类似</em>。<em class="lt">无法在运行时更改令牌范围。<br/>解决方案是从头开始重新生成具有正确作用域的令牌。</em></p><p id="2d6d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，下一个选项是做同样的事情，在令牌创建时，<strong class="is hj">在服务帐户<strong class="is hj">上请求具有正确范围的新令牌</strong>。</strong></p><p id="92ee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，我们可以使用<strong class="is hj">一个名为</strong> <a class="ae jo" href="https://cloud.google.com/iam/docs/impersonating-service-accounts" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">的特性来模仿</strong> </a>。原理是<strong class="is hj">代表另一个账户生成一个令牌</strong>(访问令牌或身份令牌)<strong class="is hj">。</strong> <br/> <em class="lt">并且，顺便继承它的所有权限</em></p></div><div class="ab cl lv lw gp lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hb hc hd he hf"><p id="fed3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在代码中，你必须改变一些东西:</p><ul class=""><li id="aa8b" class="mc md hi is b it iu ix iy jb me jf mf jj mg jn mh mi mj mk bi translated">您必须<strong class="is hj">知道服务帐户电子邮件来模拟</strong> <em class="lt">(出于生产目的，使用环境变量来提供)</em></li><li id="f7d0" class="mc md hi is b it ml ix mm jb mn jf mo jj mp jn mh mi mj mk bi translated">您必须<strong class="is hj">创建模拟凭证</strong>并使用它</li></ul><pre class="lg lh li lj fd lk lf ll lm aw ln bi"><span id="5b77" class="lo ka hi lf b fi lp lq l lr ls"><strong class="lf hj">import google.auth.impersonated_credentials</strong><br/><br/>from googleapiclient.discovery import build<br/>from googleapiclient.errors import HttpError<br/><br/># The ID and range of a sample spreadsheet.<br/>SAMPLE_SPREADSHEET_ID = 'YOUR_SHEET_ID'<br/>SAMPLE_RANGE_NAME = 'DATA!A2:E'<br/><br/><br/>def main():<br/>    <em class="lt">"""Shows basic usage of the Sheets API.<br/>    Prints values from a sample spreadsheet.<br/>    """</em></span><span id="8d99" class="lo ka hi lf b fi lu lq l lr ls">    SCOPES = ['https://www.googleapis.com/auth/spreadsheets.readonly']<strong class="lf hj"><em class="lt"><br/>    </em>creds, _ = google.auth.default(scopes="https://www.googleapis.com/auth/cloud-platform")<br/>    icreds = google.auth.impersonated_credentials.Credentials(<br/>        source_credentials=creds,<br/>        target_principal=custom-sa@PROJECT_ID.iam.gserviceaccount.com,<br/>        target_scopes=SCOPES,<br/>    )<br/><br/><br/></strong>    try:<br/>        service = build('sheets', 'v4', credentials=<strong class="lf hj">icreds</strong>)<br/><br/>        # Call the Sheets API<br/>        sheet = service.spreadsheets()<br/>        result = sheet.values().get(spreadsheetId=SAMPLE_SPREADSHEET_ID,<br/>                                    range=SAMPLE_RANGE_NAME).execute()<br/>        values = result.get('values', [])<br/><br/>        if not values:<br/>            print('No data found.')<br/>            return<br/><br/>        print('Name, Major:')<br/>        for row in values:<br/>            # Print columns A and E, which correspond to indices 0 and 4.<br/>            print('%s, %s' % (row[0], row[4]))<br/>    except HttpError as err:<br/>        print(err)<br/><br/><br/>if __name__ == '__main__':<br/>    main()</span></pre><p id="3d17" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了允许云构建运行时服务帐户模拟目标服务帐户，必须允许<strong class="is hj">运行时服务帐户在目标服务帐户</strong>上创建令牌。</p><p id="cdd7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，您必须像这样在运行时服务帐户上授予角色<code class="du lc ld le lf b">Service Account Token Creator</code></p><pre class="lg lh li lj fd lk lf ll lm aw ln bi"><span id="92be" class="lo ka hi lf b fi lp lq l lr ls">gcloud projects add-iam-policy-binding \<br/>--member="serviceAccount:custom-sa@<strong class="lf hj">PROJECT_ID</strong>.iam.gserviceaccount.com" \<br/>--role="roles/iam.serviceAccountTokenCreator" <strong class="lf hj">PROJECT_ID</strong></span></pre><p id="b025" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">而且试一试… <strong class="is hj">又失败了！！</strong></p><p id="5e94" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是好消息是<strong class="is hj">这不是同一个错误！</strong>这是来自Google Sheet的错误，因为目标服务帐户没有访问它的权限！</p></div><div class="ab cl lv lw gp lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hb hc hd he hf"><p id="5d96" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">精彩</strong>！！转到您的工作表文档，单击“共享”按钮，并将目标服务帐户电子邮件添加为工作表文档的查看者。</p><p id="c3dc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">再试一次，这次<strong class="is hj">成功了！！</strong></p><p id="33b2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="lt">注:</em> </strong> <em class="lt">不再需要客户管理服务账户。您可以切换回云构建默认服务帐户；不要忘记授予它正确的角色，让它模拟服务帐户。</em></p><p id="d164" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="lt">注意2: </em> </strong> <em class="lt">不能冒充云构建默认服务账号本身。您只能模拟客户管理的服务帐户(您创建并附加到您的项目的服务帐户)</em></p><h1 id="9aa6" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk mq km kn ko mr kq kr ks ms ku kv kw bi translated">不一致的安全解决方案</h1><p id="e32a" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">安全性是最重要的，谷歌云提供了非常强大和通用的安全选项。</p><p id="3c56" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，<strong class="is hj">这些选项从一个服务到另一个服务是不一致的</strong>，并且需要专业知识、失败和以优雅的方式成功。<br/> <strong class="is hj">因为那些困难</strong>，很多用户不花时间，快速去找最快最丑的解决方案:他们用一个<strong class="is hj">服务账号密钥文件</strong>(这是安全的反模式)！</p><p id="9b7c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我希望这篇文章能帮助你成功而优雅地管理你的安全问题，并在任何情况下保持安全。</p></div></div>    
</body>
</html>