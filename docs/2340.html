<html>
<head>
<title>BigQuery Slot Squeezes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">大查询插槽挤压</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bigquery-slot-squeezes-896d9e0f2fc?source=collection_archive---------1-----------------------#2022-09-02">https://medium.com/google-cloud/bigquery-slot-squeezes-896d9e0f2fc?source=collection_archive---------1-----------------------#2022-09-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f36c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Bigquery (BQ)是一个无服务器的大型分析数据库服务。这项服务允许您查询任何东西，从非常小的数据集到Pb大小的数据集。在后台，BigQuery将自动分配计算、内存和shuffle容量来服务您的查询请求。其核心是一个<strong class="ih hj">插槽</strong>的概念。时段是一个混合指标，它将这些不同的资源组合成一个统一的消耗值。</p><p id="d137" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您运行查询并查看查询执行细节时，您会看到一个名为<code class="du jd je jf jg b">slotMs</code>的指标。这是指示您的查询消耗了多少资源的指标。</p><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="er es jh"><img src="../Images/b516610221278c0637bcbbc218318de7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mEiQwyFKSnuV5bRxLPpd6Q.png"/></div></div><figcaption class="jt ju et er es jv jw bd b be z dx translated">BigQuery查询计划的统计信息部分</figcaption></figure><p id="c43f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Bigquery有两种定价模式，<strong class="ih hj">按需</strong>和<strong class="ih hj">统一费率</strong>。<strong class="ih hj">按需</strong>意味着您的项目有有限的插槽数量，并且您为处理的字节付费。<strong class="ih hj">统一费率</strong>意味着您购买并支付每月的插槽分配，但不支付处理的字节数。通常，前者适用于少量的偶然使用，而后者适用于具有持续、大量需求的企业环境。</p><p id="f08b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">企业环境中的一个问题是您应该购买多少个插槽。买太多，你会有很长一段时间不用它们。购买太少，用户将在高峰时间经历延迟。</p><p id="1c7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，您有兴趣确定您在一天/一周/一个月中使用了多少时段，以获得您的需求概况，然后确定固定费率时段的基本购买量以及动态弹性时段购买量，以覆盖高峰期。</p><p id="b2b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最简单的方法是查询您的系统表，使用<code class="du jd je jf jg b">Informationschema. jobs_timeline</code>表提取作业时间线的所有slot MS值并求和。</p><figure class="ji jj jk jl fd jm"><div class="bz dy l di"><div class="jx jy l"/></div></figure><p id="8241" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并绘制一天(一周/一个月)的摘要:</p><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="er es jz"><img src="../Images/d5530c549ec247822e3b833fe3a3ea09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_sui9R06T3M9cNM-"/></div></div></figure><p id="69c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将向您显示实际的插槽消耗量，您将能够看到您何时消耗了您购买的插槽的容量。</p><p id="2c05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是这些信息是有限的。您知道在一天中的什么时候您最大限度地利用了您购买的插槽容量，但是您不知道这对您的用户有多严重的影响。</p><blockquote class="ka kb kc"><p id="349d" class="if ig kd ih b ii ij ik il im in io ip ke ir is it kf iv iw ix kg iz ja jb jc hb bi translated"><strong class="ih hj">BQ时隙分配如何影响性能</strong></p><p id="5e02" class="if ig kd ih b ii ij ik il im in io ip ke ir is it kf iv iw ix kg iz ja jb jc hb bi translated">查询并不总是需要槽，它可能在查询执行过程中时好时坏。Bigquery试图根据查询的需求以公平的方式为查询分配槽。当一个查询的槽需求下降时，槽会根据需求在所有其他查询之间重新分配。这是一个非常动态的过程，时隙分配可以在几秒钟内改变。</p></blockquote><p id="26c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当查询需要的槽多于可用的槽时，工作就会堆积起来，等待资源变得可用——简而言之，查询会花费更长的时间。</p><p id="b02c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过查看您的查询执行计划来了解这一点(例如，使用<a class="ae kh" href="https://bqvisualiser.appspot.com" rel="noopener ugc nofollow" target="_blank">https://bqvisualiser.appspot.com</a>)。每个阶段都有许多关于绩效的指标。这里感兴趣的是称为<strong class="ih hj"> avg_wait_ms </strong>的指标，它是一个阶段的工作负载花费在等待上的平均时间，以毫秒为单位。</p><blockquote class="ka kb kc"><p id="31e5" class="if ig kd ih b ii ij ik il im in io ip ke ir is it kf iv iw ix kg iz ja jb jc hb bi translated"><strong class="ih hj">另一个有趣的指标:avg _ compute _ ms vs max _ compute _ ms</strong></p><p id="cbf2" class="if ig kd ih b ii ij ik il im in io ip ke ir is it kf iv iw ix kg iz ja jb jc hb bi translated">avg_compute_ms在所有工作负载中查找一个阶段以确定完成时间，而max_compute_ms则查看最大值。通常最大值不应与平均值相差太大。但是在某些情况下，这些会有很大的不同。</p><p id="cc4d" class="if ig kd ih b ii ij ik il im in io ip ke ir is it kf iv iw ix kg iz ja jb jc hb bi translated">当要处理的数据碎片大小不同时，通常会出现这种情况。如果您对数据进行分组和聚合，不均衡的分组键分布会导致这种情况。如果您遇到这种情况，请查看您的数据并考虑构建您的查询以避免这种情况。</p></blockquote><p id="0063" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述指标告诉我们，当我们用完插槽时。有了这些知识，我们现在可以构建一个度量标准，告诉我们由此产生的槽挤压有多严重:</p><figure class="ji jj jk jl fd jm"><div class="bz dy l di"><div class="jx jy l"/></div></figure><p id="d8f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里我们计算几个阶段等待时间的指标。作为一个通用指标，指标<code class="du jd je jf jg b">wait_avg</code>很好地突出了槽挤压的影响。</p><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="er es ki"><img src="../Images/56b659756e43e180b8deb49c5e10710b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ltgIOJC3BFp-C2cu"/></div></div></figure><p id="8e17" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该图现在清楚地显示了从8月29日上午6点到下午2点的一段时间，在这段时间里，主要阶段必须等待10分钟以上——这意味着主要查询至少比平时多花了btw10分钟。</p><p id="7370" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从业务角度来看，用户能承受在此期间等待查询完成的代价吗？如果没有，那么在此期间购买弹性时段可能会减少等待时间。</p></div></div>    
</body>
</html>