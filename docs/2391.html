<html>
<head>
<title>CloudSQL: Cross Region HA just got easier… and whole lot faster!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CloudSQL:跨区域HA变得更加容易……而且速度更快了！</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloudsql-cross-region-ha-just-got-easier-and-whole-lot-faster-4f94c7dcc71d?source=collection_archive---------0-----------------------#2022-09-29">https://medium.com/google-cloud/cloudsql-cross-region-ha-just-got-easier-and-whole-lot-faster-4f94c7dcc71d?source=collection_archive---------0-----------------------#2022-09-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="bdf8" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">TL；博士</strong></h1><p id="1b04" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jf hj">本文作为我2020年4月</strong> <a class="ae kb" rel="noopener" href="/google-cloud/cloud-sql-recovering-from-regional-failure-in-10-minutes-or-less-mysql-fc055540a8f0"> <strong class="jf hj">帖子</strong> </a> <strong class="jf hj">的更新。它描述了如何整合两种新的云SQL功能，HA副本和级联复制，以更好地构建跨区域高可用性。我还提供了一个</strong> <a class="ae kb" href="https://github.com/wapfel20/cloudsql_cross-region_failover_2022" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj">更新的自动化脚本</strong> </a> <strong class="jf hj">，以便于在事件期间的故障转移过程。我的测试表明，这些更新将使您能够比我以前的方法更快地从5X的区域性事件中恢复，换句话说，在2分钟或更短的时间内！试试看！</strong></p><h1 id="52cc" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">简介</strong></h1><p id="3913" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在2020年4月，我写了一篇<a class="ae kb" rel="noopener" href="/google-cloud/cloud-sql-recovering-from-regional-failure-in-10-minutes-or-less-mysql-fc055540a8f0">文章</a>解释如何为跨区域高可用性设计云SQL实例，以及如何以自动化和可控的方式编排跨区域故障转移。我最初的主张是，有了正确的云SQL架构和自动化，您可以在启动切换程序的10分钟内，从不同GCP地区的区域性中断中完全恢复。</p><p id="588a" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">然而，谷歌最近悄悄地推出了两个强大的云SQL新特性，这使得我文章中的说法无效...这些新功能进一步简化了跨区域故障转移过程，我的测试表明，它们已经将故障转移时间从10分钟减少到<strong class="jf hj">仅仅</strong> <strong class="jf hj"> 2分钟或更少！</strong></p><p id="d64b" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="kh">注意:与我之前的蓝图相比，本文主要关注新特性和更新的跨区域架构。请阅读我以前的文章，以了解云SQL的原生高可用性的限制以及为什么跨区域HA很重要，并获得评估何时实际启动跨区域故障转移的框架。</em></p><h1 id="0f1b" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">快速重温云SQL的原生高可用性</h1><p id="6049" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在我的上一篇文章中，我提供了Cloud SQL的高可用性特性和架构的详细概述。概括一下:</p><ul class=""><li id="6562" class="ki kj hi jf b jg kc jk kd jo kk js kl jw km ka kn ko kp kq bi translated"><strong class="jf hj">是的— </strong>云SQL确实具有原生的高可用性特性。云SQL提供了在创建时部署高可用性实例的选项。Google将管理该实例的复制和故障转移，无需您进行任何交互，也不会影响您的应用程序。相当甜蜜！你可以在谷歌的文档<a class="ae kb" href="https://cloud.google.com/sql/docs/mysql/high-availability#failover-overview" rel="noopener ugc nofollow" target="_blank">中看到这种故障转移是如何工作的。</a></li><li id="ce35" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka kn ko kp kq bi translated"><strong class="jf hj">但是— </strong>高可用性架构是区域性的，而不是区域性的。这意味着，如果整个区域受到中断的影响，那么数据库的两个实例都会随之中断。</li></ul><p id="7510" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">因此，对于任务关键型云SQL工作负载，我建议您设计跨GCP地区的故障能力。区域性停机并不经常发生，但一旦发生，您将在几分钟内恢复运行，而您的竞争对手却无所事事。</p><h1 id="9237" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">黑仔的新功能改进了跨区域故障切换</h1><p id="f305" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">2022年夏天，Cloud SQL悄悄推出了2个非常重要的特性，用于提高MySQL和PostgresSQL工作负载的高可用性:<strong class="jf hj"> HA副本&amp;级联复制</strong>。</p><p id="d0c1" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">黑仔功能#1 —高可用性副本</strong></p><p id="c0df" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">此功能允许您将云SQL读取副本配置为高可用性实例。与主h a实例一样，Google将管理实例的分区复制和故障转移，而无需更改其IP。</p><ul class=""><li id="c945" class="ki kj hi jf b jg kc jk kd jo kk js kl jw km ka kn ko kp kq bi translated"><strong class="jf hj">为什么如此重要:</strong>在灾难恢复故障转移到另一个区域后，新的主实例(即提升的副本)需要启用高可用性，以匹配原始集群拓扑。<strong class="jf hj">在我最初的文章中，这个过程占用了10分钟故障转移时间中的5-6分钟！</strong>通过在故障切换之前为故障切换副本配置高可用性，您可以从故障切换过程中消除这一过程和停机时间。</li><li id="85eb" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka kn ko kp kq bi translated"><strong class="jf hj">如何使用该功能:</strong>您可以在创建期间或之后，在云控制台中对读取副本启用此设置，方式与您对主实例的方式相同。</li></ul><figure class="kx ky kz la fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es kw"><img src="../Images/fb335e6a49dfa05b65b54060d0b0f5af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bUp2KDeJrSOz3WZmsgRINw.png"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx translated">传统副本与高可用性副本的比较</figcaption></figure><p id="fbf3" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">黑仔功能2 —级联复制</strong></p><p id="96e6" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">此功能允许您向任何现有复制副本添加读取复制副本，实质上是让一个读取复制副本充当另一个读取复制副本的复制源。换句话说，它允许副本以菊花链形式连接在一起，以用于复制目的。</p><ul class=""><li id="c5b5" class="ki kj hi jf b jg kc jk kd jo kk js kl jw km ka kn ko kp kq bi translated"><strong class="jf hj">为什么如此重要:</strong>在此功能之前，所有读取复制副本都依赖于主实例进行复制。因此，在执行区域故障切换(孤立原始主实例)后，需要重新创建跨区域复制副本之外的任何其他读取复制副本，并且访问这些复制副本的任何应用程序都需要使用新的连接字符串进行更新。现在，您可以将下游复制副本配置为“级联”跨区域读取复制副本，以便在跨区域故障切换后复制保持不变。</li><li id="7c58" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka kn ko kp kq bi translated"><strong class="jf hj">如何使用该功能:</strong>您可以创建级联副本，方法是在云控制台中导航到您的跨区域灾难恢复读取副本，在左侧菜单中选择“读取副本”，然后选择“创建读取副本”</li></ul><figure class="kx ky kz la fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lm"><img src="../Images/e0a5ae8085ce6d20bacdd6a5d45b5024.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*knDr4-9NdNb2_lxjY62vpg.png"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx translated">使用传统副本与级联副本比较跨区域故障切换对下游副本的影响</figcaption></figure><h1 id="0720" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">将这些新功能整合到现有架构中</h1><p id="59ca" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">当我写第一篇文章时，我使用了一个通用的云SQL架构，包含以下组件:</p><ul class=""><li id="bb43" class="ki kj hi jf b jg kc jk kd jo kk js kl jw km ka kn ko kp kq bi translated">用于读/写的支持高可用性的云SQL主实例</li><li id="d5b0" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka kn ko kp kq bi translated">下游只读应用程序的独立区域中的读取副本<em class="kh">(注意:此副本可以在所示的灾难恢复区域中，也可以在独立区域中，但由于级联复制的限制，它不能驻留在原始主区域中。)</em></li><li id="c1f5" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka kn ko kp kq bi translated">用于灾难恢复的跨区域读取副本</li></ul><p id="a28d" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">方便的是，新的云SQL特性可以在不对架构进行任何重大更改的情况下集成。下面我们一起来看看这两种架构——注意细微的差别。</p><div class="kx ky kz la fd ab cb"><figure class="ln lb lo lp lq lr ls paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><img src="../Images/775621021118ca1abf75702de43bdb37.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/1*c7cZ-z9y0av9OsH0Ghsvtg.png"/></div></figure><figure class="ln lb lt lp lq lr ls paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><img src="../Images/5f018f588c726bac9f138eb1fa7f0c0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1054/format:webp/1*Ke2ypb7PlVAwMTLghcuEdA.png"/></div><figcaption class="li lj et er es lk ll bd b be z dx lu di lv lw translated">面向云SQL的传统跨区域灾难恢复体系结构(左)与采用高可用性和级联副本的新灾难恢复体系结构(右)</figcaption></figure></div><p id="656e" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">为了实现右侧的更新架构，我简单地做了以下工作:</p><ol class=""><li id="d499" class="ki kj hi jf b jg kc jk kd jo kk js kl jw km ka lx ko kp kq bi translated">我将现有的灾难恢复读取副本更新为高可用性实例(使用HA读取副本功能)。</li><li id="7832" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka lx ko kp kq bi translated">我将只读应用程序的读取复制副本重新创建为灾难恢复读取复制副本的级联复制副本，请注意与旧体系结构相比，新体系结构中复制流程的变化。</li></ol><h1 id="993d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">新功能正在发挥作用</h1><p id="8e91" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">您可能想知道这个过程实际上是什么样子，以及这些新功能如何加快恢复速度—让我们通过一个区域性故障切换场景来揭示答案！</p><p id="14ee" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">作为基线，让我们先熟悉一下在高可用性和级联副本之前跨区域故障切换过程是如何工作的:</p><div class="kx ky kz la fd ab cb"><figure class="ln lb ly lp lq lr ls paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><img src="../Images/8681f87663ed8757674225a42cfaca64.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/format:webp/1*Lx36vf2Fk05z_aGnKJl4rA.png"/></div></figure><figure class="ln lb lz lp lq lr ls paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><img src="../Images/c3ca4e170c527ae351304c28c5a6a19b.png" data-original-src="https://miro.medium.com/v2/resize:fit:708/format:webp/1*6ulHiPU4MB3r_HeRLFe5Lw.png"/></div></figure><figure class="ln lb ma lp lq lr ls paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><img src="../Images/2196cd865883af3efcb5f1a7103b30b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:590/format:webp/1*mTYBYii5iMXexLp6kyuIvg.png"/></div></figure></div><ol class=""><li id="0ffd" class="ki kj hi jf b jg kc jk kd jo kk js kl jw km ka lx ko kp kq bi translated">区域1受到云SQL中断的影响，该中断使主实例离线。</li><li id="1708" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka lx ko kp kq bi translated">在故障切换期间，灾难恢复复制副本被提升为主副本，这将中断从原始主实例的复制—<strong class="jf hj">(1–2分钟)。</strong></li><li id="1e26" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka lx ko kp kq bi translated">然后，灾难恢复实例配置为高可用性，这需要重新启动—<strong class="jf hj">(5–6分钟)</strong>。</li><li id="c02e" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka lx ko kp kq bi translated">完成后，读/写应用程序会更新以连接到灾难恢复实例，从而完成我们的转换。</li><li id="5adc" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka lx ko kp kq bi translated">由于原始主实例不再是新写入的源，因此必须为我们的只读应用程序创建一个连接到灾难恢复实例的新读取复制副本—<strong class="jf hj">(3–5分钟)。</strong>完成后，只读应用程序将被更新以查询新副本。</li></ol><p id="6337" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">总恢复时间:9–13分钟</strong></p><p id="787f" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">现在我们有了一个基准，让我们看看如何将高可用性和级联副本整合到我们的体系结构中，从而大大简化我们的切换并缩短我们的恢复时间。下面是与上面相同的场景，但是使用了我们更新的架构:</p><div class="kx ky kz la fd ab cb"><figure class="ln lb mb lp lq lr ls paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><img src="../Images/434e9a535c0f8fd68b7e27b481807856.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*A7b2GcxzDaUIX8X0Dr4PXA.png"/></div></figure><figure class="ln lb mc lp lq lr ls paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><img src="../Images/c16daaad8950b9851abb78bbd579052c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/format:webp/1*jOW3T2jO-qNyGucwNsxxCA.png"/></div></figure></div><ol class=""><li id="3f21" class="ki kj hi jf b jg kc jk kd jo kk js kl jw km ka lx ko kp kq bi translated">区域1受到云SQL中断的影响，该中断使主实例离线。</li><li id="1560" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka lx ko kp kq bi translated">在故障切换期间，灾难恢复复制副本被提升为主副本，这将中断从原始主实例的复制—<strong class="jf hj">(1–2分钟)</strong>。</li><li id="a565" class="ki kj hi jf b jg kr jk ks jo kt js ku jw kv ka lx ko kp kq bi translated">由于灾难恢复实例已经通过HA复制副本功能进行了高可用性配置，因此不再需要升级和重新启动它。因此，读/写应用程序可以在升级后立即连接到灾难恢复实例。</li></ol><p id="8fee" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">最后，由于我们的只读应用程序的读取复制副本已经配置为灾难恢复实例的级联复制副本，它已经将该实例用作复制源。因此，复制流程不会因灾难恢复实例升级为主实例而中断，它将在故障切换后继续将未来的写入复制到新的主实例，而无需干预。</p><p id="b977" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">总恢复时间:1–2分钟</strong></p><h1 id="ea7f" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">不要忘记自动化！</h1><p id="b1a9" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">除了整合新的云SQL特性之外，您还必须具备一定的自动化能力，以便有效地促进转换过程，从而实现2分钟或更短时间的恢复基准。停机是压力很大的情况。自动化不仅有助于加快故障转移过程，还有助于防止代价高昂的错误和失误。</p><p id="1d10" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">至少，这种自动化应该处理DR实例的升级，提供其连接详细信息，并在主区域中重新创建一个副本，以备您想要移回时使用。然而，您的自动化还可以结合RTO和RPO策略来自动触发故障切换，然后利用您的应用程序管道来自动更新连接字符串——这将是非常美妙的！</p><blockquote class="md me mf"><p id="a07d" class="jd je kh jf b jg kc ji jj jk kd jm jn mg ke jq jr mh kf ju jv mi kg jy jz ka hb bi translated">幸运的是，我已经<a class="ae kb" href="https://github.com/wapfel20/cloudsql_cross-region_failover_2022" rel="noopener ugc nofollow" target="_blank">编写了一个自动化脚本</a>，您可以以此为起点！我还包含了第二个脚本，帮助您在准备好之后回切到主区域。我强烈建议您经常测试这些脚本，并在测试环境中运行实践场景，以改进您的执行和恢复时间。</p></blockquote><h1 id="4dff" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">结论</h1><p id="b3a6" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">Cloud SQL最近为MySQL和Postgres推出了两个令人兴奋的新功能，使跨区域故障转移变得更快、更容易！通过将这些功能(高可用性副本和级联副本)整合到您的云SQL架构中，并增加一点自动化，您现在可以将区域灾难中的故障切换时间减少到2分钟或更少。</p><p id="7366" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">我强烈建议您针对高优先级云SQL工作负载重新审视您的架构和故障转移计划，以纳入这两项新功能和我的<a class="ae kb" href="https://github.com/wapfel20/cloudsql_cross-region_failover_2022" rel="noopener ugc nofollow" target="_blank">更新自动化脚本</a>，这样您就可以确保在客户需要您的时候，而您的竞争对手却无所作为。</p></div></div>    
</body>
</html>