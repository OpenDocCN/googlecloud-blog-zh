<html>
<head>
<title>Bypass the Cloud Run 32mb Limit with Cloud Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用云存储绕过云运行32mb的限制</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bypass-the-cloud-run-32mb-limit-with-cloud-storage-65c24156189?source=collection_archive---------1-----------------------#2021-11-01">https://medium.com/google-cloud/bypass-the-cloud-run-32mb-limit-with-cloud-storage-65c24156189?source=collection_archive---------1-----------------------#2021-11-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/588a8d2b394a8139972233361740db11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*4jzgKfXtWbClb6XyNjROkg.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated">云存储+云运行</figcaption></figure><p id="2178" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云运行对HTTP/1请求和响应施加了32mb的<a class="ae jo" href="https://cloud.google.com/run/quotas#cloud_run_limits" rel="noopener ugc nofollow" target="_blank">限制</a>。然而，谷歌云存储允许高达<a class="ae jo" href="https://cloud.google.com/storage/quotas" rel="noopener ugc nofollow" target="_blank"> 5 TiB </a>的对象。您可能想知道，在使用Cloud Run时，我如何处理大于32mb的对象？使用云存储和云运行需要一些技术来绕过这个限制。这篇博客文章详细介绍了我们对于执行大于32mb限制的上传和下载的建议。</p><p id="2fe1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下所有建议都利用了已签名的请求。签名请求是经过身份验证的端点(URL ),您可以直接向云存储发出请求。它们消除了云运行应用程序代理对云存储对象的请求的需要。如果您的应用程序是媒体密集型的(例如，如果它包含大型视频)，这可能会减少应用程序的负载。您需要为每个想要上传或下载的文件生成一个新的URL。这些端点将在一段时间后过期，这段时间可以在创建URL时指定。有关更多信息，请参见<a class="ae jo" href="https://cloud.google.com/storage/docs/authentication/signatures" rel="noopener ugc nofollow" target="_blank">关于已签名请求的云存储文档</a>。</p><h1 id="0861" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">上传</h1><p id="4de7" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">绕过上传的云运行限制的推荐选项是签名的策略URL。</p><h2 id="cb61" class="ks jq hi bd jr kt ku kv jv kw kx ky jz jb kz la kd jf lb lc kh jj ld le kl lf bi translated">使用签名的策略URL进行上传</h2><p id="956f" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">使用签名的策略URL允许您的网站提供一个表单，该表单可用于上传大于32mb限制的文件(通过<code class="du lg lh li lj b">POST</code>请求)。</p><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div><figcaption class="im in et er es io ip bd b be z dx translated">通过上传请求生成用于上传的已签名策略URL</figcaption></figure><p id="e9cb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">参见<a class="ae jo" href="https://cloud.google.com/storage/docs/xml-api/post-object-forms#node.js" rel="noopener ugc nofollow" target="_blank">用HTTP表单上传一个对象</a>以找到更多信息和其他语言的例子。</p><h1 id="7057" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">下载</h1><p id="0484" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">有两个绕过云运行限制的推荐下载选项:签名URL和流。</p><h2 id="9547" class="ks jq hi bd jr kt ku kv jv kw kx ky jz jb kz la kd jf lb lc kh jj ld le kl lf bi translated">使用签名的URL进行下载</h2><p id="2729" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">如果您的Cloud Run应用程序为最终用户提供了一个网站，您可以使用签名的URL直接从云存储中下载大文件。要执行带有签名URL的<code class="du lg lh li lj b">GET</code>请求，其动作必须设置为<code class="du lg lh li lj b">read</code>。(注意这不同于上传，上传需要<code class="du lg lh li lj b">write</code>。)对于<a class="ae jo" href="https://cloud.google.com/storage/docs/access-control/signing-urls-with-helpers" rel="noopener ugc nofollow" target="_blank">示例</a>:</p><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div><figcaption class="im in et er es io ip bd b be z dx translated">生成一个Google云存储签名的URL，通过GET请求下载数据</figcaption></figure><p id="bc67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在您有了一个<code class="du lg lh li lj b">read</code>签名的URL，您可以使用它直接向云存储发出请求，完全绕过Cloud Run。下面是一个在E <a class="ae jo" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> xpress.js web应用程序</a>中使用这个URL的例子。</p><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div><figcaption class="im in et er es io ip bd b be z dx translated">使用云存储签名的URL进行下载</figcaption></figure><p id="60f9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意，通过修改文件上的<a class="ae jo" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Disposition" rel="noopener ugc nofollow" target="_blank"> Content-Disposition </a>，您将能够改变<code class="du lg lh li lj b">GET</code>请求的行为。在没有设置<code class="du lg lh li lj b">Content-Disposition</code>的情况下访问生成的URL将会导致带有回放控件的网页上的视频渲染。如果您想要下载视频，您可以将云存储对象元数据字段<code class="du lg lh li lj b">Content-Disposition</code>设置为<code class="du lg lh li lj b">attachment; filename=”video.mp4"</code>。这将导致文件被下载为“video.mp4”。</p><p id="1654" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有关<code class="du lg lh li lj b">Content-Disposition</code>字段以及如何在Google云存储上的文件中修改该字段的更多信息，请参考<a class="ae jo" href="https://cloud.google.com/storage/docs/metadata#content-disposition" rel="noopener ugc nofollow" target="_blank">云存储文档</a>。</p><h2 id="fb8e" class="ks jq hi bd jr kt ku kv jv kw kx ky jz jb kz la kd jf lb lc kh jj ld le kl lf bi translated">使用流进行下载</h2><p id="d1f8" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">如果您的云运行应用程序正在处理存储在云存储中的数据，我们建议通过流下载该数据。流是主要编程语言用来发送和接收分块数据的编程结构。流允许你把一个文件分成小于32mb的部分。下面的例子创建了一个流，它从Google云存储中读取文件的内容，并通过管道将其传输到<code class="du lg lh li lj b">res</code>以显示在您的网页上。</p><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div><figcaption class="im in et er es io ip bd b be z dx translated">使用云存储创建读取流进行下载</figcaption></figure><p id="2eea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在<a class="ae jo" href="https://gist.github.com/shaffeeullah/088aa29c3ee9876a6fec7b3fbbf1862f" rel="noopener ugc nofollow" target="_blank">本要点</a>中查看这些下载示例的完整代码。</p><h1 id="0e00" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">了解更多信息</h1><p id="febc" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">既然您已经阅读了这篇博文，那么您可以通过Cloud Run充分利用云存储的强大功能来绕过上传和下载大小的限制。🎉</p><p id="97e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有关使用Google云存储上传和下载数据的更多信息，请参见关于<a class="ae jo" href="https://cloud.google.com/storage/docs/uploads-downloads" rel="noopener ugc nofollow" target="_blank">上传和下载</a>的云存储文档。有关后续步骤(如将您的应用部署到云运行)，请参见<a class="ae jo" href="https://cloud.google.com/build/docs/deploying-builds/deploy-cloud-run" rel="noopener ugc nofollow" target="_blank">云运行文档</a>。</p></div><div class="ab cl lq lr gp ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="hb hc hd he hf"><p id="6d6d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">[1]对HTTP/2请求没有强加的大小限制</p></div></div>    
</body>
</html>