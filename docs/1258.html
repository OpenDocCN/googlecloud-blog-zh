<html>
<head>
<title>Getting Started with SQL Server on GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GCP上开始使用SQL Server</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/getting-started-with-sql-server-on-gcp-692e4ac44cad?source=collection_archive---------0-----------------------#2020-01-18">https://medium.com/google-cloud/getting-started-with-sql-server-on-gcp-692e4ac44cad?source=collection_archive---------0-----------------------#2020-01-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/042bc824f665f73b3d5f675e68ca288a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WmeRoa73RIBFeMM2.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">很少的设置，你就有了运行在谷歌云平台上的SQL Server</figcaption></figure><p id="5e74" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">当谈到Google云平台上的云SQL实例时，它通常与灵活方便的MySQL处理相关。最终，可能不太常见的是，有人可能会谈到PostgreSQL。然而，最近谷歌为云SQL服务增加了第三个选项:微软SQL Server。</p><p id="5f8f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae js" href="https://cloud.google.com/sql/" rel="noopener ugc nofollow" target="_blank"> Cloud SQL </a>是一个完全托管的关系数据库服务，适用于谷歌云平台(GCP)上的MySQL、PostgreSQL和SQL Server。</p><blockquote class="jt ju jv"><p id="2d85" class="iu iv jw iw b ix iy iz ja jb jc jd je jx jg jh ji jy jk jl jm jz jo jp jq jr hb bi translated"><em class="hi">云SQL与使用MySQL、PostgreSQL和SQL Server的应用程序完全兼容。您可以连接世界上任何地方的几乎任何应用程序。云SQL自动执行备份、复制和故障转移，以确保您的数据库可靠、高度可用，并灵活满足您的性能需求。</em></p></blockquote><p id="239a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">所描述的SQL Server on GCP的特性集列出了安全、高可用性、高性能和可伸缩解决方案所需的一切。可以从其他GCP服务轻松访问云SQL实例，包括App Engine、Compute Engine、Kubernetes Engine以及您的工作站。BigQuery能够直接查询现有的云SQL数据库。</p><p id="4583" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Google Cloud博客上有一篇有趣的文章:<a class="ae js" href="https://cloud.google.com/blog/products/databases/leave-no-database-behind-with-cloud-sql-for-sql-server" rel="noopener ugc nofollow" target="_blank">SQL Server的Cloud SQL不让任何数据库掉队</a>提供了关于新服务和即将推出的功能的更多信息。</p><h1 id="ecef" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">创建SQL Server的云SQL实例</h1><p id="56ae" class="pw-post-body-paragraph iu iv hi iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">登录云控制台，选择侧面导航栏中的菜单项<code class="du ld le lf lg b">SQL</code>。如果您选择的项目没有任何实例，您可以点击<code class="du ld le lf lg b">Create Instance</code>继续。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lh"><img src="../Images/885c100c5424f46404164e7efcb41dad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nEd9FwKuYi4xMPe-ejU9DA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Microsoft SQL Server作为云SQL实例提供</figcaption></figure><p id="ef90" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">接下来，选择右侧的<code class="du ld le lf lg b">SQL Server</code>选项，开始配置SQL Server。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/fd19c7a9fd00ef6552bfb5aaa1390d72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4CMOw3P3801P0coO9rN7Aw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">虽然标记为<code class="du ld le lf lg b">beta</code>,但它已经可以使用了(在撰写本文时)</figcaption></figure><p id="a9e5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">只需输入几个参数，你就可以开始了，阅读:点击页面底部的创建按钮。首先，回顾每一个配置设置，以便更熟悉云SQL，这可能是很有趣的。</p><p id="3449" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">给实例一个唯一的标识符，为您的管理用户设置或生成一个密码。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/28251cf0aefee41cef6404a90e3914d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2aa6E3F2F-lfzJnbfUdnqg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">配置基于SQL Server的云SQL实例的广泛选项</figcaption></figure><p id="dbd2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">注意:</strong>您的默认服务管理员用户名是<code class="du ld le lf lg b">sqlserver</code>。而不是常见的<code class="du ld le lf lg b">sa</code>用户名。生成的密码应该是这样的:<code class="du ld le lf lg b">d3Ptgz30EAiygtMn</code></p><p id="9e85" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后从SQL Server 2017的可用版本中进行选择。如果您熟悉SQL Server及其许可，您会知道各种版本有不同的功能、限制和成本因素。SQL Server的成本计算在这里描述得很简洁:<a class="ae js" href="https://cloud.google.com/sql/pricing#sql-server" rel="noopener ugc nofollow" target="_blank">云SQL定价</a>。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ccc1cd36d000942230403457e774c231.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SsMJEvwjkAbDTIgCAhkXDA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">SQL Server 2017有多种版本可供选择。预计会有更多版本(很快)</figcaption></figure><p id="c8d4" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果需要，您可以激活云SQL实例的自动备份和高可用性。然而，这可能会产生额外的费用。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/61417cba61abd54bc141fae5b717a068.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YFpaT-kfmZSQDmpVXWq-yQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">易于配置备份和高可用性</figcaption></figure><p id="4cc6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Cloud SQL for SQL Server的配置提供了一个名为<code class="du ld le lf lg b">Flags and parameters</code>的部分，允许您深入了解SQL Server配置的具体细节，因为生产系统可能需要它。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div class="er es lp"><img src="../Images/d355389cc658b4b8d8e86d95a3b08b97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*SvHahd9tPHeRGxIu8TXiuw.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">如果需要，可以用各种标志配置SQL Server实例</figcaption></figure><p id="b8bc" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这个标志列表是详尽的，高级设置应该为有经验的数据库管理员所知。出于测试或开发目的，您可以跳过这一部分。</p><p id="c4c1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">类似地，<code class="du ld le lf lg b">Maintenance</code>上的部分允许您定义自己喜欢的停机时间窗口。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div class="er es lq"><img src="../Images/03ad915e7b881eb58077d4e1f07f11a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*SJJOREYgi57dp-nybrcoGQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">根据您的方便确定维护周期</figcaption></figure><p id="4d7d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">最后，点击页面底部的<code class="du ld le lf lg b">Create</code>按钮，为SQL Server创建一个云SQL实例。部署需要几分钟时间。也许是时候舒展一下筋骨，喝点饮料了。</p><p id="06a6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">完成后，您会在Cloud SQL的概览页面上看到该实例。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/0f33ba0f6505c55efc0486e5fbd83722.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AuxDiDZyHFo_fZg1DKrwoA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">运行SQL Server的云SQL实例:准备就绪</figcaption></figure><p id="6922" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">实例连接信息是将客户端应用程序连接到实例所需的基本信息。单击实例标识符以访问SQL Server的概述和仪表板。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/9f727a75800ec9ae3d68032ae417ebe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*e4qwLlbiRuJo-k66y1imsQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">轻松连接到云SQL实例</figcaption></figure><p id="7bf8" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">复制信息并使用任何客户端应用程序连接到新创建的SQL Server实例。</p><p id="41fb" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">注意:</strong>一个实例的标识符被阻塞一段时间。因此，删除云SQL实例后，您将无法立即使用相同的标识符。</p><h1 id="3f9c" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">使用gcloud创建实例</h1><p id="61c9" class="pw-post-body-paragraph iu iv hi iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">在尝试为SQL Server创建云SQL实例之前，确保您的<code class="du ld le lf lg b">gcloud</code> SDK环境已经安装了<code class="du ld le lf lg b">beta</code>组件。您可以使用以下命令来验证这一点。</p><pre class="li lj lk ll fd ls lg lt lu aw lv bi"><span id="4dc9" class="lw kb hi lg b fi lx ly l lz ma">&gt; gcloud components list </span></pre><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/2ceb28aa6c1b11f3c2f150d98d92a6e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_bobpZLHeWH-tiKJ1Y0tfQ.png"/></div></div></figure><p id="d44f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">注意:</strong>必须使用<code class="du ld le lf lg b">gcloud</code>版本243.0.0或更高版本。</p><p id="5991" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">安装了<code class="du ld le lf lg b">beta</code>组件后，您可以运行这个命令为SQL Server创建一个新的云SQL实例。</p><pre class="li lj lk ll fd ls lg lt lu aw lv bi"><span id="8c3d" class="lw kb hi lg b fi lx ly l lz ma">&gt; gcloud beta sql instances create gcp-sqlserver `<br/> --database-version=SQLSERVER_2017_STANDARD `<br/> --cpu=2 `<br/> --memory=7680MiB `<br/> --root-password=d3Ptgz30EAiygtMn</span></pre><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/c421a54e37379270f620205055cbd8c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q4K73UyWB4QK3tFz0GQfVw.png"/></div></div></figure><p id="d6ce" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用预先配置的区域和分区设置，在活动的GCP项目中创建新实例。如果需要，您还可以添加命令开关<code class="du ld le lf lg b">--project</code>、<code class="du ld le lf lg b">--region</code>和<code class="du ld le lf lg b">--zone</code>来分配不同于默认值的值。</p><p id="7ca3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">成功创建后，您必须为用户<code class="du ld le lf lg b">sqlserver</code>设置密码。该密码应该不同于之前为创建云SQL实例本身而给出的root密码。</p><pre class="li lj lk ll fd ls lg lt lu aw lv bi"><span id="cb9a" class="lw kb hi lg b fi lx ly l lz ma">&gt; gcloud beta sql users set-password sqlserver `<br/> --instance=gcp-sqlserver `<br/> --password=d3Ptgz30EAiygtMn</span></pre><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/12a116ed52582c6d849a40a0d304d526.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IK4OE_HTAxIU2De4QHBiOw.png"/></div></div></figure><p id="3417" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用上面的命令，您还可以在以后重新设置用户的密码。比如，万一你忘了。</p><p id="a255" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">关于<a class="ae js" href="https://cloud.google.com/sql/docs/sqlserver/create-instance" rel="noopener ugc nofollow" target="_blank">创建实例</a>的文档更加详细，并提供了关于所有命令开关的信息。它描述了一些关于底层机器类型配置的约束。</p><h1 id="849f" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">连接到云SQL实例</h1><p id="c002" class="pw-post-body-paragraph iu iv hi iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">您将能够以熟悉的方式使用公共IP地址连接到新创建的SQL Server实例，就像连接到本地实例一样。只要你把你的IP地址列入白名单。</p><p id="8eac" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">以下是各种客户端应用程序的一些截图，如SQL Server Management Studio、Azure Data Studio和Visual Studio 2019。其他客户端应用程序应该可以正常工作。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/308f498715b1f189e5378d1a46c2a153.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LS-oRvObcgqWplmZsyBztQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用各种客户端应用程序连接到云SQL实例</figcaption></figure><p id="cc0b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用ODBC驱动程序连接到云SQL实例也非常好。</p><h1 id="91d0" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">公共访问云SQL的注意事项</h1><p id="aa90" class="pw-post-body-paragraph iu iv hi iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">在云SQL实例的创建步骤中，您可能已经看到了<code class="du ld le lf lg b">Connectivity</code>一节。默认情况下，分配一个<code class="du ld le lf lg b">Public IP</code>的选项被选中。</p><p id="61e0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">GCP建议使用<a class="ae js" href="https://cloud.google.com/sql/docs/sqlserver/sql-proxy" rel="noopener ugc nofollow" target="_blank">云SQL代理</a>而不是白名单IP地址范围，以使外部应用程序能够连接到实例。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div class="er es mf"><img src="../Images/909558c8981e880bdc3c60f5e8115ede.png" data-original-src="https://miro.medium.com/v2/resize:fit:956/format:webp/1*529B36Ucxq7PNqEy9uj0Kg.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">对云SQL的默认访问建议使用云SQL代理</figcaption></figure><p id="ea5e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">注意:</strong>使用云SQL代理需要在您的GCP项目中启用<a class="ae js" href="https://console.cloud.google.com/flows/enableapi?apiid=sqladmin&amp;redirect=https://console.cloud.google.com&amp;_ga=2.205742355.-1649613044.1542902327" rel="noopener ugc nofollow" target="_blank">云SQL管理API</a>。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div class="er es mg"><img src="../Images/0a4c5e04f7a02a02f55944f793781680.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*LneOBYnE3HsqMq0i1YB_EQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">验证在您的GCP项目中启用了云SQL管理API</figcaption></figure><p id="b9f0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下图显示了代理如何连接到云SQL:</p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mh"><img src="../Images/03257e9b9c4dc54bbff9d755f9047d21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DDVFrrT4VsZzt2J8Xd8iQA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">图片由谷歌云文档提供:<a class="ae js" href="https://cloud.google.com/sql/docs/sqlserver/sql-proxy" rel="noopener ugc nofollow" target="_blank">云SQL代理</a></figcaption></figure><p id="246e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">将云SQL代理下载到您的机器上。打开控制台或终端窗口，导航到存储下载文件的文件夹。最终将二进制文件重命名为<code class="du ld le lf lg b">cloud_sql_proxy</code>(取决于您的操作系统)。更多细节在<a class="ae js" href="https://cloud.google.com/sql/docs/sqlserver/connect-admin-proxy" rel="noopener ugc nofollow" target="_blank">使用云SQL代理</a>连接客户端中描述。</p><p id="3130" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">以下命令建立远程连接并侦听本地主机上的传入连接。</p><pre class="li lj lk ll fd ls lg lt lu aw lv bi"><span id="cb7d" class="lw kb hi lg b fi lx ly l lz ma">&gt; .\cloud_sql_proxy.exe -instances=gcp-sql-server:us-central1:gcp-sqlserver=tcp:1433</span></pre><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mi"><img src="../Images/822266d3ef07876df39934875a0c2e97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2-12iC0KHD96ohd3OA2kmw.png"/></div></div></figure><p id="7bc2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">一旦云SQL代理为新连接做好准备，您就可以配置您的客户端应用程序使用localhost或简单的<code class="du ld le lf lg b">.</code>来连接到您的实例。</p><p id="3bcf" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">按<code class="du ld le lf lg b">Ctrl+C</code>停止执行云SQL代理并关闭与您的实例的连接。</p><p id="94ba" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您应该显式指定TCP端口来连接到您的云SQL实例。否则您可能会得到一个<code class="du ld le lf lg b">unsupported network: unix</code>错误。</p><pre class="li lj lk ll fd ls lg lt lu aw lv bi"><span id="a0f7" class="lw kb hi lg b fi lx ly l lz ma">&gt; .\cloud_sql_proxy.exe -instances=gcp-sql-server:us-central1:gcp-sqlserver</span></pre><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/abc2c90537e25d13770b2ab760bf26f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jjGL_MyA1D1XEHxiVhR4sQ.png"/></div></div></figure><p id="bee0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在运行Hyper-V的机器上，您可能会观察到另一个问题。</p><pre class="li lj lk ll fd ls lg lt lu aw lv bi"><span id="7651" class="lw kb hi lg b fi lx ly l lz ma">&gt; .\cloud_sql_proxy.exe -instances=gcp-sql-server:us-central1:gcp-sqlserver2=tcp:1433</span></pre><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/6491446db8896ad4a5537d69145e06db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DPK_ZEV2SQJvB48cCHmQjw.png"/></div></div></figure><p id="81e6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这是因为端口1433由Hyper-V管理，其他应用程序无法访问。您可以使用以下命令检查保留的TCP端口列表。</p><pre class="li lj lk ll fd ls lg lt lu aw lv bi"><span id="b6df" class="lw kb hi lg b fi lx ly l lz ma">&gt; netsh int ipv4 show excludedportrange protocol=tcp</span></pre><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/662bd54db11ae803665742b35443b671.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DwFqvp9JkehEtfaOw5_7IA.png"/></div></div></figure><p id="eddf" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">解决方案是在暂时禁用Hyper-V时保留TCP端口1433。</p><pre class="li lj lk ll fd ls lg lt lu aw lv bi"><span id="0250" class="lw kb hi lg b fi lx ly l lz ma">&gt; # Disable Hyper-V <br/>&gt; dism.exe /Online /Disable-Feature:Microsoft-Hyper-V </span><span id="8b6c" class="lw kb hi lg b fi mk ly l lz ma">&gt; # Reserve the port 1433 <br/>&gt; netsh int ipv4 add excludedportrange protocol=tcp startport=1433 numberofports=1 </span><span id="cfbd" class="lw kb hi lg b fi mk ly l lz ma">&gt; # Re-enable Hyper-V <br/>&gt; dism.exe /Online /Enable-Feature:Microsoft-Hyper-V /All</span></pre><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/1497daadd2fc446a4b8000858f38c2b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*01xinPw1_BAbFfNn53K0JQ.png"/></div></div></figure><p id="3b3f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">或者改为使用非保留的TCP端口。</p><pre class="li lj lk ll fd ls lg lt lu aw lv bi"><span id="750a" class="lw kb hi lg b fi lx ly l lz ma">&gt; .\cloud_sql_proxy.exe -instances=gcp-sql-server:us-central1:gcp-sqlserver=tcp:1470</span></pre><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ml"><img src="../Images/bc829041b4321d7835b4afdae47c3ccf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zKWx7_lXUc9lrQM1pN_LWA.png"/></div></div></figure><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/c7f972316f698638e4de1504255ad11a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rR1H0OT5JR1Yd3YR9Zl7gA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">连接到本地云SQL代理和自定义TCP端口</figcaption></figure><p id="d4c3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">后一种方法提供了更好的灵活性，而不会因为永久的改变而搞乱本地机器。几个星期后你可能不记得这个变化了。</p><p id="f3ae" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">但是，云SQL代理需要在连接到实例的每个客户端上安装一个代理。要在生产环境中正确调用云SQL代理，需要几个步骤。并且在某些情况下，由于各种原因，这也是不可能的。</p><p id="92a9" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">有关云SQL代理选项和连接字符串的更多信息，请参见<a class="ae js" href="https://github.com/GoogleCloudPlatform/cloudsql-proxy" rel="noopener ugc nofollow" target="_blank">云SQL代理GitHub页面</a>。</p><p id="0465" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">或者，对任何外部网络的授权都是可能的。您将在<a class="ae js" href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#CIDR_notation" rel="noopener ugc nofollow" target="_blank"> CIDR符号</a>(无类域间路由)中指定至少一个网络，以允许访问您的实例。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div class="er es mn"><img src="../Images/98448295bd812a30c451250d2c37f88a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*_NDRGD-55nOVv6liAncZEg.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用CIDR符号将您的主机或网络列入白名单</figcaption></figure><p id="7652" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">授权外部主机或网络是更简单的选择，也是我当前对用于开发或试运行环境的云SQL实例的选择。尽管如此，云SQL代理更安全，只要稍加练习，它应该是您连接到实例的首选方式。</p><p id="3b42" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您的里程可能会有所不同。也许你可以在下面的评论区给我你的理由。</p><h1 id="cb57" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">关于云SQL for SQL Server的思考</h1><p id="a598" class="pw-post-body-paragraph iu iv hi iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">使用云SQL实例的SQL Server选项不会带来太大的意外，您应该在最短的时间内启动并运行。</p><p id="884a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">GCP的托管关系数据库服务提供了SQL Server的全部功能。通过选择SQL Server的版本，您可以完全控制功能和定价。</p><p id="c218" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">与微软的Azure SQL数据库相比，应该注意的是，GCP上的SQL Server目前作为虚拟机运行，阅读:使用预定义的计算引擎映像，在引擎盖下。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div class="er es mo"><img src="../Images/c1159b5ba478be47f7b280d02b3f4500.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*A05IdXcJJ7mN6bYc8Q9hxg.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">SQL Server的云SQL似乎作为虚拟机运行</figcaption></figure><p id="b96b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">但是，您的云SQL实例在您的计算引擎区域的虚拟机实例下是不可见的。</p><p id="881e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">不出所料，您的Cloud SQL for SQL Server实例运行在Linux VM上，准确地说是运行在Ubuntu 16.04 LTS (64位；在写的时候)。您可以在任何SQL客户端应用程序中检查执行以下查询的环境。</p><pre class="li lj lk ll fd ls lg lt lu aw lv bi"><span id="9370" class="lw kb hi lg b fi lx ly l lz ma">Select @@version;</span></pre><p id="b316" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">文本响应应该如下所示。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/2ef4537c022a9f65533a4a3acc83aa67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lj4lkQAd6BoqpnPbwhU_DQ.png"/></div></div></figure><p id="2e23" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">考虑到底层的Linux操作系统，还有许多<a class="ae js" href="https://cloud.google.com/sql/docs/sqlserver/features#sqlserver-unavailable" rel="noopener ugc nofollow" target="_blank"> SQL Server特性对于云SQL </a>是不可用的。在将本地数据库迁移到GCP之前，请务必查阅官方文档，这是评估和评价阶段的一部分。</p><p id="6768" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">尽管云SQL for SQL Server实例<a class="ae js" href="https://cloud.google.com/sql/docs/sqlserver/configure-ssl-instance#server-certs" rel="noopener ugc nofollow" target="_blank">配置有现成的自定义TLS证书</a>，但它需要<a class="ae js" href="https://cloud.google.com/sql/docs/sqlserver/connect-admin-ip#connect-ssl" rel="noopener ugc nofollow" target="_blank">在客户端</a>上注册证书颁发机构(CA)来启用加密连接。如果您在客户端上设置了<code class="du ld le lf lg b">Encrypt=yes</code> ODBC连接字符串值，将不会建立连接，并会显示一条错误消息退出。</p><p id="9170" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">相反，根据文档，Cloud SQL for SQL Server可以使用<a class="ae js" href="https://cloud.google.com/sql/docs/sqlserver/connect-admin-proxy" rel="noopener ugc nofollow" target="_blank">云SQL代理</a>进行连接，该代理将使用自动轮换的临时TLS证书建立安全连接。</p><p id="0a06" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">研究这两个选项如何工作超出了本文的范围。也许我将来会研究这个问题。</p><p id="9e49" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为SQL Server创建新的Cloud SQL实例、恢复现有数据库备份(上面没有记录)以及将任何客户端应用程序连接到Cloud SQL只需几个步骤，可能只需要几分钟。</p><p id="0fba" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我对Cloud SQL for SQL Server的印象还是比较正面的。我喜欢在GCP上运行SQL Server数据库以及其他服务的想法，如计算引擎、应用引擎、Kubernetes引擎，甚至是BigQuery来分析数据。</p><p id="9433" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们看看这项托管服务何时正式发布。SQL Server 2019应该是当前SQL Server 2017之外的额外选择。以及<a class="ae js" href="https://datastudio.google.com/" rel="noopener ugc nofollow" target="_blank"> Google Data Studio </a>中是否会有云SQL for SQL Server的连接器。</p></div><div class="ab cl mp mq gp mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="hb hc hd he hf"><p id="06af" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="jw">原载于2020年1月18日</em><a class="ae js" href="https://jochen.kirstaetter.name/sql-server-on-gcp/" rel="noopener ugc nofollow" target="_blank"><em class="jw">https://jochen . kirstaetter . name</em></a><em class="jw">。</em></p></div></div>    
</body>
</html>