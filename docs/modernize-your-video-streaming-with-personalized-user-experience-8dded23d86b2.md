# é€šè¿‡ä¸ªæ€§åŒ–çš„ç”¨æˆ·ä½“éªŒä½¿æ‚¨çš„è§†é¢‘æµç°ä»£åŒ–

> åŸæ–‡ï¼š<https://medium.com/google-cloud/modernize-your-video-streaming-with-personalized-user-experience-8dded23d86b2?source=collection_archive---------2----------------------->

å¸Œæœ›ä½ åœ¨ NEXT22 ä¸Šæœ‰ä¸€ä¸ªå¾ˆå¥½çš„ä½“éªŒï¼Œåœ¨ NEXT 22 æœŸé—´ï¼Œæˆ‘ä»¬å®£å¸ƒäº†å¯¹åª’ä½“ CDN ä¸Šç›´æ’­æµçš„æ”¯æŒï¼Œä»¥åŠä¸ T2 è°·æ­Œå¹¿å‘Šç®¡ç†å™¨ 360 å’Œ T4 åª’ä½“ CDN çš„é›†æˆã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä»‹ç» Media CDN ä¸ Google Ad Manager 360 ä¹‹é—´çš„é›†æˆï¼Œä»¥åŠä½¿ç”¨åŒä»¤ç‰Œè®¤è¯æ¥ä¿æŠ¤é¢å‘å®¢æˆ·çš„ URLã€‚åœ¨æˆ‘ä»¬å¼€å§‹æŠ€æœ¯ç»†èŠ‚ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹åª’ä½“ CDN å’Œè°·æ­Œå¹¿å‘Šç®¡ç†å™¨ã€‚

# å…³äºåª’ä½“ CDN

åª’ä½“ CDN æ˜¯è°·æ­Œäº‘çš„åª’ä½“äº¤ä»˜ CDN å¹³å°ï¼Œä¸“ä¸ºæµåª’ä½“è§†é¢‘å’Œå¤§å‹å¯¹è±¡ä¸‹è½½è€Œè®¾è®¡ã€‚åª’ä½“ CDN è¡¥å……äº‘ CDNï¼Œæˆ‘ä»¬çš„ web åŠ é€Ÿ CDN å¹³å°ã€‚

åª’ä½“ CDN çš„ç‹¬ç‰¹ä¹‹å¤„åœ¨äºï¼Œå®ƒåˆ©ç”¨äº†æˆ‘ä»¬ç”¨æ¥å‘å®¢æˆ·æä¾›å†…å®¹çš„åŸºç¡€è®¾æ–½â€”â€”åŸºäºè°·æ­Œç§æœ‰çš„å…‰çº¤ç½‘ç»œã€‚

éè°·æ­Œå®¢æˆ·å°†é¦–æ¬¡èƒ½å¤Ÿè®¿é—®è¿™ä¸ªå¹³å°ï¼Œåœ¨å…¨çƒè¶…è¿‡ 206 ä¸ªå›½å®¶/åœ°åŒºå’Œ 1300 å¤šä¸ªåŸå¸‚æä¾›å¤§è§„æ¨¡è¦†ç›–å’Œå­˜åœ¨ã€‚

![](img/59b9936f72fe7693c6ddcfe0e2eea3d2.png)

> è¿™å¼ åœ°å›¾æ˜¯æˆ‘ä»¬ç½‘ç»œå‘¼å¸çš„å›¾å½¢è¡¨ç¤ºï¼Œè€Œä¸æ˜¯ç‰¹å®šç¼“å­˜ä½ç½®çš„ç²¾ç¡®æŒ‡ç¤ºå™¨ã€‚

# å…³äºè°·æ­Œå¹¿å‘Šç»ç†(GAM)

è°·æ­Œå¹¿å‘Šç®¡ç†å™¨æ˜¯ä¸€ä¸ªé¢å‘å¤§å‹å‡ºç‰ˆå•†çš„å¹¿å‘Šç®¡ç†å¹³å°ã€‚Ad Manager æä¾›ç²¾ç»†æ§åˆ¶ï¼Œæ”¯æŒå¤šç§å¹¿å‘Šäº¤æ¢å’Œç½‘ç»œï¼ŒåŒ…æ‹¬ AdSenseã€å¹¿å‘Šäº¤æ¢ã€ç¬¬ä¸‰æ–¹ç½‘ç»œå’Œç¬¬ä¸‰æ–¹äº¤æ¢ã€‚

å¹¿å‘Šç®¡ç†å™¨é€‚åˆæ‚¨ï¼Œå¦‚æœæ‚¨éœ€è¦:

*   ä¸€ä¸ªå°†æ‰€æœ‰åº“å­˜ç±»å‹(ç½‘ç«™ã€ç§»åŠ¨åº”ç”¨ã€è§†é¢‘æˆ–æ¸¸æˆ)è´§å¸åŒ–çš„ä¸­å¿ƒ
*   ä½¿ç”¨ç¬¬ä¸‰æ–¹ç½‘ç»œæ¥ç«äº‰å¹¿å‘Šåº“å­˜
*   æ›´å¤æ‚çš„æŠ¥å‘Šï¼Œä»¥è·å¾—æ›´ç²¾ç»†çš„è§è§£

# å°†åª’ä½“ CDN ä¸ GAM é›†æˆ

å¦‚ä»Šï¼Œè¶Šæ¥è¶Šå¤šçš„è§‚ä¼—é€šè¿‡å„ç§è®¾å¤‡è§‚çœ‹ç”µè§†å’Œè§†é¢‘ã€‚åœ¨è¿™äº›è®¾å¤‡ä¹‹é—´æ— ç¼æŠ•æ”¾ç›¸å…³å¹¿å‘Šï¼ŒåŒæ—¶æä¾›å‡ºè‰²çš„ä½“éªŒï¼Œå·²ç»å˜å¾—éš¾ä»¥å®ç°ã€‚

é€šè¿‡åª’ä½“ CDN å’Œ GAM çš„é›†æˆï¼Œæˆ‘ä»¬å°†é€šè¿‡åª’ä½“ CDN æä¾›ç°ä»£åŒ–çš„æµåª’ä½“ä½“éªŒï¼Œé€šè¿‡æœåŠ¡å™¨ç«¯å¹¿å‘Šæ’å…¥(SSAI)æä¾›ä¸ªæ€§åŒ–çš„ç”¨æˆ·ä½“éªŒï¼Œä»è€Œå®ç°ä¸¤è€…çš„å®Œç¾ç»“åˆã€‚

é€šè¿‡åª’ä½“ CDN å’Œ GAM ä¹‹é—´çš„é›†æˆï¼Œæˆ‘ä»¬å°†å®¢æˆ·ç«¯å¹¿å‘Šé›†æˆçš„å¤æ‚æ€§ä»æ’­æ”¾å™¨è½¬ç§»åˆ°äº‘ï¼Œå¹¶å°†å¹¿å‘Šç¼åˆåˆ°æµçº§åˆ«çš„å†…å®¹ä¸­ã€‚ä½ å¾—åˆ°çš„æ˜¯

*   å¹¿å‘Šå’Œå†…å®¹ä¹‹é—´çš„æ— ç¼è§‚çœ‹ä½“éªŒï¼Œæ— éœ€é‡æ–°ç¼“å†²
*   è·¨ä»»æ„æ•°é‡çš„è®¾å¤‡
*   ç›´æ’­ã€çº¿æ€§å’Œè§†é¢‘ç‚¹æ’­å†…å®¹çš„å†…å®¹å’Œå¹¿å‘ŠæŠ•æ”¾
*   é’ˆå¯¹æ¯ä¸ªç”¨æˆ·çš„é’ˆå¯¹æ€§å’Œç›¸å…³æ€§å¹¿å‘Š

åœ¨æˆ‘ä»¬å¼€å§‹é›†æˆä¹‹å‰ï¼Œæˆ‘æƒ³å‘æ‚¨å±•ç¤ºä¸€ä¸ªæœ€ç»ˆçŠ¶æ€æ¶æ„ï¼Œä»¥ä¾¿æ‚¨å¾ˆå¥½åœ°äº†è§£æˆ‘ä»¬çš„æ•´ä½“è§£å†³æ–¹æ¡ˆåœ¨éƒ¨ç½²åçš„å¤–è§‚ã€‚

![](img/4138d0554ff5c01fc888e386149ec8fa.png)

# å…ˆå†³æ¡ä»¶:

**Media-CDN å…ˆå†³æ¡ä»¶:**

*   ä¸¤ä¸ªåª’ä½“ CDN å¯†é’¥é›†(ä¸€ä¸ªç”¨äºçŸ­ä»¤ç‰Œï¼Œä¸€ä¸ªç”¨äºé•¿ä»¤ç‰Œ)
*   ä¸¤ä¸ªåª’ä½“ CDN æ¥æº(ä¸€ä¸ªæŒ‡å‘ dai.google.comï¼Œä¸€ä¸ªæŒ‡å‘æ‚¨çš„å®é™…æ¥æº)
*   å¯ç”¨ SSL è¯ä¹¦çš„ä¸¤ä¸ªåª’ä½“ CDN é…ç½®(è¿™æ˜¯ DAI çš„å¿…å¤‡åŠŸèƒ½)ã€‚

**GAM å…ˆå†³æ¡ä»¶:**

*   åœ¨æ‚¨çš„ç½‘ç»œä¸­å¯ç”¨äº†ç›¸å¯¹æ’­æ”¾åˆ—è¡¨ URL å­—æ®µçš„æƒ…å†µä¸‹è®¿é—® GAM 360ï¼Œè¿™æ˜¯é»˜è®¤æƒ…å†µä¸‹åœ¨æ‚¨çš„ UI ä¸Šä¸å¯ç”¨çš„é¢„å‘å¸ƒåŠŸèƒ½(æ‚¨å¯ä»¥åœ¨å®æ—¶æµé…ç½®çš„å†…å®¹æµè®¾ç½®ä¸­æ‰¾åˆ°æ­¤åŠŸèƒ½ã€‚

çœ‹ä¸‹é¢çš„æˆªå›¾ï¼Œå¹¶æ£€æŸ¥æ‚¨çš„ç½‘ç»œæ˜¯å¦æ”¯æŒç›¸å¯¹æ’­æ”¾åˆ—è¡¨çš„ç½‘å€ã€‚å¦‚æœå®ƒæ²¡æœ‰æ˜¾ç¤ºæ­¤é€‰é¡¹ï¼Œè¯·è”ç³»æ‚¨çš„ GAM å›¢é˜Ÿä¸ºæ‚¨å¯ç”¨å®ƒã€‚

![](img/5f69a0904ebf3cacab6455c9e0e55571.png)

# åª’ä½“ CDN é…ç½®

# ç”¨äºåŒä»¤ç‰Œè®¤è¯çš„çŸ­ä»¤ç‰Œå¯†é’¥é›†åˆ›å»ºã€‚

DAI åªæ”¯æŒ HMACï¼Œæ‰€ä»¥æ‚¨å¿…é¡»ä¸ºçŸ­æœŸä»¤ç‰Œåˆ›å»º HMAC å¯†é’¥é›†ã€‚

éµå¾ª[https://cloud . Google . com/media-cdn/docs/use-dual-token-authentic ation # setup-short-duration-tokens](https://cloud.google.com/media-cdn/docs/use-dual-token-authentication#set-up-short-duration-tokens)ä¸­æåˆ°çš„æ­¥éª¤

ä¸º HMAC é’¥åŒ™é›†åˆ›ä½œã€‚

è¦ç”Ÿæˆå¯†ç ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤

```
python3.9 -c "import secrets;open('py-shared.secret','wb').write(secrets.token_bytes(32))"
```

å°† shared.secret æ–‡ä»¶ä¸Šä¼ åˆ° secret manager åï¼Œå®ƒå°†ä¸ºæ‚¨æä¾› 64 ä¸ªå­—ç¬¦çš„å¯†é’¥(åˆ é™¤ç©ºæ ¼åï¼Œå®ƒå°†ç±»ä¼¼äº d 7258 f 90 D2 f 4049 e 14 B1 C5 ecfbc 698 fbcb 925111 ABC 808 DD 17 f 22153 C1 FCC 71dï¼Œè¯·è®°ä¸‹æ¥ï¼Œå› ä¸ºè¿™åœ¨ DAI é…ç½®ä¸­æ˜¯å¿…éœ€çš„)

# ç”¨äºåŒä»¤ç‰Œè®¤è¯çš„é•¿ä»¤ç‰Œå¯†é’¥é›†åˆ›å»ºã€‚

éµå¾ª[https://cloud . Google . com/Media-cdn/docs/use-dual-token-authentic ation # create-long-duration-keyset](https://cloud.google.com/media-cdn/docs/use-dual-token-authentication#create-long-duration-keyset)ä¸­æåˆ°çš„æ­¥éª¤å¯¹äºåª’ä½“ CDN ç®¡ç†çš„é•¿ä»¤ç‰Œï¼Œè¿™æ˜¯ CDN ç®¡ç†çš„é•¿ä»¤ç‰Œï¼Œå› ä¸ºåª’ä½“ CDN ä½¿ç”¨ ED25519 ç­¾åæ¥ç”Ÿæˆå’ŒéªŒè¯é•¿ä»¤ç‰Œã€‚ED25519 æ˜¯ä¸€ç§éå¯¹ç§°æ­Œå”±ç®—æ³•ï¼Œéœ€è¦ä¸€ä¸ªç§é’¥ç”¨äºä»¤ç‰Œç”Ÿæˆï¼Œä¸€ä¸ªå…¬é’¥ç”¨äºä»¤ç‰ŒéªŒè¯ã€‚

ç”±äº CDN å¿…é¡»è¿›è¡Œç”Ÿæˆå’ŒéªŒè¯ï¼Œå› æ­¤éœ€è¦å¯¹é•¿å¯†é’¥é›†è¿›è¡Œ CDN ç®¡ç†ã€‚

# ä¸¤ä¸ªèµ·æºçš„åˆ›é€ 

# å‚£æº

å¯¹äºä¸»å’Œå­æ¸…å•è¯·æ±‚ï¼Œè¯¥èµ·ç‚¹å°†æŒ‡å‘ dai.google.comã€‚æˆ‘ä»¬å°†åœ¨ Media-CDN æœåŠ¡ä¸­é…ç½®è·¯ç”±è§„åˆ™ã€‚

ä½œä¸ºå‚è€ƒçš„ YAML æ ·æœ¬ã€‚

åœ¨æ‚¨ä½¿ç”¨ YAML ä¹‹å‰ï¼Œè¯·åœ¨ä¸‹é¢çš„< >ä¹‹é—´æ›´æ”¹ **<å˜é‡>** ï¼Œä¾‹å¦‚ï¼Œæ‚¨çš„é¡¹ç›® IDã€é¡¹ç›®ç¼–å·ç­‰..ï¼Œå¸¦èŠ±æ‹¬å·çš„å˜é‡â€” {variables}æ˜¯åª’ä½“ CDN å˜é‡ï¼Œå¦‚æœä¸éœ€è¦ï¼Œè¯·ä¸è¦æ›´æ”¹å®ƒä»¬ã€‚

```
name: projects/<your-project-Id>/locations/global/edgeCacheOrigins/dai-origin
updateTime: '2022-09-30T10:25:44.195099638Z'
originAddress: dai.google.com
protocol: HTTP2
timeout:
 connectTimeout: 5s
 maxAttemptsTimeout: 15s
 responseTimeout: 30s
 readTimeout: 15s
createTime: '2022-09-27T05:20:23.011190947Z'
```

# å®é™…å†…å®¹æ¥æº

è¿™ä¸ªåŸç‚¹å°†æŒ‡å‘æ‚¨çš„å®é™…å†…å®¹æ‰€åœ¨çš„ GCS å­˜å‚¨æ¡¶ã€‚æˆ‘ä»¬å°†åœ¨é¢å‘æœ€ç»ˆç”¨æˆ·çš„æœåŠ¡å’Œé¢å‘ dai çš„æœåŠ¡ä¸­ä½¿ç”¨æ­¤æ¥æº(ä» DAI åˆ°åª’ä½“ CDN çš„å¼‚æ­¥è·å–ï¼Œç”¨äºä¸»æ¸…å•å’Œå­æ¸…å•)ã€‚

ä½œä¸ºå‚è€ƒçš„ YAML æ ·æœ¬ã€‚

```
name: projects/<your-project-Id>/locations/global/edgeCacheOrigins/content-origin
updateTime: '2022-09-26T06:36:53.721017008Z'
originAddress: gs://<your-GCS-bucket-name>
protocol: HTTP2
port: 443
timeout:
 connectTimeout: 5s
 maxAttemptsTimeout: 15s
 responseTimeout: 30s
 readTimeout: 15s
createTime: '2022-09-26T06:35:44.718831043Z'
```

# åˆ›å»ºä¸¤ä¸ªæœåŠ¡

åˆ›å»ºä¸¤ä¸ªæœåŠ¡æ¥è·å– IP åœ°å€å’Œé…ç½® SSL è¯ä¹¦ã€‚æˆ‘ä»¬å°†æ›´æ–°æœåŠ¡ï¼Œä¸€æ—¦æˆ‘ä»¬æœ‰æ¸¸æˆæµåˆ›å»ºã€‚

*   åˆ›å»ºæœåŠ¡ yaml â€” dai-facing.yamlï¼Œä¸Šä¼ åˆ°äº‘å£³ã€‚

```
name: dai-facing
routing:
  hostRules:
  - hosts:
    - "*"
    pathMatcher: routes
  pathMatchers:
  - name: routes
    routeRules:
    - priority: 1
      matchRules:
      - prefixMatch: "/"
      origin: dai-origin
```

*   ä½¿ç”¨ yaml å¯¼å…¥æœåŠ¡ã€‚

```
gcloud edge-cache services import dai-facing \
  --source={path-to-the-yaml-file}
```

*   é€šè¿‡æ£€æŸ¥ ipv4Addresses å­—æ®µï¼Œæ£€ç´¢å¹¶è®°å½•å“åº”ä¸­è¿”å›çš„ IPã€‚
*   ç±»ä¼¼åœ°ï¼Œåˆ›å»ºæœåŠ¡ yaml â€” customer-facing.yaml å¹¶ä¸Šä¼ åˆ°äº‘å¤–å£³ã€‚

```
name: customer-facing
routing:
  hostRules:
  - hosts:
    - "*"
    pathMatcher: routes
  pathMatchers:
  - name: routes
    routeRules:
    - priority: 1
      matchRules:
      - prefixMatch: "/"
      origin: content-origin
```

*   ä½¿ç”¨ yaml å¯¼å…¥æœåŠ¡ã€‚

```
gcloud edge-cache services import customer-facing \
  --source=<path-to-the-yaml-file>
```

*   é€šè¿‡æ£€æŸ¥ ipv4Addresses å­—æ®µï¼Œæ£€ç´¢å¹¶è®°å½•å“åº”ä¸­è¿”å›çš„ IPã€‚

# é…ç½®åŸŸä»¥æŒ‡å‘ CDN æœåŠ¡ IP

*   æŒ‰ç…§[https://cloud . Google . com/DNS/docs/set-up-DNS-records-domain-name # create _ A _ record _ to _ point _ the _ domain _ to _ an _ external _ ip _ address](https://cloud.google.com/dns/docs/set-up-dns-records-domain-name#create_a_record_to_point_the_domain_to_an_external_ip_address)ä¸­çš„æ­¥éª¤åˆ›å»ºä¸€æ¡è®°å½•ï¼Œå°†åŸŸæŒ‡å‘**é¢å‘æˆ´çš„æœåŠ¡**çš„ CDN æœåŠ¡ IP
*   åŒæ ·ï¼ŒæŒ‰ç…§[https://cloud . Google . com/DNS/docs/set-up-DNS-records-domain-name # create _ A _ record _ to _ point _ the _ domain _ to _ an _ external _ ip _ address](https://cloud.google.com/dns/docs/set-up-dns-records-domain-name#create_a_record_to_point_the_domain_to_an_external_ip_address)ä¸­çš„æ­¥éª¤ï¼Œåˆ›å»ºä¸€æ¡è®°å½•ï¼Œå°†åŸŸæŒ‡å‘**é¢å‘å®¢æˆ·æœåŠ¡**çš„ CDN æœåŠ¡ IP
*   æŒ‰ç…§[https://cloud . Google . com/media-cdn/docs/configure-SSL-certificates](https://cloud.google.com/media-cdn/docs/configure-ssl-certificates)ä¸­çš„æ­¥éª¤ï¼Œä¸º**é¢å‘ dai çš„æœåŠ¡**å’Œ**é¢å‘å®¢æˆ·çš„æœåŠ¡**åˆ›å»º SSL è¯ä¹¦

ç°åœ¨æˆ‘ä»¬å°†åœ¨ GAM ä¸­è¿›è¡Œ CDN é…ç½®å’Œçº¿æ€§é…ç½®

# æ¸¸æˆé…ç½®

# GAM ä¸­çš„çº¿æ€§ CDN é…ç½®

*   ç‚¹å‡»**æ–°é…ç½®**

**ä¸€èˆ¬è®¾ç½®**

*   **åç§°** : <ç»™å‡ºæ‚¨çš„é¦–é€‰ CDN é…ç½®åç§°>
*   **ç±»å‹**:ç›´æ’­æµå†…å®¹
*   **æ‘„å–è®¾ç½®**
*   **æ‘„å– URL å‰ç¼€** : <é¢å‘æœåŠ¡çš„ FQDN>/<å‰ç¼€ 1 > /

#prefix1 æ˜¯æ‚¨é€‰æ‹©çš„å‰ç¼€ï¼Œå¯¹äºåç»­é…ç½®ï¼Œæˆ‘ä»¬å°†å…¶ç§°ä¸ºå‰ç¼€ 1

*   **CDN è®¤è¯** : Akamai
*   **ä»¤ç‰Œè®¤è¯:**å¯ç”¨
*   **ä»¤ç‰Œè®¤è¯å¯†é’¥:** <æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ 64 ä¸ªå­—ç¬¦é•¿çš„ HMAC å¯†é’¥>

**é»˜è®¤äº¤ä»˜è®¾ç½®**

*   **äº¤ä»˜ URL å‰ç¼€** : <é¢å‘å®¢æˆ·æœåŠ¡çš„ FQDN>
*   **å®‰å…¨è®¾ç½®**:å‹¾é€‰â€œä½¿ç”¨æ‘„å–å®‰å…¨è®¾ç½®â€
*   **ä¸»æ’­æ”¾åˆ—è¡¨åŸç‚¹è½¬å‘ç±»å‹**:å¸¸è§„
*   **ä¸»æ’­æ”¾åˆ—è¡¨åŸç‚¹è·¯å¾„å‰ç¼€** : / <å‰ç¼€ 1 >
*   ç‚¹å‡»**ä¿å­˜**

# GAM ä¸­çš„çº¿æ€§æµé…ç½®

*   ç‚¹å‡»**æ–°å»ºç›´æ’­**

**é€šç”¨è®¾ç½®**

*   **åç§°** : <ç»™å‡ºä½ çš„é¦–é€‰çº¿æ€§æµé…ç½®åç§°>
*   **ç»“æŸæ—¶é—´**:æ— é™åˆ¶

**å†…å®¹æµè®¾ç½®**

*   **å†…å®¹æµ**:https://<FQDN-of-Dai-facing-service>/<prefix 1>/<path-to-master-manifest-file>/index . m3u 8(æ£€æŸ¥æ‚¨çš„ä¸»æ¸…å•æ–‡ä»¶åæ˜¯å¦æ­£ç¡®)

#ä¸»æ¸…å• urlï¼Œåœ¨ FQDN/åå¸¦æœ‰{å‰ç¼€ 1}

*   **ç›´æ’­æµå†…å®¹é…ç½®** : <é€‰æ‹©-cdn-é…ç½®-åç§°-æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„>
*   **ç›¸å¯¹æ’­æ”¾åˆ—è¡¨ç½‘å€**:å·²å¯ç”¨

**å¹¿å‘Šä¸­æ–­è®¾ç½®**

*   **ä¸»å¹¿å‘Šæ ‡ç­¾** : <æ ¹æ®æ‚¨çš„ä¸šåŠ¡éœ€æ±‚é€‰æ‹©æˆ–æ·»åŠ å¹¿å‘Šæ ‡ç­¾ URL>

ç‚¹å‡»**ä¿å­˜**å’Œæ‰¾åˆ°åˆ›å»ºçš„å®æ—¶æµå¹¶è®°ä¸‹èµ„äº§é”®

**èµ„äº§å…³é”®å­—** : ABCDEFGHIJKLMNOPQRS

# æ›´æ–°åª’ä½“ CDN æœåŠ¡:

æ­¤æ—¶ï¼ŒSSL è¯ä¹¦åº”è¯¥å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ SSL è¯ä¹¦çŠ¶æ€

```
gcloud certificate-manager certificates describe <certificate-name>
```

# æ›´æ–°é¢å‘ dai çš„æœåŠ¡:

*   ä½¿ç”¨ cloud shell å’Œ import æŒ‰ç…§ä¸‹é¢çš„ä¿®æ”¹æ›´æ–° dai-facing.yaml æ–‡ä»¶ã€‚

> æ³¨æ„:æˆ‘ä»¬åªä¸º m3u8 æ–‡ä»¶åˆ›å»ºè·¯ç”±è§„åˆ™ï¼Œå› ä¸º DAI åªå¸Œæœ›ä»æ‚¨çš„æºè·å¾— m3u8 æ–‡ä»¶ï¼Œè€Œä¸éœ€è¦ä»æ‚¨çš„å®é™…æºä¸‹è½½å®é™…æ®µã€‚å¦‚æœæœ‰äººå°†è®¿é—®æ­¤ FQDN å’Œæ¸…å•æ–‡ä»¶è·¯å¾„ï¼Œåˆ™åª’ä½“ CDN ä¹Ÿä¸ä¼šå‘è¯·æ±‚è€…æä¾›æ®µï¼Œå› ä¸ºæ²¡æœ‰è·¯ç”±è§„åˆ™ã€‚ts æ–‡ä»¶ã€‚

```
name: projects/<your-project-Id>/locations/global/edgeCacheServices/dai-facing
updateTime: '2022-09-29T07:28:09.450208839Z'
requireTls: true
edgeSslCertificates:
- projects/<your-project-number>/locations/global/certificates/<certificate-name-of-your-dai-facing-service>
routing:
 hostRules:
 - hosts:
   - <FQDN-of-your-dai-facing-service>
   pathMatcher: path-matcher-0
 pathMatchers:
 - name: path-matcher-0
   routeRules:
   - priority: '1'
     matchRules:
     - prefixMatch: /<prefix1>/<path-to-master-manifest-file>/<master-manifest-file-name>.m3u8 #this will point to your master manifest file
     origin: projects/<your-project-number>/locations/global/edgeCacheOrigins/content-origin
     headerAction: {}
     routeAction:
       cdnPolicy:
         cacheMode: FORCE_CACHE_ALL
         defaultTtl: 3600s
         cacheKeyPolicy:
           excludeHost: true
           excludeQueryString: true
         signedRequestMode: DISABLED
       urlRewrite:
         pathPrefixRewrite: /<path-to-master-manifest-file>/<master-manifest-file-name>.m3u8 #Please note - this is without prefix1
   - priority: '2'
     matchRules:
     - pathTemplateMatch: /<prefix1>/<path-to-master-manifest-file>/{variant}/{file}.m3u8 #{variant} and {file} are media cdn supported variables here, if you donâ€™t have folders underneath your master manifest file, please remove {variant}/ from pathTemplateMatch, do not remove curly braces from variables.
     origin: projects/<your-project-number>/locations/global/edgeCacheOrigins/content-origin
     headerAction: {}
     routeAction:
       cdnPolicy:
         cacheMode: FORCE_CACHE_ALL
         defaultTtl: 2s
         cacheKeyPolicy:
           excludeHost: true
           excludeQueryString: true
         signedRequestMode: DISABLED
       urlRewrite:
         pathTemplateRewrite: /<path-to-master-manifest-file>/{variant}/{file}.m3u8 #{variant} and {file} are media cdn supported variables here, if you donâ€™t have folders underneath your master manifest file, please remove {variant}/ from pathTemplateMatch, do not remove curly braces from variables.
logConfig:
 enable: true
 sampleRate: 1.0
createTime: '2022-09-28T12:49:55.392769608Z'
```

*   ä½¿ç”¨ yaml å¯¼å…¥æœåŠ¡ã€‚

```
gcloud edge-cache services import dai-facing \
  --source={path-to-the-yaml-file}
```

# æ›´æ–°é¢å‘ç”¨æˆ·çš„æœåŠ¡:

*   æŒ‰ç…§ä¸‹é¢çš„ä¿®æ”¹ï¼Œä½¿ç”¨äº‘å¤–å£³å’Œå¯¼å…¥æ›´æ–°é¢å‘å®¢æˆ·çš„. yaml æ–‡ä»¶ã€‚

```
name: projects/<your-project-Id>/locations/global/edgeCacheServices/customer-facing
updateTime: '2022-09-30T12:31:44.574157874Z'
requireTls: true
edgeSslCertificates:
- projects/<your-project-number>/locations/global/certificates/<certificate-name-of-your-customer-facing-service>
routing:
 hostRules:
 - hosts:
   - <FQDN-of-your-customer-facing-service>
   pathMatcher: path-matcher-0
 pathMatchers:
 - name: path-matcher-0
   routeRules:
   - priority: '1'
     matchRules:
     - pathTemplateMatch: /linear/*/*/*/*/*/*/master.m3u8
     origin: projects/<your-project-number>/locations/global/edgeCacheOrigins/dai-origin
     headerAction:
       responseHeadersToAdd:
       - headerName: x-cdn-status
         headerValue: '{cdn_cache_status}'
     routeAction:
       cdnPolicy:
         cacheMode: CACHE_ALL_STATIC
         defaultTtl: 3600s
         maxTtl: 86400s
         cacheKeyPolicy:
           excludeHost: true
           excludeQueryString: true
         signedRequestMode: REQUIRE_TOKENS
         signedRequestKeyset: <your-short-token-keyset-name> #This is to validate urls and tokens generated by DAI
         signedTokenOptions:
           tokenQueryParameter: hdnea
           allowedSignatureAlgorithms:
           - HMAC_SHA_256
           - ED25519
           - HMAC_SHA1
         addSignatures:
           actions:
           - GENERATE_TOKEN_HLS_COOKIELESS
           keyset: <your-long-token-keyset-name> #This is to add long tokens in query parameters by media CDN
           tokenTtl: 86400s
           tokenQueryParameter: hdntl
           copiedParameters:
           - PathGlobs
           - URLPrefix
           - acl
       urlRewrite:
         hostRewrite: dai.google.com
   - priority: '3'
     matchRules:
     - pathTemplateMatch: /**.ts
     origin: projects/<your-project-number>/locations/global/edgeCacheOrigins/content-origin
     headerAction:
       responseHeadersToAdd:
       - headerName: x-cache-status
         headerValue: '{cdn_cache_status}'
     routeAction:
       cdnPolicy:
         cacheMode: FORCE_CACHE_ALL
         defaultTtl: 31536000s
         cacheKeyPolicy:
           excludeHost: true
           excludeQueryString: true
         negativeCaching: true
         negativeCachingPolicy:
           '403': 120s
           '404': 120s
           '502': 120s
         signedRequestMode: REQUIRE_TOKENS
         signedRequestKeyset: <your-long-token-keyset-name> #This is to validate urls and tokens generated media CDN in response to child manifest
         signedTokenOptions:
           tokenQueryParameter: hdntl
   - priority: '2'
     matchRules:
     - pathTemplateMatch: /**.m3u8
     origin: projects/<your-project-number>/locations/global/edgeCacheOrigins/dai-origin
     headerAction:
       responseHeadersToAdd:
       - headerName: x-cache-status
         headerValue: '{cdn_cache_status}'
     routeAction:
       cdnPolicy:
         cacheMode: CACHE_ALL_STATIC
         defaultTtl: 3600s
         maxTtl: 86400s
         cacheKeyPolicy:
           excludeHost: true
           excludeQueryString: true
         signedRequestMode: REQUIRE_TOKENS
         signedRequestKeyset: <your-long-token-keyset-name> #This is to validate urls and tokens generated by media CDN in response to master manifest file
         signedTokenOptions:
           tokenQueryParameter: hdntl
           allowedSignatureAlgorithms:
           - HMAC_SHA_256
           - ED25519
           - HMAC_SHA1
         addSignatures:
           actions:
           - PROPAGATE_TOKEN_HLS_COOKIELESS #Media CDN can also generate token option for segments, you can also use the GENERATE_TOKEN_HLS_COOKIELESS option here.
           keyset: <your-long-token-keyset-name> #This is to add long tokens in query parameters by media CDN 
           tokenTtl: 86400s
           tokenQueryParameter: hdntl
           copiedParameters:
           - PathGlobs
           - URLPrefix
           - acl
       urlRewrite:
         hostRewrite: dai.google.com
logConfig:
 enable: true
 sampleRate: 1.0
createTime: '2022-09-26T06:58:15.925641821Z'
```

*   ä½¿ç”¨ yaml å¯¼å…¥æœåŠ¡ã€‚

```
gcloud edge-cache services import customer-facing \
 - source=<path-to-the-yaml-file>
```

å®Œæˆåï¼Œå°è¯•ç©æ¸¸æˆçš„ç½‘å€å’Œæ’å…¥ SCTE æ ‡è®°æ¥æµ‹è¯•ä½ çš„é›†æˆã€‚

# åº†ç¥ğŸ¥³çš„æ—¶é—´åˆ°äº†

å¸Œæœ›ä½ ä¸€ç›´é™ªç€æˆ‘ï¼Œç›´åˆ°æ—…ç¨‹ç»“æŸï¼Œç»™è‡ªå·±ä¸€ä¸ªåº”æœ‰çš„å¥–åŠ±ï¼Œä½¿ç”¨**åª’ä½“ CDN** æ„å»ºç°ä»£åŒ–çš„æµåª’ä½“æ–¹æ³•ï¼Œä½¿ç”¨**è°·æ­Œ**è§„æ¨¡çš„è°·æ­Œå¹¿å‘Šç®¡ç†å™¨æ„å»ºä¸ªæ€§åŒ–çš„ç”¨æˆ·ä½“éªŒã€‚

è¯·ä¸æˆ‘åˆ†äº«æ‚¨çš„åé¦ˆï¼Œå¹¶å»ºè®®æˆ‘åº”è¯¥åœ¨ä¸‹ä¸€ç¯‡å…³äº GCP åª’ä½“äº§å“çš„åšå®¢ä¸­åŒ…å«å“ªäº›å†…å®¹ã€‚

**å…è´£å£°æ˜:**è¿™æ˜¯ä¸ºäº†å‘ŠçŸ¥è¯»è€…ï¼Œæ–‡ä¸­è¡¨è¾¾çš„è§‚ç‚¹ã€æƒ³æ³•å’Œæ„è§ä»…å±äºä½œè€…ï¼Œä¸ä¸€å®šå±äºä½œè€…çš„é›‡ä¸»ã€ç»„ç»‡ã€å§”å‘˜ä¼šæˆ–å…¶ä»–å›¢ä½“æˆ–ä¸ªäººã€‚