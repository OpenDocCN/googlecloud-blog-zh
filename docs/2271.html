<html>
<head>
<title>Istio Service Mesh 101 — Part (2/3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio服务网格101 —零件(2/3)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/istio-service-mesh-101-part-2-3-ceff88a38558?source=collection_archive---------0-----------------------#2022-07-21">https://medium.com/google-cloud/istio-service-mesh-101-part-2-3-ceff88a38558?source=collection_archive---------0-----------------------#2022-07-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/94bb00809bdc28037b83ae010d0a092b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l9PyOF1BIHD-6EpVSO5Gog.png"/></div></div></figure><div class=""/><p id="ff80" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">欢迎回到Istio服务网格101系列的另一部分。在<a class="ae jo" href="https://pilotudesh.medium.com/istio-service-mesh-101-part-1-3-f07a8fedeea8" rel="noopener">之前的博客</a>中，我们了解了Istio及其安装。我们还看到了如何使用Istio部署应用程序。在这篇博客中，<strong class="is hu"> <em class="jp">我们将探讨交通管理，并简要介绍一下Istio </em> </strong>中的安全概念。</p><p id="dcb9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在前一篇文章中，我们已经使用Istio建立了一个服务网格，并部署了一个示例应用程序。现在，我们希望外部用户可以访问它。对于本演示，用户需要访问产品页面。</p><blockquote class="jq"><p id="d582" class="jr js ht bd jt ju jv jw jx jy jz jn dx translated">我们如何让它变得可访问？</p></blockquote><p id="9f7f" class="pw-post-body-paragraph iq ir ht is b it ka iv iw ix kb iz ja jb kc jd je jf kd jh ji jj ke jl jm jn hb bi translated">假设我们需要使用<a class="ae jo" href="http://bookapp.com" rel="noopener ugc nofollow" target="_blank">http://bookapp.com</a>访问该网站，它应该显示产品页面，其中显示了所列产品的详细信息。</p><blockquote class="jq"><p id="fabd" class="jr js ht bd jt ju jv jw jx jy jz jn dx translated">我们如何实现这一点？</p></blockquote><p id="ef28" class="pw-post-body-paragraph iq ir ht is b it ka iv iw ix kb iz ja jb kc jd je jf kd jh ji jj ke jl jm jn hb bi translated">使用Kubernetes，我们可以使用入口资源来控制进入集群的流量。为此，我们可以<strong class="is hu"> <em class="jp">使用类似NGINX控制器的入口控制器，并定义一组规则来将流量路由到服务</em> </strong>。Istio支持Kubernetes Ingress，但他们还提供了另一种他们推荐的方法，该方法也提供了Istio的更多功能，如高级监控和路由规则。  <em class="jp">这个服务叫做</em><strong class="is hu"><em class="jp">Istio Gateway</em></strong>。</p><h1 id="c092" class="kf kg ht bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">方法</h1><blockquote class="jq"><p id="f72e" class="jr js ht bd jt ju jv jw jx jy jz jn dx translated">Istio网关是位于服务网格边缘的负载平衡器。</p></blockquote><p id="cea2" class="pw-post-body-paragraph iq ir ht is b it ka iv iw ix kb iz ja jb kc jd je jf kd jh ji jj ke jl jm jn hb bi translated"><strong class="is hu">它们是管理服务网格的入站和出站流量的主要配置。</strong>正如我们在之前关于在集群中安装Istio的讲座中所讨论的，Istio安装在一个名为istio-system的名称空间中，有3个组件。</p><blockquote class="jq"><p id="7f48" class="jr js ht bd jt ju jv jw jx jy jz jn dx translated">1.Istiod</p><p id="b726" class="jr js ht bd jt ju jv jw jx jy jz jn dx translated">2.istio-Ingres网关</p><p id="eb76" class="jr js ht bd jt ju jv jw jx jy jz jn dx translated">3.Istio-egressgateway</p></blockquote><p id="d049" class="pw-post-body-paragraph iq ir ht is b it ka iv iw ix kb iz ja jb kc jd je jf kd jh ji jj ke jl jm jn hb bi translated">Istiod是守护进程，另外两个是Istio网关控制器。<strong class="is hu"><em class="jp">Istio-ingressgateway管理所有进入这些服务的入站流量，而Istio-egressgateway管理所有来自这些服务的出站流量</em> </strong>。Kubernetes上的ingress是使用NGINX这样的控制器部署的，而Istio使用Envoy代理部署这些网关控制器。</p><blockquote class="ld le lf"><p id="61de" class="iq ir jp is b it iu iv iw ix iy iz ja lg jc jd je lh jg jh ji li jk jl jm jn hb bi translated">但是，请记住，这些网关控制器是独立的代理，独立于安装在每个服务中的代理。</p></blockquote><p id="5627" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">您也可以拥有自己的一套定制网关控制器。</em></p><p id="7e78" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们回到应用程序。我们需要让流量到达这个网关，并将其路由到产品页面所在的主机名。为此，我们需要首先<strong class="is hu"> <em class="jp">创建一个网关对象</em> </strong>。</p><p id="05b4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个入口网关</p><pre class="lj lk ll lm fd ln lo lp bn lq lr bi"><span id="5bf5" class="ls kg ht lo b be lt lu l lv lw">apiVersion: networking.istio.io/v1alpha3<br/>kind: Gateway<br/>metadata:<br/>  name: app-gateway<br/>spec:<br/>  servers:<br/>  - port:<br/>    number: 80<br/>    name: http<br/>    protocol: HTTP<br/>  hosts:<br/>  - "bookapp.com"</span></pre><p id="dd43" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您有多个入口控制器，也可以将以下代码添加到spec部分。</p><pre class="lj lk ll lm fd ln lo lp bn lq lr bi"><span id="8699" class="ls kg ht lo b be lt lu l lv lw">selector:<br/>  istio: ingressgateway //Or labels that points toward your services</span></pre><p id="74e1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦我们有了YAML文件，我们可以运行:</p><pre class="lj lk ll lm fd ln lo lp bn lq lr bi"><span id="6618" class="ls kg ht lo b be lt lu l lv lw">$ kubectl apply -f ingress-gateway.yaml</span></pre><blockquote class="ld le lf"><p id="14f1" class="iq ir jp is b it iu iv iw ix iy iz ja lg jc jd je lh jg jh ji li jk jl jm jn hb bi translated">要列出网关，请使用</p></blockquote><pre class="lj lk ll lm fd ln lo lp bn lq lr bi"><span id="aa55" class="ls kg ht lo b be lt lu l lv lw">$ kubectl get gateway</span></pre><p id="05fd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在有了一个入口。我们如何将流量路由到服务？这就是虚拟服务发挥作用的地方。</p><h1 id="d163" class="kf kg ht bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">虚拟服务</h1><blockquote class="jq"><p id="5df4" class="jr js ht bd jt ju jv jw jx jy jz jn dx translated">虚拟服务为来自入口网关进入服务网格的流量定义了一组路由规则。</p></blockquote><p id="94a8" class="pw-post-body-paragraph iq ir ht is b it ka iv iw ix kb iz ja jb kc jd je jf kd jh ji jj ke jl jm jn hb bi translated">使用虚拟服务，您可以管理不同版本的服务，并为一个或多个主机名指定流量行为。创建虚拟服务时，Istio控制平面将配置传递给安装在sidecar容器中的所有特使代理。</p><p id="7520" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个虚拟服务</p><pre class="lj lk ll lm fd ln lo lp bn lq lr bi"><span id="5d3a" class="ls kg ht lo b be lt lu l lv lw">apiVersion: networking.istio.io/v1alpha3<br/>kind: VirtualService<br/>metadata:<br/>  name: app-service<br/>spec:<br/>  hosts:<br/>  - "bookapp.com"<br/>  gateways:<br/>  - app-gateway<br/>  http:<br/>  - match:<br/>    - uri:<br/>        exact: /productpage<br/>    route:<br/>    - destination:<br/>        host: productpage <br/>        port:<br/>          number: 9080</span></pre><p id="153c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过这种方式，我们将能够访问产品页面。现在，想象一下，如果我们有多个版本的评论服务，比如2个版本v1和v2。你需要将流量分成不同的版本。按照Kubernetes的方式，您可以像金丝雀部署一样在部署中添加副本。但这只分流了这些豆荚的流量。</p><blockquote class="jq"><p id="6002" class="jr js ht bd jt ju jv jw jx jy jz jn dx translated">如果您只想重定向特定比例的流量，该怎么办？</p></blockquote><p id="598a" class="pw-post-body-paragraph iq ir ht is b it ka iv iw ix kb iz ja jb kc jd je jf kd jh ji jj ke jl jm jn hb bi translated">这就是Istio扩展虚拟服务 流量分流特性的地方。</p><p id="1990" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过编辑如下所示的目标块来修改您的虚拟服务YAML文件:</p><pre class="lj lk ll lm fd ln lo lp bn lq lr bi"><span id="acdb" class="ls kg ht lo b be lt lu l lv lw">apiVersion: networking.istio.io/v1alpha3<br/>kind: VirtualService<br/>metadata:<br/>  name: reviews<br/>spec:<br/>  hosts:<br/>  - "reviews"<br/>  http:<br/>  - route:<br/>    - destination:<br/>        host: reviews<br/>        subset: v1<br/>        weight: 95<br/>    - destination:<br/>      host: reviews <br/>      subset: v2<br/>      weight: 5</span></pre><p id="0634" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> <em class="jp">权重参数保证只有5%的流量流向v2版本的应用</em> </strong>。太好了！<strong class="is hu"> <em class="jp">但是，什么是子集？</em> </strong>这是目的地规则发挥作用的地方。</p><h1 id="9dd3" class="kf kg ht bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">目的地规则</h1><blockquote class="jq"><p id="2e48" class="jr js ht bd jt ju jv jw jx jy jz jn dx translated">在流量被路由到特定服务后，目标规则应用路由器策略。</p></blockquote><p id="42dd" class="pw-post-body-paragraph iq ir ht is b it ka iv iw ix kb iz ja jb kc jd je jf kd jh ji jj ke jl jm jn hb bi translated">让我们在更深的层次上谈论那件事。我们讨论了虚拟服务中的子集。<strong class="is hu"> <em class="jp">它们是如何定义的，在哪里？</em>T15】</strong></p><p id="2dfe" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> <em class="jp">子集是在目的规则中定义的。</em> </strong>那么，让我们创建一个目的地规则。</p><p id="49e8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建dest-rule.yaml</p><pre class="lj lk ll lm fd ln lo lp bn lq lr bi"><span id="b2fc" class="ls kg ht lo b be lt lu l lv lw">apiVersion: networking.istio.io/v1alpha3<br/>kind: DestinationRule<br/>metadata:<br/>  name: review-dest<br/>spec:<br/>  host: reviews<br/>  subsets:<br/>  - name: v1<br/>    labels:<br/>      version: v1 //Label mentioned in the pod<br/>  - name: v2<br/>    labels:<br/>      version: v2 //Label mentioned in the pod</span></pre><p id="41c2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">默认情况下，Envoy使用ROUND_ROBIN算法进行负载平衡，但这也可以定制。</em>各种算法选项有<strong class="is hu">循环、通过、最小连接和随机。</strong>这也可以通过在目的地规则的<strong class="is hu"> spec </strong>部分下添加以下代码来提及。</p><pre class="lj lk ll lm fd ln lo lp bn lq lr bi"><span id="205d" class="ls kg ht lo b be lt lu l lv lw">trafficPolicy:<br/>  loadBalancer:<br/>    simple: PASSTHROUGH</span></pre><p id="5393" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> <em class="jp">我们也有特权在子集级别设置流量策略。</em> </strong>除了配置负载均衡器，还有TLS等其他选项。</p><blockquote class="ld le lf"><p id="8076" class="iq ir jp is b it iu iv iw ix iy iz ja lg jc jd je lh jg jh ji li jk jl jm jn hb bi translated">请访问<a class="ae jo" href="https://istio.io/latest/docs/" rel="noopener ugc nofollow" target="_blank"> Istio文档</a>进行参考。</p></blockquote><h1 id="327c" class="kf kg ht bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">故障注入</h1><p id="4747" class="pw-post-body-paragraph iq ir ht is b it lx iv iw ix ly iz ja jb lz jd je jf ma jh ji jj mb jl jm jn hb bi translated">到目前为止，我们已经配置好了所有的东西，应用程序正在平稳地运行。但是我们如何检查错误处理机制呢？</p><p id="8864" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是我们使用<strong class="is hu">故障注入</strong>的地方。<strong class="is hu">它帮助我们识别所定义的策略是否有效运行，并且没有过多的限制</strong>。<strong class="is hu"> <em class="jp">错误可以通过虚拟服务注入。</em> </strong>错误有两种:<strong class="is hu"><em class="jp"/></strong><em class="jp">和</em> <strong class="is hu"> <em class="jp">中止。</em> </strong></p><blockquote class="ld le lf"><p id="4bbc" class="iq ir jp is b it iu iv iw ix iy iz ja lg jc jd je lh jg jh ji li jk jl jm jn hb bi translated">为了引起延迟，在<strong class="is hu"> spec.http </strong>部分下添加以下代码</p></blockquote><pre class="lj lk ll lm fd ln lo lp bn lq lr bi"><span id="9f34" class="ls kg ht lo b be lt lu l lv lw">- fault:<br/>    delay:<br/>      percentage:<br/>        value: 1<br/>      fixedDelay: 10s //By default, 15s</span></pre><blockquote class="ld le lf"><p id="dbed" class="iq ir jp is b it iu iv iw ix iy iz ja lg jc jd je lh jg jh ji li jk jl jm jn hb bi translated">为了引起中止，在<strong class="is hu"> spec.http </strong>部分下添加以下代码</p></blockquote><pre class="lj lk ll lm fd ln lo lp bn lq lr bi"><span id="cfd3" class="ls kg ht lo b be lt lu l lv lw">- fault:<br/>    abort:<br/>      percentage:<br/>        value: 1<br/>      httpStatus: 400</span></pre><p id="0d4e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> <em class="jp"> Abort通过拒绝请求并返回错误码的方式模拟错误。</em>T25】</strong></p><h1 id="786b" class="kf kg ht bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">超时设定</h1><p id="c747" class="pw-post-body-paragraph iq ir ht is b it lx iv iw ix ly iz ja jb lz jd je jf ma jh ji jj mb jl jm jn hb bi translated">我们可以在服务级别配置超时失败，这样依赖的服务就不会让请求排队。</p><blockquote class="ld le lf"><p id="4380" class="iq ir jp is b it iu iv iw ix iy iz ja lg jc jd je lh jg jh ji li jk jl jm jn hb bi translated">要添加超时，请使用虚拟服务YAML文件中<strong class="is hu">规范</strong>部分下的以下代码:</p></blockquote><pre class="lj lk ll lm fd ln lo lp bn lq lr bi"><span id="532b" class="ls kg ht lo b be lt lu l lv lw">timeout: 5s</span></pre><p id="74f5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要测试它，请在依赖于此服务的另一个服务上使用故障注入。</p><h1 id="28e0" class="kf kg ht bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">重试次数</h1><p id="135b" class="pw-post-body-paragraph iq ir ht is b it lx iv iw ix ly iz ja jb lz jd je jf ma jh ji jj mb jl jm jn hb bi translated">如果希望虚拟服务再次尝试操作，可以配置重试次数。为此，在虚拟服务YAML文件的<strong class="is hu"> spec.http </strong>部分使用以下内容:</p><pre class="lj lk ll lm fd ln lo lp bn lq lr bi"><span id="0581" class="ls kg ht lo b be lt lu l lv lw">retries:<br/>  attempts: 3<br/>  perTryTimeout: 5s</span></pre><p id="682a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">如果一个服务出现故障，对该服务的所有请求都会堆积起来，造成响应延迟。在这种情况下，此类请求应立即标记为失败。这个过程被称为断路</strong>。</p><blockquote class="jq"><p id="2fb1" class="jr js ht bd jt ju jv jw jx jy jz jn dx translated">这将使我们能够创建弹性微服务应用，限制故障或任何网络问题的影响。</p></blockquote><blockquote class="ld le lf"><p id="3355" class="iq ir jp is b it ka iv iw ix kb iz ja lg kc jd je lh kd jh ji li ke jl jm jn hb bi translated">对于电路中断，在目标规则YAML文件的<strong class="is hu">spec . subsets . traffic policy</strong>部分添加以下代码:</p></blockquote><pre class="lj lk ll lm fd ln lo lp bn lq lr bi"><span id="7ab7" class="ls kg ht lo b be lt lu l lv lw">connectionPool:<br/>  tcp:<br/>  maxConnections: 5</span></pre><p id="cdbd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们也来简单了解一下<strong class="is hu"> <em class="jp">安全是如何在Istio </em> </strong>上工作的。</p><h1 id="50f3" class="kf kg ht bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">安全性概述</h1><p id="faef" class="pw-post-body-paragraph iq ir ht is b it lx iv iw ix ly iz ja jb lz jd je jf ma jh ji jj mb jl jm jn hb bi translated">微服务有一定的安全需求。<strong class="is hu"> <em class="jp">当一个服务与另一个服务通信时，黑客有可能干扰通信并修改请求。这就是所谓的中间人攻击。</em> </strong>为了防止这一点，流量需要加密。实施访问控制来限制对每个服务的访问。<em class="jp"> Istio使用相互TLS和细粒度访问策略实施访问控制</em>。此外，Istio还提供了对审计日志的支持。我们将在下一篇博客中详细讨论它们。</p></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="2d96" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在此阅读第1部分:<a class="ae jo" href="https://pilotudesh.medium.com/istio-service-mesh-101-part-1-3-f07a8fedeea8" rel="noopener"> <strong class="is hu"> Istio服务网格101 —零件(1/3) </strong> </a></p><p id="8d0a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在此阅读第3部分:<a class="ae jo" rel="noopener" href="/google-cloud/istio-service-mesh-101-part-3-3-eeda77ab6244"> <strong class="is hu"> Istio服务网格101 —部分(3/3) </strong> </a></p><p id="967e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">希望这有帮助！祝您愉快！干杯！</p></div></div>    
</body>
</html>