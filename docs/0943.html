<html>
<head>
<title>Stackdriver Monitoring Automation Part 4: Stackdriver Groups with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">堆栈驱动监控自动化第4部分:具有地形的堆栈驱动组</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/stackdriver-monitoring-automation-part-4-stackdriver-groups-with-terraform-910289d16d08?source=collection_archive---------1-----------------------#2019-03-05">https://medium.com/google-cloud/stackdriver-monitoring-automation-part-4-stackdriver-groups-with-terraform-910289d16d08?source=collection_archive---------1-----------------------#2019-03-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="fb60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我寻求通过自动化改善生活的过程中，我写了一个关于Stackdriver监控自动化的3部分系列文章，其中使用了Google Cloud Deployment Manager来部署监控资源。我最近坐下来将这种自动化转化为Terraform，因为Terraform中添加了Stackdriver监控支持。您可以使用这些步骤，在使用Terraform的环境中自动部署Stackdriver监控资源。</p><p id="5ae8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在之前的系列文章中，我已经包括了最初的<a class="ae jd" rel="noopener" href="/google-cloud/stackdriver-monitoring-automation-part-1-stackdriver-groups-8e51f0aa9b03">stack driver Monitoring Automation</a>系列文章中描述的相同3个场景的Terraform配置，这里不再重复这些场景。这篇文章涉及堆栈驱动组，而<a class="ae jd" rel="noopener" href="/google-cloud/stackdriver-monitoring-automation-part-5-alerting-policies-ff77b19b4b97">第5部分</a>和<a class="ae jd" rel="noopener" href="/google-cloud/stackdriver-monitoring-automation-part-6-uptime-checks-with-terraform-76cb25b996a4">第6部分</a>分别涉及警报策略和正常运行时间检查。</p><h1 id="6c68" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">Terraform中有哪些可用于Stackdriver监控的自动化功能？</h1><p id="117b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">以下<a class="ae jd" href="https://www.terraform.io/docs/providers/google/index.html" rel="noopener ugc nofollow" target="_blank">组件</a>可用作Terraform数据源，因此可用于自动化。监控范围已经扩展到4个主要的Stackdriver配置，也可以通过监控API获得。</p><ul class=""><li id="a3fd" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">堆栈驱动程序组</li><li id="eeac" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">警报策略</li><li id="7e21" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">通知渠道</li><li id="f2aa" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">正常运行时间检查</li></ul><h1 id="6881" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置用于监控的Terraform</h1><p id="cd22" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我决定利用<a class="ae jd" href="https://cloud.google.com/shell/" rel="noopener ugc nofollow" target="_blank"> Cloud Shell </a>来运行我的Terraform脚本，因为Cloud Shell提供了一个简单的命令行界面，并自动提供了Terraform提供者。</p><p id="3a40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一步是配置Google provider，用适合我的GCP环境的值替换每个条目。这是Terraform <a class="ae jd" href="https://www.terraform.io/docs/providers/google/provider_reference.html" rel="noopener ugc nofollow" target="_blank">文档</a>中描述的格式。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="b5ec" class="le jf hi la b fi lf lg l lh li">provider "google" {<br/>  credentials <strong class="la hj">=</strong> "${file("account_key.<strong class="la hj">json</strong>")}"<br/>  project     <strong class="la hj">=</strong> "<!-- -->abab-cdcd-023991<!-- -->"<br/>  region      <strong class="la hj">=</strong> "us-central1"<br/>  zone        = "us-central1-c"</span><span id="5b41" class="le jf hi la b fi lj lg l lh li">}</span></pre><p id="e941" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我删除了配置中的凭证行，因为Cloud Shell默认提供凭证，因此不需要服务帐户密钥文件。部署所需的IAM角色已经作为项目所有者授予了我。如果您不是项目所有者，您将需要适当的IAM权限。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="148c" class="le jf hi la b fi lf lg l lh li">provider "google" {<br/>  project = "abab-cdcd-023991"<br/>  region  = "us-central1"<br/>  zone    = "us-central1-c"<br/>}</span></pre><h1 id="e048" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">配置文件</h1><p id="97e9" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我根据Stackdriver资源标签创建了3个独立的组:Apache、prod和qa。基于app=website标签，所有apache实例都包含在Apache组中。只有标有env=qa和env=prod的实例分别包含在qa和prod组中。</p><p id="3952" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">qa和prod组将Apache指定为父组，这告诉Stackdriver Monitoring这些是子组。我使用了一个引用来指代每个子组的父名称。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="34b4" class="le jf hi la b fi lf lg l lh li">provider "google" {<br/>  project = "abab-cdcd-023991"<br/>  region  = "us-central1"<br/>  zone    = "us-central1-c"<br/>}</span><span id="6d57" class="le jf hi la b fi lj lg l lh li">resource "google_monitoring_group" "apache_parent" {<br/>  display_name = "Apache"<br/>  filter = "metadata.user_labels.app=has_substring(\"website\")"<br/>}</span><span id="f054" class="le jf hi la b fi lj lg l lh li">resource "google_monitoring_group" "apache_prod_subgroup" {<br/>  display_name = "prod"<br/>  filter = "metadata.user_labels.env=\"prod\""<br/>  parent_name =  "${google_monitoring_group.apache_parent.name}"<br/>}</span><span id="5f93" class="le jf hi la b fi lj lg l lh li">resource "google_monitoring_group" "apache_qa_subgroup" {<br/>  display_name = "qa"<br/>  filter = "metadata.user_labels.env=\"qa\""<br/>  parent_name =  "${google_monitoring_group.apache_parent.name}"<br/>}</span></pre><p id="4d78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在<a class="ae jd" href="https://github.com/charlesbaer/stackdriver-automation" rel="noopener ugc nofollow" target="_blank"> github repo </a>上找到main.tf文件。</p><div class="lk ll ez fb lm ln"><a href="https://github.com/charlesbaer/stackdriver-automation" rel="noopener  ugc nofollow" target="_blank"><div class="lo ab dw"><div class="lp ab lq cl cj lr"><h2 class="bd hj fi z dy ls ea eb lt ed ef hh bi translated">Charles Baer/stack driver-自动化</h2><div class="lu l"><h3 class="bd b fi z dy ls ea eb lt ed ef dx translated">Stackdriver监控自动化中后期的配套github repo。…</h3></div><div class="lv l"><p class="bd b fp z dy ls ea eb lt ed ef dx translated">github.com</p></div></div><div class="lw l"><div class="lx l ly lz ma lw mb mc ln"/></div></div></a></div><h1 id="2428" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">创建组和子组</h1><p id="fa5a" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">添加Stackdriver组需要两个简单的步骤。首先，初始化Terraform。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="14e8" class="le jf hi la b fi lf lg l lh li">$ terraform init</span><span id="2dd1" class="le jf hi la b fi lj lg l lh li">Initializing provider plugins...</span><span id="8483" class="le jf hi la b fi lj lg l lh li">The following providers do not have any version constraints in configuration,<br/>so the latest version was installed.</span><span id="f10a" class="le jf hi la b fi lj lg l lh li">To prevent automatic upgrades to new major versions that may contain breaking<br/>changes, it is recommended to add version = "..." constraints to the<br/>corresponding provider blocks in configuration, with the constraint strings<br/>suggested below.</span><span id="b561" class="le jf hi la b fi lj lg l lh li">* provider.google: version = "~&gt; 2.1"<br/>Terraform has been successfully initialized!</span></pre><p id="e80f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，标准的Terraform apply完成所有工作。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="3109" class="le jf hi la b fi lf lg l lh li">$ terraform apply<br/>google_monitoring_group.apache_parent: Refreshing state... (ID: projects/abab-cdcd-023991/groups/4800045303134799755)<br/>google_monitoring_group.apache_prod_subgroup: Refreshing state... (ID: projects/abab-cdcd-023991/groups/1346673955451905122)<br/>google_monitoring_group.apache_qa_subgroup: Refreshing state... (ID: projects/abab-cdcd-023991/groups/2305611457471642078)</span><span id="e6d2" class="le jf hi la b fi lj lg l lh li">An execution plan has been generated and is shown below.<br/>Resource actions are indicated with the following symbols:<br/>  + create</span><span id="266d" class="le jf hi la b fi lj lg l lh li">Terraform will perform the following actions:</span><span id="3ce1" class="le jf hi la b fi lj lg l lh li">+ google_monitoring_group.apache_parent<br/>      id:           &lt;computed&gt;<br/>      display_name: "Apache"<br/>      filter:       "metadata.user_labels.app=has_substring(\"website\")"<br/>      name:         &lt;computed&gt;<br/>      project:      &lt;computed&gt;</span><span id="f666" class="le jf hi la b fi lj lg l lh li">+ google_monitoring_group.apache_prod_subgroup<br/>      id:           &lt;computed&gt;<br/>      display_name: "prod"<br/>      filter:       "metadata.user_labels.env=\"prod\""<br/>      name:         &lt;computed&gt;<br/>      parent_name:  "${google_monitoring_group.apache_parent.name}"<br/>      project:      &lt;computed&gt;</span><span id="4357" class="le jf hi la b fi lj lg l lh li">+ google_monitoring_group.apache_qa_subgroup<br/>      id:           &lt;computed&gt;<br/>      display_name: "qa"<br/>      filter:       "metadata.user_labels.env=\"qa\""<br/>      name:         &lt;computed&gt;<br/>      parent_name:  "${google_monitoring_group.apache_parent.name}"<br/>      project:      &lt;computed&gt;</span><span id="3661" class="le jf hi la b fi lj lg l lh li">Plan: 3 to add, 0 to change, 0 to destroy.</span><span id="d5b0" class="le jf hi la b fi lj lg l lh li">Do you want to perform these actions?<br/>  Terraform will perform the actions described above.<br/>  Only 'yes' will be accepted to approve.</span><span id="3a89" class="le jf hi la b fi lj lg l lh li">Enter a value: yes</span><span id="7e8d" class="le jf hi la b fi lj lg l lh li">google_monitoring_group.apache_parent: Creating...<br/>  display_name: "" =&gt; "Apache"<br/>  filter:       "" =&gt; "metadata.user_labels.app=has_substring(\"website\")"<br/>  name:         "" =&gt; "&lt;computed&gt;"<br/>  project:      "" =&gt; "&lt;computed&gt;"<br/>google_monitoring_group.apache_parent: Creation complete after 1s (ID: projects/abab-cdcd-023991/groups/3905630164280032312)<br/>google_monitoring_group.apache_qa_subgroup: Creating...<br/>  display_name: "" =&gt; "qa"<br/>  filter:       "" =&gt; "metadata.user_labels.env=\"qa\""<br/>  name:         "" =&gt; "&lt;computed&gt;"<br/>  parent_name:  "" =&gt; "projects/abab-cdcd-023991/groups/3905630164280032312"<br/>  project:      "" =&gt; "&lt;computed&gt;"<br/>google_monitoring_group.apache_prod_subgroup: Creating...<br/>  display_name: "" =&gt; "prod"<br/>  filter:       "" =&gt; "metadata.user_labels.env=\"prod\""<br/>  name:         "" =&gt; "&lt;computed&gt;"<br/>  parent_name:  "" =&gt; "projects/abab-cdcd-023991/groups/3905630164280032312"<br/>  project:      "" =&gt; "&lt;computed&gt;"<br/>google_monitoring_group.apache_qa_subgroup: Creation complete after 1s (ID: projects/abab-cdcd-023991/groups/7315859232068601075)<br/>google_monitoring_group.apache_prod_subgroup: Creation complete after 2s (ID: projects/abab-cdcd-023991/groups/457136244756364624)</span></pre><p id="3087" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦创建了组，我就使用Stackdriver监控控制台来验证Apache、qa和prod组是否已经成功创建。请注意，prod和qa子组出现在Apache组下。</p><figure class="kv kw kx ky fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es md"><img src="../Images/03201d567e073058733476542a6f8cc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YamaABlnUgqHx552yCSzyA.png"/></div></div></figure><p id="fbf4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本系列的第4部分到此结束。在本系列的其他文章和下面的参考资料中阅读更多关于使用Terraform的Stackdriver监控自动化的内容。</p><ul class=""><li id="5bf8" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/stackdriver-monitoring-automation-part-5-alerting-policies-ff77b19b4b97">堆栈驱动监控自动化第5部分:具有地形的堆栈驱动警报策略</a></li><li id="6cce" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/stackdriver-monitoring-automation-part-6-uptime-checks-with-terraform-76cb25b996a4"> Stackdriver监控自动化第6部分:使用Terraform检查Stackdriver正常运行时间</a></li></ul><p id="9e2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考资料:</p><ul class=""><li id="b097" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/docs/" rel="noopener ugc nofollow" target="_blank">堆栈驱动程序监控文档</a></li><li id="713d" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/api/ref_v3/rest/" rel="noopener ugc nofollow" target="_blank">栈驱动监控API文档</a></li><li id="3666" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/api/v3/filters" rel="noopener ugc nofollow" target="_blank">堆栈驱动监控过滤器</a></li><li id="9222" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/api/metrics_gcp" rel="noopener ugc nofollow" target="_blank">堆栈驱动程序监控指标</a></li><li id="4f2e" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://www.terraform.io/docs/providers/google/provider_reference.html" rel="noopener ugc nofollow" target="_blank">谷歌平台提供商</a></li></ul></div></div>    
</body>
</html>