<html>
<head>
<title>Long Running Query Optimization Guide for Bigquery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Bigquery的长期运行查询优化指南</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/long-running-query-optimization-guide-for-bigquery-b3bd3fbca629?source=collection_archive---------0-----------------------#2022-11-22">https://medium.com/google-cloud/long-running-query-optimization-guide-for-bigquery-b3bd3fbca629?source=collection_archive---------0-----------------------#2022-11-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="bb17" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="a940" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">有时，查询运行的时间比您希望的要长。一般来说，工作量少的查询性能更好。它们运行速度更快，消耗的资源更少，这可以降低成本，减少故障。</p><p id="a5c5" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">本文概述了可以提高BigQuery查询性能的优化技术。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kg"><img src="../Images/f1d65ec8dc6988656bcfc3c63024d6db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zF1vopNKB3S2ZwRLJNSaLw.png"/></div></div></figure><h1 id="0962" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">优化技术:</h1><ol class=""><li id="5b1b" class="ks kt hi jf b jg jh jk jl jo ku js kv jw kw ka kx ky kz la bi translated"><strong class="jf hj">连接前过滤数据</strong></li></ol><p id="6be9" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">示例</strong>:查找某个产品在某个特定地区的总销售额</p><blockquote class="lb lc ld"><p id="79bb" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select sum(sales)，region_name，product _ name from sales _ TBL sales<br/>inner join region _ TBL region<br/>on sales . region _ id = region . region _ id<br/>inner join product _ TBL product<br/>on sales . product _ id = product . product _ id<br/>其中upper(region_name)='APAC '和upper(product_name) = '键盘'<br/> group by region_name，product _ name；</p></blockquote><p id="f699" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">上面的查询可以通过将<strong class="jf hj">过滤器应用到region和product表来优化，首先</strong>使用子查询，然后连接到sales表。</p><p id="5b6f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">优化的查询如下所示:</p><blockquote class="lb lc ld"><p id="73c0" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select sum(sales)，region_name，product_name from sales _ TBL sales<br/>内联接(select * from region _ TBL region where upper(region _ name)= ' APAC ')region<br/>on sales . region _ id = region . region _ id<br/>内联接(select * from product _ TBL product where upper(product _ name)= ' KEYBOARD ')product<br/>on sales . product _ id = product . product _ id<br/>group by region _ name，product _ name</p></blockquote><p id="1f8c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">另一种情况是在连接之前删除重复项</p><p id="ece5" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">例</strong>:销售表中的region_name包含重复值，导致交叉连接。</p><blockquote class="lb lc ld"><p id="8a46" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select product _ name from product _ TBL product<br/>inner join sales _ TBL sales<br/>on product . region _ name = sales . region _ name；</p></blockquote><p id="afb1" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">为了避免这种情况，可以通过从sales表中删除重复项来优化查询</p><p id="c829" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">优化的查询如下所示:</p><blockquote class="lb lc ld"><p id="ed9c" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select product _ name from product _ TBL product<br/>inner join(select region _ name from sales _ TBL group by region _ name)sales<br/>on product . region _ name = sales . region _ name；</p></blockquote><p id="2d99" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj"> 2。仅选择需要的列</strong></p><p id="eb0e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">根据上面的示例(第1点)，可以通过将<strong class="jf hj">“select *”替换为“select&lt;column _ list&gt;”</strong>来进一步优化查询</p><blockquote class="lb lc ld"><p id="d7e7" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select sum(sales)，region_name，product _ name from sales _ TBL sales<br/>内联接(select region_name，region _ id from region _ TBL region where upper(region _ name)= ' APAC ')region<br/>on sales . region _ id = region . region _ id<br/>内联接(select product_name，product_id from product _ TBL product where upper(product _ name)= ' KEYBOARD ')product<br/>on sales . product _ id = product . product _ id<br/>group by region _ name，product _ id</p></blockquote><p id="fb83" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj"> 3。将Distinct替换为Group_by </strong></p><p id="42d5" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">示例</strong>:寻找APAC地区的特色产品</p><blockquote class="lb lc ld"><p id="c9ac" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select distinct product . product _ name from region _ TBL region<br/>inner join product _ TBL product【T1 on region . region _ id = product . region _ id<br/>其中region_name = 'APAC '</p></blockquote><p id="7167" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">可以通过用group by 替换<strong class="jf hj"> distinct来优化上面的查询</strong></p><blockquote class="lb lc ld"><p id="b9c3" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select product . product _ name from region _ TBL region<br/>inner join product _ TBL product<br/>on region . region _ id = product . region _ id<br/>其中region _ name = ' APAC '<br/>group by product _ name</p></blockquote><p id="7548" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj"> 4。将大表作为join子句中的第一个表</strong></p><p id="d5ff" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">从上面的例子(第3点)来看，与区域表相比，产品表是最大的表。因此，可以通过更改连接子句和连接条件中的表顺序来进一步优化查询。</p><blockquote class="lb lc ld"><p id="0fa1" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">在product . region _ id = region . region _ id<br/>上从product_tbl product <br/>内部联接region_tbl region <br/>中选择product.product_name，其中region_name = 'APAC' <br/>按产品名称分组</p></blockquote><p id="15b2" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj"> 5。在筛选/连接子句中首先使用分区、聚集列</strong></p><p id="eea3" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">假设sales表按sales_date进行分区，并按product_id进行聚类。</p><blockquote class="lb lc ld"><p id="9c81" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select sum(sales)，product_name<br/>from sales<br/>inner join product _ TBL product<br/>on sales . region _ id = ' APAC '<br/>and sales . product _ id = product . product _ id<br/>and on sales . sales _ date =(select date from current _ date _ TBL)<br/>group by region _ name，product _ name</p></blockquote><p id="5140" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">上述查询可以优化如下</p><blockquote class="lb lc ld"><p id="374e" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select sum(sales)，product_name<br/>from sales<br/>inner join product _ TBL product<br/>on sales . sales _ date =(select date from current _ date _ TBL)<br/>and sales . product _ id = product . product _ id<br/>and sales . region _ id = ' APAC '<br/>group by region _ name，product _ name</p></blockquote><p id="0158" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">正如我们所看到的，<strong class="jf hj">partition _ column(sales _ date)筛选器首先应用于</strong>，然后是聚类列(product_id)筛选器，最后是普通列筛选器(region_id)</p><p id="e2f7" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj"> 6。用临时表</strong>替换多个cte和视图引用</p><p id="ec41" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在下面的示例中，CTE temp_sales被引用了两次。因此，在执行过程中，CTE被执行两次。为了避免这种情况，<strong class="jf hj">将CTE转换成临时表</strong>，并使用临时表代替CTE。</p><blockquote class="lb lc ld"><p id="e22e" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">with temp _ sales as<br/>(select * from sales _ TBL where region _ id = ' R100 ')</p><p id="801e" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select sum(sales)，region_name，product_name<br/>from temp _ sales<br/>inner join region _ TBL region<br/>on sales . region _ id = region . region _ id<br/>inner join product _ TBL product<br/>on sales . product _ id = product . product _ id<br/>where upper(product _ name)= ' KEYBOARD '<br/>group by region _ name，product _ name</p><p id="5f82" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">联合所有</p><p id="ecda" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select sum(sales)，region_name，product _ name<br/>from temp _ sales<br/>inner join region _ TBL region<br/>on sales . region _ id = region . region _ id<br/>inner join product _ TBL product<br/>on sales . product _ id = product . product _ id<br/>where upper(product _ name)= ' LAPTOP '<br/>group by region _ name，product _ name；</p></blockquote><p id="e66c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">上面的查询可以优化如下<br/>这里，cte“temp_sales”被转换为临时表“temp _ sales”</p><blockquote class="lb lc ld"><p id="2819" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">创建临时表temp_sales作为<br/> ( select * from sales_tbl，其中region_id = 'R100 ')</p><p id="f978" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select sum(sales)，region_name，product_name<br/>from temp _ sales<br/>inner join region _ TBL region<br/>on sales . region _ id = region . region _ id<br/>inner join product _ TBL product<br/>on sales . product _ id = product . product _ id<br/>where upper(product _ name)= ' KEYBOARD '<br/>group by region _ name，product _ name</p><p id="5430" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">联合所有</p><p id="4776" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select sum(sales)，region_name，product _ name<br/>from temp _ sales<br/>inner join region _ TBL region<br/>on sales . region _ id = region . region _ id<br/>inner join product _ TBL product<br/>on sales . product _ id = product . product _ id<br/>where upper(product _ name)= ' LAPTOP '<br/>group by region _ name，product _ name；</p></blockquote><p id="953f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj"> 7。将大型查询拆分成临时表</strong></p><p id="97a2" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">如果查询太复杂或需要大量资源，可以使用临时表将查询分成多个部分。</p><blockquote class="lb lc ld"><p id="8c74" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select sum(sales)，region_name，product_name<br/>from sales<br/>inner join region _ TBL region<br/>on sales . region _ id = region . region _ id<br/>inner join product _ TBL product<br/>on sales . product _ id = product . product _ id<br/>where upper(product _ name)= ' KEYBOARD '<br/>group by region _ name，product _ name</p><p id="c62a" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">联合所有</p><p id="1b23" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select sum(sales)，region_name，product _ name<br/>from sales<br/>inner join region _ TBL region<br/>on sales . region _ id = region . region _ id<br/>inner join product _ TBL product<br/>on sales . product _ id = product . product _ id<br/>where upper(product _ name)= ' LAPTOP '<br/>group by region _ name，product _ name；</p></blockquote><p id="81de" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">可以通过创建两个临时表，然后对这两个临时表进行联合来优化上面的查询。此外，临时表的输出可以在多行语句中多次使用，无需任何重新计算。</p><p id="1d1f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">优化后的查询如下所示</p><blockquote class="lb lc ld"><p id="7cc7" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">创建临时表keyboard_temp为<br/> ( <br/> select sum(sales)，region_name，product_name<br/>from sales<br/>inner join region _ TBL region<br/>on sales . region _ id = region . region _ id<br/>inner join product _ TBL product<br/>on sales . product _ id = product . product _ id<br/>where upper(product _ name)= ' KEYBOARD '<br/>group by region _ name，product _ name</p><p id="fda2" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi">);</p><p id="243a" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">创建临时表laptop_temp为<br/>(</p><p id="58f5" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select sum(sales)，region_name，product_name<br/>from sales<br/>inner join region _ TBL region<br/>on sales . region _ id = region . region _ id<br/>inner join product _ TBL product<br/>on sales . product _ id = product . product _ id<br/>where upper(product _ name)= ' LAPTOP '<br/>group by region _ name，product _ name</p><p id="ca43" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi">);</p><p id="9d6c" class="jd je le jf b jg kb ji jj jk kc jm jn lf kd jq jr lg ke ju jv lh kf jy jz ka hb bi translated">select * from keyboard _ temp<br/>union all<br/>select * from laptop _ temp</p></blockquote><p id="f8bc" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我经常写关于谷歌云技术和优化技术的文章。以后的文章请随时关注我。</p><h2 id="edf3" class="li ig hi bd ih lj lk ll il lm ln lo ip jo lp lq it js lr ls ix jw lt lu jb lv bi translated">备注:</h2><p id="7a53" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">本文档补充了google cloud文档(<a class="ae lw" href="https://cloud.google.com/bigquery/docs/best-practices-performance-overview" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/best-practices-performance-overview</a>)</p><h2 id="c602" class="li ig hi bd ih lj lk ll il lm ln lo ip jo lp lq it js lr ls ix jw lt lu jb lv bi translated"><strong class="ak">附录:</strong></h2><p id="6a91" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我来自Bigquery的其他文章供你参考:</p><div class="lx ly ez fb lz ma"><a rel="noopener follow" target="_blank" href="/google-cloud/bigquery-merge-optimization-13fc7147efbf"><div class="mb ab dw"><div class="mc ab md cl cj me"><h2 class="bd hj fi z dy mf ea eb mg ed ef hh bi translated">Bigquery中的分区修剪</h2><div class="mh l"><h3 class="bd b fi z dy mf ea eb mg ed ef dx translated">让我们理解使用Merge语句进行分区修剪。</h3></div><div class="mi l"><p class="bd b fp z dy mf ea eb mg ed ef dx translated">medium.com</p></div></div><div class="mj l"><div class="mk l ml mm mn mj mo kq ma"/></div></div></a></div><div class="lx ly ez fb lz ma"><a rel="noopener follow" target="_blank" href="/google-cloud/convert-normalize-teradata-to-bigquery-76deb6af9a40"><div class="mb ab dw"><div class="mc ab md cl cj me"><h2 class="bd hj fi z dy mf ea eb mg ed ef hh bi translated">将NORMALIZE (Teradata)转换为Bigquery</h2><div class="mh l"><h3 class="bd b fi z dy mf ea eb mg ed ef dx translated">Teradata复函数转换</h3></div><div class="mi l"><p class="bd b fp z dy mf ea eb mg ed ef dx translated">medium.com</p></div></div><div class="mj l"><div class="mp l ml mm mn mj mo kq ma"/></div></div></a></div></div></div>    
</body>
</html>