<html>
<head>
<title>Make actionable alerts using Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用谷歌云发布切实可行的警报</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/make-actionable-alerts-using-google-cloud-dda93e30c781?source=collection_archive---------2-----------------------#2022-12-10">https://medium.com/google-cloud/make-actionable-alerts-using-google-cloud-dda93e30c781?source=collection_archive---------2-----------------------#2022-12-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/ec81409a5a5283522660192469df9e50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/format:webp/1*4uqhdipDdtKh0xq5Rozlag.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated"><a class="ae iq" href="https://unsplash.com/@rwlinder?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">罗伯特·林德</a>在<a class="ae iq" href="https://unsplash.com/s/photos/railway-crossing?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">号航天飞机</a>上的照片</figcaption></figure><p id="fd9c" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">操作生产系统时，可操作事件是一个非常有用的工具。一个常见的使用示例是能够重启CPU利用率达到99%且持续时间超过一分钟的虚拟机实例。根据基础架构或云提供商，事件可以实现为某种触发器，这些触发器绑定到正在执行的脚本，编码到服务中(例如，可以在创建虚拟机实例时提供操作)，或者描述为具有可定制反应的系统警报。许多其他类型的实现也是可能的。例如，参见AWS中的<a class="ae iq" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html" rel="noopener ugc nofollow" target="_blank"> CloudWatch Events </a>。主要的挑战通常是理解术语，所以您可以理解如何识别事件，以及如何将您的实现绑定到该事件，这样它将在预期的条件下被触发。</p><h2 id="879f" class="jp jq hi bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj bi translated">在谷歌云中</h2><p id="fc3d" class="pw-post-body-paragraph ir is hi it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hb bi translated">谷歌云是工程师为工程师构建的。这意味着<em class="kp">你可以实现任何你需要的东西，只要有一个公共的API。然而，这也意味着<em class="kp">有时</em>你会花时间搜索那个API，然后弄清楚如何使用它。这就是在谷歌云中被称为<em class="kp">警报</em>的可操作事件的情况。</em></p><p id="0703" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">在Google Cloud中，您可以使用阈值警报、数据缺失、SLO、正常运行时间检查以及更高级的操作(如使用MQL的变化率和聚合)来定义指标或日志数据的<a class="ae iq" href="https://cloud.google.com/monitoring/alerts" rel="noopener ugc nofollow" target="_blank">警报策略</a>—<a class="ae iq" href="https://cloud.google.com/monitoring/mql" rel="noopener ugc nofollow" target="_blank">监控查询语言</a>。警报策略可以根据小组的需要而简单或复杂，然后使用筛选和分组将数据组合成所需的集合。警报策略包含触发警报的条件、通知您的<a class="ae iq" href="https://cloud.google.com/monitoring/support/notification-options" rel="noopener ugc nofollow" target="_blank">通知渠道</a> (s ),以及包含任何动态数据和仪表盘、行动手册等链接的文档部分，以便更快地进行故障排除。每次满足策略的条件时，系统都会创建一个新的<a class="ae iq" href="https://cloud.google.com/monitoring/alerts/incidents-events" rel="noopener ugc nofollow" target="_blank">事件</a>。为了实施<strong class="it hj"> <em class="kp">可操作</em> </strong>警报，您需要定义允许您“采取行动”的“正确”通知渠道。</p><h2 id="20eb" class="jp jq hi bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj bi translated">实施警报行动</h2><p id="058f" class="pw-post-body-paragraph ir is hi it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hb bi translated">您可以使用三种方法来执行操作以响应触发的警报:</p><ol class=""><li id="4155" class="kq kr hi it b iu iv iy iz jc ks jg kt jk ku jo kv kw kx ky bi translated">定义<a class="ae iq" href="https://cloud.google.com/build/docs/automating-builds/create-manage-triggers" rel="noopener ugc nofollow" target="_blank">云构建触发器</a>。</li><li id="5e4e" class="kq kr hi it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky bi translated">定义<a class="ae iq" href="https://cloud.google.com/functions/docs/calling/pubsub" rel="noopener ugc nofollow" target="_blank">云函数</a>。</li><li id="daba" class="kq kr hi it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky bi translated">定义一个将运行您的逻辑的REST API端点。</li></ol><p id="fc2f" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">前两个可以使用<a class="ae iq" href="https://cloud.google.com/monitoring/support/notification-options#pubsub" rel="noopener ugc nofollow" target="_blank"> PubSub </a>或<a class="ae iq" href="https://cloud.google.com/monitoring/support/notification-options#webhooks" rel="noopener ugc nofollow" target="_blank"> Webhook </a>通知通道来触发。最后一种方法仅由<a class="ae iq" href="https://cloud.google.com/monitoring/support/notification-options#webhooks" rel="noopener ugc nofollow" target="_blank"> Webhook </a>触发。我会推荐使用<a class="ae iq" href="https://cloud.google.com/build" rel="noopener ugc nofollow" target="_blank">云构建</a>，因为它(1)使用声明性语言；(2)配置易于创建、维护和控制；(3)作为无服务器服务，维护成本低廉,( 4)作为谷歌云不可或缺的一部分，它让你可以使用谷歌CLI或API做任何事情。但是，如果你需要某种代理，这样你就可以在Terraform Cloud中触发执行Terraform计划，那么第二种或第三种方法适合你。</p><p id="bff7" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">您可以在<a class="ae iq" href="https://cloud.google.com/monitoring/support/notification-options#expandable-6" rel="noopener ugc nofollow" target="_blank">文档</a>中找到在PubSub消息或HTTP请求中发送的有效负载的JSON模式。</p><h2 id="9611" class="jp jq hi bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj bi translated">在警报策略中描述事件的条件</h2><p id="a594" class="pw-post-body-paragraph ir is hi it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hb bi translated">这就是“你内心的工程师”很重要的地方。如今，用户在使用Google Cloud中的警报来定义事件方面的体验并不好。基本上，为了能够定义一个有意义的警报，你需要编写你自己的MQL，是的，它是另一种脚本语言。让我给你一些关于你可以使用的UI和MQL资源的提示。</p><p id="5a60" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">当您使用<a class="ae iq" href="https://cloud.google.com/cloud-console" rel="noopener ugc nofollow" target="_blank">云控制台</a>创建新警报时，您会发现自己处于多步向导式界面中</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es le"><img src="../Images/97bad77ed130396240497a8042b01cbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*alhbFQ0VlnKNXM3dus08-Q.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">新建警报向导窗口</figcaption></figure><p id="cc35" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">它限制您只能选择一个指标进行查询，然后让您定义预警阈值。如果您的事件是"<em class="kp"> CPU利用率达到100% </em>"，这就足够了，但是如果您想要捕获一个事件"<em class="kp">当返回200个状态代码的响应占响应总数的比率小于90% </em>"或者类似的复杂事件，这就不够了。在这些情况下，你可以通过点击窗口右上角的小<strong class="it hj"> MQL </strong>按钮来改变用户界面，允许你在向导中编写MQL(见前面截图中的红色箭头)。然后，您将看到向导窗口的外观略有不同:</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es ln"><img src="../Images/7f47c324d6b13b560f5aa59bcaaaf9e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XxFFDTIsmOpNFuJxlhsBMQ.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">用于编写MQL查询的新警报向导窗口</figcaption></figure><p id="c55b" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">现在到了困难的部分。几乎所有复杂的警报都使用某种度量比率。使用<a class="ae iq" href="https://cloud.google.com/monitoring/mql/examples#qlx-ratio-ratio" rel="noopener ugc nofollow" target="_blank">比率</a>操作实现。达到相同目标的其他方法的描述可以在<a class="ae iq" href="https://cloud.google.com/monitoring/mql/examples#qlx-ratios" rel="noopener ugc nofollow" target="_blank"> MQL示例</a>中找到。使用MQL，您应该能够定义描述您的事件的MQL查询，尽管<a class="ae iq" href="https://cloud.google.com/monitoring/mql/examples" rel="noopener ugc nofollow" target="_blank">文档</a>对于您的具体情况可能不全面。如果你发现自己遇到了挑战，请在<a class="ae iq" href="https://www.googlecloudcommunity.com/gc/Google-Cloud-s-operations-suite/bd-p/cloud-operations" rel="noopener ugc nofollow" target="_blank">专用论坛</a>中自由提问。在接下来的部分中，我将展示如何针对特定的用户场景来做这件事。</p><p id="135b" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">在您构建了查询以查看捕获您的事件的数据之后，您可以<a class="ae iq" href="https://cloud.google.com/monitoring/mql/alerts#ql-alert-ops" rel="noopener ugc nofollow" target="_blank">定义两个条件</a>中的一个来完成事件的描述并触发警报:</p><ol class=""><li id="a3a4" class="kq kr hi it b iu iv iy iz jc ks jg kt jk ku jo kv kw kx ky bi translated"><code class="du lo lp lq lr b">condition</code> operator让您描述触发事件的<a class="ae iq" href="https://cloud.google.com/monitoring/mql/alerts#ql-threshold-alerts" rel="noopener ugc nofollow" target="_blank">阈值条件</a>，或者在Google Cloud的情况下，打开一个警报事件。</li><li id="f2ad" class="kq kr hi it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky bi translated"><code class="du lo lp lq lr b">absent_for</code>操作符允许您描述在<a class="ae iq" href="https://cloud.google.com/monitoring/mql/alerts#ql-absence-alerts" rel="noopener ugc nofollow" target="_blank">缺少条件</a>时应该触发的事件。当您想要描述没有数据的事件时，这很有用。例如，来自您部署的应用程序的任何<em class="kp">响应或对数据库的任何</em>查询。</li></ol><p id="cfe6" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">然后，您可以为触发事件设置附加约束</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es ls"><img src="../Images/fbd6ca413f40f4bfb9f72f192cdcf4bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TkGr8qbR6nkPBg3qHSTLBw.png"/></div></div></figure><p id="223c" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">是希望在每次满足条件时触发它，还是希望根据违反条件的比率(百分比)或时间序列数，仅在某些时候触发它。为了使其尽可能接近<em class="kp">通常的</em>可操作事件，我建议选择第一个选项“任何时间序列违反”。</p><p id="7b28" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">现在，让我们来看一个例子。</p><h2 id="e0ff" class="jp jq hi bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj bi translated">以身作则或“你能在Google Cloud中做到吗”挑战</h2><p id="4e29" class="pw-post-body-paragraph ir is hi it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hb bi translated">前一段时间，我的朋友问我，是否有可能部署一个新版本的云功能，然后如果部署的版本执行得不够好，就将其回滚。举个例子，我的朋友说这在Azure中是可能的，但是在他看来Google Cloud中没有这样的功能。我来接受挑战，因为我确信它就在那里。</p><p id="c0e6" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">因此，我最终创建了一个简单的云函数，当到达“好”路径时返回状态200，当到达“坏”路径时返回状态404。</p><pre class="lf lg lh li fd lt lr lu bn lv lw bi"><span id="41a7" class="lx jq hi lr b be ly lz l ma mb">package cloudfunctiondemo<br/> <br/>import (<br/> "fmt"<br/> "net/http"<br/>)<br/><br/>func Ping(w http.ResponseWriter, r *http.Request) {<br/>  if r.URL.Path == "/good" {<br/>    fmt.Fprint(w, "pong")<br/>    return<br/>  }<br/>  http.NotFound(w, r)<br/>}</span></pre><p id="cc52" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">我将其部署到云功能，然后创建了一个警报策略，该策略应该捕获以下事件，并在每次事件发生时发送PubSub消息:</p><blockquote class="mc md me"><p id="b6eb" class="ir is kp it b iu iv iw ix iy iz ja jb mf jd je jf mg jh ji jj mh jl jm jn jo hb bi translated">我的云函数实例的响应错误率在5分钟内超过(大于)20%</p></blockquote><p id="b6e7" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">换句话说，如果少于80%的请求连续5分钟以上不正常，那么我想回滚到以前的版本。</p><p id="3abe" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">因此，为了将上述转换成MQL，我需要一些指标来帮助我找到“云函数响应的错误率”。我去Google Cloud上查看<a class="ae iq" href="https://cloud.google.com/monitoring/api/metrics_gcp#gcp-cloudfunctions" rel="noopener ugc nofollow" target="_blank">度量云函数报告了什么</a>，发现<code class="du lo lp lq lr b"><a class="ae iq" href="https://cloud.google.com/monitoring/api/metrics_gcp#cloudfunctions/function/execution_count" rel="noopener ugc nofollow" target="_blank">function/execution_count</a></code>度量累积了函数<strong class="it hj">的执行总数，而</strong>的属性可以是“ok”、“error”等。所以，为了知道这个比率，我需要知道<code class="du lo lp lq lr b">status == "ok"</code>执行了多少次死刑，相对于所有死刑的总数。查看MQL <a class="ae iq" href="https://cloud.google.com/monitoring/mql" rel="noopener ugc nofollow" target="_blank">文档</a>和示例帮助我编写了以下包含条件的查询:</p><pre class="lf lg lh li fd lt lr lu bn lv lw bi"><span id="eed6" class="lx jq hi lr b be ly lz l ma mb">fetch cloud_function<br/>| metric 'cloudfunctions.googleapis.com/function/execution_count'<br/>| {<br/>    filter status != 'ok'<br/>    ;<br/>    ident<br/>}<br/>| group_by drop[status], sliding(5m), .sum<br/>| ratio<br/>| scale '%'<br/>| every (30s)<br/>| condition val() &gt; 20'%'</span></pre><p id="dd5f" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">我来解释一下，这样你自己做东西就容易了。<em class="kp">第一个</em>操作符(第1行)定义了我们获取数据的受监控资源的类型。s<em class="kp">second</em>运算符(第2行)查询我发现应该使用的度量。T <em class="kp"> hird </em>算子是一个复杂的算子。它(第3行)是一个<a class="ae iq" href="https://cloud.google.com/monitoring/mql/reference#query-structure" rel="noopener ugc nofollow" target="_blank">组操作符</a>，它将来自(第2行)的过滤结果与<a class="ae iq" href="https://cloud.google.com/monitoring/mql/reference#ident-tabop" rel="noopener ugc nofollow" target="_blank">“身份”表</a>相结合，后者实质上是指标的整个时间序列。下面的操作符实现前面提到的比率计算I<a class="ae iq" href="https://cloud.google.com/monitoring/mql/examples#qlx-ratio-ratio" rel="noopener ugc nofollow" target="_blank"/>。在这个特定的查询中，它对5分钟窗口中的表进行求和，并计算第一个表(非OK状态的表)与第二个表(所有计数)的比率。然后，它将结果转换成百分比(第10行)，并“告诉”每30秒刷新一次(第11行)。最后，它为比率将大于20%的情况下的警报查询设定条件。</p><p id="796c" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">在定义了“违反任何时间序列”时触发的警报并添加了PubSub通知通道后，我得到了没有操作的可操作事件。剩下的工作很简单。我定义了在接收PubSub消息时触发的CloudBuild触发器，该消息连接到警报向其发送通知的同一个PubSub主题，然后我使用CloudBuild脚本实现了<a class="ae iq" rel="noopener" href="/@minherz/rollback-your-google-cloud-function-to-its-previous-version-76db870744c6">云功能回滚</a>。我没有把代码放在这里，因为这是一个基于云函数的未记录特性的概念证明。</p></div><div class="ab cl mi mj gp mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hb hc hd he hf"><p id="7dc8" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">长话短说，在Google Cloud中实现可操作事件并不容易。我们正在努力使它更简单，但这可能需要一段时间。然而，在这方面，谷歌云没有什么是你做不到的。请联系我，您有具体的用户案例困扰着您。</p></div></div>    
</body>
</html>