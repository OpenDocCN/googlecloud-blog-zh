<html>
<head>
<title>Convert RESET WHEN (Teradata) to Google BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将RESET WHEN (Teradata)转换为Google BigQuery</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/convert-reset-when-teradata-to-google-bigquery-f355ced09872?source=collection_archive---------2-----------------------#2022-11-10">https://medium.com/google-cloud/convert-reset-when-teradata-to-google-bigquery-f355ced09872?source=collection_archive---------2-----------------------#2022-11-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="24ba" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="9721" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">当在SQL分析窗口函数中使用Teradata功能时重置。它是ANSI SQL标准的扩展。当根据某些指定条件确定SQL窗口函数在哪个分区上运行时重置。如果条件评估为真，则在现有窗口分区内创建新的动态子分区</p><p id="b9ca" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">Bigquery不支持RESET WHEN函数。为了实现这个功能，我们必须将RESET WHEN转换为Bigquery中的原生SQL语法。本文演示了如何使用Teradata RESET WHEN特性，以及如何将其转换为Bigquery SQL语法。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kg"><img src="../Images/18e28615a1c63a06aeb8f99bb593f44c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*178sOLwlm92FCk1FG6HZ8w.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">Teradata到Bigquery的转换</figcaption></figure><h1 id="98bb" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">先决条件</h1><ol class=""><li id="84e7" class="kw kx hi jf b jg jh jk jl jo ky js kz jw la ka lb lc ld le bi translated">Teradata数据仓库及其SQL语法的基础知识</li><li id="9daa" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">对Bigquery及其SQL语法有很好的理解</li></ol><h1 id="65ea" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">转换逻辑</h1><h2 id="d056" class="lk ig hi bd ih ll lm ln il lo lp lq ip jo lr ls it js lt lu ix jw lv lw jb lx bi translated">示例场景:</h2><p id="8b28" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">比方说，对于每个地区，要求是分析连续周销售额的总和。</p><p id="355d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">当一周的销售额小于或等于前一周的销售额时，要求重置合计并重新开始。</p><p id="6e4c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">样本数据如下所示</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es ly"><img src="../Images/7b54d91c390b922e2ff3331bb57c1f8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z-BXBUChVuq_6lVp"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">每周每个地区的销售额</figcaption></figure><h2 id="5233" class="lk ig hi bd ih ll lm ln il lo lp lq ip jo lr ls it js lt lu ix jw lv lw jb lx bi translated">Teradata SQL:</h2><blockquote class="lz ma mb"><p id="faa0" class="jd je mc jf b jg kb ji jj jk kc jm jn md kd jq jr me ke ju jv mf kf jy jz ka hb bi translated">SELECT region_id，week_id，sales，<br/>(SUM(sales)OVER(PARTITION BY region _ id ORDER BY week _ id<br/><strong class="jf hj">RESET WHEN</strong>sales&lt;= SUM(sales)OVER(PARTITION BY region _ id ORDER BY weekly _ id ROWS BETWEEN previous AND 1 previous)<br/>ROWS BETWEEN unbound previous AND CURRENT ROWS)作为sales _ increase<br/>FROM POC _ aa _ cs . week _ sales _ per _ region<br/>ORDER BY 1，2；</p></blockquote><h2 id="e294" class="lk ig hi bd ih ll lm ln il lo lp lq ip jo lr ls it js lt lu ix jw lv lw jb lx bi translated"><strong class="ak">查询输出:</strong></h2><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mg"><img src="../Images/2b37f08a92c000983fa150446903d160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tF22IxEXbhEV8Vb9"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">合计_连续_销售_增长</figcaption></figure><h2 id="5a67" class="lk ig hi bd ih ll lm ln il lo lp lq ip jo lr ls it js lt lu ix jw lv lw jb lx bi translated"><strong class="ak">大查询SQL: </strong></h2><blockquote class="lz ma mb"><p id="b518" class="jd je mc jf b jg kb ji jj jk kc jm jn md kd jq jr me ke ju jv mf kf jy jz ka hb bi translated">SELECT region_id，week_id，sales，<br/>(SUM(sales)OVER(PARTITION BY region _ id，upd _ dynamic _ PARTITION ORDER BY week_id)未绑定的前一行和当前行)作为sales _ increase<br/>FROM<br/>(SELECT region _ id，week_id，sales，<br/>SUM(dynamic _ part)OVER(PARTITION BY region _ id ORDER BY week _ id行，位于未绑定的前一行和当前行之间)作为upd _ dynamic _ PARTITION<br/>(SELECT region _ id，week _ id</p></blockquote><h1 id="fbdd" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">翻译解释:</h1><ul class=""><li id="443a" class="kw kx hi jf b jg jh jk jl jo ky js kz jw la ka mh lc ld le bi translated">在内部子查询(别名S1)中，创建并填充了一个动态分区指示器(dynamic_part)。如果一周的销售额小于或等于前一周的销售额，则dynamic_part设置为1；否则，它被设置为0。</li><li id="9edf" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka mh lc ld le bi translated">在下一层(别名S2)，upd_dynamic_partition属性是作为求和窗口函数的结果而生成的。</li><li id="9a1d" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka mh lc ld le bi translated">最后，将upd_dynamic_partition作为新的分区属性(动态分区)添加到现有的分区属性(region_id)中，并应用与Teradata中相同的SUM函数</li></ul><p id="2952" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">经过这些更改后，Bigquery SQL将生成与Teradata相同的输出。</p></div></div>    
</body>
</html>