<html>
<head>
<title>Application metrics in Istio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio中的应用指标</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/application-metrics-in-istio-3949d81c5508?source=collection_archive---------1-----------------------#2019-01-07">https://medium.com/google-cloud/application-metrics-in-istio-3949d81c5508?source=collection_archive---------1-----------------------#2019-01-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="eccc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Istio发送的默认指标有助于了解集群中的流量流动情况。然而，要理解应用程序的行为，您还需要应用程序指标。</p><p id="5722" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a>有<a class="ae jd" href="https://prometheus.io/docs/instrumenting/clientlibs/" rel="noopener ugc nofollow" target="_blank">客户端库</a>，你可以用它们来检测你的应用程序并发送那些指标。这很好，但也带来了一些问题:</p><ul class=""><li id="41b2" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">您从哪里收集这些指标？</li><li id="5c18" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">是用Istio的普罗米修斯还是自己设置普罗米修斯？</li><li id="14a7" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">如果你使用Istio的Prometheus，你需要什么样的配置来获得这些指标？</li></ul><p id="095c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们试着回答这些问题。</p><h1 id="68c1" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">Istio与独立普罗米修斯</h1><p id="8263" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">在Prometheus中，有一个<a class="ae jd" href="https://prometheus.io/docs/prometheus/latest/federation/" rel="noopener ugc nofollow" target="_blank">联合</a>特性，允许一个Prometheus服务器从另一个Prometheus服务器获取指标。如果您想将Istio指标和应用程序指标分开，您可以为应用程序指标设置一个单独的Prometheus服务器。然后，您可以使用federation来收集那些用Istio的Prometheus服务器收集的应用程序指标。</p><p id="b72b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一种更简单的方法是直接使用Istio的Prometheus来获取应用程序的指标，这也是我在这里想要关注的。</p><h1 id="4022" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">发送应用程序指标</h1><p id="8ca6" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">要从您的应用程序发送定制指标，您需要使用Prometheus的<a class="ae jd" href="https://prometheus.io/docs/instrumenting/clientlibs/" rel="noopener ugc nofollow" target="_blank">客户端库</a>来检测您的应用程序。使用哪个库取决于您使用的语言。作为一个C#/。NET开发者，我用的是<a class="ae jd" href="https://github.com/prometheus-net/prometheus-net" rel="noopener ugc nofollow" target="_blank">。这篇来自丹尼尔·奧利弗的博客文章一步一步地介绍了如何从ASP.NET的核心应用程序发送自定义指标，并在本地的Prometheus服务器上看到它们。</a></p><p id="62c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要注意的一件事是您暴露普罗米修斯指标的端口。在<a class="ae jd" href="http://asp.net/" rel="noopener ugc nofollow" target="_blank">ASP.NET</a>内核中，默认端口为<strong class="ih hj"> 5000 </strong>。在本地运行时，应用指标在<code class="du kv kw kx ky b">localhost:5000/metrics</code>上公开。然而，当你容器化你的应用程序时，通过不同的端口暴露你的应用程序是很常见的，比如<strong class="ih hj"> 8080 </strong>，这在我们稍后讨论配置时变得相关。</p><p id="5b0e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设您在一个支持Istio的Kubernetes集群上封装和部署了您的应用程序，现在让我们看看我们需要做些什么来让Istio的Prometheus收集这些应用程序指标。</p><h1 id="c349" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">配置</h1><p id="c88a" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">在Istio 1.0.5中，Kubernetes的默认安装文件<code class="du kv kw kx ky b">istio-demo.yaml</code>或<code class="du kv kw kx ky b">istio-demo-auth.yaml</code>已经在<code class="du kv kw kx ky b">ConfigMap</code>下有了Prometheus的抓取配置。你可以只搜索<code class="du kv kw kx ky b">prometheus.yml</code>。有两个与应用程序指标相关的擦除作业:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="338f" class="lh jt hi ky b fi li lj l lk ll">- job_name: 'kubernetes-pods'<br/>  kubernetes_sd_configs: <br/>- role: pod <br/>... <br/>- job_name: 'kubernetes-pods-istio-secure' <br/>scheme: https</span></pre><p id="e518" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些作业从常规pod和启用了mTLS的pod中收集指标。看起来Istio的Prometheus应该自动收集应用程序指标。然而，在我的第一次尝试中，并没有成功。我不确定出了什么问题，但是普罗米修斯有一些默认的端点:</p><ul class=""><li id="de9a" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated"><code class="du kv kw kx ky b">/config</code>:查看普罗米修斯目前的配置。</li><li id="6809" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><code class="du kv kw kx ky b">/metrics</code>:查看抓取的指标。</li><li id="cdba" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><code class="du kv kw kx ky b">/targets</code>:查看正在被刮的目标及其状态。</li></ul><p id="d276" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有这些端点对于调试Prometheus都很有用:</p><figure class="kz la lb lc fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lm"><img src="../Images/86ba8e7e1841ffe77c5d53c87593ba83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LoATqvpqp_Cy0OkO"/></div></div></figure><p id="5b48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">原来，我需要在我的吊舱YAML文件中添加一些注释，以便让普罗米修斯刮吊舱。我不得不告诉普罗米修斯刮去吊舱并在哪个端口上贴上这些注解:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="b479" class="lh jt hi ky b fi li lj l lk ll">kind: Deployment<br/> metadata:<br/>   name: aspnetcore-v4<br/> spec:<br/>   replicas: 1<br/>   template:<br/>     metadata:<br/>       labels:<br/>         app: aspnetcore<br/>         version: v4<br/>       annotations:<br/> <strong class="ky hj">        prometheus.io/scrape: "true"<br/></strong> <strong class="ky hj">        prometheus.io/port: "8080"</strong></span></pre><p id="d812" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加注释后，我能够在Prometheus中看到我的应用程序的指标:</p><figure class="kz la lb lc fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lm"><img src="../Images/e18f61814685ea1675f0d6c1a9f6edf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*omHyLAZeJQLCLGhi"/></div></div></figure><p id="d322" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，它只适用于常规的pod，我无法看到pod之间启用了mTLS的指标。</p><h1 id="2b17" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">Istio certs和Prometheus的问题</h1><p id="8ac7" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">这并不理想，但有一个简单的解决办法:重启普罗米修斯舱。Restart强制Prometheus获取证书，应用程序的指标也开始为启用mTLS的pod流动。</p><h1 id="4f1f" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">结论</h1><p id="cfc4" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">值得注意的是<a class="ae jd" href="https://istio.io/docs/concepts/what-is-istio/#mixer" rel="noopener ugc nofollow" target="_blank">混音器</a>正在重新设计，在Istio的未来版本中，它将直接嵌入到Envoy中。在该设计中，您将能够通过Mixer发送应用程序指标，它将通过sidecar的相同整体指标管道流动。这将使端到端的应用程序度量工作变得更加简单。</p><p id="e801" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢Istio团队和我的同事Sandeep Dinesh帮助我调试问题，让事情顺利进行。</p></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><p id="d652" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="mb">原载于2019年1月7日</em><a class="ae jd" href="https://meteatamel.wordpress.com/2019/01/07/application-metrics-in-istio/" rel="noopener ugc nofollow" target="_blank"><em class="mb">meteatamel.wordpress.com</em></a><em class="mb">。</em></p></div></div>    
</body>
</html>