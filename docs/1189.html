<html>
<head>
<title>Serverless computing with Pascal?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Pascal进行无服务器计算？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/serverless-computing-with-pascal-d7a16633db44?source=collection_archive---------1-----------------------#2019-11-04">https://medium.com/google-cloud/serverless-computing-with-pascal-d7a16633db44?source=collection_archive---------1-----------------------#2019-11-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e02f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对无服务器计算感兴趣，但不想使用一些新奇的编程语言，如Python、JavaScript或Go？那么为什么不用Pascal语言编写你的无服务器web应用呢？让我们回到20世纪70年代，从1974年出版的权威<a class="ae jd" href="https://www.springer.com/gp/book/9780387976495" rel="noopener ugc nofollow" target="_blank"> Pascal用户手册和报告</a>中取出一个Pascal程序，并将其部署到谷歌<a class="ae jd" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank">云运行</a>无服务器平台。哦，这里有一个20世纪70年代的背景音乐播放列表让你集中注意力。</p><blockquote class="je jf jg"><p id="734b" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">那是什么？<strong class="ih hj">你没有运行无服务器Pascal的需求？然后，也许你有一些其他的仅可执行形式的遗留软件，或者一种不被无服务器平台广泛支持的语言，或者由几个不同的应用构建而成。这里展示的技术也可以解决这些问题。</strong></p></blockquote><h2 id="6b3c" class="jl jm hi bd jn jo jp jq jr js jt ju jv iq jw jx jy iu jz ka kb iy kc kd ke kf bi translated">一些背景</h2><p id="3a2f" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/functions/" rel="noopener ugc nofollow" target="_blank"> Google Cloud Functions </a>和类似的无服务器解决方案使得将功能部署到云上变得极其容易。您只需编写您的应用程序代码，将其上传到服务，他们就会为您处理部署、供应、基础架构、扩展、日志记录和安全性。它们很棒，但需要权衡。他们只接受一个用他们支持的语言编写的程序。而帕斯卡不是(还不是？)支持的语言之一。</p><p id="89c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是<a class="ae jd" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank">云运行</a>提供了类似的功能，但权衡稍有不同。可以用其他语言(比如Pascal！)、可执行文件或多个程序，但您需要提供一个<a class="ae jd" href="https://www.docker.com/resources/what-container" rel="noopener ugc nofollow" target="_blank">容器</a>，而不仅仅是源代码。这要多做一点工作，但比您想象的要少，因为<a class="ae jd" href="https://cloud.google.com/cloud-build/" rel="noopener ugc nofollow" target="_blank">云构建</a>会为您完成这项工作。您还可以获得所有正常的无服务器优势，如自动伸缩(甚至在代码不运行时为零)。让我们看看怎么做。</p><h2 id="6bb0" class="jl jm hi bd jn jo jp jq jr js jt ju jv iq jw jx jy iu jz ka kb iy kc kd ke kf bi translated">TL；灾难恢复:一键式部署</h2><p id="cf41" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">示例<a class="ae jd" href="https://github.com/engelke/cloud-run-pascal" rel="noopener ugc nofollow" target="_blank">项目存储库在GitHub </a>上。看一看它。显示README 文件，靠近顶部有一个大按钮:</p><figure class="km kn ko kp fd kq er es paragraph-image"><div class="er es kl"><img src="../Images/1ed255f823967b823ae95b291b55fa34.png" data-original-src="https://miro.medium.com/v2/resize:fit:572/format:webp/1*q-x7ajkIsmmKrgObjY_ibg.png"/></div></figure><p id="1005" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你有一个谷歌云账户，比如Gmail账户，你可以点击那个按钮，回答它显示的任何提示，几分钟后你就会有一个运行中的web服务，它是由库中的Pascal程序构建的。该URL将在部署服务时显示。</p><p id="f892" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以派生这个存储库，并将其更改为运行您自己的Pascal代码(或者稍微调整一下，运行任何其他代码)，并以同样的方式启动您自己的新服务。甚至有可能让服务在你自己的域名上运行。</p><h2 id="e396" class="jl jm hi bd jn jo jp jq jr js jt ju jv iq jw jx jy iu jz ka kb iy kc kd ke kf bi translated">它是如何工作的</h2><p id="d2d6" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">我把一个Pascal程序作为一个web服务部署到云上。它接受一个数字并返回相同的数字，但用的是罗马数字。想看看用罗马数字表示的1974年(我正在使用的程序出版的那一年)是什么样子吗？只需通过<a class="ae jd" href="https://roman.engelke.dev/1974" rel="noopener ugc nofollow" target="_blank">https://roman.engelke.dev/1974</a>打电话给RESTful服务了解一下。或者您可以在URL中输入不同的数字进行转换。这个程序不使用罗马数字快捷键(如IX代表9)，所以一行中可以有四个字母。</p><p id="463f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要自己从头开始构建，首先创建一个新文件夹来保存所有的部分，或者使用下面的命令将GitHub存储库克隆到一个新文件夹中:</p><p id="d45f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kt ku kv kw b">git clone https://github.com/engelke/cloud-run-pascal.git</code></p><p id="84a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该文件夹将包含Pascal程序和任何其他需要的部分，以使它在云上运行。首先是<a class="ae jd" href="https://github.com/engelke/cloud-run-pascal/blob/master/roman.pas" rel="noopener ugc nofollow" target="_blank">帕斯卡程序</a>本身:</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kx"><img src="../Images/b00edd1cd255bcaaf948344d755f181b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oiTxkDU4QlCJ_Crv_ALpxA.png"/></div></div><figcaption class="lc ld et er es le lf bd b be z dx translated">罗曼.帕斯</figcaption></figure><p id="cd0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">简洁明了，请看:子句用分号分隔，程序以句号结尾！较新的语言没有很好的标点符号。这个程序所做的就是从标准输入中读取一个整数，并写出等同于标准输出的罗马数字。这不需要现代网络技术。这很好，因为Pascal比web早了几十年。它甚至比互联网协议IP还要古老。</p><p id="a44f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Pascal程序不理解web，但是容器必须包含web服务器。当一个web请求进入Cloud Run时，它将运行容器并将请求发送到容器中的web服务器。这个web服务器是由一个<a class="ae jd" href="https://github.com/engelke/cloud-run-pascal/blob/master/app.py" rel="noopener ugc nofollow" target="_blank"> Python包装程序</a>提供的。包装程序不理解应用程序，它是一个胶水软件，监听一个web请求，从URL的末尾提取数字，并以该数字作为输入运行Pascal程序。如果Pascal程序崩溃，包装器返回一个<code class="du kt ku kv kw b">500 Server Error</code>消息。如果程序写了一个错误消息，包装器返回一个<code class="du kt ku kv kw b">400 Bad Request</code>消息。否则，包装器获取Pascal程序的输出，并将其作为响应的主体返回。</p><p id="d424" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了Python包装程序，还有一个<a class="ae jd" href="https://github.com/engelke/cloud-run-pascal/blob/master/requirements.txt" rel="noopener ugc nofollow" target="_blank"> requirements.txt文件</a>，它指定了程序需要哪些Python库。同样，这只是需要包装我们需要运行的真正的程序，它是用Pascal语言编写的。</p><p id="db8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">唯一需要的其他东西是Dockerfile ，一个告诉如何构建容器的文本文件。让我们来看看吧。</p><ul class=""><li id="21d4" class="lg lh hi ih b ii ij im in iq li iu lj iy lk jc ll lm ln lo bi translated"><code class="du kt ku kv kw b">FROM python:3.7-slim</code> <br/>在名为<strong class="ih hj"> python:3.7-slim </strong>的标准容器之上构建容器。</li><li id="8eff" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du kt ku kv kw b">ENV APP_HOME /app<br/>WORKDIR $APP_HOME<br/>COPY . ./</code> <br/>指定在容器中的什么地方放置代码，并将文件复制到当前目录那里。</li><li id="fb86" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du kt ku kv kw b">RUN pip install -r requirements.txt<br/></code>作为构建容器的一部分，运行这个命令来安装Python包装程序所需的库。</li><li id="8240" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du kt ku kv kw b">RUN apt-get update -y -q<br/>RUN apt-get install -y -q fpc<br/>RUN fpc roman.pas</code> <br/> Pascal源代码不能直接运行，必须先编译(转换成二进制可执行文件)。所以，在构建容器时，这些行表示运行命令来安装一个名为<strong class="ih hj"> fpc </strong>的Pascal编译器，然后用它来编译<strong class="ih hj"> roman.pas </strong>程序。容器内生成的二进制可执行文件将被称为<strong class="ih hj">罗马</strong>。</li><li id="7841" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du kt ku kv kw b">CMD exec gunicorn --bind:$PORT --workers 1 --threads 8 app:app</code> <br/>在构建和部署容器后，无论何时运行它，它都应该调用这个命令，这将启动Python包装程序，并让它在容器提供的网络端口上监听web请求。</li></ul><p id="73a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你看一看基本的<a class="ae jd" href="https://cloud.google.com/run/docs/quickstarts/build-and-deploy" rel="noopener ugc nofollow" target="_blank">云运行快速启动教程</a>，你会在其中看到大部分内容。运行Pascal代码所需的唯一新部分是安装并运行Pascal编译器的三行代码，它将Pascal源代码转换为可执行文件。</p><h2 id="c0d2" class="jl jm hi bd jn jo jp jq jr js jt ju jv iq jw jx jy iu jz ka kb iy kc kd ke kf bi translated">构建和部署</h2><p id="91cc" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">一旦您创建或克隆了包含四个所需文件的文件夹:<strong class="ih hj"> roman.pas </strong>、<strong class="ih hj"> app.py </strong>、<strong class="ih hj"> requirements.txt </strong>和<strong class="ih hj"> Dockerfile </strong>，您就可以将它部署到云运行。你需要一个谷歌账户(比如Gmail账户)，你可以<a class="ae jd" href="https://cloud.google.com/sdk/install" rel="noopener ugc nofollow" target="_blank">安装谷歌云SDK </a>或者你自己的电脑，或者从你的浏览器内部使用<a class="ae jd" href="https://cloud.google.com/shell/" rel="noopener ugc nofollow" target="_blank">云外壳</a>(已经安装了SDK)来运行必要的命令。</p><p id="3c77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">准备好了吗？以下是步骤:</p><ol class=""><li id="e775" class="lg lh hi ih b ii ij im in iq li iu lj iy lk jc lu lm ln lo bi translated">在你的浏览器中进入<a class="ae jd" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云控制台</a>，如果你还没有登录的话，请登录。如果这是你第一次使用该控制台，你可能必须同意条款和条件。</li><li id="b633" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc lu lm ln lo bi translated">创建一个新项目，方法是单击页面顶部的下拉菜单(会显示“选择一个项目”或显示一个选定的项目)，然后单击“新建项目”并输入您想要的名称。等待几分钟以创建项目，然后从页面顶部的下拉列表中选择它。</li><li id="2fc8" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc lu lm ln lo bi translated">回到你电脑上的命令行，或者在Cloud Shell中，让Google Cloud构建你的容器:<br/> <code class="du kt ku kv kw b">gcloud builds submit --tag gcr.io/PROJECT-ID/my-program-name</code> <br/>(其中<code class="du kt ku kv kw b">PROJECT-ID</code>是你创建项目时创建的那个，<code class="du kt ku kv kw b">my-program-name</code>是你想用来描述它的任何名字)。回答任何提示——选择应该是清楚的。这将构建您的容器，并将其保存在您控制下的云容器存储库中。</li><li id="4c16" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc lu lm ln lo bi translated">现在将容器部署到云运行:<br/> <code class="du kt ku kv kw b">gcloud beta run deploy \<br/>--image gcr.io/PROJECT-ID/my-program-name \<br/>--platform managed</code> <br/>您可以将命令放在一个很长的行中。如果需要，请删除反斜杠。再次回答显示的任何提示。</li><li id="c534" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc lu lm ln lo bi translated">几分钟后，命令行将显示服务URL。你可以在你的浏览器中打开它，但是记住在它后面加上<code class="du kt ku kv kw b">/number</code>，对于某个十进制数，得到罗马数字版本。</li></ol><p id="eef2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你现在有一个45岁的Pascal程序作为一个无服务器的云应用程序运行。也许你不需要，但是有一天你可能需要一些其他的东西，这些东西有点超出了大多数无服务器平台的支持，但是你可以在容器中完成。那时，云运行将为您带来回报。</p><h2 id="046c" class="jl jm hi bd jn jo jp jq jr js jt ju jv iq jw jx jy iu jz ka kb iy kc kd ke kf bi translated">最后的想法</h2><p id="99df" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">您部署的应用程序的URL将由Google提供，但您可能想要一个更友好的选项。如果你愿意，你可以<a class="ae jd" href="https://cloud.google.com/run/docs/mapping-custom-domains" rel="noopener ugc nofollow" target="_blank">将你的应用连接到你拥有的域名</a>上的一个URL。这有点棘手，但如果你已经建立了自己的域名，这应该不成问题。我做到了，我的罗马数字服务可以在roman.engelke.dev获得，例如<a class="ae jd" href="https://roman.engelke.dev/2345" rel="noopener ugc nofollow" target="_blank">https://roman.engelke.dev/2345</a>。</p><p id="e047" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个例子中，构建容器最慢的部分之一是安装Pascal编译器。我本可以在自己的计算机上编译Pascal程序，并在构建时使用可执行文件而不是文件夹中的源代码。这将让我跳过在容器中安装编译器的步骤。但是因为构建容器很少发生，所以我决定通过编译来确保我的最新源代码总是被使用。</p><p id="e0e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本教程使用完全托管的云运行，让谷歌为你处理所有的工作。但是你也可以部署到在GKE上运行的<a class="ae jd" href="https://cloud.google.com/run/docs/gke/setup" rel="noopener ugc nofollow" target="_blank">云上，无论是在谷歌云平台上还是在你自己的地方，如果这对你的应用程序很重要的话。</a></p></div></div>    
</body>
</html>