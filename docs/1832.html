<html>
<head>
<title>Stream Millions of events from your client to BigQuery in a Serverless way, Part #2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以一种无服务器的方式将数百万个事件从客户机流式传输到BigQuery，第2部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/stream-millions-of-events-from-your-client-to-bigquery-in-a-serverless-way-part-2-d2913ecee763?source=collection_archive---------3-----------------------#2021-03-21">https://medium.com/google-cloud/stream-millions-of-events-from-your-client-to-bigquery-in-a-serverless-way-part-2-d2913ecee763?source=collection_archive---------3-----------------------#2021-03-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9314" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章是另一篇文章的完成:</p><p id="c386" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第1部分:<a class="ae jd" rel="noopener" href="/@abdulrahmanbabil/stream-millions-of-events-from-your-client-to-bigquery-in-a-serverless-way-part-1-a38c4f9cd6e4">构建一个API来接收来自客户端的原始数据，并将其推送到发布/订阅</a></p><p id="aad4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第2部分:运行ETL作业，将事件传输和加载到BigQuery中</strong></p><p id="f3e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以查看<a class="ae jd" href="https://github.com/omegaes/serverless-streaming" rel="noopener ugc nofollow" target="_blank"> Github库</a>来运行/查看-编码这个例子，运行这个例子的全部细节都在那里，只是一个命令！</p></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><h1 id="dfad" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">ETL作业部署</h1><p id="b6e2" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">事件订阅可能有10条消息或1000万条消息，因此作业的数量将根据未完成消息的数量而变化！，在GCP加载后台作业的方式有很多，可以使用云函数、App engine、GKE、云构建、云数据流、计算引擎、云运行。</p><p id="2234" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/dataflow" rel="noopener ugc nofollow" target="_blank"> Cloud Dataflow </a>是ETL的托管解决方案，但是它会限制您使用仅在少数编程语言中可用的<a class="ae jd" href="https://beam.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache beam </a>，但是我在本文中的方法将适用于您喜欢的任何编程语言。</p><p id="139b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于本例，我将使用<strong class="ih hj">云运行，</strong>作业将是一个API调用，将运行&lt; 10分钟，在此期间，它将尽可能多地提取消息，为每条消息进行传输(验证、映射、过滤等)，将这些传输的消息放入(CSV、JSON-LD)中，并调用BigQuery API将这些事件附加到一个表中。</p><p id="b2d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们创建了一个新的<strong class="ih hj">作业云运行</strong>服务，您必须确保这个服务独立于客户端API服务，还要确保只有经过身份验证的脚本才能调用它来执行作业，<strong class="ih hj">API调用的</strong> <strong class="ih hj">超时大约为15分钟</strong>，作业必须在10分钟内完成其工作，因为我们将确认截止时间设置为600秒。 我们将持续从<strong class="ih hj">事件订阅</strong>中提取消息7~8分钟，然后我们将这些事件加载到BigQuery，一旦BigQuery端成功，我们将确认<strong class="ih hj">事件订阅</strong>中所有已处理的消息，因此它不会再次被传递，稍后作业将返回200响应，以确认来自调用订阅的<strong class="ih hj">的消息。 </strong></p><h1 id="7c60" class="jl jm hi bd jn jo ko jq jr js kp ju jv jw kq jy jz ka kr kc kd ke ks kg kh ki bi translated">ETL作业流程</h1><p id="7213" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">提取:客户端的事件现在在事件订阅中，等待转换并加载到最终目的地，ETL作业将在作业运行时提取一批事件，订阅有更多的事件。</p><p id="565b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转换:作业将对每个事件进行所需的转换，如映射、过滤，..等等</p><p id="96e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Load:将一大堆转换后的事件发送到BigQuery中</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div class="er es kt"><img src="../Images/d20d994ff85bd9f53983f1b10b714af6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*El_UzUeaJLe9hm77e8SbwA.png"/></div></figure><h1 id="4455" class="jl jm hi bd jn jo ko jq jr js kp ju jv jw kq jy jz ka kr kc kd ke ks kg kh ki bi translated">ETL加载到BigQuery</h1><blockquote class="lb lc ld"><p id="95e9" class="if ig le ih b ii ij ik il im in io ip lf ir is it lg iv iw ix lh iz ja jb jc hb bi translated">问:如何将转换后的事件数据加载到BigQuery中？</p></blockquote><p id="9865" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">BigQuery有两种加载数据的方式，流式插入和批量加载，对于这个例子，我推荐使用批量加载，比流式插入更便宜，更具可伸缩性，你可以从<a class="ae jd" href="https://cloud.google.com/bigquery/docs/loading-data" rel="noopener ugc nofollow" target="_blank">这里</a>了解加载数据。</p><p id="24c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">批量加载背后的主要思想是创建一个包含数据行的结构化文本文件，并在BigQuery中创建一个作业，将文件中的数据加载到BigQuery表中。</p><p id="3c1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在批量加载中准备事件加载到BigQuery可能需要几秒钟，显然，这将使API变慢！更好的解决方案是将这些事件从API发送到队列服务(Pub/Sub ),然后我们运行作业来处理一大批事件并将其加载到BigQuery中。</p><h1 id="df64" class="jl jm hi bd jn jo ko jq jr js kp ju jv jw kq jy jz ka kr kc kd ke ks kg kh ki bi translated"><strong class="ak"> ETL作业触发</strong></h1><blockquote class="lb lc ld"><p id="9e90" class="if ig le ih b ii ij ik il im in io ip lf ir is it lg iv iw ix lh iz ja jb jc hb bi translated">现在，ETL作业需要从HTTP请求中调用来开始处理，我们该如何做呢？？</p></blockquote><p id="3bd7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1-使用云调度，发送发布/订阅调用消息在一个角落的方式，每5分钟，例如！</p><blockquote class="lb lc ld"><p id="6557" class="if ig le ih b ii ij ik il im in io ip lf ir is it lg iv iw ix lh iz ja jb jc hb bi translated">缺点:</p><p id="3737" class="if ig le ih b ii ij ik il im in io ip lf ir is it lg iv iw ix lh iz ja jb jc hb bi translated">答:如果订阅在一个小时内没有收到消息，作业将运行多次，不会执行任何操作，因此订阅为空。</p><p id="9c05" class="if ig le ih b ii ij ik il im in io ip lf ir is it lg iv iw ix lh iz ja jb jc hb bi translated">b——如果订阅了许多消息，作业实例在一次运行中的处理能力有限，这意味着消息将长时间滞留在订阅中，因为处理能力不会随着负载的增加而增加。</p></blockquote><p id="1ac6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2-使用云监控，监控事件订阅中未交付事件的数量，并根据该数量触发X ETL作业。</p><p id="b032" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以同时使用解决方案#1和解决方案#2，#1将每X分钟进行一次常规ETL，#2将在订阅中的事件快速增长时添加更多ETL作业，这将有助于同时进行并行ETL处理。</p><p id="96b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，事件只能发送一条消息</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es li"><img src="../Images/3d2e546c3e6a272eb115587f0e0e8f82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k_R4K56rnHOD5Y6luvv82w.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">事件订阅的警报策略</figcaption></figure><p id="39da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在事件订阅上添加了一个策略，该策略有很多条件用OR操作符来触发一个事件，事件会向<strong class="ih hj"> invoke topic发送一个Pub/Sub消息，invoke subscription </strong>会发布一个HTTP调用来触发ETL作业，并等待ETL作业完成处理，订阅为空时事件会继续发送invoke消息！</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es li"><img src="../Images/db3e86f3cf46196517110b2991d50f4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qDpPxEY1N6F0r-L_gL3tXg.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">发送用于调用主题的消息数</figcaption></figure><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es lr"><img src="../Images/fcb7fe6d1b8d0b7c8fe52409c711662e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RMOVfSdmVILkxHCuxlVLrw.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">调用ETL后BigQuery中的转换事件</figcaption></figure><h1 id="edfa" class="jl jm hi bd jn jo ko jq jr js kp ju jv jw kq jy jz ka kr kc kd ke ks kg kh ki bi translated">结论</h1><p id="a1a8" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">这是一种处理来自客户端的大数据的方法，这些数据在到达BigQuery之前会延迟几分钟，当您的应用程序收到大量事件时，您可能会面临一些挑战，但请确保总有解决方案！。</p><p id="3a18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想听听你在处理这种情况时的想法和经验，你会使用什么样的技术，构建起来有多难？</p></div></div>    
</body>
</html>