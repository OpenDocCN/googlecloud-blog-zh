<html>
<head>
<title>Automate BigQuery Snapshots at Dataset Level</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在数据集级别自动化大查询快照</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/automate-bigquery-snapshots-at-dataset-level-5ea886d9c1bc?source=collection_archive---------1-----------------------#2022-10-21">https://medium.com/google-cloud/automate-bigquery-snapshots-at-dataset-level-5ea886d9c1bc?source=collection_archive---------1-----------------------#2022-10-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a6af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">由</em> <a class="ae je" href="https://www.linkedin.com/in/franklin-whaite-62075b156/" rel="noopener ugc nofollow" target="_blank">撰写<em class="jd">富兰克林威特</em> </a> <em class="jd">和</em> <a class="ae je" href="https://www.linkedin.com/in/preetikabhateja" rel="noopener ugc nofollow" target="_blank"> <em class="jd">普瑞蒂卡</em> </a></p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/94c618b032aad0cd37371d80fb39df2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6iNnRFKwF9-SC8ezuK2onQ.png"/></div></div></figure></div><div class="ab cl jr js gp jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hb hc hd he hf"><p id="7884" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随着您公司的发展，数据会呈指数级增长，并被用于获取见解以有效运营您的业务。鉴于数据对大多数公司的价值，确保数据的完整性是企业高枕无忧的必要条件。拥有强大的备份和恢复机制对于保护您的数据免遭意外数据丢失大有帮助。在处理用户错误(例如，不小心掉了一张表)时，这一点更加重要。BigQuery提供了一种通过<a class="ae je" href="https://cloud.google.com/bigquery/docs/table-snapshots-intro" rel="noopener ugc nofollow" target="_blank">表快照</a>实现这一点的方法。</p><p id="c2b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前，使用表快照的一个主要挑战是必须对每个表执行快照，并且没有现成的自动化工具。为了解决这个问题，我们开发了一个<a class="ae je" href="https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/tools/cloud_functions/bq_table_snapshots" rel="noopener ugc nofollow" target="_blank">解决方案，在数据集级别调度和自动化</a>表快照。</p></div><div class="ab cl jr js gp jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hb hc hd he hf"><p id="e6a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">什么是快照及其工作原理</strong></p><p id="2b4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">BigQuery表快照是BigQuery提供的实现备份和还原功能的主要机制。表快照是一个持久的只读实体，它保存表(<em class="jd">基表</em>)在给定时间点的状态。您可以保存当前表的快照，或者创建表在过去七天内任何时候的快照。</p><p id="970a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然BigQuery的<a class="ae je" href="https://cloud.google.com/bigquery/docs/time-travel" rel="noopener ugc nofollow" target="_blank">时间旅行</a>也可用于灾难恢复，但该功能仅限于过去7天。大查询表快照提供了更大的灵活性。例如，您可以根据自己的业务需求创建每周、每月、每季度的快照。</p><p id="e02d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就存储而言，快照也具有成本效益。因为BigQuery只对表快照中不再存在于基表中的数据收费。如果您更改或删除了基表中的数据，而这些数据也存在于表快照中，那么您需要为已更改或已删除数据的表快照存储付费。</p></div><div class="ab cl jr js gp jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hb hc hd he hf"><p id="da9f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">解决方案架构</strong></p><p id="d736" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们用一个例子来说明解决方案架构，其中每月为<em class="jd"> dataset_1 </em>中的表创建快照。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jy"><img src="../Images/e76a1422096203f258a31eb467dab94c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5E3gwfszhFKOK-eo6GTTUA.png"/></div></div></figure><p id="1a5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">dataset _ 1 monthly _ snapshot _ scheduler</strong>将每月运行，并触发<em class="jd"> dataset_1 </em>的快照创建过程。发布/订阅消息正文将包含快照创建的参数，如下例所示:</p><pre class="jg jh ji jj fd jz ka kb kc aw kd bi"><span id="aa70" class="ke kf hi ka b fi kg kh l ki kj">{<br/>    "source_dataset_name":"Dataset_1",<br/>    "target_dataset_name":"DATASET_1_MONTHLY_snapshots",<br/>    "crontab_format":"10 * * * *",<br/>    "seconds_before_expiration":2592000,<br/>    "tables_to_include_list":[],<br/>    "tables_to_exclude_list":[]<br/>}</span></pre><p id="410a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">bq _ snapshot s _ list _ tables _ to _ backup _ cf</strong>云函数将获取source_dataset_name <strong class="ih hj">中的所有表名。</strong>然后，它将应用基于tables_to_include_list和tables_to_exclude_list的过滤器来确定范围内的表。最后，它将为每个表提交一条发布/订阅消息。</p><p id="59b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果这两个列表都没有指定，那么数据集中的所有表都将被视为在范围内。如果tables_to_include_list不为空，则只有该列表中数据集中的表才会在范围内。如果tables_to_exclude_list不为空，则数据库中的所有表都将在范围内，除了此列表中的表。</p><p id="7b4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">bq _ snapshot _ create _ snapshot _ cf</strong>云函数将提交一个BigQuery作业，为范围内的每个表创建一个快照。这个云函数将在快照名称后面加上快照日期时间，以保证名称的唯一性。它还会根据到期前的秒数来计算和设置快照的到期时间。最后，它将根据crontab_format确定快照时间。</p><p id="1503" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果<em class="jd"> dataset_1 </em>有500个表，则发送500条Pub/Sub消息，执行500次云函数调用。如果云函数在创建快照时使用当前时间，那么这500个快照将代表不同的时间点。为了避免这种情况，云函数将为表创建快照，就像云调度程序作业(<strong class="ih hj">dataset _ 1 monthly _ snapshot _ Scheduler</strong>)被触发时一样。为此，云函数将基于crontab_format计算之前的时间间隔。</p><p id="cc5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">您为什么应该使用该解决方案？</strong></p><ul class=""><li id="73af" class="kk kl hi ih b ii ij im in iq km iu kn iy ko jc kp kq kr ks bi translated"><strong class="ih hj">任意数量的数据集— </strong>这对于正在经历数据增长的大型组织尤其有用，因为只需添加一个新的云调度程序作业，就可以添加新的数据集。</li><li id="da33" class="kk kl hi ih b ii kt im ku iq kv iu kw iy kx jc kp kq kr ks bi translated"><strong class="ih hj">任意频率— </strong>用户可以通过更改crontab_format计划来指定所需的快照频率(例如，每天、每周、每月)。</li><li id="a1ee" class="kk kl hi ih b ii kt im ku iq kv iu kw iy kx jc kp kq kr ks bi translated"><strong class="ih hj">针对所选的表格进行定制— </strong>通过轻松更改触发消息正文，可以轻松包含和排除特定表格，并轻松指定快照持续时间。</li></ul><p id="993b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">从哪里开始</strong></p><p id="e8ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用<a class="ae je" href="https://cloud.google.com/blog/products/bigquery/try-google-bigquery-today-now-with-10gb-of-free-storage" rel="noopener ugc nofollow" target="_blank"> BigQuery </a>用您今天的数据尝试<a class="ae je" href="https://cloud.google.com/bigquery/docs/table-snapshots-intro" rel="noopener ugc nofollow" target="_blank"> BigQuery表快照</a>。一旦您准备好了一些表，您就可以前往<a class="ae je" href="https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/tools/cloud_functions/bq_table_snapshots" rel="noopener ugc nofollow" target="_blank">这个存储库</a>并测试解决方案，以便在一个定制的时间表下一次运行中为几个表自动创建表快照。</p></div><div class="ab cl jr js gp jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hb hc hd he hf"><h1 id="1b9e" class="ky kf hi bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">承认</h1><p id="e963" class="pw-post-body-paragraph if ig hi ih b ii lv ik il im lw io ip iq lx is it iu ly iw ix iy lz ja jb jc hb bi translated">感谢那些让这篇文章成为可能的人:</p><ul class=""><li id="cf28" class="kk kl hi ih b ii ij im in iq km iu kn iy ko jc kp kq kr ks bi translated">Aakash Bordia </li><li id="781a" class="kk kl hi ih b ii kt im ku iq kv iu kw iy kx jc kp kq kr ks bi translated"><a class="ae je" href="https://www.linkedin.com/in/yanlongsun2018/" rel="noopener ugc nofollow" target="_blank">孙燕龙</a></li><li id="04fe" class="kk kl hi ih b ii kt im ku iq kv iu kw iy kx jc kp kq kr ks bi translated"><a class="ae je" href="https://www.linkedin.com/in/daniel-deleo/" rel="noopener ugc nofollow" target="_blank">丹尼·德·利奥</a></li><li id="3ae1" class="kk kl hi ih b ii kt im ku iq kv iu kw iy kx jc kp kq kr ks bi translated"><a class="ae je" href="https://www.linkedin.com/in/akshya-sharma/" rel="noopener ugc nofollow" target="_blank">阿克希亚·夏尔马</a></li><li id="6caa" class="kk kl hi ih b ii kt im ku iq kv iu kw iy kx jc kp kq kr ks bi translated"><a class="ae je" href="https://www.linkedin.com/in/anasaslam/" rel="noopener ugc nofollow" target="_blank">阿纳斯阿斯拉姆</a></li></ul></div></div>    
</body>
</html>