<html>
<head>
<title>Squash Java Linkage Bugs Before They Bite</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Java链接错误咬人之前消灭它们</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/squash-java-linkage-bugs-before-they-bite-92af79e31bfd?source=collection_archive---------2-----------------------#2020-03-23">https://medium.com/google-cloud/squash-java-linkage-bugs-before-they-bite-92af79e31bfd?source=collection_archive---------2-----------------------#2020-03-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b135" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个典型的现代Java项目依赖于许多库，每个库又依赖于多个库。有些依赖关系在完全传递依赖图中出现多次，有些只出现一次。有时重复库的版本是相同的。通常它们并不一致，当它们不一致时，程序可能会失败。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/8b9977f498a7ffb1f568781064ab333a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T3RR80PizgDZ-AbP9dhzgA.jpeg"/></div></figure><p id="9b75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，<code class="du jl jm jn jo b"><strong class="ih hj">org.apache.beam:beam-sdks-java-io-cassandra</strong></code>可能调用Guava 20中的方法，而<code class="du jl jm jn jo b"><strong class="ih hj">com.google.cloud:google-cloud-firestore</strong></code>调用Guava 28中该方法的重命名版本。声明两者的依赖关系会引入隐藏的不兼容性，因为类路径只能包含一个版本的Guava。即使<code class="du jl jm jn jo b"><strong class="ih hj">com.google.cloud:google-cloud-firestore</strong></code>根本不调用重命名的方法，它仍然可以通过换入Guava 28而不是20(Cassandra需要的版本)意外地破坏Cassandra。这种库之间的不兼容被称为<em class="jp">链接错误</em>，因为其中一个库在运行时链接到了不兼容的Guava版本。像这样的问题通常表现为运行时异常，比如<code class="du jl jm jn jo b"><strong class="ih hj">NoSuchMethodError</strong></code>、<code class="du jl jm jn jo b"><strong class="ih hj">NoClassDefFoundError</strong></code>、<code class="du jl jm jn jo b"><strong class="ih hj">IllegalAccessError</strong></code>等等。</p><p id="5129" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Maven Enforcer插件已经提供了几种策略来减少链接错误，包括要求上限和依赖性收敛。上限检查对于修复在较新版本的库中添加了方法的情况很有用，但当问题是方法已被移除时，上限检查会失败。依赖收敛是避免链接错误的黄金标准，但是在由来自许多独立团队的许多库组成的复杂项目中很难实现。</p><p id="0216" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">链接检查器Enforcer规则是Maven Enforcer插件可以应用于项目的新规则。当完全的依赖收敛是不可能的时候，这是特别有用的。此规则检查项目的整个类路径，并报告所有链接错误。例如，在下面的项目中，gRPC中的<code class="du jl jm jn jo b"><strong class="ih hj">JettyNpnSslEngine</strong></code>类应该链接到Jetty中的<code class="du jl jm jn jo b"><strong class="ih hj">NextProtoNego</strong></code>类，但后者实际上并不在类路径中:</p><pre class="je jf jg jh fd jq jo jr js aw jt bi"><span id="5d9d" class="ju jv hi jo b fi jw jx l jy jz">$ mvn verify<br/>[INFO] - - maven-enforcer-plugin:3.0.0-M3:enforce (enforce-linkage-checker) @ google-cloud-core-grpc - -<br/>[ERROR] Linkage Checker rule found 21 reachable errors. Linkage error report:<br/>Class org.eclipse.jetty.npn.NextProtoNego is not found; referenced by 1 class file<br/>io.grpc.netty.shaded.io.netty.handler.ssl.JettyNpnSslEngine (grpc-netty-shaded-1.23.0.jar)<br/>…</span></pre><p id="a94a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个特殊问题是由不完整的着色引起的，这是链接错误的一个非常常见的来源。</p><p id="941a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">链接错误是否会在运行时导致问题取决于程序遵循的代码路径。这些问题可能潜伏数月未被发现，然后在生产中意外出现。您的程序可能永远不会调用带有链接错误的方法。另一方面，如果依赖于您的项目的另一个项目调用了这个方法，他们将会得到一个令人讨厌的惊喜。像这样的问题调试起来很困难，很昂贵，也很耗时。链接检查器Enforcer规则在开发周期的更早阶段就揭示了这些问题，那时修复它们更容易、更便宜。</p><p id="a50c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要检查Maven项目中的链接，将这个<code class="du jl jm jn jo b"><strong class="ih hj">plugin</strong></code>元素添加到pom.xml:</p><pre class="je jf jg jh fd jq jo jr js aw jt bi"><span id="142e" class="ju jv hi jo b fi jw jx l jy jz">&lt;plugin&gt;<br/>  &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>  &lt;artifactId&gt;maven-enforcer-plugin&lt;/artifactId&gt;<br/>  &lt;version&gt;3.0.0-M3&lt;/version&gt;<br/>  &lt;dependencies&gt;<br/>    &lt;dependency&gt;<br/>      &lt;groupId&gt;com.google.cloud.tools&lt;/groupId&gt;<br/>      &lt;artifactId&gt;linkage-checker-enforcer-rules&lt;/artifactId&gt;<br/>      &lt;version&gt;1.1.4&lt;/version&gt;<br/>    &lt;/dependency&gt;<br/>  &lt;/dependencies&gt;<br/>  &lt;executions&gt;<br/>    &lt;execution&gt;<br/>      &lt;id&gt;enforce-linkage-checker&lt;/id&gt;<br/>      &lt;phase&gt;verify&lt;/phase&gt;<br/>      &lt;goals&gt;<br/>        &lt;goal&gt;enforce&lt;/goal&gt;<br/>      &lt;/goals&gt;<br/>      &lt;configuration&gt;<br/>        &lt;rules&gt;<br/>          &lt;LinkageCheckerRule implementation= "com.google.cloud.tools.dependencies.enforcer.LinkageCheckerRule"&gt;<br/>            &lt;level&gt;WARN&lt;/level&gt;<br/>          &lt;/LinkageCheckerRule&gt;<br/>        &lt;/rules&gt;<br/>      &lt;/configuration&gt;<br/>    &lt;/execution&gt;<br/>  &lt;/executions&gt;<br/>&lt;/plugin&gt;</span></pre><p id="d4f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在<strong class="ih hj"> mvn verify </strong>警告你项目中的所有链接错误:缺少类、从另一个类调用私有方法、带有意外数量参数的方法等等。如果您希望在检测到链接错误时构建完全失败，请将级别设置为error。</p><p id="e8f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于链接检查的更多细节可以在<a class="ae ka" href="https://github.com/GoogleCloudPlatform/cloud-opensource-java/wiki/Linkage-Checker-Enforcer-Rule" rel="noopener ugc nofollow" target="_blank">规则的Wiki </a>上找到。您可能还会对我们发布的管理Java库依赖关系的<a class="ae ka" href="https://jlbp.dev/" rel="noopener ugc nofollow" target="_blank">最佳实践</a>感兴趣。</p><p id="7662" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了最简单的Java项目之外，链接错误是所有项目的主要问题。链接检查器Enforcer规则提供了一种及早发现这些问题并在需要进行困难的调试之前修复它们的方法。</p></div></div>    
</body>
</html>