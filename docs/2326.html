<html>
<head>
<title>Dynamically Load Data to any BigQuery Table from GCS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从GCS向任何BigQuery表动态加载数据</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/dynamically-load-data-to-any-bigquery-table-from-gcs-835a6525afef?source=collection_archive---------0-----------------------#2022-08-25">https://medium.com/google-cloud/dynamically-load-data-to-any-bigquery-table-from-gcs-835a6525afef?source=collection_archive---------0-----------------------#2022-08-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="ecc6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如何将数百个表从GCS加载到BigQuery？</p><p id="b286" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">也许，你会使用一些python脚本，像Dataflow或Cloud DataFusion这样的ETL工具。</p><p id="ebf6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，你会发现；如何使用Composer和一个动态DAG从GCS加载任何BQ表:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/4001d51c7afadc6db2bdcbdc81033a4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mlygrJRygMzNB9Z5jter7g.png"/></div></div></figure><blockquote class="jp jq jr"><p id="5599" class="if ig js ih b ii ij ik il im in io ip jt ir is it ju iv iw ix jv iz ja jb jc hb bi translated">在进入细节之前，下面是只使用Composer和BQ Load加载表的一些好处:</p><p id="8df9" class="if ig js ih b ii ij ik il im in io ip jt ir is it ju iv iw ix jv iz ja jb jc hb bi translated">1- BQ加载是免费的——如果您使用数据流/云数据融合或任何ETL工具将数据原样加载到BigQuery，您需要为计算付费。搜索ETL vs ELT，如果你觉得在加载的时候需要一些转换。</p><p id="77ad" class="if ig js ih b ii ij ik il im in io ip jt ir is it ju iv iw ix jv iz ja jb jc hb bi translated">2-它是快速和并行的—它是完全管理的，您不需要担心调整您的管道。</p><p id="10e4" class="if ig js ih b ii ij ik il im in io ip jt ir is it ju iv iw ix jv iz ja jb jc hb bi translated">3- Composer非常灵活——您拥有python的灵活性和大量开源气流操作器，同时还拥有监控和控制管道所需的许多企业功能。此外，您还可以与其他平台(如数据流、数据融合、基本上任何API)协调和组合任务。</p></blockquote></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><p id="803e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要气流的两个关键能力来构建我们的动态管道；</p><p id="10ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1-参数和触发DAG w/ config</p><p id="ee4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2- XCOM在任务间共享数据</p><p id="779f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要获得源CSV文件和目标BigQuery表作为参数。您可以使用python运算符和python函数来获取这些变量。然后您需要将这些放入xcom变量中，以便BigQuery加载任务可以使用它们。</p><p id="6394" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它看起来是这样的:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="5193" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来我们需要使用GoogleCloudStorageToBigQueryOperator来调用bqload。这里我们将把xcom变量传递给source_objects和destination _ project _ dataset _ table输入。它看起来是这样的:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="18e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能会注意到，我们使用环境变量{{var.value.X}}来定义存储桶和数据集。使用环境变量来配置开发、测试和生产环境是很重要的，因此您不需要为每个环境更改代码。</p><p id="27e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在Airflow UI中的管理&gt;变量下定义环境变量:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kf"><img src="../Images/679cc87ab6ad1c980fda89b6205e28ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-jE2HdR0hWPHDPEUPfdBBg.png"/></div></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kg"><img src="../Images/591d06c5feff3ca7b57ca55c5cbe0a10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TAg915ow30DWoHLAa5wgTg.png"/></div></div></figure><p id="d528" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是了，现在你所需要做的就是触发你的管道配置；</p><pre class="je jf jg jh fd kh ki kj kk aw kl bi"><span id="a7f0" class="km kn hi ki b fi ko kp l kq kr"> {"TargetTable":"table1","SourceCSV":"table1.csv"}</span></pre><p id="9655" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以通过gcloud cmd来做；</p><pre class="je jf jg jh fd kh ki kj kk aw kl bi"><span id="ea73" class="km kn hi ki b fi ko kp l kq kr">gcloud composer environments run composer-name --location=europe-west3 dags trigger -- initial_load_parametric \</span><span id="dfa8" class="km kn hi ki b fi ks kp l kq kr">--conf '{"TargetTable":"table1","SourceCSV":"table1.csv"}</span></pre><p id="7841" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者通过气流UI；</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kt"><img src="../Images/5e9820dd723bd33773f4a55ea8565058.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ugrCcQa-5DFfK0AITwChGg.png"/></div></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ku"><img src="../Images/f69fbcb2f82c8dc605ce69edccdd1937.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cfB2v9KPPxe8Lp2K4JpnFg.png"/></div></div></figure></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><p id="d050" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是这个DAG的完整源代码:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/4001d51c7afadc6db2bdcbdc81033a4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mlygrJRygMzNB9Z5jter7g.png"/></div></div></figure><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="d268" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望你觉得它有用，请让我知道你的想法，以及你如何在评论中加载你的BigQuery表。</p></div></div>    
</body>
</html>