<html>
<head>
<title>How to assume multiple AWS Roles from a GCP Service Account, keyless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从GCP无钥匙服务帐户承担多个AWS角色</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-assume-multiple-aws-roles-from-a-gcp-service-account-keyless-595a978eee7b?source=collection_archive---------1-----------------------#2022-11-27">https://medium.com/google-cloud/how-to-assume-multiple-aws-roles-from-a-gcp-service-account-keyless-595a978eee7b?source=collection_archive---------1-----------------------#2022-11-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="04e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">包括了安全最佳实践“不要带备用密钥”</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/2814bc737bc1c7ee5906bc4955f9988e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gFToEkKcSmnlFEMKjpE3eA.jpeg"/></div></div></figure><h1 id="f15f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="a5bc" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">本文展示了如何将一个GCP服务帐户集成到多个AWS角色，而无需在任何地方存储sa密钥。</p><h1 id="d9fb" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">开始</h1><p id="4ad0" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">从现在起的几个月甚至未来几年，您将需要连接来自不同云提供商的不同基础架构组件。几周前，我遇到了一个客户的问题，他想将一些数据从S3存储桶转移到GCP一个测试组织内新创建的GCS存储桶。</p><p id="efc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">没有比这更容易的了，这是我最初的想法。</p><p id="5c2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">即使这看起来是一个容易实现的任务，但构建一个<strong class="ih hj">安全的工作流</strong>也不是一件小事。我对此提出的要求是，我不想负责在某个地方存储(然后维护)一些访问/秘密密钥，也不想创建AWS帐户和角色。</p><p id="eec4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">换句话说，我希望能够将文件从S3传输到GCS存储桶，而无需将AWS凭证存储在AWS之外的某个地方。</strong></p><p id="ac83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我应该如何进行？我当然有不同的选择，实际上有不同的方法来存储和处理密钥，但我的目标是在两个提供者之间有一个总的区别，从第一个(AWS)不应该被存储到目的地之一，GCP。</p><p id="47a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我相信，在一个可信实体的基础上创建AWS角色的可能性这是一个解决问题的好方法，与网络身份提供商(在我们的情况下是谷歌)相关的可信身份无疑是一条出路。</p><p id="3b42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">工作流程如下所示:</p><blockquote class="ks kt ku"><p id="cf92" class="if ig kv ih b ii ij ik il im in io ip kw ir is it kx iv iw ix ky iz ja jb jc hb bi translated">1.创建一个GCP服务帐户，并获取唯一的ID。</p><p id="8449" class="if ig kv ih b ii ij ik il im in io ip kw ir is it kx iv iw ix ky iz ja jb jc hb bi translated">2.在现有的AWS帐户中创建一个AWS角色，并将受信任的实体类型设置为<strong class="ih hj"> Web Identity </strong>，选择Google作为提供者，并将GCP SA唯一ID粘贴到“受众”文本框中。</p><p id="f04a" class="if ig kv ih b ii ij ik il im in io ip kw ir is it kx iv iw ix ky iz ja jb jc hb bi translated">2.分配所需的权限以完成创建。</p></blockquote><h1 id="4691" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">由于帐户连接，我们现在能够使用GCP SA来请求临时AWS凭证，并使用这些凭证来承担AWS角色。</h1><p id="68fa" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">Avi Keinan写了一篇关于<a class="ae kz" href="https://www.doit-intl.com/assume-an-aws-role-from-a-google-cloud-without-using-iam-keys/" rel="noopener ugc nofollow" target="_blank">在不使用IAM键</a>的情况下承担来自Google Cloud的AWS角色的精彩帖子，感谢Avi的灵感！</p><p id="2467" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们有一个与GCP SA <strong class="ih hj">相关的AWS角色。</strong>接下来是什么？</p><h1 id="d0c1" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">真实案例</h1><p id="5b54" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated"><strong class="ih hj">回到使用案例，有一件事我之前没有提到，在我面对的真实场景中，AWS角色实际上是两个，而不是一个。</strong></p><p id="0487" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一个AWS角色应该用于承担第二个AWS角色的身份，第二个AWS角色具有访问S3存储桶的特定权限。</p><p id="f159" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我们需要从GCP服务帐户承担一个AWS角色，然后使用第一个AWS角色临时凭证承担第二个角色，这是唯一一个有权限访问S3存储桶的角色。棘手但也是一个有趣的挑战。</p><p id="0877" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我写了一个简单的Golang应用程序，可以通过<a class="ae kz" href="https://github.com/GoogleCloudPlatform/professional-services" rel="noopener ugc nofollow" target="_blank">Google professional services github repository</a>获得，它将为我们提供两个AWS角色，一个是作为来自GCP服务帐户 的<a class="ae kz" href="https://github.com/GoogleCloudPlatform/professional-services/tree/main/tools/gcp-sa-to-assume-aws-arn-role" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> AWS角色之间连接的一部分，另一个是执行最终任务。</strong></a></p><pre class="je jf jg jh fd la lb lc bn ld le bi"><span id="3fa2" class="lf jq hi lb b be lg lh l li lj">//getAWSWebIdentityServiceCreds function to assume the Service Role once the identity creds have been retrieved<br/>func getAWSWebIdentityServiceCreds(webIDcreds *sts.Credentials, role string) (*sts.AssumeRoleOutput, error) {accessKey := *webIDcreds.AccessKeyId<br/> secretKey := *webIDcreds.SecretAccessKey<br/> accessToken := *webIDcreds.SessionToken<br/> sess, err := session.NewSession(&amp;aws.Config{<br/>  Credentials: credentials.NewStaticCredentials(accessKey, secretKey, accessToken),<br/> })<br/> if err != nil {<br/>  fmt.Println("NewSession Error", err)<br/>  return nil, err<br/> }<br/> svc := sts.New(sess)<br/> roleToAssumeArn := role<br/> sessionName := "gcp_session"<br/> result, err := svc.AssumeRole(&amp;sts.AssumeRoleInput{<br/>  RoleArn:         &amp;roleToAssumeArn,<br/>  RoleSessionName: &amp;sessionName,<br/> })<br/> if err != nil {<br/>  fmt.Println("AssumeRole Error", err)<br/>  return nil, err<br/> }<br/> return result, nil<br/>}</span></pre><p id="8c08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">即使深入研究代码可能很有趣，并且是一个试验一些Go代码甚至改进它的机会，因为它肯定不是完美的，它已经准备好被使用了。</p><p id="bcff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">gcp-auth文件夹下的代码一旦编译，将接受两个参数作为输入，一个身份ARN角色和一个服务ARN角色。应该从GCP服务帐户使用身份ARN来对AWS IAM APIs进行身份验证，而一旦采用了身份ARN，服务ARN就会用来对S3进行API调用。</p><p id="0b51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了完成这个过程，应该将一个默认的AWS凭证(如下所示)文件放在将使用二进制文件调用AWS的对象(VM、容器等)中:</p><pre class="je jf jg jh fd la lb lc bn ld le bi"><span id="7116" class="lf jq hi lb b be lg lh l li lj">[default]<br/>credential_process = /usr/local/bin/gcp-auth --env=true</span></pre><p id="bd30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如示例所示，输入ARNs也可以作为环境变量提供，这将确保最终设置期间的更大安全性。</p><pre class="je jf jg jh fd la lb lc bn ld le bi"><span id="ac6c" class="lf jq hi lb b be lg lh l li lj">export GCP_AUTH_IDENTITY=arn:aws:iam::000000000:role/external-gcp-auth<br/>export GCP_AUTH_SERVICE=arn:aws:iam::000000000:role/access-to-s3-from-gcp</span></pre><p id="24e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我们在本文中看到的，请记住还有最后一步要做，将我们的GCP服务帐户连接到AWS S3 ARN。</p><p id="9da1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在创建AWS ARN的过程中，可以将其指定为可信身份，选择Web身份，然后选择Google。通过将GCP SA唯一ID粘贴到观众框中，最后一步就完成了。</p><p id="254d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望你喜欢这篇文章，我真的期待听到你的反馈！</p></div></div>    
</body>
</html>