<html>
<head>
<title>Cloud Spanner Emulator</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云扳手仿真器</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-spanner-emulator-bf12d141c12?source=collection_archive---------1-----------------------#2020-04-09">https://medium.com/google-cloud/cloud-spanner-emulator-bf12d141c12?source=collection_archive---------1-----------------------#2020-04-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/ab8ebf0c71d18950cba0aac614fa2370.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YJxqJzSWCkPCrb5q3MLUJQ.png"/></div></div></figure><div class=""/><p id="70fc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Cloud Spanner在2017年推出后，在几个不同的行业和垂直领域都有大量的客户采用。随着这种增长，我们已经使用Cloud Spanner建立了一个大型的应用程序开发人员社区。为了让这项服务对更广泛的开发者社区更加开放，我们引入了一个Cloud Spanner服务的离线模拟器。Cloud Spanner模拟器旨在为客户降低应用程序开发成本，提高开发人员的工作效率。</p><p id="126a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Cloud Spanner emulator为应用程序开发人员提供了全套API，包括广泛的SQL和DDL特性，可以在本地运行以进行原型开发、开发和测试。这个开源仿真器将为应用程序开发人员提供透明性和灵活性，以便为他们的应用程序定制工具。</p><p id="45a5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这篇博客介绍了Cloud Spanner模拟器，并将指导您使用现有的Cloud Spanner CLI和客户端库安装和使用模拟器。</p><h1 id="1fcc" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">什么是云扳手模拟器？</h1><p id="7593" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">云扳手仿真器提供了云扳手服务的本地、内存中的高保真仿真器。您可以使用仿真器在本地和集成测试环境中原型化、开发和密封测试您的应用程序。</p><p id="2df2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为仿真程序将数据存储在内存中，所以它不会在运行期间保存数据。该模拟器旨在帮助您使用Cloud Spanner进行本地开发和测试，而不是用于生产部署。但是，一旦您的应用程序与模拟器一起工作，您就可以通过简单地更改Cloud Spanner端点配置来继续对您的应用程序进行端到端测试。</p><h1 id="168b" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">支持的功能</h1><p id="272e" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">Cloud Spanner模拟器公开了一整套Cloud Spanner APIs，包括实例、数据库、SQL、DML、DDL、会话和事务语义。通过<a class="ae kr" href="https://cloud.google.com/spanner/docs/information-schema" rel="noopener ugc nofollow" target="_blank">信息模式</a>可以支持查询数据库的模式元数据。<a class="ae kr" href="https://cloud.google.com/spanner/docs/reference/rpc" rel="noopener ugc nofollow" target="_blank"> gRPC </a>和<a class="ae kr" href="https://cloud.google.com/spanner/docs/reference/rest" rel="noopener ugc nofollow" target="_blank">REST</a>API都得到支持，可以与现有的<a class="ae kr" href="https://cloud.google.com/spanner/docs/reference/libraries" rel="noopener ugc nofollow" target="_blank">客户端库</a>、<a class="ae kr" href="https://cloud.google.com/spanner/docs/use-oss-jdbc" rel="noopener ugc nofollow" target="_blank"> OSS JDBC驱动</a>以及<a class="ae kr" href="https://cloud.google.com/sdk/gcloud/reference/spanner" rel="noopener ugc nofollow" target="_blank"> Cloud SDK </a>一起使用。该仿真器在Linux上被本地支持，并且在MacOS和Windows平台上需要<a class="ae kr" href="https://www.docker.com/products/docker-desktop" rel="noopener ugc nofollow" target="_blank"> Docker </a>。为了简化应用程序的开发和测试，IntelliJ和Eclipse等ide可以配置为直接与Cloud Spanner仿真器端点通信。</p><p id="0eb8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">模拟器不是为生产规模和性能而构建的，因此不应用于负载测试或生产流量。应用程序开发人员可以使用模拟器进行迭代开发，并实现和运行单元测试和集成测试。</p><p id="5fb3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Cloud Spanner emulator <a class="ae kr" href="https://github.com/GoogleCloudPlatform/cloud-spanner-emulator/blob/master/README.md#technical-details" rel="noopener ugc nofollow" target="_blank">自述文件</a>中提供了详细的特性和限制列表。该模拟器目前(截至2020年4月)处于测试版，并将继续增强功能和API与云扳手服务的对等性。</p><h1 id="ff81" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">使用云扳手模拟器</h1><p id="82fa" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">本节描述使用现有的Cloud Spanner CLI和客户端库与仿真器进行交互。</p><h1 id="37fb" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">开始之前</h1><ul class=""><li id="1c92" class="ks kt ht is b it km ix kn jb ku jf kv jj kw jn kx ky kz la bi translated">安装<a class="ae kr" href="https://cloud.google.com/sdk/docs/" rel="noopener ugc nofollow" target="_blank">云SDK </a></li><li id="d506" class="ks kt ht is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">配置<a class="ae kr" href="https://cloud.google.com/sdk/gcloud/reference/auth/application-default/login" rel="noopener ugc nofollow" target="_blank"> gcloud凭证</a></li><li id="f8eb" class="ks kt ht is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">如果使用MacOS或Windows，安装<a class="ae kr" href="https://www.docker.com/products/docker-desktop" rel="noopener ugc nofollow" target="_blank"> Docker </a></li></ul><h1 id="3928" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">本地启动模拟器</h1><p id="0324" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">模拟器可以在Linux、MacOS和Windows上使用Docker或使用Cloud SDK CLI启动。无论哪种情况，MacOS和Windows都需要安装docker 。</p><h1 id="8139" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">码头工人</h1><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="bce3" class="lp jp ht ll b fi lq lr l ls lt">$ docker pull gcr.io/cloud-spanner-emulator/emulator<br/>$ docker run -p 9010:9010 -p 9020:9020 gcr.io/cloud-spanner-emulator/emulator</span></pre><p id="af79" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:第一个端口是gRPC端口，第二个端口是REST端口。</p><h1 id="abb9" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">云SDK CLI</h1><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="d1b0" class="lp jp ht ll b fi lq lr l ls lt">$ gcloud components update<br/>$ gcloud emulators spanner start</span></pre><p id="ec77" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">启动模拟器的其他选择，包括预建的linux二进制文件，在这里<a class="ae kr" href="https://github.com/GoogleCloudPlatform/cloud-spanner-emulator/blob/master/README.md#quickstart" rel="noopener ugc nofollow" target="_blank">列出</a>。</p><h1 id="5c98" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">设置云扳手项目和实例</h1><p id="421a" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">配置云扳手端点、项目和禁用身份验证:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="9c5c" class="lp jp ht ll b fi lq lr l ls lt">$ gcloud config configurations create emulator<br/>$ gcloud config set auth/disable_credentials true<br/>$ gcloud config set project test-project<br/>$ gcloud config set api_endpoint_overrides/spanner <a class="ae kr" href="http://localhost:9020/" rel="noopener ugc nofollow" target="_blank">http://localhost:9020/</a></span><span id="3f60" class="lp jp ht ll b fi lu lr l ls lt"><br/># Verify gCloud is working with the Cloud Spanner Emulator.<br/>$ gcloud spanner instance-configs list</span><span id="927a" class="lp jp ht ll b fi lu lr l ls lt">NAME            DISPLAY_NAME<br/>emulator-config Emulator Instance Config</span><span id="489a" class="lp jp ht ll b fi lu lr l ls lt"><br/># Create a Cloud Spanner Instance<br/>$ gcloud spanner instances create test-instance --config=emulator-config --description=”Test Instance” --nodes=1</span></pre><p id="28e5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lv">注</em>:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="ab71" class="lp jp ht ll b fi lq lr l ls lt"># To switch back to the default config:<br/>$ gcloud config configurations activate default</span><span id="cd83" class="lp jp ht ll b fi lu lr l ls lt"># To switch back to the emulator config:<br/>$ gcloud config configurations activate emulator</span></pre><h1 id="fb0b" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">使用云扳手客户端库</h1><p id="226b" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">有了beta午餐，支持Java、Go和C++ Cloud Spanner客户端库的最新版本与仿真器交互。使用<a class="ae kr" href="https://cloud.google.com/spanner/docs/tutorials" rel="noopener ugc nofollow" target="_blank">入门指南</a>试用模拟器。</p><p id="5819" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是一个使用模拟器运行Java客户端库的示例:</p><p id="c3cc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> <em class="lv">先决条件</em> </strong>:从上一步开始设置云扳手项目和实例。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="a694" class="lp jp ht ll b fi lq lr l ls lt"># Configure emulator endpoint<br/>$ export SPANNER_EMULATOR_HOST=”localhost:9010"</span><span id="f62c" class="lp jp ht ll b fi lu lr l ls lt"># Cloning java sample of client library.<br/>$ git clone <a class="ae kr" href="https://github.com/GoogleCloudPlatform/java-docs-samples" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/java-docs-samples</a> &amp;&amp; cd java-docs-samples/spanner/cloud-client<br/>$ mvn package</span><span id="9d74" class="lp jp ht ll b fi lu lr l ls lt"># Create database<br/>$ java -jar target/spanner-google-cloud-samples-jar-with-dependencies.jar createdatabase test-instance example-db</span><span id="8a92" class="lp jp ht ll b fi lu lr l ls lt"># Write into database<br/>$ java -jar target/spanner-google-cloud-samples-jar-with-dependencies.jar write test-instance example-db</span><span id="d56b" class="lp jp ht ll b fi lu lr l ls lt"># Query from database<br/>$ java -jar target/spanner-google-cloud-samples-jar-with-dependencies.jar query test-instance example-db</span></pre><p id="cb8f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用<a class="ae kr" href="https://cloud.google.com/spanner/docs/getting-started/java#create_a_database" rel="noopener ugc nofollow" target="_blank">入门指南</a>遵循Java客户端库示例的其余部分。</p><h1 id="7f33" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">使用云SDK CLI</h1><p id="7440" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated"><strong class="is hu"> <em class="lv">先决条件</em> </strong>:从上一步开始设置云扳手项目和实例。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="806a" class="lp jp ht ll b fi lq lr l ls lt"># Configure emulator endpoint<br/>$ gcloud config configurations activate emulator</span><span id="67f1" class="lp jp ht ll b fi lu lr l ls lt"># Create a database<br/>$ gcloud spanner databases create test-database --instance test-instance --ddl “CREATE TABLE TestTable (Key INT64, Value STRING(MAX)) PRIMARY KEY (Key)”</span><span id="0b63" class="lp jp ht ll b fi lu lr l ls lt"># Write into database<br/>$ gcloud spanner rows insert --table=TestTable --database=test-database --instance=test-instance --data=Key=1,Value=TestValue1</span><span id="a3e8" class="lp jp ht ll b fi lu lr l ls lt"># Read from database<br/>$ gcloud spanner databases execute-sql test-database --instance test-instance --sql “select * from TestTable”</span></pre><h1 id="fd15" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">使用开源命令行工具spanner-cli</h1><p id="e2e1" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">使用<a class="ae kr" href="https://github.com/cloudspannerecosystem/spanner-cli#example" rel="noopener ugc nofollow" target="_blank"> spanner-cli </a>对云Spanner数据库进行交互式提示。</p><p id="e66b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> <em class="lv">先决条件</em> </strong>:从上一步开始设置云扳手项目、实例和数据库。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="adb8" class="lp jp ht ll b fi lq lr l ls lt"># Configure emulator endpoint<br/>$ export SPANNER_EMULATOR_HOST=”localhost:9010"</span><span id="2032" class="lp jp ht ll b fi lu lr l ls lt"># Start the spanner-cli<br/>$ go get github.com/cloudspannerecosystem/spanner-cli<br/>$ go run github.com/cloudspannerecosystem/spanner-cli -p test-project -i test-instance -d test-database</span><span id="b11e" class="lp jp ht ll b fi lu lr l ls lt">spanner&gt; INSERT INTO TestTable (Key, Value) VALUES (2, “TestValue2”), (3, “TestValue3”);<br/>Query OK, 2 rows affected</span><span id="dc13" class="lp jp ht ll b fi lu lr l ls lt">spanner&gt; SELECT * FROM TestTable ORDER BY Key ASC;<br/>+ — — -+ — — — — — — — — +<br/>| Key  | Value           |<br/>+ — — -+ — — — — — — — — +<br/>| 2    | TestValue2      |<br/>| 3    | TestValue3      |<br/>+ — — -+ — — — — — — — — +<br/>2 rows in set</span><span id="1b08" class="lp jp ht ll b fi lu lr l ls lt">spanner&gt; exit;</span></pre><h1 id="a6f3" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">结论</h1><p id="df7f" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">Cloud Spanner emulator降低了应用开发成本，提高了Cloud Spanner客户的开发效率。我们计划继续构建和支持客户要求的功能，您可以通过GitHub上的<a class="ae kr" href="https://github.com/GoogleCloudPlatform/cloud-spanner-emulator" rel="noopener ugc nofollow" target="_blank"> Cloud Spanner emulator </a>了解更多更新。</p></div></div>    
</body>
</html>