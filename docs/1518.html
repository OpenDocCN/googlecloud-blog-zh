<html>
<head>
<title>Google Cloud Functions on .NET</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云功能开启。网</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-functions-on-net-2f0b9130b22b?source=collection_archive---------3-----------------------#2020-07-14">https://medium.com/google-cloud/google-cloud-functions-on-net-2f0b9130b22b?source=collection_archive---------3-----------------------#2020-07-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="bb68" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">。谷歌云功能(Alpha)</h1><p id="e1b1" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我在许多地方演讲。在过去的3-4年里，我经常收到的最常见的问题是:什么时候。NET支持云功能吗？</p><p id="5a7b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">可惜我一时没有好答案。上个月，随着来自我们C#团队的<a class="ae kg" href="https://twitter.com/jonskeet" rel="noopener ugc nofollow" target="_blank">乔恩·斯基特</a>的以下推文，这一切都改变了:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/2bb182af40d1e5e4fb8ffd77e272deb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*ICAooU7tvjLWMQ1875rdeg.png"/></div></figure><p id="0116" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">。NET对云函数的支持正在到来，目前它是公开的alpha版本。你需要在这里注册<a class="ae kg" href="https://docs.google.com/forms/d/e/1FAIpQLSe7qB5vNrgFtZZ3ZUfIwkbsDMGsA1fXY52GzmGmnhwdReHuOQ/viewform" rel="noopener ugc nofollow" target="_blank">才能进入。</a></p><p id="8436" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在这篇博文中，我想给出。NET对云功能的支持，试试看效果如何。在这个过程中，我们还将了解支持。NET对云功能的幕后支持。</p><p id="61f8" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我在这里分享的所有代码都已经在我的GitHub repo中:<a class="ae kg" href="https://github.com/meteatamel/cloud-functions-dotnetcore" rel="noopener ugc nofollow" target="_blank">cloud-functions-dotnetcore</a>。</p><h1 id="fb35" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">为什么选择云功能</h1><p id="3b04" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在我开始之前。NET对云函数的支持，一个值得回答的问题是:为什么云函数。网？已经有多种运行方式了。NET在Google Cloud上，那么为什么还要多一个呢？</p><p id="93fd" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">要回顾当前选项，您可以运行。计算引擎或Windows上的. NET框架。NET核心容器在Linux上的应用引擎(Flex)，Kubernetes引擎和最近的云运行。云跑一直是我默认选择跑的。NET Core，因为它的快速部署，令人敬畏的DevEx和它的无服务器扩展和计费模型。但是，云运行中的部署单元是一个容器。从……通过Dockerfile将. NET代码转换成Docker映像通常很简单，但也很重要。确保docker文件是优化的和安全的是更多的工作。</p><p id="c0ab" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">有时，您只想编写代码并部署它，而不必担心容器。这就是云功能使您能够做到的。截至目前，云功能也倾向于与不同的谷歌云事件更好地集成。</p><h1 id="4919" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">功能框架</h1><p id="7c83" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><a class="ae kg" href="https://github.com/GoogleCloudPlatform/functions-framework" rel="noopener ugc nofollow" target="_blank">功能框架</a>试图简化跨不同平台的可移植功能的编写和部署，例如云功能、云运行、GKE云运行或纯Knative。它对于本地开发和调试也很有用。支持<code class="du kp kq kr ks b">HTTP</code>和<code class="du kp kq kr ks b">CloudEvent</code>消费功能。</p><p id="9b60" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><a class="ae kg" href="https://github.com/GoogleCloudPlatform/functions-framework-dotnet" rel="noopener ugc nofollow" target="_blank">职能框架为。NET </a>对。NET，它是。云函数中的. NET支持。</p><h1 id="930a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">云函数的模板</h1><p id="d4cd" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">的功能框架。NET自带了一些<code class="du kp kq kr ks b">dotnet</code>的模板，方便上手。安装模板是一个简单的命令:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="67bb" class="kx ig hi ks b fi ky kz l la lb">dotnet new -i Google.Cloud.Functions.Templates::1.0.0-alpha08</span></pre><p id="006b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">您将看到以下新模板:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="2fcf" class="kx ig hi ks b fi ky kz l la lb">Templates                                              Short Name <br/>--------------------------------------------------------------------<br/>Google Cloud Functions CloudEvent Function             gcf-event<br/>Google Cloud Functions CloudEvent Function (Untyped)   gcf-untyped-event<br/>Google Cloud Functions HttpFunction                    gcf-http</span></pre><p id="bc4a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">前两个用于<code class="du kp kq kr ks b">CloudEvent</code>消费功能，最后一个用于<code class="du kp kq kr ks b">HTTP</code>消费功能。接下来我们将探索所有这些。</p><h1 id="dee5" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">HTTP功能</h1><p id="8f07" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">创建一个<code class="du kp kq kr ks b">HTTP</code>消费函数就像:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="edc6" class="kx ig hi ks b fi ky kz l la lb">dotnet new gcf-http</span></pre><p id="9541" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这将创建一个带有<a class="ae kg" href="https://github.com/meteatamel/cloud-functions-dotnetcore/blob/master/HelloHttpFunction/Function.cs" rel="noopener ugc nofollow" target="_blank"> Function.cs </a>文件的新项目:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="b9c3" class="kx ig hi ks b fi ky kz l la lb">public class Function : IHttpFunction<br/>{<br/>    public async Task HandleAsync(HttpContext context)<br/>    {<br/>        await context.Response.WriteAsync("Hello, Functions Framework.");<br/>    }<br/>}</span></pre><p id="fac6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这个函数将处理<code class="du kp kq kr ks b">HTTP</code>请求并发回<code class="du kp kq kr ks b">HTTP</code>响应。我喜欢API的简单性，这是我们不需要担心容器的额外好处。</p><p id="db96" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">要部署该函数，您可以使用<code class="du kp kq kr ks b">dotnet3</code>运行时和<code class="du kp kq kr ks b">trigger-http</code>标志:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="97c8" class="kx ig hi ks b fi ky kz l la lb">gcloud functions deploy hello-http-function \<br/>    --runtime dotnet3 \<br/>    --trigger-http \<br/>    --entry-point HelloHttpFunction.Function</span></pre><p id="ec12" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">一两分钟后，您应该会看到部署的功能:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es lc"><img src="../Images/913277c732f7459edb1f960654900a65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/0*u6EOMbvszcNNwOrw.png"/></div></figure><h1 id="32f6" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">CloudEvent函数</h1><p id="25ee" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">的功能框架。开始消费<code class="du kp kq kr ks b">CloudEvents</code>网就开始闪亮。该框架不仅在解析<code class="du kp kq kr ks b">CloudEvent</code>方面做得很好，而且还试图将<code class="du kp kq kr ks b">CloudEvent</code>中的数据解析为强类型。</p><p id="423c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">比如谷歌云存储放出<code class="du kp kq kr ks b">CloudEvents</code>。为了消费这些事件，您首先要创建一个<code class="du kp kq kr ks b">CloudEvent</code>消费函数:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="53ad" class="kx ig hi ks b fi ky kz l la lb">dotnet new gcf-event</span></pre><p id="9c93" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这创建了一个<a class="ae kg" href="https://github.com/meteatamel/cloud-functions-dotnetcore/tree/master/HelloCloudEventStorageFunction" rel="noopener ugc nofollow" target="_blank"> Function.cs </a>，它将一个<code class="du kp kq kr ks b">CloudEvent</code>和<code class="du kp kq kr ks b">CloudEvent</code>的数据解析成一个<code class="du kp kq kr ks b">StorageObjectData</code>对象:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="962e" class="kx ig hi ks b fi ky kz l la lb">public class Function : ICloudEventFunction&lt;StorageObjectData&gt;<br/>{<br/>    public Task HandleAsync(CloudEvent cloudEvent, StorageObjectData data, CancellationToken cancellationToken)<br/>    {</span></pre><p id="8d7b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这个很有用！要部署该功能，您需要相应地指定<code class="du kp kq kr ks b">trigger-event</code>和<code class="du kp kq kr ks b">trigger-resource</code>:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="bc68" class="kx ig hi ks b fi ky kz l la lb">gcloud functions deploy hello-cloudevent-storage-function \<br/>    --runtime dotnet3 \<br/>    --entry-point HelloCloudEventStorageFunction.Function \<br/>    --trigger-event google.storage.object.finalize \<br/>    --trigger-resource ${BUCKET_NAME} \<br/>    --allow-unauthenticated</span></pre><p id="2a15" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">如果您想使用发布/订阅消息，您可以经历相同的过程，但是将<a class="ae kg" href="https://github.com/meteatamel/cloud-functions-dotnetcore/blob/master/HelloCloudEventPubSubFunction/Function.cs" rel="noopener ugc nofollow" target="_blank"> Function.cs </a>中的<code class="du kp kq kr ks b">StorageObjectData</code>更改为<code class="du kp kq kr ks b">MessagePublishedData</code>，以确保数据被解析为发布/订阅消息:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="75b2" class="kx ig hi ks b fi ky kz l la lb">public class Function : ICloudEventFunction&lt;MessagePublishedData&gt;<br/>{<br/>    public Task HandleAsync(CloudEvent cloudEvent, MessagePublishedData data, CancellationToken cancellationToken)<br/>    {</span></pre><p id="9dc2" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在这种情况下，您需要使用<code class="du kp kq kr ks b">trigger-topic</code>进行部署:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="aa31" class="kx ig hi ks b fi ky kz l la lb">gcloud functions deploy hello-cloudevent-pubsub-function \<br/>    --runtime dotnet3 \<br/>    --entry-point HelloCloudEventPubSubFunction.Function \<br/>    --trigger-topic ${TOPIC_NAME}</span></pre><p id="8685" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">您可以在<a class="ae kg" href="https://github.com/GoogleCloudPlatform/functions-framework-dotnet/blob/master/docs/deployment.md" rel="noopener ugc nofollow" target="_blank">部署</a>页面中看到强类型方式支持的触发器的完整列表。</p><p id="a499" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">如果您只想监听<code class="du kp kq kr ks b">CloudEvent</code>而不解析特定的<code class="du kp kq kr ks b">data</code>类型，您可以创建一个非类型化的函数，如下所示:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="5a90" class="kx ig hi ks b fi ky kz l la lb">dotnet new gcf-untyped-event</span></pre><p id="7087" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这创建了一个带有简单<code class="du kp kq kr ks b">CloudEvent</code>签名的<a class="ae kg" href="https://github.com/meteatamel/cloud-functions-dotnetcore/blob/master/HelloCloudEventUntypedFunction/Function.cs" rel="noopener ugc nofollow" target="_blank"> Function.cs </a>:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="a303" class="kx ig hi ks b fi ky kz l la lb">public class Function : ICloudEventFunction<br/>{<br/>    public Task HandleAsync(CloudEvent cloudEvent, CancellationToken cancellationToken)<br/>    {</span></pre><h1 id="bf49" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">依赖注入</h1><p id="fa4c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我最后想提的是。NET对云功能的支持是它方便的依赖注入。</p><p id="9023" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">例如，如果您希望将记录器注入到您的函数中，您可以简单地将以下内容添加到您的<code class="du kp kq kr ks b">Function.cs</code>中:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="4dbc" class="kx ig hi ks b fi ky kz l la lb">private readonly ILogger _logger;</span><span id="e5a9" class="kx ig hi ks b fi ld kz l la lb">public Function(ILogger&lt;Function&gt; logger) =&gt;<br/>    _logger = logger;</span></pre><p id="3ec3" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">如果需要做更复杂的依赖注入，可以创建一个扩展<code class="du kp kq kr ks b">FunctionsStartup</code>的<code class="du kp kq kr ks b">Startup.cs</code>类，在<code class="du kp kq kr ks b">Configure</code>方法中做额外的注入，如<a class="ae kg" href="https://github.com/GoogleCloudPlatform/functions-framework-dotnet/blob/master/examples/Google.Cloud.Functions.Examples.AdvancedDependencyInjection/Function.cs" rel="noopener ugc nofollow" target="_blank"> Function.cs </a>所示:</p><pre class="ki kj kk kl fd kt ks ku kv aw kw bi"><span id="128f" class="kx ig hi ks b fi ky kz l la lb">public class Startup : FunctionsStartup<br/>{<br/>    public override void Configure(IFunctionsHostBuilder builder) =&gt;<br/>        builder.Services<br/>            .AddSingleton&lt;IOperationSingleton, Operation&gt;()<br/>            .AddScoped&lt;IOperationScoped, Operation&gt;();<br/>}</span></pre><p id="890b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这结束了我对……的讨论。NET上的云函数。激动人心的时刻。NET上的谷歌云肯定！</p><ul class=""><li id="fa9d" class="le lf hi jf b jg kb jk kc jo lg js lh jw li ka lj lk ll lm bi translated">在这里注册公共alpha <a class="ae kg" href="https://docs.google.com/forms/d/e/1FAIpQLSe7qB5vNrgFtZZ3ZUfIwkbsDMGsA1fXY52GzmGmnhwdReHuOQ/viewform" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="2866" class="le lf hi jf b jg ln jk lo jo lp js lq jw lr ka lj lk ll lm bi translated">点击查看我的代码和指令。</li><li id="59b8" class="le lf hi jf b jg ln jk lo jo lp js lq jw lr ka lj lk ll lm bi translated">问题/评论？在推特上联系我(<a class="ae kg" href="https://twitter.com/meteatamel" rel="noopener ugc nofollow" target="_blank"> @meteatamel </a>)。</li></ul></div><div class="ab cl ls lt gp lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hb hc hd he hf"><p id="f66f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><em class="lz">原发布于</em><a class="ae kg" href="https://atamel.dev/posts/2020/07-14_dotnet_on_cloud_functions/" rel="noopener ugc nofollow" target="_blank"><em class="lz">https://atamel . dev</em></a><em class="lz">。</em></p></div></div>    
</body>
</html>