<html>
<head>
<title>Using any Windows Performance Metric in Google Cloud and Managed Instance Groups</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google云和托管实例组中使用任何Windows性能指标</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/obtaining-any-windows-performance-metric-in-google-cloud-a5ec1432ea6e?source=collection_archive---------1-----------------------#2022-08-08">https://medium.com/google-cloud/obtaining-any-windows-performance-metric-in-google-cloud-a5ec1432ea6e?source=collection_archive---------1-----------------------#2022-08-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3ac8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Mike Francis，谷歌云的云转型架构师</p><p id="72fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最近，我面临一个问题“我们如何通过使用谷歌云帮助客户降低运行Windows终端服务的成本”。</p><p id="66dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回顾客户当前的解决方案，我发现这是一个非常典型的架构。该客户将Windows终端服务用于需要访问传统胖Windows客户端应用程序的远程办公室工作人员。客户使用VPN来保护到其数据中心的连接；他们有一组最终用户连接到的Windows终端服务器。</p><p id="4bbc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从运营的角度来看，他们似乎有很多机会可以降低运营成本。一些突出的例子是:</p><ul class=""><li id="3a9c" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">消除管理多台Windows服务器的需要。</li><li id="4b1c" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">自动化Windows终端服务器的生命周期管理。</li><li id="d8c6" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">让最终用户连接到某种形式的负载平衡，将他们连接到终端服务器，而不是特定的连接。这将简化客户端的可支持性。</li></ul><p id="ac0e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从另一个成本角度来看，问题浮出水面“我们如何利用谷歌云的弹性和固有的自动化来按需提供Windows终端服务；所以顾客只为他们使用的东西付费。</p><p id="c1ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从概念上来说，我想到了Google Cloud必须具备的自动扩展应用程序的能力，即结合使用Google Cloud负载平衡器和托管实例组，根据需求自动扩展一组虚拟机，然后在不需要时再将它们扩展回来。下图说明了概念模型:</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/1e193aa99353ae318eef1960ec8596c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c40N-JH3IglUx64C"/></div></div></figure><p id="34f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个概念让我明白，从Windows机器收集性能数据并将其发布到Google Cloud Operations的一些功能有点局限性。让我解释一下。</p><p id="74d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望在概念上遵循我之前提到的模型，在该模型中，负载平衡器跟踪应用程序请求的数量，并根据指标阈值的违反情况，托管实例组扩展一组虚拟机以支持更高的负载。当负载减少时，就会减少虚拟机的数量。</p><p id="3a6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以我想，我需要做的就是跟踪有多少个连接被连接到一个终端服务器，当那个连接超过一个阈值时，托管实例组将添加另一个终端服务器。这听起来在概念上是可以做到的；我可以使用谷歌云负载平衡器将终端服务器置于前端，根据最少使用的后端服务器自动平衡新会话。</p><p id="7703" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当时我发现谷歌云运营对它将监控的Windows指标有一些限制；它有一个具体指标的列表；终端服务器活动会话不在其中。于是我开始研究如何让这一切发生。如何监控未被捕获的windows指标，如果可以捕获，是否可以使用它来触发受管实例组更改规模。</p><p id="6a97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我发现我们在Google Cloud中支持自定义指标，并且有几个选项:</p><ul class=""><li id="dbc2" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">使用OpenCensus(现在的OpenTelemetry)</li><li id="856d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">直接使用云监控API</li></ul><p id="25fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我选择了后者，因为这似乎是获得我当时想要的东西的最简单的途径。事后看来，我可能会更深入地研究OpenTelemetry，因为再次回顾它，它似乎比我最初想象的要简单。</p><p id="b2fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然我已经决定直接使用云监控API，我需要使用一种受支持的语言。因为我最终想要一个windows服务，所以我选择使用C#。我从未用C#开发过任何东西，我想“这有什么难的，1994年我就很擅长C，我肯定能学会”。</p><p id="88f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于客户希望在短期内看到架构的概念证明，我创建了一个名为GCPAnyMetric的C#应用程序，它使用Google Cloud dot Net库对Google Cloud Operations进行身份验证，并推送指标数据。在我的代码中，我在注册表中定义了我想从Windows中收集的指标，以及将出现在Google Cloud Operations中的该指标的标签。对于Windows终端服务活动会话，我将其映射到Terminal Services/Active connections的Google Cloud自定义指标标签，如下所示。</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es kd"><img src="../Images/31c1fca21bb8fad76313ff7be0a55a34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fsAJIQ4YYL-oxKeC"/></div></div></figure><p id="af72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GCPAnyMetric中的代码将允许我定义任何Windows指标，并定义一个谷歌云操作自定义指标标签。您可以在下面我的测试Windows机器的注册表中看到这个配置。</p><figure class="js jt ju jv fd jw er es paragraph-image"><div class="er es ke"><img src="../Images/0826378f8a631e6e42e3147a1f40850a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/0*sDn6v-0fYyYfCYE1"/></div></figure><p id="8030" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">屏幕截图中的Windows指标是处理器\%用户时间。由于此计数器有多个实例，因此“/”表示此case _Total中的实例。注册表项的数据元素是Google Cloud Operations自定义指标标签。</p><p id="4499" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随着终端服务活动会话指标现在被转发到Google Cloud Operations，我在Google Compute Engine上创建了一个支持终端服务器的Windows模板，并配置了一个托管实例组。如下所示:</p><figure class="js jt ju jv fd jw er es paragraph-image"><div class="er es kf"><img src="../Images/87e03c621219383de4cd59544a19a3bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/0*FUHVV6CD9EzvnCjg"/></div></figure><p id="991c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在上面的屏幕截图中看到，我已经将我的自定义指标定义为自动缩放指标。在这个特定的概念验证中，我将自动扩展的高水位标记设置为0.5(换句话说，1个会话将突破阈值)，因为我想说明自动扩展。</p><p id="6a0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">定义了我的模板，安装了GCPAnyMetric，并配置为转发终端服务活动会话指标，定义了带自动缩放的托管实例组，解决方案就快完成了。</p><p id="5a7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我添加了一个Google Cloud TCP负载平衡器，它监听3389并转发给我的后端托管实例组。负载平衡器的配置如下所示:</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es kg"><img src="../Images/be9de2bc8612877e97814a279bd1d9e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*r87mbGoFi9-09uw7"/></div></div></figure><h1 id="2f03" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">结果</h1><p id="44b4" class="pw-post-body-paragraph if ig hi ih b ii lf ik il im lg io ip iq lh is it iu li iw ix iy lj ja jb jc hb bi translated">概念验证能够展示以下内容:</p><ul class=""><li id="5c1f" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">基于负载自动扩展Windows终端服务。</li><li id="9cbb" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">单个前端目标IP简化了客户端配置。</li><li id="49af" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">单个Windows终端服务器模板，可以进行更新和修补，并进行常规管理，然后托管实例组将根据需要部署该模板。</li><li id="459f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">该模型意味着任何Windows指标都可以用于自动扩展托管实例组。</li></ul><h1 id="73a2" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">业务成果</h1><p id="cda1" class="pw-post-body-paragraph if ig hi ih b ii lf ik il im lg io ip iq lh is it iu li iw ix iy lj ja jb jc hb bi translated">使用此解决方案，客户可以实现:</p><ul class=""><li id="eee4" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">通过消除物理服务器降低资本成本。</li><li id="c0b9" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">使用Google计算引擎按需许可降低了Windows许可成本。</li><li id="5238" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">利用托管实例组的自动升级功能减少操作工作量。</li></ul><h1 id="32a7" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">GCPAnyMetric</h1><p id="44fc" class="pw-post-body-paragraph if ig hi ih b ii lf ik il im lg io ip iq lh is it iu li iw ix iy lj ja jb jc hb bi translated">我已经在Github上发布了GCPAnyMetric，请随意下载和改进。你可以在这里找到GCPAnyMetric <a class="ae lk" href="https://bit.ly/3JDYMWH" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>