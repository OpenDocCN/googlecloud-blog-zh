<html>
<head>
<title>Automatic Datastore Replication to Secondary Datastore instance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动将数据存储复制到辅助数据存储实例</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/automatic-datastore-replication-to-secondary-datastore-instance-3afb5f694d05?source=collection_archive---------0-----------------------#2022-02-20">https://medium.com/google-cloud/automatic-datastore-replication-to-secondary-datastore-instance-3afb5f694d05?source=collection_archive---------0-----------------------#2022-02-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="bb06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的一个客户希望能够将特定类型的数据存储从生产实例导出到不同项目中的非生产数据存储实例。在传统RDBMS上进行开发的大多数团队都习惯于读取副本或辅助实例的概念，而客户在数据存储中寻找读取副本的等效物。</p><p id="6214" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建数据存储时，您可以选择“多区域”，这将在不同的区域创建另一个数据存储实例来备份您的数据，但用户无法查询。Google使用它来查询第二个区域的数据，以防主区域的数据存储不可用。</p><p id="ea09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">让我们看看需求:</strong></p><ul class=""><li id="ca04" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">非生产项目应该将数据从生产数据存储实例自动导入到非生产数据存储中</li><li id="c154" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">目标数据存储区应每24小时与生产数据存储区同步一次</li><li id="a36e" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">目前，该团队正在手动将生产中的数据存储实例导出和恢复到其他项目中，并且希望避免这种情况</li><li id="d5d3" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">通过使用生产数据的最新副本进行测试，QA团队可以对解决方案的推出充满信心，并避免对陈旧数据进行测试</li></ul><p id="7d10" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">挑战:</strong></p><ul class=""><li id="2500" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">数据存储仅允许离线导出到GCS存储桶。就在生产项目之外存储数据存储备份的要求而言，这很好，但不满足在辅助实例中自动恢复数据的要求。如何设置计划出口的GCP官方文件可以在这里找到链接—【https://cloud.google.com/datastore/docs/schedule-export T4】</li><li id="d392" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">我们必须考虑几种可能的自动化策略，以便在完成预定的导出后将数据导入到不同的项目数据存储实例中</li></ul><p id="8e8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">解决方案</strong></p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/c386515e5ca72687840c4f1e15bcd538.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dH75R-2eYFfO25QfqGdBSw.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">计划的数据存储导出和恢复</figcaption></figure><p id="5296" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了设置数据存储实例的连续导出，我们将使用云功能、云调度程序和发布/订阅的组合来激活计划导出并在目标项目中恢复。</p><p id="c462" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在源项目中</strong></p><ul class=""><li id="e78c" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">创建发布订阅主题</li><li id="59c8" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">向发布/订阅主题发布触发消息的云调度程序</li><li id="0d18" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">创建一个由发布/订阅主题触发的云函数。云功能将调用数据存储导出API，并提供GCS存储桶信息来备份数据存储数据</li></ul><p id="f889" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在目的项目</strong></p><ul class=""><li id="c158" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">在目标项目中创建一个GCS存储桶</li><li id="4bda" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">必须在目标项目中创建存储备份的GCS存储桶。这是必需的，因为只有当GCS存储桶在同一个项目中时，才能触发数据存储导入云功能的后续自动调用</li><li id="994d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">任何新对象的创建都将触发数据存储导入云功能，但是仅当由“export_metadata”文件启动触发时，云功能才会触发数据存储导入API代码</li><li id="686a" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">数据存储导入云功能将启动长时间运行的操作，以恢复目标数据存储中的数据存储种类。</li><li id="7b9b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">注意:数据存储导出和导入API通过批处理记录来减少数据存储API读取次数，从而有效地优化了备份过程，从而降低了成本</li></ul><p id="cb22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">服务账户权限:</strong></p><p id="708e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个云函数使用项目的默认服务帐户来验证和授权其导出操作。创建项目时，会为您创建一个名为的默认服务帐户</p><ul class=""><li id="a4b2" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">project_id@appspot.gserviceaccount.com</li></ul><p id="48df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此服务帐户需要权限才能开始导出操作并写入您的云存储桶。要授予这些权限，请将以下IAM角色分配给默认服务帐户:</p><ul class=""><li id="4d36" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">云数据存储导入导出管理</li><li id="d3fd" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">存储桶上的存储管理员角色</li></ul><p id="b6ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">类似地，对于导入功能，目标项目上的云功能服务帐户需要以下IAM角色</p><ul class=""><li id="e201" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">云数据存储导入导出管理</li><li id="db17" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">存储桶上的存储对象读取器和存储查看器角色</li></ul><blockquote class="ki kj kk"><p id="d9de" class="if ig kl ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated"><strong class="ih hj">定时出口配置:</strong></p></blockquote><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="5b7a" class="ku kv hi kq b fi kw kx l ky kz">SOURCE_PROJECT=&lt;source-project-id&gt;</span><span id="5082" class="ku kv hi kq b fi la kx l ky kz">BUCKET=gs://&lt;bucket&gt;  # bucket name should be globally unique</span><span id="9210" class="ku kv hi kq b fi la kx l ky kz">REGION=&lt;region&gt;</span><span id="8ac0" class="ku kv hi kq b fi la kx l ky kz">DEST_PROJECT=&lt;Destination-project-id&gt;</span></pre><p id="8b0f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在目标项目中创建GCS存储桶</strong></p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="976e" class="ku kv hi kq b fi kw kx l ky kz">gsutil mb -p $DEST_PROJECT -l northamerica-northeast1 -c NEARLINE $BUCKET</span></pre><p id="6323" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在源项目中创建发布/订阅主题</strong></p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="565a" class="ku kv hi kq b fi kw kx l ky kz">gcloud pubsub topics create datastorebackup --project=$SOURCE_PROJECT</span></pre><p id="6c4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建云调度程序，每天触发一次导出</strong></p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="022b" class="ku kv hi kq b fi kw kx l ky kz">gcloud scheduler jobs create pubsub scheduledDatastoreExport \<br/>--schedule="0 0 * * *" \<br/>--topic=projects/$SOURCE_PROJECT/topics/datastorebackup \<br/>--message-body='{ "bucket": "'"$BUCKET"'" }' --project=$SOURCE_PROJECT</span></pre><p id="0ae1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">部署云功能触发数据存储导出</strong></p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="1c31" class="ku kv hi kq b fi kw kx l ky kz">git clone https://github.com/GoogleCloudPlatform/python-docs-samples.git</span><span id="ffa1" class="ku kv hi kq b fi la kx l ky kz">gcloud functions deploy datastore_export \<br/>--source python-docs-samples/datastore/schedule-export/ \<br/>--runtime python37 \<br/>--entry-point datastore_export \<br/>--trigger-topic datastorebackup \<br/>--project $SOURCE_PROJECT \<br/>--region $REGION</span></pre><p id="5109" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">云功能服务账户写入目的GCS桶的IAM权限</strong></p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="4a57" class="ku kv hi kq b fi kw kx l ky kz">gsutil iam ch 'serviceAccount:'"$SOURCE_PROJECT"'@appspot.gserviceaccount.com:admin' $BUCKET</span></pre><p id="fcd1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">为云功能服务账户提供写入目的GCS桶的权限</strong></p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="7e75" class="ku kv hi kq b fi kw kx l ky kz">gcloud projects add-iam-policy-binding $SOURCE_PROJECT --member='serviceAccount:'"$SOURCE_PROJECT"'@appspot.gserviceaccount.com' --role='roles/datastore.importExportAdmin'</span></pre><p id="d858" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">激活云调度程序作业</strong></p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="06a5" class="ku kv hi kq b fi kw kx l ky kz">gcloud scheduler jobs run scheduledDatastoreExport --project $SOURCE_PROJECT</span></pre><p id="bf46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用手动触发器进行验证</strong></p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="6902" class="ku kv hi kq b fi kw kx l ky kz">gcloud pubsub topics publish datastorebackup --project $SOURCE_PROJECT --message='{ "bucket": "'"$BUCKET"'"}'</span></pre><p id="b249" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将触发数据存储导出作业，您可以验证导出操作和GCS存储桶中的输出</p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="9693" class="ku kv hi kq b fi kw kx l ky kz">gcloud datastore operations list --project $SOURCE_PROJECT</span><span id="eadb" class="ku kv hi kq b fi la kx l ky kz">-----</span><span id="fc0a" class="ku kv hi kq b fi la kx l ky kz">done: true<br/>metadata:<br/>'@type': type.googleapis.com/google.datastore.admin.v1.ExportEntitiesMetadatacommon:<br/>endTime: '2022-02-14T23:05:53.830652Z'<br/>operationType: EXPORT_ENTITIES<br/>startTime: '2022-02-14T23:05:36.692059Z'<br/>state: SUCCESSFUL</span></pre><p id="f275" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证GCS桶的输出</p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="9526" class="ku kv hi kq b fi kw kx l ky kz">gsutil ls $BUCKET</span></pre><p id="e987" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您的GCS存储桶将包含每种类型的文件夹和子文件夹，您还会看到一个“总体导出元数据”对象，这是我们将用于恢复的主要对象</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es lb"><img src="../Images/d58ba7c64917f0c528a84f9e9e7118d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8-Ils_qRT9bJHbkOm6OJkw.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">具有数据存储导出的GCS存储桶的示例文件输出</figcaption></figure><blockquote class="ki kj kk"><p id="1f1f" class="if ig kl ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated"><strong class="ih hj"> Datastore导入GCS功能并触发</strong></p></blockquote><p id="b943" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用您的云shell或通过google cloud帐户认证的本地Shell来部署下一组步骤</p><ul class=""><li id="ee4d" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">为云功能帐户提供数据存储导入的服务帐户权限以及对GCS存储桶的导出访问权限</li></ul><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="ad52" class="ku kv hi kq b fi kw kx l ky kz">gcloud config set project $DEST_PROJECT</span><span id="448d" class="ku kv hi kq b fi la kx l ky kz">gsutil iam ch 'serviceAccount:'"$DEST_PROJECT"'@appspot.gserviceaccount.com:admin' $BUCKET</span><span id="3b5b" class="ku kv hi kq b fi la kx l ky kz">gcloud projects add-iam-policy-binding $DEST_PROJECT --member='serviceAccount:'"$DEST_PROJECT"'@appspot.gserviceaccount.com' --role='roles/datastore.importExportAdmin'</span></pre><p id="50ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Python云函数恢复数据</strong></p><p id="211e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个目录来创建datastore_import函数</p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="d61b" class="ku kv hi kq b fi kw kx l ky kz">mkdir datastore-import<br/>cd datastore-import<br/>vi main.py</span></pre><p id="7ee5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">main.py</p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="e11f" class="ku kv hi kq b fi kw kx l ky kz">import base64<br/>import json<br/>import os</span><span id="4d83" class="ku kv hi kq b fi la kx l ky kz">from googleapiclient.discovery import build<br/>from googleapiclient.discovery_cache.base import Cache</span><span id="92db" class="ku kv hi kq b fi la kx l ky kz">class MemoryCache(Cache):<br/>  _CACHE = {}</span><span id="1fd1" class="ku kv hi kq b fi la kx l ky kz">def get(self, url):<br/>  return MemoryCache._CACHE.get(url)</span><span id="c5e5" class="ku kv hi kq b fi la kx l ky kz">def set(self, url, content):<br/>  MemoryCache._CACHE[url] = content</span><span id="08c4" class="ku kv hi kq b fi la kx l ky kz">datastore = build("datastore", "v1", cache=MemoryCache())<br/>project_id = os.environ.get("GCP_PROJECT")</span><span id="f306" class="ku kv hi kq b fi la kx l ky kz">def datastore_import(event, context):<br/>"""Triggered by a change to a Cloud Storage bucket.<br/>Args:<br/>event (dict): Event payload.context (google.cloud.functions.Context): Metadata for the event."""</span><span id="711b" class="ku kv hi kq b fi la kx l ky kz">  file = event<br/>  search_string = "overall_export_metadata"<br/>  if search_string in file['name']: <br/>    print(f"Processing file: {file['name']}."<br/>    path_name = "gs://" + file['bucket'] + "/" +file['name']       <br/>    request_body = {"inputUrl": path_name}<br/>    print (request_body)<br/>   <br/>    import_request = datastore.projects().import_(projectId=project_id, body=request_body)</span><span id="fe3a" class="ku kv hi kq b fi la kx l ky kz">    response = import_request.execute()<br/>    print(response)</span><span id="8962" class="ku kv hi kq b fi la kx l ky kz">   else:<br/>     print(f"Not an export Metadata file: {file['name']}.")<br/>     return</span></pre><p id="c891" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cloud函数在每个上传到GCS bucket的对象上被触发，但是只有当文件名包含“整体导出元数据”时，导入请求才会被触发</p><p id="f5f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">部署云功能</strong></p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="216e" class="ku kv hi kq b fi kw kx l ky kz">gcloud functions deploy datastore_import \<br/>--runtime python37 \<br/>--trigger-resource $BUCKET \<br/>--trigger-event google.storage.object.finalize \<br/>--entry-point datastore_import \<br/>--region $REGION</span></pre><p id="d1e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">运行全面的出口和进口验证:</strong></p><p id="b815" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以通过向PubSub主题发布消息来触发导出，从而手动触发完整的导出和导入测试</p><pre class="jt ju jv jw fd kp kq kr ks aw kt bi"><span id="b24d" class="ku kv hi kq b fi kw kx l ky kz">gcloud pubsub topics publish datastorebackup --project $SOURCE_PROJECT --message='{ "bucket": "'"$BUCKET"'"}'</span></pre><p id="2818" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">瞧啊。根据数据存储的大小，您应该在几分钟内完成数据复制。</p></div></div>    
</body>
</html>