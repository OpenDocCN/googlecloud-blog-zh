<html>
<head>
<title>Implementing Change Data Capture using GCP DataStream</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GCP数据流实施变更数据捕获</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/implementing-change-data-capture-using-gcp-datastream-c340238b5d2b?source=collection_archive---------1-----------------------#2022-01-25">https://medium.com/google-cloud/implementing-change-data-capture-using-gcp-datastream-c340238b5d2b?source=collection_archive---------1-----------------------#2022-01-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5cd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Datastream是一种无服务器且易于使用的变更数据捕获(CDC)和复制服务。它允许您跨异构数据库和应用程序可靠地同步数据，并且具有最小的延迟和停机时间。</p><p id="4968" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Datastream支持从Oracle和MySQL数据库流式传输到云存储。该服务提供了与数据流模板的简化集成，以支持BigQuery for analytics中的最新物化视图，将您的数据库复制到Cloud SQL或Cloud Spanner以实现数据库同步，或者利用直接来自云存储的事件流来实现事件驱动的架构。</p><p id="596f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据流的优势包括:</p><ul class=""><li id="5d9e" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">无需服务器，因此无需调配或管理资源，服务可根据需要自动扩展和缩减，最大限度减少停机时间。</li><li id="9238" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">易于使用的设置和监控体验可实现超快速的价值实现。</li><li id="1422" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">跨最佳Google云数据服务组合的集成，用于跨数据流、数据流、云数据融合、发布/订阅、BigQuery等的数据集成。</li><li id="cf40" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">跨异构数据库和应用程序同步和统一数据流。</li><li id="a3e9" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">安全性，具有私有连接选项和您期望从Google Cloud获得的安全性。</li><li id="f15d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">准确可靠，具有透明的状态报告和面对数据和模式变化时强大的处理灵活性。</li><li id="7454" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">支持多种使用情形，包括迁移和混合云配置的分析、数据库复制和同步，以及构建事件驱动的体系结构。</li><li id="8ef0" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">让我们考虑一个用例场景，其中需要从云SQL (MySQL)复制实时更改。下面是完成设置和管道执行的步骤。</li><li id="5f5b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">步骤1:设置GCP云SQL (MySQL)实例</li></ul><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/274f282b16a14d65092061c298e18a3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*II79oZvJGoxXprI8r3-3tQ.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx translated">如上所示创建实例</figcaption></figure><ul class=""><li id="2659" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">步骤2:启用MySQL实例的自动恢复</li></ul><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es kh"><img src="../Images/6f2d073eec98f65e6832b709ed968710.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wf4SkLBRLHZGxORmCT3tYQ.png"/></div></div></figure><ul class=""><li id="d3d2" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">a.连接到实例并创建数据流用户—使用以下命令从gcloud shell连接</li><li id="9a11" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">gcloud sql连接实例名—用户=根</li><li id="fb49" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">b.使用以下命令创建用户–</li></ul><blockquote class="ki kj kk"><p id="a0fe" class="if ig kl ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated">mysql &gt;创建由“[YOUR_PASSWORD]”标识的用户“数据流”@“%”；</p><p id="9424" class="if ig kl ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated">mysql &gt;授予复制从属、选择、重新加载、复制客户端、锁表、在*上执行。*到“数据流”@“%”；</p><p id="e679" class="if ig kl ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated">mysql &gt;刷新权限；</p></blockquote><ul class=""><li id="c327" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">c.验证mysql的配置--&gt;</li><li id="b9f4" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">通过输入以下MySQL命令，确认二进制日志配置正确:</li><li id="fd7b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">显示全局变量，如“% binlog _ format %”；</li><li id="0bfb" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">验证binlog_format变量的值是否设置为ROW。</li><li id="702c" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">通过输入以下MySQL命令，确认二进制日志的行格式设置为FULL:</li></ul><blockquote class="ki kj kk"><p id="77b3" class="if ig kl ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated">mysql &gt;显示‘binlog _ row _ image’这样的全局变量；</p></blockquote><ul class=""><li id="ceaf" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">通过输入以下MySQL命令，验证二进制日志的从属更新选项是否设置为on:</li></ul><blockquote class="ki kj kk"><p id="9273" class="if ig kl ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated">mysql &gt;显示像‘log _ slave _ updates’这样的全局变量；</p></blockquote><ul class=""><li id="aa83" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">通过输入以下MySQL命令，验证二进制日志的保留期是否设置为7天:</li></ul><blockquote class="ki kj kk"><p id="c047" class="if ig kl ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated">mysql &gt;显示像‘expire _ logs _ days’这样的全局变量；</p></blockquote><p id="6c0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果日志天数未设置为7天，请使用以下步骤设置为7天。</p><ol class=""><li id="cf5d" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc kp jj jk jl bi translated">导航到<strong class="ih hj"> /etc/mysql/ </strong>目录。</li><li id="7ad6" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kp jj jk jl bi translated">使用编辑器，打开<strong class="ih hj"> my.cnf </strong>文件。</li><li id="daf4" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kp jj jk jl bi translated">将以下几行添加到文件中:</li></ol><p id="7d77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">d.[mysqld]</p><p id="7e43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">e.log-bin=mysql-bin</p><p id="ae69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">f.服务器id=1</p><p id="65d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">g.binlog_format=ROW</p><p id="d646" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">h.日志从属更新=真</p><p id="7d8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一.过期日志天数=7</p><p id="38a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您正在进入<strong class="ih hj"> expire_logs_days=7 </strong>行代码，因为您希望通过配置系统将二进制日志保留至少7天来确保正确的复制。</p><ol class=""><li id="ffe5" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc kp jj jk jl bi translated">将您的更改保存到<strong class="ih hj"> my.cnf </strong>文件，然后关闭该文件。</li><li id="9d1b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kp jj jk jl bi translated">重新启动您的MySQL服务器，以便您所做的更改可以生效。</li></ol><p id="9087" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">至此，mysql配置完成。稍后，我们将添加数据流的ips，以允许来自mysql实例的流量。</p><p id="00dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤3:使用数据流创建连接配置文件。</p><p id="280b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要创建连接作为源、接收器/目标，以便配置创建流式管道。以下是为此用例创建的连接——</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/626af72a705147a3334cf11d87ad0d1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LFAB4K8geminym9c_55M3g.png"/></div></div></figure><p id="9e34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">a.Mysql连接配置文件— mysql源连接</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/1cf0f30939f2ad906b45b884dbe465ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tEVsqL30vYd3BMdHoq_SXA.png"/></div></div></figure><p id="aa3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">IP地址需要加入mysql的白名单。以下是IP–</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es kq"><img src="../Images/16ec2cca62e5e68b63f1c57dc6cb2f66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NvoDozXPlBHgrmcZLRwdMQ.png"/></div></div></figure><p id="edc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">a.存储连接配置文件—作为接收器/目标的GCS</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/693510178c0b6323ec7098e1ef7e540e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JVAGnJaFa6KuUtmsTkVb0Q.png"/></div></div></figure><p id="cd6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">a.在添加网络中为Mysql实例添加IP地址，以允许流量</p><figure class="js jt ju jv fd jw er es paragraph-image"><div class="er es kr"><img src="../Images/637e7f6a5a1446f18cfb21a8da4a97b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*9UiiIK1YUSQR9Qnhw02vPw.png"/></div></figure><p id="ede7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建流管道</p><p id="b983" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建连接配置文件后，我们可以创建流并配置变更数据捕获</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/e00a27a31c7ae506ddd0e9d2b678425c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a8iJrNDhHT713sJW51DO3w.png"/></div></div></figure><p id="6185" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置步骤–</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/4e381ee3935b6560470499a838bd62ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KdeAEloXMng_nbET_E5r2g.png"/></div></div></figure><p id="bdad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">继续配置源-</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/828bb197f98163219903c2603daca993.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MwtbhCQQMM4cQ8PyqH7rmg.png"/></div></div></figure><p id="f1dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择连接配置文件并运行测试以检查连接性–</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/ecfe77e92c85a7c602d8e43e39647a59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FjHz_Le67YlpAIVwagI0QQ.png"/></div></div></figure><p id="643e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要通过测试来配置连接-</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/203048ab169434930f38a68a6b0cf65e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LfWSV0lOKm2djPUzVCoavg.png"/></div></div></figure><p id="9e72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">继续为表/对象/模式配置流–</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/8e1c4a587d00eb7b0b2da86acce6ccb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o-2_0U9n1j9jnQBr87N5Ng.png"/></div></div></figure><p id="563a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">定义接收器/目标目的地–</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/335bf2d5fb2885abbdf29b9114a0480a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pv3hycC4ueYWGA_sik2t0A.png"/></div></div></figure><p id="62ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置目的地-</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/16e760804019bce1aa87e0d9e5b75f18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tFLLZdkL2Hrk6W8W5Sro3g.png"/></div></div></figure><p id="e8a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建流–</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/5e978a213b9b1cb004054d542d378967.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UKcr01Ihze4ZyngDfjq1Yg.png"/></div></div></figure><p id="2f85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦流创建，它不会运行，直到这是开始。这也可以使用create和start来完成。一旦流开始，它将显示如下</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/9a4ed3adbe00acdd09fffb37f5977cbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZEUzVfr8Bpf6K-o9rU2Tjg.png"/></div></div></figure><p id="c2b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GCS目标–</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/b276caabeb3a19760f79a7ae2be78c0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UuVpVHsI58sn21AMHfkS-w.png"/></div></div></figure><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/47f63b71734336b214551400ec018950.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j350TEMaMNVT4DbrXcqv6w.png"/></div></div></figure><p id="362d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">存储在GCS中的流如下——</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/18d353365e1f8e26b835f40a749b01aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TkPgT1fqAKoeCJrmtS6_gg.png"/></div></div></figure><p id="738e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦在GCS中捕获到提要，就可以创建并运行一个后续作业，将这些更改加载到GCP数据库服务中。一种实现方式是创建数据流作业，从GCS中捕获更改，并写入BQ、Spanner或Cloud SQL。谷歌在模板中提供了这些工作，可以快速创建和使用这些模板来建立管道。该作业将像实时作业一样运行，并将更改写入目标表/数据库。</p><figure class="js jt ju jv fd jw er es paragraph-image"><div class="er es ks"><img src="../Images/301ae49c8faefb8d85276f74bcd09611.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*8nCWsoC4n8O4AN7H2AjBAw.png"/></div></figure><ul class=""><li id="f0cc" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">了解更多关于https://cloud.google.com/datastream/docs GCP数据流的信息</li><li id="b73f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><strong class="ih hj">关于我</strong></li></ul><blockquote class="ki kj kk"><p id="1ffe" class="if ig kl ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated"><em class="hi">我是DWBI和云师！我一直在处理各种遗留数据仓库、大数据实施、云平台/迁移。我是谷歌认证的专业云架构师。您可以联系我@</em><a class="ae kt" href="https://www.linkedin.com/in/poojakelgaonkar" rel="noopener ugc nofollow" target="_blank"><em class="hi">LinkedIn</em></a><em class="hi">如果您需要任何认证、GCP实施方面的帮助！</em></p></blockquote></div></div>    
</body>
</html>