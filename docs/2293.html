<html>
<head>
<title>Installing Openshift OKD 3.11 Cluster on GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GCP上安装Openshift OKD 3.11集群</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/installing-openshift-okd-3-11-cluster-on-gcp-5941d3ed6c38?source=collection_archive---------2-----------------------#2022-08-08">https://medium.com/google-cloud/installing-openshift-okd-3-11-cluster-on-gcp-5941d3ed6c38?source=collection_archive---------2-----------------------#2022-08-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="749a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这篇博客将带你了解在谷歌计算引擎上配置Openshift OKD 3.11集群所需的步骤。<br/>我正在寻找一种简单的方法来启动100个Openshift集群进行测试和验证。</p><p id="67f7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">自动化使用Terraform在GCP上配置基础架构，然后部署Ansible playooks来配置OKD集群。Automation还在Openshift上部署了一个示例应用程序(<a class="ae jk" href="https://github.com/avinashkumar1289/bank-of-anthos" rel="noopener ugc nofollow" target="_blank"> Bank of Anthos </a>),并将管理员角色绑定到默认用户。它还生成一个可用于登录集群的不记名令牌。</p><p id="6222" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们开始吧。</p><p id="2141" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我将把整个自动化分解成不同的任务，并详细讨论每个任务。</p><p id="bf36" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们在开始自动化之前先讨论一下先决条件。</p><p id="a5d4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">资源库:<a class="ae jk" href="https://github.com/google/shifter/tree/main/okd-cluster" rel="noopener ugc nofollow" target="_blank">https://github . com/Google/shifter/tree/v 0 . 3 . 0/okd-cluster/3.11</a></p><p id="2b9f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">先决条件</strong></p><ol class=""><li id="95e2" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">拥有所有者权限的谷歌云项目</li><li id="4377" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">如果从GCP以外的地方运行自动化，则允许创建服务帐户密钥</li><li id="08e3" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">在部署脚本之前，需要有效的计费帐户详细信息。需要在terraform tfvars文件中更新计费详细信息。</li><li id="bf26" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">组织ID是必需的，需要在terraform.tfvars文件中更新。</li><li id="f6bb" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">部署OKD群集需要有效的域，并且需要更新DNS条目</li></ol><p id="3665" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您已经具备了所需的所有先决条件，那么让我们直接进入每项任务。请参考个人任务的<em class="jz"> okd-create.sh </em>脚本</p></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="4c4b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">生成SSH </strong></p><p id="ef05" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">此任务生成SSH密钥，该密钥将用于建立开发人员节点和控制/工作人员节点的无密码访问。ssh密钥在目录“＄{ HOME }/GCP _ keys/id _ RSA”中生成</p><p id="0475" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">提供基础设施</strong></p><p id="68a3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">此任务使用Terraform文件并在GCP上配置基础架构。</p><p id="0882" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">terra form的先决条件<br/> </strong> 1)将terraform.tfvars.sample文件更新为terraform.tfvars文件，并更新变量。<br/>样本terraform.tfvars文件</p><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="11fa" class="kj kk hi kf b fi kl km l kn ko">prefix                    = "dev"                            <br/>region                   = "europe-west1"                             master_count             = 1                             <br/>node_count               = 2                                                           project_name             = "okd-tf"                                                        <br/>org_id                   = "34545645634345"                          folder_id                = ""  <br/>environment              = "dev"                             billing_code             = "1234"         <br/>billing_account          = "0090FE-ED3D81-ER565"                            application_name         = "" <br/>primary_contact          = "avinash@example.com"                             activate_apis = [                               "compute.googleapis.com",                               "cloudbilling.googleapis.com",                               "dns.googleapis.com",                               "servicenetworking.googleapis.com"]                             master_subdomain        = "okd.example.com"                             public_subdomain        = "console.okd.example.com"                             dns_master_subdomain    = "okd.example.com."                             ssh_user                = ""</span></pre><p id="2824" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">2)使用后端GCS bucket <br/>更新backend.tf文件3)通过gcloud命令进行身份验证，或者如果您从GCP虚拟机运行脚本，则将正确的服务帐户附加到虚拟机</p><p id="f0ed" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Terraform提供了一个主节点和三个工作节点，以及一个用于运行ansible剧本的开发人员虚拟机。<br/>检查<em class="jz"> okd-template </em>目录下的<em class="jz">ansi ble-hosts . template . txt</em>文件。该主机文件用于运行ansible剧本来创建OKD集群。</p><p id="8c55" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">复制清单文件</strong></p><p id="e384" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">该步骤将所需的ansible主机模板文件和ssh密钥复制到developer节点，这是运行ansible剧本和无密码访问control和worker节点所需的</p><p id="a5e4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">供应集群</strong></p><p id="858d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这些步骤克隆了Openshift <a class="ae jk" href="https://github.com/openshift/openshift-ansible.git" rel="noopener ugc nofollow" target="_blank"> github </a>仓库<br/>中可用的剧本，并签出相关的OKD版本(在我们的例子中是3.11)。<br/>这一步从bastion主机运行所需的ansible剧本。这包括prerequisites.yml行动手册和deploy_cluster.yml行动手册。<br/>成功运行此任务后，您应该已经创建了OKD集群，并且可以从VPC中访问该集群。<br/>要访问域上的集群，请检查生成的名称服务器的日志，并更新域提供商上的名称服务器。</p><p id="b320" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">部署清单</strong></p><p id="b8c4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这一步在OKD集群上部署一个样本测试应用程序库Anthos(<a class="ae jk" href="https://github.com/avinashkumar1289/bank-of-anthos" rel="noopener ugc nofollow" target="_blank">https://github.com/avinashkumar1289/bank-of-anthos</a>)。</p><p id="b358" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> OKD配置</strong></p><p id="84f7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">该步骤通过下面的命令将集群管理员角色绑定到默认用户。</p><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="b77f" class="kj kk hi kf b fi kl km l kn ko">oc adm policy add-cluster-role-to-user cluster-admin shifter</span></pre><p id="3882" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">它还设置了一个环境变量$TOKEN，该变量存储用于访问OKD集群的承载令牌。您可以使用以下命令向群集进行身份验证。</p><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="6697" class="kj kk hi kf b fi kl km l kn ko">oc login --token=$TOKEN --server=console.okd.example.com</span></pre></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="f3ab" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这标志着OKD集群创建自动化脚本的结束。<br/>脚本文件夹中有一个variable.sh文件。默认变量文件如下所示</p><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="a50c" class="kj kk hi kf b fi kl km l kn ko">#!/bin/bash                                                           SSH_PATH=${HOME}/gcp_keys/id_rsa                             SSH_PUB_FILE=${SSH_PATH}.pub                             SSH_USER=avinash                             <br/>REGION=europe-west1                             <br/>ZONE=europe-west1-b                             OKD_VERSION=release-3.11                             LOG_PATH="${HOME}/okd/logs"                             LOG_FILE="${LOG_PATH}/create-okd-logs-$(date +'%Y-%m-%d-%H:%M:%S')"                             DELETE_LOG_FILE="${LOG_PATH}/delete-okd-logs-$(date +'%Y-%m-%d-%H:%M:%S')"</span></pre><p id="5399" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">删除基础设施</strong></p><p id="93cd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">运行<em class="jz"> okd-delete.sh </em>删除anthos银行的默认部署，并销毁通过Terraform提供的基础设施。</p></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="dfcc" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">OKD集群自动化是Google Shifter工具的一部分，用于将Kubernetes的工作负载从Openshift迁移到GKE。有兴趣了解更多关于移位器的信息，请查看这个<a class="ae jk" href="https://github.com/google/shifter" rel="noopener ugc nofollow" target="_blank"> github </a>库。</p><p id="b9b2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">至此，我们已经到了博客的结尾。我希望它是有用的。<br/>如果你有任何问题或反馈，你可以通过Linkedin联系我。</p></div></div>    
</body>
</html>