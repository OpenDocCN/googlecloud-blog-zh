<html>
<head>
<title>Rate limit your API usage with Cloud Endpoints quotas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过云端点配额限制您的API使用率</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/rate-limit-your-api-usage-with-cloud-endpoints-quotas-1270da55d2bf?source=collection_archive---------0-----------------------#2020-02-13">https://medium.com/google-cloud/rate-limit-your-api-usage-with-cloud-endpoints-quotas-1270da55d2bf?source=collection_archive---------0-----------------------#2020-02-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b870ec5a83ce44a2e6c2057bf75969b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2L_P7o3QyzVEGjZ5oQUggw.png"/></div></div></figure><p id="fdcb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所有的API提供者，比如谷歌云平台，<strong class="is hj">必须通过设置API</strong>的<strong class="is hj">配额和速率限制来保护和保存用户可用的资源</strong>。这可以是为了保护服务免受错误使用，避免<a class="ae jo" href="https://landing.google.com/sre/sre-book/chapters/addressing-cascading-failures/" rel="noopener ugc nofollow" target="_blank">级联故障</a>或者仅仅是为了丢弃像DDoS这样的攻击。</p><p id="a979" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，当你想在你的API中实现一个速率限制特性时，这并不容易。</p><ol class=""><li id="1ece" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">你必须<strong class="is hj">编码它，或者使用一个框架</strong>为你做这件事。</li><li id="772d" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">您必须<strong class="is hj">支付速率限制操作</strong>的处理时间，这会影响您的计费。<em class="kd">万一受到攻击，你的账单会爆炸！</em></li><li id="d1c2" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">您必须管理Redis 等内存数据库的分布式缓存中的<strong class="is hj"> API用法，以实现水平可伸缩性。</strong></li></ol><h1 id="01d6" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">免费的API管理解决方案</h1><p id="7320" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">这就是为什么<strong class="is hj">解决方案存在的原因，比如</strong> <a class="ae jo" href="https://cloud.google.com/apigee" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> Apigee </strong> </a>这是一款众所周知的企业级API管理产品，但也有企业级成本。对于较小的项目，有一个<strong class="is hj">自由解存在:</strong> <a class="ae jo" href="https://cloud.google.com/endpoints/docs/" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">云端点</strong> </a> <strong class="is hj">。</strong></p><p id="c3d5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本产品是<strong class="is hj"> </strong> <a class="ae jo" href="https://github.com/cloudendpoints/esp" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">开源</strong> </a>并且可以在<strong class="is hj">上托管</strong> <a class="ae jo" href="https://cloud.google.com/endpoints/docs/openapi/tutorials" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">几种服务</strong> </a>:</p><ul class=""><li id="5446" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn lh jv jw jx bi translated">计算引擎</li><li id="21b7" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lh jv jw jx bi translated">谷歌Kubernetes引擎(GKE)</li><li id="2b7a" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lh jv jw jx bi translated">云运行</li><li id="becb" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lh jv jw jx bi translated">应用引擎</li><li id="aa80" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lh jv jw jx bi translated">云函数</li></ul><p id="a9bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kd">在我的</em> <a class="ae jo" rel="noopener" href="/google-cloud/secure-cloud-run-cloud-functions-and-app-engine-with-api-key-73c57bededd1"> <em class="kd">上一篇文章</em> </a> <em class="kd">中，我描述了如何用API密匙保护无服务器端点。这将是实施步骤</em>的起点</p><h1 id="1268" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">用于识别消费者的API键</h1><p id="624d" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">为了使用云端点配额，你<strong class="is hj">必须使用API密匙</strong>。这里，这个键用于识别使用您的API的<strong class="is hj">项目</strong>。<strong class="is hj">对，项目</strong>，不是重点。的确，<strong class="is hj">如果你在同一个项目中创建了几个键，那么所有键都引用同一个项目</strong>并且限制是相同的。</p><blockquote class="li lj lk"><p id="7d71" class="iq ir kd is b it iu iv iw ix iy iz ja ll jc jd je lm jg jh ji ln jk jl jm jn hb bi translated">如何将API限制在几个客户之间没有依赖关系？</p></blockquote><p id="a168" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在<a class="ae jo" href="https://cloud.google.com/endpoints/docs/openapi/restricting-api-access-with-api-keys#sharing_apis_protected_by_api_key" rel="noopener ugc nofollow" target="_blank">这个页面</a>，谷歌提出了一个决策图。如果您想要区分几个客户，解决方案是<strong class="is hj">创建几个项目，每个客户一个，每个项目中的API都有一个API键</strong>授权。</p><h1 id="b403" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">用配额改进API定义</h1><p id="2fb2" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">为了实现API的配额，我从我上一篇文章中描述的现有定义开始，我<strong class="is hj">使用</strong> <code class="du lo lp lq lr b"><a class="ae jo" href="https://github.com/guillaumeblaquiere/apikey-endpoint/blob/master/endpoint.yaml" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">endpoint.yaml</strong></a></code> <strong class="is hj">文件作为基础文件</strong>。</p><p id="3349" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">定义配额有3个步骤:</p><ol class=""><li id="654b" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">说出你的配额以便于理解。</li><li id="621c" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">设置<strong class="is hj">默认速率</strong>(每分钟每项目查询)。</li><li id="7f23" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">定义每条路径的<strong class="is hj">成本调用</strong>。</li></ol><p id="a94f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kd">本文提供的</em> <strong class="is hj"> <em class="kd">最终文件</em> </strong> <em class="kd">中的所有描述/更新都是</em> <a class="ae jo" href="https://github.com/guillaumeblaquiere/apikey-endpoint/blob/master/endpoint-quotas.yaml" rel="noopener ugc nofollow" target="_blank"> <em class="kd">这里的</em> </a> <em class="kd">。</em></p><h2 id="0b8c" class="ls kf hi bd kg lt lu lv kk lw lx ly ko jb lz ma ks jf mb mc kw jj md me la mf bi translated">1.说出您的配额</h2><p id="5386" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">命名您的配额允许您在云端点的配额页面中看到它们，而且每个使用这个API的项目将能够在页面中看到它的配额。</p><p id="5ab9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，让我们在<strong class="is hj">YAML文件</strong>的根级别定义您想要使用的配额名称，例如就在<code class="du lo lp lq lr b">paths:</code>定义之前。</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="578b" class="ls kf hi lr b fi mo mp l mq mr">x-google-management:<br/>  metrics:<br/>    - name: "my_first_quota"<br/>      displayName: "My first quota"<br/>      valueType: INT64<br/>      metricKind: DELTA</span></pre><p id="8b34" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kd"/><code class="du lo lp lq lr b"><em class="kd">displayName</em></code><em class="kd">为达到定额错误时返回，显示在GUI上。明确一点！</em></p><h2 id="eb64" class="ls kf hi bd kg lt lu lv kk lw lx ly ko jb lz ma ks jf mb mc kw jj md me la mf bi translated">2.设置配额的默认值</h2><p id="c563" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">现在，您必须<strong class="is hj">为该配额</strong>定义标准值。<em class="kd"/><code class="du lo lp lq lr b"><em class="kd">metric:</em></code><em class="kd">字段的值与前一个块的名称相同，用于在两个</em>之间建立链接。</p><p id="0785" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">集团与</strong> <code class="du lo lp lq lr b"><strong class="is hj">metrics:</strong></code> <strong class="is hj">定义</strong>在同一层(上一部分，为定额命名)</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="62fa" class="ls kf hi lr b fi mo mp l mq mr">  quota:<br/>    limits:<br/>      - name: "read-get"<br/>        metric: "my_first_quota"<br/>        unit: "1/min/{project}"<br/>        values:<br/>          STANDARD: 1</span></pre><p id="153e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lo lp lq lr b">values:</code>是极限的值。这里每分钟一个请求，更容易测试。<em class="kd">在这个测试版中不能改变单位。</em></p><h2 id="c3dc" class="ls kf hi bd kg lt lu lv kk lw lx ly ko jb lz ma ks jf mb mc kw jj md me la mf bi translated">3.设置API调用的开销</h2><p id="4b3c" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">云端点配额功能<strong class="is hj">允许您创建不同的配额指标</strong>来区分业务案例、功能或查询类型(GET、POST、PUT、DELETE)。</p><p id="31a9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，<strong class="is hj">您也可以在相同的配额定义内，区分每个</strong> <code class="du lo lp lq lr b"><strong class="is hj">paths</strong></code>上消耗的资源。例如，带有结果列表的多标准搜索比获取单个资源要昂贵得多。</p><p id="6c77" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，在每个<code class="du lo lp lq lr b">paths</code>上，您可以<strong class="is hj">设置呼叫</strong>的<em class="kd">成本</em>。您可以在与<code class="du lo lp lq lr b">OperationId:</code>相同的级别添加该部件</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="618b" class="ls kf hi lr b fi mo mp l mq mr">      x-google-quota:<br/>        metricCosts:<br/>          "my_first_quota": 1</span></pre><h2 id="cfad" class="ls kf hi bd kg lt lu lv kk lw lx ly ko jb lz ma ks jf mb mc kw jj md me la mf bi translated">测试配额</h2><p id="863c" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">对于测试，开始部署新的服务定义</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="ab80" class="ls kf hi lr b fi mo mp l mq mr">gcloud endpoints deploy endpoint.yaml</span></pre><p id="f239" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并测试它。<strong class="is hj">重复几次</strong> <code class="du lo lp lq lr b"><strong class="is hj">curl</strong></code> <strong class="is hj">。</strong> <code class="du lo lp lq lr b"><em class="kd">-i</em></code> <em class="kd">代表显示响应头，尤其是响应码</em></p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="5767" class="ls kf hi lr b fi mo mp l mq mr">curl -i https://endpoint-&lt;hash&gt;-uc.a.run.app/hello?key=&lt;API KEY&gt;</span></pre><p id="ca8c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在几次调用之后，您应该会看到这个错误。您可能会注意到，在被阻止之前，您必须进行3、4次或更多次尝试。更多详情见下一段。</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="721d" class="ls kf hi lr b fi mo mp l mq mr">HTTP/2 429<br/>content-type: application/json<br/>x-cloud-trace-context: d08f223742db0784fbb661e2512b3381<br/>date: Mon, 27 Jan 2020 13:25:01 GMT<br/>server: Google Frontend<br/>content-length: 354</span><span id="cfbd" class="ls kf hi lr b fi ms mp l mq mr">{<br/> "code": 8,<br/> "message": "Quota exceeded for quota metric 'My first quota' and limit 'My first quota per minute' of service 'endpoint-&lt;hash-uc.a.run.app' for consumer 'project_number:XXXXXXX'.",<br/> "details": [<br/>  {<br/>   "<a class="ae jo" href="http://twitter.com/type" rel="noopener ugc nofollow" target="_blank">@type</a>": "type.googleapis.com/google.rpc.DebugInfo",<br/>   "stackEntries": [],<br/>   "detail": "internal"<br/>  }<br/> ]<br/>}</span></pre><p id="e4f3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">限额工程</strong>。您可以注意到为许多请求返回的<code class="du lo lp lq lr b"><strong class="is hj">429 HTTP</strong></code> <strong class="is hj">代码</strong>。你还可以看到错误描述体中的<strong class="is hj">定额</strong> <code class="du lo lp lq lr b"><strong class="is hj">display_name</strong></code> <strong class="is hj">和用API键标识的</strong>项目号<strong class="is hj">。</strong></p><h1 id="59d4" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">尽力配额管理</h1><p id="dee3" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated"><strong class="is hj">云端点配额目前处于测试阶段</strong>，一些功能缺失，有时行为并不完美。</p><p id="5275" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以使用<code class="du lo lp lq lr b"><a class="ae jo" href="https://github.com/rakyll/hey" rel="noopener ugc nofollow" target="_blank">hey</a></code>进行测试。如果您将请求并发性设置为1 ( <code class="du lo lp lq lr b">-c</code>参数)，<strong class="is hj">配额基本上是合理的</strong>。</p><p id="b6a9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，如果您删除它，<strong class="is hj">请求将得到服务，直到云运行端点服务考虑到阻止项目号的信息</strong>。<strong class="is hj">这可能需要几毫秒的时间</strong>，足够满足<strong class="is hj">几十个额外的请求，即使超过了配额</strong>。</p><p id="a79f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并行运行的云实例越多，流量越高，更重要的是通过而不是被阻塞的请求的数量。</p><p id="039a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">总之，<strong class="is hj">在这个小故障之后，应用了速率限制</strong>,<code class="du lo lp lq lr b">429 HTTP</code>按预期返回，并且<strong class="is hj">API防止了太多的请求。</strong></p></div><div class="ab cl mt mu gp mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="hb hc hd he hf"><h1 id="7eca" class="ke kf hi bd kg kh na kj kk kl nb kn ko kp nc kr ks kt nd kv kw kx ne kz la lb bi translated">提高安全性并保持配额</h1><p id="f3b0" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">在我的上一篇文章中，我解释过<strong class="is hj"> API Keys并不是API用户认证</strong>的最佳解决方案，即使它是可能的。但是，配额需要A <strong class="is hj"> PI键。</strong></p><blockquote class="li lj lk"><p id="4dbe" class="iq ir kd is b it iu iv iw ix iy iz ja ll jc jd je lm jg jh ji ln jk jl jm jn hb bi translated">理想的情况是为配额保留API密钥，并使用OAuth2身份验证</p></blockquote><p id="a99a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云端点允许您设置此配置。在安全定义中，<strong class="is hj">添加</strong> <a class="ae jo" href="https://cloud.google.com/endpoints/docs/openapi/authentication-method" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">你想要的认证方式</strong></a><strong class="is hj"/>。<em class="kd">在下面的例子中，我选择了Google ID令牌认证，并将其添加到了</em> <code class="du lo lp lq lr b"><a class="ae jo" href="https://github.com/guillaumeblaquiere/apikey-endpoint/blob/master/endpoint-quotas.yaml" rel="noopener ugc nofollow" target="_blank"><em class="kd">endpoint-quotas.yaml</em></a></code> <em class="kd">文件的安全定义部分。</em></p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="d5eb" class="ls kf hi lr b fi mo mp l mq mr">google_id_token:<br/>  authorizationUrl: ""<br/>  flow: "implicit"<br/>  type: "oauth2"<br/>  x-google-issuer: "https://accounts.google.com"<br/>  x-google-jwks_uri: "https://www.googleapis.com/oauth2/v3/certs"</span></pre><p id="c20c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kd">这个配置</em> <strong class="is hj"> <em class="kd">允许任何google账号调用我的API，它是大开放的！</em> </strong> <em class="kd">如果您想使用</em> <a class="ae jo" href="https://cloud.google.com/identity-platform/docs" rel="noopener ugc nofollow" target="_blank"> <em class="kd">云身份平台</em> </a> <em class="kd">来管理您的用户子集，我推荐您使用</em> <a class="ae jo" href="https://cloud.google.com/endpoints/docs/openapi/authenticating-users-firebase" rel="noopener ugc nofollow" target="_blank"> <em class="kd"> Firebase认证方法</em> </a></p><p id="e856" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，我通过设置这个值来更新端点路径的安全定义</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="b551" class="ls kf hi lr b fi mo mp l mq mr">security:<br/>  - google_id_token: []</span></pre><h2 id="1916" class="ls kf hi bd kg lt lu lv kk lw lx ly ko jb lz ma ks jf mb mc kw jj md me la mf bi translated">使用OAuth2安全定义测试云端点</h2><p id="7f58" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">现在部署新的API定义</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="9b2c" class="ls kf hi lr b fi mo mp l mq mr">gcloud endpoints deploy endpoint-quotas.yaml</span></pre><p id="c7c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并用不记名令牌进行测试</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="5998" class="ls kf hi lr b fi mo mp l mq mr">curl -H "Authorization: Bearer $(gcloud auth print-identity-token)"\<br/>    https://endpoint-&lt;hash&gt;-uc.a.run.app/hello?key=&lt;API KEY&gt;</span></pre><p id="4302" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">还有…<strong class="is hj">失败了。</strong> <strong class="is hj"> <em class="kd">为什么？</em> </strong>查看错误信息</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="731d" class="ls kf hi lr b fi mo mp l mq mr">{<br/> "code": 7,<br/> "message": "JWT validation failed: Audience not allowed",<br/> "details": [<br/>...</span></pre><p id="356b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">是的，<strong class="is hj">你只需要将观众设置到你的令牌上</strong>。很简单，使用命令<code class="du lo lp lq lr b">gcloud auth print-identity-token</code>的<code class="du lo lp lq lr b">--audiences</code>参数，并将云运行端点主机名设置为受众值</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="ffa9" class="ls kf hi lr b fi mo mp l mq mr">gcloud auth print-identity-token \<br/>  <!-- -->--audiences <!-- -->https://endpoint-&lt;hash&gt;-uc.a.run.app</span></pre><p id="b309" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您通过了用户帐户的身份验证。你应该有另一个错误。</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="caeb" class="ls kf hi lr b fi mo mp l mq mr">ERROR: (gcloud.auth.print-identity-token) Invalid account Type for `--audiences`. Requires valid service account.</span></pre><p id="b1b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好的，<strong class="is hj">有观众的身份令牌只能在</strong>服务账号上生成。为此，</p><ul class=""><li id="bf32" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn lh jv jw jx bi translated">创建服务帐户</li></ul><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="673b" class="ls kf hi lr b fi mo mp l mq mr">gcloud iam service-accounts create test-endpoint</span></pre><ul class=""><li id="5b6c" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn lh jv jw jx bi translated">生成并下载密钥文件。<em class="kd">用您的项目ID </em>替换 <code class="du lo lp lq lr b"><em class="kd">PROJECT_ID</em></code> <em class="kd"/></li></ul><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="bc4d" class="ls kf hi lr b fi mo mp l mq mr">gcloud iam service-accounts keys create key.json \<br/>  --iam-account <a class="ae jo" href="mailto:test-endpoint@gbl-imt-homerider-basguillaueb.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">test-endpoint@PROJECT_ID.iam.gserviceaccount.com</a></span></pre><ul class=""><li id="939a" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn lh jv jw jx bi translated">在gcloud CLI中激活服务帐户</li></ul><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="8319" class="ls kf hi lr b fi mo mp l mq mr">gcloud auth activate-service-account --key-file=key.json</span></pre><p id="68bd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，执行工作测试的所有部分都准备好了</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="0357" class="ls kf hi lr b fi mo mp l mq mr">curl -H "Authorization: Bearer $(gcloud auth print-identity-token \<br/>  --audiences=https://endpoint-&lt;hash&gt;-uc.a.run.app/)" \<br/>  https://endpoint-&lt;hash&gt;-uc.a.run.app/hello?key=&lt;API KEY&gt;</span></pre><p id="e4e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">那管用</strong>！！试打几个电话，是的，<strong class="is hj">额度也是活动的</strong>！</p><p id="3dd4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kd">注意:</em> <strong class="is hj"> <em class="kd">这里只需要一个活动的服务账号</em> </strong> <em class="kd">，没有任何被授予的角色，因为</em> <strong class="is hj"> <em class="kd">只勾选了认证</em> </strong> <em class="kd">。</em></p><h2 id="d082" class="ls kf hi bd kg lt lu lv kk lw lx ly ko jb lz ma ks jf mb mc kw jj md me la mf bi translated">认证转发</h2><p id="53b1" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">在这个模式中，有两个身份验证级别:</p><ol class=""><li id="19d0" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">使用“无角色”服务帐户的云端点的<strong class="is hj">调用者。</strong></li><li id="6e99" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><strong class="is hj">云端点代理，执行对期望的</strong> <code class="du lo lp lq lr b"><strong class="is hj">paths</strong></code>的调用。这里云运行端点服务账号用于在执行对<code class="du lo lp lq lr b">path</code>服务的请求时被认证和授权<em class="kd">(以</em> <code class="du lo lp lq lr b"><em class="kd">run.invoker</em></code> <em class="kd">角色为例)</em>。</li></ol><p id="9347" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这两个认证令牌在请求头中被传输到<code class="du lo lp lq lr b">path</code>服务，其名称如下:</p><ol class=""><li id="9ea7" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">调用者令牌在<code class="du lo lp lq lr b">x-endpoint-api-userinfo</code>头键中。</li><li id="2201" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">云端点代理在<code class="du lo lp lq lr b">authorization</code>头键中。</li></ol><p id="1075" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以使用它们在您的<code class="du lo lp lq lr b">path</code>服务中执行业务级别的检查和/或额外授权。</p><p id="8434" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kd">注意:</em> <strong class="is hj"> <em class="kd">令牌有效性已经检查过了</em> </strong> <em class="kd">，你不用做了，</em> <strong class="is hj"> <em class="kd">简单使用令牌内容</em> </strong> <em class="kd">。</em></p><h2 id="f75e" class="ls kf hi bd kg lt lu lv kk lw lx ly ko jb lz ma ks jf mb mc kw jj md me la mf bi translated">没有API键的API调用</h2><p id="4ea7" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">现在，API密钥还没有用于保护API，并且<strong class="is hj">您可以在没有API密钥</strong>的情况下调用API。<em class="kd">试试看！</em></p><blockquote class="nf"><p id="e00a" class="ng nh hi bd ni nj nk nl nm nn no jn dx translated">如果没有API键，对配额有什么影响？</p></blockquote><p id="58ef" class="pw-post-body-paragraph iq ir hi is b it np iv iw ix nq iz ja jb nr jd je jf ns jh ji jj nt jl jm jn hb bi translated">如前所述，这个云端点配额功能处于测试阶段。因此，今天，当API键丢失时，用于配额限制<strong class="is hj">的项目号是托管云端点服务</strong>的当前项目。</p></div><div class="ab cl mt mu gp mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="hb hc hd he hf"><h1 id="926f" class="ke kf hi bd kg kh na kj kk kl nb kn ko kp nc kr ks kt nd kv kw kx ne kz la lb bi translated">保护您的API</h1><p id="08a7" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">你的API是珍贵的，它是你的服务、信息系统和商业价值的切入点。你必须:</p><ul class=""><li id="4993" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn lh jv jw jx bi translated">确保<strong class="is hj">高水平的可用性</strong>，让客户满意</li><li id="50ed" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lh jv jw jx bi translated">所有API消费者之间正确且<strong class="is hj">公平的延迟/使用</strong></li><li id="ed74" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lh jv jw jx bi translated">用OAuth2代替API密钥的高安全级别</li></ul><p id="dde2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云端点允许你设置所有这些特性，用<strong class="is hj">一个免费的产品，你可以把它放在你想要的地方</strong>。还不完善，配额功能还处于测试阶段，但是使用和发展将巩固这些良好的基础<strong class="is hj">并且伟大的事情将会到来！</strong></p></div></div>    
</body>
</html>