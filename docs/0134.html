<html>
<head>
<title>Yosh in infrastructure land</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Yosh在基础设施用地</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/yosh-in-infrastructure-land-36c54e1bb71f?source=collection_archive---------0-----------------------#2016-08-15">https://medium.com/google-cloud/yosh-in-infrastructure-land-36c54e1bb71f?source=collection_archive---------0-----------------------#2016-08-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8f43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">过去一周左右，我一直在做基础设施方面的工作。不仅仅是因为我认为这很有趣(我真的这么认为)，这也是我正在做的这个客户项目的要求。我们的团队中没有专门的运营人员，所以我想我最好在回到JS领域之前做一些准备。这是我正在做的事情的一个简要概述。</p><h2 id="e157" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">站台</h2><p id="ece6" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">docker(1) 非常酷，因为它允许你创建微小的操作系统来运行你的应用。我非常喜欢为我的应用程序创建小的<a class="ae kd" href="https://www.alpinelinux.org/" rel="noopener ugc nofollow" target="_blank">阿尔卑斯</a>盒子。但是所有这些机器都需要在一台电脑上运行，所以我们得安装那台电脑。</p><p id="a1f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我现在选择的电脑是<a class="ae kd" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云</a>。这是因为与AWS不同，UI并不可怕。和它一起工作真的很好。我知道一些更“严肃”的操作人员可能会说UI不重要，重要的是功能。但是我跑题了；如果我不能理解用户界面，我将不会使用任何功能，所以嘿，谷歌云是我现在喜欢用的。</p><h2 id="e042" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">容器主机</h2><p id="7bf8" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">所以在谷歌云上有一个叫做“谷歌容器引擎”(GKE)的东西。它允许您只需点击一下鼠标就可以设置一个<a class="ae kd" href="http://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> kubernetes </a>集群。它和广告宣传的差不多。不过我喜欢把事情自动化到一个命令，所以我用了<a class="ae kd" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> terraform(1) </a>和<a class="ae kd" href="https://cloud.google.com/sdk/gcloud/" rel="noopener ugc nofollow" target="_blank"> gcloud(1) </a>来实现。</p><p id="0da8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Kubernetes很酷，因为它非常擅长管理容器。如果您曾经使用过docker，您可能会记得写出了一大堆标志来挂载卷、端口、安全性等等。使用kubernetes，您可以将这些标志写在一个(可读性很强的)文件中。yml格式，然后在其上运行<em class="ke"> $ kubectl apply -f &lt;文件&gt; </em>来将其部署到您的集群中。感觉真的很好。</p><p id="08a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Kubernetes可以装各种东西。在没有任何停机时间的情况下部署东西也非常有效。甚至管理秘密也很有效。秘密也只是。包含一些字符串的yml文件。它们都存储在内存中，所以攻击者需要更加努力才能读取它们。</p><p id="7a1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">总而言之:我对kubernetes很满意。它并不完美，但感觉比手工管理容器/机器更上一层楼；而且肯定比heroku少很多魔法。</p><h2 id="9511" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">连续一切</h2><p id="bf42" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">所以能够运行容器很酷，但是我们要在上面运行什么呢？首先要做的是自动化。为了让我们的系统为我们工作，如果我们能够创建连续部署就好了。</p><p id="de1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我对持续部署的看法是这样的:</p><ul class=""><li id="b279" class="kf kg hi ih b ii ij im in iq kh iu ki iy kj jc kk kl km kn bi translated">写了一段代码</li><li id="3c4d" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated">代码被上传到git主机上的一个特性分支</li><li id="b109" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated">测试运行，如果测试通过，我们可以将其合并到我们的开发分支</li><li id="6193" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated">我们的开发分支被自动部署到我们的登台环境中</li><li id="d468" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated">如果我们对我们的登台环境满意，我们将dev合并到master</li><li id="80a0" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated">主服务器自动部署到生产环境中</li></ul><p id="1362" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我选择的工具是<a class="ae kd" href="https://buildkite.com" rel="noopener ugc nofollow" target="_blank"> buildkite </a>。这是一个由了不起的人构建的半自托管自动化提供商。他们只是三个人在做一些超级好用而且看起来非常漂亮的东西。周末我一直穿着他们的<a class="ae kd" href="https://chat.buildkite.com/" rel="noopener ugc nofollow" target="_blank">休闲装</a>，他们给了我超级大的帮助。</p><p id="40a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无论如何，我现在已经为我的容器建立了一个完整的自动化设置，其中我创建了一个包含我的开发依赖项的基础构建，以及一个为生产做好准备的优化构建。我的目录中的docker文件现在具有这样的结构:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="fbc0" class="jd je hi ky b fi lc ld l le lf">.buildkite<br/>docker<br/>  build/<br/>    Dockerfile<br/>  optimize/<br/>    Dockerfile</span></pre><p id="1afa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我这样嵌套docker文件的原因是，不要给docker文件起不同的名字，这应该是最佳实践。啊，在这种情况下，我不介意过多地嵌套目录。</p><h2 id="e4f9" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">坏事</h2><p id="9070" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">到目前为止，我在这个设置中遇到的唯一问题是npm(1)为构建占用了大量内存。我的小机器一直在崩溃。幸运的是，我已经能够通过在Node中设置一些标志来解决这个问题。我的docker文件现在看起来像这样:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="0719" class="jd je hi ky b fi lc ld l le lf">FROM mhart/alpine-node:4<br/><br/># Create app directory<br/>RUN mkdir -p /usr/src/app<br/>WORKDIR /usr/src/app<br/><br/># Install img dependencies from: <a class="ae kd" href="https://pkgs.alpinelinux.org/packages" rel="noopener ugc nofollow" target="_blank">https://pkgs.alpinelinux.org/packages</a><br/>RUN apk update<br/>RUN apk add jq<br/><br/># Install app dependencies<br/>COPY package.json /usr/src/app/<br/>RUN /usr/bin/node \<br/>  --max_semi_space_size=1 \<br/>  --max_old_space_size=198 \<br/>  --max_executable_size=148 \<br/>  /usr/bin/npm install<br/><br/># Add installed binaries to env<br/>ENV PATH /app/node_modules/.bin:$PATH<br/><br/># Bundle app source<br/>COPY . /usr/src/app<br/><br/>EXPOSE 8080<br/>CMD ["npm", "start"]</span></pre><p id="7e7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你在这里看到的所有节点标志防止内存使用失控，防止构建崩溃。唯一的缺点是，现在构建需要很长时间，但至少他们完成了。也许我应该尽快转移到内存超过0.6GB的节点，但谁知道呢？也许吧。</p><h2 id="374e" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">包扎</h2><p id="429d" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">仅此而已。我现在在自己的服务器上运行kubernetes上的一大堆容器。由于我还没有为我的客户完成基础设施的设置，我可能会在未来几天/几周内做更多的工作。我热衷于为自己的基础设施添加更多的机器人。像<a class="ae kd" href="https://github.com/facebook/mention-bot" rel="noopener ugc nofollow" target="_blank">提及机器人</a>和<a class="ae kd" href="https://github.com/jfrazelle/ghb0t" rel="noopener ugc nofollow" target="_blank"> ghb0t </a>这样的东西看起来是不错的补充；但我可以想象把管理机器人军团的想法推进一点。哈。</p><p id="92dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你感兴趣，这里是我一直在做的东西的笔记；也许会有用。</p><ul class=""><li id="88f1" class="kf kg hi ih b ii ij im in iq kh iu ki iy kj jc kk kl km kn bi translated"><a class="ae kd" href="https://github.com/yoshuawuyts/infrastructure" rel="noopener ugc nofollow" target="_blank">https://github.com/yoshuawuyts/infrastructure</a></li><li id="579f" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated"><a class="ae kd" href="https://github.com/yoshuawuyts/playground-docker-buildkite" rel="noopener ugc nofollow" target="_blank">https://github.com/yoshuawuyts/playground-docker-buildkite </a></li><li id="b6da" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated"><a class="ae kd" href="https://github.com/yoshuawuyts/knowledge/blob/master/bin/docker.md" rel="noopener ugc nofollow" target="_blank">https://github.com/yoshuawuyts/knowledge/blob/master/bin/docker.md </a></li><li id="9a87" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated"><a class="ae kd" href="https://github.com/yoshuawuyts/knowledge/blob/master/bin/gcloud.md" rel="noopener ugc nofollow" target="_blank">https://github.com/yoshuawuyts/knowledge/blob/master/bin/gcloud.md </a></li><li id="b883" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated"><a class="ae kd" href="https://github.com/yoshuawuyts/knowledge/blob/master/bin/kubectl.md" rel="noopener ugc nofollow" target="_blank">https://github.com/yoshuawuyts/knowledge/blob/master/bin/kubectl.md </a></li></ul><p id="9ed0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cheers!⚠️</p><p id="b062" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ke"> Cross-posted from </em> <a class="ae kd" href="http://yoshuawuyts.com/writing/./2016-08-15-yosh-in-infrastructure-land" rel="noopener ugc nofollow" target="_blank"> <em class="ke"> https://github.com/yoshuawuyts/writing </em> </a></p></div></div>    
</body>
</html>