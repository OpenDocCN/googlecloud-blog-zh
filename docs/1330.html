<html>
<head>
<title>Shortening URLs with Google Functions and Google Sheets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用谷歌功能和谷歌表单缩短网址</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/shortening-urls-with-google-functions-and-google-sheets-da3a2003557a?source=collection_archive---------1-----------------------#2020-03-19">https://medium.com/google-cloud/shortening-urls-with-google-functions-and-google-sheets-da3a2003557a?source=collection_archive---------1-----------------------#2020-03-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5e3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们都偶然发现了像bit.ly、tinyurl.com或goo.gl这样的网址缩短服务(最后一个不久前被关闭了)。它们让我们不必交流难以拼写或太长的URL(有人试图通过电话口述Google Drive文件夹的URL吗？).因为如果你可以复制/粘贴一个url，这可能很容易，但如果你需要以有限长度的文本(如短信)发送给某人，或者你想将其编码为二维码(较短的字符串更容易扫描)，最好有一个像http://bit.ly/something这样的url(随机URL，似乎会导致带有歌曲的MP3)而不是像这样的URL<a class="ae jd" href="https://drive.google.com/drive/folders/0ByWO0aO1eI_MN1BEd3VNRUZENkU" rel="noopener ugc nofollow" target="_blank">https://drive . Google . com/drive/folders/0 by wo 0 ao1ei _ Mn 1 bed 3 vnruzenku</a>(半随机驱动器链接)</p><p id="a8a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">像这样的服务只需要一个数据库，将短url(/上例中的某个东西)与长URL(<a class="ae jd" href="https://static.stereogum.com/blogs.dir/2/files/mp3/Glen%20Hansard%20-%20Hairshirt%20(Late%20Night%20With%20Jimmy%20Fallon).mp3" rel="noopener ugc nofollow" target="_blank">https://static . stereogum . com/blogs . dir/2/files/MP3/Glen % 20 hansard % 20-% 20 hair shirt % 20(同一示例中的Late % 20 night % 20 with % 20 Jimmy % 20 Fallon). MP3</a>)关联起来，并且在接收到对短URL的请求时，将向请求客户端发出HTTP 302重定向。</p><p id="d331" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在设置中，我建议这个数据库的角色由Google Sheet来完成(我应该从一开始就提到，这更多的是一个个人URL缩短列表，而不是公开的东西——尽管最终公开它只是意味着给任何人对所述Google Sheet的写访问权),并且查找逻辑由一个<a class="ae jd" href="https://console.cloud.google.com/functions/list" rel="noopener ugc nofollow" target="_blank"> Google Cloud函数</a>来实现。</p><h1 id="750e" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">域设置</h1><p id="ab1b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">为了使它完全无服务器，我们可以使用域名注册商的功能(我用的是<a class="ae jd" href="http://www.namecheap.com" rel="noopener ugc nofollow" target="_blank"> Namecheap </a>)来批量解析特定域/子域的请求到预定义的URL(你的云功能的URL)。对于name price，此功能适用于在管理(针对相应的域)/重定向域下使用其基本DNS的任何域</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/2268910426076960b013b3dc33424f42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KA_98NNHbTXD7Q80NnHTpA.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">廉价域名管理</figcaption></figure><p id="f946" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设这个管理页面是针对<strong class="ih hj"> short.domain </strong>的，我们可以通过在源URL中输入short.domain并在目标URL中输入函数的URL(我们将在下面获得)来添加一个重定向。</p><h1 id="3bff" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">谷歌工作表</h1><p id="1ad1" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">由于我们的“数据库”将是一个Google Sheet，只需在Google Drive中创建一个电子表格文档，命名第一个(默认)电子表格“链接”,并通过在列A中输入短URL和在列B中输入长URL来填充它，就像这样</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kx"><img src="../Images/68a9d9d9bd0640476b3ca0e3428bb9d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SlPx8C5PAfQgPvqPE5O3AQ.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">Google工作表中的URL映射</figcaption></figure><p id="d94d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个例子中，http://short.domain/xyz将不得不导致<a class="ae jd" href="https://google.com" rel="noopener ugc nofollow" target="_blank">https://google.com</a>而http://short.domain/yt到YouTube的链接列在那里。你需要注意(并写/复制)的是文档id(g sheet的url看起来类似于https://docs.google.com/spreadsheets/d/123abcdef/edit#gid=0的<a class="ae jd" href="https://docs.google.com/spreadsheets/d/12PfKVI7PDUthtv8Cctr0zdL2v_Z5Rr34cxuDOz60NaI/edit#gid=0" rel="noopener ugc nofollow" target="_blank"/>，使得123abcdef成为文档id)</p><h1 id="5479" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">谷歌云控制台</h1><p id="65d5" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">如果你还没有一个项目，你需要一个在<a class="ae jd" href="https://console.cloud.google.com/projectcreate" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a>中定义的项目。创建项目后，将为其创建一个类似于my-url-project@appspot.gserviceaccount.com的服务帐户(my-url-project是这个新项目的项目ID)。将此电子邮件添加到对上面创建的电子表格具有读取权限的帐户列表中(打开文档并单击右上角的Share)。</p><p id="9b84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从那以后就一帆风顺了，如果你从这里使用代码<a class="ae jd" href="https://github.com/fixone/navigator" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="e4b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">简而言之，代码的作用是:</p><ul class=""><li id="46e8" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated">公开一个从环境中读取一些参数的函数(getLink见<a class="ae jd" href="https://github.com/fixone/navigator/blob/master/index.js#L37" rel="noopener ugc nofollow" target="_blank">此处</a>)(您也可以通过命令行传递这些参数，但前提是您自己在某个服务器上运行它——这违背了无服务器的目的)。我们将在GCF定义中使用这个导出的函数。</li><li id="466d" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">这个函数读取文档中的一个工作表，并从中获取列A和B。</li><li id="c29e" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">然后，它继续遍历A列中的项目，查找req.url中收到的url。如果找到匹配项，它将发送一个重定向到b列中相应的项目。否则，它将把用户重定向到一个默认的URL。</li><li id="cac7" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">您需要提交(使用<a class="ae jd" href="https://git-scm.com/" rel="noopener ugc nofollow" target="_blank"> Git </a>)两个文件(index.js和package.json)到您自己在<a class="ae jd" href="https://source.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">Google Cloud Source Repositories</a>上的repo。我们在部署阶段需要这个。据推测，如果是公开回购，你也可以使用github.com(但我没有尝试过，它可能不会工作)</li><li id="29de" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">一旦完成，你将需要部署它——这可以通过<a class="ae jd" href="https://console.cloud.google.com/functions/add" rel="noopener ugc nofollow" target="_blank"> GCF控制台</a>或使用<a class="ae jd" href="https://cloud.google.com/sdk/gcloud" rel="noopener ugc nofollow" target="_blank"> gcloud </a>来实现。我更喜欢后者，因为它可以更快地进行重新部署(例如，如果您需要在一次新的提交后更改函数)。部署命令是这样的</li></ul><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="4536" class="lr jf hi ln b fi ls lt l lu lv">gcloud functions deploy <strong class="ln hj">navigator</strong> --set-env-vars DOC_ID=123abcdef,SHEET_NAME=links,DEFAULT_URL=https://docs.google.com --allow-unauthenticated --memory 128MB --project my-url-project --region europe-west2 --timeout 10s --runtime nodejs8 --source https://source.developers.google.com/projects/my-url-project/repos/navigator/moveable-aliases/master/paths/ --trigger-http --entry-point <strong class="ln hj">getLink</strong></span></pre><p id="1c39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如您所猜测的那样——第一个粗体项目是函数名(触发器url将包含它),最后一个粗体项目是函数名(取自提交源代码的存储库中的源代码)。命令中出现的其他参数有</p><ul class=""><li id="87ce" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated">运行时:这是一个nodejs v8函数(用于编写逻辑的语言)</li><li id="339d" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">trigger-http:该函数应该通过HTTP/S来触发</li><li id="54d2" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">区域:在哪里部署此功能</li><li id="089e" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">set-env-vars:我们传递三个变量DOC_ID(在Drive中创建文档时检索)、SHEET_NAME(带有链接的工作表的名称)、DEFAULT_URL(如果不匹配，重定向到哪里)</li></ul><p id="bc67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署后，GCP将为该功能创建一个触发器，如下所示</p><p id="8aa6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://europe-west2-my-url-project.cloudfunctions.net/navigator" rel="noopener ugc nofollow" target="_blank">https://Europe-west 2-my-URL-project . cloud functions . net/navigator</a></p><p id="fe40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(europe-west2是因为我们部署在该地区，my-url-project是因为这是我们的项目名称，最后一部分是navigator，因为这是我们想要调用的函数)。</p><p id="0f6b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，任何对例如<a class="ae jd" href="https://europe-west2-my-url-project.cloudfunctions.net/navigator/abc" rel="noopener ugc nofollow" target="_blank">https://Europe-west 2-my-URL-project . cloud functions . net/navigator/ABC</a>(假设电子表格如上定义)的调用都会将用户重定向到<a class="ae jd" href="https://drive.google.com." rel="noopener ugc nofollow" target="_blank">https://drive.google.com。</a>注意(如果你以前使用过expressJS，可能会不太直观)req.url将被设置为/abc，即使该函数响应/navigator/abc。</p><p id="e05f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那都是乡亲们！</p></div></div>    
</body>
</html>