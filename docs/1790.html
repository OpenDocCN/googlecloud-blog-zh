<html>
<head>
<title>The Misadventures of One Cloud Function</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个云函数的不幸遭遇</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/the-misadventures-of-one-cloud-function-edd8e4036e92?source=collection_archive---------0-----------------------#2021-02-05">https://medium.com/google-cloud/the-misadventures-of-one-cloud-function-edd8e4036e92?source=collection_archive---------0-----------------------#2021-02-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0774" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">“管用！!"</strong></p><p id="c265" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你知道当你调试了几天的东西终于工作时那种甜蜜的、闪闪发光的感觉吗？</p><p id="03f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为一名偶然成为常驻GCP专家的平台工程师，我在过去的一年里一直与我们的数据工程师密切合作。我帮助他们构建架构，定义或帮助他们定义“基础设施即代码”,提醒他们不要在生产中进行测试，并考虑安全性。说到这个…</p><blockquote class="jd"><p id="b9b2" class="je jf hi bd jg jh ji jj jk jl jm jc dx translated">我们越是深入云技术，越是拥抱微服务，越是冒险进入无服务器领域，就有越多的数据四处流动，随时可以被利用或被攻破。</p></blockquote><p id="c63f" class="pw-post-body-paragraph if ig hi ih b ii jn ik il im jo io ip iq jp is it iu jq iw ix iy jr ja jb jc hb bi translated">对于我们这些工作负载完全是云原生的人来说，数据分析的前景是光明的，充满了奇迹:AWS Lake Formation and Redshift，GCP数据流和BigQuery，ML和NLP工具的口袋-一切都是为了构建一个只适合您公司的数据平台。</p><p id="868b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要保护的东西太多了。</p><p id="b4aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌云平台(GCP)，提供面向数据工程的广泛服务；以及多种安全工具，您可以使用这些工具来保护宝贵的数据。</p><p id="5b6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能希望使用数据流来消费Kafka的主题，将其存储在GCS或Big Query中，使用DataProc或Cloud Composer运行数据转换，使用AI笔记本实现数据科学和机器学习，并在Data Studio中构建漂亮、有洞察力的仪表板。</p><p id="c260" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种架构可能是这样的:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/3fac96b1dcd233c8a000ada65cd493f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UP-wCbphpTXc7tof"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">使用GCP服务构建的数据管道示例</figcaption></figure><p id="cba2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“但是Natalie，”你说，“大多数服务都是公共API，你如何确保入侵者——或者恶意的内部人员——不会从你的大型查询数据集中泄露敏感数据？”</p><h2 id="206c" class="ki kj hi bd kk kl km kn ko kp kq kr ks iq kt ku kv iu kw kx ky iy kz la lb lc bi translated"><strong class="ak"> VPC服务控制</strong></h2><p id="f43c" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">云中的安全性可能是云提供商需要证明的最激烈的论点。今天，我们有大量的安全控制可供选择，在数据保护方面，GCP为我们提供了一种叫做VPC服务控制的东西。</p><p id="c5f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">VPC服务控制是一套工具，您可以应用它来限制在您的GCP项目中对谷歌服务的访问。你可以把它想象成类固醇上的防火墙:你通过把它们放入服务边界来定义你想要保护的项目；决定要限制哪些API，以及谁可以从哪里访问这些API。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es li"><img src="../Images/91b76ecc4aea0cfc0a116faae4eeb51f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rNX7FAHOmx8cF9Xl6B4_CA.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">VPC服务控制通过将Google APIs限制在服务范围内来保护您的数据</figcaption></figure><p id="b524" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当使用与上面类似的数据平台时，您想要保护的API列表包括:</p><pre class="jt ju jv jw fd lj lk ll lm aw ln bi"><span id="0390" class="ki kj hi lk b fi lo lp l lq lr">[“bigquery.googleapis.com”,<br/>“storage.googleapis.com”,<br/>“logging.googleapis.com”,<br/>“monitoring.googleapis.com”,<br/>“notebooks.googleapis.com”,]</span></pre><p id="0f71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">限制API意味着您在受保护项目中创建的资源将无法再通过通常的DNS地址从Internet访问；相反，这些请求将被重定向到一个专用域名——restricted.googleapis.com，进而指向谷歌管理的一组特殊IP。</p><p id="b511" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后定义访问控制，称为访问级别，通常会列出内部IP、公司设备设置或一些特殊服务帐户。只有与这些过滤器中的至少一个匹配的请求才会到达受保护的资源。</p><h2 id="8a34" class="ki kj hi bd kk kl km kn ko kp kq kr ks iq kt ku kv iu kw kx ky iy kz la lb lc bi translated"><strong class="ak">现在可以用云功能了吗？</strong></h2><p id="63cf" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">当然啦！无服务器是最近的时尚，你的使用案例是什么？</p><p id="9343" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们有一个外部供应商向存储桶提交报告。您可以创建一个云函数，该函数将监听存储桶中的特定路径，一旦写入一个文件，它将读取数据并将数据的一些转换版本写入BigQuery表。</p><p id="fdb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要将该函数作为您为其创建的特殊服务帐户来运行，并通过将它添加到服务边界中的受限API列表来保护云函数API。</p><p id="42cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，通常，在同一个GCP项目中运行的服务应该能够很好地通信…</p><pre class="jt ju jv jw fd lj lk ll lm aw ln bi"><span id="fcd6" class="ki kj hi lk b fi lo lp l lq lr">ERROR: VPC Service Controls: Request is prohibited by organization’s policy.</span></pre><p id="66e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">啊，对了，好吧——也许我们需要将计算引擎默认服务帐户添加到访问级别；再试一次？</p><pre class="jt ju jv jw fd lj lk ll lm aw ln bi"><span id="0442" class="ki kj hi lk b fi lo lp l lq lr">ERROR: VPC Service Controls: Request is prohibited by organization’s policy.</span></pre><p id="a446" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">嗯。RTFM！谷歌使用一种叫做Cloud Build的特殊服务，它将在一个单独的、不可见的、所谓的“影子”项目中构建你的功能，然后让它可以在你的实际项目中执行。GCP用很多这样的影子工程来做各种各样的魔术。它使得许多托管服务非常易于使用，但也无助于调试。</p><p id="cf1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无论如何，让我们将云构建服务帐户添加到服务边界的访问级别中。</p><pre class="jt ju jv jw fd lj lk ll lm aw ln bi"><span id="ddc6" class="ki kj hi lk b fi lo lp l lq lr">ERROR: VPC Service Controls: Request is prohibited by organization’s policy.</span></pre><p id="d290" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好吧好吧。让我们看看日志是否会给我们一些清晰。请求传递的是哪个主体？</p><pre class="jt ju jv jw fd lj lk ll lm aw ln bi"><span id="4f8e" class="ki kj hi lk b fi lo lp l lq lr">“authenticationInfo”: {<br/>“principalEmail”: “special-service-account@your-project.iam.gserviceaccount.com”,<br/>  “serviceAccountDelegationInfo”: [<br/>    {<br/>      “firstPartyPrincipal”: {<br/>        “principalEmail”: “service-098765432345@gcf-admin-robot.iam.gserviceaccount.com”<br/>    }<br/>  }]<br/>},</span></pre><p id="968a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这很令人困惑。该函数是作为指定的服务帐户运行的，但还有一个firstPartyPrincipal，它既不是计算引擎，也不是云构建帐户？！</p><p id="6d98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">解决方案</strong></p><p id="e9e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然我们有足够的数据来分析云功能实际上是如何调用其他GCP服务的，我们知道我们需要做什么:</p><ol class=""><li id="28a2" class="ls lt hi ih b ii ij im in iq lu iu lv iy lw jc lx ly lz ma bi translated">将云功能API限制在服务范围内</li><li id="e8a0" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">将云功能、计算引擎和云构建机器人服务帐户添加到访问级别</li><li id="52a4" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">将我们为函数创建的运行时服务帐户添加到访问级别</li></ol><p id="cdb9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不得不管理所有这些服务客户列表会变得<strong class="ih hj">繁琐</strong>。虽然机器人sa总是遵循相同的命名模式，并且可以根据项目编号进行预测，但是我们为每个功能创建的任意自定义服务帐户却不能。</p><p id="20c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个功能有一个单独的服务帐户的全部原因是安全性:默认的计算引擎SA获得项目的编辑角色，这太开放了。</p><p id="b15e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里的折衷方案是创建一个专门用于GCP项目的云功能SA，而不是一个单一的云功能。如果您遵循专用项目的架构，并且单个SA访问其项目中所有数据的风险是可以接受的，那么您可以轻松地自动化整个设置！你的谷歌云数据平台将是安全的，但功能强大，并提供更好的用户体验。</p><p id="bc6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是如何使用Terraform实现这一点。</p><ol class=""><li id="df17" class="ls lt hi ih b ii ij im in iq lu iu lv iy lw jc lx ly lz ma bi translated">将建立一个项目的所有资源打包成一个模块<br/>使用模块使你的代码可重用！</li></ol><pre class="jt ju jv jw fd lj lk ll lm aw ln bi"><span id="deb1" class="ki kj hi lk b fi lo lp l lq lr">module "your-project" {<br/>  source = "../shiny-modules/gcp-project"<br/>  name = "your-project"<br/>  # we will base certain resources on this list of services<br/>  services = ["bigquery", "cloudfunctions"]<br/>}</span></pre><p id="575a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.GCP-项目模块</p><pre class="jt ju jv jw fd lj lk ll lm aw ln bi"><span id="e6a0" class="ki kj hi lk b fi lo lp l lq lr"># Add a label if Cloud Functions are requested — we will use it later</span><span id="2d66" class="ki kj hi lk b fi mg lp l lq lr">locals {<br/>  cloudfunctions = contains(var.services, “cloudfunctions”) ? “enabled” : “disabled”<br/>  labels         = merge(var.labels, {<br/>    “cloudfunctions” = local.cloudfunctions<br/>    })<br/>}</span><span id="42aa" class="ki kj hi lk b fi mg lp l lq lr">resource “google_project” “project” {<br/>  name   = var.name<br/>  labels = local.labels<br/>}</span><span id="b974" class="ki kj hi lk b fi mg lp l lq lr"># Create a project-dedicated SA to use in Cloud Functions<br/># A standard SA name will make the setup automatable</span><span id="3cf6" class="ki kj hi lk b fi mg lp l lq lr">resource “google_service_account” “sa” {<br/>  count        = contains(var.services, “cloudfunctions”) ? 1 : 0</span><span id="2018" class="ki kj hi lk b fi mg lp l lq lr">  account_id   = “cf-runtime”<br/>  display_name = “Cloud Functions runtime service account”<br/>}</span></pre><p id="3638" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.VPC服务控制配置—使其在项目部署后自动部署；)</p><pre class="jt ju jv jw fd lj lk ll lm aw ln bi"><span id="99dc" class="ki kj hi lk b fi lo lp l lq lr"># Find out all project numbers where Cloud Functions are enabled</span><span id="411f" class="ki kj hi lk b fi mg lp l lq lr">data “google_projects” “cf_enabled_prj” {<br/>  filter = “labels.cloudfunctions=enabled lifecycleState:ACTIVE”<br/>}</span><span id="97f7" class="ki kj hi lk b fi mg lp l lq lr">data “google_project” “cf_enabled_prj_numbers” {<br/>  count = length(data.google_projects.cf_enabled_prj.projects)</span><span id="14d1" class="ki kj hi lk b fi mg lp l lq lr">  project_id = lookup(<br/>    data.google_projects.cf_enabled_prj.projects[count.index],<br/>    “project_id”<br/>    )<br/>}</span><span id="ce10" class="ki kj hi lk b fi mg lp l lq lr"># Compile a list of SAs you need to add to the access levels</span><span id="4f1e" class="ki kj hi lk b fi mg lp l lq lr">locals = {<br/>  cf_sa_list = formatlist(<br/>    “serviceAccount:service-%s@gcf-admin-robot.iam.gserviceaccount.com”, data.google_project.cf_enabled_prj_numbers.*.number)</span><span id="bbd1" class="ki kj hi lk b fi mg lp l lq lr">  cloudbuild_sa_list = formatlist(<br/>    “serviceAccount:%s@cloudbuild.gserviceaccount.com”, data.google_project.cf_enabled_prj_numbers.*.number)</span><span id="36dd" class="ki kj hi lk b fi mg lp l lq lr">  cloudbuild_agent_sa_list = formatlist(<br/>    “serviceAccount:service-%s@gcp-sa-cloudbuild.iam.gserviceaccount.com”, data.google_project.cf_enabled_prj_numbers.*.number)</span><span id="0529" class="ki kj hi lk b fi mg lp l lq lr">  runtime_cf_sa_list = formatlist(<br/>    “serviceAccount:cf-runtime@%s.iam.gserviceaccount.com”, data.google_projects.cf_enabled_prj.*.project_id)<br/>}</span><span id="60ad" class="ki kj hi lk b fi mg lp l lq lr"># And add them to an access level</span><span id="8167" class="ki kj hi lk b fi mg lp l lq lr">resource “google_access_context_manager_access_level” “cloud_functions_access_level” {<br/>  parent = "accessPolicies/${access_policy_name}"<br/>  name   = "accessPolicies/${access_policy_name}/accessLevels/cloud_functions_access_level"<br/>  title  = "cloud_functions_access_level"</span><span id="8154" class="ki kj hi lk b fi mg lp l lq lr">basic {<br/>  conditions {<br/>  members = [<br/>    concat(<br/>      local.cf_sa_list,<br/>      local.cloudbuild_sa_list,<br/>      local.cloudbuild_agent_sa_list,<br/>      local.runtime_cf_sa_list)<br/>  ]<br/>}}}</span><span id="808a" class="ki kj hi lk b fi mg lp l lq lr"># Include the access level in the service perimeter</span><span id="5901" class="ki kj hi lk b fi mg lp l lq lr">resource "google_access_context_manager_service_perimeter" "perimeter" {<br/>  parent = "accessPolicies/${access_policy_name}"<br/>  name   = "accessPolicies/${access_policy_name}/servicePerimeters/perimeter"<br/>  title  = "perimeter"</span><span id="2243" class="ki kj hi lk b fi mg lp l lq lr">status {<br/>    resources           = var.restricted_project_numbers<br/>    restricted_services = var.restricted_apis</span><span id="1410" class="ki kj hi lk b fi mg lp l lq lr">    access_levels       = [<br/>google_access_context_manager_access_level.cloud_functions_access_level.name<br/>    ]<br/>  }<br/>}</span></pre><p id="3e3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好了，<em class="mh">现在</em>你可以安全地使用云功能了！那真是一段旅程。</p><p id="e78e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常，当构建新的东西时，我们会发现技术中没有很好描述或记录的角落。我们喜欢称之为出血边缘。</p><p id="7211" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是工具已经为您准备好了—使用它们，与您的团队合作，适应您的工作流程—您会找到合适的解决方案。</p><p id="9cea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="mh">本文首次为DevSecCon " sec advent Calendar " 2020:</em><a class="ae mi" href="https://www.devseccon.com/the-misadventures-of-one-cloud-function-secadvent-day-14-2/" rel="noopener ugc nofollow" target="_blank"><em class="mh">https://www . DevSecCon . com/the-misadventures-of-one-cloud-function-sec advent-day-14-2/</em></a></p></div></div>    
</body>
</html>