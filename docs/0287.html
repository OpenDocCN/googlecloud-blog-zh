<html>
<head>
<title>Understanding and Profiling GCE cold-boot time</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解和分析GCE冷启动时间</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/understanding-and-profiling-gce-cold-boot-time-32c209fe86ab?source=collection_archive---------1-----------------------#2017-05-18">https://medium.com/google-cloud/understanding-and-profiling-gce-cold-boot-time-32c209fe86ab?source=collection_archive---------1-----------------------#2017-05-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/d9dc4b6b7d36750855f51f34b01f8003.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i8gFMHNLtQJj-DnrepTSjw.jpeg"/></div></div></figure><div class=""/><p id="0cda" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上周我在纽约做了一个演讲，在那里我见到了“FoodiePics”的幕后人员，这是一个只允许你分享食物图片的社交网络。没有文字。没有音频。没有表情符号。只有一张食物的照片，以及拍摄地点的地理位置标签。</p><p id="2c6e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">原来，他们已经阅读了我以前关于App Engine启动性能的文章，并来找我帮助他们的应用程序，他们的Google Compute Engine实例遇到了类似的冷启动问题。他们的GCE实例拍摄上传的照片，对它们运行一些逻辑(以确保照片是食物)，并压缩和存储它以备后用。他们给我看了一张类似这样的图表:</p><figure class="jp jq jr js fd hk er es paragraph-image"><div class="er es jo"><img src="../Images/c5fed0167367e61be2d4b1708f64fafc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*uLL7inggH5b6WRze0cl__A.png"/></div></figure><p id="517c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">他们看到他们的应用程序的冷启动时间超过380秒，而请求的响应延迟在300毫秒左右。</p><p id="7bdf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这一点上，我还没有机会深入研究GCE冷启动性能，所以我很乐意以此为借口进行进一步的研究。</p><p id="ead9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们开始吧！</p><figure class="jp jq jr js fd hk"><div class="bz dy l di"><div class="jt ju l"/></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">嘿！忙到没时间看书？检查TL；上面的DR视频！</figcaption></figure><h1 id="e364" class="jz ka ht bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">GCE启动本身有多快？</h1><p id="47b4" class="pw-post-body-paragraph iq ir ht is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">此时，您可能会在我的性能调试模式中看到一个共同的趋势:当试图跟踪这样的性能问题时，我首先喜欢删除我的代码，并建立一个基线，以了解我的代码对事情的影响有多严重。</p><p id="5c7d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，解决问题的第一步是运行一个快速测试，看看是否:</p><p id="f543" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1)给定一个静态配置，GCE实例从“plz create”到“ok，你可以SSH给我”需要多长时间？</p><p id="d01e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2)给定配置的变化，这个数字如何变化？</p><p id="aeca" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以，让我们做一个简单的测试，启动一个实例只需20次迭代，计时我们可以ssh到它的时间，然后杀死它。</p><figure class="jp jq jr js fd hk er es paragraph-image"><div class="er es lc"><img src="../Images/6d9caa5a7fbdde841dc48e9b89029d3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*6gcgc4WMOpYYk_ZGh2PVJw.png"/></div></figure><p id="4e69" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">平均来说，一个2CPU、8GB的虚拟机(运行debian)需要41.5秒才能启动。如果我增加内核和内存数量会怎么样？我认为改善资源应该会缩短启动时间，因为有更多的周期可以帮助映像启动和运行。</p><figure class="jp jq jr js fd hk er es paragraph-image"><div class="er es ld"><img src="../Images/3b76c05bf535a14ccc4078e99f507468.png" data-original-src="https://miro.medium.com/v2/resize:fit:942/format:webp/1*GQKo3CmHeA1o9z6To5xBVw.png"/></div></figure><p id="b5ff" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里的平均时间是49.39秒。稍微差一点，但仍在误差范围内。这种情况会继续线性恶化吗？让我们向前跳4x看看。</p><figure class="jp jq jr js fd hk er es paragraph-image"><div class="er es le"><img src="../Images/1ac5e233ec817e9dffa6fc65eaee4056.png" data-original-src="https://miro.medium.com/v2/resize:fit:926/format:webp/1*HR_ScWpP5AfST4viZ8gDiQ.png"/></div></figure><p id="0c3e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个时间平均约为52秒，这与我认为vm启动时间与请求的资源成线性关系的想法不完全一致；这些数字似乎都在误差范围内。我们很容易看到大约30秒的启动时间，根据配置开销的不同，会出现峰值。</p><p id="41db" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">也就是说，GCE最近将虚拟机可以请求的最大CPU数量增加到64个，当我们测试启动时间时，我们确实看到平均冷启动时间始终高于其他配置:</p><figure class="jp jq jr js fd hk er es paragraph-image"><div class="er es lf"><img src="../Images/ccea9e07b7a9e84c0875517201bca9c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:916/format:webp/1*NaS4rILp1giGPYhmDxUtDg.png"/></div></figure><p id="e3df" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里的平均时间似乎是73秒。比其他的要高一点。</p><p id="28a1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">无论如何，这些数字让我知道了两件事:</p><p id="cb19" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">GCE虚拟机的冷启动时间与CPU/Ram配置无关(64核的情况除外，后者更高)</p><p id="ced3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2)<em class="lg">FoodiePics</em>虚拟机的300秒冷启动时间是由其他原因造成的。</p><h1 id="b08b" class="jz ka ht bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">让我们检查图像？</h1><p id="7eec" class="pw-post-body-paragraph iq ir ht is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">为了确保我已经完成了这个测试，让我们再运行一个测试，看看您可以使用的图像类型。Google计算引擎使用操作系统<a class="ae lh" href="https://cloud.google.com/compute/docs/images" rel="noopener ugc nofollow" target="_blank">映像</a>为您的实例创建根持久磁盘。如果你不熟悉这个术语，我们在这里不谈论<a class="ae lh" rel="noopener" href="/@duhroach/reducing-jpg-file-size-e5b27df3257c#.ic4dzzls9"> JPGs </a>。从这个意义上来说,“映像”是包含引导加载程序、操作系统和根文件系统二进制数据文件。当您创建实例时指定一个图像，当它被创建时，第一步是将图像数据拷贝到您创建的实例的磁盘上。</p><p id="3215" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以，我们来做一个小测试:保持配置不变，但改变图像类型；这对冷启动时间有什么影响？(在这次测试中，我使用的是<em class="lg">Ubuntu-14–04</em>和<em class="lg"> windows-2012-r2 </em>)</p><figure class="jp jq jr js fd hk er es paragraph-image"><div class="er es li"><img src="../Images/3cfbad5b8196f50fc07f584b682f4172.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*fDdVBXKId53iXYGRcWZS3g.png"/></div></figure><p id="9927" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">毫不奇怪，结果有一些变化。大多数基于linux的构建表现得非常相似，但是windows构建要慢得多。</p><p id="14c8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是<em class="lg"> FoodiePics </em>使用的是linux虚拟机，而且一次只启动一两个；所以图像的选择与他们缓慢的冷嘘时间没有任何关系。</p><h1 id="ed95" class="jz ka ht bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">旁白:请求和配置时间</h1><p id="e40a" class="pw-post-body-paragraph iq ir ht is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">对事物进行剖析的一个好的副作用是，你通常最终会学到更多你以前不了解的系统的某些部分(或者更确切地说，你最终会给以前的后台系统增加透明度)。也就是说，GCE在<em class="lg"> </em> <strong class="is hu">响应您的请求、配置您的虚拟机、</strong>然后启动您的实例时有明显的延迟。(你可以在这里阅读更多关于官方<a class="ae lh" href="https://cloud.google.com/compute/docs/instances/checking-instance-status" rel="noopener ugc nofollow" target="_blank">舞台的信息)</a></p><p id="9388" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在同事<a class="ae lh" href="https://twitter.com/tpryan" rel="noopener ugc nofollow" target="_blank"> Cloud DA Terry Ryan </a>的帮助下，我能够获得他们申请的每个阶段的资料，如下所示:</p><figure class="jp jq jr js fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lj"><img src="../Images/175e8d95e28122b9151eb1121bc9c6b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_pv-ReILGSRui43rz3o-KA.png"/></div></div></figure><p id="94c6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">具体来说:</p><ul class=""><li id="8090" class="lk ll ht is b it iu ix iy jb lm jf ln jj lo jn lp lq lr ls bi translated"><strong class="is hu">请求</strong>是从请求虚拟机到从API得到确认你已经请求的响应之间的时间。在我的测试中，这是服务响应<a class="ae lh" href="https://cloud.google.com/compute/docs/reference/latest/instances/insert" rel="noopener ugc nofollow" target="_blank"> insert instance </a> REST命令所用时间的计时。</li><li id="87f4" class="lk ll ht is b it lt ix lu jb lv jf lw jj lx jn lp lq lr ls bi translated"><strong class="is hu">供应</strong>是GCE在其庞大的架构上为您的虚拟机寻找空间所花费的时间；这可以通过定期轮询<a class="ae lh" href="https://cloud.google.com/compute/docs/reference/latest/instances/get" rel="noopener ugc nofollow" target="_blank"> Get实例API </a>并等待“状态”标志从“供应”设置为“运行”来找到。</li><li id="0448" class="lk ll ht is b it lt ix lu jb lv jf lw jj lx jn lp lq lr ls bi translated"><strong class="is hu">开机时间</strong>是你所期待的；映像安装和自定义代码执行，直到我的服务可用。</li></ul><p id="2bb7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该图显示，每当您想要启动新实例时，大约有7秒用于响应请求，大约18秒用于配置虚拟机。</p><p id="aa52" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当创建实例的请求来自负载均衡器时，还不清楚(现在还不清楚)这些时间是否相似，但是要记住这一点。</p><h1 id="7a1c" class="jz ka ht bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">再来一份..性能</h1><p id="24e8" class="pw-post-body-paragraph iq ir ht is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">有许多小事都会影响GCE实例的冷启动时间。当你试图追踪问题时，消除潜在的问题和找到原因一样重要。</p><p id="8f31" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以，通过这些小测试，我们发现:</p><p id="d61e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1)冷启动时间相对于CPU/Ram配置是不变的</p><p id="38ae" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2)启动时间受您选择的映像的影响。大多数Linux操作系统都是一样的，但是Linux / Win之间有很大的差异</p><p id="fede" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3)这显然是FoodiePics在启动实例时在代码中做的事情。</p><p id="ff47" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在做了进一步的调查之后，我们确实发现了问题所在；但是这是另一篇文章的主题；)</p><h2 id="375f" class="ly ka ht bd kb lz ma mb kf mc md me kj jb mf mg kn jf mh mi kr jj mj mk kv ml bi translated">嘿！</h2><p id="8855" class="pw-post-body-paragraph iq ir ht is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">想了解更多关于如何<a class="ae lh" rel="noopener" href="/@duhroach/understanding-and-profiling-app-engine-cold-boot-time-908431aa971d">剖析App引擎启动时间</a>？<br/>想了解更多关于<a class="ae lh" rel="noopener" href="/@duhroach/app-engine-scheduler-settings-and-instance-count-4d1e669f33d5"> GAE的调度器设置</a>？<br/>想知道首先避免<a class="ae lh" rel="noopener" href="/@duhroach/app-engine-startup-time-and-the-global-variable-problem-7ab10de1f349">启动新实例的方法</a>？<br/>想成为<a class="ae lh" href="http://shop.oreilly.com/product/0636920052036.do" rel="noopener ugc nofollow" target="_blank">数据压缩专家</a>？</p></div></div>    
</body>
</html>