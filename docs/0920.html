<html>
<head>
<title>A Guide to Deploy Flask App on Google Kubernetes Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google Kubernetes引擎上部署Flask应用程序的指南</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/a-guide-to-deploy-flask-app-on-google-kubernetes-engine-bfbbee5c6fb?source=collection_archive---------0-----------------------#2019-02-18">https://medium.com/google-cloud/a-guide-to-deploy-flask-app-on-google-kubernetes-engine-bfbbee5c6fb?source=collection_archive---------0-----------------------#2019-02-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div class="er es hg"><img src="../Images/8194126f00fdf7bc7c8ce7be16d8de20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*9Qt1QBMmQiR4QAyfxKgqRA.png"/></div></figure><div class=""/><p id="5fae" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这是一个简单的指南，帮助你在<a class="ae jk" href="https://cloud.google.com/kubernetes-engine/" rel="noopener ugc nofollow" target="_blank">谷歌Kubernetes引擎</a>上部署<a class="ae jk" href="http://flask.pocoo.org/" rel="noopener ugc nofollow" target="_blank"> Flask </a>应用。本指南应该适用于任何Kubernetes集群。</p><p id="c74b" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">假设我们想将以下Flask应用程序部署到Kubernetes:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="ebf9" class="ju jv hp jq b fi jw jx l jy jz">.<br/>├── app.py<br/>├── config.py<br/>└── requirements.txt</span></pre><figure class="jl jm jn jo fd hk"><div class="bz dy l di"><div class="ka kb l"/></div></figure><figure class="jl jm jn jo fd hk"><div class="bz dy l di"><div class="ka kb l"/></div></figure><figure class="jl jm jn jo fd hk"><div class="bz dy l di"><div class="ka kb l"/></div></figure><p id="4caf" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这个应用程序是一个简单的HTTP服务器，监听指定的<code class="du kc kd ke jq b">PORT</code>号。我们可以通过设置<code class="du kc kd ke jq b">DEBUG_MODE</code>环境变量来启用/禁用调试模式。我们可以使用以下命令在本地运行HTTP服务器:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="20d4" class="ju jv hp jq b fi jw jx l jy jz">gunicorn app:app --config=config.py</span></pre></div><div class="ab cl kf kg gp kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hb hc hd he hf"><h1 id="51b0" class="km jv hp bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">将烧瓶应用程序归档</h1><p id="6b85" class="pw-post-body-paragraph im in hp io b ip lj ir is it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj hb bi translated">在将Flask应用程序部署到Google Kubernetes引擎之前，我们需要对其进行dockerize。创建名为<code class="du kc kd ke jq b">Dockerfile</code>的新文件，并添加以下配置:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="5f2d" class="ju jv hp jq b fi jw jx l jy jz">FROM python:3.6-jessie</span><span id="337a" class="ju jv hp jq b fi lo jx l jy jz">RUN apt update</span><span id="e475" class="ju jv hp jq b fi lo jx l jy jz">WORKDIR /app<br/>ADD requirements.txt /app/requirements.txt<br/>RUN pip install -r /app/requirements.txt</span><span id="ec8a" class="ju jv hp jq b fi lo jx l jy jz">ADD . /app</span><span id="48b1" class="ju jv hp jq b fi lo jx l jy jz">ENV PORT 8080<br/>CMD ["gunicorn", "app:app", "--config=config.py"]</span></pre><p id="1544" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用以下命令在Google云平台上构建docker映像:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="fbf8" class="ju jv hp jq b fi jw jx l jy jz">gcloud builds --project YOUR_PROJECT_NAME \<br/>    submit --tag gcr.io/YOUR_PROJECT_NAME/flask-app:v1 .</span></pre><p id="c168" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为下一步保存标记名。</p></div><div class="ab cl kf kg gp kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hb hc hd he hf"><h1 id="5448" class="km jv hp bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">部署到Google Kubernetes引擎</h1><p id="bd15" class="pw-post-body-paragraph im in hp io b ip lj ir is it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj hb bi translated">首先，确保您可以访问Kubernetes集群。要部署到Kubernetes，创建名为<code class="du kc kd ke jq b">app.yaml</code>的新部署配置，并添加以下内容:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="5550" class="ju jv hp jq b fi jw jx l jy jz">apiVersion: apps/v1beta2<br/>kind: Deployment<br/>metadata:<br/>  name: flask-app-tutorial<br/>  labels:<br/>    name: flask-app-tutorial<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      name: flask-app-tutorial<br/>  template:<br/>    metadata:<br/>      name: flask-app-tutorial<br/>      labels:<br/>        name: flask-app-tutorial<br/>    spec:<br/>      containers:<br/>        - name: flask-app-tutorial<br/>          image: gcr.io/kumparan-data-staging/flask-app:v1<br/>          ports:<br/>            - containerPort: 8080<br/>          resources:<br/>            requests:<br/>              memory: 256Mi<br/>            limits:<br/>              memory: 512Mi<br/>          env:<br/>            - name: DEBUG_MODE<br/>              value: "1"</span></pre><p id="2072" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用以下命令将Flask应用程序部署到kubernetes集群:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="5577" class="ju jv hp jq b fi jw jx l jy jz">kubectl apply -f app.yaml</span></pre><p id="6789" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用以下命令公开端口:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="50d9" class="ju jv hp jq b fi jw jx l jy jz">kubectl expose deployment flask-app-tutorial \<br/>    --type=LoadBalancer --port 80 --target-port 8080</span></pre><p id="a3fb" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可以使用以下命令获取部署的Flask应用程序URL:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="c137" class="ju jv hp jq b fi jw jx l jy jz">kubectl get services -l name=flask-app-tutorial</span></pre><p id="a8c7" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您将获得内部和外部IP。如果你想在kubernetes集群之外访问Flask应用，你可以使用外部IP。</p><p id="f24a" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下一步是使用以下命令启用自动缩放:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="2432" class="ju jv hp jq b fi jw jx l jy jz">kubectl scale deployment flask-app-tutorial --replicas=NUMBER</span><span id="b076" class="ju jv hp jq b fi lo jx l jy jz">kubectl autoscale deployment flask-app-tutorial \<br/>    --min=NUMBER --max=NUMBER \<br/>    --cpu-ratio=FLOAT --replicas=NUMBER</span></pre><p id="2bf2" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果要重新部署，需要构建新的映像，然后运行以下命令:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="f5fa" class="ju jv hp jq b fi jw jx l jy jz">kubectl set image deployment/flask-app-tutorial \<br/>    flask-app-tutorial=NEW_IMAGE_TAG</span></pre><p id="aaf5" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">完成了。</p></div><div class="ab cl kf kg gp kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hb hc hd he hf"><h1 id="2d28" class="km jv hp bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">秘密环境变量</h1><p id="345b" class="pw-post-body-paragraph im in hp io b ip lj ir is it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj hb bi translated">假设您想要存储一些秘密(秘密令牌等)，您可以使用<a class="ae jk" href="https://kubernetes.io/docs/concepts/configuration/secret/" rel="noopener ugc nofollow" target="_blank"> kubernetes secrets </a>来处理这些。首先，您需要将您的秘密令牌编码为base64。您可以使用以下命令:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="6d41" class="ju jv hp jq b fi jw jx l jy jz">echo -n "YOUR_SECRET_TOKEN" | base64</span></pre><p id="bc00" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下一步是创建名为<code class="du kc kd ke jq b">secret.yaml</code>的yaml文件，然后添加以下配置:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="68a5" class="ju jv hp jq b fi jw jx l jy jz">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: flask-app-secrets<br/>type: Opaque<br/>data:<br/>  secret_token: $YOUR_ENCODED_BASE64_TOKEN</span></pre><p id="5d6b" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">运行以下命令来创建密码:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="9776" class="ju jv hp jq b fi jw jx l jy jz">kubectl apply -f secret.yaml</span></pre><p id="2ce1" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，您可以通过部署配置中的环境变量访问它，如下所示:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="1de5" class="ju jv hp jq b fi jw jx l jy jz">apiVersion: apps/v1beta2<br/>kind: Deployment<br/>metadata:<br/>  name: flask-app-tutorial<br/>  labels:<br/>    name: flask-app-tutorial<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      name: flask-app-tutorial<br/>  template:<br/>    metadata:<br/>      name: flask-app-tutorial<br/>      labels:<br/>        name: flask-app-tutorial<br/>    spec:<br/>      containers:<br/>        - name: flask-app-tutorial<br/>          image: gcr.io/kumparan-data-staging/flask-app:v1<br/>          ports:<br/>            - containerPort: 8080<br/>          resources:<br/>            requests:<br/>              memory: 256Mi<br/>            limits:<br/>              memory: 512Mi<br/>          env:<br/>            - name: DEBUG_MODE<br/>              value: "1"<br/>            - name: SECRET_TOKEN<br/>              valueFrom:<br/>                secretKeyRef:<br/>                  name: flask-app-secrets<br/>                  key: secret_token</span></pre><p id="e73b" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，您可以通过<code class="du kc kd ke jq b">SECRET_TOKEN</code>环境变量访问您的秘密令牌。</p></div><div class="ab cl kf kg gp kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hb hc hd he hf"><p id="0f48" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">源代码可在此处获得:<a class="ae jk" href="https://github.com/pyk/k8s-flask-tutorial" rel="noopener ugc nofollow" target="_blank"> pyk/k8s-flask-tutorial </a>。</p></div></div>    
</body>
</html>