<html>
<head>
<title>Enforce TLS Policy on GKE cluster with Istio or Anthos</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Istio或Anthos在GKE集群上实施TLS策略</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/enforce-tls-policy-on-gke-cluster-with-istio-or-anthos-ab46ee1fe038?source=collection_archive---------0-----------------------#2021-07-11">https://medium.com/google-cloud/enforce-tls-policy-on-gke-cluster-with-istio-or-anthos-ab46ee1fe038?source=collection_archive---------0-----------------------#2021-07-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/daaf3c516abdcba89d12c5e3544143f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2vH6j5AUQiQgwqnUBGGAiw.jpeg"/></div></div></figure><p id="608c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">照片由<a class="ae jo" href="https://unsplash.com/@thejmoore?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">乔恩·摩尔</a>在<a class="ae jo" href="https://unsplash.com/s/photos/security?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p><p id="d257" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Google Cloud提供了一种<a class="ae jo" href="https://cloud.google.com/load-balancing/docs/use-ssl-policies" rel="noopener ugc nofollow" target="_blank">简单的方式</a>来强制执行TLS策略，例如SSL和TLS协议的允许版本以及允许用于这些版本的密码套件。可以在<a class="ae jo" href="https://cloud.google.com/load-balancing/docs/https" rel="noopener ugc nofollow" target="_blank"> HTTP(S)外部负载均衡器</a>进行配置。如果您的工作负载运行在不使用Google负载平衡器的方式公开服务的GKE集群上，或者工作负载是内部公开的(例如，使用HTTP(S)内部负载平衡器)，那么您需要另一种方式来实施TLS策略。下面的教程展示了如何使用<a class="ae jo" href="https://cloud.google.com/service-mesh/docs/overview" rel="noopener ugc nofollow" target="_blank"> Anthos服务网格</a> (ASM)服务对其进行配置。也可以使用Istio OSS实现教程。但是，ASM允许将TLS策略应用于入口和pod到pod的流量，而Istio仅支持入口流量的TLS策略。</p><h1 id="c8aa" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">设置环境</h1><p id="be6f" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">该教程在GCP上运行，需要一个有效的计费帐户的项目。本教程中的命令意味着有一个环境变量<code class="du ks kt ku kv b">PROJECT_ID</code>存储了该项目的项目id。</p><blockquote class="kw kx ky"><p id="dc64" class="iq ir kz is b it iu iv iw ix iy iz ja la jc jd je lb jg jh ji lc jk jl jm jn hb bi translated"><strong class="is hj">注意:</strong>如果您运行本教程，您将因使用GCP资源而付费。启用某些API可能会产生额外的成本。</p></blockquote><h1 id="17b4" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">1.启用Google APIs</h1><p id="4acb" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">使用以下命令启用所需的API:</p><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="b726" class="ll jq hi kv b fi lm ln l lo lp"># gcloud services enable — project=$PROJECT_ID \<br/>    compute.googleapis.com container.googleapis.com \<br/>    meshtelemetry.googleapis.com meshconfig.googleapis.com \<br/>    iamcredentials.googleapis.com gkeconnect.googleapis.com \<br/>    gkehub.googleapis.com cloudresourcemanager.googleapis.com \<br/>    meshca.googleapis.com</span></pre><p id="4119" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你使用Istio OSS，你只需要<code class="du ks kt ku kv b">compute.googleapis.com</code>和<code class="du ks kt ku kv b">container.googleapis.com</code>API。</p><h1 id="b305" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">2.设置GKE集群</h1><p id="2910" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">带有ASM的GKE集群至少需要e2-standard-4机器类型。本教程没有在由较小机器组成的集群上进行测试。创建GKE集群:</p><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="e665" class="ll jq hi kv b fi lm ln l lo lp"># gcloud container clusters create microservice-demo \<br/>    --zone us-central1-a \<br/>    --machine-type=e2-standard-4 \<br/>    --num-nodes=4 \<br/>    --enable-stackdriver-kubernetes \<br/>    --subnetwork=default \<br/>    --no-enable-autoupgrade \<br/>    --no-enable-autorepair \<br/>    --tags=microservice-demo \<br/>    --workload-pool=$PROJECT_ID.svc.id.goog \<br/>    --project=$PROJECT_ID<br/># gcloud container clusters get-credentials microservice-demo \<br/>    --zone us-central1-a --project=$PROJECT_ID</span></pre><p id="8a88" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:</strong>如果您打算使用Istio OSS，则无需为集群提供<code class="du ks kt ku kv b">--workload-pool</code>参数。</p><h1 id="510d" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">3.设置ASM</h1><p id="65b1" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">从ASM 1.9开始，支持强制执行pod到pod TLS策略。以下命令安装ASM 1.9的最新版本:</p><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="c7e2" class="ll jq hi kv b fi lm ln l lo lp"># curl <a class="ae jo" href="https://storage.googleapis.com/csm-artifacts/asm/install_asm_1.9" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/csm-artifacts/asm/install_asm_1.9</a> &gt; install_asm<br/># curl <a class="ae jo" href="https://storage.googleapis.com/csm-artifacts/asm/install_asm_1.9.sha256" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/csm-artifacts/asm/install_asm_1.9.sha256</a> &gt; install_asm.sha256<br/># sha256sum -c --ignore-missing install_asm.sha256<br/># chmod +x install_asm<br/># ./install_asm --project_id $PROJECT_ID \<br/>    --cluster_name microservice-demo \<br/>    --cluster_location us-central1-a --enable_all \<br/>    -o envoy-access-log -D asm_install --mode install</span></pre><p id="695d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">需要获取ASM版本以备后用:</p><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="66e0" class="ll jq hi kv b fi lm ln l lo lp">ASM_REVISION=$(kubectl get pod -n istio-system -l app=istiod \<br/>  -o jsonpath='{.items[0].metadata.labels.istio\.io/rev}')</span></pre><h1 id="87a6" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">部署演示应用程序并配置TLS策略</h1><p id="45f3" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">该教程使用了一个在线精品店应用程序，可以在<a class="ae jo" href="https://github.com/GoogleCloudPlatform/microservices-demo" rel="noopener ugc nofollow" target="_blank"> github </a>上找到。以下步骤将应用程序部署到专用命名空间中，使用正确的证书配置ASM入口网关，然后对入口和pod到pod流量应用TLS策略。</p><h1 id="4bd9" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">1.设置一个演示命名空间来运行演示应用程序</h1><p id="c3d3" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">配置一个Kubernetes名称空间，在其中运行演示应用程序。</p><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="0b27" class="ll jq hi kv b fi lm ln l lo lp"># kubectl create ns demo<br/># kubectl label ns demo \<br/>    istio-injection- istio.io/rev=$ASM_REVISION --overwrite</span></pre><p id="22bc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对部署到演示命名空间中的所有工作负载实施MTL:</p><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="e424" class="ll jq hi kv b fi lm ln l lo lp"># cat &lt;&lt;EOF | kubectl apply -f -<br/>apiVersion: "security.istio.io/v1beta1"<br/>kind: "PeerAuthentication"<br/>metadata:<br/>  name: demo<br/>  namespace: istio-system<br/>spec:<br/>  mtls:<br/>    mode: STRICT<br/>EOF</span></pre><h1 id="c19b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">2.下载并部署演示应用程序</h1><p id="50e9" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在线精品店是在GKE上运行的微服务应用程序，用于不同的演示目的。本教程使用最新版本的微服务容器映像。</p><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="2e15" class="ll jq hi kv b fi lm ln l lo lp"># git clone <a class="ae jo" href="https://github.com/GoogleCloudPlatform/microservices-demo.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/microservices-demo.git</a><br/># kubectl apply -n demo \<br/>    -f microservices-demo/release/kubernetes-manifests.yaml<br/># kubectl apply -n demo \<br/>    -f microservices-demo/release/istio-manifests.yaml</span></pre><h1 id="113a" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">3.为演示应用程序选择一个主机名并设置DNS</h1><p id="a1f7" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">要测试TLS的工作，您需要有一个演示应用程序的有效域名。有几种方法可以配置它。您可以使用云DNS或其他DNS服务，如您的域注册商提供的服务。您可以使用本地/etc/hostname来进行测试。无论采用哪种方式，都可以获得ASM网关的IP地址:</p><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="0328" class="ll jq hi kv b fi lm ln l lo lp"># HOST_IP=$(kubectl get svc/istio-ingressgateway -n istio-system \<br/>    -o=jsonpath={.status.loadBalancer.ingress[0].ip})</span></pre><p id="0b76" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并将其与您选择的主机名相关联。对于以下步骤，将使用主机名<code class="du ks kt ku kv b">demo.acme.cloud</code> demo.acme.cloud。请将其替换为您选择的主机名。</p><h1 id="9778" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">4.对入口流量实施TLS策略</h1><p id="72bd" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">要对入口流量实施TLS策略，您必须配置ASM入口网关。为此，必须为演示应用主机名配置入口网关(更多详细信息，请参见<a class="ae jo" href="https://istio.io/latest/docs/tasks/traffic-management/ingress/secure-ingress/#configure-a-tls-ingress-gateway-for-a-single-host" rel="noopener ugc nofollow" target="_blank">安全网关</a>)。</p><h2 id="5fa4" class="ll jq hi bd jr lq lr ls jv lt lu lv jz jb lw lx kd jf ly lz kh jj ma mb kl mc bi translated">4.1为acme.cloud生成CA证书:</h2><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="9697" class="ll jq hi kv b fi lm ln l lo lp"># openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 \<br/>    -subj '/O=Botique Inc./CN=mydomain.com' \<br/>    -keyout mydomain.com.key \<br/>    -out mydomain.com.crt</span></pre><h2 id="5e2a" class="ll jq hi bd jr lq lr ls jv lt lu lv jz jb lw lx kd jf ly lz kh jj ma mb kl mc bi translated">4.2生成由CA签名的demo.acme.cloud主机证书:</h2><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="f856" class="ll jq hi kv b fi lm ln l lo lp"># openssl req -out demo.acme.cloud.csr \<br/>    -newkey rsa:2048 -nodes \<br/>    -keyout demo.acme.cloud.key \<br/>    -subj "/CN=demo.acme.cloud/O=Demo Org"<br/># openssl x509 -req -days 365 -set_serial 0 \<br/>    -CA acme.cloud.crt -CAkey acme.cloud.key \<br/>    -in demo.acme.cloud.csr \<br/>    -out demo.acme.cloud.crt</span></pre><h2 id="a642" class="ll jq hi bd jr lq lr ls jv lt lu lv jz jb lw lx kd jf ly lz kh jj ma mb kl mc bi translated">4.3创建TLS机密:</h2><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="87b0" class="ll jq hi kv b fi lm ln l lo lp"># kubectl create -n istio-system secret tls ingress-credential \<br/>    --key=demo.acme.cloud.key \<br/>    --cert=demo.acme.cloud.crt</span></pre><h2 id="ce08" class="ll jq hi bd jr lq lr ls jv lt lu lv jz jb lw lx kd jf ly lz kh jj ma mb kl mc bi translated">4.4更新虚拟服务:</h2><p id="332b" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">编辑虚拟服务:</p><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="8126" class="ll jq hi kv b fi lm ln l lo lp"># EDITOR=vim; kubectl edit virtualservice/frontend-ingress -n demo</span></pre><p id="4362" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并将<code class="du ks kt ku kv b">hosts:</code>列表中的<code class="du ks kt ku kv b">'*'</code>全部替换为<code class="du ks kt ku kv b">'demo.acme.cloud'</code>。</p><h2 id="dbc7" class="ll jq hi bd jr lq lr ls jv lt lu lv jz jb lw lx kd jf ly lz kh jj ma mb kl mc bi translated">4.5更新Istio网关:</h2><p id="bbff" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">编辑前端网关:</p><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="5a75" class="ll jq hi kv b fi lm ln l lo lp"># EDITOR=vim; kubectl edit gateway/frontend-gateway -n demo</span></pre><p id="5dac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并将<code class="du ks kt ku kv b">servers:</code>下的<strong class="is hj">所有</strong>数据替换为:</p><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="53eb" class="ll jq hi kv b fi lm ln l lo lp">- hosts:<br/>    - demo.acme.cloud<br/>    port:<br/>      number: 443<br/>      name: https<br/>      protocol: HTTPS<br/>    tls:<br/>      mode: SIMPLE<br/>      credentialName: ingress-credential # must be the same as secret</span><span id="fb1e" class="ll jq hi kv b fi md ln l lo lp">## the following lines define TLS policy<br/>      maxProtocolVersion: TLSV1_3<br/>      minProtocolVersion: TLSV1_2<br/>      cipherSuites:<br/>      - ECDHE-RSA-AES256-GCM-SHA384<br/>      - AES256-GCM-SHA384<br/>      - TLS_AES_256_GCM_SHA384</span></pre><p id="bdf3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:</strong>保留缩进-检查以保留清单的YAML格式。</p><p id="4fe4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">网关清单的<code class="du ks kt ku kv b">tls</code>部分将TLS策略定义为一系列TLS协议版本和这些版本允许的一组密码套件。注意，根据TLS 1.3协议规范，TLS 1.3的密码套件不能改变。因此这组密码套件适用于≤ TLS 1.2的协议版本。</p><h1 id="e856" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">5.对单元到单元的通信实施TLS策略</h1><p id="b565" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">到目前为止，所有步骤都可以使用Istio OSS运行。当启用mTLS时，可以使用ASM强制执行pod到pod通信的TLS策略。与可以在每个主机的基础上启用和配置的用于入口流量的TLS策略相反，用于pod到pod通信的TLS策略是以集群方式启用的。为此，编辑ASM控制器:</p><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="04f2" class="ll jq hi kv b fi lm ln l lo lp"># EDITOR=vim; kubectl edit deploy/istiod-$ASM_REVISION \<br/>     -n istio-system</span></pre><p id="c356" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并将以下环境变量添加到部署的单个容器规范中:</p><pre class="ld le lf lg fd lh kv li lj aw lk bi"><span id="3ae6" class="ll jq hi kv b fi lm ln l lo lp">- name: TLS_INBOUND_CIPHER_PROFILE<br/>  value: custom<br/>- name: TLS_INBOUND_CIPHER_SUITES<br/>  value: ECDHE-RSA-AES256-GCM-SHA384,AES256-GCM-SHA384</span></pre><p id="0cd1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">默认情况下，ASM仅将TLS协议版本限制为1.2和1.3。因此，没有必要限制TLS协议版本的范围。</p><h1 id="0fb8" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">包裹</h1><p id="d9e3" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">可以限制哪些TLS协议版本和哪些密码套件将用于GKE内的入口和点对点通信。这些值可以使用Istio OSS或ASM网关进行入口配置，使用ASM控制器进行pod-to-pod通信。</p></div></div>    
</body>
</html>