<html>
<head>
<title>Integrating ML Kit ODT and Vision Product Search APIs with an Android Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将ML Kit ODT和Vision产品搜索API与Android应用程序集成</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/integrating-ml-kit-odt-and-vision-product-search-apis-with-an-android-application-594df9ca73f4?source=collection_archive---------0-----------------------#2021-08-24">https://medium.com/google-cloud/integrating-ml-kit-odt-and-vision-product-search-apis-with-an-android-application-594df9ca73f4?source=collection_archive---------0-----------------------#2021-08-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="a197" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">我们不是都在最喜欢的网上购物网站上使用过图片搜索功能吗？在那里，我们上传一张带有我们正在寻找的商品的图片，瞧，几秒钟内就能得到匹配的结果！那么，为什么不将这一特性集成到我们自己的移动应用程序中呢？</p></blockquote><p id="0ef7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">这可以通过使用预定义的API来完成，这些API是Google提供的预打包人工智能解决方案。</p><p id="1af9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">在谷歌实习期间，我使用谷歌的Vision产品搜索API构建了一个产品搜索后端，并将其与一个android应用程序集成在一起。该应用程序还有一个设备上的对象检测器，我使用ML Kit对象检测和跟踪API实现了它。</p><p id="7680" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">在这篇博客中，我将解释在android应用程序中集成API的步骤，就像我在我的项目中所做的一样。</p><p id="f6c1" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">所以，让我们开始吧！</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/d8e328d4287e6697ac12c68b3a63839e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7X5tFouWx2OZUgb7"/></div></div></figure><p id="094d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><strong class="il hj">注意:</strong>我假设你有一些android应用程序的样板代码，包括通过设备摄像头捕捉图像或从设备存储器上传图像。使用预设图像也可以。如果您想使用完全相同的应用程序，请访问我的GitHub库中的<a class="ae jw" href="https://github.com/shreyaanand29/Vision-Product-Search-Android-App/tree/master" rel="noopener ugc nofollow" target="_blank">代码，并在继续之前克隆它。</a></p><h1 id="39fe" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">目标检测和跟踪</h1><p id="e910" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it jh kx iw ix ji ky ja jb jj kz je jf jg hb bi translated">将以下内容添加到依赖项文件(build.gradle)中</p><pre class="jl jm jn jo fd la lb lc ld aw le bi"><span id="6391" class="lf jy hi lb b fi lg lh l li lj">implementation <strong class="lb hj">‘com.google.mlkit:object-detection:16.2.4’</strong></span></pre><p id="80dc" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">在主文件中导入以下内容-</p><pre class="jl jm jn jo fd la lb lc ld aw le bi"><span id="cd17" class="lf jy hi lb b fi lg lh l li lj">com.google.mlkit.vision.common.InputImage</span><span id="db88" class="lf jy hi lb b fi lk lh l li lj">com.google.mlkit.vision.objects.ObjectDetection</span><span id="b598" class="lf jy hi lb b fi lk lh l li lj">com.google.mlkit.vision.objects.defaults.ObjectDetectorOptions</span></pre><p id="ce10" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">下面代码片段中的函数通过3个简单的步骤建立了对象检测和跟踪</p><ol class=""><li id="d000" class="ll lm hi il b im in iq ir jh ln ji lo jj lp jg lq lr ls lt bi translated">配置对象检测器(模式为SINGLE_IMAGE_MODE，因为我们将在静态图像上运行它)。</li><li id="2760" class="ll lm hi il b im lu iq lv jh lw ji lx jj ly jg lq lr ls lt bi translated">从位图准备输入图像(要从其他方法准备输入图像，请访问<a class="ae jw" href="https://developers.google.com/ml-kit/vision/object-detection/android" rel="noopener ugc nofollow" target="_blank">文档</a>)。</li><li id="e4a6" class="ll lm hi il b im lu iq lv jh lw ji lx jj ly jg lq lr ls lt bi translated">处理图像，如果成功，我们只保留时尚_良好的产品的应用目的。</li></ol><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="200e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">这样，您就成功地将对象检测功能与您的移动应用程序集成在一起了！</p><h1 id="189b" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">构建产品搜索后端</h1><p id="89c9" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it jh kx iw ix ji ky ja jb jj kz je jf jg hb bi translated">下一步是为vision API创建后端，然后可以从应用程序调用它来执行可视化搜索。</p><ol class=""><li id="2cdd" class="ll lm hi il b im in iq ir jh ln ji lo jj lp jg lq lr ls lt bi translated">在开始任何实际工作之前，确保已经为你设置了一个谷歌云项目，并启用了计费功能。另外，请继续并<a class="ae jw" href="https://console.cloud.google.com/flows/enableapi?apiid=vision.googleapis.com&amp;_ga=2.233519835.417375745.1628526668-88159532.1628526668" rel="noopener ugc nofollow" target="_blank">为您的项目启用Vision API </a>。</li><li id="1880" class="ll lm hi il b im lu iq lv jh lw ji lx jj ly jg lq lr ls lt bi translated">创建一个服务帐户，并赋予它Basic&gt;Owner角色。然后，您必须创建服务帐户密钥(json密钥被下载到您的计算机上)。</li><li id="c8ba" class="ll lm hi il b im lu iq lv jh lw ji lx jj ly jg lq lr ls lt bi translated">将变量GOOGLE_APPLICATION_CREDENTIALS的值设置为下载的凭证文件的路径(请记住，该值仅适用于云Shell的当前会话)。</li><li id="db08" class="ll lm hi il b im lu iq lv jh lw ji lx jj ly jg lq lr ls lt bi translated">然后，获取将用作后端服务的产品目录的产品集。我使用了位于公共云存储桶中的公开可用的<a class="ae jw" href="https://storage.cloud.google.com/cloud-samples-data/vision/product_search/product_catalog.csv" rel="noopener ugc nofollow" target="_blank"> product_catalog.csv </a>。</li></ol><p id="815b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">您可以构建自己的目录——一个. csv文件，并将其上传到您的云存储空间。</p><p id="d7ea" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><strong class="il hj">注意:</strong>如果您构建自己的产品集，请确保。csv文件具有Vision API能够正确识别它所需的格式。它应该有以下几列-</p><pre class="jl jm jn jo fd la lb lc ld aw le bi"><span id="5c6f" class="lf jy hi lb b fi lg lh l li lj">image-uri</span><span id="ded6" class="lf jy hi lb b fi lk lh l li lj">image-id (optional, if not given, automatically allocated)</span><span id="4d46" class="lf jy hi lb b fi lk lh l li lj">Product-set-id</span><span id="d4fd" class="lf jy hi lb b fi lk lh l li lj">Product-id</span><span id="0226" class="lf jy hi lb b fi lk lh l li lj">product-category (It can be one of homegoods-v2, apparel-v2, toys-v2, packagedgoods-v1, and general-v1)</span><span id="ee5f" class="lf jy hi lb b fi lk lh l li lj">product-display-name (optional)</span><span id="dd04" class="lf jy hi lb b fi lk lh l li lj">labels (optional)</span><span id="52fa" class="lf jy hi lb b fi lk lh l li lj">bounding-poly (optional)</span></pre><p id="2745" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">更多信息，请访问<a class="ae jw" href="https://cloud.google.com/vision/product-search/docs/csv-format" rel="noopener ugc nofollow" target="_blank">格式化批量导入CSV </a>。</p><p id="5f6e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">使用以下curl命令，使用bulk import为您自己的后端创建目录</p><pre class="jl jm jn jo fd la lb lc ld aw le bi"><span id="a510" class="lf jy hi lb b fi lg lh l li lj">curl -X POST \</span><span id="fb41" class="lf jy hi lb b fi lk lh l li lj">-H “Authorization: Bearer “$(gcloud auth application-default print-access-token) \</span><span id="a157" class="lf jy hi lb b fi lk lh l li lj">-H “Content-Type: application/json; charset=utf-8” \</span><span id="77f5" class="lf jy hi lb b fi lk lh l li lj">-d @import_request.json \</span><span id="73d9" class="lf jy hi lb b fi lk lh l li lj"><a class="ae jw" href="https://vision.googleapis.com/v1/projects/$PROJECT_ID/locations/$LOCATION_ID/productSets:import" rel="noopener ugc nofollow" target="_blank">https://vision.googleapis.com/v1/projects/$PROJECT_ID/locations/$LOCATION_ID/productSets:import</a></span></pre><p id="d91d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><strong class="il hj">注意:</strong>import _ request . JSON文件有以下内容-</p><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="b485" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">现在，我们必须确保产品的产品搜索索引是完整的。</p><p id="bc5a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">使用以下命令验证索引是否完成-</p><pre class="jl jm jn jo fd la lb lc ld aw le bi"><span id="6622" class="lf jy hi lb b fi lg lh l li lj">curl -X GET \</span><span id="7d9a" class="lf jy hi lb b fi lk lh l li lj">-H “Authorization: Bearer $(gcloud auth application-default print-access-token)” \</span><span id="bf89" class="lf jy hi lb b fi lk lh l li lj">-H “Content-Type: application/json” \</span><span id="4ae6" class="lf jy hi lb b fi lk lh l li lj">https://vision.googleapis.com/v1/projects/$PROJECT_ID/locations/$LOCATION_ID/productSets</span></pre><p id="22c0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">成功的响应将返回索引已完成的产品集的indexTime。</p><p id="c855" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><strong class="il hj">注意:</strong>索引每30分钟更新一次，无论何时添加或删除图像，在索引更新之前，您不会看到响应有任何变化。我后来知道了索引时间，并且不耐烦地试图马上测试我的应用程序，所以不要像我一样！</p><p id="63c1" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">至此，我们的产品搜索后端创建成功！</p><h1 id="5434" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">从Android应用程序调用后端</h1><p id="1f1b" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it jh kx iw ix ji ky ja jb jj kz je jf jg hb bi translated">最后一步是从应用程序调用后端——发送图像作为查询，接收视觉上相似的产品列表，并获取返回显示的产品的参考图像。</p><p id="fe0c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">在继续之前，创建一个API密钥并存储它。应用程序将使用它与Vision API进行交互。为了避免未经授权的使用，您还可以限制API密钥对您自己的应用程序的访问。</p><pre class="jl jm jn jo fd la lb lc ld aw le bi"><span id="7b11" class="lf jy hi lb b fi lg lh l li lj">VISION_API_URL — https://vision.googleapis.com/v1</span><span id="da12" class="lf jy hi lb b fi lk lh l li lj">VISION_API_KEY — API key</span><span id="1920" class="lf jy hi lb b fi lk lh l li lj">VISION_API_PROJECT_ID — Google Cloud project ID</span><span id="80d3" class="lf jy hi lb b fi lk lh l li lj">VISION_API_LOCATION_ID — The Region Name e.g. us-east1 </span><span id="9729" class="lf jy hi lb b fi lk lh l li lj">VISION_API_PRODUCT_SET_ID — ID of the product catalog</span></pre><p id="0ced" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">然后，使用<a class="ae jw" href="https://cloud.google.com/vision/product-search/docs/reference/rest/v1/projects.locations.images/annotate" rel="noopener ugc nofollow" target="_blank">projects . locations . images . annotate</a>端点将查询图像发送到服务器，并从产品目录中接收视觉上与查询图像相似的产品列表。</p><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="9b4b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">最后，调用<a class="ae jw" href="https://cloud.google.com/vision/product-search/docs/reference/rest/v1/projects.locations.products.referenceImages/get" rel="noopener ugc nofollow" target="_blank">projects . locations . products . reference images . get</a>API来获取返回的产品图像的URIs，并在应用程序的UI中显示它们。</p><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="28b9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">我们已经到了最后，这就是将对象检测和产品搜索功能集成到您的应用程序中所需要做的一切。</p><p id="0b1d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><strong class="il hj">祝贺你！</strong></p><p id="44b2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">只是为了提升你的热情去做点什么，这里有一个小小的视觉效果，展示你努力工作的果实会有多甜！所以，去试试这些很酷的API吧！</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es mb"><img src="../Images/e42c76ae6d399404caaa31286bb80a4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/1*3XXpWBTTvRKE-tM371oWWA.gif"/></div><figcaption class="mc md et er es me mf bd b be z dx translated">所有努力的最终成果！</figcaption></figure><h1 id="bd44" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">后续步骤</h1><p id="e70d" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it jh kx iw ix ji ky ja jb jj kz je jf jg hb bi translated">谷歌整理了一份详尽的文档清单，对理解细节非常有帮助——T4愿景和ML工具包。如果您希望按照一步一步的指南从头开始构建整个应用程序，请访问<a class="ae jw" href="https://developers.google.com/learn/pathways/on-device-ml-3" rel="noopener ugc nofollow" target="_blank">学习途径</a>，其中有视频教程和一堆代码实验室，以及为您提供的所有源代码。</p><p id="4411" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">快乐学习！</p></div></div>    
</body>
</html>