<html>
<head>
<title>Google Cloud Platform HTTP Load Balancers Explained via the CLI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google云平台HTTP负载平衡器通过CLI解释</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-platform-http-load-balancers-explained-via-the-cli-4f4d61805297?source=collection_archive---------0-----------------------#2016-04-18">https://medium.com/google-cloud/google-cloud-platform-http-load-balancers-explained-via-the-cli-4f4d61805297?source=collection_archive---------0-----------------------#2016-04-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="d590" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">这是从<a class="ae jh" href="https://www.ianlewis.org/en/google-cloud-platform-http-load-balancers-explaine" rel="noopener ugc nofollow" target="_blank">我的博客</a>交叉发布的帖子。</p></blockquote><p id="df2a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">谷歌云平台负载平衡器是基于谷歌为我们的应用开发的技术。有两种类型的负载平衡器，网络(L3)负载平衡器和HTTP (L7)负载平衡器。HTTP负载平衡器是全局的，因此同一个IP可以在世界上的任何地方使用，但仍然支持非常高的可伸缩性，无需预热。</p><p id="dd6f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">在开发人员控制台中设置HTTP负载平衡器相当简单。您可以在控制台的网络部分创建一个，并创建一个负载平衡器。一旦您开始创建一个HTTP负载平衡器，您会看到一个类似这样的页面:</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es jl"><img src="../Images/55dd133b37e9f01f159e9d1e2b8b7b37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cyhQ5QlDHvmfVGi9.png"/></div></div></figure><p id="20a0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">每个部分都设计得很好，允许您一次性创建负载平衡器。但是这里有许多正在被创建的对象，其中许多只是模糊地映射到UI。通过Google Cloud CLI进行设置可能有点令人生畏。</p><p id="8e12" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated"><a class="ae jh" href="https://cloud.google.com/compute/docs/load-balancing/http/" rel="noopener ugc nofollow" target="_blank"> HTTP负载平衡器文档</a>提供了一些有用的信息和图表，有助于理解它是如何工作的。但是当我想通过CLI设置负载平衡器时，我发现这里的图表有点过于简单。我需要知道更多关于所有部件的信息，所以我画了这张图。</p><p id="328d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们一步一步地了解如何通过CLI创建负载平衡器。在我们这样做的时候，我会试着指出我们正在创建的每个对象在云控制台中的对应关系，这样您就知道以后在哪里可以找到它们。</p><h1 id="64a8" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">健康检查</h1><p id="f0b8" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it ji kx iw ix jj ky ja jb jk kz je jf jg hb bi translated">由于大多数对象相互依赖，我们需要从“后端”到“前端”,从健康检查和后端服务开始，到转发规则结束。运行状况检查对象不依赖于任何其他对象，因此我们可以先创建它。尽管我们在这里创建了对象，但是只有在我们将它附加到后端服务之后，它才真正变得活跃。</p><pre class="jm jn jo jp fd la lb lc ld aw le bi"><span id="9832" class="lf jy hi lb b fi lg lh l li lj">gcloud compute http-health-checks create my-healthcheck --host &lt;a href="http://www.example.com"&gt;www.example.com&lt;/a&gt; --port 80 --request-path=/healthz</span></pre><p id="b0fd" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">这里我们创建一个健康检查，它将通过/healthz URL上的端口80连接到我们的应用程序。请注意，创建运行状况检查只是告诉进一步的配置要检查的端口和路径，而不是实际发送运行状况检查。host参数实际上并不用作要连接的主机，而只是用来设置主机头。一些应用程序检查这个标题，所以我们希望他们能够返回一个成功的状态。运行状况检查的实例稍后由后端服务指定。</p><p id="8fd2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">健康检查在多个地方使用，因此它们位于云控制台UI的计算引擎部分之下。此处列出的运行状况检查与CLI中的http-health-checks和https-health-checks相对应。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div class="er es lk"><img src="../Images/f4e53ff6a65af77edb3d5210b44d3c4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/0*58lcEEX2_Zzfi6HL.png"/></div></figure><h1 id="366b" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">后端服务</h1><p id="afca" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it ji kx iw ix jj ky ja jb jk kz je jf jg hb bi translated">接下来，我们将创建一个后端服务。后端服务对象定义了实际服务请求的后端虚拟机。后端服务包含许多后端。每个后端本质上是一个到实例组的链接，但是附加了一些其他选项，比如使用哪个端口号和负载平衡模式。设置端口的首选方式是通过实例组上的命名端口。您可以使用以下命令为端口80设置一个名为http-port的命名端口。我假设您已经设置了一个名为my-instance-group的实例组。您可以在这里找到关于创建托管实例组<a class="ae jh" href="https://cloud.google.com/compute/docs/instance-groups/" rel="noopener ugc nofollow" target="_blank">的更多信息。</a></p><pre class="jm jn jo jp fd la lb lc ld aw le bi"><span id="de75" class="lf jy hi lb b fi lg lh l li lj">gcloud compute instance-groups set-named-ports my-instance-group --named-ports http-port:80</span></pre><p id="70cd" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">接下来，您可以创建后端服务:</p><pre class="jm jn jo jp fd la lb lc ld aw le bi"><span id="f5cf" class="lf jy hi lb b fi lg lh l li lj">gcloud compute backend-services create my-http-backend-service --http-health-checks my-healthcheck --port-name http-port --protocol HTTP</span></pre><p id="b4c7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">既然我们已经将健康检查附加到了后端服务，它将连接到后端服务指定的实例来进行健康检查。</p><p id="2dfb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">UI在UI的“后端配置”部分显示后端服务。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es ll"><img src="../Images/91f37bf60ebf7dbd8f56d8f95b3ed26b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BM4isGqetJ0Hx9zH.png"/></div></div></figure><p id="ff93" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">接下来，我们必须创建一个后端。后端指定要向其发送流量的实例组，以及如何在可用实例之间平衡负载。您可以创建多个后端，通常为每个实例组创建一个后端。你可以用这个来做<a class="ae jh" href="https://cloud.google.com/compute/docs/load-balancing/http/cross-region-example" rel="noopener ugc nofollow" target="_blank">跨区域负载均衡，比如</a>。</p><pre class="jm jn jo jp fd la lb lc ld aw le bi"><span id="30fb" class="lf jy hi lb b fi lg lh l li lj">gcloud compute backend-services add-backend my-http-backend-service --instance-group my-instance-group --balancing-mode RATE --max-rate-per-instance 10</span></pre><p id="b723" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">这将建立一个后端，向我的实例组发送流量，并使用请求率作为一种负载平衡的方式。我将它设置为每个实例每秒最多获得10个请求，但是您也可以根据您的需要设置它来使用CPU利用率。</p><p id="0d77" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">在UI中，后端是后端服务表单的一部分。您可以向后端服务添加任意数量的后端，就像在CLI中一样。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es lm"><img src="../Images/0e90575e322b31ab4c0f506757065673.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oJigciXolt4IT4-x.png"/></div></div></figure><h1 id="6a5a" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">Url映射</h1><p id="28ac" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it ji kx iw ix jj ky ja jb jk kz je jf jg hb bi translated">Url映射用于将主机和URL映射到后端服务。url映射包含两种类型的对象，主机规则和路径匹配器。每个主机规则可以有多个路径匹配器。每个请求都与主机规则进行匹配，然后与匹配的主机规则的路径匹配器进行匹配。当创建一个url-maps对象时，您指定当没有主机规则匹配时使用的默认后端服务。</p><pre class="jm jn jo jp fd la lb lc ld aw le bi"><span id="89de" class="lf jy hi lb b fi lg lh l li lj">gcloud compute url-maps create my-url-map --default-service my-http-backend-service</span></pre><p id="4b72" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">如果你只有一个后端服务，那么这一个命令通常就足够了，因为所有的流量都可以通过默认服务发送。然而，如果你有多个后端，你可以设置基于主机或网址。一个主机规则可以有多个路径匹配器，但主机规则必须至少有一个路径匹配器，因此我们同时创建路径匹配器和主机规则。</p><pre class="jm jn jo jp fd la lb lc ld aw le bi"><span id="f1aa" class="lf jy hi lb b fi lg lh l li lj">gcloud compute url-maps add-path-matcher my-url-map --path-matcher-name my-www-path-matcher --new-hosts &lt;a href="http://www.example.com"&gt;www.example.com&lt;/a&gt; --default-service my-http-backend-service</span></pre><p id="4ed9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您还可以指定不同主机的请求也转到单独的后端服务。</p><pre class="jm jn jo jp fd la lb lc ld aw le bi"><span id="1078" class="lf jy hi lb b fi lg lh l li lj">gcloud compute url-maps add-path-matcher my-url-map --path-matcher-name my-api-path-matcher --new-hosts api.example.com --default-service my-api-backend-service</span></pre><p id="3874" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">像url-maps本身一样，如果主机规则匹配，但没有路径规则匹配，您可以指定一个默认服务。您还可以根据路径指定要使用的不同后端服务。</p><pre class="jm jn jo jp fd la lb lc ld aw le bi"><span id="d8ed" class="lf jy hi lb b fi lg lh l li lj">gcloud compute url-maps add-path-matcher my-url-map --path-matcher-name my-path-matcher --new-hosts &lt;a href="http://www.example.com"&gt;www.example.com&lt;/a&gt; --path-rules=”/api=my-api-backend-service,/other=my-other-backend-service” --default-service my-http-backend-service</span></pre><p id="2e09" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">在UI中，URL映射、主机规则和路径匹配器在“主机和路径规则”部分指定。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es ln"><img src="../Images/33f504ea79f0874113731797eb15e03c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*i5-OFzyq-DhBbEza.png"/></div></div></figure><p id="8ac3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">第一行包含当请求不匹配主机规则/路径匹配器组合时使用的默认服务。其他行包含主机规则/路径匹配器。</p><h1 id="526c" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">目标代理</h1><p id="469b" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it ji kx iw ix jj ky ja jb jk kz je jf jg hb bi translated">目标HTTP代理和目标HTTPS代理是将一个或多个转发规则连接到URL映射的对象。</p><p id="227c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">目标代理会终止与用户的连接，因此您可以在使用HTTPS时指定要使用的SSL证书。SSL证书是这样创建的:</p><pre class="jm jn jo jp fd la lb lc ld aw le bi"><span id="98ac" class="lf jy hi lb b fi lg lh l li lj">gcloud compute ssl-certificates create my-cert --certificate /path/to/cert.pm --private-key /path/to/key.pm</span></pre><p id="5225" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后，您可以使用该证书创建HTTPS代理。</p><pre class="jm jn jo jp fd la lb lc ld aw le bi"><span id="f6b8" class="lf jy hi lb b fi lg lh l li lj">gcloud compute target-https-proxies create my-https-proxy --url-map my-url-map --ssl-certificate my-ssl-certificate</span></pre><p id="7ee2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您仍然需要创建一个，但是在这一点上，我觉得目标代理使事情变得更加复杂，因为对于HTTP负载平衡器，您几乎总是为每个目标代理使用一个转发规则。</p><h1 id="08a7" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">转发规则</h1><p id="72ca" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it ji kx iw ix jj ky ja jb jk kz je jf jg hb bi translated">转发规则是我们需要创建的最终目标。这些是您实际计费的对象。转发规则将负载平衡器的IP地址映射到将处理请求的目标代理。首先，我们需要创建我们的IP地址。我们将需要一个全球性的，而不是地区性的，IP地址为我们的HTTP负载平衡器。</p><pre class="jm jn jo jp fd la lb lc ld aw le bi"><span id="e500" class="lf jy hi lb b fi lg lh l li lj">gcloud compute addresses create my-address --global</span></pre><p id="3894" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们可以创建我们的转发规则。请注意，我们需要输入我们刚刚创建的实际IP地址，而不是IP地址名称。也不是说您只能将单个端口作为—端口范围选项，我们需要添加—全局选项。</p><pre class="jm jn jo jp fd la lb lc ld aw le bi"><span id="e2da" class="lf jy hi lb b fi lg lh l li lj">gcloud compute forwarding-rules create my-https-forwarding-rule --global --address 123.123.123.123 --ip-protocol TCP --port-range 443 --target-https-proxy my-https-proxy</span></pre><p id="15ae" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">许多应用程序希望将访问http://www.example.com/的用户重定向到https://www.example.com/的T2。这是一个非常常见的用例，但负载平衡器不支持它。您需要为HTTP创建一个完全独立的目标HTTP代理和转发规则。实际上，您需要两个负载平衡器来处理流量，然后在您的应用程序中重定向用户。</p><p id="9824" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">注意，我们为HTTP转发规则输入了相同的IP地址。这使得我们可以监听我们IP地址的端口80和端口443。</p><pre class="jm jn jo jp fd la lb lc ld aw le bi"><span id="7b4c" class="lf jy hi lb b fi lg lh l li lj">gcloud compute target-http-proxies create my-http-proxy --url-map my-url-map gcloud compute forwarding-rules create my-http-forwarding-rule --global --address 123.123.123.123 --port-range 80 --target-http-proxy my-http-proxy</span></pre><p id="131e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在您已经创建了一个转发规则，它将显示在开发人员控制台的“负载平衡”部分。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es lo"><img src="../Images/c2aa9df62970fb43989af8509708d62e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LFAsVpNQiXFwc7tk.png"/></div></div></figure><h1 id="1339" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">高级视图</h1><p id="462e" class="pw-post-body-paragraph ii ij hi il b im kv io ip iq kw is it ji kx iw ix jj ky ja jb jk kz je jf jg hb bi translated">还有一个“高级视图”，允许您以更接近CLI的格式查看对象。每个主要对象都有选项卡，还有几个网络负载平衡器选项卡。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div class="er es lp"><img src="../Images/1cd2161d6762722b35ad0c70d6e8897a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/0*WTnx-_O_iRhsGAz5.png"/></div></figure><p id="03ef" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">考虑到如何在UI中创建，组成HTTP(S)负载平衡器的对象以及在GCP上设置它所需运行的命令并不十分明显。但希望这篇文章能揭示出它们是如何结合在一起的。一定要查看一下<a class="ae jh" href="https://cloud.google.com/compute/docs/load-balancing/http/" rel="noopener ugc nofollow" target="_blank"> HTTP负载平衡器文档</a>，它有更多的信息和指南，比如如何进行一些更复杂的设置，比如<a class="ae jh" href="https://cloud.google.com/compute/docs/load-balancing/http/cross-region-example" rel="noopener ugc nofollow" target="_blank">跨区域负载平衡</a>和<a class="ae jh" href="https://cloud.google.com/compute/docs/load-balancing/http/content-based-example" rel="noopener ugc nofollow" target="_blank">基于内容的负载平衡</a>。</p></div></div>    
</body>
</html>