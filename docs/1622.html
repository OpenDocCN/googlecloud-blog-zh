<html>
<head>
<title>A Safety Net for Terraform in Google Cloud Build</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云构建中的平台安全网</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/a-safety-net-for-terraform-in-google-cloud-build-1ca10259b344?source=collection_archive---------0-----------------------#2020-10-15">https://medium.com/google-cloud/a-safety-net-for-terraform-in-google-cloud-build-1ca10259b344?source=collection_archive---------0-----------------------#2020-10-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="857c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您是否曾经不得不从持续集成系统(如<a class="ae jd" href="https://cloud.google.com/cloud-build" rel="noopener ugc nofollow" target="_blank"> Google Cloud Build </a>)中运行Terraform来手动修复您的基础架构部署？</p><p id="77f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果是这样，你知道这并不有趣——这只是一堆苦差事。</p><p id="844a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Terraform是一个有状态的应用程序——也就是说，它在一个被Terraform称为<a class="ae jd" href="https://www.terraform.io/docs/state/index.html" rel="noopener ugc nofollow" target="_blank">状态</a>文件的文件中保存了它在整个生命周期中管理的资源的记录，该文件被保存到一个<a class="ae jd" href="https://www.terraform.io/docs/backends/index.html" rel="noopener ugc nofollow" target="_blank">后端</a>。为了防止多个并发的Terraform部署相互冲突，它使用了一个<a class="ae jd" href="https://www.terraform.io/docs/state/locking.html" rel="noopener ugc nofollow" target="_blank">锁</a>来确保一次只能运行一个Terraform部署。这实现了部署之间的一致性，防止了竞争情况，并确保Terraform创建的资源在其整个生命周期中继续由it管理，正如您(可能)所希望的那样。</p><p id="e92a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，如果Terraform在更新其状态文件并释放锁之前被终止，会发生什么呢？</p><p id="3316" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是我所说的辛苦——这就是你来的原因。</p><p id="80c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常，需要用<code class="du je jf jg jh b">terraform force-unlock</code>命令手动解除锁定，然后重新运行<code class="du je jf jg jh b">terraform apply</code>。在最后一次失败运行期间创建的资源可能会被孤立，因为它们可能没有被写入状态文件，并且在这种情况下，仍然不受Terraform的管理。</p><p id="cb7d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于各种原因，我经历过无数次这样的经历，我相信许多其他Terraform用户也有过这样的经历。我已经通过小心不要强制退出或意外终止Terraform中期部署来降低风险。最近，一位客户在从Google Cloud Build运行部署时遇到了这种情况:他们的构建超时，孤立了资源，锁定了状态，并导致他们跳入手动纠正问题。我能理解他们的沮丧。感觉我们可以做得更好。虽然这可能可以通过延长构建超时来解决，但我认为这种情况需要一种更微妙的方法。</p><p id="9783" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于各种原因，在Terraform部署过程中可能会出现构建超时，但一个常见且完全合理的解释是云提供商的控制平面出现了某种减速。有时，由于各种原因，操作时间比您预期的要长，而部署可能只持续几分钟，但运行时间可能是预期的数倍。有很多合理的理由来限制您的构建时间——比如对开发人员的快速反馈，或者开发团队的迭代部署——并且理想情况下，您希望您的构建超时能够适应更短(但仍然合理)的部署长度。</p><p id="73dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了解决Google Cloud Build中的这个具体问题，我写了一个<a class="ae jd" href="https://github.com/angstwad/google-cloud-build-command-wrapper" rel="noopener ugc nofollow" target="_blank"> Google Cloud Build命令包装器</a>，并在GitHub上开源了它。如果你有兴趣了解更多，继续阅读；否则，跳到GitHub repo，阅读文档，然后开始！</p><h1 id="0e9a" class="ji jj hi bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">Google云构建超时</h1><p id="895c" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">为了编写命令包装器，我需要理解当构建超时时Google Cloud Build的行为。我编写了一个快速的<a class="ae jd" href="https://gist.github.com/angstwad/1ad43131231ee0cb928ccde11604f9d0" rel="noopener ugc nofollow" target="_blank"> Python脚本</a>来模拟一个长时间运行的命令，捕捉每个有效信号，并将其记录到控制台。为了模拟Terraform在捕捉到类似<code class="du je jf jg jh b">SIGTERM</code>的信号时的行为，该脚本还运行了一个模拟清理操作。</p><p id="1c63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行这个程序时，我发现云构建作业被发送了一个<code class="du je jf jg jh b">SIGTERM</code>,正如人们合理预期的那样，触发了模拟清理阶段。不幸的是，不久之后，容器被强制终止。</p><p id="99d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这对Terraform来说是个坏消息，也是为什么命令包装器是必要的。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div class="er es kl"><img src="../Images/fe5d8bebf10d94412fb97559a477eae7.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*5gkJnS3RbvUTdIAlTT3Hew.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">运行信号捕捉器的云构建。清理开始了，但是容器几乎立即被强制终止。</figcaption></figure><h1 id="34cc" class="ji jj hi bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">请看命令包装器</h1><p id="f39a" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">该实用程序旨在成为仅在云构建步骤中运行的非交互式命令的精简包装器。它只需要一些信息:构建ID和项目ID。它访问云构建API来描述当前的构建，检查您的超时值、构建开始时间，并启动一个计时器，该计时器在预计强制终止构建的指定时间<em class="kx">之前触发。当计时器触发时，它会向包装的进程发送一个信号。默认情况下，这个信号是<code class="du je jf jg jh b">SIGTERM</code>。</em></p><p id="03c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当Terraform收到这个信号时，它会停止创建新的资源。正在进行的操作被允许完成，但是Terraform转移了它的焦点，优雅地终止正在运行的部署以更新它的状态并释放状态锁。</p><p id="5238" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它没有解决核心问题——超时才是真正的问题——但是它确实给了你一个安全网，可以说，减轻了强制终止的全部后果。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es ky"><img src="../Images/b490e655d1ee9e216770f340425111e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dK9fIXhUOn29SdFvr0RT2g.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">Terraform优雅地终止了Google Cloud Build的中期部署</figcaption></figure><h1 id="eb41" class="ji jj hi bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">最后的想法</h1><p id="0723" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">虽然将构建超时延长到一个合理的长度仍然是一个好的做法，但命令包装器提供了一个额外的保护层，以确保构建步骤有足够的时间来优雅地退出、保持状态、释放锁，并以最少的工作量再次运行，并且在理想情况下，为工程师节省一点时间来完成更重要的工作。</p></div></div>    
</body>
</html>