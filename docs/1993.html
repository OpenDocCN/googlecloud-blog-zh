<html>
<head>
<title>Cloud Run and Cloud Functions: Does the region change the performances?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云运行和云功能:区域是否改变性能？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-run-and-cloud-functions-does-the-region-change-the-performances-b967e5cee0cc?source=collection_archive---------1-----------------------#2021-10-28">https://medium.com/google-cloud/cloud-run-and-cloud-functions-does-the-region-change-the-performances-b967e5cee0cc?source=collection_archive---------1-----------------------#2021-10-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/6a706465e47990035989f408c08ba920.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uBCXef3AAMmDzC5evGjqNg.png"/></div></div></figure><p id="3e0e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">无服务器是云和应用架构的游戏规则改变者</strong>。我是这项技术的忠实粉丝，<strong class="is hj">抽象了服务器层，以及它所隐含的所有辛劳</strong>:监控、冗余、修补、扩展……</p><p id="0cca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，您对底层基础设施的控制<strong class="is hj">较少</strong>。在<a class="ae jo" rel="noopener" href="/google-cloud/bigquery-tell-me-your-region-i-will-tell-you-your-speed-41dcf42b8cc">之前的一篇文章</a>中，我展示了另一个无服务器产品BigQuery，它根据地区的不同有不同的处理性能；主要与地区年龄有关。<strong class="is hj">云运行和云功能也是无服务器</strong>产品，</p><blockquote class="jp"><p id="834b" class="jq jr hi bd js jt ju jv jw jx jy jn dx translated">云运行和云功能在不同地区之间是否也存在性能差异？</p></blockquote><h1 id="cb17" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated"><strong class="ak">测试协议</strong></h1><p id="f5ba" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">这里，我再次将我的测试集中在<strong class="is hj">处理性能</strong>上。为此，我使用了斐波那契算法(在递归模式下)来测试CPU的处理速度。<strong class="is hj">云运行和云函数使用完全相同的算法。</strong></p><p id="ee8e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lc">你可以在GitHub </em>上找到 <a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-perf-test/blob/main/cloudrun/main.go" rel="noopener ugc nofollow" target="_blank"> <em class="lc">云运行代码</em> </a> <em class="lc">和</em> <a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-perf-test/blob/main/cloudfunctions/main.go" rel="noopener ugc nofollow" target="_blank"> <em class="lc">云功能代码</em> </a> <em class="lc"/></p><h2 id="0f24" class="ld ka hi bd kb le lf lg kf lh li lj kj jb lk ll kn jf lm ln kr jj lo lp kv lq bi translated">部署测试环境</h2><p id="ed41" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">你可以<strong class="is hj">在你这边</strong>重现测试。为此，您可以通过运行<code class="du lr ls lt lu b">deploy.sh</code>文件来部署您的环境。它<strong class="is hj">在产品的所有可用区域</strong>上部署代码(在云上运行比在云函数上稍微多一点)。</p><p id="3cf2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lc">云功能和云运行都部署了1vCPU和2Gb内存，以便能够在最后进行比较。</em></p><p id="8388" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另外，还有<strong class="is hj">在云运行</strong>封装上没有特别优化。我在Cloud Run上使用了<a class="ae jo" href="https://cloud.google.com/blog/products/containers-kubernetes/google-cloud-now-supports-buildpacks" rel="noopener ugc nofollow" target="_blank"> Buildpack打包alpha特性</a>。它也是Buildpack，用于在幕后构建云功能。</p><h2 id="d272" class="ld ka hi bd kb le lf lg kf lh li lj kj jb lk ll kn jf lm ln kr jj lo lp kv lq bi translated">运行测试</h2><p id="353d" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated"><code class="du lr ls lt lu b">test-fibo.sh</code>对每个部署区域执行<strong class="is hj">相同的请求。我选择计算Fibonacci(47)，因为它<strong class="is hj">需要10到15秒</strong>来计算，<strong class="is hj">最小化/隐藏冷启动</strong> <em class="lc">(对于Golang应用程序非常低)</em>和<strong class="is hj">请求传输延迟</strong> <em class="lc">(你可以通过查看结果来说服自己。本人位于法国，部分亚美地区表现非常好，部分欧洲地区表现不太好)</em>。</strong></p><p id="f9ef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我<strong class="is hj">运行了3次相同的测试</strong>以获得每个区域的平均处理值。</p><h2 id="bb60" class="ld ka hi bd kb le lf lg kf lh li lj kj jb lk ll kn jf lm ln kr jj lo lp kv lq bi translated">打扫</h2><p id="e976" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">您可以使用脚本<code class="du lr ls lt lu b">destroy.sh</code>运行清理。这将删除服务部署。即使让未使用的服务出现在你的项目中不需要任何成本，它也会在你的项目中制造噪音！</p><h1 id="1f26" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk lv km kn ko lw kq kr ks lx ku kv kw bi translated">每个地区的云功能性能</h1><p id="c88b" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">第一次测试:<strong class="is hj">云函数。</strong>这里是3次运行后的性能结果。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/d362ed5a1b7bb52205040e40e2710293.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xv72BFlgKkyAQmFAi8-zKQ.png"/></div></div></figure><p id="950e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">哇，我<strong class="is hj">没想到会是这样的结果</strong>！我们可以观察到最慢和最快区域之间的<strong class="is hj"> 4秒，30%！</strong></p></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="260a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我对BigQuery的假设是，该地区的年龄与表现相关。让我们来看看云函数。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/e3716796807de680553ba81d9a16f2e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tuey6rz58U585EW5GhjnhQ.png"/></div></div></figure><p id="8a1c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这次，<strong class="is hj">就没那么明显了</strong>。当然，对某些地区来说确实如此，尤其是最古老的地区似乎最慢，而<code class="du lr ls lt lu b"><strong class="is hj">us-west3</strong></code> <strong class="is hj">和</strong> <code class="du lr ls lt lu b"><strong class="is hj">europe-central2</strong></code> <strong class="is hj">证实了越年轻越快。</strong></p><p id="d548" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是<code class="du lr ls lt lu b"><strong class="is hj">asia-northeast2</strong></code> <strong class="is hj">和</strong> <code class="du lr ls lt lu b"><strong class="is hj">asia-southeast2</strong></code> <strong class="is hj">是反例。</strong></p></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="ecae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后比较，为了做出正确的选择，我们必须<strong class="is hj">了解区域成本和区域的CO2影响</strong>，以便有能力选择最快、<a class="ae jo" href="https://cloud.google.com/functions/docs/locations#tier_1_pricing" rel="noopener ugc nofollow" target="_blank">最便宜和/或最环保的区域。</a></p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ml"><img src="../Images/1e5cb498e4dea50b92026bb45c59511d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mh6hQAozUFoNDsG_AlRwkw.png"/></div></div></figure><p id="2afb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里，<strong class="is hj">结果与BigQuery </strong>一致。<strong class="is hj">最高价格比最低价格提供更好的全球性能</strong>。</p><h1 id="541c" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk lv km kn ko lw kq kr ks lx ku kv kw bi translated">每个地区的云运行性能</h1><p id="ce7f" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">然后，云跑了。这是3次运行后的性能结果</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/d508a6adec5873bf7a1a39fd986365f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*anxG4Gj8twNwOW32SlZaww.png"/></div></div></figure><p id="e1fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里，最慢和最快的区域之间的<strong class="is hj">差异也高达2.5秒，即20%。</strong></p></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="c873" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们把它和这个地区的年龄联系起来。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mn"><img src="../Images/1523501c6642138eb242972b1052d5f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GtEyzuhUcMfk9zX8BB_Blg.png"/></div></div></figure><p id="fdb0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在全球范围内<strong class="is hj">这一次，越年轻越快</strong>，但也有例外:<code class="du lr ls lt lu b">asiasouth2</code>和<code class="du lr ls lt lu b">asia-southeast2</code>是最近的地区，在这次测试中是最慢的。</p></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="bd7b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在最快、<a class="ae jo" href="https://cloud.google.com/run/docs/locations#services" rel="noopener ugc nofollow" target="_blank">最便宜和/或最环保的</a>地区中做出正确选择的最后一张表。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/f2d72a721885b505a77d5bf7e4c09f29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-_cznNGNXUtKUT5kTEDUig.png"/></div></div></figure><p id="0eef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">希望<strong class="is hj">“越慢越便宜”</strong>的规则再次得到执行。</p><h1 id="39c0" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk lv km kn ko lw kq kr ks lx ku kv kw bi translated">云运行与云功能性能</h1><p id="e902" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">因为我在完全相同的条件下运行<strong class="is hj">测试，即:</strong></p><ul class=""><li id="d78a" class="mo mp hi is b it iu ix iy jb mq jf mr jj ms jn mt mu mv mw bi translated">两个平台上都有1个vCPU和2Gb内存</li><li id="ee3b" class="mo mp hi is b it mx ix my jb mz jf na jj nb jn mt mu mv mw bi translated">完全相同的Fibonnaci代码</li><li id="b97b" class="mo mp hi is b it mx ix my jb mz jf na jj nb jn mt mu mv mw bi translated">相同的容器打包引擎(buildpack)</li></ul><p id="aec3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我发现比较两种无服务器产品的性能很有趣。</p><p id="4c74" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lc">我只保留了公共区域，并根据云运行中云函数之间的性能差异进行了排序。</em></p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nc"><img src="../Images/5d5dbbcbba07246f5197db12900967c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*38ipubrKOBmcZQv3w2RCpQ.png"/></div></div></figure><p id="2d0b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">令人惊讶的是，<strong class="is hj">一种产品的区域表现<em class="lc">颜色</em>排名并不预先假定同一区域中另一种产品的表现</strong>。</p><p id="5a1a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lc">除了</em><code class="du lr ls lt lu b"><em class="lc">europe-central2</em></code><em class="lc"/><code class="du lr ls lt lu b"><em class="lc">northamerica-northeast1</em></code><em class="lc"/><code class="du lr ls lt lu b"><em class="lc">us-east1</em></code><em class="lc">。</em></p><p id="7be4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另外，<strong class="is hj">云功能和云运行之间有长达4秒的执行时间差</strong>。</p><p id="1ae0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">令人惊讶的是，据我所知，这两款产品共享相同的底层基础设施，这是我没有预料到的结果。</p><ul class=""><li id="9bce" class="mo mp hi is b it iu ix iy jb mq jf mr jj ms jn mt mu mv mw bi translated">是云功能的自动打包拖慢了执行速度？仅仅因为包装的原因，10%到30%的损失就太高了。</li><li id="cbbc" class="mo mp hi is b it mx ix my jb mz jf na jj nb jn mt mu mv mw bi translated">是产品时代？<br/> <em class="lc">这是我的最佳假设，但是“共享底层基础设施”并不完全准确，或者至少对于“计算”(CPU/内存)部分来说是不准确的；但是对于网络、安全、可伸缩性管理(…)部分来说可能是真的。</em></li></ul><h1 id="e3bc" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk lv km kn ko lw kq kr ks lx ku kv kw bi translated">区域和绩效影响</h1><p id="39b8" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">无服务器实际上就是他的意思:你<strong class="is hj">不管理底层基础设施、</strong>服务器类型、CPU生成、网络性能……因此，<strong class="is hj">你依赖于数据中心升级和版本</strong>。</p><p id="a311" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">与BigQuery相比，即使处理时间更慢，成本也是一样的，在这里，<strong class="is hj">我更担心这些结果</strong>。事实上，在一个慢行区域，你的罚分是双倍的:</p><ul class=""><li id="2ffe" class="mo mp hi is b it iu ix iy jb mq jf mr jj ms jn mt mu mv mw bi translated"><strong class="is hj">处理时间更长</strong>，因为您为使用的CPU/内存时间付费，<strong class="is hj">您将支付更多的费用</strong></li><li id="1bd2" class="mo mp hi is b it mx ix my jb mz jf na jj nb jn mt mu mv mw bi translated"><strong class="is hj">用户体验受到更高延迟的影响</strong> ( <em class="lc">实际上，对于非计算密集型请求，终端用户看不到差异)</em></li></ul></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="0c1c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，云函数和云运行之间的<strong class="is hj">性能差异是在任何情况下都只能使用云运行</strong>；<a class="ae jo" rel="noopener" href="/google-cloud/cloud-run-vs-cloud-functions-whats-the-lowest-cost-728d59345a2e">云函数在云运行上有优势的案例</a>现在已经非常少了。</p><p id="91c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，请记住，谷歌云可以在任何时候<strong class="is hj">更新其数据中心硬件</strong>，而不会发出通知和警告，并且当前结果<strong class="is hj">可能在3、6或12个月内出错</strong>！</p><blockquote class="jp"><p id="1b2c" class="jq jr hi bd js jt ju jv jw jx jy jn dx translated">不要依赖基础设施，它是无服务器的！</p></blockquote></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="2aee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lc">你可以在我的</em> <a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-perf-test" rel="noopener ugc nofollow" target="_blank"> <em class="lc"> GitHub库中找到自己运行测试的代码。</em> </a></p></div></div>    
</body>
</html>