<html>
<head>
<title>Multi-Tenant Google Cloud Platform B2B SaaS Applications How-to</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">多租户谷歌云平台B2B SaaS应用指南</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/multi-tenant-google-cloud-platform-saas-applications-how-to-3fc48162ef39?source=collection_archive---------1-----------------------#2018-06-18">https://medium.com/google-cloud/multi-tenant-google-cloud-platform-saas-applications-how-to-3fc48162ef39?source=collection_archive---------1-----------------------#2018-06-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="3586" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">隔离</h2></div><h1 id="d77f" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">概观</h1><p id="536a" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">本文解决了在<a class="ae kl" href="https://medium.com/p/f40cd9ae72a0/edit" rel="noopener">概念文章</a>中描述的隔离挑战。</p><p id="b934" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">概括来说，谷歌云平台提供了许多隔离边界，包括项目，现在是文件夹和组织，此外还有ACL和<a class="ae kl" href="https://cloud.google.com/vpc-service-controls/" rel="noopener ugc nofollow" target="_blank">基于网络的控制</a>。</p><p id="e929" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated"><a class="ae kl" href="https://cloud.google.com/iam/docs/overview" rel="noopener ugc nofollow" target="_blank">文档</a>很好地概述了ACL、项目、文件夹和组织策略。</p><p id="b563" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">在本文中，我们将重点关注可伸缩的基于项目的隔离、组织和域之间的关系、基于网络的控制以及它们对多租户SaaS应用程序的影响。</p><p id="a639" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">除了这里描述的隔离约束之外，您选择将应用程序和数据服务分配给项目和/或域的方式将取决于主权和延迟约束。</p></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><h1 id="20a6" class="ix iy hi bd iz ja ky jc jd je kz jg jh io la ip jj ir lb is jl iu lc iv jn jo bi translated">项目</h1><p id="6371" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">项目是最初的谷歌云平台隔离边界；这也是谷歌对与组织无关的客户使用的界限。</p><p id="e285" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">如果此边界解决了您的客户感知的安全问题，并且您不需要支持多个SAML IDPs(请参见身份验证和授权文章)，我们建议使用此边界，因为它支持有用的合资企业和数据共享结构，如VPC服务控制安全区域(请参见下文)。</p><p id="5f76" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">基于项目的隔离的一个自然问题是项目的扩散。租赁单元有助于缓解这种担忧。</p><h2 id="4daa" class="ld iy hi bd iz le lf lg jd lh li lj jh jy lk ll jj kc lm ln jl kg lo lp jn lq bi translated">租赁单位</h2><p id="fd5e" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated"><a class="ae kl" href="https://cloud.google.com/service-infrastructure/docs/tenancy-units-tutorial" rel="noopener ugc nofollow" target="_blank">租赁单元</a>提供基于服务、基于消费者的隔离环境。当新客户开始使用您的服务时，您可以在一个租赁单元中创建特定于该客户的所有资源。</p><p id="3c70" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">您可以在一个租赁单元内为每个客户创建一个单独的单租户应用程序实例，而不是构建一个本地多租户托管服务。这样，您就创建了一个“多单租户”服务:从消费者的角度来看是多租户的服务，但实际上是作为单独的单租户应用程序实现的。</p><p id="1b4b" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">这最适用于按客户隔离数据或按用户隔离应用程序基础架构的应用程序(即不是基于App Engine或Google Kubernetes引擎的完整多租户PaaS服务)。</p><h1 id="541d" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">组织和域</h1><p id="1a49" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">首先，一点术语:组织！=组织。</p><ul class=""><li id="d50a" class="lr ls hi jr b js km jv kn jy lt kc lu kg lv kk lw lx ly lz bi translated"><a class="ae kl" href="https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy#organizations" rel="noopener ugc nofollow" target="_blank">云平台组织资源</a>代表一个组织(例如一家公司)，是GCP资源层次结构和IAM策略中的根节点。它与云身份域相关联，云身份域代表组织中所有Google帐户的虚拟组，并公开基于域的策略和安全控制，如SAML SSO和<a class="ae kl" href="https://support.google.com/a/answer/33329" rel="noopener ugc nofollow" target="_blank">管理控制台组</a>。</li><li id="f29c" class="lr ls hi jr b js ma jv mb jy mc kc md kg me kk lw lx ly lz bi translated">云身份域还包括一个名为<a class="ae kl" href="https://support.google.com/a/answer/4352075?hl=en" rel="noopener ugc nofollow" target="_blank">组织</a>的资源(忽略传统的G套件品牌；这也适用于云身份)；这是用来组织用户和应用不同种类的政策给他们:他们可以访问哪些谷歌产品(如套件，YouTube，云控制台)，谁可以管理他们(如他们的密码管理员)。</li></ul><p id="c661" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">我们将主要关注云平台组织资源及其相关的云身份域。从Google云平台组织策略的角度来看，子域相当于域；然而，从云身份管理的角度来看，情况并非如此。</p><p id="e9e6" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">事实上，云身份域是用户管理和SAML SSO的基础，如果您为客户提供终端用户管理功能，这将带来许多影响:</p><ul class=""><li id="5c49" class="lr ls hi jr b js km jv kn jy lt kc lu kg lv kk lw lx ly lz bi translated">域代表了一个非常强大的隔离边界:这也是Google为其企业客户使用的边界。它们也是您的客户熟悉的一个界限；虽然组、文件夹和项目也是隔离边界，但它们需要更多的解释。</li><li id="6d5b" class="lr ls hi jr b js ma jv mb jy mc kc md kg me kk lw lx ly lz bi translated">您需要为希望启用SAML SSO联合的每个IDP分配一个单独的域或子域。正如在身份验证和授权文章中所讨论的，可以通过使用SAML代理来减轻这种约束。</li></ul><p id="b443" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">除了上面讨论的SAML联合含义之外，在选择多客户域还是单客户域时，还有许多因素需要考虑。</p><h2 id="45ae" class="ld iy hi bd iz le lf lg jd lh li lj jh jy lk ll jj kc lm ln jl kg lo lp jn lq bi translated">身份表征</h2><p id="28ba" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">客户用户和为每个客户分配的域上的身份之间的映射是直观的(例如<a class="ae kl" href="http://chevron.slb.com/" rel="noopener ugc nofollow" target="_blank">userid@customerdomain.mydomain.com</a>)。</p><p id="929a" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">在单个域代表所有客户的情况下，您需要在身份中包含客户信息(例如<a class="ae kl" href="http://chevron.slb.com/" rel="noopener ugc nofollow" target="_blank">userid_customerdomain@mydomain.com</a>)。如果你希望将GCP的一些托管服务直接暴露给客户的最终用户，例如，将文件上传到<a class="ae kl" href="https://cloud.google.com/storage/" rel="noopener ugc nofollow" target="_blank">谷歌云存储</a>，在<a class="ae kl" href="https://cloud.google.com/bigquery/" rel="noopener ugc nofollow" target="_blank"> BigQuery </a>上运行分析，而不使用SAML联邦，这尤其成问题。</p><h2 id="b75b" class="ld iy hi bd iz le lf lg jd lh li lj jh jy lk ll jj kc lm ln jl kg lo lp jn lq bi translated">行政范围</h2><p id="10b2" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">Google云平台管理范围通过IAM角色管理；然而，Google Cloud身份默认的管理范围是基于域的，或者在<a class="ae kl" href="https://support.google.com/a/answer/175747?hl=en&amp;ref_topic=3541972" rel="noopener ugc nofollow" target="_blank">多域支持的情况下</a>(忽略遗留的G套件品牌；这也适用于云身份)。您可以定义管理角色，这些角色属于一个<a class="ae kl" href="https://support.google.com/a/answer/6129577?hl=en" rel="noopener ugc nofollow" target="_blank">组织单位</a>(即。一组用户)以及<a class="ae kl" href="https://support.google.com/a/answer/33325?hl=en&amp;ref_topic=4514341" rel="noopener ugc nofollow" target="_blank">特定服务</a>(例如，管理密码)(忽略传统的G套件品牌；这也适用于云身份)。</p><p id="bc51" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated"><a class="ae kl" href="https://support.google.com/a/answer/2405986" rel="noopener ugc nofollow" target="_blank">超级管理员</a>(忽略传统G套件品牌；这也适用于云身份)具有跨所有用户和云身份管理服务的完整范围(例如密码重置、<a class="ae kl" href="https://developers.google.com/admin-sdk/directory/v1/guides/delegation" rel="noopener ugc nofollow" target="_blank">全域授权</a>)。这可能是按域或子域隔离客户，而不实施<a class="ae kl" href="https://support.google.com/a/answer/175747?hl=en&amp;ref_topic=3541972" rel="noopener ugc nofollow" target="_blank">多域支持</a>的好理由。</p><h2 id="3e2d" class="ld iy hi bd iz le lf lg jd lh li lj jh jy lk ll jj kc lm ln jl kg lo lp jn lq bi translated">缩放比例</h2><p id="f69e" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">每个客户的单个域或子域自然会带来可管理性的问题；这里有几个机制可以提供帮助:</p><ul class=""><li id="ba2a" class="lr ls hi jr b js km jv kn jy lt kc lu kg lv kk lw lx ly lz bi translated">您可以<a class="ae kl" href="https://support.google.com/a/answer/7502379?visit_id=1-636560392711326124-2664298727&amp;rd=1" rel="noopener ugc nofollow" target="_blank">将它们全部关联到一个账户</a>，并通过<a class="ae kl" href="https://support.google.com/a/answer/175747?hl=en&amp;ref_topic=3541972" rel="noopener ugc nofollow" target="_blank">多域支持</a>从同一个谷歌管理控制台管理它们(忽略传统的G Suite品牌；这也适用于云身份)。这简化了计费和管理，但也带来了一些限制:如果您正在实现SAML联合，那么域必须都共享同一个SAML IDP相同的管理员负责所有的领域，即。您不能按客户划分管理范围；由于所有域共享一个用户目录(尽管这可以通过子组织来划分)，用户隔离减少了。</li><li id="c9ac" class="lr ls hi jr b js ma jv mb jy mc kc md kg me kk lw lx ly lz bi translated"><a class="ae kl" href="https://developers.google.com/admin-sdk/" rel="noopener ugc nofollow" target="_blank"> Admin SDK </a>(忽略遗留的G Suite品牌；这也适用于云身份)提供了<a class="ae kl" href="https://developers.google.com/admin-sdk/reseller/v1/reference/customers/insert" rel="noopener ugc nofollow" target="_blank">创建新客户订阅</a>(例如<a class="ae kl" href="http://chevron.slb.com/" rel="noopener ugc nofollow" target="_blank">customerdomain.mydomain.com</a>)的能力。使用此API需要您被启用为谷歌经销商。</li></ul><h2 id="ae75" class="ld iy hi bd iz le lf lg jd lh li lj jh jy lk ll jj kc lm ln jl kg lo lp jn lq bi translated">演员表</h2><p id="58b2" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">您可以为每个域/组织分配至少一个Google Cloud Platform计费id，或者跨域/组织共享计费id。一如既往，每种方法都有利弊。</p><ul class=""><li id="20dd" class="lr ls hi jr b js km jv kn jy lt kc lu kg lv kk lw lx ly lz bi translated">每个客户域/组织至少有一个Google Cloud Platform计费id:这简化了传递计费，缓解了全域授权计费的不足。这也导致计费id激增。</li><li id="f601" class="lr ls hi jr b js ma jv mb jy mc kc md kg me kk lw lx ly lz bi translated">跨域/组织共享的Google云平台计费id:这最大限度地减少了计费id的增加，但实现起来很复杂，因为计费id属于最初创建它的组织，所以虽然您不能直接将其链接到多个组织，但您可以通过将其与创建项目的组织内的用户链接，将其用于不同组织内的项目。这种配置非常复杂，超出了本文的范围，并指出基于项目的隔离或多域支持(见上文)可能是更合适的选择。</li></ul></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><h1 id="d5a2" class="ix iy hi bd iz ja ky jc jd je kz jg jh io la ip jj ir lb is jl iu lc iv jn jo bi translated">基于网络的控制</h1><h2 id="a0ea" class="ld iy hi bd iz le lf lg jd lh li lj jh jy lk ll jj kc lm ln jl kg lo lp jn lq bi translated">VPC服务控制</h2><p id="12c2" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">正如我们在身份验证和授权文章中所讨论的，<a class="ae kl" href="https://developers.google.com/admin-sdk/directory/v1/guides/delegation" rel="noopener ugc nofollow" target="_blank">域范围的授权</a>带来了数据泄漏的挑战。</p><p id="eb87" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated"><a class="ae kl" href="https://cloud.google.com/vpc-service-controls/" rel="noopener ugc nofollow" target="_blank"> VPC服务控制</a>(私有测试版)使您能够围绕云存储桶等谷歌云平台资源定义基于网络的安全边界，以将数据限制在虚拟私有云(VPC)内，并帮助降低数据泄露风险。</p><p id="9ad3" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">您的客户可以将资源放在安全区域，并建立基于IP的访问限制，这样他们的内部机密信息就不会与您的应用程序共享。</p><p id="fb9a" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">同样，如果选择项目作为客户隔离边界，可以使用VPC服务控件在多个租户项目之间建立数据隔离边界。您可以有选择地启用VPC区域之间的共享，例如在合资企业的情况下。</p><p id="ccf5" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">有一个关键的警告:VPC服务控制是失效开放的，而不是失效关闭的，所以没有明确在VPC安全区的数据将可以跨越VPC的边界。强大的治理流程和自动化有助于降低这种风险。</p></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><h1 id="9476" class="ix iy hi bd iz ja ky jc jd je kz jg jh io la ip jj ir lb is jl iu lc iv jn jo bi translated">下一步是什么</h1><p id="e7a8" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">确定哪些选择最符合您的用例，并开始原型制作。</p><p id="3848" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">在<a class="ae kl" href="https://developers.google.com/apis-explorer/#p/" rel="noopener ugc nofollow" target="_blank"> API浏览器</a>中试用API。</p><p id="4a1a" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">阅读</p><ul class=""><li id="8fe8" class="lr ls hi jr b js km jv kn jy lt kc lu kg lv kk lw lx ly lz bi translated"><a class="ae kl" href="https://cloud.google.com/resource-manager/docs/managing-multiple-orgs" rel="noopener ugc nofollow" target="_blank">管理多个组织</a>学习如何将公司内的子组织或部门作为没有中央管理的独立实体来维护。</li><li id="1c9f" class="lr ls hi jr b js ma jv mb jy mc kc md kg me kk lw lx ly lz bi translated"><a class="ae kl" rel="noopener" href="/google-cloud/google-cloud-platform-cross-org-billing-41c5db8fefa6">谷歌云平台跨组织计费</a>了解如何跨多个GCP组织使用同一个计费账户。</li><li id="7713" class="lr ls hi jr b js ma jv mb jy mc kc md kg me kk lw lx ly lz bi translated"><a class="ae kl" rel="noopener" href="/google-cloud/share-data-with-confidence-cell-level-access-controls-in-bigquery-and-data-studio-cf753fa173a4">放心地共享数据:BigQuery和Data Studio中的单元级访问控制</a>了解管理访问控制的方法，不仅在文档级别，而且针对单个结果。</li></ul></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><h1 id="c12d" class="ix iy hi bd iz ja ky jc jd je kz jg jh io la ip jj ir lb is jl iu lc iv jn jo bi translated">承认</h1><p id="a900" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">非常感谢:</p><ul class=""><li id="1873" class="lr ls hi jr b js km jv kn jy lt kc lu kg lv kk lw lx ly lz bi translated">Sam Srinivas的身份表示思想，以及对多租户的广泛支持。</li><li id="6b61" class="lr ls hi jr b js ma jv mb jy mc kc md kg me kk lw lx ly lz bi translated">Samrat Ray帮助我理解了VPC服务控制的细微差别。</li><li id="b3ec" class="lr ls hi jr b js ma jv mb jy mc kc md kg me kk lw lx ly lz bi translated">罗伯·科奇曼帮我解决了租房的问题。</li></ul></div></div>    
</body>
</html>