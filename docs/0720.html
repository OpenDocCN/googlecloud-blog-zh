<html>
<head>
<title>Track Google Cloud Platform Organizations Associated With Your Billing Ids</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">跟踪与您的账单id相关联的Google云平台组织</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/find-google-cloud-platform-organizations-associated-with-your-billing-ids-6b216618a592?source=collection_archive---------3-----------------------#2018-08-09">https://medium.com/google-cloud/find-google-cloud-platform-organizations-associated-with-your-billing-ids-6b216618a592?source=collection_archive---------3-----------------------#2018-08-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="3586" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">鲁比·戈德堡遇见弗兰肯斯坦</h2></div><p id="0550" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可能希望在多个GCP <a class="ae jt" href="https://cloud.google.com/resource-manager/docs/creating-managing-organization" rel="noopener ugc nofollow" target="_blank">组织</a>中使用同一个账单账户；例如，SaaS产品的多租户子域。</p><p id="ae2c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">许多计费经理的下一个问题是如何跟踪在您的企业中百花齐放的情况，以及他们是否遵守政策。您可能已经从计费代码与单个项目的关联中猜到了，这很棘手。</p><p id="71d2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以使用<a class="ae jt" href="https://cloud.google.com/billing/reference/rest/v1/billingAccounts.projects/list" rel="noopener ugc nofollow" target="_blank">计费API </a>列出与计费账户相关的项目；然后，您可以使用<a class="ae jt" href="https://cloud.google.com/resource-manager/reference/rest/v1/projects/getAncestry" rel="noopener ugc nofollow" target="_blank">资源管理器API </a>来获取项目的父组织。然而，有一点难以理解:访问资源管理器API的帐户需要项目所属组织的文件夹查看者权限。如果满足以下所有条件，这是可以避免的:</p><ul class=""><li id="cd2d" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">您对根计费组织拥有超级管理员权限。</li><li id="e502" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">计费用户权限最初被委派给该组织的成员。</li><li id="80de" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">受委托的用户在新组织中创建了一个项目。</li></ul><p id="0928" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可能会问，这种魔力是如何发挥作用的？</p><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es ki"><img src="../Images/6485e753e3daad8575b0f5956709af96.png" data-original-src="https://miro.medium.com/v2/resize:fit:856/1*1ZETpznmHKI2gUru95cBNg.gif"/></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">布茨教授和自动操作餐巾纸(1931)。汤匙(A)被举到嘴边，拉动绳子(B ),从而猛拉勺子，将饼干(D)扔过鹦鹉(E)。鹦鹉在饼干和栖木倾斜后跳起来，把种子打翻在桶里。桶中的额外重量拉动绳子(I)，绳子打开并点燃打火机(J)，引发爆炸(K)，导致镰刀(L)切断绳子(M)，允许附有餐巾的钟摆来回摆动，从而擦拭下巴。</figcaption></figure><p id="5782" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如在<a class="ae jt" rel="noopener" href="/google-cloud/multi-tenant-google-cloud-platform-saas-applications-how-to-fbd16c8a9766">多租户GCP SaaS应用授权文章</a>中所讨论的，一个适当授权的服务帐户可以代表一个域中的用户，即。通过<a class="ae jt" href="https://developers.google.com/admin-sdk/directory/v1/guides/delegation" rel="noopener ugc nofollow" target="_blank">域范围的授权</a>模拟用户(忽略传统的G套件品牌；这也适用于云身份API)。</p><p id="dac5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这种情况下，服务帐户将代表委托计费用户，使用资源管理器API获取其项目的父组织。</p></div><div class="ab cl ku kv gp kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hb hc hd he hf"><p id="fb7d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae jt" href="https://github.com/demoforwork/public/tree/master/GCPOrgsAssociatedWithBillingIds" rel="noopener ugc nofollow" target="_blank">该实用程序</a>执行繁重的工作，并返回项目的父组织列表，其中一个查看者(或以上，例如所有者/编辑)已被授予与另一个组织关联的计费帐户的计费用户角色。</p><h1 id="760e" class="lb lc hi bd ld le lf lg lh li lj lk ll io lm ip ln ir lo is lp iu lq iv lr ls bi translated">先决条件</h1><h2 id="ae94" class="lt lc hi bd ld lu lv lw lh lx ly lz ll jg ma mb ln jk mc md lp jo me mf lr mg bi translated">Python和Python库</h2><p id="4e3b" class="pw-post-body-paragraph ix iy hi iz b ja mh ij jc jd mi im jf jg mj ji jj jk mk jm jn jo ml jq jr js hb bi translated">该实用程序依赖于Python和以下GCP和谷歌API库:</p><ul class=""><li id="41fc" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated"><a class="ae jt" href="https://github.com/google/google-api-python-client/tree/master/googleapiclient" rel="noopener ugc nofollow" target="_blank"> googleapiclient </a></li><li id="2ebb" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">google.oauth2</li></ul><h2 id="5b8e" class="lt lc hi bd ld lu lv lw lh lx ly lz ll jg ma mb ln jk mc md lp jo me mf lr mg bi translated">全域委托</h2><p id="d584" class="pw-post-body-paragraph ix iy hi iz b ja mh ij jc jd mi im jf jg mj ji jj jk mk jm jn jo ml jq jr js hb bi translated">从<a class="ae jt" href="https://github.com/demoforwork/public/blob/master/GCPOrgsAssociatedWithBillingIds/cloud.google.com/console" rel="noopener ugc nofollow" target="_blank">云控制台</a>，创建一个具有<em class="mm">全域委托权限</em>的服务账户，并下载JSON密匙。</p><ul class=""><li id="5d2e" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">从<a class="ae jt" href="https://console.cloud.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank">IAM&amp;admin-&gt;Service Accounts</a>屏幕创建它(即。不是API - &gt;凭证屏幕)或全域委托权限将不可用</li><li id="b8b3" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">在生产中，您会希望将它存储在一个安全的存储中，比如GCS，而不是您的文件系统；很容易不经意地将密钥和源代码一起上传，一旦上传到GitHub上，就很难删除旧版本的源代码。</li><li id="db7d" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">注意客户端ID:有一堆ID…您想要的是从管理服务帐户-&gt;查看客户端ID屏幕…或者直接从下载的JSON文件中获取</li></ul><p id="ccb7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从<a class="ae jt" href="https://github.com/demoforwork/public/blob/master/GCPOrgsAssociatedWithBillingIds/admin.google.com" rel="noopener ugc nofollow" target="_blank">云身份管理控制台</a>，以超级用户身份登录；超级用户角色是必需的，因为您可以通过这些设置向服务帐户授予完全管理SDK权限，否则将构成权限升级。</p><ul class=""><li id="a3dc" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">使用您之前记录的id，<a class="ae jt" href="https://developers.google.com/admin-sdk/directory/v1/guides/delegation#delegate_domain-wide_authority_to_your_service_account" rel="noopener ugc nofollow" target="_blank">授权您在GCP创建的服务帐户</a>用于所需的范围，即【https://www . Google APIs . com/auth/cloudplatformorganizations . readonly、<a class="ae jt" href="https://www.googleapis.com/auth/cloudplatformprojects.readonly" rel="noopener ugc nofollow" target="_blank">https://www . Google APIs . com/auth/cloudplatformprojects . readonly</a>、<a class="ae jt" href="https://www.googleapis.com/auth/cloud-billing.readonly" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/cloud-billing.readonly</a></li><li id="0b46" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">从安全-&gt;高级设置-&gt;管理客户端API访问窗口执行此操作</li></ul><h1 id="e613" class="lb lc hi bd ld le lf lg lh li lj lk ll io lm ip ln ir lo is lp iu lq iv lr ls bi translated">安装</h1><p id="0ed6" class="pw-post-body-paragraph ix iy hi iz b ja mh ij jc jd mi im jf jg mj ji jj jk mk jm jn jo ml jq jr js hb bi translated">下载<a class="ae jt" href="https://github.com/demoforwork/public/tree/master/GCPOrgsAssociatedWithBillingIds" rel="noopener ugc nofollow" target="_blank">文件</a>。</p><p id="4450" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在脚本中配置所需的域、组织和JSON密钥文件</p><p id="c69c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行脚本:</p><pre class="kj kk kl km fd mn mo mp mq aw mr bi"><span id="b849" class="lt lc hi mo b fi ms mt l mu mv">$ python list_orgs_associated_with_billing_ids.py</span></pre></div><div class="ab cl ku kv gp kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hb hc hd he hf"><h1 id="dc57" class="lb lc hi bd ld le mw lg lh li mx lk ll io my ip ln ir mz is lp iu na iv lr ls bi translated">承认</h1><p id="a900" class="pw-post-body-paragraph ix iy hi iz b ja mh ij jc jd mi im jf jg mj ji jj jk mk jm jn jo ml jq jr js hb bi translated">非常感谢Cyrus Harvesf的关键见解，即二级域名上项目的计费用户通常是一级组织的成员，因此可以通过一级域名上的域名范围委托来进行跟踪；也谢谢你在我迷失在荆棘丛中时指引我回到正道。</p></div></div>    
</body>
</html>