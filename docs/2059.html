<html>
<head>
<title>Reduce DB upgrade downtime to less than 10 minutes using DMS on Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Cloud上的DMS将数据库升级停机时间减少到不到10分钟</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/reduce-db-upgrade-downtime-to-less-than-10-minutes-using-dms-on-google-cloud-8704681e45ac?source=collection_archive---------1-----------------------#2022-01-14">https://medium.com/google-cloud/reduce-db-upgrade-downtime-to-less-than-10-minutes-using-dms-on-google-cloud-8704681e45ac?source=collection_archive---------1-----------------------#2022-01-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0c1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">免责声明:</strong> <em class="jd">本博客中表达的观点、想法和意见仅属于作者，不一定属于作者的雇主、组织、委员会或其他团体或个人。</em></p><p id="0446" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇博文是为你写的，如果你正在为关键应用程序运行<a class="ae je" href="https://cloud.google.com/sql/" rel="noopener ugc nofollow" target="_blank">谷歌云SQL </a>，并且打算减少升级数据库的停机时间。数据库(DB)升级在大多数情况下是修复缺陷、采用新功能、合规性的要求，最重要的是，保持应用程序数据的安全，并为应用程序带来利用新功能的灵活性。有时，如果数据库升级没有及时完成，可能会导致严重的影响问题。运营团队通常会花费大量时间来规划和测试升级，以确保停机时间最少，对相关应用和服务的影响最小。这篇博客展示了Google云数据迁移服务(DMS)如何减少数据库升级的停机时间。</p><p id="767e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" href="https://cloud.google.com/database-migration" rel="noopener ugc nofollow" target="_blank"> Google cloud DMS </a>是一种无服务器逻辑复制服务，它简化了源数据库和目标数据库之间的复制。用户可以忽略设置复制背后的复杂性，如服务器、配置管理等。</p><p id="4d2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">考虑到关键的生产环境，我将演练首先创建source env，然后使用DMS执行DB升级所需的所有步骤。随意忽略调试源env的步骤，同时您可以使用剩余的步骤来测试和派生您的策略。以下是这篇博文的高度概括——如何使用DMS来升级云SQL PostgreSQL，但是同样的策略也可以用于升级Google Cloud SQL MySQL DB实例:</p><ol class=""><li id="c727" class="jf jg hi ih b ii ij im in iq jh iu ji iy jj jc jk jl jm jn bi translated">创建源数据库环境— Google Cloud SQL PostgreSQL</li><li id="e7fe" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">使用GCE (Google计算引擎)上的CloudSQL代理模拟应用环境—本节还展示了如何保护云SQL实例和应用层之间的网络通信。</li><li id="0a78" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">配置DMS复制，该复制隐式创建目标云SQL PostgreSQL数据库实例和预期的数据库版本，并启动复制</li><li id="d4b0" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">验证DMS复制—完整复制和CDC复制(变更数据捕获)</li><li id="93bb" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">切换—过渡到更高版本的目标数据库并移动应用端点</li><li id="c6d2" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">成本考虑</li><li id="7551" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">最佳实践、已知问题和限制以及其他参考资料</li></ol><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es jt"><img src="../Images/8d06a1d33fa3da09d6f2a3507926ffa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/0*cuVUFVCcdFJ5shfT"/></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kb"><img src="../Images/b5bdc96fcc3cb220428178b5989a56b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:778/0*TOG8liO1yjgM83Ss"/></div></div></figure><p id="8ab9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1 —创建源数据库环境</strong></p><p id="eb89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1.1 —假设和先决条件</strong></p><p id="852c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于生产/开发环境，这一部分是可选的，因为您必须有要升级的源数据库。对于那些希望从头开始测试此过程并了解使用复制方法DMS升级数据库的整个过程的所有细节的人来说，本节很有帮助。以下是这篇博客的假设:</p><ol class=""><li id="b4d0" class="jf jg hi ih b ii ij im in iq jh iu ji iy jj jc jk jl jm jn bi translated">你应该已经配置好了谷歌云环境，并且可以运行了，如果还没有，那么继续<a class="ae je" href="https://cloud.google.com/gcp" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/gcp</a>。</li><li id="76d5" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">虽然我们将这篇博客的范围限制在PostgreSQL，但是推荐的升级数据库的方法也适用于Cloud SQL MySQL数据库。</li><li id="2baa" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">数据库和应用程序都在利用VPC专用子网的专用网络中运行。</li><li id="e4f8" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">由于数据库需要安全的通信，所有的网络通信都是使用私有IP来完成的。例如:数据库和应用层之间的通信是使用私有IP完成的。</li><li id="8b7b" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">使用的数据库引擎是PostgreSQL，源版本是PostgreSQL 10，目的是将数据库升级到目标PostgreSQL引擎13。</li><li id="9dc2" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">示例数据库，模式源自开源PostgreSQL社区推荐的<a class="ae je" href="https://wiki.postgresql.org/wiki/Sample_Databases" rel="noopener ugc nofollow" target="_blank">示例数据库</a>——“航空公司演示数据库”。</li><li id="90c6" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">应用层准备工作必须已经完成，例如任何数据库级程序和关于目标数据库版本的兼容性测试。</li><li id="f27c" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">本博客中考虑的GCP地区是<strong class="ih hj">孟买</strong> — <em class="jd">亚洲-南方1 </em>，不使用默认的VPC，不建议在生产和安全环境中使用。下面的屏幕截图显示，创建了一个名为"<strong class="ih hj"> sh-vpc </strong>"的VPC，孟买地区的子网为"<strong class="ih hj"> subnet-mumbai </strong>"。看一看子网IP范围配置。请记住，在这个博客中使用了相同的网络配置。</li></ol><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/cab6b9f564e72e535506d3e20fc58b54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Gg-OrE3lfvoeVknM"/></div></div></figure><p id="fb9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1.2 —创建源云SQL PG (PostgreSQL)数据库</strong></p><p id="1b50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本节中，我们将在Mumbai地区创建一个云SQL PostgreSQL数据库，只需很少的配置就可以模拟源生产数据库环境。在云控制台，进入云SQL页面:<a class="ae je" href="https://console.cloud.google.com/sql/instances" rel="noopener ugc nofollow" target="_blank">进入云SQL </a>，创建云SQL postgreSQL 10数据库，配置如下截图所示。请记下密码，因为在后面的步骤中会用到它。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kh"><img src="../Images/b74fe6d6bf12894c9cd6941daa8194e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OdFw2fKHlC9P-Uc7"/></div></div></figure><p id="5a3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据您的要求选择机器类型。您可能想要测试和存储比下面显示的更多的数据，所以根据您的要求进行选择。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ki"><img src="../Images/4624ab2fb3b3484e5f95bea34da741cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9WPL6C2uht_T_mwG"/></div></div></figure><p id="9054" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请明智地选择您的网络配置。根据我们的假设和VPC配置，我们将网络配置限制为私有，并且不检查公共选项。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kj"><img src="../Images/8bce5a59e4c1660d5725f856c5969db8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-lWEffOXxkWnfSPF"/></div></div></figure><p id="3e5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成源数据库的所有选项后，创建实例:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es kk"><img src="../Images/382c29bd73c9c97c5b6440c7b10a4b09.png" data-original-src="https://miro.medium.com/v2/resize:fit:724/0*mMr-eztncIXugaBb"/></div></figure><p id="23de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">过一会儿，DB实例将作为就绪状态列在控制台上。记录分配给实例的私有IP地址。在数据库连接的后续步骤中将需要此私有IP地址。请记住，这是在VPC子网配置下的IP范围配置设置的限制下分配的。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/3628db8055a7002e5efe6e729a73d578.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BTymuXDxeiUXnf42"/></div></div></figure><p id="7941" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2 —使用云SQL proxy代理模拟应用环境</strong></p><p id="9e41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2.1 —设置GCE虚拟机</strong></p><p id="5708" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本节中，我们将在同一个子网Cloud SQL DB实例中设置GCE VM，这将客户端和数据库之间的通信范围限制在单个子网中，如下图所示。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es kl"><img src="../Images/658d95ee59965eddea5a9755c18cf3e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/0*6cJDr_HL2DshJecE"/></div></figure><p id="9c71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">计算引擎用作连接到数据库的应用层，也可以假定为连接到数据库实例的跳转服务器。在云控制台中，进入<a class="ae je" href="https://console.cloud.google.com/compute/instances" rel="noopener ugc nofollow" target="_blank">虚拟机实例</a>页面，设置虚拟机，如下图所示。选中以选择Mumbai作为区域，并将区域与数据库匹配以防止任何延迟。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es km"><img src="../Images/110e8a662acc848a2dc8ed256d509f86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*27fMdnoUPs_yyyyJ"/></div></div></figure><p id="31d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，选择私有网络，类似于数据库的配置，并禁用公共网络和临时连接。这将确保该虚拟机和数据库实例之间的所有连接仅通过专用子网路由，并使通信更加安全。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kn"><img src="../Images/8237171acddf015428573043a19bc6d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4kQtGxsEmaXvB5aR"/></div></div></figure><p id="f658" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择创建实例后，请等待一段时间，它将出现在VM实例控制台页面上，如下所示。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ko"><img src="../Images/dd7b7ba65d3724c5eec0e2efd9c2bb97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LjMydSTQLLgES6-C"/></div></div></figure><p id="e3bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于<strong class="ih hj"> ssh </strong>选项，您可以选择“<strong class="ih hj">在浏览器窗口</strong>中打开”选项来登录虚拟机实例。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kp"><img src="../Images/8c220a77d886b5ae5626646d03f25939.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PZbLqEgoITC8n00j"/></div></div></figure><p id="dbf6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">登录ssh窗口后，使用最新版本的<a class="ae je" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank"> Cloud SDK </a>为虚拟机实例打补丁，并安装PostgreSQL客户端— <em class="jd"> psql </em> —如下截图所示:</p><blockquote class="kq kr ks"><p id="2a89" class="if ig jd ih b ii ij ik il im in io ip kt ir is it ku iv iw ix kv iz ja jb jc hb bi translated">sudo apt-get更新&amp;&amp; sudo apt-get安装google-cloud-sdk</p><p id="fbeb" class="if ig jd ih b ii ij ik il im in io ip kt ir is it ku iv iw ix kv iz ja jb jc hb bi translated">sudo安装postgresql客户端</p></blockquote><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kw"><img src="../Images/4a26b059be3f683ebc9e2c74d0d8d538.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OU2ngX9Oh0KQihvf"/></div></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es kx"><img src="../Images/2e71fe4e8d624d603f7ccb2ba0330ab8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/0*ZvE75CQbaFZO1RYD"/></div></figure><p id="717c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2.2连接虚拟机和数据库:</strong></p><p id="d2fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本节中，我们将部署<a class="ae je" href="https://cloud.google.com/sql/docs/mysql/sql-proxy" rel="noopener ugc nofollow" target="_blank">Google Cloud SQL proxy</a>agent作为数据库端点，并将数据库模拟为在同一虚拟机上运行的应用层的本地。对于这篇博文，我们假设psql应用层。</p><p id="83fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您尚未记录数据库私有IP，请返回到<a class="ae je" href="https://console.cloud.google.com/sql/instances/" rel="noopener ugc nofollow" target="_blank"> Cloud SQL cloud控制台</a>并复制数据库实例私有IP地址，如10.45.193.4所示，使用创建数据库时提供的用户名和数据库:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/6add11316fb2235eb87369201ef5db33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*e9FIhLrl70yLRmVF"/></div></div></figure><p id="59d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用虚拟机ssh上的私有IP连接到数据库，如屏幕截图所示。</p><blockquote class="kq kr ks"><p id="302b" class="if ig jd ih b ii ij ik il im in io ip kt ir is it ku iv iw ix kv iz ja jb jc hb bi translated">psql -h 10.45.193.4 -U postgres</p></blockquote><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ky"><img src="../Images/9621c51df79793dfe07bf48704af3f71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EcHJo4t5CZX6_OqE"/></div></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kz"><img src="../Images/99afacad8cb9067098196512560e0cfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vWuIDr7SL3KAbcF7"/></div></div></figure><p id="51ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用云SQL代理模拟应用环境数据库连接，云SQL代理提供安全连接，使用TLS和128位AES密码自动加密进出数据库的流量，独立于数据库协议，您无需管理SSL证书。它还使用IAM权限来控制谁和什么可以连接到您的云SQL实例。云sql身份验证代理作为本地客户端运行，我们的客户端工具psql通过标准数据库协议与云SQL身份验证代理通信，后者又使用安全隧道与运行在数据库服务器上的伴生进程通信。通过云SQL身份验证代理建立的每个连接都会创建一个到云SQL实例的连接。SQL代理充当psql客户端应用程序的DB端点，这模拟了我们的应用程序环境。接下来，让我们在GCE VM上下载并安装云SQL代理。</p><p id="a009" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">下载云SQL Auth代理:</strong></p><blockquote class="kq kr ks"><p id="268f" class="if ig jd ih b ii ij ik il im in io ip kt ir is it ku iv iw ix kv iz ja jb jc hb bi translated">【wget<a class="ae je" href="https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64</strong></a><strong class="ih hj">-O云_sql_proxy </strong></p></blockquote><p id="ba08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使云SQL Auth代理可执行:</strong></p><blockquote class="kq kr ks"><p id="7344" class="if ig jd ih b ii ij ik il im in io ip kt ir is it ku iv iw ix kv iz ja jb jc hb bi translated"><strong class="ih hj"> chmod +x cloud_sql_proxy </strong></p></blockquote><p id="e795" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用云SQL代理连接数据库:</p><p id="9042" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回到<a class="ae je" href="https://console.cloud.google.com/sql/instances/" rel="noopener ugc nofollow" target="_blank">云SQL云控制台</a>并选择您的PG实例以检查<em class="jd">连接名称</em>并在云SQL代理中使用相同名称，如屏幕截图所示:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es la"><img src="../Images/4447a6dd7be2142ba258b440488755df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AKbBbAQpLdrYk_zv"/></div></div></figure><blockquote class="kq kr ks"><p id="02d4" class="if ig jd ih b ii ij ik il im in io ip kt ir is it ku iv iw ix kv iz ja jb jc hb bi translated">。/cloud _ SQL _ proxy-instances =<strong class="ih hj">&lt;&lt;连接名称&gt; &gt; </strong> =tcp:5432 &amp;</p><p id="e679" class="if ig jd ih b ii ij ik il im in io ip kt ir is it ku iv iw ix kv iz ja jb jc hb bi translated">。/cloud _ SQL _ proxy-instances =<strong class="ih hj">shailesh-1:Asia-south 1:pg-db1</strong>= TCP:5432&amp;</p></blockquote><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lb"><img src="../Images/2c5fd3d2aacda22213732dc4175348e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G1vzUowunY_cPrOc"/></div></div></figure><p id="e231" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">建议将云SQL代理作为后台服务运行，但是为了简单起见，这里显示它作为后台命令运行。现在，使用psql中的localhost IP通过云SQL代理连接到数据库，因为云代理正在运行并将连接转发到<em class="jd"> localhost </em>上的默认端口5432上的数据库。这种方法对应用层隐藏了网络复杂性，并将数据库模拟为本地的。</p><blockquote class="kq kr ks"><p id="a837" class="if ig jd ih b ii ij ik il im in io ip kt ir is it ku iv iw ix kv iz ja jb jc hb bi translated">psql -h 127.0.0.1 -U postgres</p></blockquote><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lc"><img src="../Images/f4c11d9ec7bf068d678cd7525161492c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*caeo9n6d4e2R-47k"/></div></div></figure><p id="24f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">建立连接后，请参见下面云SQL代理日志中的连接条目。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ld"><img src="../Images/af25fc2ba7c4b2aa39bb3253f9938b8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*k5njv2HcCf3uWOeI"/></div></div></figure><p id="766c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们将填充一个示例数据库“demo”、模式“bookings”和一组表。它是从<a class="ae je" href="https://wiki.postgresql.org/wiki/Sample_Databases" rel="noopener ugc nofollow" target="_blank">开源postgresql社区页面</a>下载的，示例数据库是“航空公司演示数据库”。我们正在部署一个样本数据库的更大版本，它有超过2.5 GB的数据，具有由复杂数据类型(如“jsonb”)组成的<a class="ae je" href="https://postgrespro.com/docs/postgrespro/10/apjs02.html" rel="noopener ugc nofollow" target="_blank">模式结构</a>，主键和外键关系通常代表一个OLTP数据库。</p><blockquote class="kq kr ks"><p id="00bb" class="if ig jd ih b ii ij ik il im in io ip kt ir is it ku iv iw ix kv iz ja jb jc hb bi translated">cd ~</p><p id="c570" class="if ig jd ih b ii ij ik il im in io ip kt ir is it ku iv iw ix kv iz ja jb jc hb bi translated">mkdir航空公司-数据</p><p id="2183" class="if ig jd ih b ii ij ik il im in io ip kt ir is it ku iv iw ix kv iz ja jb jc hb bi translated">cd航空公司-数据</p><p id="ec08" class="if ig jd ih b ii ij ik il im in io ip kt ir is it ku iv iw ix kv iz ja jb jc hb bi translated">https://edu.postgrespro.com/demo-big-en.zip<a class="ae je" href="https://edu.postgrespro.com/demo-big-en.zip" rel="noopener ugc nofollow" target="_blank">wget</a></p><p id="4e5b" class="if ig jd ih b ii ij ik il im in io ip kt ir is it ku iv iw ix kv iz ja jb jc hb bi translated">解压缩demo-big-en.zip</p></blockquote><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es le"><img src="../Images/8f337de89440fe128ac4313445b70e2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*st1XALIN6kID0e6a"/></div></div></figure><p id="11ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用psql和cloudsql代理将提取的文件作为连接数据库的SQL文件运行:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lf"><img src="../Images/ad43553aa8ae4353202f8405a497415f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*THCi09kfw_6ZekGM"/></div></div></figure><p id="5263" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦SQL脚本完成，就创建了数据库“demo”、模式“bookings”及其表集。让我们验证一下。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lg"><img src="../Images/38b89db2d6b7ed4cd2e8e2acba1d2da5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*osC2pRzJIsIYikJi"/></div></div></figure><p id="e1a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">计算创建的每个表的行数。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es lh"><img src="../Images/0e99cb7f99158617fa4d029feb802831.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/0*XEDWTB9EJTbUXVBT"/></div></figure><p id="bdd4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">2–3在源数据库上配置DMS先决条件</strong></p><p id="205d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">返回到云SQL控制台页面，选择源数据库“pg-db-1 ”,然后选择编辑以更改强制标志，这将为实例启用逻辑复制和解码。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/2e8c60e08c93fa6fdc5b5aeed2628c5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*obyK5Kz3Du42rOu9"/></div></div></figure><p id="3cbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开<em class="jd">逻辑解码</em>和<em class="jd">使能逻辑</em>，如下图编辑页面截图所示。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es li"><img src="../Images/0d092c608948a89d8a8e905a942c740a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qk7s2avFPn-a0kwm"/></div></div></figure><p id="1a9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在所有数据库上启用<em class="jd"> pglogical </em>扩展，以确保不会留下任何要复制的内容，在demo和postgres数据库上启用。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es lj"><img src="../Images/5c514036a4efa7552ff873e305e16c81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/0*7lu10sPGzpc-BaOj"/></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es lk"><img src="../Images/e7ddc54e91f12c62c618442ffc5ad96b.png" data-original-src="https://miro.medium.com/v2/resize:fit:956/0*DDLlbOIESkGU4HkI"/></div></figure><p id="21e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保以下参数至少设置为这些默认值，否则根据DMS <a class="ae je" href="https://cloud.google.com/database-migration/docs/postgres/configure-source-database#cloud-sql-postgresql" rel="noopener ugc nofollow" target="_blank">文档</a>检查适当的值。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es ll"><img src="../Images/ebdf2775d7035e26654295d77fdeab4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:928/0*EWPG2jnRKO5AIqba"/></div></figure><p id="2f85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将复制角色授予DMS任务中的连接用户POSTGRES。请查看上述DMS文档页面，了解更多配置。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es lm"><img src="../Images/1dc25d5b5540eccac714f434d1c0dcde.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/0*xQKvF7prHweCQ24G"/></div></figure><p id="b9df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们回顾一下用户权限:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ln"><img src="../Images/d585209b31fe816210c68afc1d9f3a9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LCy8_bK2AJ7IEwgt"/></div></div></figure><p id="1108" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">重新启动数据库实例。</strong></p><p id="08b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">DMS不支持某些功能，如没有主键的表。您必须使用<a class="ae je" href="https://cloud.google.com/architecture/postgresql-migration-with-database-migration-service#migrating-tables-without-pk" rel="noopener ugc nofollow" target="_blank">文档</a>中规定的代理键来减轻这种情况。查看此处列出的<a class="ae je" href="https://cloud.google.com/architecture/postgresql-migration-with-database-migration-service#prep-the-db-migration" rel="noopener ugc nofollow" target="_blank">中是否有任何更复杂的问题，请在继续之前解决。</a></p><p id="b362" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3 —创建DMS复制任务并启动复制</strong></p><p id="df07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本节中，我们将创建DMS实例来启动复制:</p><p id="599b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3.1 —创建DMS连接配置文件</strong></p><p id="6a4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了创建DMS复制任务，必须具有源数据库配置。进入<a class="ae je" href="https://console.cloud.google.com/dbmigration/migration" rel="noopener ugc nofollow" target="_blank"> DMS云控制台</a>页面，在左侧面板选择“连接配置文件”。选择顶部的<strong class="ih hj">创建配置文件</strong>，然后从下拉列表中选择“云SQL for PostgreSQL ”,因为我们的源数据库是我们在上一节中创建的:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lo"><img src="../Images/3c6d698e29aa33eadbda457d8f46057b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*q2v0Gfk9GLJDPXbU"/></div></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lp"><img src="../Images/bdd991525df77e8265edc884f8aebab5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*w31N8I9vnxMwjAP5"/></div></div></figure><p id="da46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，提供与源数据库相关的所有配置。在我们的例子中，它显示在下面的屏幕截图中，并选择创建一个源数据库连接配置文件，它可以在一个或多个DMS迁移任务中使用。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lq"><img src="../Images/6552b86306c4b1b19e29d3603bf5d9df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*32cHFDoYIhoWrY7Q"/></div></div></figure><p id="fe19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3.2 —创建DMS作业并启动复制</strong></p><p id="e31d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本节中，我们将使用源数据库连接配置文件创建一个DMS复制作业，并启动数据库复制。此步骤非常全面，因为它验证了建立复制所需的数据库和网络配置。</p><p id="8d5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到DMS控制台页面，从左侧面板中选择“迁移作业”,然后单击“创建迁移作业”</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lr"><img src="../Images/c4d3e87e88030768f432d3e0ded7bbef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CdBALAg-KDdI--1A"/></div></div></figure><p id="d12d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在“入门”步骤中—指定唯一的作业名称，并选择在上一节中创建的源数据库配置文件。确保您选择了正确的地区，因为在我们的案例中，该地区是“Mumbai”和“Continuous”作为迁移工作类型。这将启用源数据库和目标数据库之间的<strong class="ih hj">变更数据捕获</strong>，直到作业被标记为完成。连续(有时也称为持续或在线)迁移是从源到目标的连续变更流，从最初的完全转储和加载开始。底部是一个先决条件，这是一个由“开放”链接组成的自愿部分。此链接指导您检查配置复制的所有先决条件。一旦满足了源数据库和连接的所有要求，就可以前进到下一步。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ls"><img src="../Images/a7e8dc25488ba67cb8cbcb7de65afdd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Vjzs1Kz5UCCULLoK"/></div></div></figure><p id="8ea7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在下一步“定义源”中，选择在上一节中创建的连接配置文件，并前进到“创建目的地”。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lt"><img src="../Images/1b990f1ce934815cc872eca3b9137283.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*woLsLoMyV1bTQfGi"/></div></div></figure><p id="7ee9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在“创建目标”步骤中，请确保指定要升级的目标PG版本以及其他配置，如凭据和实例名。一旦您继续前进，DMS将尝试创建数据库实例。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lu"><img src="../Images/ab5d979c2b8b357feb98809f451a8c2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vf_YT2zPQmwuylVx"/></div></div></figure><p id="a603" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在云SQL控制台页面上检查新数据库实例的创建进度:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/865a348e133d5f49ad9e623239ac9e0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jTDiTw1oX2_JlC2X"/></div></div></figure><p id="f44b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在DMS作业控制台页面和“定义连接方法”步骤中，指定连接方法，如下图所示，因为我们在数据库和应用程序主机之间使用专用IP。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lv"><img src="../Images/72eda402019146bff2240f693e9baa55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UwswcxrvrB0MM-3h"/></div></div></figure><p id="a62c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建新的/目标数据库实例后，您可以继续下一步，通过“测试迁移”步骤验证所有配置。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lw"><img src="../Images/9d337b24a8af745ff202a8f2685ee755.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MCCN3RYKu4uHUpFQ"/></div></div></figure><p id="a3a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果上述步骤不成功，则完成DMS <a class="ae je" href="https://cloud.google.com/database-migration/docs/postgres/configure-source-database#cloud-sql-postgresql" rel="noopener ugc nofollow" target="_blank">文档</a>中规定的先决条件配置。</p><p id="cbbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，使用“创建和启动作业”来立即启动迁移，因为在我们的情况下，此时我们没有任何理由等待，但是在您的情况下，如果您有任何理由等待，那么可以随意使用“创建作业”,您可以稍后在准备就绪时启动DMS作业。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lx"><img src="../Images/7b20dc387392e866f47ad90b16f65958.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*098aC2vfa4xOBV36"/></div></div></figure><p id="12fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">DMS作业启动后，对其进行监控，直到其状态从“正在启动”经过“正在进行完全转储”变为“正在进行CDC”。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/ab880472f591825cb5e8f0d28f4be8aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*R9Pwhj48V0ywbd2X"/></div></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/a294bafd92b3a9d6eccb799fd94f3f60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OCbotQI33WbLkpVU"/></div></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/432e26e7b705875a0d9f0af0188256f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6zdeOeQmtipmG8vD"/></div></div></figure><p id="44ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">持续监视DMS和DB operations选项卡，查看是否存在任何瓶颈。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/12ad5c8058d28189bbd2f3df3317b31d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FrrFGvdeAKr-qz15"/></div></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/e29c3a28e4d3877e1d73cc5c7f3461fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0t-BKQmgZTb_fvtu"/></div></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/d206d8752434c398bb801367a48d0d4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fsuQPOL9sURwBX16"/></div></div></figure><p id="6421" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">一旦迁移作业状态达到“CDC进行中”，您就可以验证复制并切换到目标数据库，但是，只要您愿意，您可以继续在CDC状态下运行，只要您还没有准备好切换数据库。</strong>让我们验证是否所有行都从源复制到了目标。</p><p id="1b46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3.3验证DMS复制</strong></p><p id="d227" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">找出目标数据库私有IP，使用psql连接，并更改提示名称以简化验证。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ly"><img src="../Images/61a5db5df0ad084827390fd8df5f7291.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jJlVYJST7mDA4dse"/></div></div></figure><p id="723c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证数据库和模式创建</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ly"><img src="../Images/bcab4c0d01c830c13dd9ff7c6b8ba4be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eWs04gc3hgUtF6Ii"/></div></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lz"><img src="../Images/1666d5884ff0cfcc5c4d7e717c17ffbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*D62tQIka3id-lAAv"/></div></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ma"><img src="../Images/dce4b515cb7aa705712ff78d44430ae6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/0*pHO5PxngBYic4LH5"/></div></div></figure><p id="7fce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，获取目标中的行数。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es mb"><img src="../Images/338238352732bd2d4dcfcd7d63f23e59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/0*0n6EByUC1HABt1mL"/></div></figure><p id="dc30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">连接到源数据库并更改提示名称以简化验证:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es mc"><img src="../Images/1f568bc765cd3ece68fa57201436283b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OY3r_Qqqwywz_MDO"/></div></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es md"><img src="../Images/52c9a53c6efcf152ffaafdf618b748c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DxkwtVuuIRTvr4XA"/></div></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es me"><img src="../Images/8437a25dd3325d381ff7030f4c83c999.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DtMwR2HfGwMN05LG"/></div></div></figure><p id="dd29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获取并验证源数据库和目标数据库中的行数。一切都好！！</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es mf"><img src="../Images/57f5e8e4c3790e4f43698207693000b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1094/0*50kuLtg_xeBpAbcx"/></div></figure><p id="342d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们通过在一个源表中插入一行来验证CDC(变更数据捕获),并再次将行数与目标表进行匹配。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es mg"><img src="../Images/2dd9ea19c4e1f7bcd83efe3761e8fec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mL0FBQmifYP3MmKx"/></div></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es mh"><img src="../Images/1ab7ad519ba19e3250d03dad8d9efa55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/0*dmrSkI03T4_5Vdw8"/></div></figure><p id="39ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以看到，在插入一行后，总行数保持预期，因此CDC工作正常，我们可以切换到目标数据库。</p><p id="2434" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3.4切换到目标数据库并测量应用程序层的停机时间。</strong></p><p id="1f51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们在执行切换时测量应用程序层的停机时间。注意停机开始时间如下:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es mi"><img src="../Images/a6faf7bcf54e827da6bc5f3d2bdfb445.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/0*1aKCNc37kBCvrujG"/></div></figure><p id="6c15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在开始之前，请检查不应该有任何CDC延迟，这可以作为我们DMS作业的操作指标之一进行检查。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es mj"><img src="../Images/afa869e2383101ce7498e770235ea8e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*m405mQTfqYuVa2UK"/></div></div></figure><p id="2aca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们使用云SQL代理模拟应用程序层时，我们将关闭它，以便不再有从应用程序到数据库的连接，如下所示。由于它作为后台进程运行，我们将终止仍在连接旧/源数据库的云SQL代理</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es mk"><img src="../Images/eb863984a99831dbf7dd1af24b65aa5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MzYxV6azxdSD93Uj"/></div></div></figure><p id="b05f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将停止复制，并将目标数据库提升为独立数据库，脱离DMS复制。转到DMS控制台页面，使用PROMOTE选项正常停止CDC并升级目标数据库。DMS的状态将发生如下变化</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/afcc13ad998f51a06f5fa9484667d773.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Eu8eb4PAYi6P_eWV"/></div></div></figure><p id="3646" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">等到低于“已完成…”的状态。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/42ce806da46b6ab78e4949fb602b9b6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nwtOwfdlYZ4hGXQF"/></div></div></figure><p id="e2e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您检查云SQL控制台页面，您将看到目标数据库是独立的。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ml"><img src="../Images/71174635f94e30e427c88bba90abdabd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kfh3PAEt_RvH4Q3W"/></div></div></figure><p id="d411" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在打开云SQL代理，开始接收到目标数据库的连接。为此，在“从云SQL控制台检查目标数据库的连接名称”页面上，单击“pg-db-13 ”,在“概述”选项卡上，记下连接名称:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es mm"><img src="../Images/ca6d6f0abf5bed7905e711f39f1b1f04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AOh3c6YNH59Tkqk8"/></div></div></figure><p id="d997" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用相同的连接启动云SQL代理，如下图所示。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es mn"><img src="../Images/89547ce42984002704061c2b59ff56d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XB0ugWYE3gIiaLn5"/></div></div></figure><p id="4603" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用云SQL代理，连接到目标数据库并验证新的升级版本和表数据集。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es mo"><img src="../Images/fae36d32a02c0ea7afe64bb0bf8f38c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S1IhtkD0gicOXX_U"/></div></div></figure><p id="acee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，您可以宣布停机时间结束，我们将再次记录时间。这表明停机时间不到10分钟。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es mp"><img src="../Images/6788e0c68fecbd028d1aba4aef93ca63.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/0*1WtqdvDvH5Z7I87K"/></div></figure><p id="3a7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是开始时间</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es mi"><img src="../Images/6a1bc8c975cabd9a988d2170e7333fdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/0*pt0PAjlGUcnTL-q8"/></div></figure><p id="5261" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您仍然可以通过自动化步骤而不是手动操作来进一步减少停机时间，因为在操作日志中观察到目标数据库升级不到1分钟。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es mq"><img src="../Images/78be5f17653d4e1d39922e97b820b0d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6kdntdNb-RknMqBU"/></div></div></figure><p id="912c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保旧的不可用，最好是锁定用户并关闭它。</p><p id="2f09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">成本考虑</strong></p><p id="3860" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据库迁移服务在<a class="ae je" href="https://cloud.google.com/database-migration/pricing" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">提供，无需额外费用</strong> </a>用于向云SQL的本地迁移。只要您承担现有数据库的成本，就不会产生任何成本，除非您计划将数据库移出当前地区、区域或VPC子网，否则可能不会产生任何费用。从外部源数据库进入网络不收取额外费用。然而，谷歌之外也会产生费用，如平台出口费。</p><p id="851c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">最佳实践、常见陷阱和其他参考:</strong></p><p id="c66c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请回顾DMS的<a class="ae je" href="https://cloud.google.com/database-migration/docs/postgres/migration-src-and-dest" rel="noopener ugc nofollow" target="_blank">限制</a>并找出更多的复杂性。然而，存在如下几个已知问题:</p><ol class=""><li id="f931" class="jf jg hi ih b ii ij im in iq jh iu ji iy jj jc jk jl jm jn bi translated">查看并匹配您的源数据库配置，了解如何为DMS复制准备源数据库<a class="ae je" href="https://cloud.google.com/blog/topics/developers-practitioners/preparing-postgresql-migration-database-migration-service" rel="noopener ugc nofollow" target="_blank">此处为</a>。</li><li id="c020" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">源和目的地之间的DDL变化需要特别注意，请参考此处的<a class="ae je" href="https://cloud.google.com/architecture/postgresql-migration-with-database-migration-service#manage_schema_changes" rel="noopener ugc nofollow" target="_blank"/>。</li><li id="8591" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">如果源数据库有一个复杂的场景，如没有主键的表、实体化视图、大型对象，那么请参考此处的<a class="ae je" href="https://cloud.google.com/architecture/postgresql-migration-with-database-migration-service#prep-the-db-migration" rel="noopener ugc nofollow" target="_blank"/>。</li><li id="a4a6" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">创建DMS作业时，确保目标实例必须具备所有必需的配置，如存储、CPU和网络配置。</li><li id="00a4" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">由于这篇博文的网络范围仅限于私有网络，所以请继续参考<a class="ae je" href="https://cloud.google.com/blog/topics/developers-practitioners/database-migration-service-connectivity-technical-introspective" rel="noopener ugc nofollow" target="_blank">这篇</a>关于DMS配置的复杂网络场景。</li><li id="6071" class="jf jg hi ih b ii jo im jp iq jq iu jr iy js jc jk jl jm jn bi translated">由于这篇博文是同构数据库迁移的超集用例，请回顾它的<a class="ae je" href="https://cloud.google.com/blog/products/databases/tips-for-migrating-across-compatible-database-engines" rel="noopener ugc nofollow" target="_blank">最佳实践</a>。</li></ol><p id="b5d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">行动号召</strong></p><p id="7211" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是复制有助于减少数据库升级停机时间的另一个使用案例。在这篇博文中，我们观察到使用DMS时停机时间减少到不到10分钟，而且<strong class="ih hj">仍有通过协调和自动化所有可能的步骤来减少停机时间</strong>的潜力。我鼓励你尝试这种策略，因为<strong class="ih hj"> DMS可以免费使用</strong>，如果适用，你只需承担数据库和数据输入或输出费用。</p><p id="c57f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">特别感谢我的队友sour abh Gupta<a class="ae je" href="https://www.linkedin.com/in/saurabh-gupta-b1309926/" rel="noopener ugc nofollow" target="_blank">评论了这篇博客。</a></p><p id="553d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">喜欢听到你的反馈，干杯！！</p></div></div>    
</body>
</html>