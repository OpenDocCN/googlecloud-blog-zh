<html>
<head>
<title>IP address management strategy — a crucial aspect of running GKE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">IP地址管理策略——运行GKE的一个重要方面</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/ip-address-management-strategy-a-crucial-aspect-of-running-gke-f063fe90cfbd?source=collection_archive---------0-----------------------#2022-07-12">https://medium.com/google-cloud/ip-address-management-strategy-a-crucial-aspect-of-running-gke-f063fe90cfbd?source=collection_archive---------0-----------------------#2022-07-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a1905ccc5478e588b3d17ae6fe0623e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3_ToZN6P_f4JdW_osdflmA.jpeg"/></div></div></figure><p id="ce4e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">您的组织是否在为每个应用程序/环境构建新的GKE实例？</em> <br/> <em class="jo">您的应用团队是否要求您为pod提供/18或/16或/14子网CIDRs？</em><br/><em class="jo">pod与您的内部应用程序通信吗？</em></p><p id="59f2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">那么你很快就会遇到IP枯竭的问题。不这么认为？让我告诉你怎么做！</strong></p><p id="dfd8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">任何Kubernetes网络模型都严重依赖IP地址。<br/>服务、pod、容器和节点使用IP地址和端口进行通信。</p><p id="f739" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您在VPC中启动GKE集群时，需要以下子网:</p><ul class=""><li id="33f0" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">您的工作节点的主要子网范围</li><li id="364d" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">pod和服务的二级范围(<a class="ae kd" href="https://cloud.google.com/vpc/docs/alias-ip" rel="noopener ugc nofollow" target="_blank">别名IP </a>范围)</li><li id="35dc" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">控制平面CIDR范围—用于私有集群中的主控制平面节点IP地址</li></ul><p id="8db8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们举个例子来更好地理解这一点:</p><h2 id="10f7" class="ke kf hi bd kg kh ki kj kk kl km kn ko jb kp kq kr jf ks kt ku jj kv kw kx ky bi translated"><strong class="ak">应用要求:</strong></h2><ul class=""><li id="953b" class="jp jq hi is b it kz ix la jb lb jf lc jj ld jn ju jv jw jx bi translated">微服务数量:50</li><li id="152a" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">每个微服务需要0.5个CPU、1GB内存和最少3到最多10个pod</li></ul><h2 id="9b4b" class="ke kf hi bd kg kh ki kj kk kl km kn ko jb kp kq kr jf ks kt ku jj kv kw kx ky bi translated"><strong class="ak">我们如何确定GKE集群的规模？</strong></h2><p id="0b4e" class="pw-post-body-paragraph iq ir hi is b it kz iv iw ix la iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">我们将继续使用<em class="jo">区域标准GKE集群</em>，因为它提供了高可用性和分区故障保护。为什么区域集群更好？在这里阅读更多<a class="ae kd" href="https://cloud.google.com/kubernetes-engine/docs/concepts/regional-clusters" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="f093" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们希望部署的地区是“亚洲-东南亚1”</p><p id="6ee4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">所需资源总额:</strong></p><ul class=""><li id="4f9d" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">最小CPU:0.5 x 50 x 3 = 75；最小内存:1 x 50 x 3 = 150 GB</li><li id="4e22" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">最大CPU:0.5 x 50 x 10 = 250；最大内存:1 x 50 x 10 = 500 GB</li></ul><p id="5cb6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最小集群大小将为:</p><ul class=""><li id="4e05" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">每个节点大小:8个vCPU 16 GB RAM</li><li id="5a8a" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">节点数量:12</li><li id="a48e" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">节点类型:N2</li></ul><p id="8ec8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将启用节点自动配置(NAP)来优化随着负载增加的节点自动扩展(有关NAP的更多详细信息，请参考<a class="ae kd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-provisioning" rel="noopener ugc nofollow" target="_blank">文档</a>):</p><p id="acdf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">大约。最大群集大小可能是:</p><ul class=""><li id="0730" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">每个节点大小:6个vCPU 12 GB RAM</li><li id="d1f6" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">节点数量:24</li><li id="3d19" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">节点类型:N2</li></ul><p id="638a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，GKE集群所需的子网如下:</p><ul class=""><li id="d309" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">工作节点的主要子网范围:<rfc ip="" address="" range=""> /24</rfc></li><li id="7b09" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">Pod的二级范围(别名IP范围):<rfc ip="" address="" range=""> /18</rfc></li><li id="2f6d" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">服务的二级范围(别名IP范围):<rfc ip="" address="" range=""> /20</rfc></li><li id="f820" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">控制飞机CIDR范围- <rfc ip="" address="" range=""> /28</rfc></li></ul><p id="8c5b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">(很快会写一篇详细的博客解释为什么选择上面的IP子网)</em></p><h2 id="a648" class="ke kf hi bd kg kh ki kj kk kl km kn ko jb kp kq kr jf ks kt ku jj kv kw kx ky bi translated">问题是:</h2><p id="ab9b" class="pw-post-body-paragraph iq ir hi is b it kz iv iw ix la iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">在Google Cloud中，别名IP范围是可路由的，也就是说，您可以从VPC内部使用集群中的IP直接呼叫pod分配给作为集群IP类型服务公开的k8服务的IP地址仍然只能在集群内部路由]。因此，如果pod必须与内部网络通信，IP地址可能会重叠。<br/>因此，网络团队需要在分配前规划CIDR，并且需要了解整个组织中已使用/未使用的CIDR块。</p><p id="71dd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是问题所在，从您的数据中心保留每个集群所需的/14 /16 /18 CIDR范围并不是最佳选择。</p><h2 id="11fd" class="ke kf hi bd kg kh ki kj kk kl km kn ko jb kp kq kr jf ks kt ku jj kv kw kx ky bi translated"><strong class="ak">解决方案:</strong></h2><p id="f1b8" class="pw-post-body-paragraph iq ir hi is b it kz iv iw ix la iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">为了解决超出IP范围的问题，我们建议如下:</p><p id="5a15" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> RFC对非RFC </strong>:</p><ul class=""><li id="a10d" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">从<strong class="is hj"> RFC 1918范围</strong>中为工作节点和控制平面CIDR范围选择您的主要子网范围</li><li id="d2bc" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">从<a class="ae kd" href="https://cloud.google.com/vpc/docs/vpc#valid-ranges" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">非RFC 1918范围</strong> </a>中为pod和服务选择辅助子网范围</li></ul><p id="4051" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于这两个范围(RFC和非RFC)仍然会被云路由器暴露给您的内部数据中心，因此我们使用<a class="ae kd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/ip-masquerade-agent" rel="noopener ugc nofollow" target="_blank"> <em class="jo"> IP伪装代理</em> </a> <em class="jo"> </em>到<a class="ae kd" href="https://en.wikipedia.org/wiki/Network_address_translation#SNAT" rel="noopener ugc nofollow" target="_blank"><em class="jo">SNAT</em></a><em class="jo">pod IP范围和节点IP。</em>这将有助于将从Pods (SNAT)发送的出站数据包的源IP地址更改为节点IP地址。</p><p id="a5b5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">要在您的GKE集群中启用此功能，请执行以下步骤:</strong></p><blockquote class="lh li lj"><p id="7612" class="iq ir jo is b it iu iv iw ix iy iz ja lk jc jd je ll jg jh ji lm jk jl jm jn hb bi translated">检查ip-masq代理是否已经安装在集群中:</p></blockquote><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="3f6e" class="ke kf hi ls b fi lw lx l ly lz">kubectl get daemonsets/ip-masq-agent -n kube-system</span></pre><p id="b05c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果ip-masq-agent DaemonSet存在，则输出类似于以下内容:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="5c50" class="ke kf hi ls b fi lw lx l ly lz">NAME    DESIRED CURRENT READY UP-TO-DATE AVAILABLE NODE SELECTOR AGE</span><span id="8232" class="ke kf hi ls b fi ma lx l ly lz">ip-masq-agent 3  3    3       3          3         &lt;none&gt;    13d</span></pre><p id="ef4e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果ip-masq-agent DaemonSet不存在，则输出如下所示:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="293c" class="ke kf hi ls b fi lw lx l ly lz">Error from server (NotFound): daemonsets.apps “ip-masq-agent” not found</span></pre><blockquote class="lh li lj"><p id="28fb" class="iq ir jo is b it iu iv iw ix iy iz ja lk jc jd je ll jg jh ji lm jk jl jm jn hb bi translated">使用以下内容创建一个文件ipmasq-cm.yaml:</p></blockquote><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="22b1" class="ke kf hi ls b fi lw lx l ly lz">apiVersion: v1<br/>data:<br/>  config: |<br/>    nonMasqueradeCIDRs:<br/>      - CIDR_1<br/>      - CIDR_2<br/>    masqLinkLocal: false<br/>    resyncInterval: SYNC_INTERVAL<br/>kind: ConfigMap<br/>metadata:<br/>  name: ip-masq-agent<br/>  namespace: kube-system</span></pre><p id="388d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">CIDR_1和CIDR_2是你不希望SNAT发生的目的地的CIDR。对于每个其他目的地，pod IP将在出口处被替换为节点IP作为源。</p><p id="fe69" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">SYNC_INTERVAL间隔时间，在此时间之后，pod将与配置同步。</p><blockquote class="lh li lj"><p id="7845" class="iq ir jo is b it iu iv iw ix iy iz ja lk jc jd je ll jg jh ji lm jk jl jm jn hb bi translated">在集群中部署文件</p></blockquote><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="07d6" class="ke kf hi ls b fi lw lx l ly lz">kubectl create configmap ipmasq-cm --namespace=kube-system --from-file=config=ipmasq-cm.yaml</span></pre><blockquote class="lh li lj"><p id="30ef" class="iq ir jo is b it iu iv iw ix iy iz ja lk jc jd je ll jg jh ji lm jk jl jm jn hb bi translated">创建一个ipmasq-agent daemon set“ipmasq-agent . YAML”并在集群中部署:</p></blockquote><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="5dd9" class="ke kf hi ls b fi lw lx l ly lz">apiVersion: apps/v1<br/>kind: DaemonSet<br/>metadata:<br/>  name: ip-masq-agent<br/>  namespace: kube-system<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      k8s-app: ip-masq-agent<br/>  template:<br/>    metadata:<br/>      labels:<br/>        k8s-app: ip-masq-agent<br/>    spec:<br/>      hostNetwork: true<br/>      containers:<br/>      - name: ip-masq-agent<br/>        image: k8s.gcr.io/networking/ip-masq-agent:v2.7.0<br/>        args:<br/>            # The masq-chain must be IP-MASQ<br/>            - --masq-chain=IP-MASQ<br/>            # To non-masquerade reserved IP ranges by default,<br/>            # uncomment the following line.<br/>            # - --nomasq-all-reserved-ranges<br/>        securityContext:<br/>          privileged: true<br/>        volumeMounts:<br/>          - name: config-volume<br/>            mountPath: /etc/config<br/>      volumes:<br/>        - name: config-volume<br/>          configMap:<br/>            name: ip-masq-agent<br/>            optional: true<br/>            items:<br/>              - key: config<br/>                path: ip-masq-agent<br/>      tolerations:<br/>      - effect: NoSchedule<br/>        operator: Exists<br/>      - effect: NoExecute<br/>        operator: Exists<br/>      - key: "CriticalAddonsOnly"<br/>        operator: "Exists"</span></pre><p id="0520" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有关配置IP伪装代理的更多信息，请参考GKE <a class="ae kd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/ip-masquerade-agent" rel="noopener ugc nofollow" target="_blank">公共文档</a>。</p><h2 id="d636" class="ke kf hi bd kg kh ki kj kk kl km kn ko jb kp kq kr jf ks kt ku jj kv kw kx ky bi translated">要记住的事情:</h2><ol class=""><li id="db97" class="jp jq hi is b it kz ix la jb lb jf lc jj ld jn mb jv jw jx bi translated">Windows服务器节点池不支持此功能</li><li id="7286" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn mb jv jw jx bi translated">不适用于规格为<strong class="is hj">的容器中的容器。主机网络:真</strong></li><li id="68f7" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn mb jv jw jx bi translated">群集的Pod IP地址范围不应匹配，或者不在10.0.0.0/8范围内</li><li id="5bf5" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn mb jv jw jx bi translated">对于自动驾驶集群，需要部署出口NAT策略。</li></ol><p id="ad1e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">阅读更多关于在GKE选择替代网络模型的<a class="ae kd" href="https://cloud.google.com/architecture/gke-ip-address-mgmt-strategies" rel="noopener ugc nofollow" target="_blank"> GKE IP管理策略</a>的信息，或者随时联系我！</p><p id="53f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请关注<a class="ae kd" href="https://medium.com/google-cloud" rel="noopener">谷歌云社区</a>，了解更多此类有见地的博客。黑客快乐！</p></div></div>    
</body>
</html>