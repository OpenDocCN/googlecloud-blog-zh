<html>
<head>
<title>Dynamically Handle SCD2 Merges in BigQuery using Composer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Composer动态处理BigQuery中的SCD2合并</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/dynamically-handle-scd2-merges-in-bigquery-with-composer-f6860e4ba99b?source=collection_archive---------0-----------------------#2022-11-11">https://medium.com/google-cloud/dynamically-handle-scd2-merges-in-bigquery-with-composer-f6860e4ba99b?source=collection_archive---------0-----------------------#2022-11-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="854b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博文中，您可以了解如何使用Composer和Airflow创建参数化/动态管道来自动处理BigQuery中任何表的SCD2更新。</p><p id="1413" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">渐变维度(SCD)类型2是数据仓库中处理维度表中的变化的常用技术。</p><p id="ef74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您正在从遗留数据库迁移数据集市，您可能会注意到，在BigQuery中，逐行处理SCD2的旧方法并不是一种有效的方法。</p><blockquote class="jd je jf"><p id="11b1" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">游标也不是在遗留数据库中处理SCD2的最佳方式。</p></blockquote><p id="b40b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图显示了SCD2行的外观；</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/d10058b8eeb4886b8130c854f2a55bad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E3b1tNxg5-uFbfR_FM133Q.png"/></div></div></figure><blockquote class="jd je jf"><p id="ab49" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">如何有效地管理BigQuery中的数据变更？</p><p id="cd30" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">分批思考！</p></blockquote></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><p id="2d1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Merge语句是处理BigQuery中SCD2更改的一种很好的方式，这样您可以一次处理许多记录，提高性能并降低成本。</p><p id="230b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">典型的SCD2 merge语句如下所示:</p><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="1eff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个语句中发生了什么？</p><p id="c7fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1-用current_date作为结束日期更新旧的/已更改的记录。(第11行)</p><p id="7cf5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2-生成并插入具有任意延迟结束日期的新记录(“9999–12–31 23:59:59”)。(第5、13、14行)</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><p id="1adc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个merge语句可以用作合并任何表的通用模式。它需要临时和目标维度表、键列和其他列作为变量。因此您可以<strong class="ih hj"> <em class="jg">创建一个动态管道来处理不同维度表</em> </strong>的SCD2合并。</p><p id="aa97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇博文的其余部分将向你展示；<strong class="ih hj">如何使用composer和airflow构建动态DAG来处理SCD2合并</strong>。</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><p id="760d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是动态DAG的截图，将在本帖中详细解释；</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kf"><img src="../Images/cada005fa892e836c033ad2b277798aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3SMRyQM0kJ7YaPCXlW22Cg.png"/></div></div></figure><p id="7e1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个动态DAG有一个分支操作符，可以基于输入变量进行初始加载或SCD2合并。请阅读我之前的博客文章，了解更多关于分支任务和有条件初始或增量加载表的信息。</p><p id="59bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">首先</strong>您需要为策展表进行特殊的初始加载，为SCD2表设置end_dates。我们需要一个BigQueryOperator，它从staging表中选择所有列，并添加end_date作为任意的大日期。下面是能做到这一点的任务；</p><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="7158" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">其次</strong>您需要创建一个merge语句，该语句可以将table_name、schema和key字段作为输入。那么您需要一个python操作符来调用这个函数。merge语句需要作为xcom变量发布，以便BigQueryOperator可以在后面的任务中使用它。下面是创建merge语句的python函数和python运算符；</p><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="6953" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后使用BigQueryOperator运行merge语句；</p><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="15a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些都是使用Composer动态处理SCD2管道的关键组件。请注意，在GCP还有其他平台和工具，如Dataform或Datafusion，可以实现同样的功能。我希望在接下来的博客文章中涵盖这些内容。</p><p id="f59e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请在评论中让我知道你的想法。</p><p id="1a8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在下面找到完整的DAG和参数:</p><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="1ec8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是调用此DAG进行初始加载或将SCD2合并到维度表的参数；</p><pre class="jl jm jn jo fd kh ki kj bn kk kl bi"><span id="59eb" class="km kn hi ki b be ko kp l kq kr">INITAL:<br/>{<br/>    "TargetTable":"table_name",<br/>    "SourceCSV":"table_name.csv",<br/>    "P_MODE":"INITIAL",<br/>    "TableSchema" : {<br/>            "KEY1":"INTEGER",<br/>            "KEY2":"STRING",<br/>            "COL1":"STRING",<br/>            "COL2":"STRING"<br/>        },<br/>    "TableKeys":["KEY1","KEY2"]<br/>}<br/>DELTA:<br/>{<br/>    "TargetTable":"tablename",<br/>    "SourceCSV":"source.csv",<br/>    "P_MODE":"DELTA",<br/>    "P_DATE_FIELD":"30NOV2021",<br/>    "TableSchema" : {<br/>            "KEY1":"INTEGER",<br/>            "KEY2":"STRING",<br/>            "COL1":"STRING",<br/>            "COL2":"STRING"<br/>        },<br/>    "TableKeys":["KEY1","KEY2"]<br/>}</span></pre><p id="29b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能会注意到，有一个加载特定日期的额外功能。如果只是需要合并某一天的更改，您可以将P_DATE_FIELD设置为该天。</p></div></div>    
</body>
</html>