<html>
<head>
<title>Authenticating to GKE without gcloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无需gcloud即可向GKE认证</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/authenticating-to-gke-without-gcloud-aefd23a840a9?source=collection_archive---------0-----------------------#2019-07-09">https://medium.com/google-cloud/authenticating-to-gke-without-gcloud-aefd23a840a9?source=collection_archive---------0-----------------------#2019-07-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="db50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您正在使用<a class="ae jd" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank"> Google Kubernetes Engine </a>并从CI/CD之类的无头环境中部署到它，那么您可能正在安装<code class="du je jf jg jh b">gcloud</code>命令行工具(可能每次运行构建时)。有一种方法可以在不使用 <code class="du je jf jg jh b"><strong class="ih hj">gcloud</strong></code>命令行工具的情况下认证到GKE集群<strong class="ih hj">！</strong></p><p id="bb7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">解决方案是使用我们提前制作的静态<code class="du je jf jg jh b"><a class="ae jd" href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/" rel="noopener ugc nofollow" target="_blank">kubeconfig</a></code>文件。为此，您仍然需要:</p><ol class=""><li id="2dd1" class="ji jj hi ih b ii ij im in iq jk iu jl iy jm jc jn jo jp jq bi translated">CLI(仅在开发机器上)</li><li id="2099" class="ji jj hi ih b ii jr im js iq jt iu ju iy jv jc jn jo jp jq bi translated">用于验证您身份的Google凭据(又称服务帐户密钥)。</li></ol><h1 id="5319" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">创建静态kubeconfig文件</h1><p id="9ba7" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">在bash终端的变量中设置集群名称和区域:</p><pre class="kz la lb lc fd ld jh le lf aw lg bi"><span id="6e74" class="lh jx hi jh b fi li lj l lk ll">GET_CMD="gcloud container clusters describe [CLUSTER] --zone=[ZONE]"</span></pre><p id="152d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在bash中运行以下命令块将通过检索创建一个<code class="du je jf jg jh b">kubeconfig.yaml</code>文件:</p><pre class="kz la lb lc fd ld jh le lf aw lg bi"><span id="d652" class="lh jx hi jh b fi li lj l lk ll">cat &gt; kubeconfig.yaml &lt;&lt;EOF<br/>apiVersion: v1<br/>kind: Config<br/>current-context: my-cluster<br/>contexts: [{name: my-cluster, context: {cluster: cluster-1, user: user-1}}]<br/>users: [{name: user-1, user: {auth-provider: {name: gcp}}}]<br/>clusters:<br/>- name: cluster-1<br/>  cluster:<br/>    server: "https://$(eval "$GET_CMD --format='value(endpoint)'")"<br/>    certificate-authority-data: "$(eval "$GET_CMD --format='value(masterAuth.clusterCaCertificate)'")"<br/>EOF</span></pre><p id="4060" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个<code class="du je jf jg jh b">kubeconfig.yaml</code>文件不包含诸如您的凭证之类的秘密。它只将kubectl指向您的集群。实际上，您可以放心地选择将该文件存储在git存储库中。</p><p id="1a0f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，您实际上可以通过<a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/credential-rotation" rel="noopener ugc nofollow" target="_blank">触发手动轮换</a>来轮换这个主IP地址<em class="lm">和</em> CA证书。如果这样做，您需要重新生成该文件。(这是这种方法的唯一缺点。)</p><h1 id="d831" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">为无头身份验证创建服务帐户</h1><ol class=""><li id="5d23" class="ji jj hi ih b ii ku im kv iq ln iu lo iy lp jc jn jo jp jq bi translated">您将需要<a class="ae jd" href="https://cloud.google.com/iam/docs/creating-managing-service-accounts" rel="noopener ugc nofollow" target="_blank">创建一个服务帐户</a>，以便从headless环境向GKE进行身份验证。</li><li id="af94" class="ji jj hi ih b ii jr im js iq jt iu ju iy jv jc jn jo jp jq bi translated">为该服务帐户提供您需要的。(例如，“Kubernetes引擎开发人员”角色将允许您将工作负载部署到集群。)</li><li id="bc25" class="ji jj hi ih b ii jr im js iq jt iu ju iy jv jc jn jo jp jq bi translated">然后，创建一个<a class="ae jd" href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys" rel="noopener ugc nofollow" target="_blank">密钥文件</a>(。json)(该文件是一个<strong class="ih hj">机密</strong>，不要将其签入到您的存储库中)。</li></ol><h1 id="bd94" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">使用kubeconfig文件</h1><p id="e0a1" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">现在，您可以转到没有 <code class="du je jf jg jh b"><strong class="ih hj">gcloud</strong></code>的环境<strong class="ih hj">，获取这个kubeconfig文件并将其与您的服务帐户密钥文件结合，通过设置以下环境变量从headless环境向您的GKE集群进行身份验证:</strong></p><pre class="kz la lb lc fd ld jh le lf aw lg bi"><span id="7c7f" class="lh jx hi jh b fi li lj l lk ll">export GOOGLE_APPLICATION_CREDENTIALS=service-account-key.json<br/>export KUBECONFIG =kubeconfig.yaml</span><span id="129f" class="lh jx hi jh b fi lq lj l lk ll">kubectl get nodes # You are authenticated if this works!</span></pre><p id="791f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将<code class="du je jf jg jh b">GOOGLE_APPLICATION_CREDENTIALS</code>设置为kubectl可以很好地工作，因为kubectl中的<code class="du je jf jg jh b">gcp</code> auth插件使用标准的Google Cloud Go客户端库来识别这个环境变量。</p><p id="b957" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这个小技巧可以加速您的构建环境，而不必维护安装和配置<code class="du je jf jg jh b">gcloud</code> CLI的步骤。</p><p id="7a78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这不是在没有<code class="du je jf jg jh b">gcloud</code>的情况下向GKE集群进行身份验证的唯一方式。您也可以使用<a class="ae jd" href="https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/" rel="noopener ugc nofollow" target="_blank"> Kubernetes服务账户</a>进行认证，也许我们可以在另一篇文章中探讨这个问题。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="1cea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lm">原载于2019年7月9日</em><a class="ae jd" href="https://ahmet.im/blog/authenticating-to-gke-without-gcloud/" rel="noopener ugc nofollow" target="_blank"><em class="lm">https://Ahmet . im</em></a><em class="lm">。</em></p></div></div>    
</body>
</html>