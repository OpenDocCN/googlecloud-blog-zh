<html>
<head>
<title>How long does Google Dataflow pick and process Pub/Sub messages in “real time”?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Dataflow“实时”挑选和处理发布/订阅消息需要多长时间？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-long-does-google-dataflow-pick-and-process-pub-sub-messages-in-real-time-8ac19da774a2?source=collection_archive---------1-----------------------#2020-08-18">https://medium.com/google-cloud/how-long-does-google-dataflow-pick-and-process-pub-sub-messages-in-real-time-8ac19da774a2?source=collection_archive---------1-----------------------#2020-08-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="cc05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">(一项测试及其结果)</strong></p><p id="6d9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">简介</strong></p><p id="1f30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">组织使用Google Dataflow来处理数据并将其提供给物联网设备，以控制或监控设备。不同的用例需要不同的延迟。这个测试试图了解在给定的测试环境中，Google Dataflow选择并开始处理每个Pub/Sub元素需要多长时间。</p><p id="5246" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">快速声明:这绝不是基线评估。</em></p><p id="77fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">测试概述</strong></p><p id="1970" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">测试步骤:</p><ol class=""><li id="4f6d" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">创建一个发布/订阅主题，并将数据作为模拟流数据发送到该主题。数据内容是消息发布时的时间戳。</li><li id="9d2b" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">数据流从发布/订阅中读取，处理每个元素，将处理时间戳写入BigQuery。如果不想直接写入BigQuery，可以写入StackDriver日志，稍后为日志创建一个sink。</li><li id="8b11" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">对于延迟计算，请在BigQuery中运行时差查询。</li></ol><p id="193a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">测试环境:Python。</p><p id="2d8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">测试架构:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/2f88ba34377e4ade3098a6d5dc470fe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qDgwvPpSV7NxnIzcWrYGtQ.png"/></div></div></figure><p id="0732" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">测试详细步骤:</p><ol class=""><li id="5ee7" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">如果您还没有设置python运行环境来运行数据流作业，请参考此<a class="ae ke" href="https://cloud.google.com/dataflow/docs/quickstarts/quickstart-python" rel="noopener ugc nofollow" target="_blank">链接</a>并进行设置。</li></ol><p id="82e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.向发布/订阅主题发送模拟流数据:</p><pre class="jt ju jv jw fd kf kg kh ki aw kj bi"><span id="18d2" class="kk kl hi kg b fi km kn l ko kp"># create a test topic<br/>gcloud pubsub topics create TOPIC_NAME</span><span id="7eed" class="kk kl hi kg b fi kq kn l ko kp"># use gcloud scheduler to run publisher job every second (mock stream data) that contains the timestamp when publish job run<br/>gcloud scheduler jobs create pubsub publisher-job \<br/>- schedule="* * * * *" \<br/>- topic=TOPIC_NAME - message-body=`date +%s`</span></pre><p id="875a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.数据流处理并将信息记录到BigQuery中:</p><p id="9c12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了记录获取发布/订阅数据元素的时间，我们保存了<em class="jd">光束。DoFn.TimestampParam </em>值。</p><pre class="jt ju jv jw fd kf kg kh ki aw kj bi"><span id="1f1f" class="kk kl hi kg b fi km kn l ko kp">class LatencyFn(beam.DoFn):<br/>  def process(self, element, publish_time=beam.DoFn.TimestampParam):<br/>    yield {<br/>      "msg_publish_time": json.loads(element),<br/>      "msg_process_time": round(time.mktime(dt.datetime.now().timetuple()))<br/>  }</span></pre><p id="d7d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后将时间信息写入BigQuery表。片段如下:</p><pre class="jt ju jv jw fd kf kg kh ki aw kj bi"><span id="7c1b" class="kk kl hi kg b fi km kn l ko kp">def run(input_topic, output_topic, pipeline_args=None):    <br/>    pipeline_options = PipelineOptions(<br/>        pipeline_args, streaming=True, save_main_session=True<br/>    )<br/>    with beam.Pipeline(options=pipeline_options) as p:<br/>        msg = (p | "ReadPubSubMsg" &gt;&gt;        <br/>                     beam.io.ReadFromPubSub(topic=input_topic)<br/>                 | "GetMsgInfo" &gt;&gt; beam.ParDo(LatencyFn())<br/>        )<br/>        msg | 'WriteBQ' &gt;&gt; beam.io.WriteToBigQuery(                                <br/>          table = 'test.test_latency_info',<br/>          schema = 'msg_publish_time:STRING, <br/>                    msg_process_time:STRING',          <br/>          create_disposition =<br/>              beam.io.BigQueryDisposition.CREATE_IF_NEEDED,   <br/>          write_disposition = <br/>              beam.io.BigQueryDisposition.WRITE_APPEND<br/>        )<br/>    ...</span></pre><p id="37e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.从控制台部署数据流作业。</p><pre class="jt ju jv jw fd kf kg kh ki aw kj bi"><span id="a02c" class="kk kl hi kg b fi km kn l ko kp">python test.py - project=PROJECT_NAME - job_name=test - input_topic=projects/PROJECT_NAME/topics/TOPIC_NAME - runner=DirectRunner</span></pre><p id="e0fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.一旦数据流开始运行，它将读取每个发布/订阅消息，并将时间信息写入BigQuery表。</p><p id="eb20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.转到BigQuery并分析查询中记录的数据，如:</p><pre class="jt ju jv jw fd kf kg kh ki aw kj bi"><span id="af6f" class="kk kl hi kg b fi km kn l ko kp">SELECT<br/>  MIN(latency) as min,<br/>  MAX(latency) as max,<br/>  approx_quantiles(latency, 100)[offset(50)] as p50,<br/>  approx_quantiles(latency, 100)[offset(90)] as p90,<br/>  approx_quantiles(latency, 100)[offset(99)] as p99<br/>FROM<br/>  (SELECT cast(msg_process_time as int64) - cast(msg_publish_time as int64) AS latency<br/>  FROM `PROJECT_ID.DATASET_ID.TABLE_ID`)</span></pre><p id="1b50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">测试结果:</strong></p><p id="31ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从云调度程序向发布/订阅发送数据的时间，到发布/订阅处理数据元素的时间，上述查询以毫秒为单位显示了以下结果:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es kr"><img src="../Images/eb51afd81189d711be3295216c18e04f.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/0*ZpjoIBR-GjNP1vLY"/></div></figure><p id="a229" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了呈现信息，我们可以将延迟信息添加到(比如说)Data Studio中，以便可视化和进一步深入。它有助于直观地识别异常的延迟峰值。</p><p id="9ae3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个流程可以扩展到尽可能多的数据流处理步骤。</p></div></div>    
</body>
</html>