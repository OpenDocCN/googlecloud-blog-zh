<html>
<head>
<title>All You Need to Know About MongoDB on Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于Google Cloud上的MongoDB，你需要知道的一切</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/all-you-need-to-know-about-mongodb-on-google-cloud-28adc359af37?source=collection_archive---------0-----------------------#2018-04-30">https://medium.com/google-cloud/all-you-need-to-know-about-mongodb-on-google-cloud-28adc359af37?source=collection_archive---------0-----------------------#2018-04-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="537e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud提供了一个市场，其中有许多栈和服务解决方案，可以点击部署。解决方案包括数据库解决方案(mongodb，cassandra，mysql)到博客和CMS(wordpress，joomla)以及开发工具(gitlab，jenkins)。它们不是一个完全管理的解决方案，谷歌不提供任何支持，但堆栈减少了建立解决方案的时间，人们可以通过只支付GCP资源而不是解决方案*来享受服务。</p><p id="c58c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Google Cloud Launcher上提供的部署中，mongodb是一种可以通过在副本集中创建主实例、辅助实例(计算引擎)以及仲裁节点来进行部署的部署。</p><h2 id="ca63" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">如何创建MongoDB副本集</h2><p id="9f32" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">前往谷歌云控制台上的<a class="ae kd" href="https://console.cloud.google.com/launcher/details/click-to-deploy-images/mongodb" rel="noopener ugc nofollow" target="_blank"> MongoDB启动器，在实例集群中部署NoSQL数据库。点击“在计算引擎上启动”。</a></p><figure class="kf kg kh ki fd kj er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es ke"><img src="../Images/ad4ba6d718947b0b428aa48e5e585f65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Th7qS1yPA1GQiEo_sO8RsA.png"/></div></div></figure><p id="b5c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在控制台上配置部署、副本集名称和磁盘类型。选择节点数量，其中一个将作为主副本，其余为辅助副本。此外，选择一个仲裁节点，它可以是一个小实例，因为它仅用于通过投票选择主副本。建议选择SSD作为数据存储，它具有高IOPS和吞吐量。从<a class="ae kd" href="https://cloud.google.com/compute/docs/disks/performance" rel="noopener ugc nofollow" target="_blank">官方优化指南</a>中获取关于性能差异的详细信息。</p><p id="16f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在几分钟内，群集不仅有了指定数量的副本和仲裁器，而且每个节点都有一个单独的磁盘，这些磁盘具有连接到各自实例的命名标准<code class="du kq kr ks kt b"><a class="ae kd" href="https://console.cloud.google.com/compute/disksDetail/zones/us-central1-f/disks/mongodb-servers-vm-0-data?project=pv-lb-test&amp;authuser=1&amp;folder&amp;organizationId=264425354354" rel="noopener ugc nofollow" target="_blank">mongodb-servers-vm-0-data</a></code>。那些磁盘上数据是相互同步的。此外，通过选择<strong class="ih hj">外部IP </strong>选项<strong class="ih hj">无</strong>，我们可以隐藏特定子网外部的节点。</p><h2 id="f0ef" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">与MongoDB复制集连接</h2><p id="9396" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">有不同的方法连接到mongodb副本集:</p><p id="7063" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">连接到每个节点</strong>:在控制台的<a class="ae kd" href="https://console.cloud.google.com/compute/instances" rel="noopener ugc nofollow" target="_blank">计算实例页面</a>上，点击ssh按钮，新窗口打开，显示SSH连接。此外，使用<a class="ae kd" href="https://cloud.google.com/sdk/gcloud/reference/compute/ssh" rel="noopener ugc nofollow" target="_blank"> gcloud sdk </a> : <code class="du kq kr ks kt b">gcloud compute ssh [Instance Name] --zone [zone] --project [project]</code>登录google cloud实例也很容易</p><p id="71af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在仲裁节点上:</p><pre class="kf kg kh ki fd ku kt kv kw aw kx bi"><span id="0e35" class="jd je hi kt b fi ky kz l la lb">raju@mongodb-arbiters-vm-0:~$ mongo</span><span id="e485" class="jd je hi kt b fi lc kz l la lb">MongoDB shell version v3.4.14connecting to: mongodb://127.0.0.1:27017MongoDB server version: 3.4.1</span></pre><p id="f2df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在主节点上:</p><pre class="kf kg kh ki fd ku kt kv kw aw kx bi"><span id="77d7" class="jd je hi kt b fi ky kz l la lb">raju@mongodb-servers-vm-0:~$ mongo<br/>MongoDB shell version v3.4.14 connecting to: mongodb://127.0.0.1:27017 MongoDB server version: 3.4.14 <br/>.....</span><span id="477c" class="jd je hi kt b fi lc kz l la lb">rs0:PRIMARY&gt;</span></pre><p id="2a51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在次要位置:</p><pre class="kf kg kh ki fd ku kt kv kw aw kx bi"><span id="91ca" class="jd je hi kt b fi ky kz l la lb">raju@mongodb-servers-vm-0:~$ mongo<br/>MongoDB shell version v3.4.14<br/>.....<br/>rs0:SECONDARY&gt;</span></pre><p id="59ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">连接到复制集</strong></p><p id="0ee7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们有主副本和辅助副本在运行，所以要与副本集而不是每个副本集建立mongodb连接，请在任一节点上输入以下命令:</p><pre class="kf kg kh ki fd ku kt kv kw aw kx bi"><span id="46f4" class="jd je hi kt b fi ky kz l la lb">raju@mongodb-servers-vm-1:~$ mongo “mongodb://mongodb-servers-vm-0,mongodb-servers-vm-1/myDB?replicaSet=rs0”</span></pre><p id="36dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样，我们首先连接到主副本/节点，如果发生故障转移，仲裁节点会选择另一个节点作为主节点，并建立到新主节点的连接。</p><h2 id="ef57" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">故障转移演示</h2><p id="2ad5" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">首先，我们从仲裁器节点连接到副本集</p><pre class="kf kg kh ki fd ku kt kv kw aw kx bi"><span id="a2d3" class="jd je hi kt b fi ky kz l la lb">raju@mongodb-arbiters-vm-0:~$ mongo "mongodb://mongodb-servers-vm-0,mongodb-servers-vm-1/myDB?replicaSet=rs0"</span><span id="6248" class="jd je hi kt b fi lc kz l la lb">MongoDB shell version v3.4.14 connecting to: mongodb://mongodb-servers-vm-0,mongodb-servers-vm-1/myDB?replicaSet=rs0</span><span id="6e38" class="jd je hi kt b fi lc kz l la lb">I NETWORK  [thread1] Starting new replica set monitor for rs0/mongodb-servers-vm-0:27017,mongodb-servers-vm-1:27017</span><span id="916d" class="jd je hi kt b fi lc kz l la lb">I NETWORK  [thread1] Successfully connected to mongodb-servers-vm-1:27017 (1 connections now open to mongodb-servers-vm-1:27017 with a 5 second timeout)</span><span id="4275" class="jd je hi kt b fi lc kz l la lb">I NETWORK  [ReplicaSetMonitor-TaskExecutor-0] Successfully connected to mongodb-servers-vm-0:27017 (1 connections now open to mongodb-servers-vm-0:27017 with a 5 second timeout)</span><span id="43d0" class="jd je hi kt b fi lc kz l la lb">rs0:PRIMARY&gt;</span></pre><p id="af09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，实例<code class="du kq kr ks kt b">mongodb-servers-vm-0</code>是主要的，<code class="du kq kr ks kt b">mongodb-servers-vm-1</code>是次要的。现在，让我们在主节点上重启mongod服务</p><pre class="kf kg kh ki fd ku kt kv kw aw kx bi"><span id="dd99" class="jd je hi kt b fi ky kz l la lb">raju@mongodb-servers-vm-0:~$ sudo service mongod restart</span></pre><p id="63eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在仲裁器连接上:</p><pre class="kf kg kh ki fd ku kt kv kw aw kx bi"><span id="e95e" class="jd je hi kt b fi ky kz l la lb">I NETWORK  [thread1] Successfully connected to mongodb-servers-vm-1:27017 (1 connections now open to mongodb-servers-vm-1:27017 with a 5 second timeout)</span><span id="7f28" class="jd je hi kt b fi lc kz l la lb">W NETWORK  [thread1] No primary detected for set rs0<br/>...<br/>W NETWORK  [thread1] No primary detected for set rs0</span><span id="ad77" class="jd je hi kt b fi lc kz l la lb">rs0:PRIMARY&gt;</span></pre><p id="85ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们连接到实例<code class="du kq kr ks kt b">mongodb-servers-vm-1</code>，它现在已经成为主副本。检查副本集状态:</p><pre class="kf kg kh ki fd ku kt kv kw aw kx bi"><span id="a29b" class="jd je hi kt b fi ky kz l la lb">raju@mongodb-arbiters-vm-0:~$ mongo</span><span id="6146" class="jd je hi kt b fi lc kz l la lb">rs0:ARBITER&gt; rs.status()</span></pre><p id="565d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们得到状态:</p><pre class="kf kg kh ki fd ku kt kv kw aw kx bi"><span id="5d84" class="jd je hi kt b fi ky kz l la lb">"members" : [ {<br/>"_id" : 0, <br/>"name" : "mongodb-servers-vm-1:27017",                        "health" : 1,<br/>"state" : 1, <br/>"stateStr" : "PRIMARY",<br/>.....<br/>"electionTime" : Timestamp(1525084250, 1),<br/>},<br/>{ "_id" : 1,<br/>"name" : "mongodb-servers-vm-0:27017",                        "health" : 1,<br/>"state" : 2,<br/>"stateStr" : "SECONDARY",<br/>.....<br/>"syncingTo" : "mongodb-servers-vm-1:27017",<br/>}</span></pre><p id="484e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">来自计算引擎实例的MongoDB复制集连接</strong></p><p id="c6b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从任何Google云计算引擎实例中，可以通过传递replicaset主机名来建立mongodb连接:<code class="du kq kr ks kt b">mongodb://mongodb-servers-vm-0,mongodb-servers-vm-1/myDB?replicaSet=rs0</code></p><p id="2235" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是我们不能通过提供任何节点的ip地址来连接到该设备。副本的名称可以在各自实例的<code class="du kq kr ks kt b">/etc/hosts</code>上找到。</p><p id="7f57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">来自本地主机的MongoDB复制集连接</strong></p><p id="0043" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有时，我们可能需要从本地计算机连接到Google Cloud上启动的副本集，为此我们需要创建SSH隧道:</p><pre class="kf kg kh ki fd ku kt kv kw aw kx bi"><span id="9101" class="jd je hi kt b fi ky kz l la lb">gcloud compute ssh --ssh-flag=-L27017:localhost:27017 --project=<em class="ld">PROJECT</em> --zone=<em class="ld">ZONE</em> <em class="ld">INSTANCE_NAME</em></span></pre><p id="0ac4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">顺便说一下，我们甚至可以从MongoDB Compass连接到replicaSet来探索和操作数据。</p><h2 id="17b4" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">监控MongoDB集群</h2><p id="cb32" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">正如他们所说的<em class="ld">使用Ops Manager </em>使生活变得更轻松，它是MongoDB提供的最佳解决方案之一，提供了查询优化的性能可见性以及开箱即用的警报。Ops Manager 可以在各种平台上下载，但我在ubuntu上遇到了问题，后来在CentOS上成功了，没有任何障碍。</p></div></div>    
</body>
</html>