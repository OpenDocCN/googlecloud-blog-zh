<html>
<head>
<title>Code Coverage on Google Cloud Build</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云构建的代码覆盖率</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/code-coverage-on-google-cloud-build-7fcf1b67f182?source=collection_archive---------1-----------------------#2019-02-01">https://medium.com/google-cloud/code-coverage-on-google-cloud-build-7fcf1b67f182?source=collection_archive---------1-----------------------#2019-02-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="90b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您为您的项目设置CI/CD管道时，您可能想要计算代码覆盖率，并将其发送给第三方服务，如Codecov。</p><p id="5816" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将向您展示如何在<a class="ae jd" href="https://cloud.google.com/cloud-build/" rel="noopener ugc nofollow" target="_blank"> Google Cloud Build </a>上进行设置。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/8c0c638e2fcadaadb0a038a4f4a8d95d.png" data-original-src="https://miro.medium.com/v2/resize:fit:672/format:webp/1*cBdQDlRGZ85QMTBz2gRXpA.png"/></div></figure><h1 id="63fe" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">问题</h1><p id="42cf" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">默认情况下，<a class="ae jd" href="https://www.npmjs.com/package/codecov" rel="noopener ugc nofollow" target="_blank"> codecov工具</a>必须从git存储库中运行，否则它会抛出一个错误:</p><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="a3d7" class="ku jn hi kq b fi kv kw l kx ky">fatal: Not a git repository</span></pre><p id="2d7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">原因是codecov被设计为报告代码的特定分支和提交的覆盖率。</p><p id="b251" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为<a class="ae jd" href="https://github.com/marketplace/google-cloud-build" rel="noopener ugc nofollow" target="_blank"> Google Cloud Build GitHub应用</a>不会重新创建一个完整的git存储库，所以我们需要一个变通办法。</p><h1 id="9409" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">解决办法</h1><p id="4f96" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">解决方案是手动传递分支并提交到工具:</p><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="44be" class="ku jn hi kq b fi kv kw l kx ky">$ codecov --token=X --disable=detect --commit=FOO --branch=BAR</span></pre><p id="81b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云构建通过<a class="ae jd" href="https://cloud.google.com/cloud-build/docs/configuring-builds/substitute-variable-values" rel="noopener ugc nofollow" target="_blank">内置替换</a>使这种信息对构建可用。</p><h2 id="4c39" class="ku jn hi bd jo kz la lb js lc ld le jw iq lf lg ka iu lh li ke iy lj lk ki ll bi translated"><em class="lm"> cloudbuild.yaml </em></h2><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="cc0b" class="ku jn hi kq b fi kv kw l kx ky">steps: <br/>- name: 'gcr.io/cloud-builders/npm'  <br/>  args: ['install'] </span><span id="ce7e" class="ku jn hi kq b fi ln kw l kx ky">- name: 'gcr.io/cloud-builders/npm'  <br/>  args: ['run', 'ci'] </span><span id="af9f" class="ku jn hi kq b fi ln kw l kx ky">- name: 'gcr.io/cloud-builders/npm'  <br/>  args: <br/>   [<br/>     'run', <br/>     'codecov',<br/>     '--', <br/>     '--disable=detect', <br/>     '--commit=$COMMIT_SHA', <br/>     '--branch=$BRANCH_NAME'<br/>   ]</span></pre><h2 id="73cc" class="ku jn hi bd jo kz la lb js lc ld le jw iq lf lg ka iu lh li ke iy lj lk ki ll bi translated">package.json</h2><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="4705" class="ku jn hi kq b fi kv kw l kx ky">{<br/>  "devDependencies": {<br/>    "codecov": "3.1.0", <br/>    "mocha": "5.2.0",<br/>    "nyc": "13.1.0"<br/>  },</span><span id="5144" class="ku jn hi kq b fi ln kw l kx ky">  "scripts": {<br/>     "ci": "NODE_ENV=test node_modules/.bin/nyc node_modules/.bin/mocha --reporter spec 'server/test/**/*test.js' &amp;&amp; node_modules/.bin/nyc report --reporter=text-lcov &gt; coverage.lcov",<br/>     "codecov": "node_modules/.bin/codecov --token=X"<br/>  }</span><span id="4d73" class="ku jn hi kq b fi ln kw l kx ky">}</span></pre><h1 id="c1b4" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">结论</h1><p id="483f" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">您可以绕过codecov工具检测，手动传递当前CI运行的提交和分支。</p><p id="e3e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云构建配置易于阅读:它安装依赖项，运行测试，然后将结果上传到Codecov。</p><p id="8e96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的下一篇文章中，我将向你展示如何缓存第一步以获得更好的性能。</p></div></div>    
</body>
</html>