<html>
<head>
<title>Creating a MongoDB CRUD backend on Google Cloud Functions.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google云函数上创建MongoDB CRUD后端。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/creating-a-mongodb-crud-backend-on-google-cloud-functions-88bb5c1cef77?source=collection_archive---------1-----------------------#2017-05-16">https://medium.com/google-cloud/creating-a-mongodb-crud-backend-on-google-cloud-functions-88bb5c1cef77?source=collection_archive---------1-----------------------#2017-05-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5ec9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在过去的两周里，我一直在摆弄谷歌的云功能。在看了来自谷歌(<a class="ae jd" href="https://twitter.com/bretmcg" rel="noopener ugc nofollow" target="_blank">https://twitter.com/bretmcg</a>)的Bret McGowen在SF无服务器会议上的精彩介绍和演示后，我决定试一试。</p><h2 id="003e" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">那么谷歌云功能到底是什么呢？</h2><p id="f5ce" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">Google Cloud Functions是Google提供的一种功能即服务(FaaS ),计费精确到100毫秒，运行Javascript。</p><h2 id="f836" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">首先谷歌云功能，Hello World？</h2><p id="b055" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">当然，这是一个虚拟的例子，但它是有效的！</p><figure class="ke kf kg kh fd ki"><div class="bz dy l di"><div class="kj kk l"/></div></figure><p id="05a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个基本的JavaScript模块。导出一个名为<strong class="ih hj">T3的函数句柄T5。这个函数非常类似于Expressjs(<a class="ae jd" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank">https://expressjs.com/</a>)处理函数。所以，任何在Express上有效的东西，在这里也有效。(GCF实际上是使用Expressjs来支持它们的HTTP功能)</strong></p><p id="98c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GCF有一组最低要求。比如:</p><ul class=""><li id="7817" class="km kn hi ih b ii ij im in iq ko iu kp iy kq jc kr ks kt ku bi translated"><em class="kl"> package.json </em>文件来管理依赖项，它将在部署时安装。</li><li id="971b" class="km kn hi ih b ii kv im kw iq kx iu ky iy kz jc kr ks kt ku bi translated">Node 6.9.1(令人失望的是我们还不能直接使用以后的版本，但是Babel可以帮助我们)</li><li id="fe0e" class="km kn hi ih b ii kv im kw iq kx iu ky iy kz jc kr ks kt ku bi translated">GCF SDK已安装并初始化(<a class="ae jd" href="https://cloud.google.com/sdk/downloads#interactive" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/sdk/downloads#interactive</a>)</li><li id="a04c" class="km kn hi ih b ii kv im kw iq kx iu ky iy kz jc kr ks kt ku bi translated">一个谷歌云存储桶上传或编码(从Git上传功能也是可能的)</li></ul><p id="0387" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署脚本从<em class="kl"> package.json </em>文件上的“main”prop获取函数。</p><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="a8d7" class="je jf hi lb b fi lf lg l lh li">{<br/>  "name": "gcf-hello",<br/>  "version": "1.0.0",<br/>  "description": "",<br/>  "main": "index.js",<br/>  "scripts": {<br/>    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"<br/>  },<br/>  "author": "",<br/>  "license": "ISC"<br/>}</span></pre><p id="991a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我们覆盖了所有的基础，我们需要创建一个部署桶。一个小命令将帮助我们:</p><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="b423" class="je jf hi lb b fi lf lg l lh li">$ gsutil mb gs://medium-post-functions</span></pre><p id="fbec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，只需用一个“简单”的命令部署该功能，比如:</p><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="dd90" class="je jf hi lb b fi lf lg l lh li">$ <strong class="lb hj">gcloud beta functions deploy hello-world --entry-point handler --trigger-http --stage-bucket medium-post-functions --memory=256MB</strong></span><span id="b8d2" class="je jf hi lb b fi lj lg l lh li">Copying file:///var/folders/f9/_xttz7rs7t10grd6_q_8s1dr0000gn/T/tmpxV6pSu/fun.zip [Content-Type=application/zip]...<br/>- [1 files][  438.0 B/  438.0 B]<br/>Operation completed over 1 objects/438.0 B.<br/>Deploying function (may take a while - up to 2 minutes)...done.<br/>availableMemoryMb: 256<br/>entryPoint: handler<br/>httpsTrigger:<br/>url: <a class="ae jd" href="https://us-central1-revelatio-165320.cloudfunctions.net/hello-world" rel="noopener ugc nofollow" target="_blank">https://us-central1-revelatio-165320.cloudfunctions.net/hello-world</a><br/>latestOperation: operations/cmV2ZWxhdGlvLTE2NTMyMC91cy1jZW50cmFsMS9oZWxsby13b3JsZC9nb0pHUXV2TXFTbw<br/>name: projects/revelatio-165320/locations/us-central1/functions/hello-world<br/>serviceAccount: revelatio-165320@appspot.gserviceaccount.com<br/>sourceArchiveUrl: gs://medium-post-functions/us-central1-hello-world-bsesoemdvxwb.zip<br/>status: READY<br/>timeout: 60s<br/>updateTime: '2017-05-15T16:20:11Z'</span><span id="f445" class="je jf hi lb b fi lj lg l lh li">$</span></pre><p id="1192" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将获得一个URL来通过HTTP调用我们的函数。</p><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="9493" class="je jf hi lb b fi lf lg l lh li">$ curl <a class="ae jd" href="https://us-central1-revelatio-165320.cloudfunctions.net/hello-world" rel="noopener ugc nofollow" target="_blank">https://us-central1-revelatio-165320.cloudfunctions.net/hello-world</a><br/>Hello World</span><span id="35a5" class="je jf hi lb b fi lj lg l lh li">$</span></pre><h2 id="36bb" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">添加一些依赖项使其有用</h2><p id="9c53" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">首先，我想在更新的ES2015 JavaScript上写这个函数。让我们把巴别尔(<a class="ae jd" href="https://babeljs.io/" rel="noopener ugc nofollow" target="_blank">https://babeljs.io/</a>)加入进来。</p><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="d2c0" class="je jf hi lb b fi lf lg l lh li">$ yarn add --dev babel-cli babel-core babel-plugin-transform-runtime babel-preset-es2015 babel-preset-stage-1</span><span id="56b1" class="je jf hi lb b fi lj lg l lh li">$ yarn add babel-runtime</span></pre><p id="976f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还有一个<em class="kl">。babelrc </em>文件:</p><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="9536" class="je jf hi lb b fi lf lg l lh li">{<br/>  "presets": ["es2015", "stage-1"],<br/>  "plugins": ["transform-runtime"]<br/>}</span></pre><p id="41fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这之后，我们还可以在我们的<em class="kl"> package.json </em>文件中添加一个脚本部分来构建我们的代码(另一个用于构建和部署)</p><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="d4a9" class="je jf hi lb b fi lf lg l lh li">{<br/>  "name": "gcf-hello",<br/>  "version": "1.0.0",<br/>  "description": "",<br/>  <strong class="lb hj">"main": "lib/index.js",<br/>  "scripts": {<br/>    "build": "rm -rf lib/ &amp;&amp; `yarn bin`/babel index.js --out-dir ./lib",<br/>    "deploy": "yarn build &amp;&amp; gcloud beta functions deploy hello-world --entry-point handler --trigger-http --stage-bucket medium-post-functions --memory=256MB"<br/>  },</strong><br/>  "author": "",<br/>  "license": "ISC",<br/>  <strong class="lb hj">"dependencies": {<br/>    "babel-runtime": "^6.23.0"<br/>  },<br/>  "devDependencies": {<br/>    "babel-cli": "^6.24.1",<br/>    "babel-core": "^6.24.1",<br/>    "babel-plugin-transform-runtime": "^6.23.0",<br/>    "babel-preset-es2015": "^6.24.1",<br/>    "babel-preset-stage-1": "^6.24.1"<br/>  }</strong><br/>}</span></pre><p id="80f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">标记为粗体的文本表示对我们的<em class="kl"> package.json </em>文件的更改。</p><p id="d156" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以现在我们可以用所有更好的ES2015编写我们的函数了</p><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="a29a" class="je jf hi lb b fi lf lg l lh li">export const <em class="kl">handler </em>= (req, res) =&gt; res.send('Hello World')</span></pre><p id="2b0f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">而现在，只是:</p><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="4afc" class="je jf hi lb b fi lf lg l lh li">$ yarn deploy</span></pre><p id="0417" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以根据需要多次重新部署。同一个网址总是回来使用我们的HTTP功能。</p><h2 id="61aa" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">让我们制作一个MongoDB CRUD API后端</h2><p id="a507" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">首先我们需要添加MongoDB(<a class="ae jd" href="https://www.npmjs.com/package/mongodb" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/mongodb</a>)驱动模块。</p><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="f435" class="je jf hi lb b fi lf lg l lh li">$ yarn add mongodb dotenv</span></pre><p id="665b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我还在这里添加了一个依赖项。</p><ul class=""><li id="4b6f" class="km kn hi ih b ii ij im in iq ko iu kp iy kq jc kr ks kt ku bi translated">dotenv(<a class="ae jd" href="https://www.npmjs.com/package/dotenv" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/dotenv</a>)，允许我们将配置变量加载到process.env中</li></ul><p id="a353" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我个人更喜欢使用mLab.com的免费托管mongodb服务(不需要超过500Mb)，你可以在任何地方使用你的mongodb数据库，当然可以从互联网访问。MongoDB Atlas是你可以使用的另一个服务。</p><p id="7231" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个<em class="kl">。env </em>文件将帮助我们配置动态属性，包括MONGODB连接字符串。这个文件应该不受版本控制。(例如。<em class="kl">。gitignore </em></p><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="f7e4" class="je jf hi lb b fi lf lg l lh li">MONGODB=mongodb://gcf:KjyCaENsTT6q8PVE@ds143231.mlab.com:43231/gcf-hello</span></pre><figure class="ke kf kg kh fd ki"><div class="bz dy l di"><div class="kj kk l"/></div></figure><p id="2895" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再次部署并从控制台测试它</p><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="40aa" class="je jf hi lb b fi lf lg l lh li">$ curl <a class="ae jd" href="https://us-central1-revelatio-165320.cloudfunctions.net/hello-world" rel="noopener ugc nofollow" target="_blank">https://us-central1-revelatio-165320.cloudfunctions.net/hello-world</a></span><span id="235b" class="je jf hi lb b fi lj lg l lh li">[{"_id":"591a25ea734d1d1cd0becda2","name":"Ernesto F.","email":"ernestofreyreg@gmail.com"}]</span></pre><p id="c252" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们有来自CRUD的R部分。让我们尝试添加C部分(创建)</p><figure class="ke kf kg kh fd ki"><div class="bz dy l di"><div class="kj kk l"/></div></figure><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="ad91" class="je jf hi lb b fi lf lg l lh li">$ yarn deploy</span></pre><p id="ee01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还有…</p><pre class="ke kf kg kh fd la lb lc ld aw le bi"><span id="ca54" class="je jf hi lb b fi lf lg l lh li">$ curl -d '{"name":"Lucian Freyre", "email":"lucian@codexsw.com"}' -H "Content-Type: application/json" -X POST <a class="ae jd" href="https://us-central1-revelatio-165320.cloudfunctions.net/hello-world" rel="noopener ugc nofollow" target="_blank">https://us-central1-revelatio-165320.cloudfunctions.net/hello-world</a></span><span id="7a50" class="je jf hi lb b fi lj lg l lh li">{"result": "ok"}</span><span id="0616" class="je jf hi lb b fi lj lg l lh li">$ curl https://us-central1-revelatio-165320.cloudfunctions.net/hello-world</span><span id="c3dd" class="je jf hi lb b fi lj lg l lh li">[{"_id":"591a25ea734d1d1cd0becda2","name":"Ernesto F.","email":"ernestofreyreg@gmail.com"},{"_id":"591a2e757b0c5400028ad0c3","name":"Lucian Freyre","email":"lucian@codexsw.com"}]</span></pre><p id="bf01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止，一切顺利，现在我们已经有了端点，2个基本操作(创建和读取)。我不会在这里添加更多的操作，你可能已经知道如何添加其余的。</p><h2 id="b076" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">最后的想法</h2><ul class=""><li id="0a84" class="km kn hi ih b ii jz im ka iq lk iu ll iy lm jc kr ks kt ku bi translated">FaaS会留在这里。</li><li id="5145" class="km kn hi ih b ii kv im kw iq kx iu ky iy kz jc kr ks kt ku bi translated">谷歌云功能可以改进很多，特别是在工具、文档和性能方面。</li></ul><h2 id="fdab" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">后续步骤</h2><ul class=""><li id="4572" class="km kn hi ih b ii jz im ka iq lk iu ll iy lm jc kr ks kt ku bi translated">当然是GraphQL(<a class="ae jd" href="http://graphql.org/" rel="noopener ugc nofollow" target="_blank">http://graphql.org/</a>))考虑到我们实际上使用Expressjs作为后端，使用正确的graph QL模块，剩下的工作应该相当容易。</li><li id="8d36" class="km kn hi ih b ii kv im kw iq kx iu ky iy kz jc kr ks kt ku bi translated">和服务器端呈现的反应。</li></ul></div></div>    
</body>
</html>