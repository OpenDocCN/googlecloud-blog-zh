<html>
<head>
<title>Streaming Data into BigQuery using Google Cloud Run</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Cloud Run将数据流式传输到BigQuery</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/streaming-data-into-bigquery-using-google-cloud-run-469365a731b9?source=collection_archive---------2-----------------------#2020-07-28">https://medium.com/google-cloud/streaming-data-into-bigquery-using-google-cloud-run-469365a731b9?source=collection_archive---------2-----------------------#2020-07-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="3af2" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用无服务器计算将实时流数据导入BigQuery的解决方案</h2></div><h2 id="f3dd" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">解决办法</h2><p id="b2b2" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">该解决方案旨在使用Google cloud无服务器平台将流数据接收到BigQuery中，而无需担心底层基础架构。它还支持同步数据读/写功能，并有助于线性容量规划和数据准确性。此解决方案中使用了一个额外的跃点(计算引擎),以便在将多条消息写入云存储之前将其整合到一个文件中，从而提高存储效率。</p><p id="d637" class="pw-post-body-paragraph jv jw hi jx b jy ko ij ka kb kp im kd ji kq kf kg jm kr ki kj jq ks kl km kn hb bi translated">发布/订阅通知将有关新消息/文件到达存储桶的信息发送到发布/订阅主题。一旦发布/订阅收到通知，它就会将消息推送到云运行服务的端点。</p><p id="6b68" class="pw-post-body-paragraph jv jw hi jx b jy ko ij ka kb kp im kd ji kq kf kg jm kr ki kj jq ks kl km kn hb bi translated">云运行处理从发布/订阅接收的消息，从云存储中检索文件内容，并写入BigQuery表。</p><h2 id="48cd" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated"><strong class="ak">架构</strong></h2><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es kt"><img src="../Images/cfe6a0f94fa6c433f22adbcea552213d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F1GVTyAnucgjhFRhMP9RpQ.png"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx translated">流数据接收的数据流图</figcaption></figure><h2 id="f2ef" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">步骤1:创建BigQuery数据集和表</h2><p id="df7e" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">这种解决方案允许灵活的模式定义，而不需要修改源代码，但是它必须遵守流式数据属性。在下面的示例中，只有三列表示数据摄取过程，并且可以根据需要进行扩展。</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="lj lk l"/></div><figcaption class="lf lg et er es lh li bd b be z dx translated">BigQuery数据集和表</figcaption></figure><h2 id="c0ff" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated"><strong class="ak">第二步:创建服务账户并添加角色</strong></h2><p id="5e4e" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">此解决方案需要一个具有BigQuery管理员、发布/订阅编辑器、云存储管理员和云运行管理员角色的服务帐户。</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="lj lk l"/></div></figure><h2 id="c098" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">步骤3:构建和部署云运行应用程序</h2><p id="eb25" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">Cloud Run是完全托管的计算平台，用于快速、安全地部署和扩展容器化的应用程序。下面描述的应用程序代码演示了多个步骤，包括将应用程序代码打包到容器映像中，将容器映像上传到容器注册表，然后将容器映像部署到云运行。</p><p id="3558" class="pw-post-body-paragraph jv jw hi jx b jy ko ij ka kb kp im kd ji kq kf kg jm kr ki kj jq ks kl km kn hb bi translated">源代码是用node.js语言编写的，但也可以用多种语言编写，如Go、Python、Java、Ruby。</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="lj lk l"/></div><figcaption class="lf lg et er es lh li bd b be z dx translated">处理传入请求的应用程序代码</figcaption></figure><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="lj lk l"/></div><figcaption class="lf lg et er es lh li bd b be z dx translated">发布/订阅消息控制器</figcaption></figure><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="lj lk l"/></div><figcaption class="lf lg et er es lh li bd b be z dx translated">集装箱应用程序并上传至集装箱登记处</figcaption></figure><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="lj lk l"/></div><figcaption class="lf lg et er es lh li bd b be z dx translated">部署云跑应用</figcaption></figure><h2 id="3d65" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">步骤4:创建发布/订阅主题和订阅</h2><p id="3abf" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">创建具有服务帐户的发布/订阅，以将消息推送到云运行服务的端点。每个消息包含文件名和云存储桶中的文件位置。</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="lj lk l"/></div></figure><h2 id="01d8" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">步骤5:为云存储创建发布/订阅通知</h2><p id="02cb" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">使用OBJECT_FINALIZE事件类型创建的云存储的发布/订阅通知，以确保只有在桶中成功创建新对象时才会触发通知。</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="lj lk l"/></div></figure><h2 id="4c9a" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">步骤6:将消息推送到云存储中</h2><p id="239e" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">可以通过启用流管道将消息推送到云存储桶，也可以通过将JSON格式的消息文件直接写入云存储桶来实现。</p><h2 id="593f" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">源代码库</h2><p id="74b5" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated"><a class="ae ll" href="https://github.com/soumendra-mishra/stream-analytics-api.git" rel="noopener ugc nofollow" target="_blank">https://github . com/soumendra-mis HRA/stream-analytics-API . git</a></p></div></div>    
</body>
</html>