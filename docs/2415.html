<html>
<head>
<title>Secure GKE clusters with Custom Organization Policies in GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GCP的自定义组织策略保护GKE集群</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/secure-gke-clusters-with-custom-organization-policies-in-gcp-27dad3d8ce6e?source=collection_archive---------0-----------------------#2022-10-11">https://medium.com/google-cloud/secure-gke-clusters-with-custom-organization-policies-in-gcp-27dad3d8ce6e?source=collection_archive---------0-----------------------#2022-10-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1cb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">企业正朝着将应用程序部署为容器的方向发展，kubernetes是一个流行的编排工具，用于管理和部署基于容器的工作负载。谷歌云提供了谷歌kubernetes引擎，又名GKE，一个创建和管理Kubernetes集群的平台。从安全角度来看，基于kubernetes的应用程序可以分为四个方面:1 .代码，2。集装箱3。集群和4。云。</p><p id="b2d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图显示了在公共云环境中运行的Kubernetes应用程序的不同安全层面。在本帖中，我们将深入探讨如何通过“GKE的自定义组织策略功能”来加强GKE Kubernetes集群(集群平面)的安全性。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/08d4cefa5bf262f6d80f6b10ec080424.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*utSMNugWamYAvEJGT_t9Gw.png"/></div></div></figure><h1 id="c7f0" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">介绍</h1><p id="c77e" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">组织政策在GCP环境中提供安全实践的集中控制和实施。目前有70多种内置的<a class="ae ks" href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints" rel="noopener ugc nofollow" target="_blank">组织政策</a>可用。GCP计划通过自定义组织策略扩展这一功能，使管理员能够扩展默认策略。“GKE定制组织策略”使管理员能够在GKE集群资源上实施安全策略和最佳实践。该功能目前正在<strong class="ih hj">公开预览，</strong>使组织能够保护“集群平面”，并在创建和管理GKE集群时实施最佳实践。使用此功能，您可以创建自定义策略来限制GKE集群的属性，并在组织、文件夹或项目级别应用策略约束。</p><h1 id="c9f4" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">GKE的自定义组织策略</h1><p id="4d20" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">GKE的组织策略使组织策略管理员能够指定GKE集群资源属性的约束。这些限制可以在GKE集群上实施最佳实践和策略，并从GKE集群的角度进一步加强安全态势。约束的一些例子可以是</p><ol class=""><li id="95d4" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">GKE群集应该始终是私有的，并且只公开私有端点。</li><li id="beab" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">应为GKE集群定义维护时段。</li><li id="c8e0" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">无法禁用群集的自动升级。</li><li id="917f" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">启用工作负荷标识池。</li></ol><h1 id="5d61" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">GKE组织政策示例</h1><p id="405d" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">让我们考虑这样一个用例，组织策略管理员希望确保组织中创建的所有GKE集群都是私有的。这实质上意味着为集群创建的任何VM工作节点都不应该公开公共IP地址。</p><p id="839e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了实施该策略，组织管理员必须确保在GKE集群内私有端点属性始终设置为真。为了找出GKE集群的确切属性名，管理员可以通过查看GKE集群REST API<a class="ae ks" href="https://cloud.google.com/kubernetes-engine/docs/reference/rest/v1/projects.locations.clusters#resource:-cluster" rel="noopener ugc nofollow" target="_blank">链接</a>的资源定义来查看GKE集群对象。</p><p id="40ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PrivateClusterConfig实体包含属性“enablePrivateNodes ”,以确保从该群集创建的任何节点只包含私有IP，而不会创建节点的公共Ip。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lh"><img src="../Images/3110e075a308d1efe5bbb27494c9a7cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xqGY7LY1Gg_Vho9I1gC4-Q.png"/></div></div></figure><p id="c176" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这意味着，当创建或更新集群时，在GKE集群上实施的约束应该检查条件中的属性“privateclusterconfig . enableprivatenodes”。</p><p id="b203" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以按如下方式创建GKE集群的约束条件</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es li"><img src="../Images/10a2e5385c3a2acfaab0cec4356ec46a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P46Wf5sfIYllAhOcG7h7Kg.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated"><strong class="bd jr">constraint-priv-node . YAML</strong></figcaption></figure><p id="c399" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的yaml文件创建了一个org策略约束，并评估“条件”enablePrivateNodes是否设置为false。action_type设置为DENY，因此如果在enablePrivateNode属性设置为false的情况下创建GKE集群，它将被拒绝。或者，我们也可以评估策略应该只在条件中enablePrivateNode设置为true时才允许(action_type ),否则应该会失败。method_types指定在创建和修改GKE集群的过程中都应该实施该策略。上述约束中的条件基于<a class="ae ks" href="https://cloud.google.com/resource-manager/docs/organization-policy/creating-managing-custom-constraints#common_expression_language" rel="noopener ugc nofollow" target="_blank">通用表达式语言</a></p><p id="c083" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以通过下面的命令创建组织策略约束。</p><blockquote class="ln lo lp"><p id="7434" class="if ig lq ih b ii ij ik il im in io ip lr ir is it ls iv iw ix lt iz ja jb jc hb bi translated">g cloud org-policies set-custom-constraint constraint-priv-node . YAML</p></blockquote><p id="d027" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要实施约束，请创建如下所示的策略yaml。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lu"><img src="../Images/c521d1d26d547af136b2047027e807b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K9ENG5SSPqUEiKQ8EU1Flw.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated"><strong class="bd jr"> policy-priv-cluster.yaml </strong></figcaption></figure><p id="c44e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的yaml中，我们已经指定了该策略应该在组织级别执行，因此它将应用于跨组织的不同项目创建的所有GKE集群。或者，我们也可以在策略名称中指定projects/ <project_id>,这将只对指定项目中的GKE集群实施该策略。</project_id></p><p id="a79b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过输入以下命令应用上述策略。</p><blockquote class="ln lo lp"><p id="9a8a" class="if ig lq ih b ii ij ik il im in io ip lr ir is it ls iv iw ix lt iz ja jb jc hb bi translated">g cloud org-policies set-policy policy-priv-cluster . YAML</p></blockquote><p id="fa91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">测试策略约束</strong></p><p id="416a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下命令创建一个GKE集群。默认情况下，集群的enablePrivateNodes属性为false，因此在下面的命令中，集群工作节点将公开公共ip，这是我们在上面创建的组织策略约束所禁止的</p><blockquote class="ln lo lp"><p id="196b" class="if ig lq ih b ii ij ik il im in io ip lr ir is it ls iv iw ix lt iz ja jb jc hb bi translated"><code class="du lv lw lx ly b">gcloud container clusters create gke-test \<br/> --project=&lt;PROJECT_ID&gt; \<br/> --zone=&lt;COMPUTE_ZONE&gt; \<br/> --num-nodes=1</code></p></blockquote><p id="b9d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用公共节点创建集群时，会引发以下错误</p><blockquote class="ln lo lp"><p id="423b" class="if ig lq ih b ii ij ik il im in io ip lr ir is it ls iv iw ix lt iz ja jb jc hb bi translated">错误:(g cloud . container . clusters . create)response ERROR:code = 400，message =操作被自定义组织策略拒绝:[" custom constraints/custom . enableprivatenodesorg ":"所有新群集必须是priv群集。"" custom constraints/custom . enableprivatenodesorg ":"所有Kubernetes集群应该只公开私有节点"]。</p></blockquote><p id="1452" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过显式启用私有节点并为Kubernetes主平面通信指定CIDR范围来创建私有集群。由于private nodes设置为true，因此满足了组织策略约束，并成功创建了群集。</p><blockquote class="ln lo lp"><p id="a9ca" class="if ig lq ih b ii ij ik il im in io ip lr ir is it ls iv iw ix lt iz ja jb jc hb bi translated">gcloud容器集群创建gke-test—project =<project_id>—zone =<zone>—num-nodes = 1—enable-IP-alias—enable-private-nodes—master-IP v4-CIDR = 10 . 1 . 1 . 7/28</zone></project_id></p></blockquote><h1 id="0d9e" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">结论</h1><p id="3ded" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">组织策略使管理员能够对在GCP环境中创建的资源实施安全控制和最佳实践。借助“GKE定制组织策略”，管理员现在可以在GKE集群上实施安全性和最佳实践。这些策略在正确配置的情况下将极大地帮助保护Kubernetes资源的集群平面。</p><h1 id="2842" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">参考</h1><p id="c529" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated"><a class="ae ks" href="https://cloud.google.com/kubernetes-engine/docs/how-to/custom-org-policies#create-constraint" rel="noopener ugc nofollow" target="_blank"> <em class="lq">为GKE </em>定制组织策略</a></p><p id="2a4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ks" href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints" rel="noopener ugc nofollow" target="_blank"><em class="lq">GCP的组织政策</em> </a></p><p id="2fa2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ks" href="https://cloud.google.com/kubernetes-engine/docs/reference/rest/v1/projects.locations.clusters#resource:-cluster" rel="noopener ugc nofollow" target="_blank"> <em class="lq"> GKE集群对象和属性</em> </a></p></div></div>    
</body>
</html>