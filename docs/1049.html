<html>
<head>
<title>Google Trillian for Noobs (1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Trillian for Noobs (1)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-trillian-for-noobs-9b81547e9c4a?source=collection_archive---------1-----------------------#2019-06-28">https://medium.com/google-cloud/google-trillian-for-noobs-9b81547e9c4a?source=collection_archive---------1-----------------------#2019-06-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="44ff" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">失踪手册系列</h2></div><p id="9554" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">谷歌<a class="ae jt" href="http://github.com/google/trillian" rel="noopener ugc nofollow" target="_blank"> Trillian </a>提供了一个防篡改的仅附加日志(以及即将推出的日志支持地图)。它是一个开源项目，是<a class="ae jt" href="https://www.certificate-transparency.org/" rel="noopener ugc nofollow" target="_blank">证书透明</a>、<a class="ae jt" href="https://github.com/google/keytransparency" rel="noopener ugc nofollow" target="_blank">密钥透明</a>、Go团队的<a class="ae jt" href="https://proxy.golang.org" rel="noopener ugc nofollow" target="_blank"> Go模块镜像</a> ( <a class="ae jt" href="https://go.googlesource.com/proposal/+/master/design/25530-sumdb.md" rel="noopener ugc nofollow" target="_blank">提案</a>)以及一些尚未公开的应用的基础。</p><p id="2ae3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">(谷歌的)工程师们非常擅长构建精彩的技术，但在向我们这些凡人解释如何使用这些技术时，他们往往表现不佳！在一系列简短的帖子中，我将记录我在构建Trillian应用程序原型时的经历(Trillianeers称这些为“个性”)，原因有三:</p><ul class=""><li id="c3cb" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">通过解释澄清我的理解</li><li id="d425" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">帮助他人了解崔莉恩</li><li id="92b4" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">征求Trillian团队的反馈，以增进我的理解</li></ul><blockquote class="ki kj kk"><p id="615b" class="ix iy kl iz b ja jb ij jc jd je im jf km jh ji jj kn jl jm jn ko jp jq jr js hb bi translated">我是一名谷歌员工，但不是Trillian团队的成员。我正努力扮演外部开发人员的角色，帮助Trillian团队了解这种体验，并改进其文档、样本等。我试图让我与Trillian团队的大部分沟通保持公开:在团队的公共Google Group上和使用GitHub问题上。作为团队的潜在客户，我希望你能比我得到更多的关注；-)</p></blockquote><h2 id="b632" class="kp kq hi bd kr ks kt ku kv kw kx ky kz jg la lb lc jk ld le lf jo lg lh li lj bi translated">概述</h2><ol class=""><li id="da88" class="ju jv hi iz b ja lk jd ll jg lm jk ln jo lo js lp ka kb kc bi translated">在这篇文章中，我们将启动Trillian并向日志中添加数据</li><li id="ccee" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js lp ka kb kc bi translated">在下一篇文章中，我们将构建一个基本的gRPC客户机-服务器个性</li><li id="57a2" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js lp ka kb kc bi translated">也许是对样本进行四舍五入；信任客户；让我想想…</li></ol><h2 id="a336" class="kp kq hi bd kr ks kt ku kv kw kx ky kz jg la lb lc jk ld le lf jo lg lh li lj bi translated">入门指南</h2><p id="c974" class="pw-post-body-paragraph ix iy hi iz b ja lk ij jc jd ll im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated"><code class="du lt lu lv lw b"><a class="ae jt" href="https://github.com/google/trillian" rel="noopener ugc nofollow" target="_blank">https://github.com/google/trillian</a></code></p><p id="228f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Trillian团队从回购的自述文件开始提供文档。如果这些内容是你需要开始的水平，我建议你停止阅读这篇文章，继续下去。</p><p id="4cf5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果——像我一样——你的脑袋爆炸了，请继续阅读…</p><p id="5e88" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将使用4个不同的组件:</p><ol class=""><li id="4edd" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js lp ka kb kc bi translated">保存日志的数据库(MySQL|MariaDB)</li><li id="fb15" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js lp ka kb kc bi translated">我们与之互动的万亿级日志服务器</li><li id="51d5" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js lp ka kb kc bi translated">崔莉恩日志签名者</li><li id="508d" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js lp ka kb kc bi translated">我们的Trillian示例应用程序又名“personality”</li></ol><h2 id="314f" class="kp kq hi bd kr ks kt ku kv kw kx ky kz jg la lb lc jk ld le lf jo lg lh li lj bi translated">数据库ˌ资料库</h2><p id="0f3e" class="pw-post-body-paragraph ix iy hi iz b ja lk ij jc jd ll im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">让我们创建一个Docker卷来保存数据库:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="9a54" class="kp kq hi lw b fi mf mg l mh mi">docker volume create <strong class="lw hj">trillian-data</strong></span></pre><p id="c836" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行您首选的MySQL数据库:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="d838" class="kp kq hi lw b fi mf mg l mh mi">docker run \<br/>--name=database \<br/>--env=MYSQL_ALLOW_EMPTY_PASSWORD=yes \<br/>--mount=source=<strong class="lw hj">trillian-data</strong>,target=/var/lib/mysql \<br/>--publish=3306:3306 mariadb:10.4</span></pre><p id="14f5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在第二个shell中，连接到数据库引擎，使用用户<code class="du lt lu lv lw b">test</code>和密码<code class="du lt lu lv lw b">zaphod</code>创建数据库<code class="du lt lu lv lw b">test</code>。</p><blockquote class="ki kj kk"><p id="21be" class="ix iy kl iz b ja jb ij jc jd je im jf km jh ji jj kn jl jm jn ko jp jq jr js hb bi translated">崔莉恩是以《银河系漫游指南》中的一个角色命名的。<code class="du lt lu lv lw b">zaphod</code>是另一个角色的名字。</p></blockquote><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="cc92" class="kp kq hi lw b fi mf mg l mh mi">docker run \<br/>--interactive --tty \<br/><strong class="lw hj">--net=host</strong> \<br/>mariadb:10.4 \<br/>  sh -c 'exec mysql --host=127.0.0.1 --port=3306'</span></pre><p id="e545" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="0ea6" class="kp kq hi lw b fi mf mg l mh mi">drop database if exists test;<br/>create database test;<br/>create user if not exists test@'%' identified by 'zaphod';<br/>grant all on test.* to test@'%';</span></pre><p id="4503" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="ab5f" class="kp kq hi lw b fi mf mg l mh mi">docker run \<br/>--interactive --tty \<br/>--net=host \<br/>--volume=${PWD}/trillian.sql:/trillian.sql \<br/>  mariadb:10.4 sh -c 'exec mysql --host=127.0.0.1 --port=3306 --user=test --password=zaphod test &lt; /trillian.sql'</span></pre><p id="2d84" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是trillian.sql:</p><figure class="lx ly lz ma fd mj"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="4e57" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要确认一切恢复正常，请重新进入MySQL客户端并:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="65d9" class="kp kq hi lw b fi mf mg l mh mi">MariaDB [(none)]&gt; <strong class="lw hj">show databases</strong>;<br/>+--------------------+<br/>| Database           |<br/>+--------------------+<br/>| information_schema |<br/>| mysql              |<br/>| performance_schema |<br/>| <strong class="lw hj">test </strong>              |<br/>+--------------------+<br/>4 rows in set (0.001 sec)</span><span id="7dbc" class="kp kq hi lw b fi mm mg l mh mi">MariaDB [(none)]&gt; <strong class="lw hj">use test;</strong><br/>Reading table information for completion of table and column names<br/>You can turn off this feature to get a quicker startup with -A</span><span id="d627" class="kp kq hi lw b fi mm mg l mh mi">Database changed<br/>MariaDB [test]&gt; <strong class="lw hj">show tables</strong>;<br/>+-------------------+<br/>| Tables_in_test    |<br/>+-------------------+<br/>| LeafData          |<br/>| MapHead           |<br/>| MapLeaf           |<br/>| SequencedLeafData |<br/>| Subtree           |<br/>| TreeControl       |<br/>| TreeHead          |<br/>| Trees             |<br/>| Unsequenced       |<br/>+-------------------+<br/><strong class="lw hj">9 rows</strong> in set (0.001 sec)</span></pre><h2 id="166a" class="kp kq hi bd kr ks kt ku kv kw kx ky kz jg la lb lc jk ld le lf jo lg lh li lj bi translated">万亿服务器</h2><p id="58b2" class="pw-post-body-paragraph ix iy hi iz b ja lk ij jc jd ll im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">我们将使用Docker Compose作为可能最简单的方式来运行我们将需要的容器群组:数据库、Trillian日志服务器和Trillian日志签名器。下面的<code class="du lt lu lv lw b">docker-compose.yml</code>将为我们配置这3项服务:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="916e" class="kp kq hi lw b fi mf mg l mh mi">docker-compose --file=docker-compose.yml up</span></pre><figure class="lx ly lz ma fd mj"><div class="bz dy l di"><div class="mk ml l"/></div></figure><blockquote class="ki kj kk"><p id="4632" class="ix iy kl iz b ja jb ij jc jd je im jf km jh ji jj kn jl jm jn ko jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong> <code class="du lt lu lv lw b">adminer</code>包含在内纯粹是为了确认数据库建立正确。如果您在启动服务后浏览<code class="du lt lu lv lw b">localhost:8080</code>，您应该能够列出<code class="du lt lu lv lw b">test</code>数据库表:</p></blockquote><figure class="lx ly lz ma fd mj er es paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="er es mn"><img src="../Images/e7cfbf02119158594621981ce08d7f6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UQuRaODmDXCYjgWPR9sWag.png"/></div></div></figure><blockquote class="ki kj kk"><p id="e23a" class="ix iy kl iz b ja jb ij jc jd je im jf km jh ji jj kn jl jm jn ko jp jq jr js hb bi translated"><strong class="iz hj">NB</strong>Docker组合服务运行后，您可以使用<code class="du lt lu lv lw b">docker-compose ps</code>检查所有服务的状态，并使用<code class="du lt lu lv lw b">docker-compose logs...</code>和<code class="du lt lu lv lw b">trillian-log-server</code>检查单个服务的日志。</p></blockquote><p id="2c73" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Trillian服务公开了普罗米修斯度量端点。日志服务器的http端点是<code class="du lt lu lv lw b">:8091</code>，日志签名者的端点在<code class="du lt lu lv lw b">:8092</code>。所以，例如:</p><p id="cd20" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du lt lu lv lw b"><a class="ae jt" href="http://localhost:8091/metrics" rel="noopener ugc nofollow" target="_blank">http://localhost:8091/metrics</a></code></p><blockquote class="ki kj kk"><p id="109a" class="ix iy kl iz b ja jb ij jc jd je im jf km jh ji jj kn jl jm jn ko jp jq jr js hb bi translated">日志服务器和日志签名者连接到数据库服务。它们相互之间没有联系。</p></blockquote><h2 id="a41b" class="kp kq hi bd kr ks kt ku kv kw kx ky kz jg la lb lc jk ld le lf jo lg lh li lj bi translated">基本人格</h2><p id="8d4b" class="pw-post-body-paragraph ix iy hi iz b ja lk ij jc jd ll im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">Trillian服务支持gRPC。我们将使用Trillian的基本SDK，它是从服务的protobufs自动生成的，用来连接到日志服务器并在其中创建树叶。是的，我们在原木上创造树叶。我这么假设是因为我们实际上是在一棵Merkle树上创造树叶。</p><p id="9b01" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里有一个简单的(st？)Trillian日志服务器客户端:</p><figure class="lx ly lz ma fd mj"><div class="bz dy l di"><div class="mk ml l"/></div></figure><blockquote class="ki kj kk"><p id="6603" class="ix iy kl iz b ja jb ij jc jd je im jf km jh ji jj kn jl jm jn ko jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong>客户端里还有更多文件，就这个<code class="du lt lu lv lw b">main.go</code>。请整体克隆回购:<a class="ae jt" href="https://github.com/DazWilkin/simple-trillian-log-1" rel="noopener ugc nofollow" target="_blank">https://github.com/DazWilkin/simple-trillian-log-1</a></p></blockquote><p id="8fb4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">配置和运行步骤见下文。</p><p id="92e4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这些代码所做的就是连接到我们之前启动的Trillian日志服务器。它连接到您将在下一步中创建的特定日志。然后，我们创建一个任意的<code class="du lt lu lv lw b">Thing</code>类型，它将形成叶值(在日志的Merkle树中),并使用第二个任意类型<code class="du lt lu lv lw b">Extra</code>将(元数据)与每个叶值相关联，这将形成额外的数据。</p><p id="a9ad" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因为每个叶是唯一的散列，所以每个叶的值必须是唯一的。为了实现这些，我们简单地用当前日期时间作为<code class="du lt lu lv lw b">Thing</code>字符串值<code class="du lt lu lv lw b">"Thing"</code>的前缀。嗯，每秒钟都是独一无二的，所以不要尝试运行得太快:-)</p><p id="e261" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将这个叶值元组和额外数据添加到日志中。</p><p id="7b97" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，我们通过计算叶值的散列并查询日志来检索它。</p><p id="c27e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在运行示例之前，我们需要在Trillian日志服务器中创建一个日志:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="75e6" class="kp kq hi lw b fi mf mg l mh mi">go get -u github.com/google/trillian/cmd/createtree</span><span id="6b07" class="kp kq hi lw b fi mm mg l mh mi">RPCS=8090<br/>LOGID=$(\<br/>  go run github.com/google/trillian/cmd/createtree \<br/>  --admin_server=:${RPCS} \<br/>) &amp;&amp; echo ${LOGID}</span></pre><p id="7236" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">那么…请击鼓:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="a03f" class="kp kq hi lw b fi mf mg l mh mi">GO111MODULES=on \<br/>go get github.com/DazWilkin/simple-trillian-log-1</span><span id="46b3" class="kp kq hi lw b fi mm mg l mh mi">GO111MODULES=on \<br/>go run github.com/DazWilkin/simple-trillian-log-1 \<br/>--tlog_endpoint=:8090 \<br/>--tlog_id=${LOGID}</span></pre><p id="c5eb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您应该会看到:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="3a05" class="kp kq hi lw b fi mf mg l mh mi">[main] Establishing connection w/ Trillian Log Server [:8090]<br/>[main] Creating new Trillian Log Client<br/>[main] Creating Server using LogID [2709711571613439438]<br/>[server] Creating<br/>[main] Creating a 'Thing' and something 'Extra'<br/>[thing:new] Creating: [2019-06-28T11:56:13-07:00] Thing<br/>[extra] Creating<br/>[main] Submitting it for inclusion in the Trillian Log<br/>[server:put] Entered<br/>[thing:marshal] Marshaling: [2019-06-28T11:56:13-07:00] Thing<br/>[extra:marshal] Entered<br/>[server:put] ok<br/>[main:put] ok<br/>[main] Retrieving it from the Trillian Log<br/>[server:get] Entered<br/>[thing:marshal] Marshaling: [2019-06-28T11:56:13-07:00] Thing<br/>[server:get] hash: 02a1829d...<br/>[server:get] 0: [2019-06-28T11:56:13-07:00] Thing<br/>[main:get] ok</span></pre><h2 id="6634" class="kp kq hi bd kr ks kt ku kv kw kx ky kz jg la lb lc jk ld le lf jo lg lh li lj bi translated">拆卸</h2><p id="0b87" class="pw-post-body-paragraph ix iy hi iz b ja lk ij jc jd ll im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">客户端放置-获取，然后终止。</p><p id="6671" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以通过按住CTRL键来终止Docker合成服务。或者，您可以从您创建<code class="du lt lu lv lw b">docker-compose.yml</code>文件的目录中<code class="du lt lu lv lw b">docker-compose down</code>和<code class="du lt lu lv lw b">docker-compose rm</code>。</p><p id="ca58" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您希望删除包含万亿日志数据库的Docker卷，您可以<code class="du lt lu lv lw b">docker volume delete trillian-data</code>。</p><h2 id="9ea2" class="kp kq hi bd kr ks kt ku kv kw kx ky kz jg la lb lc jk ld le lf jo lg lh li lj bi translated">结论</h2><p id="10f1" class="pw-post-body-paragraph ix iy hi iz b ja lk ij jc jd ll im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">我希望这个故事能帮助其他人克服在使用谷歌Trillian形成的“我从哪里开始？”。正如我上面提到的，目的是帮助你开始，并帮助我确认我对Trillian的理解。</p><p id="44da" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在后续的故事中，我计划通过将客户机包装在gRPC服务器中并使用更复杂的<code class="du lt lu lv lw b">Thing</code>作为叶值来增强这个最简单的起点。</p></div></div>    
</body>
</html>