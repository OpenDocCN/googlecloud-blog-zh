<html>
<head>
<title>KubernetesPodOperator Examples</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">KubernetesPodOperator示例</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/load-xlsx-data-from-google-drive-and-load-it-to-bigquery-using-airflow-ce9bb6c1d93a?source=collection_archive---------2-----------------------#2020-04-13">https://medium.com/google-cloud/load-xlsx-data-from-google-drive-and-load-it-to-bigquery-using-airflow-ce9bb6c1d93a?source=collection_archive---------2-----------------------#2020-04-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8291" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当试图从Google Drive获取数据时，我发现了几个困难，问题主要在于为我们提供的凭据定义正确的范围。我要感谢我的同事<a class="jd je ge" href="https://medium.com/u/d36e998414a0?source=post_page-----ce9bb6c1d93a--------------------------------" rel="noopener" target="_blank">崇杰林</a>在这个方法上帮助了我。</p><p id="32ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以在这里，我们想分享一种利用气流完成工作的方法。</p><p id="e4d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我使用了3个不同的操作符。</p><ol class=""><li id="fb2a" class="jf jg hi ih b ii ij im in iq jh iu ji iy jj jc jk jl jm jn bi translated"><a class="ae jo" href="https://airflow.apache.org/docs/stable/kubernetes.html" rel="noopener ugc nofollow" target="_blank"> KubernetesPodOperator </a>，用于从Google Drive下载数据，进行数据转换，并将数据以CSV的形式上传到GCS。</li><li id="f9ef" class="jf jg hi ih b ii jp im jq iq jr iu js iy jt jc jk jl jm jn bi translated"><a class="ae jo" href="https://airflow.apache.org/docs/stable/_modules/airflow/contrib/sensors/gcs_sensor.html" rel="noopener ugc nofollow" target="_blank">GoogleCloudStorageObjectSensor</a>，用于检查文件是否已经存在于GCS中。</li><li id="c677" class="jf jg hi ih b ii jp im jq iq jr iu js iy jt jc jk jl jm jn bi translated"><a class="ae jo" href="https://airflow.apache.org/docs/stable/_modules/airflow/contrib/operators/gcs_to_bq.html" rel="noopener ugc nofollow" target="_blank">GoogleCloudStorageToBigQueryOperator</a>，用于将CSV格式的数据加载到Bigquery中。</li></ol><p id="de1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在使用KubernetesPodOperator之前，应该先创建一个Dockerimage。在Dockerimage内部，我们可以定义需要做的任何事情，并提供可以传递给dockerized代码的参数。</p><p id="d75e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">从Google Drive下载数据</strong></p><p id="5683" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本上，为了能够访问，你可以使用一个服务帐户。此外，我们只能根据文件的id来下载文件，因此，如果我们说您只知道文件名，那么您只能在知道id后才能下载它，这就是为什么我们需要通过执行搜索查询来找到它。要进一步了解这一点，您可以参考<a class="ae jo" href="https://developers.google.com/drive/api/v3/quickstart/python" rel="noopener ugc nofollow" target="_blank"> Python快速入门。</a></p><p id="1750" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本上有两种检索file_id的有用方法:<br/> (1)如果我们知道folder_id <br/>，则基于文件名(2)基于查询</p><p id="80ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用的以下方法是第二种方法。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="7211" class="kd ke hi jz b fi kf kg l kh ki">class Constants:<br/>    SERVICE_ACCOUNT_PATH = 'GOOGLE_APPLICATION_CREDENTIALS'<br/>    OAUTH_TOKEN_URI = '<a class="ae jo" href="https://www.googleapis.com/oauth2/v4/token'" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/oauth2/v4/token'</a></span><span id="8771" class="kd ke hi jz b fi kj kg l kh ki">class NoQueryResultsException(Exception):<br/>    """No Files matching query in Google Drive"""</span><span id="3c7d" class="kd ke hi jz b fi kj kg l kh ki">class GoogleSuiteApi:<br/>    def __init__(self):<br/>        self.service_account_credentials = self._service_account_credentials()<br/>        self.service = self._service_build()</span><span id="d37b" class="kd ke hi jz b fi kj kg l kh ki"># <a class="ae jo" href="https://stackoverflow.com/questions/49663359/how-to-upload-file-to-google-drive-with-service-account-credential" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/questions/49663359/how-to-upload-file-to-google-drive-with-service-account-credential</a><br/>    def _service_build(self):<br/>        service = build('drive', 'v3', credentials=self.service_account_credentials)<br/>        return service</span><span id="b368" class="kd ke hi jz b fi kj kg l kh ki"><a class="ae jo" href="http://twitter.com/staticmethod" rel="noopener ugc nofollow" target="_blank">@staticmethod</a><br/>    def _service_account_credentials():<br/>        service_account_key_path = os.getenv(<br/>            Constants.SERVICE_ACCOUNT_PATH)</span><span id="80bb" class="kd ke hi jz b fi kj kg l kh ki">credentials = service_account.Credentials.from_service_account_file(<br/>            service_account_key_path)<br/>        scoped_credentials = credentials.with_scopes(<br/>            [Constants.OAUTH_TOKEN_URI])<br/>        signer_email = scoped_credentials.service_account_email<br/>        signer = scoped_credentials.signer</span><span id="dbbd" class="kd ke hi jz b fi kj kg l kh ki">credentials = google.oauth2.service_account.Credentials(<br/>            signer,<br/>            signer_email,<br/>            token_uri=Constants.OAUTH_TOKEN_URI<br/>        )<br/>        return credentials</span><span id="e1b5" class="kd ke hi jz b fi kj kg l kh ki">def get_metadata(self, folder_id):<br/>        query = &lt;whatever-your-query-is&gt;<br/>        try:<br/>            get_files = self.service.files().list(q=query,<br/>                          orderBy='modifiedTime desc',<br/>                          pageSize=1).execute().get('files')<br/>        except errors.HttpError as e:<br/>            print ('An error occurred: %s' % e)</span><span id="39d9" class="kd ke hi jz b fi kj kg l kh ki">        if len(get_files) == 0:<br/>            raise NoQueryResultsException(<br/>                'No files in Google Drive matching query {query}'.format(query=query))</span><span id="57f2" class="kd ke hi jz b fi kj kg l kh ki">get_files.sort(key=lambda x: x['name'], reverse=True)</span><span id="bef2" class="kd ke hi jz b fi kj kg l kh ki">        print(get_files[0])<br/>        return get_files[0]</span><span id="af9c" class="kd ke hi jz b fi kj kg l kh ki">def download_google_document_from_drive(self, file_id,<br/>        export_mime_type=None):<br/>        """<br/>        file_id          :  Google Drive fileId<br/>        export_mime_type :  To be provided if target file is a Google Drive native file.<br/>                            Otherwise, leave it as None<br/>        """<br/>        try:<br/>            if export_mime_type is None:<br/>                request = self.service.files().get_media(fileId=file_id)<br/>            else:<br/>                request = self.service.files().export_media(fileId=file_id,<br/>                                                            mimeType=export_mime_type)<br/>            fh = io.BytesIO()<br/>            downloader = MediaIoBaseDownload(fh, request)<br/>            done = False<br/>            while done is False:<br/>                status, done = downloader.next_chunk()<br/>                print('Download %d%%.' % int(status.progress() * 100))<br/>            return fh<br/>        except Exception as e:<br/>            print('Error downloading file from Google Drive: %s' % e)</span></pre><p id="0fab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">数据处理</strong></p><p id="80aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获得所需的文件后，您可以通过首先将xlsx数据转换为pandas来执行处理，并执行必要的join或任何其他操作。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="cea1" class="kd ke hi jz b fi kf kg l kh ki"><em class="kk">import </em>xlrd<br/><em class="kk">import </em>pandas <em class="kk">as </em>pd</span><span id="7c57" class="kd ke hi jz b fi kj kg l kh ki"><em class="kk">def </em>convert_xls_to_pandas(file_stream, sheet_name, column_mapping,<br/>    column_types):<br/>    workbook = xlrd.open_workbook(file_contents=file_stream.getvalue())<br/>    df = pd.read_excel(workbook, sheet_name=sheet_name,<br/>                       engine=xlrd)<br/>    df = (df.loc[:, column_mapping.keys()]<br/>          .copy()<br/>          .rename(columns=column_mapping)<br/>          .astype(column_types)<br/>          )<br/>    <em class="kk">return </em>df</span></pre><p id="04e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，在转换为pandas时，您还可以为名称和数据类型定义列映射。之后你可以将熊猫转换成csv。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="6dc3" class="kd ke hi jz b fi kf kg l kh ki"><em class="kk">def </em>convert_pandas_to_csv(df, csv_name):<br/>    df.to_csv(csv_name, index=<em class="kk">False</em>, header=<em class="kk">True</em>)</span></pre><p id="575f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">上传数据到GCS </strong></p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="1ba0" class="kd ke hi jz b fi kf kg l kh ki"><em class="kk">import </em>google.auth<br/><em class="kk">from </em>google.cloud <em class="kk">import </em>storage</span><span id="547b" class="kd ke hi jz b fi kj kg l kh ki"><em class="kk">def </em>upload_file_to_gcs(bucket, input_filepath, output_filename):<br/>    credentials, project = google.auth.default()<br/>    <em class="kk">if </em>credentials.requires_scopes:<br/>        credentials = credentials.with_scopes(<br/>            ['https://www.googleapis.com/auth/devstorage.read_write'])<br/>    client = storage.Client(credentials=credentials, project=project)<br/><br/>    <em class="kk">try</em>:<br/>        <em class="kk">try</em>:<br/>            bucket = client.get_bucket(bucket)<br/>        <em class="kk">except</em>:<br/>            bucket = client.create_bucket(bucket, project=project)<br/>        blob = bucket.blob(output_filename)<br/>        blob.upload_from_filename(input_filepath)<br/>        <em class="kk">print</em>('Upload to GCS complete')<br/>    <em class="kk">except </em>Exception <em class="kk">as </em>e:<br/>        <em class="kk">print</em>('An error occurred: %s' % e)<br/><br/>    <em class="kk">return None</em></span></pre><p id="55fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了能够获得访问权，您需要设置<code class="du kl km kn jz b">GOOGLE_APPLICATION_CREDENTIALS</code>环境变量，以及编写必要的<a class="ae jo" href="https://cloud.google.com/storage/docs/authentication" rel="noopener ugc nofollow" target="_blank">范围</a>。</p><p id="773c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后，您可以创建一个带有特定<code class="du kl km kn jz b">ENTRYPOINT</code>的Dockerimage，使您能够传递一些参数。</p><p id="7cce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">编写气流脚本</strong></p><p id="7aa0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，根据文档，定义一个秘密会自动将该秘密装载到您定义的某个路径中。但是，您也可以将它定义为一个环境变量，而不是将它作为一个卷来挂载。有关更多信息，您可以参考此<a class="ae jo" href="https://github.com/GoogleCloudPlatform/python-docs-samples/blob/master/composer/workflows/kubernetes_pod_operator.py" rel="noopener ugc nofollow" target="_blank">示例</a>。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="6166" class="kd ke hi jz b fi kf kg l kh ki">from airflow.contrib.operators.kubernetes_pod_operator import \<br/>    KubernetesPodOperator<br/>from airflow.contrib.kubernetes.secret import Secret</span><span id="422e" class="kd ke hi jz b fi kj kg l kh ki">svc_acc = Secret('volume', '&lt;path-to-mount-your-service-account&gt;', '&lt;secret-where-you-save-your-service-account&gt;',<br/>                         '&lt;your-service-account-name&gt;')<br/>environments = {<br/>    'GOOGLE_APPLICATION_CREDENTIALS': Constants.GOOGLE_APPLICATION_CREDENTIALS}<br/>xlsx_processing = KubernetesPodOperator(<br/>    task_id='&lt;your-task-id-name&gt;',<br/>    image=&lt;your-docker-image&gt;,<br/>    namespace='&lt;your-namespace&gt;',<br/>    name='&lt;your-k8s-job-name&gt;',<br/>    image_pull_policy='Always',<br/>    is_delete_operator_pod=True,<br/>    arguments=[<br/>        &lt;your-args&gt;<br/>    ],<br/>    secrets=[svc_acc],<br/>    env_vars=environments<br/>)</span></pre><p id="6688" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以将项目的下游设置为<code class="du kl km kn jz b">GoogleCloudStorageObjectSensor</code>。然后把下游设定成<code class="du kl km kn jz b">GoogleCloudStorageToBigQueryOperator</code>。这里我将给出一个例子，如果你想基于给定的模式而不是<code class="du kl km kn jz b">autodetect</code>加载数据。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="96c4" class="kd ke hi jz b fi kf kg l kh ki">gcs_to_bq_task = GoogleCloudStorageToBigQueryOperator(<br/>    task_id=&lt;your-task-name&gt;,<br/>    bucket=&lt;your-bucket&gt;,<br/>    source_objects=[<br/>        &lt;your-file-path&gt;<br/>    ],<br/>    destination_project_dataset_table=&lt;your-table-name&gt;,<br/>    schema_fields=&lt;your-schema&gt;,<br/>    skip_leading_rows=1, #skip the header<br/>    source_format='CSV',<br/>    write_disposition='WRITE_TRUNCATE',<br/>    google_cloud_storage_conn_id=&lt;your-connection&gt;,<br/>    bigquery_conn_id=&lt;your-connection&gt;,<br/>    autodetect=False #This is because you're using your own schema<br/>)</span></pre><p id="69b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以用以下格式定义您的模式:</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="67fe" class="kd ke hi jz b fi kf kg l kh ki">sample_schema = [<br/>        {'name': '&lt;column-name&gt;', 'type': '&lt;bq-data-type&gt;', 'mode': '&lt;mode, can be REQUIRED or NULLABLE&gt;'},<br/>]</span></pre><p id="7460" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于可用数据类型的更多解释，您可以参考第<a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types" rel="noopener ugc nofollow" target="_blank">页</a>。</p><p id="601d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最重要的是确保你的气流进入你的集装箱登记处。此外，如果您定义自己的<code class="du kl km kn jz b">ConfigMap</code>或<code class="du kl km kn jz b">Secret</code>，您可以在您的气流中创建它们，如果您在Kubernetes上运行您的气流，这也会容易得多。我想就这些了..希望有帮助！</p></div></div>    
</body>
</html>