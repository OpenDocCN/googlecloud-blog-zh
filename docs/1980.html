<html>
<head>
<title>Centralised audit logs in GCP in a secure environment with VPC Service Controls</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在VPC服务控制的安全环境中，在GCP集中审计日志</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/centralised-audit-logs-in-gcp-in-a-secure-environment-with-vpc-service-controls-5a25cd00441?source=collection_archive---------0-----------------------#2021-10-11">https://medium.com/google-cloud/centralised-audit-logs-in-gcp-in-a-secure-environment-with-vpc-service-controls-5a25cd00441?source=collection_archive---------0-----------------------#2021-10-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1cab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">理论上，建立GCP伐木汇相对容易。实际上，一旦涉及到VPC服务控制，您会突然发现自己被所有“如何做”的教程拒之门外——它们很可能不适合您的安全设置。</strong></p><p id="38ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是有希望:)</p><p id="2c72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">更新2023:</em></strong><em class="jd">GCP有了一种从集中日志中获取洞察的新方法——日志分析！在</em> <a class="ae je" rel="noopener" href="/google-cloud/centralised-audit-logs-in-google-cloud-the-new-way-log-analytics-4b8a1fb195e"> <em class="jd">这篇文章</em> </a> <em class="jd">里读到了关于它的一切。</em></p><p id="eb4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，您将了解如何在拥有VPC服务控件的组织中设置聚合日志，并找到一个<a class="ae je" href="https://github.com/ngodec/terraform-gcp-audited-folder" rel="noopener ugc nofollow" target="_blank"> Terraform模块</a>，它可以让您自动设置自己的Google云基础架构。</p><p id="9873" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们了解一下基础知识:什么是GCP审计日志记录、集中式日志记录和日志接收器。</p><p id="73c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" href="https://cloud.google.com/logging/docs/audit" rel="noopener ugc nofollow" target="_blank">审计日志</a>是一项服务，记录您的云资源中与管理活动事件、数据访问、系统事件和策略违规相对应的API调用。这是为了监控云中的活动而需要保存的数据:<strong class="ih hj">谁在什么时候做了什么</strong>。当您想要集中存储这些日志时，GCP为您提供了一种易于配置的路由日志的方式，称为<a class="ae je" href="https://cloud.google.com/logging/docs/routing/overview" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">日志接收器</strong> </a>。</p><p id="6971" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了获取日志，您需要执行以下操作:</p><p id="00c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1)在您的项目中启用审计(我们更喜欢将其设置为<code class="du jf jg jh ji b">ALL_SERVICES</code>)</p><p id="8ee0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2)创建日志接收器，将日志发送到<a class="ae je" href="https://cloud.google.com/logging/docs/routing/overview#destinations" rel="noopener ugc nofollow" target="_blank">选择的存储解决方案</a></p><p id="e872" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在四个级别配置日志接收器:</p><ol class=""><li id="528d" class="jj jk hi ih b ii ij im in iq jl iu jm iy jn jc jo jp jq jr bi translated">项目</li><li id="dc3b" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">文件夹</li><li id="06ce" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">组织</li><li id="6283" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">账单账户</li></ol><p id="f796" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个接收器类型捕获其资源(项目/文件夹/组织/计费帐户)内的所有日志，加上来自所有子项目(文件夹和项目)的日志，如果您将特殊标志<code class="du jf jg jh ji b">include_children</code>设置为true。</p><h1 id="874b" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">组织要求</h1><p id="32ac" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">现在让我们讨论一下我们公司内部对审计日志及其收集的需求。这些反映了一般的架构选择，以及我们必须遵守的法规要求:</p><ul class=""><li id="7578" class="jj jk hi ih b ii ij im in iq jl iu jm iy jn jc la jp jq jr bi translated">所有审计日志必须集中存储在<strong class="ih hj">一个独立的GCP项目</strong></li><li id="03fb" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated">日志包含敏感数据，如电子邮件和IP地址，因此需要使用<a class="ae je" href="https://cloud.google.com/vpc-service-controls/docs/overview" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> VPC服务边界</strong> </a>进行保护</li><li id="02a7" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated">存储:用于分析的<strong class="ih hj"> BigQuery </strong>和用于长期存储的<strong class="ih hj"> GCS </strong></li><li id="d2dd" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated">来自不同<strong class="ih hj">环境</strong>的日志:开发、阶段、生产和<strong class="ih hj">位置</strong>:英国、美国、加拿大—<strong class="ih hj"/>必须分开存储</li><li id="9c17" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated">我们不需要存储Kubernetes和Cloud Composer日志，也不需要存储来自我们的安全扫描软件的日志</li></ul><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lb"><img src="../Images/8dabf94446e408835cd1f3b7313e66d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BNFO_T5wyQBxR-V4Uuu5hA.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">一个具有多个环境、GCP项目、VPC服务边界和在一个中心位置审计日志的要求的组织的代表性方案</figcaption></figure><h1 id="77fc" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">挑战</h1><p id="d80a" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">我们在GCP的大部分项目都位于VPC服务区内；但不是全部。例如，开发项目，或者用于地图和翻译API的项目，不包含敏感数据，并且不需要在边界内。我们限制的API包括:</p><pre class="lc ld le lf fd lr ji ls lt aw lu bi"><span id="ffa4" class="lv jy hi ji b fi lw lx l ly lz">BigQuery<br/>Storage<br/>Logging<br/>Containers</span></pre><p id="c402" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这造成了一个挑战，因为我们的项目和审计日志项目(本身在一个单独的边界中)之间的数据流被阻塞，除非我们在它们之间建立服务边界桥。在第一次尝试中，我们选择的正是这个:项目记录汇和桥。</p><p id="da77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，<strong class="ih hj">并没有起作用</strong>:因为不在服务边界内的项目不能被添加到桥中，所以没有办法用边界日志接收器连接非边界项目。</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es ma"><img src="../Images/d2e45321683c08dd4ab1ba96c0eb7a9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FePWuMb-jlpSIIw60fCNJg.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">一封错误邮件，由Google友好地发送给我们云管理员组的每一个人👀注意:出于说明和隐私目的，内容已被修改</figcaption></figure><p id="27d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样的设置也带来了安全风险:比如说，你在一个边界中有项目A和B，在另一个边界中有项目C和D；他们不能互相交流。在使用审计日志边界创建网桥时，很容易发现这一点，并将所有A、B、C和D添加到一个网桥中，从而允许通信。</p><figure class="lc ld le lf fd lg er es paragraph-image"><div class="er es mb"><img src="../Images/3cd8c1f23d6e4283ab4d8feaf4a1e4b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:952/1*PnVyDmo_jy5aABPAQ9TUjA.gif"/></div></figure><h1 id="7b67" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">解决方案</h1><p id="efb0" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">2021年2月，谷歌发布了VPC服务控制套件的一个奇妙特性:<a class="ae je" href="https://cloud.google.com/vpc-service-controls/docs/ingress-egress-rules" rel="noopener ugc nofollow" target="_blank">入口和出口规则</a>。这允许您指定规则，在这些规则下，允许对受限服务的API调用穿越外围边界。这些规则扩展了现有的访问级别功能，在Terraform中可用，其中一个记录在案的用例是<a class="ae je" href="https://cloud.google.com/vpc-service-controls/docs/secure-data-exchange#allow_projects_from_multiple_perimeters_to_share_logs_in_a_separate_perimeter" rel="noopener ugc nofollow" target="_blank">集中伐木</a>！</p><p id="4f9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它是这样工作的:</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mc"><img src="../Images/c41beb9ba9bbe8b8414fbf1442fee8c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_guhLIuS7atch3PBp0mTFQ.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">该图说明了不同VPC SC边界之间的日志记录接收器，使用允许日志进入日志记录SP的访问级别和允许日志退出原始SP的出口规则的组合</figcaption></figure><p id="a2dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你有一个常规的项目A，在一个服务区内有一个测井槽；和一个日志记录项目，内部服务边界LSP。</p><p id="c763" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">为了实现两者之间的通信，您将:</strong></p><ol class=""><li id="9fe6" class="jj jk hi ih b ii ij im in iq jl iu jm iy jn jc jo jp jq jr bi translated">允许<em class="jd">日志</em>(以及存储/bigquery，如果你在那里写的话)API调用<em class="jd">出口</em>VPC SC服务边界<em class="jd">起点</em>带有<strong class="ih hj">出口策略</strong></li><li id="0356" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">允许记录接收器写入者身份为<em class="jd">输入</em>具有<strong class="ih hj">访问级别</strong>的<em class="jd">记录</em>服务边界</li></ol><p id="0765" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是当您想要将日志记录接收器设置为BigQuery和Storage时出口策略的样子，日志记录项目编号为<code class="du jf jg jh ji b">12345678</code>:</p><pre class="lc ld le lf fd lr ji ls lt aw lu bi"><span id="f41b" class="lv jy hi ji b fi lw lx l ly lz">egressPolicies:<br/> — egressFrom:<br/>   identityType: ANY_SERVICE_ACCOUNT<br/> egressTo:<br/>   operations:<br/>   — methodSelectors:<br/>     — method: '*'<br/>     serviceName: bigquery.googleapis.com<br/>   — methodSelectors:<br/>     — method: '*'<br/>     serviceName: logging.googleapis.com<br/>   — methodSelectors:<br/>     — method: '*'<br/>     serviceName: storage.googleapis.com<br/>   resources:<br/>   — projects/12345678</span></pre><p id="d37f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">注意:在撰写本文时，BigQuery不支持特定于方法的出口规则限制。</em></p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es md"><img src="../Images/561d1c0603c1d387bad8028972dab965.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uQg1D4LhZM79SwMHVNXFWA.jpeg"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">服务边界上的出口策略的逻辑A:仅当日志由服务帐户签名、被写入BigQuery或GCS并被发送到GCP项目#12345678时，才允许它们离开边界</figcaption></figure><p id="ff3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您没有使用Terraform，您可以通过将上面的策略保存到<code class="du jf jg jh ji b">logsegress.yaml</code>并运行以下命令来应用它:</p><pre class="lc ld le lf fd lr ji ls lt aw lu bi"><span id="5794" class="lv jy hi ji b fi lw lx l ly lz">gcloud beta access-context-manager perimeters update $SERVICE_PERIMETER_NAME --set-egress-policies=logsegress.yaml</span></pre><p id="ed75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们一会儿将通过地形设置。</p><p id="1429" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于允许日志接收器的写标识将数据写入日志项目的访问级别，我们只需列出相关日志接收器的标识作为访问级别的成员:</p><pre class="lc ld le lf fd lr ji ls lt aw lu bi"><span id="6287" class="lv jy hi ji b fi lw lx l ly lz">echo "- members:<br/>    - serviceAccount:f123456345-09876@gcp-sa-logging.iam.gserviceaccount.com<br/>    - serviceAccount:f0987654345-2345@gcp-sa-logging.iam.gserviceaccount.com" &gt; CONDITIONS.yaml<br/>  </span><span id="5689" class="lv jy hi ji b fi me lx l ly lz">gcloud access-context-manager levels create logging_al \<br/>   --title logging_al \<br/>   --basic-level-spec CONDITIONS.yaml \<br/>   --combine-function=OR \<br/>   --policy=0987654321</span></pre><p id="55f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，服务帐户电子邮件是由GCP自动生成的，我们将真正受益于Terraform自动化这一步骤的能力。</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mf"><img src="../Images/86f303a022ce1809b37cc5ffac36eb1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zwV5-DNXQ--ZttajUkQz0w.jpeg"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">当我们在上面的图表中添加一个访问级别时，我们得到了一个额外的检查，允许数据进入日志服务边界</figcaption></figure><h1 id="722c" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">让我们从整个组织获取日志</h1><p id="3260" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">以下是建议的设计:</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mg"><img src="../Images/6d09d5e7543f2adcd9bbb201e8832134.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mR78oaf392DlHomfHTxh5Q.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">在组织级别上创建2个日志记录接收器将是最干净的解决方案:2个带有仔细校准的过滤器的接收器、2个服务帐户、2个要管理的访问级别</figcaption></figure><p id="5076" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在组织级别创建两个日志接收器是最干净的解决方案:</p><ul class=""><li id="123d" class="jj jk hi ih b ii ij im in iq jl iu jm iy jn jc la jp jq jr bi translated">2个水槽，配有精心校准的过滤器</li><li id="4ddb" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated">2个服务帐户</li><li id="97e3" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated">2个访问级别</li><li id="1333" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated">其他周界各有一个出口政策。</li></ul><p id="864f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您有一个一致的方法将项目过滤为生产和非生产，这就足够简单了。但是如果你没有呢？</p><p id="cebe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者您需要将日志分成更细粒度的数据集，如“环境-位置”或“部门”？</p><h2 id="ac1f" class="lv jy hi bd jz mh mi mj kd mk ml mm kh iq mn mo kl iu mp mq kp iy mr ms kt mt bi translated">输入文件夹</h2><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mu"><img src="../Images/ae81a75c8fdfa14a086566a6732cb969.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7jDU-j3ZcZv9yarFBdqsuA.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">GCP文件夹、文件夹登录接收器、VPC SC访问级别和集中登录项目</figcaption></figure><p id="6bc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里的想法是创建顶级文件夹来表示您需要的环境(和日志)的粒度；为每个文件夹创建一个文件夹日志接收器；并在您的组织中强制执行一个策略，规定项目只能在这些顶层文件夹中的一个下创建！</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mv"><img src="../Images/6a08a9a334c4bea6c56ba7418a1e628f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kvOEFDFfrLF_ckAu-crYBg.jpeg"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">一个Google云组织的集中式日志设置的架构图，带有一个示例Prod UK环境</figcaption></figure><h1 id="977e" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">使用terraform实现it自动化</h1><p id="4863" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">本节描述了创建文件夹和记录接收器的设置，并假设您熟悉terraform，并且正在使用0.13+版。</p><p id="aa76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了自动设置跨边界日志接收器所需的一切，我们需要一个模块来创建:</p><ul class=""><li id="ea8d" class="jj jk hi ih b ii ij im in iq jl iu jm iy jn jc la jp jq jr bi translated">一个文件夹</li><li id="d081" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated">伐木水槽</li><li id="1100" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated">必要的IAM权限</li><li id="e096" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated">必要的<a class="ae je" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/access_context_manager_access_level_condition" rel="noopener ugc nofollow" target="_blank">访问级别条件</a></li></ul><p id="c03f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是完整的模块供您使用:<a class="ae je" href="https://github.com/ngodec/terraform-gcp-audited-folder" rel="noopener ugc nofollow" target="_blank">terra form-GCP-audited-folder</a></p><p id="775f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本模块假设您已经决定了哪个GCP项目将托管您的聚合日志(您的<code class="du jf jg jh ji b">logging project</code>)，创建了一个BigQuery数据集或一个GCS存储桶来将日志流式传输到其中，并且有一个VPC服务边界，其访问级别保护您的日志记录项目。</p><p id="e213" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于每个文件夹，您需要提供以下输入:</p><ul class=""><li id="7a48" class="jj jk hi ih b ii ij im in iq jl iu jm iy jn jc la jp jq jr bi translated"><code class="du jf jg jh ji b">folder_name</code></li><li id="3ab3" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated"><code class="du jf jg jh ji b">parent_id</code>格式<code class="du jf jg jh ji b">folder/12345</code>或<code class="du jf jg jh ji b">organization/6789</code></li><li id="cd7f" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated"><code class="du jf jg jh ji b">logging_project_id</code></li><li id="b339" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated">BigQuery和/或云存储的目标日志配置:数据集/存储桶名称、可选的<a class="ae je" href="https://cloud.google.com/logging/docs/routing/overview#inclusion-filters" rel="noopener ugc nofollow" target="_blank">日志过滤器</a>和可选的<a class="ae je" href="https://cloud.google.com/logging/docs/routing/overview#exclusions" rel="noopener ugc nofollow" target="_blank">排除项</a></li><li id="8637" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc la jp jq jr bi translated">格式<code class="du jf jg jh ji b">accessPolicies/${org_access_policy_number}/accessLevels/${access_level_name}</code>中的<code class="du jf jg jh ji b">logging_access_level_name</code></li></ul><pre class="lc ld le lf fd lr ji ls lt aw lu bi"><span id="f80e" class="lv jy hi ji b fi lw lx l ly lz">module "folder" {<br/>  source = "git@github.com:ngodec/terraform-gcp-audited-folder.git"<br/>  folder_name = "My Folder"<br/>  parent_id = "folders/123456"<br/>  logging_project_id = "audit-logs-prod"<br/>  bigquery_logging_sink = {<br/>      dataset_id = "logs"<br/>      filter = ""<br/>      exclusions = []<br/>    }<br/>  logging_access_level_name = "accessPolicies/123456/accessLevels/logs-access-level"<br/>}</span></pre><p id="4130" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以跳过日志变量，只提供文件夹名称和父文件夹，在这种情况下，模块将只创建文件夹，而不创建日志接收器。这样，您就可以使用同一个模块来管理所有文件夹，而不仅仅是顶级文件夹:</p><pre class="lc ld le lf fd lr ji ls lt aw lu bi"><span id="995b" class="lv jy hi ji b fi lw lx l ly lz">module "folder" {<br/>  source = "git@github.com:ngodec/terraform-gcp-audited-folder.git"<br/>  name = "My Folder"<br/>  parent = "folders/123456"<br/>}</span></pre><p id="b4a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您在审计文件夹中创建的所有项目都将把它们的日志传送到您选择的目的地。我喜欢使用BigQuery作为我的日志目的地——它可以实现一些很酷的东西，比如威胁分析和Bigquery使用仪表板，就像这样(所有数字都是随机生成的):</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mw"><img src="../Images/7b2fe0be8c5b801c86e3bb2dc25a7e45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P2U6wfkgq2s1iawhpiadWw.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">基于审计日志数据构建的BigQuery使用情况仪表板。这里所有的数字都是随机生成的</figcaption></figure><p id="ede4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">唷。安全会让事情变得很复杂，对吧？工程学的美妙之处在于为最复杂的问题找到优雅的解决方案。</p><p id="a635" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你有什么问题吗？不要犹豫，在下面发表评论或在<a class="ae je" href="https://twitter.com/ouvessvit" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上@我。</p></div></div>    
</body>
</html>