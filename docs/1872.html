<html>
<head>
<title>Dear Keys, are you still alive ?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">亲爱的Keys，你还活着吗？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/dear-keys-are-you-still-alive-ad7c73ce63b9?source=collection_archive---------4-----------------------#2021-05-04">https://medium.com/google-cloud/dear-keys-are-you-still-alive-ad7c73ce63b9?source=collection_archive---------4-----------------------#2021-05-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/9e567080a476ef72821312583274ee0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/format:webp/1*LC0r1LvfSuNnvMQ_LvQYow.png"/></div></figure><p id="9505" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi jk translated">几年前，我做了一个梦。当时，我的公司向我询问有关谷歌云服务账户密钥使用的详细信息，而我当时没有任何可用信息。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="94f2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">虽然现在这种情况已经改变，但最重要的是要记住，您应该:</p><h1 id="224d" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">"仅在适当的情况下使用服务帐户密钥文件"</h1><p id="bc56" class="pw-post-body-paragraph im in hi io b ip ky ir is it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj hb bi translated">好的，你知道服务帐户必须只在适当的时候使用，对于服务帐户密钥来说更是如此，请查看Google官方博客:</p><p id="d620" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae ld" href="https://cloud.google.com/blog/products/identity-security/how-to-authenticate-service-accounts-to-help-keep-applications-secure" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/blog/products/identity-security/how-to-authenticate-service-accounts-to-help-keep-applications-secure</a></p><p id="2649" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">密钥的问题在于它的生命周期——我们知道建议轮换它们，只在强制时使用它们，不使用时删除它们…</p><p id="d1a6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在我以前的公司，我们有2000个服务帐户和5000多个密钥，清理这些密钥是不可能的，因为我们不知道哪些已经在使用。</p><p id="9d2b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">所以现在我的目标是能够知道我创造的每一把钥匙:</p><ul class=""><li id="b10b" class="le lf hi io b ip iq it iu ix lg jb lh jf li jj lj lk ll lm bi translated">它还活着吗？</li><li id="cb74" class="le lf hi io b ip ln it lo ix lp jb lq jf lr jj lj lk ll lm bi translated">用过几次了？</li></ul><p id="1fcc" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我希望这能帮我清理没用过的钥匙。</p><div class="ls lt ez fb lu lv"><a href="https://cloud.google.com/iam/docs/service-account-monitoring" rel="noopener  ugc nofollow" target="_blank"><div class="lw ab dw"><div class="lx ab ly cl cj lz"><h2 class="bd hj fi z dy ma ea eb mb ed ef hh bi translated">监控服务帐户和密钥的使用情况</h2><div class="mc l"><h3 class="bd b fi z dy ma ea eb mb ed ef dx translated">本页解释了如何使用云监控来检查您的服务帐户和服务帐户密钥何时被使用…</h3></div><div class="md l"><p class="bd b fp z dy ma ea eb mb ed ef dx translated">cloud.google.com</p></div></div><div class="me l"><div class="mf l mg mh mi me mj ik lv"/></div></div></a></div><h2 id="095b" class="mk kb hi bd kc ml mm mn kg mo mp mq kk ix mr ms ko jb mt mu ks jf mv mw kw mx bi translated">文档显示我可以通过云运营指标显示我的密钥信息</h2><figure class="mz na nb nc fd ij er es paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="er es my"><img src="../Images/9e9433257a000949916631aa519e36a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PEJlSbG6eFCtezA-NLk4zQ.png"/></div></div></figure><p id="e9d8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">虽然这很有帮助，但对我来说还不够:</p><ul class=""><li id="ff6c" class="le lf hi io b ip iq it iu ix lg jb lh jf li jj lj lk ll lm bi translated"><strong class="io hj">因为</strong>我有许多来自不同项目的关键字，而指标页面对我来说太小了</li><li id="fbf0" class="le lf hi io b ip ln it lo ix lp jb lq jf lr jj lj lk ll lm bi translated"><strong class="io hj">因为</strong>指标页面只显示<code class="du nh ni nj nk b">Key_Id</code>，不显示服务账户或项目</li><li id="8fd3" class="le lf hi io b ip ln it lo ix lp jb lq jf lr jj lj lk ll lm bi translated"><strong class="io hj">因为</strong>我无法与我的老板分享指标页面</li><li id="983b" class="le lf hi io b ip ln it lo ix lp jb lq jf lr jj lj lk ll lm bi translated">因为这太专业了</li></ul><h2 id="c77a" class="mk kb hi bd kc ml mm mn kg mo mp mq kk ix mr ms ko jb mt mu ks jf mv mw kw mx bi translated">所以，我正在做的是:</h2><figure class="mz na nb nc fd ij er es paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="er es nl"><img src="../Images/02790b4b28f2ce525eb14b162cc6eaed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*koeJlT92wVYYbQcfzWYLJw.jpeg"/></div></div><figcaption class="nm nn et er es no np bd b be z dx translated">服务帐户密钥监控</figcaption></figure><p id="ec3b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="nq">操作被分割到不同的云功能中，以尽可能保持简单，并避免超时或配额问题。可伸缩性很重要。</em></p><p id="bff9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="nq"> **我将只关注API调用，而不是全局架构。你可以在谷歌文档中找到如何触发、调用发布/订阅等……* *</em></p><p id="6062" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">每日云调度程序作业将触发云函数，通过使用<strong class="io hj">发现方法</strong>调用<strong class="io hj">resource Manager API v1</strong>来解析我的所有GCP项目:</p><pre class="mz na nb nc fd nr nk ns nt aw nu bi"><span id="3804" class="mk kb hi nk b fi nv nw l nx ny">import google.auth</span><span id="0480" class="mk kb hi nk b fi nz nw l nx ny">from googleapiclient import discovery  <br/></span><span id="9a79" class="mk kb hi nk b fi nz nw l nx ny">credentials, project = google.auth.default(</span><span id="e6f7" class="mk kb hi nk b fi nz nw l nx ny">scopes=['https://www.googleapis.com/auth/cloud-platform'])</span><span id="e771" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj"><br/>ressourceManagerClient = </strong>discovery.build('cloudresourcemanager', 'v1', credentials=credentials)</span><span id="1a07" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">projects_list</strong> = <strong class="nk hj">ressourceManagerClient</strong>.projects().list().execute()</span><span id="564b" class="mk kb hi nk b fi nz nw l nx ny">for project in projects_list['projects']<br/>    <strong class="nk hj">project_id = project['projectId']</strong></span></pre><p id="c7d1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，对于每个项目，使用<strong class="io hj"> IAM API v1 </strong>调用一个云函数来获取项目的服务帐户列表以及每个项目的已创建密钥列表。谷歌文档说:</p><p id="3695" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="nq"/><code class="du nh ni nj nk b"><a class="ae ld" href="https://cloud.google.com/iam/docs/reference/rest/v1/projects.serviceAccounts.keys/list" rel="noopener ugc nofollow" target="_blank"><em class="nq">projects.serviceAccounts.keys.list</em></a></code><em class="nq">方法列出了一个服务帐户的所有服务帐户密钥。</em></p><p id="f60a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="nq">在使用下面的任何请求数据之前，请传递以下参数:</em></p><ul class=""><li id="3c10" class="le lf hi io b ip iq it iu ix lg jb lh jf li jj lj lk ll lm bi translated"><code class="du nh ni nj nk b"><em class="nq">PROJECT_ID</em></code> <em class="nq">:您的Google Cloud项目ID。项目id是字母数字串，像</em> <code class="du nh ni nj nk b"><em class="nq">myproject</em></code> <em class="nq">。</em></li><li id="01f5" class="le lf hi io b ip ln it lo ix lp jb lq jf lr jj lj lk ll lm bi translated"><code class="du nh ni nj nk b"><em class="nq">SA_NAME</em></code> <em class="nq">:您要列出其密钥的服务帐户的名称。</em></li><li id="a77c" class="le lf hi io b ip ln it lo ix lp jb lq jf lr jj lj lk ll lm bi translated"><code class="du nh ni nj nk b"><em class="nq">KEY_TYPES</em></code> <em class="nq">:可选。要包含在响应中的以逗号分隔的键类型列表。密钥类型表示密钥是用户管理的(</em> <code class="du nh ni nj nk b"><em class="nq">USER_MANAGED</em></code> <em class="nq">)还是系统管理的(</em> <code class="du nh ni nj nk b"><em class="nq">SYSTEM_MANAGED</em></code> <em class="nq">)。如果留空，则返回所有键。** USER_MANAGED是您创建的密钥，SYSTEM是Google生成的密钥</em></li></ul><pre class="mz na nb nc fd nr nk ns nt aw nu bi"><span id="fb24" class="mk kb hi nk b fi nv nw l nx ny">import google.auth</span><span id="ebdb" class="mk kb hi nk b fi nz nw l nx ny">from googleapiclient import discovery</span><span id="084c" class="mk kb hi nk b fi nz nw l nx ny">credentials, project = google.auth.default(</span><span id="7fd2" class="mk kb hi nk b fi nz nw l nx ny">scopes=['https://www.googleapis.com/auth/cloud-platform'])<br/></span><span id="9a6b" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">iamClient</strong> = discovery.build('iam', 'v1', credentials=credentials)</span><span id="ab3b" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">accounts_list</strong> = <strong class="nk hj">iamClient</strong>.projects().serviceAccounts().list(name="projects/<strong class="nk hj">myproject</strong>").execute()</span><span id="a996" class="mk kb hi nk b fi nz nw l nx ny">for <strong class="nk hj">service_account</strong> in accounts_list['accounts']:</span><span id="fc36" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">key</strong> =   <strong class="nk hj">iamClient</strong>.projects().serviceAccounts().keys().list(name=<strong class="nk hj">service_account['name']</strong>).execute()</span><span id="9278" class="mk kb hi nk b fi nz nw l nx ny">    for sa_key in key['keys']:</span><span id="45d8" class="mk kb hi nk b fi nz nw l nx ny">      if sa_key['keyType'] == “USER_MANAGED”:</span><span id="773d" class="mk kb hi nk b fi nz nw l nx ny">       <strong class="nk hj">  Key_ID = (key['name']).split("keys/"))[1]<br/>         Service_Account = accounts_list['name']<br/>         Service_Account_ID = accounts_list['uniqueId']</strong></span></pre><p id="4cd1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，对于每个服务帐户密钥<strong class="io hj">，我</strong>必须向<strong class="io hj">时序API v3 </strong>询问在特定时间段内使用密钥的所有事件:</p><p id="3d81" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">查看关于这个时间序列调用的Google文档:</strong></p><p id="50f9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="nq">云监控API的</em> <code class="du nh ni nj nk b"><a class="ae ld" href="https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.timeSeries/list" rel="noopener ugc nofollow" target="_blank"><em class="nq">timeSeries.list</em></a></code> <em class="nq">方法，当与特定过滤器一起使用时，允许您获取单个服务帐户密钥的使用情况指标。然后，您可以使用这些指标来确定最后一次使用密钥的时间。</em></p><p id="8426" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="nq">在使用下面的任何请求数据之前，请使用以下参数:</em></p><ul class=""><li id="eadc" class="le lf hi io b ip iq it iu ix lg jb lh jf li jj lj lk ll lm bi translated"><code class="du nh ni nj nk b"><em class="nq">PROJECT_ID</em></code> <em class="nq">:您的Google Cloud项目ID。项目id是字母数字串，像</em> <code class="du nh ni nj nk b"><em class="nq">myproject</em></code> <em class="nq">。</em></li><li id="9a2c" class="le lf hi io b ip ln it lo ix lp jb lq jf lr jj lj lk ll lm bi translated"><code class="du nh ni nj nk b"><em class="nq">KEY_ID</em></code> <em class="nq">:您的服务账号密钥的唯一ID。</em></li><li id="6d26" class="le lf hi io b ip ln it lo ix lp jb lq jf lr jj lj lk ll lm bi translated"><code class="du nh ni nj nk b"><em class="nq">END_TIME</em></code> <em class="nq">:您要检查的时间间隔的结束，以百分比编码的</em> <a class="ae ld" href="https://tools.ietf.org/html/rfc3339" rel="noopener ugc nofollow" target="_blank"> <em class="nq"> RFC 3339 </em> </a> <em class="nq">格式。比如</em> <code class="du nh ni nj nk b"><em class="nq">2020-06-12T00%3A00%3A00.00Z</em></code> <em class="nq">。</em></li><li id="ab36" class="le lf hi io b ip ln it lo ix lp jb lq jf lr jj lj lk ll lm bi translated"><code class="du nh ni nj nk b"><em class="nq">START_TIME</em></code> <em class="nq">:您要检查的时间间隔的开始，以百分比编码的</em><a class="ae ld" href="https://tools.ietf.org/html/rfc3339" rel="noopener ugc nofollow" target="_blank"><em class="nq">RFC 3339</em></a><em class="nq">格式。比如</em> <code class="du nh ni nj nk b"><em class="nq">2020-04-12T00%3A00%3A00.00Z</em></code> <em class="nq">。</em></li></ul><pre class="mz na nb nc fd nr nk ns nt aw nu bi"><span id="0803" class="mk kb hi nk b fi nv nw l nx ny">import google.auth<br/>import json</span><span id="dacd" class="mk kb hi nk b fi nz nw l nx ny">from google.auth.transport.requests import AuthorizedSession</span><span id="e344" class="mk kb hi nk b fi nz nw l nx ny">credentials, project = google.auth.default(</span><span id="fce1" class="mk kb hi nk b fi nz nw l nx ny">scopes=['https://www.googleapis.com/auth/cloud-platform'])</span><span id="6072" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">TIMESERIES_URL</strong> = "https://monitoring.googleapis.com/v3/projects/<strong class="nk hj">myproject</strong>/timeSeries?filter=metric.type%3D%22iam.googleapis.com%2Fservice_account%2Fkey%2Fauthn_events_count%22%20AND%20metric.labels.key_id%3D%22"+str(<strong class="nk hj"><em class="nq">KEY_ID</em></strong>)+"%22&amp;interval.endTime=<strong class="nk hj">2021-04-26T15:01:23Z</strong>&amp;interval.startTime=<strong class="nk hj">2021-04-20T15:01:23Z</strong>"</span><span id="089a" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">AUTHORIZED_SCOPE</strong> = ["https://www.googleapis.com/auth/cloud-platform"]</span><span id="d8a5" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">credential</strong> = google.auth.default(scopes=AUTHORIZED_SCOPE)[0]</span><span id="ac30" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">authed_session</strong> = AuthorizedSession(credential)</span><span id="bc81" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">response</strong> = authed_session.request(</span><span id="596b" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">method</strong>="GET", url=<strong class="nk hj">TIMESERIES_URL</strong>)</span><span id="10b6" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">key_usage</strong> = response.json()</span><span id="a8c9" class="mk kb hi nk b fi nz nw l nx ny">test =  "timeSeries" in key_usage</span><span id="3a2e" class="mk kb hi nk b fi nz nw l nx ny">if test is True:</span><span id="36ed" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">   timeSeries</strong> = key_usage['timeSeries'][0]['points']</span><span id="f9e7" class="mk kb hi nk b fi nz nw l nx ny">   for window in timeSeries:</span><span id="9ee2" class="mk kb hi nk b fi nz nw l nx ny">     print(<strong class="nk hj">window['interval']['startTime']</strong>)</span><span id="7d35" class="mk kb hi nk b fi nz nw l nx ny">     print(<strong class="nk hj">window['interval']['endTime']</strong>)</span><span id="fa25" class="mk kb hi nk b fi nz nw l nx ny">     print(<strong class="nk hj">window['value']['int64Value']</strong>)</span></pre><p id="b7df" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我将获得每个键在10分钟时间窗口内(开始和结束时间之间)的呼叫量</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h2 id="0eb3" class="mk kb hi bd kc ml mm mn kg mo mp mq kk ix mr ms ko jb mt mu ks jf mv mw kw mx bi translated">最后一步是将所有这些数据发送给BigQuery:</h2><pre class="mz na nb nc fd nr nk ns nt aw nu bi"><span id="86e6" class="mk kb hi nk b fi nv nw l nx ny">from google.cloud import bigquery</span><span id="d66f" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">bigqueryClient</strong> = bigquery.Client()</span><span id="9bc6" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">row</strong> = [</span><span id="99b3" class="mk kb hi nk b fi nz nw l nx ny">    {</span><span id="edbc" class="mk kb hi nk b fi nz nw l nx ny">      u"project_id": var_projectid,</span><span id="60db" class="mk kb hi nk b fi nz nw l nx ny">      u"sa_email": var_saemail,</span><span id="4881" class="mk kb hi nk b fi nz nw l nx ny">      u"sa_id": var_said,</span><span id="f129" class="mk kb hi nk b fi nz nw l nx ny">      u"key_id": var_keyid,</span><span id="31ee" class="mk kb hi nk b fi nz nw l nx ny">      u"start_time": var_start,</span><span id="ba58" class="mk kb hi nk b fi nz nw l nx ny">      u"end_time": var_end,</span><span id="460c" class="mk kb hi nk b fi nz nw l nx ny">      u"value": var_value</span><span id="dea1" class="mk kb hi nk b fi nz nw l nx ny">    }</span><span id="10d4" class="mk kb hi nk b fi nz nw l nx ny">]</span><span id="4822" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj">bigqueryClient</strong>.insert_rows_json("<strong class="nk hj">dataset.table</strong>", row, row_ids=[None] * len(row))</span></pre><p id="a6dc" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，每个项目/每个服务客户/每个键/每个10分钟窗口都有一行:</p><figure class="mz na nb nc fd ij er es paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="er es oa"><img src="../Images/d203ebe175f5825f58dc36ab27b2978c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jIIgiN02pp1G95QGPJ1Mmw.png"/></div></div></figure><p id="710a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请记住，根据文档，如果在特定窗口中没有使用我的密钥，则不会记录任何内容，因此不会显示任何内容:</p><p id="634d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="nq">如果服务帐户和服务帐户密钥用于调用任何Google API，包括不属于Google Cloud的API，则它们会出现在这些指标中。</em></p><p id="2c27" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="nq">这些指标包括成功和失败的API调用。</em></p><p id="42cd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="nq">例如，如果一个API调用由于调用者未被授权调用该API，或者由于请求引用了不存在的资源而失败，则用于该API调用的服务帐户或密钥出现在度量中。</em></p><h2 id="352a" class="mk kb hi bd kc ml mm mn kg mo mp mq kk ix mr ms ko jb mt mu ks jf mv mw kw mx bi translated">现在，让我们看看我们可以利用DataStudio做些什么和发现些什么:</h2><figure class="mz na nb nc fd ij er es paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="er es ob"><img src="../Images/8d28b77d03323edbe502f9415b17a2b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-O2dfppiWG7Hf410QqgcIg.png"/></div></div></figure><p id="e2c7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">哦耶！我可以看到我的服务帐户密钥被大量使用。否则，如果我的<strong class="io hj"> <em class="nq"> </em> </strong>在我的仪表盘里找不到，那就意味着我大概可以删除它。</p><p id="14ab" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">查看这些有用的BigQuery技巧来分析数据:</p><pre class="mz na nb nc fd nr nk ns nt aw nu bi"><span id="8889" class="mk kb hi nk b fi nv nw l nx ny"><strong class="nk hj"><em class="nq">Query the project where there is the biggest usage of Keys :</em></strong></span><span id="20af" class="mk kb hi nk b fi nz nw l nx ny">SELECT</span><span id="4042" class="mk kb hi nk b fi nz nw l nx ny">   SUM(value)as totalCount, projectId</span><span id="32bc" class="mk kb hi nk b fi nz nw l nx ny">FROM</span><span id="fd00" class="mk kb hi nk b fi nz nw l nx ny">   'my-project.mydataset.mytable'</span><span id="99c8" class="mk kb hi nk b fi nz nw l nx ny">GROUP BY projectId</span><span id="889c" class="mk kb hi nk b fi nz nw l nx ny">ORDER BY totalCount DESC</span><span id="dde4" class="mk kb hi nk b fi nz nw l nx ny"><strong class="nk hj"><em class="nq">Query the Keys that have not been used since the last 30 days:</em></strong></span><span id="afd5" class="mk kb hi nk b fi nz nw l nx ny">SELECT</span><span id="a867" class="mk kb hi nk b fi nz nw l nx ny">   keyid,</span><span id="8485" class="mk kb hi nk b fi nz nw l nx ny">   LastUse</span><span id="27aa" class="mk kb hi nk b fi nz nw l nx ny">   FROM (</span><span id="5468" class="mk kb hi nk b fi nz nw l nx ny">      SELECT</span><span id="a5c0" class="mk kb hi nk b fi nz nw l nx ny">         keyid,</span><span id="4cec" class="mk kb hi nk b fi nz nw l nx ny">         MAX(start) AS LastUse</span><span id="9bfd" class="mk kb hi nk b fi nz nw l nx ny">      FROM</span><span id="1400" class="mk kb hi nk b fi nz nw l nx ny">         'my-project.mydataset.mytable'</span><span id="5c1b" class="mk kb hi nk b fi nz nw l nx ny">      GROUP BY keyid</span><span id="d790" class="mk kb hi nk b fi nz nw l nx ny">      ORDER BY LastUse DESC )</span><span id="7647" class="mk kb hi nk b fi nz nw l nx ny">WHERE LastUse &lt; TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 30 day)</span></pre></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h1 id="4e65" class="ka kb hi bd kc kd oc kf kg kh od kj kk kl oe kn ko kp of kr ks kt og kv kw kx bi translated">结论</h1><p id="c80c" class="pw-post-body-paragraph im in hi io b ip ky ir is it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj hb bi translated">我现在可以了解我的GCP服务帐户密钥的情况，我可以轻松地分享这些信息，并采取行动！</p><p id="a403" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">点击查看回购的样本代码<a class="ae ld" href="https://github.com/antoinecastex/monitor_sakey_usage" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>