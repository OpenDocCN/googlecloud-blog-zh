<html>
<head>
<title>Instrumenting Cloud Spanner Go Applications with OpenCensus</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用OpenCensus检测云扳手Go应用程序</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/instrumenting-cloud-spanner-go-applications-with-opencensus-6e734eb4d8c8?source=collection_archive---------1-----------------------#2020-04-20">https://medium.com/google-cloud/instrumenting-cloud-spanner-go-applications-with-opencensus-6e734eb4d8c8?source=collection_archive---------1-----------------------#2020-04-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f7b8e8dea35ec2576dc05034b4c36189.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SPS2lzq97afSIola6KqiTg.png"/></div></div></figure><p id="b6bc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本教程将向您展示如何使用Go中的Cloud Spanner客户端库在演示应用程序中启用与会话相关的指标。这些指标允许更好地监控会话池，并帮助我们快速识别会话问题:</p><ul class=""><li id="7e2a" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><strong class="is hj"><em class="jx">max _ allowed _ sessions</em></strong>:允许的最大会话数。可由用户配置。</li><li id="8fb2" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><strong class="is hj"><em class="jx">num _ sessions _ in _ pool</em></strong>:当前在会话池中的会话数，包括正在使用的和未使用的。</li><li id="c266" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><strong class="is hj"><em class="jx">max _ in _ use _ sessions</em></strong>:最近10分钟间隔内使用的最大会话数。</li><li id="2d78" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><strong class="is hj"><em class="jx">get _ session _ time outs</em></strong>:由于池耗尽导致的get会话超时次数。</li><li id="321f" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><strong class="is hj"><em class="jx">num _ acquired _ sessions</em></strong>:从会话池中获取的会话数。</li><li id="6ee1" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><strong class="is hj"><em class="jx">num _ released _ sessions</em></strong>:用户释放的会话数。</li></ul><p id="6aec" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">内容将包括:</p><ul class=""><li id="5995" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">创建一个扳手表&amp;一个演示web应用程序</li><li id="7d05" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated">启用指标视图并导出到云监控</li><li id="721f" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated">云监控中的可视化指标</li></ul><p id="c075" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你用的是Java的Cloud Spanner客户端库，你可能会对<a class="ae kd" rel="noopener" href="/@mayurkale22/troubleshooting-cloud-spanner-applications-with-opencensus-2cf424c4c590">这篇文章</a>感兴趣。</p><p id="c56c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">重要提示:</strong> OpenCensus正在被OpenTelemetry所取代(目前正在进入测试阶段)，但是移植应该不需要太多的改变就可以使用API。在这里阅读更多<a class="ae kd" href="https://opentelemetry.io/about/" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="c128" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">先决条件</h1><h2 id="3d6b" class="lc kf hi bd kg ld le lf kk lg lh li ko jb lj lk ks jf ll lm kw jj ln lo la lp bi translated">创建扳手台</h2><p id="a821" class="pw-post-body-paragraph iq ir hi is b it lq iv iw ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn hb bi translated">使用以下DDL模式在spanner数据库中创建一个表“<strong class="is hj"> users </strong>”:</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="837f" class="lc kf hi ma b fi me mf l mg mh">CREATE TABLE users (<br/>  id STRING(MAX) NOT NULL,<br/>  email STRING(MAX) NOT NULL,<br/>  first_name STRING(MAX) NOT NULL,<br/>  last_name STRING(MAX) NOT NULL,<br/>) PRIMARY KEY (id)</span></pre><h2 id="358d" class="lc kf hi bd kg ld le lf kk lg lh li ko jb lj lk ks jf ll lm kw jj ln lo la lp bi translated">创建简单的web应用程序</h2><p id="95e4" class="pw-post-body-paragraph iq ir hi is b it lq iv iw ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn hb bi translated">这个web应用程序支持两个API:</p><ul class=""><li id="0355" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">GET localhost/users:在表中列出所有用户，返回的数据是json格式的。</li><li id="c33b" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated">POST localhost/users:用提交的表单字段创建一个新用户。</li></ul><p id="c2d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">代码如<a class="ae kd" href="https://github.com/hengfengli/spanner-opencensus-example/blob/master/webapp_enable_oc.go" rel="noopener ugc nofollow" target="_blank"> webapp_enable_oc.go </a>所示。</p><h1 id="0493" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">启用指标导出</h1><p id="5ed0" class="pw-post-body-paragraph iq ir hi is b it lq iv iw ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn hb bi translated">为了查看度量视图，您需要决定两件事:</p><ol class=""><li id="e16a" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn mi ju jv jw bi translated">我们希望在后端看到哪些视图？</li><li id="7c84" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn mi ju jv jw bi translated">我们应该将视图导出到哪个后端？</li></ol><p id="a860" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以使用<a class="ae kd" href="https://pkg.go.dev/go.opencensus.io/stats/view?tab=doc#Register" rel="noopener ugc nofollow" target="_blank"> register api </a>注册Spanner客户端库中定义的全部或部分视图。在本教程中，我们将使用Spanner客户端库中注册所有视图的便利API。</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="fe6f" class="lc kf hi ma b fi me mf l mg mh">// Enable all default views.<br/>spanner.EnableStatViews()</span></pre><p id="f5e5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，所有指标视图将在后端显示。</p><p id="f388" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们需要选择将指标发送到哪个后端。Opencensus支持将指标导出到许多不同的后端，您可以在这里找到受支持的导出器<a class="ae kd" href="https://opencensus.io/exporters/" rel="noopener ugc nofollow" target="_blank"/>。在本教程中，我们使用云监控(以前称为Stackdriver)作为示例:</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="77e7" class="lc kf hi ma b fi me mf l mg mh">// Set up the stackdriver exporter.<br/>sd, err := stackdriver.NewExporter(stackdriver.Options{<br/>        ProjectID: projectID,<br/>        ReportingInterval: 60 * time.Second,<br/>})<br/>if err != nil {<br/>        log.Fatalf(“Failed to create the StackDriver exporter: %v”, err)<br/>}<br/>defer sd.Flush()</span><span id="fb1d" class="lc kf hi ma b fi mj mf l mg mh">sd.StartMetricsExporter()<br/>defer sd.StopMetricsExporter()</span></pre><p id="d302" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们创建一个stackdriver导出器，并将其配置为每60秒报告一次。</p><h1 id="278e" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">可视化云监控中的指标</h1><p id="fc8d" class="pw-post-body-paragraph iq ir hi is b it lq iv iw ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn hb bi translated">首先，我们需要运行web应用程序:</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="8d53" class="lc kf hi ma b fi me mf l mg mh">$ go run webapp_enable_oc.go // The default port is 8080.<br/>// Or, specify a port.<br/>$ go run webapp_enable_oc.go -port=8080</span></pre><p id="a3d5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了创造一些流量，我们可以使用<a class="ae kd" href="https://github.com/wg/wrk" rel="noopener ugc nofollow" target="_blank"> wrk </a>(一个HTTP基准测试工具):</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="8d6a" class="lc kf hi ma b fi me mf l mg mh">$ wrk -t12 -c200 -d5m <a class="ae kd" href="http://127.0.0.1:8080/users" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8080/users</a></span><span id="be3b" class="lc kf hi ma b fi mj mf l mg mh">Running 5m test @ <a class="ae kd" href="http://127.0.0.1:8080/users" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8080/users</a><br/>  12 threads and 200 connections<br/>  Thread Stats Avg Stdev Max +/- Stdev<br/>    Latency 100.74ms 114.93ms 1.50s 87.70%<br/>    Req/Sec 222.75 64.84 430.00 70.69%<br/>  791833 requests in 5.00m, 379.09MB read<br/>  Socket errors: connect 0, read 53, write 0, timeout 0<br/>Requests/sec: 2638.51<br/>Transfer/sec: 1.26MB</span></pre><p id="deb4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将运行基准测试5分钟，使用12个线程，并保持200个HTTP连接打开。</p><p id="cf32" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，您可以导航到GCP云监控中的Metric explorer。您应该能够找到带有这个前缀的指标:“custom . Google APIs . com/open census/cloud . Google . com/go/spanner/”。所有相关指标都应在此前缀下。如果您将所有指标相加，并使用“<strong class="is hj"> sum </strong>”聚合器，您将看到一个类似于下图的图表:</p><figure class="lv lw lx ly fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/ce4dd27dfed93035d2990735aceeffc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*B4yN5DjjElPXMODf"/></div></div><figcaption class="ml mm et er es mn mo bd b be z dx translated">所有与会话相关的指标</figcaption></figure><p id="2946" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意图中没有显示<em class="jx"> get_session_timeouts </em>,因为我们还没有得到任何超时错误。</p><p id="f19f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">每个指标都有一些共同的属性:</p><ul class=""><li id="d7ec" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">client_id:区分单个进程中的spanner客户端。对于同一个数据库，它以“客户机-1”、“客户机-2”等开始。</li><li id="5905" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated">数据库:数据库的名称。</li><li id="8543" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated">instance_id:实例的名称。</li><li id="70cb" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated">library _ version:YYYYMMDD格式的<a class="ae kd" href="https://github.com/googleapis/google-cloud-go" rel="noopener ugc nofollow" target="_blank"> google-cloud-go </a>的日期版本(spanner是子模块)。</li></ul><p id="8e44" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以使用这些属性对指标进行分组，例如在<em class="jx"> max_in_use_sessions </em>中，</p><figure class="lv lw lx ly fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/4561d6c64f06ebe54092dcfa421f68a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TrhuM45YTQJx_jzc"/></div></div><figcaption class="ml mm et er es mn mo bd b be z dx translated">最大使用会话数的标签</figcaption></figure><p id="e090" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">特别是，<em class="jx"> num_sessions_in_pool </em>有一个type属性，表示会话的类型。type属性有四个值:</p><ul class=""><li id="d15d" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><strong class="is hj"> <em class="jx">【使用中会话数】</em> </strong>:用户当前正在使用的会话。</li><li id="6b6e" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><strong class="is hj"><em class="jx">num _ sessions _ being _ prepared</em></strong>:正在准备写入的会话。</li><li id="9955" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><strong class="is hj"><em class="jx">num _ read _ sessions</em></strong>:读取会话池中的会话。</li><li id="be7a" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><strong class="is hj"><em class="jx">num _ write _ prepared _ sessions</em></strong>:在会话池中写入会话。</li></ul><p id="ff9d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它们的总和就是会话池中的会话总数，包括正在使用的和未使用的。<em class="jx"> num_sessions_in_pool </em>的堆叠面积图如下所示:</p><figure class="lv lw lx ly fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/94c9331561c694ee4c09eeb6dfd2d6c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FQ6moRn_BjIJlEQI"/></div></div><figcaption class="ml mm et er es mn mo bd b be z dx translated">池中会话数的堆积面积图</figcaption></figure><h1 id="b238" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">结论</h1><p id="525a" class="pw-post-body-paragraph iq ir hi is b it lq iv iw ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn hb bi translated">本教程介绍了使用Cloud Spanner Go客户端库时，如何启用会话相关指标。客户端库中添加了六个OpenCensus指标，可用于调试会话问题。这些指标可以导出到不同的后端，以便于存储和可视化。这些指标使我们能够更好地监控会话池，并快速定位会话问题。</p></div></div>    
</body>
</html>