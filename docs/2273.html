<html>
<head>
<title>How does the GCP Workload Identity Federation work with Github Provider?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP工作负载身份联盟如何与Github提供商合作？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-does-the-gcp-workload-identity-federation-work-with-github-provider-a9397efd7158?source=collection_archive---------1-----------------------#2022-07-22">https://medium.com/google-cloud/how-does-the-gcp-workload-identity-federation-work-with-github-provider-a9397efd7158?source=collection_archive---------1-----------------------#2022-07-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/4e1729e760232658d64812e460dffee8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/0*mzZELDcSxD2ACAWl"/></div></figure><p id="7fa6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一些用户可能想要运行terraform代码，以便通过他们的Github CI/CD管道在Google云平台上创建资源。而其他人可能希望运行“gcloud”命令来进行某些配置。这两个选项都需要调用GCP API。当您调用GCP API时，它们需要认证和授权。一种可能(但不推荐)的方法是下载GCP服务账户密钥，并将其作为秘密存储在Github repos中，或者作为文件存储在Github private runners中。然后，这些服务帐户密钥可以用于进行GCP API调用。在Github环境中保护、存储、分发、轮换和监控这些密钥本身就是一项非常具有挑战性和令人兴奋的任务。所以不推荐。GCP提供了一种更安全的方法来实现相同的使用工作负载身份联邦。在这篇文章中，我将尝试描述GCP·WIF如何使用一步一步的方法与Github提供商合作。</p><h1 id="92f2" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">第一步</h1><p id="cbed" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">在此，用户要求GCP信任Github提供商。这是通过创建工作负载标识池、工作负载标识提供者和IAMs来实现的。让我们分别来看看这些。</p><p id="ef34" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">工作负载身份池:</strong>工作负载身份池用于组织和管理外部身份。建议为不同的非google云环境创建一个新池。下面的命令可以用来创建相同的:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="918f" class="kw jl hi ks b fi kx ky l kz la">gcloud iam workload-identity-pools create github-wif-pool --location="global" --project &lt;project_id&gt;</span></pre><p id="b6aa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">工作负载身份提供者:</strong>工作负载身份提供者描述了外部身份(如Github和Google Cloud)之间的关系。它基本上建立了外部身份和GCP之间的信任。它提供了将外部令牌的属性应用到Google令牌的属性映射。这使得IAM可以使用来自外部提供商的令牌来授权对Google云资源的访问。这基本上是一种将外部令牌转换成GCP等价令牌的方法。下面的命令可以用来创建相同的:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="1b96" class="kw jl hi ks b fi kx ky l kz la">gcloud iam workload-identity-pools providers create-oidc githubwif \<br/>--location="global" --workload-identity-pool="github-wif-pool"  \<br/>--issuer-uri="https://token.actions.githubusercontent.com" \<br/>--attribute-mapping="attribute.actor=assertion.actor,google.subject=assertion.sub,attribute.repository=assertion.repository" \<br/>--project &lt;project_id&gt;</span></pre><p id="eaa0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">服务帐户和IAMs: </strong>我们需要一个分配了相关权限的服务帐户。WIF将模拟此服务帐户。我们还添加了权限，允许来自工作负载身份提供者提供的身份的身份验证模拟所需的服务帐户。它允许Github action模拟服务帐户并获取令牌。请注意在成员名称中使用了属性“repository”。它允许IAM仅对来自存储库“PradeepSingh1988/gcp-wif”的请求进行身份验证。如果我们没有使用它，那么所有使用特定工作负载身份提供者的github repos都可以根据IAM进行身份验证。下面的命令可以用来创建相同的:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="9de7" class="kw jl hi ks b fi kx ky l kz la">gcloud iam service-accounts create test-wif \<br/>--display-name="Service account used by WIF POC" \<br/>--project &lt;project_id&gt;<br/><br/>gcloud projects add-iam-policy-binding &lt;project_id&gt; \<br/>--member='serviceAccount:test-wif@&lt;project_id&gt;.iam.gserviceaccount.com' \<br/>--role="roles/compute.viewer"</span><span id="6240" class="kw jl hi ks b fi lb ky l kz la">gcloud iam service-accounts add-iam-policy-binding test-wif@&lt;project_id&gt;.iam.gserviceaccount.com \<br/>--project=&lt;project_id&gt; \<br/>--role="roles/iam.workloadIdentityUser" \<br/>--member="principalSet://iam.googleapis.com/projects/&lt;project_number&gt;/locations/global/workloadIdentityPools/github-wif-pool/attribute.repository/PradeepSingh1988/gcp-wif"</span></pre><p id="b008" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">还有一些选项可以限制来自特定分支的身份验证。为此，我们需要使用如下的原则。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="15ad" class="kw jl hi ks b fi kx ky l kz la">principal://iam.googleapis.com/projects/&lt;project_number&gt;/locations/global/workloadIdentityPools/POOL_ID/subject/repo:PradeepSingh1988/gcp-wif:ref:refs/heads/main</span></pre><p id="86a9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这确保了只有repo PradeepSingh1988/gcp-wif的主分支可以进行身份验证。</p><h1 id="52a1" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">第二步</h1><p id="2558" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">对于这一步，我想给一个简单的github工作流在我的回购有以下步骤的例子。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="83e4" class="kw jl hi ks b fi kx ky l kz la">name: <strong class="ks hj">wif-ci</strong><br/>on:<br/>  push:<br/>    branches:</span><span id="5747" class="kw jl hi ks b fi lb ky l kz la">- <strong class="ks hj">'main'</strong><br/>jobs:<br/>  build:<br/>    name: <strong class="ks hj">"Test WIF"</strong><br/>    runs-on: <strong class="ks hj">ubuntu-latest</strong><br/>    timeout-minutes: 90<br/>    permissions:<br/>      contents: <strong class="ks hj">'read'</strong><br/>      id-token: <strong class="ks hj">'write'</strong><br/>    steps:<br/>      - name: <strong class="ks hj">Checkout</strong><br/>        uses: <strong class="ks hj">actions/checkout@v2</strong><br/>      - id: <strong class="ks hj">auth</strong><br/>        uses: <strong class="ks hj">google-github-actions/auth@v0.4.0</strong><br/>        with:<br/>          token_format: <strong class="ks hj">"access_token"</strong><br/>          create_credentials_file: <strong class="ks hj">true</strong><br/>          activate_credentials_file: <strong class="ks hj">true</strong><br/>          workload_identity_provider: <strong class="ks hj">${{</strong> <strong class="ks hj">secrets.WORKLOAD_IDENTITY_PROVIDER_ID</strong> <strong class="ks hj">}}</strong><br/>          service_account: <strong class="ks hj">${{</strong> <strong class="ks hj">secrets.SERVICE_ACCOUNT</strong> <strong class="ks hj">}}</strong><br/>          access_token_lifetime: <strong class="ks hj">'100s'<br/></strong>      - name: <strong class="ks hj">Set</strong> <strong class="ks hj">up</strong> <strong class="ks hj">Cloud</strong> <strong class="ks hj">SDK</strong><br/>        uses: <strong class="ks hj">google-github-actions/setup-gcloud@v0.3.0<br/></strong>      - name: <strong class="ks hj">set</strong> <strong class="ks hj">crdential_file</strong><br/>        run: <strong class="ks hj">gcloud auth login --cred-file=${{steps.auth.outputs.credentials_file_path}}<br/></strong>      - name: <strong class="ks hj">Run</strong> <strong class="ks hj">gcloud</strong><br/>        run: gcloud compute instances list --zones us-east4-c</span></pre><p id="32fc" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这里我们使用了一些秘密，如<strong class="io hj">WORKLOAD _ IDENTITY _ PROVIDER _ ID</strong>和<strong class="io hj"> SERVICE_ACCOUNT </strong>我们需要在github repo中创建这两个秘密。我们可以从步骤1中获得它们的值。</p><p id="931c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在此步骤中，Github操作' google-github-actions/auth '首先调用Github OIDC提供程序来获取OIDC令牌。要获得OIDC令牌，它必须拥有针对OIDC提供者进行API调用的权限。这就是' id-token: <strong class="io hj"> 'write' </strong>'行变得必要的地方。<strong class="io hj"> </strong>它提供了<strong class="io hj"/>‘Google-github-actions/auth’动作对OIDC提供者进行API调用的必要权限。</p><p id="0bf5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Github action调用Github OIDC提供商。该调用相当于下面的curl请求。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="9b1a" class="kw jl hi ks b fi kx ky l kz la">OIDC_TOKEN=$(curl -H <strong class="ks hj">"Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN"</strong> <strong class="ks hj">"$ACTIONS_ID_TOKEN_REQUEST_URL&amp;audience=https://iam.googleapis.com/${{ secrets.WORKLOAD_IDENTITY_PROVIDER_ID }}"</strong> | jq <strong class="ks hj">'.value'</strong>)</span></pre><p id="8020" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">OIDC提供者返回令牌，它是jwt格式的，如果解码成功，看起来如下所示:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="d34b" class="kw jl hi ks b fi kx ky l kz la">{<br/>"typ": "JWT",<br/>"alg": "RS256",<br/>"x5t": "example-thumbprint",<br/>"kid": "example-key-id"<br/>}</span><span id="b092" class="kw jl hi ks b fi lb ky l kz la">{<br/>"jti": "example-id",<br/>"sub": "repo:PradeepSingh1988/gcp-wif:ref:refs/heads/main"<br/>"environment": "",<br/>"aud": "https://iam.googleapis.com/projects/&lt;project_number&gt;/locations/global/workloadIdentityPools/&lt;pool_id&gt;/providers/&lt;provider_id&gt;",<br/>"ref": "refs/heads/main",<br/>"sha": "example-sha",<br/>"repository": "PradeepSingh1988/gcp-wif",<br/>"repository_owner": "PradeepSingh1988",<br/>"actor_id": "23",<br/>"repository_id": "45",<br/>"repository_owner_id": "67",<br/>"run_id": "example-run-id",<br/>"run_number": "101",<br/>"run_attempt": "21",<br/>"actor": "PradeepSingh1988",<br/>"workflow": "example-workflow",<br/>"head_ref": "",<br/>"base_ref": "",<br/>"event_name": "workflow_dispatch",<br/>"ref_type": "branch",<br/>"job_workflow_ref":"PradeepSingh1988/gcp-wif/.github/workflows/ci.yml@refs/heads/main",<br/>"iss": "https://token.actions.githubusercontent.com",<br/>"nbf": 1632494000,<br/>"exp": 1632494900,<br/>"iat": 1632494600<br/>}</span></pre><h1 id="6934" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">第三步</h1><p id="ed6c" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">在此步骤中，Github操作' google-github-actions/auth '将OIDC提供jwt令牌与GCP安全令牌服务进行交换，以获得联合访问令牌。Github action发出的HTTPs调用相当于下面的curl请求。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="d4ca" class="kw jl hi ks b fi kx ky l kz la">STS_RESPONSE=$(curl -0 -X POST https://sts.googleapis.com/v1/token \<br/> -H <strong class="ks hj">'Accept: application/json'</strong> -H <strong class="ks hj">'Content-Type: application/json'</strong> -d <strong class="ks hj">"$(cat &lt;&lt;EOF<br/> {<br/>     "audience": "//iam.googleapis.com/${{ secrets.WORKLOAD_IDENTITY_PROVIDER_ID }}",<br/>     "grantType": "urn:ietf:params:oauth:grant-type:token-exchange",<br/>     "requestedTokenType" : "urn:ietf:params:oauth:token-type:access_token",<br/>     "scope": "https://www.googleapis.com/auth/cloud-platform",<br/>     "subjectTokenType": "urn:ietf:params:oauth:token-type:jwt",<br/>     "subjectToken": $OIDC_TOKEN<br/> }<br/> EOF<br/> )"</strong><br/> )<br/> STS_TOKEN=$(jq <strong class="ks hj">'.access_token'</strong> &lt;&lt;&lt; <strong class="ks hj">"$STS_RESPONSE"</strong>)</span></pre><p id="3094" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这里它传递了两个重要的信息，受众和subjectToken。收到请求后，STS在工作负载身份提供者的帮助下验证令牌。Workload Identity Provider执行所有条件检查，以及在创建提供程序期间指定的属性映射。它检查令牌中的“iss”字段是否与创建工作负荷身份提供者期间传递的“issuer-uri”相同。令牌中的“aud”字段等于<em class="lc">"</em><a class="ae ld" href="https://iam.googleapis.com/projects/" rel="noopener ugc nofollow" target="_blank"><em class="lc">https://iam.googleapis.com/projects/</em></a><em class="lc">&lt;项目_编号&gt;/locations/global/workloadIdentityPools/&lt;pool _ id&gt;/providers/&lt;provider _ id&gt;"</em>或不等于等等。所有的步骤都在<a class="ae ld" href="https://cloud.google.com/iam/docs/using-workload-identity-federation#verification_of_external_credentials" rel="noopener ugc nofollow" target="_blank">这里</a>详细描述。</p><p id="2693" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦请求验证成功，STS就会返回一个联邦令牌。这个令牌是一种GCP身份，具有模拟服务帐户所需的所有必要信息。</p><h1 id="2094" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">第四步</h1><p id="f4a3" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">在此步骤中，Github操作' google-github-actions/auth '交换在上一步骤中收到联合令牌，以获取IAM访问令牌。Github action发出的HTTPs调用相当于下面的curl请求。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="56cc" class="kw jl hi ks b fi kx ky l kz la">IAM_RESPONSE=$(curl -0 -X POST   \<br/>https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/${{ \<br/>secrets.SERVICE_ACCOUNT }}:generateAccessToken \<br/>-H <strong class="ks hj">"Authorization: Bearer $STS_TOKEN"</strong> \<br/>-H <strong class="ks hj">'Accept: application/json'</strong> \<br/>-H <strong class="ks hj">'Content-Type: application/json'</strong> -d <strong class="ks hj">"$(cat &lt;&lt;EOF<br/>{<br/>  "scope": [ "https://www.googleapis.com/auth/cloud-platform" ]<br/>}<br/>EOF<br/>)"</strong><br/>)<br/>ACCESS_TOKEN=$(jq <strong class="ks hj">'.accessToken'</strong> &lt;&lt;&lt; <strong class="ks hj">"$IAM_RESPONSE"</strong>)</span></pre><p id="bc97" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">IAM验证联邦令牌，并检查它是否属于正确的主体，如果是，那么它发出一个oauth令牌，该令牌可用于进行GCP api调用。</p><h1 id="a7a0" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">第五步</h1><p id="086c" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">使用在步骤4中接收的访问令牌，工作流向GCP发出列出实例的API请求。这个令牌的寿命很短。一旦过期，我们需要再次刷新它。</p><p id="3b6d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">其他OIDC身份提供商的流程也是一样的。我希望这篇文章对你有用。这里还有一篇非常好的文章，提供了更多的细节。请检查一下。</p><p id="0496" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">快乐阅读！！欢迎评论和建议！！</p></div></div>    
</body>
</html>