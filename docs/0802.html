<html>
<head>
<title>Istio Routing Basics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio路由基础</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/istio-routing-basics-14feab3c040e?source=collection_archive---------0-----------------------#2018-11-02">https://medium.com/google-cloud/istio-routing-basics-14feab3c040e?source=collection_archive---------0-----------------------#2018-11-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c67c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当学习像<a class="ae jd" href="http://istio.io" rel="noopener ugc nofollow" target="_blank"> Istio </a>这样的新技术时，看一看示例应用程序总是一个好主意。Istio repo有一些<a class="ae jd" href="https://github.com/istio/istio/tree/master/samples" rel="noopener ugc nofollow" target="_blank">样本</a>应用，但它们在各方面都有不足。<a class="ae jd" href="https://github.com/istio/istio/tree/master/samples/bookinfo" rel="noopener ugc nofollow" target="_blank"> BookInfo </a>包含在文档中，这是很好的第一步。然而，它对我来说太冗长了，有太多的服务，文档似乎专注于管理BookInfo应用程序，而不是从头开始构建它。有一个更小的<a class="ae jd" href="https://github.com/istio/istio/tree/master/samples/helloworld" rel="noopener ugc nofollow" target="_blank"> helloworld </a>示例，但它更多的是关于自动缩放。</p><p id="e242" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我想介绍一些基础知识，并向您展示如何从头开始构建一个支持Istio的“HelloWorld”应用程序。有一点要记住，Istio只管理你app的流量。应用程序的生命周期由底层平台管理，在本例中是Kubernetes。因此，您需要了解容器和Kubernetes的基础知识，并且需要预先了解Istio路由原语，如Gateway、VirtualService、DestinationRule。我假设大多数人都知道容器和Kubernetes的基本知识。在这篇文章中，我将重点讨论Istio路由。</p><h1 id="d691" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">基本步骤</h1><p id="5a9f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">要获得支持Istio的“HelloWorld”应用，大致需要遵循以下步骤:</p><ol class=""><li id="1388" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">创建一个Kubernetes集群并安装带有自动边车注入的Istio。</li><li id="af36" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">用你选择的语言创建一个HelloWorld应用程序，用它创建一个Docker映像，并把它推送到一个公共映像库。</li><li id="984d" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">为您的容器创建Kubernetes部署和服务。</li><li id="33f8" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">创建一个<a class="ae jd" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#Gateway" rel="noopener ugc nofollow" target="_blank">网关</a>来启用到您的集群的HTTP(S)流量。</li><li id="2217" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">创建一个<a class="ae jd" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#VirtualService" rel="noopener ugc nofollow" target="_blank"> VirtualService </a>来通过网关公开Kubernetes服务。</li><li id="5521" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">(可选)如果您想要创建应用程序的多个版本，请创建一个<a class="ae jd" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#DestinationRule" rel="noopener ugc nofollow" target="_blank"> DestinationRule </a>来定义您可以从VirtualService引用的子集。</li><li id="0557" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">(可选)如果您想要调用服务网格之外的外部服务，请创建一个<a class="ae jd" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#ServiceEntry" rel="noopener ugc nofollow" target="_blank"> ServiceEntry </a>。</li></ol><p id="2d3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不会在这篇文章中讨论第一步和第二步，因为它们不是Istio特有的。如果你在这些步骤上需要帮助，你可以看看我在本文末尾提到的codelabs。第3步也不是很具体，但它是所有其他事情的先决条件，所以让我们从这一步开始。</p><h1 id="5749" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">部署和服务</h1><p id="b01f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">正如我提到的，应用程序的生命周期由Kubernetes管理。因此，您需要从创建Kubernetes部署和服务开始。在我的例子中，我有一个容器化的ASP.NET核心应用程序，它的图像我已经推送到谷歌容器注册。让我们从创建一个<code class="du kv kw kx ky b">aspnetcore.yaml</code>文件开始:</p><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="a0a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建部署和服务:</p><pre class="kz la lb lc fd lg ky lh li aw lj bi"><span id="caea" class="lk jf hi ky b fi ll lm l ln lo">$ kubectl apply -f aspnetcore.yaml</span><span id="8efd" class="lk jf hi ky b fi lp lm l ln lo">service "aspnetcore-service" created<br/>deployment.extensions "aspnetcore-v1" created</span></pre><p id="11f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前还没什么特别的。</p><h1 id="100c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">门</h1><p id="1ab1" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我们现在可以开始研究Istio路由。首先，我们需要为我们的服务网格启用HTTP/HTTPS流量。为此，我们需要创建一个<a class="ae jd" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#Gateway" rel="noopener ugc nofollow" target="_blank">网关</a>。网关描述了在网格边缘运行的负载平衡器，接收传入或传出的HTTP/TCP连接。</p><p id="a6ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个<code class="du kv kw kx ky b">aspnetcore-gateway.yaml</code>文件:</p><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="5e83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建网关:</p><pre class="kz la lb lc fd lg ky lh li aw lj bi"><span id="bd5d" class="lk jf hi ky b fi ll lm l ln lo">$ kubectl apply -f aspnetcore-gateway.yaml</span><span id="7993" class="lk jf hi ky b fi lp lm l ln lo">gateway.networking.istio.io "aspnetcore-gateway" created</span></pre><p id="3828" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，我们已经为集群启用了HTTP流量。我们需要将之前创建的Kubernetes服务映射到网关。我们将通过虚拟服务来做到这一点。</p><h1 id="9d14" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">虚拟服务</h1><p id="e415" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">一个<a class="ae jd" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#VirtualService" rel="noopener ugc nofollow" target="_blank"> VirtualService </a>本质上将一个Kubernetes服务连接到Istio Gateway。它还可以做更多的事情，例如定义一组流量路由规则，以便在主机被寻址时应用，但我们不会深入讨论这些细节。</p><p id="3a5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个<code class="du kv kw kx ky b">aspnetcore-virtualservice.yaml</code>文件:</p><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="3393" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，VirtualService被绑定到一个特定的网关，它定义了一个引用Kubernetes服务的主机。</p><p id="d68f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建虚拟服务:</p><pre class="kz la lb lc fd lg ky lh li aw lj bi"><span id="1731" class="lk jf hi ky b fi ll lm l ln lo">$ kubectl apply -f aspnetcore-virtualservice.yaml</span><span id="bba9" class="lk jf hi ky b fi lp lm l ln lo">virtualservice.networking.istio.io "aspnetcore-virtualservice" created</span></pre><h1 id="0368" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">测试应用程序的版本1</h1><p id="3842" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我们已经准备好测试我们的应用程序。我们需要获得Istio入口网关的IP地址:</p><pre class="kz la lb lc fd lg ky lh li aw lj bi"><span id="8380" class="lk jf hi ky b fi ll lm l ln lo">$ kubectl get svc istio-ingressgateway -n istio-system</span><span id="6ac3" class="lk jf hi ky b fi lp lm l ln lo">NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP                                                                                                        <br/>istio-ingressgateway   LoadBalancer   10.31.247.41   35.240.XX.XXX</span></pre><p id="a34b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们浏览到<code class="du kv kw kx ky b">EXTERNAL-IP</code>时，我们应该看到hello world ASP.NET核心应用程序:</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lq"><img src="../Images/1534f23e50451d0c39415e16b5d81c86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WksXRI3XV54SegfmFd0_bg.png"/></div></div></figure><h1 id="78d2" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">目标规则</h1><p id="4925" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在某些时候，你想要更新你的应用程序到一个新的版本。也许你想在两个版本之间分配流量。您需要创建一个<a class="ae jd" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#DestinationRule" rel="noopener ugc nofollow" target="_blank"> DestinationRule </a>来定义这些版本，在Istio中称为子集。</p><p id="af4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，更新<code class="du kv kw kx ky b">aspnetcore.yaml</code>文件，用容器的<code class="du kv kw kx ky b">v2</code>版本定义<code class="du kv kw kx ky b">v2</code>的部署:</p><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="3d22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建新部署:</p><pre class="kz la lb lc fd lg ky lh li aw lj bi"><span id="4301" class="lk jf hi ky b fi ll lm l ln lo">$ kubectl apply -f aspnetcore.yaml</span><span id="1a93" class="lk jf hi ky b fi lp lm l ln lo">service "aspnetcore-service" unchanged<br/>deployment.extensions "aspnetcore-v1" unchanged<br/>deployment.extensions "aspnetcore-v2" created</span></pre><p id="cbad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你用<code class="du kv kw kx ky b">EXTERNAL-IP</code>刷新浏览器，你会看到VirtualService在应用的<code class="du kv kw kx ky b">v1</code>和<code class="du kv kw kx ky b">v2</code>版本中循环:</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lq"><img src="../Images/1534f23e50451d0c39415e16b5d81c86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WksXRI3XV54SegfmFd0_bg.png"/></div></div><figcaption class="lx ly et er es lz ma bd b be z dx translated">应用程序的v1</figcaption></figure><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es mb"><img src="../Images/335a4198e0e03a5f774a1a28eff62721.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vqfpTeJtV1aP8v0mV8Ff2g.png"/></div></div><figcaption class="lx ly et er es lz ma bd b be z dx translated">应用程序的v2</figcaption></figure><p id="04eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是意料之中的，因为两个版本都暴露在同一个Kubernetes服务之下:<code class="du kv kw kx ky b">aspnetcore-service</code>。</p><p id="db88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想把你的服务只锁定在<code class="du kv kw kx ky b">v2</code>呢？这可以通过在VirtualService中指定一个子集来完成，但是我们需要首先在DestinationRules中定义这些子集。DestinationRule本质上将标签映射到Istio子集。</p><p id="a93d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个<code class="du kv kw kx ky b">aspnetcore-destinationrule.yaml</code>文件:</p><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="78dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建目标规则:</p><pre class="kz la lb lc fd lg ky lh li aw lj bi"><span id="6569" class="lk jf hi ky b fi ll lm l ln lo">$ kubectl apply -f aspnetcore-destinationrule.yaml</span><span id="1fa1" class="lk jf hi ky b fi lp lm l ln lo">destinationrule.networking.istio.io "aspnetcore-destinationrule" created</span></pre><p id="176c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以参考来自VirtualService的<code class="du kv kw kx ky b">v2</code>子集:</p><figure class="kz la lb lc fd ld"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="7acc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更新虚拟服务:</p><pre class="kz la lb lc fd lg ky lh li aw lj bi"><span id="3b40" class="lk jf hi ky b fi ll lm l ln lo">$ kubectl apply -f aspnetcore-virtualservice.yaml</span><span id="c9a1" class="lk jf hi ky b fi lp lm l ln lo">virtualservice.networking.istio.io "aspnetcore-virtualservice" configured</span></pre><p id="c7c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您浏览回<code class="du kv kw kx ky b">EXTERNAL-IP</code>，您现在应该只能看到应用程序的<code class="du kv kw kx ky b">v2</code>。</p><h1 id="800a" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">ServiceEntry</h1><p id="52b5" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在Istio路由中最后要提到的是<a class="ae jd" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#ServiceEntry" rel="noopener ugc nofollow" target="_blank"> ServiceEntry </a>。默认情况下，Istio中的所有外部流量都会被阻止。如果要启用外部流量，需要创建一个ServiceEntry来列出为外部流量启用了哪些协议和主机。我不会在这篇文章中展示一个例子，但是你可以在这里阅读更多关于它的内容。</p></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="1b14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这有用！如果您想了解更多，有一个由2部分组成的codelab系列，其中所有这些概念以及更多内容都在一个分步教程中进行了解释:</p><ul class=""><li id="1569" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc mj kn ko kp bi translated"><a class="ae jd" href="https://codelabs.developers.google.com/codelabs/cloud-istio-aspnetcore-part1" rel="noopener ugc nofollow" target="_blank">使用Istio将ASP.NET核心应用部署到Google Kubernetes引擎(第1部分)</a></li><li id="c74e" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc mj kn ko kp bi translated"><a class="ae jd" href="https://codelabs.developers.google.com/codelabs/cloud-istio-aspnetcore-part2" rel="noopener ugc nofollow" target="_blank">使用Istio将ASP.NET核心应用部署到Google Kubernetes引擎(第2部分)</a></li></ul></div></div>    
</body>
</html>