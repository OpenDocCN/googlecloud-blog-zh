<html>
<head>
<title>Use Workload Identity Federation with another GCP project</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将工作量标识联合用于另一个GCP项目</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/use-workload-identity-federation-with-another-gcp-project-98dc3b1c236c?source=collection_archive---------0-----------------------#2022-10-31">https://medium.com/google-cloud/use-workload-identity-federation-with-another-gcp-project-98dc3b1c236c?source=collection_archive---------0-----------------------#2022-10-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/68112c29084b1c58e8f58d339394062a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EFWheXhBBcw0Ggsd"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">克劳迪奥·施瓦茨拍摄的照片</figcaption></figure><p id="6330" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">自2021年4月<a class="ae iu" href="https://cloud.google.com/iam/docs/release-notes#April_09_2021" rel="noopener ugc nofollow" target="_blank">日</a>起，GCP允许为外部工作负载建立身份联盟。在<a class="ae iu" href="https://cloud.google.com/iam/docs/workload-identity-federation" rel="noopener ugc nofollow" target="_blank">官方文档</a>中提到:</p><blockquote class="jt ju jv"><p id="c442" class="iv iw jw ix b iy iz ja jb jc jd je jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">使用身份联合，您可以授予内部或多云工作负载对Google云资源的访问权限，而无需使用服务帐户密钥。</p></blockquote><p id="172c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这里，术语<em class="jw">外部</em>似乎包含了所有在GCP之外运行的进程(例如AWS、Azure、on-prem、SaaS等)。).事实上，Workload Identity Federation试图解决的主要问题是长期凭证的使用，服务帐户密钥很好地体现了这一点。</p><p id="31ad" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我看来，一个<em class="jw">外部</em>工作量就是在一个GCP组织 之外<strong class="ix hj"> <em class="jw">运行的一切。</em></strong></p><p id="65b1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">话虽如此，当两个GCP组织需要一起工作时会发生什么呢？</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ka"><img src="../Images/7fe314f578776e1ec9a1c0f710678240.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QPG26x4P-z25lBs5EJ3Jfw.png"/></div></div></figure><p id="55dc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从您知道另一个组织拥有的服务帐户的电子邮件的那一刻起，您可以通过以下方式授予它对您的资源的权限:</p><ul class=""><li id="5705" class="kf kg hi ix b iy iz jc jd jg kh jk ki jo kj js kk kl km kn bi translated"><code class="du ko kp kq kr b"><strong class="ix hj">Direct Access</strong></code></li><li id="487f" class="kf kg hi ix b iy ks jc kt jg ku jk kv jo kw js kk kl km kn bi translated"><code class="du ko kp kq kr b"><strong class="ix hj">Indirect Access</strong></code>:允许后者冒充你的一个服务账号</li></ul><p id="e571" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">知道外部服务帐户在GCP上运行，它可以受益于环境凭据而不是密钥。</p><pre class="kb kc kd ke fd kx kr ky kz aw la bi"><span id="bb37" class="lb lc hi kr b fi ld le l lf lg"><strong class="kr hj">Definition</strong></span><span id="384b" class="lb lc hi kr b fi lh le l lf lg"><em class="jw">Ambient credentials are credentials that the application can obtain without having to perform any additional authentication.</em></span><span id="63e1" class="lb lc hi kr b fi lh le l lf lg"><em class="jw">For example, in GCP it's provided thanks to a runtime service account + metadata server</em></span></pre><p id="be33" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">考虑到这一点，在这种用例中使用工作负载身份联合可能听起来很傻或者有些过火😵。</p><p id="13f8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，让我们看看它是如何有用的！</p></div><div class="ab cl li lj gp lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hb hc hd he hf"><h1 id="8a73" class="lp lc hi bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">GCP项目的工作负载身份联合并非毫无意义</h1><p id="7abd" class="pw-post-body-paragraph iv iw hi ix b iy mm ja jb jc mn je jf jg mo ji jj jk mp jm jn jo mq jq jr js hb bi translated">我们开门见山吧！当您以<em class="jw">本机方式</em>访问外部SA时，主要缺点是它将<strong class="ix hj"> <em class="jw">不可察觉</em> </strong>在您的审计日志中。</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/bc93fb4e711cba05629c5b2fd03ef2aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HzQrypLWawpKMYvqq7bOlg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用本机IAM策略的审计日志示例(直接访问)</figcaption></figure><p id="cc46" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">换句话说，审计日志不会突出一个<code class="du ko kp kq kr b"><strong class="ix hj"><em class="jw">service account DOESN'T belong to your org</em></strong></code>的事实！</p><p id="ec98" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="jw">注意</em> </strong> <em class="jw">:我观察到了一个模仿(间接访问)的相同行为。</em></p><p id="266c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了获得这些信息，您必须解析日志(例如<em class="jw">从电子邮件</em>中提取项目id或项目编号)并与您的参考(例如<a class="ae iu" href="https://cloud.google.com/asset-inventory/docs/overview" rel="noopener ugc nofollow" target="_blank">云资产清单</a>)进行比较，这需要时间和资源。</p><p id="62db" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">另一方面，如果您使用工作负载身份联邦，那么<strong class="ix hj"> <em class="jw">将明确</em> </strong>某个身份在您的领域之外。</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/c9c07d61669fcfb94b431e7b51c272a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QunjCcmn7BfjtedwnytETw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用工作负载身份联合的审计日志示例</figcaption></figure><p id="57d8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我的例子中，主体遵循这个任意的模式<em class="jw"> </em> <code class="du ko kp kq kr b"><strong class="ix hj"><em class="jw">ext_gcp_sa::&lt;sa_id&gt;::&lt;sa_email&gt;</em></strong></code>。现在，如果您的组织遵守命名约定，您的安全团队将能够跟踪外部身份足迹，而无需数据转换！</p><p id="10ed" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此外，以同样的方式对待所有外部身份提供了一致性(如流程、日志格式)，从而降低了总体复杂性。</p><p id="a872" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我会告诉你如何设置这个⬇️</p></div><div class="ab cl li lj gp lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hb hc hd he hf"><h1 id="cbbc" class="lp lc hi bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">具体的例子</h1><p id="1a58" class="pw-post-body-paragraph iv iw hi ix b iy mm ja jb jc mn je jf jg mo ji jj jk mp jm jn jo mq jq jr js hb bi translated">首先，下面描述的所有内容在这个<a class="ae iu" href="https://github.com/LoicSikidi/workload-identity-federation-with-gcp-project" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> <em class="jw">资源库</em> </strong> </a>中也是可用的。</p><p id="0bfa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将创建这样的东西:</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mt"><img src="../Images/f1a0f78bdd04cfb9adb5b9f976d90fc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vlyB0vyCMvhVSiuaP70CJw.png"/></div></div></figure><p id="f6c0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="jw">注意</em> </strong> <em class="jw">:为了简单起见，我们将所有资源创建在同一个项目中。</em></p><h2 id="a387" class="lb lc hi bd lq mu mv mw lu mx my mz ly jg na nb mc jk nc nd mg jo ne nf mk ng bi translated">魔法是如何运作的？</h2><ol class=""><li id="3918" class="kf kg hi ix b iy mm jc mn jg nh jk ni jo nj js nk kl km kn bi translated">信任关系依赖于两个前提条件:<br/>a)OIDC令牌<em class="jw">必须由<em class="jw">https://accounts.google.com</em><br/>颁发</em>b)OIDC令牌中代表服务帐户ID的声明(此处为<code class="du ko kp kq kr b">sub</code>)<em class="jw"/>必须在我们的允许列表中。信任基于SA ID，因为该值随时间推移是唯一的(例如<em class="jw">如果服务帐户被删除，然后用同一电子邮件重新创建，后者将被拒绝，因为ID将不同</em>)</li><li id="8fd2" class="kf kg hi ix b iy ks jc kt jg ku jk kv jo kw js nk kl km kn bi translated"><a class="ae iu" href="https://google.aip.dev/auth/4117" rel="noopener ugc nofollow" target="_blank"> <em class="jw">外部帐户凭证</em> </a>(由应用程序默认凭证解释)看起来像这样:</li></ol><pre class="kb kc kd ke fd kx kr ky kz aw la bi"><span id="8c2e" class="lb lc hi kr b fi ld le l lf lg">{<br/>  "type": "external_account",<br/>  "audience": "&lt;AUDIENCE&gt;",<br/>  "subject_token_type": "urn:ietf:params:oauth:token-type:jwt",<br/>  "token_url": "<a class="ae iu" href="https://sts.googleapis.com/v1/token" rel="noopener ugc nofollow" target="_blank">https://sts.googleapis.com/v1/token</a>",<br/>  "<strong class="kr hj">credential_source</strong>": {<br/>    "<strong class="kr hj">url</strong>": "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/identity?audience=&lt;AUDIENCE&gt;",<br/>    "<strong class="kr hj">headers</strong>": {<br/>      "Metadata-Flavor": "Google"<br/>    }<br/>  },<br/>  "service_account_impersonation_url": "<a class="ae iu" href="https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/internal-sa@test-wif-qsfqsf.iam.gserviceaccount.com:generateAccessToken" rel="noopener ugc nofollow" target="_blank">https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/&lt;SA_EMAIL&gt;:generateAccessToken</a>"<br/>}</span></pre><p id="afb8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://www.rfc-editor.org/rfc/rfc8693#section-2.1-4.12" rel="noopener ugc nofollow" target="_blank"> subject_token </a>直接从元数据服务器中检索。</p><h2 id="e8ce" class="lb lc hi bd lq mu mv mw lu mx my mz ly jg na nb mc jk nc nd mg jo ne nf mk ng bi translated">设置</h2><p id="45bb" class="pw-post-body-paragraph iv iw hi ix b iy mm ja jb jc mn je jf jg mo ji jj jk mp jm jn jo mq jq jr js hb bi translated">第一步是启用云存储审计日志。</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nl"><img src="../Images/f6d6336d661cd9fc540240df6a224d44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c6LPqHd3E6T1XvhmkIooRg.png"/></div></div></figure><p id="9fe3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，运行以下命令:</p><figure class="kb kc kd ke fd ij"><div class="bz dy l di"><div class="nm nn l"/></div></figure><h2 id="14e4" class="lb lc hi bd lq mu mv mw lu mx my mz ly jg na nb mc jk nc nd mg jo ne nf mk ng bi translated">试验</h2><pre class="kb kc kd ke fd kx kr ky kz aw la bi"><span id="3b51" class="lb lc hi kr b fi ld le l lf lg"><em class="jw"># Call the cloudfunction to produce audit logs</em></span><span id="513b" class="lb lc hi kr b fi lh le l lf lg"><strong class="kr hj">for</strong> <!-- -->i <strong class="kr hj">in</strong> <!-- -->{1..10}<br/><strong class="kr hj">do<br/>    </strong>curl -sS -H<!-- --> "Authorization: Bearer $(gcloud auth print-identity-token)" $CF_URL<br/><strong class="kr hj">done</strong></span></pre><p id="13ac" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，使用这个查询<code class="du ko kp kq kr b">protoPayload.serviceName="storage.googleapis.com"</code>检查<em class="jw">云日志</em>以查看审计日志并检查IAM委托细节。</p><h2 id="3791" class="lb lc hi bd lq mu mv mw lu mx my mz ly jg na nb mc jk nc nd mg jo ne nf mk ng bi translated">打扫</h2><p id="1fcd" class="pw-post-body-paragraph iv iw hi ix b iy mm ja jb jc mn je jf jg mo ji jj jk mp jm jn jo mq jq jr js hb bi translated">从上面的脚本中取消对<em class="jw">清理</em>部分的注释，以便删除创建的资源。</p><p id="b441" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果需要，禁用云存储审核日志。</p></div><div class="ab cl li lj gp lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hb hc hd he hf"><h1 id="85bf" class="lp lc hi bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated"><strong class="ak">结论</strong></h1><p id="7fea" class="pw-post-body-paragraph iv iw hi ix b iy mm ja jb jc mn je jf jg mo ji jj jk mp jm jn jo mq jq jr js hb bi translated">如您所见，在另一个GCP项目中使用Workload Identity Federation是有意义的。该功能可以在您的GCP组织中带来更好的可见性，而这并不需要很大的努力。可见性可以帮助您的不同团队(开发人员、安全与合规、高层管理人员等)。)在他们的日常任务中。</p><p id="4e89" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一般来说，如果你必须给出一个外部服务帐户的访问权限，总是选择<code class="du ko kp kq kr b"><strong class="ix hj">indirect access</strong></code>而不是<code class="du ko kp kq kr b"><strong class="ix hj">direct access</strong></code>。</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es no"><img src="../Images/9888c19ecf70172a55391bad9f765cf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rCwz_mnXdqJHDPOkFLE_Vw.png"/></div></div></figure><p id="fbb3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我对不同方法的评分如下:</p><ol class=""><li id="fdef" class="kf kg hi ix b iy iz jc jd jg kh jk ki jo kj js nk kl km kn bi translated"><strong class="ix hj"> <em class="jw">工作负载身份联合</em> </strong>:提供最佳特性覆盖的解决方案。</li><li id="f0d5" class="kf kg hi ix b iy ks jc kt jg ku jk kv jo kw js nk kl km kn bi translated"><strong class="ix hj"> <em class="jw">常规冒充</em> </strong>:权衡好但是审计日志少<em class="jw">上下文感知</em>。</li><li id="6db5" class="kf kg hi ix b iy ks jc kt jg ku jk kv jo kw js nk kl km kn bi translated"><strong class="ix hj"> <em class="jw">直接访问</em> </strong>:不允许强制执行任何安全策略(例如，组织策略、从<a class="ae iu" href="https://cloud.google.com/policy-intelligence/docs/service-account-usage-tools" rel="noopener ugc nofollow" target="_blank">策略智能</a>中获取洞察等)。)由您的组织定义。用这种方法，你完全依赖于你的伴侣的善意。</li></ol><p id="0a7d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">今天到此为止。</p><p id="e6f1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我希望这个反思对你们中的一些人有用！</p></div></div>    
</body>
</html>