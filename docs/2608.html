<html>
<head>
<title>Solution : Not able to connect to a Private Cloud SQL Instance from a Private Data Fusion Instance?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解决方案:无法从私有数据融合实例连接到私有云SQL实例？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/solution-not-able-to-connect-to-a-private-cloud-sql-instance-from-a-private-data-fusion-instance-7c01e8e4aa4?source=collection_archive---------0-----------------------#2022-12-10">https://medium.com/google-cloud/solution-not-able-to-connect-to-a-private-cloud-sql-instance-from-a-private-data-fusion-instance-7c01e8e4aa4?source=collection_archive---------0-----------------------#2022-12-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="f925" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">为什么使用私有IP的云数据融合“无法”与使用私有IP的云SQL实例连接，尽管使用了相同的VPC网络？</p><p id="09f0" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">我可以从云数据融合访问公共数据融合实例，而无需额外设置，但为什么它不能用于私有IP？</p></blockquote><p id="6fe6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">请阅读这篇文章，找出这一挑战背后的原因并找到解决方案。</p><p id="8d85" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">可以从云数据融合访问公共云SQL实例，但出于安全原因，建议将私有实例用于云SQL和云数据融合。</p><h1 id="37a8" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">挑战</h1><p id="a60c" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it jh kk iw ix ji kl ja jb jj km je jf jg hb bi translated">当您在同一个VPC中创建一个<a class="ae kn" href="https://cloud.google.com/data-fusion/docs/how-to/create-private-ip#create_a_peering_connection" rel="noopener ugc nofollow" target="_blank">私有数据融合实例</a>和一个<a class="ae kn" href="https://cloud.google.com/sql/docs/mysql/connect-instance-private-ip" rel="noopener ugc nofollow" target="_blank">私有云SQL实例</a>并尝试从云数据融合实例访问云SQL实例(MySQL或SQLServer)时，您无法在它们之间建立连接并得到以下错误:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ko"><img src="../Images/9cc6161feb461ed0b93f801faf2e113f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fKYzwiuIchGnVz7kmdhZGQ.png"/></div></div></figure><h1 id="0b44" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">背景</h1><p id="19f5" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it jh kk iw ix ji kl ja jb jj km je jf jg hb bi translated">当您提供专用数据融合实例时，您将看到在VPC网络→您的VPC网络→专用服务连接下创建的专用服务连接，如下所示:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es la"><img src="../Images/53f145193d9e538a373f380cb9973568.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a0dZca9JHbgFUOl-y5ZK6Q.png"/></div></div></figure><p id="b53e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">每当您创建云数据融合(CDF)实例时，它都会在幕后创建一个Dataproc集群，并运行所有的sqoop作业。现在，Dataproc实例将只有一个私有IP，这是创建具有私有IP地址的CDF实例的整个概念。当您按照<a class="ae kn" href="https://cloud.google.com/data-fusion/docs/how-to/create-private-ip" rel="noopener ugc nofollow" target="_blank">这个</a>配置私有CDF实例时，它会引导您在您当前的VPC网络(比如默认网络)和云融合租户项目网络之间创建VPC对等。因此，每当CDF实例运行时，它都作为租户项目运行。</p><blockquote class="if ig ih"><p id="436c" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">租户项目ID是“at”符号(<strong class="il hj"> @ </strong>)和后面的句点(<strong class="il hj">)之间的部分。</strong>)。例如，如果服务帐户值为<br/> <code class="du lb lc ld le b">cloud-datafusion-management-sa@r8170c9b5e7699803-tp.iam.gserviceaccount.com</code>，则租户项目ID为<code class="du lb lc ld le b">r8170c9b5e7699803-tp</code>。</p></blockquote><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es lf"><img src="../Images/909d8209820b6442a5b734dfc4c39aec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j1PdmaN-kgwMQ2HE4l-X6Q.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">VPC与租户项目对等</figcaption></figure><p id="9beb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">当您仅使用私有IP地址调配云SQL实例时，它会在后台创建一个VPC对等，这在您当前的VPC和特定于云SQL的对等VPC之间隐式发生。</p><h1 id="57bc" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">连接失败的原因</h1><p id="317c" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it jh kk iw ix ji kl ja jb jj km je jf jg hb bi translated">现在我们知道了当两个私有实例都被提供时会发生什么。让我们来看看尽管设置了，连接还是没有建立的原因。无论何时创建私有数据融合实例，用户都会在当前网络和租户项目网络之间创建对等关系。每当再次创建私有云SQL实例时，当前网络和云SQL特定网络之间就会发生对等。<br/>现在，这两种不同的peerings正在当前网络(即您的默认网络)之间发生。但是云数据融合网络和云SQL网络并不是对等的，这就是为什么您不能在两个私有实例之间创建连接。</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es lk"><img src="../Images/3d6ef21a97c9b945da536ab0e2dde679.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g2FBD7ruvLar0Rg1o4LavA.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">VPC对等不是可传递的</figcaption></figure><p id="d873" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">虽然看起来两个实例都在同一个网络中，但是如果深入了解细节，您会发现这是两个不同的网络，没有对等关系；因此，无法访问它们的内部IP。<br/>现在我们来谈谈解决方案。</p><h1 id="2716" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">解决办法</h1><p id="be90" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it jh kk iw ix ji kl ja jb jj km je jf jg hb bi translated">要从私有云数据融合实例连接到私有云SQL实例，请使用代理计算引擎虚拟机。之所以需要代理，是因为云SQL网络并不直接与云数据融合网络对等，并且可传递对等体无法相互通信。要了解更多关于VPC对等的信息，请点击<a class="ae kn" href="https://cloud.google.com/vpc/docs/vpc-peering" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ll"><img src="../Images/4d1ea1de374684e15f899bf8cf149445.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VctB3LC8W1zjT3CeoTbKyg.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">代理虚拟机</figcaption></figure><p id="eb10" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><strong class="il hj">解决方案的步骤:</strong></p><p id="4d98" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">1)使用此<a class="ae kn" href="https://cloud.google.com/sql/docs/mysql/connect-instance-private-ip" rel="noopener ugc nofollow" target="_blank">文档</a>创建一个私有IP云SQL实例。这将包括两个步骤:</p><ul class=""><li id="2025" class="lm ln hi il b im in iq ir jh lo ji lp jj lq jg lr ls lt lu bi translated">建立VPC</li><li id="aeca" class="lm ln hi il b im lv iq lw jh lx ji ly jj lz jg lr ls lt lu bi translated">分配IP范围</li></ul><p id="2373" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">2)使用此<a class="ae kn" href="https://cloud.google.com/data-fusion/docs/how-to/create-private-ip" rel="noopener ugc nofollow" target="_blank">文档</a>创建一个私有云数据融合实例。</p><p id="8376" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><strong class="il hj"> <em class="ik">注意:</em> </strong>云SQL会创建自动访问私有IP实例所需的VPC对等，而数据融合则不会。你必须明确地创建VPC凝视你自己。确保完成<a class="ae kn" href="https://cloud.google.com/data-fusion/docs/how-to/create-private-ip#set-up-vpc-peering" rel="noopener ugc nofollow" target="_blank">这一步。</a></p><p id="c26d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">3)完成上述步骤后，您应该会看到控制台中创建了3个VPC peering。</p><ul class=""><li id="a4fb" class="lm ln hi il b im in iq ir jh lo ji lp jj lq jg lr ls lt lu bi translated">云SQL</li><li id="451b" class="lm ln hi il b im lv iq lw jh lx ji ly jj lz jg lr ls lt lu bi translated">服务网络</li><li id="67d5" class="lm ln hi il b im lv iq lw jh lx ji ly jj lz jg lr ls lt lu bi translated">云数据融合</li></ul><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ma"><img src="../Images/5d3b6850499ce571027bdf4fe9e62662.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MNDBAeDDdzqHgIbD2r-uPw.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">VPC对等</figcaption></figure><p id="b6ed" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">4)使用此<a class="ae kn" href="https://cloud.google.com/sql/docs/mysql/connect-admin-proxy" rel="noopener ugc nofollow" target="_blank">文档</a>创建云SQL代理。</p><p id="e528" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">5)创建或确保防火墙规则允许流量从专用CDF实例通过所需端口到达您的代理虚拟机。CDF的IP地址范围可以在CDF实例详细信息页面上找到。</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ma"><img src="../Images/4c5c156edc9f61b33fc9625f3763f453.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dYnQAtaLgyyEwpuiU-38dQ.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">防火墙规则</figcaption></figure><p id="4dbd" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><strong class="il hj">从云数据融合实例访问云SQL实例</strong></p><p id="f05d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">6)在云数据融合中创建数据库连接</p><ul class=""><li id="7f0d" class="lm ln hi il b im in iq ir jh lo ji lp jj lq jg lr ls lt lu bi translated">转到CDF控制台(外部URL)</li><li id="378e" class="lm ln hi il b im lv iq lw jh lx ji ly jj lz jg lr ls lt lu bi translated">在主屏幕上，选择牧马人</li><li id="aa18" class="lm ln hi il b im lv iq lw jh lx ji ly jj lz jg lr ls lt lu bi translated">从连接屏幕中，选择添加连接</li><li id="944f" class="lm ln hi il b im lv iq lw jh lx ji ly jj lz jg lr ls lt lu bi translated">然后选择数据库</li></ul><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es mb"><img src="../Images/400dadf6378d4cc8b1680543323f7f0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9atywddyEl-DHOCK"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">云数据融合中的数据库连接</figcaption></figure><p id="8c43" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">7)在开始从云数据融合实例访问云SQL实例之前，请确保已经从Hub安装了mysql/sqlserver驱动程序。</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es mc"><img src="../Images/591cd0ab86e92950adb8882ee89c366a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bOswiQj_g1uXTYUOkyRbQw.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">中心</figcaption></figure><p id="b7b2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">8)完成云数据融合中的数据库连接。您将能够成功地从私有云数据融合实例连接到私有云SQL实例。</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es md"><img src="../Images/c7d8825bbe6fae4bc153cb4c79fe1bdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eoV8TwxQB9afmr3FBqviBQ.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">成功连接</figcaption></figure><p id="2482" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">希望这篇文章对你有所帮助。你可以在<a class="ae kn" href="https://www.linkedin.com/in/megha-bedi-990/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上联系我。</p></div></div>    
</body>
</html>