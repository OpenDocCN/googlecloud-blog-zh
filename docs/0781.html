<html>
<head>
<title>Load Test Google Cloud APIs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">负载测试谷歌云API</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/load-testing-google-cloud-apis-889e393139ca?source=collection_archive---------2-----------------------#2018-09-28">https://medium.com/google-cloud/load-testing-google-cloud-apis-889e393139ca?source=collection_archive---------2-----------------------#2018-09-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="3586" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">JMeter和Go</h2></div><p id="5f6c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Google Cloud Platform提供了在云控制台中<a class="ae jt" href="https://console.cloud.google.com/iam-admin/quotas" rel="noopener ugc nofollow" target="_blank">监控配额和请求增加</a>的能力。</p><p id="9d24" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这提供了极好的透明性和控制，但并不排除负载测试的需要:</p><ul class=""><li id="45ed" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">谷歌云平台的<a class="ae jt" href="http://services.google.com/fh/files/misc/csuite_security_ebook.pdf" rel="noopener ugc nofollow" target="_blank">深度防御</a>的一个方面是，基础设施的多个层都有自己的防止滥用的保护措施，这可以表现为负载限制。</li><li id="4a62" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">一些谷歌云API的配额，如<a class="ae jt" href="https://developers.google.com/admin-sdk/" rel="noopener ugc nofollow" target="_blank">管理软件开发工具包</a>(忽略传统的G套件品牌；这也适用于云身份API)不是通过云控制台呈现的。</li></ul><p id="6476" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae jt" href="http://jmeter.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache JMeter(TM) </a>是一个流行的开源负载测试工具；它包括用兼容JSR223的语言编写的可脚本化的采样器，比如Groovy和BeanShell。</p><p id="53ef" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，在编写脚本时，您可能更喜欢用自己熟悉的语言编写代码。如果你对<a class="ae jt" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go编程语言</a>的发布很感兴趣，但一直在等待合适的用例，这就是它。</p></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><h1 id="c461" class="kp kq hi bd kr ks kt ku kv kw kx ky kz io la ip lb ir lc is ld iu le iv lf lg bi translated">JMeter</h1><p id="41ad" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">熟悉JMeter的人可能会发现为Google Cloud配置JMeter是显而易见的；然而，如果你是JMeter或Google Cloud的新手，以下内容可能会帮你省去一些试错的麻烦。</p><h2 id="d114" class="lm kq hi bd kr ln lo lp kv lq lr ls kz jg lt lu lb jk lv lw ld jo lx ly lf lz bi translated">创建OAuth客户端ID</h2><p id="14cd" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">如果您的项目有关联的非默认配额，则此步骤是必需的；否则可以跳过。</p><p id="59dd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您需要一个Google Cloud凭证来授权JMeter执行您的项目；确保在您想要测试的项目上创建它，以便应用适当的配额。创建一个新的凭据，而不是重复使用现有的凭据，以防它被破坏。</p><ul class=""><li id="63a5" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">应用类型:web应用</li><li id="5061" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">授权的Javascript起源:<a class="ae jt" href="https://developers.google.com" rel="noopener ugc nofollow" target="_blank">https://developers.google.com</a></li><li id="fc39" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">授权重定向:<a class="ae jt" href="https://developers.google.com/oauthplayground" rel="noopener ugc nofollow" target="_blank">https://developers.google.com/oauthplayground</a></li></ul><p id="db53" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">安全地记录客户端ID和密码。</p><h2 id="e5ad" class="lm kq hi bd kr ln lo lp kv lq lr ls kz jg lt lu lb jk lv lw ld jo lx ly lf lz bi translated">获取访问令牌</h2><p id="96e9" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">确保您处于与测试项目的域相关联的浏览器会话中，并且具有足够的权限来授权API范围的身份(例如，Admin SDK APIs的超级管理员角色)。</p><p id="a705" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在<a class="ae jt" href="https://developers.google.com/oauthplayground" rel="noopener ugc nofollow" target="_blank"> OAuth 2.0游乐场</a> …</p><p id="3b6c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您的项目有非默认配额，请单击设置(齿轮图标)并…</p><ul class=""><li id="e765" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">选择“使用您自己的OAuth凭据”</li><li id="dcdd" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">提供您在上面生成的客户端ID和密码</li></ul><p id="9c56" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">否则你可以使用操场生成的默认凭证。</p><p id="1258" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在主屏幕中，按照提示进行操作:</p><ul class=""><li id="f253" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">第一步。选择并授权API:提供你要测试的API的范围，例如<a class="ae jt" href="https://www.googleapis.com/auth/admin.directory.group.readonly" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/admin.directory.group</a>API的https://www . Google APIs . com/auth/admin . directory . group . readonly。</li><li id="00a3" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">第二步。令牌的交换授权码</li></ul><p id="35a6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这可能会将您直接带到步骤3，并折叠步骤2；如有必要，展开步骤2以查看访问令牌。</p><p id="0339" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在后续步骤中，您将返回到此屏幕以获取访问令牌，因此不要关闭此窗口。</p><h2 id="3c48" class="lm kq hi bd kr ln lo lp kv lq lr ls kz jg lt lu lb jk lv lw ld jo lx ly lf lz bi translated">安装JMeter</h2><p id="2dfe" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">安装JMeter (Java SDK是记录HTTPS的<a class="ae jt" href="https://jmeter.apache.org/usermanual/get-started.html#requirements" rel="noopener ugc nofollow" target="_blank">先决条件</a>，所以如果还没有安装的话先安装它)。</p><ul class=""><li id="a7b6" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">Mac: brew安装JMeter</li></ul><h2 id="a296" class="lm kq hi bd kr ln lo lp kv lq lr ls kz jg lt lu lb jk lv lw ld jo lx ly lf lz bi translated">运行JMeter</h2><p id="2235" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">从安装的bin目录中，运行JMeter的UI。</p><pre class="ma mb mc md fd me mf mg mh aw mi bi"><span id="bac3" class="lm kq hi mf b fi mj mk l ml mm">$ bash jmeter</span></pre><h2 id="c7d9" class="lm kq hi bd kr ln lo lp kv lq lr ls kz jg lt lu lb jk lv lw ld jo lx ly lf lz bi translated">配置JMeter测试计划</h2><p id="7301" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">要么从<a class="ae jt" href="https://gist.github.com/ferrisargyle/95e539a75fe720beca3688a69c1549ca" rel="noopener ugc nofollow" target="_blank">这个模板</a>开始，只提供下面的粗体参数，要么创建一个新计划并…</p><p id="336e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">添加一个<a class="ae jt" href="https://jmeter.apache.org/usermanual/test_plan.html#thread_group" rel="noopener ugc nofollow" target="_blank">线程组</a>(右击测试计划)并配置它:</p><ul class=""><li id="0d1d" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">添加-&gt;线程(用户)-&gt;线程组</li><li id="74fc" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">发生采样器错误后要采取的操作:停止线程</li><li id="374d" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">线程属性-&gt;线程数量:10；从1开始，逐渐增加直到你到达你想要的QPS。</li><li id="2291" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">循环计数:永远</li><li id="9696" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">调度程序配置-&gt;持续时间:100秒；选择与您正在测试的配额期相匹配的持续时间。</li></ul><p id="112d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">添加一个<a class="ae jt" href="https://jmeter.apache.org/usermanual/component_reference.html#HTTP_Request" rel="noopener ugc nofollow" target="_blank"> HTTP请求采样器</a>(右击线程组)并配置它:</p><ul class=""><li id="1ec7" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">添加-&gt;采样器-&gt; HTTP请求</li><li id="6205" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">Web服务器-&gt;协议:https</li><li id="709d" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">Web服务器-&gt;名称或IP:content.googleapis.com</li><li id="9805" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">方法:GET(除非您正在测试插入，这通常需要脚本)</li><li id="ab00" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated"><strong class="iz hj">路径</strong>:追加到服务器，例如/admin/directory/v1/groups</li><li id="e485" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated"><strong class="iz hj">参数</strong>(不编码):这些被附加到路径中，例如，domain=yourdomain.com，userKey=testuser@yourdomain.com</li></ul><p id="1cab" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">添加一个<a class="ae jt" href="https://jmeter.apache.org/usermanual/component_reference.html#HTTP_Header_Manager" rel="noopener ugc nofollow" target="_blank"> HTTP头管理器</a>(右击测试计划)并配置它:</p><ul class=""><li id="daf4" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">添加-&gt;配置元素-&gt; HTTP头管理器</li><li id="07f6" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated"><strong class="iz hj">Headers</strong>:Authorization = Bearer【您的访问令牌:复制/粘贴您之前在OAuth 2.0 Playground中创建的令牌；您可能需要先刷新它]</li></ul><p id="ddda" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">添加<a class="ae jt" href="https://jmeter.apache.org/usermanual/component_reference.html#Summary_Report" rel="noopener ugc nofollow" target="_blank">总结报告</a>和<a class="ae jt" href="https://jmeter.apache.org/usermanual/component_reference.html#View_Results_Tree" rel="noopener ugc nofollow" target="_blank">结果树</a> <a class="ae jt" href="https://jmeter.apache.org/usermanual/component_reference.html#listeners" rel="noopener ugc nofollow" target="_blank">监听器</a>(右击测试计划):</p><ul class=""><li id="cf61" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">添加-&gt;监听程序-&gt;摘要报告</li><li id="9150" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">添加-&gt;监听器-&gt;查看结果树；确保未选中记录/仅显示框来查看错误和成功日志。</li></ul><h2 id="f9de" class="lm kq hi bd kr ln lo lp kv lq lr ls kz jg lt lu lb jk lv lw ld jo lx ly lf lz bi translated">保存JMeter测试计划</h2><p id="3c6a" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">在任何情况下都会提示您…</p><h2 id="78d2" class="lm kq hi bd kr ln lo lp kv lq lr ls kz jg lt lu lb jk lv lw ld jo lx ly lf lz bi translated">运行JMeter测试计划</h2><p id="4eab" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">选择摘要报告以监控进度，然后单击屏幕顶部的绿色播放按钮。</p><p id="669f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行完成后，检查监听器:</p><ul class=""><li id="fb06" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">摘要报告显示在配额达到最大值或运行超过配置的持续时间之前提交的查询总数(“样本数”)，以及QPS(“吞吐量”)。</li><li id="f4a5" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">查看结果树-&gt;响应数据显示详细的响应和任何错误消息。</li></ul><p id="eb1e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当您对您的测试计划感到满意时，您可以直接从命令行运行它。</p></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><h1 id="57db" class="kp kq hi bd kr ks kt ku kv kw kx ky kz io la ip lb ir lc is ld iu le iv lf lg bi translated">去</h1><p id="57a5" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">负载测试和多线程就像烤面包和果酱一样；然而，Go的性能不如JMeter，所以你需要运行更多的线程，也就是Go例程，来生成与JMeter相同的负载；作为回报，你得到了大量的控制和灵活性。</p><p id="c412" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有几种方法可以实现多线程:</p><ul class=""><li id="5e7c" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated"><a class="ae jt" href="https://gobyexample.com/mutexes" rel="noopener ugc nofollow" target="_blank">互斥</a></li><li id="1ac1" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated"><a class="ae jt" href="https://gobyexample.com/stateful-goroutines" rel="noopener ugc nofollow" target="_blank">有状态goroutines和通道</a></li></ul><p id="bdeb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">互斥体非常适合负载测试用例，因此您可以将示例互斥体应用程序与<a class="ae jt" href="https://developers.google.com/admin-sdk/directory/v1/quickstart/go" rel="noopener ugc nofollow" target="_blank"> Admin SDK Go quickstart应用程序</a>混合，并添加少量<a class="ae jt" href="https://github.com/jawher/mow.cli" rel="noopener ugc nofollow" target="_blank"> CLI sugar </a>来构建一个简单的负载测试工具，用于组列表和插入操作。</p><p id="be89" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">list命令的操作类似于上面的JMeter测试；insert命令在插入组名时会增加组名。</p><p id="bf79" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你需要用<em class="mn"> go build </em>编译代码，然后运行二进制；命令行标志和参数对<em class="mn"> go run </em>快捷方式不起作用。</p><figure class="ma mb mc md fd mo"><div class="bz dy l di"><div class="mp mq l"/></div></figure><h2 id="15db" class="lm kq hi bd kr ln lo lp kv lq lr ls kz jg lt lu lb jk lv lw ld jo lx ly lf lz bi translated">下载OAuth凭证</h2><p id="964a" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">您需要根据Admin SDK授权该工具(这需要使用与具有超级管理员角色的用户相关联的会话；Google云平台API只需要通常的IAM权限)。</p><p id="feae" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用“<a class="ae jt" href="https://developers.google.com/admin-sdk/directory/v1/quickstart/go" rel="noopener ugc nofollow" target="_blank">启用目录API </a>按钮启用现有或新项目上的API，并将令牌下载到您的源目录；该应用程序将带您通过auth流，而不是必须使用OAuth 2.0 playground。</p></div></div>    
</body>
</html>