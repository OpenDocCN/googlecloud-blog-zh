<html>
<head>
<title>Simplifying Microservices with Istio in Google Kubernetes Engine — Part III</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Kubernetes引擎中的Istio简化微服务—第三部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/simplifying-microservices-with-istio-in-google-kubernetes-engine-part-iii-6b62876d0a7d?source=collection_archive---------1-----------------------#2018-02-15">https://medium.com/google-cloud/simplifying-microservices-with-istio-in-google-kubernetes-engine-part-iii-6b62876d0a7d?source=collection_archive---------1-----------------------#2018-02-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex if ig ih ii"><div class="bz dy l di"><div class="ij ik l"/></div></figure><blockquote class="il im in"><p id="9c62" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">我写的关于Istio的内容是Istio网站上<a class="ae jn" href="https://istio.io/docs/" rel="noopener ugc nofollow" target="_blank">精彩文档</a>的一个子集。请阅读官方文件以了解更多信息。</p></blockquote><p id="56e0" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">在本系列的<a class="ae jn" rel="noopener" href="/google-cloud/simplifying-microservices-with-istio-in-google-kubernetes-engine-part-i-849555f922b8">第一部分</a>中，我们看到了如何使用<a class="ae jn" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio </a>来简化微服务之间的通信。</p><p id="fa14" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">在本系列的第二篇文章中，我们学习了使用Istio出口规则来控制对服务网格之外的服务的访问。</p><blockquote class="il im in"><p id="1515" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated"><strong class="ir hj">在这一部分中，我们将了解如何使用Istio </strong>进行金丝雀部署和增加流量</p></blockquote><p id="02eb" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated"><strong class="ir hj">背景</strong>:在<a class="ae jn" rel="noopener" href="/@nithinmallya4/blue-green-deployments-for-a-rails-app-in-google-container-engine-gke-49ddcc1b002">过去的文章</a>中，我详细解释了我们如何使用Kubernetes进行蓝/绿部署。这是一种部署技术，我们使用应用程序的当前版本<strong class="ir hj">和新版本</strong>部署相同的生产环境。这项技术使我们能够进行零停机部署(ZDD)，以确保我们的用户在切换到新版本时不会受到影响。拥有两个版本(当前版本和新版本)也使我们能够在新版本出现任何问题时回滚。</p><p id="f3f1" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">我们<strong class="ir hj">还需要</strong>能够<strong class="ir hj">将流量</strong>提升(或降低)到我们应用的新版本，并监控它以确保没有负面影响。实现这一点的一个方法是用<a class="ae jn" href="https://martinfowler.com/bliki/CanaryRelease.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hj">部署</strong> </a>或者金丝雀释放。</p><blockquote class="il im in"><p id="603e" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">不那么有趣的事实:矿工进入矿井时会带着金丝雀。任何有毒气体都会首先杀死金丝雀，并警告矿工离开矿井。</p></blockquote><p id="84b0" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">同样，在应用程序部署领域，通过Canary部署，我们可以将应用程序的新版本部署到生产环境中，并且只将一小部分流量发送到这个新部署。这个新版本<strong class="ir hj">将与当前版本<strong class="ir hj">并行运行</strong>，并在我们将所有流量切换到新版本</strong>之前提醒我们任何问题。</p><p id="d2c5" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">例如:我们的应用程序v1可以获得90%的流量，v2可以获得另外的10%。如果一切正常，我们可以将v2流量提升至25%、50%，最终达到100%。Istio Canary部署的另一个优势是，我们可以根据请求中的自定义报头来增加流量。例如，将10%具有特定cookie头值的流量提升至我们应用的v2。</p><blockquote class="il im in"><p id="c3a1" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated"><strong class="ir hj">注意</strong>:虽然Canary部署“可以”与A/B测试结合使用，从业务指标的角度来看用户对新版本的反应，但其背后的真正动机是确保应用程序从功能角度来看表现令人满意。此外，业务所有者可能希望运行A/B测试活动的时间比Canary ramp可能需要的时间更长(例如:许多天甚至几周)。因此，将它们分开是明智的。</p></blockquote><h1 id="c162" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">让我们看看它的实际效果吧！</strong></h1><p id="dd3b" class="pw-post-body-paragraph io ip hi ir b is kp iu iv iw kq iy iz jo kr jc jd jp ks jg jh jq kt jk jl jm hb bi translated">从第一部分我们知道，我们的PetService与PetDetailsService(v1)和PetMedicalHistoryService(v1)进行对话。对PetService的调用的输出如下所示:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="596c" class="ld js hi kz b fi le lf l lg lh">$ <strong class="kz hj">curl </strong><a class="ae jn" href="http://108.59.82.93/pet/123" rel="noopener ugc nofollow" target="_blank"><strong class="kz hj">http://108.59.82.93/pet/123</strong></a></span><span id="61d0" class="ld js hi kz b fi li lf l lg lh">{<br/>  "petDetails": {<br/>    "petName": "Maximus",<br/>    "petAge": 5,<br/>    "petOwner": "Nithin Mallya",<br/>    <strong class="kz hj">"petBreed": "Dog"</strong><br/>  },<br/>  "petMedicalHistory": {<br/>    "vaccinationList": [<br/>      "Bordetella, Leptospirosis, Rabies, Lyme Disease"<br/>    ]<br/>  }<br/>}</span></pre><p id="5a7c" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">在上面的回答中，你会注意到宠物的名字是“狗”。<strong class="ir hj">然而，Maximus碰巧是一只德国牧羊犬，我们需要修改PetDetailsService，以便正确返回该品种。</strong></p><p id="a30a" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">因此，我们创建了PetDetailsService的v2，它现在将返回“德国牧羊犬”。但是，我们希望确保在将所有流量驱动到v2之前，我们可以用一小部分用户测试该服务的v2。</p><p id="8c40" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">在下面的图1中，我们看到流量被配置为50%的请求将被定向到v1，50%的请求将被定向到v2，即我们的Canary部署。(可以是任何数字，具体取决于变化的程度，并尽量减少负面影响)。</p><figure class="ku kv kw kx fd ii er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es lj"><img src="../Images/cebf4cae0964d37b6feaecfa0b0ca291.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6sHarJ2KJmAnLF4hSJ2Q_w.jpeg"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">图1:我们可以将PetDetailsService的v2部署为金丝雀部署并增加流量</figcaption></figure><h1 id="4da5" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">步骤:</h1><ol class=""><li id="1ecd" class="lu lv hi ir b is kp iw kq jo lw jp lx jq ly jm lz ma mb mc bi translated">创建PetDetailsService的版本v2，并像以前一样部署它。(参见petdetailservice/kube文件夹下的petinfo.yaml)</li></ol><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="04a6" class="ld js hi kz b fi le lf l lg lh">$ kubectl get pods</span><span id="c950" class="ld js hi kz b fi li lf l lg lh">NAME                                         READY     STATUS    RESTARTS   AGE</span><span id="bf5d" class="ld js hi kz b fi li lf l lg lh">petdetailsservice-v1-2831216563-qnl10        2/2       Running   0          19h</span><span id="8e38" class="ld js hi kz b fi li lf l lg lh"><strong class="kz hj">petdetailsservice-v2-2943472296-nhdxt</strong>        2/2       Running   0          2h</span><span id="25cd" class="ld js hi kz b fi li lf l lg lh">petmedicalhistoryservice-v1-28468096-hd7ld   2/2       Running   0          19h</span><span id="e16a" class="ld js hi kz b fi li lf l lg lh">petservice-v1-1652684438-3l112               2/2       Running   0          19h</span></pre><p id="cf08" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">2.创建一个<strong class="ir hj"> RouteRule </strong>，将流量分成<strong class="ir hj"> petdetailsservice </strong>的50%(v1)和50%(v2)，如下所示:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="9935" class="ld js hi kz b fi le lf l lg lh">cat &lt;&lt;EOF | istioctl create -f -<br/>apiVersion: config.istio.io/v1alpha2<br/>kind: RouteRule<br/>metadata:<br/>  name: petdetailsservice-default<br/>spec:<br/>  destination:<br/>    name: petdetailsservice<br/>  route:<br/>  - labels:<br/>      <strong class="kz hj">version: v1<br/>    weight: 50</strong><br/>  - labels:<br/>      <strong class="kz hj">version: v2<br/>    weight: 50</strong><br/>EOF</span><span id="d9ef" class="ld js hi kz b fi li lf l lg lh">$ <strong class="kz hj">istioctl get routerule</strong></span><span id="7faa" class="ld js hi kz b fi li lf l lg lh">NAME    KIND     NAMESPACE</span><span id="8efe" class="ld js hi kz b fi li lf l lg lh">petdetailsservice-default RouteRule.v1alpha2.config.istio.io default</span></pre><p id="8ed2" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">3.现在，如果您访问PetService，您应该看到交替请求分别返回“Dog”和“German Shepherd Dog ”,如下所示:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="f5a2" class="ld js hi kz b fi le lf l lg lh">$ <strong class="kz hj">curl </strong><a class="ae jn" href="http://108.59.82.93/pet/123" rel="noopener ugc nofollow" target="_blank"><strong class="kz hj">http://108.59.82.93/pet/123</strong></a></span><span id="1302" class="ld js hi kz b fi li lf l lg lh">{<br/>  "petDetails": {<br/>    "petName": "Maximus",<br/>    "petAge": 5,<br/>    "petOwner": "Nithin Mallya",<br/>    <strong class="kz hj">"petBreed": "Dog"</strong><br/>  },<br/>  "petMedicalHistory": {<br/>    "vaccinationList": [<br/>      "Bordetella, Leptospirosis, Rabies, Lyme Disease"<br/>    ]<br/>  }<br/>}</span><span id="6c30" class="ld js hi kz b fi li lf l lg lh">$ <strong class="kz hj">curl </strong><a class="ae jn" href="http://108.59.82.93/pet/123" rel="noopener ugc nofollow" target="_blank"><strong class="kz hj">http://108.59.82.93/pet/123</strong></a></span><span id="b1d2" class="ld js hi kz b fi li lf l lg lh">{<br/>  "petDetails": {<br/>    "petName": "Maximus",<br/>    "petAge": 5,<br/>    "petOwner": "Nithin Mallya",<br/>    <strong class="kz hj">"petBreed": "German Shepherd Dog"</strong><br/>  },<br/>  "petMedicalHistory": {<br/>    "vaccinationList": [<br/>      "Bordetella, Leptospirosis, Rabies, Lyme Disease"<br/>    ]<br/>  }<br/>}</span></pre><p id="f161" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">而且很管用！</p><blockquote class="il im in"><p id="5c63" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated"><strong class="ir hj"> <em class="hi">这就引出了一个问题:难道我们不能用</em></strong><a class="ae jn" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#canary-deployment" rel="noopener ugc nofollow" target="_blank"><strong class="ir hj"><em class="hi">Kubernetes金丝雀部署</em> </strong> </a> <strong class="ir hj"> <em class="hi">来做这件事吗？简单的回答是肯定的。</em>T25】</strong></p></blockquote><p id="63f8" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">但是，这样做的步骤比较复杂，并且有一些限制:</p><ul class=""><li id="bf65" class="lu lv hi ir b is it iw ix jo md jp me jq mf jm mg ma mb mc bi translated">您仍将创建PetDetailsService的两个部署(v1和v2 ),但是您需要在部署期间手动限制v2副本的数量，以保持v1:v2的比率。例如:您可以用10个副本部署v1，用2个副本部署v2，以实现10:2的负载平衡，依此类推。</li><li id="a8fe" class="lu lv hi ir b is mh iw mi jo mj jp mk jq ml jm mg ma mb mc bi translated">由于所有的pods，<strong class="ir hj">与版本</strong>无关，都被同等对待，因此Kubernetes集群中的流量负载平衡仍然具有随机性。</li><li id="2b51" class="lu lv hi ir b is mh iw mi jo mj jp mk jq ml jm mg ma mb mc bi translated">基于流量的自动扩展pod也存在问题，因为我们需要分别自动扩展两个部署，这两个部署会根据每个服务上的流量负载分布表现不同</li><li id="4ad3" class="lu lv hi ir b is mh iw mi jo mj jp mk jq ml jm mg ma mb mc bi translated">如果我们希望根据某些标准(如请求头)只允许/限制某些用户的流量，Kubernetes Canary部署可能无法实现这一点。</li></ul><blockquote class="il im in"><p id="bf71" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated"><strong class="ir hj"> <em class="hi">结论:您刚刚看到了使用Istio创建金丝雀部署和斜坡流量是多么容易。马克西姆斯也很快乐！</em> </strong></p></blockquote><figure class="ku kv kw kx fd ii er es paragraph-image"><div class="er es mm"><img src="../Images/8bc0be6a0a9f676806b43e3c9be36aa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*6uuUOOk5AVyeQ8QTkMFrrg.jpeg"/></div></figure><p id="2891" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated"><strong class="ir hj">资源</strong>:</p><ol class=""><li id="6d5e" class="lu lv hi ir b is it iw ix jo md jp me jq mf jm lz ma mb mc bi translated">本系列文章第一部分:<a class="ae jn" rel="noopener" href="/google-cloud/simplifying-microservices-with-istio-in-google-kubernetes-engine-part-i-849555f922b8">https://medium . com/Google-cloud/simplizing-micro services-with-istio-in-Google-kubernetes-engine-part-I-849555 f 922 b 8</a></li><li id="0e94" class="lu lv hi ir b is mh iw mi jo mj jp mk jq ml jm lz ma mb mc bi translated">本文章系列第二部分:<a class="ae jn" rel="noopener" href="/google-cloud/simplifying-microservices-with-istio-in-google-kubernetes-engine-part-ii-7461b1833089">https://medium . com/Google-cloud/simplizing-micro services-with-istio-in-Google-kubernetes-engine-part-II-7461 b 1833089</a></li><li id="819f" class="lu lv hi ir b is mh iw mi jo mj jp mk jq ml jm lz ma mb mc bi translated">Istio主页<a class="ae jn" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank">https://istio.io/</a></li><li id="9490" class="lu lv hi ir b is mh iw mi jo mj jp mk jq ml jm lz ma mb mc bi translated">DevOxx Istio演示由<a class="mn mo ge" href="https://medium.com/u/a535baed6389?source=post_page-----6b62876d0a7d--------------------------------" rel="noopener" target="_blank">Ray Tsang</a>:<a class="ae jn" href="https://www.youtube.com/watch?v=AGztKw580yQ&amp;t=231s" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=AGztKw580yQ&amp;t = 231秒</a></li><li id="8a94" class="lu lv hi ir b is mh iw mi jo mj jp mk jq ml jm lz ma mb mc bi translated">Github链接到这个例子:<a class="ae jn" href="https://github.com/nmallya/istiodemo" rel="noopener ugc nofollow" target="_blank">https://github.com/nmallya/istiodemo</a></li><li id="1fb1" class="lu lv hi ir b is mh iw mi jo mj jp mk jq ml jm lz ma mb mc bi translated">库伯内斯:<a class="ae jn" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/</a></li></ol></div></div>    
</body>
</html>