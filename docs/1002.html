<html>
<head>
<title>gRPC Transcoding</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">gRPC代码转换</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/grpc-transcoding-e101cc53d51d?source=collection_archive---------1-----------------------#2019-05-18">https://medium.com/google-cloud/grpc-transcoding-e101cc53d51d?source=collection_archive---------1-----------------------#2019-05-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="07ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我正在开发一些受益于gRPC的代码。稍微跑题一下(提前考虑，以便于测试)，我想探索gRPC-JSON代码转换。</p><p id="8fe5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谁知道有这么多选择:</p><ul class=""><li id="2aa7" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><a class="ae jm" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http_filters/grpc_json_transcoder_filter" rel="noopener ugc nofollow" target="_blank">特使gRPC-JSON转码</a></li><li id="ea07" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated"><a class="ae jm" href="https://grpc-ecosystem.github.io/grpc-gateway/" rel="noopener ugc nofollow" target="_blank">grpc-网关</a></li><li id="90b5" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated"><a class="ae jm" href="https://github.com/grpc/grpc-web" rel="noopener ugc nofollow" target="_blank"> grpc-web </a></li><li id="b971" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">谷歌云端点(<a class="ae jm" href="https://cloud.google.com/endpoints/docs/grpc/about-grpc" rel="noopener ugc nofollow" target="_blank">链接</a>)</li></ul><p id="b79c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">salmaan rashid (和我)是Envoy的粉丝，他推荐我尝试它的gRPC-JSON转码器。它工作了，但是我花了一段时间让我的配置工作，我仍然不能让其余的调用成功。</p><blockquote class="ju jv jw"><p id="b8e9" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated"><strong class="ih hj">更新2019-05-19</strong>:REST通话现在正常。见故事结尾。</p></blockquote><p id="4a1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这能帮助你避免同样的陷阱。</p><p id="ac7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">总之——在Linux上——我为<code class="du kb kc kd ke b">envoy.yaml</code>找到了这个工作组合:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="9ee7" class="kn ko hi ke b fi kp kq l kr ks">cluster_name: grpc<br/>  endpoints:<br/>  - lb_endpoints:<br/>    - endpoint:<br/>        address:<br/>          socket_address:<br/>            address: <strong class="ke hj">0.0.0.0</strong><br/>            port_value: 50051</span></pre><blockquote class="ju jv jw"><p id="6dc6" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">我认为<code class="du kb kc kd ke b">host.docker.internal</code>在Linux上不起作用，但是这个解决方案应该可以跨平台工作。</p></blockquote><p id="302a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，最简单的方法是使用以下命令与容器共享主机网络:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="cf3f" class="kn ko hi ke b fi kp kq l kr ks">docker run \<br/>--interactive --tty --rm <br/>--<strong class="ke hj">net=host</strong> \<br/>--volume=${WORK_DIR}/envoy.yaml:/etc/envoy/envoy.yaml \<br/>--volume=${WORK_DIR}/envoy/proto.pb:/tmp/envoy \<br/>envoyproxy/envoy</span></pre><blockquote class="ju jv jw"><p id="3d00" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>调整卷安装，以反映<code class="du kb kc kd ke b">envoy.yaml</code>文件的位置和原始描述符集的路径(<code class="du kb kc kd ke b">proto.pb</code>)。不要忘记生成原型描述符集，这对我来说是新的。</p></blockquote><p id="fe52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">gRPC </p><p id="6a1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了调试这个，我使用了<code class="du kb kc kd ke b"><a class="ae jm" href="https://github.com/fullstorydev/grpcurl" rel="noopener ugc nofollow" target="_blank">gRPCurl</a></code>,如果你和我一样，错过了卷曲gRPC服务的能力，这是一个有用的工具。使用它，您可以:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="7e3a" class="kn ko hi ke b fi kp kq l kr ks">HELLOWORLD=${GOPATH}/src/google.golang.org/grpc/examples/helloworld<br/>GOOGLEAPIS=${GOPATH}/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis</span><span id="79da" class="kn ko hi ke b fi kt kq l kr ks">grpcurl \<br/>--plaintext \<br/>--import-path=${HELLOWORLD} \<br/>--import-path=${GOOGLEAPIS} \<br/>--proto=helloworld/helloworld.proto \<br/><strong class="ke hj">${SERVER}</strong> \<br/><strong class="ke hj">helloworld.Greeter/SayHello</strong><br/>{<br/>  "message": "Hello "<br/>}</span></pre><blockquote class="ju jv jw"><p id="9de2" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated"><strong class="ih hj">NB</strong>T5】可以是直接的，例如<code class="du kb kc kd ke b">:5<strong class="ih hj">0</strong>051</code>或通过代理<code class="du kb kc kd ke b">:5<strong class="ih hj">1</strong>051</code>。关于增加<code class="du kb kc kd ke b">${GOOGLEAPIS}</code>的原因，见下文休息部分。</p></blockquote><p id="e42d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="d902" class="kn ko hi ke b fi kp kq l kr ks">grpcurl \<br/>...<br/>${SERVER} \<br/><strong class="ke hj">list</strong><br/>helloworld.Greeter</span><span id="147f" class="kn ko hi ke b fi kt kq l kr ks">grpcurl<br/>...<br/>${SERVER} \<br/><strong class="ke hj">list helloworld.Greeter</strong><br/>helloworld.Greeter.SayHello</span></pre><p id="e3f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然这些结果不是由服务器提供的，而是通过自省提供的原型。</p><p id="f7da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">休息</strong></p><p id="108a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">嗯…..还没工作:-(</p><p id="75da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，我确信代码转换配置正确，因为我可以通过它路由gRPC流量。</p><p id="0b51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我没有注意到在定义REST映射的Envoy文档中添加到原型的注释:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="ad93" class="kn ko hi ke b fi kp kq l kr ks">service Greeter {<br/>  // Sends a greeting<br/>  rpc SayHello (HelloRequest) returns (HelloReply) {<br/><strong class="ke hj">    option (google.api.http) = {<br/>      get: "/say"<br/>    };<br/></strong>  }<br/>}</span></pre><p id="9731" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，在生成原型描述符集之前添加这些，然后在运行<code class="du kb kc kd ke b">protoc</code>时需要引用Google API:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="e1f3" class="kn ko hi ke b fi kp kq l kr ks">HELLOWORLD=${GOPATH}/src/google.golang.org/grpc/examples/helloworld<br/>GOOGLEAPIS=${GOPATH}/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis</span><span id="1475" class="kn ko hi ke b fi kt kq l kr ks">protoc \<br/>--proto_path=${HELLOWORLD} \<br/><strong class="ke hj">--proto_path=${GOOGLEAPIS}</strong> \<br/>--include_imports \<br/>--include_source_info   \<br/>--descriptor_set_out=proto.pb \<br/>helloworld/helloworld.proto</span></pre><p id="3030" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，尽管我尽了最大努力(文档中似乎缺少这方面的内容)，我还是不能<code class="du kb kc kd ke b">curl</code><code class="du kb kc kd ke b">:51051</code>端点:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="82be" class="kn ko hi ke b fi kp kq l kr ks">curl \<br/>--request GET \<br/>--header "Content-Type: application/json" \<br/>--data '{"name":"Freddie"}' \<br/>http://0.0.0.0:51051/<strong class="ke hj">helloworld.Greeter/SayHello</strong></span><span id="cbc4" class="kn ko hi ke b fi kt kq l kr ks">curl \<br/>--header "Content-Type: application/json" \<br/>--data '{"name":"Freddie"}' \<br/>http://0.0.0.0:51051/<strong class="ke hj">say</strong></span><span id="f65e" class="kn ko hi ke b fi kt kq l kr ks">curl \<br/>--request GET \<br/>--header "Content-Type: application/json" \<br/><a class="ae jm" href="http://0.0.0.0:51051/helloworld.Greeter/SayHello" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:51051/</a>say?name=Freddie</span><span id="dfec" class="kn ko hi ke b fi kt kq l kr ks">upstream connect error or disconnect/reset before headers. reset reason: remote reset</span></pre><p id="6bba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">鉴于:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="a89b" class="kn ko hi ke b fi kp kq l kr ks">grpcurl \<br/>--plaintext \<br/>--import-path=${HELLOWORLD} \<br/>--import-path=${GOOGLEAPIS} \<br/>--proto=helloworld/helloworld.proto \<br/>-d '{"name":"Freddie"}' \<br/>:51051 \<br/>helloworld.Greeter/SayHello<br/>{<br/>  "message": "Hello Freddie"<br/>}</span></pre><p id="0890" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个相关的困难是，Envoy代理(按照配置)没有提供太多的报告，因此我没有信息来指导我找到解决方案。</p><p id="af70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我会更新这个故事——要么当我意识到，要么当有人指出——我的错误。</p><p id="4c0f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">工作！</strong></p><p id="00b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在另一台机器上再现了该解决方案，并且能够通过Envoy代理成功地发出请求:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="4128" class="kn ko hi ke b fi kp kq l kr ks">curl \<br/>--header "Content-Type: application/<strong class="ke hj">json</strong>" \<br/><a class="ae jm" href="http://localhost:51051/say?name=Frederik" rel="noopener ugc nofollow" target="_blank">http://localhost:51051/say?name=Frederik</a><br/>{<br/> "message": "Hello Frederik"<br/>}</span><span id="c5ad" class="kn ko hi ke b fi kt kq l kr ks">curl <a class="ae jm" href="http://localhost:51051/say?name=Frederik" rel="noopener ugc nofollow" target="_blank">http://localhost:51051/say?name=Frederik</a><br/>{<br/> "message": "Hello Frederik"<br/>}</span></pre><p id="57d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下变体*不*工作:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="7e77" class="kn ko hi ke b fi kp kq l kr ks">curl \<br/>--header "Content-Type: application/<strong class="ke hj">grpc</strong>" \<br/><a class="ae jm" href="http://localhost:51051/say" rel="noopener ugc nofollow" target="_blank">http://localhost:51051/say</a></span><span id="3f4a" class="kn ko hi ke b fi kt kq l kr ks">curl \<br/>--<strong class="ke hj">data</strong> '{"name":"Henry"}' \<br/><a class="ae jm" href="http://localhost:51051/say" rel="noopener ugc nofollow" target="_blank">http://localhost:51051/say</a><br/>upstream connect error or disconnect/reset before headers. reset reason: remote reset</span></pre><p id="1ad7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我确信另一台机器上有网络(配置)问题。</p></div></div>    
</body>
</html>