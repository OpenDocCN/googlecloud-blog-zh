<html>
<head>
<title>How to Query Balances for all Ethereum Addresses in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在BigQuery中查询所有以太坊地址的余额</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-query-balances-for-all-ethereum-addresses-in-bigquery-fb594e4034a7?source=collection_archive---------0-----------------------#2018-11-13">https://medium.com/google-cloud/how-to-query-balances-for-all-ethereum-addresses-in-bigquery-fb594e4034a7?source=collection_archive---------0-----------------------#2018-11-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b0e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最近，我们在big query:<a class="ae jd" href="https://bigquery.cloud.google.com/table/bigquery-public-data:crypto_ethereum.traces" rel="noopener ugc nofollow" target="_blank">https://big query . cloud . Google . com/table/big query-public-data:crypto _ ether eum . traces</a>的公共以太坊数据集中宣布了事务跟踪(也称为内部事务)的beta可用性。他们允许用他们的余额查询所有以太坊地址。</p><p id="4eb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下查询将为您提供前10名余额:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="94a2" class="jn jo hi jj b fi jp jq l jr js">#standardSQL<br/>select *<br/>from `<!-- -->bigquery-public-data.crypto_ethereum.balances`<br/>order by eth_balance desc<br/>limit 10</span></pre><p id="2554" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jt ju jv jj b">balances</code>表每天更新。如果您需要实时余额，您可以使用以下查询:</p><figure class="je jf jg jh fd jw"><div class="bz dy l di"><div class="jx jy l"/></div></figure><p id="7692" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://bigquery.cloud.google.com/savedquery/869804627112:19aa3cfac30743f19c89e3e5c4e86b03" rel="noopener ugc nofollow" target="_blank">在BigQuery中运行它</a></p><p id="44f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是结果，在写作当天(作为<a class="ae jd" href="https://gist.github.com/medvedev1088/ed32ec9a40a86aff80ecd35a938ca1a3" rel="noopener ugc nofollow" target="_blank"> csv文件</a>):</p><figure class="je jf jg jh fd jw er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es jz"><img src="../Images/f8a641e7e67cfa70b25b7179a1751705.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H4-gdNQ_aG0ehvEdm6drjQ.png"/></div></div></figure><p id="29ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是我们用来获得这一结果的工作流程的高级概述:</p><ol class=""><li id="dee0" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc kl km kn ko bi translated">使用<a class="ae jd" href="https://github.com/blockchain-etl/ethereum-etl" rel="noopener ugc nofollow" target="_blank">以太坊ETL </a>将所有踪迹从奇偶校验节点导出到BigQuery。</li><li id="e079" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">用说明父跟踪失败的状态字段来丰富跟踪。</li><li id="5c0a" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">添加<code class="du jt ju jv jj b">genesis</code>和<code class="du jt ju jv jj b">daofork</code>痕迹。</li><li id="5327" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">编写一个SQL来计算余额。</li></ol><p id="996f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个过程中，我不得不解决一些有趣的挑战，我将在下面的章节中揭示这些挑战。</p><h2 id="51a8" class="jn jo hi bd ku kv kw kx ky kz la lb lc iq ld le lf iu lg lh li iy lj lk ll lm bi translated">计算跟踪状态</h2><p id="d6ad" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated">如<a class="ae jd" href="https://wiki.parity.io/JSONRPC-trace-module" rel="noopener ugc nofollow" target="_blank">奇偶校验的跟踪模块Wiki </a>中所述:</p><p id="670c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有返回踪迹的<code class="du jt ju jv jj b">traceAddress</code>字段给出了调用踪迹中的确切位置[根中的索引，第一个<code class="du jt ju jv jj b">CALL</code>中的索引，第二个<code class="du jt ju jv jj b">CALL</code>中的索引，…]。</p><p id="e00e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">即如果轨迹是:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="7a4e" class="jn jo hi jj b fi jp jq l jr js">A<br/>  CALLs B<br/>    CALLs G<br/>  CALLs C<br/>    CALLs G</span></pre><p id="503c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么它应该看起来像这样:</p><p id="60d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jt ju jv jj b">[ {A: []}, {B: [0]}, {G: [0, 0]}, {C: [1]}, {G: [1, 0]} ]</code></p><p id="42e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">奇偶校验还为每个跟踪提供一个错误字符串，以防失败。不幸的是，它没有考虑到顶级跟踪失败。例如，如果在上面的例子中对C的调用成功了，但是对A的顶级调用由于例如气体耗尽错误而失败，那么对C的调用的跟踪将不会返回任何错误。这是有问题的，因为呼叫中的任何状态改变，包括以太网传输，都被还原。我们希望过滤掉这样的嵌套调用，它们在跟踪中看起来很成功，但实际上由于顶级跟踪失败而被恢复。</p><p id="9209" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您的第一个想法可能是从奇偶校验返回的平面跟踪中重建调用树，对于每个调用，遍历树并查看是否有任何顶级调用失败，相应地设置每个调用的状态。</p><p id="489c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我最终使用的另一个解决方案是，首先查询所有失败的跟踪，然后找到它们的所有子跟踪，并将它们标记为失败。这可以在BigQuery中用下面的SQL轻松完成:<a class="ae jd" href="https://github.com/blockchain-etl/ethereum-etl-airflow/blob/master/dags/resources/stages/enrich/sqls/traces.sql" rel="noopener ugc nofollow" target="_blank">https://github . com/区块链-ETL/以太坊-ETL-air flow/blob/master/DAGs/resources/stages/enrich/SQL/traces . SQL</a></p><p id="9e11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当跟踪成功时,<code class="du jt ju jv jj b">status</code>字段为<code class="du jt ju jv jj b">0</code>,当由于任何操作导致调用本身或任何顶级调用恢复而失败时为<code class="du jt ju jv jj b">1</code>。这与交易收据中的<code class="du jt ju jv jj b">status</code>字段一致。</p><h2 id="5ac2" class="jn jo hi bd ku kv kw kx ky kz la lb lc iq ld le lf iu lg lh li iy lj lk ll lm bi translated">处理刀叉中不规则的状态变化</h2><p id="2853" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated">如果您只是从奇偶校验返回的跟踪中查询余额，这两个地址将出现在顶部:</p><ul class=""><li id="5fb3" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc ls km kn ko bi translated">怀特哈特道—<a class="ae jd" href="https://etherscan.io/address/0xb136707642a4ea12fb4bae820f03d2562ebff487" rel="noopener ugc nofollow" target="_blank">0xb 136707642 a4 ea 12 FB 4 BAE 820 f03d 2562 ebff 487</a></li><li id="e2db" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc ls km kn ko bi translated">dark Dao—<a class="ae jd" href="https://etherscan.io/address/0x304a554a310c7e546dfe434669c62820b7d83490" rel="noopener ugc nofollow" target="_blank">0x 304 a 554 a 310 c 7 e 546 dfe 434669 c 62820 b7d 83490</a></li></ul><p id="d5d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实际上，在写作的当天，上述地址每个只有7个魏。如果你谷歌一下，你会看到维塔利克·布特林<a class="ae jd" href="https://blog.ethereum.org/2016/07/20/hard-fork-completed/" rel="noopener ugc nofollow" target="_blank">https://blog.ethereum.org/2016/07/20/hard-fork-completed/</a>写的这篇关于刀叉的文章。以下是摘要:</p><blockquote class="lt lu lv"><p id="e285" class="if ig lw ih b ii ij ik il im in io ip lx ir is it ly iv iw ix lz iz ja jb jc hb bi translated"><a class="ae jd" href="http://etherscan.io/block/1920000" rel="noopener ugc nofollow" target="_blank">块1920000 </a>包含一个<strong class="ih hj">不规则</strong>状态变更的执行，该状态变更将约1200万ETH从“Dark DAO”和“Whitehat DAO”合同转入<a class="ae jd" href="https://etherscan.io/address/0xbf4ed7b27f1d666546e30d74d50d173d20bca754" rel="noopener ugc nofollow" target="_blank">撤回DAO回收合同</a>。</p></blockquote><p id="05e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">改动的完整说明在这个EIP<a class="ae jd" href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-779.md" rel="noopener ugc nofollow" target="_blank"><em class="lw">https://github . com/ether eum/EIPs/blob/master/EIPS/EIP-779 . MD</em></a><em class="lw">。</em></p><p id="bc8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些不规则的状态变化是不会出现在奇偶校验痕迹中的，所以我只好用这个SQL来查询:<a class="ae jd" href="https://github.com/blockchain-etl/ethereum-etl-airflow/blob/master/sqls/daofork_traces.sql" rel="noopener ugc nofollow" target="_blank">https://github . com/区块链-ETL/以太坊-ETL-air flow/blob/master/sqls/Dao fork _ traces . SQL</a>。然后，结果在以太坊ETL工具中被硬编码为<a class="ae jd" href="https://github.com/blockchain-etl/ethereum-etl/blob/develop/ethereumetl/mainnet_daofork_state_changes.py" rel="noopener ugc nofollow" target="_blank">并被摄取到BigQuery数据集。</a></p><p id="3ff7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些不规则痕迹的<code class="du jt ju jv jj b">trace_type</code>栏是<code class="du jt ju jv jj b">daofork</code>。我必须添加到表格中的另一种特殊类型的轨迹是<code class="du jt ju jv jj b">genesis</code>，它们是<a class="ae jd" href="https://github.com/ethereum/ethereumj/blob/develop/ethereumj-core/src/main/resources/genesis/frontier.json" rel="noopener ugc nofollow" target="_blank">初始乙醚分配</a>。它们不与任何事务相关联，因此不会在事务或跟踪API中返回。</p><h2 id="b33a" class="jn jo hi bd ku kv kw kx ky kz la lb lc iq ld le lf iu lg lh li iy lj lk ll lm bi translated">限制</h2><p id="ad7b" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated">来自<a class="ma mb ge" href="https://medium.com/u/57ffb51f1e81?source=post_page-----fb594e4034a7--------------------------------" rel="noopener" target="_blank"> alethio </a>的Johannes Pfeffer帮助识别查询结果中显示的余额与以太坊节点报告的余额不匹配的地址。这是地址列表:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="4fe3" class="jn jo hi jj b fi jp jq l jr js"><a class="ae jd" href="https://etherscan.io/address/0x4509008d923ef571fc1d29fd66d3135fa02f0b64" rel="noopener ugc nofollow" target="_blank">0x4509008d923ef571fc1d29fd66d3135fa02f0b64</a><br/>0xe5449e9a4f31c38d926b76f76571e5d0b143ef5d<br/>0x0000000000000000000000000000000000000001<br/>0x1f78775c8260df084f9a0e5fbdf06487b875ac4d<br/>0x0000000000000000000000000000000000000003</span></pre><p id="87f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可能的根本原因是奇偶校验<a class="ae jd" href="https://github.com/paritytech/parity-ethereum/issues/7765" rel="noopener ugc nofollow" target="_blank">https://github.com/paritytech/parity-ethereum/issues/7765</a>中的这个问题，它导致API结果中缺少对预编译契约的调用。</p><p id="a90d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将需要重新同步我们的奇偶校验节点，重新运行ETL，之后这个问题将得到解决。</p><h2 id="006a" class="jn jo hi bd ku kv kw kx ky kz la lb lc iq ld le lf iu lg lh li iy lj lk ll lm bi translated">挑战</h2><p id="2ce1" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated">可以在每个日期查询每个地址的余额。尝试编写一个查询，返回非零余额的地址数量，并绘制一段时间的曲线图。在评论中发布你的SQL。(<a class="ae jd" rel="noopener" href="/google-cloud/plotting-ethereum-address-growth-chart-55cc0e7207b2">解决方案</a>)</p><p id="dc2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另请参阅:</p><ul class=""><li id="b43a" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc ls km kn ko bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/plotting-ethereum-address-growth-chart-55cc0e7207b2">如何查询任意日期所有以太坊地址的余额</a></li><li id="3111" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc ls km kn ko bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/real-time-ethereum-notifications-for-everyone-for-free-a76e72e45026">实时以太坊免费通知大家</a></li><li id="c458" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc ls km kn ko bi translated"><a class="ae jd" href="https://cloud.google.com/blog/products/data-analytics/ethereum-bigquery-how-we-built-dataset" rel="noopener ugc nofollow" target="_blank">big query中的以太坊:我们如何构建这个数据集</a></li><li id="5aa8" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc ls km kn ko bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/how-to-query-ether-supply-in-bigquery-90f8ae795a8">如何在BigQuery中查询乙醚供应</a></li><li id="5cb7" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc ls km kn ko bi translated">在推特上关注我们:【https://twitter.com/EthereumETL T2】</li></ul></div></div>    
</body>
</html>