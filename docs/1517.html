<html>
<head>
<title>Authenticating users with Google Sign-in</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google登录验证用户</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/authenticating-users-with-google-sign-in-cb257d4fc722?source=collection_archive---------2-----------------------#2020-07-14">https://medium.com/google-cloud/authenticating-users-with-google-sign-in-cb257d4fc722?source=collection_archive---------2-----------------------#2020-07-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3c46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我讨厌处理用户认证，所以我很乐意让用户管理和认证成为别人的问题。像谷歌这样的“人家”。安全地处理用户信息，支持各种多因素认证，实现帐户恢复，同时避免帐户劫持…这些都是谷歌比我处理得好得多！</p><p id="7a3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对我来说不幸的是，我发现让谷歌为我做这件事很令人困惑。哦，在谷歌的网站上有关于如何做的准确而详细的信息。很多信息。关于很多不同的方法。主要是使用库，至少对我来说，很难调试我做错的事情。所以我决定从基础做起，详细地完成让我的服务器端网络应用程序使用谷歌登录所需的基本步骤。这篇博文展示了我是如何做到的，如果你愿意，你也可以这样做。</p><h1 id="8a7c" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">逻辑步骤</h1><p id="1876" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我喜欢为我的应用程序管理会话，所以我真正的问题是在我创建这样的会话之前验证用户的身份。其步骤如下:</p><ol class=""><li id="fe3d" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc kl km kn ko bi translated">浏览器向我的应用程序发送请求。我的服务器检查是否有当前活动的会话，如它设置和信任的cookie所指示的。如果有也没关系，我的app返回请求的页面。否则，我的应用程序<strong class="ih hj">会返回一个网页</strong>，声明用户需要认证才能进一步使用该网站。该页面有一个链接，用户应该点击这样做。(或者，我的应用程序可以只发送一个链接的重定向响应，但这很突然，可能会让用户感到困惑。)</li><li id="f377" class="kg kh hi ih b ii kq im kr iq ks iu kt iy ku jc kl km kn ko bi translated"><em class="kp">用户点击链接，浏览器向谷歌发送页面请求。那个链接是到accounts.google.com的一个谷歌页面。该链接的确切格式将在本文稍后描述。谷歌将返回网页，并根据需要处理响应，以验证用户身份。如果认证成功，Google将<strong class="ih hj">返回一个指向我的站点页面的重定向响应</strong>。</em></li><li id="f94f" class="kg kh hi ih b ii kq im kr iq ks iu kt iy ku jc kl km kn ko bi translated"><em class="kp">用户的浏览器通过向我的应用程序发送请求来处理重定向。</em>我的服务器使用重定向URL中的信息从Google检索用户信息。这种检索是从我的网络服务器到谷歌，而不是从用户的浏览器。如果一切顺利，我的服务器现在知道用户是谁，所以服务器创建一个会话，然后<strong class="ih hj">向用户返回一个响应</strong>，其中包含一个头，为该会话设置一个cookie。这个响应<strong class="ih hj">可能是一个网页，或者重定向</strong>到用户最初请求的页面。但是现在用户的浏览器有了有效的会话cookie，用户可以访问我的站点了。</li></ol><p id="1bfa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这三个步骤中，我的服务器必须处理<strong class="ih hj">步骤1 </strong>，在这里它得到一个请求，这个请求可能有也可能没有与之相关联的活动会话，如果没有，就必须用一个页面进行响应，或者用正确的URL进行重定向。该URL将用户的浏览器发送到谷歌进行<strong class="ih hj">步骤2</strong>；这是谷歌要处理的，所以我的应用程序没有参与。最后，谷歌将浏览器重定向回我的应用程序进行<strong class="ih hj">步骤3 </strong>，我的服务器必须使用重定向URL中的信息来获取用户的身份。</p><p id="d186" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么我们来看看一个app是如何处理<strong class="ih hj">步骤1 </strong>和<strong class="ih hj">步骤3 </strong>的。但是首先，有一个<strong class="ih hj">步骤0 </strong>。当任何人要求时，谷歌都不会确认用户身份。想要使用Google Sign-in的应用程序需要首先向Google注册。</p><p id="ac77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们来看看让您的web服务器使用Google sign-in所需的步骤。</p><h1 id="1955" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">第0步——向谷歌注册应用程序</h1><p id="a444" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">你需要在console.cloud.google.com<a class="ae kv" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">创建一个谷歌云平台项目。为此，你可以使用Gmail或G Suite帐户，或者在被要求时创建一个普通的Google Cloud帐户。你可能必须提供一张信用卡，但有一个慷慨的免费试用，如果没有事先通知，试用结束时你不会收到账单，而且在任何情况下，这种注册不需要使用任何目前需要花钱的服务。</a></p><p id="26bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦有了项目，使用控制台左侧的菜单选择<strong class="ih hj">API&amp;服务</strong>，然后选择<strong class="ih hj"> OAuth同意屏幕</strong>。除非您打算只验证您控制的G Suite域中的用户，否则您的应用程序将被视为外部应用程序，因此您将选择该应用程序并单击<strong class="ih hj">创建</strong>。在页面中填入关于应用程序的信息(您可以随意命名)并保存。然后您需要转到<strong class="ih hj">凭证</strong>选项卡(您可能会被自动引导到那里),并为您的web应用程序创建一个<strong class="ih hj"> OAuth客户端ID </strong>。作为其中的一部分，你应该注册一个<strong class="ih hj">授权的重定向URL </strong>。这是您的应用程序中的URL，将在<strong class="ih hj">步骤3 </strong>中调用。</p><p id="0774" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您完成此步骤时，您将从您创建的凭证中获得一个<strong class="ih hj">客户端ID </strong>和<strong class="ih hj">客户端秘密</strong>。您还将为步骤3选择并注册<strong class="ih hj">重定向_URI </strong>。您将在下面的步骤中使用它们。</p><h1 id="3892" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">步骤1 —提供登录URL</h1><p id="5c55" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">当您的服务器收到不包含有效会话cookie的请求时，它会回复一个包含指向特定登录地址的链接的页面，或者回复一个指向相同地址的重定向响应。这一步的任务是创建地址。</p><p id="e371" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是地址，显示时分成几行，但实际应用程序都在一行上:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="766c" class="lf je hi lb b fi lg lh l li lj"><a class="ae kv" href="https://accounts.google.com/signin/oauth?" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com/signin/oauth?</a><br/>response_type=code&amp;<br/>client_id=CLIENT_ID&amp;<br/>scope=openid%20email&amp;<br/>redirect_uri=REDIRECT_URI&amp;<br/>state=STATE</span></pre><p id="051d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大写字母的单词都需要替换为正确的值。步骤0为<strong class="ih hj">客户端ID </strong>和<strong class="ih hj">重定向URI </strong>提供了这些值。<strong class="ih hj">状态</strong>的值几乎可以是你想要的任何字符串——应用程序在<strong class="ih hj">步骤3 </strong>中指向的URL将包括它，所以这是一种将信息从这一步传递到那一步的方式。我通常把最初请求的页面的路径放在这里。</p><p id="0e00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lk ll lm lb b">response_type=code</code>参数要求最终的重定向请求包含一个代码，该代码可用于检索有关登录结果的信息。<code class="du lk ll lm lb b">scope=open_id%20email</code>表示应用程序想要的信息是登录用户的电子邮件地址。</p><h1 id="c81e" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">步骤2 —验证用户</h1><p id="5522" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">这是谷歌的问题，不是你的问题。但是谷歌会检查一下:</p><ul class=""><li id="6dde" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc ln km kn ko bi translated">要求这样做的应用程序已经在Google上注册了(客户端标识<strong class="ih hj">)</strong></li><li id="aae6" class="kg kh hi ih b ii kq im kr iq ks iu kt iy ku jc ln km kn ko bi translated">将用户送回的位置(<strong class="ih hj">重定向_URI </strong>)是为该应用程序注册的</li></ul><p id="9497" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌还会告诉用户你注册应用程序时给它起的名字，以及一个应用程序隐私政策的链接，如果有的话。最终，如果用户同意并通过验证，Google将向用户的浏览器发送一个重定向响应，然后浏览器将向您的服务器发出请求，开始<strong class="ih hj">步骤3 </strong>。</p><h1 id="bcb8" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">步骤3 —检索用户信息</h1><p id="84e0" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">当用户的浏览器向谷歌响应指定的<strong class="ih hj"> REDIRECT_URI </strong>发出请求时，这一步开始。该请求将包括查询参数，并且具有以下形式:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="4882" class="lf je hi lb b fi lg lh l li lj">REDIRECT_URI?state=STATE&amp;code=CODE.</span></pre><p id="cc5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你的应用程序的服务器将使用这些查询参数值(<strong class="ih hj">状态</strong>和<strong class="ih hj">代码</strong>)来获取用户的身份信息。<strong class="ih hj">状态</strong>的值就是服务器在<strong class="ih hj">步骤1 </strong>中发回的值。这有利于保持从这一步到下一步的连续性，因为就服务器而言，这个请求可能来自当前正在进行身份验证的任何用户。当被告知用户需要首先进行身份验证时，服务器没有其他方法可以知道用户正在尝试访问应用程序中的哪个页面。</p><p id="4fbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">代码</strong>值本身不包含任何用户信息，但是服务器可以用它来获取这些信息。为此，服务器(用户的浏览器)将向<code class="du lk ll lm lb b"><a class="ae kv" href="https://oauth2.googleapis.com/token" rel="noopener ugc nofollow" target="_blank">https://oauth2.googleapis.com/token</a></code>发出HTTP POST请求，所需的信息将作为响应的主体返回。POST请求的主体应该具有内容类型<strong class="ih hj">application/x-www-form-urlencoded</strong>，并包括以下值(与前面一样，为了清楚起见，这被分成多行，但是请求主体应该都在一行中):</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="c715" class="lf je hi lb b fi lg lh l li lj">code=CODE&amp;<br/>client_id=CLIENT_ID&amp;<br/>client_secret=CLIENT_SECRET&amp;<br/>redirect_uri=REDIRECT_URI&amp;<br/>grant_type=authorization_code</span></pre><p id="0ed8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">代码</strong>是从用户浏览器发送的查询参数中提取的值。<strong class="ih hj">客户端ID </strong>、<strong class="ih hj">客户端秘密</strong>和<strong class="ih hj">重定向URI </strong>是来自步骤0的值。并且<code class="du lk ll lm lb b">grant_type=authorization_code</code>告诉谷歌你的应用服务器正在提供什么样的代码。</p><p id="9155" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对这个POST请求的响应将是一个包含用户信息的<strong class="ih hj">应用程序/json </strong>主体。这个JSON对象中的一个字段叫做<strong class="ih hj"> id_token </strong>，它的值是一个<a class="ae kv" href="https://en.wikipedia.org/wiki/JSON_Web_Token" rel="noopener ugc nofollow" target="_blank"> JSON Web Token </a> (JWT)。这是一段经过数字签名的数据，其中包含有关用户的字段，包括:电子邮件地址、发布者(在本例中为<code class="du lk ll lm lb b"><a class="ae kv" href="https://accounts.google.com" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com</a></code>)、受众(即该令牌的目标接收者，即您的应用程序)和有效期。您可以自己完成所有的加密和解析工作，但是Python库<code class="du lk ll lm lb b"><a class="ae kv" href="https://google-auth.readthedocs.io/en/latest/reference/google.oauth2.id_token.html" rel="noopener ugc nofollow" target="_blank">google.oauth2.id_token</a></code>可以处理这些工作，包括验证数字签名是否有效以及是否来自Google。</p><p id="1d80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦您的服务器有了这些信息，它就可以将用户的信息保存在一个会话对象中，并设置一个指向该会话的cookie。身份验证工作已经完成。</p><h1 id="147e" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">信息流</h1><p id="747d" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">你的应用服务器和谷歌登录服务之间的信息以两种方式流动:间接通过用户的浏览器，以及直接从你的应用服务器到谷歌。间接信息是在浏览器请求的URL的查询参数中提供的，要么是对你的应用程序将浏览器发送给谷歌的响应，要么是谷歌将浏览器定向回来。这些查询参数包括<strong class="ih hj">客户端ID </strong>、<strong class="ih hj">重定向_URI </strong>、<strong class="ih hj">状态</strong>和<strong class="ih hj">代码</strong>。</p><p id="b4dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">敏感信息不能通过这种方式(通过浏览器)传递，因为它可能会被截取并在预期的上下文之外使用。这就是为什么谷歌只是将一个不透明的代码发送回你的应用，而不是用户的电子邮件地址。敏感信息必须在你的应用服务器和谷歌服务之间直接安全地传递。这是通过<strong class="ih hj">步骤3 </strong>中的POST请求和响应实现的。该连接返回用户的身份，谷歌只愿意在用户批准后提供给你的注册应用，并传递<strong class="ih hj"> CLIENT_SECRET </strong>，你的服务器用它向谷歌证明自己的身份。</p><h1 id="1403" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">示例应用程序</h1><p id="c743" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我在GitHub 上分享了一个示例应用程序的<a class="ae kv" href="https://github.com/engelke/google-signin-demo" rel="noopener ugc nofollow" target="_blank">源代码，展示了所有这些如何在一个极小的web应用程序中工作。你可以为谷歌云平台注册一个项目，然后运行这个代码来尝试。我为Google App Engine写了代码，但是它应该可以在任何地方运行。它可以在云上运行或计算引擎，或者不同的云提供商，或者您自己的数据中心，甚至您自己的测试桌面。暂时可以</a><a class="ae kv" href="https://engelke-signin-demo.uc.r.appspot.com" rel="noopener ugc nofollow" target="_blank">试试这里</a>。</p></div><div class="ab cl lo lp gp lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="hb hc hd he hf"><p id="f889" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp">原载于2020年7月14日</em><a class="ae kv" href="https://engelke.dev/2020/07/14/authenticating-users-with-google-sign-in/" rel="noopener ugc nofollow" target="_blank"><em class="kp">http://engelke . dev</em></a><em class="kp">。</em></p></div></div>    
</body>
</html>