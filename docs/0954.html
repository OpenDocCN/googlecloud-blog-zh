<html>
<head>
<title>Scheduled Mirror/Sync SFTP to GCS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">计划将SFTP镜像/同步到GCS</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/scheduled-mirror-sync-sftp-to-gcs-b167d0eb487a?source=collection_archive---------0-----------------------#2019-03-25">https://medium.com/google-cloud/scheduled-mirror-sync-sftp-to-gcs-b167d0eb487a?source=collection_archive---------0-----------------------#2019-03-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="7dc1" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">语境</strong></h1><p id="0043" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">应用程序通常需要松散耦合的文件共享系统。有时，数据文件需要在不共享存储基础架构的公司或公司内的团队之间共享。在这种情况下，SFTP是常见的接口。</p><h1 id="84d2" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">为什么要将文件同步到谷歌云存储？</strong></h1><p id="ad17" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">而GCP上的应用程序可以直接从SFTP服务器读取。但在某些情况下，将文件同步到GCS可能是首选方法。您考虑设置同步的原因:</p><ul class=""><li id="fe9d" class="kb kc hi jf b jg kd jk ke jo kf js kg jw kh ka ki kj kk kl bi translated">应用程序的一致文件源</li><li id="d11f" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">细粒度访问控制列表(ACL)</li><li id="7254" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">轻松的文件生命周期管理</li><li id="31a9" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">减轻网络剥落</li></ul></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><h1 id="78d1" class="if ig hi bd ih ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc bi translated">解决方案概述</h1><ul class=""><li id="f580" class="kb kc hi jf b jg jh jk jl jo ld js le jw lf ka ki kj kk kl bi translated">GCS用于在虚拟机上安装存储桶</li><li id="1419" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">安排lftp命令定期镜像文件</li><li id="a7f1" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">不需要编码，只使用工具。</li></ul><h1 id="6986" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">我们开始吧</h1><p id="87ff" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">如果你还没有使用谷歌云，你可以前往https://console.cloud.google.com的<a class="ae lg" href="https://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank">注册一个300美元起的免费账户。</a></p><ol class=""><li id="40ab" class="kb kc hi jf b jg kd jk ke jo kf js kg jw kh ka lh kj kk kl bi translated">打开云壳。</li></ol><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es li"><img src="../Images/70e72acdf9f01c871829d1b26d75a089.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W0CDGYhKx_k4tNtW.png"/></div></div></figure><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es li"><img src="../Images/9cd588718f2bbd6f0f5cd1517d6d8e2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VcNGvqDrnbfxcH4s.png"/></div></div></figure><p id="964f" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">2.创建一个具有唯一名称的新存储桶。</p><pre class="lj lk ll lm fd lx ly lz ma aw mb bi"><span id="c304" class="mc ig hi ly b fi md me l mf mg">gcs_bucket=”sftp_bucket_”$(python -c “import uuid; print str(uuid.uuid4())”)<br/>gsutil mb gs://$gcs_bucket</span></pre><p id="5bf5" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">3.创建新的虚拟机实例</p><p id="ccfd" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">VM实例可以通过UI或gcloud命令创建，如下所示。<br/>在UI中，将访问范围更改为访问范围- &gt;存储- &gt;满<br/>或者从云外壳执行以下命令。</p><pre class="lj lk ll lm fd lx ly lz ma aw mb bi"><span id="f8a5" class="mc ig hi ly b fi md me l mf mg">gcloud compute instances create sftp-test --zone=us-central1-c --machine-type=n1-standard-1 --subnet=default  --scopes=<a class="ae lg" href="https://www.googleapis.com/auth/cloud-platform" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/cloud-platform</a> --image-family=ubuntu-1604-lts --image-project=ubuntu-os-cloud --boot-disk-size=10GB --boot-disk-type=pd-standard --boot-disk-device-name=sftp-test</span></pre><p id="fdb7" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">上述命令将在默认网络和子网中创建虚拟机。</p><p id="f912" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">4.SSH进入虚拟机</p><p id="6b49" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">在SSH的云shell中键入以下命令</p><pre class="lj lk ll lm fd lx ly lz ma aw mb bi"><span id="3c54" class="mc ig hi ly b fi md me l mf mg">gcloud compute ssh sftp-test</span></pre><p id="6efb" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">5.在虚拟机上安装lftp</p><p id="c6a6" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">Lftp工具是文件下载的瑞士军刀，它与包括sftp在内的许多协议一起工作。</p><pre class="lj lk ll lm fd lx ly lz ma aw mb bi"><span id="5667" class="mc ig hi ly b fi md me l mf mg">sudo apt-get install lftp</span></pre><p id="c1f0" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">6.在虚拟机上安装gcsfuse</p><pre class="lj lk ll lm fd lx ly lz ma aw mb bi"><span id="04ed" class="mc ig hi ly b fi md me l mf mg">export GCSFUSE_REPO=gcsfuse-`lsb_release -c -s`<br/>echo "deb http://packages.cloud.google.com/apt $GCSFUSE_REPO main" | sudo tee /etc/apt/sources.list.d/gcsfuse.list<br/>curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -</span><span id="fbf7" class="mc ig hi ly b fi mh me l mf mg">sudo apt-get update<br/>sudo apt-get install gcsfuse</span></pre><p id="efe6" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">7.在虚拟机上装载存储桶</p><pre class="lj lk ll lm fd lx ly lz ma aw mb bi"><span id="5b29" class="mc ig hi ly b fi md me l mf mg">mkdir ~<em class="mi">/gcsBucket</em><br/>gcsfuse <em class="mi">&lt;replace-by-bucket-name&gt;</em> ~<em class="mi">/gcsBucket</em></span></pre><p id="7a6b" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">将<replace-by-bucket-name>替换为桶名(在步骤2中创建)。不要使用gs://</replace-by-bucket-name></p><p id="4048" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">8.计划lftp命令</p><p id="4f41" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">假设sftp使用用户名和密码进行身份验证。如下创建脚本。</p><pre class="lj lk ll lm fd lx ly lz ma aw mb bi"><span id="38ca" class="mc ig hi ly b fi md me l mf mg">crontab -e</span></pre><p id="e908" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">这将打开一个文件来调度cron作业。</p><pre class="lj lk ll lm fd lx ly lz ma aw mb bi"><span id="e0ee" class="mc ig hi ly b fi md me l mf mg">0 0 * * * lftp sftp://<em class="mi">&lt;username&gt;</em>:<em class="mi">&lt;password&gt;</em>@<em class="mi">&lt;sftp-server-ip/domain&gt;</em>  -e "set sftp:auto-confirm yes;  mirror --verbose <em class="mi">/path/on/sftp</em> <!-- -->~/gcsBucket<!-- --> ;  bye"</span></pre><p id="24f1" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">上述作业安排在每天00:00(基于虚拟机时区，通常为UTC)。<br/>将&lt;用户名&gt;替换为sftp用户名<br/>将&lt;密码&gt;替换为sftp密码<br/>将&lt; sftp-server-ip/domain &gt;替换为sftp url/ip <br/>将/path/on/sftp替换为sftp服务器上的路径</p></div></div>    
</body>
</html>