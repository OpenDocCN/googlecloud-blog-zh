<html>
<head>
<title>SLOs with Stackdriver Service Monitoring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SLOs与Stackdriver服务监控</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/slos-with-stackdriver-service-monitoring-62f193147b3f?source=collection_archive---------0-----------------------#2020-01-22">https://medium.com/google-cloud/slos-with-stackdriver-service-monitoring-62f193147b3f?source=collection_archive---------0-----------------------#2020-01-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2cbe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">服务水平目标是<a class="ae jd" href="https://landing.google.com/sre/" rel="noopener ugc nofollow" target="_blank">现场可靠性工程</a>的基本原则之一。我们使用它们来精确量化我们希望在服务中实现的可靠性目标。我们还使用他们的逆<a class="ae jd" href="https://landing.google.com/sre/sre-book/chapters/embracing-risk/#xref_risk-management_unreliability-budgets" rel="noopener ugc nofollow" target="_blank">误差预算</a>，来做出在任何给定时间我们可以承担多大风险的明智决定。例如，这让我们能够确定我们是否可以推进生产或基础架构升级。</p><p id="a7c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，Stackdriver从来没有给我们实际创建、跟踪、提醒和报告SLO的能力——直到现在。服务监控API在秋天的NEXT London上发布了公开测试版，我想借此机会尝试一下。这是我的发现。</p><h1 id="9248" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">服务</h1><p id="aa2f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在创建服务级别目标之前，我需要一个服务。因为最初发布的<a class="ae jd" href="https://cloud.google.com/monitoring/service-monitoring/" rel="noopener ugc nofollow" target="_blank"> API </a>只支持App Engine、GKE上的Istio和云端点，所以我想我会尝试最简单的选择——App Engine Standard。我用Mux路由器在Go中创建了一个基本的Hello World应用程序——下面是它的<a class="ae jd" href="https://github.com/yuriatgoogle/stack-doctor/tree/master/service-monitoring-demo/gae" rel="noopener ugc nofollow" target="_blank">代码</a>:</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="8f95" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我创建了app.yaml文件:</p><pre class="kh ki kj kk fd ko kp kq kr aw ks bi"><span id="008c" class="kt jf hi kp b fi ku kv l kw kx">runtime: go112 # replace with go111 for Go 1.11</span></pre><p id="841b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我使用“gcloud app deploy”部署了该应用。此时，构建过程失败了，我不得不按照这些<a class="ae jd" href="https://github.com/golang/go/wiki/Modules#how-to-define-a-module" rel="noopener ugc nofollow" target="_blank">指令</a>来定义一个模块。我不是围棋专家，我猜这是一个本地环境配置的问题，我懒得去解决。尽管如此，我还是按照这些说明部署了这个应用程序。</p><p id="af83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我设置了一个全球正常运行时间检查，以获得稳定的流量流向我的新应用程序:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es ky"><img src="../Images/47a60915c33aabfebb3624c91640b614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dgsxpZ7PATyexzKr"/></div></div></figure><h1 id="3552" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">定义SLI</h1><p id="cd5f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在我已经创建了一个服务，可以继续了。我发现关于概念的<a class="ae jd" href="https://cloud.google.com/monitoring/service-monitoring/" rel="noopener ugc nofollow" target="_blank">文档</a>非常有帮助，即使是对这个主题非常熟悉的人。在这个练习中，我想创建一个简单的可用性服务水平指标(SLI ),来衡量“良好”请求占总数的百分比。这需要三个决定:</p><ul class=""><li id="7671" class="lf lg hi ih b ii ij im in iq lh iu li iy lj jc lk ll lm ln bi translated">如何计算请求总数</li><li id="e71a" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">如何计算“好的”请求</li><li id="52dc" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">我的SLI使用什么时间框架</li></ul><p id="3dbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">幸运的是，App Engine提供了一个有用的响应计数指标:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lt"><img src="../Images/4fd384db1d0d78d8b3a768c5bed98af2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_x29foJPRnqGiC68"/></div></div></figure><p id="f2b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">请注意</strong>如果GAE应用程序被禁用(我通过禁用该应用程序来模拟失败，从而了解到这一点)，则不会写入该指标。</p><p id="a381" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此指标可以进一步按响应代码进行筛选:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lu"><img src="../Images/5577b0d61581cf2c167fc1758b7338b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DvS7winl3LMrr-Z3"/></div></div></figure><p id="0a50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了简单起见，我决定使用未过滤的指标来计算请求总数，并过滤响应代码为200的请求来计算“好”的请求。</p><blockquote class="lv lw lx"><p id="fd11" class="if ig ly ih b ii ij ik il im in io ip lz ir is it ma iv iw ix mb iz ja jb jc hb bi translated">N <strong class="ih hj">注意到</strong>这对于任何生产应用来说都可能过于简单。例如，这将把404算作“坏”请求，而它们很可能是错误配置的客户端甚至外部扫描器的结果。</p></blockquote><h1 id="d3f1" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">创造了SLI和SLO</h1><p id="feaa" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">此时，我已经准备好使用<a class="ae jd" href="https://cloud.google.com/monitoring/service-monitoring/identifying-custom-sli" rel="noopener ugc nofollow" target="_blank"> API </a>来定义我的SLO。正如“<a class="ae jd" href="https://cloud.google.com/monitoring/service-monitoring/identifying-custom-sli#configure-sli" rel="noopener ugc nofollow" target="_blank">构建SLI </a>”一节中所推荐的，我使用Metrics Explorer创建了一个图表，显示了我的“总”请求数:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es ky"><img src="../Images/96ce6404538348c1f374fe0763a3ae18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YPWJv5wT82ut6LlQ"/></div></div></figure><p id="3050" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从那里，我能够复制过滤器的JSON:</p><pre class="kh ki kj kk fd ko kp kq kr aw ks bi"><span id="20ea" class="kt jf hi kp b fi ku kv l kw kx">"metric.type=\"appengine.googleapis.com/http/server/response_count\" resource.type=\"gae_app\" resource.label.\"module_id\"=\"default\""</span></pre><p id="3f35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我修改了图表，只统计“好的”请求，过滤response_code=200，并复制了JSON:</p><pre class="kh ki kj kk fd ko kp kq kr aw ks bi"><span id="f1ea" class="kt jf hi kp b fi ku kv l kw kx">"metric.type=\"appengine.googleapis.com/http/server/response_count\" resource.type=\"gae_app\" resource.label.\"module_id\"=\"default\" metric.label.\"response_code\"=\"200\""</span></pre><p id="0719" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，我已经准备好建造SLI了:</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="fa96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我选择了“基于请求”类型的SLI，因为我希望捕捉全部请求中好的部分。其他选项<a class="ae jd" href="https://cloud.google.com/monitoring/service-monitoring/api-structures#sli-structs" rel="noopener ugc nofollow" target="_blank">包括</a> <em class="ly">【基本】</em>，这对于我在这里的目的来说可能已经足够好了，还有“<em class="ly">基于窗口的</em>”，它允许您统计服务满足定义的健康阈值的周期数。我可能会回来，在另一篇文章中重新讨论后者。</p><p id="7df3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从那里，我定义了SLO:</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="91ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我使用<a class="ae jd" href="https://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>将请求提交给API——您可以使用API Explorer甚至curl做同样的事情。响应是成功的，并在正文中返回了SLO的名字:</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><h1 id="0c91" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">警惕SLO</h1><p id="089b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">既然我的SLO已经定义好了，我想实现两件事——为SLO违规创建一个警报，并弄清楚如何在不触发警报的情况下获得状态。我能够使用UI创建一个使用“SLO燃烧率”条件类型的警报策略:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es ky"><img src="../Images/c56c5716d77bab5c4628e53c9a4ec4ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wOwOFr6oTWtFD_Ga"/></div></div></figure><p id="2138" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在设置警报策略时，我遇到了两个字段，它们的含义我并不清楚。第一个是回望持续时间。我在<a class="ae jd" href="https://cloud.google.com/monitoring/alerts/concepts-indepth#condition-types" rel="noopener ugc nofollow" target="_blank">文档</a>中找到了解释——因为燃烧速率从根本上来说是一个变化率条件，你可以选择指定一个定制的回顾窗口。对于其他变化率条件，回看设置为10分钟，不能更改。从变化率条件的文档中:</p><blockquote class="lv lw lx"><p id="21f6" class="if ig ly ih b ii ij ik il im in io ip lz ir is it ma iv iw ix mb iz ja jb jc hb bi translated">该条件对过去10分钟的指标值进行平均，然后将结果与持续时间窗口之前测量的10分钟平均值进行比较。指标变化率条件使用的10分钟回顾窗口是一个固定值；你不能改变它。但是，在创建条件时，您需要指定持续时间窗口。</p></blockquote><h1 id="7e55" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">触发警报</h1><p id="acac" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">配置好我的警报策略后，我想看看如果出现可用性问题会发生什么。我重写了服务，以便有一半时间抛出一个错误:</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="efb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并重新部署了应用程序。很快，我遇到了一个事故:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es mc"><img src="../Images/ea74d2883f1ed2d8a35a5103cc300d00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*odJAfJzA8bPCNqPl"/></div></div></figure><p id="903e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我对此感到满意，并重新部署了原始代码的应用程序，让它再次工作。很快，事件得到了解决。</p><h1 id="3d64" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">正在检索SLO状态</h1><p id="afd4" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">对错误预算烧警报显然是必要的，但有时我们需要在问题出现之前很久就知道我们的SLO的状态。因此，我需要一种方法来查询SLO数据。我遵循了<a class="ae jd" href="https://cloud.google.com/monitoring/service-monitoring/timeseries-selectors" rel="noopener ugc nofollow" target="_blank">文档</a>并使用了监控API的<a class="ae jd" href="https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.timeSeries/list" rel="noopener ugc nofollow" target="_blank"> timeSeries.list </a>方法。</p><p id="13a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想到了我希望能够回答的两个主要问题——在给定的时间段内我的服务的可用性如何，以及在给定的时间点我的误差预算的状态如何？</p><h1 id="02ff" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">SLO地位</h1><p id="fdb6" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">第一个问题用“选择慢动作健康”时间序列来回答。我向<a class="ae jd" href="https://monitoring.googleapis.com/v3/projects/stack-doctor/timeSeries" rel="noopener ugc nofollow" target="_blank">https://monitoring.googleapis.com/v3/projects/&lt;项目ID/时间序列</a>发送了一个带有以下参数的请求:</p><pre class="kh ki kj kk fd ko kp kq kr aw ks bi"><span id="5fd4" class="kt jf hi kp b fi ku kv l kw kx">name:projects/&lt;project ID&gt;</span><span id="217a" class="kt jf hi kp b fi md kv l kw kx">filter:select_slo_health("projects/&lt;project number&gt;/services/gae:&lt;project ID&gt;_default/serviceLevelObjectives/&lt;SLO name&gt;")</span><span id="0daa" class="kt jf hi kp b fi md kv l kw kx">interval.endTime:2020-01-06T17:17:00.0Z</span><span id="60d4" class="kt jf hi kp b fi md kv l kw kx">interval.startTime:2020-01-05T17:17:00.0Z</span><span id="0a5a" class="kt jf hi kp b fi md kv l kw kx">aggregation.alignmentPeriod:3600s</span><span id="0b36" class="kt jf hi kp b fi md kv l kw kx">aggregation.perSeriesAligner:ALIGN_MEAN</span></pre><p id="3ec9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用了在前面的步骤中创建SLO时返回的SLO名称。我还可以调用<a class="ae jd" href="https://monitoring.googleapis.com/v3/projects/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">【https://monitoring.googleapis.com/v3/projects/】</strong></a><strong class="ih hj">&lt;项目ID &gt; /services/gae: &lt;项目ID&gt;_ default/serviceLevelObjectives</strong>来检索我针对默认应用引擎服务配置的SLO。</p><p id="b87a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我指定了一个24小时的间隔来检索数据，使用平均对齐器进行1小时的对齐。如果我要绘制数据图表，我可以使用更短的校准周期和更精确的校准器，但这足以满足我的目的。结果看起来像这样:</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="f526" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如预期的那样，输出显示了在总时间间隔(由interval.startTime和endTime指定)内，每个时间间隔(与我的alignmentPeriod匹配)的良好请求与总请求的百分比。对于我的服务，每个值都是1，这意味着每个小时间隔内100%的请求都是好的。</p><h1 id="ec80" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">错误预算状态</h1><p id="78a4" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我想回答的第二个问题是“我还有多少误差预算？”该操作符是select_slo_budget_fraction。请求中唯一的变化是改变过滤器:</p><pre class="kh ki kj kk fd ko kp kq kr aw ks bi"><span id="8fe3" class="kt jf hi kp b fi ku kv l kw kx">name:projects/&lt;project ID&gt;</span><span id="3a08" class="kt jf hi kp b fi md kv l kw kx">filter:select_slo_budget_fraction("projects/&lt;project number&gt;/services/gae:&lt;project ID&gt;_default/serviceLevelObjectives/&lt;SLO name&gt;")</span><span id="67fa" class="kt jf hi kp b fi md kv l kw kx">interval.endTime:2020-01-06T17:17:00.0Z</span><span id="ae02" class="kt jf hi kp b fi md kv l kw kx">interval.startTime:2020-01-05T17:17:00.0Z</span><span id="53ff" class="kt jf hi kp b fi md kv l kw kx">aggregation.alignmentPeriod:3600s</span><span id="abc2" class="kt jf hi kp b fi md kv l kw kx">aggregation.perSeriesAligner:ALIGN_MEAN</span></pre><p id="2d1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在向timeSeries.list方法发出请求后，我得到了以下返回:</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="7dab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如前所述，每个“值”代表该点剩余的误差预算的一部分。因为我的服务没有消耗错误预算，所以数字保持在1。我还可以使用select_slo_budget操作符来获得实际的剩余预算——剩余的错误数。</p><h1 id="9f48" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">总之…</h1><p id="f13c" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我希望对服务监控API的介绍对您有所帮助。感谢您的阅读，如果您有任何反馈，请告诉我。下次见！</p></div></div>    
</body>
</html>