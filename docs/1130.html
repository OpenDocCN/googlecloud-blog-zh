<html>
<head>
<title>Building a Flask(Python) CRUD API with Cloud Firestore(Firebase) and Deploying on Cloud Run.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Cloud Firestore(Firebase)构建Flask(Python) CRUD API并部署在Cloud Run上。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/building-a-flask-python-crud-api-with-cloud-firestore-firebase-and-deploying-on-cloud-run-29a10c502877?source=collection_archive---------0-----------------------#2019-08-29">https://medium.com/google-cloud/building-a-flask-python-crud-api-with-cloud-firestore-firebase-and-deploying-on-cloud-run-29a10c502877?source=collection_archive---------0-----------------------#2019-08-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/67d59816a3bdef47f4d09ea55838833d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YhhOn62cLCyVKpHQL1Xm0A.png"/></div></div></figure><blockquote class="iq ir is"><p id="c90a" class="it iu iv iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="hi">在本教程中，您将使用Flask(Python的微框架)、Cloud Firestore(Firebase的一个灵活、可扩展的移动、web和服务器开发数据库)构建一个CRUD(创建、读取、更新、删除)API来管理</em> <strong class="iw hj"> <em class="hi">待办事项列表</em> </strong> <em class="hi">，并将该API部署到</em> <a class="ae js" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank"> <em class="hi">云运行</em> </a> <em class="hi">(一个在Google云平台上运行容器的无服务器环境)。</em></p></blockquote><figure class="jt ju jv jw fd ij"><div class="bz dy l di"><div class="jx jy l"/></div></figure><p id="72c2" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jz jg jh ji ka jk jl jm kb jo jp jq jr hb bi translated"><a class="ae js" href="https://firebase.google.com/docs/firestore" rel="noopener ugc nofollow" target="_blank"> Cloud Firestore </a>将数据存储为文档集合，它还具有比<a class="ae js" href="https://firebase.google.com/docs/database" rel="noopener ugc nofollow" target="_blank">实时数据库</a>更丰富、更快速的查询和扩展功能。<br/>你可以通过API管理不同字段的<em class="iv">待办事项</em>文档。</p><h1 id="1023" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">要求</h1><ul class=""><li id="7990" class="la lb hi iw b ix lc jb ld jz le ka lf kb lg jr lh li lj lk bi translated"><a class="ae js" href="https://www.python.org/downloads/" rel="noopener ugc nofollow" target="_blank"> Python3.7 </a></li><li id="d516" class="la lb hi iw b ix ll jb lm jz ln ka lo kb lp jr lh li lj lk bi translated"><a class="ae js" href="https://github.com/pallets/flask" rel="noopener ugc nofollow" target="_blank">烧瓶</a></li><li id="662a" class="la lb hi iw b ix ll jb lm jz ln ka lo kb lp jr lh li lj lk bi translated"><a class="ae js" href="https://github.com/firebase/firebase-admin-python" rel="noopener ugc nofollow" target="_blank"> Firebase Admin Python SDK </a></li></ul><h1 id="08f5" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">开始之前</h1><p id="a3c9" class="pw-post-body-paragraph it iu hi iw b ix lc iz ja jb ld jd je jz lq jh ji ka lr jl jm kb ls jp jq jr hb bi translated">创建一个新的Firebase项目，或者使用一个现有的。</p><ul class=""><li id="5354" class="la lb hi iw b ix iy jb jc jz lt ka lu kb lv jr lh li lj lk bi translated">在云Firestore部分点击<strong class="iw hj">数据库</strong>和<strong class="iw hj">创建数据库</strong>。</li><li id="d259" class="la lb hi iw b ix ll jb lm jz ln ka lo kb lp jr lh li lj lk bi translated">设置您的<a class="ae js" href="https://firebase.google.com/docs/firestore/security/get-started" rel="noopener ugc nofollow" target="_blank">安全规则</a>和<a class="ae js" href="https://firebase.google.com/docs/projects/locations" rel="noopener ugc nofollow" target="_blank">位置</a></li><li id="c32f" class="la lb hi iw b ix ll jb lm jz ln ka lo kb lp jr lh li lj lk bi translated">您应该有一个类似于以下内容的初始屏幕:</li></ul><figure class="jt ju jv jw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lw"><img src="../Images/1604f306b8d48f3212370875bbcb1566.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*plWXeXNKBUxN9Z0j.png"/></div></div></figure><p id="d37e" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jz jg jh ji ka jk jl jm kb jo jp jq jr hb bi translated">下载您的Firebase服务帐户密钥</p><ul class=""><li id="22e9" class="la lb hi iw b ix iy jb jc jz lt ka lu kb lv jr lh li lj lk bi translated">点击仪表盘顶部的<strong class="iw hj">设置图标</strong></li><li id="729c" class="la lb hi iw b ix ll jb lm jz ln ka lo kb lp jr lh li lj lk bi translated">点击<strong class="iw hj">服务账户</strong>标签</li><li id="14ca" class="la lb hi iw b ix ll jb lm jz ln ka lo kb lp jr lh li lj lk bi translated">为<strong class="iw hj">管理SDK配置片段</strong>选择<strong class="iw hj"> Python </strong>选项，点击<strong class="iw hj">生成新私钥</strong>并保存为<code class="du lx ly lz ma b"><strong class="iw hj">key.json</strong></code></li></ul><figure class="jt ju jv jw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/1bd16b4384dd13559d2e861120df2797.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uU7yY4lQa8usob_c.png"/></div></div></figure><p id="b5e1" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jz jg jh ji ka jk jl jm kb jo jp jq jr hb bi translated"><a class="ae js" href="https://console.cloud.google.com/project?_ga=2.69989718.-735545701.1566156833" rel="noopener ugc nofollow" target="_blank">创建一个新的谷歌云平台(GCP)项目</a>，或者使用一个现有的项目(你将需要它来部署到云运行)</p><ul class=""><li id="8058" class="la lb hi iw b ix iy jb jc jz lt ka lu kb lv jr lh li lj lk bi translated">安装<a class="ae js" href="https://cloud.google.com/sdk/" rel="noopener ugc nofollow" target="_blank">云SDK </a>或者使用Googl上可用的云Shell</li><li id="1329" class="la lb hi iw b ix ll jb lm jz ln ka lo kb lp jr lh li lj lk bi translated">(可选)设置持续部署检查<a class="ae js" href="https://fullstackgcp.com/simplified-continuous-deployment-on-google-cloud-platform-bc5b0a025c4e" rel="noopener ugc nofollow" target="_blank">这个</a></li><li id="7bf4" class="la lb hi iw b ix ll jb lm jz ln ka lo kb lp jr lh li lj lk bi translated">确保您可以在shell上运行<code class="du lx ly lz ma b"><strong class="iw hj">gcloud -h</strong></code>。</li></ul><figure class="jt ju jv jw fd ij er es paragraph-image"><div class="er es mc"><img src="../Images/aad65e32dda8a23b863af5aaf820f517.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/0*EoDSB0gPsxJ0dRcM.png"/></div></figure><h1 id="488a" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">源代码</h1><figure class="jt ju jv jw fd ij er es paragraph-image"><div class="er es md"><img src="../Images/b734b7025be9d60bd5d2eb7020cc31d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/0*BcEn8MbHesA2gX3M.gif"/></div><figcaption class="me mf et er es mg mh bd b be z dx translated">是时候写些代码了。</figcaption></figure><pre class="jt ju jv jw fd mi ma mj mk aw ml bi"><span id="0a3b" class="mm kd hi ma b fi mn mo l mp mq"># app.py</span><span id="9b60" class="mm kd hi ma b fi mr mo l mp mq"># Required Imports<br/>import os<br/>from flask import Flask, request, jsonify<br/>from firebase_admin import credentials, firestore, initialize_app</span><span id="9e99" class="mm kd hi ma b fi mr mo l mp mq"># Initialize Flask App<br/>app = Flask(__name__)</span><span id="68e7" class="mm kd hi ma b fi mr mo l mp mq"># Initialize Firestore DB<br/>cred = credentials.Certificate('key.json')<br/>default_app = initialize_app(cred)<br/>db = firestore.client()<br/>todo_ref = db.collection('todos')<br/></span><span id="7b25" class="mm kd hi ma b fi mr mo l mp mq">@app.route('/add', methods=['POST'])<br/>def create():<br/>    """<br/>        create() : Add document to Firestore collection with request body<br/>        Ensure you pass a custom ID as part of json body in post request<br/>        e.g. json={'id': '1', 'title': 'Write a blog post'}<br/>    """<br/>    try:<br/>        id = request.json['id']<br/>        todo_ref.document(id).set(request.json)<br/>        return jsonify({"success": True}), 200<br/>    except Exception as e:<br/>        return f"An Error Occured: {e}"<br/></span><span id="dcc6" class="mm kd hi ma b fi mr mo l mp mq">@app.route('/list', methods=['GET'])<br/>def read():<br/>    """<br/>        read() : Fetches documents from Firestore collection as JSON<br/>        todo : Return document that matches query ID<br/>        all_todos : Return all documents</span><span id="f38f" class="mm kd hi ma b fi mr mo l mp mq">    """<br/>    try:<br/>        # Check if ID was passed to URL query<br/>        todo_id = request.args.get('id')    <br/>        if todo_id:<br/>            todo = todo_ref.document(todo_id).get()<br/>            return jsonify(todo.to_dict()), 200<br/>        else:<br/>            all_todos = [doc.to_dict() for doc in todo_ref.stream()]<br/>            return jsonify(all_todos), 200<br/>    except Exception as e:<br/>        return f"An Error Occured: {e}"<br/></span><span id="2b76" class="mm kd hi ma b fi mr mo l mp mq">@app.route('/update', methods=['POST', 'PUT'])<br/>def update():<br/>    """<br/>        update() : Update document in Firestore collection with request body<br/>        Ensure you pass a custom ID as part of json body in post request<br/>        e.g. json={'id': '1', 'title': 'Write a blog post today'}<br/>    """<br/>    try:<br/>        id = request.json['id']<br/>        todo_ref.document(id).update(request.json)<br/>        return jsonify({"success": True}), 200<br/>    except Exception as e:<br/>        return f"An Error Occured: {e}"<br/></span><span id="a765" class="mm kd hi ma b fi mr mo l mp mq">@app.route('/delete', methods=['GET', 'DELETE'])<br/>def delete():<br/>    """<br/>        delete() : Delete a document from Firestore collection</span><span id="cd88" class="mm kd hi ma b fi mr mo l mp mq">    """<br/>    try:<br/>        # Check for ID in URL query<br/>        todo_id = request.args.get('id')<br/>        todo_ref.document(todo_id).delete()<br/>        return jsonify({"success": True}), 200<br/>    except Exception as e:<br/>        return f"An Error Occured: {e}"<br/></span><span id="6686" class="mm kd hi ma b fi mr mo l mp mq">port = int(os.environ.get('PORT', 8080))<br/>if __name__ == '__main__':<br/>    app.run(threaded=True, host='0.0.0.0', port=port)</span></pre><p id="eacb" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jz jg jh ji ka jk jl jm kb jo jp jq jr hb bi translated">API执行的每个操作都有单独的方法和路线，您可以改进代码片段并添加更多功能来满足您的需求。对于每个CRUD(创建、读取、更新、删除)操作，我们定义了路由及其对应的<a class="ae js" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods" rel="noopener ugc nofollow" target="_blank"> HTTP方法</a>。我们还尝试执行该操作并返回一个带有200状态代码的响应，如果某处有问题，我们将返回异常错误。</p><h1 id="2189" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">部署到云运行</h1><p id="4b7e" class="pw-post-body-paragraph it iu hi iw b ix lc iz ja jb ld jd je jz lq jh ji ka lr jl jm kb ls jp jq jr hb bi translated">我们将不得不为我们的API编写一个<strong class="iw hj"> Dockerfile </strong>，以便能够将它构建为一个容器，并让它在Cloud Run上运行。</p><pre class="jt ju jv jw fd mi ma mj mk aw ml bi"><span id="1515" class="mm kd hi ma b fi mn mo l mp mq"># Dockerfile<br/>FROM python:3.7-stretch<br/>RUN apt-get update -y<br/>RUN apt-get install -y python-pip python-dev build-essential<br/>COPY . /app<br/>WORKDIR /app<br/>RUN pip install -r requirements.txt<br/>ENTRYPOINT ["python"]<br/>CMD ["app.py"]</span></pre><p id="3352" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jz jg jh ji ka jk jl jm kb jo jp jq jr hb bi translated">确保您有一个包含以下内容的<strong class="iw hj"> requirements.txt </strong>文件。</p><pre class="jt ju jv jw fd mi ma mj mk aw ml bi"><span id="4e51" class="mm kd hi ma b fi mn mo l mp mq"># requirements.txt<br/>flask<br/>firebase_admin</span></pre><p id="e06b" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jz jg jh ji ka jk jl jm kb jo jp jq jr hb bi translated">最后，您将用来触发构建的<strong class="iw hj"> cloudbuild.yaml </strong>文件需要创建如下。</p><pre class="jt ju jv jw fd mi ma mj mk aw ml bi"><span id="2f28" class="mm kd hi ma b fi mn mo l mp mq"># cloudbuild.yaml<br/>steps:<br/>  # build &amp; push the container image<br/>- name: "gcr.io/kaniko-project/executor:latest"<br/>  args: ["--cache=true", "--cache-ttl=48h", "--destination=gcr.io/$PROJECT_ID/todo:latest"]<br/>  # Deploy container image to Cloud Run<br/>- name: "gcr.io/cloud-builders/gcloud"<br/>  args: ['beta', 'run', 'deploy', 'todo', '--image', 'gcr.io/$PROJECT_ID/todo:latest', '--region', 'us-central1', '--allow-unauthenticated', '--platform', 'managed']</span></pre><p id="645b" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jz jg jh ji ka jk jl jm kb jo jp jq jr hb bi translated">此外，您还可以将您的<code class="du lx ly lz ma b"><strong class="iw hj">key.json</strong></code> Firebase服务帐户文件导入到同一个目录中，因为不建议将其推送到您的源存储库。一种快速的方法是添加一个额外的云构建步骤，从一个私有位置(比如Google云存储桶)下载服务帐户。</p><h1 id="069d" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">在云外壳上执行构建和部署步骤</h1><p id="0b49" class="pw-post-body-paragraph it iu hi iw b ix lc iz ja jb ld jd je jz lq jh ji ka lr jl jm kb ls jp jq jr hb bi translated">运行下面的命令来构建Docker容器，并按照<strong class="iw hj"> cloudbuild.yaml </strong>文件中的指定推送到容器注册表。这还执行了部署到云运行的额外步骤。</p><pre class="jt ju jv jw fd mi ma mj mk aw ml bi"><span id="e585" class="mm kd hi ma b fi mn mo l mp mq">gcloud builds submit --config cloudbuild.yaml .</span></pre><h1 id="b1fb" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">使用云运行按钮部署</h1><p id="b4fe" class="pw-post-body-paragraph it iu hi iw b ix lc iz ja jb ld jd je jz lq jh ji ka lr jl jm kb ls jp jq jr hb bi translated">最近，Google Cloud宣布了<a class="ae js" href="https://cloud.google.com/blog/products/serverless/introducing-cloud-run-button-click-to-deploy-your-git-repos-to-google-cloud" rel="noopener ugc nofollow" target="_blank"> Cloud Run按钮</a>，这是一个图片和链接，你可以将它添加到你的源代码库的README中，以允许其他人使用Cloud Run将你的应用程序部署到Google Cloud平台。将“云运行”按钮添加到存储库中的步骤如下:</p><ul class=""><li id="095a" class="la lb hi iw b ix iy jb jc jz lt ka lu kb lv jr lh li lj lk bi translated">复制并粘贴这个降价信息到你的<code class="du lx ly lz ma b"><strong class="iw hj">README.md</strong></code>文件中</li></ul><pre class="jt ju jv jw fd mi ma mj mk aw ml bi"><span id="90c3" class="mm kd hi ma b fi mn mo l mp mq">[![Run on Google Cloud](<a class="ae js" href="https://storage.googleapis.com/cloudrun/button.svg)](https://console.cloud.google.com/cloudshell/editor?shellonly=true&amp;cloudshell_image=gcr.io/cloudrun/button&amp;cloudshell_git_repo=YOUR_HTTP_GIT_URL)" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/cloudrun/button.svg)](https://console.cloud.google.com/cloudshell/editor?shellonly=true&amp;cloudshell_image=gcr.io/cloudrun/button&amp;cloudshell_git_repo=YOUR_HTTP_GIT_URL)</a></span></pre><ul class=""><li id="f198" class="la lb hi iw b ix iy jb jc jz lt ka lu kb lv jr lh li lj lk bi translated">用您的HTTP git URL替换<code class="du lx ly lz ma b"><strong class="iw hj">YOUR_HTTP_GIT_URL</strong></code>，比如:<code class="du lx ly lz ma b"><a class="ae js" href="https://github.com/Timtech4u/flask-firestore.git" rel="noopener ugc nofollow" target="_blank"><strong class="iw hj">https://github.com/Timtech4u/flask-firestore.git</strong></a></code></li><li id="ae46" class="la lb hi iw b ix ll jb lm jz ln ka lo kb lp jr lh li lj lk bi translated">确保您的存储库有一个<code class="du lx ly lz ma b"><strong class="iw hj">Dockerfile</strong></code></li></ul><figure class="jt ju jv jw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/9c9767e22e5fb90ddaf35e3e0d4ff403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_zPQzkpC0YKk9-EN.png"/></div></div></figure><h1 id="cb6b" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">清理</h1><p id="e749" class="pw-post-body-paragraph it iu hi iw b ix lc iz ja jb ld jd je jz lq jh ji ka lr jl jm kb ls jp jq jr hb bi translated">为了防止不必要的费用，请清理为本教程创建的资源，删除使用的资源或项目(如果您创建了新项目)。</p><h1 id="a427" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">有用的链接</h1><ul class=""><li id="6f78" class="la lb hi iw b ix lc jb ld jz le ka lf kb lg jr lh li lj lk bi translated"><a class="ae js" href="https://github.com/Timtech4u/flask-firestore" rel="noopener ugc nofollow" target="_blank">GitHub上的源代码</a></li><li id="1cba" class="la lb hi iw b ix ll jb lm jz ln ka lo kb lp jr lh li lj lk bi translated"><a class="ae js" href="https://flask.palletsprojects.com/en/1.1.x/" rel="noopener ugc nofollow" target="_blank">烧瓶文件</a></li><li id="9dfe" class="la lb hi iw b ix ll jb lm jz ln ka lo kb lp jr lh li lj lk bi translated"><a class="ae js" href="https://firebase.google.com/docs/firestore" rel="noopener ugc nofollow" target="_blank">云Firestore文档</a></li><li id="d3cb" class="la lb hi iw b ix ll jb lm jz ln ka lo kb lp jr lh li lj lk bi translated"><a class="ae js" href="https://cloud.google.com/run/docs/" rel="noopener ugc nofollow" target="_blank">云运行文档</a></li><li id="2070" class="la lb hi iw b ix ll jb lm jz ln ka lo kb lp jr lh li lj lk bi translated"><a class="ae js" href="https://cloud.google.com/cloud-build/docs/" rel="noopener ugc nofollow" target="_blank">云构建文档</a></li></ul><p id="842c" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jz jg jh ji ka jk jl jm kb jo jp jq jr hb bi translated"><em class="iv">感谢通读！如果我错过了任何步骤，如果有些事情不太适合你，或者如果这个指南有帮助，请告诉我。</em></p><p id="2549" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je jz jg jh ji ka jk jl jm kb jo jp jq jr hb bi translated"><a class="ae js" href="https://fullstackgcp.com/building-a-flaskpython-crud-api-with-cloud-firestorefirebase-and-deploying-on-cloud-run-cjzwbwvid000fpxs10npcr2ps" rel="noopener ugc nofollow" target="_blank">最初发布于FullStackGCP </a></p></div></div>    
</body>
</html>