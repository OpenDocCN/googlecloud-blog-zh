<html>
<head>
<title>Three Simple Steps to Save Costs when Prototyping with App Engine Flexible Environment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用App Engine灵活环境构建原型时，节省成本的三个简单步骤</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/three-simple-steps-to-save-costs-when-prototyping-with-app-engine-flexible-environment-104fc6736495?source=collection_archive---------0-----------------------#2016-06-28">https://medium.com/google-cloud/three-simple-steps-to-save-costs-when-prototyping-with-app-engine-flexible-environment-104fc6736495?source=collection_archive---------0-----------------------#2016-06-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a11f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你曾经使用过谷歌应用引擎，你会知道这是从想法到工作原型最快的方法之一。只要您遵守沙盒限制，您就不需要设置服务器、安装软件包或执行任何会降低您速度的繁琐的DevOps任务。</p><p id="93eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随着<a class="ae jd" href="https://cloud.google.com/appengine/docs/flexible/" rel="noopener ugc nofollow" target="_blank">App Engine Flexible Environment</a>(以前称为托管虚拟机)的推出，谷歌取消了许多沙盒限制，并添加了更多内置运行时，包括Node.js和Ruby。您甚至可以通过指定自己的docker文件来定制一切！</p><p id="1591" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/appengine/docs/the-appengine-environments#comparing_environments" rel="noopener ugc nofollow" target="_blank">参见这里的对比。</a></p><p id="90ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，这种灵活性是有代价的。灵活环境的部署速度较慢，并且不能像标准环境那样快速扩展。默认部署对于原型来说也是多余的。</p><p id="47dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我看来最大的不同是没有“规模到零”。与应用引擎标准，如果没有人在使用你的应用程序，它会关闭一切。当用户访问时，App Engine会在几毫秒内启动一个实例来服务新的请求。结合慷慨的免费层，你真的不必担心原型的基础设施成本。目前，灵活环境需要至少运行一个实例来处理流量，并且没有空闲层。</p><p id="b177" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们来看看一些使用灵活环境构建原型的最佳实践，它们可以将成本降至最低。</p><blockquote class="je jf jg"><p id="a3c9" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi"> 2019更新</em> </strong> <em class="hi">:我强烈推荐使用</em> <a class="ae jd" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank"> <em class="hi">云运行</em> </a> <em class="hi">来代替App Engine Flex完成大部分任务。在我看来，它融合了App Engine标准(按使用付费，扩展到零)和App Engine Flex(灵活性，Dockerfiles)的优点。Flex唯一的主要优势是实例规模更大。</em></p></blockquote><h1 id="b117" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">默认部署</h1><p id="9fe7" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">让我们在App Engine Flexible Environment上推出一个Node.js app。默认的app.yaml如下所示:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="23a9" class="kx jm hi kt b fi ky kz l la lb">runtime: nodejs<br/>env: flex</span></pre><p id="e518" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用gcloud命令部署它:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="dfc3" class="kx jm hi kt b fi ky kz l la lb">$ gcloud app deploy</span></pre><p id="d095" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署应用程序后，我们可以查看应用程序引擎的“实例”部分，了解以下内容:</p><figure class="ko kp kq kr fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lc"><img src="../Images/55ca56b89471ead06bbf4b9d2fc25b08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PfsoHzniMNYZclx20GYhig.png"/></div></div></figure><p id="84aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，它启动两个<a class="ae jd" href="https://cloud.google.com/appengine/docs/flexible/nodejs/configuring-your-app-with-app-yaml#resource-settings" rel="noopener ugc nofollow" target="_blank">n1-标准-1 </a>虚拟机。这是为了提供更高的可靠性。</p><p id="bd36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看这次部署的每月成本。我已经在谷歌云定价计算器<a class="ae jd" href="https://cloud.google.com/products/calculator/#id=aaf0c51a-4f50-4c03-8e30-cbc5dde4e4fb" rel="noopener ugc nofollow" target="_blank">中配置了这个默认部署，这里是</a>。</p><p id="8e00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">一个月80多美元！</strong></p><p id="c780" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然这个价格对生产流量来说是不错的，但是在原型开发阶段是非常荒谬的。</p><h1 id="97b0" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">第一步:减少实例数量</h1><p id="e26f" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">通过启动一个实例而不是两个实例，我们可以将成本削减一半。通过启用手动缩放(原型不需要自动缩放)并将实例设置为1来实现这一点。<a class="ae jd" href="https://cloud.google.com/appengine/docs/flexible/nodejs/configuring-your-app-with-app-yaml#services" rel="noopener ugc nofollow" target="_blank">你可以在这里阅读更多关于缩放的信息</a>。</p><p id="de1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">修改app.yaml:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="f2e5" class="kx jm hi kt b fi ky kz l la lb">runtime: nodejs<br/>env: flex<br/>manual_scaling:<br/>  instances: 1</span></pre><p id="b6eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将把我们的成本从大约80美元<strong class="ih hj">削减到40美元</strong>！不错！</p><p id="90cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽管如此，这是非常昂贵的原型。通常，原型只需要最少的资源就可以运行，所以我们可以进一步优化。</p><h1 id="82d3" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">第二步:使用较小的实例</h1><h2 id="96a9" class="kx jm hi bd jn lk ll lm jr ln lo lp jv iq lq lr jz iu ls lt kd iy lu lv kh lw bi translated">不幸的是，这一步在此时是不可能的！希望这种选择在将来会被恢复。</h2></div><div class="ab cl lx ly gp lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hb hc hd he hf"><p id="29c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">#虽然g1-small已经很小了，但我们还可以做得更小。</p><p id="f258" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"># f1-micro是原型的完美范例。它有足够的RAM和#CPU来运行大多数原型级别的工作负载，因此您不会在未使用的资源上花费#金钱。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="26ed" class="kx jm hi kt b fi ky kz l la lb">runtime: nodejs<br/>env: flex</span><span id="4742" class="kx jm hi kt b fi me kz l la lb">manual_scaling:<br/>  instances: 1</span><span id="c644" class="kx jm hi kt b fi me kz l la lb">#resources:<br/>#  cpu: .5<br/>#  memory_gb: 0.18<br/>#  disk_size_gb: 10</span></pre><p id="13c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">#现在价格从40美元降到15美元！非常好！</p><h1 id="59b4" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">第三步:关闭开发实例</h1><p id="04c9" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">如果您正在开发一个原型，那么您可能不需要它全天候运行。默认情况下，App Engine每次都会部署新版本。这使得回滚到旧版本或流量分流和A/B测试变得非常容易，但原型并不需要。</p><p id="25d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将您的部署命令修改为:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="fbee" class="kx jm hi kt b fi ky kz l la lb">$ gcloud app deploy --version dev</span></pre><p id="ab19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您完成一天的工作后，您可以使用以下命令降低实例的速度:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="d1ea" class="kx jm hi kt b fi ky kz l la lb">$ gcloud app versions stop dev</span></pre><p id="749e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以同样轻松地重新启动它:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="e323" class="kx jm hi kt b fi ky kz l la lb">$ gcloud app versions start dev</span></pre><p id="7e52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设你一周工作6天，每天工作10小时，因为你是10倍的工程师。如果你回家后关闭App Engine，总费用会下降到每月15-20美元。</p><h1 id="bbe0" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">结论</h1><p id="7975" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">通过遵循这三个步骤，我们已经将App Engine Flexible的成本从<strong class="ih hj">80美元降至20美元</strong>。</p><p id="2bb6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">价格下降了85%! </p><p id="f507" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然它仍然不像App Engine标准那样免费，但我觉得它更合理。</p><p id="91ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最好的部分:<em class="jh">你不需要修改任何代码或操作就可以将你的原型投入生产</em>。只需切换回自动缩放，并在app.yaml中更改您的CPU和RAM要求，您就可以开始了！</p><p id="9308" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以请记住:在构建原型时，使用一个小实例并关闭它！</p><h1 id="5e8c" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">附录</h1><h2 id="e326" class="kx jm hi bd jn lk ll lm jr ln lo lp jv iq lq lr jz iu ls lt kd iy lu lv kh lw bi translated">app.yaml:</h2><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="3a97" class="kx jm hi kt b fi ky kz l la lb">runtime: nodejs<br/>env: flex</span><span id="1787" class="kx jm hi kt b fi me kz l la lb">manual_scaling:<br/>  instances: 1</span><span id="45b2" class="kx jm hi kt b fi me kz l la lb">#resources:<br/>#  cpu: .5<br/>#  memory_gb: 0.18<br/>#  disk_size_gb: 10</span></pre><h2 id="6233" class="kx jm hi bd jn lk ll lm jr ln lo lp jv iq lq lr jz iu ls lt kd iy lu lv kh lw bi translated">部署:</h2><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="bbd4" class="kx jm hi kt b fi ky kz l la lb">$ gcloud app deploy --version dev</span></pre><h2 id="fdb6" class="kx jm hi bd jn lk ll lm jr ln lo lp jv iq lq lr jz iu ls lt kd iy lu lv kh lw bi translated">停止:</h2><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="516f" class="kx jm hi kt b fi ky kz l la lb">$ gcloud app versions stop dev</span></pre><h2 id="e95c" class="kx jm hi bd jn lk ll lm jr ln lo lp jv iq lq lr jz iu ls lt kd iy lu lv kh lw bi translated">开始:</h2><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="d5ae" class="kx jm hi kt b fi ky kz l la lb">$ gcloud app versions start dev</span></pre></div></div>    
</body>
</html>