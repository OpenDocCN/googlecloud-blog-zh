<html>
<head>
<title>Loading Geographic Multiband Raster Data in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在BigQuery中加载地理多波段栅格数据</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/loading-geographic-multiband-raster-data-in-bigquery-5acea6174d3f?source=collection_archive---------1-----------------------#2022-12-19">https://medium.com/google-cloud/loading-geographic-multiband-raster-data-in-bigquery-5acea6174d3f?source=collection_archive---------1-----------------------#2022-12-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="8773" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">目标:使用以下两种方法在BigQuery中加载栅格数据，</p><p id="e540" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">1.通过GeoBeam使用数据流</p><p id="633e" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">2.使用GDAL核心库。</p></blockquote></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="090a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">为了设置上下文，这里解释了一些关于栅格数据的术语，</p><h1 id="3055" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">光栅图像</h1><p id="7d96" class="pw-post-body-paragraph ii ij hi il b im kp io ip iq kq is it jo kr iw ix jp ks ja jb jq kt je jf jg hb bi translated">在栅格形式中，数据是通过遥感作为图像捕获的，并表示为像素网格。卫星或装有照相机的飞机捕捉地球上某个区域的图像，代表连续变化的数据，例如土壤的性质、林地中的种植园等。</p><p id="9a9d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">这些图像带有地理标记，包含地理位置信息。通常，此信息由图像左上角像素的坐标、X方向上每个像素的大小、Y方向上每个像素的大小以及图像旋转的量(如果有)组成。有了这些信息，GIS应用程序就可以确保栅格数据显示在正确的位置。</p><h1 id="fdde" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">法官</h1><p id="6e38" class="pw-post-body-paragraph ii ij hi il b im kp io ip iq kq is it jo kr iw ix jp ks ja jb jq kt je jf jg hb bi translated">栅格图像可以包含一个或多个波段，每个波段覆盖相同的空间区域，但包含不同的信息。有些栅格只有一个波段或图层(单个特征的测量值)，而其他栅格则有多个波段。基本上，波段由单个像元值矩阵表示，具有多个波段的栅格包含多个表示同一空间区域的空间重合像元值矩阵。</p><p id="5761" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">波段可以代表电磁波谱的任何部分，包括肉眼不可见的范围，例如红外或紫外部分。具有单一波段的图像称为灰度图像。多光谱图像的三个波段可以用红色、绿色和蓝色显示，这样我们就能看到它们。</p><blockquote class="if ig ih"><p id="0cb9" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">在光栅图像上表示要素</p></blockquote><p id="0418" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">每个像素或一组像素可以表示一个地理点或一条要素线，如河流或显示为多边形的区域。</p></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><h1 id="4cee" class="jr js hi bd jt ju ku jw jx jy kv ka kb kc kw ke kf kg kx ki kj kk ky km kn ko bi translated">在BigQuery数据集中加载栅格数据</h1><p id="cbc6" class="pw-post-body-paragraph ii ij hi il b im kp io ip iq kq is it jo kr iw ix jp ks ja jb jq kt je jf jg hb bi translated"><strong class="il hj"> GeoTIFF </strong>是一种广泛使用的栅格数据格式。这种格式允许将TIFF图像中的像素映射到地理坐标。Tag图像文件格式，缩写为<strong class="il hj"> TIFF </strong>或<strong class="il hj"> TIF </strong>，是一种用于存储光栅图形的图像文件格式。</p><p id="813b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">这是我从geobeam示例中获得的tiff文件，</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es kz"><img src="../Images/27f4e4587858abffad2441683cf3647d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x-y8R4sU2BTMuF25EpEU5w.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx translated"><a class="ae lp" href="https://storage.googleapis.com/geobeam/examples/soilgrid-test-clipped.tif" rel="noopener ugc nofollow" target="_blank">土壤网格Tiff文件</a></figcaption></figure><p id="86b8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">该栅格文件被加载到BigQuery中进行地理空间分析。该文件中的数据模式如下所示，</p><pre class="la lb lc ld fd lq lr ls bn lt lu bi"><span id="bb5c" class="lv js hi lr b be lw lx l ly lz">[<br/>  {<br/>    "name": "h3",<br/>    "type": "INT64",<br/>    "description": "Derived available soil water capacity (volumetric fraction) with FC = pF 2.5 for depth 0 cm"<br/>  },<br/>  {<br/>    "name": "geom",<br/>    "type": "GEOGRAPHY"<br/>  }<br/>]</span></pre><p id="ea28" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">根据数据类型，我们可以将一些地理空间数据直接加载到BigQuery和Earth Engine中。如果数据使用WGS 84参考系统，BigQuery允许加载WKT、WKB和GeoJSON文件格式的矢量数据。Earth Engine直接与Earth Engine目录中的可用数据集成，并支持以GeoTIFF文件格式直接加载光栅图像。但是，我们总是可以将GeoTiff文件转换为矢量数据文件，并将其加载到BigQuery中进行地理空间分析。</p><p id="a930" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">BigQuery提供了许多<a class="ae lp" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/geography_functions" rel="noopener ugc nofollow" target="_blank">函数</a>，让我们可以构造新的地理值，计算地理的度量，探索两个地理之间的关系，等等。我们可以使用BigQuery S2函数对S2格网单元进行分级地理空间索引。此外，BigQuery ML的机器学习功能可用于识别数据中的模式，如创建k-means机器学习模型来聚类地理空间数据。</p><p id="4c79" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">BigQuery中GeoTiff文件的摄取是使用下面两种方法完成的，</p><ol class=""><li id="5578" class="ma mb hi il b im in iq ir jo mc jp md jq me jg mf mg mh mi bi translated">使用基于GDAL、PROJ和其他库的GeoBeam库</li><li id="b4f6" class="ma mb hi il b im mj iq mk jo ml jp mm jq mn jg mf mg mh mi bi translated">直接使用OSGEO库— GDAL、Rasterio</li></ol><h1 id="a8d3" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">使用GeoBeam摄取</h1><p id="84d2" class="pw-post-body-paragraph ii ij hi il b im kp io ip iq kq is it jo kr iw ix jp ks ja jb jq kt je jf jg hb bi translated">我使用带有geobeam示例代码的数据流来加载多个图像，在本文中，我将介绍土壤网格tiff文件加载步骤和结果。</p><ol class=""><li id="3c3c" class="ma mb hi il b im in iq ir jo mc jp md jq me jg mf mg mh mi bi translated">安装地梁，</li></ol><pre class="la lb lc ld fd lq lr ls bn lt lu bi"><span id="40ab" class="lv js hi lr b be lw lx l ly lz">pip install geobeam</span></pre><p id="c6b0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">2.运行dataflowrunner调用geobeam示例python代码将tiff文件加载到BigQuery中，</p><pre class="la lb lc ld fd lq lr ls bn lt lu bi"><span id="dc00" class="lv js hi lr b be lw lx l ly lz">python -m geobeam.examples.geotiff_soilgrid \<br/>  --runner DataflowRunner \<br/>  --sdk_container_image gcr.io/dataflow-geobeam/base \<br/>  --temp_location &lt;your temp bucket&gt; \<br/>  --project &lt;your project&gt; \<br/>  --service_account_email &lt;your service account&gt; \<br/>  --region us-central1 \<br/>  --worker_machine_type c2-standard-8 \<br/>  --gcs_url gs://geobeam/examples/soilgrid-test-clipped.tif \<br/>  --dataset examples \<br/>  --table soilgrid \<br/>  --band_column h3</span></pre><p id="5f9c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">3.geobeam库geo beam . examples . geo tiff _ soil grid中的<a class="ae lp" href="https://github.com/GoogleCloudPlatform/dataflow-geobeam/blob/main/geobeam/examples/crop_geotiff.py" rel="noopener ugc nofollow" target="_blank">示例</a>代码用于演示，但是可以对其进行定制以满足任何用例的需求。该示例代码加载了一个单波段图像文件。我修改了它来加载多个波段。</p><p id="482c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">基本上，该代码使用多边形化方法将栅格像素转换为多边形要素，该方法为栅格中共享一个公共像素值的所有像素连接区域创建矢量多边形。每个多边形都创建有一个指示该多边形像素值的属性。</p><p id="d2f2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">GeoBeam中的RasterPolygonSource用于启用行级数据加载，以便在BigQuery中进行即时查询。</p><pre class="la lb lc ld fd lq lr ls bn lt lu bi"><span id="6a65" class="lv js hi lr b be lw lx l ly lz">class geobeam.io.RasterPolygonSource(file_pattern, bidx=1, in_epsg=None, in_proj=None, **kwargs)</span></pre><pre class="mo lq lr ls bn lt lu bi"><span id="b0ba" class="lv js hi lr b be lw lx l ly lz"><br/>with beam.Pipeline(options=pipeline_options) as p:<br/>  (p<br/>   | beam.io.Read(GeotiffSource(known_args.gcs_url))<br/>   | 'MakeValid' &gt;&gt; beam.Map(geobeam.fn.make_valid)<br/>   | 'FilterInvalid' &gt;&gt; beam.Filter(geobeam.fn.filter_invalid)<br/>   | 'FormatRecords' &gt;&gt; beam.Map(geobeam.fn.format_record,<br/>       known_args.band_column, known_args.band_type)<br/>   | 'WriteToBigQuery' &gt;&gt; beam.io.WriteToBigQuery('DATASET.TABLE'))</span></pre><p id="662a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">上面的示例管道代码显示了读写步骤和选项，用于过滤记录、格式化记录，然后写入BigQuery。</p><p id="8c38" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">面数据被加载到地理数据类型列geom中，并用于进一步查询。</p><h1 id="09b8" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">使用GDAL摄取数据</h1><p id="3b10" class="pw-post-body-paragraph ii ij hi il b im kp io ip iq kq is it jo kr iw ix jp ks ja jb jq kt je jf jg hb bi translated">这种方法我使用了OSGEO开源库，GDAL和OGR。这种方法可以更好地控制数据加载方法和步骤，例如可以根据连通性级别对栅格像素进行多边形化。</p><p id="be72" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">GDAL可以安装为，</p><pre class="la lb lc ld fd lq lr ls bn lt lu bi"><span id="0f3e" class="lv js hi lr b be lw lx l ly lz">sudo apt-get install gdal-bin unzip </span></pre><p id="c982" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">下面的代码加载tiff文件，查找文件中的所有波段，并遍历每个波段。图像中的每个波段都被转换成一个形状文件(一种由Esri 开发的矢量数据格式)。它允许您存储几何位置和相关属性)。但是，也可以使用其他格式来代替形状文件。</p><pre class="la lb lc ld fd lq lr ls bn lt lu bi"><span id="1ef3" class="lv js hi lr b be lw lx l ly lz">from osgeo import gdal, ogr<br/>import sys<br/><br/>src_ds = gdal.Open('./SoilGrid.tif')<br/>band = 0<br/>if src_ds is None:<br/>    print ('Unable to open tif  ')   <br/>    sys.exit(1)<br/><br/>print ("[ RASTER BAND COUNT ]: ", src_ds.RasterCount)<br/>for band in range( src_ds.RasterCount ):<br/>    band += 1<br/>    print ("[ GETTING BAND ]: ", band)<br/>    srcband = src_ds.GetRasterBand(band)<br/>    if srcband is None:<br/>        continue<br/><br/>    stats = srcband.GetStatistics( True, True )<br/>    print("band num is : ", band)<br/>    print ("[ NO DATA VALUE ] = ", srcband.GetNoDataValue())<br/>    print ("[ MIN ] = ", srcband.GetMinimum())<br/>    print ("[ MAX ] = ", srcband.GetMaximum())<br/>    print ("[ SCALE ] = ", srcband.GetScale())<br/>    print ("[ UNIT TYPE ] = ", srcband.GetUnitType())<br/><br/>    dst_layername = "POLYGONIZED_DATA_BAND" + str(band)<br/>    drv = ogr.GetDriverByName("ESRI Shapefile")<br/>    dst_ds = drv.CreateDataSource( dst_layername + ".shp" )<br/>    dst_layer = dst_ds.CreateLayer(dst_layername, srs = None )<br/><br/>    gdal.Polygonize( srcband, None, dst_layer, -1, [], callback=None )<br/><br/>    if stats is None:<br/>        continue</span></pre><p id="8028" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">可以使用geobeam加载形状文件，也可以使用OGR将其转换为CSV格式，然后使用BQ load命令加载到BigQuery中，</p><pre class="la lb lc ld fd lq lr ls bn lt lu bi"><span id="4207" class="lv js hi lr b be lw lx l ly lz">ogr2ogr -f csv -dialect sqlite -sql 'select AsGeoJSON(geometry) AS geom, * from "crop_data"' crop_data.csv crop_data.shp</span></pre><pre class="mo lq lr ls bn lt lu bi"><span id="eba9" class="lv js hi lr b be lw lx l ly lz">bq load --autodetect --replace sample_data.crop_data_vector gs://sample_data/crop_data.csv</span></pre><p id="2c90" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">此外，加载的数据可用于使用BigQuery中的geo函数进行分析。</p><p id="b58c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">为了测试和原型化地理空间分析，我使用了<a class="ae lp" href="https://cloud.google.com/bigquery/docs/gis-visualize#geo_viz" rel="noopener ugc nofollow" target="_blank"> BigQuery GeoViz </a>作为验证查询并从BigQuery生成可视化输出的方法。对于商业智能报告，可以使用<a class="ae lp" href="https://lookerstudio.google.com/c/u/0/" rel="noopener ugc nofollow" target="_blank"> Looker Studio </a>或<a class="ae lp" href="https://looker.com/" rel="noopener ugc nofollow" target="_blank"> Looker </a>连接到BigQuery，并将地理空间可视化与各种其他报告类型相结合，以呈现所需洞察的统一视图。</p><p id="0f85" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">我计划在接下来的博客中发布更多关于地理空间数据分析和创建仪表板的详细示例。</p><h1 id="08e1" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">参考</h1><p id="8fae" class="pw-post-body-paragraph ii ij hi il b im kp io ip iq kq is it jo kr iw ix jp ks ja jb jq kt je jf jg hb bi translated"><a class="ae lp" href="https://webhelp.esri.com/" rel="noopener ugc nofollow" target="_blank">https://webhelp.esri.com/</a></p><div class="mp mq ez fb mr ms"><a href="https://cloud.google.com/architecture/geospatial-analytics-architecture" rel="noopener  ugc nofollow" target="_blank"><div class="mt ab dw"><div class="mu ab mv cl cj mw"><h2 class="bd hj fi z dy mx ea eb my ed ef hh bi translated">地理空间分析架构|云架构中心|谷歌云</h2><div class="mz l"><h3 class="bd b fi z dy mx ea eb my ed ef dx translated">本文档帮助您了解Google Cloud地理空间功能，以及如何在您的…</h3></div><div class="na l"><p class="bd b fp z dy mx ea eb my ed ef dx translated">cloud.google.com</p></div></div><div class="nb l"><div class="nc l nd ne nf nb ng lj ms"/></div></div></a></div><div class="mp mq ez fb mr ms"><a href="https://github.com/GoogleCloudPlatform/dataflow-geobeam/tree/main/geobeam/examples" rel="noopener  ugc nofollow" target="_blank"><div class="mt ab dw"><div class="mu ab mv cl cj mw"><h2 class="bd hj fi z dy mx ea eb my ed ef hh bi translated">data flow-geo beam/geo beam/主GoogleCloudPlatform上的示例/dataflow-geobeam</h2><div class="mz l"><h3 class="bd b fi z dy mx ea eb my ed ef dx translated">将县宗地的shapefile加载到big query python-m geo beam . examples . shape file _ parcel \-runner direct runner \…</h3></div><div class="na l"><p class="bd b fp z dy mx ea eb my ed ef dx translated">github.com</p></div></div><div class="nb l"><div class="nh l nd ne nf nb ng lj ms"/></div></div></a></div><p id="8de9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated"><a class="ae lp" href="https://docs.qgis.org/2.8/en/docs" rel="noopener ugc nofollow" target="_blank">https://docs.qgis.org/2.8/en/docs</a></p></div></div>    
</body>
</html>