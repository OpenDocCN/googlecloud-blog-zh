<html>
<head>
<title>OpenCensus Tracing w/ Stackdriver</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用堆栈驱动程序打开人口普查跟踪</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/opencensus-tracing-w-stackdriver-a079fae52499?source=collection_archive---------0-----------------------#2018-03-13">https://medium.com/google-cloud/opencensus-tracing-w-stackdriver-a079fae52499?source=collection_archive---------0-----------------------#2018-03-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b30b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一位客户的工程师询问他们如何在Java应用中灵活地结合OpenCensus tracing w/ App Engine，并在Stackdriver中显示结果。</p><p id="2488" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些天我是“Golang First ”,所以这里有两种解决方法:Golang和Java。</p><p id="9cd2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">文件是…稀疏。希望这些工作(！)示例将帮助您了解如何将这些神奇的东西应用到您的项目中。</p><p id="29e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">准备好谷歌云平台项目并启用计费…</p><p id="ad4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的项目中创建App Engine应用程序:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="a63f" class="jm jn hi ji b fi jo jp l jq jr">gcloud app create \<br/>--region=us-central \<br/>--project=${PROJECT}</span></pre><p id="f1a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对我来说，Stackdriver跟踪是启用的，但您可以确保这一点。请确保将<code class="du js jt ju ji b">PROJECT</code>设置为您的项目ID:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="44ef" class="jm jn hi ji b fi jo jp l jq jr">gcloud services enabled cloudtrace.googleapis.com --project=${PROJECT}</span></pre><h2 id="f11d" class="jm jn hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">第一:Golang</h2><p id="8df6" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">App Engine灵活部署配置了<code class="du js jt ju ji b">app.yaml</code>，对于Golang，我假设您已经配置了<code class="du js jt ju ji b">GOPATH</code>等。</p><p id="6d34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">app.yaml:</p><figure class="jd je jf jg fd kt"><div class="bz dy l di"><div class="ku kv l"/></div></figure><blockquote class="kw kx ky"><p id="8980" class="if ig kz ih b ii ij ik il im in io ip la ir is it lb iv iw ix lc iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>这包括对两个环境变量的引用<code class="du js jt ju ji b">PROJECT</code>是您的GCP项目，而<code class="du js jt ju ji b">PORT</code>定义了httpd的端口。我建议您将其保留在<code class="du js jt ju ji b">8080</code>，因为这是App Engine所期望的值。只要定义了环境变量，就可以用<code class="du js jt ju ji b">go run main.go</code>在本地运行示例。<em class="hi">当代码部署到App Engine (GKE等)时，不需要指定</em> <code class="du js jt ju ji b"><em class="hi">PROJECT</em></code> <em class="hi">。)但是我把它放在这里是为了允许在本地运行。</em></p></blockquote><p id="6c52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主页面:</p><figure class="jd je jf jg fd kt"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="2543" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在本地运行此代码:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="1642" class="jm jn hi ji b fi jo jp l jq jr">export PROJECT=[[YOUR-PROJECT-ID]]<br/>export ADDR="8080"</span><span id="60b6" class="jm jn hi ji b fi ld jp l jq jr">go get ./...<br/>go run main.go</span></pre><p id="6852" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du js jt ju ji b">/</code>上列举了机器的环境变量。您可以在<code class="du js jt ju ji b">/_ah/health</code>和等效的<code class="du js jt ju ji b">/healthz</code>上检查健康检查。当你不在谷歌上运行时，你可以使用<code class="du js jt ju ji b">/requestz</code>端点，但是在谷歌的服务上，请使用同义词<code class="du js jt ju ji b">/remotez</code>。</p><p id="450d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">而且，当您准备好(并希望看到真实的痕迹)时，您可以使用以下工具部署到App Engine:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="5e79" class="jm jn hi ji b fi jo jp l jq jr">gcloud app deploy --project=${PROJECT}</span></pre><p id="4a86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以确认应用程序已部署:</p><figure class="jd je jf jg fd kt er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es le"><img src="../Images/62b708cfef094ed4e4e22dfb95f73d80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X8cKF6IUnwG9fcMCD8l4JQ.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx translated">云控制台:应用引擎(运行时:Go)</figcaption></figure><p id="44b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="3580" class="jm jn hi ji b fi jo jp l jq jr">gcloud app services browse default \<br/>--project=${PROJECT}</span></pre><p id="4431" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切正常，您应该很快就会看到跟踪列表工具中出现的项目:</p><p id="eacb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">https://console.cloud.google.com/traces/traces?project=[[您的项目ID]]</p><figure class="jd je jf jg fd kt er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es le"><img src="../Images/9c8aebd96a03873a53833adfa6e4a0e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sUgUMocEVL2bYVTFt-hP0g.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx translated">堆栈驱动程序跟踪列表</figcaption></figure><h2 id="9f47" class="jm jn hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">第二:Java</h2><p id="5e89" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">对于Java，你需要Maven。下面是<code class="du js jt ju ji b">pom.xml</code>、<code class="du js jt ju ji b">MainServlet.java</code>和<code class="du js jt ju ji b">app.yaml</code>:</p><p id="8ec5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">app.yaml:</p><figure class="jd je jf jg fd kt"><div class="bz dy l di"><div class="ku kv l"/></div></figure><blockquote class="kw kx ky"><p id="ebd4" class="if ig kz ih b ii ij ik il im in io ip la ir is it lb iv iw ix lc iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>与Golang示例不同，Java示例假设端口是<code class="du js jt ju ji b">8080</code>。事后看来，Golang示例也应该假设这一点(我可能会修改它以反映这一点)。</p></blockquote><p id="e50b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">pom.xml:</p><figure class="jd je jf jg fd kt"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="88a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">MainServlet.java:</p><figure class="jd je jf jg fd kt"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="e9a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在本地运行:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="517e" class="jm jn hi ji b fi jo jp l jq jr">export PROJECT=[[YOUR-PROJECT-ID]]</span><span id="05f0" class="jm jn hi ji b fi ld jp l jq jr">mvn clean jetty:run</span></pre><p id="9beb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个例子更简单。它枚举环境变量*并*在根端点上生成跟踪跨度(<code class="du js jt ju ji b">/</code>)。</p><p id="6142" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要生成可以在Stackdriver中检查的跟踪，您需要将示例部署到App Engine:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="b5fa" class="jm jn hi ji b fi jo jp l jq jr">mvn clean appengine:deploy -Dapp.deploy.project=${PROJECT}</span></pre><p id="c096" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个构建和部署的过程中，去读一本关于Golang的快乐的书吧…</p><figure class="jd je jf jg fd kt er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lq"><img src="../Images/9c88c2f51e3e68585e6bbb8f5fdfd67a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BiO0fbejtr2hFcLk4v6WqA.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx translated">云控制台:应用引擎(运行时:Java)</figcaption></figure><p id="09b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该能够切换到Stackdriver跟踪列表来查看:</p><figure class="jd je jf jg fd kt er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lq"><img src="../Images/a9bce2d65130793f493ef87c596802b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eSF2UfAZRR-gGyhKlm-tgg.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx translated">堆栈驱动程序跟踪列表</figcaption></figure><h2 id="efab" class="jm jn hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">结论</h2><p id="5e26" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">OpenCensus支持“可插拔”的监控和跟踪服务。Stackdriver Trace只是一种选择。在这篇文章中，我们编写了Golang和Java示例，将OpenCensus Tracing整合到一个部署到App Engine Flexible的应用程序中，以展示该解决方案的一致性和能力。</p><p id="9be1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！</p></div></div>    
</body>
</html>