<html>
<head>
<title>Migrating Collections from MongoDB to Cloud Firestore</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将集合从MongoDB迁移到云Firestore</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/migrating-collections-from-mongodb-to-cloud-firestore-dfeff15f1c8?source=collection_archive---------0-----------------------#2022-01-05">https://medium.com/google-cloud/migrating-collections-from-mongodb-to-cloud-firestore-dfeff15f1c8?source=collection_archive---------0-----------------------#2022-01-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/2e48ca7c420e5139b4a317fbd3d37051.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*uvO3BKSY2yTVQj1YjCpXPw.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated">图片来源:谷歌<a class="ae iq" href="https://www.gcppodcast.com/images/icons/firestore.png" rel="noopener ugc nofollow" target="_blank"> Firestore Logo </a>，Mongo <a class="ae iq" href="https://assets-global.website-files.com/6130fa1501794e37c21867cf/6191a3901b4f74718ba3916a_613294646e81b85ff5c7a1ef_MongoDB.svg" rel="noopener ugc nofollow" target="_blank"> MongoDB logo </a></figcaption></figure><h1 id="a4dd" class="ir is hi bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">介绍</h1><p id="3590" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">Cloud Firestore是一个灵活的、可扩展的、云托管的NoSQL数据库，用于Google Cloud的移动、web和服务器开发。Cloud Firestore还提供与其他Firebase和谷歌云产品的无缝集成，包括云功能。Firestore将数据存储为组织成集合的文档。借助Cloud Firestore，您可以获得自动多区域数据复制、强大的一致性保证、原子批处理操作和真实事务支持。开发人员选择Firestore用于需要即时数据并使用实时监听器在客户端应用程序之间自动同步的客户端应用程序。</p><p id="2fd9" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">本文解释了如何通过三个简单的步骤将集合从MongoDB迁移到Firestore。如果您想尝试这些步骤，这个存储库中提供了示例文件。</p><h1 id="bbd5" class="ir is hi bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">先决条件</h1><ol class=""><li id="97a0" class="ks kt hi jr b js jt jw jx ka ku ke kv ki kw km kx ky kz la bi translated">要迁移的源数据所在的MongoDB数据库</li><li id="26e5" class="ks kt hi jr b js lb jw lc ka ld ke le ki lf km kx ky kz la bi translated">Mongo Shell与MongoDB进行交互</li><li id="27f6" class="ks kt hi jr b js lb jw lc ka ld ke le ki lf km kx ky kz la bi translated">安装<a class="ae iq" href="https://docs.mongodb.com/database-tools/installation/installation-linux/" rel="noopener ugc nofollow" target="_blank"> Mongo数据库工具</a>特别是你将需要mongoexport</li><li id="7281" class="ks kt hi jr b js lb jw lc ka ld ke le ki lf km kx ky kz la bi translated">安装<a class="ae iq" href="https://stedolan.github.io/jq/" rel="noopener ugc nofollow" target="_blank"> jq </a>处理JSON数据</li><li id="d174" class="ks kt hi jr b js lb jw lc ka ld ke le ki lf km kx ky kz la bi translated">安装nodejs和<a class="ae iq" href="https://www.npmjs.com/package/firestore-export-import" rel="noopener ugc nofollow" target="_blank">firestore-export-import</a>NPM包</li><li id="81a8" class="ks kt hi jr b js lb jw lc ka ld ke le ki lf km kx ky kz la bi translated">要导入数据的目标云Firestore。添加一个Firebase服务帐户并获取服务帐户密钥，如这里的<a class="ae iq" href="https://firebase.google.com/docs/admin/setup#initialize-sdk" rel="noopener ugc nofollow" target="_blank">所述</a>。这个密钥是一个JSON文件，包含以下数据，包括您的私钥，以便您可以与Firestore DB对话。</li></ol><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="2dc6" class="lp is hi ll b fi lq lr l ls lt">{<br/>  "type": "",<br/>  "project_id": "",<br/>  "private_key_id": "",<br/>  "private_key": "",<br/>  "client_email": "",<br/>  "client_id": "",<br/>  "auth_uri": "",<br/>  "token_uri": "",<br/>  "auth_provider_x509_cert_url": "",<br/>  "client_x509_cert_url": ""<br/>}</span></pre><h1 id="905d" class="ir is hi bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">迁移是如何进行的？</h1><p id="ac49" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">我们将通过一个例子来理解这一点。</p><p id="7983" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">假设您在MongoDB中将一个JSON作为一个集合存储。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="bad1" class="lp is hi ll b fi lq lr l ls lt">[<br/>	{<br/>		"type": "donut",<br/>		"name": "Cake",<br/>		"ppu": 0.55,<br/>		"batters":<br/>			{<br/>				"batter":<br/>					[<br/>						{ "code": "1001", "type": "Regular" },<br/>						{ "code": "1002", "type": "Chocolate" },<br/>						{ "code": "1003", "type": "Blueberry" },<br/>						{ "code": "1004", "type": "Devil's Food" }<br/>					]<br/>			},<br/>		"topping":<br/>			[<br/>				{ "code": "5001", "type": "None" },<br/>				{ "code": "5002", "type": "Glazed" },<br/>				{ "code": "5005", "type": "Sugar", "unhealthy": true  },<br/>				{ "code": "5007", "type": "Powdered Sugar", "unhealthy": true },<br/>				{ "code": "5006", "type": "Chocolate with Sprinkles" },<br/>				{ "code": "5003", "type": "Chocolate" },<br/>				{ "code": "5004", "type": "Maple" }<br/>			]<br/>	},<br/>...<br/>]</span></pre><blockquote class="lx ly lz"><p id="eb49" class="jp jq ma jr b js kn ju jv jw ko jy jz mb kp kc kd mc kq kg kh md kr kk kl km hb bi translated"><strong class="jr hj">注意</strong>:如果您想亲自尝试，可以将这些数据作为<code class="du lu lv lw ll b">donuts</code>集合添加到您的MongoDB中。数据在<a class="ae iq" href="https://raw.githubusercontent.com/VeerMuchandi/mongotofirestore/main/donuts.json" rel="noopener ugc nofollow" target="_blank">这里</a>可用。<code class="du lu lv lw ll b">mongoimport --uri $MONGODB_URI --collection donuts --type json donuts.json --jsonArray.</code></p></blockquote><p id="d59c" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">MongoDB通过为集合中的每个对象分配一个ObjectId来存储这些数据，如下所示</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="2154" class="lp is hi ll b fi lq lr l ls lt">&gt; db.donuts.find();<br/>{ "_id" : ObjectId("61d59cae348ca76a1703bd38"), "type" : "donut", "name" : "Raised", "ppu" : <br/>0.55, "batters" : { "batter" : [ { "code" : "1001", "type" : "Regular" } ] }, "topping" : [ {<br/> "code" : "5001", "type" : "None" }, { "code" : "5002", "type" : "Glazed" }, { "code" : "5005<br/>", "type" : "Sugar", "unhealthy" : true }, { "code" : "5003", "type" : "Chocolate" }, { "code<br/>" : "5004", "type" : "Maple" } ] }<br/>....<br/>....</span></pre><p id="71d6" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">Firestore需要不同格式的数据，如下所示。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="e2d4" class="lp is hi ll b fi lq lr l ls lt">{<br/>  "61d59cae348ca76a1703bd38": {<br/>    "ppu": 0.55,<br/>    "topping": [<br/>      {<br/>        "code": "5001",<br/>        "type": "None"<br/>      },<br/>      {<br/>        "type": "Glazed",<br/>        "code": "5002"<br/>      },<br/>      {<br/>        "type": "Sugar",<br/>        "code": "5005",<br/>        "unhealthy": true<br/>      },<br/>      {<br/>        "type": "Chocolate",<br/>        "code": "5003"<br/>      },<br/>      {<br/>        "code": "5004",<br/>        "type": "Maple"<br/>      }<br/>    ],<br/>    "name": "Raised",<br/>    "type": "donut",<br/>    "batters": {<br/>      "batter": [<br/>        {<br/>          "code": "1001",<br/>          "type": "Regular"<br/>        }<br/>      ]<br/>    },<br/>    "__collections__": {}<br/>  },<br/>  ....</span></pre><p id="f6ec" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">当您将数据从MongoDB迁移到Firestore时，我们需要在推送到目标之前将数据格式转换为与Firestore兼容的格式。这里解释的过程假设您希望保留来自源MongoDB的对象id，作为引用目标Firestore数据库集合中的文档的id。</p><p id="6bf0" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">这些步骤是:</p><ol class=""><li id="f2bd" class="ks kt hi jr b js kn jw ko ka me ke mf ki mg km kx ky kz la bi translated">将来自源MongoDB的集合导出为JSON</li><li id="e382" class="ks kt hi jr b js lb jw lc ka ld ke le ki lf km kx ky kz la bi translated">转换数据格式</li><li id="7363" class="ks kt hi jr b js lb jw lc ka ld ke le ki lf km kx ky kz la bi translated">将集合导入目标云Firestore</li></ol><h1 id="1830" class="ir is hi bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">从源MongoDB导出集合</h1><ul class=""><li id="0caf" class="ks kt hi jr b js jt jw jx ka ku ke kv ki kw km mh ky kz la bi translated">设置MONGODB_URI环境变量</li></ul><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="fc08" class="lp is hi ll b fi lq lr l ls lt">export MONGODB_URI=mongodb://IPADDRESS:27017/test</span></pre><ul class=""><li id="09f9" class="ks kt hi jr b js kn jw ko ka me ke mf ki mg km mh ky kz la bi translated">将<code class="du lu lv lw ll b">donuts</code>集合导出到一个JSON数组</li></ul><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="c833" class="lp is hi ll b fi lq lr l ls lt">mongoexport --uri=$MONGODB_URI --collection=donuts -o donuts_mongo_export.json --jsonArray</span></pre><p id="8e5f" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">结果文件应该类似于<a class="ae iq" href="https://github.com/VeerMuchandi/mongotofirestore/blob/main/donuts_mongo_export.json" rel="noopener ugc nofollow" target="_blank">这个</a>。</p><h1 id="d21a" class="ir is hi bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">转换数据格式</h1><ul class=""><li id="2399" class="ks kt hi jr b js jt jw jx ka ku ke kv ki kw km mh ky kz la bi translated">使用jq转换数据格式以与Firestore兼容</li></ul><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="2cec" class="lp is hi ll b fi lq lr l ls lt">jq 'map( {(._id."$oid") : . }) | [.[]| map_values(del(.__v, ._id))]| add' donuts_mongo_export.json &gt; donuts_firestore_import.json</span></pre><p id="df44" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">这种转换完成了以下工作:</p><ul class=""><li id="8368" class="ks kt hi jr b js kn jw ko ka me ke mf ki mg km mh ky kz la bi translated">将ObjectId指定为键，将内容指定为数据</li><li id="2a92" class="ks kt hi jr b js lb jw lc ka ld ke le ki lf km mh ky kz la bi translated">删除_id和__v</li><li id="972a" class="ks kt hi jr b js lb jw lc ka ld ke le ki lf km mh ky kz la bi translated">将数组中的对象合并成一个对象</li></ul><p id="7ccb" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">最终转换后的文件应该类似于<a class="ae iq" href="https://github.com/VeerMuchandi/mongotofirestore/blob/main/donuts_firestore_import.json" rel="noopener ugc nofollow" target="_blank">这个</a>。</p><h1 id="eb0d" class="ir is hi bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">将收藏导入target Firestore</h1><ul class=""><li id="a9eb" class="ks kt hi jr b js jt jw jx ka ku ke kv ki kw km mh ky kz la bi translated">使用<code class="du lu lv lw ll b">firestore-import</code>将转换后的数据上传到云Firestore。在这一步中，您将需要<a class="ae iq" href="https://firebase.google.com/docs/admin/setup#initialize-sdk" rel="noopener ugc nofollow" target="_blank">服务帐户密钥json </a>文件。</li></ul><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="87d4" class="lp is hi ll b fi lq lr l ls lt">firestore-import -a &lt;&lt;PathToKey.json&gt;&gt; -b donuts_firestore_import.json —nodePath donuts -y</span></pre><p id="5d21" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">导入后，数据将显示在Firestore控制台上。</p><figure class="lg lh li lj fd ij er es paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="er es mi"><img src="../Images/3dd9145cdc0202d536793335d8bd2ee3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yfaVS8zgGHzN49ep.png"/></div></div></figure><p id="0b82" class="pw-post-body-paragraph jp jq hi jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hb bi translated">恭喜你！！您已经学会了将集合从MongoDB迁移到Cloud Firestore。希望这篇简短的教程对你有所帮助。</p></div></div>    
</body>
</html>