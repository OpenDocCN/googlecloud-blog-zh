<html>
<head>
<title>CI/GitOps with Helm, GitHub Actions, Google Artifact Registry and Config Sync</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有Helm、GitHub操作、Google工件注册和配置同步的CI/gitop</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/ci-gitops-with-helm-github-actions-google-artifact-registry-and-config-sync-b48604191fda?source=collection_archive---------0-----------------------#2022-09-21">https://medium.com/google-cloud/ci-gitops-with-helm-github-actions-google-artifact-registry-and-config-sync-b48604191fda?source=collection_archive---------0-----------------------#2022-09-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8970" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">2023年1月16日更新，在谷歌云控制台中使用新的配置同步用户界面，列出同步的资源及其状态。</em></p><p id="351f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从<a class="ae je" href="https://cloud.google.com/anthos-config-management/docs/release-notes#September_15_2022" rel="noopener ugc nofollow" target="_blank"> Anthos配置管理1.13.0 </a>开始，配置同步支持从私人OCI注册表同步舵图。要了解更多，请参见<a class="ae je" href="https://cloud.google.com/anthos-config-management/docs/how-to/sync-helm-charts-from-artifact-registry" rel="noopener ugc nofollow" target="_blank">从神器注册表</a>同步头盔图表。</p><p id="1844" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">你可以在这里了解更多关于这个公告:</em> <a class="ae je" href="https://cloud.google.com/blog/products/containers-kubernetes/gitops-with-oci-artifacts-and-config-sync" rel="noopener ugc nofollow" target="_blank"> <em class="jd">部署OCI神器和舵图表GitOps方式与配置同步</em> </a> <em class="jd">。</em></p><p id="7454" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" rel="noopener" href="/google-cloud/ci-gitops-with-helm-github-actions-github-container-registry-and-config-sync-836913e74e79"> <em class="jd">在另一篇文章</em> </a> <em class="jd">中，我们看到了如何使用GitHub动作</em>  <em class="jd">将舵图打包并推送到</em> <strong class="ih hj"> <em class="jd"> GitHub容器注册表，然后如何使用配置同步部署舵图。</em></strong></p><p id="e0ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将展示如何使用GitHub actions(使用工作负载身份联盟)打包并向<strong class="ih hj"> Google Artifact Registry推送掌舵图，然后如何使用<strong class="ih hj"> Config Sync(使用工作负载身份)</strong>部署掌舵图。</strong></p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/9f5e0c8800a7ab5ca08c0ff7009bd0c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tlHY1fAmRkT79-Nh.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">工作流打包和推送一个舵图到Google工件注册表，然后用配置同步部署它</figcaption></figure></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="e07a" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">目标</h1><ul class=""><li id="5591" class="la lb hi ih b ii lc im ld iq le iu lf iy lg jc lh li lj lk bi translated">用一个专用的Google服务帐户(工件注册表编写器)设置工作负载身份联合</li><li id="ea26" class="la lb hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated">创建一个Google工件注册库</li><li id="2afe" class="la lb hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated">使用GitHub操作在Google工件注册表中打包并推送一个舵图(使用工作负载身份联盟)</li><li id="8cb1" class="la lb hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated">创建GKE集群并启用配置同步</li><li id="68e7" class="la lb hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated">使用专用的Google服务帐户(工件注册阅读器)设置工作负载身份</li><li id="fb23" class="la lb hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated">将Google工件注册表中的舵图与配置同步(使用工作负载身份)同步</li></ul></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="26b5" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">费用</h1><p id="6a03" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">本教程使用Google Cloud的付费组件，包括:</p><ul class=""><li id="da0f" class="la lb hi ih b ii ij im in iq lt iu lu iy lv jc lh li lj lk bi translated"><a class="ae je" href="https://cloud.google.com/kubernetes-engine/pricing" rel="noopener ugc nofollow" target="_blank"> Kubernetes发动机</a></li><li id="c301" class="la lb hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated"><a class="ae je" href="https://cloud.google.com/artifact-registry/pricing" rel="noopener ugc nofollow" target="_blank">工件注册表</a></li></ul><p id="2606" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">注意:在这种情况下，配置同步是免费的，更多详情见</em> <a class="ae je" href="https://cloud.google.com/anthos-config-management/docs/pricing" rel="noopener ugc nofollow" target="_blank"> <em class="jd">此处</em> </a> <em class="jd">。</em></p><p id="ed36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<a class="ae je" href="https://cloud.google.com/products/calculator" rel="noopener ugc nofollow" target="_blank">定价计算器</a>根据您的预计使用量生成成本估算。</p></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="19d3" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">开始之前</h1><p id="599c" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">本指南假设您拥有Google Cloud项目的所有者IAM权限。在生产中，您不需要所有者许可。</p><ol class=""><li id="df58" class="la lb hi ih b ii ij im in iq lt iu lu iy lv jc lw li lj lk bi translated"><a class="ae je" href="https://console.cloud.google.com/projectselector2" rel="noopener ugc nofollow" target="_blank">选择或创建一个谷歌云项目</a>。</li><li id="d59f" class="la lb hi ih b ii ll im lm iq ln iu lo iy lp jc lw li lj lk bi translated"><a class="ae je" href="https://cloud.google.com/billing/docs/how-to/modify-project" rel="noopener ugc nofollow" target="_blank">验证您的项目是否启用了计费</a>。</li></ol><p id="985d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本指南还假设你有一个<a class="ae je" href="https://github.com/" rel="noopener ugc nofollow" target="_blank"> GitHub账户</a>。</p></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="a3dd" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">设置您的环境</h1><p id="098c" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">以下是您需要的工具:</p><ul class=""><li id="75ea" class="la lb hi ih b ii ij im in iq lt iu lu iy lv jc lh li lj lk bi translated"><code class="du lx ly lz ma b"><a class="ae je" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank">gcloud</a></code></li><li id="e435" class="la lb hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated"><code class="du lx ly lz ma b"><a class="ae je" href="https://git-scm.com/downloads" rel="noopener ugc nofollow" target="_blank">git</a></code></li><li id="8234" class="la lb hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated"><code class="du lx ly lz ma b"><a class="ae je" href="https://cli.github.com/" rel="noopener ugc nofollow" target="_blank">gh</a></code></li><li id="9cb1" class="la lb hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated"><code class="du lx ly lz ma b"><a class="ae je" href="https://kubernetes.io/docs/tasks/tools/#kubectl" rel="noopener ugc nofollow" target="_blank">kubectl</a></code></li></ul><p id="b562" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意:你可以使用已经安装了所有这些工具的Google Cloud Shell。</p><p id="5ce1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">初始化本教程中使用的通用变量:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="c574" class="mf kd hi ma b be mg mh l mi mj">PROJECT_ID=FIXME-WITH-YOUR-PROJECT-ID<br/>REGION=us-east4<br/>ZONE=us-east4-a</span></pre><p id="2897" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了避免在整个教程中重复命令中的<code class="du lx ly lz ma b">--project</code>，让我们设置当前项目:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="9427" class="mf kd hi ma b be mg mh l mi mj">gcloud config set project ${PROJECT_ID}</span></pre><p id="1374" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<code class="du lx ly lz ma b"><a class="ae je" href="https://cli.github.com/" rel="noopener ugc nofollow" target="_blank">gh</a></code>工具创建这个GitHub库:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="4d38" class="mf kd hi ma b be mg mh l mi mj">REPO_NAME=my-chart<br/>cd ~/<br/>gh auth login<br/>git config --global init.defaultBranch main<br/>gh repo create ${REPO_NAME} --private --clone</span></pre><p id="7589" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们捕获GitHub所有者的值，您将在本教程的后面部分重用它:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="c75c" class="mf kd hi ma b be mg mh l mi mj">GITHUB_REPO_OWNER=$(gh repo view ${REPO_NAME} --json owner --jq .owner.login)</span></pre></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="60b6" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">设置工作量身份联盟</h1><p id="17ad" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated"><a class="ae je" href="https://cloud.google.com/iam/docs/workload-identity-federation" rel="noopener ugc nofollow" target="_blank">Workload Identity Federation</a>允许您使用短期访问令牌直接访问资源，并消除与服务帐户密钥相关的维护和安全负担。</p><p id="2ce5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个专门的谷歌服务帐户，这将推动人工制品注册表中的掌舵图稍后:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="4b72" class="mf kd hi ma b be mg mh l mi mj">PACKAGER_GSA_NAME=helm-charts-packager<br/>gcloud iam service-accounts create ${PACKAGER_GSA_NAME}</span></pre><p id="61b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建工作负荷身份池:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="e040" class="mf kd hi ma b be mg mh l mi mj">WI_POOL_NAME=helm-charts-packager-wi-pool<br/>gcloud iam workload-identity-pools create ${WI_POOL_NAME} \<br/>    --location global \<br/>    --display-name ${WI_POOL_NAME}<br/>WI_POOL_ID=$(gcloud iam workload-identity-pools describe ${WI_POOL_NAME} \<br/>    --location global \<br/>    --format='get(name)')</span></pre><p id="ac55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用该池中的GitHub操作创建一个工作负载身份提供者:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="efa6" class="mf kd hi ma b be mg mh l mi mj">gcloud iam workload-identity-pools providers create-oidc ${WI_POOL_NAME} \<br/>    --location global \<br/>    --workload-identity-pool ${WI_POOL_NAME} \<br/>    --display-name ${WI_POOL_NAME} \<br/>    --attribute-mapping "google.subject=assertion.repository,attribute.actor=assertion.actor,attribute.aud=assertion.aud,attribute.repository=assertion.repository" \<br/>    --issuer-uri "https://token.actions.githubusercontent.com"<br/>WI_POOL_PROVIDER_ID=$(gcloud iam workload-identity-pools providers describe ${WI_POOL_NAME} \<br/>    --location global \<br/>    --workload-identity-pool ${WI_POOL_NAME} \<br/>    --format='get(name)')</span></pre><p id="48a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">允许来自工作负载身份提供者的身份验证模拟上面创建的服务帐户:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="60d3" class="mf kd hi ma b be mg mh l mi mj">gcloud iam service-accounts add-iam-policy-binding ${PACKAGER_GSA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com \<br/>    --role "roles/iam.workloadIdentityUser" \<br/>    --member "principalSet://iam.googleapis.com/${WI_POOL_ID}/attribute.repository/${GITHUB_REPO_OWNER}/${REPO_NAME}"</span></pre></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="6a85" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">设置工件注册库</h1><p id="7201" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">创建Google工件注册库:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="adfb" class="mf kd hi ma b be mg mh l mi mj">gcloud services enable artifactregistry.googleapis.com<br/>ARTIFACT_REGISTRY_REPOSITORY=helm-charts<br/>gcloud artifacts repositories create ${ARTIFACT_REGISTRY_REPOSITORY} \<br/>    --location ${REGION} \<br/>    --repository-format docker</span></pre><p id="9b87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">允许Google服务帐户推入工件注册表:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="f59e" class="mf kd hi ma b be mg mh l mi mj">gcloud artifacts repositories add-iam-policy-binding ${ARTIFACT_REGISTRY_REPOSITORY} \<br/>    --location ${REGION} \<br/>    --member "serviceAccount:${PACKAGER_GSA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com" \<br/>    --role roles/artifactregistry.writer</span></pre></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="5020" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">在Google工件注册表中打包并推送一个舵图</h1><p id="c463" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">创建舵图:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="b23f" class="mf kd hi ma b be mg mh l mi mj">helm create ~/${REPO_NAME}</span></pre><p id="ce59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在GitHub存储库中提交此舵图模板:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="7ec4" class="mf kd hi ma b be mg mh l mi mj">cd ~/${REPO_NAME}<br/>git add . &amp;&amp; git commit -m "Create Helm chart template" &amp;&amp; git push origin main</span></pre><p id="d173" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将环境变量设置为GitHub操作管道的机密:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="1d7b" class="mf kd hi ma b be mg mh l mi mj">gh secret set PROJECT_ID -b"${PROJECT_ID}"<br/>gh secret set ARTIFACT_REGISTRY_REPOSITORY -b"${ARTIFACT_REGISTRY_REPOSITORY}"<br/>gh secret set ARTIFACT_REGISTRY_HOST_NAME -b"${REGION}-docker.pkg.dev"<br/>gh secret set PACKAGER_GSA_ID -b"${PACKAGER_GSA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com"<br/>gh secret set WI_POOL_PROVIDER_ID -b"${WI_POOL_PROVIDER_ID}"</span></pre><p id="d46a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">定义一个GitHub操作管道来打包并在Google工件注册表中推送Helm图表:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="1296" class="mf kd hi ma b be mg mh l mi mj">mkdir .github &amp;&amp; mkdir .github/workflows<br/>cat &lt;&lt;'EOF' &gt; .github/workflows/ci-helm-gar.yaml<br/>name: ci-helm-gar<br/>permissions:<br/>  contents: read<br/>  id-token: write<br/>on:<br/>  push:<br/>    branches:<br/>      - main<br/>  pull_request:<br/>env:<br/>  CHART_NAME: my-chart<br/>  IMAGE_TAG: 0.1.0<br/>jobs:<br/>  job:<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>      - uses: actions/checkout@v3<br/>      - name: helm lint<br/>        run: |<br/>          helm lint .<br/>      - uses: google-github-actions/auth@v0<br/>        with:<br/>          workload_identity_provider: '${{ secrets.WI_POOL_PROVIDER_ID }}'<br/>          service_account: '${{ secrets.PACKAGER_GSA_ID }}'<br/>          token_format: 'access_token'<br/>      - uses: google-github-actions/setup-gcloud@v0<br/>        with:<br/>          version: latest<br/>      - name: login to artifact registry<br/>        run: |<br/>          gcloud auth configure-docker ${{ secrets.ARTIFACT_REGISTRY_HOST_NAME }} --quiet<br/>      - name: helm package<br/>        run: |<br/>          helm package . --version $IMAGE_TAG<br/>      - name: helm push<br/>        if: ${{ github.event_name == 'push' }}<br/>        run: |<br/>          helm push $CHART_NAME-$IMAGE_TAG.tgz oci://${{ secrets.ARTIFACT_REGISTRY_HOST_NAME }}/${{ secrets.PROJECT_ID }}/${{ secrets.ARTIFACT_REGISTRY_REPOSITORY }}<br/>EOF</span></pre><p id="25bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个GitHub动作管道允许执行一系列命令:<code class="du lx ly lz ma b">helm lint</code>、<code class="du lx ly lz ma b">gcloud auth configure-docker</code>、<code class="du lx ly lz ma b">helm package</code>，最终，如果是<code class="du lx ly lz ma b">main</code>分支的<code class="du lx ly lz ma b">push</code>，就会执行<code class="du lx ly lz ma b">helm push</code>。此外，只要在<code class="du lx ly lz ma b">main</code>分支中有一个<code class="du lx ly lz ma b">push</code>以及任何pull请求，这个管道就会被触发。你可以根据自己的需要调整这个流程和这些条件。</p><p id="5000" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以看到，我们使用<code class="du lx ly lz ma b"><a class="ae je" href="https://github.com/google-github-actions/auth" rel="noopener ugc nofollow" target="_blank">google-github-actions/auth</a></code>动作通过工作负载身份联合建立对Google Cloud的身份验证。为了让这个动作生效，我们需要有<code class="du lx ly lz ma b">permissions.id-token: write</code>。然后<code class="du lx ly lz ma b">gcloud auth configure-docker</code>允许对工件注册中心进行认证，在这种情况下<code class="du lx ly lz ma b">helm registry login</code>是不必要的，下一个<code class="du lx ly lz ma b">helm</code>命令将重用这个认证机制。</p><p id="6ce7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在GitHub存储库中提交此GitHub操作管道:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="8f3e" class="mf kd hi ma b be mg mh l mi mj">git add . &amp;&amp; git commit -m "Create GitHub actions pipeline" &amp;&amp; git push origin main</span></pre><p id="bec3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">等待相关运行成功完成:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="54be" class="mf kd hi ma b be mg mh l mi mj">gh run list</span></pre><p id="4c74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看到你的头盔图表已经上传到谷歌工件注册库:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="d71a" class="mf kd hi ma b be mg mh l mi mj">gcloud artifacts docker images list ${REGION}-docker.pkg.dev/${PROJECT_ID}/$ARTIFACT_REGISTRY_REPOSITORY/${REPO_NAME}</span></pre><p id="611a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们已经构建并存储了掌舵图，让我们为GKE集群提供配置同步，以便最终部署这个掌舵图。</p></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="8aa7" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">创建您的GKE集群并启用配置同步</h1><p id="8a42" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">创建在<a class="ae je" href="https://cloud.google.com/anthos/fleet-management/docs/fleet-concepts" rel="noopener ugc nofollow" target="_blank">机群</a>中注册的GKE集群以启用配置管理:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="624f" class="mf kd hi ma b be mg mh l mi mj">gcloud services enable container.googleapis.com<br/>CLUSTER_NAME=cluster-helm-test<br/>gcloud container clusters create ${CLUSTER_NAME} \<br/>    --workload-pool=${PROJECT_ID}.svc.id.goog \<br/>    --zone ${ZONE}<br/><br/>gcloud services enable gkehub.googleapis.com<br/>gcloud container fleet memberships register ${CLUSTER_NAME} \<br/>    --gke-cluster ${ZONE}/${CLUSTER_NAME} \<br/>    --enable-workload-identity<br/><br/>gcloud beta container fleet config-management enable</span></pre><p id="53a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在此GKE群集中安装配置同步:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="e32f" class="mf kd hi ma b be mg mh l mi mj">cat &lt;&lt;EOF &gt; acm-config.yaml<br/>applySpecVersion: 1<br/>spec:<br/>  configSync:<br/>    enabled: true<br/>EOF<br/>gcloud beta container fleet config-management apply \<br/>    --membership ${CLUSTER_NAME} \<br/>    --config acm-config.yaml</span></pre></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="76b9" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">从谷歌人工制品注册表同步舵图表</h1><p id="ab0f" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">创建一个专用的Google云服务帐户，使用<code class="du lx ly lz ma b">roles/artifactregistry.reader</code>角色对工件注册库进行细粒度访问:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="4970" class="mf kd hi ma b be mg mh l mi mj">HELM_CHARTS_READER_GSA_NAME=helm-charts-reader<br/>gcloud iam service-accounts create ${HELM_CHARTS_READER_GSA_NAME} \<br/>    --display-name ${HELM_CHARTS_READER_GSA_NAME}<br/>gcloud artifacts repositories add-iam-policy-binding ${ARTIFACT_REGISTRY_REPOSITORY} \<br/>    --location ${REGION} \<br/>    --member "serviceAccount:${HELM_CHARTS_READER_GSA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com" \<br/>    --role roles/artifactregistry.reader</span></pre><p id="7c40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">允许配置同步通过工作负载标识同步特定<code class="du lx ly lz ma b">RootSync</code>的资源:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="4852" class="mf kd hi ma b be mg mh l mi mj">ROOT_SYNC_NAME=root-sync-helm<br/>gcloud iam service-accounts add-iam-policy-binding \<br/>    --role roles/iam.workloadIdentityUser \<br/>    --member "serviceAccount:${PROJECT_ID}.svc.id.goog[config-management-system/root-reconciler-${ROOT_SYNC_NAME}]" \<br/>    ${HELM_CHARTS_READER_GSA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com</span></pre><p id="975d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">展开<code class="du lx ly lz ma b">RootSync</code>以同步私人舵图表:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="4e50" class="mf kd hi ma b be mg mh l mi mj">cat &lt;&lt; EOF | kubectl apply -f -<br/>apiVersion: configsync.gke.io/v1beta1<br/>kind: RootSync<br/>metadata:<br/>  name: ${ROOT_SYNC_NAME}<br/>  namespace: config-management-system<br/>spec:<br/>  sourceFormat: unstructured<br/>  sourceType: helm<br/>  helm:<br/>    repo: oci://${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REGISTRY_REPOSITORY}<br/>    chart: my-chart<br/>    version: 0.1.0<br/>    releaseName: my-chart<br/>    namespace: default<br/>    auth: gcpserviceaccount<br/>    gcpServiceAccountEmail: ${HELM_CHARTS_READER_GSA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com<br/>EOF</span></pre><p id="99f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">请注意，我们设置了</em> <code class="du lx ly lz ma b"><em class="jd">spec.helm.auth: gcpserviceaccount</em></code> <em class="jd">和</em> <code class="du lx ly lz ma b"><em class="jd">spec.helm.gcpServiceAccountEmail: ${HELM_CHARTS_READER_GSA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com</em></code> <em class="jd">值，以便能够访问和同步私人舵图表。</em></p><p id="ab40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过运行命令<code class="du lx ly lz ma b">gcloud alpha anthos config sync resources list</code>或从云控制台导航到<strong class="ih hj"> <em class="jd"> Kubernetes引擎&gt;配置&amp;策略&gt;配置</em> </strong>，列出配置同步所同步的资源及其状态:</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es mk"><img src="../Images/2122f6fdfdab0d7e43a9be5682938073.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zdD7P4-aS8s5Cnoc0l2SAA.png"/></div></div></figure><p id="f2a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">瞧！你刚刚部署了一个<strong class="ih hj">私有头盔图</strong>托管在Google Artifact Registry中，配置同步。</p></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="3c08" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">结论</h1><p id="39f4" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">在本文中，您能够使用Workload Identity Federation通过GitHub操作在Google Artifact Registry中打包和推送一个Helm图表。最后，您看到了如何使用工作负载身份将私有掌舵图与<code class="du lx ly lz ma b">RootSync</code>上的<code class="du lx ly lz ma b">spec.helm.auth: gcpserviceaccount</code>设置同步。这表明GitHub Actions和Config Sync都支持一种高度安全的(无密钥)方法来连接到Google Artifact Registry。</p></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="1f51" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">清理</h1><p id="8a0b" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">为了避免向您的Google Cloud帐户收取费用，您可以删除本教程中使用的资源。</p><p id="d82a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从<a class="ae je" href="https://cloud.google.com/anthos/fleet-management/docs/fleet-concepts" rel="noopener ugc nofollow" target="_blank">舰队中注销GKE集群</a>:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="88ce" class="mf kd hi ma b be mg mh l mi mj">gcloud container fleet memberships unregister ${CLUSTER_NAME} \<br/>    --project=${PROJECT_ID} \<br/>    --gke-cluster=${ZONE}/${CLUSTER_NAME}</span></pre><p id="38b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除GKE群集:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="dfc9" class="mf kd hi ma b be mg mh l mi mj">gcloud container clusters delete ${CLUSTER_NAME} \<br/>    --zone ${ZONE}</span></pre><p id="3473" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除工件注册库:</p><pre class="jg jh ji jj fd mb ma mc bn md me bi"><span id="8157" class="mf kd hi ma b be mg mh l mi mj">gcloud artifacts repositories delete ${ARTIFACT_REGISTRY_REPOSITORY} \<br/>    --location ${REGION}</span></pre></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="48e0" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">下一步是什么</h1><ul class=""><li id="0ef9" class="la lb hi ih b ii lc im ld iq le iu lf iy lg jc lh li lj lk bi translated"><a class="ae je" href="https://cloud.google.com/blog/products/containers-kubernetes/gitops-with-oci-artifacts-and-config-sync" rel="noopener ugc nofollow" target="_blank">使用配置同步以GitOps方式部署OCI工件和舵图</a></li><li id="d9b0" class="la lb hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated"><a class="ae je" href="https://cloud.google.com/anthos-config-management/docs/how-to/sync-helm-charts-from-artifact-registry" rel="noopener ugc nofollow" target="_blank">从神器注册表同步舵图</a></li><li id="c630" class="la lb hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated"><a class="ae je" href="https://cloud.google.com/anthos-config-management/docs/how-to/sync-oci-artifacts-from-artifact-registry" rel="noopener ugc nofollow" target="_blank">从工件注册表同步OCI工件</a></li><li id="de0a" class="la lb hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated"><a class="ae je" rel="noopener" href="/google-cloud/ci-gitops-with-helm-github-actions-github-container-registry-and-config-sync-836913e74e79">带有Helm的CI/GitOps、GitHub操作、GitHub容器注册和配置同步</a></li></ul></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><p id="2768" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">原帖</em><a class="ae je" href="https://mathieu-benoit.github.io/" rel="noopener ugc nofollow" target="_blank"><em class="jd">Mathieu-Benoit . github . io</em></a><em class="jd">。</em></p></div></div>    
</body>
</html>