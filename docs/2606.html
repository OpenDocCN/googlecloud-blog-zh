<html>
<head>
<title>Google Cloud Tech Nibble: Securing the SSH Button with IAP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Cloud Tech Nibble:用IAP保护SSH按钮</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-tech-nibble-securing-the-ssh-button-with-iap-c9a4ffb2a5f0?source=collection_archive---------1-----------------------#2022-12-09">https://medium.com/google-cloud/google-cloud-tech-nibble-securing-the-ssh-button-with-iap-c9a4ffb2a5f0?source=collection_archive---------1-----------------------#2022-12-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e2f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些科技产品是用于学习和教育的。我希望我们都知道得更清楚…但是请不要在生产环境中玩:)</p><p id="a2a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个“技术啃咬”<strong class="ih hj">很快</strong>通过<a class="ae je" href="https://cloud.google.com/iap" rel="noopener ugc nofollow" target="_blank">身份感知代理</a>完成了保护ssh按钮的基本步骤，而不是在防火墙上打开SSH。</p><p id="81a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您已经在GCE ( <a class="ae je" href="https://cloud.google.com/compute" rel="noopener ugc nofollow" target="_blank"> Google Compute Engine </a>)上创建了一个虚拟机，毫无疑问，您已经看到了连接到该虚拟机的SSH按钮。</p><div class="jf jg jh ji fd ab cb"><figure class="jj jk jl jm jn jo jp paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><img src="../Images/e915e2b1e67ef2e5da0309cfb624eef9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*KRFHT1claeihcZPxICEBZw.png"/></div></figure><figure class="jj jk jw jm jn jo jp paragraph-image"><img src="../Images/0d8876656471a1d306d32bc689d72e4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:580/format:webp/1*E78L3bL4LpiXSJC4gr6RDQ.png"/></figure></div><p id="55a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您点击此按钮，并且在您的防火墙中打开SSH (TCP:22)到VPC，您可能能够连接，但是，如果您没有打开TCP:22，您将看到下面的。</p><div class="jf jg jh ji fd ab cb"><figure class="jj jk jx jm jn jo jp paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><img src="../Images/401b308c13d49733db8f48506acf56b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*riI-mZRCrcneKn3lqYUw5g.png"/></div></figure><figure class="jj jk jx jm jn jo jp paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><img src="../Images/73bf548252afed8f0a1b429d859330a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*GPhzU8Bbwr6o86PaPNt9xw.png"/></div></figure></div><p id="5aac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了在防火墙上打开TCP:22，一个更安全、更易于管理的选择是使用<a class="ae je" href="https://cloud.google.com/iap/docs/tcp-forwarding-overview" rel="noopener ugc nofollow" target="_blank">身份感知代理IAP TCP转发</a>来保护对虚拟机的SSH访问。虽然这篇文章专门讨论SSH，但是这个过程也适用于RDP。要通过IAP保护对资源的SSH访问，请执行以下操作:</p><ol class=""><li id="7957" class="jy jz hi ih b ii ij im in iq ka iu kb iy kc jc kd ke kf kg bi translated">打开<a class="ae je" href="https://console.cloud.google.com/security/iap" rel="noopener ugc nofollow" target="_blank"> IAP配置页面</a></li><li id="a263" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc kd ke kf kg bi translated">点击<a class="ae je" href="https://console.cloud.google.com/security/iap?tab=ssh-tcp-resources" rel="noopener ugc nofollow" target="_blank"> SSH和TCP资源</a>选项卡</li><li id="2932" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc kd ke kf kg bi translated">如果您删除了对实例的SSH访问，您应该会看到错误警告。单击它，您将看到一条消息，提示您需要打开从35.235.240.0/20到您的资源的所有TCP。</li></ol><div class="jf jg jh ji fd ab cb"><figure class="jj jk km jm jn jo jp paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><img src="../Images/da29b1680224d4d3aff6ec3012f5c986.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/format:webp/1*ksMG7UXXcUCT1hR1N852qQ.png"/></div></figure><figure class="jj jk kn jm jn jo jp paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><img src="../Images/e68ab95c910fa53211c386c6c5f3e3dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*nn6xv4NK-vfHF5HZaFxlBA.png"/></div></figure></div><ul class=""><li id="0570" class="jy jz hi ih b ii ij im in iq ka iu kb iy kc jc ko ke kf kg bi translated">设置防火墙规则的最佳实践是使用标记。您可以在<a class="ae je" href="https://cloud.google.com/vpc/docs/add-remove-network-tags#adding_new_tags_to_vm_instances" rel="noopener ugc nofollow" target="_blank">现有机器</a>上添加网络标签，或者在高级选项→网络下创建机器时添加<a class="ae je" href="https://cloud.google.com/vpc/docs/add-remove-network-tags#add_tags_to_new_vm" rel="noopener ugc nofollow" target="_blank">标签。</a></li></ul><figure class="jf jg jh ji fd jk er es paragraph-image"><div class="er es kp"><img src="../Images/0624fb8bf6897cc24c3d09248dc1b1c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*0ei578olwckxV-jrFEL5Ng.png"/></div></figure><p id="f1e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.除非您已经在实例上设置了网络标记，否则请返回到compute engine中的实例，并对其进行编辑以添加适当的网络标记。</p><p id="01da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.添加一个防火墙规则，以允许VPC防火墙中的TCP:22到达您的网络标记35.235.240.0/20。应该是:</p><ul class=""><li id="f54d" class="jy jz hi ih b ii ij im in iq ka iu kb iy kc jc ko ke kf kg bi translated">方向:入口</li><li id="6031" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc ko ke kf kg bi translated">来源:35.235.240.0/20</li><li id="1620" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc ko ke kf kg bi translated">优先级高于任何阻止规则(回想一下，数字越小，优先级越高)</li><li id="7d43" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc ko ke kf kg bi translated">目的地:您希望对其启用SSH的机器的网络标签</li><li id="c5de" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc ko ke kf kg bi translated">协议:TCP端口22(注意，这里我只开放22，为了更加严格，对于其他服务，如RDP，您将需要开放各自的端口，如RDP的TCP:3389)。为IAP开放35.235.240.0/20的所有TCP几乎没有风险，但是，许多安全管理员和策略喜欢尽可能地严格限制)</li><li id="9893" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc ko ke kf kg bi translated">操作:允许</li></ul><figure class="jf jg jh ji fd jk er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kq"><img src="../Images/6416fcc9821425ed97612bf4850ceaf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dym-Kes6v6Kcmn6QyzxRng.png"/></div></div></figure><p id="2a00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.在<a class="ae je" href="https://console.cloud.google.com/iam-admin/iam" rel="noopener ugc nofollow" target="_blank"> IAm和Admin → IAM </a>下，向您要授予访问权限的用户或组添加以下角色。这是最低要求。</p><figure class="jf jg jh ji fd jk er es paragraph-image"><div class="er es kr"><img src="../Images/dc642afc277977066e0a0cbc6f0feae0.png" data-original-src="https://miro.medium.com/v2/resize:fit:500/format:webp/1*97H5h0X4MlhYtM5WMXUkiA.png"/></div></figure><p id="6b63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，当您单击实例上的SSH按钮时，如果您的用户得到授权，您将能够从web进行SSH。</p><figure class="jf jg jh ji fd jk er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ks"><img src="../Images/59e9d9d900be97eeb004b63698f3d623.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yLaKWkJu9gA8i4X9ay-oNg.png"/></div></div></figure><p id="51f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其他资源:</p><div class="kt ku ez fb kv kw"><a href="https://cloud.google.com/iap/docs/enabling-compute-howto" rel="noopener  ugc nofollow" target="_blank"><div class="kx ab dw"><div class="ky ab kz cl cj la"><h2 class="bd hj fi z dy lb ea eb lc ed ef hh bi translated">为计算引擎启用IAP身份感知代理| Google云</h2><div class="ld l"><h3 class="bd b fi z dy lb ea eb lc ed ef dx translated">本页说明如何使用身份识别代理(IAP)保护计算引擎实例。要为计算启用IAP</h3></div><div class="le l"><p class="bd b fp z dy lb ea eb lc ed ef dx translated">cloud.google.com</p></div></div><div class="lf l"><div class="lg l lh li lj lf lk ju kw"/></div></div></a></div></div></div>    
</body>
</html>