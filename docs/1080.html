<html>
<head>
<title>GCP PostgreSQL — Compute Engine Snapshot Based Replication (Eg: Production to Development)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP PostgreSQL —基于计算引擎快照的复制(例如:从生产到开发)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-postgresql-compute-engine-snapshot-based-replication-eg-production-to-development-d90eb0477e90?source=collection_archive---------0-----------------------#2019-07-18">https://medium.com/google-cloud/gcp-postgresql-compute-engine-snapshot-based-replication-eg-production-to-development-d90eb0477e90?source=collection_archive---------0-----------------------#2019-07-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/002d2596a5d30bef670c27dbe00c0f2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d8WezOUjUDt5lwAVA0FhDA.jpeg"/></div></div></figure><h1 id="1f31" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">快速总结(TL；博士)</h1><p id="74d8" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">在本帖中，将介绍在Google云平台上基于GCE快照的复制的真实情况和建议。该解决方案适用于数据库管理员和应用程序团队，依赖于GCE虚拟机上托管的数据库。此解决方案通过快照利用克隆磁盘。同样的概念也适用于其他数据库。</p><ol class=""><li id="67d7" class="km kn hi jq b jr ko jv kp jz kq kd kr kh ks kl kt ku kv kw bi translated">创建生产数据库磁盘的快照</li><li id="d259" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">从快照创建磁盘映像</li><li id="048a" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">创建实例模板</li><li id="cf6f" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">使用新的实例模板对托管实例组(在开发项目中)进行滚动更新。</li></ol><h1 id="d161" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">介绍</h1><p id="6c1f" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">有时由于安全性和合规性要求，开发团队不允许直接访问生产数据库。但是，为了调试特定的生产问题或创建临时报告，开发团队可能需要能够访问数据。</p><p id="71a2" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">这有时会导致在开发环境中执行数据库备份和恢复操作时出现问题。这个过程通常缓慢而令人沮丧。此外，进行逻辑备份通常需要停机。</p><p id="eb87" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">如果创建每隔几个小时刷新一次数据的预定脚本或管道，则可以极大地提高体验和生产率。虽然可能有其他解决方案，如流复制、逻辑备份和恢复，但这是一个替代解决方案。</p><h2 id="b6c4" class="lf ir hi bd is lg lh li iw lj lk ll ja jz lm ln je kd lo lp ji kh lq lr jm ls bi translated"><strong class="ak">优势</strong></h2><ol class=""><li id="dfbb" class="km kn hi jq b jr js jv jw jz lt kd lu kh lv kl kt ku kv kw bi translated">通过为开发人员提供生产数据的单独副本提高了安全性</li><li id="7173" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">自动化节省的时间，不用再等票了</li><li id="b545" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">不需要生产数据库停机</li><li id="944c" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">更快的错误修复和开发周期</li></ol><h1 id="9106" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">部署布局</h1><figure class="lx ly lz ma fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lw"><img src="../Images/24dc19db77b4372d37dad60094580973.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2W92T4KKoiE84Xk4F97Upg.jpeg"/></div></div></figure><p id="2f86" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">上面的部署图显示了一个典型的设置，其布局如下:</p><ol class=""><li id="ce10" class="km kn hi jq b jr ko jv kp jz kq kd kr kh ks kl kt ku kv kw bi translated">生产数据库虚拟机位于单独的生产项目中。</li><li id="bf57" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">对于生产和非生产，可能有也可能没有单独的VPC网络。</li><li id="bc87" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">生产PostgreSql的数据磁盘会定期拍摄快照。</li><li id="2b7c" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">在非生产环境中，创建托管实例组(MIG)。新数据展示通过滚动更新功能实现。</li></ol></div><div class="ab cl mb mc gp md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="hb hc hd he hf"><h1 id="88e6" class="iq ir hi bd is it mi iv iw ix mj iz ja jb mk jd je jf ml jh ji jj mm jl jm jn bi translated">示例实现</h1><p id="6d03" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">为简单起见，我将使用:</p><ol class=""><li id="0847" class="km kn hi jq b jr ko jv kp jz kq kd kr kh ks kl kt ku kv kw bi translated">一个包含源数据库(假设为生产数据库)和副本(用于非生产用途)的项目。</li><li id="9f9e" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">postgres数据库虚拟机将只有一个磁盘用于引导、数据和日志。在实际场景中，最好只将数据磁盘复制到非生产环境，这样数据库用户、日志和配置(pg_hba.conf和postgres.conf等)就不会被带到非生产环境中。</li><li id="5fb4" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">托管实例组使用新的数据库快照进行滚动更新。</li><li id="c167" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">为在上述步骤中创建的受管实例组创建负载平衡器。</li><li id="3359" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">一个orchestrator虚拟机，通过调度cron作业来触发管道。它将按以下命令顺序执行:<br/> a .创建源磁盘快照<br/> b .从快照创建新的磁盘映像。<br/> c .用新的磁盘映像创建新的实例模板。<br/> d .在MIG上使用新快照进行滚动更新。</li></ol><h2 id="5ccc" class="lf ir hi bd is lg lh li iw lj lk ll ja jz lm ln je kd lo lp ji kh lq lr jm ls bi translated">我们开始吧</h2><p id="a9e1" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">如果你还没有使用过谷歌云，你可以前往https://console.cloud.google.com注册一个300美元起的免费账户。</p><h2 id="6deb" class="lf ir hi bd is lg lh li iw lj lk ll ja jz lm ln je kd lo lp ji kh lq lr jm ls bi translated">设置源数据库和托管实例组</h2><ol class=""><li id="0b41" class="km kn hi jq b jr js jv jw jz lt kd lu kh lv kl kt ku kv kw bi translated">开放云壳</li></ol><figure class="lx ly lz ma fd ij er es paragraph-image"><div class="ab fe cl mo"><img src="../Images/0852ab4e79dc9b9f64f489bfcab1d98f.png" data-original-src="https://miro.medium.com/v2/format:webp/0*W0CDGYhKx_k4tNtW.png"/></div></figure><figure class="lx ly lz ma fd ij er es paragraph-image"><div class="ab fe cl mo"><img src="../Images/d7b1db12513c6e11b4c2b8400f5760de.png" data-original-src="https://miro.medium.com/v2/format:webp/0*VcNGvqDrnbfxcH4s.png"/></div></figure><p id="6a01" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">2.为postgres实例创建防火墙规则，并创建新的虚拟机实例。</p><p id="ffc1" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">创建防火墙(默认VPC网络可选)<br/>执行以下命令创建防火墙规则，允许端口5432上的传入连接</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="cd09" class="lf ir hi mq b fi mu mv l mw mx">gcloud compute firewall-rules create pg-firewall-open --direction=INGRESS --priority=1000 --network=default --action=ALLOW --rules=tcp:5432 --source-ranges=0.0.0.0/0</span></pre><p id="27e6" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">创建虚拟机<br/>虚拟机实例可以通过UI或gcloud命令创建，如下所示。<br/>或者从云壳执行以下命令。</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="c1df" class="lf ir hi mq b fi mu mv l mw mx">gcloud compute instances create postgres-prod --zone=us-west1-b --machine-type=n1-standard-1 --subnet=default  --scopes=<a class="ae mn" href="https://www.googleapis.com/auth/cloud-platform" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/cloud-platform</a> --image-family=ubuntu-1604-lts --image-project=ubuntu-os-cloud --boot-disk-size=100GB --boot-disk-type=pd-standard --boot-disk-device-name=postgres-prod</span></pre><p id="14cb" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">3.SSH到虚拟机，安装并配置PostgreSQL数据库。</p><p id="299f" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">安装PostgreSQL</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="e4b6" class="lf ir hi mq b fi mu mv l mw mx">gcloud compute ssh postgres-prod --zone=us-west1-b<br/>sudo apt update<br/>sudo apt install postgresql postgresql-contrib</span></pre><p id="1a4f" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">配置PostgreSQL以允许远程连接</p><p id="93e8" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">默认情况下，PostgreSQL被配置为绑定到“localhost”。<br/>配置postgresql.conf，我一般做个搜索就能找到。</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="63f9" class="lf ir hi mq b fi mu mv l mw mx">$ find \ -name "postgresql.conf" <!-- -->/etc/postgresql/9.5/main/<!-- -->postgresql.conf</span></pre><p id="3068" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">打开postgresql.conf文件并替换行</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="5fb6" class="lf ir hi mq b fi mu mv l mw mx">listen_addresses = 'localhost'</span></pre><p id="b5bb" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">随着</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="c754" class="lf ir hi mq b fi mu mv l mw mx">listen_addresses = '*'</span></pre><p id="cbb7" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">配置pg_hba.conf</p><p id="1ff0" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">类似地，找到并打开pg_hba.conf，并在最后添加以下条目。</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="8cb4" class="lf ir hi mq b fi mu mv l mw mx">host    all             all      0.0.0.0/0     md5<br/>host    all             all      ::/0          md5</span></pre><p id="90f1" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">4.创建示例数据库。</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="1a26" class="lf ir hi mq b fi mu mv l mw mx">sudo -u postgres psql</span></pre><p id="5eea" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">进入psql shell后，创建一个新的数据库。</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="9ef4" class="lf ir hi mq b fi mu mv l mw mx">create database prod_test_1;</span></pre><p id="ed78" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">退出psql shell</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="7568" class="lf ir hi mq b fi mu mv l mw mx">\q</span></pre><p id="13e3" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">退出postgres-prod虚拟机</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="bf1b" class="lf ir hi mq b fi mu mv l mw mx">exit</span></pre><p id="69fa" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">5.创建磁盘快照。</p><p id="71dd" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated"><code class="du my mz na mq b">Name snapshot as: postgres-prod-initial-snapshot</code></p><figure class="lx ly lz ma fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nb"><img src="../Images/c8b52328bd7971816358a4159585c6c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uiX27S5bQHjCI5bAGyZw7A.png"/></div></div></figure><figure class="lx ly lz ma fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nc"><img src="../Images/fa3d427e0c41d8ecb59519fd43d4abe0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RCWgR059bS6XcwEuVuQCtQ.png"/></div></div></figure><p id="89fe" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">6.从快照创建磁盘映像，如下所示。</p><figure class="lx ly lz ma fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es et"><img src="../Images/17ef152f5625b2c0b5abb517b78e364a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bGLYe65RLxF2fl46NzQv1A.png"/></div></div></figure><p id="5d8b" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">7.创建一个名为postgres-prd-replica-initial-template的实例模板，如下所示</p><figure class="lx ly lz ma fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nd"><img src="../Images/a869332cc93f03ec21b576c8de035d3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i5wqISQhNIYSJeavcZhPrQ.png"/></div></div></figure><p id="3570" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">8.使用上述名为postgres-prd-replica-mig的模板创建一个托管实例组。计算引擎-&gt;实例组-&gt;创建实例组。</p><figure class="lx ly lz ma fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ne"><img src="../Images/31f2911689cb1641fd7978f1a1b96a42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Af53vmvX5e2Y3piCxC5bPQ.png"/></div></div></figure><p id="d1ac" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">9.现在我们将创建一个负载平衡器。因此它提供了一个不变的IP地址来连接数据库。网络服务-&gt;负载平衡-&gt;创建负载平衡器-&gt; TCP负载平衡-&gt;启动配置</p><figure class="lx ly lz ma fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nf"><img src="../Images/c053f6e44ada395de282d6869b9f73ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2gEOiwKAkdV70_Pr4i2-eQ.png"/></div></div></figure><p id="78e6" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">在这里，我们将配置负载平衡器。将其命名为postgres-prod-replica-lb，并按照下面的屏幕截图进行配置。</p><figure class="lx ly lz ma fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ng"><img src="../Images/39707e045088095ef6c0433ce6a41738.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bbvBSXOSs7mKr83r_OKMZw.png"/></div></div></figure><p id="6fb8" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">按如下方式配置运行状况检查。</p><figure class="lx ly lz ma fd ij er es paragraph-image"><div class="er es nh"><img src="../Images/d0c4eb58c828477666cde53c6a20339b.png" data-original-src="https://miro.medium.com/v2/resize:fit:932/format:webp/1*fkpPGmMcFIl6ssj9-xAvuA.png"/></div></figure><p id="e654" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">如下配置前端并点击创建按钮。</p><figure class="lx ly lz ma fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ni"><img src="../Images/b19c44bee3a2defa4bd03e4c276667db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I9SKQViDYHy_T26-sObMtA.png"/></div></div></figure><p id="1e53" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">这将创建一个带有内部ip的负载平衡器，开发者/应用程序可以使用它进行连接。</p><p id="3c5e" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">您还需要创建一个健康检查防火墙规则来启用它。</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="3cc9" class="lf ir hi mq b fi mu mv l mw mx">gcloud compute firewall-rules create allow-hc --direction=INGRESS --priority=1000 --network=default --action=ALLOW --rules=tcp --source-ranges=130.211.0.0/22,35.191.0.0/16</span></pre><p id="9f07" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">用户应连接到此负载平衡器以访问生产副本数据库。</p></div><div class="ab cl mb mc gp md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="hb hc hd he hf"><h1 id="a3cb" class="iq ir hi bd is it mi iv iw ix mj iz ja jb mk jd je jf ml jh ji jj mm jl jm jn bi translated">手动更新数据库快照副本</h1><p id="9ae1" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">为了更新数据的最新副本，我们需要做的事情如下。<br/>磁盘快照- &gt;映像- &gt;实例模板- &gt;滚动更新</p><ol class=""><li id="d09c" class="km kn hi jq b jr ko jv kp jz kq kd kr kh ks kl kt ku kv kw bi translated">创建磁盘快照(如前使用UI或如下使用gcloud)</li></ol><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="b61c" class="lf ir hi mq b fi mu mv l mw mx">gcloud compute disks snapshot postgres-prod --snapshot-names=postgres-prod-manual1-snapshot --zone=us-west1-b</span></pre><p id="de06" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">2.创建磁盘映像(像以前一样使用UI，或者像下面一样使用gcloud)</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="8194" class="lf ir hi mq b fi mu mv l mw mx">gcloud compute images create postgres-prod-manual1-image --family=postgres-prod --source-snapshot=postgres-prod-manual1-snapshot</span></pre><p id="abc2" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">3.创建实例模板(使用之前的UI或下面的gcloud)</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="0cd5" class="lf ir hi mq b fi mu mv l mw mx">gcloud compute instance-templates create postgres-prd-replica-manual1-template --machine-type=n1-standard-1 --scopes=https://www.googleapis.com/auth/cloud-platform --image=postgres-prod-manual1-image --boot-disk-size=100GB --boot-disk-type=pd-standard</span></pre><p id="c253" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">4.对托管实例组的滚动更新</p><p id="5cc1" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">转到计算引擎-&gt;实例组-&gt; postgres-prd-replica-mig -&gt;滚动更新</p><figure class="lx ly lz ma fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nj"><img src="../Images/6b5977431e6e215519b759e465566d0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dgP1rS4AVyMEJyE2JBir9w.png"/></div></div></figure><p id="4ace" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">然后选择新模板，将最大不可用时间更改为0，并单击更新。这将首先创建一个新的复制副本实例，然后删除旧实例。</p><figure class="lx ly lz ma fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nk"><img src="../Images/33986908ae35ace3e287d27ef26b5b4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m9tvYCNFZEx2h3VO1LafWA.png"/></div></div></figure><p id="da26" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">或者，这可以通过以下gcloud命令来实现。</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="99df" class="lf ir hi mq b fi mu mv l mw mx">gcloud beta compute instance-groups managed rolling-action start-update postgres-prd-replica-mig --version template=postgres-prd-replica-manual1-template --max-unavailable 0 --zone us-west1-b</span></pre></div><div class="ab cl mb mc gp md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="hb hc hd he hf"><h1 id="1cfc" class="iq ir hi bd is it mi iv iw ix mj iz ja jb mk jd je jf ml jh ji jj mm jl jm jn bi translated">编排定期自动更新</h1><p id="3cd5" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">使用各种第三方部署工具(如jenkins)都可以轻松做到这一点。但是，这里我将简单地创建一个shell脚本，并将其调度为cron tab。</p><p id="88f0" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">我将生成一个uuid(使用uuidgen命令),为所有资源提供唯一的名称。我还缩短了资源的名称，因为它们超出了gcp的字符限制。</p><p id="d0ba" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">创建一个名为prd-replica-updater的虚拟机</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="ce5b" class="lf ir hi mq b fi mu mv l mw mx">gcloud compute instances create prd-replica-updater --zone=us-west1-b --machine-type=n1-standard-1 --subnet=default  --scopes=<a class="ae mn" href="https://www.googleapis.com/auth/cloud-platform" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/cloud-platform</a> --image-family=ubuntu-1604-lts --image-project=ubuntu-os-cloud --boot-disk-size=10GB --boot-disk-type=pd-standard --boot-disk-device-name=prd-replica-updater</span></pre><p id="ae05" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">SSH进入虚拟机，创建名为prd-replica-update.sh的shell脚本，如下所示</p><pre class="lx ly lz ma fd mp mq mr ms aw mt bi"><span id="e520" class="lf ir hi mq b fi mu mv l mw mx"># uuid string<br/>rnd=$(uuidgen)</span><span id="2288" class="lf ir hi mq b fi nl mv l mw mx"># create snapshot<br/>gcloud compute disks snapshot postgres-prod --snapshot-names=pg-prd-auto-$rnd-snap --zone=us-west1-b</span><span id="01cc" class="lf ir hi mq b fi nl mv l mw mx"># create image<br/>gcloud compute images create pg-prd-auto-$rnd-image --family=postgres-prod --source-snapshot=pg-prd-auto-$rnd-snap</span><span id="1f73" class="lf ir hi mq b fi nl mv l mw mx"># create instance template<br/>gcloud compute instance-templates create pg-prd-auto-$rnd-template --machine-type=n1-standard-1 --scopes=https://www.googleapis.com/auth/cloud-platform --image=pg-prd-auto-$rnd-image --boot-disk-size=100GB --boot-disk-type=pd-standard</span><span id="7f32" class="lf ir hi mq b fi nl mv l mw mx"># do rolling update<br/>gcloud beta compute instance-groups managed rolling-action start-update postgres-prd-replica-mig --version template=pg-prd-auto-$rnd-template --max-unavailable 0 --zone us-west1-b</span></pre><p id="3474" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">可以使用crontab调度上述脚本，从而自动更新数据库。</p></div></div>    
</body>
</html>