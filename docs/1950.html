<html>
<head>
<title>Static Website Publishing to Cloud Pub/Sub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">静态网站发布到云发布/订阅</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/static-website-publishing-to-pubsub-b5ea2d35d232?source=collection_archive---------1-----------------------#2021-08-27">https://medium.com/google-cloud/static-website-publishing-to-pubsub-b5ea2d35d232?source=collection_archive---------1-----------------------#2021-08-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="7295" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">概观</h1><p id="ee9e" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">您有没有发现自己正在制作想要发送到PubSub中的JSON数据？希望有某种GUI、WebService或CLI来简化这一过程吗？</p><p id="3c1b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><em class="kg">一个</em> <strong class="jf hj"> <em class="kg">静态</em> </strong> <em class="kg">网页怎么样，在https端点上内部托管，作为一种快速简单的方法？</em></p><p id="58e0" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这也依赖于GCP本土的安全模式。网页充当格式化工具(像CLI！)通过OAuth使用最终用户凭证发布数据。</p><h1 id="6303" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">给我看看！</h1><p id="6d12" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这是一系列的步骤——小步骤——来建立一个HTML网页。错误检查、用户反馈和风格都作为练习。</p><h2 id="a7ea" class="kh ig hi bd ih ki kj kk il kl km kn ip jo ko kp it js kq kr ix jw ks kt jb ku bi translated">HTML表单</h2><p id="5f1f" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">首先，我们将从一个非常简单的HTML表单开始。这将在屏幕上显示一个带有消息和发布按钮的表单。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="2c39" class="kh ig hi la b fi le lf l lg lh">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;meta charset='utf-8'/&gt;<br/>&lt;body&gt;<br/>  &lt;!-- Form for submitting data to the topic --&gt;<br/>  &lt;form onsubmit="publish('testTopic', [window['message'].value]);<br/>                  return false;"&gt;<br/>    &lt;input type="text" id='message' name="msg"&gt;&lt;/input&gt;<br/>    &lt;input type="submit" value="Publish"&gt;&lt;/submit&gt;<br/>  &lt;/form&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="71d6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">唯一缺少的是<strong class="jf hj">发布</strong> ( <strong class="jf hj">主题，消息</strong> ) <strong class="jf hj"> </strong>方法。</p><h2 id="fa05" class="kh ig hi bd ih ki kj kk il kl km kn ip jo ko kp it js kq kr ix jw ks kt jb ku bi translated">发布消息</h2><p id="3fa5" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jf hj">发布</strong> ( <strong class="jf hj">主题</strong>，<strong class="jf hj">消息</strong>)方法是一个瘦包装器，调用这个<a class="ae li" href="https://cloud.google.com/pubsub/docs/reference/rest/v1/projects.topics/publish" rel="noopener ugc nofollow" target="_blank"> REST API端点</a>。这在下面实现，它使用<strong class="jf hj"> gapi.client.request </strong>方法——管理OAuth——这将在下一节实现。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="7389" class="kh ig hi la b fi le lf l lg lh">&lt;!-- Publish --&gt;<br/>&lt;script type="text/javascript"&gt;</span><span id="3ddb" class="kh ig hi la b fi lj lf l lg lh">const PROJECT_ID = '&lt;your-project&gt;';</span><span id="cf3e" class="kh ig hi la b fi lj lf l lg lh">// Publish topic (as a promise)<br/>async function publish(topic, messages) {<br/>  const attrs = {<br/>    'sent_by': 'publish.html'<br/>  };</span><span id="ccf9" class="kh ig hi la b fi lj lf l lg lh">// Create payload to send as per REST specification<br/>let body = { 'messages': [] };<br/>  for (let i = 0; i &lt; messages.length; i++) {<br/>    console.log('publishing', messages[i]);<br/>    body['messages'].push({<br/>      'data': btoa(JSON.stringify(messages[i])),<br/>      'attributes': attrs<br/>    });<br/>  }</span><span id="7866" class="kh ig hi la b fi lj lf l lg lh">// Return <br/>return await gapi.client.request({<br/>    'path':'<a class="ae li" href="https://pubsub.googleapis.com/v1/projects/'" rel="noopener ugc nofollow" target="_blank">https://pubsub.googleapis.com/v1/projects/'</a> +<br/>            PROJECT_ID + '/topics/' + topic + ':publish',<br/>    'method':'POST',<br/>    'headers': {},<br/>    'body': body,<br/>  });<br/>}<br/>&lt;/script&gt;</span></pre><h2 id="00c0" class="kh ig hi bd ih ki kj kk il kl km kn ip jo ko kp it js kq kr ix jw ks kt jb ku bi translated">GAPI客户端初始化</h2><p id="043b" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们将使用Javascript的async/await来加载GAPI客户端，用CLIENT_ID、Scope和API_KEY初始化它，最后，如果需要的话，登录。这是使用<a class="ae li" href="https://github.com/google/google-api-javascript-client/blob/master/docs/start.md" rel="noopener ugc nofollow" target="_blank"> GAPI Javascript客户端API </a>。这将提示用户授权客户代表用户行事。</p><p id="50b4" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">下一节将详细介绍CLIENT_ID和API_KEY。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="65ac" class="kh ig hi la b fi le lf l lg lh">&lt;!-- Login using OAuth --&gt;<br/>&lt;script type="text/javascript"<br/>        src="<a class="ae li" href="https://apis.google.com/js/client.js" rel="noopener ugc nofollow" target="_blank">https://apis.google.com/js/client.js</a>"&gt;<br/>&lt;/script&gt;<br/>&lt;script type="text/javascript"&gt;<br/>const CLIENT_ID = '&lt;CLIENT_ID&gt;';<br/>const PUBSUB_SCOPE = '<a class="ae li" href="https://www.googleapis.com/auth/pubsub'" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/pubsub'</a>;<br/>const API_KEY = '&lt;API_KEY&gt;';</span><span id="19e5" class="kh ig hi la b fi lj lf l lg lh">// Login (as a promise)<br/>async function doLogin() {</span><span id="8ba6" class="kh ig hi la b fi lj lf l lg lh">  // Load auth libraries. These need to be<br/>  // wrapped in a promise to use async/await.<br/>  await new Promise((resolve, reject) =&gt; {<br/>    gapi.load('client:auth2', resolve);<br/>  });</span><span id="dfea" class="kh ig hi la b fi lj lf l lg lh">  // Await the GAPI api to initialise.<br/>  await gapi.client.init({<br/>      apiKey: API_KEY,<br/>      clientId: CLIENT_ID,<br/>      scope: PUBSUB_SCOPE,<br/>  });</span><span id="7472" class="kh ig hi la b fi lj lf l lg lh">  // Sign in if needed<br/>  if (!gapi.auth2.getAuthInstance().isSignedIn.get()) {<br/>    await gapi.auth2.getAuthInstance().signIn();<br/>  }<br/>}</span><span id="7951" class="kh ig hi la b fi lj lf l lg lh">// Do the login<br/>// Use promise results to update screen status?<br/>doLogin();</span><span id="f4fd" class="kh ig hi la b fi lj lf l lg lh">&lt;/script&gt;</span></pre><h2 id="922b" class="kh ig hi bd ih ki kj kk il kl km kn ip jo ko kp it js kq kr ix jw ks kt jb ku bi translated">客户端标识和API密钥</h2><p id="29de" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">客户端ID和API密钥都来自谷歌云的<a class="ae li" href="https://console.cloud.google.com/apis/credentials" rel="noopener ugc nofollow" target="_blank"> API服务&gt;凭证</a>部分。</p><p id="752a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">创建客户端ID </strong></p><p id="0686" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">回顾<a class="ae li" href="https://support.google.com/cloud/answer/6158849" rel="noopener ugc nofollow" target="_blank">设置OAuth 2.0 </a>并记住以下几点:</p><ul class=""><li id="d113" class="lk ll hi jf b jg kb jk kc jo lm js ln jw lo ka lp lq lr ls bi translated">需要为静态网站设置授权的Javascript源。这可以是本地主机(可以是http)或支持https的web服务器。它必须被托管在某个地方！</li><li id="4a4f" class="lk ll hi jf b jg lt jk lu jo lv js lw jw lx ka lp lq lr ls bi translated">这是一个网络应用程序。</li></ul><p id="9b5d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">创建API密钥</strong></p><p id="24e5" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">使用API密钥检查<a class="ae li" href="http://Using API keys" rel="noopener ugc nofollow" target="_blank">并创建一个新的API密钥。还可以将API密钥限制在特定的域和API中，以提高密钥的安全性。</a></p><h1 id="4866" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">把它放在一起</h1><p id="b494" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在让一切正常工作之前，请记住:</p><ul class=""><li id="e817" class="lk ll hi jf b jg kb jk kc jo lm js ln jw lo ka lp lq lr ls bi translated">使用具有发布IAM权限的最终用户(网页用户)创建主题。在本例中，使用了testTopic。</li><li id="3494" class="lk ll hi jf b jg lt jk lu jo lv js lw jw lx ka lp lq lr ls bi translated">为您可以从中提取的主题创建订阅。在本例中，使用了testSub。</li></ul><h2 id="2729" class="kh ig hi bd ih ki kj kk il kl km kn ip jo ko kp it js kq kr ix jw ks kt jb ku bi translated">网页</h2><p id="d14a" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">该网页具有简单的输入和发布。“测试消息！”正在发送的消息。</p><figure class="kv kw kx ky fd lz er es paragraph-image"><div class="er es ly"><img src="../Images/b73019bffffaecc418389b521438b113.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*W4GY_ftlg1XpyCL2xj4Ecg.png"/></div></figure><p id="b61e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">查看浏览器控制台是查看事情是否出错的好地方。</p><h2 id="fbf3" class="kh ig hi bd ih ki kj kk il kl km kn ip jo ko kp it js kq kr ix jw ks kt jb ku bi translated">g云订阅拉动</h2><p id="4519" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">发布后，<code class="du mc md me la b">gcloud pubsub subscriptions pull</code>可用于获取消息:</p><figure class="kv kw kx ky fd lz er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mf"><img src="../Images/e2a78ce01fbb45284e2e2480c760d339.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DUmHb9mhW8mGJtFfdtK_bg.png"/></div></div></figure><h1 id="1831" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">结论</h1><p id="ccf0" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">有很大的改进空间，但是使用OAuth创建一个简单的发布订阅发布网页非常简单。对于面向公众的解决方案，不建议这样做(每条PubSub消息都要花钱！)，但对于面向内部的工具，这可能就是解决方案。</p></div></div>    
</body>
</html>