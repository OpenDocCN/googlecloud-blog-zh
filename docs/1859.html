<html>
<head>
<title>The Wondrous World of Cloud Audit Logs!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云审计日志的奇妙世界！</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/the-wondrous-world-of-cloud-audit-logs-7a1fe6e47002?source=collection_archive---------0-----------------------#2021-04-19">https://medium.com/google-cloud/the-wondrous-world-of-cloud-audit-logs-7a1fe6e47002?source=collection_archive---------0-----------------------#2021-04-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/db90e5ababd8da6293cc9dcebf5d759c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m4Yf0cSxRB-6KwXhNqT0BA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">产生审计日志的谷歌云服务</figcaption></figure><p id="94c9" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi js translated">几乎每个谷歌云服务都能在你的项目中产生一个事件，称为<em class="kb">云审计日志</em>。这些日志记录了项目中的活动。示例活动包括:创建新的虚拟机、修改IAM角色或访问云存储桶。</p><p id="08ab" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在这篇博文中，我们将探索云审计日志，并展示如何使用Eventarc来监听这些日志流，配置事件过滤器，并触发您的云运行服务。</p></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><h1 id="bfe6" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">什么是云审计日志？</h1><p id="c931" class="pw-post-body-paragraph iu iv hi iw b ix lh iz ja jb li jd je jf lj jh ji jj lk jl jm jn ll jp jq jr hb bi translated">云审计日志是针对<em class="kb">管理活动</em>、<em class="kb">数据访问</em>、<em class="kb">系统事件</em>和<em class="kb">策略被拒绝</em>事件的日志流。这些事件通常用于帮助客户满足审计和法规遵从性需求。他们会回答你项目中的“谁在何时何地做了什么”。<a class="ae lm" href="https://cloud.google.com/logging/docs/audit" rel="noopener ugc nofollow" target="_blank">🔗</a></p><p id="71a0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">以下是审计日志类型:</p><p id="2513" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi js translated"><span class="l jt ju jv bm jw jx jy jz ka di"> 1 </span> <strong class="iw hj"> <em class="kb">管理活动</em> </strong> <em class="kb">审计日志</em>包含<strong class="iw hj"> API调用</strong>或<strong class="iw hj">修改</strong> <strong class="iw hj">配置</strong>或元数据的其他操作的日志条目。<a class="ae lm" href="https://cloud.google.com/logging/docs/audit#admin-activity" rel="noopener ugc nofollow" target="_blank">🔗</a></p><p id="0e06" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi js translated"><span class="l jt ju jv bm jw jx jy jz ka di"> 2 </span> <em class="kb"> </em> <strong class="iw hj"> <em class="kb">数据访问</em> </strong> <em class="kb">审计日志</em>记录读取资源配置、元数据的API调用，或者读取或写入资源数据的<strong class="iw hj">用户级API调用</strong>。<a class="ae lm" href="https://cloud.google.com/logging/docs/audit#data-access" rel="noopener ugc nofollow" target="_blank">🔗</a></p><p id="40e9" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi js translated"><span class="l jt ju jv bm jw jx jy jz ka di"> 3 </span> <strong class="iw hj"> <em class="kb">系统事件</em> </strong> <em class="kb">审计日志</em>记录从Google systems生成的系统管理信息——不是由用户直接操作驱动的。<a class="ae lm" href="https://cloud.google.com/logging/docs/audit#system-event" rel="noopener ugc nofollow" target="_blank">🔗</a></p><p id="7ce1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi js translated"><span class="l jt ju jv bm jw jx jy jz ka di"> 4 </span> <strong class="iw hj"> <em class="kb">策略被拒绝</em> </strong> <em class="kb">审计日志</em>记录服务帐户或用户对服务的未授权访问尝试，这在某些情况下很有用。<a class="ae lm" href="https://cloud.google.com/logging/docs/audit#policy_denied" rel="noopener ugc nofollow" target="_blank">🔗</a></p><p id="4a83" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我个人发现<strong class="iw hj"> <em class="kb">数据访问</em> </strong>日志包含有用的事件信息。我们将在这篇博文的其余部分引用这些日志。</p><h1 id="1b11" class="kj kk hi bd kl km ln ko kp kq lo ks kt ku lp kw kx ky lq la lb lc lr le lf lg bi translated">启用审计日志</h1><p id="9b21" class="pw-post-body-paragraph iu iv hi iw b ix lh iz ja jb li jd je jf lj jh ji jj lk jl jm jn ll jp jq jr hb bi translated">在开始之前，我们需要为我们想要生成审计事件的服务启用数据访问审计日志。我们可以在IAM和Admin下的Audit Logs页面中启用事件:</p><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/9c8aef486c1fa0946de99a9d342b6347.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ecgrOoJYQoJm6PAVWNPz8A.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae lm" href="https://console.cloud.google.com/iam-admin/audit" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/iam-admin/audit</a></figcaption></figure><blockquote class="lx ly lz"><p id="2286" class="iu iv kb iw b ix iy iz ja jb jc jd je ma jg jh ji mb jk jl jm mc jo jp jq jr hb bi translated">您可以使用默认配置为所有服务启用审计日志，尽管我发现通过单独选择服务更容易找到我想要观察的日志条目。</p></blockquote><h1 id="2c42" class="kj kk hi bd kl km ln ko kp kq lo ks kt ku lp kw kx ky lq la lb lc lr le lf lg bi translated">查看审计日志</h1><p id="e604" class="pw-post-body-paragraph iu iv hi iw b ix lh iz ja jb li jd je jf lj jh ji jj lk jl jm jn ll jp jq jr hb bi translated">启用审计日志后，您的项目将开始生成并保留这些日志。默认情况下，数据访问日志保留30天。</p><h2 id="5b8b" class="md kk hi bd kl me mf mg kp mh mi mj kt jf mk ml kx jj mm mn lb jn mo mp lf mq bi translated">日志浏览器</h2><p id="d5c3" class="pw-post-body-paragraph iu iv hi iw b ix lh iz ja jb li jd je jf lj jh ji jj lk jl jm jn ll jp jq jr hb bi translated">查看日志的一个好方法是通过日志浏览器。在这里，您有一个强大的查询界面，我们可以在其中查看我们的数据访问日志:</p><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/60d838e1263acc09b0264215eb66b4da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kwrRvCmi82gqQLjrwqUy1Q.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae lm" href="https://console.cloud.google.com/logs/query" rel="noopener ugc nofollow" target="_blank">日志浏览器&gt;日志名称过滤器</a></figcaption></figure><p id="e699" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">当在您的项目中执行某个操作时，您将会看到一个审计日志，比如这个创建云函数的日志(一些个人数据是伪造的):</p><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/40da41de90ca5d6184b610ffce4e1a58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tYLP8WnA2H2Up-33LwRtAg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">带有红色矩形的扩展审计日志条目，突出显示日志的<strong class="bd kl"> <em class="mt">服务名</em> </strong>、<strong class="bd kl">方法名</strong>和<strong class="bd kl">资源名</strong>。</figcaption></figure><p id="8321" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在这里，您可以看到一个日志条目，其中包含我们的<code class="du mu mv mw mx b">protoPayload</code>中一些有用的字段。以下是一些亮点:</p><ul class=""><li id="0b2c" class="my mz hi iw b ix iy jb jc jf na jj nb jn nc jr nd ne nf ng bi translated"><code class="du mu mv mw mx b">serviceName</code>(始终存在):被记录的API/服务。</li><li id="a877" class="my mz hi iw b ix nh jb ni jf nj jj nk jn nl jr nd ne nf ng bi translated"><code class="du mu mv mw mx b">methodName</code>(始终存在):在服务中执行的动作。</li><li id="0e96" class="my mz hi iw b ix nh jb ni jf nj jj nk jn nl jr nd ne nf ng bi translated"><code class="du mu mv mw mx b">resourceName</code>(有时存在):执行动作时被修改的资源。</li></ul><p id="1773" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在这种情况下，我们记录了方法(<code class="du mu mv mw mx b">CreateFunction</code>)和关于函数的细节(函数在<code class="du mu mv mw mx b">secret-project</code>，位置<code class="du mu mv mw mx b">us-central1</code>，函数名<code class="du mu mv mw mx b">new-function</code>)。</p><h1 id="c21e" class="kj kk hi bd kl km ln ko kp kq lo ks kt ku lp kw kx ky lq la lb lc lr le lf lg bi translated">使用Eventarc触发云运行服务</h1><p id="81f0" class="pw-post-body-paragraph iu iv hi iw b ix lh iz ja jb li jd je jf lj jh ji jj lk jl jm jn ll jp jq jr hb bi translated">现在您已经创建了一个审计日志，您可以用这些信息做什么呢？</p><p id="5463" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用Eventarc，我们可以创建一个触发器来监听这些审计日志，并以CloudEvent的形式向云运行服务发送HTTP请求。下面是一个<code class="du mu mv mw mx b">gcloud</code>命令的例子:</p><figure class="lt lu lv lw fd ij"><div class="bz dy l di"><div class="nm nn l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">创建新Eventarc触发器的gcloud命令</figcaption></figure><p id="6429" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">因此，每当您的项目看到带有这个<code class="du mu mv mw mx b">serviceName</code>和<code class="du mu mv mw mx b">methodName</code>的审计日志时，Eventarc将向您的运行服务发送一个带有审计日志的HTTP主体的<code class="du mu mv mw mx b">POST</code>请求。</p><h2 id="9829" class="md kk hi bd kl me mf mg kp mh mi mj kt jf mk ml kx jj mm mn lb jn mo mp lf mq bi translated">(可选)使用Google CloudEvent库</h2><p id="dc8e" class="pw-post-body-paragraph iu iv hi iw b ix lh iz ja jb li jd je jf lj jh ji jj lk jl jm jn ll jp jq jr hb bi translated">根据您的云运行服务的编程语言，您可能希望为CloudEvent有效负载提供某种类型的自动完成。</p><p id="9b70" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Google提供了一些类型库，可以帮助您的应用程序使用这些事件:</p><ul class=""><li id="3296" class="my mz hi iw b ix iy jb jc jf na jj nb jn nc jr nd ne nf ng bi translated"><strong class="iw hj">节点/打字稿</strong>:<a class="ae lm" href="https://github.com/googleapis/google-cloudevents-nodejs" rel="noopener ugc nofollow" target="_blank">github.com/googleapis/google-cloudevents-nodejs</a></li><li id="646c" class="my mz hi iw b ix nh jb ni jf nj jj nk jn nl jr nd ne nf ng bi translated"><strong class="iw hj">走</strong>:<a class="ae lm" href="https://github.com/googleapis/google-cloudevents-go" rel="noopener ugc nofollow" target="_blank">github.com/googleapis/google-cloudevents-go</a></li><li id="4791" class="my mz hi iw b ix nh jb ni jf nj jj nk jn nl jr nd ne nf ng bi translated"><strong class="iw hj">Java</strong>:<a class="ae lm" href="https://github.com/googleapis/google-cloudevents-java" rel="noopener ugc nofollow" target="_blank">github.com/googleapis/google-cloudevents-java</a></li></ul><p id="63db" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">出于好奇，这些库是从GitHub上开源的<em class="kb"> protobufs </em>和<em class="kb"> JSON schemas </em>中生成的:</p><blockquote class="no"><p id="4bd2" class="np nq hi bd nr ns nt nu nv nw nx jr dx translated"><a class="ae lm" href="https://github.com/googleapis/google-cloudevents" rel="noopener ugc nofollow" target="_blank">https://github.com/googleapis/google-cloudevents</a></p></blockquote></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><p id="c253" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">感谢阅读！如果你学到了什么，请打碎它👏！</p></div></div>    
</body>
</html>