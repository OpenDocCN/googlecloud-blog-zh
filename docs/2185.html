<html>
<head>
<title>A Guide to Auditing Cloud Dataflow Job Cost via BigQuery Billing Export</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过BigQuery计费导出审计云数据流作业成本的指南</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/a-guide-to-auditing-cloud-dataflow-jobs-cost-via-bigquery-billing-export-502749813b8b?source=collection_archive---------0-----------------------#2022-05-11">https://medium.com/google-cloud/a-guide-to-auditing-cloud-dataflow-jobs-cost-via-bigquery-billing-export-502749813b8b?source=collection_archive---------0-----------------------#2022-05-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/6d14ff16e7a7cbf80fb4ada24fe8ac94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hZYieF2lKDDtOAKOWsd2ZQ.png"/></div></div></figure><p id="280a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在谷歌云平台上，BigQuery <a class="ae jo" href="https://cloud.google.com/billing/docs/how-to/export-data-bigquery" rel="noopener ugc nofollow" target="_blank">计费导出服务</a>可以成为查询和审计GCP资源成本/计费的有用数据集。在这篇文章中，我们将看看数据流相关作业的使用案例，以及我们如何使用该数据集来衡量它们的成本。</p><p id="7bd1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您还没有一个账单导出设置，请确保在您要审计的项目上激活了BigQuery账单导出。为此，在<a class="ae jo" href="https://console.cloud.google.com/billing/" rel="noopener ugc nofollow" target="_blank">谷歌云控制台</a>中，进入计费&gt;计费导出并激活BigQuery计费导出。<a class="ae jo" href="https://cloud.google.com/billing/docs/how-to/export-data-bigquery" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/billing/docs/how-to/export-data-big query</a></p><h1 id="1380" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">计费出口结构和服务</h1><p id="33d1" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/billing/docs/how-to/export-data-bigquery-tables#standard-usage-cost-data-schema" rel="noopener ugc nofollow" target="_blank">标准计费导出模式</a>具有一组一致的顶级和结构字段，定义如下:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="8222" class="lb jq hi kx b fi lc ld l le lf">+-------------------------------+-----------+<br/>|             Field             |   Type    |<br/>+-------------------------------+-----------+<br/>| billing_account_id            | String    |<br/>| invoice.month                 | String    |<br/>| cost_type                     | String    |<br/>| service.id                    | String    |<br/>| service.description           | String    |<br/>| sku.id                        | String    |<br/>| sku.description               | String    |<br/>| usage_start_time              | Timestamp |<br/>| usage_end_time                | Timestamp |<br/>| project                       | Struct    |<br/>| project.id                    | String    |<br/>| project.number                | String    |<br/>| project.name                  | String    |<br/>| project.ancestry_numbers      | String    |<br/>| project.labels.key            | String    |<br/>| project.labels.value          | String    |<br/>| labels.key                    | String    |<br/>| labels.value                  | String    |<br/>| system_labels.key             | String    |<br/>| system_labels.value           | String    |<br/>| location.location             | String    |<br/>| location.country              | String    |<br/>| location.region               | String    |<br/>| location.zone                 | String    |<br/>| cost                          | Float     |<br/>| currency                      | String    |<br/>| currency_conversion_rate      | Float     |<br/>| usage.amount                  | Float     |<br/>| usage.unit                    | String    |<br/>| usage.amount_in_pricing_units | Float     |<br/>| usage.pricing_unit            | String    |<br/>| credits                       | Struct    |<br/>| credits.id                    | String    |<br/>| credits.full_name             | String    |<br/>| credits.type                  | String    |<br/>| credits.name                  | String    |<br/>| credits.amount                | Float     |<br/>| adjustment_info               | Struct    |<br/>| adjustment_info.id            | string    |<br/>| adjustment_info.description   | string    |<br/>| adjustment_info.type          | String    |<br/>| adjustment_info.mode          | String    |<br/>| export_time                   | Timestamp |<br/>+-------------------------------+-----------+</span></pre><p id="52ba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要查看与特定服务相关的数据(例如数据流)，仔细查看几个列及其子字段非常重要:</p><ul class=""><li id="4c33" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated"><strong class="is hj">服务</strong>—描述服务的ID和名称的字段</li><li id="6df0" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated"><strong class="is hj"> sku </strong> —描述与服务相关的资源类型的字段，如计算、存储、内存等</li><li id="4895" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated"><strong class="is hj"> usage_start_time </strong> —计算给定成本的每小时使用时段的开始时间</li><li id="15e0" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated"><strong class="is hj"> user_end_time </strong> —计算给定成本的每小时使用时段的结束时间</li><li id="d07e" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated"><strong class="is hj">标签</strong> —一组键:值对，表示与使用发生的Google云资源相关的元数据。这将包括通常由服务设置的默认元数据和用户在使用时设置的自定义元数据</li><li id="b7d8" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated"><strong class="is hj">成本</strong> —在任何信用之前的使用成本</li></ul><h1 id="5da2" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">数据流的作业成本结构</h1><h2 id="7d53" class="lb jq hi bd jr lu lv lw jv lx ly lz jz jb ma mb kd jf mc md kh jj me mf kl mg bi translated">SKU</h2><p id="3783" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">典型的数据流作业消耗不同的资源(SKU)。对于同一作业，您可能会找到几行，每一行代表一个SKU的消耗指标，包括以下内容之一:</p><ul class=""><li id="69b9" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">本地磁盘时间</li><li id="de00" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">RAM时间</li><li id="2bd0" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">已处理随机数据</li><li id="354a" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">vCPU时间</li></ul><p id="68bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这种结构在构建成本分析查询时提供了灵活性。您可以选择通过与数据流作业相关的一个或多个SKU来获取成本。</p><h2 id="e45c" class="lb jq hi bd jr lu lv lw jv lx ly lz jz jb ma mb kd jf mc md kh jj me mf kl mg bi translated">通过标签识别工作</h2><p id="f982" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">对于代表数据流成本项目的每一行，我们找到一组标识与该成本相关的作业细节的标签。</p><p id="3714" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">除了<strong class="is hj"> goog-dataflow-job-id之外，</strong>标签因作业及其类型而异。<strong class="is hj"> goog-dataflow-job-id </strong>是在确定成本项目的数据流作业id时要寻找的关键字。</p><p id="88b9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">更一般地，由<strong class="is hj"> goog-dataflow-job-* </strong>前置的标签是由服务附加的标准标签。例如，基于模板的作业会附加与数据流模板相关的额外标签，如下例所示。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ca"><img src="../Images/4e2146480e8e6b3ab9b19c44c5a21246.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WCCFhF-agZms479eJzY_qw.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">BigQuery计费导出中数据流作业的标签集示例</figcaption></figure><h2 id="ad33" class="lb jq hi bd jr lu lv lw jv lx ly lz jz jb ma mb kd jf mc md kh jj me mf kl mg bi translated">对数据流作业使用自定义标签</h2><p id="a62a" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">虽然标准标签对于成本分解很有用，但是您可以通过在作业上附加自定义标签来获得更多的审计细节。这些标签将与<strong class="is hj">标签</strong>字段中的其他默认标签一起添加到成本表中。</p><p id="b645" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">向任务添加自定义标签的一种方式是通过任务启动时的标签<strong class="is hj">命令行标志</strong>。标签作为JSON字符串传递，每个键代表一个标签名及其对应的值。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="4b21" class="lb jq hi kx b fi lc ld l le lf">java -cp ./my_pipeline \<br/>        --runner="DataflowRunner" \<br/>        --project="my-project-id" \<br/>        --inputFile="gs://whatever/input.file" \<br/>        --region="europe-west2" \<br/>        <strong class="kx hj">--labels='{"env": "production", "started_by":"someuser", </strong>"mode": "production"}'</span></pre><p id="f21b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">也可以将管道代码中的标签<strong class="is hj">定义为DataflowPipelineOptions的一部分。对于某些用例来说，这可能更加“灵活”,但是请记住，这个值是在管道启动之前设置的，启动之后就不能修改了。</strong></p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="2351" class="lb jq hi kx b fi lc ld l le lf">private DataflowPipelineOptions options = PipelineOptionsFactory.fromArgs(args).as(DataflowPipelineOptionsImpl.class); <br/>options.setLabels(ImmutableMap.of("key", "value"));</span></pre><h2 id="4be3" class="lb jq hi bd jr lu lv lw jv lx ly lz jz jb ma mb kd jf mc md kh jj me mf kl mg bi translated">长时间运行作业的成本报告(超过1小时)</h2><p id="625e" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">对于运行时间超过1小时的数据流作业(例如流作业)，您可能会注意到，对于相同的作业id，相同的SKU项目会重复出现，如下例所示。</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ml mm l"/></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">用于放大数据流作业成本时间表的示例查询</figcaption></figure><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mn"><img src="../Images/a9c7d11c98b888b6723228e93f478fc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yDS0SNjurwdMqyWXab5Uow.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">运行数小时的流式作业的示例SKU</figcaption></figure><p id="4978" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这应该是正常的行为，可以允许在作业生命周期的特定时间段内测量长时间运行(1h以上)作业的成本时有一定的灵活性。</p><h2 id="dbf5" class="lb jq hi bd jr lu lv lw jv lx ly lz jz jb ma mb kd jf mc md kh jj me mf kl mg bi translated">批处理与流式作业成本报告</h2><p id="60dd" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">默认情况下，没有一个字段可以明确区分作业类型(批处理与流)。这是在作业上设置自定义标签以识别其类型有意义的一个用例。</p><h1 id="d595" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">数据流成本审计的有用查询</h1><p id="80d5" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">到目前为止，您已经看到，计费导出表在查询方面提供了很大的灵活性，让我们深入了解一些您可能想要使用的有用的查询思想。</p><h2 id="06c6" class="lb jq hi bd jr lu lv lw jv lx ly lz jz jb ma mb kd jf mc md kh jj me mf kl mg bi translated">按地点列出的总成本</h2><p id="08f2" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">按位置报告就像按<code class="du mo mp mq kx b">location.location</code>列汇总并对成本值应用求和函数一样简单。</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ml mm l"/></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">每个地区的成本SQL</figcaption></figure><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/91b30c0abe4b853153f59f7997aad51f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*llEkxB-YFZN4UN2u4BPXDQ.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">每个区域的成本结果</figcaption></figure><h2 id="8553" class="lb jq hi bd jr lu lv lw jv lx ly lz jz jb ma mb kd jf mc md kh jj me mf kl mg bi translated">模板成本</h2><p id="289f" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">将管道作为模板部署和运行是数据流中的标准做法。在许多情况下，模板可以代表特定的用例。对于这种情况，按模板名称汇总成本对于报告非常有用。</p><p id="158c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如前所述，数据流模板名称作为字段存储在标签列中，标签列是一个<code class="du mo mp mq kx b">REPEATED RECORD</code>列。为此，我们通过<code class="du mo mp mq kx b">UNNEST</code>和一个针对其值的<a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/arrays#query_structs_in_an_array" rel="noopener ugc nofollow" target="_blank">交叉连接</a>来扩展标签列，从而可以访问每一行上的每个标签键/值。</p><p id="8b59" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，我们根据我们要寻找的关键字<code class="du mo mp mq kx b">goog-dataflow-provided-template-name</code>过滤出行，并根据代表数据流模板名称的行上的相应值列进行分组和应用成本合计。</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ml mm l"/></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">按模板列出的成本SQL</figcaption></figure><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/9954f40709cc3fb18902980bc3e9011a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1O591MVqsAE1i9bNrwDe3Q.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">按模板列出的成本示例结果</figcaption></figure><h2 id="e9ad" class="lb jq hi bd jr lu lv lw jv lx ly lz jz jb ma mb kd jf mc md kh jj me mf kl mg bi translated">每个项目的工作成本</h2><p id="5146" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">另一个有用且受欢迎的做法是获得每个项目每个工作的成本细目，以及您可能发现有用的任何过滤器，例如按工作运行的特定位置进行过滤。</p><p id="c8b9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下面的例子中，我们使用与上一个例子相同的策略从标签中提取数据流作业id，这次使用<code class="du mo mp mq kx b">goog-dataflow-job-id</code>作为struct字段的键。此外，我们从project列中提取id，这是一个不重复的记录字段(这里不需要unnest)。</p><p id="6d6c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，在提取作业id和项目id值的级别上进行聚合，并对成本列进行求和。</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ml mm l"/></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">按项目列出的成本SQL</figcaption></figure><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mt"><img src="../Images/cbba4d56b0ecb0270317d9a4a5d6d624.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hZo0nzWQAAW1hLVqcXpR2A.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">按项目和作业列出的成本实例结果</figcaption></figure><h2 id="9978" class="lb jq hi bd jr lu lv lw jv lx ly lz jz jb ma mb kd jf mc md kh jj me mf kl mg bi translated">按发票月份列出的成本</h2><p id="2582" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">最后，还有一个想法是探索数据流的每个发票月的成本，并列出当月成本最高的数据流作业。</p><p id="c257" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这种情况下，当对成本应用SUM函数时，我们可以很容易地按<code class="du mo mp mq kx b">invoice_month</code>列分组。</p><p id="5f78" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如下面的示例屏幕截图所示，为了获得每个发票月的作业明细，我们在初始查询中扩展了labels字段，以提取数据流作业id，然后在第二个查询中，我们应用上述聚合，并生成一个<code class="du mo mp mq kx b">REPEATED</code> <code class="du mo mp mq kx b">RECORD</code>列，该列集成了一个小型子查询的结果，以映射和排序job _ ids及其成本。</p><p id="c30e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du mo mp mq kx b">ARRAY_AGG(STRUCT(job_id, total_cost) ORDER BY total_cost DESC)</code></p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="ml mm l"/></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">按发票月份列出的成本SQL</figcaption></figure><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/0d842ab35d20bb0f8c5a638f59c5bde6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xu24bsUvSKgob722wLdN_g.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">按发票月份列出的成本示例结果</figcaption></figure><h1 id="d0f9" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">那都是乡亲们！</h1><p id="7f90" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">围绕GCP big query计费导出表的查询可能是无穷无尽的，我希望你会发现数据流上共享的查询和解释对你自己的计费导出冒险有用。与此同时，我希望听到您的反馈以及与此主题相关的问题。查询愉快！:)</p></div></div>    
</body>
</html>