<html>
<head>
<title>Analyzing COVID-19 with BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用BigQuery分析新冠肺炎</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/analyzing-covid-19-with-bigquery-13701a3a785?source=collection_archive---------0-----------------------#2020-03-30">https://medium.com/google-cloud/analyzing-covid-19-with-bigquery-13701a3a785?source=collection_archive---------0-----------------------#2020-03-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="80af" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用免费的BigQuery公共数据集进行分析和规划</h2></div><p id="82f4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Johns Hopkins保存了一个新冠肺炎确诊病例的数据集，并以CSV文件的形式免费提供给学术和研究人员使用。为了让数据更容易查询和分析，谷歌云在BigQuery 中公开了<a class="ae jt" href="https://console.cloud.google.com/marketplace/details/johnshopkins/covid19_jhu_global_cases" rel="noopener ugc nofollow" target="_blank">。BigQuery有一个</a><a class="ae jt" href="https://towardsdatascience.com/bigquery-without-a-credit-card-discover-learn-and-share-199e08d4a064" rel="noopener" target="_blank">沙盒</a>，通过它你可以试用它，而不必注册谷歌云(或者提供信用卡)。</p><p id="10c7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"/></p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="a6cb" class="ke kf hi ka b fi kg kh l ki kj"><em class="ju">bigquery-public-data.covid19_open_data.compatibility_view</em></span></pre><p id="75df" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="ju">我还没有更新输出快照等。</em></p><p id="830b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">作为一个特例，这个BigQuery数据集是<a class="ae jt" href="https://cloud.google.com/blog/products/data-analytics/free-public-datasets-for-covid19" rel="noopener ugc nofollow" target="_blank">免费的，甚至可以在免费层之外进行查询</a>(直到2020年9月)。如果您将新冠肺炎数据与任何其他数据集相关联，这些其他数据集每月的前1 TB查询是免费的，并包含在沙盒计划中。</p><h1 id="fbcf" class="kk kf hi bd kl km kn ko kp kq kr ks kt io ku ip kv ir kw is kx iu ky iv kz la bi translated">查询和绘制数据</h1><p id="47ed" class="pw-post-body-paragraph ix iy hi iz b ja lb ij jc jd lc im jf jg ld ji jj jk le jm jn jo lf jq jr js hb bi translated">转到<a class="ae jt" href="https://console.cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/bigquery</a>并输入:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="05d4" class="ke kf hi ka b fi kg kh l ki kj">SELECT<br/>  date, SUM(confirmed) num_reports<br/>FROM `bigquery-public-data.covid19_open_data.compatibility_view`<br/>WHERE country_region = 'Italy'<br/>GROUP BY date<br/>HAVING num_reports IS NOT NULL<br/>ORDER BY date ASC</span></pre><p id="10f0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">查询返回的前几行:</p><figure class="jv jw jx jy fd lh er es paragraph-image"><div class="er es lg"><img src="../Images/4b0587267b2368233d1e414ba3613ef9.png" data-original-src="https://miro.medium.com/v2/resize:fit:602/format:webp/1*X-IH5XjTjYcUwQ0Ml_qtow.png"/></div></figure><p id="9068" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">而最后几行是:</p><figure class="jv jw jx jy fd lh er es paragraph-image"><div class="er es lk"><img src="../Images/f4531be7ab265845293614d9c50fe747.png" data-original-src="https://miro.medium.com/v2/resize:fit:590/format:webp/1*PJtrWJyUr-VsqVW2tZ7tSQ.png"/></div></figure><p id="5462" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">显示出意大利确诊病例的快速增长。单击“使用Data Studio探索”按钮，在Data Studio中执行以下两个步骤:</p><ol class=""><li id="0fb2" class="ll lm hi iz b ja jb jd je jg ln jk lo jo lp js lq lr ls lt bi translated">选择“平滑时间序列图”图标(见下图中的红色椭圆形)</li><li id="50f9" class="ll lm hi iz b ja lu jd lv jg lw jk lx jo ly js lq lr ls lt bi translated">将指标更改为“报告数量”</li></ol><p id="cd73" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你会得到这样一个图表:</p><figure class="jv jw jx jy fd lh er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es lz"><img src="../Images/7394b8a21a18b0d607c87ea6430099f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EnkLNyIYw7kZNAIZ"/></div></div></figure><p id="4060" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这些数据是全球性的，因此我们可以对新加坡做同样的事情，但这里我们使用BigQuery的地理空间功能:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="c9ae" class="ke kf hi ka b fi kg kh l ki kj">SELECT<br/>  date, SUM(confirmed) num_reports<br/>FROM `bigquery-public-data.covid19_open_data.compatibility_view`<br/>WHERE ST_Distance(ST_GeogPoint(longitude, latitude),  <br/>                  ST_GeogPoint(103.8, 1.4)) &lt; 200*1000     -- 200km<br/>GROUP BY date<br/>HAVING num_reports IS NOT NULL AND num_reports &gt; 0<br/>ORDER BY date ASC</span></pre><p id="168e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这显示了慢得多的增长(注意Y轴):</p><figure class="jv jw jx jy fd lh er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es me"><img src="../Images/bb026d46fdd30371641a0505c090f1db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DP9QTFLlbKYIpmdK"/></div></div></figure><h1 id="82e8" class="kk kf hi bd kl km kn ko kp kq kr ks kt io ku ip kv ir kw is kx iu ky iv kz la bi translated">使用BigQuery GeoViz绘制数据</h1><p id="f4c7" class="pw-post-body-paragraph ix iy hi iz b ja lb ij jc jd lc im jf jg ld ji jj jk le jm jn jo lf jq jr js hb bi translated">要获取县级数据(仅限美国)，您可以在数据中使用fips代码。前往位于https://bigquerygeoviz.appspot.com/的BigQuery GeoViz，输入以下查询以获得每个县的最新确认数字:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="f5b9" class="ke kf hi ka b fi kg kh l ki kj">WITH cases_by_county AS (<br/>  SELECT<br/>    fips,<br/>    ARRAY_AGG(confirmed ORDER BY date DESC LIMIT 1)[OFFSET(0)] as num_cases<br/>  FROM `bigquery-public-data.covid19_open_data.compatibility_view`<br/>  WHERE confirmed IS NOT NULL<br/>  GROUP BY fips<br/>)<br/>SELECT<br/>  num_cases,<br/>  ST_CENTROID(county_geom) AS map_marker<br/>FROM<br/>  cases_by_county<br/>JOIN<br/>  `bigquery-public-data`.geo_us_boundaries.counties<br/>  ON fips = county_fips_code</span></pre><p id="f566" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">地图开始看起来像这样(即，在每个报告县的中心点只有一个小红点):</p><figure class="jv jw jx jy fd lh er es paragraph-image"><div class="er es mf"><img src="../Images/091908eaa8d545e61220232399fb568b.png" data-original-src="https://miro.medium.com/v2/resize:fit:738/0*VHQw3k-EfVRcM9o8"/></div></figure><p id="e9cc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">进入风格部分并选择这些:</p><ul class=""><li id="9960" class="ll lm hi iz b ja jb jd je jg ln jk lo jo lp js mg lr ls lt bi translated">将fillColor更改为数据驱动，并将对话框更改如下(域为对数，范围基于色调):</li></ul><figure class="jv jw jx jy fd lh er es paragraph-image"><div class="er es mh"><img src="../Images/7da4fd7cc0c3888bb703dcf5b1e380c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/0*fbSELL03etpbBDK2"/></div></figure><ul class=""><li id="8842" class="ll lm hi iz b ja jb jd je jg ln jk lo jo lp js mg lr ls lt bi translated">在fillOpacity对话框中，将值更改为0.4。</li><li id="178c" class="ll lm hi iz b ja lu jd lv jg lw jk lx jo ly js mg lr ls lt bi translated">将circleRadius更改为对数和数据驱动:</li></ul><figure class="jv jw jx jy fd lh er es paragraph-image"><div class="er es mi"><img src="../Images/efbe2cbf3c0ad9a28091eeec3f48a730.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*erIhqgLFYzfqjY8K"/></div></figure><p id="dc25" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以获得一个更好看的图，其中半径取决于确诊病例的数量。</p><figure class="jv jw jx jy fd lh er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es mj"><img src="../Images/b040f500fabf22474729d46e216979c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8eq5DWLSYNrXNzQS"/></div></div></figure><h1 id="00cd" class="kk kf hi bd kl km kn ko kp kq kr ks kt io ku ip kv ir kw is kx iu ky iv kz la bi translated">推断趋势</h1><p id="4ed9" class="pw-post-body-paragraph ix iy hi iz b ja lb ij jc jd lc im jf jg ld ji jj jk le jm jn jo lf jq jr js hb bi translated">BigQuery融合了机器学习算法和时间序列预测方法。这些不是流行病学模型，只是对当前趋势的推断。然而，即使是外推法对于规划也是有用的。所以，让我们看看如何推断当前的趋势。</p><p id="aeb1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我将首先为日本说明这一点(参见这篇文章，了解如何在BigQuery 中进行时间序列预测的入门知识)。首先创建一个名为advdata的数据集来保存输出模型。然后，键入:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="d733" class="ke kf hi ka b fi kg kh l ki kj">CREATE OR REPLACE MODEL advdata.numreports_forecast<br/>OPTIONS(model_type='ARIMA',<br/>       time_series_data_col='num_reports',<br/>       time_series_timestamp_col='date') AS<br/>SELECT<br/>   date, SUM(confirmed) num_reports<br/>FROM `bigquery-public-data.covid19_open_data.compatibility_view`<br/>WHERE country_region = 'Japan' AND confirmed IS NOT NULL<br/>GROUP BY date<br/>ORDER BY date ASC</span></pre><p id="3b0a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="ju">请注意，在我写这篇文章的时候，ARIMA模型还处于alpha阶段。联系您的Google Cloud销售代表，将您的项目列入白名单。</em></p><p id="aa1b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就产生了一个时间序列外推模型。我们现在可以通过以下方式获得14天的天气预报:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="76b3" class="ke kf hi ka b fi kg kh l ki kj">SELECT * FROM <br/>ML.FORECAST(MODEL advdata.numreports_forecast,<br/>            STRUCT(14 AS horizon, 0.9 AS confidence_level))</span></pre><p id="c3a6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这产生了(再次请注意，这只是对当前趋势的推断——对于真正的预测，请咨询流行病学家！):</p><figure class="jv jw jx jy fd lh er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es mk"><img src="../Images/be6e30a7a6cfff6fe86f274d55e0b7ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ucOlOqCsfkKK07h3Ch_XdA.png"/></div></div></figure><p id="8418" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们选择日本是有原因的——因为我们使用<a class="ae jt" href="https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average" rel="noopener ugc nofollow" target="_blank"> ARIMA </a>模型进行时间序列预测，我们需要一个稳定的/周期性的趋势。美国正呈现指数增长，如果我们使用原始值，它不是ARIMA的好候选。</p><p id="2aa7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要在美国等地使用ARIMA模型，我们应该记录报告数量，并拟合其趋势。下面的查询可以做到这一点:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="eb56" class="ke kf hi ka b fi kg kh l ki kj">CREATE OR REPLACE MODEL advdata.numreports_forecast<br/>OPTIONS(model_type='ARIMA',<br/>        time_series_data_col='log_num_reports',<br/>        time_series_timestamp_col='date') AS<br/>SELECT<br/>   date, LOG(SUM(confirmed)) log_num_reports<br/>FROM `bigquery-public-data.covid19_open_data.compatibility_view`<br/>WHERE country_region = 'US' AND confirmed IS NOT NULL<br/>GROUP BY date<br/>ORDER BY date ASC<br/>;<br/>SELECT<br/> * , EXP(forecast_value) AS forecast_numreports<br/>FROM ML.FORECAST(MODEL advdata.numreports_forecast,<br/>STRUCT(14 AS horizon, 0.9 AS confidence_level))</span></pre><p id="d337" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这会产生:</p><figure class="jv jw jx jy fd lh er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es me"><img src="../Images/a91365bd17b32799a43ca9517dfc932f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dwBn5rq_78f_Ik7M"/></div></div></figure><p id="1854" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们希望再次重申，这条曲线只是对当前趋势的推断——考虑到预防措施、医院能力、社区传播等因素的真实预测。，你应该咨询流行病学家！</p><p id="aff9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是对历史趋势的推断，没有考虑影响确诊COVID病例数量的所有其他因素。它并不意味着预测实际结果。相反，它意味着推断如果事情保持不变(它们不会)会发生什么。</p><p id="8f0b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们继续下去并与实际结果进行比较，会发生什么呢？以下分析由<a class="ae jt" rel="noopener" href="/@hoffa">费利佩·霍法</a>完成。让我们来看看当我们<a class="ae jt" href="https://github.com/fhoffa/code_snippets/blob/master/arima_covid/usa.6.days.sql" rel="noopener ugc nofollow" target="_blank">扩充查询</a>来比较ARIMA的预测和过去6天的实际数字时会发生什么:</p><figure class="jv jw jx jy fd lh er es paragraph-image"><div class="er es ml"><img src="../Images/1cb3cc3a97dd7f8322d8740e13fc7869.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/0*Ge7mP2C8dD-3UgKQ"/></div></figure><p id="c428" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意，这些都不是很好的预测。预测的数字很快显示出30%的高估，并且置信界限相当宽。这是有意义的，因为我们正在处理指数增长(指数的标准偏差与最终值成比例)，并且实际情况正在发生变化(希望这是因为就地安置开始使曲线变平)。</p><p id="f79b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">底线:不要把预测当成预测实际结果。他们不是。这些都是推断。</p><h1 id="2b21" class="kk kf hi bd kl km kn ko kp kq kr ks kt io ku ip kv ir kw is kx iu ky iv kz la bi translated">获取每日天气预报</h1><p id="6699" class="pw-post-body-paragraph ix iy hi iz b ja lb ij jc jd lc im jf jg ld ji jj jk le jm jn jo lf jq jr js hb bi translated">为了获得每日预测，我们可以从这两个查询中创建一个脚本。这就像一个接一个地编写两个SQL语句一样简单，确保第一个语句以分号结束。然后，单击“计划查询”每天运行:</p><figure class="jv jw jx jy fd lh er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es mm"><img src="../Images/f89012f53a0bb243d7b1f0a4ab3cc223.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NgNnCDVxqctsYhs_"/></div></div></figure><p id="ec37" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意安全！</p><h1 id="a246" class="kk kf hi bd kl km kn ko kp kq kr ks kt io ku ip kv ir kw is kx iu ky iv kz la bi translated">结束语和行动项目</h1><ol class=""><li id="08f7" class="ll lm hi iz b ja lb jd lc jg mn jk mo jo mp js lq lr ls lt bi translated">请遵循公共卫生当局的指导。在美国，这是疾病预防控制中心。在写这篇文章的时候，主要的指导方针是<a class="ae jt" href="http://www.flattenthecurve.com" rel="noopener ugc nofollow" target="_blank">拉平曲线</a>。请尽自己的一份力量，呆在家里，远离大型集会。</li><li id="fe3a" class="ll lm hi iz b ja lu jd lv jg lw jk lx jo ly js lq lr ls lt bi translated">拥有现成的数据支持大量的分析需求，但是要意识到你对数据的解读很可能是错误的。在做出任何生死攸关的决定或根据你的分析推荐任何决定之前，请咨询公共卫生专家。</li><li id="a83d" class="ll lm hi iz b ja lu jd lv jg lw jk lx jo ly js lq lr ls lt bi translated">外推趋势就是这样——外推。报告的数量可能会受到更多测试的影响，也可能会受到“使曲线变平”等干预措施的影响。因此，为了计划的目的使用推断(“如果当前的趋势持续下去，什么都不改变，会发生什么”)但是要意识到世界<strong class="iz hj">将</strong>改变，预测<strong class="iz hj">将</strong>是错误的。</li><li id="19ad" class="ll lm hi iz b ja lu jd lv jg lw jk lx jo ly js lq lr ls lt bi translated">BigQuery是免费的，不需要信用卡(在免费层内)。如果您添加信用卡<strong class="iz hj">，确保</strong>到<a class="ae jt" href="https://stackoverflow.com/questions/52831056/how-do-i-turn-on-cost-controls-on-bigquery" rel="noopener ugc nofollow" target="_blank">设置成本控制</a>。</li></ol><p id="a3b2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我不代表我的雇主。这不是谷歌的官方工作。感谢Felipe Hoffa的许多深刻的评论，以及Amir Hormati的GeoViz情节设置。当然，剩下的任何错误都是我的。</p></div></div>    
</body>
</html>