<html>
<head>
<title>Exposing GKE applications leveraging the built-in ingress</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用内置入口公开GKE应用程序</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/exposing-gke-applications-leveraging-the-built-in-ingress-e87b78e23e90?source=collection_archive---------0-----------------------#2021-12-23">https://medium.com/google-cloud/exposing-gke-applications-leveraging-the-built-in-ingress-e87b78e23e90?source=collection_archive---------0-----------------------#2021-12-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8fc5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">今天，我决定用<a class="ae jd" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank"> GKE </a>玩一玩，看看如何通过默认的<a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/concepts/ingress" rel="noopener ugc nofollow" target="_blank"> GKE入口</a>公开一个简单的演示应用程序。</p><p id="437d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对我来说，在生产环境中公开应用程序意味着(至少…):</p><ul class=""><li id="62b1" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">仅在HTTPS上公开我的应用程序</li><li id="b0f1" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">自动将任何HTTP连接重定向到HTTPS</li><li id="c5e9" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">使用静态IP，而不是短暂的IP</li><li id="d370" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">让谷歌自动为我管理证书</li></ul><p id="bc24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然我习惯于浏览<a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/load-balance-ingress" rel="noopener ugc nofollow" target="_blank">谷歌云文档</a>，但我意识到我仍然需要相当长的时间来把所有的片段放在一起，所以我决定写这个简短的教程。</p><h1 id="08a3" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">我出发的地方</h1><p id="8ea5" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">我所拥有的只是一个最小的设置，我通常保持活跃来尝试一些东西或者运行演示。没什么复杂的:</p><ul class=""><li id="0d86" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">GKE集群(我使用私有集群，但是公共集群也可以)</li><li id="9e1b" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">公共域名。为了这个练习，我们称它为<em class="kv">mydomain.com</em>。</li><li id="caae" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">管理客户端(我的笔记本电脑！)，配置为使用已经设置的kubectl和gcloud访问集群控制平面。</li></ul><h1 id="d33c" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">开始部署吧！</h1><p id="173c" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">这将是一个<em class="kv">“快速和肮脏的”</em>演练。我将强调几件事，因为我们将浏览部署，并将一些相关链接放在文章的末尾，这样您就可以深入了解大多数步骤。</p><p id="df50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于这个练习，我们将尝试在<em class="kv">https://www.mydomain.com展示一个简单的web应用程序。</em></p><p id="9a4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们部署一个示例<em class="kv"> nginx </em>应用程序</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="a170" class="lf jt hi lb b fi lg lh l li lj"># app.yaml</span><span id="6c18" class="lf jt hi lb b fi lk lh l li lj">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  creationTimestamp: null<br/>  labels:<br/>    app: ingress-test<br/>  name: ingress-test<br/>spec:<br/>  containers:<br/>  - name: ingress-test<br/>    image: nginx:latest<br/>    imagePullPolicy: Always<br/>  dnsPolicy: ClusterFirst<br/>  restartPolicy: Always<br/>status: {}</span><span id="be86" class="lf jt hi lb b fi lk lh l li lj">---</span><span id="76a1" class="lf jt hi lb b fi lk lh l li lj">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  creationTimestamp: null<br/>  labels:<br/>    app: ingress-test<br/>  name: ingress-test-svc<br/>  annotations:<br/>    cloud.google.com/neg: '{"ingress": true}'<br/>spec:<br/>  ports:<br/>  - name: ingress-test-port<br/>    port: 80<br/>    protocol: TCP<br/>    targetPort: 80<br/>  selector:<br/>    app: ingress-test<br/>  type: ClusterIP<br/>status:<br/>  loadBalancer: {}</span></pre><p id="24c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意服务<em class="kv"> ingress-test-svc </em>的注释<em class="kv">cloud.google.com/neg:“{ " ingress ":true }”</em>。这有两个好处:</p><ul class=""><li id="1eb6" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">作为服务创建的结果而分配的全局负载平衡器(GLB)将直接在pod之间对流量进行负载平衡，而不是在GKE节点之间，从而利用所谓的<a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/concepts/container-native-load-balancing" rel="noopener ugc nofollow" target="_blank">容器本地负载平衡</a>，因此<a class="ae jd" href="https://cloud.google.com/load-balancing/docs/negs" rel="noopener ugc nofollow" target="_blank">网络端点组(NEGs) </a>。这将避免Kubernetes集群内部的第二级负载平衡/流量路由，有利于更可靠和更快速的路由。</li><li id="3238" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/container-native-load-balancing#using" rel="noopener ugc nofollow" target="_blank">您将能够在入口</a>中引用集群IP服务，而不必创建节点端口或负载平衡器服务。</li></ul><p id="20df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们部署应用程序:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="0586" class="lf jt hi lb b fi lg lh l li lj">kubectl apply -f app.yaml</span></pre><p id="9d94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们来分配一个静态IP。对于演示，我们将使用<em class="kv"> gcloud </em>快速完成，但是<a class="ae jd" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_address" rel="noopener ugc nofollow" target="_blank"> Terraform </a>或<a class="ae jd" href="https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address" rel="noopener ugc nofollow" target="_blank"> GUI </a>也可以使用。从云壳里，我们跑吧</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="921a" class="lf jt hi lb b fi lg lh l li lj">gcloud compute addresses create ingress-test-ip --global</span></pre><p id="ce47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">IP地址立即可见</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="8bf8" class="lf jt hi lb b fi lg lh l li lj">gcloud compute addresses describe ingress-test-ip --global<br/><strong class="lb hj">address: X.X.X.X</strong><br/>addressType: EXTERNAL<br/>creationTimestamp: '2021-12-23T01:32:03.047-08:00'<br/>description: ''<br/>id: 'xxxxxxxxxxxxxxx'<br/>ipVersion: IPV4<br/>kind: compute#address<br/>name: ingress-test<br/>networkTier: PREMIUM<br/>selfLink: <a class="ae jd" href="https://www.googleapis.com/compute/v1/projects/psc-241325431543/global/addresses/ingress-test" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/compute/v1/projects/xxxxxxxx/global/addresses/ingress-test-ip</a><br/>status: IN_USE</span></pre><p id="ff9f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们需要创建一个A DNS记录(在我的例子中，<a class="ae jd" href="https://cloud.google.com/dns/docs/records" rel="noopener ugc nofollow" target="_blank">我是在云DNS </a>中创建的，因为我的域是在那里管理的)，这样我们的www.mydomain.com<a class="ae jd" href="http://www.mydomain.com" rel="noopener ugc nofollow" target="_blank"><em class="kv"/></a>就指向了GLB IP地址。</p><p id="1bb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们创建将由负载平衡器公开的证书。虽然这可以通过Terraform或GUI创建，但有一种直接从GKE请求的便捷方法:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="accd" class="lf jt hi lb b fi lg lh l li lj"># cert.yaml</span><span id="d352" class="lf jt hi lb b fi lk lh l li lj">apiVersion: networking.gke.io/v1<br/>kind: ManagedCertificate<br/>metadata:<br/>  name: ingress-test-cert<br/>spec:<br/>  domains:<br/>    - www<em class="kv">.mydomain.com</em></span></pre><p id="ba0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用您拥有的域替换该域，并应用:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="e95f" class="lf jt hi lb b fi lg lh l li lj">kubectl apply -f cert.yaml</span></pre><p id="89ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将会请求一个新的证书，但是在验证之前它不会被激活，所以直到负载平衡器被创建并且一个DNS条目将指向它(在我们的例子中最后一个已经是真的)。我们将能够从GUI或直接通过kubectl定期检查证书的状态。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="6d4e" class="lf jt hi lb b fi lg lh l li lj">kubectl get managedcertificates<br/>NAME                AGE     STATUS<br/>ingress-test-cert   2m      Pending</span></pre><p id="5cb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们创建入口对象:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="7155" class="lf jt hi lb b fi lg lh l li lj"># ingress.yaml</span><span id="95dd" class="lf jt hi lb b fi lk lh l li lj">apiVersion: networking.gke.io/v1beta1<br/>kind: FrontendConfig<br/>metadata:<br/> name: ingress-test-fe-config<br/>spec:<br/> redirectToHttps:<br/>   enabled: true<br/>   responseCodeName: PERMANENT_REDIRECT</span><span id="b453" class="lf jt hi lb b fi lk lh l li lj">---</span><span id="1014" class="lf jt hi lb b fi lk lh l li lj">apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: test-ingress<br/>  annotations:<br/>    kubernetes.io/ingress.class: "gce"<br/>    kubernetes.io/ingress.global-static-ip-name: "ingress-test-ip"<br/>    networking.gke.io/managed-certificates: "ingress-test-cert"<br/>    networking.gke.io/v1beta1.FrontendConfig: "ingress-test-fe-config"<br/>spec:<br/>  defaultBackend:<br/>    service:<br/>      name: ingress-test-svc<br/>      port:<br/>        number: 80</span></pre><p id="329d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个文件中，我们创建了两个对象:</p><ul class=""><li id="a60c" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">将任何HTTP连接重定向到HTTPS的前端配置(这将自动转换为GLB配置)。感谢伯恩哈德·魏斯胡恩！</li><li id="e72f" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">入口对象，也引用配置。</li></ul><p id="3eb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">说到注解:</p><ul class=""><li id="ddf9" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated"><em class="kv"> ingress.class </em>被设置为<em class="kv"> gce </em>。我喜欢明确地指定这一点，尽管这是没有手动指定时的默认值<a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/load-balance-ingress#creating_an_ingress" rel="noopener ugc nofollow" target="_blank"/>。</li><li id="e729" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">我们告诉入口使用我们之前创建的静态IP，使用它的GCP资源名。</li><li id="b371" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">我们引用刚刚在GCP通过Kubernetes请求的托管证书对象。</li><li id="25f5" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">我们引用FrontendConfig对象，它刚刚在上面的同一个文件中创建。</li></ul><p id="b4d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们申请:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="45e6" class="lf jt hi lb b fi lg lh l li lj">kubectl apply -f ingress.yaml</span></pre><p id="1800" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建负载平衡器需要一些时间。在资源调配期间，我们应该看到类似这样的内容</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="bbc9" class="lf jt hi lb b fi lg lh l li lj">kubectl get ingress<br/>NAME           CLASS    HOSTS   ADDRESS   PORTS   AGE<br/>test-ingress   &lt;none&gt;   *                 80      4s</span></pre><p id="428b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是几分钟后，当负载平衡器准备就绪时，我们应该看到GLB IP出现在输出中(至少，这通常是一个好迹象！)</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="8098" class="lf jt hi lb b fi lg lh l li lj">NAME           CLASS    HOSTS   ADDRESS         PORTS   AGE<br/>test-ingress   &lt;none&gt;   *       x.x.x.x.        80      158m</span></pre><p id="fba4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">证书供应可能需要更长的时间(<a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs#setting_up_a_google-managed_certificate" rel="noopener ugc nofollow" target="_blank"> Google说</a>可能需要60分钟证书才能生效)。对我来说，不超过5分钟。这是你应该看到的:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="51b4" class="lf jt hi lb b fi lg lh l li lj">kubectl get managedcertificates<br/>NAME                AGE     STATUS<br/>ingress-test-cert   15m      Active</span></pre><p id="ca79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">剩下的事情就是打开浏览器，连接到https://www.mydomain.com的<em class="kv"/>，这将显示默认的nginx页面。</p><figure class="kw kx ky kz fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es ll"><img src="../Images/ee9d288f99eb6668707a337225ee4d54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*icivlUJIq83zUDR-UX_qyQ.png"/></div></div></figure><p id="49be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，当我们试图连接到http://www.mydomain.com的<a class="ae jd" href="http://www.mydomain.com" rel="noopener ugc nofollow" target="_blank"><em class="kv"/></a>时，我们总是会被重定向到它的<em class="kv"> https </em>版本。</p><h1 id="c3d9" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">有用的链接</h1><p id="29fd" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">以下是我在练习中使用的一些有用的链接。它们包含更多的变体(即自管理证书)，应该明确用于巩固本文中探讨的概念。</p><ul class=""><li id="476f" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated"><a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-multi-ssl#google-managed-certs_1" rel="noopener ugc nofollow" target="_blank">在具有入口的HTTPS负载平衡中使用多个SSL证书</a></li><li id="8bf7" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" href="https://cloud.google.com/load-balancing/docs/ssl-certificates/google-managed-certs" rel="noopener ugc nofollow" target="_blank">使用谷歌托管证书</a></li><li id="1d2f" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/load-balance-ingress" rel="noopener ugc nofollow" target="_blank">为外部负载平衡配置入口</a></li><li id="e92d" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/container-native-load-balancing" rel="noopener ugc nofollow" target="_blank">通过入口实现容器本地负载平衡</a></li></ul></div><div class="ab cl lt lu gp lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="hb hc hd he hf"><p id="8553" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这篇简短的教程对你有用，能帮你节省时间，或者至少能激起你的好奇心。</p><p id="d0b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更多文章即将发布。敬请期待！</p><p id="854f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kv">感谢</em> <a class="ma mb ge" href="https://medium.com/u/2288812ff80e?source=post_page-----e87b78e23e90--------------------------------" rel="noopener" target="_blank"> <em class="kv">西蒙·鲁菲利</em> </a> <em class="kv">的点评！</em></p></div></div>    
</body>
</html>