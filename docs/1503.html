<html>
<head>
<title>Cloud Spanner Change Publisher</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云扳手更改发布器</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-spanner-change-publisher-7fbee48f66f8?source=collection_archive---------2-----------------------#2020-07-08">https://medium.com/google-cloud/cloud-spanner-change-publisher-7fbee48f66f8?source=collection_archive---------2-----------------------#2020-07-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="fb4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/spanner" rel="noopener ugc nofollow" target="_blank"> Google Cloud Spanner </a>是一个全面管理、可扩展的关系数据库服务，用于区域和全球应用数据。它是第一个可扩展的、企业级的、全球分布的、高度一致的数据库服务，专为云构建，将关系数据库结构的优势与非关系水平扩展相结合。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/16400067b46aef8a444b688bcf1f44a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*t7MKxLVba5Nji_NOIKVrKw.png"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">谷歌云扳手</figcaption></figure><p id="38c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">多个应用程序和服务可以同时与同一个Cloud Spanner数据库交互，常见的模式是一个服务基于某些事件触发其他服务，比如在数据库中插入或更新记录。本文描述了开源的<a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher/tree/master/google-cloud-spanner-change-publisher" rel="noopener ugc nofollow" target="_blank"> spanner-change-publisher </a>服务，它可以作为一个独立的应用程序运行，将云spanner数据库中的数据更改发布到Pubsub。</p><p id="2f9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">开源项目还包含<a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher/tree/master/google-cloud-spanner-change-watcher" rel="noopener ugc nofollow" target="_blank"> spanner-change-watcher </a>库，该库可以集成到现有的Java应用程序中，以将数据更改事件直接交付给该应用程序，而不是将这些事件发布到Pubsub。关于这项服务的介绍可以在<a class="ae jd" rel="noopener" href="/@knutolavloite/cloud-spanner-change-watcher-b77ca036459c">这里</a>找到。</p><h1 id="e537" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">先决条件和限制</h1><ul class=""><li id="1005" class="ko kp hi ih b ii kq im kr iq ks iu kt iy ku jc kv kw kx ky bi translated">Spanner Change Publisher使用<a class="ae jd" href="https://cloud.google.com/spanner/docs/commit-timestamp" rel="noopener ugc nofollow" target="_blank">提交时间戳</a>来确定行何时被更新。使用这个库只能监视包含具有上次更新提交时间戳的列的表。这个专栏的名字可以自由选择。</li><li id="cf50" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">该库只能检测插入和更新，因为它依赖行的提交时间戳值来检测更改。要检测删除，您应该通过在行上设置deleted标志来实现逻辑删除，而不是实际删除它。如果在带有一个或多个标记为ON DELETE CASCADE的子表的父表上执行删除，那么子表也需要相应地更新，以便由观察器选取。单独的后台任务可以使用该标志来检测稍后应该删除哪些行。</li><li id="ffd5" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">该库通过轮询被监视的表来监视数据库的变化。轮询间隔默认为一秒钟，可以进行配置。如果在小于轮询间隔的时间范围内对同一行有多次更改，库可能只报告最后一次更改。</li></ul><h1 id="72e0" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">扳手更换发布者</h1><p id="fc08" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">Spanner Change Publisher是一种服务，它监控云Spanner数据库中的一个、一些或所有表的数据变化，并将检测到的数据变化发布到Pubsub。它既可以作为现有应用程序的一部分执行，也可以作为独立的应用程序执行。Spanner Change Publisher内置了对以Avro和JSON格式发布更改数据的支持，数据转换是可配置的，并允许您提供自己的转换器来转换您可能想要使用的任何格式。</p><p id="d070" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">扳手变化发布器依靠扳手变化监视器来检测数据库中的变化。建议在使用扳手更换发布器之前，对扳手更换观察器有一个基本的了解。扳手更换观察器的介绍可以在<a class="ae jd" rel="noopener" href="/@knutolavloite/cloud-spanner-change-watcher-b77ca036459c">这里</a>找到。</p><p id="383a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对一个表的更改保证按提交时间戳的顺序发布，但Pubsub不保证消息按发布的顺序传递给订阅者。关于Pubsub消息订购的更多信息，请参见https://cloud.google.com/pubsub/docs/ordering<a class="ae jd" href="https://cloud.google.com/pubsub/docs/ordering" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="7319" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">示例应用程序</h1><p id="237f" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">项目<a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher/blob/master/samples/spanner-change-publisher-samples/src/main/java/com/google/cloud/spanner/publisher/sample/SimpleChangePublisherSample.java" rel="noopener ugc nofollow" target="_blank">包含一个小的示例应用程序</a>，它将:</p><ol class=""><li id="e902" class="ko kp hi ih b ii ij im in iq lh iu li iy lj jc lk kw kx ky bi translated">创建一个包含两个表的数据库(或者使用现有的数据库，如果它已经存在的话)。</li><li id="5eae" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc lk kw kx ky bi translated">创建一个扳手更改发布器，它将监视数据库中所有表的更改，并将这些更改发布到一个Pubsub主题。</li><li id="5169" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc lk kw kx ky bi translated">创建一个从Pubsub接收更改并将这些更改写入控制台的Pubsub订阅服务器。</li><li id="dfd8" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc lk kw kx ky bi translated">对云扳手数据库写一些修改。订户将更改写入控制台。</li></ol><h2 id="2f1e" class="ll jr hi bd js lm ln lo jw lp lq lr ka iq ls lt ke iu lu lv ki iy lw lx km ly bi translated">数据模型</h2><p id="f39d" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">该应用程序使用以下数据模型。如果您从一个空数据库开始，它会自动为您创建。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lz ma l"/></div></figure><h2 id="2698" class="ll jr hi bd js lm ln lo jw lp lq lr ka iq ls lt ke iu lu lv ki iy lw lx km ly bi translated">创建扳手变更发布者</h2><p id="daf1" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">如果您的应用程序中包含<a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher/tree/master/google-cloud-spanner-change-publisher" rel="noopener ugc nofollow" target="_blank"> spanner-change-publisher </a>作为依赖项，您可以从自己的应用程序中配置、创建和启动变更发布程序。示例应用程序创建了一个具有以下属性的发布者:</p><ul class=""><li id="832f" class="ko kp hi ih b ii ij im in iq lh iu li iy lj jc kv kw kx ky bi translated">观察Cloud Spanner数据库中所有表(带有提交时间戳列)的变化。</li><li id="4337" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">以JSON格式发布更改后的数据。</li><li id="7cd5" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">发布对单个发布订阅主题的所有更改。每个Pubsub消息的属性还将包含发生更改的表的名称。Spanner Change Publisher还支持发布对每个表的不同主题的更改。关于如何做到这一点的更多信息，请参见项目中的附加示例和方法<code class="du mb mc md me b">Builder.setTopicNameFormat(String)</code>的文档。</li></ul><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lz ma l"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">为整个数据库创建扳手变化发布器</figcaption></figure><p id="dd93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦发布程序运行，对给定数据库中任何表的所有更改都将发布到Pubsub，并将传递给发布更改的主题的订阅者。</p><h2 id="bda8" class="ll jr hi bd js lm ln lo jw lp lq lr ka iq ls lt ke iu lu lv ki iy lw lx km ly bi translated">从云扳手订阅更改</h2><p id="b8b4" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">来自Cloud Spanner的更改以选定的格式发布到选定的发布订阅主题。对这些更改的订阅是使用普通的Pubsub订阅服务器完成的。消息数据包含实际的云扳手数据，而消息属性包含更改的元数据，例如数据库名称、表名称和提交时间戳。</p><p id="2464" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的代码片段显示了如何订阅JSON格式的更改并将这些更改写入标准控制台。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lz ma l"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">订阅扳手变更发布程序的示例</figcaption></figure><h2 id="adba" class="ll jr hi bd js lm ln lo jw lp lq lr ka iq ls lt ke iu lu lv ki iy lw lx km ly bi translated">运行示例应用程序</h2><p id="7008" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">要执行示例应用程序，请按照下列步骤操作:</p><ol class=""><li id="3b04" class="ko kp hi ih b ii ij im in iq lh iu li iy lj jc lk kw kx ky bi translated"><a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher" rel="noopener ugc nofollow" target="_blank">从GitHub </a>克隆项目。</li><li id="1571" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc lk kw kx ky bi translated">导航到<code class="du mb mc md me b">spanner-change-watcher/samples/spanner-change-publisher-samples</code>文件夹。</li><li id="2967" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc lk kw kx ky bi translated">通过执行<code class="du mb mc md me b">mvn clean package</code>创建一个. jar。</li><li id="bfe3" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc lk kw kx ky bi translated">执行以下命令，其中<code class="du mb mc md me b">&lt;instance-id&gt;,</code> <code class="du mb mc md me b">&lt;database-id&gt;, &lt;topic-id&gt;</code>和<code class="du mb mc md me b">&lt;subscription-id&gt;</code>必须替换为实际值。该实例必须已经存在，如果数据库尚不存在，将自动创建该数据库。如果Pubsub主题和Pubsub订阅不存在，也将自动创建它们。请注意，正在使用的帐户必须拥有创建主题和订阅的权限，这样才能自动创建主题和订阅。如果服务帐户没有这些权限，您也可以手动创建主题和订阅。</li></ol><pre class="jf jg jh ji fd mf me mg mh aw mi bi"><span id="f9be" class="ll jr hi me b fi mj mk l ml mm">java -cp target/spanner-change-publisher-samples.jar \<br/>com.google.cloud.spanner.publisher.sample.SimpleChangePublisherSample \<br/>&lt;instance-id&gt; &lt;database-id&gt; &lt;topic-id&gt; &lt;subscription-id&gt;</span></pre><p id="c80b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">示例应用程序将启动Spanner Change发布者和Pubsub订阅者，然后将一些数据写入Cloud Spanner。数据将被写入控制台日志。</p><h1 id="ffc0" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">扳手变化发布者独立应用程序</h1><p id="fb42" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">扳手变化发布器可以作为独立的应用程序来配置和执行，而不需要集成到现有的Java应用程序中。要监视的数据库、应该发布更改的主题以及其他配置选项都可以在属性文件中设置。</p><p id="8d71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完整的配置示例文件可以在GitHub 上找到。下面列出了最重要的配置参数。</p><pre class="jf jg jh ji fd mf me mg mh aw mi bi"><span id="97f9" class="ll jr hi me b fi mj mk l ml mm"># ----- SPANNER SETTINGS ----- #<br/>scep.spanner.project=my-spanner-project<br/>scep.spanner.instance=my-instance<br/>scep.spanner.database=my-database</span><span id="5b2f" class="ll jr hi me b fi mn mk l ml mm">#Credentials to use for Spanner if these differ from the default<br/>scep.spanner.credentials=/path/to/spanner-credentials.json</span><span id="c199" class="ll jr hi me b fi mn mk l ml mm"># Turn watching all tables in the database for changes on/off.<br/>scep.spanner.allTables=false</span><span id="80fa" class="ll jr hi me b fi mn mk l ml mm"># A list of tables that should be excluded from monitoring.<br/># This may only be used in combination with allTables=true.<br/>scep.spanner.excludedTables=TABLE1,TABLE2,TABLE3</span><span id="27f8" class="ll jr hi me b fi mn mk l ml mm"># A list of tables that should be included in the monitoring.<br/># This may only be used in combination with allTables=false.<br/>scep.spanner.includedTables=TABLE1,TABLE2,TABLE3</span><span id="6704" class="ll jr hi me b fi mn mk l ml mm"># The poll interval of the Spanner watcher.<br/>scep.spanner.pollInterval=PT0.5S</span><span id="4a44" class="ll jr hi me b fi mn mk l ml mm"># ----- PUBSUB SETTINGS ----- #<br/>scep.pubsub.project=my-pubsub-project</span><span id="5bf4" class="ll jr hi me b fi mn mk l ml mm"># Credentials to use for Pubsub if these differ from the default.<br/>scep.pubsub.credentials=/path/to/pubsub-credentials.json</span><span id="bcc8" class="ll jr hi me b fi mn mk l ml mm"># Converter to use to convert a Spanner row to a Pubsub message.<br/>scep.pubsub.converterFactory=com.google.cloud.spanner.publisher.SpannerToJsonFactory</span><span id="6c73" class="ll jr hi me b fi mn mk l ml mm"># Topic(s) where to publish the changes.<br/>scep.pubsub.topicNameFormat=spanner-update-%database%-%table%</span></pre><p id="7191" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要使用的配置文件在启动时作为系统参数给出。还可以通过将附加配置值指定为系统参数来覆盖或设置它们。</p><p id="0d1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要运行Spanner Change Publisher独立应用程序，请遵循以下步骤:</p><ol class=""><li id="870a" class="ko kp hi ih b ii ij im in iq lh iu li iy lj jc lk kw kx ky bi translated"><a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher" rel="noopener ugc nofollow" target="_blank">从GitHub </a>克隆项目。</li><li id="1bef" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc lk kw kx ky bi translated">导航到<code class="du mb mc md me b">spanner-change-watcher/google-cloud-spanner-change-publisher</code>文件夹。</li><li id="8402" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc lk kw kx ky bi translated">通过执行<code class="du mb mc md me b">mvn clean package</code>创建一个. jar。</li><li id="a584" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc lk kw kx ky bi translated">执行<code class="du mb mc md me b">java -Dscep.properties=/path/to/your-scep.properties -jar target/spanner-publisher.jar</code>，其中<code class="du mb mc md me b">path/to/your-scep.properties</code>是您的配置文件。</li></ol><h2 id="0e73" class="ll jr hi bd js lm ln lo jw lp lq lr ka iq ls lt ke iu lu lv ki iy lw lx km ly bi translated">发布订阅主题名称格式</h2><p id="b6b7" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">Pubsub主题名称格式配置值用于确定将特定表中的更改发布到何处。配置值允许使用多个通配符将不同表中的更改发布到不同的主题。您还可以指定不带任何通配符的固定格式。这将导致所有更改都发布到同一个主题。订阅者仍然可以看到更改来自哪个表，因为完整的表名包含在Pubsub消息的属性中。</p><p id="6f1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Pubsub主题名称格式配置中支持的通配符有:</p><ul class=""><li id="087e" class="ko kp hi ih b ii ij im in iq lh iu li iy lj jc kv kw kx ky bi translated">%project%:云扳手数据库的项目id</li><li id="c354" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">%instance%:云扳手数据库的实例id</li><li id="77d6" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">%database%:云扳手数据库的数据库id</li><li id="e66c" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">%table%:云扳手数据库的表名</li></ul><p id="d98e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，下面的配置将发布对数据库<code class="du mb mc md me b">my-database</code>中的表<code class="du mb mc md me b">MyTable</code>的更改，以发布到名为<code class="du mb mc md me b">projects/my-pubsub-project/topics/spanner-update-my-database-MyTable</code>的主题。</p><pre class="jf jg jh ji fd mf me mg mh aw mi bi"><span id="8c58" class="ll jr hi me b fi mj mk l ml mm">scep.pubsub.project=my-pubsub-project<br/>scep.pubsub.topicNameFormat=spanner-update-%database%-%table%</span></pre></div></div>    
</body>
</html>