<html>
<head>
<title>Fine tuning a Kubernetes cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">微调Kubernetes集群</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/fine-tuning-a-kubernetes-cluster-187d79370fd9?source=collection_archive---------0-----------------------#2018-12-30">https://medium.com/google-cloud/fine-tuning-a-kubernetes-cluster-187d79370fd9?source=collection_archive---------0-----------------------#2018-12-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="cc81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">众所周知，API服务器、调度器、控制器管理器和Kubernetes组件构成了Kubernetes集群的主干，在这里我们将通过示例来了解如何根据我们的需求调整这些组件。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/83a92873ff43b95eacb1b256c4fd38c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QDMegz35emimpzHDXp0k9Q.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">1925年，一名男子在TRF调试真空管(来源:<a class="ae jt" href="https://commons.wikimedia.org/wiki/File:Tuning_a_TRF_radio_1925.jpg" rel="noopener ugc nofollow" target="_blank">https://commons . wikimedia . org/wiki/File:Tuning _ a _ TRF _无线电_1925.jpg </a>)</figcaption></figure><h2 id="7f21" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">使用Kubeadm创建的集群</h2><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kp"><img src="../Images/a3668907e8173a636f4b92b7f1fc4387.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*o5A7CVyU8nyWEhAqDMz-hA.jpeg"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">来源:<a class="ae jt" href="https://image.slidesharecdn.com/2-kubernetes-training-171016154824/95/orchestrating-microservices-with-kubernetes-37-638.jpg?cb=1508173523" rel="noopener ugc nofollow" target="_blank">https://image . slidesharecdn . com/2-kubernetes-training-171016154824/95/orchestrating-micro services-with-kubernetes-37-638 . jpg？cb=1508173523 </a></figcaption></figure><p id="0683" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用kubeadm配置的集群将kubelet实现为systemd服务，将kube-scheduler、kube-apiserver、kube-controller-manager实现为docker容器，从主机系统的/etc/kubernetes/manifests/加载它们的配置。对这些配置所做的任何更新都会对群集产生直接影响，无需重新启动。</p><h1 id="be41" class="kq jv hi bd jw kr ks kt ka ku kv kw ke kx ky kz kh la lb lc kk ld le lf kn lg bi translated">调整Kubenetes集群的必要性</h1><p id="e01b" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">kubernetes集群及其默认的配置值集合几乎可以满足所有普通用户的需求。在正常情况下，您不必调整Kubernetes配置参数。然而，有些情况下你需要它们，它们将在下面讨论。</p><h1 id="5f53" class="kq jv hi bd jw kr ks kt ka ku kv kw ke kx ky kz kh la lb lc kk ld le lf kn lg bi translated">情况1:更快地检测/响应节点故障</h1><p id="5f0a" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">这里有一个用例，默认配置集不够用，需要调整集群。这是在使用Raspberry Pi集群运行/测试Kubernetes节点故障时。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lm"><img src="../Images/3634383c64384c9c146e04cea04eb213.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_4Gf5jX2R0prZZuMNL_X4A.jpeg"/></div></div></figure><p id="a45a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如@v1ktoor在<a class="ae jt" href="https://fatalfailure.wordpress.com/2016/06/10/improving-kubernetes-reliability-quicker-detection-of-a-node-down/" rel="noopener ugc nofollow" target="_blank">这篇</a>帖子中提到的，kubelet在第40秒(<em class="ln">node-update-status-frequency</em>x(N–1))后检测到节点不可用，在此之后，kube-controller-manager在开始驱逐pod之前会等待5分钟(<em class="ln"> node-eviction-timeout </em>)。这意味着，在节点出现故障后，需要340秒(40秒+5分钟)才能采取任何措施。这可以通过降低默认值来加快反应速度。例如，在Raspi kubernetes集群中将以下值设置为:</p><ul class=""><li id="394f" class="lo lp hi ih b ii ij im in iq lq iu lr iy ls jc lt lu lv lw bi translated"><strong class="ih hj"> kubelet </strong> : <em class="ln">节点-状态-更新-频率</em> =4s(从10s开始)</li><li id="d3e5" class="lo lp hi ih b ii lx im ly iq lz iu ma iy mb jc lt lu lv lw bi translated"><strong class="ih hj">kube-控制器-管理器</strong> : <em class="ln">节点-监控-周期</em> =2s(从5s开始)</li><li id="addf" class="lo lp hi ih b ii lx im ly iq lz iu ma iy mb jc lt lu lv lw bi translated"><strong class="ih hj">kube-controller-manager</strong>:<em class="ln">node-monitor-grace-period</em>= 16s(从40s开始)</li><li id="26d3" class="lo lp hi ih b ii lx im ly iq lz iu ma iy mb jc lt lu lv lw bi translated"><strong class="ih hj">kube-controller-manager</strong>:<em class="ln">pod-eviction-time out</em>= 30s(从5m开始)</li></ul><p id="d53c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保满足公式:<em class="ln"> pod-eviction-timeout &gt;(节点-状态-更新-频率x (N-1) ==节点-监视器-宽限期)</em>。修改上述值后，控制器管理器在故障发生后半分钟内开始驱逐pod(从电源上拔下随机的RaspberryPi)。</p><h1 id="c994" class="kq jv hi bd jw kr ks kt ka ku kv kw ke kx ky kz kh la lb lc kk ld le lf kn lg bi translated">情况2:每个节点的最大pod超过110</h1><p id="9865" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">如果您有一个大型集群，或者如果您正在尝试使用更多的pod进行测试，您将很快意识到，每个节点有110个pod的硬性限制。您会得到这样错误:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="bc27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以上是用<em class="ln"> kubeadm </em>创建的双节点+主集群。该值在<em class="ln">/var/lib/kube let/CONFIG . YAML</em>中配置为<em class="ln"> maxPods </em>，并作为<em class="ln"> - config </em>传递给<em class="ln"> kubelet </em>作为KUBELET_CONFIG_ARGS。这可以调整到所需的值，并重新启动<em class="ln"> kubelet </em>以使其生效。</p><h1 id="a036" class="kq jv hi bd jw kr ks kt ka ku kv kw ke kx ky kz kh la lb lc kk ld le lf kn lg bi translated">更多配置参数</h1><p id="bbf2" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">除此之外，这里记录了所有kubernetes组件的完整参考:</p><ul class=""><li id="eabe" class="lo lp hi ih b ii ij im in iq lq iu lr iy ls jc lt lu lv lw bi translated"><strong class="ih hj"> Kubernetes api服务器</strong>—<a class="ae jt" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/" rel="noopener ugc nofollow" target="_blank">https://Kubernetes . io/docs/reference/command-line-tools-reference/kube-API server/</a></li><li id="dae9" class="lo lp hi ih b ii lx im ly iq lz iu ma iy mb jc lt lu lv lw bi translated"><strong class="ih hj"> Kubernetes控制器管理器</strong>—<a class="ae jt" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/" rel="noopener ugc nofollow" target="_blank">https://Kubernetes . io/docs/reference/command-line-tools-reference/kube-controller-manager/</a></li><li id="e0f5" class="lo lp hi ih b ii lx im ly iq lz iu ma iy mb jc lt lu lv lw bi translated"><strong class="ih hj"> Kubernetes调度程序</strong>—<a class="ae jt" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/" rel="noopener ugc nofollow" target="_blank">https://Kubernetes . io/docs/reference/command-line-tools-reference/kube-scheduler/</a></li><li id="6322" class="lo lp hi ih b ii lx im ly iq lz iu ma iy mb jc lt lu lv lw bi translated"><strong class="ih hj">kube let</strong>—<a class="ae jt" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/reference/command-line-tools-reference/kube let/</a></li></ul><p id="dc8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保这些服务在修改后重新启动。</p><h1 id="4d73" class="kq jv hi bd jw kr ks kt ka ku kv kw ke kx ky kz kh la lb lc kk ld le lf kn lg bi translated">云托管解决方案—局限性</h1><p id="b4ca" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">几乎所有主要的云供应商都提供托管/托管的kubernetes解决方案。在这种情况下，用户不必关心集群的维护，缺点是无法访问/调整配置参数。然而，托管解决方案的整体思想是不必关心kubernetes的复杂性。</p><h1 id="455c" class="kq jv hi bd jw kr ks kt ka ku kv kw ke kx ky kz kh la lb lc kk ld le lf kn lg bi translated">结论</h1><p id="03ad" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">由于kubernetes的社区和它的用途被带到不同的领域，很难找到一个适合所有人的默认配置。有时，您需要根据需要修改配置参数。然而，非常好的是，社区已经设法维护了大量的配置参数，这些参数可以在源代码之外进行修改。</p><h1 id="2a03" class="kq jv hi bd jw kr ks kt ka ku kv kw ke kx ky kz kh la lb lc kk ld le lf kn lg bi translated">参考</h1><ol class=""><li id="6238" class="lo lp hi ih b ii lh im li iq me iu mf iy mg jc mh lu lv lw bi translated">关于检测更快节点故障的帖子—<a class="ae jt" href="https://fatalfailure.wordpress.com/2016/06/10/improving-kubernetes-reliability-quicker-detection-of-a-node-down/" rel="noopener ugc nofollow" target="_blank">https://fatal failure . WordPress . com/2016/06/10/improving-kubernetes-reliability-faster-detection-of-a-node-down/</a></li></ol></div></div>    
</body>
</html>