<html>
<head>
<title>Dead letter queue for errors with Beam, Asgarde, Dataflow and alerting in real time</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">死信队列，用于波束、Asgarde、数据流和实时报警的错误</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/dead-letter-queue-for-errors-with-beam-asgarde-dataflow-and-alerting-in-real-time-5745225e12b7?source=collection_archive---------0-----------------------#2022-12-19">https://medium.com/google-cloud/dead-letter-queue-for-errors-with-beam-asgarde-dataflow-and-alerting-in-real-time-5745225e12b7?source=collection_archive---------0-----------------------#2022-12-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="957f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文的目标是展示一个用例，其中的一个<code class="du jd je jf jg b">Beam</code>管道包含一个<code class="du jd je jf jg b">dead letter queue</code>，用于处理通过<code class="du jd je jf jg b">Asgarde</code>库应用的错误。</p><p id="b4b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于<code class="du jd je jf jg b">Asgarde</code>库的更多细节，可以查看这篇文章:</p><div class="jh ji ez fb jj jk"><a rel="noopener follow" target="_blank" href="/google-cloud/error-handling-with-apache-beam-presentation-of-asgarde-ce5e5dfb2d74"><div class="jl ab dw"><div class="jm ab jn cl cj jo"><h2 class="bd hj fi z dy jp ea eb jq ed ef hh bi translated">Apache Beam的错误处理:Asgarde演示</h2><div class="jr l"><h3 class="bd b fi z dy jp ea eb jq ed ef dx translated">波束ParDo和DoFn的误差逻辑</h3></div><div class="js l"><p class="bd b fp z dy jp ea eb jq ed ef dx translated">medium.com</p></div></div><div class="jt l"><div class="ju l jv jw jx jt jy jz jk"/></div></div></a></div><h1 id="6246" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">1.本文中出现的用例的解释</h1><p id="f058" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated"><code class="du jd je jf jg b">dead letter queue</code>是一种在不中断作业的情况下捕捉数据管道中的错误的方法。这项技术很有趣，因为错误不会丢失，并且可以根据错误处理策略在最佳存储服务中消失:</p><ul class=""><li id="f1b9" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated">可以在<code class="du jd je jf jg b">PubSub topic</code>中发送错误以重新加载</li><li id="356c" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">错误可以存储在一个<code class="du jd je jf jg b">Bigquery</code>表中，以允许开发团队或合作伙伴分析错误，并在仪表板中显示它们</li><li id="20d5" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">可以将错误写入<code class="du jd je jf jg b">Cloud storage</code>文件，稍后以<code class="du jd je jf jg b">batch</code>模式重新加载</li></ul><p id="2f5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，选择了一个<code class="du jd je jf jg b">Bigquery</code>表中的存储。</p><blockquote class="lr ls lt"><p id="637a" class="if ig lu ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><strong class="ih hj"><em class="hi"/></strong><code class="du jd je jf jg b"><strong class="ih hj"><em class="hi">Beam</em></strong></code><strong class="ih hj"><em class="hi">作业包含2个汇:</em> </strong></p></blockquote><ul class=""><li id="8205" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated">写在<code class="du jd je jf jg b">Bigquery</code>表中的良好输出</li><li id="9153" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">记录在<code class="du jd je jf jg b">Bigquery</code>表和<code class="du jd je jf jg b">Cloud Logging</code>中的故障</li></ul><blockquote class="lr ls lt"><p id="b9b7" class="if ig lu ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi">故障将以如下方式被利用:</em> </strong></p></blockquote><ul class=""><li id="def3" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated">当在<code class="du jd je jf jg b">Cloud Logging</code>中写入故障时，会实时发送电子邮件警报</li><li id="32ed" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">一个<code class="du jd je jf jg b">Datastudio</code>仪表板将显示一个日期范围内的故障</li></ul><p id="98c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里你可以看到这篇文章的用例图:</p><figure class="lz ma mb mc fd md er es paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="er es ly"><img src="../Images/c0215d3d60d035c98141ec0bef229ea4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dR4t4td-Gd_FBgVd0NmZ-w.png"/></div></div></figure><h1 id="958f" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">2.具有梁本机的死信队列</h1><p id="78b9" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">在这一节中，我们将展示如何使用<code class="du jd je jf jg b">Beam</code> native应用死信队列和错误处理。</p><h2 id="3d4f" class="mj kb hi bd kc mk ml mm kg mn mo mp kk iq mq mr ko iu ms mt ks iy mu mv kw mw bi translated"><strong class="ak"> 2.1用梁Java的例子</strong></h2><p id="ea96" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">为了应用<code class="du jd je jf jg b">dead letter queue</code>和错误处理，<code class="du jd je jf jg b">Beam</code>建议用以下方式处理侧输出:</p><ul class=""><li id="9418" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated"><code class="du jd je jf jg b">TupleTags</code>在<code class="du jd je jf jg b">DoFn</code>类中</li><li id="434d" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">内置组件<code class="du jd je jf jg b">MapElements</code><code class="du jd je jf jg b">FlatMapElements</code><code class="du jd je jf jg b">exceptionInto</code>和<code class="du jd je jf jg b">exceptionVia</code>的方法，举例:</li></ul><pre class="lz ma mb mc fd mx jg my bn mz na bi"><span id="64d4" class="nb kb hi jg b be nc nd l ne nf">@Override<br/>public Result&lt;PCollection&lt;TeamStats&gt;, Failure&gt; expand(PCollection&lt;TeamStatsRaw&gt; input) {<br/>    Result&lt;PCollection&lt;TeamStatsRaw&gt;, Failure&gt; res1 = input.apply("Validate fields", MapElements<br/>            .into(of(TeamStatsRaw.class))<br/>            .via(TeamStatsRaw::validateFields)<br/>            .exceptionsInto(of(Failure.class))<br/>            .exceptionsVia(exElt -&gt; Failure.from("Validate fields", exElt)));<br/><br/>    PCollection&lt;TeamStatsRaw&gt; output1 = res1.output();<br/>    PCollection&lt;Failure&gt; failure1 = res1.failures();<br/><br/>    Result&lt;PCollection&lt;TeamStats&gt;, Failure&gt; res2 = output1.apply("Compute team stats", MapElements<br/>            .into(of(TeamStats.class))<br/>            .via(TeamStats::computeTeamStats)<br/>            .exceptionsInto(of(Failure.class))<br/>            .exceptionsVia(exElt -&gt; Failure.from("Compute team stats", exElt)));<br/><br/>    PCollection&lt;TeamStats&gt; output2 = res2.output();<br/>    PCollection&lt;Failure&gt; failure2 = res2.failures();<br/><br/>    final TransformToTeamStatsWithSloganFn toStatsWithSloganFn = new TransformToTeamStatsWithSloganFn(<br/>            "Add team slogan",<br/>            slogansSideInput<br/>    );<br/>    final PCollectionTuple res3 = output2.apply(name,<br/>            ParDo.of(toStatsWithSloganFn)<br/>                    .withOutputTags(toStatsWithSloganFn.getOutputTag(), TupleTagList.of(toStatsWithSloganFn.getFailuresTag()))<br/>                    .withSideInput("slogans", slogansSideInput));<br/><br/>    PCollection&lt;TeamStats&gt; output3 = res3.get(toStatsWithSloganFn.getOutputTag());<br/>    PCollection&lt;Failure&gt; failure3 = res3.get(toStatsWithSloganFn.getFailuresTag());<br/><br/>    PCollection&lt;Failure&gt; allFailures = PCollectionList<br/>            .of(failure1)<br/>            .and(failure2)<br/>            .and(failure3)<br/>            .apply(Flatten.pCollections());<br/><br/>    return Result.of(output3, allFailures);<br/>}</span></pre><p id="879a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种方法的问题是，代码冗长，我们必须重复技术代码来处理错误。</p><p id="69e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">链接到Github库:</strong></p><div class="jh ji ez fb jj jk"><a href="https://github.com/tosun-si/teams-league-java-dlq-native-beam-summit/blob/main/src/main/java/fr/groupbees/domain_ptransform/TeamStatsTransform.java" rel="noopener  ugc nofollow" target="_blank"><div class="jl ab dw"><div class="jm ab jn cl cj jo"><h2 class="bd hj fi z dy jp ea eb jq ed ef hh bi translated">teams-league-Java-dlq-native-beam-summit/teamstatsform . Java at main…</h2><div class="jr l"><h3 class="bd b fi z dy jp ea eb jq ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="js l"><p class="bd b fp z dy jp ea eb jq ed ef dx translated">github.com</p></div></div><div class="jt l"><div class="ng l jv jw jx jt jy jz jk"/></div></div></a></div><h2 id="3e96" class="mj kb hi bd kc mk ml mm kg mn mo mp kk iq mq mr ko iu ms mt ks iy mu mv kw mw bi translated"><strong class="ak"> 2.2梁Python示例</strong></h2><p id="ba76" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">在<code class="du jd je jf jg b">Python</code> sdk中，原理是一样的，我们必须在一个<code class="du jd je jf jg b">DoFn</code>类中使用<code class="du jd je jf jg b">TupleTag</code>，例如:</p><pre class="lz ma mb mc fd mx jg my bn mz na bi"><span id="a1d6" class="nb kb hi jg b be nc nd l ne nf">def expand(self, inputs: PCollection[TeamStatsRaw]) -&gt; \<br/>        Tuple[PCollection[TeamStats], PCollection[Failure]]:<br/>    # When.<br/>    outputs_map1, failures_map1 = (<br/>            inputs | VALIDATE_FIELDS &gt;&gt; ParDo(TeamStatsRawFieldsValidationFn(VALIDATE_FIELDS))<br/>            .with_outputs(FAILURES, main='outputs')<br/>    )<br/><br/>    outputs_map2, failures_map2 = (<br/>            outputs_map1 | COMPUTE_TEAM_STATS &gt;&gt; ParDo(TeamStatsMapperFn(COMPUTE_TEAM_STATS))<br/>            .with_outputs(FAILURES, main='outputs')<br/>    )<br/><br/>    final_outputs, failures_map3 = (<br/>            outputs_map2 | ADD_SLOGAN_TEAM_STATS &gt;&gt;<br/>            ParDo(<br/>                TeamStatsWithSloganFn(ADD_SLOGAN_TEAM_STATS),<br/>                AsSingleton(self.slogans_side_inputs)<br/>            )<br/>            .with_outputs(FAILURES, main='outputs')<br/>    )<br/><br/>    result_all_failures = (<br/>            (failures_map1, failures_map2, failures_map3)<br/>            | 'All Failures PCollections' &gt;&gt; beam.Flatten()<br/>    )<br/><br/>    return final_outputs, result_all_failures</span></pre><p id="5a4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">至于Java部分，问题是相同的，我们必须重复错误处理的技术代码。</p><p id="bd68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">链接到Github库:</strong></p><div class="jh ji ez fb jj jk"><a href="https://github.com/tosun-si/teams-league-python-dlq-native-beam-summit/blob/main/team_league/domain_ptransform/team_stats_transform.py" rel="noopener  ugc nofollow" target="_blank"><div class="jl ab dw"><div class="jm ab jn cl cj jo"><h2 class="bd hj fi z dy jp ea eb jq ed ef hh bi translated">teams-league-python-dlq-native-beam-summit/team _ stats _ transform . py at main…</h2><div class="jr l"><h3 class="bd b fi z dy jp ea eb jq ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="js l"><p class="bd b fp z dy jp ea eb jq ed ef dx translated">github.com</p></div></div><div class="jt l"><div class="nh l jv jw jx jt jy jz jk"/></div></div></a></div><h1 id="563c" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">3.带Asgarde库的死信队列</h1><p id="9bcf" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">在这一节中，我们将展示如何使用<code class="du jd je jf jg b">Beam</code>和<code class="du jd je jf jg b">Asgarde</code>库应用死信队列和错误处理。</p><h2 id="0072" class="mj kb hi bd kc mk ml mm kg mn mo mp kk iq mq mr ko iu ms mt ks iy mu mv kw mw bi translated"><strong class="ak"> 3.1用Asgarde Java的例子</strong></h2><p id="d0a7" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated"><code class="du jd je jf jg b">Asgarde</code> <code class="du jd je jf jg b">Java</code>提出了一个<code class="du jd je jf jg b">CollectionComposer</code>类，用更少的代码和更有表现力的代码来简化错误处理:</p><pre class="lz ma mb mc fd mx jg my bn mz na bi"><span id="c03c" class="nb kb hi jg b be nc nd l ne nf">@Override<br/>public Result&lt;PCollection&lt;TeamStats&gt;, Failure&gt; expand(PCollection&lt;TeamStatsRaw&gt; input) {<br/>    return CollectionComposer.of(input)<br/>            .apply("Validate fields", MapElements.into(of(TeamStatsRaw.class)).via(TeamStatsRaw::validateFields))<br/>            .apply("Compute team stats", MapElementFn<br/>                    .into(of(TeamStats.class))<br/>                    .via(TeamStats::computeTeamStats)<br/>                    .withStartBundleAction(() -&gt; LOGGER.info("####################Start bundle compute stats")))<br/>            .apply("Add team slogan", MapProcessContextFn<br/>                            .from(TeamStats.class)<br/>                            .into(of(TeamStats.class))<br/>                            .via(c -&gt; addSloganToStats(c, slogansSideInput))<br/>                            .withSetupAction(() -&gt; LOGGER.info("####################Start add slogan")),<br/>                    Collections.singletonList(slogansSideInput))<br/>            .getResult();<br/>}</span></pre><p id="220b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">链接到Github库:</strong></p><div class="jh ji ez fb jj jk"><a href="https://github.com/tosun-si/teams-league-java-dlq-asgarde-beam-summit/blob/main/src/main/java/fr/groupbees/domain_ptransform/TeamStatsTransform.java" rel="noopener  ugc nofollow" target="_blank"><div class="jl ab dw"><div class="jm ab jn cl cj jo"><h2 class="bd hj fi z dy jp ea eb jq ed ef hh bi translated">teams-league-Java-dlq-as garde-beam-summit/teamstatsform . Java at main…</h2><div class="jr l"><h3 class="bd b fi z dy jp ea eb jq ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="js l"><p class="bd b fp z dy jp ea eb jq ed ef dx translated">github.com</p></div></div><div class="jt l"><div class="ni l jv jw jx jt jy jz jk"/></div></div></a></div><h2 id="edbf" class="mj kb hi bd kc mk ml mm kg mn mo mp kk iq mq mr ko iu ms mt ks iy mu mv kw mw bi translated">【with Asgarde Kotlin的例子</h2><p id="b26c" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated"><code class="du jd je jf jg b">Asgarde</code>还提议用更多的函数式编程风格对<code class="du jd je jf jg b">Kotlin</code>进行扩展:</p><pre class="lz ma mb mc fd mx jg my bn mz na bi"><span id="16e6" class="nb kb hi jg b be nc nd l ne nf">override fun expand(input: PCollection&lt;TeamStatsRaw&gt;): Result&lt;PCollection&lt;TeamStats&gt;, Failure&gt; {<br/>    return CollectionComposer.of(input)<br/>        .map("Validate fields") { it.validateFields() }<br/>        .mapFn(<br/>            name = "Compute team stats",<br/>            startBundleAction = { LOGGER.info("####################Start bundle compute stats") },<br/>            transform = { TeamStats.computeTeamStats(it) })<br/>        .mapFnWithContext&lt;TeamStats, TeamStats&gt;(<br/>            name = "Add team slogan",<br/>            setupAction = { LOGGER.info("####################Start add slogan") },<br/>            sideInputs = listOf(slogansSideInput),<br/>            transform = { addSloganToStats(it, slogansSideInput) }<br/>        )<br/>        .result<br/>}</span></pre><p id="349f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">链接到Github库:</strong></p><div class="jh ji ez fb jj jk"><a href="https://github.com/tosun-si/teams-league-kotlin-dlq-asgarde-beam-summit/blob/main/src/main/kotlin/fr/groupbees/domain_ptransform/TeamStatsTransform.kt" rel="noopener  ugc nofollow" target="_blank"><div class="jl ab dw"><div class="jm ab jn cl cj jo"><h2 class="bd hj fi z dy jp ea eb jq ed ef hh bi translated">teams-league-kot Lin-dlq-as garde-beam-summit/teamstats transform . kt at main…</h2><div class="jr l"><h3 class="bd b fi z dy jp ea eb jq ed ef dx translated">通过在GitHub上创建一个帐户，为tosun-si/teams-league-kot Lin-dlq-as garde-beam-summit开发做出贡献。</h3></div><div class="js l"><p class="bd b fp z dy jp ea eb jq ed ef dx translated">github.com</p></div></div><div class="jt l"><div class="nj l jv jw jx jt jy jz jk"/></div></div></a></div><h2 id="92a9" class="mj kb hi bd kc mk ml mm kg mn mo mp kk iq mq mr ko iu ms mt ks iy mu mv kw mw bi translated"><strong class="ak">3.3 Asgarde Python的例子</strong></h2><p id="d261" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated"><code class="du jd je jf jg b">Asgarde</code> <code class="du jd je jf jg b">Python</code>与<code class="du jd je jf jg b">Java</code>库中一样，提出了一个<code class="du jd je jf jg b">CollectionComposer</code>类来简化错误处理:</p><pre class="lz ma mb mc fd mx jg my bn mz na bi"><span id="5ecb" class="nb kb hi jg b be nc nd l ne nf">def expand(self, inputs: PCollection[TeamStatsRaw]) -&gt; \<br/>            Tuple[PCollection[TeamStats], PCollection[Failure]]:<br/>    result = (CollectionComposer.of(inputs)<br/>              .map("Validate raw fields", lambda t_raw: t_raw.validate_fields())<br/>              .map("Compute team stats", TeamStats.compute_team_stats)<br/>              .map("Add slogan to team stats",<br/>                   self.add_slogan_to_stats,<br/>                   slogans=AsSingleton(self.slogans_side_inputs),<br/>                   setup_action=lambda: '######### Start add slogan to stats actions')<br/>              )<br/><br/>    return result.outputs, result.failures</span></pre><p id="30b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">链接到Github库:</strong></p><div class="jh ji ez fb jj jk"><a href="https://github.com/tosun-si/teams-league-python-dlq-asgarde-beam-summit/blob/main/team_league/domain_ptransform/team_stats_transform.py" rel="noopener  ugc nofollow" target="_blank"><div class="jl ab dw"><div class="jm ab jn cl cj jo"><h2 class="bd hj fi z dy jp ea eb jq ed ef hh bi translated">teams-league-python-dlq-as garde-beam-summit/team _ stats _ transform . py at main…</h2><div class="jr l"><h3 class="bd b fi z dy jp ea eb jq ed ef dx translated">通过在GitHub上创建一个帐户，为tosun-si/teams-league-python-dlq-as garde-beam-summit开发做出贡献。</h3></div><div class="js l"><p class="bd b fp z dy jp ea eb jq ed ef dx translated">github.com</p></div></div><div class="jt l"><div class="nk l jv jw jx jt jy jz jk"/></div></div></a></div><h1 id="5a65" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">4.波束管道故障IO</h1><p id="1f09" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">在本例中，管道输出为:</p><ul class=""><li id="8e44" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated">写在<code class="du jd je jf jg b">Bigquery</code>表中的良好输出</li><li id="9531" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">用写在<code class="du jd je jf jg b">Bigquery</code>表中的<code class="du jd je jf jg b">Beam/Asgarde</code>捕获的故障，用于在仪表板中分析和展示</li><li id="ac5a" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">用包含输入元素和堆栈跟踪的特定<code class="du jd je jf jg b">log</code> <code class="du jd je jf jg b">pattern</code>在<code class="du jd je jf jg b">Cloud logging</code>中编写的故障</li></ul><p id="36f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">BigQuery</code> <code class="du jd je jf jg b">job_failure</code>表的模式是:</p><figure class="lz ma mb mc fd md er es paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="er es nl"><img src="../Images/50e3317fd86fd640b849ac2373fce016.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QWPh20WPFNM1852owJksBg.png"/></div></div></figure><p id="6929" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了节省成本，我们在<code class="du jd je jf jg b">dwhCreationDate</code>字段上每天添加一个<strong class="ih hj">分区</strong>。</p><p id="09e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还在<code class="du jd je jf jg b">featureName</code> <code class="du jd je jf jg b">jobName</code> <code class="du jd je jf jg b">componentType</code>和<code class="du jd je jf jg b">pipelineStep</code>字段上添加了一个<strong class="ih hj">聚类</strong>，以提高用户使用<strong class="ih hj"> WHERE </strong>子句时的查询性能。</p><p id="693a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">json</code>模式:</p><pre class="lz ma mb mc fd mx jg my bn mz na bi"><span id="a8ae" class="nb kb hi jg b be nc nd l ne nf">[<br/>    {<br/>        "name": "featureName",<br/>        "type": "STRING",<br/>        "mode": "NULLABLE",<br/>        "description": "Feature name concerned by error"<br/>    },<br/>    {<br/>        "name": "jobName",<br/>        "type": "STRING",<br/>        "mode": "NULLABLE",<br/>        "description": "Job name concerned by error"<br/>    },<br/>    {<br/>        "name": "pipelineStep",<br/>        "type": "STRING",<br/>        "mode": "NULLABLE",<br/>        "description": "Pipeline step concerned by error"<br/>    },<br/>    {<br/>        "name": "inputElement",<br/>        "type": "STRING",<br/>        "mode": "NULLABLE",<br/>        "description": "Input element when error occurred"<br/>    },<br/>    {<br/>        "name": "exceptionType",<br/>        "type": "STRING",<br/>        "mode": "NULLABLE",<br/>        "description": "Exception type of error"<br/>    },<br/>    {<br/>        "name": "stackTrace",<br/>        "type": "STRING",<br/>        "mode": "NULLABLE",<br/>        "description": "Stack trace of error"<br/>    },<br/>    {<br/>        "name": "componentType",<br/>        "type": "STRING",<br/>        "mode": "NULLABLE",<br/>        "description": "GCP Component type (Dataflow, Composer....)"<br/>    },<br/>    {<br/>        "name": "dwhCreationDate",<br/>        "type": "TIMESTAMP",<br/>        "mode": "NULLABLE",<br/>        "description": "Creation date of error"<br/>    }<br/>]</span></pre><h2 id="5feb" class="mj kb hi bd kc mk ml mm kg mn mo mp kk iq mq mr ko iu ms mt ks iy mu mv kw mw bi translated">4.1 Beam Java中<strong class="ak"> BigQuery IO </strong>的代码</h2><pre class="lz ma mb mc fd mx jg my bn mz na bi"><span id="987f" class="nb kb hi jg b be nc nd l ne nf">public PTransform&lt;PCollection&lt;Failure&gt;, ? extends POutput&gt; write() {<br/>    return BigQueryIO.&lt;Failure&gt;write()<br/>            .withMethod(BigQueryIO.Write.Method.FILE_LOADS)<br/>            .to(failureConf.getOutputDataset() + "." + failureConf.getOutputTable())<br/>            .withFormatFunction(failure -&gt; toFailureTableRow(failureConf, failure))<br/>            .withCreateDisposition(BigQueryIO.Write.CreateDisposition.CREATE_NEVER)<br/>            .withWriteDisposition(BigQueryIO.Write.WriteDisposition.WRITE_APPEND);<br/>}<br/><br/>private static TableRow toFailureTableRow(FailureConf failureConf, Failure failure) {<br/>    val creationDate = Instant.now().toString();<br/><br/>    return new TableRow()<br/>            .set(FEATURE_NAME.getValue(), failureConf.getFeatureName())<br/>            .set(PIPELINE_STEP.getValue(), failure.getPipelineStep())<br/>            .set(JOB_NAME.getValue(), failureConf.getJobName())<br/>            .set(INPUT_ELEMENT.getValue(), failure.getInputElement())<br/>            .set(EXCEPTION_TYPE.getValue(), failure.getException().getClass().getSimpleName())<br/>            .set(STACK_TRACE.getValue(), ExceptionUtils.getStackTrace(failure.getException()))<br/>            .set(COMPONENT_TYPE.getValue(), COMPONENT_TYPE_VALUE)<br/>            .set(DWH_CREATION_DATE.getValue(), creationDate);<br/>}</span></pre><p id="2b50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">链接到Github库:</strong></p><div class="jh ji ez fb jj jk"><a href="https://github.com/tosun-si/teams-league-java-dlq-asgarde-beam-summit/blob/main/src/main/java/fr/groupbees/infrastructure/io/bigquery/FailureBigqueryIOAdapter.java" rel="noopener  ugc nofollow" target="_blank"><div class="jl ab dw"><div class="jm ab jn cl cj jo"><h2 class="bd hj fi z dy jp ea eb jq ed ef hh bi translated">teams-league-Java-dlq-as garde-beam-summit/failurebigqueryioadapter . Java at main…</h2><div class="jr l"><h3 class="bd b fi z dy jp ea eb jq ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="js l"><p class="bd b fp z dy jp ea eb jq ed ef dx translated">github.com</p></div></div><div class="jt l"><div class="nm l jv jw jx jt jy jz jk"/></div></div></a></div><h2 id="9b00" class="mj kb hi bd kc mk ml mm kg mn mo mp kk iq mq mr ko iu ms mt ks iy mu mv kw mw bi translated"><strong class="ak">4.2 Beam Java中云日志IO代码</strong></h2><pre class="lz ma mb mc fd mx jg my bn mz na bi"><span id="df29" class="nb kb hi jg b be nc nd l ne nf">public PDone expand(PCollection&lt;Failure&gt; input) {<br/>    input.apply(STEP_MAP_FAILURE_JSON_STRING, new LogTransform());<br/>    return PDone.in(input.getPipeline());<br/>}<br/><br/>static class LogTransform extends PTransform&lt;PCollection&lt;Failure&gt;, PCollection&lt;String&gt;&gt; {<br/>    public PCollection&lt;String&gt; expand(PCollection&lt;Failure&gt; input) {<br/>        return input<br/>                .apply(STEP_MAP_FAILURE_JSON_STRING, MapElements<br/>                        .into(strings())<br/>                        .via(FailureCloudLoggingWriteTransform::toFailureLogInfo))<br/>                .apply(STEP_LOG_FAILURE, MapElements.into(strings()).via(this::logFailure));<br/>    }<br/><br/>    private String logFailure(String failureAsString) {<br/>        LOGGER.error(failureAsString);<br/>        return failureAsString;<br/>    }<br/>}<br/><br/>private static String toFailureLogInfo(Failure failure) {<br/>    val inputElementInfo = "InputElement : " + failure.getInputElement();<br/>    val stackTraceInfo = "StackTrace : " + ExceptionUtils.getStackTrace(failure.getException());<br/><br/>    return inputElementInfo + "\n" + stackTraceInfo;<br/>}</span></pre><p id="fa36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">Github资源库的链接:</strong></p><div class="jh ji ez fb jj jk"><a href="https://github.com/tosun-si/teams-league-java-dlq-asgarde-beam-summit/blob/main/src/main/java/fr/groupbees/infrastructure/io/cloudlogging/FailureCloudLoggingWriteTransform.java" rel="noopener  ugc nofollow" target="_blank"><div class="jl ab dw"><div class="jm ab jn cl cj jo"><h2 class="bd hj fi z dy jp ea eb jq ed ef hh bi translated">teams-league-Java-dlq-as garde-beam-summit/failurecloudloggingwrite transform . Java at main…</h2><div class="jr l"><h3 class="bd b fi z dy jp ea eb jq ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="js l"><p class="bd b fp z dy jp ea eb jq ed ef dx translated">github.com</p></div></div><div class="jt l"><div class="nn l jv jw jx jt jy jz jk"/></div></div></a></div><h2 id="2d48" class="mj kb hi bd kc mk ml mm kg mn mo mp kk iq mq mr ko iu ms mt ks iy mu mv kw mw bi translated">4.3 Beam Python中<strong class="ak"> BigQuery IO </strong>的代码</h2><pre class="lz ma mb mc fd mx jg my bn mz na bi"><span id="b710" class="nb kb hi jg b be nc nd l ne nf">def expand(self, inputs_failures: PCollection[Failure]):<br/>    return (inputs_failures<br/>            | 'Map to failure table fields' &gt;&gt; beam.Map(self.to_failure_table_fields)<br/>            | "Sink failures to Bigquery" &gt;&gt; beam.io.WriteToBigQuery(<br/>                project=self.pipeline_conf.project_id,<br/>                dataset=self.pipeline_conf.failure_output_dataset,<br/>                table=self.pipeline_conf.failure_output_table,<br/>                create_disposition=beam.io.BigQueryDisposition.CREATE_NEVER,<br/>                write_disposition=beam.io.BigQueryDisposition.WRITE_APPEND)<br/>            )<br/><br/>def to_failure_table_fields(self, failure: Failure):<br/>    return {<br/>        FailureTableFields.FEATURE_NAME.value: self.pipeline_conf.failure_feature_name,<br/>        FailureTableFields.JOB_NAME.value: self.pipeline_conf.job_type,<br/>        FailureTableFields.PIPELINE_STEP.value: failure.pipeline_step,<br/>        FailureTableFields.INPUT_ELEMENT.value: failure.input_element,<br/>        FailureTableFields.EXCEPTION_TYPE.value: type(failure.exception).__name__,<br/>        FailureTableFields.STACK_TRACE.value: get_failure_error(failure),<br/>        FailureTableFields.COMPONENT_TYPE.value: 'DATAFLOW',<br/>        FailureTableFields.DWH_CREATION_DATE.value: datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S")<br/>    }</span></pre><p id="96df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">Github资源库的链接:</strong></p><div class="jh ji ez fb jj jk"><a href="https://github.com/tosun-si/teams-league-python-dlq-asgarde-beam-summit/blob/main/team_league/infrastructure/io/bigquery/failure_bigquery_write_transform.py" rel="noopener  ugc nofollow" target="_blank"><div class="jl ab dw"><div class="jm ab jn cl cj jo"><h2 class="bd hj fi z dy jp ea eb jq ed ef hh bi translated">teams-league-python-dlq-as garde-beam-summit/failure _ big query _ write _ transform . py at main…</h2><div class="jr l"><h3 class="bd b fi z dy jp ea eb jq ed ef dx translated">通过在GitHub上创建一个帐户，为tosun-si/teams-league-python-dlq-as garde-beam-summit开发做出贡献。</h3></div><div class="js l"><p class="bd b fp z dy jp ea eb jq ed ef dx translated">github.com</p></div></div><div class="jt l"><div class="no l jv jw jx jt jy jz jk"/></div></div></a></div><h2 id="792e" class="mj kb hi bd kc mk ml mm kg mn mo mp kk iq mq mr ko iu ms mt ks iy mu mv kw mw bi translated">4.4 Beam Python中<strong class="ak">云日志IO </strong>的代码</h2><pre class="lz ma mb mc fd mx jg my bn mz na bi"><span id="18cf" class="nb kb hi jg b be nc nd l ne nf">def expand(self, inputs_failures: PCollection[Failure]):<br/>    return (inputs_failures<br/>            | 'Map to failure log info' &gt;&gt; beam.Map(self.to_failure_log_info)<br/>            | "Logs Failure to cloud logging" &gt;&gt; beam.Map(self.log_failure))<br/><br/>def to_failure_log_info(self, failure: Failure):<br/>    input_element_info = f'InputElement : {failure.input_element}'<br/>    stack_trace_info = f'StackTrace : {get_failure_error(failure)}'<br/><br/>    return f'{input_element_info} \n {stack_trace_info}'<br/><br/>def log_failure(self, failure_log_info: str):<br/>    logging.error(failure_log_info)<br/><br/>    return failure_log_info</span></pre><p id="4ec9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">Github资源库的链接:</strong></p><div class="jh ji ez fb jj jk"><a href="https://github.com/tosun-si/teams-league-python-dlq-asgarde-beam-summit/blob/main/team_league/infrastructure/io/cloud_logging/failure_cloud_logging_write_transform.py" rel="noopener  ugc nofollow" target="_blank"><div class="jl ab dw"><div class="jm ab jn cl cj jo"><h2 class="bd hj fi z dy jp ea eb jq ed ef hh bi translated">teams-league-python-dlq-as garde-beam-summit/failure _ cloud _ logging _ write _ transform . py at main…</h2><div class="jr l"><h3 class="bd b fi z dy jp ea eb jq ed ef dx translated">通过在GitHub上创建一个帐户，为tosun-si/teams-league-python-dlq-as garde-beam-summit开发做出贡献。</h3></div><div class="js l"><p class="bd b fp z dy jp ea eb jq ed ef dx translated">github.com</p></div></div><div class="jt l"><div class="np l jv jw jx jt jy jz jk"/></div></div></a></div><h1 id="47b9" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">5.在Google Cloud中创建关于波束故障的警报策略</h1><p id="0640" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">在<code class="du jd je jf jg b">Cloud Logging</code>中写入失败后，我们想要实时发送电子邮件警报，以下是<code class="du jd je jf jg b">Google Cloud</code>中实现这一需求的步骤:</p><ul class=""><li id="0d25" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated">创建一个<code class="du jd je jf jg b">log based metric</code>来过滤由<code class="du jd je jf jg b">Dataflow</code>任务写入的失败<code class="du jd je jf jg b">pattern</code></li><li id="c4f8" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">创建一个<code class="du jd je jf jg b">notification channel</code>，本例中选择了电子邮件</li><li id="690a" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">基于之前创建的<code class="du jd je jf jg b">log based metric</code>和<code class="du jd je jf jg b">notification channel</code>创建一个<code class="du jd je jf jg b">alerting policy</code></li></ul><h2 id="cdfd" class="mj kb hi bd kc mk ml mm kg mn mo mp kk iq mq mr ko iu ms mt ks iy mu mv kw mw bi translated">5.1创建基于日志的指标</h2><p id="cd6b" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">我们将首先创建一个关于<code class="du jd je jf jg b">Dataflow</code>工作失误的<code class="du jd je jf jg b">log based metric</code>。</p><p id="7a9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">关于</strong> <code class="du jd je jf jg b"><strong class="ih hj">Cloud Logging</strong></code>日志格式的一些说明</p><p id="9b50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">Cloud Logging</code>中的条目由<code class="du jd je jf jg b">LogEntry</code>格式和对象表示:</p><div class="jh ji ez fb jj jk"><a href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry" rel="noopener  ugc nofollow" target="_blank"><div class="jl ab dw"><div class="jm ab jn cl cj jo"><h2 class="bd hj fi z dy jp ea eb jq ed ef hh bi translated">日志条目|云日志|谷歌云</h2><div class="jr l"><h3 class="bd b fi z dy jp ea eb jq ed ef dx translated">无论您的企业正处于数字化转型的早期阶段，谷歌云都可以帮助您解决…</h3></div><div class="js l"><p class="bd b fp z dy jp ea eb jq ed ef dx translated">cloud.google.com</p></div></div><div class="jt l"><div class="nq l jv jw jx jt jy jz jk"/></div></div></a></div><p id="880f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里您可以看到<code class="du jd je jf jg b">LogEntry</code>对象的<code class="du jd je jf jg b">json</code>表示:</p><pre class="lz ma mb mc fd mx jg my bn mz na bi"><span id="3b1e" class="nb kb hi jg b be nc nd l ne nf">{<br/>  "logName": string,<br/>  "resource": {<br/>    object (MonitoredResource)<br/>  },<br/>  "timestamp": string,<br/>  "receiveTimestamp": string,<br/>  "severity": enum (LogSeverity),<br/>  "insertId": string,<br/>  "httpRequest": {<br/>    object (HttpRequest)<br/>  },<br/>  "labels": {<br/>    string: string,<br/>    ...<br/>  },<br/>  "metadata": {<br/>    object (MonitoredResourceMetadata)<br/>  },<br/>  "operation": {<br/>    object (LogEntryOperation)<br/>  },<br/>  "trace": string,<br/>  "spanId": string,<br/>  "traceSampled": boolean,<br/>  "sourceLocation": {<br/>    object (LogEntrySourceLocation)<br/>  },<br/>  "split": {<br/>    object (LogSplit)<br/>  },<br/>  // Union field payload can be only one of the following:<br/>  "protoPayload": {<br/>    "@type": string,<br/>    field1: ...,<br/>    ...<br/>  },<br/>  "textPayload": string,<br/>  "jsonPayload": {<br/>    object<br/>  }<br/>  // End of list of possible types for union field payload.<br/>}</span></pre><p id="14c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以在<code class="du jd je jf jg b">LogEntry</code>字段上添加过滤器。</p><p id="0c25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建</strong>T12】</p><p id="b163" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du jd je jf jg b">Google Cloud Console</code>中，我们进入<code class="du jd je jf jg b">log-based metric</code>菜单，首先填写<code class="du jd je jf jg b">metric type</code> <code class="du jd je jf jg b">metric name</code>和<code class="du jd je jf jg b">description</code>:</p><figure class="lz ma mb mc fd md er es paragraph-image"><div class="er es nr"><img src="../Images/128dfacf6c20240a9cc911e62ddf5535.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/1*V8rFrqqZg-lW3fY-uz0Enw.png"/></div></figure><p id="6d0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">公制类型</strong></p><p id="dbb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们选择带有<code class="du jd je jf jg b">counter</code>的<code class="du jd je jf jg b">metric type</code>是因为每次<code class="du jd je jf jg b">Dataflow</code>作业以特定模式在日志中写入错误时，我们都希望增加这个度量。</p><p id="b4cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个例子中的<code class="du jd je jf jg b">metric name</code>是<code class="du jd je jf jg b">dataflow_jobs_intercepted_errors</code></p><p id="0db5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">过滤器</strong></p><p id="1056" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们填充<code class="du jd je jf jg b">filter</code>和<code class="du jd je jf jg b">label</code>:</p><figure class="lz ma mb mc fd md er es paragraph-image"><div class="er es ns"><img src="../Images/a6ca47a25c03dfeaaf953f8c6291bb59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/1*jh5dWbjuiYkB-7jIPV5-SA.png"/></div></figure><p id="28a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">filter</code>中使用的格式是<code class="du jd je jf jg b">Cloud Logging</code>和<code class="du jd je jf jg b">Google Cloud</code>中<code class="du jd je jf jg b">logger explorer</code>通常使用的格式</p><p id="b015" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">resource.type=dataflow_step</code>允许仅针对<code class="du jd je jf jg b">Dataflow</code>工作和服务。</p><p id="23b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">severity=ERROR</code>指定过滤器只关注日志中的错误。</p><p id="6ba4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的<code class="du jd je jf jg b">Dataflow</code>作业使用带有<code class="du jd je jf jg b">InputElement</code>和<code class="du jd je jf jg b">StackTrace</code>关键字的特定模式在<code class="du jd je jf jg b">Cloud Logging</code>中写入错误，这就是过滤器添加基于<code class="du jd je jf jg b">jsonPayload.message</code>的标准的原因</p><p id="d6bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">jsonPayload.message =~ InputElement.*</code></p><ul class=""><li id="165b" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated"><code class="du jd je jf jg b">=~</code>的意思是<code class="du jd je jf jg b">contains</code></li><li id="859e" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated"><code class="du jd je jf jg b">.*</code>的意思是<code class="du jd je jf jg b">any character</code></li><li id="514b" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">该标准允许搜索包含<code class="du jd je jf jg b">InputElement</code>的模式</li></ul><p id="04e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">标签</strong></p><p id="47bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">标签允许基于日志的指标包含多个时间序列。</p><p id="ec2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，我们添加了以下标签<code class="du jd je jf jg b">resource.label.job_id</code>，因为我们希望根据<code class="du jd je jf jg b">Dataflow job</code>对日志应用过滤器，而不是对所有作业一起应用过滤器。</p><h2 id="05cf" class="mj kb hi bd kc mk ml mm kg mn mo mp kk iq mq mr ko iu ms mt ks iy mu mv kw mw bi translated">5.2创建通知渠道</h2><p id="d9d6" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">在菜单<strong class="ih hj"><em class="lu"/></strong>中，我们<strong class="ih hj"> <em class="lu"> </em> </strong>创建<strong class="ih hj"> <em class="lu"> </em> </strong>一个邮件通道</p><figure class="lz ma mb mc fd md er es paragraph-image"><div class="er es nt"><img src="../Images/2418e3df2fd8516e79d249aa34a534cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:868/format:webp/1*Eh00NMunbVtkDbFO4QVZlA.png"/></div></figure><h2 id="1132" class="mj kb hi bd kc mk ml mm kg mn mo mp kk iq mq mr ko iu ms mt ks iy mu mv kw mw bi translated">5.3根据基于日志的指标创建警报策略</h2><p id="3e38" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">在本节中，我们将基于之前创建的<code class="du jd je jf jg b">log based metric</code>创建<code class="du jd je jf jg b">alerting policy</code>。</p><p id="200d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先在<strong class="ih hj"> <em class="lu">新条件</em> </strong>菜单中，我们在指标搜索字段中填入<code class="du jd je jf jg b">Dataflow</code>，然后选择<code class="du jd je jf jg b">log based metrics</code>和之前创建的指标<code class="du jd je jf jg b">dataflow_intercepted_errors</code></p><figure class="lz ma mb mc fd md er es paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="er es nu"><img src="../Images/0a348941e62fc8ca46df4a5121635bfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uaCZMj7lJjRMlxSFPYCe7w.png"/></div></div></figure><p id="c8c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<strong class="ih hj"> <em class="lu">配置触发</em> </strong>菜单中，我们选择<strong class="ih hj">阈值</strong>作为条件类型，<strong class="ih hj">阈值</strong>为0.9</p><p id="e314" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">意思是，如果每个<code class="du jd je jf jg b">Dataflow</code>任务有一个错误，将触发一个警报(1大于0.9)</p><figure class="lz ma mb mc fd md er es paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="er es nv"><img src="../Images/d8683cc646c15fb44708eb0eb2e8d86d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*azZy2q1sFWyp9bSOkFwBqA.png"/></div></div></figure><p id="8905" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后一个要配置的菜单是<strong class="ih hj"> <em class="lu">警报详细信息</em> </strong>，我们设置之前创建的通知通道，即电子邮件地址。</p><p id="24f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于每个警报，将向指定的地址发送一封电子邮件。</p><p id="a75d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">值得注意的是，我们可以指定多个通知渠道(几封邮件、Slack……)。</p><h1 id="32dd" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">6.警报电子邮件示例</h1><p id="640b" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">这里你可以看到一封示例邮件。</p><figure class="lz ma mb mc fd md er es paragraph-image"><div class="er es nw"><img src="../Images/e161d9e4795584927c12582310201255.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*oYgpSqgZMx1aKwbejfxUAw.png"/></div></figure><p id="2608" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">邮件中提出了2个链接:</p><ul class=""><li id="4f90" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated"><strong class="ih hj">查看事件</strong>提出链接<code class="du jd je jf jg b">Google Cloud</code>中的当前事件</li><li id="d92d" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated"><strong class="ih hj">查看日志</strong>建议<strong class="ih hj"> </strong>链接到<code class="du jd je jf jg b">Cloud Logging</code>中的错误日志</li></ul><p id="de2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jd je jf jg b">Cloud Logging</code>中<code class="du jd je jf jg b">Dataflow</code>作业的错误日志示例:</p><figure class="lz ma mb mc fd md er es paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="er es nx"><img src="../Images/262a8fadde007b3d4560b13dd2c9a751.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EfPrLJNONNGtgUyQ01Zqpg.png"/></div></div></figure><p id="daee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以看到:</p><ul class=""><li id="f752" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated">云日志记录浏览器页面</li><li id="573b" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated"><strong class="ih hj">中的过滤器查询</strong>菜单</li><li id="087e" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">在左侧，日志字段:<strong class="ih hj">资源类型、严重性、作业名称、区域</strong> …</li><li id="66a3" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated"><strong class="ih hj">查询结果</strong>包含错误日志，它对应于<strong class="ih hj">输入元素</strong>和<strong class="ih hj">堆栈轨迹</strong>，这是光束/数据流作业指定的模式</li></ul><h1 id="a298" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">7.在Datastudio仪表板中显示故障</h1><p id="cdc6" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">在本节中，我们将创建一个负责显示故障的<code class="du jd je jf jg b">Datastudio</code>仪表板。</p><figure class="lz ma mb mc fd md er es paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="er es ny"><img src="../Images/81aec4de4fd6c404e58a9ce01acc5bd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ekL3wxfi42-uzmRNLNWGtQ.png"/></div></div></figure><p id="58e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该仪表板建议使用以下过滤器:</p><ul class=""><li id="d9f8" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated"><code class="du jd je jf jg b">date</code>范围在<code class="du jd je jf jg b">dwhCreationDate</code>上</li><li id="c629" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated"><code class="du jd je jf jg b">featureName</code>字段上的下拉列表</li><li id="8b7f" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated"><code class="du jd je jf jg b">jobName</code>字段上的下拉列表</li><li id="1a3c" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated"><code class="du jd je jf jg b">InputElement</code>上的高级过滤器(等于，包含..)</li><li id="4d12" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated"><code class="du jd je jf jg b">StackTrace</code>上的高级过滤器</li></ul><p id="df45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">页面的其余部分包含:</p><ul class=""><li id="6b33" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated">结果表中的数据失败</li><li id="c882" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">根据<code class="du jd je jf jg b">exceptionType</code>以百分比表示的饼图</li><li id="5826" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">根据<code class="du jd je jf jg b">jobName</code>以百分比表示的饼图</li><li id="2cf2" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">根据<code class="du jd je jf jg b">dwhCreationDate</code>和<code class="du jd je jf jg b">jobName</code>记录计数的条形图</li></ul><p id="1803" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将在另一篇文章中对这个仪表板进行深入的解释。</p><p id="3995" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">我分享了对本文中使用的一些组件有帮助的资源:</strong></p><p id="1302" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lu"> Asgarde Java : </em></p><div class="jh ji ez fb jj jk"><a href="https://github.com/tosun-si/asgarde" rel="noopener  ugc nofollow" target="_blank"><div class="jl ab dw"><div class="jm ab jn cl cj jo"><h2 class="bd hj fi z dy jp ea eb jq ed ef hh bi translated">GitHub-tosun-si/as garde:as garde允许用Apache Beam Java简化错误处理，用…</h2><div class="jr l"><h3 class="bd b fi z dy jp ea eb jq ed ef dx translated">这个模块允许用Apache Beam Java简化错误处理。该项目托管在Maven存储库上。你可以…</h3></div><div class="js l"><p class="bd b fp z dy jp ea eb jq ed ef dx translated">github.com</p></div></div><div class="jt l"><div class="nz l jv jw jx jt jy jz jk"/></div></div></a></div><p id="e814" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lu"> Asgarde Python : </em></p><div class="jh ji ez fb jj jk"><a href="https://github.com/tosun-si/pasgarde" rel="noopener  ugc nofollow" target="_blank"><div class="jl ab dw"><div class="jm ab jn cl cj jo"><h2 class="bd hj fi z dy jp ea eb jq ed ef hh bi translated">GitHub-tosun-si/pas garde:as garde允许用Apache Beam Python简化错误处理，用…</h2><div class="jr l"><h3 class="bd b fi z dy jp ea eb jq ed ef dx translated">该模块允许使用Apache Beam Python简化错误处理。该项目托管在PyPi存储库上。你…</h3></div><div class="js l"><p class="bd b fp z dy jp ea eb jq ed ef dx translated">github.com</p></div></div><div class="jt l"><div class="oa l jv jw jx jt jy jz jk"/></div></div></a></div><p id="789c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lu">在Asgarde上的Beam Sumit对话:</em></p><figure class="lz ma mb mc fd md"><div class="bz dy l di"><div class="ob oc l"/></div></figure><p id="fcce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你喜欢这个项目，请用明星✩来支持我们</p><blockquote class="lr ls lt"><p id="f682" class="if ig lu ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated">如果你喜欢我的文章，想看我的帖子，请关注我:</p><p id="3059" class="if ig lu ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated">- <a class="ae od" rel="noopener" href="/@mazlum.tosun">中</a> <br/> - <a class="ae od" href="https://twitter.com/MazlumTosun3" rel="noopener ugc nofollow" target="_blank">推特</a> <br/> - <a class="ae od" href="https://www.linkedin.com/in/mazlum-tosun-900b1812" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a></p></blockquote></div></div>    
</body>
</html>