# 只需一个命令，就可以轻松地将新版本的代码部署到 GCP 的 Kubernetes 上。

> 原文：<https://medium.com/google-cloud/easily-deploy-new-versions-of-code-to-kubernetes-on-gcp-with-a-single-command-ff920a367cf1?source=collection_archive---------0----------------------->

本文将介绍如何创建一个基本的工作流程，让您可以使用一个命令来推送应用程序的新版本。

我把它称为穷人在 GCP(谷歌云平台)上为 Kubernetes 编写的持续集成脚本。

配置完成后，您只需输入以下命令即可更新您的应用程序(node.js):

```
yarn gcp
```

**部署流程概述:**

1.  您的应用程序在 Kubernetes 上作为服务运行
2.  您在开发机器上更新本地 repo 中的代码
3.  您将这些更改提交给 git，并推送到 Github 上的主分支
4.  GCP 将看到提交并更新 GCP 源存储库中的镜像回购。
5.  GCP 构建触发器将看到更新的主 repo 并构建 docker 容器。
6.  除非你要求，否则 GCP 不会用新的 docker 版本更新 kubernetes 服务。
7.  您在开发机器上输入`yarn gcp`,这个脚本将监控构建触发器，并自动用新的构建更新 kubernetes 上的服务。

**本文假设如下:**

1.  您的应用程序代码已下载到您的机器上，并且您已安装了 kubectl/gcloud cli。您的 PROJECT_ID 在 gcloud 中设置正确。
2.  您的应用程序是一个 git repo，可以在 Github 上获得，并且正确设置了远程 url，您可以提交和推送对主分支的更改。您可以根据需要对 Bitbucket 等进行调整。
3.  您已经成功地在 kubernetes 中将应用程序作为服务运行。
4.  如果您还没有将 Github repo 链接到 GCP 的容器注册中心构建触发器，那么您可以接受。
5.  我们将部署 Node.js 应用程序，但您可以根据需要对任何基于 Docker 的应用程序进行调整。

这是我们将要使用的完整的构建脚本。将其复制到项目根目录下的文件`deploy.sh`中。这个文件中没有任何秘密，所以你可以把它提交给 source。

1.  保存上述文件后，编辑`package.json`，添加以下脚本:

```
# package.json{
  scripts: {
    "gcp": "./deploy.sh"
  }
}
```

2.如果以后不能运行的话，你需要让`deploy.sh`脚本在你的开发机器上可执行。

```
$ chmod +x deploy.sh
```

3.在谷歌云控制台上，访问容器注册表->构建触发器。为应用的回购设置构建触发器。假设使用 Github，您将需要使用 GCP 上的向导来验证和添加您的 repo。

4.对于触发器设置，请提供任意名称。您只需要设置分支名称。如果这是你唯一想要的分支，你可以输入 master。对于图像名称，保留默认值或使用以下名称:

```
gcr.io/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA
```

5.对于构建触发器来说，这就差不多了，定制您可能需要的任何其他设置。

6.在您的开发机器上，根据需要定制 deploy.sh 文件。阅读行内注释了解更多信息。

*   根据您的应用程序设置名称、徽标和 URL。
*   确保您的 PROJECT_ID 已在 gcloud cli 中设置

**测试完毕**

现在我们可以更新源代码并验证构建触发器正在工作。

1.  在您的开发机器上对本地源代码进行任何更改。
2.  提交更改并推送到您的远程源(推送到 github 等)。
3.  登录谷歌云控制台，进入容器注册->构建历史。
4.  您应该会看到一个新的构建被触发并运行。检查细节并确认容器名称看起来不错。
5.  在您的开发机器上，键入`yarn gcp`。您将看到 deploy.sh 脚本开始运行并检查远程构建状态。根据构建需要的时间，脚本将每 45 秒检查一次。
6.  一旦检测到构建成功完成，它将使用新的 docker 映像更新 Kubernetes 服务。
7.  您可以运行`kubectl get pods`来监控更新。
8.  就是这样，检查公共网址，看看你的新版本是否运行。

**成交记录**

基本上，任何时候你需要在 Kubernetes 上更新你的应用程序，把一些代码推送到 Github，然后运行`yarn gcp`，等几分钟。你的应用应该会自动更新。

您可以修改`deploy.sh`来更频繁地检查，或者以更短的时间间隔等，这取决于您的构建过程通常需要多长时间。目前它检查 9 次，超时前每 45 秒检查一次。

你也可以使用不同于“GCP”`yarn gcp`等的脚本名。相应更新`package.json`中的名称即可。