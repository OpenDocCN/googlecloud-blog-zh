<html>
<head>
<title>Easily generate Google signed id-token with token-generator</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用令牌生成器轻松生成Google签名的id令牌</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/easily-generate-google-signed-id-token-with-token-generator-d25b7e235f2e?source=collection_archive---------1-----------------------#2020-04-03">https://medium.com/google-cloud/easily-generate-google-signed-id-token-with-token-generator-d25b7e235f2e?source=collection_archive---------1-----------------------#2020-04-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/86cd772e827a2887b349c6a10c86cfba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mojA9AFdMgotcIEkPvi4tA.png"/></div></div></figure><p id="20d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">安全性对云提供商来说是一个巨大的挑战，谷歌云平台选择了<strong class="is hj">用OAuth2协议</strong>来保护其所有服务。安全令牌在API调用的头中传递，用于标识用户。授权基于角色，并在IAM中进行检查。</p><p id="9582" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个令牌可以<strong class="is hj">标识一个用户账户，也可以标识一个服务账户</strong>。在机器对机器的调用中，使用的就是这种类型的身份验证。</p><h1 id="a5f7" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">使用gcloud命令生成Id令牌</h1><p id="1667" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">当您尝试访问服务时，如私有云运行或私有云功能，需要一个<strong class="is hj">签名的id令牌</strong>。使用您的<strong class="is hj">用户帐户</strong>，可以使用gcloud SDK轻松生成该令牌</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="3537" class="la jp hi kw b fi lb lc l ld le"># Authenticate with your service account<br/>gcloud auth login </span><span id="f592" class="la jp hi kw b fi lf lc l ld le"># Generate an id token<br/>gcloud auth print-identity-token</span></pre><p id="e93c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者用<strong class="is hj">服务账号密钥文件</strong>T0】</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="2dd5" class="la jp hi kw b fi lb lc l ld le"># Load the service account identity<br/>gcloud auth activate-service-account --key-file=key.json</span><span id="df15" class="la jp hi kw b fi lf lc l ld le"># Generate an id token<br/>gcloud auth print-identity-token</span></pre><p id="6ccb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一个特殊的技巧，<strong class="is hj">你可以模拟一个服务帐户</strong>并像这样使用它</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="3699" class="la jp hi kw b fi lb lc l ld le"># Generate an id token<br/>gcloud auth print-identity-token \<br/>--impersonate-service-account=SA@PROJECT_ID.iam.gserviceaccount.com</span></pre><p id="339b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lj">将</em> <code class="du lg lh li kw b"><em class="lj">SA</em></code> <em class="lj">替换为服务帐户名，将</em> <code class="du lg lh li kw b"><em class="lj">PROJECT_ID</em></code> <em class="lj">替换为您的项目ID </em></p><h1 id="28a8" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">在Google Cloud环境下生成一个Id令牌</h1><p id="f485" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在GCP上，<strong class="is hj">每个组件都有自己的身份</strong>，这意味着一个服务帐户会自动附加到组件上。<strong class="is hj">该服务帐户可定制，以实现更好的权利分离</strong>，并在每个组件上应用<strong class="is hj">最小特权原则</strong>。</p><p id="0c3c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果没有指定服务帐户，则使用默认服务帐户，通常使用以下模式计算默认服务帐户:<br/> <code class="du lg lh li kw b">&lt;PROJECT_NUMBER&gt;-compute@developer.gserviceaccount.com</code></p><p id="a63a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，<strong class="is hj">您不需要为使用特定的服务帐户生成服务帐户密钥</strong> <strong class="is hj">文件</strong>。您可以通过<a class="ae lk" href="https://cloud.google.com/compute/docs/storing-retrieving-metadata" rel="noopener ugc nofollow" target="_blank">元数据服务器</a>直接使用<strong class="is hj">组件标识</strong>。这里以<a class="ae lk" href="https://cloud.google.com/run/docs/authenticating/service-to-service#go" rel="noopener ugc nofollow" target="_blank">云运行</a>为例</p></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><p id="a24a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="lj">注意</em> </strong> <em class="lj">:当你在GCP环境下，我强烈建议</em> <strong class="is hj"> <em class="lj">千万不要</em> </strong> <em class="lj">使用服务账号密钥文件。他们是</em></p><ul class=""><li id="49ae" class="ls lt hi is b it iu ix iy jb lu jf lv jj lw jn lx ly lz ma bi translated"><em class="lj">无用感谢组件标识</em></li><li id="9960" class="ls lt hi is b it mb ix mc jb md jf me jj mf jn lx ly lz ma bi translated"><em class="lj">难以保全(或者存放在</em> <a class="ae lk" href="https://cloud.google.com/secret-manager/docs" rel="noopener ugc nofollow" target="_blank"> <em class="lj">秘密总管</em> </a> <em class="lj"> ) </em></li><li id="24f0" class="ls lt hi is b it mb ix mc jb md jf me jj mf jn lx ly lz ma bi translated"><em class="lj">难以追踪</em></li><li id="164c" class="ls lt hi is b it mb ix mc jb md jf me jj mf jn lx ly lz ma bi translated"><em class="lj">难以定期轮换(建议每90天一次)</em></li></ul><h1 id="b7a6" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">从GCP境外生成Id令牌</h1><p id="139a" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">然而，当你不在GCP上，你想用一个自动平台生成一个id_token(我的意思是没有用户账号)，<strong class="is hj">你必须有一个服务账号密钥文件</strong>。</p><p id="c9fd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这在几种情况下发生:</p><ul class=""><li id="0bf6" class="ls lt hi is b it iu ix iy jb lu jf lv jj lw jn lx ly lz ma bi translated">您必须在CI/CD平台中与GCP服务进行交互</li><li id="bfcd" class="ls lt hi is b it mb ix mc jb md jf me jj mf jn lx ly lz ma bi translated">您有一个托管在GCP之外的应用程序(本地或其他云提供商)</li><li id="835e" class="ls lt hi is b it mb ix mc jb md jf me jj mf jn lx ly lz ma bi translated">开发人员没有一个谷歌帐户，你可以在IAM授权</li></ul></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><p id="37b2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当<strong class="is hj">开发者不熟悉GCP或者如果他们使用旧的框架</strong>时，很难生成id令牌。我最近处理了两个用例:</p><ul class=""><li id="d6ef" class="ls lt hi is b it iu ix iy jb lu jf lv jj lw jn lx ly lz ma bi translated">开发人员希望使用Postman来测试云运行私有API。不安装gcloud。他们很难为他们的测试建立一个简单的过程</li><li id="34dc" class="ls lt hi is b it mb ix mc jb md jf me jj mf jn lx ly lz ma bi translated">。Net 4.0框架，并且缺少一些构建JWT令牌的方法，它们必须手动实现。</li></ul><p id="bff4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lj">最后一种情况可能出现在任何旧的语言和/或框架中。</em> <strong class="is hj"> <em class="lj">在应用程序现代化方面，这可能是一个挑战和阻碍</em> </strong> <em class="lj">。</em></p><h1 id="9e48" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">用于生成id令牌的令牌生成器</h1><p id="8c57" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">为了帮助开发人员并防止任何项目延迟，我实现了一个小工具，<a class="ae lk" href="https://github.com/guillaumeblaquiere/token-generator" rel="noopener ugc nofollow" target="_blank"> token-generator </a>，它基于参数中提供的服务帐户密钥文件生成id_token。</p><p id="327d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个工具公开了一个可以在本地主机上访问的网络服务器。想法是<strong class="is hj">简单地在这个服务器上执行一个</strong> <code class="du lg lh li kw b"><strong class="is hj">GET</strong></code> <strong class="is hj">查询来获得一个有效的令牌ID </strong>。</p><ul class=""><li id="3a75" class="ls lt hi is b it iu ix iy jb lu jf lv jj lw jn lx ly lz ma bi translated">开发人员在他们的本地环境中启动token-generator，简单地在localhost上执行get，并将授权头中的结果用作承载令牌。</li><li id="cd68" class="ls lt hi is b it mb ix mc jb md jf me jj mf jn lx ly lz ma bi translated">旧的应用程序/框架在服务器的一个空闲端口上启动token-generator作为辅助程序，并在localhost中执行一个简单的GET来获取令牌并在后续查询中使用它</li></ul><h1 id="d2ca" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">在任何地方使用令牌生成器…</h1><p id="78aa" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated"><strong class="is hj">我</strong> <a class="ae lk" href="https://github.com/guillaumeblaquiere/token-generator" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">在GitHub </strong></a>上开源了这个小而有用的工具。它是用Go编写，可以在几个平台上编译(现在每个版本都自动生成3个)。</p><p id="8505" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为有了Go，<strong class="is hj">流程轻便高效，对性能没有影响</strong>。当您有一个生成id令牌的阻塞点时，您可以随意使用。</p><h1 id="9fec" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">…而且要小心</h1><p id="4194" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">但是这个工具<strong class="is hj">并不能防止滥用服务账户密钥文件</strong>，尤其是像Git这样的配置管理工具中的存储。</p><p id="b65a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另外，<strong class="is hj">你绝对不可以在互联网上公开暴露这项服务。</strong>为本地运行而设计，与其他软件搭配使用。</p><h1 id="153e" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">欢迎反馈</h1><p id="b1fe" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我将很高兴<strong class="is hj">得到反馈，并讨论您的用例</strong>，引导您使用或不使用该工具。你也可以在GitHub 上<a class="ae lk" href="https://github.com/guillaumeblaquiere/token-generator" rel="noopener ugc nofollow" target="_blank">打开问题。</a></p></div></div>    
</body>
</html>