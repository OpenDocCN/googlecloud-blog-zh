# ä»å‡½æ•°ä¸­è°ƒç”¨å·¥ä½œæµï¼

> åŸæ–‡ï¼š<https://medium.com/google-cloud/call-a-workflow-from-a-function-51fc7fc8e1ff?source=collection_archive---------1----------------------->

![](img/31984f6fc53eb69027c3fc4db7ee8121.png)

å·¥ä½œæµ+åŠŸèƒ½

äº‘å·¥ä½œæµå…è®¸æ‚¨ç¼–æ’å’Œè‡ªåŠ¨åŒ– Google äº‘å’ŒåŸºäº HTTP çš„ API æœåŠ¡ã€‚

æ‚¨å¯èƒ½ä¼šé—®ï¼Œå¦‚ä½•å°†è¿™äº›å·¥ä½œæµä¸æ‚¨ç°æœ‰çš„äº‘åŠŸèƒ½ç›¸é›†æˆï¼Ÿâ€”å¾ˆå¥½çš„é—®é¢˜ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œä½ å°†å­¦ä¹ å¦‚ä½•ä»äº‘å‡½æ•°ä¸­è°ƒç”¨å·¥ä½œæµï¼ğŸš€

# éƒ¨ç½²äº‘å·¥ä½œæµ

é¦–å…ˆï¼Œæ‚¨çš„é¡¹ç›®ä¸­éœ€è¦ä¸€ä¸ªå·¥ä½œæµ(å¦‚æœæ‚¨è¿˜æ²¡æœ‰çš„è¯)ã€‚ç”¨ä»¥ä¸‹å†…å®¹åˆ›å»ºä¸€ä¸ªåä¸º`myFirstWorkflow.yaml`çš„æ–°æ–‡ä»¶:

myFirstWorkflow.yaml

é˜…è¯»ä¸Šé¢çš„ YAMLï¼Œå·¥ä½œæµæ‰§è¡Œä»¥ä¸‹æ“ä½œ:

1.  ä»å…¬å…±äº‘åŠŸèƒ½è·å–å½“å‰æ—¥æœŸ/æ—¶é—´ã€‚
2.  ç”¨æŸ¥è¯¢å‚æ•°`dayOfTheWeek`è°ƒç”¨ Wikipedia (opensearch) APIã€‚
3.  ä»ç»´åŸºç™¾ç§‘è¿”å›æœ€çƒ­é—¨çš„ç»“æœã€‚

è®©æˆ‘ä»¬ç”¨`gcloud`éƒ¨ç½²å·¥ä½œæµ:

```
gcloud workflows deploy myFirstWorkflow \
--source=myFirstWorkflow.yaml
```

å¦‚æœæ‚¨æ„¿æ„ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æµ‹è¯•å·¥ä½œæµç¨‹:

```
gcloud workflows run myFirstWorkflow
```

ä½¿ç”¨è¯¥å‘½ä»¤ï¼Œæ‚¨å°†æ‰§è¡Œå·¥ä½œæµå¹¶ç­‰å¾…ç»“æœã€‚
å“åº”å°†åŒ…æ‹¬å¦‚ä¸‹è¯¦ç»†ä¿¡æ¯:

```
result: '["Tuesday","Tuesday Weld","Tuesday Night Music Club","Tuesday (ILoveMakonnen
  song)","Tuesday Group","Tuesdays with Morrie","Tuesday Knight","Tuesday (Burak Yeter
  song)","Tuesday Morning Quarterback","Tuesday Vargas"]'

state: SUCCEEDED
```

ä¸é”™ï¼âœ”ï¸

# åˆ›å»ºäº‘å‡½æ•°

æ‰€ä»¥ç°åœ¨æˆ‘ä»¬ä¸ä»`gcloud`è¿è¡Œå·¥ä½œæµï¼Œè€Œæ˜¯ä»äº‘å‡½æ•°è°ƒç”¨å·¥ä½œæµã€‚æ‚¨å¯ä»¥æƒ³è±¡è¿™å¯¹äºåˆ›å»ºå‘ç¥¨æˆ–è¿è¡Œå›¾åƒå¤„ç†ç®¡é“éå¸¸æœ‰ç”¨ã€‚

äº‘å‡½æ•°ä½¿å¾—è°ƒç”¨å·¥ä½œæµå˜å¾—ç›¸å½“å®¹æ˜“ï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦ç¼–å†™ä»»ä½•æˆæƒä»£ç ã€‚è®©æˆ‘ä»¬ä½¿ç”¨å‡½æ•°æ¡†æ¶åˆ›å»ºä¸€ä¸ªè½»é‡çº§èŠ‚ç‚¹å‡½æ•°ã€‚

## åˆ›å»ºä¸€ä¸ª`package.json`æ–‡ä»¶:

package.json

è¿™ä¸ªæ–‡ä»¶æè¿°äº†æˆ‘ä»¬çš„èŠ‚ç‚¹ç¨‹åºï¼Œå®ƒä½¿ç”¨äº†[åŠŸèƒ½æ¡†æ¶](https://github.com/GoogleCloudPlatform/functions-framework-nodejs)å’Œ[äº‘å·¥ä½œæµ API å®¢æˆ·ç«¯åº“](https://github.com/googleapis/nodejs-workflows)ã€‚

## åˆ›å»ºä¸€ä¸ª`index.js`æ–‡ä»¶:

å¯¹äºæ‚¨çš„å‡½æ•°ï¼Œåˆ›å»ºä»¥ä¸‹`index.js`æ–‡ä»¶:

ç´¢å¼•. js

ä¸‹é¢æ˜¯ä»£ç çš„ç®€è¦è¯´æ˜:

*   `exports.runWorkflow`æ˜¯ä½ çš„äº‘å‡½æ•°ï¼Œä¼ é€’ç»™ä½ çš„ Express `(req, res)`å‚æ•°ã€‚æˆ‘ä»¬æ¥å— POST è¯·æ±‚ï¼Œè°ƒç”¨`callWorkflowsAPI`å‡½æ•°å¹¶è¿”å›ç»“æœã€‚
*   æœ‰ä¸€ä¸ªäº‘å·¥ä½œæµ API å®¢æˆ·ç«¯çš„å°è®¾ç½®
*   `callWorkflowsAPI`å‡½æ•°åˆ›å»ºæˆ‘ä»¬å·¥ä½œæµçš„æ‰§è¡Œï¼Œç„¶åä½¿ç”¨æŒ‡æ•°è¡¥å¿ç­‰å¾…å·¥ä½œæµå®Œæˆæ‰§è¡Œã€‚
*   å¦‚æœå¾—åˆ°å“åº”ï¼Œæˆ‘ä»¬ç«‹å³è¿”å›ï¼Œå¦åˆ™æˆ‘ä»¬å°†è¶…æ—¶å¹¶è¿”å›`{ "success": false }`ã€‚

å¦‚æœæ‚¨æ„¿æ„ï¼Œå¯ä»¥åˆ é™¤æ—¥å¿—è®°å½•å’ŒæŒ‡æ•°è¡¥å¿éƒ¨åˆ†ï¼Œä»¥ä½¿ä»£ç æ›´çŸ­ã€‚

> è¦åœ¨æœ¬åœ°ä¸»æœºä¸Šæµ‹è¯•ï¼Œè¿è¡Œ`npm i`å’Œ`npm start`ã€‚ä½ å¯ä»¥ç”¨ä¸€ä¸ªç±»ä¼¼`curl -XPOST localhost:8080`çš„å‘½ä»¤æ¥æµ‹è¯•è¿™ä¸ªåŠŸèƒ½ã€‚
> æ‚¨å¯èƒ½éœ€è¦ä½¿ç”¨`gcloud auth application-default`ç™»å½•ã€‚

# éƒ¨ç½²åˆ°äº‘åŠŸèƒ½

è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†å‡½æ•°éƒ¨ç½²åˆ°äº‘å‡½æ•°:

éƒ¨ç½²å¹¶æµ‹è¯•æˆ‘ä»¬çš„åŠŸèƒ½

æˆ‘ä»¬å·²ç»å°†è¿™ä¸ªäº‘åŠŸèƒ½è®¾ä¸ºç§æœ‰ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨æ¥è‡ª`gcloud`çš„è®¤è¯ä»¤ç‰Œæ¥æµ‹è¯•è¿™ä¸ªäº‘åŠŸèƒ½ã€‚å·¥ä½œæµç»“æœå°†å‡ºç°åœ¨ HTTP å“åº”ä¸­ã€‚

```
Result: ["Wednesday","Wednesday Night Wars","Wednesday 13","Wednesday Campanella","Wednesday Addams","Wednesday Night Hockey (American TV program)","Wednesdayite","Wednesday Campanella discography","Wednesday Morning, 3 A.M.","Wednesday Theatre"]
```

å¦‚æœæœ‰é—®é¢˜ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æŸ¥çœ‹å‡½æ•°çš„ Stackdriver æ—¥å¿—ã€‚

# æ„Ÿè°¢é˜…è¯»

ç°åœ¨ï¼Œæ‚¨å·²ç»æœ‰äº†ä¸€ä¸ªä¸äº‘åŠŸèƒ½ç›¸å…³è”çš„å·¥ä½œæµï¼Œæˆ–è®¸å¯ä»¥ä½¿ç”¨ Cloud Scheduler ä¸ºæ‚¨çš„åŠŸèƒ½æ·»åŠ ä¸€ä¸ªè®¡åˆ’ã€‚ä½ çš„æ€ç»´æ˜¯æé™ï¼

å¦‚æœæ‚¨å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘æ¨èæ‚¨è§‚çœ‹ YouTube ä¸Šå…³äºäº‘å·¥ä½œæµçš„è§†é¢‘:

ä»‹ç» Google äº‘å·¥ä½œæµ

å¹¶åœ¨ GitHub ä¸ŠæŸ¥çœ‹æˆ‘ä»¬æ‰€æœ‰çš„å‡ åä¸ªå·¥ä½œæµç¤ºä¾‹:

[https://github.com/GoogleCloudPlatform/workflows-samples](https://github.com/GoogleCloudPlatform/workflows-samples)