<html>
<head>
<title>Initial Privilege Breakthrough in Google Kubernetes Engine(GKE) — Helm Included</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌Kubernetes引擎(GKE)的首次特权突破—包括头盔</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/initial-breakthrough-in-google-kubernetes-engine-gke-bd84d72870e4?source=collection_archive---------1-----------------------#2018-04-25">https://medium.com/google-cloud/initial-breakthrough-in-google-kubernetes-engine-gke-bd84d72870e4?source=collection_archive---------1-----------------------#2018-04-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e0e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创造一个新的可抢占的GKE(<a class="ae jd" rel="noopener" href="/google-cloud/using-preemptible-vms-to-cut-kubernetes-engine-bills-in-half-de2481b8e814">省点钱吧！！</a>美国中部地区<strong class="ih hj">上名为<code class="du je jf jg jh b">mytest</code>的集群:</strong></p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="0ad1" class="jq jr hi jh b fi js jt l ju jv">$ gcloud container clusters create <strong class="jh hj">mytest</strong> --preemptible --cluster-version <strong class="jh hj">1.10.2-gke.3</strong> --zone <strong class="jh hj">us-central1-b</strong></span><span id="5712" class="jq jr hi jh b fi jw jt l ju jv">Creating cluster mytest...done.</span></pre><p id="dace" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">群集将在几分钟后创建。获取有关集群的详细信息:</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="edf5" class="jq jr hi jh b fi js jt l ju jv">$ gcloud container clusters describe <strong class="jh hj">mytest</strong> --zone <strong class="jh hj">us-central1-b</strong></span></pre><p id="91b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您从Kubernetes引擎UI创建集群，请获取凭证:</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="9974" class="jq jr hi jh b fi js jt l ju jv">$ gcloud container clusters get-credentials <strong class="jh hj">mytest</strong> --zone <strong class="jh hj">us-central1-b</strong></span></pre><p id="c42a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获取<code class="du je jf jg jh b">admin</code>密码:</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="a5ea" class="jq jr hi jh b fi js jt l ju jv">$ gcloud container clusters describe <strong class="jh hj">mytest</strong> | grep password</span><span id="f519" class="jq jr hi jh b fi jw jt l ju jv"># OPTIONALLY</span><span id="c60a" class="jq jr hi jh b fi jw jt l ju jv">$ gcloud container clusters describe <strong class="jh hj">mytest</strong> --format json | jq -r '.masterAuth.password'</span></pre><p id="0629" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为方便起见，导出密码变量</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="a2c0" class="jq jr hi jh b fi js jt l ju jv">$ export GKEPASS=$(gcloud container clusters describe mytest --format json | jq -r '.masterAuth.password')</span></pre><p id="b2d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">障碍:</p><h2 id="4452" class="jq jr hi bd jx jy jz ka kb kc kd ke kf iq kg kh ki iu kj kk kl iy km kn ko kp bi translated">1.默认命名空间中的签出窗格:</h2><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="bd6d" class="jq jr hi jh b fi js jt l ju jv">kubectl get pods</span></pre><p id="90e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">错误:</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="4646" class="jq jr hi jh b fi js jt l ju jv">Error from server (Forbidden): pods is forbidden: User "client" cannot list pods in the namespace "default": Unknown user "client"</span></pre><p id="c4a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是因为，对于GKE集群，默认情况下会禁用传统授权。因此，我们需要创建基于角色的访问来授予用户权限。因此，我们授予当前用户创建授权角色的能力。</p><figure class="ji jj jk jl fd kr er es paragraph-image"><div class="er es kq"><img src="../Images/210d2fb6737379aed6da4eb7ac0b784b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*7BB3DUU6JvvK2n8bCftQ2A.png"/></div></figure><p id="6960" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">解决方案:</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="6ac7" class="jq jr hi jh b fi js jt l ju jv">$ kubectl create rolebinding <strong class="jh hj">client-user-rolebinding</strong> --clusterrole=admin --user=client --username admin --password *****</span><span id="bee5" class="jq jr hi jh b fi jw jt l ju jv"># OR</span><span id="412f" class="jq jr hi jh b fi jw jt l ju jv">$ kubectl create rolebinding <strong class="jh hj">client-user-rolebinding</strong> --clusterrole=admin --user=client --username admin --password $GKEPASS</span></pre><p id="9eb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以在默认名称空间中获得pod和其他组件，但除此之外就没有了。因为<code class="du je jf jg jh b">rolebinding</code>在特定的名称空间内授予角色或集群角色，这里我们没有指定名称空间，所以使用了<code class="du je jf jg jh b">default</code>。</p><p id="df21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无密码可选方式:</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="3145" class="jq jr hi jh b fi js jt l ju jv">kubectl create rolebinding client-user-rolebinding --clusterrole=admin --user=$(gcloud config get-value account)</span></pre><h2 id="b69b" class="jq jr hi bd jx jy jz ka kb kc kd ke kf iq kg kh ki iu kj kk kl iy km kn ko kp bi translated">2.所有命名空间中的签出窗格:</h2><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="8306" class="jq jr hi jh b fi js jt l ju jv">$ kubectl get pods --all-namespaces</span></pre><p id="df50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">错误:</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="fd81" class="jq jr hi jh b fi js jt l ju jv">Error from server (Forbidden): pods is forbidden: User "client" cannot list pods at the cluster scope: Unknown user "client"</span></pre><p id="1739" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是因为用户<code class="du je jf jg jh b">client</code>没有权限访问默认名称空间之外的资源。只有默认名称空间<code class="du je jf jg jh b">rolebinding</code>的用户甚至不能创建名称空间。因此，解决方案是<code class="du je jf jg jh b">clusterrolebinding</code>，它将角色授予整个名称空间。</p><p id="281f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">解决方案:创建<code class="du je jf jg jh b">clusterrolebinding</code></p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="b9e1" class="jq jr hi jh b fi js jt l ju jv">$ kubectl create clusterrolebinding client-admin-crb --clusterrole=admin --user=client --username admin --password ****</span><span id="c9ad" class="jq jr hi jh b fi jw jt l ju jv"># OR</span><span id="922b" class="jq jr hi jh b fi jw jt l ju jv">$ kubectl create clusterrolebinding client-admin-crb --clusterrole=admin --user=client --username admin --password $GKEPASS</span></pre><p id="9e4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在yml中:</p><figure class="ji jj jk jl fd kr"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="6d04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用<code class="du je jf jg jh b">kubectl apply -f client-crb.yaml --username admin --password $GKEPASS</code>涂抹yml</p><p id="9e8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无需密码:</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="90a4" class="jq jr hi jh b fi js jt l ju jv">kubectl create clusterrolebinding client-admin-crb --clusterrole=cluster-admin --user=$(gcloud config get-value account)</span></pre><h2 id="2a7a" class="jq jr hi bd jx jy jz ka kb kc kd ke kf iq kg kh ki iu kj kk kl iy km kn ko kp bi translated">舵的授权</h2><p id="79d6" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">初始舵</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="f500" class="jq jr hi jh b fi js jt l ju jv">$ helm init</span><span id="b52a" class="jq jr hi jh b fi jw jt l ju jv">$HELM_HOME has been configured at /Users/user/.helm.</span><span id="ee86" class="jq jr hi jh b fi jw jt l ju jv">Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster.</span></pre><p id="ec96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du je jf jg jh b">init</code>命令在K8s集群中安装名为Tiller的Helm服务器端组件，并在$HELM_HOME(默认~/)中设置本地配置。helm/)。可以用<code class="du je jf jg jh b">$ kubectl get pods -l name=tiller --namespace=kube-system</code>检查舵杆舱</p><p id="70c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个舵图</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="6eea" class="jq jr hi jh b fi js jt l ju jv">$ helm create mychart</span><span id="6fbf" class="jq jr hi jh b fi jw jt l ju jv">Creating mychart</span></pre><p id="6601" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装图表:</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="ad57" class="jq jr hi jh b fi js jt l ju jv">$ helm install --name myapp mychart/</span></pre><p id="240b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">错误:</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="774f" class="jq jr hi jh b fi js jt l ju jv">Error: release app failed: namespaces "default" is forbidden: User "system:serviceaccount:kube-system:default" cannot get namespaces in the namespace "default": Unknown user "system:serviceaccount:kube-system:default"</span></pre><p id="3b22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">解决方案:</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="b674" class="jq jr hi jh b fi js jt l ju jv">kubectl create clusterrolebinding default-sa-crb — clusterrole=cluster-admin — serviceaccount=kube-system:default — username admin — password ****</span></pre><p id="5539" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，你可以走了。但是，更安全的方法是分解角色。为蒂勒提供单独的服务账户:</p><figure class="ji jj jk jl fd kr"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="b807" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">升级舵柄</strong></p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="b325" class="jq jr hi jh b fi js jt l ju jv">helm init --service-account tiller --upgrade</span></pre><h2 id="bdaf" class="jq jr hi bd jx jy jz ka kb kc kd ke kf iq kg kh ki iu kj kk kl iy km kn ko kp bi translated">清理集群和舵</h2><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="4cf5" class="jq jr hi jh b fi js jt l ju jv">$ helm delete --purge myapp</span><span id="45ba" class="jq jr hi jh b fi jw jt l ju jv">$ gcloud container clusters delete mytest --zone us-central1-b</span></pre></div></div>    
</body>
</html>