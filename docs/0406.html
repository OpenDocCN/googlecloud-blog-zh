<html>
<head>
<title>Build a Weather Station using Google Cloud IoT Core and MongooseOS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用谷歌云物联网核心和MongooseOS构建气象站</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/build-a-weather-station-using-google-cloud-iot-core-and-mongooseos-7a78b69822c5?source=collection_archive---------0-----------------------#2017-10-16">https://medium.com/google-cloud/build-a-weather-station-using-google-cloud-iot-core-and-mongooseos-7a78b69822c5?source=collection_archive---------0-----------------------#2017-10-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="0192" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用托管的无服务器架构收集大量数据，这样您就不会在此过程中自寻烦恼。</h2></div><p id="93d3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">好的，有很多教程教你如何建立一个气象站，因为有很多方法。这是一个简单的项目，所以我会努力专注于建立一个端到端的解决方案，从收集数据到对您的数据进行分析。所有这些都将使用托管的谷歌云服务，概述如何构建一个完整的物联网解决方案。最后，您可以基于您的数据构建报告，并通过web访问它。在这里你可以看到它的样子:</p><div class="jt ju jv jw fd ab cb"><figure class="jx jy jz ka kb kc kd paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><img src="../Images/0266720d4a968d977796c7d40932f8e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/1*fUIbdzdXKWk_I5-5LkZyRQ.png"/></div></figure><figure class="jx jy kk ka kb kc kd paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><img src="../Images/5263999358bf7d335a269cdc2bf0299f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1432/format:webp/1*QZNlDeZBGx63rpY5B92PqQ.png"/></div><figcaption class="kl km et er es kn ko bd b be z dx kp di kq kr translated">我们项目的最终外观</figcaption></figure></div><blockquote class="ks kt ku"><p id="e9e9" class="ix iy kv iz b ja jb ij jc jd je im jf kw jh ji jj kx jl jm jn ky jp jq jr js hb bi translated">我们完成的web app:<a class="ae kz" href="https://weather-station-iot-170004.firebaseapp.com" rel="noopener ugc nofollow" target="_blank">https://weather-station-iot-170004.firebaseapp.com</a>/</p><p id="4f09" class="ix iy kv iz b ja jb ij jc jd je im jf kw jh ji jj kx jl jm jn ky jp jq jr js hb bi translated">数据工作室报道:<a class="ae kz" href="https://datastudio.google.com/reporting/0B0w5dnm9bD8sdy1OR1lZQ0l4Vmc" rel="noopener ugc nofollow" target="_blank">https://data Studio . Google . com/reporting/0 b 0 w5 dnm 9 BD 8 SD y1 or 1 lzq 0 l4 VMC</a></p></blockquote><p id="6aeb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本教程中，我们将使用运行<strong class="iz hj"> MongooseOS </strong>的WiFi微控制器构建一个气象站，它使用MQTT协议通过<strong class="iz hj">云物联网核心</strong>安全地发送数据，然后使用<strong class="iz hj"> Firebase云函数</strong>以基于事件的方式处理数据，这些函数将原始数据保存在<strong class="iz hj"> BigQuery </strong>中，并更新<strong class="iz hj"> Firebase实时数据库</strong>中的设备当前状态。然后可以通过<strong class="iz hj"> DataStudio </strong>和<strong class="iz hj"> Firebase Hosting </strong>上托管的简单WebApp访问数据。有许多产品，但我将展示如何轻松地连接每一个产品，以部署一个按需扩展的产品。我们的架构将会是这样的:</p><figure class="jt ju jv jw fd jy er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es la"><img src="../Images/e9bac6b4c00bf5a65f10bf88fda0e87a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_WSqG1NE4ofI_dM6eSOfuA.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated">我们的项目架构</figcaption></figure><p id="2403" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了便于开发，我将使用MongooseOS，它已经有一个用于云物联网核心的连接器，并有助于为设备提供证书、WiFi配置和其他自定义配置的过程。</p><p id="ffeb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将学到什么:</p><ul class=""><li id="1221" class="lb lc hi iz b ja jb jd je jg ld jk le jo lf js lg lh li lj bi translated">创建云物联网核心设备注册表。</li><li id="e150" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">创建PubSub主题以接收和发送数据。</li><li id="c417" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">安装MongooseOS命令行工具— <em class="kv"> mos。</em></li><li id="46aa" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">使用<em class="kv"> mos对ESP32/ESP8266进行编程。</em></li><li id="ed6e" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">为设备提供证书和WiFi配置。</li><li id="41c7" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">设置BigQuery和Firebase来接收数据。</li><li id="b018" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">部署Firebase云功能来接收数据。</li><li id="3ee0" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">在Firebase托管中部署一个基本的WebApp。</li><li id="3f67" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">使用Data Studio在BigQuery中制作报表。</li></ul><p id="a22e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">说得够多了，让我们开始吧🚀。</p><h2 id="ebcf" class="lp lq hi bd lr ls lt lu lv lw lx ly lz jg ma mb mc jk md me mf jo mg mh mi mj bi translated">设置谷歌云项目和云物联网核心</h2><p id="6a45" class="pw-post-body-paragraph ix iy hi iz b ja mk ij jc jd ml im jf jg mm ji jj jk mn jm jn jo mo jq jr js hb bi translated">谷歌最近公开推出了beta Cloud IoT Core，这是一种托管服务，可以使用通用协议(MQTT和HTTP)安全地与物联网设备进行通信，并以简单的方式管理这些设备。基本上，有了这项服务，你可以插入许多其他谷歌服务来处理、存储和分析你的设备产生的所有数据。在这里，我们可以看到一个使用云物联网核心的推荐架构示例。</p><figure class="jt ju jv jw fd jy er es paragraph-image"><div class="er es mp"><img src="../Images/d9abec421644e9a0285e53cdd24e027f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*4u9A3dCbi9G_bWDvqKAftA.gif"/></div><figcaption class="kl km et er es kn ko bd b be z dx translated">流经许多谷歌服务的数据。</figcaption></figure><p id="903d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">云物联网核心有一个设备注册表的概念，在我们的项目中，我们将对一系列类似的设备进行分组，并与该注册表相关联。要开始使用谷歌云，你可以在云控制台web界面上做所有的事情，但命令行工具是一个更强大的工具，也是我选择在这个项目上使用的工具。</p><p id="e42d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要使用<code class="du mq mr ms mt b">gcloud</code>命令行工具，<a class="ae kz" href="https://cloud.google.com/sdk/downloads" rel="noopener ugc nofollow" target="_blank">按照这里的说明下载并安装它</a>。</p><div class="mu mv ez fb mw mx"><a href="https://cloud.google.com/sdk/downloads" rel="noopener  ugc nofollow" target="_blank"><div class="my ab dw"><div class="mz ab na cl cj nb"><h2 class="bd hj fi z dy nc ea eb nd ed ef hh bi translated">安装Cloud SDK | Cloud SDK文档| Google云平台</h2><div class="ne l"><h3 class="bd b fi z dy nc ea eb nd ed ef dx translated">编辑描述</h3></div><div class="nf l"><p class="bd b fp z dy nc ea eb nd ed ef dx translated">cloud.google.com</p></div></div></div></a></div><p id="71f0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">安装SDK后，您应该安装测试版工具来访问云物联网核心命令。此外，在此之后，您应该验证并创建一个在本教程中使用的项目，将您的_PROJECT_NAME替换为您希望用于此项目的名称:</p><pre class="jt ju jv jw fd ng mt nh ni aw nj bi"><span id="e7f3" class="lp lq hi mt b fi nk nl l nm nn"># Install beta components:<br/><strong class="mt hj">gcloud components install beta<br/></strong># Authenticate with Google Cloud:<br/><strong class="mt hj">gcloud auth login<br/></strong># Create cloud project — choose your unique project name:<br/><strong class="mt hj">gcloud projects create YOUR_PROJECT_NAME<br/></strong># Set current project<strong class="mt hj"><br/>gcloud config set project YOUR_PROJECT_NAME</strong></span></pre><p id="602e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在在云物联网核心端，你首先应该配置一些与云物联网核心使用的主要组件之一Cloud PubSub相关的组件。在下面的命令中，您将执行以下操作:</p><ol class=""><li id="b160" class="lb lc hi iz b ja jb jd je jg ld jk le jo lf js no lh li lj bi translated">授予云物联网核心在PubSub上发布消息的权限。</li><li id="02f2" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js no lh li lj bi translated">创建一个名为<em class="kv"> telemetry-topic、</em>的<strong class="iz hj">主题</strong>，这些消息将在这里发布。</li><li id="679b" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js no lh li lj bi translated">创建一个名为<em class="kv">遥测订阅</em>的<strong class="iz hj">订阅</strong>，我们稍后将使用它来读取主题中的一些消息。</li><li id="0a79" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js no lh li lj bi translated">创建一个名为<em class="kv">weather-station-Registry</em>的<strong class="iz hj">注册表</strong>，我们的设备将在其中注册，以便能够连接到<strong class="iz hj">云物联网核心</strong>。这里我们联想到<strong class="iz hj">主题</strong>的创建。</li></ol><pre class="jt ju jv jw fd ng mt nh ni aw nj bi"><span id="4dc5" class="lp lq hi mt b fi nk nl l nm nn"># Add permissions for IoT Core<strong class="mt hj"><br/>gcloud projects add-iam-policy-binding YOUR_PROJECT_NAME --member=serviceAccount:cloud-iot@system.gserviceaccount.com --role=roles/pubsub.publisher<br/></strong># Create PubSub topic for device data:<br/><strong class="mt hj">gcloud beta pubsub topics create telemetry-topic<br/></strong># Create PubSub subscription for device data:<br/><strong class="mt hj">gcloud beta pubsub subscriptions create --topic telemetry-topic telemetry-subscription<br/></strong># Create device registry:<br/><strong class="mt hj">gcloud beta iot registries create weather-station-registry --region us-central1 --event-pubsub-topic=telemetry-topic</strong></span></pre><p id="bbc0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您访问Google Cloud控制台，您可以验证它已经创建并配置完毕。</p><figure class="jt ju jv jw fd jy er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es np"><img src="../Images/b844898850547c552e42cfb15af13c8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2AE61A100p8yQziuUZriQg.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated">已创建并与发布订阅主题相关联的注册表</figcaption></figure><h2 id="544c" class="lp lq hi bd lr ls lt lu lv lw lx ly lz jg ma mb mc jk md me mf jo mg mh mi mj bi translated">猫鼬操作系统和ESP32/ESP8266</h2><p id="de00" class="pw-post-body-paragraph ix iy hi iz b ja mk ij jc jd ml im jf jg mm ji jj jk mn jm jn jo mo jq jr js hb bi translated">对于这个项目，我将使用最新的ESP32 WiFi微控制器，对于那些还不知道它的人来说，它是ExpressIf非常著名的ESP8266的继任者，但现在具有更多功能，如内置蓝牙LE、时钟频率为240MHz的双核处理器、触摸传感器和对闪存加密的支持，所以没有人可以访问您的代码。一次升级。</p><figure class="jt ju jv jw fd jy er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es nq"><img src="../Images/2df098949ad778786485cd77424cedff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JPMfV4VVEMqy4VmoXKEx4Q.jpeg"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated">猫鼬操作系统和谷歌物联网核心包，带阿达果羽毛huzzah 32—<a class="ae kz" href="https://www.adafruit.com/product/3606" rel="noopener ugc nofollow" target="_blank">https://www.adafruit.com/product/3606</a></figcaption></figure><p id="30e9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Adafruit出售一个非常棒的工具包，可以开始使用ESP32和谷歌云，它包含了这个项目和许多其他项目所需的所有内容，所以如果你想走简单的路，你可以购买其中一个。(只是给你一个想法<a class="nr ns ge" href="https://medium.com/u/c9914184139c?source=post_page-----7a78b69822c5--------------------------------" rel="noopener" target="_blank">阿达果工业</a>，我没有这些，只是说…)</p><figure class="jt ju jv jw fd jy er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es nt"><img src="../Images/22f7f7df94e2f730981d399c3f717c16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5FxYfE6AxML2xEo5rxljQQ.jpeg"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated">该项目采用ESP微控制器ESP32和ESP8266。</figcaption></figure><p id="67e3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个项目也可以在ESP8266上运行，所以这里提供的代码和原理图可以在两个微控制器上运行。该项目的电路非常简单，只需将DHT传感器连接到ESP32/ESP8266，如下图所示:</p><figure class="jt ju jv jw fd jy er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es nu"><img src="../Images/f5765b5c88d2b178c9a2776706fcc3ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zv63BXeNYZeKE9tmEPW2kw.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated">使用ESP32和ESP8266的项目原理图</figcaption></figure><p id="a8f0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了对开发板进行编程，我们将使用MongooseOS，这是一个为商业产品开发的操作系统，具有许多令人惊叹的功能。它支持一些微控制器，如CC3200、ESP32和ESP8266。它的一个很酷的功能是可以使用Javascript快速原型化您的嵌入式应用，它有一个名为<em class="kv"> mos </em>的工具，使编程、供应和配置在那些支持的板上变得非常容易。</p><p id="20c8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要使用它，我们需要从官方网站下载并安装它。遵循<a class="ae kz" href="https://mongoose-os.com/docs/quickstart/setup.html" rel="noopener ugc nofollow" target="_blank">https://mongoose-os.com/docs/quickstart/setup.html</a>上的安装说明。</p><div class="mu mv ez fb mw mx"><a href="https://mongoose-os.com/docs/quickstart/setup.html" rel="noopener  ugc nofollow" target="_blank"><div class="my ab dw"><div class="mz ab na cl cj nb"><h2 class="bd hj fi z dy nc ea eb nd ed ef hh bi translated">Mongoose操作系统文档</h2><div class="ne l"><h3 class="bd b fi z dy nc ea eb nd ed ef dx translated">Mongoose操作系统文档和用户指南</h3></div><div class="nf l"><p class="bd b fp z dy nc ea eb nd ed ef dx translated">mongoose-os.com</p></div></div><div class="nv l"><div class="nw l nx ny nz nv oa ki mx"/></div></div></a></div><h2 id="5722" class="lp lq hi bd lr ls lt lu lv lw lx ly lz jg ma mb mc jk md me mf jo mg mh mi mj bi translated">硬件编程和设置我们的后端</h2><p id="21ad" class="pw-post-body-paragraph ix iy hi iz b ja mk ij jc jd ml im jf jg mm ji jj jk mn jm jn jo mo jq jr js hb bi translated">安装好工具后，下载链接到这里的<a class="ae kz" href="https://github.com/alvarowolfx/weather-station-gcp-mongoose-os" rel="noopener ugc nofollow" target="_blank"> Github库上的项目代码</a>，这样您就可以在设备上构建和部署它了。</p><div class="mu mv ez fb mw mx"><a href="https://github.com/alvarowolfx/weather-station-gcp-mongoose-os" rel="noopener  ugc nofollow" target="_blank"><div class="my ab dw"><div class="mz ab na cl cj nb"><h2 class="bd hj fi z dy nc ea eb nd ed ef hh bi translated">alvarowolfx/气象站-GCP-mongose-OS</h2><div class="ne l"><h3 class="bd b fi z dy nc ea eb nd ed ef dx translated">一个用ESP32制作的气象站，通过谷歌云物联网核心和…</h3></div><div class="nf l"><p class="bd b fp z dy nc ea eb nd ed ef dx translated">github.com</p></div></div><div class="nv l"><div class="ob l nx ny nz nv oa ki mx"/></div></div></a></div><p id="148f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">知识库由<strong class="iz hj"> 3个子项目</strong>组成:</p><ul class=""><li id="7f9b" class="lb lc hi iz b ja jb jd je jg ld jk le jo lf js lg lh li lj bi translated"><strong class="iz hj">固件</strong>:运行在微控制器上的MongooseOS项目，收集传感器数据并通过云物联网核心发送</li><li id="4543" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated"><strong class="iz hj">功能</strong>:将部署到Firebase上的云功能。这里我们有一个函数，它对PubSub上的新数据做出反应，然后发送到BigQuery和Firebase实时数据库。还有另一个功能，它基本上是一个HTTP端点，查询BigQuery以获取我们的WebApp要使用的最近7天的数据。</li><li id="e232" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated"><strong class="iz hj"> public </strong>:一个简单的WebApp，将被部署在Firebase主机上，它参考我们的数据库来显示我们的传感器数据。</li></ul><p id="6c66" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是对<strong class="iz hj">固件</strong>项目的一些描述:</p><ul class=""><li id="5324" class="lb lc hi iz b ja jb jd je jg ld jk le jo lf js lg lh li lj bi translated">fs :这里是我们的Javascript代码，它包含了所有收集数据的逻辑，并以固定的时间间隔通过MQTT发送。</li><li id="6fca" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">src :我们本地C代码，basic启动了Google Cloud library，所以它自动配置我们的项目来连接Google MQTT服务器。</li><li id="5712" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated"><strong class="iz hj"> mos.yml和mos_esp8266.yml </strong>:我们的项目配置，这里我们声明我们的项目依赖项，这里是GCP库，DHT传感器库和mJS库，最后一个增加了对Javascript embedded的支持。这里我们声明了一个名为<strong class="iz hj"> app.dht的自定义配置变量，</strong>这样我们就可以通过更改这个配置来更改dht引脚，这可以在这个文件上进行，也可以通过<em class="kv"> mos </em>工具进行。此外，这种配置在不同的微控制器之间也有所不同，增加了对具有相同代码的两个微控制器的支持。</li></ul><figure class="jt ju jv jw fd jy"><div class="bz dy l di"><div class="oc od l"/></div></figure><p id="2800" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要对硬件进行编程，请进入<strong class="iz hj">固件</strong>文件夹并运行以下指令来刷新固件、配置WiFi并在云物联网核心上配置设备:</p><ul class=""><li id="54e7" class="lb lc hi iz b ja jb jd je jg ld jk le jo lf js lg lh li lj bi translated">根据所选硬件运行<code class="du mq mr ms mt b">mos build --arch esp32</code>或<code class="du mq mr ms mt b">mos build --arch esp8266</code>。这个命令构建我们硬件的固件。</li><li id="d490" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">通过USB连接硬件运行<code class="du mq mr ms mt b">mos flash</code>，刷新固件。</li><li id="30f6" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">运行<code class="du mq mr ms mt b">mos wifi your_ssid your_pass</code>在您的设备上配置WiFi。</li><li id="5680" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">运行以下命令在云IoT代码上注册此设备。该命令生成用于通信的公钥和私钥，将私钥放在设备上，将公钥发送到云物联网核心并注册设备，从ESP获取设备Id。谢谢蒙古人❤.</li></ul><pre class="jt ju jv jw fd ng mt nh ni aw nj bi"><span id="d261" class="lp lq hi mt b fi nk nl l nm nn">mos gcp-iot-setup --gcp-project <strong class="mt hj">YOUR_PROJECT_NAME</strong> --gcp-region us-central1 --gcp-registry <strong class="mt hj">YOUR_REGISTRY</strong></span></pre><p id="6e3b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">就是这样，你的设备将开始向云物联网核心发送数据。这些项目被配置为每分钟发送数据，但是您可以稍后在<strong class="iz hj"> fs/init.js </strong>文件中更改这一点，或者您可以创建一个定制的配置变量来更改时间。我会把这个作为家庭作业。你可以使用<code class="du mq mr ms mt b">mos console</code>工具看到设备上发生了什么。你会看到它试图与mqtt.googleapis.com建立联系。</p><pre class="jt ju jv jw fd ng mt nh ni aw nj bi"><span id="30c1" class="lp lq hi mt b fi nk nl l nm nn">$ mos console<br/>Using port /dev/cu.SLAB_USBtoUART<br/>[Oct 15 18:17:47.230] pm open,type:2 0<br/>[Oct 15 18:17:47.234] mgos_sntp_ev         SNTP reply from 192.99.2.8: time 1508102268.124028, local 15.317275, delta 1508102252.806753<br/>[Oct 15 18:17:47.448] mgos_mqtt_ev         MQTT CONNACK 4<br/>[Oct 15 18:17:47.455] mgos_mqtt_ev         MQTT Disconnect<br/>[Oct 15 18:17:47.463] mqtt_global_reconnec MQTT connecting after 2017 ms<br/>[Oct 15 18:17:48.167] Info: {"hum":34,"temp":30,"free_ram":35.593750,"total_ram":51.218750} <br/>[Oct 15 18:17:49.487] mgos_mqtt_global_con MQTT connecting to mqtt.googleapis.com:8883</span></pre><p id="c02f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要查看PubSub上的数据，您可以使用gcloud命令来查询我们创建的订阅:</p><pre class="jt ju jv jw fd ng mt nh ni aw nj bi"><span id="a04b" class="lp lq hi mt b fi nk nl l nm nn">$ gcloud beta pubsub subscriptions pull --auto-ack telemetry-subscription<br/>┌───────────────────────────────────────────────────────────┬─────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐<br/>│                            DATA                           │    MESSAGE_ID   │                                                                                    ATTRIBUTES                                                                                   │<br/>├───────────────────────────────────────────────────────────┼─────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤<br/>│ {"hum":35,"temp":32,"free_ram":167344,"total_ram":253928} │ 158362578982703 │ deviceId=esp32_02455C deviceNumId=2799497560622332 deviceRegistryId=weather-station-registry deviceRegistryLocation=us-central1 projectId=weather-station-iot-170004 subFolder= │<br/>└───────────────────────────────────────────────────────────┴─────────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘</span></pre><p id="6534" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你看到控制台上的数据，你可以开始庆祝，我们走在正确的道路上🎉🏆。</p><h2 id="5346" class="lp lq hi bd lr ls lt lu lv lw lx ly lz jg ma mb mc jk md me mf jo mg mh mi mj bi translated">在BigQuery上存储数据</h2><p id="254b" class="pw-post-body-paragraph ix iy hi iz b ja mk ij jc jd ml im jf jg mm ji jj jk mn jm jn jo mo jq jr js hb bi translated">直接从官网获取定义:</p><blockquote class="ks kt ku"><p id="59c4" class="ix iy kv iz b ja jb ij jc jd je im jf kw jh ji jj kx jl jm jn ky jp jq jr js hb bi translated">BigQuery是Google的低成本、完全可管理的Pb级可扩展数据存储服务。BigQuery是独立的，不需要管理基础设施，也不需要数据库管理员，因为它可以随数据扩展。</p></blockquote><p id="5e24" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这里，我们将使用它来存储我们收集的所有传感器数据，以运行一些查询，并在以后使用Data Studio构建报告。首先，让我们创建一个<strong class="iz hj">数据集</strong>和一个<strong class="iz hj">表</strong>来存储我们的数据。为此，<a class="ae kz" href="https://bigquery.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">打开BigQuery Web UI </a>，并按照说明进行操作:</p><ol class=""><li id="eb59" class="lb lc hi iz b ja jb jd je jg ld jk le jo lf js no lh li lj bi translated">单击向下箭头图标，然后单击“创建新数据集<strong class="iz hj">”</strong>。</li><li id="0bb7" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js no lh li lj bi translated">把你的<strong class="iz hj">数据集</strong>命名为“weather_station_iot <strong class="iz hj">”。</strong></li><li id="1bee" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js no lh li lj bi translated">使用以下字段和类型创建一个<strong class="iz hj">表"</strong> raw_data <strong class="iz hj"> " </strong>:</li></ol><figure class="jt ju jv jw fd jy er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es oe"><img src="../Images/1e76b5de757bd5a1733133feba585c36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kIgbW_qE3ys7RgaPTYmzJg.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated">我们的BigQuery表来存储传感器数据。</figcaption></figure><h2 id="17c9" class="lp lq hi bd lr ls lt lu lv lw lx ly lz jg ma mb mc jk md me mf jo mg mh mi mj bi translated">部署Firebase数据库和云功能</h2><p id="f317" class="pw-post-body-paragraph ix iy hi iz b ja mk ij jc jd ml im jf jg mm ji jj jk mn jm jn jo mo jq jr js hb bi translated">现在，为了在BigQuery上插入数据，我们将使用Firebase云函数，这些函数可以配置为基于许多不同的触发器和事件来执行。其中一个触发器是插入到PubSub主题中的新数据，因此我们将侦听与我们的设备注册表相关联的主题，对于每个到达的数据，我们执行一个函数，将数据存储在BigQuery中，并在Firebase实时数据库中维护最新的设备数据。</p><figure class="jt ju jv jw fd jy er es paragraph-image"><div class="er es of"><img src="../Images/e9e8d36deb6a8886a23ba0ce027d9200.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*JbmSevoGfa4bzLqkk6N4Iw.jpeg"/></div><figcaption class="kl km et er es kn ko bd b be z dx translated">Firebase云功能的触发因素— Google Cloud Next 2017</figcaption></figure><p id="62c1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Firebase实时数据库是一项非常有用的技术，可以维护实时数据，在所有连接的客户端之间提供免费的自动同步。<a class="ae kz" href="https://cloud.google.com/solutions/iot-overview" rel="noopener ugc nofollow" target="_blank">甚至谷歌也建议它保持物联网设备的实时状态，就像我们在这里看到的</a>。</p><figure class="jt ju jv jw fd jy er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es og"><img src="../Images/44486c551b4026abb9967e1faa2cde29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cOwcAVFbv-0lR0MVik6VbQ.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated">使用Firebase的物联网架构—【https://cloud.google.com/solutions/iot-overview T21】</figcaption></figure><p id="d03b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们的函数的代码可以在上面看到，它基本上对PubSub事件作出反应，并插入到BigQuery中，然后更新Firebase上的当前状态。</p><p id="00b7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="kv"> Firebase命令行工具</em>需要节点。js和npm <a class="ae kz" href="https://www.npmjs.org/" rel="noopener ugc nofollow" target="_blank">、</a>可以按照<a class="ae kz" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank">https://Nodejs.org/.</a>安装node上的说明安装，JS也会安装npm。</p><p id="96ca" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">安装节点和NPM后，运行以下命令安装Firebase CLI。</p><pre class="jt ju jv jw fd ng mt nh ni aw nj bi"><span id="60ef" class="lp lq hi mt b fi nk nl l nm nn">npm install -g firebase-tools</span></pre><p id="495d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，要用我们的项目配置firebase并部署功能，在项目根文件夹中，遵循上面的说明:</p><ul class=""><li id="3476" class="lb lc hi iz b ja jb jd je jg ld jk le jo lf js lg lh li lj bi translated">运行<code class="du mq mr ms mt b">firebase login</code>向Google认证并设置命令行工具</li><li id="cd5c" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">运行<code class="du mq mr ms mt b">firebase init</code>将本地项目与您的Firebase项目关联起来。</li><li id="144b" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">运行上面的代码来设置一些环境变量，指向我们的BigQuery数据集和表。</li></ul><pre class="jt ju jv jw fd ng mt nh ni aw nj bi"><span id="1b3c" class="lp lq hi mt b fi nk nl l nm nn">firebase functions:config:set bigquery.datasetname="weather_station_iot" bigquery.tablename="raw_data”</span></pre><ul class=""><li id="208a" class="lb lc hi iz b ja jb jd je jg ld jk le jo lf js lg lh li lj bi translated">最后运行<code class="du mq mr ms mt b">firebase deploy</code>在公共文件夹上部署函数和Webapp。</li></ul><figure class="jt ju jv jw fd jy er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es oh"><img src="../Images/d9e4de9e251a4243b0259887f8f14fdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xNG3YoW3XNv1NV4ejggJ8Q.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated">所有这些都可以通过Firebase轻松部署。</figcaption></figure><p id="054c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用部署的功能，您可以接收设备发送的遥测数据，并存储在两个存储解决方案中。您可以在Firebase控制台上看到所有部署的资源。</p><figure class="jt ju jv jw fd jy er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es oi"><img src="../Images/44278c960a178024a9783f2f0ae36fd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pnUbq7MHMBZGEtGnNukIyQ.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated">您可以看到在Firebase上运行的函数的执行和日志。</figcaption></figure><p id="9ea4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以看到上面函数的代码:</p><figure class="jt ju jv jw fd jy"><div class="bz dy l di"><div class="oc od l"/></div><figcaption class="kl km et er es kn ko bd b be z dx translated">我们的云功能负责向BigQuery和Firebase实时数据库发送数据</figcaption></figure><p id="2bde" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="kv"> firebase-tools </em>也有一个内置的服务器，你可以在运行<strong class="iz hj"> firebase serve </strong>的项目文件夹上启动它，它会默认在端口5000上启动一个web服务器。</p><figure class="jt ju jv jw fd jy er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es oj"><img src="../Images/9dda8031f15f91b2d9e5eb67e8435e8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I0TbTu_77AbD73eVvOwVEw.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated">使用Firebase服务器运行本地</figcaption></figure><p id="7059" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">webapp可以直接在<strong class="iz hj"> public </strong>目录看到，逻辑在<strong class="iz hj"> public/app.js </strong>，前端在<strong class="iz hj"> public/index.html </strong>。挺基础的，就Javascript，<a class="ae kz" href="http://material-components-web.appspot.com" rel="noopener ugc nofollow" target="_blank"> Web素材组件</a>和<a class="ae kz" href="http://chartjs.org" rel="noopener ugc nofollow" target="_blank">图表。图表。</a></p><p id="1bcc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果一切设置正确，那么你可以再次庆祝，因为你开发了一个端到端的物联网解决方案，而无需接触高级服务器设置。</p><h2 id="e5b9" class="lp lq hi bd lr ls lt lu lv lw lx ly lz jg ma mb mc jk md me mf jo mg mh mi mj bi translated">最后一站，谷歌数据工作室</h2><p id="240d" class="pw-post-body-paragraph ix iy hi iz b ja mk ij jc jd ml im jf jg mm ji jj jk mn jm jn jo mo jq jr js hb bi translated">Data Studio是一个非常直观的工具，我不会在这里探究它，所以本教程变得不太全面，但是为了让您知道，Data Studio有一个BigQuery连接器，所以只需导入您的表并使用这个强大工具提供的不同可视化。去datastudio.google.com玩吧。</p><figure class="jt ju jv jw fd jy er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es ok"><img src="../Images/2316513056127a0ac60926d9fec128d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A7nyvG0rm0eZHQ4NJsrvjA.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated">Data Studio BigQuery连接器。</figcaption></figure><figure class="jt ju jv jw fd jy er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es ol"><img src="../Images/8ed668b0ef5c5c9d206bec821a488206.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QZNlDeZBGx63rpY5B92PqQ.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated">使用Data Studio的简单报告。</figcaption></figure></div><div class="ab cl om on gp oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="hb hc hd he hf"><h2 id="bba7" class="lp lq hi bd lr ls lt lu lv lw lx ly lz jg ma mb mc jk md me mf jo mg mh mi mj bi translated">进一步阅读</h2><p id="191c" class="pw-post-body-paragraph ix iy hi iz b ja mk ij jc jd ml im jf jg mm ji jj jk mn jm jn jo mo jq jr js hb bi translated">这就是本教程，希望你对谷歌云物联网核心感兴趣，这是一个很棒的服务，你可以用它做强大的事情。这篇文章比我预期的要长一点，但我相信它很好地概述了谷歌云平台上的许多工具。</p><p id="2e85" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个项目的代码可以在我的Github上找到，一些有趣的链接在下面的部分，稍后阅读:</p><div class="mu mv ez fb mw mx"><a href="https://github.com/alvarowolfx/weather-station-gcp-mongoose-os" rel="noopener  ugc nofollow" target="_blank"><div class="my ab dw"><div class="mz ab na cl cj nb"><h2 class="bd hj fi z dy nc ea eb nd ed ef hh bi translated">alvarowolfx/气象站-GCP-mongose-OS</h2><div class="ne l"><h3 class="bd b fi z dy nc ea eb nd ed ef dx translated">一个用ESP32制作的气象站，通过谷歌云物联网核心和…</h3></div><div class="nf l"><p class="bd b fp z dy nc ea eb nd ed ef dx translated">github.com</p></div></div><div class="nv l"><div class="ob l nx ny nz nv oa ki mx"/></div></div></a></div><ul class=""><li id="513c" class="lb lc hi iz b ja jb jd je jg ld jk le jo lf js lg lh li lj bi translated"><a class="ae kz" href="https://cloudplatform.googleblog.com/2017/09/announcing-Cloud-IoT-Core-public-beta.html" rel="noopener ugc nofollow" target="_blank">https://Cloud platform . Google blog . com/2017/09/announcing-Cloud-IoT-Core-public-beta . html</a></li><li id="e89a" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">http://mongoose-os.com/gcp<a class="ae kz" href="http://mongoose-os.com/gcp" rel="noopener ugc nofollow" target="_blank"/></li><li id="63e5" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated">【https://cloud.google.com/iot/docs/quickstart T4】</li><li id="8a78" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated"><a class="ae kz" href="https://mongoose-os.com/docs/libraries/cloud_integrations/gcp.html" rel="noopener ugc nofollow" target="_blank">https://mongose-OS . com/docs/libraries/cloud _ integrations/GCP . html</a></li><li id="702c" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated"><a class="ae kz" href="https://www.adafruit.com/product/3606" rel="noopener ugc nofollow" target="_blank">https://www.adafruit.com/product/3606</a></li><li id="77d3" class="lb lc hi iz b ja lk jd ll jg lm jk ln jo lo js lg lh li lj bi translated"><a class="ae kz" href="https://github.com/alvarowolfx/weather-station-gcp-mongoose-os" rel="noopener ugc nofollow" target="_blank">https://github . com/alvarowolfx/weather-station-GCP-mongose-OS</a></li></ul></div><div class="ab cl om on gp oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="hb hc hd he hf"><blockquote class="ks kt ku"><p id="cd17" class="ix iy kv iz b ja jb ij jc jd je im jf kw jh ji jj kx jl jm jn ky jp jq jr js hb bi translated">你喜欢这个帖子吗？所以不要忘了让你的拍手继续👏下面，推荐一下，分享给你的朋友。</p><p id="b2bb" class="ix iy kv iz b ja jb ij jc jd je im jf kw jh ji jj kx jl jm jn ky jp jq jr js hb bi translated">你用这个教程做了什么好事吗？显示在下面的评论部分。</p><p id="cd96" class="ix iy kv iz b ja jb ij jc jd je im jf kw jh ji jj kx jl jm jn ky jp jq jr js hb bi translated">如果你有任何问题，请在评论中留言，我会尽力帮助你。</p></blockquote></div></div>    
</body>
</html>