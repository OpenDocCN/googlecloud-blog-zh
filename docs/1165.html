<html>
<head>
<title>Surviving traffic spike from Hacker News: my dreaded Google Cloud invoice</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客新闻中幸存的流量峰值:我可怕的谷歌云发票</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/surviving-traffic-spike-from-hacker-news-my-dreaded-google-cloud-invoice-6b940dd9eba6?source=collection_archive---------0-----------------------#2019-10-09">https://medium.com/google-cloud/surviving-traffic-spike-from-hacker-news-my-dreaded-google-cloud-invoice-6b940dd9eba6?source=collection_archive---------0-----------------------#2019-10-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="418e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个故事讲述了发生在2019年9月26日的事件。都是真的。我建的一个网站，“<a class="ae jd" href="https://www.programming-idioms.org" rel="noopener ugc nofollow" target="_blank">编程习惯用语</a>”，打到了“橙站”(又名黑客新闻)的第一页。我的云提供商监控控制台让我知道突发流量是否导致了停机。而几天后的发票让我明白，在云端运行服务不是免费的饭。</p><p id="9303" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="je">免责声明1:我目前在谷歌云工作。然而，在加入谷歌之前，我已经设计和部署了网站编程习惯用法。</em></p><p id="c720" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="je">免责声明2:这是我具体经历的忠实报告。显然不适用于任何不相关的类似云项目。YMMV。</em></p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><h1 id="2e94" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">1.症状</h1><p id="7aa8" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">下午5:07，我收到一个通知:有人要求在我的网站中添加对他们最喜欢的编程语言的支持。然后五分钟后，另一个通知，来自其他人，要求相同的语言。这是怎么回事？</p><p id="c7ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae jd" href="https://www.programming-idioms.org/" rel="noopener ugc nofollow" target="_blank">编程习惯用法</a>中，用不支持的语言编写代码片段会产生一个令人愉快的<a class="ae jd" href="https://en.wikipedia.org/wiki/Blue_screen_of_death" rel="noopener ugc nofollow" target="_blank">老式错误页面</a>:</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es kp"><img src="../Images/4ddf64cadd3c6c90374492d12b87d256.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-OJtuwj9Ku5YuKvMjQcDPg.png"/></div></div><figcaption class="lb lc et er es ld le bd b be z dx translated"><em class="lf">一个令人愉快的老式错误页面</em></figcaption></figure><p id="d33a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我决定登录谷歌云平台(GCP)的web控制台，查看最近是否发生了许多这样的错误。贡献系统可能会因为某些原因而中断。</p><p id="76bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我注意到的第一件事是“每秒请求数”仪表板中一个不寻常的形状。我还注意到一个高实例计数。</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div class="er es lg"><img src="../Images/de9cd797e65cf1b93be740558316323e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*SQdZOZRdUMRpMTk0N1apEA.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx translated">每秒异常的请求数</figcaption></figure><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lh"><img src="../Images/ca1b579cae575706e3b09f7dbbbdf4dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ahPjO4rqvjSJCMwuyZAoww.png"/></div></div><figcaption class="lb lc et er es ld le bd b be z dx translated">当前运行的服务器实例数量异常</figcaption></figure><p id="b100" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的第一个想法是，我犯了一个大错，就像cronjob启动的失败任务的无限循环。我必须马上解决这个问题！云中的无限循环对银行账户不利。</p><p id="f125" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这一点上，知道GCP还没有提供一个简单的方法来限制一个给定项目的成本，也就是说，自动地阻止已计费的$$$的暴涨是很有用的。然而，至少可以说，这是件好事。</p><p id="0708" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在项目层面，当成本超过一些特定的阈值时，可以设置“预算提醒”电子邮件。但是在我的脚本横行肆虐的情况下(或者一个真正的流量突然激增)，我很可能会在大量现金被烧掉后<em class="je">阅读邮件并采取行动。</em></p><p id="0099" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，在App Engine标准级别上<strong class="ih hj">有</strong>一个<a class="ae jd" href="https://cloud.google.com/appengine/docs/standard/go111/console/#setting_a_spending_limit" rel="noopener ugc nofollow" target="_blank">每日消费限额</a>选项。很高兴知道！</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div class="er es li"><img src="../Images/f1177070eebe6339b26662660c3983c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*oeECcbzP3uxY9j0NdCozEQ.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx translated">这个选择可以挽救你的退休计划</figcaption></figure><p id="0075" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="je">编辑:</em> </strong>在服务层面(GCP组件)，可以学习到一种有效的方法<a class="ae jd" href="https://www.youtube.com/watch?v=XpSBBFSBM9g" rel="noopener ugc nofollow" target="_blank">用定额</a>设置成本控制。这涵盖了所有可能的坏场景的很大一部分。</p><p id="0c1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我还没想到会有大量游客涌入。</p><p id="e1f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在web服务可伸缩性方面的经验是，预期流量的不确定性通常是通过雄心勃勃的防御设计和过度供应来解决的，遵循了这本伟大著作中的建议和智慧:</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div class="er es lj"><img src="../Images/96521dae5c3043940cbb7a2548fa1703.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*81_8Jy1Os3-8GaD0H1GR6Q.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx translated">鸣谢:<a class="ae jd" href="https://twitter.com/ThePracticalDev/status/800752571497545729" rel="noopener ugc nofollow" target="_blank">推特上的the practical dev</a></figcaption></figure><p id="80c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本上，企业家对他们的服务迅速传播并取得成功的可能性有很高的评价，并且在其他关键问题之前，非常关心处理不可避免的巨大负载的能力。在我看来，市场调查，用户界面，UX，可用性，拥有一个MVP，收集早期反馈，等等。比处理100万并发用户更紧迫。成功终将到来(也可能根本不会到来)，连续几波流量增加将会发生，每次显著的增加都将是修改可伸缩性策略的机会，将实际流量和错误监控指标考虑在内，以及对项目需求的更好理解(比原型阶段早期)。</p><p id="868f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，我承认，在大众媒体<strong class="ih hj"> <em class="je">的意外曝光是一种切实的威胁。没有人希望他们的服务在流量激增时失败。其实现在是最不好下去的时候！</em></strong></p><p id="21bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就我而言，谷歌分析证实了不寻常的访客涌入:</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div class="er es lk"><img src="../Images/5165124372cb1361397107eb463a4499.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*UFnWHi5AiV8mLdMqyB7cAg.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx translated">每小时的会话数</figcaption></figure><p id="70f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">高峰前的每小时流量肯定不是零(每月~6000个会话，平均每小时~8)。与峰值相比简直是小巫见大巫。</p><p id="2774" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">罪魁祸首就在几下鼠标之外，在“收购”部分:</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div class="er es ll"><img src="../Images/35f485aeba36cf93b2d16424e4443b6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:744/format:webp/1*XWDBLBLYd__qtEpPG75ihg.png"/></div></figure></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><p id="8cfa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我明白是怎么回事了，我想知道服务质量是否受到负载的影响。</p><h1 id="8099" class="jm jn hi bd jo jp lm jr js jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj bi translated">2.体系结构</h1><p id="e374" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">编程习惯用法使用以下基础结构组件:</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div class="er es lr"><img src="../Images/6578dbe989ef991a11bd02834cfe4aed.png" data-original-src="https://miro.medium.com/v2/resize:fit:558/format:webp/1*IJWSI9GVWu7rtuIOj7RNEw.png"/></div></figure><ul class=""><li id="0711" class="ls lt hi ih b ii ij im in iq lu iu lv iy lw jc lx ly lz ma bi translated"><a class="ae jd" href="https://cloud.google.com/appengine/docs/go/" rel="noopener ugc nofollow" target="_blank">带有<a class="ae jd" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go </a>语言环境的App Engine </a></li><li id="a7de" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated"><a class="ae jd" href="https://cloud.google.com/datastore/docs/concepts/overview" rel="noopener ugc nofollow" target="_blank">数据存储</a>，一个NoSQL数据库</li><li id="4968" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated"><a class="ae jd" href="https://cloud.google.com/appengine/docs/standard/go/memcache/" rel="noopener ugc nofollow" target="_blank"> Memcache </a>，分布式内存数据缓存</li></ul><p id="3fd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些组件<em class="je">本身</em>是可扩展的:App Engine根据需要旋转尽可能多的无状态web服务器实例(自动扩展，yay)，并且数据存储具有“自动管理扩展的分布式架构”。</p><p id="501d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这并不意味着我的网站不会在重压之下崩溃。需要仔细的设计和实现来正确地利用平台的可伸缩性。我的主要挑战是数据一致性:编程习惯用法接受任何人的贡献，而不需要创建一个帐户，并且当用户同时修改同一个“习语”时，我必须小心编辑冲突。</p><p id="6445" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我设计网站时使用了一些性能优化技术，考虑到了<strong class="ih hj">响应</strong>，这也正好降低了成本:</p><h2 id="2c4e" class="mg jn hi bd jo mh mi mj js mk ml mm jw iq mn mo ka iu mp mq ke iy mr ms ki mt bi translated">前端</h2><ul class=""><li id="a774" class="ls lt hi ih b ii kk im kl iq mu iu mv iy mw jc lx ly lz ma bi translated">所有响应都启用了Gzip。</li><li id="ba2a" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">JS被连接并压缩成一个文件，其中包含jQuery、Bootstrap、Prettify和我自己的JS代码。</li><li id="1f45" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">JS文件包含在HTML的底部。</li><li id="7d40" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">CSS被连接和缩小。</li><li id="6b89" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">所有静态文件都有一个很长的公共缓存头。更新静态文件是通过一种<a class="ae jd" href="https://www.stevesouders.com/blog/2008/08/23/revving-filenames-dont-use-querystring/" rel="noopener ugc nofollow" target="_blank">加速</a>技术完成的:每当我修改一个静态文件时，我会撞击静态资产的<a class="ae jd" href="https://github.com/Deleplace/programming-idioms/blob/master/pigapp/app.yaml#L20" rel="noopener ugc nofollow" target="_blank">虚拟文件夹</a>，隐式地使浏览器缓存和服务器缓存中过时的资源失效。</li><li id="1bdd" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">网站大部分是文本，只有有限数量的小图片。</li><li id="1456" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">所有页面都是服务器端呈现的。根据我的测量，模板相当快，不是瓶颈。备选方案(客户端呈现)将涉及JSON编组，这也不是免费的。</li><li id="440b" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">所有静态资源在app.yaml 中都声明为<a class="ae jd" href="https://cloud.google.com/appengine/docs/standard/go111/serving-static-files" rel="noopener ugc nofollow" target="_blank">“static _ dir”，也就是说由一个高效的分布式CDN来服务，根本不用我的App Engine服务器实例。</a></li><li id="6df4" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">HTTP请求的数量很少:10个页面请求，其中8个响应(静态资产)进入浏览器缓存，不再需要被请求。</li></ul><h2 id="6645" class="mg jn hi bd jo mh mi mj js mk ml mm jw iq mn mo ka iu mp mq ke iy mr ms ki mt bi translated">后端</h2><ul class=""><li id="640f" class="ls lt hi ih b ii kk im kl iq mu iu mv iy mw jc lx ly lz ma bi translated">数据存储是一个NoSQL文档数据库。我有大约180个“习语”,包含大约3000个片段。每个习语都存储为一个包含几个片段的文档。读取速率将远远超过写入速率。</li><li id="bc41" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">访问Memcache比访问数据存储快几个数量级。因为我总共有大约2MB的数据，所以我积极地将所有的片段存储在Memcache中。</li><li id="b67d" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">对代码片段的修改必须使缓存中的代码片段无效。缓存失效被认为是困难的。我的策略包括有选择地驱逐所有与被修改的元素相关的缓存条目(但不在每次写操作时刷新整个缓存)。</li><li id="edd4" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">从HTML模板生成页面速度很快，但仍然会产生一些工作量。我决定积极缓存(在Memcache中)所有的HTML页面。</li><li id="dabd" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">索引对搜索很重要，但不允许降低请求的处理速度。I <a class="ae jd" href="https://godoc.org/google.golang.org/appengine/delay" rel="noopener ugc nofollow" target="_blank">延迟</a>索引工作，它将被放入一个任务队列中，在用户请求的范围之外执行。</li><li id="2414" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">我保存了所有代码片段的所有后续版本的历史记录，但是写入历史记录并不重要，这也委托给了后台任务队列。</li><li id="bf16" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated"><a class="ae jd" href="https://golang.org" rel="noopener ugc nofollow" target="_blank"> Go </a>对于App Engine standard来说是个不错的选择，因为克隆启动非常快，运行时占用的内存也很少。一个<a class="ae jd" href="https://cloud.google.com/appengine/docs/standard/#instance_classes" rel="noopener ugc nofollow" target="_blank">最小级别F1 </a>的实例通常足以服务多个并发访问者。</li><li id="5a17" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">外部API调用(例如对数据库的调用)通常是无服务器实例处理web请求的延迟瓶颈。因此，利用goroutines和<a class="ae jd" href="https://golang.org/pkg/sync/#WaitGroup" rel="noopener ugc nofollow" target="_blank"> waitgroups </a>并发启动几个API调用是有意义的，因为它们是受网络限制的，而不是受CPU限制的。对于习语视图页面，我实际上不需要这样做，但是我确实使用了并发来改善文本搜索体验。</li></ul><figure class="kq kr ks kt fd ku er es paragraph-image"><div class="er es mx"><img src="../Images/55d538a22fa48594f604888c7ee42464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*x71aLqpqTAxxvJFv3JZtvw.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx translated">一个服务器实例vCPU花费大量时间处于空闲状态，即使在处理多个并发请求时也是如此，因为大部分等待时间都花在了等待外部组件上。这是一个例子；我在这个项目中不使用GCS和Pub/Sub。</figcaption></figure><p id="c548" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有关Go和云性能的更多信息，请参见本文<a class="ae jd" rel="noopener" href="/@val_deleplace/go-code-refactoring-the-23x-performance-hunt-156746b522f7">和视频</a><a class="ae jd" href="https://www.youtube.com/watch?v=b0o-xeEoug0" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="0bc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">App Engine自带丰厚的每日免费额度。事实上，我通常每月的10K浏览量很少达到配额的百分之几。</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div class="er es my"><img src="../Images/354269744ff883143637e8e80895c1a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:256/format:webp/1*AxhhF2VK_dq66omwLm5jRA.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx translated">略微担心但不太多。</figcaption></figure><p id="68f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们<em class="je">超过</em>限额时，这份免费赠品多少“掩盖了<a class="ae jd" href="https://cloud.google.com/appengine/pricing" rel="noopener ugc nofollow" target="_blank">将被收取</a>费用的事实。我不知道我将真正面对的是什么。</p><p id="0036" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是现在还不是考虑钱的时候，首先我想知道<strong class="ih hj">服务质量</strong>是否受到负载的影响。</p><h1 id="d2e0" class="jm jn hi bd jo jp lm jr js jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj bi translated">3.监视</h1><p id="93b6" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">日志视图中的[错误]级别不算太差。主要是“不支持的语言”BSOD的十几次出现。到目前为止，没有异常错误率。(不过，从UX的角度来看，我应该<a class="ae jd" href="https://github.com/Deleplace/programming-idioms/issues/79" rel="noopener ugc nofollow" target="_blank">修理这个</a>。)</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es mz"><img src="../Images/7fa387a4c1bc0d9ef0d68f80e29d0494.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YurtfovhY8bXz0arFcVofQ.png"/></div></div><figcaption class="lb lc et er es ld le bd b be z dx translated">Stackdriver日志视图中的错误级别</figcaption></figure><p id="9b57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">日志视图中的[警告]级别也不算太差。它主要由一个404组成，表示一个较小的丢失图像，哎呀。到目前为止，没有异常错误率。</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es na"><img src="../Images/4e5258e9304d3c2102e9e9d8e773480f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5xvS4SKSr4l-eKNWStuVBg.png"/></div></div><figcaption class="lb lc et er es ld le bd b be z dx translated">Stackdriver日志视图中的警告级别</figcaption></figure><p id="fedb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了获得关于服务器端性能的详细信息，我通常会使用BigQuery交互式控制台:</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es nb"><img src="../Images/0134a6d19cfe13467ba4e5f4513f1904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*prLihrkXVvz2T6lAEboj1w.png"/></div></div></figure><p id="dd23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在那里，我发现BigQuery中缺少今天的日志，过了很久我才意识到在两天前迁移到go111运行时的过程中出现了配置故障。哎呀。虽然我仍然将日志导出到云存储中，但是JSON文件不太方便挖掘。<a class="ae jd" href="https://stedolan.github.io/jq/" rel="noopener ugc nofollow" target="_blank">。/jq </a>还是朋友！</p><p id="8b78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在App Engine的延迟仪表板中，我可以检查流量峰值前后的第50、95和99个百分点。</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es nc"><img src="../Images/e7815e353588166bd9c7dbd6d278ce2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*y8Kz1mCf7N1oMflO3OJ1Dg.png"/></div></div><figcaption class="lb lc et er es ld le bd b be z dx translated">这看起来很糟糕，但实际上很好，除了第99百分位</figcaption></figure><p id="c094" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">中值</strong>延迟总是极低的(~ 2毫秒)，因为静态文件是由类似CDN的系统提供的。这很好，但也不是一个非常相关的指标。</p><p id="4969" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第95百分位的数字对我来说更重要，事实证明它一直低于100毫秒，这很好。</p><p id="8875" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，我应该检查一下为什么第99百分位的蓝绿色线条从26号之前的200毫秒上升到28号之后的1000毫秒。即使只有不到1%的请求达到这一延迟，5倍的跳跃也令人担忧。同样耐人寻味的是，降级的99%在峰值后一天进入<em class="je">，然后<em class="je">在峰值后很长时间内保持持久降级</em>。</em></p><figure class="kq kr ks kt fd ku er es paragraph-image"><a href="https://www.programming-idioms.org/about#about-block-language-coverage"><div class="er es nd"><img src="../Images/c8858f76d269ea77244fc434679f440d.png" data-original-src="https://miro.medium.com/v2/resize:fit:614/format:webp/1*5zJ5Pk6H4HUFGy137qHhCg.png"/></div></a><figcaption class="lb lc et er es ld le bd b be z dx translated">一个<a class="ae jd" href="https://www.programming-idioms.org/about#about-block-language-coverage" rel="noopener ugc nofollow" target="_blank">网格</a>为每个代码片段包含一个正方形</figcaption></figure><p id="193f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">原来，所有缓慢的请求都是为了显示一个特定的页面，该页面具有一个根据整个数据库的当前状态动态构建的网格:所有的习惯用法，所有的片段。</p><p id="bfe8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">网格数据缓存在服务器端，并且经常更新。这个特定请求有65%的时间命中缓存并且很快，有35%的时间网格重新生成并且响应时间很长。</p><p id="9804" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出于某种原因，网格现在需要多花50%的时间来提供服务，无论是在快速情况下(缓存)，还是在慢速情况下。这可能与最近迁移到App Engine第二代运行时有关，尽管在这一点上我不是100%确定。</p><p id="8534" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主页和习语的详细页面都很好:从服务器的角度来看，在流量高峰期间，它们的延迟没有降低。</p><h1 id="f3c8" class="jm jn hi bd jo jp lm jr js jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj bi translated">4.切肉刀</h1><figure class="kq kr ks kt fd ku er es paragraph-image"><div class="er es ne"><img src="../Images/f66fcc04fc66c5e4108b47bceb33b837.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*TdG85ONrdohYTgzi7b2ZOA.jpeg"/></div><figcaption class="lb lc et er es ld le bd b be z dx translated">一把菜刀(<a class="ae jd" href="https://commons.wikimedia.org/wiki/File:Foster_Cleaver.jpg" rel="noopener ugc nofollow" target="_blank">演职员表</a></figcaption></figure><h2 id="ddb6" class="mg jn hi bd jo mh mi mj js mk ml mm jw iq mn mo ka iu mp mq ke iy mr ms ki mt bi translated">在交通高峰之前</h2><p id="d11f" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">我每个月都会收到一张发票。正如我提到的，流量(6K次会议，10K浏览量)通常很容易就符合免费配额。因此，App Engine、Datastore和Memcache通常不花我一分钱。</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es nf"><img src="../Images/51c980f15e0fe64e76e8085d534e7e0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5RfJG7RzRh4sIhENiCPpMw.png"/></div></div><figcaption class="lb lc et er es ld le bd b be z dx translated">一个月的典型费用</figcaption></figure><p id="6f93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在GCS(日志)中有5GB的非关键文件，如果我想保存11个，我可以删除它们。</p><p id="9e70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你有没有注意到把我所有的日志写到BigQuery上需要0.01美元来进行分析？我强烈建议设置这个日志导出。BigQuery非常适合日志调查。</p><h2 id="5fef" class="mg jn hi bd jo mh mi mj js mk ml mm jw iq mn mo ka iu mp mq ke iy mr ms ki mt bi translated">在交通高峰之后</h2><p id="e1c2" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">9月份共有44，000次会话，16万次浏览量。其中94%发生在26号之后。</p><p id="862a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">峰值后的第六天，我收到了9月份的发票:</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div class="er es ng"><img src="../Images/d0e949f8f7e649cbcf8e7b05ae376787.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*LHUxdIxU7nY9kAzND1WRXg.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx translated">2019年9月</figcaption></figure><p id="c4fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基础设施成本最终没有让我破产。</p><p id="4b20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<em class="je">输出带宽</em>部分，有两件事让我感到惊讶:</p><ul class=""><li id="b648" class="ls lt hi ih b ii ij im in iq lu iu lv iy lw jc lx ly lz ma bi translated">起初，25GB似乎很多。让我们计算一下:25GB/160K的页面平均每页150KB。这是有意义的，因为习语的详细页面视图下载了240KB的gzipped (700KB未压缩)，主页稍微重一些(340KB)。带有热缓存的后续页面非常小:只有15KB！</li><li id="01f2" class="ls lt hi ih b ii mb im mc iq md iu me iy mf jc lx ly lz ma bi translated">如果我没记错的话，App Engine中的静态文件以前是免费提供的。我不知道这是一个错误还是一个政策，但似乎<a class="ae jd" href="https://cloud.google.com/appengine/quotas#Requests" rel="noopener ugc nofollow" target="_blank">不再是这样的</a>。静态文件可能占我的25GB出口网络流量的95%。</li></ul><p id="b6f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在这里，少了6美元，并且被一个庞大的开发人员社区所打动，他们来看看并留下来贡献他们自己的代码片段——实现一个两行代码可能看起来像是一件微不足道的小事，但实际上编写合理的代码并链接到官方文档是非常耗时的。我要衷心感谢每一个人。</p><p id="68b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想贡献一个片段，这里有一个切入点:<a class="ae jd" href="https://www.programming-idioms.org/about#about-block-language-coverage" rel="noopener ugc nofollow" target="_blank">查看网格</a>，在你熟悉的语言栏中找到一个空圈。我也鼓励你编辑现有的片段来改进它们。</p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><p id="582b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的Twitter上有更多关于技术、云和go的庆祝活动！<a class="ae jd" href="https://twitter.com/val_deleplace" rel="noopener ugc nofollow" target="_blank">https://twitter.com/val_deleplace</a></p></div></div>    
</body>
</html>