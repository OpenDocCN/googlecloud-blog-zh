<html>
<head>
<title>SAP on Google Cloud: Creating the CI/CD Pipeline (pt. 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Cloud上的SAP:创建CI/CD管道(pt。3)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/sap-on-google-cloud-creating-the-ci-cd-pipeline-pt-3-22aa6c64123?source=collection_archive---------0-----------------------#2020-08-30">https://medium.com/google-cloud/sap-on-google-cloud-creating-the-ci-cd-pipeline-pt-3-22aa6c64123?source=collection_archive---------0-----------------------#2020-08-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a833ed7b0b65ee27f5d58f81e1e2bf2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*---1Mb6D5X04Dr_W"/></div></div></figure><p id="9e18" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本帖中，我们将继续我们的CI/CD之旅。我们已经探索了主要概念(<a class="ae jo" rel="noopener" href="/@lucia.subatin/sap-on-google-cloud-when-sap-developers-join-the-cloud-pt-1-5b4e24bf24e8">第1部分</a> —包括什么是CI/CD)和我们的示例应用程序背后的思想，以及涉及HANA时的管道设计原则(<a class="ae jo" rel="noopener" href="/@lucia.subatin/sap-on-google-cloud-hana-hdi-containers-and-ci-cd-pipelines-60cedaddfbc8">第2部分</a>)。现在，我们将向您展示其中一个微服务管道的管道情况。</p><p id="416e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上图显示了我们将实施的CI/CD流。当应用程序开发人员提交代码时，它将被云构建中的触发器拾取。然后，它将构建、测试和部署我们的应用程序。让我们首先关注单个环境管道，因为稍后将它扩展到多个环境是非常简单的。</p><h1 id="68c1" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">演示应用概述</h1><p id="c1e4" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在深入管道之前，让我们快速回顾一下我们的应用程序是什么样子的:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div class="er es ks"><img src="../Images/0d260f95dd14ef82cf7ed44728976f95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1318/0*hrzUzZHYejA2B9S3"/></div></figure><p id="d341" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如在第2部分中解释的，这个应用程序有四个主要组件:</p><ol class=""><li id="972b" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">前端:web界面，允许用户访问应用程序。</li><li id="5cb7" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">后端:翻译服务</li><li id="7958" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">DAL:数据访问层</li><li id="a394" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">数据库:SAP HANA —存储我们的数据。</li></ol><p id="b7f0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上图显示了这些组件是如何相互作用的。要了解更多细节，请参阅本系列的第2部分。</p><h1 id="397d" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">我该从何说起呢？</h1><p id="ee55" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">现在你可能会想:太棒了！我们从哪里开始？我如何挑选第一个成为<em class="ll"> CI/CD'ed </em>的微服务？(没错，我就是发明了一个词……诗意许可FTW！！！)</p><p id="d163" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当第一次为现有应用程序启动CI/CD管道时，知道如何开始剖析这个庞然大物可能是一个挑战。在服务中寻找以下特征:</p><ul class=""><li id="9f9d" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lm ld le lf bi translated">相当独立，这意味着它不必在同一个应用程序中调用许多其他服务(作为其他服务的依赖是可以的)</li><li id="a89e" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lm ld le lf bi translated">一个对单元、功能和集成测试有良好测试覆盖的服务(是的——它们都很重要)</li><li id="cf15" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lm ld le lf bi translated">具有相对较低的整体复杂性</li></ul><p id="efdd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">再看一下上面的图表，你认为哪个服务最适合成为第一个？猜猜看！</p><p id="cb11" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们从后端服务开始，因为它是相当孤立的，并且经过了很好的测试。当自动化部署时，总是尝试改进您的测试以确保您的应用程序的可靠性——您未来的自己会感谢您的。</p><h1 id="b897" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">构建容器</h1><p id="3629" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">后端依赖于Golang的Google Translate API SDK这意味着我们总是需要在构建之前安装带有<code class="du ln lo lp lq b">go get</code>的SDK。我们还想运行<code class="du ln lo lp lq b">go test</code>和<code class="du ln lo lp lq b">go vet</code>作为我们测试过程的一部分。</p><p id="cc68" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云构建中的管道步骤在容器内部运行；这意味着我们可以通过创建一个包含我们需要的所有工具的定制容器来简化我们的构建。让我们继续为后端创建一个构建容器，并将其存储在容器注册表中，供以后在管道中使用。</p><p id="9dfe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你会问，为什么要这么麻烦？最终，你会想要一天运行10次甚至100次构建——所以那几秒钟被放大了。这推动了尽可能快地构建的需求。构建容器允许我们跳过构建依赖项的下载和安装步骤，从而节省时间。</p><p id="8968" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是我们的后端构建容器Dockerfile的样子:</p><pre class="kt ku kv kw fd lr lq ls lt aw lu bi"><span id="95fe" class="lv jq hi lq b fi lw lx l ly lz"># build stage<br/>FROM golang:alpine<br/>RUN apk — no-cache add build-base git bzr gcc<br/>RUN go get -u cloud.google.com/<a class="ae jo" href="https://goto.google.com/translate" rel="noopener ugc nofollow" target="_blank">go/translate</a></span><span id="8cb3" class="lv jq hi lq b fi ma lx l ly lz">ENTRYPOINT [ “/bin/ash” ]</span></pre><p id="4e0e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">额外提示:你可以通过实现<a class="ae jo" href="https://cloud.google.com/cloud-build/docs/kaniko-cache" rel="noopener ugc nofollow" target="_blank"> Kaniko缓存</a>来进一步减少构建时间。</p><h1 id="0e99" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">管道配置</h1><p id="65f9" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">现在我们有了环境，让我们检查一下管道是什么样子的:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/52b9123ef867cab93d1f1725e58d71da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_mtogi642wW-jHpJ"/></div></div></figure><p id="ea4d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于主支行，我们将:</p><ol class=""><li id="1c3f" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">使用<code class="du ln lo lp lq b">go vet</code>运行静态测试</li><li id="ce0e" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">运行单元测试<code class="du ln lo lp lq b">go test</code></li><li id="672e" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">运行功能测试(也是<code class="du ln lo lp lq b">go test</code></li><li id="1ad7" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">构建容器(<code class="du ln lo lp lq b">docker</code>)</li><li id="917c" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">将容器推入注册表(<code class="du ln lo lp lq b">docker</code>)</li><li id="f78e" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">将容器部署到环境中(<code class="du ln lo lp lq b">gcloud</code>)</li><li id="9838" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">运行集成测试(<code class="du ln lo lp lq b">go test</code>)</li></ol><p id="1735" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云构建管道通过名为<code class="du ln lo lp lq b">cloudbuild.yaml</code>的YAML文件进行配置，如下所示:</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="026f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当然，为了实现其他技术的管道，细节将会改变，但是，总体流程将保持不变。例如，当使用NodeJS测试DAL层时，命令将是<code class="du ln lo lp lq b">npm test</code>而不是<code class="du ln lo lp lq b">go test</code>等等。</p><p id="17b7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里有一些重要的考虑因素:</p><ol class=""><li id="06f0" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">每个微服务都有一个单独的管道(cloudbuild.yaml)</li><li id="e396" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">每个微服务将独立地产生它的人工制品</li><li id="2a69" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">每个微服务都应该测试与其依赖项的集成。</li></ol><p id="76c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">还记得Lucia在第2部分中解释的这个图像吗？</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/d695d27ab92a97e085b39d5c3a0121dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fGU2Ts08zvoA5CYE"/></div></div></figure><p id="8343" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">仔细查看cloudbuild.yaml，您会在每个步骤中看到一个指向后端微服务的<code class="du ln lo lp lq b">dir: translate</code>,因此它只会在我们对该文件夹进行更改时运行。有许多方法可以做到这一点，所以选择最适合您的发布和开发需求的版本。此外，请注意cloudbuild.yaml文件如何位于其相关微服务的文件夹中。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mf"><img src="../Images/a001c719005a805b690a3978ae8b381a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pbl9Jtz5M-QD1Mpq"/></div></div></figure><h1 id="b741" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">创建触发器</h1><p id="ba68" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">创建YAML文件后，在云构建中创建触发器非常简单:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div class="er es mg"><img src="../Images/4d49f5e6ec5e27a01d8f567298c84f58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/0*La8mLNbyDC-kNa8v"/></div></figure><p id="d117" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，我们将glob模式配置为仅匹配在我们的后端it为<code class="du ln lo lp lq b">translate/**</code>的情况下应用于我们的微服务文件夹内的更改。如果我们在repo中的其他文件夹中提交，这可以防止触发此触发器。</p><p id="38a6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">还可以看到我们的正则表达式是如何匹配名为<code class="du ln lo lp lq b">master</code>的分支的，对于非主分支，您可以选中“反转正则表达式”复选框。最后，云构建配置文件还专门指向我们的微服务管道定义<code class="du ln lo lp lq b">translate/cloudbuild.yaml</code></p><p id="8fa4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">到目前为止，您已经非常清楚如何为其他微服务创建管道了！</p><p id="ddab" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要将管道提交运行到正确文件夹中的存储库，您还可以选择手动运行。可以通过转到控制台并查看构建执行来查看构建日志，如下所示:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mh"><img src="../Images/857b33e96b86371fb185b4799c8589de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*d5ictjVUtZy9fABX"/></div></div></figure><h1 id="a837" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">HANA人工制品的管道</h1><figure class="kt ku kv kw fd ij er es paragraph-image"><div class="er es mi"><img src="../Images/c5f86ce26152337562262735d0871906.png" data-original-src="https://miro.medium.com/v2/resize:fit:1118/format:webp/1*lyRCTGSKY-yjhPz11iEaRQ.png"/></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">信用/来源:<a class="ae jo" href="https://icanhas.cheezburger.com/" rel="noopener ugc nofollow" target="_blank">icanhas.cheezburger.com</a></figcaption></figure><p id="44d2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">部署HANA产品的管道大部分是相同的，但有所不同……但大部分还是相同的。</p><p id="a99c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如您在第2部分中看到的，这个管道依赖于一个HDI容器和一个特殊的带有正确工具的构建容器，以允许我们连接和部署到实例。实际的<code class="du ln lo lp lq b">cloudbuild.yaml</code>文件相当简单:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mn"><img src="../Images/6d76684b39d447bdd35254cc3af0c3ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*htdbBkcNMYAejhSM"/></div></div></figure><p id="d747" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意它有一个单独的步骤(现在)。它主要依赖于准备好的构建环境和工具，如<code class="du ln lo lp lq b">hana-cli</code>和通过环境的HDI连接上下文。所有这些都是通过创建一个特定的构建容器(很像我们的后端构建容器)来完成的。</p><p id="c53d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是构建容器docker文件的外观:</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="61b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">顺便提一下，这个docker文件没有经过优化，您可能希望在使用之前对它进行一些调整。</p><p id="ce48" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意我们是如何使用所需的工具来设置容器，以便通过HDI连接到HANA的。您可以用我们创建后端构建容器的相同方式来构建这个容器。这一步很重要，因为它本质上允许我们准备好通过HDI连接和部署我们的db-things。</p><p id="f3fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另一个重要的区别是<code class="du ln lo lp lq b">npm start</code>命令是如何配置的。我们添加了退出标志，所以它不会等待一个人按下<code class="du ln lo lp lq b">Ctrl+C</code>，否则管道会挂起并超时。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/f3526b9993d270d3b7fc1bb23e4fb6c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Qh_jgrJb8iUMhdVi"/></div></div></figure><p id="e541" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些是常规微服务管道和使用HDI容器的HANA部署管道之间的主要区别。</p><p id="4184" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您应该能够为您的微服务和HANA工件构建自己的管道了！尽情享受吧！</p><p id="8f42" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://twitter.com/LuciaBlick" rel="noopener ugc nofollow" target="_blank">露西娅·苏巴丁</a>和<a class="ae jo" href="https://www.linkedin.com/in/fatimasilv/" rel="noopener ugc nofollow" target="_blank">法蒂玛·西尔韦拉</a>。</p></div></div>    
</body>
</html>