<html>
<head>
<title>Data augmentation with BigQuery and Google Knowledge Graph</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于BigQuery和Google知识图的数据扩充</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/data-augmentation-with-bigquery-and-google-knowledge-graph-f30aa74e8a00?source=collection_archive---------0-----------------------#2022-12-21">https://medium.com/google-cloud/data-augmentation-with-bigquery-and-google-knowledge-graph-f30aa74e8a00?source=collection_archive---------0-----------------------#2022-12-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="dd86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">似乎最近每个人都在谈论大型语言模型，大多数人都对他们使用语言的能力印象深刻。然而，不需要太多的努力就可以看出生成的内容非常松散地符合事实。根据使用的环境，有些人会简单地称之为读起来很愉快的小说，其他人会把它们归类为幻觉。你有没有这样的感觉，后者的数量比提供事实的来源的数量增长得更快，我们可以在这些事实的基础上建立我们的知识和决策？这种情况类似于招聘人员分享的老笑话:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/74ee63e88c000eafd587f89d128e89c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ahCeUFQg71YBi7ZOuLLfiA.png"/></div></div></figure><p id="f950" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">值得一提的一个可信的事实来源是Google知识图。它包含数十亿个条目，描述真实世界的实体，如人、地点和事物。这些实体和它们之间的关系形成了一个巨大的知识图的节点和边。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jp"><img src="../Images/662d4f26078785c6efc07685eb2cfbc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZZ5SSy-u7ff7BT1G.jpg"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">来源:<a class="ae ju" href="https://searchengineland.com/laymans-visual-guide-googles-knowledge-graph-search-api-241935" rel="noopener ugc nofollow" target="_blank">谷歌知识图搜索API的外行视觉指南</a></figcaption></figure><p id="f0d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Knowledge Graph包含在协调和合并来自多个来源的数据后创建的实体的主版本。每个这样的主实体都有一个全局唯一的标识符，称为机器ID或MID:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jv"><img src="../Images/cf20b55cb037f8466103775ac01992be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4oF2cC2YQ6EAc5hj.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">来源:<a class="ae ju" href="https://cloud.google.com/enterprise-knowledge-graph/docs/mid" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/enterprise-knowledge-graph/docs/mid</a></figcaption></figure><p id="0557" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了搜索或查找这个图表，你可以使用谷歌云上的<a class="ae ju" href="https://cloud.google.com/enterprise-knowledge-graph/docs/search-api" rel="noopener ugc nofollow" target="_blank">谷歌知识图表搜索API </a>。</p><p id="c3da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在两个版本中选择一个:<em class="jw">基础</em>和<em class="jw">高级</em>。基本版为简单起见进行了优化。它非常适合非高流量使用情形的社区应用程序，而高级版针对企业和生产使用情形进行了优化(例如增加了QPS配额)。</p><p id="1be4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将展示如何使用Google知识图搜索API来扩充(丰富)BigQuery中的数据。</p><h1 id="6d23" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">背景:</h1><p id="1dd6" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">让我们假设我们是一个全球数字市场，出售全天候即时交付的游戏钥匙——类似于我们来自Kinguin.net的朋友所做的事情。</p><p id="cd99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们想取悦我们的用户，并提供最准确的游戏描述。</p><p id="7c8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们假设我们想要用从<a class="ae ju" href="https://www.igdb.com/" rel="noopener ugc nofollow" target="_blank">https://www.igdb.com/</a>(IGDB)收集的细节来扩充我们的内部数据库，这是由<a class="ae ju" href="https://www.twitch.tv." rel="noopener ugc nofollow" target="_blank"> https://www.twitch.tv. </a>运营的公开可用的数据库</p><p id="bbb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">挑战之一是在游戏标题方面没有标准化，不同来源使用略有不同的标题来表示同一款游戏。因此，连接这样的数据集并不简单。事实上，这个问题不仅适用于游戏，也适用于所有行业。</p><p id="193c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么我们如何解决这个问题呢？一种选择是从我们的内部和IGDB数据库中查找谷歌的企业知识图，并将游戏标题映射到全球唯一的MID(知识图机器ID)。然后，可以使用这个MID来连接这两个数据集。我们还可以使用这个解决方案来获取仅在知识图中可用的附加属性。换句话说，我们将使用谷歌的知识图作为主数据来标准化和扩充我们的数据集。</p><h1 id="6422" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">高级计划:</h1><p id="fc43" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">让我们确定现有资源的基线:</p><ul class=""><li id="2915" class="la lb hi ih b ii ij im in iq lc iu ld iy le jc lf lg lh li bi translated">作为BigQuery表的游戏内部数据库</li><li id="9976" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">IGDB游戏数据库加载到大查询表</li></ul><p id="8884" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一步是用对应于Google Knowledge Graph中MID的附加列来扩展这两个集合:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lo"><img src="../Images/7b15df98c16d4748744649369d554aaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mWgRPvgjzLU6wwFp-jF5lQ.png"/></div></div></figure><p id="7c1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">为了与谷歌知识图交流，我们将使用知识图搜索API </strong>。假设我们的数据已经在BigQuery中，我们可以使用BigQuery <a class="ae ju" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/remote-functions" rel="noopener ugc nofollow" target="_blank">远程函数</a>调用这个API。远程函数可以像任何其他用户定义的函数一样在SQL查询中使用，唯一的区别是它将在后台调用云函数，我们在云函数中编写与知识图搜索API通信所需的所有逻辑，查找图并将结果(至少MID)返回给BigQuery:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lp"><img src="../Images/9947649bd0a831dc428b2d5f8c977cc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d4uA0nxI6cLKZ5raWlYdHw.png"/></div></div></figure><blockquote class="lq lr ls"><p id="2c1e" class="if ig jw ih b ii ij ik il im in io ip lt ir is it lu iv iw ix lv iz ja jb jc hb bi translated">您可能需要联系GCP技术支持，以增加对<strong class="ih hj">知识图搜索API的查询次数限制(默认情况下:每分钟60次查询)。</strong></p></blockquote><p id="8725" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以将这种机制应用于两者:表示我们内部数据库的表和表示IGDB的表。当查找知识图时，搜索API将利用模糊文本、公共关系、实体类型的任意组合来计算语义相似度，结果是相同的游戏但标题略有不同<strong class="ih hj">将被映射到相同的MID。</strong></p><p id="28e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">值得一提的是，我们还可以考虑Google Cloud上的另一个功能来查找记录之间的语义相似性，即<a class="ae ju" href="https://cloud.google.com/enterprise-knowledge-graph/docs/entity-reconciliation-console" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">实体协调API </strong> </a>:。</p><p id="9e14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过实体协调，我们能够定义直接从BigQuery表中读取数据的<strong class="ih hj">实体协调作业</strong>，并给出一些配置，将输入表列映射到一个受支持的实体类型的属性。这些作业可以处理以下内容:</p><ul class=""><li id="e4e8" class="la lb hi ih b ii ij im in iq lc iu ld iy le jc lf lg lh li bi translated">知识提取将输入的关系数据转换成知识图表示(<a class="ae ju" href="https://en.wikipedia.org/wiki/Semantic_triple" rel="noopener ugc nofollow" target="_blank"> RDF三元组</a>)。</li><li id="e24f" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">然后，Google实体协调引擎构建一个图，将实体聚类成组(同一组中具有相同聚类ID的实体被视为匹配)。</li><li id="9ddf" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">最后一步是以新的惟一标识符列(MID)的形式将链接结果(匹配和不匹配)输出到BigQuery表中。</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jv"><img src="../Images/0db210b0ebea199f9192f9f3f6b2ec32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*um6-NpWIUpB3Lhjy.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">来源:<a class="ae ju" href="https://cloud.google.com/enterprise-knowledge-graph/docs/overview#how_does_it_work" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/enterprise-knowledge-graph/docs/overview # how _ it _ work</a></figcaption></figure><p id="7c6b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实体协调通常是我们的首选，但目前它仅支持以下实体类型:个人、组织和本地业务，而我们需要视频游戏。幸运的是，其他实体类型很快就会出现。</p><p id="4ef5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当谈到谷歌知识图API支持的实体时，这个列表要长得多，并且已经包括了视频游戏。以下是你<strong class="ih hj"> </strong>也会发现的其他类型:</p><ul class=""><li id="78ad" class="la lb hi ih b ii ij im in iq lc iu ld iy le jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/Book" rel="noopener ugc nofollow" target="_blank">书</a></li><li id="f08b" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/BookSeries" rel="noopener ugc nofollow" target="_blank">书籍系列</a></li><li id="e4bf" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/EducationalOrganization" rel="noopener ugc nofollow" target="_blank">教育组织</a></li><li id="0cdd" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/Event" rel="noopener ugc nofollow" target="_blank">事件</a></li><li id="cd73" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/GovernmentOrganization" rel="noopener ugc nofollow" target="_blank">政府机构</a></li><li id="a5d4" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/LocalBusiness" rel="noopener ugc nofollow" target="_blank">本地商业</a></li><li id="b400" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/Movie" rel="noopener ugc nofollow" target="_blank">电影</a></li><li id="0041" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/MovieSeries" rel="noopener ugc nofollow" target="_blank">电影系列</a></li><li id="07e3" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/MusicAlbum" rel="noopener ugc nofollow" target="_blank">音乐剧</a></li><li id="105d" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/MusicGroup" rel="noopener ugc nofollow" target="_blank">音乐组</a></li><li id="109d" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/MusicRecording" rel="noopener ugc nofollow" target="_blank">音乐录制</a></li><li id="2be7" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/Organization" rel="noopener ugc nofollow" target="_blank">组织</a></li><li id="ad73" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/Periodical" rel="noopener ugc nofollow" target="_blank">期刊</a></li><li id="799b" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/Person" rel="noopener ugc nofollow" target="_blank">人</a></li><li id="376e" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/Place" rel="noopener ugc nofollow" target="_blank">地点</a></li><li id="f111" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/SportsTeam" rel="noopener ugc nofollow" target="_blank">体育团队</a></li><li id="f7c0" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/TVEpisode" rel="noopener ugc nofollow" target="_blank">电视插曲</a></li><li id="ca10" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/TVSeries" rel="noopener ugc nofollow" target="_blank">电视剧</a></li><li id="df12" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/VideoGame" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">电子游戏</strong> </a></li><li id="b3b9" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/VideoGameSeries" rel="noopener ugc nofollow" target="_blank">视频游戏系列</a></li><li id="fe3c" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><a class="ae ju" href="http://schema.org/WebSite" rel="noopener ugc nofollow" target="_blank">网站</a></li></ul><p id="8d6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们动手使用谷歌知识图搜索API吧！</p><h1 id="4d21" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">安装大纲:</h1><ol class=""><li id="fd5d" class="la lb hi ih b ii kv im kw iq lw iu lx iy ly jc lz lg lh li bi translated"><strong class="ih hj">首先启用适当的API:</strong></li></ol><ul class=""><li id="046c" class="la lb hi ih b ii ij im in iq lc iu ld iy le jc lf lg lh li bi translated">企业知识图API</li><li id="2e26" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">云函数API</li><li id="1804" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">云构建API</li><li id="c48a" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">记录和监控API</li><li id="c843" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">BigQuery API</li><li id="2957" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">BigQuery连接API(允许用户使用BigQuery连接到外部数据源和API)</li></ul><p id="d33e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.<strong class="ih hj">为云功能创建服务账户</strong></p><p id="cea7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要编写和部署一个云函数，当我们运行使用我们的远程函数的SQL时，它将从BigQuery作业中触发，然后它将调用知识图搜索API。</p><p id="5b8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的云功能会用服务账号来表示，服务账号必须有调用知识图搜索API的权限。</p><p id="0a6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要创建这样的服务帐户，请导航到IAM &amp; Admin &gt;服务帐户页面，单击“+ <strong class="ih hj">创建服务帐户</strong>”按钮，并提供名称和ID。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ma"><img src="../Images/b550c6b205c80b5dbd2fd3e07c6b86c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/0*MXfepy3Wxn_L7U0n"/></div></figure><p id="1a9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当创建服务帐户时，我们可以为它分配名为<strong class="ih hj">企业知识图查看器</strong>的预定义角色。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mb"><img src="../Images/5ae300c4637773a6324e790f02283e92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FI4_KS2h_UhfXaHm"/></div></div></figure><p id="87b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该角色集合了使用知识图搜索API所需的所有权限，具体包括:</p><p id="4397" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">企业知识图.云知识图实体.搜索</strong></p><p id="9690" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3。创建云功能</strong></p><p id="77df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到谷歌云控制台中的云功能仪表板，然后单击创建按钮。为您的函数取一个符合命名约定的名称，并将其余设置保留为默认值:</p><ul class=""><li id="6948" class="la lb hi ih b ii ij im in iq lc iu ld iy le jc lf lg lh li bi translated">要求身份验证，</li><li id="9e8c" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">内存和超时值</li><li id="f0ff" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">所有的连接和安全参数。</li></ul><p id="be5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了提高性能，请将云函数部署到与BigQuery数据集所在区域相同的区域。</p><p id="0bda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">唯一重要的变化是通过用我们在上一步中创建的帐户替换默认帐户来修改运行时服务帐户。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mc"><img src="../Images/82f8cbc60cd80c6fc56e6436cbb72c99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/0*yY5cAmVUsp6oR28j"/></div></figure><p id="2f6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单击“下一步”以完成此步骤，并开始与Google知识图搜索API进行编码通信。</p><p id="6fe5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，将运行时环境切换到<strong class="ih hj"> Python 3.7，</strong>，Google将为能够处理HTTP请求的入口点生成框架:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es md"><img src="../Images/c5abea324d6cdb1862005da03042158e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i3Ph9GyNY8an_1NybFzDOQ.png"/></div></div></figure><p id="2936" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们做一些改变。首先将入口点从<strong class="ih hj"> hello_world </strong>重命名为<strong class="ih hj"> ckg_lookup。</strong>然后打开requirements.txt文件，添加这两个条目<strong class="ih hj"> : </strong></p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="9550" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，修改<strong class="ih hj"> main.py </strong>并使用以下代码来验证分配给我们的云功能的服务帐户，并使用其凭证来获取访问令牌，该令牌将用于授权对Google知识图搜索API的请求:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mg"><img src="../Images/1d479e6a906bd8880c7656e8e3fbbb0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5pzHRxutoljxz3lk"/></div></div></figure><p id="a7bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，我们有了基本的云功能，它期待HTTP请求。</p><p id="3fa6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们运行SQL查询引用远程函数时，我们的云函数将被BigQuery触发。因此，现在是跳转到BigQuery控制台的好时机。</p><h2 id="95de" class="mh jy hi bd jz mi mj mk kd ml mm mn kh iq mo mp kl iu mq mr kp iy ms mt kt mu bi translated">4.将游戏标题导入BigQuery表</h2><p id="f219" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">在这篇文章中，我们希望用来自Google知识图的至少MID属性来增加或丰富我们的游戏数据。这意味着我们需要BigQuery表作为我们的游戏字典。</p><p id="7a16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于本文，让我们创建一个只有一个名为<strong class="ih hj"> title的列的BigQuery表。</strong>BigQuery中的表总是属于某个数据集，因此如果您的项目中没有big query数据集，请创建一个。我们的叫做:<strong class="ih hj">游戏_信息</strong></p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mv"><img src="../Images/940b005c6a4921ccaad64b99cbef9027.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*8SyAv84MgIstTe9DC5CZ0A.png"/></div></figure><p id="288b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们应该导航到BigQuery接口并导入我们的数据。</p><p id="3aff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下载以下<a class="ae ju" href="https://pastebin.com/raw/ceD7abaY" rel="noopener ugc nofollow" target="_blank"> csv文件</a>来实例化您的游戏字典:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="2715" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后从CSV文件创建新BigQuery表:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mw"><img src="../Images/883c208ec4432e4664269d798717b91a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D6kIuwTsXBIO-XB3hFSOzQ.png"/></div></div></figure><p id="2a19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，当您在这个表上运行simple SELECT时，您应该会看到…只是一个导入标题的列表:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mx"><img src="../Images/f23f551908585b02d753f66d41dd0896.png" data-original-src="https://miro.medium.com/v2/resize:fit:438/format:webp/1*Jecjd8lqnUmbWcr_fgn7Vw.png"/></div></figure><h2 id="1ddb" class="mh jy hi bd jz mi mj mk kd ml mm mn kh iq mo mp kl iu mq mr kp iy ms mt kt mu bi translated">5.创建BigQuery远程函数</h2><p id="a403" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">BigQuery远程函数将使您能够从SQL命令中调用云函数。每个BigQuery远程函数都需要三个元素:</p><ul class=""><li id="caae" class="la lb hi ih b ii ij im in iq lc iu ld iy le jc lf lg lh li bi translated"><strong class="ih hj"> BigQuery远程连接对象</strong> —你可以把它看作是连接BigQuery与云函数或云运行等远程资源的桥梁</li><li id="4eeb" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><strong class="ih hj">当调用/调用云函数时，具有代表我们的远程函数</strong>所需权限的服务帐户</li><li id="3c8c" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">函数定义，提供函数输入和输出的规范，并将远程连接对象与云函数或云运行端点/url链接起来。</li></ul><h2 id="6ef5" class="mh jy hi bd jz mi mj mk kd ml mm mn kh iq mo mp kl iu mq mr kp iy ms mt kt mu bi translated">5.1创建BigQuery远程连接对象</h2><p id="2c08" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">为了创建BigQuery远程连接对象，我们需要切换到云外壳。云shell配备了运行以下命令所需的所有GCP实用程序，包括<strong class="ih hj"> bq </strong>:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="cb32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，当我们返回到BigQuery工作区并展开<strong class="ih hj">外部连接</strong>树时，我们应该看到我们新创建的远程连接对象:<strong class="ih hj"> games_ekg_lookup </strong>。双击它以列出其属性:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es my"><img src="../Images/1c1c86e88966f291dc9c173b59762ff1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hlm1qQuG5DIM3KcpzSaQdA.png"/></div></div></figure><p id="b116" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们看来，最重要的属性是<strong class="ih hj">服务帐户Id </strong>。</p><p id="4843" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这意味着当我们要求BigQuery创建新的远程连接对象时，它也为这个连接创建了一个新的服务帐户。现在我们需要确保它有必要的权限来调用我们的云函数。</p><h2 id="4d1f" class="mh jy hi bd jz mi mj mk kd ml mm mn kh iq mo mp kl iu mq mr kp iy ms mt kt mu bi translated">5.2设置调用云功能的权限</h2><p id="c29b" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">为BigQuery远程连接对象创建的服务帐户需要<strong class="ih hj">cloud functions . functions . invoke</strong>权限。我们可以通过分配<strong class="ih hj">云函数调用者的角色来满足这个需求:</strong></p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mz"><img src="../Images/942b1a19148818ae5cc1c865a5f518b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:788/0*FZBSOAgfQ4MJNsdz"/></div></figure><h2 id="ce5b" class="mh jy hi bd jz mi mj mk kd ml mm mn kh iq mo mp kl iu mq mr kp iy ms mt kt mu bi translated">5.3创建BigQuery远程函数</h2><p id="b279" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">要创建一个远程函数，执行下面的<code class="du na nb nc nd b"><a class="ae ju" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create_function_statement" rel="noopener ugc nofollow" target="_blank">CREATE FUNCTION</a></code>语句。不是每个人都能创建远程功能。您需要在创建远程函数的数据集上拥有权限<code class="du na nb nc nd b">bigquery.routines.create</code>，以及<code class="du na nb nc nd b">bigquery.connections.delegate</code>权限。(可从<strong class="ih hj"> BigQuery连接管理</strong>角色获得)远程函数所使用的连接。</p><p id="6266" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">远程功能定义指定:</p><ul class=""><li id="64b4" class="la lb hi ih b ii ij im in iq lc iu ld iy le jc lf lg lh li bi translated">输入和输出属性——请注意，我们的函数返回JSON，这意味着我们将利用BigQuery对这种数据类型的本地支持</li><li id="1178" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">用于调用云函数的远程连接对象</li><li id="a0c2" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">云功能端点/url</li><li id="53a2" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">所谓的用户定义的上下文，这是一种提供键:值对列表的方式，可以在编码云函数逻辑时使用。我们将使用这个属性让Google Knowledge Search API知道我们只想关注类型为<strong class="ih hj"> VideoGame </strong>的实体</li></ul><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="4d15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要获取您的云功能URL，请转到Google Cloud Console中的云功能仪表板，单击您的功能名称，然后转到触发器选项卡。TRIGGER_URL属性的值是您希望在BigQuery远程函数定义中使用的值。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ne"><img src="../Images/96df5fbed102d1d51ad7b3c41da733fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HdqoUqnj1nRYe-SwL3qNQQ.png"/></div></div></figure><h2 id="331f" class="mh jy hi bd jz mi mj mk kd ml mm mn kh iq mo mp kl iu mq mr kp iy ms mt kt mu bi translated">6.更新云函数逻辑</h2><p id="d5f1" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">如果一切按预期运行，用我们的远程函数<strong class="ih hj"> games_ekg_lookup </strong>运行SQL查询应该会调用云函数。</p><p id="5b91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们检查这个。转到BigQuery workspace并运行如下内容:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nf"><img src="../Images/3c6ea39d2944dd1c1fe72f65cb0ea2b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e0AwL_nArHXlykB6W_oWdQ.png"/></div></div></figure><p id="f0b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在转到谷歌云控制台中的云功能仪表板，单击您的功能名称，然后转到日志选项卡。您应该会看到新条目:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ng"><img src="../Images/270e1bae614d5a54c348002752638d7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_cJop9Mypjs3PJXFWlJ6MA.png"/></div></div></figure><p id="28f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好的，这证明了所有的部分都是完整的。在第3步中，我们创建了云函数，但还没有编码与谷歌知识图搜索API的集成。相应的逻辑将包括三个步骤:</p><ul class=""><li id="fd5f" class="la lb hi ih b ii ij im in iq lc iu ld iy le jc lf lg lh li bi translated">BigQuery远程函数发送的读取请求</li><li id="eede" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">与谷歌知识图搜索API交流，使用游戏标题查找视频游戏实体</li><li id="356e" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">将结果返回给BigQuery</li></ul><p id="6b08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了正确编码这些步骤，我们需要更好地理解我们从BigQuery接收到什么，Google知识图搜索API期望的请求体是什么，以及BigQuery期望的消息体是什么。</p><p id="598c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从深入探究从BigQuery接收到的内容开始。问题是我们在哪里能抓到它。一种选择是使用与我们用于检查集成的流程相同的流程——即使用远程功能发送SQL查询，并查看云日志中记录了什么。</p><p id="cb0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果这样做，您将看到以下请求:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="cbd7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">名为<strong class="ih hj">“calls”</strong>的数组元素是我们的远程函数(游戏标题)的输入，对应于BigQuery表的<strong class="ih hj">标题列</strong>中的行。输入是成批发送的:单个请求通常包括多行——或者在<strong class="ih hj">调用</strong>数组中的多个元素。</p><p id="b94a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> userDefinedContext </strong>属性被设置为<strong class="ih hj"> VideoGame </strong>这并不奇怪，因为这是我们在BigQuery中定义远程函数时设置的值(步骤5.3)。</p><p id="3b6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当谈到BigQuery期望什么样的消息格式时，这里有一个例子:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="6925" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它期望一个名为<strong class="ih hj">的数组回复由JSON对象组成的</strong>。</p><p id="bb99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们知道了什么是输入，什么应该返回给BigQuery，我们需要用代码修改我们的云函数，以使用来自BigQuery的输入请求(第3行)，准备对Google Knowledge Graph Search API的请求(第6–16行)，遍历来自输入请求的值集合，并在对Google Knowledge Graph Search API的请求中使用它们作为查找关键字(第17–22行)。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="0f31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第28–29行使用从知识图中获取的对象集合构建JSON响应。目前——这个集合是空的，因为我们想对知识图搜索API返回的内容添加一些文字。</p><p id="55c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当调用EKG API时，我们收到大量的信息反馈。从多个标识号到简短和详细的描述或相关图像。这里解释了完整的模式<a class="ae ju" href="https://schema.org/VideoGame" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nh"><img src="../Images/f7511ad9ef4b48dd12e8ff407b95453e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wUJeFHKqOQk7Y9PXS018lg.png"/></div></div></figure><p id="7276" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们的示例中，我们只想提取一些可用属性的子集，即:游戏描述、徽标、googleKg MID(机器ID)以供将来参考，以及用于验证目的的原始名称:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="b018" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">整个main.py文件应该如下所示。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="5104" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的云功能准备好了！按下部署按钮，让谷歌为我们处理剩下的。</p><h1 id="a139" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">7.从BigQuery查询EKG</h1><p id="f292" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">我们现在准备返回到BigQuery workspace，使用我们的BigQuery remote函数来查找Google知识图，并使用知识图MID、相应的游戏描述及其图像的url来增加游戏标题。运行以下查询:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="8121" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">结果来了！</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mg"><img src="../Images/7d856dd75bfd806c60610510e870e201.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qS1_Dl_KseN88zJ6"/></div></div></figure><blockquote class="lq lr ls"><p id="91fa" class="if ig jw ih b ii ij ik il im in io ip lt ir is it lu iv iw ix lv iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi">本文由</em></strong><a class="ae ju" href="https://www.linkedin.com/in/lukasz-olejniczak-1a75a613/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"><em class="hi">Lukasz Olejniczak</em></strong></a><strong class="ih hj"><em class="hi">和</em></strong><a class="ae ju" href="https://www.linkedin.com/in/jakub-podmokly-19331ab0/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"><em class="hi">Jakub Podmokly</em></strong></a><strong class="ih hj"><em class="hi">合著。表达的观点是作者的观点，不一定反映谷歌的观点。</em> </strong></p></blockquote><p id="3d6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你喜欢这篇文章，请为它鼓掌。更多google云端数据科学、数据工程、AI/ML关注我<a class="ae ju" href="https://www.linkedin.com/in/lukasz-olejniczak-1a75a613/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"><em class="jw">LinkedIn</em></strong></a><strong class="ih hj"><em class="jw">。</em> </strong></p></div></div>    
</body>
</html>