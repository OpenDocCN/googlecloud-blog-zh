<html>
<head>
<title>How to backup a BigQuery table (or dataset) to Google Cloud Storage and restore from it</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将BigQuery表(或数据集)备份到Google云存储中并从中恢复</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-backup-a-bigquery-table-or-dataset-to-google-cloud-storage-and-restore-from-it-6ef7eb322c6d?source=collection_archive---------0-----------------------#2020-03-18">https://medium.com/google-cloud/how-to-backup-a-bigquery-table-or-dataset-to-google-cloud-storage-and-restore-from-it-6ef7eb322c6d?source=collection_archive---------0-----------------------#2020-03-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="38c7" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">将对bq命令行实用程序的调用串在一起</h2></div><p id="dd62" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> <em class="jt">注:此文已过时。BigQuery现在支持</em> </strong> <a class="ae ju" href="https://cloud.google.com/bigquery/docs/table-snapshots-intro" rel="noopener ugc nofollow" target="_blank"> <strong class="iz hj"> <em class="jt">表格快照</em> </strong> </a> <strong class="iz hj"> <em class="jt">。</em>T13】</strong></p><p id="1bc4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">BigQuery是完全托管的，负责管理存储中的冗余备份。它还支持“时间旅行”，即查询一天前的快照的能力。因此，如果ETL作业出错，而您想要恢复到昨天的数据，您只需执行以下操作:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="6135" class="ke kf hi ka b fi kg kh l ki kj">CREATE OR REPLACE TABLE dataset.table_restored<br/>AS <br/>SELECT *<br/>FROM dataset.table<br/>FOR SYSTEM TIME AS OF <br/>  TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL -1 DAY)</span></pre><p id="3b8f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，时间旅行被限制为7天。有情况(回放，法规遵从性等。)当您可能需要将表恢复到30天前或1年前的状态时。</p><figure class="jv jw jx jy fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kk"><img src="../Images/f98f5cad89fb9624b7931093589a2334.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T44MmnnjoGVuzhgLCBkTHQ.jpeg"/></div></div></figure><h2 id="a677" class="ke kf hi bd ks kt ku kv kw kx ky kz la jg lb lc ld jk le lf lg jo lh li lj lk bi translated">用于备份和恢复的Python脚本</h2><p id="f3f9" class="pw-post-body-paragraph ix iy hi iz b ja ll ij jc jd lm im jf jg ln ji jj jk lo jm jn jo lp jq jr js hb bi translated">为了方便起见，我为备份和恢复BigQuery表和数据集编写了一对Python程序<a class="ae ju" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/tree/master/blogs/bigquery_backup" rel="noopener ugc nofollow" target="_blank">和</a>。从这个GitHub存储库中获取它们:<a class="ae ju" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/tree/master/blogs/bigquery_backup" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/Google cloud platform/big query-oreilly-book/tree/master/blogs/big query _ backup</a></p><p id="4f02" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以下是脚本的使用方法:</p><p id="43d2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将表备份到GCS</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="a4f3" class="ke kf hi ka b fi kg kh l ki kj">./bq_backup.py --input dataset.tablename --output gs://BUCKET/backup</span></pre><p id="fadf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该脚本以AVRO格式将schema.json、tabledef.json和提取的数据保存到GCS。</p><p id="4cb5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您还可以备份数据集中的所有表:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="382b" class="ke kf hi ka b fi kg kh l ki kj">./bq_backup.py --input dataset --output gs://BUCKET/backup</span></pre><p id="a5d5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">通过指定目标数据集逐个还原表</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="18e4" class="ke kf hi ka b fi kg kh l ki kj">./bq_restore.py --input gs://BUCKET/backup/fromdataset/fromtable --output destdataset</span></pre><h2 id="264c" class="ke kf hi bd ks kt ku kv kw kx ky kz la jg lb lc ld jk le lf lg jo lh li lj lk bi translated">Python脚本如何工作</h2><p id="3c81" class="pw-post-body-paragraph ix iy hi iz b ja ll ij jc jd lm im jf jg ln ji jj jk lo jm jn jo lp jq jr js hb bi translated">这些脚本使用BigQuery命令行实用程序bq来组合一个备份和恢复解决方案。</p><p id="753b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae ju" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/blogs/bigquery_backup/bigquery_backup.py" rel="noopener ugc nofollow" target="_blank"> bq_backup.py </a>调用以下命令:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="5fda" class="ke kf hi ka b fi kg kh l ki kj">bq show --schema dataset.table. # schema.json<br/>bq --format=json show dataset.table.  # tbldef.json<br/>bq extract --destination_format=AVRO \<br/>           dataset.table gs://.../data_*.avro # AVRO files</span></pre><p id="8e09" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它将JSON文件和AVRO文件一起保存到谷歌云存储中。</p><p id="47b6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae ju" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/blogs/bigquery_backup/bigquery_restore.py" rel="noopener ugc nofollow" target="_blank"> bq_restore.py </a>使用表定义来查找特性，例如表是时间分区的、范围分区的还是聚集的，然后调用命令:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="f6fc" class="ke kf hi ka b fi kg kh l ki kj">bq load --source_format=AVRO \<br/>    --time_partitioning_expiration ... \<br/>    --time_partitioning_field ... \<br/>    --time_partitioning_type ... \<br/>    --clustering_fields ... \<br/>    --schema ... \<br/>    todataset.table_name \<br/>    gs://.../data_*.avro</span></pre><p id="9007" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于视图，脚本存储和恢复视图定义。视图定义是表定义JSON的一部分，要恢复它，脚本只需调用:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="7e83" class="ke kf hi ka b fi kg kh l ki kj">bq mk --view query --nouse_legacy_sql todataset.table_name</span></pre><p id="8525" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">尽情享受吧！</p><h2 id="761d" class="ke kf hi bd ks kt ku kv kw kx ky kz la jg lb lc ld jk le lf lg jo lh li lj lk bi translated">1.需要备份到谷歌云存储吗？</h2><p id="4538" class="pw-post-body-paragraph ix iy hi iz b ja ll ij jc jd lm im jf jg ln ji jj jk lo jm jn jo lp jq jr js hb bi translated">在我发表这篇文章后，安托万·卡斯在推特上回应道:</p><figure class="jv jw jx jy fd kl"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="f806" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">他完全正确。本文假设您希望在云存储上进行文件形式的备份。这可能是因为您的合规性审计员希望将数据导出到某个特定位置，也可能是因为您希望备份可由其他工具处理。</p><p id="39cd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果不需要文件形式的备份，一种更简单的备份BigQuery表的方法是使用<em class="jt"> bq cp </em>创建/恢复备份:</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="978d" class="ke kf hi ka b fi kg kh l ki kj"># backup<br/>date=...<br/>bq mk dataset_${date}<br/>bq cp dataset.table dataset_${date}.table</span><span id="80d8" class="ke kf hi ka b fi ls kh l ki kj"># restore<br/>bq cp dataset_20200301.table dataset_restore.table</span></pre><h2 id="5c7a" class="ke kf hi bd ks kt ku kv kw kx ky kz la jg lb lc ld jk le lf lg jo lh li lj lk bi translated">2.备份文件被压缩了吗？</h2><p id="2f83" class="pw-post-body-paragraph ix iy hi iz b ja ll ij jc jd lm im jf jg ln ji jj jk lo jm jn jo lp jq jr js hb bi translated">是啊！数据以Avro格式存储，Avro格式采用压缩。两个JSON文件(表定义和模式)没有被压缩，但是它们相对较小。</p><p id="083b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，我备份了一个有4亿行的BigQuery表，在BigQuery中占用了11.1 GB。当在GCS上将它存储为Avro时，同一个表被保存为47个文件，每个文件都是174.2 MB，也就是8.2 GB。这两个JSON文件总共占用了1.3 MB，基本上是四舍五入。这是有意义的，因为BigQuery存储针对交互式查询进行了优化，而Avro格式则没有。</p><h2 id="b6fc" class="ke kf hi bd ks kt ku kv kw kx ky kz la jg lb lc ld jk le lf lg jo lh li lj lk bi translated">3.你真的能在BigQuery和Avro之间来回吗？</h2><p id="b015" class="pw-post-body-paragraph ix iy hi iz b ja ll ij jc jd lm im jf jg ln ji jj jk lo jm jn jo lp jq jr js hb bi translated">BigQuery可以将大多数原始类型和嵌套重复的字段导出到Avro中。有关Avro代表权的全部细节，请参见<a class="ae ju" href="https://cloud.google.com/bigquery/docs/exporting-data#avro_export_details" rel="noopener ugc nofollow" target="_blank">文件</a>。备份工具指定了use_avro_logical_types，因此日期和时间将分别存储为日期和时间毫秒。</p><p id="cb8a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">也就是说，您应该验证备份/恢复在您的表上工作。</p></div></div>    
</body>
</html>