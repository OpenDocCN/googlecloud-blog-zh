<html>
<head>
<title>Upload public keys for GCP service accounts with terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用terraform上传GCP服务帐户的公钥</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/upload-public-keys-for-gcp-service-accounts-with-terraform-e1c87fca816e?source=collection_archive---------1-----------------------#2022-06-28">https://medium.com/google-cloud/upload-public-keys-for-gcp-service-accounts-with-terraform-e1c87fca816e?source=collection_archive---------1-----------------------#2022-06-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4b9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望你已经看过一篇很棒的文章，作者是<a class="jd je ge" href="https://medium.com/u/5a967609ab69?source=post_page-----e1c87fca816e--------------------------------" rel="noopener" target="_blank">瑞安·坎迪</a> <a class="ae jf" href="https://jryancanty.medium.com/stop-downloading-google-cloud-service-account-keys-1811d44a97d9" rel="noopener">停止下载谷歌云服务账户密钥</a>，如今有很多<a class="ae jf" href="https://cloud.google.com/iam/docs/best-practices-for-managing-service-account-keys#alternatives" rel="noopener ugc nofollow" target="_blank">替代创建服务账户密钥</a>。</p><p id="3118" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，假设您处于云采用的早期阶段，您还没有准备好涉及OIDC提供商和<a class="ae jf" href="https://cloud.google.com/iam/docs/workload-identity-federation#pools" rel="noopener ugc nofollow" target="_blank">工作负载身份池</a>。同时，本地应用程序/服务器需要一种方法来验证Google Cloud APIs。最不安全的方法是允许工程师生成服务帐户密钥，这可能导致这些密钥通过内部信使或邮箱从一个用户传到另一个用户。稍微好一点的方法是集中密钥生成，只允许通过GitOps + Terraform提供密钥，这样您就有了“集成”服务帐户管理的清晰历史。但是这种方法仍然有一些警告:</p><ul class=""><li id="26ab" class="jg jh hi ih b ii ij im in iq ji iu jj iy jk jc jl jm jn jo bi translated">密钥没有到期时间</li><li id="c396" class="jg jh hi ih b ii jp im jq iq jr iu js iy jt jc jl jm jn jo bi translated">关键材料以地形状态写入</li><li id="0286" class="jg jh hi ih b ii jp im jq iq jr iu js iy jt jc jl jm jn jo bi translated">需要将密钥传输到终端应用程序/服务器</li><li id="392c" class="jg jh hi ih b ii jp im jq iq jr iu js iy jt jc jl jm jn jo bi translated">每个能接触到terraform管道的人都能接触到钥匙</li></ul><p id="1c56" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有一个更好的方法可以处理以上所有问题！</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ju"><img src="../Images/011a401d057ce825d5b47cb88477f50a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rmnwrE8VNXgrdi3_qV8U0Q.png"/></div></div></figure><h2 id="d685" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated">通过terraform上传公共RSA密钥来管理服务帐户密钥</h2><p id="36cf" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">这个例子展示了如何通过使用<a class="ae jf" href="https://www.openssl.org/" rel="noopener ugc nofollow" target="_blank"> OpenSSL </a>手动生成密钥对并将密钥的公共部分上传到GCP来管理IAM服务帐户密钥。它有以下好处:</p><ul class=""><li id="0e75" class="jg jh hi ih b ii ij im in iq ji iu jj iy jk jc jl jm jn jo bi translated">没有<a class="ae jf" href="https://cloud.google.com/iam/docs/best-practices-for-managing-service-account-keys#pass-between-users" rel="noopener ugc nofollow" target="_blank">在用户</a>或系统之间传递密钥</li><li id="36ae" class="jg jh hi ih b ii jp im jq iq jr iu js iy jt jc jl jm jn jo bi translated">没有私钥存储在terraform状态中(只有密钥的公共部分在该状态中)</li><li id="42e0" class="jg jh hi ih b ii jp im jq iq jr iu js iy jt jc jl jm jn jo bi translated">让密钥<a class="ae jf" href="https://cloud.google.com/iam/docs/best-practices-for-managing-service-account-keys#key-expiryhaving" rel="noopener ugc nofollow" target="_blank">自动过期</a></li></ul><h2 id="5281" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated">部署</h2><p id="fc3d" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">要运行这个示例，首先克隆<a class="ae jf" href="https://github.com/terraform-google-modules/cloud-foundation-fabric" rel="noopener ugc nofollow" target="_blank">存储库</a>并切换到示例文件夹。如果你喜欢使用云Shell，<a class="ae jf" href="https://ssh.cloud.google.com/cloudshell/editor?cloudshell_git_repo=https%3A%2F%2Fgithub.com%2FGoogleCloudPlatform%2Fcloud-foundation-fabric&amp;cloudshell_print=cloud-shell-readme.txt&amp;cloudshell_working_dir=examples%2Fcloud-operations%2Fonprem-sa-key-management&amp;cloudshell_open_in_editor=cloudshell_open%2Fcloud-foundation-fabric%2Fexamples%2Fcloud-operations%2Fonprem-sa-key-management%2Fvariables.tf" rel="noopener ugc nofollow" target="_blank">这个链接</a>将为你运行Git克隆，并切换到正确的文件夹，这样你就可以跳过下面的初始步骤。</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="0511" class="kg kh hi lh b fi ll lm l ln lo">git clone <a class="ae jf" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/cloud-foundation-fabric.git</a><br/>cd <a class="ae jf" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric.git" rel="noopener ugc nofollow" target="_blank">cloud-foundation-fabric</a>/examples/cloud-operations/<a class="ae jf" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric/tree/master/examples/cloud-operations/onprem-sa-key-management" rel="noopener ugc nofollow" target="_blank">onprem-sa-key-management</a></span></pre><p id="485d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">清理示例键。</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="7835" class="kg kh hi lh b fi ll lm l ln lo">rm -f /public-keys/data-uploader/<br/>rm -f /public-keys/prisma-security/</span></pre><p id="3897" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为服务帐户生成新密钥。</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="6db7" class="kg kh hi lh b fi ll lm l ln lo">mkdir keys &amp;&amp; cd keys<br/>openssl req -x509 -nodes -newkey rsa:2048 -days 30 \<br/>    -keyout data_uploader_private_key.pem \<br/>    -out ../public-keys/data-uploader/public_key.pem \<br/>    -subj "/CN=unused"<br/>openssl req -x509 -nodes -newkey rsa:2048 -days 30 \<br/>    -keyout prisma_security_private_key.pem \<br/>    -out ../public-keys/prisma-security/public_key.pem \<br/>    -subj "/CN=unused"</span></pre><p id="93a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署服务帐户和密钥。</p><p id="2f27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lp">注意:我们只使用密钥的公共部分进行部署，理想情况下，密钥的私有部分不应该离开生成和使用它的服务器。</em></p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="eb42" class="kg kh hi lh b fi ll lm l ln lo">cd ..<br/>terraform init<br/>terraform apply -var project_id=$GOOGLE_CLOUD_PROJECT</span></pre><p id="637a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从terraform输出中提取JSON凭证模板，并将密钥的私有部分放入模板中。</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="f30c" class="kg kh hi lh b fi ll lm l ln lo">terraform show -json | jq '.values.outputs."sa-credentials".value."data-uploader"."public_key.pem" | fromjson' &gt; data-uploader.json<br/>terraform show -json | jq '.values.outputs."sa-credentials".value."prisma-security"."public_key.pem" | fromjson' &gt; prisma-security.json<br/><br/>contents=$(jq --arg key "$(cat keys/data_uploader_private_key.pem)" '.private_key=$key' data-uploader.json) &amp;&amp; echo "$contents" &gt; data-uploader.json<br/>contents=$(jq --arg key "$(cat keys/prisma_security_private_key.pem)" '.private_key=$key' prisma-security.json) &amp;&amp; echo "$contents" &gt; prisma-security.json</span></pre><h2 id="8847" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated">测试</h2><p id="395a" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">验证服务帐户json凭据是否有效。</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="50b2" class="kg kh hi lh b fi ll lm l ln lo">gcloud auth activate-service-account --key-file prisma-security.json<br/>gcloud auth activate-service-account --key-file data-uploader.json</span></pre><p id="c2d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打扫卫生。</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="c2be" class="kg kh hi lh b fi ll lm l ln lo">terraform destroy -var project_id=$GOOGLE_CLOUD_PROJECT</span></pre></div><div class="ab cl lq lr gp ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="hb hc hd he hf"><p id="e7aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">避免使用服务帐户密钥总是更好，但是在现实生活中，我们仍然不得不依赖它们。通过本文中所示的方法，我们缓解了与服务帐户密钥管理相关的大部分安全问题，例如:</p><ul class=""><li id="e9ec" class="jg jh hi ih b ii ij im in iq ji iu jj iy jk jc jl jm jn jo bi translated">密钥生成并存储在消费者服务器上，永远不会离开它</li><li id="02da" class="jg jh hi ih b ii jp im jq iq jr iu js iy jt jc jl jm jn jo bi translated">密钥的到期时间由用户设置</li><li id="67e5" class="jg jh hi ih b ii jp im jq iq jr iu js iy jt jc jl jm jn jo bi translated">密钥的私有部分不存储在地形状态或代码中</li><li id="b10a" class="jg jh hi ih b ii jp im jq iq jr iu js iy jt jc jl jm jn jo bi translated">GitOps和terraform提供了一个中央平面的玻璃上的“集成”密钥管理</li></ul></div></div>    
</body>
</html>