<html>
<head>
<title>Post-Migration Tasks in PostgreSQL: Migrating Grants and Reassigning Owners</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PostgreSQL中的迁移后任务:迁移授权和重新分配所有者</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/migrate-grants-and-reassign-owner-in-alloydb-for-postgresql-post-dms-610393731024?source=collection_archive---------1-----------------------#2022-11-10">https://medium.com/google-cloud/migrate-grants-and-reassign-owner-in-alloydb-for-postgresql-post-dms-610393731024?source=collection_archive---------1-----------------------#2022-11-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="e16b" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">它是迁移用户、角色和授权系列的一部分，是从PostgreSQL到Google Cloud PostgreSQL数据库的同构迁移的一部分。<a class="ae jh" rel="noopener" href="/google-cloud/migrate-users-with-credentials-from-cloudsql-to-another-instance-or-alloydb-for-postgresql-e377a222d3f8">查看第1部分，将用户凭证迁移到CloudSQL或AlloyDB。</a></p></blockquote><p id="2867" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated"><strong class="il hj"> <em class="ik">谷歌云数据迁移服务(DMS) </em> </strong>以最少的停机时间简化整体迁移，将谷歌云数据库组合主要迁移到PostgreSQL托管服务。对于作为源的PostgreSQL，它在内部利用pglogical扩展，并自动执行迁移模式、代码、初始回填数据和实例中所有数据库的连续更改的整个过程。</p><p id="a985" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">查看DMS产品团队发布的视频。</p><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="jq jr l"/></div><figcaption class="js jt et er es ju jv bd b be z dx translated">数据库迁移服务入门</figcaption></figure><h2 id="9d61" class="jw jx hi bd jy jz ka kb kc kd ke kf kg ji kh ki kj jj kk kl km jk kn ko kp kq bi translated">DMS在迁移到Google Cloud中PostgreSQL时执行的高级任务。</h2><p id="dc7b" class="pw-post-body-paragraph ii ij hi il b im kr io ip iq ks is it ji kt iw ix jj ku ja jb jk kv je jf jg hb bi translated">以AlloyDB为参考目标，以下是DMS执行的高级任务。</p><blockquote class="if ig ih"><p id="3881" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj"> 1。创建数据库并迁移只有模式的</strong>组件，将<strong class="il hj"> alloydbexternalsync作为所有者。</strong> <br/> 2。<strong class="il hj">创建带有节点和订户的pglogical扩展</strong>。<br/> 3。<strong class="il hj">在实例中并行启动每个数据库</strong>的回填。<br/> 4。<strong class="il hj">表格回填完成后，开始进行数据采集</strong>。<br/> 5。<strong class="il hj">监控复制延迟</strong>，一旦为0，主服务器关闭，启动升级。6。如果有，使用pglogical同步序列，并删除pglogical节点和订阅。7。<strong class="il hj">将AlloyDB实例</strong>提升为主实例。</p></blockquote><p id="74fb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">DMS迁移后作业已完成；我们对整个模式和数据组件都很满意，但是在用户和角色方面的额外任务还没有完成。如下所列</p><blockquote class="if ig ih"><p id="af1d" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">从具有相同或新凭证的源中迁移用户\角色</strong><br/><strong class="il hj">迁移</strong> <strong class="il hj">权限，包括根据源将</strong> <br/> <strong class="il hj">更改</strong>数据库对象所有者从<strong class="il hj"> alloydbexternalsync </strong>迁移到用户\角色。</p></blockquote><p id="8551" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我已经在博客上发表了如何<a class="ae jh" rel="noopener" href="/google-cloud/migrate-users-with-credentials-from-cloudsql-to-another-instance-or-alloydb-for-postgresql-e377a222d3f8"> <strong class="il hj"> <em class="ik">将具有凭证的用户从CloudSQL迁移到AlloyDB或另一个CloudSQL实例。</em></strong></a><strong class="il hj"><em class="ik"/></strong>还可以利用它将用户从PostgreSQL兼容实例迁移到CloudSQL或AlloyDB。</p><p id="bd2f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">在这篇博客中，我们将找到可行的方法和解决方案，作为迁移权限的自动化脚本，并执行必要的Alter命令来根据源代码更改所有者。</p><h2 id="fe3c" class="jw jx hi bd jy jz ka kb kc kd ke kf kg ji kh ki kj jj kk kl km jk kn ko kp kq bi translated"><strong class="ak">迁移</strong> <strong class="ak">权限包括授予和撤源。</strong></h2><p id="568c" class="pw-post-body-paragraph ii ij hi il b im kr io ip iq ks is it ji kt iw ix jj ku ja jb jk kv je jf jg hb bi translated">如果迁移到AlloyDB，我们将使用PostgreSQL客户端实用程序<a class="ae jh" href="https://www.postgresql.org/docs/current/app-pg-dumpall.html" rel="noopener ugc nofollow" target="_blank"> <em class="ik"> pg_dumpall </em> </a>从源PostgreSQL(包括CloudSQL)导出必要的授权和撤销。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es kw"><img src="../Images/47df827b52553e2af4be566c06152f5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hy_ulBSRqKoyDFmX-Fufzg.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx translated">pg_dumpall</figcaption></figure><p id="6925" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们将使用下面列出的键<em class="ik"> pg_dumpall </em>选项来迁移用户\角色相关的授权和撤销命令。</p><blockquote class="if ig ih"><p id="7910" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj"> — exclude-database </strong>:根据托管服务排除内部数据库，如从AWS迁移的rdsadmin或从cloudsql迁移到alloydb的cloudsqladmin。<strong class="il hj"> </strong> <br/> <strong class="il hj"> —无角色密码</strong>:避免仅在管理实例的情况下导出密码的异常。<br/> <strong class="il hj"> —仅架构</strong>:仅转储架构相关组件。</p></blockquote><p id="d0f8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">pg_dumpall 没有任何关于仅迁移授权的特定选项，因此我们将使用sed和grep等操作系统级命令来获得所需的输出。</p><p id="aefe" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">使用<em class="ik"> pg_dumpall </em>从CloudSQL作为源导出授权的示例命令。</p><pre class="jl jm jn jo fd ld le lf lg aw lh bi"><span id="4697" class="jw jx hi le b fi li lj l lk ll"><strong class="le hj"><em class="ik">pg_dumpall</em></strong><em class="ik"> -h &lt;&lt;instance-endpoints&gt;&gt; -U postgres </em><strong class="le hj"><em class="ik">--exclude-database="alloydbadmin|cloudsqladmin|rdsadmin" --schema-only --no-role-passwords</em></strong><em class="ik"> | sed '/cloudsqladmin/d;/cloudsqlagent/d;/cloudsqliamserviceaccount/d;/cloudsqliamuser/d;/cloudsqlimportexport/d;/cloudsqlreplica/d;/cloudsqlsuperuser/d;s/NOSUPERUSER//g' </em><strong class="le hj"><em class="ik">| grep -e '^|(GRANT\|REVOKE\|\\connect\)'</em></strong></span></pre><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lm"><img src="../Images/f7582d5ea79ba75137b5ec48c9e00e6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zWvaIoGlkVc7PyBAR8338Q.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx translated">pg_dumpall出口授权</figcaption></figure><p id="29e9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们可以使用类似的命令并进行必要的修改，以生成在DMS迁移作业完成后在迁移的数据库上执行的sql脚本。</p><h2 id="61f1" class="jw jx hi bd jy jz ka kb kc kd ke kf kg ji kh ki kj jj kk kl km jk kn ko kp kq bi translated"><strong class="ak">根据来源将</strong>数据库对象所有者从<strong class="ak"> alloydbexternalsync(适用于AlloyDB as target) </strong>更改为user\role。</h2><p id="db42" class="pw-post-body-paragraph ii ij hi il b im kr io ip iq ks is it ji kt iw ix jj ku ja jb jk kv je jf jg hb bi translated">一旦DMS迁移工作完成，您将发现所有迁移的模式对象，如表、函数、索引，包括所有者为<em class="ik"> alloydbexternalsync </em>的模式。</p><p id="18d5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">下面是在所有者为<em class="ik"> alloydbexternalsync </em>的已迁移数据库中查找所有对象的脚本构建。如果我们已经迁移到CloudSQL for PostgreSQL，可以使用相同的脚本来检查<em class="ik"> cloudsqlexternalsync </em>拥有的所有对象。</p><p id="ccff" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">它将连接到迁移实例中所有数据库，并显示由DMS创建的迁移用户拥有的数据库对象(<em class="ik"> alloydbexternalsync </em>)</p><h2 id="e11d" class="jw jx hi bd jy jz ka kb kc kd ke kf kg ji kh ki kj jj kk kl km jk kn ko kp kq bi translated">dbobj_ownerlist.sh</h2><pre class="jl jm jn jo fd ld le lf lg aw lh bi"><span id="3694" class="jw jx hi le b fi li lj l lk ll">#!/bin/bash</span><span id="eec3" class="jw jx hi le b fi ln lj l lk ll">#Argument input hostname , user and password of target PostgreSQL instance on GCP.<br/>#sh dbobj_ownerlist.sh &lt;&lt;host-endpoint-Ip&gt;&gt; &lt;&lt;user&gt;&gt; &lt;&lt;password&gt;&gt;</span><span id="29bc" class="jw jx hi le b fi ln lj l lk ll">databaseList=$(cat &lt;&lt; EOD<br/>SELECT datname FROM pg_database WHERE datname not in ('cloudsqladmin','template0','template1','alloydbadmin' , 'rdsadmin') ORDER BY datname<br/>EOD<br/>)</span><span id="910e" class="jw jx hi le b fi ln lj l lk ll">echo ${databaseList} | PGPASSWORD=$3 psql -h $1 \<br/>-d postgres \<br/>-U $2 \<br/>--no-align \<br/>-t \<br/>--field-separator '-' \<br/>-q \<br/>| while IFS='-' read databasename ; do</span><span id="c18c" class="jw jx hi le b fi ln lj l lk ll">sqlCommand=$(cat &lt;&lt;EOD<br/>SELECT '${databasename}' as DatabaseName,<br/>nsp.nspname as SchemaName<br/>,cls.relname as ObjectName<br/>,rol.rolname as ObjectOwner<br/>,CASE cls.relkind<br/>WHEN 'r' THEN 'TABLE'<br/>WHEN 'm' THEN 'MATERIALIZED_VIEW'<br/>WHEN 'i' THEN 'INDEX'<br/>WHEN 'S' THEN 'SEQUENCE'<br/>WHEN 'v' THEN 'VIEW'<br/>WHEN 'c' THEN 'TYPE'<br/>WHEN 'm' THEN 'MVIEW'<br/>WHEN 'p' THEN 'PARTITION TABLE'<br/>WHEN 'I' THEN 'PARTITION INDEX'<br/>WHEN 'f' THEN 'FOREIGN TABLE'<br/>ELSE cls.relkind::text<br/>END as ObjectType<br/>FROM pg_class cls<br/>JOIN pg_roles rol<br/>ON rol.oid = cls.relowner<br/>JOIN pg_namespace nsp<br/>ON nsp.oid = cls.relnamespace<br/>WHERE nsp.nspname NOT IN ('information_schema', 'pg_catalog')<br/>AND nsp.nspname NOT LIKE 'pg_toast%'<br/>AND rol.rolname IN ('alloydbexternalsync','cloudsqlexternalsync')<br/>UNION<br/>SELECT '${databasename}' , nsp.nspname , nsp.nspname , rol.rolname , 'SCHEMA'<br/>FROM  pg_namespace nsp INNER JOIN pg_roles rol<br/>ON nsp.nspowner = rol.oid<br/>WHERE rol.rolname IN ('alloydbexternalsync','cloudsqlexternalsync')<br/>UNION<br/>SELECT  '${databasename}' ,  N.nspname  ,  quote_ident(p.proname) ,  rol.rolname , CASE p.prokind<br/>WHEN 'f' THEN 'FUNCTION'<br/>WHEN 'p' THEN 'PROCUDURE'<br/>WHEN 'a' THEN 'AGGREGATE FUNCTION'<br/>WHEN 'w' THEN 'WINDOW FUNCTION'<br/>ELSE p.prokind::text<br/>END as ObjectType<br/>FROM   pg_catalog.pg_proc p<br/>JOIN   pg_catalog.pg_namespace n ON n.oid = p.pronamespace<br/>JOIN pg_roles rol<br/>ON   rol.oid = p.proowner<br/>WHERE  n.nspname not like 'pg_catalog%'<br/>AND rol.rolname IN ('alloydbexternalsync','cloudsqlexternalsync')<br/>order by 1,4 ,2<br/>EOD<br/>)</span><span id="6ea7" class="jw jx hi le b fi ln lj l lk ll">echo  ${sqlCommand} | PGPASSWORD=$3 psql -h $1 -U $2 -d ${databasename}</span><span id="51ed" class="jw jx hi le b fi ln lj l lk ll">done</span></pre><blockquote class="if ig ih"><p id="7844" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">sh db obj _ owner list . sh&lt;<host-endpoint-ip>&gt;&lt;<user>&gt;&lt;<password>&gt;</password></user></host-endpoint-ip></p></blockquote><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lo"><img src="../Images/6ba4fc9121625e668dc5c12d82306d63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZL_79XzxkhB8dAU4S13pfQ.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx translated">dbobj_ownerlist.sh</figcaption></figure><p id="9c39" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">在接下来的步骤中，我们将根据源数据库生成必要的ALTER命令来更改所有者。在对对象所有者的变更应用必要的变更时，我们将使用与迁移授权相同的方法，即<em class="ik"> pg_dumpall。</em></p><pre class="jl jm jn jo fd ld le lf lg aw lh bi"><span id="07a6" class="jw jx hi le b fi li lj l lk ll"><strong class="le hj"><em class="ik">pg_dumpall</em></strong><em class="ik"> -h &lt;&lt;instance-endpoints&gt;&gt;  --exclude-database="alloydbadmin|cloudsqladmin|rdsadmin" --schema-only --no-role-passwords  | sed '/cloudsqladmin/d;/cloudsqlagent/d;/cloudsqliamserviceaccount/d;/cloudsqliamuser/d;/cloudsqlimportexport/d;/cloudsqlreplica/d;/cloudsqlsuperuser/d;s/NOSUPERUSER//g' | </em><strong class="le hj"><em class="ik">grep -e</em></strong><em class="ik"> '^\(GRANT\|REVOKE\|\\connect\</em><strong class="le hj"><em class="ik">|ALTER.*OWNER.*\</em></strong><em class="ik">)'</em></span></pre><p id="09d7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">它将根据所有者和授权生成Alter。检查如下生成的示例输出。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lp"><img src="../Images/44e1e25bd80140a41a1e8af824a76d7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pdw4a_ofvELqVPJR_fPqdw.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx translated"><strong class="bd jy"> <em class="lq"> pg_dumpall —更改所有者</em> </strong></figcaption></figure><p id="a5b6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">因此，现在我们可以将上面生成的<em class="ik"> pg_dumpall </em>输出应用到迁移的目标实例，DMS迁移后的作业就完成了。</p><p id="9393" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">通过<em class="ik"> pg_dumpall </em>，我们可以组合所有关于整体用户\角色迁移的命令，包括创建、权限和根据源数据库重新分配所有者。</p><pre class="jl jm jn jo fd ld le lf lg aw lh bi"><span id="4299" class="jw jx hi le b fi li lj l lk ll"><strong class="le hj"><em class="ik">pg_dumpall</em></strong><em class="ik"> -h &lt;&lt;instance-endpoints&gt;&gt; -U postgres  --exclude-database="alloydbadmin|cloudsqladmin|rdsadmin" --schema-only --no-role-passwords  | sed '/cloudsqladmin/d;/cloudsqlagent/d;/cloudsqliamserviceaccount/d;/cloudsqliamuser/d;/cloudsqlimportexport/d;/cloudsqlreplica/d;/cloudsqlsuperuser/d;s/NOSUPERUSER//g' | grep -e '^\</em><strong class="le hj"><em class="ik">(GRANT\|REVOKE\|\\connect\|ALTER.*OWNER.*\|CREATE ROLE\|ALTER ROLE\)'</em></strong></span></pre><h2 id="44ea" class="jw jx hi bd jy jz ka kb kc kd ke kf kg ji kh ki kj jj kk kl km jk kn ko kp kq bi translated">附加注释</h2><p id="29c8" class="pw-post-body-paragraph ii ij hi il b im kr io ip iq ks is it ji kt iw ix jj ku ja jb jk kv je jf jg hb bi translated">默认情况下，每当在CloudSQL或AlloyDB之类的托管实例中创建数据库时，公共模式由cloudsqlsuperuser或alloydbsuperuser拥有。如果我们从一个托管实例迁移到AlloyDB，我们需要明确地将公共模式的所有者分配给相应的用户。</p><h2 id="2ba0" class="jw jx hi bd jy jz ka kb kc kd ke kf kg ji kh ki kj jj kk kl km jk kn ko kp kq bi translated">结论</h2><p id="62d2" class="pw-post-body-paragraph ii ij hi il b im kr io ip iq ks is it ji kt iw ix jj ku ja jb jk kv je jf jg hb bi translated">DMS迁移工作完成后，我们需要处理下面列出的用户\角色相关任务。</p><blockquote class="if ig ih"><p id="3f98" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">使用相同或新的凭证<br/> <strong class="il hj">从源中迁移用户\角色</strong>迁移</strong> <strong class="il hj">权限，包括根据源将</strong> <br/> <strong class="il hj">更改</strong>数据库对象所有者从<strong class="il hj"> alloydbexternalsync </strong>迁移到用户\角色。</p></blockquote><p id="a5a7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated"><em class="ik"> pg_dumpall </em>和脚本共享可用于启用迁移授权，并在DMS迁移作业完成后更改源中数据库对象的所有者。</p><blockquote class="if ig ih"><p id="726c" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">一旦迁移了用户或角色，围绕凭证和允许模式实施策略是非常关键的。CloudSQL包含管理数据库用户凭证的密码策略，<a class="ae jh" rel="noopener" href="/google-cloud/password-policies-with-cloudsql-for-postgresql-adf7f7e18cca">查看博客了解更多信息。</a></p></blockquote></div></div>    
</body>
</html>