<html>
<head>
<title>Cloud Spanner Change Watcher without Commit Timestamp</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">没有提交时间戳的云扳手更改观察器</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-spanner-change-watcher-without-commit-timestamp-9f149adbdd7?source=collection_archive---------2-----------------------#2020-10-20">https://medium.com/google-cloud/cloud-spanner-change-watcher-without-commit-timestamp-9f149adbdd7?source=collection_archive---------2-----------------------#2020-10-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3764" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/spanner" rel="noopener ugc nofollow" target="_blank"> Google Cloud Spanner </a>是一个全面管理、可扩展的关系数据库服务，用于区域和全球应用数据。它是第一个可扩展的、企业级的、全球分布的、高度一致的数据库服务，专为云构建，将关系数据库结构的优势与非关系水平扩展相结合。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/16400067b46aef8a444b688bcf1f44a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*t7MKxLVba5Nji_NOIKVrKw.png"/></div></figure><p id="27a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">开源的<a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher/tree/master/google-cloud-spanner-change-watcher" rel="noopener ugc nofollow" target="_blank"> spanner-change-watcher </a>库可以监控和发布云spanner数据库中数据变化的事件，作为Java应用程序的进程内服务。关于这个图书馆的一般介绍可以在<a class="ae jd" rel="noopener" href="/google-cloud/cloud-spanner-change-watcher-b77ca036459c">这里</a>找到。</p><p id="69cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文描述了如何使用Spanner Change Watcher来观察不包含和<a class="ae jd" href="https://cloud.google.com/spanner/docs/commit-timestamp#creating_and_deleting_a_commit_timestamp_column" rel="noopener ugc nofollow" target="_blank">提交时间戳列</a>的表<em class="jm">的变化。数据表中有一个提交时间戳列有利于审计，但它也有一些缺点:</em></p><ul class=""><li id="0fb3" class="jn jo hi ih b ii ij im in iq jp iu jq iy jr jc js jt ju jv bi translated">在DML语句使用<a class="ae jd" href="https://cloud.google.com/spanner/docs/functions-and-operators#pending_commit_timestamp" rel="noopener ugc nofollow" target="_blank">PENDING _ COMMIT _ TIMESTAMP()</a>函数更新提交时间戳列之后，它使得表<a class="ae jd" href="https://cloud.google.com/spanner/docs/commit-timestamp#dml" rel="noopener ugc nofollow" target="_blank">对于事务</a>的剩余部分不可读。</li><li id="49c0" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated">提交时间戳列不应是辅助索引的第一部分。</li></ul><h1 id="df9d" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">数据模型</h1><p id="7ee6" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">扳手更改监视器可以通过使用<em class="jm"> ChangeSets </em>表来监视一个或多个没有提交时间戳列的表。<em class="jm">变更集</em>表包含扳手变更观察器应该观察和报告的所有事务，实际数据表引用最后修改行的变更集。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="le lf l"/></div></figure><h1 id="5300" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">创建变更集</h1><p id="fda9" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">每个包含(或可能包含)一个或多个对应该包含在变更集中的表的变更的事务，必须在<em class="jm">变更集</em>表中创建一个记录。这可以手动完成，或者通过使用扳手变化监视器库提供的<a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher/blob/master/google-cloud-spanner-change-watcher/src/main/java/com/google/cloud/spanner/watcher/DatabaseClientWithChangeSets.java" rel="noopener ugc nofollow" target="_blank">数据库客户端包装器</a>来完成。后者将自动为每个读/写事务创建一个更改集记录。</p><h2 id="adf6" class="lg kc hi bd kd lh li lj kh lk ll lm kl iq ln lo kp iu lp lq kt iy lr ls kx lt bi translated">手动创建更改集</h2><p id="f478" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">您的应用程序可以为每个事务手动创建一个更改集记录，方法是为更改集生成一个唯一的id，并向事务添加一个变异。同一事务中的所有变更或更新都应该引用唯一的变更集id。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="le lf l"/></div></figure><h2 id="7427" class="lg kc hi bd kd lh li lj kh lk ll lm kl iq ln lo kp iu lp lq kt iy lr ls kx lt bi translated">自动创建变更集</h2><p id="31c4" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">变更集记录也可以通过使用包装的数据库客户机自动生成。这将减少变更集应用程序中锅炉板代码的数量。应用程序仍然必须为它执行的每个变异和更新添加对变更集的引用。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="le lf l"/></div></figure><h1 id="98b3" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">创建扳手观察器</h1><p id="9e0b" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">一旦您有了一个包含<em class="jm">变更集</em>表的数据模型，并且您的数据表包含对变更集的引用，您就可以创建一个扳手变更监视器，它将拾取并报告底层数据表的所有变更。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="acb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">扳手变化观察器库包含观察器的构建器，可以观察完整的数据库(<a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher/blob/master/google-cloud-spanner-change-watcher/src/main/java/com/google/cloud/spanner/watcher/SpannerDatabaseChangeSetPoller.java" rel="noopener ugc nofollow" target="_blank">SpannerDatabaseChangeSetPoller.java</a>)以及单个表格(<a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher/blob/master/google-cloud-spanner-change-watcher/src/main/java/com/google/cloud/spanner/watcher/SpannerTableChangeSetPoller.java" rel="noopener ugc nofollow" target="_blank">SpannerTableChangeSetPoller.java</a>)。</p><h1 id="a947" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">将更改发布到发布订阅</h1><p id="7d87" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">扳手变化观察器库还包含<a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher/tree/master/google-cloud-spanner-change-publisher" rel="noopener ugc nofollow" target="_blank">扳手变化发布者</a>库。这个库可以用来发布由扳手变化监视器向PubSub报告的变化。扳手变更发布者接受<a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher/blob/master/google-cloud-spanner-change-watcher/src/main/java/com/google/cloud/spanner/watcher/SpannerDatabaseChangeWatcher.java" rel="noopener ugc nofollow" target="_blank">SpannerDatabaseChangeWatcher</a>和<a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher/blob/master/google-cloud-spanner-change-watcher/src/main/java/com/google/cloud/spanner/watcher/SpannerTableChangeWatcher.java" rel="noopener ugc nofollow" target="_blank">SpannerTableChangeWatcher</a>接口的任何实现。这意味着变更集轮询器也可以用于将变更发布到PubSub。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="le lf l"/></div></figure><h1 id="8a50" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">更多样本</h1><p id="5d2f" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">请参见<a class="ae jd" href="https://github.com/cloudspannerecosystem/spanner-change-watcher/tree/master/samples" rel="noopener ugc nofollow" target="_blank">https://github . com/cloudspannerlecosystem/Spanner-change-Watcher/tree/master/samples</a>了解有关如何使用云扳手观察器和云扳手发布器的更多示例，包括以下示例:</p><ul class=""><li id="bf2e" class="jn jo hi ih b ii ij im in iq jp iu jq iy jr jc js jt ju jv bi translated">错误处理</li><li id="fb1d" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated">配置轮询间隔</li><li id="ffe8" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated">使用自定义提交时间戳存储库</li><li id="f92a" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated">使用<a class="ae jd" href="https://cloud.google.com/spanner/docs/whitepapers/optimizing-schema-design#anti-pattern_timestamp_ordering" rel="noopener ugc nofollow" target="_blank">分片</a>允许对提交时间戳列进行索引，以优化轮询</li></ul></div></div>    
</body>
</html>