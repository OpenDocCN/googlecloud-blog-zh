<html>
<head>
<title>Google Cloud Anthos Series: Anthos Config Management</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云Anthos系列:Anthos配置管理</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-anthos-series-part5-a17ce89ddc7a?source=collection_archive---------1-----------------------#2022-02-21">https://medium.com/google-cloud/google-cloud-anthos-series-part5-a17ce89ddc7a?source=collection_archive---------1-----------------------#2022-02-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="6e63" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">谷歌云系列:第5部分</h2></div><p id="88df" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi jt translated"><span class="l ju jv jw bm jx jy jz ka kb di"> W </span>欢迎来到“谷歌云Anthos系列”的第5部分。你可以在这里找到完整的系列<a class="ae kc" rel="noopener" href="/google-cloud/google-cloud-anthos-series-23b9a35e9179">。</a></p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es kd"><img src="../Images/80343f65eed65b9af444a03bf2a7a295.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dJlJTr1G3s4HD1sLo-Q3qg.png"/></div></div></figure><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es kp"><img src="../Images/6a7714065fb5ea8552a76c2de6e75c57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RuJ_R3in60P5Ccj4liU4_A.png"/></div></div></figure><p id="b980" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">设置</strong> <code class="du kq kr ks kt b"><strong class="iz hj">PROJECT_ID</strong></code> <strong class="iz hj">环境变量，确保Google Kubernetes引擎和云操作API启用。</strong></p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="6567" class="ky kz hi kt b fi la lb l lc ld">PROJECT_ID="&lt;your-project-id&gt;"<br/>gcloud services enable container.googleapis.com --project ${PROJECT_ID}<br/>gcloud services enable monitoring.googleapis.com \<br/>    cloudtrace.googleapis.com \<br/>    clouddebugger.googleapis.com \<br/>    cloudprofiler.googleapis.com \<br/>    --project ${PROJECT_ID}</span></pre><p id="c9dc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">克隆线上精品库。</strong></p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="f480" class="ky kz hi kt b fi la lb l lc ld">git clone <a class="ae kc" href="https://github.com/GoogleCloudPlatform/microservices-demo.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/microservices-demo.git</a><br/>cd microservices-demo</span></pre><p id="8715" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在三个不同的区域创建GKE集群。确保您有一个跨越至少3个区域的VPC，您希望您的集群驻留在这些区域中。</p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="5dc1" class="ky kz hi kt b fi la lb l lc ld">ZONE1=us-central1-b<br/>ZONE2=europe-west1-b<br/>ZONE3=asia-south1-b</span><span id="bb09" class="ky kz hi kt b fi le lb l lc ld">gcloud container clusters create us-gke-cluster \<br/>    --project=${PROJECT_ID} --zone=${ZONE1} \<br/>    --machine-type=e2-standard-2 --num-nodes=4 \<br/>    --scopes=cloud-platform \<br/>    <!-- -->--workload-pool=<!-- -->${PROJECT_ID}<!-- -->.svc.id.goog</span><span id="9da1" class="ky kz hi kt b fi le lb l lc ld">gcloud container clusters create eu-gke-cluster \<br/>    --project=${PROJECT_ID} --zone=${ZONE2} \<br/>    --machine-type=e2-standard-2 --num-nodes=4 \<br/>    --scopes=cloud-platform \<br/>    <!-- -->--workload-pool=<!-- -->${PROJECT_ID}<!-- -->.svc.id.goog</span><span id="73d8" class="ky kz hi kt b fi le lb l lc ld">gcloud container clusters create asia-gke-cluster \<br/>    --project=${PROJECT_ID} --zone=${ZONE3} \<br/>    --machine-type=e2-standard-2 --num-nodes=4 \<br/>    --scopes=cloud-platform \<br/>    <!-- -->--workload-pool=<!-- -->${PROJECT_ID}<!-- -->.svc.id.goog</span></pre><p id="71df" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">启用Anthos配置管理API</p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="fcc5" class="ky kz hi kt b fi la lb l lc ld">gcloud beta container hub config-management enable</span></pre><p id="6419" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建云资源存储库</p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="d3d8" class="ky kz hi kt b fi la lb l lc ld">gcloud source repos create &lt;repo name&gt;</span></pre><p id="b7a3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">确保群集的默认服务帐户PROJECT_NUMBER-compute@developer.gserviceaccount.com拥有对存储库的source.reader访问权限。</p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="d2de" class="ky kz hi kt b fi la lb l lc ld">PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format="value(projectNumber)")</span><span id="a3cd" class="ky kz hi kt b fi le lb l lc ld">gcloud projects add-iam-policy-binding ${PROJECT_ID} --member serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com --role roles/source.reader</span></pre><p id="2ab4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将线上精品应用推送到新创建的云源码库中。</p><p id="1e27" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将应用程序部署到所有集群。</p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="a8d1" class="ky kz hi kt b fi la lb l lc ld">kubectx gke_${PROJECT_ID}_${ZONE1}_us-gke-cluster<br/>kubectl apply -f ./release/kubernetes-manifests.yaml</span><span id="e445" class="ky kz hi kt b fi le lb l lc ld">kubectx gke_${PROJECT_ID}_${ZONE2}_eu-gke-cluster<br/>kubectl apply -f ./release/kubernetes-manifests.yaml</span><span id="9478" class="ky kz hi kt b fi le lb l lc ld">kubectx gke_${PROJECT_ID}_${ZONE3}_asia-gke-cluster<br/>kubectl apply -f ./release/kubernetes-manifests.yaml</span></pre><p id="a1cc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要创建约束并将文件推送到云资源存储库。</p><p id="9549" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是一个示例约束，它将拒绝创建任何特权容器。</p><p id="7849" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">文件夹结构:/all policies/policies/policy . YAML(截图)</p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="89d0" class="ky kz hi kt b fi la lb l lc ld">#policy.yaml<br/>apiVersion: constraints.gatekeeper.sh/v1beta1<br/>kind: K8sPSPPrivilegedContainer<br/>metadata:<br/>  name: psp-privileged-container<br/>spec:<br/>  match:<br/>    excludedNamespaces:<br/>    - kube-system<br/>    kinds:<br/>    - apiGroups:<br/>      - ""<br/>      kinds:<br/>      - Pod</span></pre><p id="169b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将策略推送到源代码存储库。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es lf"><img src="../Images/196fbd1ebbcc96c0a4b466b4108e0a75.png" data-original-src="https://miro.medium.com/v2/resize:fit:550/format:webp/1*74FG78VGUXeVscCZYZ91QA.png"/></div></figure><p id="6bd7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">安装Anthos配置管理，并通过GKE控制台配置策略控制器。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lg"><img src="../Images/a24e955fcd3bdeb3b714d8138741d601.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UulinrEy2xUwof4b9K63gw.png"/></div></div></figure><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lh"><img src="../Images/772111795b42cbfd92bc5e8d8e70f2c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y-gWBKkI8QZbXXjx7taRHA.png"/></div></div></figure><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es li"><img src="../Images/ccf54841277486f96c23dfa7705a613d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JSNyUeXSvqcr9NVjpRNFtg.png"/></div></div></figure><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lj"><img src="../Images/dcdbf7ae68e90bb678bb7abc2c111740.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cqcaltTl6rAhgNBEI5i8ZQ.png"/></div></div></figure><p id="7b63" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用下面的命令获取存储库的端点。我们将在下一步需要它。</p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="c960" class="ky kz hi kt b fi la lb l lc ld">gcloud source repos list</span></pre><p id="dea7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将您的云资源库的URL粘贴如下，并点击显示高级选项。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lk"><img src="../Images/87ae1a4d5068ef9dfb9ac447774ad04b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u5gS4MbGvIv0_AZHn0wv8A.png"/></div></div></figure><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es ll"><img src="../Images/7b73818ff62604e8696326eb2f09775d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p44AtLmHFxv54yeFDdUYgQ.png"/></div></div></figure><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lm"><img src="../Images/e9e92c86c08ca16322e75cb55f6d925c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_4hKQs54oGUMqDATmnB96w.png"/></div></div></figure><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es ln"><img src="../Images/acd7e179fb43675388762660a3f9e0aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XP7iiBzzMdAfjB9xQwpgsg.png"/></div></div></figure><p id="b595" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以验证Config Sync正在将此约束同步到您的GKE集群。</p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="ce6d" class="ky kz hi kt b fi la lb l lc ld">kubectx gke_${PROJECT_ID}_${ZONE1}_us-gke-cluster<br/>kubectl get constraint</span><span id="88aa" class="ky kz hi kt b fi le lb l lc ld">kubectx gke_${PROJECT_ID}_${ZONE2}_eu-gke-cluster<br/>kubectl get constraint</span><span id="2dc1" class="ky kz hi kt b fi le lb l lc ld">kubectx gke_${PROJECT_ID}_${ZONE3}_asia-gke-cluster<br/>kubectl get constraint</span></pre><p id="83ac" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您应该能够看到如下输出。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lo"><img src="../Images/7da1bce7ecf775eace6b590d511e60ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KY3qx_HURvWdXtnFaLyM4Q.png"/></div></div></figure><p id="7c7c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，让我们为拥有特权容器的pod创建一个清单(privileged.yaml)。</p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="e296" class="ky kz hi kt b fi la lb l lc ld">#privileged.yaml<br/>apiVersion: v1<br/>kind: Pod<br/>metadata:<br/> labels:<br/>   app: nginx-privileged<br/> name: nginx-privileged-disallowed<br/>spec:<br/> containers:<br/> - image: nginx<br/>   name: nginx<br/>   securityContext:<br/>     privileged: true</span></pre><p id="6cae" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">尝试将违反策略的清单部署到任何群集。</p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="0745" class="ky kz hi kt b fi la lb l lc ld">kubectx gke_${PROJECT_ID}_${ZONE1}_us-gke-cluster</span><span id="0d99" class="ky kz hi kt b fi le lb l lc ld">kubectl apply -f privileged.yaml</span></pre><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lp"><img src="../Images/b524225deb3c781458e30a80d656ed25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TVYTJtW0bVZOwGO79EVpfQ.png"/></div></div></figure><p id="d9cf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它应该会失败，并显示以下错误。</p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="7cd6" class="ky kz hi kt b fi la lb l lc ld">Error from server (Forbidden): error when creating "privileged.yaml": admission webhook "validation.gatekeeper.sh" denied the request: [psp-privileged-container] Privileged container is not allowed: nginx, securityContext: {"privileged": true}</span></pre><p id="a2bb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们在<em class="lq"> dryrun </em>模式下运行约束，我们可以通过状态字段中的以下命令查看违反情况。</p><pre class="ke kf kg kh fd ku kt kv kw aw kx bi"><span id="30de" class="ky kz hi kt b fi la lb l lc ld">kubectl get K8sPSPPrivilegedContainer psp-privileged-container -o yaml</span></pre><p id="5bfc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">即将推出..</strong></p><p id="4bfe" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这篇博客中，我们讨论了Anthos配置管理。在接下来的博客中，我们将继续Samajik的旅程和其他Anthos特性。</p><p id="866f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">供稿人:<a class="lr ls ge" href="https://medium.com/u/41b475b881ff?source=post_page-----a17ce89ddc7a--------------------------------" rel="noopener" target="_blank">施吉木尔·阿克</a>，<a class="lr ls ge" href="https://medium.com/u/c79cc28e2999?source=post_page-----a17ce89ddc7a--------------------------------" rel="noopener" target="_blank">普什卡尔·科塔瓦德</a>，<a class="lr ls ge" href="https://medium.com/u/71d9487165c6?source=post_page-----a17ce89ddc7a--------------------------------" rel="noopener" target="_blank">丹杜斯</a></p></div></div>    
</body>
</html>