<html>
<head>
<title>Connect Private Data Fusion instance with a Private Cloud SQL instance using CloudSQL proxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Cloud SQL代理将私有数据融合实例与私有云SQL实例连接起来</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/connect-private-data-fusion-instance-with-a-private-cloud-sql-instance-using-cloudsql-proxy-caddf4795ac6?source=collection_archive---------0-----------------------#2022-12-15">https://medium.com/google-cloud/connect-private-data-fusion-instance-with-a-private-cloud-sql-instance-using-cloudsql-proxy-caddf4795ac6?source=collection_archive---------0-----------------------#2022-12-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/63405e9ab39ae6bf2da3d64333f731a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_vCg5030ZUz-gb1h"/></div></div></figure><p id="4d6e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云数据融合的一个常见用例是创建一个数据管道，需要从云SQL实例中的数据库收集一些数据，当数据融合和云SQL实例都作为公共实例部署时，这很容易执行。但是，最佳实践建议是将这两个实例都部署为私有实例，以便只允许通过本地IP地址进行私有访问。本实验提供了使用SQL代理从私有云数据融合实例安全访问私有云SQL实例所需的步骤</p><h1 id="6652" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">概观</h1><p id="182e" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated"><a class="ae kr" href="https://cloud.google.com/sql" rel="noopener ugc nofollow" target="_blank">云SQL </a>是Google Cloud的托管关系型SQL数据库服务；它支持MySQL、PostgreSQL和SQL Server数据库引擎。作为一项托管服务，Google负责提供数据库所需的所有基础设施管理任务，为其分配存储并运行它，因此用户只需负责加载数据和使用数据库。</p><p id="e8d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kr" href="https://cloud.google.com/data-fusion" rel="noopener ugc nofollow" target="_blank">云数据融合</a>是谷歌云的原生低/无代码解决方案，用于创建任何规模的ETL/ELT管道。通过抽象出编写在云Dataproc集群上运行的代码的所有复杂性，并为用户提供一个点击式可视化用户界面，它可以轻松地创建和运行数据争论和转换管道。</p><p id="ee43" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上述两种服务都可以公开部署(在这种情况下，一个公共IP被分配给您在GCP的组织的域下的用户项目中的一个计算实例，因此两者之间的连接非常简单)</p><p id="b359" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">需要代理，因为云SQL网络不直接与云数据融合网络对等，并且可传递对等点无法相互通信(有关更多信息，请参见<a class="ae kr" href="https://cloud.google.com/vpc/docs/vpc-peering" rel="noopener ugc nofollow" target="_blank"> VPC文档</a>中的VPC网络对等部分)。</p><p id="8746" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些是我们将执行的任务，以便能够从私有云数据融合实例访问私有云SQL实例，从而以保密和安全的方式从中获取数据。尽管这超出了本练习的范围，但是如果您在运行本练习之前已经设置了与GCP的专用连接(使用HA VPN或任何其他类型的专用互连),通过执行这些步骤，也可以从您的本地网络以专用方式访问这两个实例。</p><h1 id="c5d8" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">我们将涵盖的内容</h1><ol class=""><li id="1a8f" class="ks kt hi is b it km ix kn jb ku jf kv jj kw jn kx ky kz la bi translated">如何使用MySQL数据库启动私有云SQL实例</li><li id="748a" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">如何启动私有云数据融合实例</li><li id="2882" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">如何启动代理计算引擎虚拟机实例，以允许云SQL和数据融合实例之间的私有连接</li><li id="339e" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">如何使用云数据融合中心提供的MySQL JDBC驱动程序创建到私有云SQL实例的连接</li></ol><h1 id="cd12" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">用于解决方案的GCP服务:</h1><ul class=""><li id="dbf8" class="ks kt hi is b it km ix kn jb ku jf kv jj kw jn lg ky kz la bi translated">谷歌云SQL。</li><li id="a35f" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn lg ky kz la bi translated">谷歌计算引擎。</li><li id="e1be" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn lg ky kz la bi translated">谷歌云数据融合。</li></ul><h1 id="6e4a" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">设置—启用所需的API</h1><p id="0aa3" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">确保启用本练习所需的所有API，在云shell中，运行下面的gcloud命令以启用以下API(您也可以通过逐个访问GCP控制台中的所有部分并在系统提示时启用每个API来这样做):</p><ul class=""><li id="f71a" class="ks kt hi is b it iu ix iy jb lh jf li jj lj jn lg ky kz la bi translated">数据融合API</li><li id="c98e" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn lg ky kz la bi translated">计算引擎API</li><li id="c3ca" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn lg ky kz la bi translated">云SQL API</li><li id="4f03" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn lg ky kz la bi translated">服务网络API</li><li id="4a29" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn lg ky kz la bi translated">SQL管理API</li><li id="cd22" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn lg ky kz la bi translated">网络管理API</li></ul><p id="27ea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过在cloud shell中运行以下命令来设置初始环境变量:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="1f00" class="lt jp hi lp b be lu lv l lw lx">export PROJECT_ID=$(gcloud config get-value project)</span></pre><p id="d8b0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，通过在cloud shell中运行以下命令，启用我们将在本实验中使用的API:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="8c3e" class="lt jp hi lp b be lu lv l lw lx">gcloud services enable \<br/>datafusion.googleapis.com \<br/>compute.googleapis.com \<br/>sql-component.googleapis.com \<br/>servicenetworking.googleapis.com \<br/>sqladmin.googleapis.com \<br/>networkmanagement.googleapis.com</span></pre><p id="00af" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:每当您需要启用API时，您可以检查可用服务列表，以找到您需要使用gcloud services list命令激活的服务，例如，您可以使用以下命令列出GCP可用的API，同时将输出限制为前1000个API:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="279f" class="lt jp hi lp b be lu lv l lw lx">gcloud services list --available --filter "NAME:googleapis" --limit 1000</span></pre><h1 id="4d46" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">创建私有云SQL MySQL实例:</h1><h1 id="f286" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">为云SQL配置私有服务访问</h1><p id="d7be" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">要创建私有云SQL实例(以及私有数据融合实例)，您需要在创建实例本身之前设置私有服务访问连接。私有服务访问连接允许您在GCP项目中定义的VPC网络与Google管理的项目(也称为<strong class="is hj">“服务提供商项目”，或“租户项目”</strong>)中的另一个VPC进行内部通信，私有云SQL实例基础架构实际驻留在该项目中。这有效地允许您从您的项目(以及从您的项目被授权并连接到的任何网络)连接到私有云SQL实例，该实例本质上没有公共IP，因此不具有其本地网络之外的任何连接性(由于其私有性质)。</p><p id="0fd7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您创建私有服务访问连接时，您分配了一个IP范围，Google将使用该范围将私有IP分配给私有实例。Google将根据您定义的分配范围创建一个子网，以便在某个区域提供资源。您可以分配的最小CIDR块是/24，但建议至少分配一个/16块。</p><p id="8e95" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">实际上，这在您的GCP项目中的VPC和从您分配给Google管理的服务生产者项目使用的IP范围中创建的VPC之间创建了一个VPC对等。</p><p id="0a3a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下图描述了这在示例部署中是如何工作的:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/48fec6849463e345d3e92f332ece3d05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kwzsuaYbQ3l5BMWk"/></div></div></figure><p id="8857" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，每个Google服务都从定义的范围创建一个子网，在其中提供资源。子网的IP地址范围通常是由服务选择的/24 CIDR块，来自分配的IP地址范围。您不能修改服务生成器的子网。GCP的一项服务在该服务先前创建的现有区域子网中提供新资源。如果子网已满，该服务将在同一区域创建一个新的子网。</p><p id="1ec5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这意味着同一子网不能分配给其他服务(如数据融合)。对于两个服务之间的本地通信，每个服务都需要一个从服务提供商GCP项目到您的GCP项目的独立连接。</p><p id="ea44" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果在创建任何私有实例之前没有设置此连接，则在尝试创建实例时，您将面临以下警告:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lz"><img src="../Images/2f81fc6ffcb15bc5299de5077339fa09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eb09LEj_CVmXj_DO"/></div></div></figure><p id="529d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:虽然在本练习中并非如此，但如果在您自己的部署中使用共享VPC，您还需要在共享VPC网络主机项目中启用服务网络API，您可以通过要求该项目中的网络管理员运行所需的gcloud命令来实现:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="5124" class="lt jp hi lp b be lu lv l lw lx">gcloud services enable servicenetworking.googleapis.com</span></pre><p id="8777" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本实验中，我们将对私有云SQL实例连接使用10.30.1.0/24范围。</p><h1 id="c692" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">为云SQL分配IP地址范围</h1><p id="6821" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在cloud shell中运行以下命令(或者，您可以使用控制台中的UI来执行这些步骤):</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="80ce" class="lt jp hi lp b be lu lv l lw lx">gcloud compute addresses create google-managed-services-default \<br/>--global \<br/>--purpose=VPC_PEERING \<br/>--addresses=10.30.1.0 \<br/>--prefix-length=24 \<br/>--network=projects/$PROJECT_ID/global/networks/default</span></pre><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/e4178fe97f599dc9f4d1f860920b7c9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*u6dr3z1wrkjwJdzE"/></div></div></figure><p id="b849" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建后，您可以在VPC网络部分的内部IP地址子部分检查IP分配:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/9ecc68e5585c4a7af7841db50d548d66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nyQ7XhFCx2OV6XNY"/></div></div></figure><h1 id="29bc" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">创建私有连接</h1><p id="9f43" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">现在您已经创建了IP分配，您可以在项目中的VPC和您刚刚分配的IP范围之间创建VPC对等连接。在云shell中运行以下命令:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="eae6" class="lt jp hi lp b be lu lv l lw lx">gcloud services vpc-peerings connect \<br/>--service=servicenetworking.googleapis.com \<br/>--ranges=google-managed-services-default \<br/>--network=default \<br/>--project=$PROJECT_ID</span></pre><p id="af8a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">几分钟后，操作将完成。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/e11fc578816ef690e270a11b99100fb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*s8b0E8WFHh1kEFTy"/></div></div></figure><p id="6c22" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您还应该能够在云控制台中看到VPC对等，特别是在VPC网络对等部分。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/30af97b3e075f19978a17dfc7aa6e26c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SYFcWZJ6ts32chm6"/></div></div></figure><h1 id="6d85" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">参考上一步中创建的私有服务访问连接，创建私有云SQL实例</h1><p id="42d8" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">首先，确保设置了所有必需的环境变量:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="e5e4" class="lt jp hi lp b be lu lv l lw lx">export INSTANCE_ID=$(echo test-private-cloudsql) \<br/>export PROJECT_ID=$(gcloud config get-value project) \<br/>export VPC_NETWORK_NAME=$(echo default) \<br/>export RANGE_NAME=$(echo google-managed-services-$VPC_NETWORK_NAME) \<br/>export DB_PASSWORD=(echo [YOUR_DB_PASSWORD])</span></pre><p id="1115" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在Cloud shell中运行以下命令，启动私有云SQL实例配置过程。这需要几分钟时间:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="c175" class="lt jp hi lp b be lu lv l lw lx">gcloud beta sql instances create $INSTANCE_ID \<br/>--project=$PROJECT_ID \<br/>--network=projects/$PROJECT_ID/global/networks/$VPC_NETWORK_NAME \<br/>--database-version=MYSQL_8_0 \<br/>--cpu=2 \<br/>--memory=4GB \<br/>--region=us-central1 \<br/>--no-assign-ip \<br/>--root-password=$DB_PASSWORD \<br/>--allocated-ip-range-name=$RANGE_NAME</span></pre><p id="d28a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">几分钟后，实例达到可运行状态，这意味着它可以使用了:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/24f6fbafa904cd67b37d000b808fec32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QYVdvEVUhHfxlLrj"/></div></div></figure><p id="ba2b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在云控制台中，您还应该能够看到实例已经创建，它已经通过从我们之前创建的分配中选择一个IP来设置其私有IP地址，并且已经使用私有服务访问连接到对等设备:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/cc502233545bd959814103e6b1489c8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6kMc82jU2Fpukt68"/></div></div></figure><h1 id="e3a3" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">创建私有数据融合实例</h1><h1 id="13ba" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">授予Google管理的数据融合服务帐户所需的权限，以便它可以生成Dataproc集群。</h1><p id="6e0b" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我们需要授予Data Fusion服务帐户启动Dataproc集群的权限。如果我们不这样做，我们的数据融合管道将会失败。当您转到UI中的数据融合部分中的创建实例向导时，如果您没有授予将用于创建Dataproc集群的服务帐户的数据融合权限，您将会得到如下图所示的警告(默认情况下是计算引擎服务帐户，我们可以在IAM &amp; Admin页面的服务帐户部分检查这一点，其格式如下所示:[PROJECT_NUMBER]-compute@developer.gserviceaccount.com)</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/096f6887a96ea976a7c5cffad60bdbf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Zcc8Ge-RJGgwgSkd"/></div></div></figure><p id="bfbb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">您只需点击授予权限按钮(确保在该警告下方的下拉框中选择了计算服务帐户):</strong></p><p id="4493" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">或者，</strong>您可以遵循此文档并使用<a class="ae kr" href="https://cloud.google.com/data-fusion/docs/how-to/granting-service-account-permission?_ga=2.97242134.-86038369.1663269464" rel="noopener ugc nofollow" target="_blank">云控制台</a>、<strong class="is hj">或</strong>中IAM部分的UI授予所需的权限。您可以在云外壳中执行以下命令:</p><p id="474a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">(可选)首先获取服务代理电子邮件地址:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="3836" class="lt jp hi lp b be lu lv l lw lx">export PROJECT_ID=$(gcloud config get-value project)<br/>export PROJECT_NUMBER=$(gcloud projects list --filter="$PROJECT_ID" --format="value(PROJECT_NUMBER)")<br/>export DATAFUSION_SA=$(echo service-$PROJECT_NUMBER@gcp-sa-datafusion.iam.gserviceaccount.com)<br/>export COMPUTE_SA=$(echo $PROJECT_NUMBER-compute@developer.gserviceaccount.com)</span></pre><p id="bac4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">(可选)现在，授予代理所需的权限:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="16af" class="lt jp hi lp b be lu lv l lw lx">gcloud iam service-accounts add-iam-policy-binding \<br/>            $COMPUTE_SA \<br/>            --member='serviceAccount:'$DATAFUSION_SA'' \<br/>            --role='roles/iam.serviceAccountUser'</span></pre><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/19dff6e633b0d3576bf5703ac1d947ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*khj70Sg1P2cTvRUU"/></div></div></figure><p id="d862" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:如果您在导航到数据融合部分时看到此提示，您可能还没有启用API:</strong></p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/988249981d222c77024faed073f52f3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*T6uh1ZlqVlv3OkNo"/></div></div></figure><h1 id="547e" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">部署私有数据融合实例</h1><p id="f7c6" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在本练习中，我们将使用数据融合API创建一个私有实例。</p><p id="e1ce" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先设置一些环境变量，这些变量将在以后调用API时使用:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="3eec" class="lt jp hi lp b be lu lv l lw lx">export PROJECT_ID=$(gcloud config get-value project)<br/>export LOCATION="us-central1"<br/>export DATA_FUSION_API_NAME=datafusion.googleapis.com<br/>export DF_INSTANCE_ID=test-private-datafusion</span></pre><h1 id="1587" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">为数据融合分配IP地址范围</h1><p id="05b4" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">与创建私有云SQL实例时一样，我们必须为数据融合分配一个IP范围，默认情况下，数据融合使用/22范围在租户项目中部署其内部组件。<strong class="is hj">在这种情况下，将使用范围10.40.0.0/22。</strong>运行此命令创建IP分配:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="aa2c" class="lt jp hi lp b be lu lv l lw lx">gcloud compute addresses create google-managed-services-default-df \<br/>--global \<br/>--purpose=VPC_PEERING \<br/>--addresses=10.40.0.0 \<br/>--prefix-length=22 \<br/>--network=projects/$PROJECT_ID/global/networks/default</span></pre><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/53a86d6cc04ff5d6fe99f80f56f9b4dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NGbo2aOycvIRMBwg"/></div></div></figure><h1 id="8d1d" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">使用API创建数据融合实例</h1><p id="eb42" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">要使用API创建实例，请在Cloud shell中运行以下cURL命令:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="2b68" class="lt jp hi lp b be lu lv l lw lx">curl -H "Authorization: Bearer $(gcloud auth print-access-token)" -H "Content-Type: application/json" https://$DATA_FUSION_API_NAME/v1/projects/$PROJECT_ID/locations/$LOCATION/instances?instance_id=$DF_INSTANCE_ID -X POST -d '{"description": "Private CDF instance created through REST.", "type": "BASIC", "privateInstance": true, "networkConfig": {"network": "default", "ipAllocation": "10.40.0.0/22"}}'</span></pre><p id="bda6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">API接收请求并开始处理它:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/a74a19d531fa77fe975813594ebf02e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UlxYAYOxTqqdPSr8"/></div></div></figure><p id="0dc5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以在GCP的数据融合部分看到正在创建的实例:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/e79b40528eeeebc0ef681a335eb92383.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EZoFhHP8wOlImFGO"/></div></div></figure><p id="a646" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:创建实例大约需要20分钟。</p><p id="1531" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦实例创建过程结束，我们将启动并运行云SQL和数据融合私有实例。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/2923c8e4bb4f0490be88fcc179d03c82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WvexJIz_ENPeaMm9"/></div></div></figure><p id="70af" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这里，通过单击实例名称，我们可以看到创建该实例的详细信息，请注意，它使用了我们之前保留的IP地址分配(10.40.0.0/22)。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/27d4a07e870e8765cbdca22d6053006e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j1qvzmwVU-h7jqD4"/></div></div></figure><p id="f536" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在实例详细信息页面中，<strong class="is hj">记下运行数据融合实例的TENANT_PROJECT_ID </strong>，我们将在下一步中用到它。我们可以在@符号和下一个点之间的<strong class="is hj">服务帐户</strong>字段中找到它，就在<em class="md">" . iam . gserviceaccount . com "</em>之前，它通常以<em class="md">-TP "</em><strong class="is hj"/>"结尾(在上面的示例中，它将是"<strong class="is hj"> eh3a2c2bf9e20v09d-tp </strong>")</p><h1 id="ff0c" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">在本地VPC和为数据融合分配的范围之间创建VPC对等</h1><p id="e56f" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">因为在创建云SQL实例期间已经创建了私有服务访问的对等关系，而Data Fusion并不使用这一点，而是需要不同的VPC对等关系，所以我们不能使用之前创建这一新连接时使用的相同g Cloud Services VPC-peerings connect命令。云数据融合使用项目中本地VPC和Google管理的租户项目之间的VPC对等，其中数据融合实例在自己的远程VPC中运行。为了在您的本地网络和运行Data Fusion的网络之间创建VPC对等，我们需要收集两件东西:</p><p id="420d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1)运行数据融合实例的远程项目ID(称为“租户项目”，我们在上一步中从数据融合实例详细信息页面中检索到它)。</p><p id="4cee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2)租户项目中的远程网络:它是在数据融合私有实例创建时自动为我们生成的，并且采用以下命名:<region> - <data_fusion_instance_name/></region></p><p id="ad31" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在cloud shell中运行以下命令，在本地VPC和运行Data Fusion的租户项目中的对等VPC之间创建VPC对等关系:</p><p id="da4f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:记住用上一步中检索到的租户项目ID替换[YOUR-TENANT-PROJECT-ID]值。</strong></p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="2128" class="lt jp hi lp b be lu lv l lw lx">export TENANT_PROJECT=[YOUR-TENANT-PROJECT-ID]</span></pre><pre class="me lo lp mf mg aw mh bi"><span id="30f3" class="mi jp hi lp b fi mj mk l ml lx">export LOCATION="us-central1"</span><span id="1472" class="mi jp hi lp b fi mm mk l ml lx">gcloud compute networks peerings create peering-private-datafusion \<br/>    --network=default \<br/>    --peer-project $TENANT_PROJECT \<br/>    --peer-network $LOCATION-$DF_INSTANCE_ID</span></pre><p id="6c16" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您应该在控制台的VPC网络对等部分看到新的对等:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mn"><img src="../Images/a940d797e33ad27f8f87096d8315cb57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DBf2yIhSTX5v3pQ-"/></div></div></figure><h1 id="31f6" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">在我们的本地VPC子网启用私人谷歌访问</h1><p id="07c4" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">为了让数据融合管道正常运行，我们需要在对云SQL和数据融合都对等的子网中启用私有Google访问。否则，当我们在数据融合中运行管道时，管道将在尝试提供Dataproc集群时被卡住。</p><p id="5078" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在云Shell中运行以下命令:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="ca04" class="lt jp hi lp b be lu lv l lw lx">export SUBNET_NAME=default<br/>export REGION=us-central1</span></pre><pre class="me lo lp lq bn lr ls bi"><span id="5017" class="lt jp hi lp b be lu lv l lw lx">gcloud compute networks subnets update $SUBNET_NAME \<br/>--region=$REGION \<br/>--enable-private-ip-google-access</span></pre><p id="5bb6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">导航到控制台中的云SQL部分，记下IP地址云SQL(在本例中，它为实例分配了IP地址10.30.1.3):</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/5b83a97f00480f1d2a76b11377196876.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MtB0nXjz1jQpdeK2"/></div></div></figure><h1 id="e8a0" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">创建云SQL代理虚拟机</h1><p id="5a8e" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">由于云SQL和数据融合实例都与GCP项目中的本地VPC对等(如下图所示，默认子网范围为us-central1，10.128.0.0/20)，因此这两个实例都可以从该网络访问，也可以访问该网络(这意味着任何资源，如从10.128.0.0/20网络通信的虚拟机，都应该能够独立地与云SQL和数据融合专用实例通信)。</p><p id="60f0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，由于网络对等点不会将网络路由转发到网络对等点之外，因此云SQL实例无法直接与数据融合实例通信，因为两个网络对等点会导致传递性问题。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/383246d29632ff0520757f42a4e6fe98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Bum9dm2f5oLCK3qt"/></div></div></figure><p id="b128" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上图显示，通过前面步骤中创建的私有服务访问连接，两个连续的对等点位于数据融合到达云SQL所需的网络路径中，导致数据融合无法到达云SQL，因为根据网络设计，VPC对等点是不可传递的。为了解决这个问题，需要在本地VPC (10.128.0.0/20)中部署一个虚拟机代理，以在两个网络(即数据融合的10.40.0.0/22和云SQL的10.30.1.0/24)之间传播路由。下图显示了该设置的外观:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/53780048830412a75135b37ffa8df42c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uw6_t1C6DCXCaiLF"/></div></div></figure><h1 id="ecd0" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">导出初始变量</h1><p id="fe49" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">首先，导出我们将在后续步骤中使用的变量:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="46ee" class="lt jp hi lp b be lu lv l lw lx">export PROJECT_ID=$(gcloud config get-value project)<br/>export REGION=us-central1<br/>export ZONE=`gcloud compute zones list --filter="name=${REGION}" --limit 1 --uri --project=${PROJECT}| sed 's/.*\///'`<br/>export NETWORK=default <br/>export SUBNET=default<br/>export INSTANCE_NAME=cloudsql-proxy<br/>export SQL_CONN=private-datafusion-to-cloudsql:us-central1:test-private-cloudsql<br/>export CDF_IP_RANGE=10.40.0.0/22<br/>export VM_IMAGE=$(gcloud compute images list --project=$PROJECT | grep cos-stable | awk 'NR&lt;2{print $2}')<br/>export SQL_PORT=3306 Important Note:</span></pre><p id="0718" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要获取“SQL_CONN”环境变量的值，我们可以从GCP控制台的云SQL部分的实例详细信息中的<strong class="is hj">“连接名称”</strong>字段获取:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/82d80b5103281b57c454a3d784e19932.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rbAH_VeXAHsjE-E1"/></div></div></figure><p id="39a7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建防火墙规则以允许数据融合进入流量。在云Shell中运行以下命令:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="c70a" class="lt jp hi lp b be lu lv l lw lx">gcloud compute firewall-rules create allow-private-cdf \<br/> --allow=tcp:22,tcp:${SQL_PORT} \<br/> --source-ranges=$CDF_IP_RANGE --network=$NETWORK --project=$PROJECT_ID</span></pre><p id="70c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您的输出应该如下所示:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/b4b5cb3e488d0d31f0c562418bec0a93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MKus9_ll8ZK5JzpH"/></div></div></figure><p id="e34f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您应该能够看到在名为“allow-private-cdf”的控制台中创建了新的防火墙规则，并允许在端口22和3306:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/a62068c5a35ecf357c7548a195d825fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wsymEv3c6b7EDpVC"/></div></div></figure><p id="7f29" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在云shell中使用以下gcloud命令创建代理虚拟机:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="b00f" class="lt jp hi lp b be lu lv l lw lx">gcloud compute --project=${PROJECT} instances create ${INSTANCE_NAME} \<br/> --zone=${ZONE} \<br/> --machine-type=g1-small \<br/> --subnet=${SUBNET} \<br/> --metadata=startup-script="docker run -d -p 0.0.0.0:${SQL_PORT}:${SQL_PORT} gcr.io/cloudsql-docker/gce-proxy:latest /cloud_sql_proxy -instances=${SQL_CONN}=tcp:0.0.0.0:${SQL_PORT}" \<br/> --maintenance-policy=MIGRATE \<br/> --scopes=https://www.googleapis.com/auth/cloud-platform \<br/> --image=${VM_IMAGE} \<br/> --image-project=cos-cloud</span></pre><p id="c440" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您应该会看到如下输出:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/5d8465cd4a532f0ed6ab6dd7587c6ffd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rAWhER4gMIZ9wzCH"/></div></div></figure><p id="8dd2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，导出一个变量来保存分配给虚拟机的内部IP地址，这样我们就可以将它作为一个为这台机器保留的静态IP。在云Shell中运行:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="2573" class="lt jp hi lp b be lu lv l lw lx">export IP=`gcloud compute \<br/> --project=${PROJECT} instances describe ${INSTANCE_NAME} \<br/> --zone ${ZONE} | grep "networkIP" | awk '{print $2}'`</span></pre><p id="0d32" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">运行以下命令保留虚拟机IP:</p><pre class="lk ll lm ln fd lo lp lq bn lr ls bi"><span id="f7a8" class="lt jp hi lp b be lu lv l lw lx">gcloud compute --project=${PROJECT} addresses create mysql-proxy \<br/> --addresses ${IP} --region ${REGION} --subnet ${SUBNET}</span></pre><p id="7a8b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以在GCP控制台的VPC网络部分的IP地址列表中看到该IP被列为静态IP(您还可以看到虚拟机的外部IP(被列为临时IP):</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/4c0d270f9ccc84d95eb1da740daba0bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*COwM9tdubbRoa2rx"/></div></div></figure><p id="0ffa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意，这个内部静态IP是您从现在开始将要用来建立到云SQL实例的连接的IP。</strong></p><h1 id="7c44" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">从数据融合连接到云SQL</h1><p id="d65e" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">导航到GCP控制台中的云数据融合部分，单击“查看实例”操作URL以访问数据融合UI。</p><p id="cfbb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">URL应该是这样的:</p><p id="6382" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kr" href="https://test-private-datafusion-private-datafusion[PROJECT_NUMBER]-dot-usc1.datafusion.googleusercontent.com/" rel="noopener ugc nofollow" target="_blank">https://test-private-data fusion-private-data fusion[PROJECT _ NUMBER]-dot-us C1 . data fusion . Google user content . com/</a></p><h1 id="de19" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">为MySQL安装JDBC连接器</h1><p id="7acf" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在云数据融合用户界面中，单击欢迎弹出窗口中的“不，谢谢”按钮:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/830bdbf09df57bf5e14ad98c45c2d534.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lmuc6JJABJKVi--7"/></div></div></figure><p id="9ef5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">单击屏幕右上角的中心按钮，导航至数据融合中心:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mq"><img src="../Images/ea9c59d4c65ef09a722ed27ed4a0bdf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sSuo3p5eie3JOpKG"/></div></div></figure><p id="9b0e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在HUB中，在顶部的搜索栏中，搜索“cloudsql ”,并从可用插件列表中选择“CloudSQL MySQL JDBC驱动程序”,单击它:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/5ec716914188a0d62062992c9027d171.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9O4BxN0aTP6YAGjj"/></div></div></figure><p id="7f71" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">系统会提示我们下载驱动程序。jar文件，然后将其上传到Data Fusion，以便在数据管道中进行部署和使用。点击第一步下面的下载链接</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/9a1052aee3fdd8aa9e9e1de2d87f4fac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mol5rbfiWAGy027S"/></div></div></figure><p id="cdd2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">按照提供的说明，下载。jar文件从链接到Google云平台的Github到你的本地机器。您应该下载一个类似于<strong class="is hj">“MySQL-socket-factory-connector-j-8–1 . 0 . 16-jar-with-driver-and-dependencies . jar”</strong>的文件</p><p id="7dee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下载文件后，单击“完成”按钮:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/9adea07e7cfcefeb9dccd6a2e88b6a3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Y6CpO0IZUpl01EP3"/></div></div></figure><p id="9fcc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在是时候上传。jar文件和数据融合实例的插件。单击您在上一步中单击的链接旁边的“部署”链接:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/2d9c9c63ff93a904ad68898f8c9a60bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uwFCi3GMKm5kyZ3d"/></div></div></figure><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/db24503d10a27f00753bb326971901cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9J1MfvZfYfW5jfT3"/></div></div></figure><p id="1ef9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">提供。jar文件，然后单击“下一步”</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/aed73eca16f01a491e6cf62e01a50c58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*P55gwojFgByONIZc"/></div></div></figure><p id="8a04" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">保留所有默认设置，然后单击“Finish”按钮。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/031a4a9aa92203b928979d3cc3ed64c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KFSJgQB4V8mIL9mv"/></div></div></figure><p id="36bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">部署过程将开始(可能需要一分钟)。完成后，您将看到一个成功弹出窗口，提示您“创建管道”或“转到主页”。忽略按钮，点击旁边的“转到主页”链接。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/2e7152ab2f2c48fdb564d2d5655bfc4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*80MuUr0i7_8sRwNi"/></div></div></figure><h1 id="1cfc" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">使用JDBC插件测试云SQL中MySQL数据库的连接性</h1><p id="9ea9" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">从云数据融合UI主页，单击欢迎弹出窗口中的“不，谢谢”按钮(如果它再次出现)。从这里开始，通过向画布添加一个牧马人任务来测试创建一个简单的数据管道。点击“争吵”卡片。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/19bf572db1492f6e7946d3703af15f94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Gkdi4VVoEvVodEaD"/></div></div></figure><p id="1877" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后单击左侧菜单底部的添加连接按钮:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div class="er es ms"><img src="../Images/6d893ed334a702cf96ea8f06a389d2b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/0*Fuv3nR_iYfBA44jn"/></div></figure><p id="975e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从屏幕中间的列表中选择CloudSQL MySQL连接:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/149fe7f9fda05ffedaa5646ec33aca4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Rex6l4f70fu7QDQ3"/></div></div></figure><p id="5289" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输入新连接的名称，根据下表选择您之前在JDBC驱动程序中部署的驱动程序和其余必需的输入，然后在底部单击“测试连接”按钮:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mt"><img src="../Images/eed682b6d217d0e453fdab1ad074d7df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AUQ1WCdKn89pK9RlPrY2CQ.png"/></div></div></figure><p id="7d9e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果一切顺利，您应该会看到连接尝试成功，如下图所示:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div class="er es mu"><img src="../Images/76e9fdfb30a25ef5d8e05a5829b244d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:734/0*WV3qyH8WubVfa637"/></div></figure><h1 id="9cb3" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">搞定了。！您通过云SQL的私有接口将数据融合与云SQL连接起来。</h1><p id="0483" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">如果您在点击TEST CONNECTION按钮时遇到类似下图中的错误，很可能是您没有正确配置peerings或您缺少防火墙规则，请记住将SQL代理虚拟机内部IP放在Connection Name字段中，放入来自CloudSQL或其私有IP的连接名称将不起作用:</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div class="er es mu"><img src="../Images/b6d3f73d08286a55d8e71f829935650e.png" data-original-src="https://miro.medium.com/v2/resize:fit:734/0*UwZN0ZEXEOOWnRMj"/></div></figure><h1 id="7f59" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">恭喜你！</h1><p id="4dbf" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">您已经安全地将私有数据融合实例与私有云SQL数据库实例连接起来。</p><h1 id="0955" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">我们讨论过的内容</h1><ul class=""><li id="d2c7" class="ks kt hi is b it km ix kn jb ku jf kv jj kw jn lg ky kz la bi translated">如何使用MySQL数据库启动私有云SQL实例</li><li id="3bf3" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn lg ky kz la bi translated">如何启动私有云数据融合实例</li><li id="e88a" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn lg ky kz la bi translated">如何启动代理计算引擎虚拟机实例，以允许云SQL和数据融合实例之间的私有连接</li><li id="3f0e" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn lg ky kz la bi translated">如何使用云数据融合中心提供的MySQL JDBC驱动程序创建到私有云SQL实例的连接</li></ul><h1 id="be6a" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">有用的文档</h1><p id="728d" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">了解云SQL私有IP:<a class="ae kr" href="https://cloud.google.com/sql/docs/mysql/private-ip?hl=en" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/sql/docs/mysql/private-ip?hl=en</a></p><p id="3bd4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为cloud配置私有服务访问SQL:<a class="ae kr" href="https://cloud.google.com/sql/docs/mysql/configure-private-services-access" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/SQL/docs/MySQL/configure-Private-Services-Access</a></p><p id="09b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为云SQL配置私有IP:<a class="ae kr" href="https://cloud.google.com/sql/docs/mysql/configure-private-ip?hl=en" rel="noopener ugc nofollow" target="_blank">https://Cloud . Google . com/SQL/docs/MySQL/configure-Private-IP？hl=en </a></p><p id="30e4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建私有数据融合实例:</p><p id="5903" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kr" href="https://cloud.google.com/data-fusion/docs/how-to/create-private-ip#curl" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/data-fusion/docs/how-to/create-private-IP # curl</a></p><p id="d351" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">授予Data Fusion Service帐户权限:</p><p id="8462" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kr" href="https://cloud.google.com/data-fusion/docs/how-to/granting-service-account-permission?_ga=2.97242134.-86038369.1663269464" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/data-fusion/docs/how-to/granting-service-account-permission？_ga=2.97242134。-86039464</a></p><p id="8c4d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云数据融合服务客户:</p><p id="6d21" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kr" href="https://cloud.google.com/data-fusion/docs/concepts/service-accounts#service_account_table" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/data-fusion/docs/concepts/service-accounts # service _ account _ table</a></p><p id="561a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">VPC对等:</p><p id="1720" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kr" href="https://cloud.google.com/vpc/docs/using-vpc-peering" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/vpc/docs/using-vpc-peering</a></p></div></div>    
</body>
</html>