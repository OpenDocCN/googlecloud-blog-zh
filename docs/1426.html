<html>
<head>
<title>Container Load Balancing on Google Kubernetes Engine(GKE)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Kubernetes引擎上的容器负载平衡(GKE)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/container-load-balancing-on-google-kubernetes-engine-gke-4cbfaa80a6f6?source=collection_archive---------0-----------------------#2020-05-14">https://medium.com/google-cloud/container-load-balancing-on-google-kubernetes-engine-gke-4cbfaa80a6f6?source=collection_archive---------0-----------------------#2020-05-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="f29b" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">在云中烹饪</h2></div><p id="d26b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">作者:<a class="ae jt" href="https://twitter.com/pvergadia" rel="noopener ugc nofollow" target="_blank">普里扬卡·韦尔加迪亚</a>，<a class="ae jt" href="https://twitter.com/swongful" rel="noopener ugc nofollow" target="_blank">王从希</a></p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ju"><img src="../Images/ed10814b1a4d84b5553eb5591db7fd07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZL_T-y_1MZsZH5Fn.gif"/></div></div></figure><h1 id="a465" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated">介绍</h1><p id="db56" class="pw-post-body-paragraph ix iy hi iz b ja ky ij jc jd kz im jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">“<a class="ae jt" rel="noopener" href="/@pvergadia/get-cooking-in-cloud-an-introduction-5b3b90de534e">在云中烹饪</a>”是一个博客和<a class="ae jt" href="https://www.youtube.com/playlist?list=PLIivdWyY5sqIOyeovvRapCjXCZykZMLAe" rel="noopener ugc nofollow" target="_blank">视频</a>系列，帮助企业和开发者在谷歌云上构建商业解决方案。在这个系列中，我们计划确定开发人员希望在Google cloud上构建的特定主题。一旦确定，我们就以此为主题制作一个迷你系列。</p><p id="5e5d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这个迷你系列中，我们将讨论Google云负载平衡。</p><ol class=""><li id="2e47" class="ld le hi iz b ja jb jd je jg lf jk lg jo lh js li lj lk ll bi translated"><a class="ae jt" rel="noopener" href="/google-cloud/choosing-the-right-load-balancer-9ec909148a85">选择正确的负载平衡器</a></li><li id="c37a" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js li lj lk ll bi translated"><a class="ae jt" rel="noopener" href="/google-cloud/application-capacity-optimizations-with-global-load-balancing-e0aa079d2c25">通过全局负载平衡优化应用容量</a></li><li id="3060" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js li lj lk ll bi translated"><a class="ae jt" rel="noopener" href="/google-cloud/capacity-management-with-load-balancing-32bd22a716a7">负载平衡的容量管理</a></li><li id="ecdc" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js li lj lk ll bi translated">GKE网络端点组的负载平衡(本文)</li></ol><p id="212d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本文中，我们将介绍负载平衡如何与作为后端运行的Google Kubernetes集群一起工作。</p><h1 id="7575" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated">看看这个视频</h1><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="lr ls l"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">负载平衡Google Kubernetes容器集群</figcaption></figure><h1 id="ee8a" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated">你会学到什么</h1><ul class=""><li id="8f21" class="ld le hi iz b ja ky jd kz jg lx jk ly jo lz js ma lj lk ll bi translated">为什么我们需要容器负载平衡？</li><li id="bfa8" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js ma lj lk ll bi translated">什么是网络端点组(NEG)？</li><li id="aa62" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js ma lj lk ll bi translated">如何在GKE设置容器本地负载平衡</li><li id="7afb" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js ma lj lk ll bi translated">容器本地负载平衡的优势</li></ul><h1 id="ade4" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated">回顾</h1><p id="d014" class="pw-post-body-paragraph ix iy hi iz b ja ky ij jc jd kz im jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">在这个系列中，我们将与<strong class="iz hj"> Beyond Treat，</strong>一个素食狗零食的一站式商店合作！他们的在线业务仍在蓬勃发展。虽然他们升级到使用谷歌的全球负载均衡器，但他们也决定将他们的web后端迁移到一个容器化的微服务环境中。</p><h1 id="43e0" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated">负载平衡的历史和一些挑战</h1><p id="e22b" class="pw-post-body-paragraph ix iy hi iz b ja ky ij jc jd kz im jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">负载平衡器最初是为了支持虚拟机(VM)的资源分配而构建的，这有助于提高工作负载的可用性。</p><blockquote class="mb"><p id="5a59" class="mc md hi bd me mf mg mh mi mj mk js dx translated">当容器和容器编排器开始起飞时，用户调整这些以VM为中心的负载平衡器供他们使用，即使性能不是最理想的。</p></blockquote><p id="65eb" class="pw-post-body-paragraph ix iy hi iz b ja ml ij jc jd mm im jf jg mn ji jj jk mo jm jn jo mp jq jr js hb bi translated">传统上，以Kubernetes集群为目标的HTTP(S)负载平衡器实际上会以它的<strong class="iz hj">节点</strong>为目标，因为它们没有办法识别每个pod。由于无法将一组pod定义为后端，负载平衡器使用实例组将虚拟机分组为后端。GKE的入口支持使用这些实例组，使用HTTP(S)负载平衡器对集群中的<strong class="iz hj">节点</strong>执行负载平衡。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es mq"><img src="../Images/a2f2698a7300fcd944f60777698c7475.png" data-original-src="https://miro.medium.com/v2/resize:fit:576/format:webp/1*VfiBAGEXNTtEfkDdNX_dXA.png"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">iptables将流量路由到pod</figcaption></figure><p id="9cf2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在节点上编程的Iptables规则将请求路由到作为负载平衡应用程序后端的pod。节点的负载平衡是唯一的选择，因为负载平衡器不会将pod或containers识别为后端，从而导致负载不平衡和次优的数据路径，并在节点之间增加了不必要的跳跃。</p><h1 id="2528" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated">网络端点组(NEG) —容器本地负载平衡</h1><p id="7ada" class="pw-post-body-paragraph ix iy hi iz b ja ky ij jc jd kz im jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">Google推出了一个<a class="ae jt" href="https://cloud.google.com/load-balancing/docs/negs" rel="noopener ugc nofollow" target="_blank">网络端点组(NEG) </a>抽象层，支持容器本地负载平衡。这意味着负载平衡器可以看到Kubernetes集群的pods，因为NEGs与运行在GCP上的Kubernetes Ingress控制器集成在一起。</p><blockquote class="mb"><p id="c0bd" class="mc md hi bd me mf mg mh mi mj mk js dx translated">借助网络端点组(NEG ),负载平衡器可以了解Kubernetes集群的pods。</p></blockquote><figure class="mr ms mt mu mv jz er es paragraph-image"><div class="er es mq"><img src="../Images/222917f3e5858c4e484255d2a63da21b.png" data-original-src="https://miro.medium.com/v2/resize:fit:576/format:webp/1*4hQAk9F-MzAIXZ_3kh4s3g.png"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">网络端点组(NEG)如何帮助将流量路由到pod</figcaption></figure><p id="9ed1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Beyond Treat的情况下，他们有一个多层电子商务部署，并希望使用GKE向互联网公开一个服务。有了NEGs，他们现在可以配置HTTP(S)负载平衡器，允许他们配置基于路径或基于主机的路由到他们的后端pod。</p><h1 id="2331" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated"><strong class="ak">在GKE设置容器本地负载平衡</strong></h1><p id="d517" class="pw-post-body-paragraph ix iy hi iz b ja ky ij jc jd kz im jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">创建一个VPC本地的GKE集群。默认情况下，Kubernetes使用静态路由进行pod联网，这需要Kubernetes控制平面来维护这些到每个节点的路由。但是，这是以扩展成本为代价的。</p><p id="d2c0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在GKE，您可以选择在VPC本地模式下创建集群，这提供了使用NEG数据模型的<strong class="iz hj">容器本地</strong>负载平衡。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es mw"><img src="../Images/778ecca9b8af3665799b2b007b0eec21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Tnl64Ldfk5dmCxP_"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">建立VPC本土GKE集群</figcaption></figure><p id="4110" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">VPC本地模式意味着您可以在VPC中的所有pod之间建立连接，而不会产生路由扩展开销，并且流量会在端点组中的可用健康后端之间均匀分布。</p><h1 id="835e" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated"><strong class="ak">容器本地负载平衡的优势</strong></h1><blockquote class="mb"><p id="f258" class="mc md hi bd me mf mg mh mi mj mk js dx translated">NEG和容器本地负载平衡的好处是流量均匀分布、健康检查、适度终止和最佳路径。</p></blockquote><ul class=""><li id="1183" class="ld le hi iz b ja ml jd mm jg mx jk my jo mz js ma lj lk ll bi translated">借助容器原生负载平衡，流量按照定义的负载平衡算法均匀分布在端点组中可用的健康后端之间。</li><li id="523e" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js ma lj lk ll bi translated">容器本地负载平衡支持健康检查，包括TCP、HTTP(S)或HTTP/2检查。NEGs可以直接检查pod，而不是将健康检查转发给随机pod的节点。因此，运行状况检查可以更准确地反映后端的运行状况。</li><li id="b711" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js ma lj lk ll bi translated">您还可以从正常终止中获益—当pod被移除时，负载平衡器会根据为其配置的连接排出周期，自动排出到端点服务流量的连接。</li><li id="c7ad" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js ma lj lk ll bi translated">流量到达最佳数据路径—由于能够直接对容器进行负载平衡，从负载平衡器到节点的流量跳跃消失了，因为负载平衡是在一个步骤而不是两个步骤中执行的。</li><li id="1536" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js ma lj lk ll bi translated">提高可见性和安全性——容器原生负载平衡帮助他们在pod级别排除服务故障。它可以在HTTP报头中保留源IP，以便更容易追溯到流量的来源。由于容器看到的是来自负载平衡器的数据包，而不是通过另一个节点的源NAT到达的数据包，因此它们现在可以使用节点级网络策略创建防火墙规则。</li></ul><h1 id="a372" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated">结论</h1><p id="ccd5" class="pw-post-body-paragraph ix iy hi iz b ja ky ij jc jd kz im jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">好了，你有它，负载平衡解构所有的方式！在<a class="ae jt" rel="noopener" href="/google-cloud/choosing-the-right-load-balancer-9ec909148a85">前三篇文章</a>中，我们了解了Google Cloud上的负载平衡选项，并证明了全局负载平衡比区域HTTPS负载平衡更高效、更可靠。最后，我们了解到，即使使用GKE集群，容器原生负载平衡也意味着它们可以直接将后端pod作为目标，以实现最佳流量分配和可扩展性改进。</p><p id="00d8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">敬请关注<a class="ae jt" rel="noopener" href="/@pvergadia/get-cooking-in-cloud-an-introduction-5b3b90de534e">云烹饪系列</a>中的更多文章，并查看以下参考资料了解更多细节。</p><h1 id="b0a8" class="kg kh hi bd ki kj kk kl km kn ko kp kq io kr ip ks ir kt is ku iu kv iv kw kx bi translated">后续步骤和参考:</h1><ul class=""><li id="f309" class="ld le hi iz b ja ky jd kz jg lx jk ly jo lz js ma lj lk ll bi translated">在<a class="ae jt" href="https://medium.com/google-cloud" rel="noopener">谷歌云平台媒体</a>上关注这个博客系列。</li><li id="65e8" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js ma lj lk ll bi translated">参考:<a class="ae jt" href="https://cloud.google.com/kubernetes-engine/docs/how-to/container-native-load-balancing" rel="noopener ugc nofollow" target="_blank">容器原生负载均衡</a>，<a class="ae jt" href="https://cloud.google.com/blog/products/containers-kubernetes/introducing-container-native-load-balancing-on-google-kubernetes-engine" rel="noopener ugc nofollow" target="_blank">博客</a></li><li id="cb4f" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js ma lj lk ll bi translated">关注<a class="ae jt" href="https://www.youtube.com/watch?v=pxp7uYUjH_M" rel="noopener ugc nofollow" target="_blank">获取云端烹饪</a>视频系列，订阅谷歌云平台YouTube频道</li><li id="67d2" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js ma lj lk ll bi translated">想要更多的故事？在<a class="ae jt" rel="noopener" href="/@pvergadia/">媒体</a>和<a class="ae jt" href="https://twitter.com/pvergadia" rel="noopener ugc nofollow" target="_blank">推特</a>上关注我。</li><li id="8569" class="ld le hi iz b ja lm jd ln jg lo jk lp jo lq js ma lj lk ll bi translated">请和我们一起欣赏这部迷你剧，并了解更多类似的谷歌云解决方案:)</li></ul><div class="na nb ez fb nc nd"><a rel="noopener follow" target="_blank" href="/google-cloud/choosing-the-right-load-balancer-9ec909148a85"><div class="ne ab dw"><div class="nf ab ng cl cj nh"><h2 class="bd hj fi z dy ni ea eb nj ed ef hh bi translated">选择正确的负载平衡器</h2><div class="nk l"><h3 class="bd b fi z dy ni ea eb nj ed ef dx translated">在云中烹饪</h3></div><div class="nl l"><p class="bd b fp z dy ni ea eb nj ed ef dx translated">medium.com</p></div></div><div class="nm l"><div class="nn l no np nq nm nr ke nd"/></div></div></a></div></div></div>    
</body>
</html>