<html>
<head>
<title>Connecting to CloudSQL from a service running in a GCP serverless environnement (ex: Cloud Functions)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从运行在GCP无服务器环境中的服务连接到CloudSQL(例如:云函数)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/connecting-to-cloudsql-from-a-service-running-in-a-gcp-serverless-environnement-ex-cloud-a0187a57c551?source=collection_archive---------2-----------------------#2020-12-09">https://medium.com/google-cloud/connecting-to-cloudsql-from-a-service-running-in-a-gcp-serverless-environnement-ex-cloud-a0187a57c551?source=collection_archive---------2-----------------------#2020-12-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="36a5" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">TL；灾难恢复—将SQL代理(通过unix套接字)与具有私有IP的云SQL的无服务器VPC访问结合使用</h2></div><p id="91fa" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">云功能是一种可扩展的解决方案，可以将现收现付功能作为一种服务。</p><p id="8962" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以选择函数将被实例化的区域，但是它们不会在您的网络上运行。当您需要连接到CloudSQL实例时，您必须回答这两个问题:</p><ul class=""><li id="f295" class="jt ju hi iz b ja jb jd je jg jv jk jw jo jx js jy jz ka kb bi translated">CloudSQL使用的是公有IP还是私有IP？<em class="kc">(私有IP更安全，不需要就不要暴露你的DB)</em></li><li id="43d3" class="jt ju hi iz b ja kd jd ke jg kf jk kg jo kh js jy jz ka kb bi translated">是否启用了SSL？<em class="kc">(加密你的流量，以避免任何不可预见的窥探)</em></li></ul><p id="0a6f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦您知道了如何设置CloudSQL实例，您就可以轻松地从云函数的无服务器环境连接到它(参见<a class="ae ki" href="https://cloud.google.com/sql/docs/mysql/connect-functions" rel="noopener ugc nofollow" target="_blank">文档</a>和<a class="ae ki" href="https://cloud.google.com/sql/docs/postgres/quickstart-connect-functions" rel="noopener ugc nofollow" target="_blank">使用云函数的云SQL快速入门指南</a>)。</p><h2 id="6ed1" class="kj kk hi bd kl km kn ko kp kq kr ks kt jg ku kv kw jk kx ky kz jo la lb lc ld bi translated">公共或私有IP</h2><figure class="le lf lg lh fd li"><div class="bz dy l di"><div class="lj lk l"/></div></figure><figure class="le lf lg lh fd li er es paragraph-image"><div class="er es ll"><img src="../Images/b6c9df8dc5e45428d870003c916974c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*jES8uQThFArUy-fkQ-zT9g.png"/></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">实线:公共IP网络路径。虚线:专用IP路径</figcaption></figure><p id="5006" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您的CloudSQL实例有一个公共IP，那么您可以直接从云功能访问它(防火墙规则适用)。</p><p id="25e5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您的CloudSQL实例有一个私有IP，那么您需要<a class="ae ki" href="https://cloud.google.com/functions/docs/networking/connecting-vpc" rel="noopener ugc nofollow" target="_blank">配置无服务器VPC访问</a>来将您的云功能连接到VPC网络。</p><h2 id="961e" class="kj kk hi bd kl km kn ko kp kq kr ks kt jg ku kv kw jk kx ky kz jo la lb lc ld bi translated">启用SSL？</h2><figure class="le lf lg lh fd li"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="bb5a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当您有一个启用了SSL的实例时，您可以通过证书在它的<em class="kc"> IP:port </em>上访问CloudSQL，或者使用SQL代理进行安全连接。</p><h2 id="1a42" class="kj kk hi bd kl km kn ko kp kq kr ks kt jg ku kv kw jk kx ky kz jo la lb lc ld bi translated">Python中云函数的CloudSQL (Postgres)连接的代码“备忘单”</h2></div><div class="ab cl ls lt gp lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hb hc hd he hf"><p id="b785" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果没有SSL，请使用IP和端口(如果是专用IP，请启用无服务器VPC访问):</p><figure class="le lf lg lh fd li"><div class="bz dy l di"><div class="lj lk l"/></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">要在web应用程序的上下文中查看这个片段，请查看GitHub 上的<a class="ae ki" href="https://github.com/GoogleCloudPlatform/python-docs-samples/tree/master/cloud-sql/postgres/sqlalchemy/README.md" rel="noopener ugc nofollow" target="_blank">自述文件。</a></figcaption></figure><p id="40ca" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">启用SSL，使用unix套接字通过SQL代理(如果是私有IP，则启用无服务器VPC访问)，并授予<code class="du lz ma mb mc b">cloudsql.instances.connect</code>对您的云功能的服务帐户的权限(参见<a class="ae ki" href="https://cloud.google.com/sql/docs/postgres/sql-proxy#authentication-options" rel="noopener ugc nofollow" target="_blank">文档</a>)。</p><figure class="le lf lg lh fd li"><div class="bz dy l di"><div class="lj lk l"/></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">要在web应用程序的上下文中查看这个片段，请查看GitHub上的<a class="ae ki" href="https://github.com/GoogleCloudPlatform/python-docs-samples/tree/master/cloud-sql/postgres/sqlalchemy/README.md" rel="noopener ugc nofollow" target="_blank">自述文件</a></figcaption></figure><p id="f4fd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从云功能的无服务器环境连接到任何CloudSQL实例，对您来说已经没有秘密可言。去试试吧！</p></div></div>    
</body>
</html>