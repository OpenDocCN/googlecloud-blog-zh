<html>
<head>
<title>Importing data from GCS to Databases (via JDBC) using Dataproc Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dataproc无服务器将数据从GCS导入数据库(通过JDBC)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/importing-data-from-gcs-to-databases-via-jdbc-using-dataproc-serverless-7ed75eab93ba?source=collection_archive---------0-----------------------#2022-06-04">https://medium.com/google-cloud/importing-data-from-gcs-to-databases-via-jdbc-using-dataproc-serverless-7ed75eab93ba?source=collection_archive---------0-----------------------#2022-06-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e2034781b0068df463c9718f16355b47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XJJEMcKLQWAeVZoq8zItcg.png"/></div></div></figure><p id="ecd7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在运行Spark作业的同时管理服务器始终是一项挑战。对Spark作业使用完全托管的按需服务器是当今时代的需要。它帮助开发人员专注于核心应用程序逻辑，而不是花时间管理框架。Dataproc Serverless就是Google云平台提供的一个这样的产品。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es jo"><img src="../Images/819cf1296dfc0581447091724c646c58.png" data-original-src="https://miro.medium.com/v2/resize:fit:654/format:webp/1*QTFti8cG08DZMUmBDrvXfw.jpeg"/></div></figure><p id="bdc9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">大多数事务数据仍然驻留在关系数据库服务器上，可以通过使用JDBC驱动程序来连接。MySQL、Oracle和SQL Server主要用于此目的。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es jt"><img src="../Images/252ab408451fd6d27e8504cc0ee7352f.png" data-original-src="https://miro.medium.com/v2/resize:fit:916/format:webp/1*fQ7pfe9GKiyjzcyZpnmPEw.png"/></div></figure><p id="0dcb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当今世界正在转向基于云的存储服务来存储数据。它引发了谷歌云存储桶的使用。</p><p id="194b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这篇文章是关于通过Dataproc无服务器将数据从GCS桶转移到JDBC数据库的。</p><h1 id="1f46" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">主要优势</h1><ol class=""><li id="2928" class="ks kt hi is b it ku ix kv jb kw jf kx jj ky jn kz la lb lc bi translated">使用<strong class="is hj"> Dataproc无服务器</strong>运行Spark批处理工作负载，无需管理Spark框架。批量大小也可以在该模板中配置。</li><li id="7ccf" class="ks kt hi is b it ld ix le jb lf jf lg jj lh jn kz la lb lc bi translated"><a class="ae li" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/src/main/java/com/google/cloud/dataproc/templates/gcs/README.md#3-gcs-to-jdbc" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> GCSToJDBC </strong> </a>模板是开源的，配置驱动的，随时可以使用。执行代码只需要JDBC和GCS证书。</li><li id="6fcc" class="ks kt hi is b it ld ix le jb lf jf lg jj lh jn kz la lb lc bi translated">支持的文件格式有Avro、Parquet和ORC。</li><li id="da8c" class="ks kt hi is b it ld ix le jb lf jf lg jj lh jn kz la lb lc bi translated"><a class="ae li" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/src/main/java/com/google/cloud/dataproc/templates/jdbc/README.md#2-jdbc-to-gcs" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> JDBCToGCS </strong> </a>模板可以反过来使用，即通过JDBC将数据从数据库导出到GCS存储桶。</li></ol><h1 id="b1d8" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated"><strong class="ak">用途</strong></h1><ol class=""><li id="04c6" class="ks kt hi is b it ku ix kv jb kw jf kx jj ky jn kz la lb lc bi translated">如果你要使用“默认的”由GCP生成的VPC网络，请确保你已经启用了私有谷歌访问子网。您仍然需要启用如下的私人访问。</li></ol><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es lj"><img src="../Images/75fd723625ca3e21aa6f036e53c5fff0.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/0*q3OwtI4Rpl5pHJKX.png"/></div></figure><pre class="jp jq jr js fd lk ll lm ln aw lo bi"><span id="287c" class="lp jv hi ll b fi lq lr l ls lt">gcloud compute networks subnets update default --region=us-central1 --enable-private-ip-google-access</span></pre><p id="aeaf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.为jar文件创建一个GCS存储桶和暂存位置。</p><p id="e6bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.在预装了<a class="ae li" href="https://cloud.google.com/shell/docs/how-cloud-shell-works" rel="noopener ugc nofollow" target="_blank">各种工具</a>的云壳中克隆git repo。或者使用任何预装JDK 8+，Maven和Git的机器。</p><pre class="jp jq jr js fd lk ll lm ln aw lo bi"><span id="e857" class="lp jv hi ll b fi lq lr l ls lt">git clone <a class="ae li" href="https://github.com/GoogleCloudPlatform/dataproc-templates.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/dataproc-templates.git</a>cd dataproc-templates/java</span></pre><p id="5497" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.获取身份验证凭据(以提交作业)。</p><pre class="jp jq jr js fd lk ll lm ln aw lo bi"><span id="7388" class="lp jv hi ll b fi lq lr l ls lt">gcloud auth application-default login</span></pre><p id="6ff2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.执行GCSToJDBC模板。<br/>例如:</p><pre class="jp jq jr js fd lk ll lm ln aw lo bi"><span id="2395" class="lp jv hi ll b fi lq lr l ls lt">export GCP_PROJECT=my-gcp-project<br/>export REGION=us-central1<br/>export GCS_STAGING_LOCATION=gs://staging-bucket \<br/>export JARS=gs://jar-location/mysql-connector-java-8.0.29.jar</span><span id="64d8" class="lp jv hi ll b fi lu lr l ls lt">bin/start.sh \<br/>-- --template GCSTOJDBC \<br/>--templateProperty project.id=my-gcp-project \<br/>--templateProperty gcs.jdbc.input.location=gs://inputBucket/empavro \<br/>--templateProperty gcs.jdbc.input.format=avro \<br/>--templateProperty gcs.jdbc.output.table=demo \<br/>--templateProperty gcs.jdbc.output.saveMode=Overwrite \<br/>--templateProperty gcs.jdbc.output.url='jdbc:mysql://12.345.678.9:3306/test?user=root&amp;password=root' \<br/>--templateProperty gcs.jdbc.output.driver='com.mysql.jdbc.Driver' \<br/>--templateProperty gcs.jdbc.output.batchInsertSize=1000</span></pre><p id="1694" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意</strong>:如果尚未启用，它会要求您启用Dataproc Api。</p><h1 id="b1cf" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">设置每日增量数据导出</h1><p id="624c" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb lv jd je jf lw jh ji jj lx jl jm jn hb bi translated">有时需要日/周/月末导出。最重要的是，您可能希望只提取增量变更，因为在每次迭代中导出整个数据可能会有些过头。</p><p id="411a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意</strong> : Dataproc Serverless不支持实时作业。因此，如果目标是将变更从GCS实时复制到JDBC，那么您将需要考虑变更数据捕获(CDC)的替代方案。</p><ol class=""><li id="793b" class="ks kt hi is b it iu ix iy jb ly jf lz jj ma jn kz la lb lc bi translated">使用标准数据库的<a class="ae li" href="https://cloud.google.com/spanner/docs/commit-timestamp" rel="noopener ugc nofollow" target="_blank">提交时间戳</a>特性，您可以跟踪插入/更新的行(删除不能被捕获)。</li><li id="564b" class="ks kt hi is b it ld ix le jb lf jf lg jj lh jn kz la lb lc bi translated">重写提交给spark的sql查询，以捕获自上次执行以来的更改。例如:</li></ol><pre class="jp jq jr js fd lk ll lm ln aw lo bi"><span id="13b3" class="lp jv hi ll b fi lq lr l ls lt">jdbctogcs.sql='<!-- -->select trip_id, bikeid, duration_minutes from bikeshare where LastUpdateTime &gt;= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY'</span></pre><p id="7fe6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.计划批处理作业。<br/> GCP原生提供云调度+云功能，可用于提交spark批量作业。或者自我管理的软件，如linux cron tab，Jenkins等。也可以使用。</p><h1 id="27ca" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">设置附加火花属性</h1><p id="c93b" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb lv jd je jf lw jh ji jj lx jl jm jn hb bi translated">如果您需要<a class="ae li" href="https://cloud.google.com/dataproc-serverless/docs/concepts/properties" rel="noopener ugc nofollow" target="_blank">指定Dataproc无服务器支持的spark属性</a>，如调整驱动程序、内核、执行器等的数量。</p><p id="fca2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以编辑start.sh文件中的<a class="ae li" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/bin/start.sh#L50" rel="noopener ugc nofollow" target="_blank"> OPT_PROPERTIES </a>值。</p><p id="85a5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">参考文献</strong><br/><a class="ae li" rel="noopener" href="/google-cloud/cloud-spanner-export-query-results-using-dataproc-serverless-6f2f65b583a4">https://medium . com/Google-cloud/cloud-spanner-export-query-results-using-data proc-server less-6 F2 f 65 b 583 a4</a><br/><a class="ae li" href="https://cloud.google.com/dataproc-serverless/docs/overview" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/pubsub/docs/overview</a><br/><a class="ae li" href="https://github.com/GoogleCloudPlatform/dataproc-templates" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/dataproc-templates</a></p></div></div>    
</body>
</html>