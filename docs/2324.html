<html>
<head>
<title>Avoid Public PyPI Using Google Cloud Artifact Registry</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">避免使用Google Cloud Artifact Registry的公共PyPI</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/avoid-public-pypi-using-google-cloud-artifact-registry-4464325a5e75?source=collection_archive---------0-----------------------#2022-08-23">https://medium.com/google-cloud/avoid-public-pypi-using-google-cloud-artifact-registry-4464325a5e75?source=collection_archive---------0-----------------------#2022-08-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="176d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你为什么想要避开<a class="ae jd" href="https://pypi.org/" rel="noopener ugc nofollow" target="_blank"> PyPI </a>？PyPI很棒，它是一个巨大的集市，有近400，000个包，自2003年以来一直公开发售。但不幸的是，它对出版内容的控制也非常有限。不怀好意的人很容易发布与现有流行软件包名称非常相似的软件包，利用常见的打字错误，并包含恶意软件。也有可能找到所有者不再有时间照看的包，并试图侵入所有者的帐户并发布有效现有包的新中毒版本。有许多变种利用这些<a class="ae jd" href="https://cloud.google.com/resources/delivering-software-securely-whitepaper" rel="noopener ugc nofollow" target="_blank">软件供应链漏洞</a>，但是我们也可以通过避开我们无法控制的软件库来保护自己。</p><p id="e4e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更大的组织通常会走得更远，直接禁止访问公共互联网。现在如果你需要安装一个Python包，你会怎么做？如果你在谷歌云上，你使用工件注册。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/0f808962c6cae8a988a80908f8121ebf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZRCPVTUSVJrmOU-O"/></div></div></figure><p id="e134" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有很多关于使用Artifact Registry设置Python存储库的信息，通常是为了共享内部开发的Python包。但是对于那些在没有互联网接入的环境中的人来说，具体的挑战很少被涉及。这篇文章提供了如何克服这些障碍的细节。</p><p id="c7de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你建立了一个私有的软件包回购，正如我们在这篇文章中建议的，你将不得不通过不断安装新版本的软件包来维护它，让你的用户保持最新。当Artifact Registry使其<a class="ae jd" href="https://cloud.google.com/artifact-registry/docs/repositories/virtual-repo" rel="noopener ugc nofollow" target="_blank">虚拟存储库</a>普遍可用时，这种负担将会减轻，但在此之前，我们将不得不手工维护。</p><h1 id="cc50" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">在工件注册表上设置Python索引</h1><p id="b00a" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">您的相关管理员将锁定您的互联网访问，例如禁止您使用外部IP地址创建资源，如计算引擎中的虚拟机或Vertex AI Workbench中的Jupyter笔记本。如果资源的网络(VPC)没有启用云NAT，它将无法访问互联网。</p><p id="ea00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，当我们需要安装Python包时，我们将从Artifact Registry中的Python存储库中安装它们。我们首先选择我们信任的Python包和版本，并允许在我们的项目中使用。我们将把这些包上传到Artifact Registry，项目的用户可以在需要的时候安装它们。</p><p id="a427" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，如果我们没有互联网接入，我们如何让包上传到工件注册？要设置我们的Python包存储库，我们需要从某个地方访问互联网。我们可以在计算引擎中使用虚拟机，管理员可以使用外部IP地址创建该虚拟机，或者在具有云NAT的VPC中创建虚拟机，以支持互联网访问。当然，在这种情况下，我们将不得不阻止其他用户在这个VPC中创建资源！</p><p id="71cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于本文的剩余部分，我们将假设我们在安全项目中的一个虚拟机上工作，该虚拟机可以访问公共互联网和我们项目中的工件注册表。我们将使用<a class="ae jd" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank"> gcloud命令行界面</a>。</p><p id="de68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，我们可以简单地按照<a class="ae jd" href="https://cloud.google.com/artifact-registry/docs/python" rel="noopener ugc nofollow" target="_blank">文档</a>创建一个Python库并上传我们的包:</p><ol class=""><li id="e67b" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">首先在您选择的地区创建一个名为“medium”的Python存储库:</li></ol><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="a33c" class="lh jr hi ld b fi li lj l lk ll">gcloud auth login<br/>gcloud config set project my_project<br/>gcloud artifacts repositories create medium \<br/>   --repository-format=python --location=europe-west1</span></pre><p id="a287" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.一个项目所需的Python包列表通常保存在一个<a class="ae jd" href="https://learnpython.com/blog/python-requirements-file/" rel="noopener ugc nofollow" target="_blank"> requirements.txt文件</a>中。如果您没有，那么您可以使用pip freeze创建一个requirements.txt:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="c6a7" class="lh jr hi ld b fi li lj l lk ll">pip freeze &gt; requirements</span></pre><p id="f57a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.准备下载我们所有的软件包！或者也许我们应该首先检查我们的列表不包含任何已知的漏洞…我推荐使用<a class="ae jd" href="https://www.redhat.com/sysadmin/find-python-vulnerabilities" rel="noopener ugc nofollow" target="_blank"> pip-audit </a>。如果它返回“没有发现漏洞”，那么我们就可以走了！您可以按如下方式使用pip-audit:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="f7d4" class="lh jr hi ld b fi li lj l lk ll">pip install virtualenv<br/>virtualenv venv<br/>source venv/bin/activate<br/>pip install --upgrade pip-audit<br/>pip-audit --requirement requirements.txt</span></pre><p id="02f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.终于准备好下载我们所有的软件包了。画中画工具在这里很有用:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="da44" class="lh jr hi ld b fi li lj l lk ll">mkdir dist<br/>pip download --destination-directory dist -r ../requirements.txt</span></pre><p id="6c44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.现在，我们使用twine上传下载的包，如<a class="ae jd" href="https://cloud.google.com/artifact-registry/docs/python/manage-packages" rel="noopener ugc nofollow" target="_blank"> Google Cloud文档</a>中所述(不要忘记将“my_project”替换为您的项目名称！)</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="2c16" class="lh jr hi ld b fi li lj l lk ll">pip install twine<br/>twine upload --repository-url <a class="ae jd" href="https://europe-west1-python.pkg.dev/my_project/medium/" rel="noopener ugc nofollow" target="_blank">https://europe-west1-python.pkg.dev/my_project/medium/</a> dist/* --skip-existing</span></pre><p id="63df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果twine挂在大量要上传的包上，请逐个上传:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="e685" class="lh jr hi ld b fi li lj l lk ll">for F in dist/*; do twine upload — repository-url <a class="ae jd" href="https://europe-west1-python.pkg.dev/my_project/medium/" rel="noopener ugc nofollow" target="_blank">https://europe-west1-python.pkg.dev/my_project/medium/</a> $F — skip-existing; done</span></pre><p id="d5ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">恭喜你，你的Python库已经上线了！</p><h1 id="f023" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">使用您的私有Python包存储库</h1><p id="a1ef" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/artifact-registry/docs/python/authentication" rel="noopener ugc nofollow" target="_blank">文档</a>以及许多博客和stackoverflow问题将告诉您做两件事:设置认证和配置pip以从工件注册中心的Python存储库中检索包。我们来看这两个步骤。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lm"><img src="../Images/940b630360bb68046f16f9faea300eaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oHxA_t5Ih583w_u6UZ4e7Q.png"/></div></div></figure><h1 id="e6c4" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">设置身份验证</h1><p id="a57d" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">在使用pip install从Artifact Registry中的存储库安装软件包之前，您需要启用pip来验证Artifact Registry。Pip不是一个Google Cloud感知工具，所以它需要某种机制来检索Google Cloud凭证。这个机制就是Google Cloud Artifact Registry插件的“keyring”包。使用pip install安装密匙环和插件。</p><p id="9eab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是等等……如果我不能访问互联网，也不能通过我的私有存储库进行认证，我该如何用插件安装这个密匙环呢？蛇咬自己的尾巴。</p><h2 id="627b" class="lh jr hi bd js ln lo lp jw lq lr ls ka iq lt lu ke iu lv lw ki iy lx ly km lz bi translated">最简单的方法</h2><p id="0129" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">这个问题最简单的解决方案是让管理员构建一个自定义容器。如果这个容器构建过程可以访问互联网，那么您可以将这些包作为Docker构建的一部分进行pip安装:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="0756" class="lh jr hi ld b fi li lj l lk ll">RUN pip install keyring==23.7.0<br/>RUN pip install keyrings.google-artifactregistry-auth==1.0.0</span></pre><p id="a530" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，这一步确实涉及到从公共PyPI安装这些包，这是我们试图避免的。但是我们需要在某个时候下载这些包，只要它在管理员的控制下，我们就可以，比如说，如果这些包已经被污染了，我们就可以取消发布容器。</p><h2 id="9777" class="lh jr hi bd js ln lo lp jw lq lr ls ka iq lt lu ke iu lv lw ki iy lx ly km lz bi translated">如果最简单的方法不适用</h2><p id="c965" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">最简单的方法是构建一个定制的映像，并在容器构建过程中使用互联网访问。如果您使用云构建来构建您的容器，那么云构建工作人员必须能够访问互联网。如果违反了这两个条件中的任何一个，我们就需要寻找另一个解决方案。</p><p id="f3f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">解决方案是让管理员下载包，就像我们之前从requirements.txt文件下载包一样。我们使用pip安装下载的文件，这将启用工件注册的认证。</p><p id="fe20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们只需要安装两个包:keyring和key rings . Google-artifact registry-auth。但是我们也需要他们的依赖。以及依赖关系的依赖关系。更不用说，<em class="ma">他们的</em>依赖关系了。你明白了。Pip下载将负责下载所有内容。总共有22个包，你需要按照正确的顺序安装。对于当前版本keyring 23.7.0和keyrings . Google _ artifact registry _ auth 1 . 0 . 0，以下是按有效顺序排列的列表:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="4532" class="lh jr hi ld b fi li lj l lk ll">jeepney-0.8.0-py3-none-any.whl<br/>typing_extensions-4.3.0-py3-none-any.whl<br/>zipp-3.8.1-py3-none-any.whl<br/>importlib_metadata-4.12.0-py3-none-any.whl<br/>pycparser-2.21-py2.py3-none-any.whl<br/>cffi-1.15.1-cp37-cp37m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl<br/>cryptography-37.0.4-cp36-abi3-manylinux_2_24_x86_64.whl<br/>SecretStorage-3.3.2-py3-none-any.whl<br/>keyring-23.7.0-py3-none-any.whl<br/>pyasn1–0.4.8-py2.py3-none-any.whl<br/>pyasn1_modules-0.2.8-py2.py3-none-any.whl<br/>rsa-4.9-py3-none-any.whl<br/>cachetools-5.2.0-py3-none-any.whl<br/>six-1.16.0-py2.py3-none-any.whl<br/>google_auth-2.9.1-py2.py3-none-any.whl<br/>certifi-2022.6.15-py3-none-any.whl<br/>charset_normalizer-2.1.0-py3-none-any.whl<br/>idna-3.3-py3-none-any.whl<br/>urllib3–1.26.11-py2.py3-none-any.whl<br/>requests-2.28.1-py3-none-any.whl<br/>pluggy-1.0.0-py2.py3-none-any.whl<br/>keyrings.google_artifactregistry_auth-1.0.0-py3-none-any.whl</span></pre><p id="eacf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">管理员可以通过云存储共享这些包，只要需要，用户就可以检索并安装它们。但是这有点麻烦，如果我们正在运行任何类型的分布式处理(例如，使用数据流)，我们将需要在每次新工人启动时经历这个过程，这将影响处理速度。最好是生成一个docker映像，并使用这个映像来启动新的工人。我不会在这里详细描述，但是如果你在数据流中使用自定义容器，你可以将所有的包下载到一个目录(例如pydist)中，并将其包含在docker文件中:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="2050" class="lh jr hi ld b fi li lj l lk ll">ADD pydist pydist<br/>RUN pip install pydist/jeepney-0.8.0-py3-none-any.whl<br/>RUN pip install pydist/typing_extensions-4.3.0-py3-none-any.whl<br/>RUN pip install pydist/zipp-3.8.1-py3-none-any.whl<br/>...</span></pre><p id="3370" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">诸如此类。</p><p id="e8a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我们安装了这些包，我们就可以运行keyring-list-backends，它应该会输出如下内容:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="3720" class="lh jr hi ld b fi li lj l lk ll">keyrings.gauth.GooglePythonAuth (priority: 9)<br/>keyring.backends.chainer.ChainerBackend (priority: -1)<br/>keyring.backends.fail.Keyring (priority: 0)</span></pre><p id="f2eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这意味着我们都准备好了。如果您尚未获得认证，请使用gcloud auth login获取您的凭据。现在，如果您运行pip install，它将能够通过您的存储库工件注册中心进行认证。也就是说，如果pip具有知道您的存储库在哪里的配置。我们一会儿会看到这是如何做到的，但是让我们思考一下。</p><h1 id="c778" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">装有我们需要的一切的定制容器</h1><p id="4a51" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">如果我们必须下载22个包，并可能构建一个自定义容器，这样我们就可以从工件注册表安装包…为什么我们不创建一个包含我们需要的所有包的自定义容器，这样我们就不需要安装任何东西了？</p><p id="78ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从性能和可重复性的角度来看，构建包含所有必需代码的自定义容器是推荐的做法。性能，因为容器启动时不需要安装工作。和可再现性，因为容器上的软件版本是固定的，而requirements.txt文件通常不指定(某些)包版本。</p><p id="7e22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是要做到这一点，我们需要知道我们需要的软件包的完整列表。当我们发现我们需要升级一个包时，我们需要重新构建容器。当我们需要添加一个我们以前没有使用过的包时也是如此。如果您有一个正在生产中工作的数据流管道或类似的东西，那么我们仍然建议为这个过程创建一个自定义容器。但是如果你的团队正在开发新的代码，构建新容器的管理开销将会非常高。例如，每当您想要安装Python包时，必须在新构建的容器上重新创建一个笔记本实例。所以Artifact Registry使得Python包的管理更加容易。</p><p id="64ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您需要使用您的项目中没有人使用过的包时，您的管理员只需从PyPI下载它，验证它没有漏洞(！idspnonenote)。)，并将其上传到工件注册表。</p><h1 id="0fa6" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">配置pip！</h1><p id="3ef1" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">您可以通过在每次调用时传递正确的命令行参数来配置pip，但是这很容易出错。<a class="ae jd" href="https://console.cloud.google.com/artifacts" rel="noopener ugc nofollow" target="_blank">工件注册表UI </a>有一个“设置说明”按钮</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mb"><img src="../Images/9398488c71e3054a18d54a7c65430d82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gcU4dblT0z_yv1-O"/></div></div></figure><p id="2cca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您单击它，它会告诉您运行这个命令(同样，用您的项目名称替换“my_project ”)</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="344e" class="lh jr hi ld b fi li lj l lk ll">gcloud artifacts print-settings python \<br/>  --project=my_project --repository=medium --location=europe-west1</span></pre><p id="13ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该命令的输出是一些您可以粘贴到pip配置文件中的配置。它会告诉pip添加一个“额外的索引URL”。这将导致pip查看公共PyPI和您的本地存储库。这很有用，所以你可以在内部发布你自己的包，而不会失去对PyPI的访问。不幸的是，这对我们不起作用。</p><p id="e80b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您无法访问互联网，pip将继续尝试检查PyPI。我们不需要添加额外的索引URL，我们需要设置<em class="ma">和</em>索引URL，并告诉pip不要查看其他地方。这将是“我的项目”的配置，它也禁用pip的更新检查:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="0708" class="lh jr hi ld b fi li lj l lk ll">[global]<br/>index-url = <a class="ae jd" href="https://europe-west1-python.pkg.dev/my_project/medium/simple/" rel="noopener ugc nofollow" target="_blank">https://europe-west1-python.pkg.dev/my_project/medium/simple/</a></span><span id="35a7" class="lh jr hi ld b fi mc lj l lk ll">[global]<br/>disable-pip-version-check = True</span></pre><p id="467b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将这些信息存储在一个名为pip.conf的文件中，并告诉pip使用它:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="04bd" class="lh jr hi ld b fi li lj l lk ll">export PIP_CONFIG_FILE=pip.conf</span></pre><p id="45b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果希望从任何目录都可以使用，请使用绝对路径。如果您正在构建一个定制的容器，那么您还需要在docker文件中包含这个配置:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="ed3d" class="lh jr hi ld b fi li lj l lk ll">COPY pip.conf pip.conf<br/>ENV PIP_CONFIG_FILE=pip.conf</span></pre><p id="c1e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您没有构建设置了这种配置的定制容器，那么每次容器启动后都必须执行这些步骤。如果你使用的是Vertex AI用户管理的笔记本，那么你可以为你的笔记本实例使用一个“启动后脚本”来实现自动化。您需要将脚本存储在云存储中，并将云存储的URL传递给<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/notebooks/instances/create#--post-startup-script" rel="noopener ugc nofollow" target="_blank">–post-startup-script参数</a>，例如:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="7bad" class="lh jr hi ld b fi li lj l lk ll">gcloud notebooks instances create example-instance \<br/>  --vm-image-project=deeplearning-platform-release \<br/>  --vm-image-family=caffe1-latest-cpu-experimental \<br/>  --machine-type=n1-standard-4 \<br/>  --location=us-central1-b \<br/>  --post-startup-script=gs://…</span></pre><p id="1ed7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以像往常一样使用pip install安装软件包:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="31e1" class="lh jr hi ld b fi li lj l lk ll">pip install packagename</span></pre><p id="f0bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查找输出的第一行，以验证pip正在查看正确的存储库:</p><pre class="jf jg jh ji fd lc ld le lf aw lg bi"><span id="7fb2" class="lh jr hi ld b fi li lj l lk ll">Looking in indexes: <a class="ae jd" href="https://europe-west1-python.pkg.dev/my_project/medium/simple/" rel="noopener ugc nofollow" target="_blank">https://europe-west1-python.pkg.dev/my_project/medium/simple/</a></span></pre><h1 id="898e" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">结论</h1><p id="1a1e" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">如果你已经走了这么远，那你就完了。现在，您已经将pip配置为在工件注册中心查询您的私有Python存储库。您还将它配置为能够通过工件注册中心进行认证，而不需要通过公共互联网！</p><p id="626c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">人们越来越意识到依赖公共软件库的安全隐患。我们希望这个指南能帮助你在Google Cloud上配置一个安全的环境。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/2e414194f124433d24dc8cd66dec1ede.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3t3C239SsVXPyEX5"/></div></div></figure><h1 id="635f" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">参考</h1><ol class=""><li id="4cea" class="kt ku hi ih b ii ko im kp iq md iu me iy mf jc ky kz la lb bi translated"><a class="ae jd" href="https://cloud.google.com/resources/delivering-software-securely-whitepaper" rel="noopener ugc nofollow" target="_blank">安全交付软件</a>，谷歌云白皮书</li><li id="c645" class="kt ku hi ih b ii mg im mh iq mi iu mj iy mk jc ky kz la lb bi translated"><a class="ae jd" href="https://cloud.google.com/artifact-registry/docs/how-to" rel="noopener ugc nofollow" target="_blank">神器登记文档</a></li><li id="6aae" class="kt ku hi ih b ii mg im mh iq mi iu mj iy mk jc ky kz la lb bi translated"><a class="ae jd" href="https://cloud.google.com/artifact-registry/docs/repositories/virtual-repo" rel="noopener ugc nofollow" target="_blank">在工件注册表</a>上创建虚拟存储库，工件注册表文档。截至2022年8月的私人预览功能。</li><li id="5d15" class="kt ku hi ih b ii mg im mh iq mi iu mj iy mk jc ky kz la lb bi translated"><a class="ae jd" href="https://cloud.google.com/artifact-registry/docs/python/manage-packages" rel="noopener ugc nofollow" target="_blank">管理Python包</a>，工件注册文档</li><li id="8268" class="kt ku hi ih b ii mg im mh iq mi iu mj iy mk jc ky kz la lb bi translated"><a class="ae jd" href="https://www.redhat.com/sysadmin/find-python-vulnerabilities" rel="noopener ugc nofollow" target="_blank">如何在你的Python代码中发现第三方漏洞</a>，红帽。pip审计说明。</li></ol><p id="5ac9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">—</p><p id="3281" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">图片来源:丹尼斯·巴尔姆</p></div></div>    
</body>
</html>