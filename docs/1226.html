<html>
<head>
<title>Partition on any field with BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用BigQuery对任何字段进行分区</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/partition-on-any-field-with-bigquery-840f8aa1aaab?source=collection_archive---------0-----------------------#2019-12-16">https://medium.com/google-cloud/partition-on-any-field-with-bigquery-840f8aa1aaab?source=collection_archive---------0-----------------------#2019-12-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c5d1c96513a1953dfb380cb2e9a3e93e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eDEy4S8zFfYnRt1X.png"/></div></div></figure><p id="0be9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据对公司至关重要。他们中的许多人拥有比处理能力更多的数据。而且，可悲的是，大量的值沉睡在数据库中。</p><p id="3f2e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">BigQuery是Google云平台产品，它解决了这个问题。<strong class="is hj"> BigQuery是一个Pb级的数据仓库</strong>，你可以在几秒钟内查询TB级的数据，你可以<strong class="is hj">释放你休眠数据的能量</strong>。</p><h1 id="e9d6" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">定价模型和划分问题</h1><p id="efb4" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">BigQuery有两种定价模式:<strong class="is hj">按需</strong>和<strong class="is hj">统一费率</strong></p><p id="7ab2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用<strong class="is hj">统一费率模型</strong>，您提交了许多“<a class="ae kr" href="https://cloud.google.com/bigquery/docs/slots" rel="noopener ugc nofollow" target="_blank">槽位</a>”(计算能力的单位)，并且您预先知道您将支付的账单。第一个统一费率承诺相当高(每月1万美元)，<strong class="is hj">建议大数据公司采用。</strong></p><p id="cf3e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用<strong class="is hj">按需模式</strong>，您需要根据扫描的数据量付费。这种模式非常适合初创、中型和小型公司。由于“<em class="ks">扫描的数据越多，支付的费用就越多</em>，为了限制成本，必须对数据进行优化，以减少读取的数据。为此，BigQuery <strong class="is hj">允许对数据进行分区，以缩小扫描的数据量</strong>。</p><p id="b652" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="ks">注意:区分扫描的数据量和返回的数据量很重要。一个</em> <code class="du kt ku kv kw b"><em class="ks">limit</em></code> <em class="ks">在查询结束时限制结果不是卷扫描。</em></p><h1 id="8fce" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">划分和聚类</h1><p id="72c4" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated"><strong class="is hj">分区和集群是两个特性，允许您缩小在数据库中扫描的数据量</strong>。</p><p id="cee0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">到目前为止，分区只能在日期:<a class="ae kr" href="https://cloud.google.com/bigquery/docs/creating-column-partitions" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">上，或者在时间戳字段</strong> </a> <strong class="is hj">上，或者在摄取时间</strong>  <strong class="is hj">上</strong> <a class="ae kr" href="https://cloud.google.com/bigquery/docs/creating-partitioned-tables" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">上；两者同一天粒度</strong>。像这样，为每天创建一个类似于“<em class="ks">子表”、</em>的分区。当你寻找一个数据时，只需指定日期(或日期范围)<strong class="is hj">，只查询感兴趣的分区，只扫描相关数据</strong>。</a></p><p id="cab6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">集群是分区内更细粒度的优化，类似于关系数据库中的复合索引。<a class="kx ky ge" href="https://medium.com/u/279fe54c149a?source=post_page-----840f8aa1aaab--------------------------------" rel="noopener" target="_blank"> Felipe Hoffa </a>(谷歌云开发者倡导者)发布了一篇关于这方面的文章</p><h1 id="71d8" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">整数范围划分</h1><p id="602a" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">2019年12月，Google已经发布了<strong class="is hj">新的分区能力:</strong> <a class="ae kr" href="https://cloud.google.com/bigquery/docs/creating-integer-range-partitions" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">整数范围分区</strong> </a>。这个特性允许您在同一个分区中存储同一个范围的所有值</p><p id="8654" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您必须定义最小值和最大值，以及范围大小。就这样，碎片是为你做的！<strong class="is hj">你有用户ID，邮政编码，地理坐标，(…)分区为你工作</strong>！</p><blockquote class="kz"><p id="3ddc" class="la lb hi bd lc ld le lf lg lh li jn dx translated">但是，如果我没有数值或日期值呢？</p></blockquote></div><div class="ab cl lj lk gp ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hb hc hd he hf"><h1 id="01fa" class="jo jp hi bd jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh lu kj kk kl bi translated">创建您定制的分区</h1><p id="56d2" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">通过允许整数分区，<strong class="is hj"> BigQuery允许您在任何字段上进行分区</strong> : Float、String、Date……为了实现这一点，您<strong class="is hj">必须在存储和查询数据时将分区字段转换成一个整数值</strong>。</p><h2 id="6016" class="lv jp hi bd jq lw lx ly ju lz ma mb jy jb mc md kc jf me mf kg jj mg mh kk mi bi translated">字符串字段上的分区</h2><blockquote class="kz"><p id="5d51" class="la lb hi bd lc ld le lf lg lh li jn dx translated">如果我的数据库中没有数字用户ID，只有电子邮件ID，如何对这个表进行分区？</p></blockquote><p id="3f09" class="pw-post-body-paragraph iq ir hi is b it mj iv iw ix mk iz ja jb ml jd je jf mm jh ji jj mn jl jm jn hb bi translated">为此，<strong class="is hj"> BigQuery有很多内置函数</strong>，其中一个就是<a class="ae kr" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/hash_functions#farm_fingerprint" rel="noopener ugc nofollow" target="_blank"> Farm-Fingerprint </a> hash函数。这个函数将您输入转换成一个带符号的INT64值。不要指望有1e+19分区来微调你的账单。根据<strong class="is hj"> BigQuery的限制和配额，</strong> <a class="ae kr" href="https://cloud.google.com/bigquery/quotas#partitioned_tables" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">每个表限制4000个分区</strong> </a> <strong class="is hj">。</strong></p><p id="5376" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，根据这个限制，您可以像这样创建最优化的表分区</p><figure class="mp mq mr ms fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/d2346ece40e192802d1bc369fa667b83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2NhUbAUw_fRGUlkvATIoWg.png"/></div></div></figure><p id="36d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，这个表上有多达4000个分区。在分区字段中填入正确的值</p><pre class="mp mq mr ms fd mt kw mu mv aw mw bi"><span id="f797" class="lv jp hi kw b fi mx my l mz na">INSERT INTO `data.string_partitioned_table` <br/>     VALUES ("string_example",        <br/>              ABS(MOD(FARM_FINGERPRINT("string_example"),4000)) + 1)</span></pre><p id="0781" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了检索符合正确分区的数据，通过使用相同的分区值处理</p><pre class="mp mq mr ms fd mt kw mu mv aw mw bi"><span id="41ff" class="lv jp hi kw b fi mx my l mz na">SELECT * <br/>FROM `data.string_partitioned_table` <br/>WHERE integer_partition_field =     <br/>           ABS(MOD(FARM_FINGERPRINT("string_example"),4000) + 1)</span></pre><h2 id="83ac" class="lv jp hi bd jq lw lx ly ju lz ma mb jy jb mc md kc jf me mf kg jj mg mh kk mi bi translated">每小时需要一个分区？</h2><p id="42d9" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated"><strong class="is hj"> BigQuery时间戳划分如今仅限于日粒度</strong>，而且不能有更细的粒度，例如，小时划分粒度。</p><p id="b507" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，整数分区可以很容易地解决这个问题。<strong class="is hj">我们只需简单地转换时间戳</strong>，这要感谢一个内置的BigQuery函数<code class="du kt ku kv kw b">UNIX_SECONDS </code>，它可以将时间戳转换为秒，一个整数！</p><p id="8ab5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="ks">注意:这也适用于毫秒和微秒。</em></p><p id="2ff0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从定义第一个分区开始。这里<code class="du kt ku kv kw b">2020-01-01 12am</code>。</p><pre class="mp mq mr ms fd mt kw mu mv aw mw bi"><span id="ab62" class="lv jp hi kw b fi mx my l mz na">select UNIX_SECONDS(TIMESTAMP("2020-01-01 00:00:00"))</span><span id="94e5" class="lv jp hi kw b fi nb my l mz na">#Result<br/>1577836800</span></pre><p id="0605" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，加上4000小时，得到你的最大上限<em class="ks">(大约166天)。</em>记住，BigQuery被限制为4000个分区</p><pre class="mp mq mr ms fd mt kw mu mv aw mw bi"><span id="2269" class="lv jp hi kw b fi mx my l mz na">select UNIX_SECONDS(TIMESTAMP_ADD(<br/>   TIMESTAMP("2020-01-01 00:00:00"), INTERVAL 4000 HOUR)<br/>)</span><span id="77be" class="lv jp hi kw b fi nb my l mz na">#Result<br/>1592236800</span></pre><p id="9566" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在创建你的表格，以秒为单位给出你的下限和上限，1小时的间隔-&gt; 3600秒</p><figure class="mp mq mr ms fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nc"><img src="../Images/75af5b7f274d54a8db74b5b3e8198a7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F3wvdY8g2eby1v4UdDpu2g.png"/></div></div></figure><p id="137e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，这个表上有多达4000个分区。在分区字段中填入正确的值</p><pre class="mp mq mr ms fd mt kw mu mv aw mw bi"><span id="cd9a" class="lv jp hi kw b fi mx my l mz na">INSERT INTO `data.hourly_partitioned_table`  <br/>     VALUES (TIMESTAMP("2020-03-28 08:00:00"),        <br/>              UNIX_SECONDS(TIMESTAMP("2020-03-28 08:00:00")))</span></pre><p id="4ce5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了检索符合正确分区的数据，通过使用相同的分区值处理</p><pre class="mp mq mr ms fd mt kw mu mv aw mw bi"><span id="a106" class="lv jp hi kw b fi mx my l mz na">SELECT * <br/>FROM `data.hourly_partitioned_table` <br/>WHERE integer_partition_field =     <br/>          UNIX_SECONDS(TIMESTAMP("2020-03-28 08:00:00"))</span></pre><p id="8e9d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，分区是连续的，你可以像这样搜索一个小时范围</p><pre class="mp mq mr ms fd mt kw mu mv aw mw bi"><span id="4c71" class="lv jp hi kw b fi mx my l mz na">SELECT * <br/>FROM `data.hourly_partitioned_table` <br/>WHERE integer_partition_field &gt;    <br/>          UNIX_SECONDS(TIMESTAMP("2020-03-28 08:00:00"))<br/>  AND integer_partition_field &lt;=<br/>          UNIX_SECONDS(TIMESTAMP("2020-03-28 18:00:00"))</span></pre></div><div class="ab cl lj lk gp ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hb hc hd he hf"><h1 id="7694" class="jo jp hi bd jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh lu kj kk kl bi translated">限制和制约因素</h1><p id="23f9" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">除了BigQuery中可能的4000个分区的<strong class="is hj">限制之外，<strong class="is hj">解决方案意味着添加一个额外的分区字段，并将其存储在您的表中</strong>。要激活分区，必须正确设置该分区字段。顺便说一下，当你执行摄取时，你有两个解决方案</strong></p><ul class=""><li id="98d9" class="nd ne hi is b it iu ix iy jb nf jf ng jj nh jn ni nj nk nl bi translated">在加载作业之前填充分区字段，或者在流插入之前填充到代码中</li><li id="5312" class="nd ne hi is b it nm ix nn jb no jf np jj nq jn ni nj nk nl bi translated">将数据加载到BigQuery中，并对这些数据执行<em class="ks">插入选择</em>。</li></ul><h2 id="3468" class="lv jp hi bd jq lw lx ly ju lz ma mb jy jb mc md kc jf me mf kg jj mg mh kk mi bi translated">加载前填写分区字段</h2><p id="9e2d" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated"><strong class="is hj">解决方案要求在加载作业之前对文件进行预处理</strong>，或者在代码中进行流插入之前进行额外的处理。</p><ul class=""><li id="cbe1" class="nd ne hi is b it iu ix iy jb nf jf ng jj nh jn ni nj nk nl bi translated">对于字符串字段类型，<code class="du kt ku kv kw b">FARM_FINGERPRINT</code>是一个开源的哈希函数，你可以很容易地重用它。</li><li id="89d5" class="nd ne hi is b it nm ix nn jb no jf np jj nq jn ni nj nk nl bi translated">对于日期字段类型，以秒为单位的时间戳转换是所有时间库中的标准转换。</li></ul><p id="0b9c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您使用 <strong class="is hj">自定义转换或散列</strong>，请记住，在插入BigQuery之前创建的分区字段的值必须在您的BigQuery查询中可重用。<a class="ae kr" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/user-defined-functions" rel="noopener ugc nofollow" target="_blank"> <em class="ks">【用户自定义功能】(UDF) </em> </a> <em class="ks">对此可以有所帮助。</em></p><h2 id="3c19" class="lv jp hi bd jq lw lx ly ju lz ma mb jy jb mc md kc jf me mf kg jj mg mh kk mi bi translated">执行插入-选择</h2><p id="fdce" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">如果<strong class="is hj">不想执行预处理</strong>，可以将数据<em class="ks">按原样</em>加载到BigQuery临时表中，然后<strong class="is hj">执行请求INSERT-SELECT到最终目的表</strong>。</p><pre class="mp mq mr ms fd mt kw mu mv aw mw bi"><span id="4cf8" class="lv jp hi kw b fi mx my l mz na"># For string partitioning<br/>INSERT INTO `data.string_partitioned_table` <br/>    SELECT string_field, <br/>           ABS(MOD(FARM_FINGERPRINT(string_field),4000) + 1) <br/>    FROM `data.string_partitioned_table_temp`</span><span id="59f2" class="lv jp hi kw b fi nb my l mz na"># For hourly partitioning<br/>INSERT INTO `data.hourly_partitioned_table`  <br/>    SELECT date, UNIX_SECONDS(date)<br/>    FROM `data.hourly_partitioned_table_temp`</span></pre><p id="4f0d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这种解决方案有几个限制</p><ul class=""><li id="85e4" class="nd ne hi is b it iu ix iy jb nf jf ng jj nh jn ni nj nk nl bi translated">你必须查询临时表中的数据，因此<strong class="is hj">你必须为这个查询</strong>付费。</li><li id="2b71" class="nd ne hi is b it nm ix nn jb no jf np jj nq jn ni nj nk nl bi translated">你受到限制，今天每天每桌<strong class="is hj">t</strong><a class="ae kr" href="https://cloud.google.com/bigquery/quotas#standard_tables" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">1000</strong></a><code class="du kt ku kv kw b"><a class="ae kr" href="https://cloud.google.com/bigquery/quotas#standard_tables" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">INSERTs</strong></a></code><a class="ae kr" href="https://cloud.google.com/bigquery/quotas#standard_tables" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"/></a>，与每天每桌加载作业的限制相同。</li><li id="b257" class="nd ne hi is b it nm ix nn jb no jf np jj nq jn ni nj nk nl bi translated">您必须管理临时表，因此在插入选择后，您<strong class="is hj">必须删除它们。</strong></li></ul></div><div class="ab cl lj lk gp ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hb hc hd he hf"><h1 id="9a00" class="jo jp hi bd jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh lu kj kk kl bi translated">划分任何字段</h1><p id="424d" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">然而，新的<strong class="is hj"> BigQuery特性开启了新的用例，而push进一步拓展了当前的限制</strong>。</p><p id="a488" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您可以<strong class="is hj">根据您的数据类型和结构以最相关的方式优化您的查询成本</strong>。分区不再局限于天数或整数！</p></div></div>    
</body>
</html>