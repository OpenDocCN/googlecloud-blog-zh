<html>
<head>
<title>Optimise Cloud logging in Google Cloud with logging query language</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用日志查询语言优化Google Cloud中的云日志</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/optimise-cloud-logging-in-google-cloud-with-logging-query-language-6f4e4ba417b0?source=collection_archive---------2-----------------------#2022-09-02">https://medium.com/google-cloud/optimise-cloud-logging-in-google-cloud-with-logging-query-language-6f4e4ba417b0?source=collection_archive---------2-----------------------#2022-09-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e3f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">您的云日志记录费用是否超出了您的预期？让我们来学习一种方法，把它们过滤掉，减少你每月的消费。</em></p><p id="a6e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在跳到步骤之前，我们先了解一下云日志定价是如何工作的。</p><p id="03a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于以下两个因素，云日志记录会产生费用:</p><ol class=""><li id="206c" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated"><strong class="ih hj">摄取</strong>:将数据写入云日志API，并将其路由到日志桶</li><li id="bf8a" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><strong class="ih hj">存储</strong>:记录日志桶中保留的数据</li></ol><p id="8604" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud在日志存储中自动创建两个存储桶，分别是<strong class="ih hj"> _Default </strong>和<strong class="ih hj"> _Required </strong>。</p><p id="29f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> _Required </strong>日志桶包含某些日志，如审计日志和透明日志，这些日志会自动进入该桶。我们不允许删除或编辑此存储桶。最重要的是，我们不为它的摄入和储存付费。但是，如果您想在其他存储桶中保存这些日志的副本，我们可能会收费。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/d23b4fdbeeb0c51d963de7bbf44dc0b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AOL5G_K2RuUxL7I4"/></div></div></figure><p id="7b29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了<strong class="ih hj"> _Required </strong>之外的桶将对其摄取和储存收费。目前，云日志记录为前30天的日志保留提供免费存储，而不考虑任何存储桶。发布日期<strong class="ih hj">2023年1月16日</strong>，存储费用将适用于保留超过30天的日志数据。请参考此处的文档<a class="ae ke" href="https://cloud.google.com/logging/quotas#logs_retention_periods" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="0c66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是云日志记录如何路由和存储日志条目的高级流程图。请参考此<a class="ae ke" href="https://cloud.google.com/logging/docs/routing/overview" rel="noopener ugc nofollow" target="_blank">链接</a>以阅读更多详细信息，了解如何通过日志记录获取日志，并使用接收器通过日志路由器路由日志。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es kf"><img src="../Images/d1b6be74cafdc5cafa72812d03cceccd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rr7smYFRTdm7I0fg"/></div></div></figure><p id="ce4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们知道日志路由器接收日志并将其路由到接收器。因此，为了过滤日志，我们必须设置一个或多个排除过滤器来排除来自接收器目的地的日志。</p><p id="ef93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">排除筛选器是使用日志记录查询语言创建的。我们可以在Google Cloud控制台的日志浏览器、日志API或命令行界面中使用日志查询语言。在这里阅读更多<a class="ae ke" href="https://cloud.google.com/logging/docs/view/logging-query-language" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="0881" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以基于以下字段构建查询:</p><ul class=""><li id="b7d3" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc kg jk jl jm bi translated">资源.类型</li><li id="5d89" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc kg jk jl jm bi translated">资源.标签. *</li><li id="ac94" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc kg jk jl jm bi translated">日志名</li><li id="3b14" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc kg jk jl jm bi translated">严重</li><li id="5743" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc kg jk jl jm bi translated">时间戳</li><li id="4a10" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc kg jk jl jm bi translated">insertId</li><li id="62c6" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc kg jk jl jm bi translated">操作. id</li><li id="3b31" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc kg jk jl jm bi translated">找到；查出</li><li id="7fef" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc kg jk jl jm bi translated">httpRequest.status</li><li id="6469" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc kg jk jl jm bi translated">标签。*</li><li id="591c" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc kg jk jl jm bi translated">Split.uid</li></ul><p id="394a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了这些字段之外，我们还可以构建查询，并基于我们的自定义字段对它们进行配置(目前在正式发布前)。这里详细阅读更多<a class="ae ke" href="https://cloud.google.com/logging/docs/analyze/custom-index" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="d23b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题陈述:</strong></p><p id="8e7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有些情况下，客户在不知情的情况下为Google Cloud中的云日志支付了过高的费用，他们也不知道如何过滤相关的日志。</p><p id="3433" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud建议使用日志查询语言来查询数据，并编写过滤器来创建汇和基于日志的指标。然而，有时事情并不那么简单。</p><p id="68a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">解决方案:</strong></p><p id="2a8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了解决这个问题，作为一个最佳实践，我们应该根据我们想要排除的字段在日志路由器接收器中添加排除过滤器。</p><p id="952b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要进入排除过滤器，请在GCP控制台中进入日志，然后单击左侧面板中的日志路由器(如下所述)。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/1d418e1becfaced60bb02c0ac7b9a535.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8mpUjfAz38OznpiY"/></div></div></figure><p id="f641" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击默认水槽/自定义水槽的三个垂直点，然后点击<strong class="ih hj">编辑水槽</strong>。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/67fc1d980d63cc46ed59dab94b1cace5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*r3EPd0dTdcWTmxnM"/></div></div></figure><p id="f880" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">向下滚动到<strong class="ih hj">选择要过滤掉的日志(可选)</strong>，然后点击<strong class="ih hj">添加排除</strong>。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/71884281f68fce2ed9b4671a56b487b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AwYOZrHzjxuxs8Cj"/></div></div></figure><p id="6285" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，假设您想要根据资源类型“Google App Engine”应用程序和严重性“默认”来过滤日志。为您的过滤器命名，如<strong class="ih hj"> sampleexclusionfilter，</strong>在排除中输入以下查询，然后单击<strong class="ih hj"> Update Sink </strong>。</p><p id="ae94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">T13】resource . type = " gae _ app "T15】</strong></p><p id="be5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">严重性=默认</em> </strong></p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/486db1ca2dc700d2c8a1f18176fe2bf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EEsLtsG5QGiclG3O"/></div></div></figure><p id="fa19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将从GAE应用程序中删除所有默认日志。类似地，您可以输入更多的查询，以根据日志名称、项目id、模块id和所选区域过滤掉接收器。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es kh"><img src="../Images/d235a8e8dd201748f851931bb4b7b4ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:524/0*nsnc19V7SR0bjxwe"/></div></figure><p id="2057" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Logs explorer中找出最大数量的不相关日志，并在exclusion filter中复制相同的查询，如上所述。</p><p id="5f1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">概要:</strong></p><p id="50a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是我们如何了解GCP云日志记录的定价因素、使用汇点通过日志路由器接收和路由日志的过程，以及最终我们如何在谷歌云平台中显著降低我们的云消费账单。</p><p id="cbee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">阅读更多关于云日志的</em> <a class="ae ke" href="https://cloud.google.com/logging#section-6" rel="noopener ugc nofollow" target="_blank"> <em class="jd">特性</em> </a> <em class="jd">。</em></p></div></div>    
</body>
</html>