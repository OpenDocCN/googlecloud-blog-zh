<html>
<head>
<title>Getting started with Google Cloud Monitoring APIs — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google云监控API入门—第2部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/fetching-monitoring-metrics-data-from-gcp-into-your-application-using-python-214358b0047e?source=collection_archive---------0-----------------------#2021-07-26">https://medium.com/google-cloud/fetching-monitoring-metrics-data-from-gcp-into-your-application-using-python-214358b0047e?source=collection_archive---------0-----------------------#2021-07-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/33cc5cbfd6bb232b6ed2455a7aa6caad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1JRkU_O63GncmX01QYCxTA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">GCP上的典型监控仪表板(针对计算实例)</figcaption></figure><p id="8618" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">你有一个关于GCP的项目。您已经在控制台中设置了监控控制面板，所有的图表都很有意义，而且只需通过一个用户界面，您就可以检查整个GCP环境。嗨，你这个监控专家！谢谢你把一切管理得这么好。</p><p id="5c5a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，如果您想在应用程序的某个部分使用这些度量图，该怎么办呢？也许你想用你的品牌颜色来格式化图表，提取实时数据并呈现在你的网站上。</p><blockquote class="js"><p id="eca0" class="jt ju hi bd jv jw jx jy jz ka kb jr dx translated">我们的API具有令人印象深刻的24x7响应时间！“来，看看我们网站上的这张图表。”</p></blockquote><figure class="kd ke kf kg kh ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kc"><img src="../Images/dbe12653df8bbada3f18cfabdf57312a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FvVbZccqMzFF3Ui-qJuMKA.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">给我那些图表！[图片由<a class="ae ki" href="https://unsplash.com/@mjessier?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">米利安·耶西耶</a>在<a class="ae ki" href="https://unsplash.com/s/photos/computer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄]</figcaption></figure><p id="6909" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在本系列的上一篇<a class="ae ki" rel="noopener" href="/google-cloud/confused-with-custom-monitoring-metrics-on-gcp-c514cd4a776b">博客</a>中，我写了如何使用Python客户端库为Google云监控API创建定制的监控指标，从而自动化这个过程。在这篇博客中，我将解释如何使用<code class="du kj kk kl km b">list_time_series</code>方法来读取度量数据并获取它供我们使用。快速提醒，指标数据被称为“时间序列数据”。</p><h1 id="0346" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">设置场景</h1><p id="397e" class="pw-post-body-paragraph iu iv hi iw b ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr hb bi translated">我强烈建议浏览之前的<a class="ae ki" rel="noopener" href="/google-cloud/confused-with-custom-monitoring-metrics-on-gcp-c514cd4a776b">博客</a>以了解度量标准，它们是如何存储的，以及您应该如何认证您的服务帐户以直接或通过客户端库使用这些API。</p><p id="049b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我已经在GCP的Jupyter笔记本上试过了，但是你可以在本地笔记本上或者在你的应用程序代码中使用这里解释的方法。在您的环境中安装<code class="du kj kk kl km b">google-cloud-monitoring</code>—</p><pre class="lq lr ls lt fd lu km lv lw aw lx bi"><span id="0a7a" class="ly ko hi km b fi lz ma l mb mc">pip install google-cloud-monitoring</span></pre><p id="799b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您可以获取GCP上任何受监控资源的度量数据。您可以在GCP文档中找到一个度量名称列表，以供您的应用程序参考，或者在GCP控制台上的monitoring部分下使用metric explorer进行实验。metrics explorer允许您根据资源类型、资源id等过滤出指标，还可以帮助您为这些过滤器构建查询，这些过滤器可以在您的应用程序中使用。如果过滤器在这里没有意义，不要担心，我们将在下一节讨论它们。</p><figure class="lq lr ls lt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/65464be7673104ccc39fe2613ad86f7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xeUABJccpNC_yIYXzpIbag.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">通过GUI在metric explorer中使用过滤器。或者，单击“MQL”选项卡获得等效的查询。</figcaption></figure><h1 id="9294" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">关于“列表时间序列”方法</h1><p id="3e4c" class="pw-post-body-paragraph iu iv hi iw b ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr hb bi translated"><code class="du kj kk kl km b">list_time_series</code>是客户端库中的方法，我们将使用它来获取时间序列数据。</p><pre class="lq lr ls lt fd lu km lv lw aw lx bi"><span id="9a74" class="ly ko hi km b fi lz ma l mb mc">results = client.list_time_series(<br/>    request={<br/>        "<strong class="km hj">name</strong>": project_name,<br/>        "<strong class="km hj">filter</strong>": 'metric.type = "compute.googleapis.com/instance/cpu/usage_time"',<br/>        "<strong class="km hj">interval</strong>": interval,<br/>        "<strong class="km hj">view</strong>": monitoring_v3.ListTimeSeriesRequest.TimeSeriesView.FULL,<br/>    }<br/>)</span></pre><p id="136d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用此方法发送的<strong class="iw hj">请求</strong>是调用<code class="du kj kk kl km b">list</code>方法的API的抽象，从名称就可以理解，并且可以与类似API调用中的请求体进行比较。在这个例子中我们有四个参数(顺序不重要)—</p><ol class=""><li id="a043" class="me mf hi iw b ix iy jb jc jf mg jj mh jn mi jr mj mk ml mm bi translated"><code class="du kj kk kl km b">name</code>:您要从中提取监视度量数据的项目的名称。</li><li id="ad97" class="me mf hi iw b ix mn jb mo jf mp jj mq jn mr jr mj mk ml mm bi translated"><code class="du kj kk kl km b">filter</code>:这是您指定想要的数据的度量的地方。在这个例子中，我们只有一个类型，但是它也可以有其他的<a class="ae ki" href="https://cloud.google.com/monitoring/custom-metrics/reading-metrics#time_series_filters" rel="noopener ugc nofollow" target="_blank">过滤器</a>，正如我前面提到的。我主要使用metric explorer来构建我的过滤查询。本质上，我们希望来自监控UI的输出是我们在应用程序中看到的输出，因此使用metric explorer验证您的查询是一个好主意。</li><li id="e131" class="me mf hi iw b ix mn jb mo jf mp jj mq jn mr jr mj mk ml mm bi translated"><code class="du kj kk kl km b">view</code>:该方法可能有两种响应——<br/><strong class="iw hj">I .完整视图:</strong>响应包含您的指标的元数据和时序数据，如<code class="du kj kk kl km b">points</code> <br/> <strong class="iw hj"> ii。标题视图</strong>:响应仅包含您的指标的元数据</li><li id="44ba" class="me mf hi iw b ix mn jb mo jf mp jj mq jn mr jr mj mk ml mm bi translated"><code class="du kj kk kl km b">interval</code>:需要数据的时间窗口。你必须指定<strong class="iw hj">参数</strong> <code class="du kj kk kl km b">start_time</code> <strong class="iw hj"> </strong>和<strong class="iw hj"> </strong> <code class="du kj kk kl km b">end_time</code> <strong class="iw hj"> </strong>其中时间输入在<a class="ae ki" href="https://www.epoch101.com/" rel="noopener ugc nofollow" target="_blank"> unix纪元</a>中。从UTC时间1970年1月1日午夜开始，以秒数的形式贡献你的时间值是一个想法。<br/>注意<strong class="iw hj">默认情况下，数据仅存储6周</strong>。如果您希望将监控数据保存更长时间，可以考虑将其转移到云存储或BigQuery之类的数据库中。</li></ol><pre class="lq lr ls lt fd lu km lv lw aw lx bi"><span id="78bb" class="ly ko hi km b fi lz ma l mb mc">interval = monitoring_v3.TimeInterval(<br/>    {<br/>        "<strong class="km hj">end_time</strong>": {"seconds": start_time, "nanos": nanos},<br/>        "<strong class="km hj">start_time</strong>": {"seconds": (start_time - seconds_in_a_month ), "nanos": nanos},<br/>    }<br/>)</span></pre><h1 id="5d85" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated"><strong class="ak">获取并绘制度量数据</strong></h1><p id="7dd3" class="pw-post-body-paragraph iu iv hi iw b ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr hb bi translated">我在下面的代码片段中使用了<code class="du kj kk kl km b">list_time_series</code>，并使用了<code class="du kj kk kl km b">matplotlib</code>(Python中的绘图库)来绘制API作为响应返回的<code class="du kj kk kl km b">points</code>。</p><figure class="lq lr ls lt fd ij"><div class="bz dy l di"><div class="ms mt l"/></div></figure><blockquote class="mu mv mw"><p id="77f9" class="iu iv mx iw b ix iy iz ja jb jc jd je my jg jh ji mz jk jl jm na jo jp jq jr hb bi translated">注意:在上面的代码片段中，<code class="du kj kk kl km b">results</code>存储API响应。<code class="du kj kk kl km b">results</code>是一个对象，您可以迭代它来获得度量数据。根据您指定的过滤器，每个对象都是一个资源/度量种类的<code class="du kj kk kl km b">points</code>的集合。时间序列数据即度量数据存储在<code class="du kj kk kl km b">points</code>中，可通过迭代<code class="du kj kk kl km b">result.points</code>来访问，其中<code class="du kj kk kl km b">result</code>是<code class="du kj kk kl km b">results</code>中的一个对象。</p></blockquote><p id="2aac" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">不像我，请多了解一下<a class="ae ki" href="https://matplotlib.org/" rel="noopener ugc nofollow" target="_blank"> Matplotlib </a>，更好的利用公制数据。这可能是一个很好的起点，但要走的路！这是上面代码片段的输出图:</p><figure class="lq lr ls lt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nb"><img src="../Images/f1fcb593367ee074c6ef27cebecef954.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C5mY3lfJMtU6g2o3XdWu2g.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">一个相当不像样的图表，但请利用你的审美和技术大脑。</figcaption></figure><p id="4c00" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果您的回答中有超过10，000个数据点，您可能无法看到回答中的所有数据点。这是因为，对于大型响应，响应由API自动分页，返回的是整个输出的<strong class="iw hj">第一页</strong>，包含<strong class="iw hj"> 10，000个</strong>点。我已经在下面的<a class="ae ki" href="https://towardsdatascience.com/missing-data-points-in-your-monitoring-api-response-use-page-iterators-81d27e954c70" rel="noopener" target="_blank">这篇博客</a>中详细讨论了这一点。:)</p><div class="nc nd ez fb ne nf"><a rel="noopener follow" target="_blank" href="/google-cloud/missing-data-points-in-your-monitoring-api-response-use-page-iterators-81d27e954c70"><div class="ng ab dw"><div class="nh ab ni cl cj nj"><h2 class="bd hj fi z dy nk ea eb nl ed ef hh bi translated">您的监控API响应中缺少数据点？使用页面迭代器！</h2><div class="nm l"><h3 class="bd b fi z dy nk ea eb nl ed ef dx translated">迭代器简化了通过API响应分页的过程。具有遵循列表的方法的API客户端…</h3></div><div class="nn l"><p class="bd b fp z dy nk ea eb nl ed ef dx translated">medium.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt io nf"/></div></div></a></div><p id="e76a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">注意:</strong>撰写这篇博文时，考虑到了产品和客户端库的最新版本。更多关于GCP监控的信息，请参见https://cloud.google.com/monitoring/docs<a class="ae ki" href="https://cloud.google.com/monitoring/docs" rel="noopener ugc nofollow" target="_blank"/>。</p></div></div>    
</body>
</html>