<html>
<head>
<title>Can you alert on logs in Stackdriver?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可以在Stackdriver中的日志上报警吗？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/can-you-alert-on-logs-in-stackdriver-7dfb07f495c0?source=collection_archive---------0-----------------------#2019-10-15">https://medium.com/google-cloud/can-you-alert-on-logs-in-stackdriver-7dfb07f495c0?source=collection_archive---------0-----------------------#2019-10-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="0c9c" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="1729" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我从使用Stackdriver日志记录和监控中的一个或两个的人那里听到的一个更常见的问题是“我如何在我的日志中创建错误警报？”一般来说，他们问有两个原因:</p><ol class=""><li id="d33a" class="kb kc hi jf b jg kd jk ke jo kf js kg jw kh ka ki kj kk kl bi translated">他们真的希望每次记录错误时都能得到通知——正如您所料，这是我与他们讨论可靠性目标、SLO和良好警报实践的机会。</li><li id="2286" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">他们将日志作为一种SLI，当符合某些标准(例如错误)的消息数量超过特定阈值时，他们确实需要得到提醒。</li></ol><p id="edd1" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">在这篇文章中，我将讨论后一种情况。我将首先介绍日志和指标通常用于什么，以及它们包含的数据种类。接下来，我将回顾如何从Stackdriver中的日志创建指标，并使用这些指标在仪表板和警报中创建图表。</p><p id="060b" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">请注意，Stackdriver团队的产品经理Mary Koes在<a class="ae ku" href="https://cloud.google.com/logging/docs/logs-based-metrics/charts-and-alerts" rel="noopener ugc nofollow" target="_blank">文档</a>和这篇精彩的博客<a class="ae ku" href="https://cloud.google.com/blog/products/gcp/extracting-value-from-your-logs-with-stackdriver-logs-based-metrics" rel="noopener ugc nofollow" target="_blank">帖子</a>中已经介绍了很多这方面的信息。然而，这是我试图用实际例子来创建一个连贯的故事，说明如何在Stackdriver中开始使用基于日志的指标。</p><h1 id="ca39" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">日志和指标</h1><p id="f87d" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在我们开始之前，重要的是对我们谈论日志和指标时的确切含义有一个共同的理解。合在一起，它们是可观察性的三个支柱中的两个(痕迹是第三个)。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es kv"><img src="../Images/1a2f5ce88a2080fb1d2f646d01971948.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/0*kDh7IgLfEnhXv4lz"/></div></figure><blockquote class="ld le lf"><p id="75aa" class="jd je lg jf b jg kd ji jj jk ke jm jn lh kr jq jr li ks ju jv lj kt jy jz ka hb bi translated"><strong class="jf hj">注意</strong>我这里一般指的是“可观测性1.0”。就可观察性而言，我很乐意听从像慈善专业人士和利兹·方-琼斯这样的人的意见。你可以从阅读《慈善回顾》开始<a class="ae ku" href="https://thenewstack.io/observability-a-3-year-retrospective/" rel="noopener ugc nofollow" target="_blank">这里</a>，以及<a class="ae ku" href="https://twitter.com/el_bhs" rel="noopener ugc nofollow" target="_blank">本·西格曼</a>在<a class="ae ku" href="https://lightstep.com/blog/three-pillars-zero-answers-towards-new-scorecard-observability/" rel="noopener ugc nofollow" target="_blank">这里</a>直接阐述三大支柱的理念。</p></blockquote><p id="f097" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">解决了这个问题，让我们回到手头的问题上来。我们使用<strong class="jf hj">日志</strong>作为数据点，具体描述我们系统中发生的事件。日志是由我们的代码、运行代码的平台以及我们所依赖的基础设施编写的(出于本文的目的，我不讨论审计日志，我将在另一篇文章中直接讨论它们)。因为现代系统中的日志是写入磁盘的文本日志文件的后代(有时仍然是),所以我认为日志条目(类似于日志文件中的一行)是日志记录的量子单元。一个条目通常由两部分组成——一个时间戳，表示事件发生的时间或者事件被接收到我们的日志记录系统的时间；以及文本负载，可以是非结构化文本数据，也可以是结构化数据，在JSON中最常见。日志还可以携带相关的元数据，特别是当它们被接收到Stackdriver中时，比如写它们的资源、日志名称和每个条目的严重性。我们使用日志有两个主要目的:</p><ul class=""><li id="f5fc" class="kb kc hi jf b jg kd jk ke jo kf js kg jw kh ka lk kj kk kl bi translated">事件日志描述了在我们的系统中发生的特定事件——我们可以使用它们来输出消息，向开发人员保证事情运行良好(“任务成功”)或者在事情不顺利时提供信息(“从服务器收到异常”)。</li><li id="866d" class="kb kc hi jf b jg km jk kn jo ko js kp jw kq ka lk kj kk kl bi translated">事务日志描述了系统或组件处理的每个事务的详细信息。例如，负载平衡器将记录它收到的每个请求，无论它是否成功完成，并包括附加信息，如请求的URL、HTTP响应代码，以及可能的信息，如哪个后端用于服务请求。</li></ul><p id="df55" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated"><strong class="jf hj">另一方面，度量</strong>通常不被认为是描述特定事件的(同样，这正在改变)。更常见的是，它们用于表示系统随时间变化的状态或健康状况。指标由一系列点组成，每个点都包含时间戳和一个数值。指标也有与之相关的元数据——通常称为时间序列的一系列点将包括名称、描述等内容，通常还包括标签，以帮助确定哪个资源正在编写指标。</p><p id="4964" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">特别是在Stackdriver中，指标是唯一一种可用于通过警报策略创建警报的数据。因此，理解如何使用日志来创建指标非常重要——让我们现在就开始吧。</p><h1 id="3456" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">基于日志的指标</h1><p id="d5e2" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">术语“基于日志的度量”是特定于Stackdriver的，但其思想相当简单。首先，Stackdriver提供了一种简单的机制来计算每分钟匹配过滤器的日志条目的数量，这被称为“计数器度量”。例如，如果我们想要使用负载平衡器日志作为服务可用性的服务级别指标，我们将使用这种方法。我们可以创建一个指标来计算我们将看到多少错误，并且我们将使用一个警报策略在该值超过我们认为可接受的阈值时发出警报。这个过程在这里有记录<a class="ae ku" href="https://cloud.google.com/logging/docs/logs-based-metrics/counter-metrics" rel="noopener ugc nofollow" target="_blank">，但是我发现一个具体的例子总是有帮助的。</a></p><h1 id="1013" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">计数器度量—错误</h1><p id="48c4" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">让我们看一个简单的例子。我已经创建了一个简单的<a class="ae ku" href="https://github.com/yuriatgoogle/stack-doctor/blob/master/log-based-metrics/errors/errors.js" rel="noopener ugc nofollow" target="_blank">示例</a>，它在20%的情况下都会写一个错误。当我通过Google Cloud SDK认证后在本地运行代码时，下面是日志条目:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ll"><img src="../Images/8901fbe060f807c7bce401d62c8c936c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BZkvwqCiYP__4t3M"/></div></div></figure><p id="122b" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">从这里开始，我想知道我的错误率何时超过特定的阈值。首先，我需要为所有包含错误的日志创建一个过滤器。一种简单的方法是展开日志，在有效负载中找到我想要的消息，单击它，然后选择show matching entries。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lq"><img src="../Images/e861c289215d615cd3e297efd5480f56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8vp-0suS9iEWjfhl"/></div></div></figure><p id="fcce" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">这将创建一个高级过滤器，并向我显示失败消息:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ll"><img src="../Images/169ddd5fbd83f2d8316464ae290f2670.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*A6SiV8nFh9yYFPMI"/></div></div></figure><p id="b51c" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">接下来，我可以使用Create Metric特性来创建计数器指标:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ll"><img src="../Images/ecfd91322b30ab41ce4576c1a2724102.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Z34Db4-W4nu1V9T_"/></div></div></figure><p id="a075" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">单击“Create Metric”后，我可以转到Stackdriver Monitoring并在那里看到它:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ll"><img src="../Images/2061cc8a991ec3a8323b4f1d952fa42c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lLSi3HWqMlrzR7rs"/></div></div></figure><h1 id="dfad" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">分布指标—延迟</h1><p id="6fe3" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">既然您已经看到了如何创建一个简单的计数器指标来跟踪每分钟的错误数量，那么让我们看看我们可能希望使用基于日志的指标的另一个原因——跟踪日志有效负载中的特定数值。我创建了第二个<a class="ae ku" href="https://github.com/yuriatgoogle/stack-doctor/blob/master/log-based-metrics/latency/latency.js" rel="noopener ugc nofollow" target="_blank">示例</a>——这一次，我在代码中引入一个随机生成的延迟，并将其记录为延迟。这是有效载荷的样子:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lr"><img src="../Images/2cefe98659ac3a5d8e428e53b05502cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*umpSver5BzDZWQq-"/></div></div></figure><p id="348d" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">我想创建一个指标来获取“消息”字段中的值。为此，我再次使用“Show matching entries”特性，并从选择中创建一个指标。我需要使用一个正则表达式来解析字段并提取数值。</p><blockquote class="ld le lf"><p id="8565" class="jd je lg jf b jg kd ji jj jk ke jm jn lh kr jq jr li ks ju jv lj kt jy jz ka hb bi translated"><strong class="jf hj">注意</strong>我修改了选择过滤器，通过使用logName过滤器来查找来自运行Node.js代码的本地机器的所有消息。</p></blockquote><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ll"><img src="../Images/2f46f1ebe81f12307d7f0babaa676258.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WMaGZXDuOYHOBX3U"/></div></div></figure><p id="063e" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">和前面一样，我创建了指标，并在指标浏览器中查看它:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ll"><img src="../Images/61dc42499145ad4896afa4e920a6a254.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aZv53HZBV2DeEZWl"/></div></div></figure><h1 id="e66b" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">使用指标</h1><p id="88c4" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">现在我们已经创建了我们的指标，我们可以像使用Stackdriver监控中的任何其他指标一样使用它们。我们可以用它们创建图表，并在警报策略中使用它们。</p><h1 id="4c1c" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">图表</h1><p id="5e4a" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">例如，我为延迟创建了一个图表，并将其记录为日志值:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ls"><img src="../Images/fc0d5a527df7b18eca959dd4c73942b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JV8Smw7f_ljdGvYr"/></div></div></figure><p id="47ad" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">基于日志的指标的一个优点是，您可以很容易地看到为其提供信息的日志。单击图表的3点菜单，并选择查看日志:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lt"><img src="../Images/c3176b5dc5a2cde5b9a3b4edbf0dc735.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iTDvuHbwL8pPlpDM"/></div></div></figure><p id="bee9" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">结果是一个高级过滤器，向您显示在图表或控制面板设置选择的时间范围内摄取的日志:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ll"><img src="../Images/e62e1922ce58f340214bc03fa88506e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*be8xEdADnlsKPqx8"/></div></div></figure><h1 id="75a8" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">警报</h1><p id="8866" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">为了解决开始时提出的原始问题，我们还可以使用我们的指标作为警报的基础。例如，如果我们想知道我们的错误率何时超过特定阈值，我们可以简单地在警报策略条件中使用我们的错误度量:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ll"><img src="../Images/477b72faedc9f4ef9f9a428064b9aea4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Raof2DP3oaTlt-io"/></div></div></figure><p id="19e2" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">我们可以对捕获延迟的分布指标做同样的事情:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ll"><img src="../Images/319afaa85819e36cb80f38df98db2647.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Kia_BQD4_C9ZDNEC"/></div></div></figure><blockquote class="ld le lf"><p id="7466" class="jd je lg jf b jg kd ji jj jk ke jm jn lh kr jq jr li ks ju jv lj kt jy jz ka hb bi translated"><strong class="jf hj">注意</strong>直到大约一周前，文档还声明分发指标不支持警报——这不是真的，您可以通过使用百分位数对齐器对分发指标发出警报(感谢<a class="ae ku" href="https://twitter.com/summitraj" rel="noopener ugc nofollow" target="_blank">峰会</a>捕捉到文档错误)。</p></blockquote><h1 id="11c7" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">总结和结论</h1><p id="575a" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我希望您现在能够更好地理解如何从Stackdriver中的日志创建指标，以及如何使用这些指标通过图表可视化数据，并通过警报策略创建警报。一如既往，我感谢您的反馈、问题和对未来主题的想法。</p></div></div>    
</body>
</html>