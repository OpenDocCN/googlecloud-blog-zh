<html>
<head>
<title>Mega8s: A Complex Kubernetes Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Mega8s:一个复杂的Kubernetes星团</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/mega8s-1c341043511e?source=collection_archive---------1-----------------------#2018-05-02">https://medium.com/google-cloud/mega8s-1c341043511e?source=collection_archive---------1-----------------------#2018-05-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0586" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">帮助重现一个客户的问题需要创建一个Kubernetes集群，这个集群比我以前创建的大约400个带有网络负载平衡器的服务要大。这需要大量增加配额</p><h2 id="4489" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">定额</h2><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="2da3" class="jd je hi kd b fi kh ki l kj kk">CPUs: 96<br/>IPs: 96<br/>PD: 9182 (GB)<br/>Firewalls: 500<br/>Forwarding Rules: 500<br/>Target Pools: 500<br/></span></pre><blockquote class="kl km kn"><p id="5c12" class="if ig ko ih b ii ij ik il im in io ip kp ir is it kq iv iw ix kr iz ja jb jc hb bi translated">我确定的CPU和IP配额远远超过了实际需要。之前对此记录的尝试调配了比最终运行所需更多的CPU。</p></blockquote><p id="c81c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在我的首选<code class="du ks kt ku kd b">us-west1</code>中创建了一个可抢占的1x4区域集群。</p><h2 id="15d4" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">状态</h2><p id="a5d7" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">这是事后的事；我曾经部署了400项服务，这些服务提供了400个网络LBs:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="528d" class="jd je hi kd b fi kh ki l kj kk">kubectl get deployments \<br/>--namespace=$NAMESPACE \<br/>--output=name \<br/>| wc --lines<br/>400</span><span id="da7b" class="jd je hi kd b fi la ki l kj kk">kubectl get services \<br/>--namespace=$NAMESPACE \<br/>--output=name \<br/>| wc --lines<br/>400</span><span id="f315" class="jd je hi kd b fi la ki l kj kk">kubectl get pods \<br/>--namespace=$NAMESPACE \<br/>--output=name \<br/>| wc --lines<br/>400</span></pre><p id="c7db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个服务都有<code class="du ks kt ku kd b">--type=LoadBalancer</code>，Kubernetes需要一些时间对所有这些进行编程:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="d423" class="jd je hi kd b fi kh ki l kj kk">gcloud compute forwarding-rules list \<br/>--format="value(name)" \<br/>--project=$PROJECT \<br/>| wc --lines<br/>401</span><span id="094a" class="jd je hi kd b fi la ki l kj kk">gcloud compute instances list \<br/>--format="value(name)" \<br/>--project=$PROJECT \<br/>| wc --lines<br/>4</span></pre><blockquote class="kl km kn"><p id="bc36" class="if ig ko ih b ii ij ik il im in io ip kp ir is it kq iv iw ix kr iz ja jb jc hb bi translated"><strong class="ih hj">NB</strong>“401”——吗？？？参见下面的解释</p></blockquote><p id="385c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有4个(！)节点——每个节点运行100个pod(一个pod/服务),尽管每个pod都很小(2.5MB ),但这一点令人印象深刻</p><figure class="jy jz ka kb fd lc er es paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="er es lb"><img src="../Images/146bb7364ba03102073b4e50fb83add5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kKn0YxBmhiKoSQZJt9AW2g.png"/></div></div></figure><blockquote class="kl km kn"><p id="4929" class="if ig ko ih b ii ij ik il im in io ip kp ir is it kq iv iw ix kr iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>很难展示400个服务……我向你保证前面的服务也存在。</p></blockquote><h2 id="a345" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">怎么会？</h2><p id="67f6" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">巴什-福和我的巴什并不出色；-)</p><p id="be6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请参见下文，了解如何为gRPC服务和云端点部署创建容器。</p><p id="e486" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设您有一个代表gRPC服务器的容器:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="9265" class="jd je hi kd b fi kh ki l kj kk">gcr.io/${PROJECT}/grpc-server:latest</span></pre><p id="268e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一些部署和服务。我建议你逐渐开始:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="0369" class="jd je hi kd b fi kh ki l kj kk">PROJECT=[[YOUR-PROJECT]]<br/>NAMESPACE=[[YOUR-NAMESPACE]]            # fourhundred</span><span id="383c" class="jd je hi kd b fi la ki l kj kk">kubectl create namespace ${NAMESPACE}</span><span id="7892" class="jd je hi kd b fi la ki l kj kk">for NUM in $(seq -f "%03g" 0 9)<br/>do<br/>  echo "Service: service-${NUM}"<br/>  kubectl run service-${NUM} \<br/>  --image=gcr.io/${PROJECT}/grpc-server:latest \<br/>  --port=10000 \<br/>  --namespace=${NAMESPACE}<br/>  kubectl expose deployment/service-${NUM} \<br/>  --protocol=TCP \<br/>  --port=10000 \<br/>  --target-port=10000 \<br/>  --type=LoadBalancer \<br/>  --namespace=${NAMESPACE}<br/>  kubectl label service/service-${NUM} grpc=true service=whoami \<br/>  --namespace=${NAMESPACE}<br/>done</span></pre><blockquote class="kl km kn"><p id="e56b" class="if ig ko ih b ii ij ik il im in io ip kp ir is it kq iv iw ix kr iz ja jb jc hb bi translated"><strong class="ih hj">NB</strong><code class="du ks kt ku kd b">Service</code>使用端口<code class="du ks kt ku kd b">10000</code>,<code class="du ks kt ku kd b">Deployment</code>的吊舱露出端口<code class="du ks kt ku kd b">10000</code>，吊舱中的集装箱监听<code class="du ks kt ku kd b">10000</code>。这相当于Docker的<code class="du ks kt ku kd b">--publish=10000:10000</code>。</p></blockquote><p id="331c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用我之前展示的命令来检查进度:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="7c82" class="jd je hi kd b fi kh ki l kj kk">kubectl get deployments \<br/>--namespace=${NAMESPACE} \<br/>--output=name \<br/>| wc --lines</span><span id="90fd" class="jd je hi kd b fi la ki l kj kk">kubectl get pods \<br/>--namespace=${NAMESPACE} \<br/>--output=name \<br/>| wc --lines</span><span id="ce38" class="jd je hi kd b fi la ki l kj kk">gcloud compute forwarding-rules list \<br/>--format="value(name)" \<br/>--project=$PROJECT \<br/>| wc --lines</span></pre><p id="b982" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>第一个命令使用<code class="du ks kt ku kd b">kubectl</code>，第二个命令使用<code class="du ks kt ku kd b">gcloud</code>。创建网络LBs(由<code class="du ks kt ku kd b">forwarding-rules</code>表示)需要一点时间。</p><p id="6511" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您对所拥有的东西有信心时，您可以在脚本中突破下限和上限，并再次运行它。</p><h2 id="2bb0" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">延期:整理</h2><p id="c00b" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">要删除部署和服务:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="cdbb" class="jd je hi kd b fi kh ki l kj kk">NAMESPACE=[[YOUR-NAMESPACE]]</span><span id="9359" class="jd je hi kd b fi la ki l kj kk">for NUM in $(seq -f "%03g" 0 9)<br/>do<br/>  echo "Service: service-${NUM}"<br/>  kubectl delete deployment/service-${NUM} --namespace=${NAMESPACE}<br/>  kubectl delete service/service-${NUM} --namespace=${NAMESPACE}<br/>done</span></pre><p id="1260" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>确保您正确设置了下限(当前为<code class="du ks kt ku kd b">0</code>)和上限(当前为<code class="du ks kt ku kd b">9</code>)以删除您的所有服务。</p><p id="e77d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以重新运行之前显示的命令，以确保将<code class="du ks kt ku kd b">Deployments</code>、<code class="du ks kt ku kd b">Services</code>、<code class="du ks kt ku kd b">Pods</code>和LBs ( <code class="du ks kt ku kd b">forwarding-rules</code>)降到零。或者，您可以敲打名称空间，这应该会删除所有内容:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="3dc8" class="jd je hi kd b fi kh ki l kj kk">kubectl delete namespace/${NAMESPACE}</span></pre><h2 id="da32" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">测试</h2><p id="6b67" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">我们现在有一些网络LB(转发规则),通过每个服务的网络LB在端口<code class="du ks kt ku kd b">9000</code>上公开我们的gRPC服务(本身运行在端口<code class="du ks kt ku kd b">10000</code>上)。这个脚本列举了所有服务的端点(有些可能还没有IP地址，这些被忽略了)，然后它随机选择一个端点并调用它。这不是重要的负载测试，但却是负载测试:-)</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="ea9c" class="jd je hi kd b fi kh ki l kj kk">NAMESPACE=[[YOUR-NAMESPACE]]</span><span id="d71b" class="jd je hi kd b fi la ki l kj kk">unset LB<br/>LB=()<br/>for IP in $(kubectl get services \<br/>--selector=grpc==true,service==whoami \<br/>--namespace=${NAMESPACE} \<br/>--output=json \<br/>| jq --raw-output '.items[] | .status.loadBalancer.ingress[0].ip | select(.!=null)')<br/>do<br/>  LB+=(${IP})<br/>done</span><span id="faf4" class="jd je hi kd b fi la ki l kj kk">while :<br/>do<br/>  TEST_LB=${LB[$RANDOM % ${#LB[@]} ]}<br/>  ./grpc-client --host=${TEST_LB} --port=10000<br/>done</span></pre><blockquote class="kl km kn"><p id="bc7a" class="if ig ko ih b ii ij ik il im in io ip kp ir is it kq iv iw ix kr iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>如果您大幅修改了磅数(向上或向下)，您应该重新运行整个脚本。如果你有相同数量的LBs，一些可能随后获得了一个IP地址。如果你只是想像以前一样使用相同的LBs再次运行，你可以只运行<code class="du ks kt ku kd b">while</code>循环。</p></blockquote><h2 id="dd22" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">可选:云端点</h2><p id="811e" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">谷歌的说明在这里:</p><p id="2972" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae lj" href="https://cloud.google.com/endpoints/docs/grpc/get-started-grpc-kubernetes-engine" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/endpoints/docs/grpc/get-started-grpc-kubernetes-engine</a></p><p id="ea20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想使用云端点部署gRPC服务的另一个实例，您需要</p><ul class=""><li id="3302" class="lk ll hi ih b ii ij im in iq lm iu ln iy lo jc lp lq lr ls bi translated">启用云端点</li><li id="ea1f" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated">生成原型描述符</li><li id="d676" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated">部署服务配置</li><li id="08dd" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated">使用*端点边车部署gRPC WhoService *</li><li id="fbf9" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated">测试一下！</li></ul><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="4d67" class="jd je hi kd b fi kh ki l kj kk">gcloud services enable endpoints.googleapis.com \<br/>--project=$PROJECT</span></pre><p id="4d81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们必须生成一个伴随<code class="du ks kt ku kd b">api_config.yaml</code>文件的原型描述符(<code class="du ks kt ku kd b">api_descriptor.pb</code>)来创建端点服务。以下是我建议您从包含<code class="du ks kt ku kd b">whoami</code>目录的工作目录开始执行的步骤，该目录本身包含<code class="du ks kt ku kd b">whoami.proto</code>和<code class="du ks kt ku kd b">api_config.yaml</code>文件:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="6873" class="jd je hi kd b fi kh ki l kj kk">virtualenv env<br/>source venv/bin/activate<br/>pip install grpcio-tools</span><span id="8ccb" class="jd je hi kd b fi la ki l kj kk">python -m grpc_tools.protoc \<br/>--include_imports \<br/>--include_source_info \<br/>--proto_path=./whoami \<br/>--descriptor_set_out=./whoami/api_descriptor.pb \<br/>whoami.proto</span></pre><p id="dc68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后部署服务配置:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="d912" class="jd je hi kd b fi kh ki l kj kk">gcloud endpoints services deploy api_descriptor.pb api_config.yaml \<br/>--project=$PROJECT</span></pre><p id="e30d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果成功，将返回:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="a432" class="jd je hi kd b fi kh ki l kj kk">Service Configuration [2018-05-02r0] uploaded for service [whoservice.endpoints.[[YOUR-PROJECT]].cloud.goog]</span></pre><p id="b142" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，云端点知道了我们的API会带来什么，我们需要部署实现它的gRPC WhoService:</p><figure class="jy jz ka kb fd lc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><blockquote class="kl km kn"><p id="e04a" class="if ig ko ih b ii ij ik il im in io ip kp ir is it kq iv iw ix kr iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>请将第20行的<code class="du ks kt ku kd b">[[YOUR-PROJECT]]</code>替换为您的GCP项目的价值。</p></blockquote><p id="8db6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="e427" class="jd je hi kd b fi kh ki l kj kk">kubectl apply --filename=deployment.yaml</span></pre><p id="0213" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过以下方式确认:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="660d" class="jd je hi kd b fi kh ki l kj kk">kubectl get deployment/grpc-server<br/>kubectl get service/grpc-server</span></pre><p id="f111" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将重用之前在bash脚本中使用的机制来标识由该部署创建的网络LB的IP地址:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="21ff" class="jd je hi kd b fi kh ki l kj kk">ENDPOINTS_IP=$(\<br/>  kubectl get service grpc-server \<br/>  --output=jsonpath="{.status.loadBalancer.ingress[0].ip}")<br/>echo ${ENDPOINTS_IP}</span></pre><p id="108d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为配置网络LB需要一点时间，所以重复该命令，直到获得一个IP。一切都很好:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="0eec" class="jd je hi kd b fi kh ki l kj kk">while :<br/>do<br/>  ./grpc-client \<br/>  --host=${ENDPOINTS_IP} \<br/>  --port=9000<br/>done</span></pre><blockquote class="kl km kn"><p id="76a7" class="if ig ko ih b ii ij ik il im in io ip kp ir is it kq iv iw ix kr iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>通过端点，我们与边车通信，边车与我们的gRPC服务器通信。为了说明这一点，我们使用<code class="du ks kt ku kd b">9000</code>作为代理，而我们的服务仍然在<code class="du ks kt ku kd b">10000</code>上。</p></blockquote><p id="5228" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">端点为我们提供了一个仪表板:</p><figure class="jy jz ka kb fd lc er es paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="er es ma"><img src="../Images/772e0788e84a3cf5a308c7b08979efcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xgeHdi_dQHErvgZ1CuXCbQ.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">云端点</figcaption></figure><figure class="jy jz ka kb fd lc er es paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="er es mf"><img src="../Images/33359b519bc1376d1c9163e0813fef8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hodt-QYdTcgy9RbHCbPB1g.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">云迹</figcaption></figure><p id="0c5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">…还有痕迹！！Woot</p><h2 id="9630" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">Stackdriver Kubernetes</h2><p id="3897" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">如果<a class="ae lj" href="https://cloudplatform.googleblog.com/2018/05/Announcing-Stackdriver-Kubernetes-Monitoring-Comprehensive-Kubernetes-observability-from-the-start.html" rel="noopener ugc nofollow" target="_blank">这个</a>在2天前宣布的话，我就可以向你展示这个具有令人敬畏的新Kubernetes监控的集群:-(</p><h2 id="84a8" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">gRPC Whoami</h2><p id="4df6" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">哎呀，我从某人那里抄袭了这个，但是不记得在哪里了。亲爱的开发者，很抱歉没有提到你的名字</p><p id="6aaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我寻求一个简单的gRPC服务来模拟客户的体验。我还使用云端点部署了该服务的一个实例。</p><figure class="jy jz ka kb fd lc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><blockquote class="kl km kn"><p id="4803" class="if ig ko ih b ii ij ik il im in io ip kp ir is it kq iv iw ix kr iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>请用你的<code class="du ks kt ku kd b">github.com/your-name</code>目录路径替换<code class="du ks kt ku kd b">client.go</code>的第8行和<code class="du ks kt ku kd b">[[YOUR-GITHUB]]</code>的<code class="du ks kt ku kd b">server.go</code>。这是假设你用的是GitHub，但如果你用的是Go也是可能的。如果您没有使用GitHub，您必须简单地反映gRPC服务的目录结构。我提议<code class="du ks kt ku kd b">my-working-dir/client</code>、<code class="du ks kt ku kd b">my-working-dir/server</code>和<code class="du ks kt ku kd b">my-working-dir/whoami</code>。后者应该包含<code class="du ks kt ku kd b">whoami.proto</code>和<code class="du ks kt ku kd b">api_config.yaml</code>。</p><p id="253f" class="if ig ko ih b ii ij ik il im in io ip kp ir is it kq iv iw ix kr iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>请用您将在其中部署端点服务的Google云平台项目的值替换<code class="du ks kt ku kd b">api_config.yaml</code>的第4行。</p></blockquote><p id="a933" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了方便起见，我在上面包含了机器生成的<code class="du ks kt ku kd b">whoami.pb.go</code>文件。这省去了您从<code class="du ks kt ku kd b">whoami.proto</code>文件生成这个文件的麻烦，并使这篇博文稍微短了一些。如果您感兴趣，请点击此处了解更多关于此流程的信息:</p><p id="e397" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae lj" href="https://grpc.io/docs/tutorials/basic/go.html" rel="noopener ugc nofollow" target="_blank">https://grpc.io/docs/tutorials/basic/go.html</a></p><p id="d716" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您*应该*能够获取并运行这些文件:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="2817" class="jd je hi kd b fi kh ki l kj kk">go get ./...<br/>go run server/server.go</span><span id="0b1b" class="jd je hi kd b fi la ki l kj kk">go run client/client.go</span></pre><blockquote class="kl km kn"><p id="a55c" class="if ig ko ih b ii ij ik il im in io ip kp ir is it kq iv iw ix kr iz ja jb jc hb bi translated">在一个窗口中启动服务器后，你需要在另一个窗口中运行客户端。</p></blockquote><p id="cf70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果成功了，我们可以建造并再试一次:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="2b29" class="jd je hi kd b fi kh ki l kj kk">CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o grpc-client client/client.go</span><span id="7c76" class="jd je hi kd b fi la ki l kj kk">CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o grpc-server server/server.go</span></pre><p id="d445" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">或</strong>:2的循环需要循环吗？</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="a91b" class="jd je hi kd b fi kh ki l kj kk">for FILE in client server<br/>do<br/>  CGO_ENABLED=0 \<br/>  GOOS=linux \<br/>  go build -a -installsuffix cgo -o grpc-${FILE} ${FILE}/${FILE}.go<br/>done</span></pre><p id="e615" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果可行，我们可以用集装箱装起来再试一次:</p><figure class="jy jz ka kb fd lc"><div class="bz dy l di"><div class="ly lz l"/></div></figure><blockquote class="kl km kn"><p id="e316" class="if ig ko ih b ii ij ik il im in io ip kp ir is it kq iv iw ix kr iz ja jb jc hb bi translated">你不需要容器化客户端，只需要容器化服务器。</p><p id="15eb" class="if ig ko ih b ii ij ik il im in io ip kp ir is it kq iv iw ix kr iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong> <code class="du ks kt ku kd b">Dockerfile.client</code>采用多阶段构建。都用<code class="du ks kt ku kd b">dumb-init</code>。如果不想使用<code class="du ks kt ku kd b">dumb-init</code>,分别拆卸12+4线。在客户端文件中，将第15行替换为<code class="du ks kt ku kd b">ENTRYPOINT ["/grpc-client"]</code>。在服务器文件中删除第8行并留下<code class="du ks kt ku kd b">CMD</code>。</p></blockquote><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="aac9" class="jd je hi kd b fi kh ki l kj kk">docker build \<br/>--tag=gcr.io/${PROJECT}/grpc-client \<br/>--file=Dockerfile.client \<br/>.</span><span id="88de" class="jd je hi kd b fi la ki l kj kk">docker build \<br/>--tag=gcr.io/${PROJECT}/grpc-server \<br/>--file=Dockerfile.server \<br/>.</span><span id="17c9" class="jd je hi kd b fi la ki l kj kk">docker push gcr.io/${PROJECT}/grpc-client<br/>docker push gcr.io/${PROJECT}/grpc-server</span></pre><h2 id="cfb3" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">试验</h2><p id="0d05" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">服务器:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="c6fc" class="jd je hi kd b fi kh ki l kj kk">docker run \<br/>--interactive \<br/>--tty \<br/>--publish=10000:10000 \<br/>gcr.io/dazwilkin-180420-trillian/grpc-server</span></pre><p id="e48e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您将客户装箱，那么:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="1219" class="jd je hi kd b fi kh ki l kj kk">docker run \<br/>--interactive \<br/>--tty \<br/>--net=host \<br/>gcr.io/dazwilkin-180420-trillian/grpc-client \<br/>  --host=localhost \<br/>  --port=10000</span></pre><p id="5280" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您没有将客户端容器化，则:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="076a" class="jd je hi kd b fi kh ki l kj kk">./grpc-client --host=localhost --port=10000</span></pre><h2 id="6d28" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">旁白:尼克的黑客</h2><p id="125c" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">愚蠢的是，我忘记了我还创建了端点服务，并想知道为什么我有401(而不是400)网络LBs-(</p><p id="331e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢Nick——一个非常棒的Kubernetes工程师——他指出了这个有用的LBs过滤器，它表明，虽然我在名称空间<code class="du ks kt ku kd b">fourhundred</code>中有400个名为<code class="du ks kt ku kd b">service-XXX</code>的LB(LB描述保留了Kubernetes名称空间/服务名称== cool ),但我在<code class="du ks kt ku kd b">default</code>中还有一个由端点创建的LB:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="7141" class="jd je hi kd b fi kh ki l kj kk">gcloud compute forwarding-rules list \<br/>--project=${PROJECT} \<br/>--format="table(description)"<br/>DESCRIPTION<br/>...<br/>{"kubernetes.io/service-name":"fourhundred/service-009"}<br/>{"kubernetes.io/service-name":"default/grpc-server"}<br/>{"kubernetes.io/service-name":"fourhundred/service-010"}<br/>{"kubernetes.io/service-name":"fourhundred/service-011"}<br/>{"kubernetes.io/service-name":"fourhundred/service-012"}<br/>{"kubernetes.io/service-name":"fourhundred/service-013"}<br/>{"kubernetes.io/service-name":"fourhundred/service-014"}<br/>{"kubernetes.io/service-name":"fourhundred/service-015"}<br/>...</span></pre><h2 id="1a5c" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">结论</h2><p id="d719" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">我认为这次经历最能说明问题的是，拥有400项服务的Kubernetes与拥有4项服务的Kubernetes差别不大。还要注意我们是如何忽略了为该服务提供动力的节点以及体现这些节点的GCE虚拟机。</p><h2 id="8eff" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">整理</h2><p id="4e64" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">“焦土”清理是删除GCP项目。这将删除项目中的所有内容。如果你专门为这项工作创建了项目，做得很好。继续进行，风险自负:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="3edd" class="jd je hi kd b fi kh ki l kj kk">gcloud projects delete ${PROJECT} --quiet</span></pre><p id="cf77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，您可以删除Kubernetes集群和端点服务。同样，如果你将其中任何一个用于其他目的，请注意你会删除所有内容。继续进行，风险自负:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="cc7d" class="jd je hi kd b fi kh ki l kj kk">gcloud container clusters delete $CLUSTER \<br/>--project=${PROJECT}</span><span id="e08e" class="jd je hi kd b fi la ki l kj kk">gcloud endpoints services delete \<br/>whoservice.endpoints.${PROJECT}.cloud.goog \<br/>--project=${PROJECT}</span></pre><p id="71fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仅此而已！</p></div></div>    
</body>
</html>