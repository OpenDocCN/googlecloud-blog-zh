<html>
<head>
<title>Google Cloud Storage &amp; Large Object upload speeds</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云存储和大对象上传速度</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-storage-large-object-upload-speeds-7339751eaa24?source=collection_archive---------0-----------------------#2017-10-19">https://medium.com/google-cloud/google-cloud-storage-large-object-upload-speeds-7339751eaa24?source=collection_archive---------0-----------------------#2017-10-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/d9dc4b6b7d36750855f51f34b01f8003.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i8gFMHNLtQJj-DnrepTSjw.jpeg"/></div></div></figure><div class=""/><p id="d6b0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Medic7在上传大型视频文件时遇到问题。他们的客户会制作一些基因测试的视频，然后上传，这要花很长时间。他们需要帮助。</p><p id="d9f0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了了解他们的问题，我上传了一堆100MB、200MB和500MB的文件来看看性能。你可以在下图中看到，当前的上传性能似乎在大约200M的对象大小时达到了极限。</p><figure class="jp jq jr js fd hk er es paragraph-image"><div class="er es jo"><img src="../Images/c2d1eddb47f917ee2da901b59d1fa3e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:636/format:webp/1*1OZ_UsZKX7LBoeX3oFiP5A.png"/></div></figure><p id="5086" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，如果我们上传一堆4g文件(比如视频编辑)，我们需要一个更好的计划。</p><h1 id="adfa" class="jt ju ht bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">打碎这东西</h1><p id="7cf3" class="pw-post-body-paragraph iq ir ht is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">在使用gsutil时，这个问题的答案会让你大吃一惊。每当你试图上传一个“大文件”时，你都会看到下面的消息。</p><figure class="jp jq jr js fd hk er es paragraph-image"><div class="er es kw"><img src="../Images/25e05c1cf1d038765e3775befb4e66fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*qH0xidbKzVa5hIE7xCzRuQ.png"/></div></figure><p id="8221" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">分解一下，gsutil可以自动使用<a class="ae kx" href="https://cloud.google.com/storage/docs/composite-objects" rel="noopener ugc nofollow" target="_blank">对象组合</a>来并行执行上传，将大型本地文件上传到Google云存储。这个过程的工作原理是将一个大文件拆分成多个组件，这些组件被并行上传，然后在云中组合(临时组件最终被删除)。</p><p id="96e9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以通过在gsutil ( <em class="ky">上设置`<em class="ky">parallel _ composite _ upload _ threshold</em>d `选项来启用它，或者更新您的。boto文件，如同控制台输出提示</em></p><blockquote class="kz la lb"><p id="76e7" class="iq ir ky is b it iu iv iw ix iy iz ja lc jc jd je ld jg jh ji le jk jl jm jn hb bi translated">GSUtil-o GSUtil:parallel _ composite _ upload _ threshold = 150M CP。/localbigfile gs://your-bucket</p></blockquote><p id="5177" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">其中“localbigfile”是大于150 MiB的文件。这将把你的数据分成大约150兆字节的块，然后并行上传，从而提高上传性能。(注意，对可以使用的块的数量有一些限制。有关更多信息，请参考文档)</p><p id="2465" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里有一个图表，显示了100个上传300MB文件的实例。</p><figure class="jp jq jr js fd hk er es paragraph-image"><div class="er es lf"><img src="../Images/40d999c7aa2b4ded4737ae391da871c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*XgFkmOrOtTPj_er597QTPA.png"/></div></figure><h1 id="f452" class="jt ju ht bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">复合上传的挑战</h1><figure class="jp jq jr js fd hk er es paragraph-image"><div class="er es lg"><img src="../Images/6e1201e8d7f849bc08a31c90180e2454.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*U2mp-J6igFFUQfbS4nDzaA.png"/></div></figure><p id="27ab" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用并行复合上传在上传性能和下载配置之间进行权衡:如果您启用并行复合上传，您的上传将运行得更快，但是如果您想要使用gsutil(或其他python应用程序)获取对象，那么客户端将需要安装编译的crcmod(参见<a class="ae kx" href="https://cloud.google.com/storage/docs/gsutil/addlhelp/CRC32CandInstallingcrcmod" rel="noopener ugc nofollow" target="_blank"> gsutil help crcmod </a>)以便正确下载文件。</p><p id="0417" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">需要说明的是，对crcmod的这种限制是暂时的，主要是为了保护数据的完整性，并确保您的客户不会因为事情看起来不同而惊慌失措。(CRC值和HTTP ETAG报头可能会有所不同。)</p><p id="236a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，如果这对您的设置不起作用，您有三个选择:</p><p id="c590" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1) <strong class="is hu">也许</strong> <strong class="is hu">关机了？</strong>修改您的配置文件的‘check _ hashes’选项以禁用此步骤。注意:强烈建议您<strong class="is hu">不要禁用完整性检查</strong>。这样做可能会使数据损坏在上传/下载过程中不被发现。</p><p id="692a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2) <strong class="is hu">不用gsutil？</strong>需要澄清的是，这不是一个被认可的建议。但是，如果您使用cURL、wget或http下载复合对象，那么获取将会工作(您将获得复合对象)。然而，强烈建议您仍然进行crc校验，这只是您现在的责任。</p><p id="94fb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3) <strong class="is hu">中机？减少这个问题的另一种方法是使用云端实例下载文件(因为crcmod可以安装在那里)，然后完整地重新上传到一个bucket。需要明确的是，这需要时间，也更昂贵(就交易成本而言)，但是这完全消除了crcmod的限制，从时间角度来看，这可能是一个双赢的结果，因为GCP可以轻松地从内部虚拟机获得约16千兆位/秒的上传速度。</strong></p><h1 id="36c3" class="jt ju ht bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">修复工作开始了！</h1><p id="520f" class="pw-post-body-paragraph iq ir ht is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">对于Medic7，将CRCmod放在他们的每个内部客户端上不是问题，因为上传的视频必须很快，然后在移动到另一个GCS存储桶进行分发之前进行内部处理，因此对他们来说，中间机器方法几乎是事实上的。复合对象的使用为他们的客户带来了50%的性能提升，这是非常了不起的！</p></div></div>    
</body>
</html>