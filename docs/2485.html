<html>
<head>
<title>Understanding lock_scanned_ranges hint of Cloud Spanner</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">理解云扳手的lock_scanned_ranges提示</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/understanding-lock-scanned-ranges-hint-of-cloud-spanner-5d245ecf7e9c?source=collection_archive---------3-----------------------#2022-11-06">https://medium.com/google-cloud/understanding-lock-scanned-ranges-hint-of-cloud-spanner-5d245ecf7e9c?source=collection_archive---------3-----------------------#2022-11-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="ddc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud Spanner是一个现代化的完全托管的关系数据库，在任何规模下都提供最高的可用性和一致性。由于熟悉Ansi SQL语言，它很容易被数据库开发人员采用，现在它也提供了PostgreSQL兼容的接口。</p><p id="a763" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提示一直是数据库提供的核心特性之一，用来影响各种选项，如要使用的连接顺序、方法或索引。Spanner支持许多这样的提示，在这个博客中我们将讨论关于<strong class="ih hj"> LOCK_SCANNED_RANGES </strong>的提示。对于在事务内将锁从共享升级到独占的事务，或者观察到高写入争用和事务中止情况的事务，需要获取独占锁。</p><p id="f96d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">lock_scanned_ranges提示帮助我们获取行上的排他锁，作为select的一部分，并在事务完成后释放。在实现lock_scanned_ranges之前，需要注意一些重要的事项。</p><p id="a933" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们行动起来，更好地理解它，将我们的样本。表tblsample包含一些虚拟记录，并在名称过滤器上使用lock_scanned_rows。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="df82" class="jm jn hi ji b fi jo jp l jq jr">CREATE TABLE tblsample (<br/>ID INT64 NOT NULL,<br/>NAME STRING(44) NOT NULL,<br/>TYPE STRING(44) NOT NULL,<br/>CREATED_DATE TIMESTAMP,<br/>MODIFIED_DATE TIMESTAMP<br/>)PRIMARY KEY(ID);</span><span id="c8e4" class="jm jn hi ji b fi js jp l jq jr">INSERT INTO tblsample (ID,NAME, TYPE, CREATED_DATE)<br/>SELECT *<br/>FROM UNNEST ([(1,'APPLE', 'FRUIT', CURRENT_TIMESTAMP),<br/>(2,'CAR', 'VEHICLE', CURRENT_TIMESTAMP),<br/>(3,'MANGO', 'FRUIT', CURRENT_TIMESTAMP),<br/>(4,'BANANA', 'FRUIT', CURRENT_TIMESTAMP),<br/>(5,'CRICKET', 'SPORTS', CURRENT_TIMESTAMP),<br/>(6,'FOOTBALL', 'SPORTS', CURRENT_TIMESTAMP),<br/>(7,'POTATO', 'VEGETABLE', CURRENT_TIMESTAMP),<br/>(8,'KIWI', 'FRUIT', CURRENT_TIMESTAMP)<br/>]);</span></pre><p id="06a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用<a class="ae jt" href="https://github.com/cloudspannerecosystem/spanner-cli" rel="noopener ugc nofollow" target="_blank"> spanner-cli </a>连接到spanner并执行我们的示例查询。</p><figure class="jd je jf jg fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es ju"><img src="../Images/f9f3b05f41096ee36c91137f5afc0d3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lp4f8OFRq_70EnoZ8taxfg.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">斯潘内尔克利</figcaption></figure><p id="9c7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用lock_scanned_ranges，我们将在相关的行上实现排他锁，并阻止另一个会话对行的排他访问。</p><p id="ebf1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在session1中，我们使用只返回一行的过滤器name = '<strong class="ih hj"><em class="kg">apple</em></strong><em class="kg">'</em>的<em class="kg"> sql获取排他锁。在会话2中，我们尝试获取锁，但使用了不同的过滤器<em class="kg">name = '</em><strong class="ih hj"><em class="kg">mango</em></strong><em class="kg">'</em>，该过滤器也将只返回1行，但它正在等待获取锁。</em></p><figure class="jd je jf jg fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kh"><img src="../Images/e457fe0358de57ddd4969e6795999733.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*pe0eiYusxELkCL6Ut0wRnA.gif"/></div></div></figure><p id="b2bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了理解为什么会话2不能获得锁，我们可以查看执行计划并建立我们的观察。</p><figure class="jd je jf jg fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es ki"><img src="../Images/7b240eda9108ef4199c72f946844d843.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dJPySdnwf9fh7RhGyHomlA.png"/></div></div></figure><p id="f59f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于执行计划和lock_scanned_ranges提示突出显示了一些关键观察结果。</p><blockquote class="kj kk kl"><p id="f62e" class="if ig kg ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated"><strong class="ih hj">表tblsample上的访问模式</strong>是<strong class="ih hj">全扫描</strong>，因为<strong class="ih hj">名称列上没有索引</strong></p><p id="a8a8" class="if ig kg ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated"><strong class="ih hj">扫描的行数(8行)</strong>比<strong class="ih hj">返回的行数(1行)</strong>高</p><p id="f196" class="if ig kg ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated"><strong class="ih hj"> lock_scanned_ranges </strong>顾名思义，就是<strong class="ih hj">不是基于<strong class="ih hj">返回的</strong>行而是基于<strong class="ih hj">扫描的</strong>行。</strong></p></blockquote><p id="b6e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设计最佳访问模式以最小化扫描的行数很重要，主要是在使用lock_scanned_ranges提示时。扫描未获得返回的行可能会造成热锁争用，并由于扫描行上的行锁而影响伸缩。</p><p id="0dc8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们继续为示例表的name列创建一个辅助索引。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="bcb6" class="jm jn hi ji b fi jo jp l jq jr">spanner-session1&gt;create index idx_test1 on tblsample(NAME);<br/>Query OK, 0 rows affected (15.86 sec)</span></pre><figure class="jd je jf jg fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kp"><img src="../Images/573285867ad9fd6eba9d77be05d92405.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GOPNQRTyMiF1_of4XGYHVA.png"/></div></div></figure><p id="8f41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果我们重试前面的场景，在session1中，我们使用只返回一行的过滤器name = '<strong class="ih hj"><em class="kg">apple</em></strong><em class="kg">'</em>使用<em class="kg"> sql获取排他锁。在会话2中，我们尝试获取锁，但使用不同的过滤器<em class="kg">name = '</em><strong class="ih hj"><em class="kg">mango</em></strong><em class="kg">'</em>将仅返回1行，锁将成功。</em></p><figure class="jd je jf jg fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kh"><img src="../Images/87d9761658dbf16a50edb9f1533f1aff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*oov31gKUrFn9bT0R9bLoYA.gif"/></div></div></figure><p id="5d9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于有了新的索引，扫描的行将减少到仅筛选的行，如果另一个会话需要锁定其他行，它将会成功。</p><figure class="jd je jf jg fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kq"><img src="../Images/f21645a9f944607b97eed4f8dd930af0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5NSy08R351rcyk0qcMH-zA.png"/></div></div></figure><h2 id="3479" class="jm jn hi bd kr ks kt ku kv kw kx ky kz iq la lb lc iu ld le lf iy lg lh li lj bi translated">结论</h2><p id="80c4" class="pw-post-body-paragraph if ig hi ih b ii lk ik il im ll io ip iq lm is it iu ln iw ix iy lo ja jb jc hb bi translated">对排他锁使用lock_scanned_ranges需要详细了解执行计划中扫描的行和底层访问模式。它应该用在具有索引访问模式的筛选器上，以最小化扫描的行数。</p></div></div>    
</body>
</html>