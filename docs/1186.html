<html>
<head>
<title>Understanding Stackdriver Audit Logs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解堆栈驱动程序审核日志</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/understanding-stackdriver-audit-logs-3879473de82a?source=collection_archive---------0-----------------------#2019-10-31">https://medium.com/google-cloud/understanding-stackdriver-audit-logs-3879473de82a?source=collection_archive---------0-----------------------#2019-10-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="ab41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章是与Roman Mezhibovski合作撰写的。</p><p id="926d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在GCP，审计日志提供了关于资源和数据如何被创建、修改和访问的不变记录。本指南旨在帮助您了解:</p><ul class=""><li id="2b70" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">什么是“现成”记录的</li><li id="29ed" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">如何打开附加审核日志记录</li><li id="f0cb" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">如何使用多个日志条目来形成特定事件的完整画面</li></ul><p id="e150" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用GCS来演示不同的日志是如何显示的。让我们开始吧！</p><h1 id="60d5" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">“现成的”审计日志记录</h1><p id="c55a" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">查看项目中已审核事件记录的第一个也是最容易的位置是在云控制台的“活动”选项卡中:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/3d171766a0b86ab6c2e16c884c802265.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mt0Mb1d1GZgz5HZN"/></div></div></figure><blockquote class="lh li lj"><p id="960b" class="if ig lk ih b ii ij ik il im in io ip ll ir is it lm iv iw ix ln iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/logging/docs/audit/#view-activity" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">注意</strong> </a>这个视图呈现的是“简短的项目级审计日志条目”，而不是每个事件的全部细节。</p></blockquote><p id="a29b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们来看一个具体的例子。首先创建一个云存储桶:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lo"><img src="../Images/293a4eb1818fe528c09ed2010aacad8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UmiHNA7NGlqvN7zl"/></div></div></figure><p id="40a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将在控制台的“Activity”选项卡上看到反映存储桶创建的记录:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/c14263c1ed5a2870ba44c56f51579c1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jj8Pojdjb9T60qKJ"/></div></div></figure><blockquote class="lh li lj"><p id="41e6" class="if ig lk ih b ii ij ik il im in io ip ll ir is it lm iv iw ix ln iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>您可以根据资源或类别过滤活动页面中的条目，以便更容易找到它们。</p></blockquote><p id="d725" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还可以在Stackdriver日志中找到匹配的日志条目:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/fd488f08db08b1c38ad8c89d47a1cb90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_S9bmX-qAgDysxjf"/></div></div></figure><p id="049e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将创建一个日志条目，其logName设置为</p><pre class="kw kx ky kz fd lp lq lr ls aw lt bi"><span id="47b2" class="lu jt hi lq b fi lv lw l lx ly">projects/&lt;project ID&gt;/logs/cloudaudit.googleapis.com%2F<strong class="lq hj">activity`</strong></span></pre><p id="0dc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并将protoPayload中的@type字段设置为</p><pre class="kw kx ky kz fd lp lq lr ls aw lt bi"><span id="257f" class="lu jt hi lq b fi lv lw l lx ly">type.googleapis.com/google.cloud.audit.AuditLog</span></pre><p id="11fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，将一个文件上传到存储桶，以向其中添加一个对象:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/e3deab9990591d99da49b5c92805e4fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3UHbMEAm9E3D3Ojl"/></div></div></figure><p id="aa91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将看到活动页面没有任何新条目—没有您上传该文件的记录。如果您从bucket中删除该文件，您会发现也没有相关记录。这是怎么回事？</p><p id="9958" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将看到在<a class="ae jd" href="https://cloud.google.com/logging/docs/audit/#top_of_page" rel="noopener ugc nofollow" target="_blank">文档</a>中描述的行为。具体来说，创建资源被认为是一项管理活动——正如您所看到的，这些事件总是被记录下来。但是，将对象添加到存储桶或删除是用户驱动的操作，会修改用户数据，而不是资源本身。因此，我们需要启用额外的审计日志来创建它的记录。让我们接下来做那件事。</p><h1 id="4c25" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">审核日志记录</h1><p id="98ea" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">您可以通过从IAM和Admin下的Products菜单中选择该选项来获取审核日志:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lz"><img src="../Images/045c157cf174ff75eecdc4dbb630b32e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TesaTb84dHlSPzZa"/></div></div></figure><p id="9fc2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">结果页面显示了您可以为GCP服务启用的数据访问日志:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/8fba308e3c17d8d9354df1ea1ed38ec2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8K3pC06QelpoUyQ_"/></div></div></figure><p id="d36b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在<a class="ae jd" href="https://cloud.google.com/logging/docs/audit/configure-data-access" rel="noopener ugc nofollow" target="_blank">文档</a>中阅读更多关于配置审计日志的信息。关于审计日志，需要了解的主要内容有:</p><ol class=""><li id="3331" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc ma jk jl jm bi translated">有三种类型的审核日志—系统事件、管理活动和数据访问。前两个是自动为您编写的，您无法控制它们。因此，它们不会产生费用。</li><li id="8250" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc ma jk jl jm bi translated">作为管理员，您可以启用额外的数据访问审核日志，这些日志需要付费，并且会导致创建大量数据。</li><li id="570f" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc ma jk jl jm bi translated">数据访问日志有三个子类型—管理员读取、数据读取和数据写入</li></ol><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mb"><img src="../Images/4a3c2dc23ed82f44f82088fcf45be37a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7vbPe8zlqClzJbfj"/></div></div></figure><h1 id="71dd" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">管理员读取审计日志</h1><p id="83f2" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">您可以启用的第一个日志类型是管理员读取。<a class="ae jd" href="https://cloud.google.com/logging/docs/audit/configure-data-access" rel="noopener ugc nofollow" target="_blank">文档</a>将这些日志描述为“记录读取元数据或配置信息的操作”打开管理员读取审计日志并保存配置。当您下一次刷新云控制台中的bucket信息时，您将在Activity选项卡中看到一个新条目，显示您对该资源的检索:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mc"><img src="../Images/f2d42c1a73c4b75fa0f02e76f4ec6cb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EY3n1s0M9-lFBOv4"/></div></div></figure><p id="ee1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以在日志查看器中看到相应的日志条目:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/4797b7d958fc6c1f8b8c20bfe0f9e4a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eUPVUyd77uN8s1OS"/></div></div></figure><p id="89c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有效负载包含关于您的请求的详细信息，如您的用户名、您访问的资源以及您用来访问它的API和方法——在本例中是storage.buckets.get。您还应该看到另一个包含storage.objects.list的条目——这是列出bucket中的对象的调用。注意，这个条目的日志名字段是</p><pre class="kw kx ky kz fd lp lq lr ls aw lt bi"><span id="7ffc" class="lu jt hi lq b fi lv lw l lx ly">projects/&lt;project ID&gt;/logs/cloudaudit.googleapis.com%2F<strong class="lq hj">data_access</strong></span></pre><p id="3ada" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果此时您尝试将另一个对象添加到您的存储桶或删除一个对象，您将会看到在日志查看器或活动页面中没有生成额外的条目。这是因为该活动并不修改或检索关于资源本身的数据——它只是修改该资源内的用户数据。让我们转到数据读取审计日志，看看它是如何工作的。</p><h1 id="a0c1" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">数据读取审计日志</h1><p id="55e8" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">打开数据读取审计日志。如果在控制台中刷新存储段详细信息，您将在活动页面中看到一个新条目，显示您执行了storage.objects.list API:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es md"><img src="../Images/76fba8b89665109b771e2e3c6feaa3e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yIzs_YiG7NdGc8dN"/></div></div></figure><p id="1a9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在日志查看器中看到相应的条目:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/78a6b2acfdafffe00894d2732029700c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bz0DJoPyXm9juAWC"/></div></div></figure><blockquote class="lh li lj"><p id="06f0" class="if ig lk ih b ii ij ik il im in io ip ll ir is it lm iv iw ix ln iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>条目具有相同的日志名和原始有效负载。@类型和以前一样——真正的不同是<strong class="ih hj"> protoPayload.methodName </strong>字段，它现在显示存储。<strong class="ih hj"> objects.list </strong>，而不是存储。<strong class="ih hj"> buckets.get </strong>。</p></blockquote><p id="8f07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您现在使用</p><pre class="kw kx ky kz fd lp lq lr ls aw lt bi"><span id="8be9" class="lu jt hi lq b fi lv lw l lx ly">gsutil cat gs://&lt;bucket name&gt;/&lt;file name&gt;</span></pre><p id="0145" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将看到该操作的新活动条目:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/21d23a82d17a6ef5ba05d00084e6c1d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zYzyoGL6wZf9BQOP"/></div></div></figure><p id="72f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">相应的日志条目也具有相同的日志名和@type。methodName是“storage . objects . get”——这是对一个对象的操作，而不是对存储桶的操作，并且正在检索该对象，因此这是有意义的:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/bf688ee1eb3f22cb5d4c354cd63a83e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3hmMGlvtsmsiggiq"/></div></div></figure><h1 id="af1b" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">数据写入审计日志</h1><p id="9cd1" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">最后，在审计日志配置页面中打开数据写入审计日志。现在，将另一个对象上传到您的存储桶。您应该注意到活动页面中有一个新条目:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/995d515950b1f6fd7c62991267c681f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*On-jl8Z6Qy0KflLF"/></div></div></figure><p id="c98e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">日志查看器中有一个相应的新条目:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/fb92195ae1631fdd986511e3344df9b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ui6373WXC2BQO0nQ"/></div></div></figure><p id="e6c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该条目具有相同的日志名和原始有效负载。@type同上，protoPayload.methodName为storage.objects.create。</p><h1 id="38f7" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">摘要</h1><p id="211b" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">让我们总结一下这些操作及其生成的日志类型:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es me"><img src="../Images/5d8a2ae701b30d7c5f12f8b42cff1171.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G7xPjHOZUr30wiBk9xA1KQ.png"/></div></div></figure><h1 id="3b53" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">下一步是什么？</h1><p id="687d" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">我希望这有助于您理解如何在GCP控制审计日志。请注意，您为这些示例启用的额外日志类型需要支付标准的日志记录费用，并且可能会产生额外的成本——如果担心这一点，请禁用它们。</p><p id="c651" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了简单起见，我将重点放在这些例子的GC上。你可以在这里阅读更多关于审计日志如何为GCS工作的信息，在这里查看其他支持审计日志的GCP服务<a class="ae jd" href="https://cloud.google.com/logging/docs/audit/services" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="13da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦您理解了您的审计日志选项，您就可以了解如何<a class="ae jd" href="https://cloud.google.com/solutions/design-patterns-for-exporting-stackdriver-logging" rel="noopener ugc nofollow" target="_blank">导出</a>审计日志以满足合规性或安全性，并深入研究审计日志<a class="ae jd" href="https://cloud.google.com/logging/docs/audit" rel="noopener ugc nofollow" target="_blank">文档</a>。我很感谢Roman Mezhibovski对这篇文章的帮助，也很感谢你的阅读！</p></div></div>    
</body>
</html>