<html>
<head>
<title>Centralized multi-project log monitoring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">集中式多项目日志监控</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/multiple-projects-log-monitoring-in-a-single-place-59f1156721bb?source=collection_archive---------0-----------------------#2021-08-04">https://medium.com/google-cloud/multiple-projects-log-monitoring-in-a-single-place-59f1156721bb?source=collection_archive---------0-----------------------#2021-08-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/4ab7213b4194a1cbaf84b31cbd9b9eed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nsdVM4YTabaTuFb9DcHIuQ.png"/></div></div></figure><p id="2171" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在云环境中，根据需要创建和销毁资源是很常见的。出于<strong class="is hj">安全或保密</strong>的原因，<strong class="is hj">强烈分离资源</strong>也很常见；或者在发生事故时简单地用<strong class="is hj">限制爆炸半径</strong>。<br/>在Google Cloud上，创建<strong class="is hj">几个项目，每个客户一个</strong>，每个项目部署相同的应用程序是一种常见的模式，尤其是当您拥有<strong class="is hj">依赖于项目的资源</strong>时，例如<a class="ae jo" href="https://cloud.google.com/appengine" rel="noopener ugc nofollow" target="_blank">应用程序引擎</a>或<a class="ae jo" href="https://cloud.google.com/firestore" rel="noopener ugc nofollow" target="_blank">Firestore</a>/<a class="ae jo" href="https://cloud.google.com/datastore" rel="noopener ugc nofollow" target="_blank">Datastore</a>。</p><blockquote class="jp"><p id="5b02" class="jq jr hi bd js jt ju jv jw jx jy jn dx translated">您最终会得到一个部署在几个单租户项目中的多租户服务</p></blockquote><p id="88b3" class="pw-post-body-paragraph iq ir hi is b it jz iv iw ix ka iz ja jb kb jd je jf kc jh ji jj kd jl jm jn hb bi translated">那是为了设计，但是在<strong class="is hj"> <em class="ke">第二</em> </strong>天，你需要监控你的应用程序，<strong class="is hj">被分派到不同的项目</strong>。</p><p id="0b69" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我的例子中，为了跟踪错误，我习惯于<strong class="is hj">定义几个</strong> <a class="ae jo" href="https://cloud.google.com/logging/docs/logs-based-metrics" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">基于日志的度量</strong> </a>来过滤与我的错误案例相关的日志。然后，我在这些指标上添加了一个<a class="ae jo" href="https://cloud.google.com/logging/docs/logs-based-metrics/charts-and-alerts#alert-on-lbm" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">云监控警报</strong> </a> <strong class="is hj">，以向团队通知错误(使用电子邮件、PubSub等)</strong></p><h1 id="9fd8" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">多个项目日志</h1><p id="e1df" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">当你有多个项目时的问题是你有<strong class="is hj">几个</strong> <a class="ae jo" href="https://cloud.google.com/logging/docs" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">云日志</strong> </a> <strong class="is hj">实例</strong>，每个项目一个，并且<strong class="is hj">很难在同一时间</strong>，在同一地点监控所有的项目。</p><p id="c7d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，当您设置一个<strong class="is hj">基于日志的指标</strong>时，您只能在当前项目中<strong class="is hj">进行过滤，而不能在文件夹或组织级别设置过滤器。</strong></p><p id="e281" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为不同项目中部署的代码是相同的，所以<strong class="is hj">不必在每个项目中复制基于日志的指标</strong>和警报。在一个地方这样做更有效率和一致性！</p><h1 id="97ea" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">文件夹和组织级别的接收器</h1><p id="b057" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">令人欣慰的是，可以用一个水槽在文件夹和组织级别过滤日志。这里的技巧是<strong class="is hj"><em class="ke">在文件夹和组织级别包含子节点</em> </strong>。<br/> <em class="ke">文件夹和组织的子节点是文件夹和项目。因此，如果您在sink中包含了孩子，那么您也添加了所有的文件夹和项目</em> <strong class="is hj"> <em class="ke">(递归)。</em>T13】</strong></p><p id="a5b6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该特征被<strong class="is hj">命名为</strong> <a class="ae jo" href="https://cloud.google.com/logging/docs/export/aggregated_sinks" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">聚合汇</strong> </a> <strong class="is hj">。</strong>你可以从所有子节点获取过滤后的日志，然后<strong class="is hj">将它们放入BigQuery、PubSub、云存储和日志桶中。</strong></p><p id="5817" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">遗憾的是，这只是一个日志转发，您不能在聚合的sink上定义基于日志的指标。你还需要补充点什么！</p><h1 id="0a4f" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">云日志桶</h1><p id="0487" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">解决方案来自云日志服务本身。你现在可以用<strong class="is hj">定义</strong> <a class="ae jo" href="https://cloud.google.com/logging/docs/buckets" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">日志桶</strong> </a>。这是一个用户定义的日志存储，您可以在其中<strong class="is hj">路由日志</strong>并<strong class="is hj">将它们保留一段用户定义的保留期</strong>(以天为单位)。</p><p id="241a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个特性对于将日志保留一段合法的时间(例如3年)很有意义。在我们的例子中，保留并不是很重要，我们只希望把日志放在一个地方。请记住，你保存日志的时间越长，你使用的存储空间就越多，你支付的费用也就越多。</p><h1 id="b83b" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">沉入云日志记录日志桶</h1><p id="18b3" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">聚合接收器和日志存储桶的组合是关键。</p><figure class="lj lk ll lm fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es li"><img src="../Images/55c3c08c0166d995af8f9f55c746c764.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jxU3AiL_LftyNt_wKMj1_g.png"/></div></div></figure><p id="10da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是如何让他们行动起来。</p><ul class=""><li id="530a" class="ln lo hi is b it iu ix iy jb lp jf lq jj lr jn ls lt lu lv bi translated">首先<strong class="is hj">创建你需要的资源组织</strong>，例如，创建一个包含两个项目的文件夹。</li><li id="18e8" class="ln lo hi is b it lw ix lx jb ly jf lz jj ma jn ls lt lu lv bi translated">然后，<strong class="is hj">在两个项目中创建一个类似的日志条目</strong>，例如运行一个失败的BigQuery查询</li></ul><pre class="lj lk ll lm fd mb mc md me aw mf bi"><span id="1359" class="mg kg hi mc b fi mh mi l mj mk">SELECT * FROM 'bigquery-public-data.austin_311.311_service_requests' where unique_key=3</span></pre><p id="f1ae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要查看日志中的错误，请转到云日志记录并使用此过滤器。</p><pre class="lj lk ll lm fd mb mc md me aw mf bi"><span id="0b27" class="mg kg hi mc b fi mh mi l mj mk">resource.type="bigquery_resource"<br/>severity=ERROR<br/>protoPayload.methodName="jobservice.jobcompleted"</span></pre><p id="b3b5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="ke">稍后获取此日志过滤器。</em></p><ul class=""><li id="6de5" class="ln lo hi is b it iu ix iy jb lp jf lq jj lr jn ls lt lu lv bi translated">选择一个<strong class="is hj">日志专用的项目</strong>。它可以是两个项目中的一个，也可以在另一个项目中。然后，创建一个日志存储桶</li></ul><pre class="lj lk ll lm fd mb mc md me aw mf bi"><span id="95ef" class="mg kg hi mc b fi mh mi l mj mk">gcloud logging buckets create --location=global \<br/>  --retention-days=7 --project=LOG_PROJECT_ID specific-log</span></pre><ul class=""><li id="a76c" class="ln lo hi is b it iu ix iy jb lp jf lq jj lr jn ls lt lu lv bi translated">然后<strong class="is hj">在你的文件夹</strong> <em class="ke">上创建一个聚合的sink(这也与</em> <code class="du ml mm mn mc b"><em class="ke">--organization</em></code> <em class="ke">参数一起在组织级别创建它)</em></li></ul><pre class="lj lk ll lm fd mb mc md me aw mf bi"><span id="1a1a" class="mg kg hi mc b fi mh mi l mj mk">gcloud logging sinks create --folder=&lt;FOLDER_ID&gt; \<br/>  --log-filter='resource.type="bigquery_resource"<br/>   AND severity=ERROR<br/>   AND protoPayload.methodName="jobservice.jobcompleted"'\<br/>  --include-children sink-specific-logs \<br/>logging.googleapis.com/projects/&lt;LOG_BUCKET_PROJECT_ID&gt;/locations/global/buckets/specific-log</span></pre><ul class=""><li id="d4db" class="ln lo hi is b it iu ix iy jb lp jf lq jj lr jn ls lt lu lv bi translated">最后，再次运行错误的BigQuery查询。</li></ul></div><div class="ab cl mo mp gp mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="hb hc hd he hf"><p id="5d5c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，<strong class="is hj">检查云日志记录桶中的新日志条目</strong>。为了实现这一目标</p><ul class=""><li id="2659" class="ln lo hi is b it iu ix iy jb lp jf lq jj lr jn ls lt lu lv bi translated">进入云日志页面，点击<code class="du ml mm mn mc b">refine scope</code></li></ul><figure class="lj lk ll lm fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mv"><img src="../Images/f83c34378c69971a19c8b2e1ded63565.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x5gsuH7F5mGqkgOr_Rk6iw.png"/></div></div></figure><ul class=""><li id="7d2e" class="ln lo hi is b it iu ix iy jb lp jf lq jj lr jn ls lt lu lv bi translated">选择<code class="du ml mm mn mc b">scope by storage</code>选项，并且只选择你的<code class="du ml mm mn mc b">specific-logs</code>圆木桶</li></ul><figure class="lj lk ll lm fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mw"><img src="../Images/4fd707526d65d1b67b4dce7abcc5e0c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZRhc2i8sslBEFgh_XV2o4Q.png"/></div></div></figure><p id="f3b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">什么也没发生</strong>，没有日志记录，也没有错误，<em class="ke">很烦人… </em></p></div><div class="ab cl mo mp gp mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="hb hc hd he hf"><p id="022e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">实际上，这是一个安全问题:在文件夹级别创建的<strong class="is hj">聚合接收器没有权限将</strong>写入日志桶！</p><p id="f016" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了解决这个问题，我们需要<strong class="is hj">获取聚合接收器</strong>的 <code class="du ml mm mn mc b"><strong class="is hj">writerIdentity</strong></code> <strong class="is hj"/></p><pre class="lj lk ll lm fd mb mc md me aw mf bi"><span id="2881" class="mg kg hi mc b fi mh mi l mj mk">gcloud logging sinks describe --folder=&lt;FOLDER_ID&gt;\<br/> --format='value(writerIdentity)' sink-specific-logs</span></pre><p id="78cc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后授予<code class="du ml mm mn mc b">writerIdentity</code>服务帐户作为日志专用项目上的<strong class="is hj">日志桶写者</strong>。</p><pre class="lj lk ll lm fd mb mc md me aw mf bi"><span id="f7ba" class="mg kg hi mc b fi mh mi l mj mk">gcloud projects add-iam-policy-binding &lt;PROJECT_ID&gt; \<br/>  --member=&lt;WRITER_IDENTITY&gt; --role=roles/logging.bucketWriter</span></pre><p id="ac1d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">再次尝试您的BigQuery查询，然后<strong class="is hj">嘣！！T21，你的圆木桶里有你的圆木。</strong></p><h1 id="629b" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">把你的日志集中起来，然后一起玩</h1><p id="5048" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">现在，你可以在一个地方拥有你所有相关的日志，所有应用的租户<strong class="is hj">，你可以用它们做你想做的事情</strong></p><ul class=""><li id="537b" class="ln lo hi is b it iu ix iy jb lp jf lq jj lr jn ls lt lu lv bi translated">保留一段<strong class="is hj">长时间/法定时间</strong></li><li id="e06d" class="ln lo hi is b it lw ix lx jb ly jf lz jj ma jn ls lt lu lv bi translated"><strong class="is hj">授予团队仅访问此<em class="ke">日志专用</em>项目</strong>的权限，以访问日志，但不访问租户项目(和数据)</li><li id="e35b" class="ln lo hi is b it lw ix lx jb ly jf lz jj ma jn ls lt lu lv bi translated">在单个聚合位置创建<strong class="is hj">基于日志的指标</strong>。</li></ul><p id="471b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你呢，你的用例是什么，把所有的日志放在同一个地方？</p></div></div>    
</body>
</html>