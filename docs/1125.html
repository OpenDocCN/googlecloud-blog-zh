<html>
<head>
<title>Cloud Run Using Pubsub Triggers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Pubsub触发器的云运行</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-run-using-pubsub-triggers-2db74fc4ac6d?source=collection_archive---------0-----------------------#2019-08-26">https://medium.com/google-cloud/cloud-run-using-pubsub-triggers-2db74fc4ac6d?source=collection_archive---------0-----------------------#2019-08-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/559595a6d229cb4cc80fbb442087854b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hdY9vD_acPkIWsMFzirsiw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">Google云平台上的云运行</figcaption></figure><div class=""/><p id="b5ee" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">几个月前，谷歌宣布了一个非常酷的东西，一个鲜为人知的项目，叫做Cloud Run——从最初的宣布开始，Cloud Run就引起了一些严重的噪音。《云跑》在一个非常有趣的时间问世。就像开发人员大批涌入Kubernetes一样，谷歌推出了一种新工具，无论你是否知道在T2部署和在T4进入的区别，你仍然可以创建基于Kubernetes和谷歌的GKE的强大功能运行的令人惊叹的工具。</p><blockquote class="jt ju jv"><p id="09d3" class="iu iv js iw b ix iy iz ja jb jc jd je jw jg jh ji jx jk jl jm jy jo jp jq jr hb bi translated">如果你想进一步深入兔子洞，你会了解到在幕后谷歌正在使用另一个新项目，名为<a class="ae jz" href="https://knative.dev/" rel="noopener ugc nofollow" target="_blank"> KNative </a>。Knative利用Kubernetes的力量，通过一些魔法，将Kubernetes变成一个无服务器平台，允许您根据使用情况增加工作负载，如果没有流量，则一直将工作负载降至零。</p></blockquote><p id="337d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用云运行的最大好处是，只需点击几下鼠标，您就可以让您的应用在Kubernetes上运行，并在一个您可以信赖的环境中随着您的使用规模进行扩展。</p><p id="fb2a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，在本文中，我将快速向您展示，您可以立即让一切正常运行。事不宜迟，我们开始吧。</p><h1 id="918b" class="ka kb hx bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">使用Pubsub和调度程序的云运行示例项目</h1><p id="c8c8" class="pw-post-body-paragraph iu iv hx iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">作为一个快速的小项目，我们将制作一个使用Pubsub来触发您的云运行工作负载的系统。我觉得触发这些Pubsub消息的最简单的方法是使用Cloud Scheduler以我们可以设置的时间间隔(本例中为每分钟)触发Pubsub。这会是什么样子？像这样。</p><figure class="le lf lg lh fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ld"><img src="../Images/495fcd8e949aa5f00f7198b5811831ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vfcEHNjLjWaG3O4OFwo-sQ.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">通过Pubsub运行云调度程序</figcaption></figure><p id="916c" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们的云运行工作负载是用NodeJS编写的，但是如果你看一下最终的代码，你会发现这种语言对于这个例子并不重要，因为它非常简单。</p><p id="5052" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">所有代码都可以在<a class="ae jz" href="https://github.com/jonbcampos/cloudrun-series/tree/master/getting-started" rel="noopener ugc nofollow" target="_blank">我的Github Repo </a>中查看。</p><div class="hh hi ez fb hj li"><a href="https://github.com/jonbcampos/cloudrun-series/tree/master/getting-started" rel="noopener  ugc nofollow" target="_blank"><div class="lj ab dw"><div class="lk ab ll cl cj lm"><h2 class="bd hy fi z dy ln ea eb lo ed ef hw bi translated">jonbcampos/cloudrun系列</h2><div class="lp l"><h3 class="bd b fi z dy ln ea eb lo ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="lq l"><p class="bd b fp z dy ln ea eb lo ed ef dx translated">github.com</p></div></div><div class="lr l"><div class="ls l lt lu lv lr lw hp li"/></div></div></a></div><h1 id="bcf5" class="ka kb hx bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">设置基本节点项目</h1><p id="675f" class="pw-post-body-paragraph iu iv hx iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">NodeJS项目相当简单。一个小的Express应用程序和一个POST端点，用于我们的PubSub订阅将数据推入其中。</p><figure class="le lf lg lh fd hk"><div class="bz dy l di"><div class="lx ly l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">使用Pubsub消息的Index.js文件</figcaption></figure><p id="01c9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">你可以在Github 中深入查看<a class="ae jz" href="https://github.com/jonbcampos/cloudrun-series/tree/master/getting-started" rel="noopener ugc nofollow" target="_blank">入门项目中的每一行代码。</a></p><h1 id="46cb" class="ka kb hx bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">构建和部署项目</h1><p id="46e7" class="pw-post-body-paragraph iu iv hx iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">要将项目构建成可部署的Dockerized应用程序，我们只需要运行一个快速命令来<a class="ae jz" href="https://github.com/jonbcampos/cloudrun-series/blob/master/getting-started/scripts/build.sh" rel="noopener ugc nofollow" target="_blank">在GCP </a>中构建和存储应用程序。</p><figure class="le lf lg lh fd hk"><div class="bz dy l di"><div class="lx ly l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">文档化应用</figcaption></figure><p id="5ae6" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">就是这个！就是这一刻。这是我们<a class="ae jz" href="https://github.com/jonbcampos/cloudrun-series/blob/master/getting-started/scripts/deploy.sh" rel="noopener ugc nofollow" target="_blank">向云运行</a>发布应用的重要时刻。你准备好了吗？</p><figure class="le lf lg lh fd hk"><div class="bz dy l di"><div class="lx ly l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">部署到云运行</figcaption></figure><p id="2699" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">就是这样！这就是困难所在。好的，这非常简单，现在完全可以扩展。说真的，这基本上是生产就绪。</p><figure class="le lf lg lh fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lz"><img src="../Images/a4bacfa2dbef503b6750611e0e7536d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*69nCflu5l1Pg6TGQpXB8og.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">云运行项目运行</figcaption></figure><p id="4f67" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">从现在开始，支持我们的应用程序的一切都在走下坡路。</p><h1 id="a330" class="ka kb hx bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">添加发布订阅</h1><p id="0b21" class="pw-post-body-paragraph iu iv hx iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">我们的应用程序正在运行，但是此时什么也没有发生，因为我们没有连接Pubsub。我们将<a class="ae jz" href="https://github.com/jonbcampos/cloudrun-series/blob/master/getting-started/scripts/add-pubsub.sh" rel="noopener ugc nofollow" target="_blank">现在将Pubsub添加到我们的GCP项目</a>中。</p><figure class="le lf lg lh fd hk"><div class="bz dy l di"><div class="lx ly l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">启用发布订阅</figcaption></figure><p id="5cfc" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这个脚本启用Pubsub并创建一个Pubsub主题。</p><figure class="le lf lg lh fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ma"><img src="../Images/46524b2debb849165abe119b8c978837.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uIDwQ0uFmRGFITE8Uw64cw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">已创建发布订阅消息</figcaption></figure><p id="1e50" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">舞台已经准备好了。我们只需要设置云调度程序来调度Pubsub主题。</p><h1 id="ffe4" class="ka kb hx bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">添加计划程序</h1><p id="c128" class="pw-post-body-paragraph iu iv hx iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">Cloud Scheduler 是一个非常灵活的工具，它允许你设置一个Cron时间表，这个时间表将定期触发HTTP消息或Pubsub消息。对于我们的项目，我们让Cloud Scheduler每分钟发送一条Pubsub消息，以模拟应用程序调度Pubsub消息。同样，<a class="ae jz" href="https://github.com/jonbcampos/cloudrun-series/blob/master/getting-started/scripts/add-scheduler.sh" rel="noopener ugc nofollow" target="_blank">一行bash脚本之后，我们就可以开始了</a>。</p><figure class="le lf lg lh fd hk"><div class="bz dy l di"><div class="lx ly l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">创建调度程序作业</figcaption></figure><p id="f8c7" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">云调度程序现在每分钟都在调度主题。</p><figure class="le lf lg lh fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mb"><img src="../Images/752d9ab35895fd76309b09c57deb0644.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aVDGWmMv0_ezaUvOHxQLzw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">已创建云调度程序</figcaption></figure><p id="425f" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们需要做的最后一件事是设置一个订阅，将这个主题推到我们的云运行工作负载中。</p><h1 id="ded9" class="ka kb hx bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">添加订阅</h1><p id="35a3" class="pw-post-body-paragraph iu iv hx iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">这是这个过程的最后/最复杂的部分。我们需要创建一个服务帐户，获取我们的云运行端点的URL，然后创建订阅以将Pubsub消息路由到云运行。</p><p id="d549" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">第一，网址。这可以很容易地在云运行仪表板中找到。</p><figure class="le lf lg lh fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mc"><img src="../Images/e082d2c0dc0fafde8e286cb115942e14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nl4hXQY0opFMv80WqhBrJg.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">云运行URL</figcaption></figure><p id="20d0" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">接下来，我们需要创建订阅。<a class="ae jz" href="https://github.com/jonbcampos/cloudrun-series/blob/master/getting-started/scripts/add-subscription.sh" rel="noopener ugc nofollow" target="_blank">这是通过几行bash脚本完成的。</a></p><figure class="le lf lg lh fd hk"><div class="bz dy l di"><div class="lx ly l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">创建订阅</figcaption></figure><p id="105d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">一旦完成，Pubsub消息将被路由到Cloud Run。我们去看看我们的杰作吧。</p><h1 id="e81f" class="ka kb hx bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">看着圆木滚滚而来</h1><p id="7cec" class="pw-post-body-paragraph iu iv hx iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">当我们回到云运行时，我们可以很快看到一些东西已经在运行。</p><figure class="le lf lg lh fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lz"><img src="../Images/e774d0ae6c743a7aa9594ba44e092b42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*94n5MaGqNWK5s7oUqF3C1w.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">来自云运行指标的结果</figcaption></figure><p id="f726" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果我们查看该服务的日志，我们可以看到数据的传输情况。</p><figure class="le lf lg lh fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es md"><img src="../Images/14ba771120182c7b90ae97173f366e4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GEYhw_0FJDWIwax2AIPY9w.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">显示结果的日志</figcaption></figure><p id="3a74" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们正式结束了。一切都通过云调度程序使用Pubsub运行到我们的服务中。这是非常光滑的，看看是否所有运行。</p><h1 id="1b50" class="ka kb hx bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">结论</h1><p id="9848" class="pw-post-body-paragraph iu iv hx iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">云运行是一项了不起的服务。如果你有一个谷歌Kubernetes引擎(GKE)实例运行，你可以包括云运行作为一个插件，或者你可以使用托管云运行实例，我们已经在这里使用。无论哪种方式，你都将拥有一个惊人的平台来构建最大的应用程序。</p></div><div class="ab cl me mf gp mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="hb hc hd he hf"><p id="efce" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Jonathan Campos 是一个狂热的开发者，也是学习新事物的爱好者。我相信我们应该不断学习、成长和失败。我总是开发社区的支持者，并且总是愿意提供帮助。因此，如果您对这个故事有任何问题或评论，请在下面添加。在<a class="ae jz" href="https://www.linkedin.com/in/jonbcampos/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>或<a class="ae jz" href="https://twitter.com/jonbcampos" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上与我联系，并提及这个故事。</p></div></div>    
</body>
</html>