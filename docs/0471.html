<html>
<head>
<title>Google Cloud Storage “downsizer”</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云存储“缩小者”</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-storage-downsizer-af0048591e40?source=collection_archive---------1-----------------------#2017-12-21">https://medium.com/google-cloud/google-cloud-storage-downsizer-af0048591e40?source=collection_archive---------1-----------------------#2017-12-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="4093" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">谷歌云功能的进一步探索</h2></div><p id="a65e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">没有人阻止我…这太有趣了；-)</p><p id="7baa" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">App Engine Standard提供了一项图像服务，许多客户都很重视这项服务，并经常使用它来创建缩略图(在<a class="ae jt" href="https://cloud.google.com/storage/" rel="noopener ugc nofollow" target="_blank">谷歌云存储</a>中)。<a class="ae jt" href="https://firebase.google.com/" rel="noopener ugc nofollow" target="_blank"> Firebase </a>有一个<a class="ae jt" href="https://cloud.google.com/functions/" rel="noopener ugc nofollow" target="_blank">云函数</a> <a class="ae jt" href="https://firebase.google.com/docs/storage/extend-with-functions#example_image_transformation" rel="noopener ugc nofollow" target="_blank">样本</a>，它也使用<a class="ae jt" href="http://www.imagemagick.org" rel="noopener ugc nofollow" target="_blank"> ImageMagick </a>来显示缩略图。</p><p id="f1ff" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是我的版本。它使用文件流，所以应该(尚未测试)规模更好，它创建多个缩小(缩略图)图像。我决定使用<a class="ae jt" href="https://cloud.google.com/source-repositories/" rel="noopener ugc nofollow" target="_blank">云源代码库</a>来托管我的代码，虽然它会从新的云功能部署的变更触发中受益。</p><h2 id="8142" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">设置</h2><p id="3635" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">我认为你可能会从谷歌云平台的<a class="ae jt" href="https://cloud.google.com/free/" rel="noopener ugc nofollow" target="_blank">免费</a>(如啤酒)层中受益，因为谷歌云功能、谷歌云存储和谷歌云资源存储库似乎都包含在内。</p><p id="9c5f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">打开bash终端并获取编码:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="2d7d" class="ju jv hi kz b fi ld le l lf lg">ROOT=$(whoami)-171220<br/>BILLING=[[YOUR-BILLING-ID]]<br/>PROJECT=[[YOUR-PROJECT-ID]] // ${ROOT}-downsizer<br/>REGION=us-central1</span><span id="d28a" class="ju jv hi kz b fi lh le l lf lg"># Create GCP Project<br/>gcloud alpha projects create $PROJECT</span><span id="b777" class="ju jv hi kz b fi lh le l lf lg"># Link it to your Billing Account<br/>gcloud alpha billing projects link $PROJECT --account-id=$BILLING</span><span id="d24d" class="ju jv hi kz b fi lh le l lf lg"># Enable Cloud Functions<br/>gcloud services enable cloudfunctions.googleapis.com \<br/>--project=$PROJECT</span><span id="b7b2" class="ju jv hi kz b fi lh le l lf lg"># GCS is enabled by default create 2 buckets<br/>for BUCKET in trigger thumbnails<br/>do<br/>  gsutil mb \<br/>  -c regional \<br/>  -l ${REGION} \<br/>  -p ${PROJECT} \<br/>  gs://${ROOT}-${BUCKET}<br/>done</span></pre><h2 id="8212" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">云资源仓库(CSR)</h2><p id="2fa9" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">CSR是一项提供托管、私有Git回购的服务。我通常很懒，使用常规的文件系统来存放我的代码，但是用Git保持变化是很棒的。一旦创建了CSR repo，就在本地为您的代码克隆它:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="f264" class="ju jv hi kz b fi ld le l lf lg"># Create a Cloud Source Repo called "default"<br/>gcloud source repos create default</span><span id="6e7a" class="ju jv hi kz b fi lh le l lf lg"># Change to your working directory<br/>gcloud source repos clone default --project=${PROJECT}</span></pre><p id="70a4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建index.js:</p><figure class="ku kv kw kx fd li"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="9b45" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">和package.json:</p><figure class="ku kv kw kx fd li"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="28b7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">打开Visual Studio代码(或您首选的编辑器)。用bash环境变量${root}的值替换“ROOT”的值(#10)。省省吧。</p><figure class="ku kv kw kx fd li er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ll"><img src="../Images/5e246faa78cccb49b03b9c2e79fc3291.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6t_OFs7DQ54QV_UaUXNhvQ.png"/></div></div></figure><p id="ff00" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Visual Studio代码包含一个Git客户端，因此您可以使用它暂存您的更改并定义一个提交。或者，如果您喜欢使用命令行:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="ca89" class="ju jv hi kz b fi ld le l lf lg">git add index.js<br/>git add package.json<br/>git commit --message "Initial commit"<br/>git push -u origin master</span></pre><p id="feca" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">每当您更改这些文件中的任何一个时，请重复add，commit，push命令，以确保您的文件正确反映在CSR:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="f3ad" class="ju jv hi kz b fi ld le l lf lg">https://console.cloud.google.com/code/develop/browse/default/master?project=${PROJECT}</span></pre><figure class="ku kv kw kx fd li er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ls"><img src="../Images/bfe0e0739f5d3c9b886af4aab5a14b98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N9MQdDQILwZnhCb39uWCtg.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">云资源仓库:默认</figcaption></figure><p id="2a40" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们将这段代码部署为一个云函数</p><h2 id="bd66" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">云函数</h2><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="5847" class="ju jv hi kz b fi ld le l lf lg">https://console.cloud.google.com/functions/list?project=${PROJECT}</span></pre><figure class="ku kv kw kx fd li er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lx"><img src="../Images/61d174c171a875f93aafc8cada67ae2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PInd0sFOMafc56PVtjebmw.png"/></div></div></figure><p id="9521" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">坚持使用命令行，您应该能够:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="0b1e" class="ju jv hi kz b fi ld le l lf lg">gcloud beta functions deploy downsizer \<br/>--source <a class="ae jt" href="https://source.developers.google.com/projects/${PROJECT}/repos/default/moveable-aliases/master/paths/" rel="noopener ugc nofollow" target="_blank">https://source.developers.google.com/projects/${PROJECT}/repos/default/moveable-aliases/master/paths/</a> \<br/>--trigger-bucket=${ROOT}-trigger \<br/>--entry-point=thumbnail \<br/>--project=$PROJECT</span></pre><p id="1c90" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你会注意到我把“缩小者”和“缩略图”搞混了，抱歉。我从“缩略图”开始，但现在更喜欢“缩小版”。它更…戏剧化。幸运的是，云函数允许别名。我们将云函数命名为“downsizer ”,但我们告诉它，在Node.js代码中导出的函数称为“thumbnail”。source标志的值是特定于＄{ PROJECT }的，事实上，回购被称为“default ”,为了简单起见，我们使用“master”。</p><p id="6903" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">几分钟后…</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="7cfb" class="ju jv hi kz b fi ld le l lf lg">Deploying function (may take a while - up to 2 minutes)...</span></pre><figure class="ku kv kw kx fd li er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ly"><img src="../Images/b62bc017b6c429af93c1822ad14b6aba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t_T1N54haaaT0lhfX1ue2A.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">云功能:部署“缩小版”</figcaption></figure><p id="59a0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">或者，如果你喜欢:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="40fb" class="ju jv hi kz b fi ld le l lf lg">gcloud beta functions list --project=$PROJECT<br/>NAME       STATUS  TRIGGER        REGION<br/>downsizer  ACTIVE  Event Trigger  us-central1</span></pre><h2 id="2d01" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">测试</h2><p id="24a8" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">因为我们为这个项目创建了存储桶，并且还没有使用它们，所以它们都是空的:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="5812" class="ju jv hi kz b fi ld le l lf lg">gsutil ls gs://${ROOT}-trigger<br/>gsutil ls gs://${ROOT}-thumbnails</span></pre><p id="30d0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">找到你最喜欢的图像，用gsutil把它复制到“触发器”桶中。这将触发云函数在“缩略图”桶中生成我们图像的4个缩略图。在我的示例中，我还将文件移动(重命名)到“/2013/road-trip/henry.jpg”以显示源路径被保留。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="be07" class="ju jv hi kz b fi ld le l lf lg">gsutil cp henry.jpg gs://${ROOT}-trigger/2013/road-trip<br/>Copying file:.../henry.jpg [Content-Type=image/jpeg]...<br/>- [1 files][  1.7 MiB/  1.7 MiB]                         <br/>Operation completed over 1 objects/1.7 MiB.</span></pre><p id="ff5c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是我和我最好的朋友:</p><figure class="ku kv kw kx fd li er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lz"><img src="../Images/f1029ce120697a0ac54e0946e4822113.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tpmAimV2zd-RuSftK3lWZA.jpeg"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">4000x3000</figcaption></figure><p id="ff73" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这张图片是4000x3000像素，1.7兆字节</p><p id="e493" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一切正常，你应该期待4个缩略图出现在'缩略图'桶。这是我的结果:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="224b" class="ju jv hi kz b fi ld le l lf lg">gsutil ls gs://${ROOT}-thumbnails/2013/road-trip/<br/>gs://${ROOT}-thumbnails/2013/road-trip/henry.jpg_128x128<br/>gs://${ROOT}-thumbnails/2013/road-trip/henry.jpg_256x2256<br/>gs://${ROOT}-thumbnails/2013/road-trip/henry.jpg_64x64</span></pre><p id="5dc5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用“gsutil ls -l”列举它们，我了解到它们按照列表顺序分别是18364、26154和15758字节，这听起来是正确的。所以，我们来确认一下:</p><p id="acd6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">64x64实际上是64x64，因为我的原始图像不是正方形的(64/4000*3000=48)</p><figure class="ku kv kw kx fd li er es paragraph-image"><div class="er es ma"><img src="../Images/930208d516b4ff85c2dcb558ce18ce82.png" data-original-src="https://miro.medium.com/v2/resize:fit:128/format:webp/1*zdHqSWPJ4g7lgSk4VOFI6A.jpeg"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">64x48</figcaption></figure><p id="4996" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">出于同样的原因，256x256实际上是256乘以192:</p><figure class="ku kv kw kx fd li er es paragraph-image"><div class="er es mb"><img src="../Images/eb7936ab4b18ce93ced5327ffc650ae4.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*AjZp8x5Wh_xzWfVMFgotkQ.jpeg"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">256x192</figcaption></figure><h2 id="e640" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">日志</h2><p id="e67a" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">我最近有点痴迷于grepping Stackdriver日志记录，所以我会控制自己，只给你一个例子:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="4b36" class="ju jv hi kz b fi ld le l lf lg">gcloud logging read "resource.type=\"cloud_function\" resource.labels.function_name=\"downsizer\"" \<br/>--project=$PROJECT \<br/>--freshness=10m \<br/>--format='value(textPayload)'</span></pre><blockquote class="mc md me"><p id="5ebc" class="ix iy mf iz b ja jb ij jc jd je im jf mg jh ji jj mh jl jm jn mi jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong>我今天早些时候了解到的“<a class="ae jt" href="https://cloud.google.com/sdk/gcloud/reference/beta/logging/read" rel="noopener ugc nofollow" target="_blank">新鲜度</a>标志，在本例中，它只检索最近10分钟的日志。</p></blockquote><h2 id="379e" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">更新日期:2017年12月21日</h2><p id="d67d" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">我修改了示例以利用标题元数据来指定所需的缩略图大小。上面的代码反映了这一点。现在，如果对象包含一个带有大小数组的“goog-meta-sizes”标头，将使用这些大小数组，而不是默认的[“256 x256”、“128x128”、“64x 64”]:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="ba80" class="ju jv hi kz b fi ld le l lf lg">gsutil  \<br/>-h 'x-goog-meta-sizes:["8x8","32x32","512x512"]' \<br/>cp henry.jpg gs://{ROOT}-trigger/2013/road-trip/beach/</span></pre><p id="f5d3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">结果是:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="59f0" class="ju jv hi kz b fi ld le l lf lg">gsutil ls gs://${ROOT}-thumbnails/2013/road-trip/beach/<br/>gs://${ROOT}-thumbnails/2013/road-trip/beach/henry.jpg_32x32<br/>gs://${ROOT}-thumbnails/2013/road-trip/beach/henry.jpg_512x512<br/>gs://${ROOT}-thumbnails/2013/road-trip/beach/henry.jpg_8x8</span></pre><blockquote class="mc md me"><p id="b3bd" class="ix iy mf iz b ja jb ij jc jd je im jf mg jh ji jj mh jl jm jn mi jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong>我发现很难找到云函数事件数据的规范。这是有据可查的，<a class="ae jt" href="https://cloud.google.com/functions/docs/concepts/events-triggers#event_parameter_and_data_property" rel="noopener ugc nofollow" target="_blank">这里</a>然后，对于云存储对象<a class="ae jt" href="https://cloud.google.com/storage/docs/json_api/v1/objects" rel="noopener ugc nofollow" target="_blank">这里</a>。</p></blockquote><h2 id="23ec" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">结论</h2><p id="c285" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">这与我之前的<a class="ae jt" rel="noopener" href="/google-cloud/google-cloud-storage-exploder-221c5b4d219c"> Exploder </a>帖子没有太大的不同，但是，在没有来自谷歌或第三方的替代方案的情况下，构建、部署和运行用于事件驱动处理的云功能是很简单的。</p><p id="60f5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">随时欢迎反馈！</p><h2 id="8d46" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">整理</h2><p id="3a70" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">您可以删除云功能:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="5306" class="ju jv hi kz b fi ld le l lf lg">gcloud beta functions delete downsizer \<br/>--project=${PROJECT} \<br/>--quiet</span></pre><p id="27de" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以在递归删除所有对象后删除存储桶。请小心使用这个命令:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="af94" class="ju jv hi kz b fi ld le l lf lg">gsutil rm -r gs://${ROOT}-trigger<br/>gsutil rm -r gs://${ROOT}-thumbnails</span></pre><p id="31f7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">或者，您可以简单地删除项目，这样也会删除其中的所有内容:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="fa56" class="ju jv hi kz b fi ld le l lf lg">gcloud projects delete ${PROJECT} --quiet</span></pre><p id="6806" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">谢谢！</p></div></div>    
</body>
</html>