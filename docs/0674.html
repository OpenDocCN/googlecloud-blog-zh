<html>
<head>
<title>Zero Downtime GKE Cluster &amp; Node Version Upgrade and Spec Update</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">零宕机GKE集群和节点版本升级和规格更新</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/zero-downtime-gke-cluster-node-version-upgrade-and-spec-update-dad917e25b53?source=collection_archive---------1-----------------------#2018-07-04">https://medium.com/google-cloud/zero-downtime-gke-cluster-node-version-upgrade-and-spec-update-dad917e25b53?source=collection_archive---------1-----------------------#2018-07-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="605d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">集群版本升级不会影响底层服务，但是Kubernetes api组件可能会在几分钟内不可用。此时，我们不能创建新的部署，也不能对资源进行任何其他更新。</p><p id="15c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">集群升级后，向集群添加新版本或规范的新节点:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="7eb6" class="jm jn hi ji b fi jo jp l jq jr">gcloud container node-pools create <strong class="ji hj">new-node</strong> --cluster <strong class="ji hj">mycluster</strong> --machine-type n1-standard-2 --disk-size 25 --num-nodes 5</span></pre><p id="9697" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，耗尽旧节点上运行的资源，将它们调度到新创建的节点上。这里，节点标签是<code class="du js jt ju ji b">cloud.google.com/gke-nodepool=default-pool</code>。通过描述池的任意节点得到标签:<code class="du js jt ju ji b">kubectl describe node <strong class="ih hj">nodename</strong></code> <strong class="ih hj">。</strong></p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="b561" class="jm jn hi ji b fi jo jp l jq jr">for node in $(kubectl get nodes -l <strong class="ji hj">cloud.google.com/gke-nodepool=default-pool</strong> -o=name); do<br/>  kubectl drain --force --ignore-daemonsets --delete-local-data --grace-period=300 "$node";<br/>done</span></pre><p id="d000" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">封锁节点，以便旧节点池上不会安排新资源:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="a032" class="jm jn hi ji b fi jo jp l jq jr">for node in $(kubectl get nodes -l <strong class="ji hj">cloud.google.com/gke-nodepool=default-pool</strong> -o=name); do kubectl cordon "$node"; done</span></pre><p id="79c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，删除旧节点:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="b02f" class="jm jn hi ji b fi jo jp l jq jr">gcloud container node-pools delete [POOL_NAME] --cluster [CLUSTER_NAME]</span></pre><p id="aa19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过类似的方式，可以实现节点磁盘大小调整、镜像更新(<code class="du js jt ju ji b"> — image-type</code>)的零停机升级。</p><p id="c1ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您愿意进行自动升级，可以根据有利的时机指定维护窗口:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="7647" class="jm jn hi ji b fi jo jp l jq jr">gcloud container clusters update gcloud [CLUSTER_NAME] --maintenance-window [HH:MM]</span></pre></div></div>    
</body>
</html>