<html>
<head>
<title>Particle, Cloud Functions &amp; Prometheus</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">粒子、云函数和普罗米修斯</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/particle-cloud-functions-prometheus-580b224b8c3e?source=collection_archive---------3-----------------------#2019-06-28">https://medium.com/google-cloud/particle-cloud-functions-prometheus-580b224b8c3e?source=collection_archive---------3-----------------------#2019-06-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="ccf7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">继我之前的故事“<a class="ae jd" rel="noopener" href="/google-cloud/particle-opencensus-microk8s-17d886d535e"> Particle，OpenCensus &amp; MicroK8s </a>”之后，我想知道Prometheus <a class="ae jd" href="https://github.com/prometheus/pushgateway" rel="noopener ugc nofollow" target="_blank"> PushGateway </a>是否是一个提供粒子设备测量的好解决方案。</p><p id="53cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">效果很好。</p><h2 id="1ab3" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">库伯内特斯</h2><p id="f946" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">下面是为Pushgateway创建部署并将其公开为服务(使用TCP负载平衡器)的Kubernetes配置:</p><figure class="ke kf kg kh fd ki"><div class="bz dy l di"><div class="kj kk l"/></div></figure><p id="7eda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以获得服务的端点:</p><pre class="ke kf kg kh fd kl km kn ko aw kp bi"><span id="5d1d" class="je jf hi km b fi kq kr l ks kt"><strong class="km hj">GATEWAY</strong>=$(kubectl get services/pushgateway \<br/>--output=jsonpath="{.status.loadBalancer.ingress[0].ip}") &amp;&amp; \<br/>echo ${GATEWAY}</span></pre><h2 id="57a3" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">云函数</h2><p id="5927" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">这里有一个云函数，它将传入的粒子Webhook帖子转换为普罗米修斯规范，并将其推送到Pushgateway:</p><figure class="ke kf kg kh fd ki"><div class="bz dy l di"><div class="kj kk l"/></div></figure><p id="80af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这可以通过以下方式进行部署:</p><pre class="ke kf kg kh fd kl km kn ko aw kp bi"><span id="54b0" class="je jf hi km b fi kq kr l ks kt">gcloud functions deploy topushgateway \<br/>--region=us-central1 \<br/>--project=${PROJECT} \<br/>--runtime=go112 \<br/>--trigger-http \<br/>--entry-point=ToPushGateway \<br/>--set-env-vars=GATEWAY=<strong class="km hj">${GATEWAY}</strong></span></pre><h2 id="50ab" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">粒子网钩</h2><p id="dd5c" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">创建一个粒子集成Webhook，将粒子“百分比”事件发送到云函数:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es ku"><img src="../Images/5db6020286f389a09c50c4a62d55efcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bihbeEAdjNZRjINM4utGUg.png"/></div></div></figure><h2 id="6a83" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">测试</h2><p id="cd81" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">1分钟后，Webhook应报告事件:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es lb"><img src="../Images/bb0a747cddb35ff31de4568f8fb7fcbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:624/format:webp/1*AkIxgxv_R_Fi0lSh1H7btg.png"/></div></figure><p id="87fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云函数应该报告事件:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lc"><img src="../Images/b5678e614ec551cb926e1f4d2735e439.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z-C_yS2g0QojKpUWqeA5nw.png"/></div></div></figure><p id="7019" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者:</p><pre class="ke kf kg kh fd kl km kn ko aw kp bi"><span id="4698" class="je jf hi km b fi kq kr l ks kt">gcloud logging read 'resource.type="cloud_function" resource.labels.function_name="topushgateway"' \<br/>--project=${PROJECT} \<br/>--<strong class="km hj">freshness=5m</strong> \<br/>--format="json" \<br/>| jq -r .[].textPayload</span><span id="f6b6" class="je jf hi km b fi ld kr l ks kt">Function execution took 43 ms, finished with status code: 200<br/>2019/06/28 17:29:45 value: 22.881563<br/>2019/06/28 17:29:45 function<br/>Function execution started<br/>Function execution took 40 ms, finished with status code: 200<br/>2019/06/28 17:28:44 value: 22.710623<br/>2019/06/28 17:28:44 function<br/>Function execution started<br/>Function execution took 43 ms, finished with status code: 200<br/>2019/06/28 17:27:44 value: 22.442003<br/>2019/06/28 17:27:44 function<br/>Function execution started<br/>Function execution took 42 ms, finished with status code: 200<br/>2019/06/28 17:26:44 value: 22.710623<br/>2019/06/28 17:26:44 function<br/>Function execution started<br/>Function execution took 41 ms, finished with status code: 200<br/>2019/06/28 17:25:44 value: 22.637363<br/>2019/06/28 17:25:44 function<br/>Function execution started</span></pre><p id="5df7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Pushgateway应该报告事件:</p><pre class="ke kf kg kh fd kl km kn ko aw kp bi"><span id="2693" class="je jf hi km b fi kq kr l ks kt">google-chrome http://<strong class="km hj">${GATEWAY}</strong>:9091/metrics</span></pre><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es le"><img src="../Images/8e665a2b833566d6824acd31b2f35365.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UVPCkY7_WEy07CXZncB3lw.png"/></div></div></figure><p id="d08b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该能够在页面中控制“百分比”度量。</p><h2 id="0311" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">普罗米修斯</h2><p id="865a" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">如果您想将Prometheus服务器连接到Pushgateway，创建一个<code class="du lf lg lh km b">prometheus.yml</code>并替换<code class="du lf lg lh km b">${GATEWAY}</code>的值:</p><pre class="ke kf kg kh fd kl km kn ko aw kp bi"><span id="8f01" class="je jf hi km b fi kq kr l ks kt">global:<br/>  scrape_interval: 5s<br/>  external_labels:<br/>    monitor: "local-monitor"</span><span id="0750" class="je jf hi km b fi ld kr l ks kt">scrape_configs:<br/>  - job_name: "pushgateway"<br/>    honor_labels: true<br/>    static_configs:<br/>      - targets: ["<strong class="km hj">${GATEWAY}</strong>:9091"]</span></pre><p id="fc2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后:</p><pre class="ke kf kg kh fd kl km kn ko aw kp bi"><span id="a79b" class="je jf hi km b fi kq kr l ks kt">docker run \<br/>--publish=9090:9090 \<br/>--volume=${PWD}/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus</span></pre><p id="b16a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并浏览<code class="du lf lg lh km b"><a class="ae jd" href="http://localhost:9090" rel="noopener ugc nofollow" target="_blank">http://localhost:9090</a></code></p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es li"><img src="../Images/921461d6c1de6862d69470442874bd17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yPAbmQiEeKJpX-mqXXurwA.png"/></div></div></figure><p id="fa62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用PromQL找到<code class="du lf lg lh km b">percent</code>:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lj"><img src="../Images/c77b7562e09854e5029278785b6067f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E7zUHBF0m10sfQhsBwA2Tw.png"/></div></div></figure><blockquote class="lk ll lm"><p id="1855" class="if ig ln ih b ii ij ik il im in io ip lo ir is it lp iv iw ix lq iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>在PromQL中，我通过<code class="du lf lg lh km b">job="pushgateway"</code>和<code class="du lf lg lh km b">core_id=${COREID}</code>进行过滤，其中<code class="du lf lg lh km b">${COREID}</code>是从Webhook数据中提取的粒子设备的标识符。</p></blockquote><h2 id="3187" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">结论</h2><p id="6da5" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">我一直想探索普罗米修斯之门。因为粒子发布事件是短暂可用的，所以使用类似云函数的东西将它们推送到Pushgateway是有意义的。</p><p id="5a0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这有助于你想象其他场景！</p><p id="b059" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仅此而已。</p></div></div>    
</body>
</html>