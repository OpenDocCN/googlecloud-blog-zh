<html>
<head>
<title>Managing GCP service usage through delegated role grants</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过委派角色授权管理GCP服务的使用</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/managing-gcp-service-usage-through-delegated-role-grants-a843610f2226?source=collection_archive---------0-----------------------#2021-09-22">https://medium.com/google-cloud/managing-gcp-service-usage-through-delegated-role-grants-a843610f2226?source=collection_archive---------0-----------------------#2021-09-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/0842f064cdc814dc5c0a3ca695f31b3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KJM5RbPuz5GsA3cB.jpg"/></div></div></figure><p id="aa8f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">企业客户通常需要对允许其用户在GCP使用哪些服务进行精细控制。例如，考虑一家公司可能希望如何允许他们的用户只使用谷歌计算引擎(GCE)、谷歌云存储(GCS)，而不使用其他东西。</p><p id="027c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">GCP通过<a class="ae jo" href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints" rel="noopener ugc nofollow" target="_blank">云API和服务</a>组织策略(<code class="du jp jq jr js b">constraints/serviceuser.services</code>)提供对服务使用的一些控制。然而，该组织策略仅支持有限的一组服务，并且它仅充当拒绝列表，而不可能指定允许服务的列表。出于限制服务使用的目的，该组织策略有所欠缺。</p><p id="413f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了解决这一问题，组织采取了对授予其用户的权限进行严格控制的手段来限制对特定服务的访问。在我们上面的场景中，组织管理员将只授予其用户计算管理员和存储管理员角色。这有效地防止了用户使用未经组织管理员授权的服务。</p><p id="2bc8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这种方法的问题是，虽然细粒度的权限有效地允许项目管理员最大限度地使用GCE和GCS，但权限管理确实非常严格和繁琐。这阻碍了生产力，因为项目管理员不能轻易地将权限授予其他任何人。如果需要加入新的主体(用户、服务帐户、组)，中央云管理员团队必须明确地将角色授予新的主体。</p><p id="12ee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">项目管理员不能授予其他任何人权限的原因是因为他们缺少自己项目的关键权限<code class="du jp jq jr js b">resourcemanager.projects.setIamPolicy</code>。没有此权限，项目管理员不能在项目级别创建(或更改)任何IAM绑定(即授权)。</p><p id="41a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，通过计算管理员和存储管理员角色，项目管理员可以授予对特定计算资源(例如虚拟机)或存储桶的权限，但如果管理员希望允许其他人创建新桶，该怎么办呢？</p><p id="9ff3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">输入委托角色授权</strong>。<a class="ae jo" href="https://cloud.google.com/iam/docs/setting-limits-on-granting-roles" rel="noopener ugc nofollow" target="_blank">委派角色授予</a>是GCP的一项新功能，它允许组织管理员控制用户可以授予或撤销哪些角色，即使用户对某个资源拥有<code class="du jp jq jr js b">setIamPolicy</code>权限。换句话说，通过委派角色授予，组织管理员可以授予用户<strong class="is hj">授予/撤销特定角色的权限。</strong>正如我们将看到的，委派角色授权是使用IAM条件配置的。<a class="ae jo" href="https://cloud.google.com/iam/docs/conditions-overview" rel="noopener ugc nofollow" target="_blank"> IAM conditions </a>本身就是一个完整的主题，但其总体思想是，它允许您指定给定的IAM绑定何时有效(即，仅当满足条件时才授予权限)。</p><p id="219e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此时，我们知道我们将为项目管理员创建一个带有条件的绑定。但是我们要给他们什么角色呢？如果我们在GCP控制台的角色页面中搜索<code class="du jp jq jr js b">resourcemanager.projects.setIamPolicy</code>权限，我们会看到一些有趣的选项:</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es jt"><img src="../Images/cc67c4b43d001ef35e9cdf7c01c4d034.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/0*_AiBJ7h5zTDQvA1m"/></div></figure><p id="df77" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以放弃这些角色中的大部分，但是，IAM管理的项目看起来很有前途。如果我们列出它的权限，我们会看到它只包括</p><ul class=""><li id="6012" class="jy jz hi is b it iu ix iy jb ka jf kb jj kc jn kd ke kf kg bi translated"><code class="du jp jq jr js b">resourcemanager.projects.get</code></li><li id="a069" class="jy jz hi is b it kh ix ki jb kj jf kk jj kl jn kd ke kf kg bi translated"><code class="du jp jq jr js b">resourcemanager.projects.getIamPolicy</code></li><li id="aca2" class="jy jz hi is b it kh ix ki jb kj jf kk jj kl jn kd ke kf kg bi translated"><code class="du jp jq jr js b">resourcemanager.projects.setIamPolicy</code></li></ul><p id="87a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是一个仅授予读写项目的IAM绑定的权限的角色，即设置其权限。</p><p id="90ad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们有了所有的工具来允许我们的用户只使用GCE和GCS，同时仍然给他们在他们自己的项目中授予额外权限的灵活性。项目管理员将在其项目中扮演以下角色:</p><ul class=""><li id="cbe2" class="jy jz hi is b it iu ix iy jb ka jf kb jj kc jn kd ke kf kg bi translated">计算管理</li><li id="259a" class="jy jz hi is b it kh ix ki jb kj jf kk jj kl jn kd ke kf kg bi translated">存储管理员</li><li id="7efd" class="jy jz hi is b it kh ix ki jb kj jf kk jj kl jn kd ke kf kg bi translated">项目IAM管理员，条件是仅授予/撤销计算管理员和存储管理员权限。</li></ul><h1 id="e084" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">实施细节</h1><p id="4671" class="pw-post-body-paragraph iq ir hi is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hb bi translated">要实现我们之前提到的权限，您必须创建一个具有以下形式的条件的绑定:</p><pre class="ju jv jw jx fd lp js lq lr aw ls bi"><span id="b371" class="lt kn hi js b fi lu lv l lw lx">api.getAttribute('iam.googleapis.com/modifiedGrantsByRole', []).hasOnly(roles)</span></pre><p id="cb23" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">其中<code class="du jp jq jr js b">roles</code>是您希望允许用户授予其他主体的角色列表。在我们的例子中，表达式应该是:</p><pre class="ju jv jw jx fd lp js lq lr aw ls bi"><span id="8656" class="lt kn hi js b fi lu lv l lw lx">api.getAttribute('iam.googleapis.com/modifiedGrantsByRole', []).hasOnly(['roles/compute.admin', 'roles/storage.admin'])</span></pre><p id="f36c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请记住，<code class="du jp jq jr js b">hasOnly()</code>的参数不能超过10个元素。如果希望委派更多的角色，可以用OR运算符(||)连接多个表达式。但是，每个条件最多只能有12个逻辑操作符，所以如果需要130个以上的角色，就需要创建多个绑定。</p><h1 id="611e" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">允许附加角色</h1><p id="c017" class="pw-post-body-paragraph iq ir hi is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hb bi translated">到目前为止，我们已经允许项目管理员委派计算管理员和存储管理员，但如果项目管理员还想委派其他权力较小的角色，如存储对象查看器，该怎么办？尽管存储对象查看器的权限集是存储管理员的严格子集，但我们使用的IAM条件不支持授予存储对象查看器权限。我们需要<strong class="is hj">明确列出项目管理员将被允许授予/撤销的任何和所有角色。</strong>我们希望以这样的方式结束:</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/c530f7a3554e4aab9c5b9ec594b1cfb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tjh59JHCvHuv9x705Q8kgw.png"/></div></div></figure><p id="c5c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">虽然不方便，但我们可以轻松地在我们的条件中包含任何其他计算和存储角色。要提取与GCE和GCS相关的任何角色，我们可以使用以下命令:</p><pre class="ju jv jw jx fd lp js lq lr aw ls bi"><span id="7a9e" class="lt kn hi js b fi lu lv l lw lx">$ gcloud iam roles list --filter=”name:roles/storage. stage=GA” — format=”get(name)” &gt;&gt; roles.txt<br/>$ gcloud iam roles list --filter=”name:roles/compute. stage=GA” — format=”get(name)” &gt;&gt; roles.txt</span></pre><p id="7820" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">运行这个roles.txt后，将包含如下内容:</p><pre class="ju jv jw jx fd lp js lq lr aw ls bi"><span id="48a7" class="lt kn hi js b fi lu lv l lw lx">roles/storage.admin<br/>roles/storage.hmacKeyAdmin<br/>roles/storage.legacyBucketOwner<br/>roles/storage.legacyBucketReader<br/>roles/storage.legacyBucketWriter<br/>roles/storage.legacyObjectOwner<br/>roles/storage.legacyObjectReader<br/>roles/storage.objectAdmin<br/>roles/storage.objectCreator<br/>roles/storage.objectViewer<br/>roles/compute.admin<br/>roles/compute.imageUser<br/>roles/compute.instanceAdmin<br/>roles/compute.instanceAdmin.v1<br/>roles/compute.networkAdmin<br/>roles/compute.networkUser<br/>roles/compute.networkViewer<br/>roles/compute.orgFirewallPolicyAdmin<br/>roles/compute.orgFirewallPolicyUser<br/>roles/compute.orgSecurityPolicyAdmin<br/>roles/compute.orgSecurityPolicyUser<br/>roles/compute.orgSecurityResourceAdmin<br/>roles/compute.osAdminLogin<br/>roles/compute.osLogin<br/>roles/compute.osLoginExternalUser<br/>roles/compute.packetMirroringAdmin<br/>roles/compute.packetMirroringUser<br/>roles/compute.publicIpAdmin<br/>roles/compute.securityAdmin<br/>roles/compute.serviceAgent<br/>roles/compute.storageAdmin<br/>roles/compute.viewer<br/>roles/compute.xpnAdmin</span></pre><p id="27a8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们删除了所有遗留角色和<code class="du jp jq jr js b">compute.xpnAdmin</code>,因为它不能应用于项目级别。我们现在有28个角色，所以我们必须将我们的条件分成多个表达式:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="324d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">构建和维护这个表达式当然很麻烦。我们将看到如何使用Terraform实现自动化，但首先需要注意一些重要事项。</p><h1 id="b761" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">考虑</h1><p id="b04b" class="pw-post-body-paragraph iq ir hi is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hb bi translated">需要记住的一个重要方面是，IAM绑定是附加应用的。这意味着，如果您有一个有条件的角色绑定和无条件的角色绑定(直接或通过资源层次结构继承)用于同一个角色并提到同一个用户，那么有条件的角色绑定实际上是无用的。在使用委派角色授权时，您必须牢记这一点，并确保以下几点，以确保您的用户保持在您设置的限制范围内:</p><ol class=""><li id="ce74" class="jy jz hi is b it iu ix iy jb ka jf kb jj kc jn mb ke kf kg bi translated">您必须<strong class="is hj">确保授予项目管理员的无条件角色绑定不允许他们使用</strong> <code class="du jp jq jr js b">resourcemanager.projects.setIamPolicy</code> <strong class="is hj">权限</strong>。如果您做不到这一点，项目管理员可以授予他们自己(和任何其他委托人)任何他们想要的角色。</li><li id="ef8b" class="jy jz hi is b it kh ix ki jb kj jf kk jj kl jn mb ke kf kg bi translated">您必须<strong class="is hj">确保没有一个被委派的角色包含</strong> <code class="du jp jq jr js b">resourcemanager.projects.setIamPolicy</code> <strong class="is hj">权限</strong>。如果做不到这一点，项目管理员可以授予自己包含该权限的角色，然后授予自己任何想要的角色。换句话说，您必须确保上一个屏幕截图中显示的角色都没有列在IAM条件的<code class="du jp jq jr js b">hasOnly()</code>调用中(如果您有任何自定义角色，您也必须考虑这些角色)。</li><li id="5b8f" class="jy jz hi is b it kh ix ki jb kj jf kk jj kl jn mb ke kf kg bi translated"><strong class="is hj">项目管理员不应该有权限修改他们可以授予</strong>的任何(自定义)角色。如果不能确保这一点，项目管理员就可以将<code class="du jp jq jr js b">resourcemanager.projects.setIamPolicy</code>添加到他们控制的角色中，然后授予自己该角色，这实际上是将他们的权限提升到了完全的<code class="du jp jq jr js b">projectIamAdmin</code>。</li></ol><h1 id="e14b" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">使用Terraform处理委派角色授权</h1><p id="d543" class="pw-post-body-paragraph iq ir hi is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hb bi translated">正如我们之前看到的，构建IAM条件来实现委托角色绑定可能会很棘手。为了简化这个过程，我们构建了一个<a class="ae jo" href="https://github.com/terraform-google-modules/cloud-foundation-fabric/tree/master/cloud-operations/iam-delegated-role-grants" rel="noopener ugc nofollow" target="_blank"> Terraform示例</a>，它实现了我们在本文中讨论的场景。只需克隆回购协议并适当设置<code class="du jp jq jr js b">project_id</code>和<code class="du jp jq jr js b">project_administrators</code>变量:</p><pre class="ju jv jw jx fd lp js lq lr aw ls bi"><span id="b6ac" class="lt kn hi js b fi lu lv l lw lx">$ git clone <a class="ae jo" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/cloud-foundation-fabric.git</a><br/>$ cd cloud-foundation-fabric/blueprints/cloud-operations/iam-delegated-role-grants/<br/>$ terraform init<br/>$ terraform apply -var project_id=my-project-id 'project_administrators=["user:project-admin@example.com"]'</span></pre><p id="e869" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">运行后，<code class="du jp jq jr js b">project-admin@example.com</code>将被允许授予上面<code class="du jp jq jr js b">my-project-id</code>中列出的GCE和GCS角色。如果用户尝试授予任何其他角色(例如角色/所有者)，GCP将不会允许。去试试吧！</p><p id="4699" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是你开始所需要的，但是你也可以通过<code class="du jp jq jr js b">direct_role_grants</code>和<code class="du jp jq jr js b">delegated_role_grants</code>变量定制角色集。查看<a class="ae jo" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric/blob/master/blueprints/cloud-operations/iam-delegated-role-grants/README.md" rel="noopener ugc nofollow" target="_blank">自述文件</a>了解更多详情。</p><h1 id="19d7" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">审核委派的权限</h1><p id="b174" class="pw-post-body-paragraph iq ir hi is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hb bi translated">在考虑因素部分，我们提到我们必须确保项目管理员没有直接或间接的<code class="du jp jq jr js b">resourcemanager.projects.setIamPolicy</code>权限。为了帮助确保这一点，存储库还包括一个Python脚本来帮助验证这一点。你只需要把你想要检查的角色放在一个文件中，脚本会告诉你是否有角色包含了<code class="du jp jq jr js b">resourcemanager.projects.setIamPolicy</code>(还有一些其他的)。</p><pre class="ju jv jw jx fd lp js lq lr aw ls bi"><span id="66bb" class="lt kn hi js b fi lu lv l lw lx">$ pip3 install -r requirements.txt<br/>$ gcloud application default login<br/>$ python3 audit.py roles.txt</span><span id="1697" class="lt kn hi js b fi mc lv l lw lx">roles/storage.admin ok<br/>roles/storage.hmacKeyAdmin ok<br/>roles/storage.objectAdmin ok<br/>roles/storage.objectCreator ok<br/>roles/storage.objectViewer ok<br/>roles/compute.admin ok<br/>roles/compute.imageUser ok<br/>roles/compute.instanceAdmin ok<br/>roles/compute.instanceAdmin.v1 ok<br/>roles/compute.networkAdmin ok<br/>roles/compute.networkUser ok<br/>roles/compute.networkViewer ok<br/>roles/compute.orgFirewallPolicyAdmin ok<br/>roles/compute.orgFirewallPolicyUser ok<br/>roles/compute.orgSecurityPolicyAdmin ok<br/>roles/compute.orgSecurityPolicyUser ok<br/>roles/compute.orgSecurityResourceAdmin ok<br/>roles/compute.osAdminLogin ok<br/>roles/compute.osLogin ok<br/>roles/compute.osLoginExternalUser ok<br/>roles/compute.packetMirroringAdmin ok<br/>roles/compute.packetMirroringUser ok<br/>roles/compute.publicIpAdmin ok<br/>roles/compute.securityAdmin ok<br/>roles/compute.serviceAgent ok<br/>roles/compute.storageAdmin ok<br/>roles/compute.viewer ok<br/>roles/compute.xpnAdmin ok<br/>WARNING: roles/owner contains {'resourcemanager.projects.setIamPolicy'}</span></pre><p id="0d99" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们有意在文件中包含了所有者角色，以向您展示需要注意的事项。如果您在输出中得到任何警告，检查有问题的角色并再次运行脚本，直到您的所有角色都显示为“ok”。</p><p id="bbee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意</strong>:该脚本使用<a class="ae jo" href="https://cloud.google.com/sdk/gcloud/reference/auth/application-default" rel="noopener ugc nofollow" target="_blank">应用程序默认凭证</a>，因此在运行它之前，您需要使用<code class="du jp jq jr js b">gcloud auth application-default login</code>来验证您的Google用户。</p><h1 id="64d8" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">结束语</h1><p id="a0cd" class="pw-post-body-paragraph iq ir hi is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hb bi translated">我们已经展示了如何使用委派角色授权来限制GCP服务的使用。这是一个强大的功能，您可以将它整合到您的整体安全设计中，以简化权限管理。对于一些组织来说，这可以取代涉及中央云管理团队的静态权限管理，而其他组织可以混合使用这两种方法(即，集中管理生产权限，而其他环境依赖于委派角色授权来实现更大的灵活性)。</p><p id="87d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在以后的文章中，我们将讨论如何将这种技术扩展到更多的服务，以及如何允许项目管理员指定新的项目管理员。敬请期待！</p></div></div>    
</body>
</html>