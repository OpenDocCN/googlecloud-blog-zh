<html>
<head>
<title>Near Real Time Data Replication using Debezium on GKE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GKE上使用Debezium进行近实时数据复制</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/near-real-time-data-replication-using-debezium-on-gke-634ee1d3e1aa?source=collection_archive---------1-----------------------#2022-02-12">https://medium.com/google-cloud/near-real-time-data-replication-using-debezium-on-gke-634ee1d3e1aa?source=collection_archive---------1-----------------------#2022-02-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1138" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本帖中，我们将使用部署在GKE上的Debezium将实时数据从Postgres实例传输到Google Pub/Sub。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/74bc4857eab0d76649c6530729b34fd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/0*9UrdJZUBZj-1g-nc"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">体系结构</figcaption></figure><p id="2f6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置完成后，您可以使用任何下游工具。一个广泛使用的用例是将流量从发布/订阅传输到数据流，在其上运行一些转换，然后导出到BigQuery进行分析。</p><h1 id="6ed0" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">所需的基础设施:</h1><p id="4843" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">我们将在基础架构下进行配置</p><ol class=""><li id="c3eb" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">CloudSQL上的Postgres DB</li><li id="2f96" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">GKE的Debezium</li><li id="0f6c" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">云发布/订阅</li><li id="ec1f" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">一个附属于Pub/Sub的云功能-只是为了确保流到达GCP</li></ol><h1 id="018d" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated"><strong class="ak"> 1。CloudSQL上的postgres DB</strong></h1><p id="5ecd" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">1.使用下面的命令创建一个Postgres DB，确保添加了"<strong class="ih hj"> <em class="lh"> —数据库标志cloudsql . logical _ decoding = on</em></strong>"</p><pre class="jf jg jh ji fd li lj lk ll aw lm bi"><span id="b1e1" class="ln jr hi lj b fi lo lp l lq lr">gcloud sql instances create debezium-db — database-version=POSTGRES_12 — tier=db-g1-small — region=asia-south1 — database-flags cloudsql.logical_decoding=on</span></pre><p id="534a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.接下来，在创建数据库之后——连接到Postgres并创建一个数据库用户“debezium_user ”,它具有复制属性。</p><pre class="jf jg jh ji fd li lj lk ll aw lm bi"><span id="6f0b" class="ln jr hi lj b fi lo lp l lq lr">CREATE USER debezium_user WITH REPLICATION IN ROLE cloudsqlsuperuser LOGIN PASSWORD admin;</span></pre><p id="8097" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.创建一个我们将用于测试的表。</p><pre class="jf jg jh ji fd li lj lk ll aw lm bi"><span id="6a4a" class="ln jr hi lj b fi lo lp l lq lr">CREATE TABLE public.actor (</span><span id="41ab" class="ln jr hi lj b fi ls lp l lq lr">actor_id integer NOT NULL,</span><span id="0f76" class="ln jr hi lj b fi ls lp l lq lr">first_name character varying(45) NOT NULL,</span><span id="43b6" class="ln jr hi lj b fi ls lp l lq lr">last_name character varying(45) NOT NULL,</span><span id="4dba" class="ln jr hi lj b fi ls lp l lq lr">last_update timestamp without time zone DEFAULT now() NOT NULL</span><span id="6cc0" class="ln jr hi lj b fi ls lp l lq lr">);</span></pre><h1 id="6208" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">2.创建发布/订阅主题</h1><p id="f534" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">创建一个名为&lt; CloudSQL Server Name &gt;的<a class="ae jd" href="https://cloud.google.com/pubsub" rel="noopener ugc nofollow" target="_blank"> GCP发布/订阅</a>主题。&lt;模式名&gt;。&lt;表&gt;跟随<a class="ae jd" href="https://cloud.google.com/pubsub/docs/quickstart-console" rel="noopener ugc nofollow" target="_blank">创建发布/订阅</a>。对于我们的例子，它应该是<strong class="ih hj">debezium-db . public . actor</strong>。</p><p id="f388" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了使用发布/订阅，我们还需要添加一些配置。我们将在Debezium配置文件中添加以下配置参数</p><blockquote class="lt lu lv"><p id="b5cf" class="if ig lh ih b ii ij ik il im in io ip lw ir is it lx iv iw ix ly iz ja jb jc hb bi translated">debezium.sink.type=pubsub</p><p id="ebc7" class="if ig lh ih b ii ij ik il im in io ip lw ir is it lx iv iw ix ly iz ja jb jc hb bi translated">debezium . sink . pub sub . project . id =<gcp project="" id=""/></p><p id="0b9d" class="if ig lh ih b ii ij ik il im in io ip lw ir is it lx iv iw ix ly iz ja jb jc hb bi translated">debezium . sink . pub sub . ordering . enabled = true</p></blockquote><h1 id="aff0" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">3.GKE的Debezium</h1><p id="45a4" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">要在GKE上部署Debezium，我们需要创建一个打开了工作负载身份的Kubernetes集群</p><ol class=""><li id="d8ec" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">在<a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity" rel="noopener ugc nofollow" target="_blank">创建GKE集群</a>之后创建GKE集群(确保您为服务帐户分配了访问发布/订阅的角色)</li><li id="c1e6" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">在集群上部署以下文件，我们正在部署一个带有开源Debezium映像的<a class="ae jd" href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" rel="noopener ugc nofollow" target="_blank">有状态集</a>。唯一增加的是Debezium容器中使用的命令，它将使用<a class="ae jd" href="https://cloud.google.com/sql/docs/mysql/sql-proxy" rel="noopener ugc nofollow" target="_blank"> GCP云代理</a>连接到数据库。</li></ol><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="67a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在以下位置找到代码库</p><div class="mb mc ez fb md me"><a href="https://github.com/ajiteshk-G/Near-Real-Time-Streaming-using-Debezium-on-GKE" rel="noopener  ugc nofollow" target="_blank"><div class="mf ab dw"><div class="mg ab mh cl cj mi"><h2 class="bd hj fi z dy mj ea eb mk ed ef hh bi translated">GitHub-ajiteshk-G/GKE河畔使用Debezium的近实时流</h2><div class="ml l"><h3 class="bd b fi z dy mj ea eb mk ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mm l"><p class="bd b fp z dy mj ea eb mk ed ef dx translated">github.com</p></div></div><div class="mn l"><div class="mo l mp mq mr mn ms jk me"/></div></div></a></div><p id="9b3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保将这些文件部署在创建GKE集群时设置服务帐户的同一名称空间中。</p><h1 id="237e" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">4.创建云函数</h1><p id="06b6" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">转到发布/订阅主题，然后单击创建云函数。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="er es mt"><img src="../Images/d00b06d53af59309b1f3335c4db287f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jSoeE-eYCkOOfSB0"/></div></div></figure><h1 id="afef" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">5.导出到BigQuery(可选)</h1><p id="e49f" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">您可以通过创建一个数据流作业将流导出到BigQuery，但是我们将在第4步结束这篇文章。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="er es mt"><img src="../Images/f8febb1fc0c1c012c8bf58e0986f5c00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Sn7YfDZz16crOpfgWUfDlw.png"/></div></div></figure><h1 id="c352" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">测试-</h1><p id="2ada" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">现在我们已经完成了所有的设置，但是我们如何测试呢？转到CloudFunction并打开已创建的云函数的logs选项卡。接下来，在Postgres实例上运行下面的存储过程，然后调用方法。</p><pre class="jf jg jh ji fd li lj lk ll aw lm bi"><span id="675b" class="ln jr hi lj b fi lo lp l lq lr">CREATE OR REPLACE PROCEDURE load_data()</span><span id="afac" class="ln jr hi lj b fi ls lp l lq lr">LANGUAGE plpgsql</span><span id="7194" class="ln jr hi lj b fi ls lp l lq lr">AS $$</span><span id="2b36" class="ln jr hi lj b fi ls lp l lq lr">DECLARE</span><span id="ce56" class="ln jr hi lj b fi ls lp l lq lr">BEGIN</span><span id="8b32" class="ln jr hi lj b fi ls lp l lq lr">FOR i IN 1..20 LOOP</span><span id="83b4" class="ln jr hi lj b fi ls lp l lq lr">INSERT INTO public.actor VALUES (i,’test first’,’test last’,’2013–05–26 14:47:57.62');</span><span id="d4a3" class="ln jr hi lj b fi ls lp l lq lr">COMMIT;</span><span id="1abe" class="ln jr hi lj b fi ls lp l lq lr">END LOOP;</span><span id="c8bd" class="ln jr hi lj b fi ls lp l lq lr">END;</span><span id="33b1" class="ln jr hi lj b fi ls lp l lq lr">$$;</span></pre><p id="81b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您应该可以在云函数中看到日志流。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="er es my"><img src="../Images/c1df80b6e32d96d30784c3ae469c6d8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vWy-A4pqCD-26X2H"/></div></div></figure></div></div>    
</body>
</html>