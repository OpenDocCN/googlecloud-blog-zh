<html>
<head>
<title>GoCD on Google Kubernetes Engine Using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform在Google Kubernetes引擎上运行GoCD</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gocd-on-google-kubernetes-engine-using-terraform-5eb0d0b537d3?source=collection_archive---------0-----------------------#2018-09-26">https://medium.com/google-cloud/gocd-on-google-kubernetes-engine-using-terraform-5eb0d0b537d3?source=collection_archive---------0-----------------------#2018-09-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/858c51e03a49479e8d2394a73887ae56.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*J2iFOKfLesB6PafNvjYUsw.png"/></div></figure><p id="85bd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">GoCD 是由<a class="ae jk" href="https://www.thoughtworks.com" rel="noopener ugc nofollow" target="_blank"> ThoughtWorks </a>开发的一个非常酷的CD工具。我最近一直在研究<a class="ae jk" href="https://www.thoughtworks.com/continuous-delivery" rel="noopener ugc nofollow" target="_blank">连续交付</a>，我想如果我想要一个工具与之匹配，我会尝试这个，因为你知道，它们与<a class="ae jk" href="https://www.amazon.com/dp/0321601912" rel="noopener ugc nofollow" target="_blank">书</a>有关。</p></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><h1 id="b9af" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">初始设置:</h1><p id="d87d" class="pw-post-body-paragraph im in hi io b ip kq ir is it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj hb bi translated">在您的<a class="ae jk" href="https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy" rel="noopener ugc nofollow" target="_blank">云平台资源层级</a>中创建一个文件夹，并在该文件夹中创建一个项目。例如，一个名为“工具”的文件夹和一个名为“我的工具产品”的项目。</p><p id="8944" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">该项目将运行<a class="ae jk" href="https://cloud.google.com/dns" rel="noopener ugc nofollow" target="_blank"> Google Cloud DNS </a>，我们将使用<a class="ae jk" href="https://github.com/kubernetes-incubator/external-dns" rel="noopener ugc nofollow" target="_blank">外部dns </a>同步Kubernetes入口资源。它还将为<a class="ae jk" href="https://www.terraform.io/docs/state/remote.html" rel="noopener ugc nofollow" target="_blank"> Terraform远程状态</a>运行<a class="ae jk" href="https://cloud.google.com/storage" rel="noopener ugc nofollow" target="_blank">谷歌云存储</a>。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="3d2f" class="le jt hi la b fi lf lg l lh li">export project=my-tools-prod<br/>gcloud config set project ${project}</span></pre><p id="29ef" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">创建一个</strong> <a class="ae jk" href="https://cloud.google.com/dns/zones" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj"> Google Cloud托管DNS区域</strong> </a> <strong class="io hj"> : </strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="939d" class="le jt hi la b fi lf lg l lh li">gcloud dns managed-zones create domain-com \<br/>--description="My Default Domain" --dns-name="domain.com"</span></pre><p id="d169" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">向您的域名注册机构注册该区域:</strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="075f" class="le jt hi la b fi lf lg l lh li">gcloud dns record-sets list --zone domain-com</span><span id="c8d9" class="le jt hi la b fi lj lg l lh li">NAME          TYPE  TTL    DATA<br/>domain.com.                         NS     21600  ns-cloud-c1.googledomains.com.,ns-cloud-c2.googledomains.com.,ns-cloud-c3.googledomains.com.,ns-cloud-c4.googledomains.com.<br/>domain.com.                         SOA    21600  ns-cloud-c1.googledomains.com. cloud-dns-hostmaster.google.com.</span></pre><p id="4698" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这将显示您的NS记录，获取数据并在您的注册服务商上创建NS记录。从这一点开始，Google Cloud DNS将管理“domain.com”。</p><p id="87e7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">创建一个</strong> <a class="ae jk" href="https://cloud.google.com/storage/docs/creating-buckets" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj"> Google云存储桶</strong> </a> <strong class="io hj">为</strong> <a class="ae jk" href="https://www.terraform.io/docs/state/remote.html" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj"> Terraform远程状态</strong> </a> <strong class="io hj"> : </strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="396c" class="le jt hi la b fi lf lg l lh li">gsutil mb -p ${project} -c multi_regional -l US \<br/>gs://${project}_tf_state</span></pre><p id="536d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">同时启用<a class="ae jk" href="https://cloud.google.com/storage/docs/object-versioning" rel="noopener ugc nofollow" target="_blank">对象版本</a>:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="741b" class="le jt hi la b fi lf lg l lh li">gsutil versioning set on gs://${project}_tf_state</span></pre><p id="a0be" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们有了一个包含项目和资源的资源层次结构，它将支持我们部署GoCD的依赖项。</p></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><h1 id="cf9a" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">部署GoCD:</h1><p id="bfe2" class="pw-post-body-paragraph im in hi io b ip kq ir is it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj hb bi translated">这将为您提供一个公开的GoCD实例，并使用来自Let's Encrypt的DNS和SSL运行。</p><p id="cc01" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">安装谷歌云SDK: </strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="e0c0" class="le jt hi la b fi lf lg l lh li">curl https://sdk.cloud.google.com | bash<br/>exec -l $SHELL<br/>gcloud init<br/>gcloud components install kubectl</span></pre><p id="7317" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">安装地形:</strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="9f82" class="le jt hi la b fi lf lg l lh li">curl -O https://releases.hashicorp.com/terraform/0.11.8/terraform_0.11.8_linux_amd64.zip<br/>sudo unzip terraform_0.11.8_linux_amd64.zip -d /usr/local/bin</span></pre><p id="f72c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">设置Google应用默认凭证:</strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="fc1a" class="le jt hi la b fi lf lg l lh li">gcloud auth application-default login</span></pre><p id="0aa8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">克隆项目:</strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="e071" class="le jt hi la b fi lf lg l lh li">git clone git@github.com:lzysh/ops-gke-gocd.git</span></pre><p id="d120" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">初始化地形:</strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="2ace" class="le jt hi la b fi lf lg l lh li">cd ops-gke-gocd/terraform<br/>terraform init -backend-config="bucket=${project}_tf_state" -backend-config="project=${project}"</span></pre><blockquote class="lk ll lm"><p id="57e0" class="im in ln io b ip iq ir is it iu iv iw lo iy iz ja lp jc jd je lq jg jh ji jj hb bi translated"><em class="hi">注意:此时您被设置为在Terraform中使用</em> <a class="ae jk" href="https://www.terraform.io/docs/state/remote.html" rel="noopener ugc nofollow" target="_blank"> <em class="hi">远程状态</em> </a> <em class="hi">。</em></p></blockquote><p id="d565" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">设置变量:</strong></p><p id="22c7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">创建一个<code class="du lr ls lt la b">local.tfvars</code>文件，并根据需要进行编辑:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="92dd" class="le jt hi la b fi lf lg l lh li">cp local.tfvars.EXAMPLE local.tfvars</span></pre><blockquote class="lk ll lm"><p id="58c7" class="im in ln io b ip iq ir is it iu iv iw lo iy iz ja lp jc jd je lq jg jh ji jj hb bi translated"><em class="hi">注意:folder_id变量将是你在上面创建的“工具”文件夹的id。</em></p></blockquote><p id="ee51" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">地形图&amp;适用:</strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="1c94" class="le jt hi la b fi lf lg l lh li">random=$RANDOM<br/>terraform plan -out="plan.out" -var-file="local.tfvars" -var="project=&lt;gocd-project&gt;-${random}-sb" -var="host=gocd-${random}"<br/>terraform apply "plan.out"</span></pre><p id="55f2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">terraform应用成功后，大约需要5-10分钟才能访问GoCD实例。入口正在做它的事情，DNS正在传播，SSL证书正在颁发。</p><p id="e669" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">地形摧毁:</strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="60e8" class="le jt hi la b fi lf lg l lh li">terraform destroy -var-file="local.tfvars" -var="project=&lt;gocd-project&gt;-${random}-sb -var="host=gocd-${random}"</span></pre></div></div>    
</body>
</html>