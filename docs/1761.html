<html>
<head>
<title>Cloud Build is everywhere</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云构建无处不在</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-build-is-everywhere-f516e96cd268?source=collection_archive---------0-----------------------#2021-01-18">https://medium.com/google-cloud/cloud-build-is-everywhere-f516e96cd268?source=collection_archive---------0-----------------------#2021-01-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c9da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们最喜欢云提供商的一点是，你只需给出几行代码，而故事的其余部分不是由你完成的。</p><p id="5612" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud的<strong class="ih hj">无服务器CI/CD产品【Cloud Build令人惊叹，因为它简单、智能、高效。</strong></p><h1 id="933e" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">今天我要告诉你们:</h1><ul class=""><li id="ee69" class="kb kc hi ih b ii kd im ke iq kf iu kg iy kh jc ki kj kk kl bi translated">如何使用CloudBuild</li><li id="52f9" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">如何保护您的云构建</li><li id="fa73" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">使用CloudBuild部署云功能</li><li id="3ca7" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">从CloudBuild调用cURL</li><li id="306f" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">在CloudBuild中使用Terraform</li><li id="ebad" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">从任何地方触发云构建</li><li id="9747" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">从另一个CloudBuild触发CloudBuild</li><li id="46f9" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">GCP IAM从CloudBuild“添加权限”操作</li></ul><h1 id="2278" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">云构建的触发功能易于配置。</strong></h1><p id="2821" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">在这里，我有一个托管我的代码的云存储库，我想让我的Cloudbuild代码(无论它在做什么)在每次我推送新版本的代码时运行:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/8e54fcbfaf012d3db1ecba9230ddf80f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zO1OHJfhGhsoCk4tEYgFog.png"/></div></div></figure><p id="324a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每当我在主分支中修改我的代码时，触发器就会自动执行我的代码。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lg"><img src="../Images/b2e7f4f2291ee8eb1aec285d2f0de6d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nFwjfSYwiUHIci2h25vrzw.png"/></div></div></figure><p id="d4f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的配置是一个YAML文件，我可以添加替代变量，这在你有一些变量要导入时非常有用(不要放入关键信息，请优先使用秘密管理器来保存秘密……)</p></div><div class="ab cl lh li gp lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="hb hc hd he hf"><p id="56a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最近，Google推出了一项新功能来保护您的CloudBuild管道。就像他们在其他无服务器产品(云运行或云功能)中已经做的那样，您现在可以指定用于您的云构建的ServiceAccount。</p><p id="c703" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这意味着您可以根据最小特权原则，用自己的身份来分隔所有管道。</p><p id="bf8f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来是:</p><div class="lo lp ez fb lq lr"><a href="https://cloud.google.com/cloud-build/docs/securing-builds/configure-user-specified-service-accounts" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab dw"><div class="lt ab lu cl cj lv"><h2 class="bd hj fi z dy lw ea eb lx ed ef hh bi translated">配置用户指定的服务帐户</h2><div class="ly l"><h3 class="bd b fi z dy lw ea eb lx ed ef dx translated">" type": "thumb-down "，" id": "hardToUnderstand "，" label ":"难以理解" }，{ "type": "thumb-down "，" id"…</h3></div><div class="lz l"><p class="bd b fp z dy lw ea eb lx ed ef dx translated">cloud.google.com</p></div></div><div class="ma l"><div class="mb l mc md me ma mf le lr"/></div></div></a></div><p id="2197" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不要忘了在你的YAML的结尾加上这句台词</p><pre class="kv kw kx ky fd mg mh mi mj aw mk bi"><span id="a915" class="ml je hi mh b fi mm mn l mo mp">serviceAccount: 'projects/PROJECT_NAME/serviceAccounts/SERVICE_ACCOUNT'</span></pre></div><div class="ab cl lh li gp lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="hb hc hd he hf"><p id="3424" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们来谈谈配置的YAML，如果我说</p><p id="2920" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">我可以使用云构建，通过gcloud从云资源回购托管代码部署我的云功能</strong></p><pre class="kv kw kx ky fd mg mh mi mj aw mk bi"><span id="00ec" class="ml je hi mh b fi mm mn l mo mp">steps:<br/>  - name: "gcr.io/cloud-builders/gcloud"<br/>    args:<br/>      [<br/>        "functions",<br/>        "deploy",<br/>        "$_GCF",<br/>        "--region",<br/>        "europe-west2",<br/>        "--trigger-http",<br/>        "--runtime",<br/>        "python38",<br/>        "--entry-point",<br/>        "manager",<br/>        "--timeout",<br/>        "540s",<br/>        "--service-account",<br/>        "$_SA",<br/>        "--env-vars-file",<br/>        "./.env.yaml",<br/>        "--update-labels",<br/>        "name=$_GCF",<br/>      ]</span></pre><p id="e40f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，您可以看到代码将使用gcloud和替换变量($_xxx)等参数部署我的GCF</p></div><div class="ab cl lh li gp lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="hb hc hd he hf"><p id="0b73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">我也可以使用云构建来使用cURL </strong></p><p id="4bef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据这个</p><div class="lo lp ez fb lq lr"><a href="https://github.com/GoogleCloudPlatform/cloud-builders/tree/master/curl" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab dw"><div class="lt ab lu cl cj lv"><h2 class="bd hj fi z dy lw ea eb lx ed ef hh bi translated">谷歌云平台/云构建者</h2><div class="ly l"><h3 class="bd b fi z dy lw ea eb lx ed ef dx translated">gcr.io/cloud-builders/curl映像由云构建团队维护，但它可能不支持最新的…</h3></div><div class="lz l"><p class="bd b fp z dy lw ea eb lx ed ef dx translated">github.com</p></div></div><div class="ma l"><div class="mq l mc md me ma mf le lr"/></div></div></a></div><p id="1331" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这很容易做到</p><pre class="kv kw kx ky fd mg mh mi mj aw mk bi"><span id="5ba4" class="ml je hi mh b fi mm mn l mo mp">steps:<br/>  - name: "launcher.gcr.io/google/ubuntu1604"<br/>    entrypoint: "curl"<br/>    args:<br/>      ["-d", '"{\"id\":\"$BUILD_ID\"}"', "-X", "POST", "<a class="ae mr" href="http://www.example.com" rel="noopener ugc nofollow" target="_blank">http://www.example.com</a>"]</span></pre><p id="04b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">现在，下一步是使用CloudBuild运行一些Terraform脚本</strong></p><p id="178f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">想法是将你的<strong class="ih hj"> main.tf </strong>文件放在Google Cloud repo上，如下所示:</p><pre class="kv kw kx ky fd mg mh mi mj aw mk bi"><span id="bac0" class="ml je hi mh b fi mm mn l mo mp">resource "google_project" "project" {<br/>provider        = google-beta<br/>name            = var.PROJECT_NAME<br/>project_id      = var.PROJECT_ID<br/>folder_id       = var.FOLDER_ID<br/>billing_account = var.BILLING_ACCOUNT<br/>labels = var.LABELS<br/>}</span></pre><p id="b6ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要运行这段代码，您的YAML必须如下所示:</p><pre class="kv kw kx ky fd mg mh mi mj aw mk bi"><span id="a5e5" class="ml je hi mh b fi mm mn l mo mp">{<br/>    "steps": [<br/>        {<br/>            "name": "hashicorp/terraform",<br/>            "args": [<br/>                "init",<br/>                "-backend=true",<br/>                "-lock=false",<br/>                "-backend-config=prefix=" "project",<br/>            ],<br/>        },<br/>        {<br/>            "name": "hashicorp/terraform",<br/>            "args": [<br/>                "apply",<br/>                "-var=PROJECT_ID=xxx",<br/>                "-var=PROJECT_NAME=xxx",<br/>                "-var=FOLDER_ID=xxx",<br/>                "-var=BILLING_ACCOUNT=xxx",<br/>                "-auto-approve",<br/>                "-lock=false",<br/>            ],<br/>        },<br/>    ]<br/>}</span></pre><p id="4e9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我想从工具外部触发一个构建呢？</p><pre class="kv kw kx ky fd mg mh mi mj aw mk bi"><span id="ea9f" class="ml je hi mh b fi mm mn l mo mp">curl --request POST \<br/>  '<a class="ae mr" href="https://cloudbuild.googleapis.com/v1/projects/btdp-sbx-d-deslandes2/triggers/a809f71a-877f-4180-b0fd-a2e0bacd05a5:run?key=[YOUR_API_KEY]'" rel="noopener ugc nofollow" target="_blank">https://cloudbuild.googleapis.com/v1/projects/xxxx/triggers/a809f71a:run?key=[YOUR_API_KEY]'</a> \<br/>  --header 'Authorization: Bearer [YOUR_ACCESS_TOKEN]' \<br/>  --header 'Accept: application/json' \<br/>  --header 'Content-Type: application/json' \<br/>  --data '{}' \<br/>  --compressed</span></pre><p id="8a61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想从云构建步骤中触发构建，您只需这样做(令牌生成和curl必须在同一个命令中) :</p><pre class="kv kw kx ky fd mg mh mi mj aw mk bi"><span id="c59a" class="ml je hi mh b fi mm mn l mo mp">(* indentation have been modified because of the article)</span><span id="0a89" class="ml je hi mh b fi ms mn l mo mp">steps:<br/>- name: 'gcr.io/cloud-builders/gcloud'<br/>  entrypoint: 'bash'<br/>  args:<br/>  - '-c'<br/>  - |-<br/>    <!-- -->apt update &amp;&amp; apt install jq -y <br/>    TOKEN=$$(curl -H Metadata-Flavor: Google  http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token | <br/>    jq -r .access_token) <br/>    echo $${TOKEN} <br/>    curl --request <br/>    POST           '<a class="ae mr" href="https://cloudbuild.googleapis.com/v1/projects/btdp-sbx-d-deslandes2/triggers/a809f71a-877f-4180-b0fd-a2e0bacd05a5:run?key=[YOUR_API_KEY]'" rel="noopener ugc nofollow" target="_blank">https://cloudbuild.googleapis.com/v1/projects/xxxx/triggers/a809f71a:run</a>'<br/>  - '<!-- -->--header<!-- -->'<br/>  - '<!-- -->Authorization: Bearer ${TOKEN}<!-- -->'<br/>  - '<!-- -->--header<!-- -->'<br/>  - '<!-- -->Accept: application/json<!-- -->'<br/>  - '<!-- -->--header<!-- -->'<br/>  - '<!-- -->Content-Type: application/json<!-- -->'<br/>  - '<!-- -->--compressed<!-- -->'</span></pre><p id="4a5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将很快改变，查看文章的结论，了解调用CloudBuild很快会有什么可能。</p><p id="0f69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我可以使用CloudBuild调用几乎所有的东西…好消息是，Cloud Build是GCP上的无服务器产品，提供了最大的超时:24小时！</p><p id="47bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这意味着您可能会将它用于超出其最初设计的用途…</p><p id="be78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个用法的例子，当我不得不在GCP项目中给某人添加多个角色时，我很累。当然我有可能使用gcloud add-iam-bindings，但是…每个角色一个命令！</p><p id="334e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么，为什么不在CloudBuild CI中生成并运行它呢？耶！</p><p id="ce89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们要添加的权限列表是</p><pre class="kv kw kx ky fd mg mh mi mj aw mk bi"><span id="0559" class="ml je hi mh b fi mm mn l mo mp">permissions = [<br/>    "roles/servicemanagement.admin",<br/>    "roles/iap.admin",<br/>    "roles/iap.settingsAdmin",<br/>    "roles/iam.serviceAccountCreator",<br/>    "roles/compute.instanceAdmin.v1",<br/>    "roles/compute.loadBalancerAdmin",<br/>]</span></pre><p id="8341" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以在这个数组上循环，为每个角色生成一个YAML文件</p><pre class="kv kw kx ky fd mg mh mi mj aw mk bi"><span id="7d03" class="ml je hi mh b fi mm mn l mo mp">for role in permissions:</span><span id="5a20" class="ml je hi mh b fi ms mn l mo mp">    data["steps"].append(<br/>        [<br/>            {<br/>                "name": "gcr.io/cloud-builders/gcloud",<br/>                "entrypoint": "bash",<br/>                "args": [<br/>                    "-c",<br/>                    'gcloud projects add-iam-policy-binding projectA - member="<a class="ae mr" href="mailto:my_user@domain.com" rel="noopener ugc nofollow" target="_blank">my_user@domain.com</a>" -role='+role,<br/>                ],<br/>            }<br/>        ]<br/>    )</span></pre><p id="99fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">结论</strong></p><p id="54cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">今天，构建可以通过提交回购来触发，最近也可以手动启动，明天我希望可以通过Pub/Sub来触发，这是GCP在平台上部署的所有架构中使用的最重要的服务…保持简单，享受乐趣！</p></div></div>    
</body>
</html>