<html>
<head>
<title>Serve Keras models using Google Cloud Machine Learning services</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用谷歌云机器学习服务服务Keras模型</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/serve-keras-models-using-google-cloud-machine-learning-services-910912238bf6?source=collection_archive---------3-----------------------#2018-01-02">https://medium.com/google-cloud/serve-keras-models-using-google-cloud-machine-learning-services-910912238bf6?source=collection_archive---------3-----------------------#2018-01-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8c06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud ML使您能够在云中训练您的模型并提供在线/批量预测。我已经找到了许多教程和代码示例，但没有一个是完整的。</p><p id="73a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你只是在云中训练你的模型，只要你按照Google 提供的<a class="ae jd" href="https://cloud.google.com/ml-engine/docs/getting-started-training-prediction" rel="noopener ugc nofollow" target="_blank">操作指南中的步骤去做，你在那个阶段应该不会有任何问题。我强烈建议您看一看</a><a class="ae jd" href="https://github.com/GoogleCloudPlatform/cloudml-samples/tree/master/census/keras" rel="noopener ugc nofollow" target="_blank">“使用Keras使用人口普查收入数据集预测收入”</a>示例，并关注如何使用TensorBoard实现可视化培训结果。</p><p id="13eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Tensorflow是使用<a class="ae jd" href="https://github.com/tensorflow/serving" rel="noopener ugc nofollow" target="_blank"> Tensorflow Serving </a>库在Google Cloud ML上提供预测的主要框架。除了可用的Google <a class="ae jd" href="https://cloud.google.com/ml-engine/docs/deploying-models" rel="noopener ugc nofollow" target="_blank">操作指南</a>，以下是我鼓励你在部署第一个模型时使用的重要资源:</p><ol class=""><li id="5200" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">查看本教程:<a class="ae jd" href="https://blog.keras.io/keras-as-a-simplified-interface-to-tensorflow-tutorial.html" rel="noopener ugc nofollow" target="_blank"> Keras作为TensorFlow的简化接口</a>描述Keras层与Tensorflow tensors的兼容性。特别注意<strong class="ih hj">第4节</strong>:导出一个带TensorFlow-serving的模型。</li><li id="2c2b" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">仔细阅读Census Keras示例代码。这是一个很好的参考，并提供了一个端到端的例子(训练到预测)，但调用set_learning_phase <strong class="ih hj">很重要，否则预测将失败</strong>，并显示StatusCode。INVALID_ARGUMENT错误(<a class="ae jd" href="https://github.com/GoogleCloudPlatform/cloudml-samples/pull/141" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">刚刚用此修复</strong> </a>创建了一个pull请求)。</li></ol><p id="57f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是您在开发任务时必须注意的主要构建模块:</p><ol class=""><li id="8115" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">编译一个Keras模型(见上面set_learning_phase)。</li><li id="a97c" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">可以使用tensorflow.python.lib.io将文件写入GCS，但是您必须使用GCS python客户端库才能与GCS存储桶进行交互。</li><li id="91b5" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">使用TensorBoard回调来可视化您的训练过程。</li><li id="ea0b" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">训练Keras模型。</li><li id="25be" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">将Keras模型导出到一个<a class="ae jd" href="https://www.tensorflow.org/programmers_guide/saved_model" rel="noopener ugc nofollow" target="_blank">tensor flow Serving saved model</a>。</li><li id="a30f" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">创建一个模型实例，例如:<em class="js">g cloud ml-engine models create model name—regions us-central 1</em></li><li id="7cf2" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">基于您导出的模型实例创建模型版本($MODEL_BINARIES是您的GS://exported MODEL location):<em class="js">g cloud ml-engine versions create v1—MODEL MODEL name—origin $ MODEL _ BINARIES—runtime-version 1.4</em></li><li id="15b6" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">通过运行在线预测来测试您的模型:<em class="js">g cloud ml-engine predict-model model name-JSON-instances model/request . JSON-version v1</em></li></ol><ul class=""><li id="b549" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jt jk jl jm bi translated">确保您的request.json结构与您提供给SavedModel builder的签名一致。</li><li id="7581" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jt jk jl jm bi translated">如有错误，请仔细阅读。通常，该错误具有很强的描述性，例如以下关于所提供的输入形状的内容:</li></ul><p id="cc28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">{</p><p id="a0df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">" error ":"预测失败:模型执行期间出错:AbortionError(code=StatusCode。INVALID_ARGUMENT，details=\ "输入必须是四维的[1，1，1，150，150，3]\ n \ T[[Node:Conv2D _ 1/convolution = Conv2D[T = DT _ FLOAT，_output_shapes=[？，148，148，32]]，data_format=\"NHWC\ "，padding=\ "有效\ "，strides=[1，1，1，1]，use_cudnn_on_gpu=true，_ device = \ "/job:localhost/replica:0/task:0/device:CPU:0 \ "](_ arg _ conv2d _ 1 _ input _ 0 _ 0，conv2d_1/kernel/read)])"</p><p id="5115" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">}</p><p id="e402" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者这个(与set_learning_phase相关):</p><p id="f7b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">NetworkError(code=StatusCode。INVALID_ARGUMENT，details= "您必须为dtype uint 8<br/>的占位符张量' keras_learning_phase '提供一个值[[Node:keras _ learning _ phase = Placeholder[dtype = DT _ uint 8，shape=[]，_ device = "/job:localhost/replica:0/task:0/CPU:0 "]()]]")</p><p id="e019" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">祝你好运！</p></div></div>    
</body>
</html>