<html>
<head>
<title>Data plumbing — Is my data pipeline processing events?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据管道—我的数据管道在处理事件吗？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/data-plumbing-is-my-data-pipeline-processing-events-a2b651573c2?source=collection_archive---------0-----------------------#2019-05-13">https://medium.com/google-cloud/data-plumbing-is-my-data-pipeline-processing-events-a2b651573c2?source=collection_archive---------0-----------------------#2019-05-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="369c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个例子展示了如何在GCP用谷歌云完全管理的企业级cron作业调度器来实现一个探测，以<a class="ae jd" href="https://twitter.com/polleyg/status/1125651245035712512" rel="noopener ugc nofollow" target="_blank">检查一个端到端管道是否工作</a>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/4952c13cc7df1673ecb33275d2b6a22b.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/0*u1u2PVkWobqTWmtX.png"/></div></figure><p id="c7d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">想象一下，您正在构建一个令人惊叹但复杂的多步骤管道来实现您的<a class="ae jd" href="https://cloud.google.com/solutions/big-data/stream-analytics/" rel="noopener ugc nofollow" target="_blank">流分析</a>用例，涉及许多GCP <a class="ae jd" href="https://cloud.google.com/pubsub/" rel="noopener ugc nofollow" target="_blank">发布订阅</a>主题和<a class="ae jd" href="https://cloud.google.com/dataflow/" rel="noopener ugc nofollow" target="_blank">数据流</a>流作业来处理事件，此外，管道可能会与其他服务交互以丰富事件并写入外部接收器。</p><p id="5c93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您现在即将上线，并开始打开“水龙头”，让事件在管道中流动。当涉及到监控您的管道时，您可以使用强大的指标来单独监控您的<a class="ae jd" href="https://cloud.google.com/pubsub/docs/monitoring" rel="noopener ugc nofollow" target="_blank"> Pubsub主题</a>或您的<a class="ae jd" href="https://cloud.google.com/dataflow/docs/guides/using-stackdriver-monitoring" rel="noopener ugc nofollow" target="_blank">数据流作业</a>，但是当您想要以整体的方式端到端地检查管道的状态时，会发生什么呢？</p><ul class=""><li id="22be" class="jm jn hi ih b ii ij im in iq jo iu jp iy jq jc jr js jt ju bi translated">我可以不仅仅监视第一个主题和最后一个数据流作业，并相应地生成警报吗？可以，但我们仍需要验证缺少事件是因为数据源没有发送事件，还是因为接受新事件时出现问题，最后一个流式作业也可能没有接收到任何内容，因为卡在两个主题之间的中间作业中，同时用一些元数据丰富事件。更糟糕的是，您将无法提前识别错误，直到您收到新的事件，这些事件将引发错误，但为时已晚！</li><li id="5534" class="jm jn hi ih b ii jv im jw iq jx iu jy iy jz jc jr js jt ju bi translated">我可以使用某种探测/健康检查注入一些虚拟事件吗？你当然可以！您希望通过管道端到端地处理有效事件，然后可以将这些事件插入到管道末端的接收器中，以便定期清除。如果探测器未能注入事件或者死信接收器中没有接收到任何内容，则会生成警报。</li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ka"><img src="../Images/d34f653164efba215afbc79281722ca4.png" data-original-src="https://miro.medium.com/v2/resize:fit:662/format:webp/0*NqfB6j87x9q3zlBk.png"/></div></figure><p id="16df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们使用下面的GCP <strong class="ih hj">无服务器</strong>服务来演示如何使用云调度程序实现探测:</p><ul class=""><li id="3e94" class="jm jn hi ih b ii ij im in iq jo iu jp iy jq jc jr js jt ju bi translated">Cloud Scheduler作为探针来生成在我们的Pubsub主题中注入的事件</li><li id="cef0" class="jm jn hi ih b ii jv im jw iq jx iu jy iy jz jc jr js jt ju bi translated">GCP <a class="ae jd" href="https://cloud.google.com/pubsub/" rel="noopener ugc nofollow" target="_blank"> Pubsub </a>话题为短信服务</li><li id="a42f" class="jm jn hi ih b ii jv im jw iq jx iu jy iy jz jc jr js jt ju bi translated">GCP <a class="ae jd" href="https://cloud.google.com/dataflow/" rel="noopener ugc nofollow" target="_blank">数据流</a>模板来处理我们的事件并将结果发送给大查询</li><li id="1acb" class="jm jn hi ih b ii jv im jw iq jx iu jy iy jz jc jr js jt ju bi translated"><a class="ae jd" href="https://cloud.google.com/bigquery/" rel="noopener ugc nofollow" target="_blank"> GCP BigQuery </a>，谷歌快速、高度可扩展、经济高效、完全托管的云数据仓库，用于分析，作为汇</li></ul><h2 id="5a96" class="kb kc hi bd kd ke kf kg kh ki kj kk kl iq km kn ko iu kp kq kr iy ks kt ku kv bi translated">例子</h2><p id="62f1" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">我们将用一个简单的例子来演示这个概念，使用来自你的GCP项目的<a class="ae jd" href="https://cloud.google.com/shell/" rel="noopener ugc nofollow" target="_blank">云外壳</a>(也可以通过GCP UI控制台来完成)中的<code class="du lb lc ld le b">gcloud commands</code>，并利用<a class="ae jd" href="https://github.com/GoogleCloudPlatform/DataflowTemplates" rel="noopener ugc nofollow" target="_blank">数据流模板</a>来简化。</p><p id="8b68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将注入下面简单的JSON消息:</p><pre class="jf jg jh ji fd lf le lg lh aw li bi"><span id="7cfe" class="kb kc hi le b fi lj lk l ll lm">{“id”:”test”,”data”:”Testing probe”}</span></pre><p id="1a5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">0.在开始之前，确保您拥有正确的权限，并且在项目中为所需的组件(Pubsub、BigQuery、GCS和Dataflow)启用了API</p><ol class=""><li id="7d05" class="jm jn hi ih b ii ij im in iq jo iu jp iy jq jc ln js jt ju bi translated">让我们创建我们的Pubsub主题:</li></ol><pre class="jf jg jh ji fd lf le lg lh aw li bi"><span id="7fb5" class="kb kc hi le b fi lj lk l ll lm">gcloud pubsub topics create <strong class="le hj">[TOPIC_NAME]</strong></span></pre><p id="4b75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.我们继续使用BigQuery，创建输出表，实际上这可以是我们监控的主题或任何其他可用的接收器。我们使用BigQuery来方便地查询结果，在这种情况下，我们需要创建一个表，其模式与我们将从探针注入的消息兼容。使用<a class="ae jd" href="https://cloud.google.com/bigquery/docs/bq-command-line-tool" rel="noopener ugc nofollow" target="_blank"> <em class="lo"> bq </em> </a>命令行工具:</p><pre class="jf jg jh ji fd lf le lg lh aw li bi"><span id="7ce5" class="kb kc hi le b fi lj lk l ll lm">bq --location=<strong class="le hj">[LOCATION]</strong> mk --dataset <strong class="le hj">[PROJECT_ID]</strong>:<strong class="le hj">[DATASET]</strong><br/>bq mk --table <strong class="le hj">[PROJECT_ID]</strong>:<strong class="le hj">[DATASET]</strong>.<strong class="le hj">[TABLE]</strong> id:STRING,data:STRING</span></pre><p id="457c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.我们现在可以提交一个<a class="ae jd" href="https://cloud.google.com/dataflow/docs/guides/templates/overview" rel="noopener ugc nofollow" target="_blank">数据流模板</a>来从我们的主题中提取消息，并将它们插入到BigQuery中。对于这个例子，我们将使用一个简单的流作业<a class="ae jd" href="https://cloud.google.com/dataflow/docs/guides/templates/provided-templates#cloud-pubsub-to-bigquery" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">PubSubtoBigQuery</strong></a>，它可以用作基线并相应地扩展。这个模板接收JSON消息，执行UDF来转换消息，并将它们插入BigQuery中，所有这些都没有编写任何Java或Python代码，而是使用了我们自己的参数，太棒了！</p><pre class="jf jg jh ji fd lf le lg lh aw li bi"><span id="e1a6" class="kb kc hi le b fi lj lk l ll lm">gcloud dataflow jobs run <strong class="le hj">[JOB_NAME]</strong> \<br/>    --gcs-location gs://dataflow-templates/latest/PubSub_to_BigQuery \<br/>    --parameters \<br/>inputTopic=projects/<strong class="le hj">[PROJECT_ID]</strong>/topics/<strong class="le hj">[TOPIC]</strong>,\<br/>outputTableSpec=<strong class="le hj">[PROJECT_ID]</strong>:<strong class="le hj">[DATASET]</strong>.<strong class="le hj">[TABLE_NAME]</strong></span></pre><p id="6ada" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.最后，我们需要用GCP调度程序创建我们的探针，很简单！</p><pre class="jf jg jh ji fd lf le lg lh aw li bi"><span id="8fd3" class="kb kc hi le b fi lj lk l ll lm">gcloud beta scheduler jobs create pubsub <strong class="le hj">[JOB] </strong>--schedule<!-- -->="*<!-- --> * * * *"<!-- --> <!-- -->--topic<!-- -->=<strong class="le hj">[</strong><strong class="le hj">TOPIC]</strong> --<!-- -->message-body='{“id”:”test”,”data”:”Testing probe”}'</span></pre><p id="4783" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用<a class="ae jd" href="https://en.wikipedia.org/wiki/Cron#Overview" rel="noopener ugc nofollow" target="_blank"> cron格式</a>来调度我们的探测，在我们的例子中是按分钟调度的，但是我们可以很容易地用<code class="du lb lc ld le b">"0 * * * *"</code>把它改成类似每小时。</p><p id="96f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然我们已经安排了探测，我们可以验证我们确实每分钟都在接收来自探测器的消息。下面的查询应该返回探测器在管道中注入的每条消息的行。</p><pre class="jf jg jh ji fd lf le lg lh aw li bi"><span id="c506" class="kb kc hi le b fi lj lk l ll lm">bq query --use_legacy_sql=false 'SELECT * FROM `<strong class="le hj">[DATASET]</strong>.<strong class="le hj">[TABLE_NAME]</strong>` LIMIT 1000'</span></pre><h2 id="927e" class="kb kc hi bd kd ke kf kg kh ki kj kk kl iq km kn ko iu kp kq kr iy ks kt ku kv bi translated">结论</h2><p id="098a" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">这个使用无服务器服务的简单示例展示了如何实现一个探针来将消息注入到我们的管道中，以验证是否完全正常工作。希望这可以让人们了解如何为他们自己的特定管道实现探测，但是请记住，像注入带有更新时间戳的消息这样的复杂用例并不被直接支持，因为云调度器目前不支持动态消息。</p></div></div>    
</body>
</html>