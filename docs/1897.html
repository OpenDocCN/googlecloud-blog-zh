<html>
<head>
<title>Get notified when an expensive BigQuery job executes using Eventarc and SendGrid</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Eventarc和SendGrid在昂贵的BigQuery作业执行时得到通知</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/get-notified-when-an-expensive-bigquery-job-executes-using-eventarc-and-sendgrid-4591053109ca?source=collection_archive---------2-----------------------#2021-06-08">https://medium.com/google-cloud/get-notified-when-an-expensive-bigquery-job-executes-using-eventarc-and-sendgrid-4591053109ca?source=collection_archive---------2-----------------------#2021-06-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="4d16" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">Eventarc支持的事件</h1><p id="0d12" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">上周，我在我们的<a class="ae kb" href="https://github.com/GoogleCloudPlatform/eventarc-samples" rel="noopener ugc nofollow" target="_blank"> eventarc-samples </a> repo中整理了一份由Eventarc支持的<a class="ae kb" href="https://github.com/GoogleCloudPlatform/eventarc-samples/tree/main/eventarc-events" rel="noopener ugc nofollow" target="_blank">事件列表。感谢我们的文档团队，这个列表现在是我们官方文档的一部分，在</a><a class="ae kb" href="https://cloud.google.com/eventarc/docs/reference/supported-events" rel="noopener ugc nofollow" target="_blank">参考部分</a>。</p><p id="79f2" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">在查看完整列表后，我开始思考这些事件支持的一些用例。今天我想谈谈其中的一个用例:<strong class="jf hj">当一个昂贵的BigQuery作业执行时，如何得到通知？</strong></p><h1 id="e944" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">确定已完成且昂贵的BigQuery作业</h1><p id="f364" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">要回答的第一个问题是:如何确定已完成且昂贵的BigQuery作业？幸运的是，BigQuery的审计日志拥有所有的信息。请注意，在BigQuery中，审计日志是默认启用的，因此您不必做任何特殊的事情来启用它们。</p><p id="f735" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">要查看已完成的BigQuery作业，您可以查看在<code class="du kh ki kj kk b">bigquery.googleapis.com</code>的<code class="du kh ki kj kk b">serviceName</code>和<code class="du kh ki kj kk b">jobservice.jobcompleted</code>的<code class="du kh ki kj kk b">methodName</code>下记录的审计日志:</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kl"><img src="../Images/ff5e401b4deb9a702d25c060d610a299.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sHTLvQ9ALoR5PtG1.png"/></div></div></figure><p id="56bf" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">要获得更多的作业细节，您可以在<code class="du kh ki kj kk b">jobsCompletedEvent</code>下检查，在那里您可以访问执行了什么查询，更重要的是在<code class="du kh ki kj kk b">totalBilledBytes</code>下它花费了多少:</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kx"><img src="../Images/1f4fc435fd2598adde83c9f5ef004a97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bNhrZ7BHK2pIOVP7.png"/></div></div></figure><p id="2878" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><code class="du kh ki kj kk b">totalBilledBytes</code>让您知道这个查询有多昂贵。例如，如果查询被缓存，这将是零，没有成本，但对于昂贵的查询，它将是千兆字节或更多。在本例中，我们假设1GB或更大的查询开销很大。</p><h1 id="77b5" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">体系结构</h1><p id="f766" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">该架构非常简单:</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es ky"><img src="../Images/d471884ea807ea194a8fa6446f9c6e07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QNE5CDr-VxR2Lg4w.png"/></div></div></figure><ol class=""><li id="1a85" class="kz la hi jf b jg kc jk kd jo lb js lc jw ld ka le lf lg lh bi translated">一个BigQuery用户运行一些BigQuery作业。这会生成一些审计日志。</li><li id="4dcc" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">Eventarc触发器为<code class="du kh ki kj kk b">bigquery.googleapis.com</code>的<code class="du kh ki kj kk b">serviceName</code>和<code class="du kh ki kj kk b">jobservice.jobcompleted</code>的<code class="du kh ki kj kk b">methodName</code>过滤这些审计日志，并转发给云运行服务。</li><li id="0700" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">云运行服务接收<code class="du kh ki kj kk b">jobcompleted</code>事件，记录它并检查<code class="du kh ki kj kk b">totalBilledBytes</code>是否大于1GB。如果是，它使用SendGrid向BigQuery管理员发送一封电子邮件。</li></ol><h1 id="c545" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">开始之前</h1><p id="1a2d" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在部署服务和触发器之前，请完成一些设置步骤。</p><h2 id="332a" class="ln ig hi bd ih lo lp lq il lr ls lt ip jo lu lv it js lw lx ix jw ly lz jb ma bi translated">默认计算服务帐户</h2><p id="2fdc" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">默认计算服务帐户将在Eventarc的审核日志触发器中使用。将<code class="du kh ki kj kk b">eventarc.eventReceiver</code>角色授予默认计算服务帐户:</p><pre class="km kn ko kp fd mb kk mc md aw me bi"><span id="1684" class="ln ig hi kk b fi mf mg l mh mi">export PROJECT_NUMBER="$(gcloud projects describe $(gcloud config get-value project) --format='value(projectNumber)')"</span><span id="ba5f" class="ln ig hi kk b fi mj mg l mh mi">gcloud projects add-iam-policy-binding $(gcloud config get-value project) \<br/>    --member=serviceAccount:${<a class="ae kb" href="mailto:PROJECT_NUMBER}-compute@developer.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">PROJECT_NUMBER}-compute@developer.gserviceaccount.com</a> \<br/>    --role='roles/eventarc.eventReceiver'</span></pre><h2 id="b25a" class="ln ig hi bd ih lo lp lq il lr ls lt ip jo lu lv it js lw lx ix jw ly lz jb ma bi translated">区域、位置、平台</h2><p id="199c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">为云运行和Eventarc设置区域、位置和平台:</p><pre class="km kn ko kp fd mb kk mc md aw me bi"><span id="0de7" class="ln ig hi kk b fi mf mg l mh mi">export REGION=us-central1<br/>export GOOGLE_CLOUD_PROJECT=$(gcloud config get-value project)</span><span id="9f5c" class="ln ig hi kk b fi mj mg l mh mi">gcloud config set run/platform managed<br/>gcloud config set run/region ${REGION}<br/>gcloud config set eventarc/location ${REGION}</span></pre><h1 id="85d2" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">通知人</h1><p id="7c19" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">该服务将接收BigQuery <code class="du kh ki kj kk b">jobcompleted</code>事件，记录接收到的事件，如果<code class="du kh ki kj kk b">totalBilledBytes</code>超过1GB，它将使用SendGrid发送一封关于昂贵查询的电子邮件。</p><p id="d4fb" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">您需要设置一个SendGrid帐户并创建一个API密钥。你可以跟随SendGrid的API Keys <a class="ae kb" href="https://app.sendgrid.com/settings/api_keys" rel="noopener ugc nofollow" target="_blank"> doc </a>来获得更多关于如何设置SendGrid的细节。</p><p id="c959" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">服务的代码在<a class="ae kb" href="https://github.com/GoogleCloudPlatform/eventarc-samples/blob/main/bigquery-jobs-notifier/app.py" rel="noopener ugc nofollow" target="_blank"> app.py </a>中。您可以看看如何解析接收到的CloudEvent，如何解析包含相关信息的审计日志，以及最后如何为昂贵的查询发送电子邮件。</p><p id="cde9" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">构建并推送容器映像:</p><pre class="km kn ko kp fd mb kk mc md aw me bi"><span id="540b" class="ln ig hi kk b fi mf mg l mh mi">export SERVICE_NAME=bigquery-usage-notifier<br/>export GOOGLE_CLOUD_PROJECT=$(gcloud config get-value project)<br/>gcloud builds submit --tag gcr.io/${GOOGLE_CLOUD_PROJECT}/${SERVICE_NAME}</span></pre><p id="0b3c" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">部署服务，同时将<code class="du kh ki kj kk b">TO_EMAILS</code>传入您想要发送通知的电子邮件地址，并将<code class="du kh ki kj kk b">SENDGRID_API_KEY</code>与send SendGrid API密匙一起传入。</p><pre class="km kn ko kp fd mb kk mc md aw me bi"><span id="d9cc" class="ln ig hi kk b fi mf mg l mh mi">export <a class="ae kb" href="mailto:TO_EMAILS=youremail@gmail.com" rel="noopener ugc nofollow" target="_blank">TO_EMAILS=youremail@gmail.com</a><br/>export SENDGRID_API_KEY=yoursendgridapikey</span><span id="58f0" class="ln ig hi kk b fi mj mg l mh mi">gcloud run deploy ${SERVICE_NAME} \<br/>  --image gcr.io/${GOOGLE_CLOUD_PROJECT}/${SERVICE_NAME} \<br/>  --allow-unauthenticated \<br/>  --update-env-vars TO_EMAILS=${TO_EMAILS},SENDGRID_API_KEY=${SENDGRID_API_KEY}</span></pre><h1 id="5df8" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">引发</h1><p id="32a4" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">部署服务后，创建一个触发器来过滤正确的BigQuery事件:</p><pre class="km kn ko kp fd mb kk mc md aw me bi"><span id="832f" class="ln ig hi kk b fi mf mg l mh mi">gcloud eventarc triggers create ${SERVICE_NAME}-trigger \<br/>  --destination-run-service=${SERVICE_NAME} \<br/>  --destination-run-region=${REGION} \<br/>  --event-filters="type=google.cloud.audit.log.v1.written" \<br/>  --event-filters="serviceName=bigquery.googleapis.com" \<br/>  --event-filters="methodName=jobservice.jobcompleted" \<br/>  --<a class="ae kb" href="mailto:service-account=${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">service-account=${PROJECT_NUMBER}-compute@developer.gserviceaccount.com</a></span></pre><p id="1b63" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">测试前，确保触发器已准备好:</p><pre class="km kn ko kp fd mb kk mc md aw me bi"><span id="9cae" class="ln ig hi kk b fi mf mg l mh mi">gcloud eventarc triggers list</span><span id="3d1b" class="ln ig hi kk b fi mj mg l mh mi">NAME                                ACTIVE<br/>bigquery-usage-notifier-trigger      Yes</span></pre><h1 id="923e" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">试验</h1><p id="d91c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">要进行测试，您需要运行一个产生1GB或更多计费字节的BigQuery作业。下面是一个使用<code class="du kh ki kj kk b">bq</code> CLI运行的示例查询:</p><pre class="km kn ko kp fd mb kk mc md aw me bi"><span id="d941" class="ln ig hi kk b fi mf mg l mh mi">bq query \<br/>  --nouse_legacy_sql \<br/>  --nouse_cache \<br/>  'SELECT * FROM `bigquery-samples`.reddit.full'</span></pre><p id="3c34" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">查询完成后，您应该会看到云运行服务记录了查询，并且您还应该会收到一封类似这样的电子邮件:</p><pre class="km kn ko kp fd mb kk mc md aw me bi"><span id="a6df" class="ln ig hi kk b fi mf mg l mh mi">The following BigQuery job completed<br/><br/>principalEmail: atameldev@gmail.com<br/>jobId: bqjob_r3293aa18ce3b8bed_00000179e689b8b9_1<br/>createTime: 2021-06-07T12:54:16.783Z<br/>query: SELECT * FROM `bigquery-samples`.reddit.full<br/>totalBilledBytes: 1450180608.0, above 1GB? True</span></pre></div><div class="ab cl mk ml gp mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hb hc hd he hf"><p id="79e2" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">如果您想尝试一下，所有代码都在我们的<a class="ae kb" href="https://github.com/GoogleCloudPlatform/eventarc-samples/tree/main/bigquery-jobs-notifier" rel="noopener ugc nofollow" target="_blank"> eventarc-samples </a> repo中。如有任何问题/反馈，请随时通过Twitter <a class="ae kb" href="https://twitter.com/meteatamel" rel="noopener ugc nofollow" target="_blank"> @meteatamel </a>联系我。</p></div><div class="ab cl mk ml gp mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hb hc hd he hf"><p id="a4f9" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mr">原发布于</em><a class="ae kb" href="https://atamel.dev/posts/2021/06-08_bigquery-jobs-notifier/" rel="noopener ugc nofollow" target="_blank"><em class="mr">https://atamel . dev</em></a><em class="mr">。</em></p></div></div>    
</body>
</html>