<html>
<head>
<title>Automating Infrastructure with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform实现基础设施自动化</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/automating-infrastructure-with-terraform-c0d27a9df338?source=collection_archive---------0-----------------------#2022-11-25">https://medium.com/google-cloud/automating-infrastructure-with-terraform-c0d27a9df338?source=collection_archive---------0-----------------------#2022-11-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9033" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章进一步详细介绍了在Google Cloud上使用Terraform作为代码来管理基础设施。与通过用户界面手动配置资源不同，基础结构作为代码涉及控制一个或多个文件中的基础结构。Terraform是HashiCorp提供的基础设施代码。它是一个安全、一致地开发、改变和管理基础设施的工具。</p><p id="80bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">先决条件:熟悉谷歌云控制台，虚拟机，网络配置。</p><p id="61fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文结束时，您将能够:</p><ul class=""><li id="1da7" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">使用Terraform建立、变更和摧毁基础设施</li><li id="8543" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">使用Terraform创建资源依赖关系</li><li id="2243" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">使用Terraform调配基础架构</li></ul><p id="0940" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1。建筑基础设施</strong></p><p id="1910" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Terraform预装在云壳中。通过在云壳中运行<em class="jr"> terraform </em>来验证Terraform是否可用。</p><blockquote class="js jt ju"><p id="3ef1" class="if ig jr ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">用这段代码创建main.tf文件(替换<peroject id="" with="" your="" project="">)。这是描述运行所需组件的配置文件。</peroject></p></blockquote><pre class="jy jz ka kb fd kc kd ke bn kf kg bi"><span id="eae6" class="kh ki hi kd b be kj kk l kl km">terraform {<br/>  required_providers {<br/>    google = {<br/>      source = "hashicorp/google"<br/>    }<br/>  }<br/>}<br/>provider "google" {<br/>  version = "3.5.0"<br/>  project = "&lt;PROJECT_ID&gt;"<br/>  region  = "us-central1"<br/>  zone    = "us-central1-c"<br/>}<br/>resource "google_compute_network" "vpc_network" {<br/>  name = "terraform-network"<br/>}<br/>resource "google_compute_instance" "vm_instance" {<br/>  name         = "terraform-instance"<br/>  machine_type = "f1-micro"<br/>  boot_disk {<br/>    initialize_params {<br/>      image = "debian-cloud/debian-11"<br/>    }<br/>  }<br/>  network_interface {<br/>    network = google_compute_network.vpc_network.name<br/>    access_config {<br/>    }<br/>  }<br/>}</span></pre><p id="29da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">terraform {}块是必需的，因此terraform知道从<a class="ae kn" href="https://registry.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform注册表</a>下载哪个提供者。资源块在打开块之前有两个字符串:资源类型(Google _ compute _ network<strong class="ih hj">)</strong>和资源名称( vpc_network <strong class="ih hj"> ) </strong>。</p><blockquote class="js jt ju"><p id="c6ad" class="if ig jr ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated"><em class="hi">运行命令</em> terraform init <em class="hi">安装提供者二进制文件并初始化新的terraform配置。</em></p><p id="0686" class="if ig jr ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated"><em class="hi">运行命令</em> terraform apply，立即应用您的配置。</p></blockquote><p id="0e9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输出在资源“Google _ compute _ network”“VPC _ network”旁边有一个+,意味着terraform将创建这个资源。</p><p id="c91a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果计划创建成功，terraform将暂停并等待批准，然后继续。如果terraform应用因错误而失败，请阅读错误消息并修复出现的错误。</p><p id="676b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仅此而已，terraform全部搞定！您可以转到云控制台，看到虚拟机实例已创建，网络已调配。要么，在云壳中运行<em class="jr"> terraform show </em>命令来检查当前状态。</p><p id="ada1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2。改变和破坏基础设施</strong></p><p id="b2a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过将资源添加到terraform配置中并运行terraform apply来供应资源，从而创建新资源。</p><p id="3d33" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">向“vm_instance”添加一个tags参数，如下所示:</p><pre class="jy jz ka kb fd kc kd ke bn kf kg bi"><span id="78b3" class="kh ki hi kd b be kj kk l kl km">resource "google_compute_instance" "vm_instance" {<br/>  name         = "terraform-instance"<br/>  machine_type = "f1-micro"<br/>  tags         = ["web", "dev"]<br/>  # ...<br/>}</span></pre><p id="7a8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要更新实例，再次运行<em class="jr"> terraform apply </em>。如果前缀存在，资源将被就地更新。您可以继续并接受修改。</p><p id="decf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">破坏性更改是指提供者必须替换当前资源，而不是简单地更新它。通常，这是因为云提供商不支持根据您的设置升级资源。如果前缀-/+存在，资源将被销毁并重新创建，而不是就地更新。</p><p id="13fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在生产环境中，基础设施破坏很少发生。但是，如果您使用terraform来加速各种环境，如开发、测试和登台，销毁通常是一个有用的操作。类似于<em class="jr"> terraform apply </em>的<em class="jr"> terraform destroy </em>命令可用于销毁资源，但其操作方式如同所有资源都已从配置中移除。使用前缀-时，网络和实例将被终止。在这里，它创建了一个依赖图来标识删除资源的顺序。</p><p id="b644" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3。创建资源依赖关系</strong></p><p id="2775" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现实世界中的基础设施使用各种资源。terraform配置中可以包含多种资源、不同的资源种类，甚至不同的提供者。</p><p id="5a42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我们将看到如何配置多个资源以及如何使用资源属性来配置其他资源的基本示例。</p><p id="0689" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将此块添加到您的配置文件中，以便为main.tf中的VM实例分配一个静态IP:</p><pre class="jy jz ka kb fd kc kd ke bn kf kg bi"><span id="19fd" class="kh ki hi kd b be kj kk l kl km">resource "google_compute_address" "vm_static_ip" {<br/>  name = "terraform-static-ip"<br/>}<br/>  network_interface {<br/>    network = google_compute_network.vpc_network.self_link<br/>    access_config {<br/>      nat_ip = google_compute_address.vm_static_ip.address<br/>    }<br/>  }</span></pre><p id="3111" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当Terraform读取此配置时，它将:</p><ul class=""><li id="176b" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">确保在虚拟机实例之前创建虚拟机静态ip</li><li id="5319" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">在状态中保存vm_static_ip的属性</li><li id="13d7" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">将nat_ip设置为vm_static_ip.address属性的值</li></ul><blockquote class="js jt ju"><p id="989e" class="if ig jr ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated"><em class="hi">再次运行terraform计划，并使用</em> terraform计划输出static_ip <em class="hi">保存该配置。</em></p></blockquote><p id="e444" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以这种方式保存计划可以确保您将来可以应用完全相同的计划。在上面的例子中，对google_compute_address . vm_static_ip . address的引用创建了对名为VM _ static _ IP的Google _ compute _ address的隐式依赖。</p><p id="ddb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过插值表达式的隐式依赖是通知Terraform这些关系的主要方式，应尽可能使用。有时资源之间的依赖关系对terraform来说是不可见的。<em class="jr"> depends_on </em>参数可以添加到任何资源中，并接受一个资源列表来为其创建显式依赖关系。</p><p id="ed60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 4。供应基础设施</strong></p><p id="eaae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌云允许客户管理他们自己的<a class="ae kn" href="https://cloud.google.com/compute/docs/images/create-delete-deprecate-private-images" rel="noopener ugc nofollow" target="_blank">定制操作系统映像</a>。这是一个很好的方法，可以确保您使用Terraform提供的实例是根据您的需求预先配置的。<a class="ae kn" href="https://www.packer.io/" rel="noopener ugc nofollow" target="_blank"> Packer </a>是这方面的完美工具，包括一个用于谷歌云的<a class="ae kn" href="https://www.packer.io/docs/builders/googlecompute.html" rel="noopener ugc nofollow" target="_blank">构建器。</a></p><p id="8ce8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Terraform使用供应器来上传文件、运行shell脚本或安装和触发其他软件，如配置管理工具。</p><pre class="jy jz ka kb fd kc kd ke bn kf kg bi"><span id="a105" class="kh ki hi kd b be kj kk l kl km">resource "google_compute_instance" "vm_instance" {<br/>  name         = "terraform-instance"<br/>  machine_type = "f1-micro"<br/>  tags         = ["web", "dev"]<br/>  provisioner "local-exec" {<br/>    command = "echo ${google_compute_instance.vm_instance.name}:  ${google_compute_instance.vm_instance.network_interface[0].access_config[0].nat_ip} &gt;&gt; ip_address.txt"<br/>  }<br/>  # ...<br/>}</span></pre><p id="52d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里使用的<em class="jr"> local-exec </em> provisioner在运行terraform的机器上本地执行命令，而不是VM实例本身。</p><p id="c731" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Terraform对置备程序的处理不同于其他参数。置备程序仅在创建资源时运行，但添加置备程序不会强制销毁和重新创建该资源。使用<em class="jr">terraform tain</em>命令告诉terra form重新创建实例。被污染的资源将在下次应用时被销毁并重新创建。</p><p id="469e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">结论</strong></p><p id="1597" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">terraform的使用使得管理和更新基础设施的任务变得相当简单。更进一步，你可以使用谷歌云持续集成服务<a class="ae kn" href="https://cloud.google.com/build" rel="noopener ugc nofollow" target="_blank"> Cloud Build </a>，自动将terraform清单应用到你的环境中。</p></div></div>    
</body>
</html>