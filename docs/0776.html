<html>
<head>
<title>Continuous Delivery of HashiCorp Vault on Google Kubernetes Engine: Initial Setup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google Kubernetes引擎上连续交付HashiCorp Vault:初始设置</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/continuous-delivery-of-hashicorp-vault-on-google-kubernetes-engine-initial-setup-39bbe04d0bdd?source=collection_archive---------3-----------------------#2018-09-27">https://medium.com/google-cloud/continuous-delivery-of-hashicorp-vault-on-google-kubernetes-engine-initial-setup-39bbe04d0bdd?source=collection_archive---------3-----------------------#2018-09-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8274" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">这是一个系列的第4部分:</strong> <a class="ae jd" rel="noopener" href="/@blzysh/continuous-delivery-of-hashicorp-vault-on-google-kubernetes-engine-bcbf4e75f0f6"> <strong class="ih hj">指数</strong> </a></p><h1 id="6b69" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">概述:</h1><p id="9b67" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这是实际的“后端”工作和相关信息，用于支持Vault的持续交付。与Vault本身无关，只是一种设置层级和资源的方式，可以让您继续前进。</p><h1 id="bc15" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置资源层次结构:</h1><p id="57d9" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">创建一个Google <a class="ae jd" href="https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy" rel="noopener ugc nofollow" target="_blank">云平台资源层级</a>，看起来像这样:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/3b7366ce3774dfd3b531f1f9caa570f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*vzNGGc12XP0ZCrWMaNUBxA.png"/></div></figure><p id="2edf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不要忘记<a class="ae jd" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" rel="noopener ugc nofollow" target="_blank">项目</a>编号和项目ID在整个谷歌云平台中是唯一的。您选择的项目名称可以相同，但ID不会排成一行，ID用于所有内容。</p><p id="98bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本指南的其余部分，我将使用上面的层次结构，所以如果你正在跟随并决定做一些不同的事情，请注意你的变化并相应地调整。</p><p id="03eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Operations文件夹:</strong>用于将贡献运营代码和运营工具的开发者。</p><ul class=""><li id="6c6c" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc ku kv kw kx bi translated"><strong class="ih hj"> Sanbox文件夹:</strong>用于沙盒开发项目</li><li id="b4f3" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated"><strong class="ih hj"> ops-bcurtis-sb项目:</strong>用于<a class="ae jd" href="https://cloud.google.com/dns" rel="noopener ugc nofollow" target="_blank">Google Cloud DNS</a>&amp;<a class="ae jd" href="https://cloud.google.com/storage" rel="noopener ugc nofollow" target="_blank">Google云存储</a>启用个人沙盒开发所需的资源— <em class="ld">每个开发者使用自己的项目</em></li><li id="3278" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated"><strong class="ih hj">工具文件夹:</strong>用于包含操作工具资源的项目</li><li id="c09d" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated"><strong class="ih hj"> ops-tools-prod项目:</strong>用于<a class="ae jd" href="https://cloud.google.com/dns" rel="noopener ugc nofollow" target="_blank"> Google Cloud DNS </a>、<a class="ae jd" href="https://cloud.google.com/storage" rel="noopener ugc nofollow" target="_blank"> Google Cloud Storage </a>、<a class="ae jd" href="https://cloud.google.com/container-registry" rel="noopener ugc nofollow" target="_blank">Google Container Registry</a>&amp;<a class="ae jd" href="https://cloud.google.com/iam/docs/understanding-service-accounts" rel="noopener ugc nofollow" target="_blank">服务账号</a>资源用于生产</li></ul><p id="a735" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">共享基础结构文件夹:</strong>用于跨团队共享资源</p><ul class=""><li id="8e3e" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc ku kv kw kx bi translated"><strong class="ih hj">安全文件夹:</strong>用于与安全相关的项目</li><li id="f6e9" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated"><strong class="ih hj">测试文件夹:</strong>用于测试资源</li><li id="fb7f" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated"><strong class="ih hj">工具文件夹:</strong>用于包含操作工具资源的项目</li><li id="3cab" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated"><strong class="ih hj"> test-tools-prod项目:</strong>用于<a class="ae jd" href="https://cloud.google.com/dns" rel="noopener ugc nofollow" target="_blank"> Google Cloud DNS </a>测试资源— <em class="ld">我希望这是一个临时项目。Google目前不支持低于project的资源类型的云DNS角色。更多细节见下文。</em></li></ul></div><div class="ab cl le lf gp lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="hb hc hd he hf"><h1 id="d07a" class="je jf hi bd jg jh ll jj jk jl lm jn jo jp ln jr js jt lo jv jw jx lp jz ka kb bi translated">设置ops-tools-prod项目和资源:</h1><p id="7113" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">更详细地说，这个项目将运行<a class="ae jd" href="https://cloud.google.com/dns" rel="noopener ugc nofollow" target="_blank"> Google Cloud DNS </a>，我将使用<a class="ae jd" href="https://github.com/kubernetes-incubator/external-dns" rel="noopener ugc nofollow" target="_blank">外部dns </a>为生产环境同步Kubernetes入口资源。它将为<a class="ae jd" href="https://www.terraform.io/docs/state/remote.html" rel="noopener ugc nofollow" target="_blank"> Terraform远程状态</a>运行<a class="ae jd" href="https://cloud.google.com/storage" rel="noopener ugc nofollow" target="_blank">谷歌云存储</a>。它还将运行<a class="ae jd" href="https://cloud.google.com/container-registry" rel="noopener ugc nofollow" target="_blank">谷歌容器注册表</a>，用于图像的“本地”存储和<a class="ae jd" href="https://cloud.google.com/container-registry/docs/get-image-vulnerabilities" rel="noopener ugc nofollow" target="_blank">容器分析</a>。</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="594e" class="lv jf hi lr b fi lw lx l ly lz">export project=ops-tools-prod<br/>gcloud config set project ${project}</span></pre><p id="29ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建一个</strong> <a class="ae jd" href="https://cloud.google.com/dns/zones" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Google Cloud托管DNS区域</strong> </a> <strong class="ih hj"> : </strong></p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="939d" class="lv jf hi lr b fi lw lx l ly lz">gcloud dns managed-zones create lzy-sh \<br/>--description="My Default Domain" --dns-name="lzy.sh"</span></pre><p id="d169" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">向您的域名注册机构注册该区域:</strong></p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="075f" class="lv jf hi lr b fi lw lx l ly lz">gcloud dns record-sets list --zone lzy-sh</span><span id="c8d9" class="lv jf hi lr b fi ma lx l ly lz">NAME          TYPE  TTL    DATA<br/>lzy.sh.                         NS     21600  ns-cloud-c1.googledomains.com.,ns-cloud-c2.googledomains.com.,ns-cloud-c3.googledomains.com.,ns-cloud-c4.googledomains.com.<br/>lzy.sh.                         SOA    21600  ns-cloud-c1.googledomains.com. cloud-dns-hostmaster.google.com.</span></pre><p id="4698" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">显示您的NS记录，获取数据并在您的注册服务商上创建NS记录。从现在开始，Google Cloud DNS将为我管理lzy.sh。</p><p id="87e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在其他需要它的项目中(稍后你会看到),我创建了一个子域区域，并将它添加到我的顶级区域lzy-sh，在这个项目中由Google Cloud DNS管理。</p><p id="a0be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建两个</strong> <a class="ae jd" href="https://cloud.google.com/storage/docs/creating-buckets" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Google云存储桶</strong> </a> <strong class="ih hj">用于</strong> <a class="ae jd" href="https://www.terraform.io/docs/state/remote.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Terraform远程状态</strong> </a> <strong class="ih hj"> : </strong></p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="396c" class="lv jf hi lr b fi lw lx l ly lz">gsutil mb -p ${project} -c multi_regional -l US \<br/>gs://${project}_tf_state</span><span id="e00d" class="lv jf hi lr b fi ma lx l ly lz">gsutil mb -p ${project} -c multi_regional -l US \<br/>gs://${project}-pre-prod_tf_state</span></pre><p id="536d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个用于生产平台状态，另一个用于所有预生产平台状态。用于自动化的生产前服务帐户无权访问生产存储桶。</p><p id="f4ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同时启用<a class="ae jd" href="https://cloud.google.com/storage/docs/object-versioning" rel="noopener ugc nofollow" target="_blank">对象版本</a>:</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="741b" class="lv jf hi lr b fi lw lx l ly lz">gsutil versioning set on gs://${project}_tf_state</span><span id="3b65" class="lv jf hi lr b fi ma lx l ly lz">gsutil versioning set on gs://${project}-pre-prod_tf_state</span></pre><p id="1274" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/iam/docs/creating-managing-service-accounts" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">创建两个谷歌云服务账号</strong> </a> <strong class="ih hj">进行自动化:</strong></p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="a110" class="lv jf hi lr b fi lw lx l ly lz">gcloud iam service-accounts create pre-prod-terraform \<br/>--display-name "Pre-production Terraform"</span><span id="6633" class="lv jf hi lr b fi ma lx l ly lz">gcloud iam service-accounts create terraform \<br/>--display-name "Production Terraform"</span></pre><p id="55cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys" rel="noopener ugc nofollow" target="_blank">创建两个服务账户密钥</a>并保存在安全的地方。它们将在以后用于自动化:</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="5520" class="lv jf hi lr b fi lw lx l ly lz">gcloud iam service-accounts keys create \<br/>~/pre-prod-terraform-key.json --iam-account \ <br/><a class="ae jd" href="mailto:pre-prod-terraform@ops-tools-prod.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">pre-prod-terraform@</a>${project}<a class="ae jd" href="mailto:pre-prod-terraform@ops-tools-prod.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">.iam.gserviceaccount.com</a></span><span id="1808" class="lv jf hi lr b fi ma lx l ly lz">gcloud iam service-accounts keys create \<br/>~/prod-terraform-key.json --iam-account \<br/><a class="ae jd" href="mailto:terraform@ops-tools-prod.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">terraform@</a>${project}<a class="ae jd" href="mailto:terraform@ops-tools-prod.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">.iam.gserviceaccount.com</a></span></pre><p id="bc49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/iam/docs/granting-changing-revoking-access" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">授予IAM角色</strong> </a> <strong class="ih hj">用于服务账户:</strong></p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="bd52" class="lv jf hi lr b fi lw lx l ly lz">gcloud projects add-iam-policy-binding ${project} --member \<br/>serviceAccount:<a class="ae jd" href="mailto:terraform@ops-tools-prod.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">terraform@</a>${project}<a class="ae jd" href="mailto:terraform@ops-tools-prod.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">.iam.gserviceaccount.com</a> \<br/>--role roles/resourcemanager.projectIamAdmin</span><span id="dd1a" class="lv jf hi lr b fi ma lx l ly lz">gcloud projects add-iam-policy-binding test-tools-prod --member \<br/>serviceAccount:pre-prod-terraform@${project}.iam.gserviceaccount.com \<br/>--role roles/resourcemanager.projectIamAdmin</span></pre></div><div class="ab cl le lf gp lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="hb hc hd he hf"><h1 id="5258" class="je jf hi bd jg jh ll jj jk jl lm jn jo jp ln jr js jt lo jv jw jx lp jz ka kb bi translated">设置测试工具产品项目和资源:</h1><p id="61d6" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">就像上面的ops-tools-prod项目一样，这个项目将运行<a class="ae jd" href="https://cloud.google.com/dns" rel="noopener ugc nofollow" target="_blank"> Google Cloud DNS </a>，我将使用<a class="ae jd" href="https://github.com/kubernetes-incubator/external-dns" rel="noopener ugc nofollow" target="_blank">外部dns </a>为预生产环境同步Kubernetes入口资源。我这样做的原因是因为Kubernetes的底层默认计算服务帐户需要有DNS管理员角色，就像我上面提到的那样，该角色的最低资源类型是项目。我不想授予生产前服务帐户编辑生产dns记录的能力。你可能知道那有多糟糕..</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="dd73" class="lv jf hi lr b fi lw lx l ly lz">export project=test-tools-prod<br/>gcloud config set project ${project}</span></pre><p id="c5f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建一个</strong> <a class="ae jd" href="https://cloud.google.com/dns/zones" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Google Cloud托管DNS区域</strong> </a> <strong class="ih hj"> : </strong></p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="3263" class="lv jf hi lr b fi lw lx l ly lz">gcloud dns managed-zones create test-lzy-sh \<br/>--description="My Test Domain" --dns-name="test.lzy.sh"</span></pre><p id="b22a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在ops-tools-prod: </strong>中向托管dns区域注册该区域</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="8001" class="lv jf hi lr b fi lw lx l ly lz">gcloud dns record-sets list --zone test-lzy-sh</span><span id="5c4c" class="lv jf hi lr b fi ma lx l ly lz">NAME          TYPE  TTL    DATA<br/>test.lzy.sh.  NS    21600  ns-cloud-d1.googledomains.com.,ns-cloud-d2.googledomains.com.,ns-cloud-d3.googledomains.com.,ns-cloud-d4.googledomains.com.<br/>test.lzy.sh.  SOA   21600  ns-cloud-d1.googledomains.com. cloud-dns-hostmaster.google.com. 1 21600 3600 259200 300</span></pre><p id="9380" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将显示您的NS记录，获取数据并在ops-tools-prod project lzy-sh managed cloud DNS zone中创建NS记录。</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="66ce" class="lv jf hi lr b fi lw lx l ly lz">gcloud --project ops-tools-prod dns record-sets transaction \<br/>start -z=lzy-sh</span><span id="8049" class="lv jf hi lr b fi ma lx l ly lz">gcloud --project ops-tools-prod dns record-sets transaction \<br/>add -z=lzy-sh --name="test.lzy.sh." --type=NS --ttl=300 \<br/>"ns-cloud-d1.googledomains.com." "ns-cloud-d2.googledomains.com." \<br/>"ns-cloud-d3.googledomains.com." "ns-cloud-d4.googledomains.com." </span><span id="d66b" class="lv jf hi lr b fi ma lx l ly lz">gcloud --project ops-tools-prod dns record-sets transaction \<br/>execute -z=lzy-sh</span></pre></div><div class="ab cl le lf gp lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="hb hc hd he hf"><h1 id="7a7f" class="je jf hi bd jg jh ll jj jk jl lm jn jo jp ln jr js jt lo jv jw jx lp jz ka kb bi translated">结论:</h1><p id="3771" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在，我们有了一个资源层次结构，其中的项目和资源支持从沙盒环境一直到生产的“安全”开发和自动化。</p><p id="eb9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" rel="noopener" href="/@blzysh/continuous-delivery-of-hashicorp-vault-on-google-kubernetes-engine-sandbox-development-f603e0bceaf1"> <strong class="ih hj">第五部分- &gt; </strong> </a></p></div></div>    
</body>
</html>