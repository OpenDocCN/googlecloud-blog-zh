<html>
<head>
<title>Cloud Dataflow can autoscale R programs for massively parallel data processing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云数据流可以自动缩放程序以进行大规模并行数据处理</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-dataflow-can-autoscale-r-programs-for-massively-parallel-data-processing-492b57bd732d?source=collection_archive---------0-----------------------#2016-08-26">https://medium.com/google-cloud/cloud-dataflow-can-autoscale-r-programs-for-massively-parallel-data-processing-492b57bd732d?source=collection_archive---------0-----------------------#2016-08-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="26df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/dataflow/" rel="noopener ugc nofollow" target="_blank">云数据流</a>是一个完全托管的服务，用于执行数据处理作业。你不需要配置或管理任何虚拟机——相反，你只需要编写你的数据处理管道，然后把它放到谷歌云平台上。这种处理是自动扩展的(在许多机器上),并在GCP计算基础设施上以分布式方式执行。</p><p id="1769" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您有一个令人尴尬的并行问题，这将非常有用，因为您只为使用这些机器的时间付费——运行一个由10台机器组成的小型集群1小时的成本与运行一个由100台机器组成的大型集群6分钟的成本相同，当您可以在6分钟内得到结果时，谁愿意等60分钟呢？</p><p id="a8cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cloud Dataflow目前支持两种语言的管道编程——Java和Python(API本身是开源的，以Apache Beam的形式)。这很好，但是如果您倾向于在R中进行分析呢？</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/2bd5dbe69ede5798d4690fffac7f4c36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GcylgN46pPtO-gmyuQbDxQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">使用Java的ScriptEngine功能从数据流中调用R程序</figcaption></figure><p id="ec06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你能使用数据流大规模并行处理R脚本吗？是的，你可以，使用<a class="ae jd" href="http://www.renjin.org/" rel="noopener ugc nofollow" target="_blank"> Renjin </a>和Java的<a class="ae jd" href="https://docs.oracle.com/javase/7/docs/api/javax/script/ScriptEngine.html" rel="noopener ugc nofollow" target="_blank"> ScriptEngine </a>框架从Java调用R程序——使用这种方法而不是Rjava或其他你可能熟悉的R-to-Java解决方案，因为你不能在数据流机器上安装R(记住数据流是一个自动伸缩框架，你不能配置虚拟机。)</p><p id="488d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如何做到这一点的详细步骤(你可以在github 上看到我的<a class="ae jd" href="https://github.com/GoogleCloudPlatform/training-data-analyst/tree/master/blogs/dataflow_r" rel="noopener ugc nofollow" target="_blank">数据流项目演示了这些步骤):</a></p><p id="7c2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Java Dataflow项目中，向pom.xml添加Renjin的存储库以及R和Cran的依赖项(以获得R库):</p><pre class="jf jg jh ji fd ju jv jw jx aw jy bi"><span id="92a4" class="jz ka hi jv b fi kb kc l kd ke">&lt;repositories&gt;<br/>  &lt;repository&gt;<br/>    &lt;id&gt;bedatadriven&lt;/id&gt;<br/>    &lt;name&gt;bedatadriven public repo&lt;/name&gt;<br/>    &lt;url&gt;<a class="ae jd" href="https://nexus.bedatadriven.com/content/groups/public/&lt;/url" rel="noopener ugc nofollow" target="_blank">https://nexus.bedatadriven.com/content/groups/public/&lt;/url</a>&gt;<br/>  &lt;/repository&gt;<br/>&lt;/repositories&gt;</span><span id="2552" class="jz ka hi jv b fi kf kc l kd ke">&lt;dependencies&gt;<br/>  &lt;dependency&gt;<br/>    &lt;groupId&gt;org.renjin&lt;/groupId&gt;<br/>    &lt;artifactId&gt;renjin-script-engine&lt;/artifactId&gt;<br/>    &lt;version&gt;RELEASE&lt;/version&gt;<br/>  &lt;/dependency&gt;<br/>  &lt;dependency&gt;<br/>    &lt;groupId&gt;org.renjin.cran&lt;/groupId&gt;<br/>    &lt;artifactId&gt;exptest&lt;/artifactId&gt;<br/>    &lt;version&gt;1.2-b214&lt;/version&gt;<br/>  &lt;/dependency&gt;</span></pre><p id="306d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">像平常一样写你的R程序。Java的ScriptEngine框架会让你给R输入值，得到R变量的值和结果。我的例子利用R库来测试给定的一组数字是否来自指数概率分布:</p><pre class="jf jg jh ji fd ju jv jw jx aw jy bi"><span id="bf67" class="jz ka hi jv b fi kb kc l kd ke">library(exptest)</span><span id="742e" class="jz ka hi jv b fi kf kc l kd ke">co.exp.test(x, simulate.p.value=FALSE, nrepl=2000)</span></pre><p id="755e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的Java管道中，实例化一个ScriptEngine并执行R程序。R程序将与您的Java代码打包在一起，这样就可以从类路径中找到它(同样，绝对路径不会起作用，因为这是一个自动缩放框架，您无法访问数据流机器上的本地驱动器):</p><pre class="jf jg jh ji fd ju jv jw jx aw jy bi"><span id="173d" class="jz ka hi jv b fi kb kc l kd ke">ScriptEngineManager manager = new ScriptEngineManager();<br/>ScriptEngine engine = manager.getEngineByName("Renjin");<br/>InputStream rprog = CallingRFromJava.class.getResourceAsStream("myprog.r");</span></pre><p id="ac0f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">推入你的R程序需要的变量(我的需要x，是一个doubles的数组)，运行R程序，从R返回结果，拉出你需要的数据。在我的例子中，指数测试返回一个p值是第二个数字的列表。所以，我有:</p><pre class="jf jg jh ji fd ju jv jw jx aw jy bi"><span id="b7dd" class="jz ka hi jv b fi kb kc l kd ke">double[] inputx = c.element(); // from input<br/>engine.put("x", inputx);</span><span id="ccdb" class="jz ka hi jv b fi kf kc l kd ke">// run R program, get output from R, send to Dataflow<br/>ListVector result = (ListVector) engine.eval(new InputStreamReader(rprog));</span><span id="cb33" class="jz ka hi jv b fi kf kc l kd ke">double pvalue = result.getElementAsDouble(1);</span></pre><p id="e54f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无论是在本地还是在云上，照常执行数据流管道。</p><p id="b217" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参见<a class="ae jd" href="https://github.com/GoogleCloudPlatform/training-data-analyst/tree/master/blogs/dataflow_r" rel="noopener ugc nofollow" target="_blank"> github repo </a>获取创建Maven项目的脚本、数据流管道的完整代码以及如何在云上运行它。</p><p id="fc18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">编码快乐！</p><p id="d5d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> P.S. </strong>一位同事提出，在Dataflow中运行R程序还有另一种可能的方法，因为Dataflow的Python版本允许用户<a class="ae jd" href="https://cloud.google.com/dataflow/pipelines/dependencies-python#non-python-dependencies" rel="noopener ugc nofollow" target="_blank">安装非Python依赖项</a>。您可以添加类似这样的内容:</p><pre class="jf jg jh ji fd ju jv jw jx aw jy bi"><span id="fe7c" class="jz ka hi jv b fi kb kc l kd ke">apt-get install -y r-base<br/>pip install rpy2</span></pre><p id="a782" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并将其包含在Python作业的启动脚本中。但是我没有尝试过，我也不清楚如何用这种方法安装R库。如果你真的尝试了第二种方法，并且成功了，请在评论中告诉我们！</p></div></div>    
</body>
</html>