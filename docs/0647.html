<html>
<head>
<title>1 hour migrations #1: SQS to GCP’s Cloud Pub/Sub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">1小时迁移#1: SQS到GCP的云发布/订阅</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/1-hour-migrations-1-sqs-to-gcps-cloud-pub-sub-105bcac63318?source=collection_archive---------0-----------------------#2018-06-15">https://medium.com/google-cloud/1-hour-migrations-1-sqs-to-gcps-cloud-pub-sub-105bcac63318?source=collection_archive---------0-----------------------#2018-06-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="86c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">消息队列在当今可伸缩的分布式基础设施中扮演着重要的角色。亚马逊网络服务(AWS)提供SQS(简单队列服务)，谷歌云平台(GCP)提供云发布/订阅。</p><p id="c08f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些都是用于发布和消费消息的可管理的、可伸缩的、可靠的服务。在这篇文章中，我想从高层次上讨论如何将你的应用从使用亚马逊的SQS迁移到谷歌的发布/订阅。</p><h2 id="c68a" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">伙计，我的队伍呢？</h2><p id="4a7f" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">在我们深入探讨之前，让我们将一些术语从SQS映射到Pub/Sub。</p><p id="5e2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在SQS，您处理队列，而在发布/订阅中，您处理主题和订阅。你可能会问，等等，为什么我的队列变成了两个独立的实体？这与Pub/Sub的工作方式有关。Pub/Sub中实际的类似队列的范例由一个主题表示，但是如果没有消费者为该主题创建和订阅一个(或多个)订阅，您将无法做太多事情。</p><p id="e01f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看下面的SQS队列:</p><ol class=""><li id="2c41" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated"><strong class="ih hj">名称:我的队列</strong></li><li id="e47b" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">地区:美国东部-1 </strong></li><li id="64b0" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">消息保留时间:12天</strong></li><li id="6914" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">先进先出:否</strong></li><li id="6c0b" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">重驱动策略:否(无死信队列)</strong></li><li id="604f" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">最大有效载荷大小:256KB </strong></li><li id="dbd0" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><strong class="ih hj">消息传递延迟:无</strong></li></ol><p id="614d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">向云发布/订阅迁移的第一步是:</p><ol class=""><li id="82f0" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated">创建一个名为“myqueue”的主题</li><li id="9a8b" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">为该主题创建一个名为“mysubscription”的订阅。</li></ol><p id="abdd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意:</p><ul class=""><li id="8538" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc kr kj kk kl bi translated">不需要定义区域，因为发布/订阅主题是全局的。</li><li id="1ab9" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc kr kj kk kl bi translated">发布/订阅中的消息保留期(在本文发布之日)是7天，所以我们不能像SQS上的配置那样达到12天。</li></ul><h2 id="adb9" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">发布消息(即让他们拥有它！)</h2><p id="20ed" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">在SQS，发布消息就像调用SendMessage API一样简单，只需要队列URL和消息有效负载。在Cloud Pub/Sub中，您可以只使用主题名称和有效负载来调用“publish”方法。很简单，但是请注意，cloudpub/Sub API将返回一个future，您需要等待它来解决，直到您可以保存发送的消息Id。</p><h2 id="66ca" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">接收消息(即收到消息！)</h2><p id="5a52" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">要从SQS轮询消息，您可以以一种简单的方式使用AWS api:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="c6aa" class="jd je hi kx b fi lb lc l ld le">response <strong class="kx hj">=</strong> client<strong class="kx hj">.</strong>receive_message(<br/>    QueueUrl<strong class="kx hj">="https://somearn/myqueue"</strong>,<br/>    MaxNumberOfMessages<strong class="kx hj">=</strong>1,<br/>    VisibilityTimeout<strong class="kx hj">=</strong>10,<br/>)</span></pre><p id="efcd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在云发布/订阅中，您可以使用消息轮询或消息推送(在<a class="ae lf" href="https://cloud.google.com/pubsub/docs/subscriber" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/pubsub/docs/subscriber</a>了解更多信息)。</p><p id="c3a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了简单起见，我们将使用轮询机制，但是请注意我使用的是异步方式:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="e24e" class="jd je hi kx b fi lb lc l ld le">subscriber = pubsub_v1.SubscriberClient()<br/>subscription_path = subscriber.subscription_path(<br/>    'myproject', 'mysubscription')<br/><br/>def message_callback(message):<br/>    # Do something with the message here<br/>    message.ack()<br/><br/>subscriber.subscribe(subscription_path, callback=message_callback)</span></pre><p id="1fa1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为这里的轮询是非阻塞的，如果这是进程唯一要做的事情，你将需要一个主循环来保持它的活动。</p><h1 id="952f" class="lg je hi bd jf lh li lj jj lk ll lm jn ln lo lp jq lq lr ls jt lt lu lv jw lw bi translated">结论</h1><p id="bdc2" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">在这篇文章中，我介绍了一个从简单的SQS到云发布/订阅的迁移场景。当然，还有更复杂的用例、架构和最佳实践，我会在接下来的文章中介绍。</p><p id="12ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更多阅读:</p><p id="f3d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云发布/订阅:<a class="ae lf" href="https://cloud.google.com/pubsub/docs/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/pubsub/docs/</a></p><p id="324d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">SQS和云Pub/Sub:<a class="ae lf" href="https://cloud.google.com/docs/compare/aws/application-services" rel="noopener ugc nofollow" target="_blank">https://Cloud . Google . com/docs/compare/AWS/application-services</a></p></div></div>    
</body>
</html>