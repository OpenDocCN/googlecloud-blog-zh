<html>
<head>
<title>Coolest features of Google Cloud Build</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Cloud Build最酷的特性</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/container-builder-797c0dc2c991?source=collection_archive---------1-----------------------#2017-04-05">https://medium.com/google-cloud/container-builder-797c0dc2c991?source=collection_archive---------1-----------------------#2017-04-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div class="er es hg"><img src="../Images/e335ffce4b127aa1f1fc49568dfcc7a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*pCrexz9Aau_VRmj2QSOT5w.gif"/></div></figure><div class=""/><p id="10d2" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" href="https://cloud.google.com/container-builder/" rel="noopener ugc nofollow" target="_blank"> Google Cloud Build </a>(又名容器构建器)是上个月<a class="ae jk" href="https://cloudplatform.googleblog.com/2017/03/Google-Cloud-Container-Builder-a-fast-and-flexible-way-to-package-your-software.html" rel="noopener ugc nofollow" target="_blank">发布的</a>，从那以后我一直在使用它。它有几个我非常喜欢但没有被强调的特性。黑客新闻出来的时候我在上面写了一篇<a class="ae jk" href="https://news.ycombinator.com/item?id=13807495" rel="noopener ugc nofollow" target="_blank">证词</a>，所以我打算在这里详细说明一下。以下是一些很酷的功能:</p><p id="eca5" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您将应用程序作为容器分发，则无需托管Jenkins实例或第三方CI服务来构建/推送您的映像。Cloud Container Builder不仅可以做到这一点，它还可以运行任意构建步骤来部署您的应用程序。</p><blockquote class="jl jm jn"><p id="cb97" class="im in jo io b ip iq ir is it iu iv iw jp iy iz ja jq jc jd je jr jg jh ji jj hb bi translated"><em class="hp">免责声明:我为Google Cloud工作，但不在容器构建器上工作。</em></p></blockquote><h1 id="227f" class="js jt hp bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">Dockerfile文件支持</h1><p id="e937" class="pw-post-body-paragraph im in hp io b ip kq ir is it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj hb bi translated">如果您的源存储库或目录有一个<code class="du kv kw kx ky b">Dockerfile</code> <a class="ae jk" href="https://docs.docker.com/engine/reference/builder/" rel="noopener ugc nofollow" target="_blank">(？)</a>，容器建造者可以建造它——句号。您有两种选择来使用<a class="ae jk" href="https://cloud.google.com/container-builder/docs/docker-build" rel="noopener ugc nofollow" target="_blank">这个特性</a>:要么转到Google Cloud Console并使用UI来导入您的存储库，要么只使用<code class="du kv kw kx ky b">gcloud</code> <a class="ae jk" href="https://cloud.google.com/sdk/gcloud/" rel="noopener ugc nofollow" target="_blank">(？)</a>命令行工具。</p><p id="d5e0" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">因此，您最喜欢的命令不是:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="5c65" class="lh jt hp ky b fi li lj l lk ll">docker build -t gcr.io/project-id/app:v1 .</span></pre><p id="5817" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可以运行:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="fa5f" class="lh jt hp ky b fi li lj l lk ll">gcloud container builds submit -t gcr.io/project-id/app:v1 .</span></pre><p id="c006" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du kv kw kx ky b">gcloud</code> <strong class="io hq">通过执行以下步骤来打包您的源目录并在云</strong>上构建:</p><ul class=""><li id="7fbb" class="lm ln hp io b ip iq it iu ix lo jb lp jf lq jj lr ls lt lu bi translated">将源目录压缩为tarball ( <code class="du kv kw kx ky b">.tgz</code>)</li><li id="78c1" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj lr ls lt lu bi translated">将源包上传到Google云存储</li><li id="e1c0" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj lr ls lt lu bi translated">在云容器构建器上启动构建请求</li><li id="1641" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj lr ls lt lu bi translated">将构建日志流式传输到用户控制台</li><li id="961c" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj lr ls lt lu bi translated">标记构建的图像</li><li id="0485" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj lr ls lt lu bi translated">将图像推送到<a class="ae jk" href="https://cloud.google.com/container-registry/" rel="noopener ugc nofollow" target="_blank"> gcr.io </a>注册表</li></ul><p id="00ab" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你不明白我刚才说的话，这意味着你的机器上不需要Docker来构建和推送Docker映像。它看起来是这样的:</p><figure class="kz la lb lc fd hk er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es ma"><img src="../Images/ed488e50aa10d261386f1ef4c6326d27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*1ne8y8fjqg1K57PZUeVLlg.gif"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">这条命令在云上构建您的源代码，打包并存储它</figcaption></figure><h1 id="da0e" class="js jt hp bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">GitHub/BitBucket集成</h1><p id="03af" class="pw-post-body-paragraph im in hp io b ip kq ir is it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj hb bi translated">我把我所有的东西都放在GitHub私人仓库里，包括我的博客。我花了不到60秒的时间为我的GitHub库建立了一个版本。谷歌云控制台集成了GitHub，因此导入您的回购文件非常简单。你只需授权应用程序访问你的回购，然后选择你的回购建立。</p><p id="7fa8" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你的回购有一个<code class="du kv kw kx ky b">Dockerfile</code>，你不需要写一个<code class="du kv kw kx ky b">.travis.yml</code>或者<code class="du kv kw kx ky b">circle.yml</code>之类的东西。</p><h1 id="2930" class="js jt hp bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">多步可定制构建</h1><p id="d83c" class="pw-post-body-paragraph im in hp io b ip kq ir is it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj hb bi translated">单一的<code class="du kv kw kx ky b">Dockerfile</code>并不总能给你想要的。有时你需要执行多个步骤来建立你的形象；我怀疑这就是为什么很多人仍然使用詹金斯。</p><p id="91ef" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Cloud Builder很好地解决了这个问题，它提供了一个定制构建步骤和环境的选项。</p><p id="963a" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">以下是你需要知道的:</p><ol class=""><li id="880f" class="lm ln hp io b ip iq it iu ix lo jb lp jf lq jj mj ls lt lu bi translated">您可以用一个<code class="du kv kw kx ky b">cloudbuild.{yaml,json}</code>文件<a class="ae jk" href="https://cloud.google.com/container-builder/docs/api/custom-build-steps" rel="noopener ugc nofollow" target="_blank">(？)</a></li><li id="527b" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj mj ls lt lu bi translated">每个构建步骤都在一个容器中运行</li><li id="4ac6" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj mj ls lt lu bi translated">你可以自带容器图片(或者使用谷歌提供的图片)</li><li id="e82d" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj mj ls lt lu bi translated">您的存储库安装在<code class="du kv kw kx ky b">/workspace</code></li><li id="daa6" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj mj ls lt lu bi translated">从一个构建步骤到另一个构建步骤，<code class="du kv kw kx ky b">/workspace</code>的内容被保留。</li></ol><p id="8f04" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这就像<strong class="io hq"> Jenkins构建管道</strong>一样，你的工件从管道的一个步骤到另一个步骤被隐藏/不被隐藏。</p><p id="0df5" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了更好地说明这一点，假设您有一个示例应用程序:</p><ul class=""><li id="f3bc" class="lm ln hp io b ip iq it iu ix lo jb lp jf lq jj lr ls lt lu bi translated"><strong class="io hq">第一步:</strong> <code class="du kv kw kx ky b">(image=golang)</code>编译你的Go应用程序</li><li id="670c" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj lr ls lt lu bi translated"><strong class="io hq">步骤2: </strong> <code class="du kv kw kx ky b">(image=binary-signing)</code>签署您的应用程序二进制文件</li><li id="d52d" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj lr ls lt lu bi translated">第三步: <code class="du kv kw kx ky b">(image=docker)</code>将你的二进制文件打包成Docker镜像</li></ul><p id="c7d6" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后，Container Builder会自动将标记的图像推送到GCR。你可以在<a class="ae jk" href="https://github.com/GoogleCloudPlatform/cloud-builders" rel="noopener ugc nofollow" target="_blank">云构建者</a>库中看到各种各样的例子。</p><p id="f4c6" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">但是在我结束这一部分之前，还有两件很酷的事情:</p><ul class=""><li id="9191" class="lm ln hp io b ip iq it iu ix lo jb lp jf lq jj lr ls lt lu bi translated"><strong class="io hq">你不需要用Cloud Builder来构建容器:</strong>例如，我<a class="ae jk" href="https://cloud.google.com/community/tutorials/automated-publishing-container-builder" rel="noopener ugc nofollow" target="_blank">写了一篇教程</a>，讲述我如何使用容器构建器在谷歌云存储上发布这篇博客。我没有为此构建任何容器。我的定制构建步骤只是运行<code class="du kv kw kx ky b">gsutil rsync</code>来上传我的博客。一旦你意识到这一点，你基本上可以用它来做任何事情，比如运行测试，或者进行部署。</li><li id="bf06" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj lr ls lt lu bi translated"><strong class="io hq">您可以并行化构建步骤:</strong>您在<code class="du kv kw kx ky b">cloudbuild.{yaml/json}</code>文件中列出的任何步骤都可以并行执行。我有这个repo，我并行编译和打包了3个不同的Go二进制文件，节省了很多构建时间。</li><li id="44d1" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj lr ls lt lu bi translated"><strong class="io hq">可定制的构建通知:</strong>参见<a class="ae jk" href="https://cloud.google.com/container-builder/docs/tutorials/configuring-third-party-notifications" rel="noopener ugc nofollow" target="_blank">本教程</a>了解如何使用Google Cloud函数和Pub/Sub向Slack通道交付构建状态。</li></ul><h1 id="aba9" class="js jt hp bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">集装箱建造者是faaaast！</h1><p id="2ea4" class="pw-post-body-paragraph im in hp io b ip kq ir is it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj hb bi translated">你需要明白谷歌拥有大量的计算和网络能力，并且<a class="ae jk" href="https://thehftguy.com/2016/11/18/google-cloud-is-50-cheaper-than-aws/" rel="noopener ugc nofollow" target="_blank">不介意</a>把这些分配给像容器构建器这样的东西。在Container Builder上运行构建的机器在CPU、I/O和网络方面真的很快。</p><p id="84b2" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">正如你可以在我的<a class="ae jk" href="https://news.ycombinator.com/item?id=13807495" rel="noopener ugc nofollow" target="_blank"> CircleCI vs Container Builder证词</a>中读到的，当我转到Container Builder时，我看到我的3m30s构建下降到1m10s(也就是说<strong class="io hq">快了3倍</strong>)。</p><p id="7cbb" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">以下是Google容器构建器更快的一些原因:</p><ul class=""><li id="475c" class="lm ln hp io b ip iq it iu ix lo jb lp jf lq jj lr ls lt lu bi translated">你的源代码已经被镜像到谷歌的云源代码库中，所以相比之下，获取源代码会更快。</li><li id="2331" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj lr ls lt lu bi translated">Google分配了大量的网络带宽来构建机器，因此你的基本docker映像被快速提取(除非它已经被缓存，因为像<code class="du kv kw kx ky b">golang</code>、<code class="du kv kw kx ky b">python</code>这样的流行基本映像已经被缓存在构建机器上了！)</li><li id="ed89" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj lr ls lt lu bi translated">谷歌分配了大量的计算能力来构建机器，因此编译速度比第三方CI服务的免费层(甚至是付费订阅)更快。</li><li id="8be5" class="lm ln hp io b ip lv it lw ix lx jb ly jf lz jj lr ls lt lu bi translated">容器图像在谷歌容器注册处被更快地推回，因为谷歌内部的流量相对于外部-内部网络来说真的很快。</li></ul><p id="3986" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">也就是说，目前你可以免费获得2小时的构建时间，额外的构建时间<a class="ae jk" href="https://cloud.google.com/container-builder/pricing" rel="noopener ugc nofollow" target="_blank">需要付费</a>。我希望大多数小项目对免费层感到满意。</p><p id="1103" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">容器构建器的简单构建模式给了我很大的启发。如果你只是用Dockerfiles构建，它可以开箱即用。然而，如果你想定制，它也提供了一个干净的模块化方法。我已经用它来构建和部署我的应用程序并发布我的博客。</p><p id="6299" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当然<a class="ae jk" href="https://cloud.google.com/container-builder/" rel="noopener ugc nofollow" target="_blank">可以查看云容器构建器</a>和<a class="ae jk" href="https://cloud.google.com/container-builder/docs/" rel="noopener ugc nofollow" target="_blank">阅读文档</a>，如果你有兴趣的话。</p></div><div class="ab cl mk ml gp mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hb hc hd he hf"><p id="081c" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你想了解更多关于Kubernetes，Google Container Engine和其他很酷的东西，请关注我。本文原载于<a class="ae jk" href="https://ahmetalpbalkan.com/blog/container-builder/" rel="noopener ugc nofollow" target="_blank"><em class="jo">ahmetalpbalkan.com</em></a><em class="jo">。</em></p></div></div>    
</body>
</html>