<html>
<head>
<title>Simplify streaming ELT pipeline using BigQuery Subscriptions with Pub/Sub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用带有发布/订阅的BigQuery订阅简化流ELT管道</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/simplify-streaming-elt-pipeline-using-bigquery-subscriptions-with-pub-sub-b3c4fb69e5f4?source=collection_archive---------0-----------------------#2022-09-19">https://medium.com/google-cloud/simplify-streaming-elt-pipeline-using-bigquery-subscriptions-with-pub-sub-b3c4fb69e5f4?source=collection_archive---------0-----------------------#2022-09-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d3eb7c1a475598c9551533c2e06490d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*s23BrtSrSKK-CxbC"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">克劳迪奥·施瓦兹在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="dcab" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将您的数据从客户端实时接收到BigQuery这样的数据仓库中，对于让您的最新业务数据立即可供分析来说是至关重要的。</p><p id="d70a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在GCP，你基本上使用一个组合<strong class="ix hj">云发布/订阅</strong>，它用于流分析和数据集成管道来接收和分发数据。作为面向消息的中间件，它同样可以有效地进行服务集成，或者作为队列来并行化任务和中间的<a class="ae iu" href="https://cloud.google.com/dataflow" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">数据流</strong> </a>作业，然后您的数据才能以正确的模式被接收到BigQuery中。虽然数据流管道(包括使用数据流模板构建的管道)可以很好地完成工作，但有时对于只需要将原始数据导出到BigQuery而不进行转换的用例来说，它们可能会超出需求。</p><p id="5813" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">幸运的是，GCP宣布了一种叫做<strong class="ix hj"> BigQuery Subscription </strong>的新订阅类型，它直接从发布/订阅向BigQuery写入数据。这个新的提取、加载和转换(ELT)路径将能够简化您的事件驱动架构。对于Pub/Sub消息，在将数据放入BigQuery之前，需要进行高级预加载转换或数据处理(例如屏蔽PII ),但是中间仍然需要数据流。</p><p id="75c6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，让我们继续创建我们的管道。我们将完成以下主要任务:</p><ol class=""><li id="a504" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">创建我们的客户端(Node js)并使用云运行作业部署它。</li><li id="0ad2" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">创建BQ数据集和表</li><li id="ae8b" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">配置发布/订阅</li></ol><p id="f040" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">创建客户端并部署到云运行作业</strong></p><p id="96fa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将使用<a class="ae iu" href="https://github.com/faker-js/faker" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> faker js </strong> </a> (RIP艾伦·施瓦茨)生成大量虚假(但真实)的交易数据。</p><figure class="kh ki kj kk fd ij"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="94d8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">确保在根文件夹中创建一个. env文件，并设置了<strong class="ix hj">主题名称</strong>和<strong class="ix hj">项目ID </strong>值。</p><p id="3d04" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们需要对客户端进行容器化，将容器推送到工件注册中心，并将其部署为云运行作业。</p><figure class="kh ki kj kk fd ij"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="700d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">构建您的容器，并将其推送到工件注册表。你可以在这里查阅文档<a class="ae iu" href="https://cloud.google.com/artifact-registry/docs/docker/pushing-and-pulling" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="48e3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">导航到GCP控制台中的云运行，然后选择作业。点击创建工单，并填写如下详细信息:</p><figure class="kh ki kj kk fd ij er es paragraph-image"><div class="er es kn"><img src="../Images/a37af5592ea3b1e9e0a117c6abea05ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*iS7FmQeJB2sPRT-mVf2PwA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">云运行作业配置</figcaption></figure><p id="17e0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不要勾选<strong class="ix hj">立即执行作业</strong>复选框。点击创建</p><p id="ec5f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">创建BQ数据集和表格</strong></p><p id="9679" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在GCP控制台中导航到BigQuery，单击项目旁边的⋮图标，然后单击<strong class="ix hj">创建数据集</strong></p><p id="0230" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建数据集后，运行以下查询来创建表:</p><figure class="kh ki kj kk fd ij"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="7092" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">配置发布/订阅</strong></p><p id="3add" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在GCP控制台中导航到发布/订阅，然后单击左侧边栏中的模式。</p><p id="a4d4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从顶部单击创建模式。给它一个名称，并选择<strong class="ix hj"> Avro作为模式类型。</strong>增加以下模式定义:</p><figure class="kh ki kj kk fd ij"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="2e72" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建模式后，单击创建主题，输入所有详细信息，然后单击创建。</p><figure class="kh ki kj kk fd ij er es paragraph-image"><div class="er es ko"><img src="../Images/4cf423b4b452efc55c59349d72274eb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*PdTLAizchAIBooFlj84SVA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">发布/子主题配置</figcaption></figure><p id="7dac" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">转到<strong class="ix hj">订阅</strong>，从顶部点击<strong class="ix hj">创建订阅</strong>。为订阅命名，并添加前面步骤中的所有详细信息。</p><figure class="kh ki kj kk fd ij er es paragraph-image"><div class="er es kp"><img src="../Images/309dc680bcd211f69eafd627c08e01e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*AVX_P64MqvnKSqOxAvoADA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">发布/订阅订阅配置</figcaption></figure><p id="e01a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦创建了订阅，就可以了。您已经完成了设置。现在让我们来看看它的运行情况。</p><p id="874f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">转到云运行中的作业。选择之前创建的任务，点击<strong class="ix hj">执行。</strong></p><p id="24a0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您应该开始看到BQ表中的条目。一旦云运行作业完成，在BQ中运行以下查询来检查摄取的记录数量:</p><p id="de06" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从`<project_id>中选择计数(账户)。<dataset_name>。<table_name/></dataset_name></project_id></p><p id="bb89" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">总结</strong></p><p id="be4d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这篇博客中，我们创建了一个简单的实时管道，将数据从发布/订阅直接推送到BigQuery，而不必在中间使用数据流。这对于在存储之前不需要额外处理的用例非常有用。</p><p id="9668" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有了这种新的订阅类型，在使用这种新的直接方法时，您不再需要为将数据接收到BigQuery中而付费。你只需为你使用的酒馆/餐馆付费。与使用数据流管道相比，这要便宜得多，在数据流管道中，您需要为使用存储写API的发布/订阅读取、数据流作业和大查询数据接收付费。</p><p id="7041" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">参考<br/></strong><a class="ae iu" href="https://cloud.google.com/blog/products/data-analytics/pub-sub-launches-direct-path-to-bigquery-for-streaming-analytics" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/blog/products/data-analytics/pub-sub-launchs-direct-path-to-big query-for-streaming-analytics</a></p><p id="13fe" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://cloud.google.com/pubsub/docs/bigquery" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/pubsub/docs/bigquery</a></p><p id="2fb2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://github.com/rastogiji/automation-scripts/tree/master/streaming-pipeline-gcp" rel="noopener ugc nofollow" target="_blank">https://github . com/rastogiji/automation-scripts/tree/master/streaming-pipeline-GCP</a></p><p id="5620" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://www.rollingstone.com/culture/culture-news/the-brilliant-life-and-tragic-death-of-aaron-swartz-177191/" rel="noopener ugc nofollow" target="_blank">https://www . rollingstone . com/culture/culture-news/the-brilliant-life-and-quartery-death-of-aaron-swar tz-177191/</a></p></div></div>    
</body>
</html>