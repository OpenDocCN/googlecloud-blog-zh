<html>
<head>
<title>Adding a cache layer to Google Cloud databases (Bigtable + Memcached)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向Google云数据库添加缓存层(Bigtable + Memcached)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/adding-a-cache-layer-to-google-cloud-databases-memcached-bigtable-4db9de8c9873?source=collection_archive---------0-----------------------#2020-10-22">https://medium.com/google-cloud/adding-a-cache-layer-to-google-cloud-databases-memcached-bigtable-4db9de8c9873?source=collection_archive---------0-----------------------#2020-10-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/3134e089ebcf241d955ce28f845bf746.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KGRxs_Zz8r7fmIi22aG3Rg.png"/></div></div></figure><p id="c7f2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">TLDR:通过对经常查询的数据使用Memcached来提高应用程序的性能，如下所示:</p><figure class="jo jp jq jr fd ij"><div class="bz dy l di"><div class="js jt l"/></div></figure><p id="cfda" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据库是为特定的模式、查询和吞吐量而设计的，但是如果您的数据在一段时间内被更频繁地查询，您可能希望通过引入缓存层来减少数据库的负载。</p><p id="034a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本帖中，我们将关注可水平扩展的Google Cloud Bigtable，它非常适合高吞吐量的读写。通过确保在数据库中统一查询行，可以优化性能。如果我们为更频繁查询的行引入一个缓存，我们可以从两个方面提高应用程序的速度:降低热定位行的负载，并通过将缓存和计算放在一起提高响应速度。</p><p id="0e77" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Memcached是一个内存中的键值存储，用于存储小块的任意数据，我将为Memcached  (Beta)使用可伸缩的、完全托管的<a class="ae ju" href="https://cloud.google.com/memorystore/docs/memcached" rel="noopener ugc nofollow" target="_blank"> Memorystore，因为它与Google Cloud生态系统集成得很好。</a></p><h1 id="b9e5" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">设置</h1><ol class=""><li id="d239" class="kt ku hi is b it kv ix kw jb kx jf ky jj kz jn la lb lc ld bi translated"><a class="ae ju" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" rel="noopener ugc nofollow" target="_blank">创建一个新的</a> Google Cloud项目，或者使用您选择的现有项目和数据库。这里的例子将显示Cloud <a class="ae ju" href="https://cloud.google.com/bigtable/docs" rel="noopener ugc nofollow" target="_blank"> Bigtable </a>，但是Spanner或Firestore也是不错的选择。</li><li id="cfc7" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">我将为大多数步骤提供<a class="ae ju" href="https://cloud.google.com/sdk/gcloud" rel="noopener ugc nofollow" target="_blank"> gcloud命令</a>，但是如果您愿意，您可以在Google <a class="ae ju" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">云控制台</a>中完成大部分操作。</li><li id="65a7" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn la lb lc ld bi translated">使用以下命令创建云Bigtable实例和一个只有一行的表:</li></ol><pre class="jo jp jq jr fd lj lk ll lm aw ln bi"><span id="6cb6" class="lo jw hi lk b fi lp lq l lr ls">cbt createinstance bt-cache "Bigtable with cache" bt-cache-c1 us-central1-b 1 SSD</span><span id="5440" class="lo jw hi lk b fi lt lq l lr ls">cbt -instance=bt-cache createtable mobile-time-series "families=stats_summary"</span><span id="bbca" class="lo jw hi lk b fi lt lq l lr ls">cbt -instance=bt-cache set mobile-time-series phone#4c410523#20190501 stats_summary:os_build=PQ2A.190405.003 <br/>stats_summary:os_name=android</span><span id="2a7a" class="lo jw hi lk b fi lt lq l lr ls"># Verify this worked by reading the data.<br/>cbt -instance=bt-cache read mobile-time-series</span></pre><h1 id="a36a" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">代码</h1><p id="a235" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lu jd je jf lv jh ji jj lw jl jm jn hb bi translated">高速缓存的通用逻辑可以在以下步骤中定义:</p><pre class="jo jp jq jr fd lj lk ll lm aw ln bi"><span id="2afa" class="lo jw hi lk b fi lp lq l lr ls">Pick a row key to query<br/>If row key is in cache<br/>    Return the value<br/>Otherwise<br/>    Look up the row in Cloud Bigtable<br/>    Add the value to the cache with an expiration<br/>    Return the value</span></pre><p id="3203" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于Cloud Bigtable，您的代码可能如下所示(<a class="ae ju" href="https://github.com/GoogleCloudPlatform/java-docs-samples/tree/master/bigtable/memorystore" rel="noopener ugc nofollow" target="_blank">GitHub上的完整代码</a>):</p><figure class="jo jp jq jr fd ij"><div class="bz dy l di"><div class="js jt l"/></div></figure><p id="5b0a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我选择将缓存键设为<code class="du lx ly lz lk b">row_key:column_family:column_qualifier</code>,以便于访问列值。以下是一些您可以使用的潜在缓存键/值对:</p><ul class=""><li id="d89a" class="kt ku hi is b it iu ix iy jb ma jf mb jj mc jn md lb lc ld bi translated"><code class="du lx ly lz lk b">rowkey: encoded row</code></li><li id="3961" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn md lb lc ld bi translated"><code class="du lx ly lz lk b">start_row_key-end_row_key: array of encoded rows</code></li><li id="6481" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn md lb lc ld bi translated"><code class="du lx ly lz lk b">SQL queries: results</code></li><li id="2ee6" class="kt ku hi is b it le ix lf jb lg jf lh jj li jn md lb lc ld bi translated"><code class="du lx ly lz lk b">row prefix: array of encoded rows</code></li></ul><p id="86de" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建缓存时，根据您的使用情况确定设置。请注意，Bigtable行键的大小限制为4KB，而Memcached键的大小限制为250字节，因此您的行键可能会太大。</p><h1 id="6cd2" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">创建Memcached实例</h1><p id="a51b" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lu jd je jf lv jh ji jj lw jl jm jn hb bi translated">我将为Memcached实例创建一个Memorystore，但是您可以安装并运行一个<a class="ae ju" href="https://github.com/memcached/memcached/wiki/Install" rel="noopener ugc nofollow" target="_blank">本地Memcached实例</a>来进行测试。如果你愿意，这些步骤可以用<a class="ae ju" href="https://console.cloud.google.com/memorystore/memcached/instances" rel="noopener ugc nofollow" target="_blank">内存商店云控制台</a>来完成。</p><ol class=""><li id="7f6e" class="kt ku hi is b it iu ix iy jb ma jf mb jj mc jn la lb lc ld bi translated">启用Memcached API的内存存储。</li></ol><pre class="jo jp jq jr fd lj lk ll lm aw ln bi"><span id="f2ea" class="lo jw hi lk b fi lp lq l lr ls">gcloud services enable memcache.googleapis.com</span></pre><p id="8e89" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.在默认网络上创建最小大小的Memcached实例。使用适合您的应用程序的区域。</p><pre class="jo jp jq jr fd lj lk ll lm aw ln bi"><span id="1d84" class="lo jw hi lk b fi lp lq l lr ls">gcloud beta memcache instances create bigtable-cache --node-count=1 --node-cpu=1 --node-memory=1GB --region=us-central1</span></pre><figure class="jo jp jq jr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/e6dae31b65cc93ca75d1e0a6d825be17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JbuahAxHGxsJypj77KkK0g.png"/></div></div></figure><p id="6a35" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.获取Memcached实例的详细信息并获取<a class="ae ju" href="https://cloud.google.com/memorystore/docs/memcached/using-auto-discovery" rel="noopener ugc nofollow" target="_blank"> discoveryEndpoint IP地址</a>(您可能需要等待几分钟来完成实例的创建)。</p><pre class="jo jp jq jr fd lj lk ll lm aw ln bi"><span id="c34d" class="lo jw hi lk b fi lp lq l lr ls">gcloud beta memcache instances describe bigtable-cache --region=us-central1</span></pre><h1 id="74ec" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">在网络内设置机器</h1><p id="79ce" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lu jd je jf lv jh ji jj lw jl jm jn hb bi translated">我们需要在与Memcached实例相同的网络上创建一个运行代码的地方。您可以使用云功能等<a class="ae ju" href="https://cloud.google.com/vpc/docs/configure-serverless-vpc-access" rel="noopener ugc nofollow" target="_blank">无服务器选项</a>，但是计算虚拟机需要的配置较少。</p><ol class=""><li id="7005" class="kt ku hi is b it iu ix iy jb ma jf mb jj mc jn la lb lc ld bi translated">在默认网络上创建一个计算实例，并为云Bigtable数据启用API作用域。请注意，该区域必须与Memcached实例位于同一区域。</li></ol><pre class="jo jp jq jr fd lj lk ll lm aw ln bi"><span id="ef4e" class="lo jw hi lk b fi lp lq l lr ls">gcloud beta compute instances create bigtable-memcached-vm --zone=us-central1-a --machine-type=e2-micro --image=debian-10-buster-v20200910 --image-project=debian-cloud --boot-disk-size=10GB --boot-disk-type=pd-standard --boot-disk-device-name=bigtable-memcached-vm --scopes=https://www.googleapis.com/auth/bigtable.data,https://www.googleapis.com/auth/servicecontrol,https://www.googleapis.com/auth/service.management.readonly,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write,https://www.googleapis.com/auth/trace.append,https://www.googleapis.com/auth/devstorage.read_only</span></pre><div class="jo jp jq jr fd ab cb"><figure class="mf ij mg mh mi mj mk paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/729e6694142605f0365ee72c41429557.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*3zP7lJJ9hrzAEeg10mcc9Q.png"/></div></figure><figure class="mf ij ml mh mi mj mk paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/51694642064a47de463ca9d2319c8f5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/1*IXuL6OqIt8nPFuUU3yZv3A.png"/></div></figure></div><p id="6b29" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.SSH到您的新虚拟机。</p><pre class="jo jp jq jr fd lj lk ll lm aw ln bi"><span id="9047" class="lo jw hi lk b fi lp lq l lr ls">gcloud beta compute ssh --zone “us-central1-a” bigtable-memcached-vm</span></pre><h1 id="ec4f" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">可以选择通过Telnet连接到Memcached</h1><p id="1288" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lu jd je jf lv jh ji jj lw jl jm jn hb bi translated">Memcached文档的<a class="ae ju" href="https://cloud.google.com/memorystore/docs/memcached/connecting-memcached-instance?hl=en_US" rel="noopener ugc nofollow" target="_blank">memory store</a>包含了关于这个过程的更多信息，但是您可以运行下面的命令来设置和获取缓存中的值。</p><pre class="jo jp jq jr fd lj lk ll lm aw ln bi"><span id="e65b" class="lo jw hi lk b fi lp lq l lr ls">sudo apt-get install telnet<br/>telnet $DISCOVERY_ENDPOINT_ID 11211<br/>set greeting 1 0 11<br/>hello world<br/>get greeting</span></pre><h1 id="70ae" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">运行代码</h1><p id="50c6" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lu jd je jf lv jh ji jj lw jl jm jn hb bi translated">现在我们准备把代码放到机器上。</p><ol class=""><li id="843a" class="kt ku hi is b it iu ix iy jb ma jf mb jj mc jn la lb lc ld bi translated">您可以将回购直接克隆到虚拟机上，并从那里运行它。如果您想定制代码，请查看我的文章<a class="ae ju" rel="noopener" href="/google-cloud/rsync-on-gcp-compute-engine-when-you-cant-run-your-code-locally-network-issues-cb2ff2c9c176">将代码同步到计算引擎</a>或者使用<a class="ae ju" href="https://cloud.google.com/sdk/gcloud/reference/compute/scp" rel="noopener ugc nofollow" target="_blank"> gcloud scp命令</a>将代码从本地机器复制到虚拟机。</li></ol><pre class="jo jp jq jr fd lj lk ll lm aw ln bi"><span id="8246" class="lo jw hi lk b fi lp lq l lr ls">sudo apt-get install git<br/>git clone <a class="ae ju" href="https://github.com/GoogleCloudPlatform/java-docs-samples.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/java-docs-samples.git</a><br/>cd java-docs-samples/bigtable/memorystore</span></pre><p id="faf1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.安装maven</p><pre class="jo jp jq jr fd lj lk ll lm aw ln bi"><span id="6d7b" class="lo jw hi lk b fi lp lq l lr ls">sudo apt-get install maven</span></pre><p id="f326" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.为您的配置设置环境变量。</p><pre class="jo jp jq jr fd lj lk ll lm aw ln bi"><span id="f9a2" class="lo jw hi lk b fi lp lq l lr ls">PROJECT_ID=your-project-id<br/>MEMCACHED_DISCOVERY_ENDPOINT="0.0.0.0" # Get this from the memcache describe command above. Exclude the ':11211' suffix</span></pre><p id="1f60" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.运行该程序一次，从数据库中获取值，然后再次运行它，您将看到该值是从缓存中获取的。</p><pre class="jo jp jq jr fd lj lk ll lm aw ln bi"><span id="f537" class="lo jw hi lk b fi lp lq l lr ls">mvn compile exec:java -Dexec.mainClass=Memcached \<br/>    -DbigtableProjectId=$PROJECT_ID \<br/>    -DbigtableInstanceId=bt-cache \<br/>    -DbigtableTableId=mobile-time-series \<br/>    -DmemcachedDiscoveryEndpoint=$MEMCACHED_DISCOVERY_ENDPOINT</span></pre><h1 id="dd4e" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">后续步骤和清理</h1><p id="42a5" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lu jd je jf lv jh ji jj lw jl jm jn hb bi translated">现在，您应该理解了在数据库前放置缓存层的核心概念，并且可以将它集成到您现有的应用程序中。如果您遵循了这篇博文，请使用以下命令删除您的VM、Cloud Bigtable实例和Memcached实例，以防止收到资源账单:</p><pre class="jo jp jq jr fd lj lk ll lm aw ln bi"><span id="4b6d" class="lo jw hi lk b fi lp lq l lr ls">cbt deleteinstance bt-cache<br/>gcloud beta memcache instances delete bigtable-cache --region=us-central1 <br/>gcloud compute instances delete bigtable-memcached-vm --zone=us-central1-a</span></pre></div></div>    
</body>
</html>