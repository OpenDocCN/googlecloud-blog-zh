<html>
<head>
<title>Google Trillian for Noobs (1c)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Trillian for Noobs (1c)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-trillian-for-noobs-1c-dddb66ddd09f?source=collection_archive---------1-----------------------#2019-07-05">https://medium.com/google-cloud/google-trillian-for-noobs-1c-dddb66ddd09f?source=collection_archive---------1-----------------------#2019-07-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="068e" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">失踪手册系列</h2></div><p id="cef9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上周，我记录了我所希望的最简单的崔莉恩人格。昨天，我<a class="ae jt" rel="noopener" href="/google-cloud/google-trillian-for-noobs-1a-c87a78e5e585">记录了</a>添加包含证明。今天早些时候，我<a class="ae jt" rel="noopener" href="/google-cloud/google-trillian-for-noobs-1b-16097474ee3d">记录了</a>为个性构建一个基于gRPC的客户端和服务器。这里有一个小的添加，增加了度量(统计)和跟踪。</p><h2 id="948d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">OpenCensus导出器</h2><p id="bc68" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">通过使用OpenCensus代理为OpenCensus导出器添加一个简单的配置，我们能够配置代理将传入的stats|traces转换为各种第三方服务。</p><p id="86dc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是基本的个性化服务器配置:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="f74d" class="ju jv hi kz b fi ld le l lf lg">oc, err := ocagent.NewExporter(<br/> ocagent.WithAddress(*ocagEndpoint),<br/> ocagent.WithInsecure(),<br/> ocagent.WithReconnectionPeriod(10*time.Second),<br/> ocagent.WithServiceName(serviceName),<br/>)<br/>if err != nil {<br/> log.Fatal(err)<br/>}<br/>defer oc.Stop()</span></pre><p id="8362" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是代理的配置，用于在<code class="du lh li lj kz b">:55678</code>上接收传入的stats|traces，并将stats导出到Prometheus(在<code class="du lh li lj kz b">:9100</code>上)，并将traces路由到端口<code class="du lh li lj kz b">:9411</code>上的<code class="du lh li lj kz b">zipkin</code>服务:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="393a" class="ju jv hi kz b fi ld le l lf lg">receivers:<br/>  opencensus:<br/>    address: ":55678"</span><span id="69ba" class="ju jv hi kz b fi lk le l lf lg">exporters:<br/>  jaeger:<br/>    collector_endpoint: "<strong class="kz hj">jaeger</strong>:14268/api/traces"<br/>  prometheus:<br/>    address: ":9100"<br/>  zipkin:<br/>    endpoint: "<strong class="kz hj">zipkin</strong>:9411/api/v2/spans"</span><span id="282d" class="ju jv hi kz b fi lk le l lf lg">zpages:<br/>    port: 9999</span></pre><blockquote class="ll lm ln"><p id="2b14" class="ix iy lo iz b ja jb ij jc jd je im jf lp jh ji jj lq jl jm jn lr jp jq jr js hb bi translated">潜在的混乱来源。这些DNS名称由Docker Compose提供给它创建的网络上运行的服务。解决方案中的其他服务可以访问这些名称。在这种情况下，OpenCensus代理(本身称为<code class="du lh li lj kz b">opencensus-agent</code>)能够通过服务名(<code class="du lh li lj kz b">jaefer</code>、<code class="du lh li lj kz b">zipkin</code>)引用这些其他服务，但只能在解决方案中引用。在外部，我们需要将这些服务映射到<code class="du lh li lj kz b">localhost</code>上的一个可用端口上。</p></blockquote><h2 id="96c6" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">OpenCensus代理</h2><p id="41c4" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">OpenCensus代理在主机<code class="du lh li lj kz b">:9100</code>上导出为Prometheus导出器，因此您可以查询<code class="du lh li lj kz b"><a class="ae jt" href="http://localhost:9100/metrics" rel="noopener ugc nofollow" target="_blank">http://localhost:9100/metrics</a></code>并希望看到:</p><figure class="ku kv kw kx fd lt er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es ls"><img src="../Images/0960b0dd4a5d3bcc02fd6466de7aa145.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZGcHHOHiV7EjBNh0TotDsA.png"/></div></div></figure><p id="b0b6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以通过检查OpenCensus代理的日志来确认它:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="302c" class="ju jv hi kz b fi ld le l lf lg">docker-compose \<br/>--file=deployment/docker-compose.yml \<br/>logs <strong class="kz hj">opencensus-agent</strong></span><span id="0982" class="ju jv hi kz b fi lk le l lf lg">Attaching to deployment_opencensus-agent_1<br/>opencensus-agent_1          | {"level":"info","ts":1562357412.0980296,"caller":"config/config.go:490","msg":"Trace Exporter enabled","exporter":"zipkin"}<br/>opencensus-agent_1          | {"level":"info","ts":1562357412.0983222,"caller":"config/config.go:497","msg":"Metrics Exporter enabled","exporter":"prometheus"}<br/>opencensus-agent_1          | 2019/07/05 20:10:13 Running OpenCensus Trace and Metrics receivers as a gRPC service at ":55678"<br/>opencensus-agent_1          | 2019/07/05 20:10:13 Running zPages on port 9999</span></pre><p id="460b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">OpenCensus代理被配置为(<code class="du lh li lj kz b">:9999</code>)显示zPages，因此我们可以询问该端点:</p><figure class="ku kv kw kx fd lt er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es ma"><img src="../Images/cf0857e946b1d78daedb65c3fafdf456.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*araLUG_hqdc7ubtQnfw19A.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">/debug/tracez</figcaption></figure><blockquote class="ll lm ln"><p id="d832" class="ix iy lo iz b ja jb ij jc jd je im jf lp jh ji jj lq jl jm jn lr jp jq jr js hb bi translated"><strong class="iz hj">注意</strong>我本希望看到代理反映的上游gRPC跟踪，但它们没有。所以这是一个问题。</p></blockquote><h2 id="5061" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">普罗米修斯</h2><p id="261c" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">OpenCensus代理现在是Prometheus服务器的一个抓取目标(通过上面的导出程序)。因此，基本的个性客户端和服务器gRPC指标被导出到OpenCensus代理，该代理将其作为Prometheus导出器导出，然后由该服务器捕获:</p><figure class="ku kv kw kx fd lt er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es mf"><img src="../Images/fc1f168a7c393c7d8ed2f97a6bb3aaf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1IkugrEa0OIh2k_vD184gw.png"/></div></div></figure><h2 id="4279" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">齐普金</h2><figure class="ku kv kw kx fd lt er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es mg"><img src="../Images/eb601319ccc23b29b879adf4408c19e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BvNxpDTqWImnu7FEsFbdgw.png"/></div></div></figure><p id="c0ce" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">出于某种原因——有待探究——Zipkin要么没有接收到要么无法处理通过OpenCensus代理路由的由自动<code class="du lh li lj kz b">ocgrpc</code>处理程序生成的跟踪。</p><p id="fe87" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您也可以确认Zipkin服务日志，尽管这些日志很详细，这里不包括:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="6357" class="ju jv hi kz b fi ld le l lf lg">docker-compose \<br/>--file=deployment/docker-compose.yml \<br/>logs zipkin</span></pre><h2 id="eba3" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">贼鸥</h2><p id="dd4e" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">当Zipkin没有显示痕迹时，我添加了<a class="ae jt" href="https://www.jaegertracing.io" rel="noopener ugc nofollow" target="_blank"> Jaeger </a>(另一个痕迹监控工具)来查看它是否是Zipkin，上游OpenCensus代理，或者其他什么东西。杰格报告了它自己的踪迹但没有其他人。因此，在我的配置或OpenCensus代理中有一些东西不起作用:</p><figure class="ku kv kw kx fd lt er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es mf"><img src="../Images/54364fdbd447d630720eda96c4fc1489.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JkIa7eOq3bn_y1WERGrD5g.png"/></div></div></figure><h2 id="a677" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">结论</h2><p id="6c11" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">一个整合统计和追踪到基本个性的“娱乐套餐”。如果能完美运行就更牛逼了；-)</p></div></div>    
</body>
</html>