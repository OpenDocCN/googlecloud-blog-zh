<html>
<head>
<title>Capacity Management with Load Balancing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">负载平衡的容量管理</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/capacity-management-with-load-balancing-32bd22a716a7?source=collection_archive---------1-----------------------#2020-04-21">https://medium.com/google-cloud/capacity-management-with-load-balancing-32bd22a716a7?source=collection_archive---------1-----------------------#2020-04-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="5ac5" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">在云中烹饪</h2></div><p id="4fe5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">作者:<a class="ae jt" href="https://twitter.com/swongful" rel="noopener ugc nofollow" target="_blank">王从希</a>，<a class="ae jt" href="https://twitter.com/pvergadia" rel="noopener ugc nofollow" target="_blank">普里扬卡·韦尔加迪亚</a></p><h1 id="a8dd" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated"><strong class="ak">简介</strong></h1><p id="8165" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">“在云中烹饪”是一个博客和视频系列，旨在帮助企业和开发人员在Google Cloud上构建业务解决方案。在这个系列中，我们计划确定开发人员希望在Google cloud上构建的特定主题。一旦确定，我们将创建一个关于该主题的迷你系列。</p><p id="b052" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这个迷你系列中，我们将讨论Google云负载平衡。</p><ol class=""><li id="33b3" class="kr ks hi iz b ja jb jd je jg kt jk ku jo kv js kw kx ky kz bi translated"><a class="ae jt" rel="noopener" href="/google-cloud/choosing-the-right-load-balancer-9ec909148a85">选择合适的负载平衡器</a></li><li id="365a" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated"><a class="ae jt" rel="noopener" href="/google-cloud/application-capacity-optimizations-with-global-load-balancing-e0aa079d2c25">通过全局负载平衡优化应用容量</a></li><li id="4265" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated">负载平衡的容量管理(本文)</li><li id="c5f7" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated"><a class="ae jt" rel="noopener" href="/google-cloud/container-load-balancing-on-google-kubernetes-engine-gke-4cbfaa80a6f6">GKE网络端点组的负载均衡</a></li></ol><p id="1981" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本文中，我们将向您展示如何比较多区域负载平衡器和单区域负载平衡器的性能。我们将通过设置一个简单的web服务器来实现这一点，该服务器运行一个计算Mandelbrot集合的CPU密集型应用程序。</p><h1 id="1466" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated"><strong class="ak">查看视频</strong></h1><figure class="lf lg lh li fd lj"><div class="bz dy l di"><div class="lk ll l"/></div></figure><h1 id="63f6" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated"><strong class="ak">回顾</strong></h1><p id="c47e" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">在上一个视频中，我们展示了多区域<a class="ae jt" href="https://cloud.google.com/load-balancing/docs/https" rel="noopener ugc nofollow" target="_blank"> HTTP(S)负载平衡</a>如何使用区域瀑布算法将流量溢出到下一个最近实例所在的区域。这意味着当涉及到像Beyond Treat这样的全球电子商务网站时，使用全球负载平衡器而不是区域负载平衡器会特别有效。使用区域后端的应用程序名义上具有较低的延迟，但它们很容易过载。</p><p id="8dd4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们通过一个教程来进行真正的测试，该教程展示了云负载平衡如何优化您的全局应用程序容量，从而与大多数负载平衡实施相比，带来更好的用户体验和更低的成本。</p><p id="c4bb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本教程中，您将设置一个简单的web服务器，运行一个计算Mandelbrot集合的CPU密集型应用程序。</p><ol class=""><li id="ce43" class="kr ks hi iz b ja jb jd je jg kt jk ku jo kv js kw kx ky kz bi translated">首先，使用负载测试工具(httperf)测量单个区域中多个虚拟机实例的网络容量，并测量负载下的响应时间。</li><li id="d5c8" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated">然后使用全局负载平衡将网络扩展到多个区域，然后测量服务器在负载下的响应时间，并将其与单区域负载平衡进行比较。执行这一系列测试可以让您看到云负载平衡的跨区域负载管理的积极效果。</li></ol><h1 id="2996" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">你将学习和使用的东西</h1><ul class=""><li id="5012" class="kr ks hi iz b ja km jd kn jg lm jk ln jo lo js lp kx ky kz bi translated">了解如何使用负载测试工具(<a class="ae jt" href="https://github.com/httperf/httperf" rel="noopener ugc nofollow" target="_blank">ht perf</a>)。</li><li id="3e1e" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js lp kx ky kz bi translated">用单区域负载平衡测量过载的影响。</li><li id="a515" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js lp kx ky kz bi translated">使用全局负载平衡测量溢出到另一个区域的影响。</li></ul><p id="4cdd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您将使用:</p><ul class=""><li id="d260" class="kr ks hi iz b ja jb jd je jg kt jk ku jo kv js lp kx ky kz bi translated">计算引擎</li><li id="9258" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js lp kx ky kz bi translated">负载平衡和转发规则</li></ul><p id="ea13" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae jt" href="https://cloud.google.com/solutions/capacity-management-with-load-balancing" rel="noopener ugc nofollow" target="_blank"> <strong class="iz hj">此解决方案</strong> </a> <strong class="iz hj"> </strong>用于带负载均衡的容量管理</p><h1 id="bbeb" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">启动云外壳实例</h1><ol class=""><li id="f7fa" class="kr ks hi iz b ja km jd kn jg lm jk ln jo lo js kw kx ky kz bi translated">使用[PROJECT_ID]的项目ID设置您的默认项目:</li></ol><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="c504" class="lv jv hi lr b fi lw lx l ly lz">gcloud config set project [PROJECT_ID]</span></pre><p id="a1f1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.使用以下内容设置您的默认计算引擎区域(或替换为您的首选区域)，然后将其设置为环境变量供以后使用:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="8039" class="lv jv hi lr b fi lw lx l ly lz">gcloud config set compute/zone us-central1-c</span><span id="caa5" class="lv jv hi lr b fi ma lx l ly lz">export ZONE=us-central1-c</span></pre><h1 id="a995" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">创建并配置VPC网络。</h1><ol class=""><li id="6f44" class="kr ks hi iz b ja km jd kn jg lm jk ln jo lo js kw kx ky kz bi translated">创建用于测试的VPC网络:</li></ol><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="18d5" class="lv jv hi lr b fi lw lx l ly lz">gcloud compute networks create lb-testing --subnet-mode auto</span></pre><p id="b7f3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.定义防火墙规则以允许内部流量:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="3a10" class="lv jv hi lr b fi lw lx l ly lz">gcloud compute firewall-rules create lb-testing-internal \</span><span id="2456" class="lv jv hi lr b fi ma lx l ly lz">--network lb-testing --allow all --source-ranges 10.128.0.0/11</span></pre><p id="d7f2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.定义防火墙规则以允许SSH流量与VPC网络通信:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="fc15" class="lv jv hi lr b fi lw lx l ly lz">gcloud compute firewall-rules create lb-testing-ssh \</span><span id="86b3" class="lv jv hi lr b fi ma lx l ly lz">--network lb-testing --allow tcp:22 --source-ranges 0.0.0.0/0</span></pre><h1 id="8b1f" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">用单区域负载平衡器测量过载效应</h1><p id="d533" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">首先，让我们检查一下过载对单区域负载平衡器的影响，比如在本地使用的典型负载平衡器，或者在区域(而不是全局)部署中使用HTTP(S)负载平衡器。</p><figure class="lf lg lh li fd lj er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mb"><img src="../Images/aa33abaa2f9723c95ed62be5f3f182a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t7KjGI8osOTo-eBmKiICHA.png"/></div></div></figure><h2 id="ea75" class="lv jv hi bd jw mi mj mk ka ml mm mn ke jg mo mp kg jk mq mr ki jo ms mt kk mu bi translated">创建单区域HTTP(S)负载平衡器</h2><p id="15de" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">首先创建一个单区域HTTP(S)负载平衡器，具有3个固定大小的虚拟机实例。</p><ol class=""><li id="2b83" class="kr ks hi iz b ja jb jd je jg kt jk ku jo kv js kw kx ky kz bi translated">为安装Python Mandelbrot生成脚本的web服务器VM实例创建一个实例模板。在云Shell中运行以下命令:</li></ol><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="dac9" class="lv jv hi lr b fi lw lx l ly lz">gcloud compute instance-templates create webservers \</span><span id="0e98" class="lv jv hi lr b fi ma lx l ly lz">--machine-type n1-highcpu-4 \</span><span id="8cde" class="lv jv hi lr b fi ma lx l ly lz">--image-family=debian-10 --image-project=debian-cloud \</span><span id="46a8" class="lv jv hi lr b fi ma lx l ly lz">--tags=http-server \</span><span id="9ac6" class="lv jv hi lr b fi ma lx l ly lz">--network=lb-testing \</span><span id="d318" class="lv jv hi lr b fi ma lx l ly lz">--metadata startup-script='#! /bin/bash</span><span id="8fe8" class="lv jv hi lr b fi ma lx l ly lz">apt-get -y update</span><span id="62ff" class="lv jv hi lr b fi ma lx l ly lz">apt-get install -y git python-numpy python-matplotlib</span><span id="fc23" class="lv jv hi lr b fi ma lx l ly lz">git clone \</span><span id="c1fa" class="lv jv hi lr b fi ma lx l ly lz">https://github.com/GoogleCloudPlatform/lb-app-capacity-tutorial-python.git</span><span id="b76c" class="lv jv hi lr b fi ma lx l ly lz">cd lb-app-capacity-tutorial-python</span><span id="5635" class="lv jv hi lr b fi ma lx l ly lz">python webserver.py'</span></pre><p id="57ab" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.接下来，基于上一步中的模板创建一个包含3个实例的托管实例组:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="ad84" class="lv jv hi lr b fi lw lx l ly lz">gcloud compute instance-groups managed create webserver-region1 \</span><span id="124c" class="lv jv hi lr b fi ma lx l ly lz">--size=3 --template=webservers</span></pre><p id="d7ce" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.创建防火墙规则以允许从您自己的计算机对webserver实例进行外部访问:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="fc01" class="lv jv hi lr b fi lw lx l ly lz">gcloud compute firewall-rules create lb-testing-http \</span><span id="a1e6" class="lv jv hi lr b fi ma lx l ly lz">--network lb-testing --allow tcp:80 --source-ranges 0.0.0.0/0 \</span><span id="6355" class="lv jv hi lr b fi ma lx l ly lz">--target-tags http-server</span></pre><p id="5bb0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.创建设置<a class="ae jt" href="https://cloud.google.com/compute/docs/load-balancing/http#overview" rel="noopener ugc nofollow" target="_blank"> HTTP负载平衡</a>所需的健康检查、后端服务、URL映射、目标代理和全局转发规则:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="fc9e" class="lv jv hi lr b fi lw lx l ly lz">gcloud compute health-checks create http basic-check \</span><span id="24e2" class="lv jv hi lr b fi ma lx l ly lz">--request-path="/health-check" --check-interval=60s</span><span id="6a0e" class="lv jv hi lr b fi ma lx l ly lz">gcloud compute backend-services create web-service \</span><span id="eccf" class="lv jv hi lr b fi ma lx l ly lz">--health-checks basic-check --global</span><span id="694b" class="lv jv hi lr b fi ma lx l ly lz">gcloud compute backend-services add-backend web-service \</span><span id="952c" class="lv jv hi lr b fi ma lx l ly lz">--global --instance-group=webserver-region1 \</span><span id="ae7e" class="lv jv hi lr b fi ma lx l ly lz">--instance-group-zone $ZONE</span><span id="44a7" class="lv jv hi lr b fi ma lx l ly lz">gcloud compute url-maps create web-map --default-service web-service</span><span id="78be" class="lv jv hi lr b fi ma lx l ly lz">gcloud compute target-http-proxies create web-proxy --url-map web-map</span><span id="a1b2" class="lv jv hi lr b fi ma lx l ly lz">`</span><span id="216c" class="lv jv hi lr b fi ma lx l ly lz">gcloud compute forwarding-rules create web-rule --global \</span><span id="07fb" class="lv jv hi lr b fi ma lx l ly lz">--target-http-proxy web-proxy --ports 80</span></pre><p id="3818" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">5.获取转发规则的IP地址:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="1f79" class="lv jv hi lr b fi lw lx l ly lz">gcloud compute forwarding-rules describe --global web-rule --format "value(IPAddress)"</span></pre><p id="0089" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">输出是您创建的负载平衡器的公共IP地址。</p><p id="5174" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">6.在浏览器中，转到上一个命令返回的IP地址。等待几分钟，您应该会看到一个计算出的Mandelbrot集合。该映像由新创建的组中的一个虚拟机实例提供。</p><figure class="lf lg lh li fd lj er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mv"><img src="../Images/2e10b1d5bfce32986c041169a5d7f5cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*f1yOl8enU0gtBgu4"/></div></div></figure><h2 id="30aa" class="lv jv hi bd jw mi mj mk ka ml mm mn ke jg mo mp kg jk mq mr ki jo ms mt kk mu bi translated">使用负载测试来测试单区域负载平衡器</h2><ol class=""><li id="e3be" class="kr ks hi iz b ja km jd kn jg lm jk ln jo lo js kw kx ky kz bi translated">创建负载测试实例:</li></ol><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="ec2c" class="lv jv hi lr b fi lw lx l ly lz">gcloud compute instances create loadtest --machine-type n1-standard-1 \</span><span id="5702" class="lv jv hi lr b fi ma lx l ly lz">--network=lb-testing --image-family=debian-10 \</span><span id="9729" class="lv jv hi lr b fi ma lx l ly lz">--image-project=debian-cloud</span></pre><p id="2ab7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.在计算引擎实例页面上SSH到负载测试机器:</p><figure class="lf lg lh li fd lj er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mw"><img src="../Images/0546adbd3835d8ae58f7ef2182252c8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8YVKlJ-ouua9Wt89"/></div></div></figure><p id="5e43" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.在负载测试实例上，安装<a class="ae jt" href="https://github.com/httperf/httperf" rel="noopener ugc nofollow" target="_blank"> httperf </a>作为负载测试工具:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="db9c" class="lv jv hi lr b fi lw lx l ly lz">sudo apt-get install -y httperf</span></pre><p id="e3cc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.通过每秒发送各种请求(RPS)来测试服务器响应。确保您使用的RPS值至少在5到20的范围内。例如，以下命令生成10个RPS。将[IP地址]替换为步骤5中负载平衡器的IP地址。</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="477e" class="lv jv hi lr b fi lw lx l ly lz">httperf --server [IP_address] --num-conns 500 --rate 10 2&gt;&amp;1| grep 'Errors\|ion time'</span></pre><p id="acd2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您会看到类似如下的输出:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="98c7" class="lv jv hi lr b fi lw lx l ly lz">httperf --server 35.190.77.137 --num-conns 500 --rate 10 2&gt;&amp;1|</span><span id="3871" class="lv jv hi lr b fi ma lx l ly lz">grep 'Errors\|ion time'</span><span id="dd7a" class="lv jv hi lr b fi ma lx l ly lz">Connection time [ms]: min 418.6 avg 607.5 max 1963.5 median 522.5 stddev 249.2</span><span id="e9ab" class="lv jv hi lr b fi ma lx l ly lz">Connection time [ms]: connect 0.5</span><span id="9078" class="lv jv hi lr b fi ma lx l ly lz">Errors: total 0 client-timo 0 socket-timo 0 connrefused 0 connreset 0</span><span id="274e" class="lv jv hi lr b fi ma lx l ly lz">Errors: fd-unavail 0 addrunavail 0 ftab-full 0 other 0</span></pre><p id="7211" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当RPS的数量超过12或13时，响应延迟会显著增加。以下是典型结果的可视化:</p><figure class="lf lg lh li fd lj er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mx"><img src="../Images/7c7ad81eb56e187a8353a1be9f78eddd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MQgJSFAWtvWcOPDH"/></div></div></figure><p id="16d1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">5.注销负载测试虚拟机实例:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="085e" class="lv jv hi lr b fi lw lx l ly lz">exit</span></pre><p id="3942" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用单区域负载平衡器时，随着负载增加超过服务能力，平均请求延迟会达到峰值。对于10 RPS，平均请求延迟接近500毫秒，但对于20 RPS，延迟为5000毫秒。延迟增加了10倍，您的用户不会对应用程序超时感到满意。</p><p id="d59e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在下一节中，您将向负载平衡拓扑添加第二个区域，并比较跨区域故障转移如何影响最终用户延迟。</p><h1 id="369b" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">测量对另一个区域的溢出效应</h1><p id="21af" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">如果您使用带有HTTP(S)负载平衡的全局应用程序，并且如果您在<em class="my">多个区域</em>中部署了后端，那么当单个区域中的容量过载时，您会自动将流量溢出到另一个区域。让我们通过在另一个区域添加第二个VM实例组来测试这一点。</p><figure class="lf lg lh li fd lj er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mz"><img src="../Images/9a65491d17c2e24e440cba7e17d8ed38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yPZqOYQAn2UxGMr2YFqykA.png"/></div></div></figure><h2 id="6ac4" class="lv jv hi bd jw mi mj mk ka ml mm mn ke jg mo mp kg jk mq mr ki jo ms mt kk mu bi translated">在多个区域创建服务器</h2><p id="e3df" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">让我们在另一个区域添加另一组后端，并为每个区域分配10个RPS的容量。然后您可以看到当超过这个限制时负载平衡是如何反应的。</p><ol class=""><li id="4e8e" class="kr ks hi iz b ja jb jd je jg kt jk ku jo kv js kw kx ky kz bi translated">在Cloud Shell中，选择不同于默认区域的区域，并将其设置为环境变量:</li></ol><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="4db1" class="lv jv hi lr b fi lw lx l ly lz">export ZONE2=us-east1-b</span></pre><p id="497a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.在第二个区域中创建一个包含3个虚拟机实例的新实例组:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="de4e" class="lv jv hi lr b fi lw lx l ly lz">gcloud compute instance-groups managed create webserver-region2 \</span><span id="1871" class="lv jv hi lr b fi ma lx l ly lz">--size=3 --template=webservers --zone $ZONE2</span></pre><p id="bee1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.将实例组添加到最大容量为10 RPS的现有后端服务中:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="1f4e" class="lv jv hi lr b fi lw lx l ly lz">gcloud compute backend-services add-backend web-service \</span><span id="68b5" class="lv jv hi lr b fi ma lx l ly lz">--global --instance-group=webserver-region2 \</span><span id="1ae1" class="lv jv hi lr b fi ma lx l ly lz">--instance-group-zone $ZONE2 --max-rate 10</span></pre><p id="24b5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.将现有后端服务的最大速率调整为10 RPS:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="1973" class="lv jv hi lr b fi lw lx l ly lz">gcloud compute backend-services update-backend web-service \</span><span id="9baa" class="lv jv hi lr b fi ma lx l ly lz">--global --instance-group=webserver-region1 \</span><span id="6d40" class="lv jv hi lr b fi ma lx l ly lz">--instance-group-zone $ZONE --max-rate 10</span></pre><h2 id="643e" class="lv jv hi bd jw mi mj mk ka ml mm mn ke jg mo mp kg jk mq mr ki jo ms mt kk mu bi translated">使用负载测试来测试多区域负载平衡器</h2><ol class=""><li id="080b" class="kr ks hi iz b ja km jd kn jg lm jk ln jo lo js kw kx ky kz bi translated">所有实例启动后，SSH进入loadtest VM实例。</li><li id="cead" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated">以10 RPS运行500个请求。将[IP地址]替换为负载平衡器的IP地址:</li></ol><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="789c" class="lv jv hi lr b fi lw lx l ly lz">httperf --server [IP_address] --num-conns 500 --rate 10 2&gt;&amp;1| grep 'ion time'</span></pre><p id="fc1c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.您会看到如下结果:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="8da4" class="lv jv hi lr b fi lw lx l ly lz">Connection time [ms]: min 405.9 avg 584.7 max 1390.4 median 531.5 stddev</span><span id="eb26" class="lv jv hi lr b fi ma lx l ly lz">181.3</span><span id="304a" class="lv jv hi lr b fi ma lx l ly lz">Connection time [ms]: connect 1.1</span></pre><p id="2a46" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">结果类似于区域负载平衡器产生的结果。</p><p id="9265" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.因为您的测试工具会立即运行满负载，而不会像现实世界的实现那样缓慢增加负载，所以您必须重复测试几次，以使溢出机制生效。以20转/秒的速度运行500个请求5次。将[IP地址]替换为负载平衡器的IP地址。</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="70d4" class="lv jv hi lr b fi lw lx l ly lz">for a in \`seq 1 5\`; do httperf --server [IP_address] \</span><span id="ffbf" class="lv jv hi lr b fi ma lx l ly lz">--num-conns 500 --rate 20 2&gt;&amp;1| grep 'ion time' ; done</span></pre><p id="22d8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您会看到如下结果:</p><pre class="lf lg lh li fd lq lr ls lt aw lu bi"><span id="4252" class="lv jv hi lr b fi lw lx l ly lz">Connection time [ms]: min 426.7 avg 6396.8 max 13615.1 median 7351.5 stddev</span><span id="df22" class="lv jv hi lr b fi ma lx l ly lz">3226.8</span><span id="9f98" class="lv jv hi lr b fi ma lx l ly lz">Connection time [ms]: connect 0.9</span><span id="4886" class="lv jv hi lr b fi ma lx l ly lz">Connection time [ms]: min 417.2 avg 3782.9 max 7979.5 median 3623.5 stddev</span><span id="386e" class="lv jv hi lr b fi ma lx l ly lz">2479.8</span><span id="a750" class="lv jv hi lr b fi ma lx l ly lz">Connection time [ms]: connect 0.9</span><span id="939c" class="lv jv hi lr b fi ma lx l ly lz">Connection time [ms]: min 411.6 avg 860.0 max 3971.2 median 705.5 stddev 492.9</span><span id="8e78" class="lv jv hi lr b fi ma lx l ly lz">Connection time [ms]: connect 0.7</span><span id="32c9" class="lv jv hi lr b fi ma lx l ly lz">Connection time [ms]: min 407.3 avg 700.8 max 1927.8 median 667.5 stddev 232.1</span><span id="487e" class="lv jv hi lr b fi ma lx l ly lz">Connection time [ms]: connect 0.7</span><span id="01ab" class="lv jv hi lr b fi ma lx l ly lz">Connection time [ms]: min 410.8 avg 701.8 max 1612.3 median 669.5 stddev 209.0</span><span id="3431" class="lv jv hi lr b fi ma lx l ly lz">Connection time [ms]: connect 0.8</span></pre><p id="81d9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">系统稳定后，平均响应时间在10 RPS时为400 ms，在20 RPS时仅增加到700 ms。与区域负载平衡器提供的5000毫秒延迟相比，这是一个巨大的改进，并带来了更好的用户体验。</p><p id="f21a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下图显示了RPS使用全局负载平衡测量的响应时间:</p><figure class="lf lg lh li fd lj er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es na"><img src="../Images/0affc6403e0d005cc123c76db59363c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-xkgws_oI1qiemnn"/></div></div></figure><h1 id="1d7c" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">比较区域与全局负载平衡的结果</h1><blockquote class="nb"><p id="8cba" class="nc nd hi bd ne nf ng nh ni nj nk js dx translated">您刚刚探索了使用区域负载平衡和全局负载平衡时后端对容量的延迟影响！</p></blockquote><p id="fdc5" class="pw-post-body-paragraph ix iy hi iz b ja nl ij jc jd nm im jf jg nn ji jj jk no jm jn jo np jq jr js hb bi translated">当流量超过容量时，区域负载平衡解决方案就会过载，因为流量只能流向过载的后端虚拟机实例。这符合传统的本地负载平衡器、GCP上的网络负载平衡和单个区域中的HTTP(S)负载平衡的模式。平均延迟增加了10倍以上！</p><p id="0378" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">同时，多个区域中后端的全局HTTP(S)负载平衡允许流量溢出到具有可用服务容量的最近区域。这导致了终端用户延迟的可测量但相对较低的增加，并提供了更好的用户体验。如果您的应用程序不能在一个区域足够快地扩展，全局HTTP(S)负载平衡是最佳选择，因为流量可以重定向到其他区域，有助于避免全面服务中断。</p><p id="1eb7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">恭喜你。您刚刚比较了区域和全局HTTP负载平衡的性能！</p><figure class="lf lg lh li fd lj er es paragraph-image"><div class="er es nq"><img src="../Images/238551a94c68ac0f76fb12be987bde77.png" data-original-src="https://miro.medium.com/v2/resize:fit:520/0*Bdua_YPTnhGeo8i2"/></div></figure><p id="86af" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">关于这个食谱的更多信息，以及浏览完整的教程，请查看这个<a class="ae jt" href="https://cloud.google.com/solutions/capacity-management-with-load-balancing" rel="noopener ugc nofollow" target="_blank">解决方案</a>。</p><h1 id="5ec1" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">后续步骤和参考:</h1><ul class=""><li id="95b5" class="kr ks hi iz b ja km jd kn jg lm jk ln jo lo js lp kx ky kz bi translated">在<a class="ae jt" href="https://medium.com/google-cloud" rel="noopener">谷歌云平台媒体</a>上关注这个博客系列。</li><li id="9f33" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js lp kx ky kz bi translated">参考:<a class="ae jt" href="https://cloud.google.com/solutions/capacity-management-with-load-balancing" rel="noopener ugc nofollow" target="_blank">带负载平衡的容量管理</a></li><li id="3ea2" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js lp kx ky kz bi translated">跟随<a class="ae jt" href="https://www.youtube.com/watch?v=pxp7uYUjH_M" rel="noopener ugc nofollow" target="_blank">获取云端烹饪</a>视频系列，订阅谷歌云平台YouTube频道</li><li id="e31f" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js lp kx ky kz bi translated">想要更多的故事？在<a class="ae jt" rel="noopener" href="/@swongra">媒体</a>和<a class="ae jt" href="http://twitter.com/swongful" rel="noopener ugc nofollow" target="_blank">推特</a>上关注我。</li><li id="6de2" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js lp kx ky kz bi translated">请和我们一起欣赏这部迷你剧，并了解更多类似的谷歌云解决方案:)</li></ul></div></div>    
</body>
</html>