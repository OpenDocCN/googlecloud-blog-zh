<html>
<head>
<title>Automating creation, deployment of application and deletion of OKD 4.x Cluster in Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在谷歌云中自动创建、部署和删除OKD 4.x集群</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/automating-creation-deployment-of-application-and-deletion-of-okd-4-x-cluster-in-google-cloud-a375b8871902?source=collection_archive---------1-----------------------#2022-08-17">https://medium.com/google-cloud/automating-creation-deployment-of-application-and-deletion-of-okd-4-x-cluster-in-google-cloud-a375b8871902?source=collection_archive---------1-----------------------#2022-08-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/883474e3841b0623aaecb15008c92d30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h37tQ8ZHuGvExTXfrBqPUA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">谷歌云中的OKD 4.x</figcaption></figure><p id="e1f9" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">随着越来越多的人采用云，特别是采用多种云供应商，人们对在Google Cloud中自动安装和设置不同的Kubernetes风格越来越感兴趣。kubernetes的一个这样的redhat版本通常被称为OKD(Openshift)。</p><p id="a7a0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这篇文章讨论了一个这样的模块，它帮助自动创建okd集群，然后在这个okd集群上部署一个运行在google cloud上的应用程序。</p><p id="c9ed" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们从设置这个集群的可用选项开始。用户可以遵循两种方法:</p><ol class=""><li id="1b72" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated"><strong class="iw hj">用户调配的基础架构</strong> (UPI) —期望最终用户能够调配创建OKD集群所需的基础架构。</li><li id="d920" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><strong class="iw hj">安装程序提供的基础设施</strong>—okd提供的安装程序将帮助我们提供okd集群以及所需的基础设施，前提是在您的google cloud项目中满足使用该安装程序的所有先决条件。</li></ol><p id="21f7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">虽然第二种方法对于自动化OKD集群的安装和配置来说听起来很棒，但是仍然存在一些警告，比如执行一些手动步骤来满足先决条件。在设置之前和之后都需要执行这些手动步骤，以确保成功创建OKD集群，并在其中部署应用程序。</p><p id="8c54" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">此外，用户可能需要在不同OKD版本的不同GCP项目中创建多个okd集群。所有这些不同的组合可能会使状态和日志文件的管理变得困难。</p><p id="058a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为了解决上述问题，我们创建了一个模块，使开发人员和最终用户能够快速启动okd集群，而无需担心先决条件。</p><p id="90a7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">此模块使用terraform代码处理诸如确保组织策略、创建服务帐户、创建DNS区域等先决条件。</p><p id="8a92" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">以下是运行此代码的要求:</p><ol class=""><li id="c9dc" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">运行代码的用户必须拥有<code class="du kg kh ki kj b"><strong class="iw hj">owner</strong></code>权限。</li><li id="7206" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">你必须安装<code class="du kg kh ki kj b"><strong class="iw hj">oc cli , gcloud cli and terraform cli</strong></code>。</li><li id="158d" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">这里写的脚本在<code class="du kg kh ki kj b"><strong class="iw hj">linux machine</strong></code>中测试过，因此如果不使用bash，可能需要做一些修改。</li></ol><h1 id="0304" class="kk kl hi bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">部署步骤</h1><p id="3870" class="pw-post-body-paragraph iu iv hi iw b ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn lm jp jq jr hb bi translated"><strong class="iw hj">创建OKD集群</strong></p><ol class=""><li id="0936" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">Git克隆repo或复制该位置的文件夹(4.x文件夹)<a class="ae ln" href="https://github.com/google/shifter/tree/main/okd-cluster/4.x" rel="noopener ugc nofollow" target="_blank">https://github.com/google/shifter/tree/main/okd-cluster/4.x</a></li><li id="d76c" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">您必须更新<strong class="iw hj">强制变量</strong>部分下的<code class="du kg kh ki kj b">install.sh</code>中的变量。下面是这些变量的一个片段，以及应该替换的示例值。</li><li id="9c42" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">一旦变量被更新，你可以执行<code class="du kg kh ki kj b">install.sh</code><strong class="iw hj"><em class="lo">install . sh</em></strong>将允许你在同一个项目中创建多个集群或者在不同的项目中创建多个集群。</li><li id="1f05" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">每当创建一个公共区域时，我们必须确保该公共区域的<code class="du kg kh ki kj b">registrar-setup</code>已经正确执行。如果我们计划为多个okd集群使用单个项目，这将是一次性工作。作为安装过程的一部分，这些名称服务器的值将显示为输出，您可以参考这些值在您的注册商处进行配置。</li></ol><p id="e8da" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">链接</strong>更新域名服务器:<a class="ae ln" href="https://cloud.google.com/dns/docs/update-name-servers" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/dns/docs/update-name-servers</a></p><pre class="lp lq lr ls fd lt kj lu lv aw lw bi"><span id="7759" class="lx kl hi kj b fi ly lz l ma mb">PROJECT_ID=""                    #e.g. : "pm-okd-11"<br/>CLUSTER_NAME=""                  #e.g. : "okd-41"<br/>OKD_VERSION=""                   #e.g. : "4.10"<br/>BILLING_ACCOUNT_ID=""            #e.g. : "aaaaa-bbbbbb-ccccc"<br/>PARENT=""                        #e.g. : "organizations/111222333444"<br/>DOMAIN=""                        #e.g. : "your-domain.com."<br/>SSH_KEY_PATH=""                  #e.g. : usr/local/google/home/username/.ssh/id_ed25519.pub</span><span id="1c6b" class="lx kl hi kj b fi mc lz l ma mb"># More details on redhat pull secret can be found here <a class="ae ln" href="https://console.redhat.com/openshift/install/pull-secret" rel="noopener ugc nofollow" target="_blank">https://console.redhat.com/openshift/install/pull-secret</a></span><span id="ceae" class="lx kl hi kj b fi mc lz l ma mb">REDHAT_PULL_SECRET='{"auths":{"fake":{"auth":"aWQ6cGFzcwo="}}}'<br/>PROJECT_CREATE="false"           #make this as true if you want to create a new project under the PARENT</span></pre><p id="a41f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">输出</strong></p><p id="a5bc" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">成功执行<code class="du kg kh ki kj b">install.sh</code>后，集群详细信息如<strong class="iw hj">集群端点</strong>、<strong class="iw hj">用户名</strong>和<strong class="iw hj">密码</strong>将通过控制台日志共享，或者您也可以在日志和凭证的<code class="du kg kh ki kj b">okd-cluster/4.x/install-config/&lt;PROJECT_ID&gt;/&lt;CLUSTER_NAME&gt;</code>中找到这些详细信息，包括okd集群的KUBECONFIG。</p><p id="82f8" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">部署应用程序</strong></p><p id="5fd1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">集群自动化并没有就此结束，它还将一个示例微服务应用程序<code class="du kg kh ki kj b">bank-of-anthos</code>部署到您的集群上，以确保集群正常运行。部署应用程序后，它会显示已部署应用程序的端点。<br/>您可以访问这个端点，进一步探索部署在集群中的应用程序。<br/>安索斯银行<strong class="iw hj">链接</strong>:<a class="ae ln" href="https://github.com/GoogleCloudPlatform/bank-of-anthos" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/bank-of-anthos</a></p><p id="9d7b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">删除OKD集群<br/> </strong>一旦您在GCP尝试并测试了您的应用程序和OKD集群的部署，并且您不再需要该集群，那么您可以按照下面提到的步骤删除该集群。</p><ol class=""><li id="c42d" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">为了删除集群，我们将类似地更新出现在<code class="du kg kh ki kj b">destroy.sh</code>文件的MANDATORY_VARIABLES部分中的变量。我们必须确保下面列出的变量被正确更新。</li><li id="a4dc" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">执行<code class="du kg kh ki kj b">destroy.sh</code>将允许您删除集群。</li></ol><pre class="lp lq lr ls fd lt kj lu lv aw lw bi"><span id="bbd5" class="lx kl hi kj b fi ly lz l ma mb">########## Mandatory Variables ###########<br/>PROJECT_ID=””   # e.g. “pm-okd-11”<br/>CLUSTER_NAME=”” # e.g. ”okd-41"<br/>OKD_VERSION=””  # e.g. ”4.10"</span></pre><p id="f2c9" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">注意:</strong><code class="du kg kh ki kj b">destroy.sh</code>脚本使用在<code class="du kg kh ki kj b">install.sh</code>文件执行过程中创建的同一个<code class="du kg kh ki kj b">service-account-key.json</code>。如果这个<code class="du kg kh ki kj b">service-account-key.json</code>被删除，那么你可以按照下面提到的步骤创建一个替代的<code class="du kg kh ki kj b">service-account-key.json</code>。</p><pre class="lp lq lr ls fd lt kj lu lv aw lw bi"><span id="8142" class="lx kl hi kj b fi ly lz l ma mb">gcloud iam service-accounts keys create ${SA_JSON_FILENAME} --iam-account=okd-sa@${PROJECT_ID}.iam.gserviceaccount.com</span><span id="17b3" class="lx kl hi kj b fi mc lz l ma mb">   #gcloud iam service-accounts keys create service-account-key.json --iam-account=okd-sa@pm-okd-11.iam.gserviceaccount.com</span><span id="a0bf" class="lx kl hi kj b fi mc lz l ma mb">   mkdir ${CWD_PATH}/01-projectsetup/sa-keys/${PROJECT_ID}/</span><span id="0239" class="lx kl hi kj b fi mc lz l ma mb">   mv ${CWD_PATH}/${SA_JSON_FILENAME} ${CWD_PATH}/01-projectsetup/sa-keys/${PROJECT_ID}/</span></pre><p id="37c6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">本博客使用一个模块来帮助您自动创建OKD集群、在OKD集群中部署应用程序以及删除OKD集群(如果需要)。共享的模块目前支持OKD 4.9和OKD 4.10，但是代码完全可扩展以支持任何OKD 4.x版本。</p><p id="8cd2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">链接</strong>:<a class="ae ln" href="https://github.com/google/shifter/tree/main/okd-cluster/4.x" rel="noopener ugc nofollow" target="_blank">https://github.com/google/shifter/tree/main/okd-cluster/4.x</a></p><p id="4321" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">该模块是Shifter的一部分，使最终用户能够测试并将工作负载从Openshift迁移到Anthos。关于这个模块的更多细节可以在<a class="ae ln" href="https://github.com/google/shifter/tree/main/okd-cluster/4.x" rel="noopener ugc nofollow" target="_blank">https://github.com/google/shifter</a>找到</p><p id="3d9f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果您对本文中提供的自动化有任何疑问或建议，请随时联系我们。</p></div></div>    
</body>
</html>