<html>
<head>
<title>Running Eclipse HONO and Ditto on Google Cloud (3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在谷歌云上运行Eclipse HONO和Ditto)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/running-eclipse-hono-and-ditto-on-google-cloud-3-4a8919460c60?source=collection_archive---------1-----------------------#2022-08-20">https://medium.com/google-cloud/running-eclipse-hono-and-ditto-on-google-cloud-3-4a8919460c60?source=collection_archive---------1-----------------------#2022-08-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="776c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Eclipse Ditto是一种数字双胞胎服务，它允许您在云中创建一个双胞胎，并通过双胞胎与设备进行通信。</p><h1 id="627d" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">设置Eclipse同上</h1><p id="7cf6" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">为了让Eclipse Ditto与Eclipse HONO进行对话，首先我们在Eclipse Ditto中创建一个数字孪生兄弟。</p><p id="753c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我们创建一个数字孪生，代表具有温度和湿度两个属性的设备，稍后我们的设备将发送遥测数据来更新这些属性。</p><p id="b085" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，当调用Eclipse的REST API时，您指定一个用户名和密码作为凭证。Eclipse Ditto自带其认证和授权机制，详细内容请参考<a class="ae kg" href="https://www.eclipse.org/ditto/basic-auth.html" rel="noopener ugc nofollow" target="_blank"> Eclipse Ditto文档</a>。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="1cc7" class="kq je hi km b fi kr ks l kt ku">curl -X PUT -i -u ditto:ditto -H ‘Content-Type: application/json’ -d '{<br/>“attributes”: {<br/>“location”: “Taiwan”<br/>},<br/>“features”: {<br/>“temperature”: {<br/>“properties”: {<br/>“value”: null<br/>}<br/>},<br/>“humidity”: {<br/>“properties”: {<br/>“value”: null<br/>}}}}' <a class="ae kg" href="http://${DITTO_API_IP}:${DITTO_API_PORT_HTTP}/api/2/things/${TENANT_NAME}:${DEVICE_ID}" rel="noopener ugc nofollow" target="_blank">http://${DITTO_API_IP}:${DITTO_API_PORT_http}/api/2/things/${TENANT_NAME}:${DEVICE_ID}</a></span></pre><p id="b3db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该会看到下面的消息，表明数字孪生已成功创建。</p><figure class="kh ki kj kk fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es kv"><img src="../Images/7fe0eed4d6a6a745ef13e7496beb4552.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zBd-MDtpmCC9rThKcJGNUA.png"/></div></div></figure><p id="14f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以做一个HTTP GET来获得数字孪生配置。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="f1e2" class="kq je hi km b fi kr ks l kt ku">curl -i -u ditto:ditto <a class="ae kg" href="http://${DITTO_API_IP}:${DITTO_API_PORT_HTTP}/api/2/things/${TENANT_NAME}:${DEVICE_ID}" rel="noopener ugc nofollow" target="_blank">http://${DITTO_API_IP}:${DITTO_API_PORT_http}/api/2/things/${TENANT_NAME}:${DEVICE_ID}</a></span></pre><h1 id="d8c4" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">创建一个连接来连接Eclipse HONO和Eclipse同上</h1><p id="42da" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">下一步，我想让Eclipse HONO与Eclipse Ditto连接。Eclipse Ditto提供了<a class="ae kg" href="https://www.eclipse.org/ditto/connectivity-overview.html" rel="noopener ugc nofollow" target="_blank">连接API </a>来与外部系统集成。但是在我创建连接来集成双方之前，让我们先看看Eclipse Ditto和HONO是如何处理传入消息的。</p><p id="7b28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当一个设备通过MQTT协议向Eclipse HONO发送遥测数据时，它会转到Eclipse HONO MQTT适配器，根据安装步骤，消息随后会被发送到<a class="ae kg" href="https://www.eclipse.org/hono/docs/getting-started" rel="noopener ugc nofollow" target="_blank"> AMQP网络或Kafka </a>进行进一步路由。在我们的例子中，我们将把这些遥测路由到Eclipse Ditto，它接受Eclipse Ditto协议消息格式。</p><p id="5c61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，在我们将遥测路由到Eclipse Ditto之前，我们首先需要定义一个映射，将来自设备的遥测映射到Ditto协议。为了简单起见，我假设设备总是以下面的格式发送JSON消息</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="8e97" class="kq je hi km b fi kr ks l kt ku">{ “temp”: 20.5, “hum”:50}</span></pre><p id="99af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Eclipse Ditto中，可以定义一个JavaScript函数来映射消息。下面是简单的JavaScript函数。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="7b87" class="kq je hi km b fi kr ks l kt ku">function mapToDittoProtocolMsg(<br/>   headers, <br/>   textPayload, <br/>   bytePayload, <br/>   contentType) <br/>{<br/>   if (contentType !== "application/json") { return null; }<br/>   var jsonData = JSON.parse(textPayload);<br/>   var temperature = jsonData.temp;<br/>   var humidity = jsonData.hum;<br/>   var path;<br/>   var value;<br/>   <br/>   if (temperature != null &amp;&amp; humidity != null) {<br/>      path = "/features";<br/>      value = {<br/>         temperature: <br/>            { <br/>               properties: { value: temperature } <br/>            }, <br/>         humidity: { properties: { value: humidity } }<br/>      };<br/>   } else if (temperature != null) {<br/>      path = "/features/temperature/properties/value";<br/>      value = temperature;<br/>   } else if (humidity != null) {<br/>      path = "/features/humidity/properties/value";<br/>      value = humidity;<br/>   }<br/>   if (!path || !value) {<br/>      return null;<br/>   }</span><span id="3640" class="kq je hi km b fi ld ks l kt ku">   return Ditto.buildDittoProtocolMsg(<br/>            "org.eclipse.ditto2",<br/>            headers["device_id"].split(":")[1],<br/>            "things",<br/>            "twin",<br/>            "commands",<br/>            "modify",<br/>            path,<br/>            headers,<br/>            value<br/>   );<br/>}</span></pre><p id="91e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们仔细看看这些代码。</p><p id="bd3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，代码检查内容类型是否是<em class="le">应用程序/json。</em>在我们的例子中，我们只处理JSON消息，所以如果内容类型不是JSON消息，我们就简单地丢弃它。注意，这也意味着在我们的设备代码中，我们需要指定内容类型头。</p><p id="92bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，一旦我们有了消息体，我们就开始解析消息并获取所需的信息，在本例中，<em class="le"> temp </em>和<em class="le"> hum。</em></p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="48f5" class="kq je hi km b fi kr ks l kt ku">var jsonData = JSON.parse(textPayload);<br/>var temperature = jsonData.temp;<br/>var humidity = jsonData.hum;</span></pre><p id="bc38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们指定<em class="le">路径</em>值，该路径与我们之前创建的数字孪生属性一致。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="63b4" class="kq je hi km b fi kr ks l kt ku">   } else if (temperature != null) {<br/>      path = "/features/temperature/properties/value";<br/>      value = temperature;<br/>   } else if (humidity != null) {<br/>      path = "/features/humidity/properties/value";<br/>      value = humidity;</span></pre><p id="ed29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们创建Ditto协议消息，注意第二个参数是Eclipse Ditto中的设备id，在我们的例子中是<em class="le"> demo-device-001 </em>。当遥测数据从设备发送到Eclipse HONO时，设备id采用<em class="le">$ {租户名称}:$ {设备ID} </em>格式，因此我们在这里进行字符串拆分以提取设备ID。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="2584" class="kq je hi km b fi kr ks l kt ku">return Ditto.buildDittoProtocolMsg(<br/>            "org.eclipse.ditto2",<br/>            headers["device_id"].split(":")[1],<br/>            "things",<br/>            "twin",<br/>            "commands",<br/>            "modify",<br/>            path,<br/>            headers,<br/>            value<br/>   );</span></pre><p id="b34c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了给Connection添加映射函数，我们对它做了一个JSON.stringify()，所以值变成了这个。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="85a7" class="kq je hi km b fi kr ks l kt ku">“function mapToDittoProtocolMsg(\n headers,\n textPayload,\n bytePayload,\n contentType\n) {\n\n if (contentType !== \”application/json\”) {\n return null;\n }\n\n var jsonData = JSON.parse(textPayload);\n var temperature = jsonData.temp;\n var humidity = jsonData.hum;\n \n var path;\n var value;\n if (temperature != null &amp;&amp; humidity != null) {\n path = \”/features\”;\n value = {\n temperature: {\n properties: {\n value: temperature\n }\n },\n humidity: {\n properties: {\n value: humidity\n }\n }\n };\n } else if (temperature != null) {\n path = \”/features/temperature/properties/value\”;\n value = temperature;\n } else if (humidity != null) {\n path = \”/features/humidity/properties/value\”;\n value = humidity;\n }\n \n if (!path || !value) {\n return null;\n }\n\n return Ditto.buildDittoProtocolMsg(\n \”org.eclipse.ditto2\”,\n headers[\”device_id\”].split(\”:\”)[1],\n \”things\”,\n \”twin\”,\n \”commands\”,\n \”modify\”,\n path,\n headers,\n value\n );\n}”</span></pre><p id="0157" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们有了映射函数，让我们创建连接来连接Eclipse HONO和Eclipse Ditto。</p><p id="428a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意到</p><ul class=""><li id="93e5" class="lf lg hi ih b ii ij im in iq lh iu li iy lj jc lk ll lm ln bi translated">调用create connection时，我们使用devops:devopsPw1！作为凭证。</li><li id="5b16" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">连接监听AMQP网络，网络的URL在<em class="le">“uri”中指定。</em></li><li id="7a6e" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">连接id，<em class="le"> hono-sandbox-connection，</em>将被用作MQTT客户机Id的一部分，记下这个Id，我们将在以后使用它。</li></ul><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="d00e" class="kq je hi km b fi kr ks l kt ku">curl -X POST -i -u devops:devopsPw1! -H 'Content-Type: application/json' -d '{<br/>"targetActorSelection": "/system/sharding/connection",<br/>"headers": {<br/>"aggregate": false<br/>},<br/>"piggybackCommand": {<br/>"type": "connectivity.commands:createConnection",<br/>"connection": {<br/>"id": "hono-sandbox-connection",<br/>"connectionType": "amqp-10",<br/>"connectionStatus": "open",<br/>"uri": "amqp://consumer%40HONO:verysecret@'${AMQP_NETWORK_IP}:${AMQP_NETWORK_PORT_amqp}'",<br/>"failoverEnabled": true,<br/>"sources": [{<br/>"addresses": [<br/>"telemetry/org.eclipse.ditto",<br/>"event/org.eclipse.ditto"<br/>],<br/>"authorizationContext": ["nginx:ditto"]<br/>}],<br/>"mappingContext": {<br/>"mappingEngine": "JavaScript",<br/>"options": {<br/>"incomingScript": "function mapToDittoProtocolMsg(\n    headers,\n    textPayload,\n    bytePayload,\n    contentType\n) {\n\n    if (contentType !== \"application/json\") {\n        return null;\n    }\n\n    var jsonData = JSON.parse(textPayload);\n    var temperature = jsonData.temp;\n    var humidity = jsonData.hum;\n    \n    var path;\n    var value;\n    if (temperature != null &amp;&amp; humidity != null) {\n        path = \"/features\";\n        value = {\n                temperature: {\n                    properties: {\n                        value: temperature\n                    }\n                },\n                humidity: {\n                    properties: {\n                        value: humidity\n                    }\n                }\n            };\n    } else if (temperature != null) {\n        path = \"/features/temperature/properties/value\";\n        value = temperature;\n    } else if (humidity != null) {\n        path = \"/features/humidity/properties/value\";\n        value = humidity;\n    }\n    \n    if (!path || !value) {\n        return null;\n    }\n\n    return Ditto.buildDittoProtocolMsg(\n        \"org.eclipse.ditto2\",\n        headers[\"device_id\"].split(\":\")[1],\n        \"things\",\n        \"twin\",\n        \"commands\",\n        \"modify\",\n        path,\n        headers,\n        value\n    );\n}"}}}}}' http://${DITTO_API_IP}:${DITTO_API_PORT_http}/devops/piggyback/connectivity?timeout=8s</span></pre><p id="1478" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要验证连接是否成功创建，您需要执行一个检索连接API调用。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="eea9" class="kq je hi km b fi kr ks l kt ku">curl -X POST -i -u devops:devopsPw1! -H ‘Content-Type: application/json’ -d '{<br/>“targetActorSelection”: “/system/sharding/connection”,<br/>“headers”: {},<br/>“piggybackCommand”: {<br/>“type”: “connectivity.commands:retrieveConnection”,<br/>“connectionId”: “hono-sandbox-connection”<br/>}<br/>}'<br/><a class="ae kg" href="http://${DITTO_API_IP}:${DITTO_API_PORT_http}/devops/piggyback/connectivity?timeout=8s" rel="noopener ugc nofollow" target="_blank">http://${DITTO_API_IP}:${DITTO_API_PORT_http}/devops/piggyback/connectivity?timeout=8s</a></span></pre><p id="de3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要验证连接是否正常运行，请运行HTTP客户端提交遥测数据。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="0c0e" class="kq je hi km b fi kr ks l kt ku">curl -X POST -i -u ${DEVICE_ID}-auth@${TENANT_NAME}:my-password -H ‘Content-Type: application/json’ -d ‘{“temp”: 33.07}’ <a class="ae kg" rel="noopener ugc nofollow" target="_blank" href="/${HTTP_ADAPTER_IP}:${HTTP_ADAPTER_PORT_HTTP}/telemetry">http://${HTTP_ADAPTER_IP}:${HTTP_ADAPTER_PORT_http}/telemetry</a></span></pre><p id="28f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您获取连接度量来检查遥测是否被路由到Eclipse Ditto。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="acdf" class="kq je hi km b fi kr ks l kt ku">curl -X POST -i -u devops:devopsPw1! -H ‘Content-Type: application/json’ -d ‘{<br/>“targetActorSelection”: “/system/sharding/connection”,<br/>“headers”: {},<br/>“piggybackCommand”: {<br/>“type”: “connectivity.commands:retrieveConnectionMetrics”,<br/>“connectionId”: “hono-sandbox-connection”<br/>}<br/>}’<br/><a class="ae kg" href="http://${DITTO_API_IP}:${DITTO_API_PORT_http}/devops/piggyback/connectivity?timeout=8s" rel="noopener ugc nofollow" target="_blank">http://${DITTO_API_IP}:${DITTO_API_PORT_http}/devops/piggyback/connectivity?timeout=8s</a></span></pre><p id="9065" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">至此，我们已经成功地集成了Eclipse HONO和Eclipse Ditto。在下一篇博客中，我将集成Eclipse Ditto和Google Cloud功能。</p><p id="b7a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae kg" rel="noopener" href="/google-cloud/running-eclipse-hono-and-ditto-on-google-cloud-4-308c61735d47">第四部分</a></p></div></div>    
</body>
</html>