<html>
<head>
<title>Stackdriver Monitoring Automation Part 1: Stackdriver Groups</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">堆栈驱动程序监控自动化第1部分:堆栈驱动程序组</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/stackdriver-monitoring-automation-part-1-stackdriver-groups-8e51f0aa9b03?source=collection_archive---------1-----------------------#2018-09-28">https://medium.com/google-cloud/stackdriver-monitoring-automation-part-1-stackdriver-groups-8e51f0aa9b03?source=collection_archive---------1-----------------------#2018-09-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="eda0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">许多开发人员和组织认识到自动化对于云基础设施和应用的长期管理至关重要。刚刚开始使用Stackdriver Monitoring的开发人员、站点可靠性工程师和运营团队可能想知道哪些组件可以用于自动化。我最近经历了为组织内创建的每个新项目自动创建Stackdriver监控组件的练习。</p><p id="faa8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个系列中，我已经包括了我所采取的步骤和我用来创建自动化的方法。您可以使用这些步骤在您的环境中自动部署Stackdriver监控资源。这篇文章涉及堆栈驱动组，而第二部分和第三部分<a class="ae jd" rel="noopener" href="/google-cloud/stackdriver-monitoring-automation-part-3-uptime-checks-476b8507f59c">分别涉及警报策略和正常运行时间检查。</a></p><h1 id="97f7" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">堆栈驱动程序监控中有哪些自动化功能？</h1><p id="117b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">以下组件可通过API获得，因此可用于自动化。</p><ul class=""><li id="a3fd" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">堆栈驱动程序组</li><li id="eeac" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">警报策略</li><li id="f2aa" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">正常运行时间检查</li></ul><p id="8df4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Stackdriver监控API可以通过<a class="ae jd" href="https://cloud.google.com/monitoring/api/ref_v3/rest/" rel="noopener ugc nofollow" target="_blank"> REST API </a>和<a class="ae jd" href="https://cloud.google.com/monitoring/api/ref_v3/rpc/" rel="noopener ugc nofollow" target="_blank"> gRPC </a>获得。相同的REST APIs可以用在<a class="ae jd" href="https://cloud.google.com/deployment-manager/docs/" rel="noopener ugc nofollow" target="_blank">Google Cloud Deployment Manager</a>甚至是<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/" rel="noopener ugc nofollow" target="_blank"> gcloud </a>命令行中。使用Deployment Manager可以轻松地将配置视为代码，并进一步自动化Stackdriver监控组件的管理。我使用部署管理器来实现自动化。</p><h1 id="b327" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">1.先决条件</h1><p id="313c" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">首先，我设置了一个Stackdriver工作区和至少一个与该工作区相关联的GCP项目。在2018年9月12日之前，工作区以前称为Stackdriver帐户。更多详情见这篇<a class="ae jd" href="https://cloud.google.com/blog/products/management-tools/using-stackdriver-workspaces-help-manage-your-hybrid-and-multicloud-environment" rel="noopener ugc nofollow" target="_blank">博文</a>。</p><p id="2c90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用了一个GCP环境，其中已经使用了许多不同的组件，包括云存储、BigQuery、计算引擎、Kubernetes引擎、云函数和云ML引擎。使用一个有许多组件在使用的环境使我更容易监控组件。</p><h1 id="7ba1" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated"><strong class="ak"> 2。堆栈驱动程序组</strong></h1><p id="be21" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/groups/" rel="noopener ugc nofollow" target="_blank"> Stackdriver Groups </a>允许您在Stackdriver Monitoring中定义和监控资源的逻辑组。这些包括资源，如虚拟机实例和容器。然后，可以使用组作为单个实体来监控一组资源。组还可以包括子组，这些子组可用于在逻辑上构建组层次结构。</p><p id="9fdd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，我创建了一个组来监视与运行在GCE上的一组apache实例相关的所有资源。当我部署GCE资源时，我向每个GCE实例添加了标记app:website，env:prod。您可以在下面看到贴在实例上的标签。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="ce87" class="le jf hi la b fi lf lg l lh li">$ gcloud compute instances describe wwwhttp11 --zone us-west1-b</span><span id="9d66" class="le jf hi la b fi lj lg l lh li">canIpForward: false<br/>cpuPlatform: Intel Broadwell<br/>creationTimestamp: '2018-09-24T13:16:33.497-07:00'<br/>deletionProtection: false<br/>...<br/>id: '1488468442473625840'<br/>kind: compute#instance<br/>labelFingerprint: FrEu9_zPopQ=<br/><strong class="la hj">labels:<br/>  app: website<br/>  env: prod</strong></span></pre><p id="6697" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，当我创建Stackdriver组时，我可以过滤标签，以包括组中的那些特定资源。这也突出了群体的动态能力。我也可以使用名称或资源类型进行过滤。我还根据env标签将这些组分成子组，这允许我按照环境隔离apache实例。</p><p id="a529" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.groups/create" rel="noopener ugc nofollow" target="_blank">projects . groups . create</a>API列出了创建组所需的以下值。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="3cb7" class="le jf hi la b fi lf lg l lh li">{<br/> “name”: string,<br/> “displayName”: string,<br/> “parentName”: string,<br/> “filter”: string,<br/> “isCluster”: boolean<br/>}</span></pre><p id="3446" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用了<a class="ae jd" href="https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.groups/create" rel="noopener ugc nofollow" target="_blank">项目.组.创建</a>文档中的“尝试这个API”侧栏来测试这个API，确保我有正确的值。这是在将配置值添加到部署管理器或通过代码添加之前检查配置值的一种简单方法。</p><p id="2bf8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用以下值来测试创建一个简单的组:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="db42" class="le jf hi la b fi lf lg l lh li">{<br/>  "displayName": “Apache test”,<br/>  "parentName": “”,<br/>  "filter":”metadata.user_labels.app=has_substring(\"website\")”,<br/>  "isCluster": false<br/>}</span></pre><p id="3d42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“尝试这个API”过程很适合测试API，尽管我想创建一个我可以自动化的可重复的过程。这就是部署管理器的用武之地。我创建了部署管理器配置文件来为projects.groups.create API提供值。我将模板分为jinja模板和yaml文件，这样我就可以为任何其他组重用jinja模板。</p><p id="b06f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> stackdriver_groups.jinja </strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="2c8a" class="le jf hi la b fi lf lg l lh li">resources:<br/>- name:  {{ env["name"] }}<br/>  type: gcp-types/monitoring-v3:projects.groups <br/>  properties:<br/>    name: "projects/{{ env["project"] }}"<br/>    displayName: {{ properties["group_display_name"] }}<br/>    parentName: "{{ properties["group_parent_name"] }}" <br/>    filter: {{ properties["group_filter"] }}<br/>    isCluster: {{ properties["group_is_cluster"] }}</span></pre><p id="22df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，我在yaml文件中创建了3个独立的组:Apache、prod和qa。基于app=website标签，所有apache实例都包含在Apache组中。只有标有env=qa和env=prod的实例分别包含在qa和prod组中。qa和prod组将Apache指定为父组，这告诉Stackdriver Monitoring这些是子组。</p><p id="42fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> stackdriver_groups.yaml </strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="5a06" class="le jf hi la b fi lf lg l lh li">imports: <br/>- path: stackdriver_groups.jinja<br/>resources:<br/>- name: create-apache-group<br/>  type: stackdriver_groups.jinja <br/>  properties:<br/>    group_display_name: "Apache"<br/>    group_parent_name: ""<br/>    group_filter: "metadata.user_labels.app=has_substring(\"website\")"<br/>    group_is_cluster: false<br/>- name: create-apache-prod-group<br/>  type: stackdriver_groups.jinja<br/>  properties:<br/>    group_display_name: "prod"<br/>    group_parent_name: $(ref.create-apache-group.name)<br/>    group_filter: "metadata.user_labels.env=\"prod\""<br/>    group_is_cluster: false<br/>    metadata:<br/>      dependsOn:<br/>        create-apache-group<br/>- name: create-apache-qa-group<br/>  type: stackdriver_groups.jinja<br/>  properties:<br/>    group_display_name: "qa"<br/>    group_parent_name: $(ref.create-apache-group.name)<br/>    group_filter: "metadata.user_labels.env=\"qa\""<br/>    group_is_cluster: false<br/>    metadata:<br/>      dependsOn:<br/>        create-apache-group</span></pre><p id="1e65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在<a class="ae jd" href="https://github.com/charlesbaer/stackdriver-automation" rel="noopener ugc nofollow" target="_blank"> github repo </a>上找到jinja和yaml文件。</p><p id="d1fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后一步是使用下面的gcloud命令行，通过部署管理器实际创建Stackdriver组。我首先使用了<code class="du lk ll lm la b">--preview</code>命令行参数来确保部署配置正确。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="b270" class="le jf hi la b fi lf lg l lh li">$ gcloud deployment-manager deployments create apachegroup --config stackdriver_groups.yaml --preview</span><span id="87b8" class="le jf hi la b fi lj lg l lh li">The fingerprint of the deployment is nm2-shmY2Oj2tDQfCc4__g==<br/>Waiting for create [operation-1538010937030-576d0138ff573-f3a4b3a2-a3ed8f5c]...done.<br/>Create operation operation-1538010937030-576d0138ff573-f3a4b3a2-a3ed8f5c completed successfully.<br/>NAME                      TYPE                                     STATE       ERRORS  INTENT<br/>create-apache-group       gcp-types/monitoring-v3:projects.groups  IN_PREVIEW  []      CREATE_OR_ACQUIRE<br/>create-apache-prod-group  gcp-types/monitoring-v3:projects.groups  IN_PREVIEW  []      CREATE_OR_ACQUIRE<br/>create-apache-qa-group    gcp-types/monitoring-v3:projects.groups  IN_PREVIEW  []      CREATE_OR_ACQUIRE</span></pre><p id="ba22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置没有产生任何错误，所以我提交了创建部署的命令。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="8947" class="le jf hi la b fi lf lg l lh li">$ gcloud deployment-manager deployments create apachegroup --config stackdriver_groups.yaml</span><span id="67d7" class="le jf hi la b fi lj lg l lh li">Create operation operation-1537807543251-576a0b8593038-2a7c079e-38f54092 completed successfully.<br/>NAME                      TYPE                                     STATE      ERRORS  INTENT<br/>create-apache-group       gcp-types/monitoring-v3:projects.groups  COMPLETED  []<br/>create-apache-prod-group  gcp-types/monitoring-v3:projects.groups  COMPLETED  []<br/>create-apache-qa-group    gcp-types/monitoring-v3:projects.groups  COMPLETED  []</span></pre><p id="e236" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦创建了组，我就使用Stackdriver监控控制台来验证Apache、qa和prod组是否已经成功创建。请注意，prod和qa子组出现在Apache组下。</p><figure class="kv kw kx ky fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es ln"><img src="../Images/67c0c26eb5a6f509b346989da9278d14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NN1Jqz-TR8L2_U9y"/></div></div></figure><p id="fe22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本系列的第1部分到此结束。在本系列的其他文章和下面的参考资料中阅读更多关于Stackdriver监控自动化的内容。</p><ul class=""><li id="5bf8" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae jd" rel="noopener" href="/@charles.baer/stackdriver-automation-part-2-alerting-policies-9f42068603c4">堆栈驱动自动化第2部分:堆栈驱动警报策略</a></li><li id="6cce" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" rel="noopener" href="/@charles.baer/stackdriver-automation-part-3-uptime-checks-476b8507f59c">堆栈驱动自动化第3部分:堆栈驱动正常运行时间检查</a></li></ul><p id="9e2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考资料:</p><ul class=""><li id="b097" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/docs/" rel="noopener ugc nofollow" target="_blank">堆栈驱动监控文件</a></li><li id="713d" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/api/ref_v3/rest/" rel="noopener ugc nofollow" target="_blank">栈驱动监控API文档</a></li><li id="3666" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/api/v3/filters" rel="noopener ugc nofollow" target="_blank">堆栈驱动监控过滤器</a></li><li id="9222" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/api/metrics_gcp" rel="noopener ugc nofollow" target="_blank">堆栈驱动程序监控指标</a></li><li id="4f2e" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://cloud.google.com/deployment-manager/docs/" rel="noopener ugc nofollow" target="_blank">谷歌云部署管理器</a></li><li id="ec80" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://github.com/GoogleCloudPlatform/deploymentmanager-samples" rel="noopener ugc nofollow" target="_blank">部署管理器示例</a></li></ul></div></div>    
</body>
</html>