<html>
<head>
<title>Active Directory Setup with Kerberized Dataproc Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kerberized化的Dataproc集群设置Active Directory</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/active-directory-setup-with-kerberized-dataproc-cluster-dd0da6987d7d?source=collection_archive---------1-----------------------#2021-02-16">https://medium.com/google-cloud/active-directory-setup-with-kerberized-dataproc-cluster-dd0da6987d7d?source=collection_archive---------1-----------------------#2021-02-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1f94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在之前的<a class="ae jd" rel="noopener" href="/google-cloud/getting-started-with-kerberized-dataproc-clusters-with-cross-realm-trust-222d991660dd">帖子</a>中，我们提供了一个terraform模块，用于使用Kerberos部署Dataproc集群，并与麻省理工学院KDC分校合作管理用户/服务帐户主体。虽然麻省理工学院KDC分校提供了快速运行的能力，但在企业中更常见的是使用现有的身份管理系统，如Active Directory，用于管理用户和服务帐户主体，以便通过Hadoop进行身份验证。</p><p id="f8ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然我们可以使用terraform自动完成这一部署，但在本文中，我们将手动完成以下步骤，以熟悉这些概念。</p><ol class=""><li id="3258" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">安装Active Directory域服务(域控制器)</li><li id="c037" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">创建一个对AD DS单向信任的Dataproc集群</li><li id="ee63" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">创建一个带有密码的用户和一个带有密钥表的服务账户主体(存储在<a class="ae jd" href="https://cloud.google.com/secret-manager" rel="noopener ugc nofollow" target="_blank">秘密管理器</a>中)用于认证</li><li id="e84f" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">在演示身份验证的Dataproc中运行Hadoop命令</li></ol><blockquote class="js jt ju"><p id="ad53" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated"><strong class="ih hj">重要提示:</strong>本指南不涵盖部署最佳实践，包括安全性、高可用性、混合体系结构、VPC以及生产环境所必需的其他要素。参见<a class="ae jd" href="https://cloud.google.com/managed-microsoft-ad/docs/best-practices" rel="noopener ugc nofollow" target="_blank">在Google Cloud上运行活动目录的最佳实践</a>和<a class="ae jd" href="https://cloud.google.com/solutions/deploy-fault-tolerant-active-directory-environment" rel="noopener ugc nofollow" target="_blank">部署容错的微软活动目录环境</a>开始。</p></blockquote><h1 id="53c4" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">概观</h1><p id="714e" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">下图和配置描述了此示例的部署。它包含一个沙箱活动目录服务器，具有跨领域信任和Dataproc，并利用Secrets Manager存储非人类帐户的密钥表。我们通过对所有组件使用单个GCP项目来简化我们的示例，但是在真实世界场景中应该设置单独的项目、专用网络和防火墙。</p><p id="6954" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AD和Dataproc领域的域:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="5c41" class="ll ka hi lh b fi lm ln l lo lp"><strong class="lh hj">Active Directory Domain</strong>: FOO.INTERNAL<br/><strong class="lh hj">Server Instance:</strong>         active-directory-2016</span><span id="960a" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj">Dataproc Cluster Realm:</strong>  ANALYTICS.FOO.INTERNAL<br/><strong class="lh hj">Dataproc Cluster:</strong>        analytics-cluster</span></pre><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es lr"><img src="../Images/7c9d45818bbf23f5eaa7e15543bfad6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BOUkYUHwzt5CT_84cyAk1Q.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[带有AD Kerberos身份验证的Dataproc单向信任]</figcaption></figure><p id="f533" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述架构包含以下关键方面:</p><ul class=""><li id="76b3" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc md jk jl jm bi translated">Active Directory企业服务器中的用户/服务帐户</li><li id="0454" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc md jk jl jm bi translated">Dataproc服务主体由集群上的KDC管理。不需要在AD中创建任何服务主体。</li><li id="cca5" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc md jk jl jm bi translated">在创建Dataproc集群之前，可以在Active Directory中创建单向信任。这为临时集群动态加入AD提供了灵活性。</li><li id="9c36" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc md jk jl jm bi translated">Secrets manager用于存储/旋转由Active Directory管理员添加的keytabs，仅可由Analytics Dataproc集群管理员访问。</li></ul><h1 id="0fa4" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">先决条件</h1><p id="26b6" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">在我们的项目中设置Windows和Dataproc GCE实例需要以下先决条件。我们将不涉及设置VPC和前面提到的其他方面。以下步骤可以在云壳或者本地终端执行。</p><p id="cad4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1。设置环境/帐户(根据需要修改)</strong> : <br/>创建您的GCP项目(在我们的示例中使用了<em class="jv"> ad-kerberos </em>)，<a class="ae jd" href="https://cloud.google.com/sdk/docs/initializing" rel="noopener ugc nofollow" target="_blank">初始化您的gcloud sdk </a>，设置默认的<a class="ae jd" href="https://cloud.google.com/compute/docs/gcloud-compute#set_default_zone_and_region_in_your_local_client" rel="noopener ugc nofollow" target="_blank">区域/区域</a>，让我们开始吧。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="6ed7" class="ll ka hi lh b fi lm ln l lo lp"><strong class="lh hj"># properties</strong><br/>export PROJECT=$(gcloud info --format='value(config.project)')<br/>export ZONE=$(gcloud info --format='value(config.properties.compute.zone)')<br/>export REGION=${ZONE%-*}<br/>export SUBNETWORK=default<br/>export BUCKET_SECRETS=${PROJECT}-us-dataproc-secrets</span><span id="27d0" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># gcp admin / service accounts</strong><br/>export GCP_ADMIN=$(gcloud info --format='value(config.account)')<br/>export SERVICE_ACCOUNT_AD=active-directory-sa<br/>export SERVICE_ACCOUNT_DL=dataproc-analytics-cluster-sa</span><span id="e318" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># create gcp service account for </strong><a class="ae jd" href="https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/service-accounts" rel="noopener ugc nofollow" target="_blank"><strong class="lh hj">dataproc</strong></a><strong class="lh hj"> cluster<br/></strong>gcloud iam service-accounts create "${SERVICE_ACCOUNT_DL}" \<br/>  --description="dataproc sa" \<br/>  --display-name=${SERVICE_ACCOUNT_DL}</span><span id="211a" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># create gcp service account for active directory </strong><a class="ae jd" href="https://cloud.google.com/compute/docs/access/service-accounts" rel="noopener ugc nofollow" target="_blank"><strong class="lh hj">gce instance</strong></a><br/>gcloud iam service-accounts create ${SERVICE_ACCOUNT_AD} \<br/>  --description="active directory sa" \<br/>  --display-name=${SERVICE_ACCOUNT_AD}</span><span id="d786" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># enable </strong><a class="ae jd" href="https://cloud.google.com/vpc/docs/configure-private-google-access" rel="noopener ugc nofollow" target="_blank"><strong class="lh hj">private google access </strong></a><strong class="lh hj">on subnet</strong><br/>gcloud compute networks subnets update ${SUBNETWORK} --region=${REGION} --enable-private-ip-google-access</span><span id="2014" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># IAM role for </strong><a class="ae jd" href="https://cloud.google.com/iap/docs/using-tcp-forwarding" rel="noopener ugc nofollow" target="_blank"><strong class="lh hj">IAP tunnel</strong></a><strong class="lh hj"> to AD and Dataproc (if needed)</strong><br/>gcloud projects add-iam-policy-binding ${PROJECT} \<br/>  --member=user:<a class="ae jd" href="mailto:jhambleton@matsugo.org" rel="noopener ugc nofollow" target="_blank">$</a>{GCP_ADMIN} \<br/>  --role=roles/iap.tunnelResourceAccessor</span><span id="2eea" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># IAM role for </strong><a class="ae jd" href="https://cloud.google.com/iam/docs/understanding-roles#dataproc-roles" rel="noopener ugc nofollow" target="_blank"><strong class="lh hj">dataproc</strong></a><strong class="lh hj"> cluster</strong><br/>gcloud projects add-iam-policy-binding ${PROJECT} --member=serviceAccount:${SERVICE_ACCOUNT_DL}@${PROJECT}.iam.gserviceaccount.com --role=roles/dataproc.worker</span></pre><p id="29c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2。设置云KMS、秘密管理器和秘密</strong> <br/>在我们示例的后半部分，我们将使用云KMS通过Kerberos 和<a class="ae jd" href="https://cloud.google.com/secret-manager/docs" rel="noopener ugc nofollow" target="_blank">秘密管理器</a>进行<a class="ae jd" href="https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/security#create_a_kerberos_cluster_with_your_own_root_principal_password" rel="noopener ugc nofollow" target="_blank"> Dataproc设置，以存储core-data-svc帐户的Active Directory keytab。我们将在接下来的步骤中设置这些以备后用。</a></p><p id="1e8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.1.创建云KMS密钥环、云KMS密钥，并分配IAM角色。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="d135" class="ll ka hi lh b fi lm ln l lo lp"><strong class="lh hj"># properties</strong><br/>export KMS_KEY_RING_LOCATION=us<br/>export KMS_KEY_RING_NAME=dataproc-key-ring<br/>export KMS_KEY_NAME=dataproc-key<br/>export KMS_KEY_URI=projects/${PROJECT}/locations/${KMS_KEY_RING_LOCATION}/keyRings/${KMS_KEY_RING_NAME}/cryptoKeys/${KMS_KEY_NAME}</span><span id="272b" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># create kms keyring</strong><br/>gcloud kms keyrings create ${KMS_KEY_RING_NAME} \<br/>  --project ${PROJECT} \<br/>  --location ${KMS_KEY_RING_LOCATION}</span><span id="174a" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># create kms key</strong><br/>gcloud kms keys create ${KMS_KEY_NAME} \<br/>  --project ${PROJECT} \<br/>  --location ${KMS_KEY_RING_LOCATION} \<br/>  --purpose encryption \<br/>  --keyring ${KMS_KEY_RING_NAME}</span><span id="f095" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># allow dataproc decrypt IAM role on kms key for cluster creation</strong><br/>gcloud kms keys add-iam-policy-binding ${KMS_KEY_NAME} --location ${KMS_KEY_RING_LOCATION} --keyring ${KMS_KEY_RING_NAME} --member=serviceAccount:${SERVICE_ACCOUNT_DL}@${PROJECT}.iam.gserviceaccount.com --role=roles/cloudkms.cryptoKeyDecrypter</span><span id="6270" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># allow AD decrypt IAM role on kms key for shared secret</strong><br/>gcloud kms keys add-iam-policy-binding ${KMS_KEY_NAME} --location ${KMS_KEY_RING_LOCATION} --keyring ${KMS_KEY_RING_NAME} --member=serviceAccount:${SERVICE_ACCOUNT_AD}@${PROJECT}.iam.gserviceaccount.com --role=roles/cloudkms.cryptoKeyDecrypter</span></pre><p id="029d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.2.为Dataproc根主体和与Active Directory共享的主体生成随机机密。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="e218" class="ll ka hi lh b fi lm ln l lo lp"><strong class="lh hj"># create secret</strong><br/>openssl rand -base64 32 | sed 's/\///g' &gt; cluster_secret.txt <br/>openssl rand -base64 32 | sed 's/\///g' &gt; trust_secret.txt</span><span id="d80a" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># create bucket in project for secrets (restrict access)<br/></strong>gsutil mb gs://$BUCKET_SECRETS</span><span id="7acd" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># encrypt cluster secret and store in restricted bucket</strong><br/>cat cluster_secret.txt \<br/>  | gcloud kms encrypt --ciphertext-file - --plaintext-file \<br/>  - --key "${KMS_KEY_URI}" | gsutil cp - gs://${BUCKET_SECRETS}/analytics-cluster_principal.encrypted</span><span id="a531" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># encrypt trust secret and store in restricted bucket</strong><br/>cat trust_secret.txt | gcloud kms encrypt \<br/>  --ciphertext-file - --plaintext-file - --key "${KMS_KEY_URI}" \<br/>  | gsutil cp - gs://${BUCKET_SECRETS}/trust_analytics-cluster_ad_principal.encrypted</span><span id="9718" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># allow active directory access to shared secrets<br/></strong>gsutil iam ch serviceAccount:${SERVICE_ACCOUNT_AD}@${PROJECT}.iam.gserviceaccount.com:objectViewer gs://${BUCKET_SECRETS}</span></pre><p id="6083" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.3.在Secret Manager中创建Secret，并为存储core-data-svc keytab分配IAM角色。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="f351" class="ll ka hi lh b fi lm ln l lo lp"><strong class="lh hj"># properties</strong><br/>export KEYTAB_SECRET=keytab-core-data-svc</span><span id="254b" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># create secret manager secret for storing Kerberos keytab</strong><br/>gcloud secrets create ${KEYTAB_SECRET}</span><span id="4607" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># role for AD host account </strong><a class="ae jd" href="https://cloud.google.com/secret-manager/docs/access-control" rel="noopener ugc nofollow" target="_blank"><strong class="lh hj">secrets adder</strong></a><strong class="lh hj"> for keytab <br/></strong>gcloud secrets add-iam-policy-binding ${KEYTAB_SECRET} --member=serviceAccount:${SERVICE_ACCOUNT_AD}@${PROJECT}.iam.gserviceaccount.com --role=roles/secretmanager.secretVersionAdder</span><span id="59e6" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># role for dataproc host account </strong><a class="ae jd" href="https://cloud.google.com/secret-manager/docs/access-control" rel="noopener ugc nofollow" target="_blank"><strong class="lh hj">secrets acccessor</strong></a><strong class="lh hj"> for keytab </strong><br/>gcloud secrets add-iam-policy-binding ${KEYTAB_SECRET} --member=serviceAccount:${SERVICE_ACCOUNT_DL}@${PROJECT}.iam.gserviceaccount.com --role=roles/secretmanager.secretAccessor</span></pre><h2 id="5e1c" class="ll ka hi bd kb me mf mg kf mh mi mj kj iq mk ml kn iu mm mn kr iy mo mp kv mq bi translated">安装Active Directory域控制器</h2><p id="aedc" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">在Google Cloud中，Windows Server基础映像在计算引擎中可用。对于我们的例子，我们将使用<code class="du mr ms mt lh b">Windows Server 2016 Datacenter</code>创建域控制器，并完成一个轻量级的安装。参考<a class="ae jd" href="https://cloud.google.com/solutions/deploy-fault-tolerant-active-directory-environment" rel="noopener ugc nofollow" target="_blank">部署容错微软活动目录环境</a>指南，了解更全面的设置，包括VPC、DNS、多区域部署等。</p><p id="c04f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建Active Directory实例。导航至<code class="du mr ms mt lh b"><strong class="ih hj">Compute Engine &gt; VM instances &gt; Create Instance</strong></code>。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mu"><img src="../Images/97d34617acbe1f1ded0294af0927b9e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Oe_Si1Oa1tNVdM-w"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[带有Windows映像的Google计算引擎实例]</figcaption></figure><p id="4010" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置启动盘操作系统<code class="du mr ms mt lh b"><strong class="ih hj">Windows Server</strong></code>和版本<code class="du mr ms mt lh b"><strong class="ih hj">Windows Server 2016 Datacenter</strong></code>。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mv"><img src="../Images/aaff95326e4387ce98b9fc42017c4ed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mDs105_aBpa6HzzA"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[Windows Server 2016数据中心公共映像]</figcaption></figure><p id="aebe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于GCE实例，我们将使用上面配置了特定IAM角色的<code class="du mr ms mt lh b"><strong class="ih hj">active-directory-sa</strong></code>服务帐户。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mw"><img src="../Images/3db6e24b49035914c99bfb2b51e2dcbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-AgVrb9_CCg2LbMuiyJaew.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[GCE实例服务帐户]</figcaption></figure><p id="4044" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将带有外部IP的网络接口配置为<code class="du mr ms mt lh b"><strong class="ih hj">None</strong></code>,以便实例仅使用内部IP。如果仅使用内部IP，请参考本指南后面的步骤，通过IAP隧道配置RDP。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div class="er es mx"><img src="../Images/af4863ea4d4fea619027eb016680c50c.png" data-original-src="https://miro.medium.com/v2/resize:fit:942/0*ibvmfZSRe5FF3CRF"/></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[没有外部IP的网络接口]</figcaption></figure><p id="d6f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">服务器完成初始化后，<code class="du mr ms mt lh b"><strong class="ih hj">Set Windows password</strong></code>。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es my"><img src="../Images/8eba37a5d4ff1a150668e9b8a8b6a649.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cbV7ZkWMUDaWYh9c"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[Windows Server实例active-directory-2016]</figcaption></figure><p id="177b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为用户设置新密码。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div class="er es mz"><img src="../Images/4951a2d7490ad60a9873d6f7deb44ed8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/0*tN6MP4WtfFuuI_1y"/></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[Windows密码重置提示]</figcaption></figure><h1 id="37d6" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated"><strong class="ak">使用远程桌面登录Windows服务器</strong></h1><p id="0855" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">下一节将介绍如何使用内部IP访问Windows服务器，但是有多个选项可供选择。</p><ul class=""><li id="1354" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc md jk jl jm bi translated">如果配置了外部IP(<em class="jv">不推荐</em>，那么安装<a class="ae jd" href="https://chrome.google.com/webstore/detail/chrome-rdp-for-google-clo/mpbbnannobiobpnfblimoapbephgifkm" rel="noopener ugc nofollow" target="_blank">Chrome RDP for Google Cloud Platform</a>扩展，通过active-directory-2016 instance下拉菜单可以直接从控制台创建RDP会话。</li><li id="254e" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc md jk jl jm bi translated">如果配置了内部IP，则为TCP转发设置<a class="ae jd" href="https://cloud.google.com/iap/docs/using-tcp-forwarding" rel="noopener ugc nofollow" target="_blank">IAP</a>，创建隧道，并使用RDP客户端(即。<a class="ae jd" href="https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/remote-desktop-mac" rel="noopener ugc nofollow" target="_blank"> Mac客户端</a>)遵循以下步骤。</li></ul><h2 id="8cd2" class="ll ka hi bd kb me mf mg kf mh mi mj kj iq mk ml kn iu mm mn kr iy mo mp kv mq bi translated">通过IAP初始化RDP隧道</h2><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="898e" class="ll ka hi lh b fi lm ln l lo lp">gcloud compute start-iap-tunnel active-directory-2016 3389 --local-host-port=localhost:3389 --zone=us-central1-a<br/><em class="jv">Testing if tunnel connection works.<br/>Listening on port [3389].</em></span></pre><h2 id="865e" class="ll ka hi bd kb me mf mg kf mh mi mj kj iq mk ml kn iu mm mn kr iy mo mp kv mq bi translated"><strong class="ak">启动微软远程桌面客户端</strong></h2><p id="9e5c" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">添加主机<code class="du mr ms mt lh b"><strong class="ih hj">localhost</strong></code>并使用上面设置的用户名/密码进行连接。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es na"><img src="../Images/cb80317866bc4dcd58b42ef3c3471884.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fHN18tZnlM0ApExR"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[用于Mac的微软远程桌面]</figcaption></figure><h2 id="79ac" class="ll ka hi bd kb me mf mg kf mh mi mj kj iq mk ml kn iu mm mn kr iy mo mp kv mq bi translated"><strong class="ak">设置管理员密码</strong></h2><p id="fb6e" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">连接到Windows服务器后，设置<em class="jv">管理员</em>密码。此步骤是<em class="jv">将服务器升级到域控制器所必需的</em>。</p><p id="2602" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过<code class="du mr ms mt lh b"><strong class="ih hj">Tools &gt; Computer Management</strong></code>导航至用户管理</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es nb"><img src="../Images/1081e22436e4d1aa79cc708bc44de070.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*emcamjFp7E_XSYBG"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[Active Directory服务器管理器计算机管理]</figcaption></figure><p id="c49c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，选择<code class="du mr ms mt lh b"><strong class="ih hj">Local Users and Groups &gt; Users &gt; Administrator &gt;</strong></code>右键并选择<code class="du mr ms mt lh b"><strong class="ih hj">Set Password</strong></code></p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es nc"><img src="../Images/1166d282fa6488cc6dabd25fc9d7f997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dkhhaR0KMg3dVF5j"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[计算机管理设置管理员密码]</figcaption></figure><h2 id="eb6f" class="ll ka hi bd kb me mf mg kf mh mi mj kj iq mk ml kn iu mm mn kr iy mo mp kv mq bi translated"><strong class="ak">设置域服务和域控制器</strong></h2><p id="4829" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">选择<code class="du mr ms mt lh b"><strong class="ih hj">Add roles and features</strong></code>进行设置。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es nd"><img src="../Images/43dfdaeeb747975217abfcc41d10a0b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6qCTm43GYLEqCTyd"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[Active Directory服务器管理器添加角色和功能]</figcaption></figure><p id="2413" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，选择<code class="du mr ms mt lh b"><strong class="ih hj">Role-based installation</strong></code>类型。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es ne"><img src="../Images/1bcee50288520e6d06315f7a513113fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NZBuusuRlIiut3pl"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[添加角色和功能向导]</figcaption></figure><p id="67f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加<code class="du mr ms mt lh b"><strong class="ih hj">Active Directory Domain Services</strong></code>角色。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es ne"><img src="../Images/cd66e40ae8ff706e84e5d3b9b306c7ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1PLmLcqnG4E14shBG3Qv7g.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[添加角色和功能向导]</figcaption></figure><p id="fd10" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">继续使用功能和Active Directory域服务的默认值，然后使用<code class="du mr ms mt lh b"><strong class="ih hj">Install</strong></code>服务。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es ne"><img src="../Images/03e01f262a43d37f94ea10f3722d3951.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pcrwSbCcIyRL4r3UnsAUcg.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[添加角色和功能向导]</figcaption></figure><p id="571c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，从服务器管理器仪表板中选择<code class="du mr ms mt lh b"><strong class="ih hj">Promote this server to a domain controller</strong></code>。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es nf"><img src="../Images/405cc6d0de3deef46b003a9d4bb0f84e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G2OaHb251ta0CYQpfHcbBA.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[将服务器提升为域控制器]</figcaption></figure><p id="7713" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择<code class="du mr ms mt lh b"><strong class="ih hj">Add a new forest</strong></code>，添加根域。在我们的例子中，我们使用<code class="du mr ms mt lh b"><strong class="ih hj">foo.internal</strong></code>。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es ng"><img src="../Images/a9b6144d269e40fbdb088297f59f1e1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ZLjW1ffeP8sjm7bvA325Q.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[Active Directory域服务配置向导]</figcaption></figure><p id="dfef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置<code class="du mr ms mt lh b"><strong class="ih hj">Restore Mode</strong></code>的密码并继续。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es ng"><img src="../Images/956eb3d39aa948a6dfe179adec7553f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fMhPHG51YIbmQclbJOti0Q.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[Active Directory域服务配置向导]</figcaption></figure><p id="6466" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">继续使用DNS选项和中NetBIOS域名的默认<code class="du mr ms mt lh b"><strong class="ih hj">FOO</strong></code>并继续。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es nh"><img src="../Images/c3aeb68a9f3bed1985aa4930c55f813d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MR7rpurv6ad7L2w19WikMA.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[Active Directory域服务配置向导]</figcaption></figure><p id="0425" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">复习后继续<code class="du mr ms mt lh b"><strong class="ih hj">install</strong></code>。服务器将自动重启以完成安装。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es ni"><img src="../Images/04530ed9166a509c38b18d1d1f6e21c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Mu-fnnhWOJkmdNaAtu4rQ.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[Active Directory域服务配置向导]</figcaption></figure><p id="bf12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jv">恭喜</em>，域控制器现已安装完毕。接下来，我们将使用我们在先决条件部分中创建的加密秘密来设置从Dataproc集群KDC到Active Directory的信任。</p><h2 id="f1bd" class="ll ka hi bd kb me mf mg kf mh mi mj kj iq mk ml kn iu mm mn kr iy mo mp kv mq bi translated"><strong class="ak">将外部KDC添加到活动目录服务器</strong></h2><p id="69d2" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">接下来，我们设置外部Dataproc KDC领域，分析。FOO.INTERNAL，用于建立单向信任，即使我们还没有创建Dataproc集群。</p><p id="b051" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开<code class="du mr ms mt lh b"><strong class="ih hj">powershell</strong></code>(右击&amp;以<em class="jv">管理员</em>身份运行)并运行以下程序:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="94e0" class="ll ka hi lh b fi lm ln l lo lp"><strong class="lh hj"># set powershell variables</strong><br/>$KMS_KEY_URI="projects/ad-kerberos/locations/us/keyRings/dataproc-key-ring/cryptoKeys/dataproc-key"<br/>$BUCKET_SECRETS="ad-kerberos-us-dataproc-secrets"</span><span id="735a" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># add external KDC realm to Active Directory</strong><br/>ksetup /addkdc ANALYTICS.FOO.INTERNAL analytics-cluster-m.us-central1-a.c.ad-kerberos.internal</span><span id="f027" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># verify realm was added</strong><br/><em class="jv">PS C:\Users\jhambleton&gt; ksetup<br/>default realm = foo.internal (NT Domain)<br/>ANALYTICS.FOO.INTERNAL:<br/>        kdc = analytics-cluster-m.us-central1-a.c.ad-kerberos.internal</em></span><span id="4287" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># retrieve trust secret </strong><br/>gsutil cp gs://$BUCKET_SECRETS/trust_analytics-cluster_ad_principal.encrypted .<br/>$secret=gcloud kms decrypt --ciphertext-file .\trust_analytics-cluster_ad_principal.encrypted --plaintext-file - --key "${KMS_KEY_URI}"</span><span id="65a3" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># create one-way trust </strong><br/>netdom trust ANALYTICS.FOO.INTERNAL /Domain FOO.INTERNAL /add /realm /passwordt:$secret</span><span id="cbe7" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># Configure other domain support for Kerberos AES Encryption</strong><br/>ksetup /setenctypeattr ANALYTICS.FOO.INTERNAL AES256-CTS-HMAC-SHA1-96 AES128-CTS-HMAC-SHA1-96</span></pre><h2 id="7d5b" class="ll ka hi bd kb me mf mg kf mh mi mj kj iq mk ml kn iu mm mn kr iy mo mp kv mq bi translated"><strong class="ak">创建单向信任AD域控制器的Dataproc集群</strong></h2><p id="50b5" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">在您的本地终端或云shell中，为<a class="ae jd" href="https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/security#create_the_cluster" rel="noopener ugc nofollow" target="_blank"> Dataproc Kerberos配置</a>创建一个YAML文件(确保这些配置被正确定义)。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="dfa2" class="ll ka hi lh b fi lm ln l lo lp"><strong class="lh hj">#####<br/># kerberos_dataproc.yaml config<br/>#<br/></strong>enable_kerberos: true<br/>realm: ANALYTICS.FOO.INTERNAL<br/>root_principal_password_uri: <br/>  gs://ad-kerberos-us-dataproc-secrets/analytics-cluster_principal.encrypted<br/>kms_key_uri:<br/>  projects/ad-kerberos/locations/us/keyRings/dataproc-key-ring/cryptoKeys/dataproc-key<br/>cross_realm_trust:<br/>  realm: FOO.INTERNAL<br/>  kdc: active-directory-2016.us-central1-a.c.ad-kerberos.internal<br/>  admin_server: active-directory-2016.us-central1-a.c.ad-kerberos.internal<br/>  shared_password_uri:<br/>        gs://ad-kerberos-us-dataproc-secrets/trust_analytics-cluster_ad_principal.encrypted<br/>  tgt_lifetime_hours: 1</span></pre><p id="ea92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建Dataproc集群。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="bd37" class="ll ka hi lh b fi lm ln l lo lp">gcloud dataproc clusters create analytics-cluster \<br/>  --enable-component-gateway \<br/>  --no-address \<br/>  --region ${REGION} \<br/>  --zone ${ZONE} \<br/>  --subnet default \<br/>  --image-version 1.5-debian \<br/>  --service-account ${SERVICE_ACCOUNT_DL}@${PROJECT}.iam.gserviceaccount.com \<br/>  --scopes '<a class="ae jd" href="https://www.googleapis.com/auth/cloud-platform'" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/cloud-platform'</a> \<br/>  --project ${PROJECT} \<br/>  --kerberos-config-file ./kerberos_dataproc.yaml</span></pre><h2 id="7d48" class="ll ka hi bd kb me mf mg kf mh mi mj kj iq mk ml kn iu mm mn kr iy mo mp kv mq bi translated">创建<em class="nj">爱丽丝</em>和核心数据服务主体</h2><p id="a33e" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">接下来，让我们在Active Directory中创建第一个测试用户Alice。导航至<br/>T10。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es nk"><img src="../Images/4cabacd21936e92aedf865e2bb8e5f6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zIn73ja_-jOydtUqaA97BA.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[Active Directory用户和计算机]</figcaption></figure><p id="7605" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建新的组织单位。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es nl"><img src="../Images/93097a7ca454b5e4898207ae91ac48be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9yrBcvumR3JOMBPx4vWhTw.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[新的组织单位]</figcaption></figure><p id="83cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在其中创建<em class="jv"> GCP数据湖OU </em>和<em class="jv">用户OU </em>。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div class="er es nm"><img src="../Images/b89a026f23b27ce09a82516c80fc0365.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/format:webp/1*GT-O-szhGTB8JF1ISjCcKg.png"/></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[新的组织单位— GCP数据湖OU]</figcaption></figure><p id="065f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jv"> GCP数据湖OU </em>中的用户将只包含特定于数据湖的特殊用户帐户(即用于运行计划作业的广告服务帐户)。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es nn"><img src="../Images/29454c16fa8651fe86f6a30aab12504a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_wTLdRSStojmY3DJG1w6bA.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">【GCP数据湖欧】</figcaption></figure><p id="b8fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在顶级用户下创建新用户。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es no"><img src="../Images/d7bb06234eee8f17cb65c74ea17db339.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zd3fUIPYiLAnFaodvkt4VA.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[创建新用户]</figcaption></figure><p id="433d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加Alice为新用户(我们设置<em class="jv">不安全的pwd alic123！</em>)。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div class="er es np"><img src="../Images/0d5cfd3d6e64cf7cccf3de31e67e676f.png" data-original-src="https://miro.medium.com/v2/resize:fit:880/format:webp/1*c7ah0pBX13CleUCSLyBnUQ.png"/></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">【新用户——Alice @ FOO。内部]</figcaption></figure><p id="a06a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们在<em class="jv"> GCP数据湖OU </em>中创建<em class="jv"> core-data-svc </em>服务帐户，并生成用于认证的密钥表。</p><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es nq"><img src="../Images/4b6c5969095bd8eb795982a12491a49d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xFz9awW-PjfitglHfVc-bA.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[GCP数据湖OU核心数据服务中心新账户]</figcaption></figure><figure class="lc ld le lf fd ls er es paragraph-image"><div class="er es nr"><img src="../Images/29f364b92c0932288dd14ce214c8bc4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:878/format:webp/1*H9h-ph6HKu_gN4oClmw9KQ.png"/></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">[核心数据服务的新对象]</figcaption></figure><p id="07a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为这个非人类<em class="jv"> core-data-svc </em>帐户创建keytab。打开<code class="du mr ms mt lh b"><strong class="ih hj">powershell</strong></code>(右击&amp;以<em class="jv">管理员</em>身份运行)并运行以下程序:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="7db4" class="ll ka hi lh b fi lm ln l lo lp">$KEYTAB_SECRET="keytab-core-data-svc"</span><span id="a140" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># keytab generation </strong><br/>ktpass /out "C:\Users\jhambleton\core-data-svc.keytab" /mapuser core-data-svc /princ core-data-svc@FOO.INTERNAL +rndpass /ptype KRB5_NT_PRINCIPAL /target FOO.INTERNAL /kvno 0 /crypto AES256-SHA1</span><span id="4c60" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># export keytab to secret manager</strong><br/>gcloud secrets versions add ${KEYTAB_SECRET} --data-file="C:\Users\jhambleton\core-data-svc.keytab"</span><span id="9461" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># remove secret</strong><br/>rm "C:\Users\jhambleton\core-data-svc.keytab"</span></pre><h1 id="37a6" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">使用Active Directory验证Kerberos身份验证</h1><p id="d535" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">登录，以alice身份验证，并在analytics-cluster上运行Hadoop命令。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="4eca" class="ll ka hi lh b fi lm ln l lo lp"><em class="jv">$ gcloud compute ssh alice@analytics-cluster-m --tunnel-through-iap<br/>$ kinit alice@FOO.INTERNAL          # remember insecure pwd alic123!<br/>Password for alice@FOO.INTERNAL:<br/>$ klist <br/>$ hadoop fs -ls /user/</em></span></pre><h2 id="76f5" class="ll ka hi bd kb me mf mg kf mh mi mj kj iq mk ml kn iu mm mn kr iy mo mp kv mq bi translated">应用服务帐户测试核心-数据-svc@FOO。内部的</h2><p id="8c05" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">出于安全原因，下面的步骤使用密钥表，然后销毁本地密钥表。然后，它在分析集群上运行hadoop命令(或者可以启动spark作业)。该命令只能使用具有集群实例授权的Google身份来执行。</p><p id="5686" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从本地终端或云shell运行(<em class="jv">不需要ssh</em>):</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="7845" class="ll ka hi lh b fi lm ln l lo lp"><strong class="lh hj"># properties</strong><br/>export KEYTAB_SECRET=keytab-core-data-svc<br/>export AD_SVC_ACCNT=core-data-svc<br/>export DOMAIN=FOO.INTERNAL</span><span id="8aba" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj">## ## ## ##<br/>## commands to be executed on remote cluster</strong></span><span id="0060" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># cmd 1 - get keytab from secret manager</strong><br/>export cmd_get_secret="gcloud secrets versions access latest --secret ${KEYTAB_SECRET} --format='get(payload.data)' | tr '_-' '/+' | base64 -d &gt; ./${AD_SVC_ACCNT}.keytab"</span><span id="b979" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># cmd 2 - kinit</strong><br/>export cmd_kinit="kinit -kt ./${AD_SVC_ACCNT}.keytab ${AD_SVC_ACCNT}@${DOMAIN}; rm ./${AD_SVC_ACCNT}.keytab"</span><span id="3381" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj"># cmd 3 - execute hadoop cmd or spark-submit</strong><br/>export cmd_hadoop="hadoop fs -ls /user/"</span><span id="9f99" class="ll ka hi lh b fi lq ln l lo lp"><strong class="lh hj">## ## ## ##<br/># execute cmd - run hadoop/spark-submit command with kerberos auth<br/></strong>gcloud compute ssh core-data-svc@analytics-cluster-m \<br/>  --command="${cmd_get_secret}; ${cmd_kinit}; ${cmd_hadoop};" --tunnel-through-iap</span></pre><h1 id="7c33" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated"><strong class="ak">故障排除</strong></h1><p id="5e30" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">在这一节中，我们捕获了一些有用的命令，如果有必要的话，这些命令对调试很有用。</p><p id="5948" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">命令测试用户名默认规则</strong>(Hadoop . security . auth _ to _ local rules)</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="689d" class="ll ka hi lh b fi lm ln l lo lp">$ hadoop org.apache.hadoop.security.HadoopKerberosName alice@FOO.INTERNAL<br/><em class="jv">Name: alice@FOO.INTERNAL to alice</em></span></pre><p id="6faf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">Hadoop和Kerberos握手的调试模式</strong></p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="0a66" class="ll ka hi lh b fi lm ln l lo lp">$ HADOOP_OPTS="-Dsun.security.krb5.debug=true" hadoop fs -ls /<br/><em class="jv">...<br/>&gt;&gt;&gt; KrbKdcReq send: kdc=active-directory-2016.us-central1-a.c.ad-kerberos.internal UDP:88, timeout=30000, number of retries =3, #bytes=1378<br/>&gt;&gt;&gt; KDCCommunication: kdc=active-directory-2016.us-central1-a.c.ad-kerberos.internal UDP:88, timeout=30000,Attempt =1, #bytes=1378<br/>&gt;&gt;&gt; KrbKdcReq send: #bytes read=1377<br/>&gt;&gt;&gt; KdcAccessibility: remove active-directory-2016.us-central1-a.c.ad-kerberos.internal<br/>&gt;&gt;&gt; EType: sun.security.krb5.internal.crypto.Aes256CtsHmacSha1EType<br/>&gt;&gt;&gt; TGS credentials serviceCredsSingle:<br/>...</em></span></pre><p id="a1a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">启用跟踪级Hadoop日志记录器并调试JAAS日志记录</strong></p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="2349" class="ll ka hi lh b fi lm ln l lo lp">$ HADOOP_ROOT_LOGGER=TRACE,console HADOOP_JAAS_DEBUG=true hdfs dfs -ls /<br/><em class="jv">...<br/>21/02/05 12:32:54 DEBUG security.UserGroupInformation: hadoop login commit<br/>21/02/05 12:32:54 DEBUG security.UserGroupInformation: using kerberos user:alice@FOO.INTERNAL<br/>21/02/05 12:32:54 DEBUG security.UserGroupInformation: Using user: "alice@FOO.INTERNAL" with name alice@FOO.INTERNAL<br/>...</em></span></pre><p id="d2ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Kerberos级别跟踪</strong></p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="3528" class="ll ka hi lh b fi lm ln l lo lp">$ env KRB5_TRACE=/dev/stdout kinit alice@FOO.INTERNAL<br/><em class="jv">[14178] 1612528239.343161: Getting initial credentials for alice@FOO.INTERNAL<br/>[14178] 1612528239.343163: Sending unauthenticated request<br/>[14178] 1612528239.343164: Sending request (192 bytes) to FOO.INTERNAL<br/>[14178] 1612528239.343165: Resolving hostname active-directory-2016.us-central1-a.c.ad-kerberos.internal<br/>[14178] 1612528239.343166: Sending initial UDP request to dgram 10.128.0.55:88<br/>...</em></span></pre><h1 id="bc35" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated"><strong class="ak">总结</strong></h1><p id="d549" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">在本课程中，我们将活动目录域服务和域控制器设置为一个身份提供者，用于使用Kerberized化的Dataproc集群进行身份验证。虽然这个设置是一个简单的部署，只有一个Dataproc集群，但是它可以扩展到Google Cloud上的复杂数据湖架构。</p><h1 id="d232" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">附加参考</h1><ul class=""><li id="e622" class="je jf hi ih b ii kx im ky iq ns iu nt iy nu jc md jk jl jm bi translated"><a class="ae jd" href="https://cloud.google.com/solutions/deploy-fault-tolerant-active-directory-environment" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/solutions/deploy-fault-tolerant-active-directory-environment</a></li><li id="1f30" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc md jk jl jm bi translated"><a class="ae jd" href="https://pc-addicts.com/setup-active-directory-server-2016/" rel="noopener ugc nofollow" target="_blank">https://pc-addicts.com/setup-active-directory-server-2016/</a></li><li id="a101" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc md jk jl jm bi translated"><a class="ae jd" href="https://steveloughran.gitbooks.io/kerberos_and_hadoop/content/sections/secrets.html" rel="noopener ugc nofollow" target="_blank">https://steveloughran . git books . io/Kerberos _ and _ Hadoop/content/sections/secrets . html</a></li><li id="607b" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc md jk jl jm bi translated"><a class="ae jd" href="https://blog.cloudera.com/how-to-deploy-a-secure-enterprise-data-hub-on-aws/" rel="noopener ugc nofollow" target="_blank">https://blog . cloud era . com/how-to-deploy-a-secure-enterprise-data-hub-on-AWS/</a></li></ul><p id="e8c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作者:威尔逊·刘&amp; <a class="ae jd" rel="noopener" href="/@jordan.hambleton">乔丹·汉伯顿</a></p></div></div>    
</body>
</html>