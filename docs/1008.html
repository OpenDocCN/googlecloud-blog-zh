<html>
<head>
<title>Google Cloud Run on Rails: a real life example (Part 3: production environment and security)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">运行在Rails上的Google Cloud:一个真实的例子(第3部分:生产环境和安全性)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-run-on-rails-a-real-life-example-part-3-production-environment-and-security-e109063ef745?source=collection_archive---------2-----------------------#2019-05-21">https://medium.com/google-cloud/google-cloud-run-on-rails-a-real-life-example-part-3-production-environment-and-security-e109063ef745?source=collection_archive---------2-----------------------#2019-05-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2e20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程的<a class="ae jd" rel="noopener" href="/@laurent_90293/google-cloud-run-on-rails-a-real-life-example-part-1-preparing-the-ground-705c94ab8a7a">第1部分</a>中，我们设置了我们的项目环境，而<a class="ae jd" rel="noopener" href="/@laurent_90293/google-cloud-run-on-rails-a-real-life-example-part-2-running-locally-5734a1a7532f">第2部分</a>致力于在您的本地开发环境中运行相册应用程序。</p><h1 id="6ccf" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置云运行</h1><p id="fbd3" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">如果在<a class="ae jd" rel="noopener" href="/@laurent_90293/google-cloud-run-on-rails-a-real-life-example-part-1-preparing-the-ground-705c94ab8a7a">第1部分</a>中尚未启用，则启用云运行API:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="f9ed" class="kq jf hi km b fi kr ks l kt ku">$ gcloud services enable run.googleapis.com</span></pre><p id="914f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还定义了Google Cloud区域Cloud Run将运行于:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="d045" class="kq jf hi km b fi kr ks l kt ku">$ gcloud config set run/region us-central1</span></pre><p id="2366" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong> : <em class="kv">在撰写本文时，云运行仍处于测试阶段，因此仅可从</em> <code class="du kw kx ky km b">us-central1</code> <em class="kv">区域</em>获得</p><h1 id="03b0" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置Rails主密钥</h1><p id="a406" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">从版本5.2开始，Rails生成一个秘密主密钥来加密cookies中的用户会话参数、应用程序和浏览器之间来回传递的其他类型的敏感信息以及您自己的应用程序数据。要创建新的rails主密钥和相应的凭证文件，请键入以下命令:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="1e0a" class="kq jf hi km b fi kr ks l kt ku">$ EDITOR=vim rails credentials:edit # generate secret_key_base</span></pre><p id="edc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它会启动vi编辑器，其中已经填充了新的凭证文件，因此您只需保存它。凭证文件的加密版本在<code class="du kw kx ky km b">config/credentials.yml.enc</code>中，相应的主密钥在<code class="du kw kx ky km b">config/master.key</code>中。后者是非常敏感的信息，未经授权的人或程序不得访问。我们马上会看到如何保护万能钥匙。</p><h1 id="b040" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">使用云SQL设置您的生产数据库</h1><p id="46f2" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">如果还没有在第1部分中完成，启用云SQL管理API。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="1cfc" class="kq jf hi km b fi kr ks l kt ku">$ gcloud services enable sqladmin.googleapis.com</span></pre><p id="6e6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/sql/docs/" rel="noopener ugc nofollow" target="_blank"> Cloud SQL </a>，GCP上可用的MySQL的托管版本，是我们在本教程中选择的RBDMS。</p><p id="5a30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个所谓的“db-f1-micro”服务器实例，这是最小的云SQL实例。它非常适合我们的演示应用程序(参见<a class="ae jd" href="https://cloud.google.com/sql/pricing#2nd-gen-pricing" rel="noopener ugc nofollow" target="_blank">其他类型的MySQL实例</a>)。我们还需要用密码保护数据库root帐户，并定义另一个我们将在生产中专门由Rails使用的帐户。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="1009" class="kq jf hi km b fi kr ks l kt ku"># Create a small Cloud SQL instance with a public IP (takes some time)<br/>$ gcloud sql instances create photo-album-production --tier=db-f1-micro --region=us-central1 --assign-ip</span><span id="9292" class="kq jf hi km b fi kz ks l kt ku"># Protect database root account<br/>$ gcloud sql users set-password root --host % --instance photo-album-production --password <strong class="km hj"><em class="kv">your_root_db_password</em></strong></span><span id="6850" class="kq jf hi km b fi kz ks l kt ku"># Create a new database account for Rails in production<br/>$ gcloud sql users create prod_db_user --instance photo-album-production --host % --password <strong class="km hj"><em class="kv">your_prod_db_password</em></strong></span></pre><p id="1e25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们检查一下我们的云SQL实例是否可以使用。下面的命令应该将您的实例显示为“RUNNABLE”。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="bb9a" class="kq jf hi km b fi kr ks l kt ku">$ gcloud sql instances list</span></pre><p id="ca97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://console.cloud.google.com/sql" rel="noopener ugc nofollow" target="_blank">在Google Cloud Web控制台上访问您的云SQL实例</a>，复制实例连接名称并将其粘贴到<code class="du kw kx ky km b">config/database.yml</code>中生产部分的<code class="du kw kx ky km b">socket</code>字段中。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="5511" class="kq jf hi km b fi kr ks l kt ku">production:<br/>  &lt;&lt;: *default<br/>  database: photo_album_production<br/>  username: prod_db_user<br/>  password: &lt;%= ENV[‘DATABASE_PASSWORD’] %&gt;<br/>  socket: “/cloudsql/<em class="kv">project_id</em>:us-central1:photo-album-production”</span></pre><p id="7346" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">安全提示:</strong> <em class="kv">您可能已经知道，从安全角度来看，在应用程序的源代码中明文存储密码和凭证是绝对不允许的。这就是为什么对于生产部署，Rails将在运行时从DATABASE_PASSWORD环境变量中获取数据库密码。在本文的后面，Google云密钥管理系统(云KMS)将帮助我们加密这个密码，并且只在Rails真正需要的时候才解密。</em></p><h1 id="2459" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">在GCS上创建图像存储桶</h1><p id="76c4" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">相册应用程序依靠<a class="ae jd" href="https://edgeguides.rubyonrails.org/active_storage_overview.html" rel="noopener ugc nofollow" target="_blank"> Rails活动存储</a>来管理图像文件。活动存储是一个非常酷的模块，它方便上传任何类型的文件，并将这些文件存储在选择的存储后端。当在开发或测试环境中本地运行时，存储后端通常是您的本地磁盘。在生产中，我们选择使用Google云存储(GCS)作为我们的后端，以获得最大的可扩展性和可靠性。</p><p id="e713" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建GCS存储桶，将图像存储在与云运行实例相同的位置，以获得最佳性能:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="b59f" class="kq jf hi km b fi kr ks l kt ku">$ gsutil mb -p $PROJECT_ID -l us-central1 gs://photo_album_images_xxxxxx</span></pre><p id="c08b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其中<code class="du kw kx ky km b">xxxxxx</code>是一个6位数字，您可以选择它作为唯一的存储桶名称。</p><p id="d59a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，让我们通过编辑<code class="du kw kx ky km b">config/storage.yml</code>文件将活动存储指向这个桶。查找<code class="du kw kx ky km b">google</code>部分，并使用您自己的项目ID和bucket名称调整项目参数。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="c58e" class="kq jf hi km b fi kr ks l kt ku">google:<br/>  service: GCS<br/>  project: <strong class="km hj"><em class="kv">project_id</em></strong><br/>  credentials: &lt;%= Rails.root.join(“config/photo_album_runner.key”) %&gt;<br/>  bucket: <strong class="km hj"><em class="kv">photo_album_images_xxxxxx</em></strong></span></pre><p id="6648" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还要编辑<code class="du kw kx ky km b">config/environments/production.rb</code>文件，通知Active Storage我们将在生产中使用Google Storage后端:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="f257" class="kq jf hi km b fi kr ks l kt ku">config.active_storage.service = :google</span></pre><h1 id="9bed" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">创建应用程序服务帐户</h1><p id="7ed5" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在我们可以在生产中部署我们的应用程序并第一次运行它之前，我们必须将它与一个<a class="ae jd" href="https://cloud.google.com/iam/docs/service-accounts" rel="noopener ugc nofollow" target="_blank">服务帐户</a>相关联。简而言之，服务帐户是一个特殊的Google帐户，当您的应用程序与其他GCP服务接口时，它会模拟您的应用程序。</p><p id="eb18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们用<a class="ae jd" href="https://cloud.google.com/iam/" rel="noopener ugc nofollow" target="_blank"> Google Cloud IAM </a>(身份&amp;访问管理)创建一个名为“photo-album-runner”的服务帐户:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="da7b" class="kq jf hi km b fi kr ks l kt ku">$ gcloud iam service-accounts create photo-album-runner --display-name “Photo Album Cloud Runner”</span></pre><p id="6a93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下命令查看完整的服务帐户名称:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="11ec" class="kq jf hi km b fi kr ks l kt ku">$ gcloud iam service-accounts list<br/>NAME                     EMAIL                             DISABLED</span><span id="0b54" class="kq jf hi km b fi kz ks l kt ku">Photo Album Cloud Runner <strong class="km hj">photo-album-runner@photo-album-xxxxxx.iam.gserviceaccount.com</strong> False<br/>...<br/>...</span></pre><p id="f01d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong> : <em class="kv">您可能还会注意到列表中的另外两个服务帐户。每当您创建一个新项目时，GCP都会自动创建这些帐户:一个计算引擎服务帐户和一个应用引擎服务帐户。在本教程中，我们不会用到这些。</em></p><p id="f3d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一步是向我们全新的服务帐户授予角色，以便它获得足够的权限来履行其职责。那么这个服务帐户到底需要做什么呢？</p><ul class=""><li id="314f" class="la lb hi ih b ii ij im in iq lc iu ld iy le jc lf lg lh li bi translated">首先，它需要在GCS桶中查看、创建、删除对象，因为这是我们存储图像的地方。这可以通过授予<code class="du kw kx ky km b">storage.objectAdmin</code>角色来实现。</li><li id="9be7" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">它还必须能够作为客户端与我们的云SQL实例对话(<code class="du kw kx ky km b">cloudsql.client</code>角色)。</li></ul><figure class="kh ki kj kk fd lo"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="866e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kw kx ky km b">photo-album-runner</code>服务帐户现在已经配备了它所需要的角色。不多不少。</p><p id="5f41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一步是要求Cloud IAM以JSON文件的形式为我们生成一个服务帐户密钥，保存在<code class="du kw kx ky km b">config/photo_album_runner.key</code>文件中。该文件将在运行时用作相册应用程序的Google凭证，以建立其与其他GCP服务的身份。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="c1ba" class="kq jf hi km b fi kr ks l kt ku">$ gcloud iam service-accounts keys create ./config/photo_album_runner.key --iam-account photo-album-runner@$PROJECT_ID.iam.gserviceaccount.com</span></pre><p id="a186" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个凭证文件绝对是一条敏感的信息。如果有人能够访问该文件，他/她也可以访问我们正在使用的各种GCP服务。很明显，这个关键文件以及我们应用程序的其他敏感信息必须得到绝对的保护。谷歌云KMS救援！</p><h1 id="bbbf" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">保守我们的秘密…秘密</h1><p id="e150" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">幸运的是，谷歌云密钥管理服务(云KMS)正是旨在提供这种服务，它与谷歌云构建优雅地运行。记住这一点，让我们退后一步，列出Rails应用程序中需要加密的所有资源:</p><ul class=""><li id="558f" class="la lb hi ih b ii ij im in iq lc iu ld iy le jc lf lg lh li bi translated">由Rails ( <code class="du kw kx ky km b">config/master.key</code>)生成的主密钥文件，如上所述。</li><li id="c556" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">我们将在运行时在DATABASE_PASSWORD环境变量中传递的Rails生产数据库密码(参见<code class="du kw kx ky km b">config/database.yml</code>)</li><li id="71c1" class="la lb hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">在云环境中运行时，模拟我们的应用程序的GCP服务帐户的凭据</li></ul><p id="72a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于Rails 5.2，所有加密的秘密、Rails需要的秘密以及应用程序的其他秘密都存储在一个加密文件中:config/credentials.yml.enc。用于加密/解密该文件的主密钥在config/master.key中。出于显而易见的安全原因，gitignore确保它不会被提交到您的源代码库中。</p><p id="8085" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于这个文件不是我们的源存储库的一部分，我们必须找到另一种安全的方式来为Rails提供这个主密钥文件，因为构建应用程序容器和随后在容器中运行Rails应用程序都需要它。让我们看看如何做到这一点。</p><p id="778d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果在<a class="ae jd" rel="noopener" href="/@laurent_90293/google-cloud-run-on-rails-a-real-life-example-part-1-preparing-the-ground-705c94ab8a7a">第1部分</a>中尚未完成，请从Web控制台(以下截图)或命令行启用<a class="ae jd" href="https://console.cloud.google.com/flows/enableapi?apiid=cloudkms.googleapis.com" rel="noopener ugc nofollow" target="_blank">谷歌云KMS API:</a></p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="873d" class="kq jf hi km b fi kr ks l kt ku">$ gcloud services enable cloudkms.googleapis.com</span></pre><figure class="kh ki kj kk fd lo er es paragraph-image"><div class="er es lr"><img src="../Images/331c636ec2e0b8aaac0849cab9d0d8f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/0*8wP0PicihsVC_PXy"/></div><figcaption class="lu lv et er es lw lx bd b be z dx translated">从Google Cloud Web控制台为您的项目启用云KMS</figcaption></figure><p id="d597" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们创建一个名为photo-album的密匙环，一个用于Photo Album服务帐户，一个用于Rails主密钥。</p><figure class="kh ki kj kk fd lo"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="ed33" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">两个加密的文件<code class="du kw kx ky km b">config/photo_album_runner.key.enc</code>和<code class="du kw kx ky km b">config/master.key.enc</code>可以安全地提交到您的源代码库中。稍后构建容器映像时，云构建将要求云KMS仅在需要时并且仅在任何人都无法访问的上下文中解密密钥，从而保护您的秘密。</p><p id="1202" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们也加密我们将用于生产数据库的数据库密码，以便我们避免在我们的任何源文件(通常是<code class="du kw kx ky km b">config/database.yml</code>或<code class="du kw kx ky km b">Dockerfile</code>)中留下明文的生产密码。将下面的<code class="du kw kx ky km b">xxx</code>替换为您在前面的云SQL部分创建prod_db_user时选择的密码:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="dd85" class="kq jf hi km b fi kr ks l kt ku">$ gcloud kms keys create db_pwd_key --location=us-central1 --keyring photo-album --purpose encryption</span><span id="40bd" class="kq jf hi km b fi kz ks l kt ku">$ echo -n “xxx” | gcloud kms encrypt --location us-central1 --keyring photo-album --key db_pwd_key --plaintext-file - --ciphertext-file -| base64 --wrap 0</span></pre><p id="7137" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将base64编码的密码复制粘贴到<code class="du kw kx ky km b">cloudbuild.yaml</code>文件中(参见文件末尾的DB_PWD条目)</p><p id="99c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是<a class="ae jd" rel="noopener" href="/@laurent_90293/google-cloud-run-on-rails-a-real-life-example-part-3-production-environment-and-security-e109063ef745">第三部</a>的结尾。我们的生产环境已经就绪。本教程的第4部分(也是目前的最后一部分)将介绍如何构建容器映像并将其部署到生产环境中。</p></div></div>    
</body>
</html>