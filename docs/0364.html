<html>
<head>
<title>Using CircleCI and Kubernetes to achieve seamless deployments to Google Container Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CircleCI和Kubernetes实现到Google容器引擎的无缝部署</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-circleci-and-kubernetes-to-achieve-seamless-deployments-to-google-container-engine-8b26abc04846?source=collection_archive---------1-----------------------#2017-08-29">https://medium.com/google-cloud/using-circleci-and-kubernetes-to-achieve-seamless-deployments-to-google-container-engine-8b26abc04846?source=collection_archive---------1-----------------------#2017-08-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a8c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在过去的一篇文章中，我详细描述了对谷歌容器引擎(GKE)进行蓝/绿部署的过程。在那篇文章中，我提到了我们如何通过CircleCI、Jenkins等CI/CD工具在蓝绿部署之间手动切换<strong class="ih hj">或</strong>。(下图1)。</p><blockquote class="je jf jg"><p id="1ec8" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated"><a class="ae jd" href="https://circleci.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> CircleCI </strong> </a>是一个CI/CD平台，可以很容易地与GitHub集成，并且可以很好地适应我们的构建/测试/部署需求。它还具有分析代码库和自动运行单元测试的智能。配置它部署到谷歌云平台(GCP)非常顺利。</p></blockquote><p id="1faa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Circle CI详细信息</strong>:<a class="ae jd" href="https://circleci.com/docs/1.0/" rel="noopener ugc nofollow" target="_blank">Circle CI的1.0版</a>已在本例中使用。它包含一个<strong class="ih hj"> circle.yml </strong>文件，该文件位于我们应用程序的根目录下。该文件用于设置环境、向GCP认证、构建我们的Rails应用程序的Docker映像并对其进行标记。当代码合并到主分支时，调用“deploy.sh”将应用程序部署到GKE。在本文的结尾，我们将看到deploy.sh所做的更多内容。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es jl"><img src="../Images/d3e869e8180b0ea79100526e3cbc846f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MDSta9dV-rqAlzS5pj4trQ.png"/></div></div><figcaption class="jx jy et er es jz ka bd b be z dx translated">示例circle.yml</figcaption></figure><blockquote class="je jf jg"><p id="a921" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong> : <a class="ae jd" href="https://circleci.com/docs/2.0/" rel="noopener ugc nofollow" target="_blank"> CircleCI 2.0 </a>已经发布，具有一些令人兴奋的新特性，包括更快的构建和更好的配置。下的一个示例config.yml文件。circleci文件夹</p></blockquote><pre class="jm jn jo jp fd kb kc kd ke aw kf bi"><span id="3942" class="kg kh hi kc b fi ki kj l kk kl">version: 2<br/>jobs:<br/>  build:<br/>    environment:<br/>      DEBIAN_FRONTEND: noninteractive<br/>    docker:<br/>      - image: circleci/ruby:2.4.2-node-browsers<br/>    steps:<br/>      - checkout<br/>      # Download and cache dependencies<br/>      - restore_cache:<br/>          keys:<br/>          - v1-dependencies-{{ checksum "Gemfile.lock" }}<br/>          # fallback to using the latest cache if no exact match is found<br/>          - v1-dependencies-<br/>      - run:<br/>          name: install dependencies<br/>          command: |<br/>            bundle install --jobs=4 --retry=3 --path vendor/bundle<br/>      - save_cache:<br/>          paths:<br/>            - ./vendor/bundle<br/>          key: v1-dependencies-{{ checksum "Gemfile.lock" }}</span><span id="0e01" class="kg kh hi kc b fi km kj l kk kl">parallelism: 1</span><span id="c761" class="kg kh hi kc b fi km kj l kk kl"># push to Google Container Registry (GCR)<br/>  push-dev-server:<br/>    docker:<br/>      - image: turbinelabs/gcloud-build:0.12.4<br/>    environment:<br/>      DEBIAN_FRONTEND: noninteractive<br/>    steps:<br/>      - checkout<br/>      - setup_remote_docker<br/>      - run: openrc boot<br/>      - run: docker build -t &lt;YOUR APP NAME&gt; -f ./Dockerfile.gcloud .<br/>      - run: docker tag &lt;YOUR APP NAME&gt; gcr.io/&lt;GCP PROJECT&gt;/&lt;YOUR APP NAME&gt;:$CIRCLE_SHA1<br/>      - run: gcloud docker -- push gcr.io/&lt;GCP PROJECT&gt;/&lt;YOUR APP NAME&gt;:$CIRCLE_SHA1</span><span id="2ede" class="kg kh hi kc b fi km kj l kk kl"># Deploy to GKE<br/>  deploy-dev-server:<br/>    docker:<br/>      - image: turbinelabs/gcloud-build:0.12.4<br/>    steps:<br/>      - checkout<br/>      - run: openrc boot<br/>      - run: chmod +x ./.circleci/deploy_qa.sh   #IN THIS FILE, YOU WILL HAVE YOUR kubectl deploy logic<br/>      - run: ./.circleci/deploy_qa.sh</span><span id="75ee" class="kg kh hi kc b fi km kj l kk kl">workflows:<br/>  version: 2<br/>  build:<br/>    jobs:<br/>      - build:<br/>          filters:<br/>            branches:<br/>              only:<br/>                - &lt;ADD YOUR BRANCHING TAGS HERE&gt;<br/>              ignore:<br/>                - develop<br/>                - master<br/>  dev_deploy:<br/>    jobs:<br/>      - build:<br/>          filters:<br/>            branches:<br/>              only: develop<br/>              ignore: /.*/<br/>            tags:<br/>              only: &lt;ADD YOUR BRANCHING TAGS HERE&gt;<br/>      - push-dev-server:<br/>          filters:<br/>            branches:<br/>              only: develop<br/>              ignore: /.*/<br/>            tags:<br/>              only: &lt;ADD YOUR BRANCHING TAGS HERE&gt;<br/>      - deploy-dev-server:<br/>          requires:<br/>            - build<br/>            - push-dev-server<br/>          filters:<br/>            branches:<br/>              only: develop<br/>              ignore: /.*/<br/>            tags:<br/>              only: &lt;ADD YOUR BRANCHING TAGS HERE&gt;</span></pre><p id="5b31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">这篇文章讨论了到GKE的无缝部署。让我们看看如何实现这一点。</strong></p><p id="01a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为复习，这里有一个在<strong class="ih hj">生产</strong>中的蓝/绿部署示例(来自上一篇文章)。</p><blockquote class="je jf jg"><p id="d316" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated"><strong class="ih hj">蓝/绿部署</strong>(如下图1所示)是减少用户生产停机时间的经典方式，同时还能升级到应用程序的新版本。这是通过让我们的应用程序的多个版本并行运行并在它们之间切换来实现的。</p></blockquote><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es kn"><img src="../Images/b7db5d784a7507800a50c3bb062dbd1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xSEFinOHvXrI9roiPxhV6g.jpeg"/></div></div><figcaption class="jx jy et er es jz ka bd b be z dx translated">图1:生产中的蓝/绿部署</figcaption></figure><p id="d695" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> QA环境:</strong>当我们开始CI/CD流程时，我们在QA环境中使用了<strong class="ih hj">而不是</strong>蓝/绿部署模型。任何对GitHub的Pull请求(PR)都会启动CircleCI构建和测试周期。一旦测试通过，PR将被合并到我们的主分支机构。这反过来将启动我们在GKE的QA服务器的部署。冲洗并重复。一切都很好。(下图2)</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es ko"><img src="../Images/4fd5310521709a36e560dd3d52627fd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2XYl77KzEhIY4xzTurUKAg.jpeg"/></div></div><figcaption class="jx jy et er es jz ka bd b be z dx translated">图2:使用CircleCI的QA中的示例部署</figcaption></figure><blockquote class="je jf jg"><p id="4738" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi">问题</em> </strong> <em class="hi">:只要部署不太频繁，上述方法就非常有效。然而，每次我们部署到我们的QA服务器时，它都被视为完全部署，当Kubernetes pods更新为新映像时，会有大约5分钟的延迟。</em></p></blockquote><p id="db96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">很快，我们有了许多并行构建的功能，并导致大量PR合并到我们的主分支。我们开始看到QA停机时间变长了。依赖我们的QA服务器的各种团队(UX、产品和其他)将不得不等待服务器“恢复运行”。我们的自动化运行得有点太好了。</p><p id="5a3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">解决方案</strong>:我们决定使用一种<strong class="ih hj">类似于</strong>我们在生产中使用的蓝/绿部署的方法。下面的图3显示了新的方法。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es kp"><img src="../Images/88802a7cb682e78f474b406b8e5e6847.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n_RNGevryVkY03UNfJnA3w.jpeg"/></div></div><figcaption class="jx jy et er es jz ka bd b be z dx translated">图3</figcaption></figure><p id="9055" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">进场</strong>:</p><p id="4c0e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤1: CircleCI将创建一个新的构建，检查Kubernetes服务中我们部署的当前“颜色”,然后部署到另一个“颜色”部署。例如，如果当前部署为蓝色，则新部署将为绿色，反之亦然。</p><p id="cf93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤2: CircleCI然后会通过更改服务文件内容来更新Kubernetes服务，以指向这个新的颜色(部署)</p><p id="7783" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤3:用户现在可以访问新版本了</p><p id="1756" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">详情</strong></p><ol class=""><li id="f7a9" class="kq kr hi ih b ii ij im in iq ks iu kt iy ku jc kv kw kx ky bi translated">我们创建了两个Kubernetes部署(蓝色、绿色),代表我们的应用程序的当前版本和新版本</li></ol><p id="f0e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.我们有一个Kubernetes服务(BlueGreen Service)可以在这两个部署之间切换。</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div class="er es kz"><img src="../Images/074d7f66bd9f76bb438baada91c66e60.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*67R-dEAt6lf7ARKWmkSpRA.png"/></div><figcaption class="jx jy et er es jz ka bd b be z dx translated">指向蓝色部署的web-service-blue-green.yml</figcaption></figure><blockquote class="je jf jg"><p id="7d1c" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi">注意</em> </strong> <em class="hi">:与生产环境(上面的图1)不同，我们</em> <strong class="ih hj"> <em class="hi">没有</em> </strong> <em class="hi">创建冒烟测试服务和冒烟测试入口，因为我们希望我们的应用能够快速部署到我们的QA服务器，在那里测试新特性</em></p></blockquote><p id="4d3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.我们有1个入口(QA入口)，用于从互联网访问我们的应用程序。</p><blockquote class="la"><p id="be76" class="lb lc hi bd ld le lf lg lh li lj jc dx translated">我们必须想办法让CircleCI知道我们当前的部署版本是什么，以及如何切换到“其他”版本。</p></blockquote><p id="0262" class="pw-post-body-paragraph if ig hi ih b ii lk ik il im ll io ip iq lm is it iu ln iw ix iy lo ja jb jc hb bi translated">为了解决这个问题，我们创建了两个相同的服务文件(除了主文件之外),分别代表用于“修补”的蓝色和绿色部署(下图中的颜色:蓝色和绿色)</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div class="er es lp"><img src="../Images/d8d33bf126369950725b49daa577e31c.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*vYWAaYgNZNAJBq4oQ4K66Q.png"/></div><figcaption class="jx jy et er es jz ka bd b be z dx translated">蓝色服务补丁</figcaption></figure><figure class="jm jn jo jp fd jq er es paragraph-image"><div class="er es lq"><img src="../Images/ed3346bdbc82e67feeece6b6c9669641.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/format:webp/1*8r1vSlYuZzAJuJX92Y0MCQ.png"/></div><figcaption class="jx jy et er es jz ka bd b be z dx translated">绿色服务补丁. yml</figcaption></figure><p id="78a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们的CircleCI部署shell脚本(deploy.sh)中，我们添加了从kubernetes服务本身获取蓝色/绿色版本的逻辑，并将我们的最新版本部署到“其他”部署，并通过“kubernetes patch”命令更新服务，如下图所示</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es lr"><img src="../Images/1b4a14d79f3530b135ad9ab8f1d59aab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lTzKiv5Kg0Wl_h5Q6j6rgA.png"/></div></div><figcaption class="jx jy et er es jz ka bd b be z dx translated">通过CircleCI识别蓝/绿部署并自动切换</figcaption></figure><p id="39f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">总结</strong>:通过使用上述方法，我们能够将QA中的应用程序版本切换时间减少到不到40秒，同时确保整个构建/测试/部署流程完全自动化。</p><p id="ed93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">资源</strong>:</p><ol class=""><li id="819f" class="kq kr hi ih b ii ij im in iq ks iu kt iy ku jc kv kw kx ky bi translated">马丁·福勒关于蓝/绿部署的文章:【https://martinfowler.com/bliki/BlueGreenDeployment.html T4】</li><li id="8a94" class="kq kr hi ih b ii ls im lt iq lu iu lv iy lw jc kv kw kx ky bi translated">滚动更新:<a class="ae jd" href="https://tachingchen.com/blog/Kubernetes-Rolling-Update-with-Deployment/" rel="noopener ugc nofollow" target="_blank">https://taching Chen . com/blog/Kubernetes-Rolling-Update-with-Deployment/</a></li><li id="1fb1" class="kq kr hi ih b ii ls im lt iq lu iu lv iy lw jc kv kw kx ky bi translated">关于这个话题的一篇优秀的CloudNative文章:<a class="ae jd" href="https://cloudnative.io/docs/blue-green-deployment/" rel="noopener ugc nofollow" target="_blank">https://cloudnative.io/docs/blue-green-deployment/</a></li><li id="125a" class="kq kr hi ih b ii ls im lt iq lu iu lv iy lw jc kv kw kx ky bi translated">蓝绿部署:<a class="ae jd" rel="noopener" href="/@nithinmallya4/blue-green-deployments-for-a-rails-app-in-google-container-engine-gke-49ddcc1b002">https://medium . com/@ nithinmallya 4/blue-Green-Deployments-for-a-rails-app-in-Google-container-engine-gke-49 ddcc 1b 002</a></li></ol></div></div>    
</body>
</html>