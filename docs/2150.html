<html>
<head>
<title>Pre-Heating Applications running on Google Cloud Run</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">运行在Google Cloud Run上的预热应用程序</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/pre-heating-cloud-run-apps-for-crisp-ux-d13c341e0a29?source=collection_archive---------2-----------------------#2022-04-01">https://medium.com/google-cloud/pre-heating-cloud-run-apps-for-crisp-ux-d13c341e0a29?source=collection_archive---------2-----------------------#2022-04-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="fae9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">德国白芦笋的生长季节开始了，这启发了我写这篇关于如何在Cloud Run上自动扩展应用程序以提供良好用户体验的教程。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/55c0e09dc7fec71d544ba7210deb3972.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZAUl7KPxdiECjHPnbpTWdA.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">在<a class="ae jt" href="https://unsplash.com/s/photos/white-asparagus?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae jt" href="https://unsplash.com/@waldemarbrandt67w?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Waldemar Brandt </a>拍照</figcaption></figure><h1 id="0492" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">种植芦笋</h1><p id="8d4e" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">在我之前的生活中，我有幸为德国的芦笋种植者设计了一个应用程序。芦笋种植面临许多挑战，生长季节大约从2月中旬开始，大约持续到6月23日圣约翰前夕。第一批芦笋大约在四月初上市，对农民来说价格最高。但是德国的芦笋需要做到完美。大小和周长需要合适，它不应该尝起来有“木质”的味道，头部应该闭合。</p><p id="63e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">芦笋的生长发育高度依赖于芦笋苗床的温度。使用一张有黑白两面的厚箔，农民可以控制床对阳光的吸收，从而加速或减缓芦笋的生长。他们通常根据18点钟的温度或大约20厘米深度的全天平均温度来决定使用铝箔的哪一面。</p><p id="4b8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的解决方案是一个简单的传感器，它可以测量芦笋床不同深度的温度，并在移动应用程序中为农民显示数据。</p><p id="f6ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们从API监测数据中了解到，该应用程序主要在3月、4月和5月使用(在5月使用，以防止芦笋过热)。6月底后，这一数字几乎降至零。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kx"><img src="../Images/1d61d8f8d19809d74ed42294ac166d51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*CYAAejA_HhhhnXENxGT7gw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">每月的API请求</figcaption></figure><p id="3bf8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">全天的使用情况也反映出大多数农民要么在晚上要么在早上计划他们的工作。但在这些时间窗口之外，这款应用的使用率很低。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ky"><img src="../Images/898accfffa20c6f86c145c197a3e0eee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*C9RxSmZZbWCGYihQwjyIyA.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">API请求在白天分发</figcaption></figure><p id="2999" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可悲的是，在那个时候，我们仍然有基础设施在运行，随时可以为用户服务，只是不需要信息，增加了成本。当时，我们希望有一个更具弹性的扩展基础设施，以实现更高的成本效益。我们的基础设施每年有六位数的运行成本(我不允许透露确切的数字)，但只有一小部分时间在使用。</p><h1 id="697d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">谷歌云运行</h1><p id="7ec2" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated"><a class="ae jt" href="https://cloud.google.com/run" rel="noopener ugc nofollow" target="_blank"> Google Cloud Run </a>允许你在Google管理的无服务器平台上调度容器。它基于<a class="ae jt" href="https://knative.dev/" rel="noopener ugc nofollow" target="_blank"> Knative </a>，一个流行的无服务器框架，反过来在引擎盖下使用<a class="ae jt" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>。对我来说，Knative最令人兴奋的特性之一是能够扩展到零。这意味着Knative能够运行应用程序的0个实例，同时仍然为来自客户端的请求提供服务。它通过“搁置”请求并启动一个容器来处理请求。</p><p id="1e58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如您所见，这是上述应用程序的理想功能。在使用窗口之外，提供API的成本基本为零。而基于用户请求量的缩放由平台动态处理。</p><h1 id="031d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">预热实例</h1><p id="8003" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">但是它也有一点不好的地方。如果还没有容器实例在运行，这会增加客户端的延迟。这可能会导致糟糕的用户体验。但是当然有办法绕过这一点。当你从上面看图表时，我们可以看到用户正常使用应用程序的清晰阶段。所以我们的目标是为我们的大多数用户提供一个好的UX。</p><p id="d00a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以做的是使用一些自动化，根据历史负载观察来显示容器的数量，以便为大多数用户确保一个清晰的UX。对于该窗口之外的使用，延迟略有下降。我将这种模式称为“预热”，我们使用云调度程序来触发云运行实例，以更新我们想要的最小数量的应用程序实例。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kz"><img src="../Images/a274d5efd5ec332471975d4f08ad0229.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*n_69eJF54ZFMdRmR"/></div></div></figure><h1 id="1ea4" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">如何设置它</h1><p id="05c7" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">预热器本身就是一个简单的web服务，用<a class="ae jt" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Golang </a>编写。调用的参数是要扩展的服务，以及要使用的最小实例数。</p><p id="48c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从预热器应用开始:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="d8aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如您所见，这是一个相当简单的go应用程序，它公开了一个端点，该端点接受一些参数来扩展或缩减云运行服务。</p><p id="2067" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了将它打包成一个简单的Docker映像，我使用了以下Docker文件:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="4669" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了构建容器映像并将其推送到您的GCR存储库，您可以克隆gist并运行以下命令:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="ef8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您还没有启动并运行云运行应用程序，您可以按照以下简单指南启动一个简单的应用程序<a class="ae jt" href="https://cloud.google.com/run/docs/quickstarts/prebuilt-deploy" rel="noopener ugc nofollow" target="_blank">https://Cloud . Google . com/Run/docs/quick starts/pre build-deploy</a></p><p id="21a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们为预热器创建一个服务帐户，它能够更新现有的云运行服务:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="a71d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于生产场景，您可能希望创建一个比标准角色roles/run.admin提供的权限更低的角色。</p><p id="3d10" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将部署一个预热器实例来云运行</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="9152" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于<a class="ae jt" href="https://cloud.google.com/scheduler" rel="noopener ugc nofollow" target="_blank">云调度器</a>需要激活AppEngine API，下一步是激活AppEngine:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="9b40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后，您可以简单地设置两个云调度器，一个用于扩展到1(或更多)，另一个用于缩减应用程序:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="042c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过运行以下命令来测试作业</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="0566" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和分别</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="6d0f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当使用以下命令进行检查时，您应该会看到min实例的数量相应地进行了调整(新版本可能需要一段时间才能激活)</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="271a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在GitHub上找到上述示例的完整源代码。<a class="ae jt" href="https://gist.github.com/cgrotz/a4a6dcf6e8aa694dfe82724d35b2cbe6" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/cgrotz/a 4 a6 DCF 6 E8 aa 694 dfe 82724d 35 B2 CBE 6</a></p><h1 id="c4ea" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">观点</h1><p id="492c" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">这让您对CloudRun所拥有的功能以及它如何帮助您提供出色的用户体验有了一个很好的概述。当然，最重要的部分是你对你的用例以及你的用户的理解，有了手边合适的工具，你就能得到很棒的解决方案。</p><p id="dc33" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前，上述实现基于实例计数的固定计划。它可以通过利用从云监控、Google Analytics或Firebase Analytics收集的监控数据进行优化，并根据这些数据进行动态扩展。</p></div></div>    
</body>
</html>