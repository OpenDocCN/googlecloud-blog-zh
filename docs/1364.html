<html>
<head>
<title>Your private PDF merge service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">您的私人PDF合并服务</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/your-private-pdf-merge-service-d4d1caa44a9b?source=collection_archive---------0-----------------------#2020-04-10">https://medium.com/google-cloud/your-private-pdf-merge-service-d4d1caa44a9b?source=collection_archive---------0-----------------------#2020-04-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e632" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(几分钟后)</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/d2f4582ae163b920711a4a74d0bf51e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*PlIMe41CEG5DECRjYnISTA.png"/></div></figure><p id="7c66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您是否曾经不得不从单个文件创建多页PDF文档？</p><p id="e057" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章将带您了解如何打包一个高效的Linux命令，将PDF文件合并到一个web应用程序中，并在Cloud Run上托管它。这使得您的朋友和家人，甚至您的企业内部都可以通过简单的浏览器或作为内部API来合并pdf。完整代码在<a class="ae jl" href="https://github.com/alexismp/pdf-merger" rel="noopener ugc nofollow" target="_blank">这个GitHub repo </a>里，现场服务在<a class="ae jl" href="https://pdf-merger-unite-nmv4siw5tq-ew.a.run.app/" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="66ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">合并PDF文件的神奇Linux命令</strong></p><p id="b55b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于StackOverflow 有一个很好的讨论，比较不同的方法和结果(速度、文档大小等等)。我最终使用了<a class="ae jl" href="https://manpages.debian.org/jessie/poppler-utils/pdfunite.1" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"><em class="jm">pdfunite</em></strong></a>但是在这里可以随意使用其他东西。</p><p id="5371" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">从命令行工具创建(web)应用</strong></p><p id="346c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使其成为web应用程序的第一步是能够从您选择的语言(在我的例子中是Java)中调用命令行工具。我<a class="ae jl" href="https://github.com/alexismp/pdf-merger/blob/master/src/main/java/org/alexismp/pdfmerger/LocalStorageService.java#L132" rel="noopener ugc nofollow" target="_blank">用了</a> <code class="du jn jo jp jq b"><a class="ae jl" href="https://github.com/alexismp/pdf-merger/blob/master/src/main/java/org/alexismp/pdfmerger/LocalStorageService.java#L132" rel="noopener ugc nofollow" target="_blank">ProcessBuilder</a></code>，以<code class="du jn jo jp jq b">inheritIO()</code>和<code class="du jn jo jp jq b">Process.waitFor()</code>完成开始。</p><p id="85a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这显然要求<code class="du jn jo jp jq b">pdfunite</code>安装在底层操作系统上，但当我们将应用程序打包到一个容器中时，这一点更重要。</p><p id="e50f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">流行的Java web框架有SpringBoot、Micronaut、Spark等。或者甚至是原始的HTTP Servlets。我使用SpringBoot，使用一个<a class="ae jl" href="https://github.com/alexismp/pdf-merger/blob/master/src/main/java/org/alexismp/pdfmerger/PDFMergerController.java" rel="noopener ugc nofollow" target="_blank">单控制器</a>来管理<code class="du jn jo jp jq b">MultipartFile</code>上传，并将所有PDF文件的存储和操作委托给一个<a class="ae jl" href="https://github.com/alexismp/pdf-merger/blob/master/src/main/java/org/alexismp/pdfmerger/LocalStorageService.java" rel="noopener ugc nofollow" target="_blank">专用服务</a>，该服务负责从文件系统中删除它使用或生成的每个文件。</p><p id="a13e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">前端非常简单；它支持四个文件上传，并保持文件被合并的顺序。(四的限制是任意选择的；后端没有施加这样的限制)。正如本<code class="du jn jo jp jq b"><a class="ae jl" href="https://github.com/alexismp/pdf-merger/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">README</a></code>中所讨论的，还有巨大的改进空间。</p><p id="6131" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，您真的不需要使用Java甚至spring boot——因为在下一步我们将把它打包成一个容器，我们真的可以在这里使用任何语言和框架的组合。</p><p id="1598" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">将此包装在一个容器中(没有Dockerfile) </strong></p><p id="fd63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Java的一个好处是它充满活力的生态系统，对我来说，这意味着使用一个开源工具<a class="ae jl" href="https://github.com/GoogleContainerTools/jib" rel="noopener ugc nofollow" target="_blank"> Jib </a>来构建和推送一个优化的容器映像，而无需编写docker文件，甚至无需安装docker。在我的例子中，我使用了Maven插件并执行了<code class="du jn jo jp jq b">mvn compile jib:build</code> (gradle也受支持)。通过<a class="ae jl" href="https://github.com/GoogleCloudPlatform/buildpacks" rel="noopener ugc nofollow" target="_blank"> Buildpacks </a>，这种构建容器的无docker文件方法可用于许多编程语言。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jr"><img src="../Images/46a23544552e81e29d3b3459c5de60d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/1*XKxQHHXwW2qfMF3kQim3SQ.png"/></div></figure><p id="900f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里的关键是要确保容器化的应用程序确实能够调用gs二进制文件。Jib无法添加linux包，所以我用一个基于<code class="du jn jo jp jq b">openjdk:11-jre-slim</code>的简单映像替换了我的<code class="du jn jo jp jq b">pom.xml</code>中默认的Jib基础映像，并添加了<code class="du jn jo jp jq b">pdfunite</code>二进制文件(<code class="du jn jo jp jq b">apt-get install poppler-utils</code>)。你实际上不需要建立这个图像，而是使用我提供的一个。</p><p id="550f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你的应用程序被打包到一个容器中，图像就会被推送到Google Cloud Registry中(作为Jib构建过程的一部分),这样部署起来就更容易、更快，标签如下:<code class="du jn jo jp jq b">gcr.io/PROJECT-ID/pdfmerger</code></p><p id="5a00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">遇见云跑</strong></p><figure class="je jf jg jh fd ji er es paragraph-image"><a href="http://cloud.run"><div class="er es js"><img src="../Images/643edb351864334607c74d7dc0d0a67b.png" data-original-src="https://miro.medium.com/v2/resize:fit:194/format:webp/0*A78-T50WZj4GN9pO.png"/></div></a></figure><p id="65ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jl" href="https://cloud.run" rel="noopener ugc nofollow" target="_blank"> Cloud Run </a>是Google完全托管的解决方案，通过按使用付费的模式自动扩展无状态容器。它使用起来非常简单，非常适合将这个小型Java web应用程序公开给外界或您的组织内部。</p><p id="835e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于我们的映像已经可以从云注册表中获得，我们可以简单地用<code class="du jn jo jp jq b"><a class="ae jl" href="https://cloud.google.com/sdk/gcloud" rel="noopener ugc nofollow" target="_blank">gcloud</a></code> : <br/> <code class="du jn jo jp jq b">$ gcloud run deploy — image gcr.io/PROJECT-ID/pdfmerger</code>部署一个新服务</p><p id="8c07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以提供选项来指定服务名、使用<em class="jm">托管的</em>平台(相对于在Kubernetes集群上托管)、部署区域。如果您希望将此网站作为公共网站进行访问或限制其通过Cloud IAM进行访问(如果这是一项可供您组织中的其他应用程序访问的服务)，您可以允许未经身份验证的请求。以下是使用<code class="du jn jo jp jq b"><a class="ae jl" href="http://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank">console.cloud.google.com</a></code>时的相关选项:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jt"><img src="../Images/c766f24d8f51c1374a7b6895136ab099.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/0*mQw8g6LQbxNGG97V"/></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ju"><img src="../Images/6874fbdc1d1596998164afcd41b8c55c.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/0*_-fXMrIAVOHE3fsO"/></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jv"><img src="../Images/7129656038922a24de6afb18a0444075.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/0*LpTfaM2YgFgftf0q"/></div></figure><p id="5caf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为<a class="ae jl" href="https://ahmet.im/blog/cloud-run-is-a-knative/" rel="noopener ugc nofollow" target="_blank"> Cloud Run是建立在Knative </a>之上的，所以你也可以在Anthos GKE上部署同样的应用，而<a class="ae jl" href="https://cloud.google.com/run/choosing-a-platform" rel="noopener ugc nofollow" target="_blank"> Cloud Run for Anthos </a>，这对于一些企业设置来说是一个很好的选择。</p><p id="2694" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署完成后(应该很快)，Cloud Run会提供一个URL:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jw"><img src="../Images/aa6b674b3fd8e7527ae5234007c537fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*a2jaxZSNP-xDz7gx"/></div></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><a href="https://pdf-merger-unite-nmv4siw5tq-ew.a.run.app/"><div class="er es kb"><img src="../Images/ed7e47479d0009b4c4dc293e75756ced.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/0*UGpPC4nGYwANgB3O"/></div></a></figure><p id="c16e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">40 MB的文件大小限制似乎是合理的，并使用SpringBoot的<code class="du jn jo jp jq b">application.properties</code>强制执行。我还将Cloud Run的内存设置提升到了2 GB。</p><p id="cf2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">关于并发的一句话</strong></p><p id="15eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cloud Run内置了并发性，这意味着多个请求可以命中同一个容器实例。这是更好地利用资源和限制冷启动的好方法。然而，这意味着您需要在构建服务时考虑到并发性；或者总是使用并发的API和服务。</p><p id="b4d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们的例子中，这意味着并发用户(所有使用给定容器实例的用户)共享同一个文件系统，记住这一点以避免以任何方式混合用户文件是很重要的。对于这个应用程序，我通过用一个共同的前缀将文件按用户分组并在列表中保留它们的顺序来解决这个问题。</p><p id="66ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">只是一个起点</strong></p><p id="ac1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用<a class="ae jl" href="https://github.com/GoogleCloudPlatform/cloud-run-button" rel="noopener ugc nofollow" target="_blank">云运行按钮</a>(与回购的<code class="du jn jo jp jq b"><a class="ae jl" href="https://github.com/alexismp/pdf-merger" rel="noopener ugc nofollow" target="_blank">README</a></code>链接)部署您自己的副本。这将封装到目前为止讨论的所有步骤，并为您提供一个包含已部署服务的URL。</p><p id="0a58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就其现状而言，这个web应用程序仍然有一些限制，但是希望它已经向您展示了一种方法，您可以通过无服务器托管的web服务来提供一个流行的命令行工具。</p><p id="fd36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有讨论过的代码都可以在<a class="ae jl" href="https://github.com/alexismp/pdf-merger" rel="noopener ugc nofollow" target="_blank">这个GitHub repo </a>中找到，这个应用的一个实例是<a class="ae jl" href="https://pdf-merger-unite-nmv4siw5tq-ew.a.run.app/" rel="noopener ugc nofollow" target="_blank">在这里运行</a>。</p><p id="bec7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">前途无量</strong></p><p id="f2d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不仅仅是PDF！您可以使用<em class="jm"> ImageMagick </em>(用于转换图像)、<em class="jm"> ffmpeg </em>(例如用于<a class="ae jl" href="https://bernd.dev/2020/04/trim-videos-instantly/" rel="noopener ugc nofollow" target="_blank">修剪视频</a>)、<em class="jm"> Inkscape </em>或任何其他可以容器化的操作系统程序。如果你想从productivity suite格式生成PDF，那么考虑使用<a class="ae jl" href="https://github.com/as-a-service/pdf" rel="noopener ugc nofollow" target="_blank">这个类似的例子</a>，它使用LibreOffice。</p></div></div>    
</body>
</html>