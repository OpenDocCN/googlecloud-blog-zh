<html>
<head>
<title>GCP — Dataflow — Egress/Ingress Deny All — How far the rabbit hole goes ?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP —数据流—出口/入口拒绝所有—兔子洞有多远？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-dataflow-egress-ingress-deny-all-how-far-the-rabbit-hole-goes-46541f361de5?source=collection_archive---------2-----------------------#2022-10-12">https://medium.com/google-cloud/gcp-dataflow-egress-ingress-deny-all-how-far-the-rabbit-hole-goes-46541f361de5?source=collection_archive---------2-----------------------#2022-10-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="6c8e" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">Dataflow是一个<strong class="il hj">托管服务</strong>，用于运行批处理和流应用程序。数据流运行用Java/Python/Go编写的<strong class="il hj"> apache beam </strong>作业。</p><p id="1ac5" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">在这篇博客中，我们将讨论当存在<strong class="il hj">高度受限网络</strong> ( <strong class="il hj">拒绝所有入口和显式拒绝所有出口规则</strong>)时会遇到何种故障，以及它<strong class="il hj">如何影响数据流工作者</strong>以及需要做什么来处理这些故障</p></blockquote></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="cc18" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">让我们从一个<strong class="il hj">简单的apache beam作业创建</strong>开始，它的功能是<strong class="il hj">读取一个JSON换行符分隔的文件</strong>，<strong class="il hj">使用python库“jsonschema”验证模式</strong>，然后<strong class="il hj">将传递的/错误记录写入BigQuery。</strong></p><p id="d0e0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">下面是用于解释的样本输入文件</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/b7d046cfa84df57e4a682b532a2eadf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aNkMEGoIHBBXd8-oHh5oUA.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx translated">input.jsonl输入Json文件</figcaption></figure><p id="7a8e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">上面红色标记的行表示模式<br/> 1中的违规。第一组的<strong class="il hj">股票价格</strong>属性被错误地称为<strong class="il hj">价格<br/> 2。</strong>第二组将<strong class="il hj">股票价格</strong>作为字符串提及，而不是<strong class="il hj">数字</strong></p><p id="9e78" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">下面是代码片段和功能解释细目。</p><p id="71d7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">JSON schema将使用JSON模式规范来解析传入的记录</p><figure class="js jt ju jv fd jw"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="9171" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated"><strong class="il hj"> validate_dofn </strong>使用上面的json模式并验证传入的记录</p><figure class="js jt ju jv fd jw"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="e278" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">数据流管道如下</p><figure class="js jt ju jv fd jw"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="9fdf" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">为工人提及python依赖性的设置文件</p><figure class="js jt ju jv fd jw"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="6e9e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">数据流作业在<br/> 1的网络上提交。<strong class="il hj">允许同一子网<br/> 2中的工作人员通过端口</strong>进行内部通信。<strong class="il hj">允许下载python依赖项的外部通信<br/> 3。子网与私人谷歌访问<br/> 4。具有外部ip地址的工人</strong></p><p id="5830" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">这项工作运行得非常好，没有遇到任何问题。</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es kj"><img src="../Images/450fd83fbb82bfe3ab44cf91ccaa85af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pw4X9NdZ4l51QXk-uLYpJw.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx translated">数据流作业图</figcaption></figure></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><blockquote class="if ig ih"><p id="b9a7" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">这通常不是客户端网络中的情况。客户端网络在本质上更具限制性</p></blockquote><p id="f216" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">让我们试着在网络中引入2个变化。<strong class="il hj">明确拒绝所有出口规则</strong></p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es kk"><img src="../Images/ef3029dc1b51276c72b06f01316a8b86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gRCF0VvgkmWqQrwt5J7j1A.png"/></div></div></figure><p id="70a9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">2.<strong class="il hj">数据流作业的公共IP被禁用</strong></p><pre class="js jt ju jv fd kl km kn ko aw kp bi"><span id="eeac" class="kq kr hi km b fi ks kt l ku kv">--no_use_public_ips</span></pre><p id="98c3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">现在，当提交作业时会发生什么，作业只是无限期地运行，没有工作日志</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es kw"><img src="../Images/62dc32f9b59e886693ee53ddc3187ce9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s_uiA6EWownlTnKRlrhK7g.png"/></div></div></figure><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es kx"><img src="../Images/ab11f56d8150f62a5f2492fc907a7d83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ataK2JPRRGhcfJToupyN1A.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx translated">工人日志</figcaption></figure></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="d7ba" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">我们从文档开始，首先回顾网络规则</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es ky"><img src="../Images/53b454ac477b2b0d6353eef245417ec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pqvGvv-vURbSjvqstKWedQ.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx translated"><a class="ae kz" href="https://cloud.google.com/dataflow/docs/guides/routes-firewall#firewall_rules" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/data flow/docs/guides/routes-firewall # firewall _ rules</a></figcaption></figure><p id="7dcb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">每个数据流工作虚拟机默认创建有网络标签— <strong class="il hj">数据流</strong></p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es la"><img src="../Images/b24e46320a4c9b7342336f48fa47050f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6ppKsKX59NRP85SAb1LoNg.png"/></div></div></figure><p id="1b05" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">让我们创建一个防火墙规则来允许上述情况</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es lb"><img src="../Images/c2fc00dd462e6752eea389809d56bee5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MnfUPghN0uBLX6R92ArZ2w.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx translated">防火墙规则</figcaption></figure></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="90cc" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">接下来，当检查网络防火墙日志时，<strong class="il hj">拒绝所有出口规则</strong>获得命中数</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es lc"><img src="../Images/7f86755c4c9242ae59a212a06c06b01d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IGl36tf9FkRRVlwSQs9Reg.png"/></div></div></figure><p id="9db2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">现在这些是<strong class="il hj"> google api ip范围</strong>，通信发生在<strong class="il hj">端口443上。</strong></p><p id="3d3b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">IP范围的详细列表发布在以下2个链接中</p><p id="3ebb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated"><a class="ae kz" href="https://www.gstatic.com/ipranges/goog.json" rel="noopener ugc nofollow" target="_blank">https://www.gstatic.com/ipranges/goog.json</a></p><p id="1752" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated"><a class="ae kz" href="https://www.gstatic.com/ipranges/cloud.json" rel="noopener ugc nofollow" target="_blank">https://www.gstatic.com/ipranges/cloud.json</a></p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es ld"><img src="../Images/86fe0494a6ba82b8efb6844943a1a42a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nd5eXChuC-lq0cOdeddAEg.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx translated"><a class="ae kz" href="https://cloud.google.com/vpc/docs/configure-private-google-access#config-firewall" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/VPC/docs/configure-private-Google-access # config-firewall</a></figcaption></figure><p id="bc7c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">让我们创建一个防火墙，允许在提到的IP范围列表上的端口443通信出口</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es lb"><img src="../Images/7cdf3e1c084de7ca90b4f38978fa5660.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AqPW9A2LeUjbYj1h5B3eng.png"/></div></div></figure><blockquote class="if ig ih"><p id="7f99" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">上面的ip地址列表是动态的，并且经常更新，允许端口443 https通信到0.0.0.0/0可能更好，但是这可能会被标记为组织中的漏洞，在这种情况下，需要编写一个程序来读取IP范围并刷新防火墙规则</p></blockquote></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="1bf4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">此外，在端口53 UDP协议上出现DNS解析错误，如下所示</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es le"><img src="../Images/869dabb82bdc90912cd372eb0c4f03c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ceqerv-RakwV_1_d7rBPKQ.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx translated">防火墙问题—云日志记录</figcaption></figure><p id="5151" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">让我们通过创建允许DNS解析发生的防火墙规则来处理它</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es lf"><img src="../Images/6439670311acc27aa014a23069c1e0f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TQufNL1NKI03F8FOVwtjKg.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx translated">防火墙允许用于DNS解析的出口通信</figcaption></figure></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="c22b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">现在，作业被创建，并进入另一个错误，如下所示</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es lg"><img src="../Images/0a5fc83c3846cbeac55da8b9e073a066.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D5jqNg2O6uq5lCdhsRPOCQ.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx translated">防火墙问题—云日志记录</figcaption></figure><p id="ba8f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">第一个日志条目显示<strong class="il hj"> setup.py </strong>正在准备中，这表明数据流工作者正试图从pypi添加额外的python包["jsonschema"]，pypi是外部服务器，在运行数据流工作者的vpc网络上被阻止。</p><p id="cefd" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">为了减少这个错误，让我们创建一个<strong class="il hj">定制工人容器映像</strong>，其中已经预安装了<strong class="il hj">必需的包。</strong></p><p id="cb51" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated"><strong class="il hj">工人图像</strong>可以从云壳使用Dockerfile轻松设置，如下所示</p><pre class="js jt ju jv fd kl km kn ko aw kp bi"><span id="3842" class="kq kr hi km b fi ks kt l ku kv">FROM apache/beam_python3.7_sdk:2.41.0<br/>RUN pip install --no-cache-dir --upgrade pip<br/>RUN pip install jsonschema==4.16.0</span></pre><p id="4ebc" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">使用gcloud构建创建自定义容器映像提交</p><pre class="js jt ju jv fd kl km kn ko aw kp bi"><span id="6794" class="kq kr hi km b fi ks kt l ku kv">gcloud builds submit -t gcr.io/&lt;project&gt;/dataflow/custom-container .</span></pre><p id="b32d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">创建映像后，可以使用以下选项提交作业</p><pre class="js jt ju jv fd kl km kn ko aw kp bi"><span id="65c0" class="kq kr hi km b fi ks kt l ku kv">--sdk_container_image gcr.io/&lt;&gt;/dataflow/custom-container</span></pre><p id="9831" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">现在不需要提供<strong class="il hj"> setup.py </strong>,因为定制容器拥有所有需要的python包依赖关系。</p><blockquote class="if ig ih"><p id="e037" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">使用setup.py提及您的代码可能需要的额外模块包</p></blockquote><p id="0ec7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">完整的命令如下所示</p><pre class="js jt ju jv fd kl km kn ko aw kp bi"><span id="fad5" class="kq kr hi km b fi ks kt l ku kv">python dataflow_job.py \<br/>--input_file_path gs://&lt;bucket&gt;/dataflow_input/ \<br/>--skip_header_lines 0 \<br/>--bigquery_target_table "&lt;project&gt;:dataset_us_central1.passed_table" \<br/>--bigquery_error_table "&lt;project&gt;:dataset_us_central1.error_table" \<br/>--temp_location "gs://&lt;bucket&gt;/dataflow-temp-path/" \<br/>--runner DataflowRunner \<br/>--project &lt;project&gt; \<br/>--region us-central1 \<br/>--job_name "dataflow-job-1" \<br/>--subnetwork "https://www.googleapis.com/compute/v1/projects/&lt;project&gt;/regions/us-central1/subnetworks/dataflow-subnet-uscentral1" \<strong class="km hj"><br/>--no_use_public_ips \<br/>--sdk_container_image gcr.io/&lt;project&gt;/dataflow/custom-container</strong></span></pre><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es lh"><img src="../Images/4b7864686079860f436510905e7b0380.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*om5qrtPi818Ko5GKa3CIsg.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx translated">成功的作业执行</figcaption></figure></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="464e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">总之，执行的活动列表为<br/> 1。为标签数据流<br/> 2打开端口12345:12346上的数据流工作虚拟机通信。允许在公布的google api ip地址列表上的出口通信<br/> 3。允许来自1.1.1.1、8.8.8.8和8.8.8.4的DNS解析端口53上的出口通信<br/> 4。为任何特定的python包要求创建自定义容器。</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es li"><img src="../Images/0bb2bd0833605dd2ed356f9845a6bc08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gnsyldE1n_4gEiKvA_LM-Q.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx translated">所有防火墙规则的摘要</figcaption></figure></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="7492" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">希望这有助于更好地理解数据流的要求。请发表评论，让我知道这是否有用</p><p id="74de" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jo iv iw ix jp iz ja jb jq jd je jf jg hb bi translated">LinkedIn-handle—【https://www.linkedin.com/in/murli-krishnan-a1319842/ T4】</p></div></div>    
</body>
</html>