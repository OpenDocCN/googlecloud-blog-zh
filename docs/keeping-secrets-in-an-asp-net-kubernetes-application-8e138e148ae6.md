# åœ¨ ASP.NETÂ·åº“ä¼¯å†…ç‰¹çš„åº”ç”¨ç¨‹åºä¸­ä¿å®ˆç§˜å¯†

> åŸæ–‡ï¼š<https://medium.com/google-cloud/keeping-secrets-in-an-asp-net-kubernetes-application-8e138e148ae6?source=collection_archive---------1----------------------->

åœ¨æ›´æ—©çš„ä¸€ä¸ªåä¸º[çš„æ•…äº‹ä¸­ã€‚NET çš„ appsettings.json](/google-cloud/keeping-secrets-in-asp-nets-appsettings-json-5694e533dc87) ï¼Œæˆ‘ç”¨[è°·æ­Œäº‘å¯†é’¥ç®¡ç†æœåŠ¡(KMS)](https://cloud.google.com/kms/) æ¼”ç¤ºäº†å¦‚ä½•åœ¨`appsecrets.json`ä¸­ä¿å¯†ã€‚ç”Ÿæˆçš„åº”ç”¨ç¨‹åºæ˜“äºç»´æŠ¤ï¼Œå› ä¸ºæœºå¯†æ˜¯ç”¨æºä»£ç è¿›è¡ŒåŠ å¯†å’Œç‰ˆæœ¬æ§åˆ¶çš„ï¼Œè§£å¯†å¯†é’¥ä»ä¸åˆ†å‘ç»™å¼€å‘äººå‘˜æˆ–ç³»ç»Ÿç®¡ç†å‘˜ï¼Œå¹¶ä¸”æœºå¯†æ˜¯ç”±è¿è¡Œåº”ç”¨ç¨‹åºçš„ç”Ÿäº§æœåŠ¡å™¨åœ¨æœ€åä¸€åˆ»è§£å¯†çš„ã€‚å®Œæ•´çš„æ•…äº‹åŒ…å«æ›´å¤šçš„ç»†èŠ‚ã€‚

æˆ‘å·²ç»å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°äº†[è°·æ­Œè®¡ç®—å¼•æ“](https://cloud.google.com/compute/)å’Œ[è°·æ­Œåº”ç”¨å¼•æ“](https://cloud.google.com/appengine/)ã€‚æœ€è¿‘ï¼Œæˆ‘å†³å®šå°†åŒæ ·çš„åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° [Google Kubernetes å¼•æ“](https://cloud.google.com/kubernetes-engine/) (GKE)ã€‚å› ä¸ºä¿å®ˆç§˜å¯†æ˜¯ä¸€ä»¶ä¸¥è‚ƒçš„äº‹æƒ…ï¼Œæ‰€ä»¥æˆ‘æƒ³éµå¾ªå®‰å…¨æœ€ä½³å®è·µï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªæƒé™æœ€å°çš„è°·æ­ŒæœåŠ¡è´¦æˆ·ã€‚æœåŠ¡å¸æˆ·ç”¨äºèº«ä»½éªŒè¯å’Œæˆæƒã€‚é»˜è®¤çš„ GKE æœåŠ¡å¸æˆ·æ¯”æˆ‘çš„åº”ç”¨ç¨‹åºéœ€è¦çš„ç‰¹æƒå¤šå¾—å¤šï¼Œè¿™æ˜¯ä¸€ä¸ªå®‰å…¨é£é™©ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªå…³äºæœåŠ¡å¸æˆ·çš„å¿«é€Ÿä»‹ç»ã€‚æˆ‘çš„åº”ç”¨ç¨‹åºå’Œ[è°·æ­Œäº‘ KMS](https://cloud.google.com/kms/) ä¹‹é—´çš„å¯¹è¯å¦‚ä¸‹:

![](img/187111198082ceace185cb8a79e154d7.png)

ä¸ºäº†èƒ½å¤Ÿåœ¨ GKE å®ä¾‹ä¸Šè§£å¯†`appsecrets.json.encrypted`,æˆ‘å¿…é¡»åœ¨ GKE å®ä¾‹ä¸Šå®‰è£… Google äº‘æœåŠ¡å¸æˆ·å‡­è¯ã€‚

æˆ‘æ‰¾åˆ°äº†ä¸¤ç§æ–¹æ³•æ¥åšåˆ°è¿™ä¸€ç‚¹:

**æ–¹æ³• 1** åˆ›å»ºæ–°çš„ GKE é›†ç¾¤æˆ–[èŠ‚ç‚¹æ± ](https://cloud.google.com/kubernetes-engine/docs/concepts/node-pools)æ—¶ï¼Œå®‰è£…æœåŠ¡å¸æˆ·å‡­è¯ã€‚è¿™å¾ˆå¿«ä¹Ÿå¾ˆå®¹æ˜“ï¼Œä½†æ˜¯å¦‚æœ Kubernetes é›†ç¾¤åœ¨å…¶ä»–åœ°æ–¹è¿è¡Œï¼Œè¿™å°±è¡Œä¸é€šäº†ã€‚

**æ–¹æ³•äºŒ**å®‰è£…ä¸€ä¸ªæœåŠ¡è´¦å·å¯†é’¥ä½œä¸º K [ubernetes secret](https://kubernetes.io/docs/concepts/configuration/secret/) ã€‚å½“é›†ç¾¤è¿è¡Œåœ¨ Google Cloud å†…éƒ¨æˆ–å¤–éƒ¨æ—¶ï¼Œå®ƒéƒ½å¯ä»¥å·¥ä½œã€‚ä¸**æ–¹æ³• 1** ä¸åŒï¼Œå®ƒå°†æœåŠ¡å¸æˆ·å¯†é’¥äº¤ä»˜ç»™ç°æœ‰èŠ‚ç‚¹ï¼Œå› æ­¤ä¸éœ€è¦åˆ›å»ºæ–°èŠ‚ç‚¹ã€‚å®ƒè¿˜å…è®¸åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ä¸åŒåº”ç”¨ç¨‹åºä½¿ç”¨ä¸åŒçš„æœåŠ¡å¸æˆ·ã€‚

å‘åº”ç”¨ç¨‹åºä¼ é€’ç§˜å¯†çš„æœ€â€œKubernetes æ–¹å¼â€æ˜¯åˆ›å»ºä¸€ä¸ªåŒ…å«`appsecrets.json.`çš„ Kubernetes ç§˜å¯†ã€‚æˆ‘è®¡åˆ’åœ¨ä»¥åçš„å¸–å­ä¸­è®¨è®ºè¿™ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œä½†æ˜¯åœ¨è¿™ç¯‡å¸–å­ä¸­æˆ‘å°†åšæŒä½¿ç”¨**æ–¹æ³• 1** å’Œ**æ–¹æ³• 2** ï¼Œå› ä¸ºå®ƒä»¬éµå¾ªäº†åœ¨ ASP ä¸­ä¿å­˜ç§˜å¯†[ä¸­æè¿°çš„æ¨¡å¼ã€‚NET çš„ appsettings.json](/google-cloud/keeping-secrets-in-asp-nets-appsettings-json-5694e533dc87) ï¼Œå¾ˆå¤šäººå‘ç°è¿™ä¸ªæ¨¡å¼å¾ˆæœ‰ç”¨ã€‚æ­¤å¤–ï¼Œä¸€æ—¦æˆ‘å®‰è£…äº†è°·æ­ŒæœåŠ¡å¸æˆ·å‡­è¯ï¼Œæˆ‘å°±å¯ä»¥è½»æ¾åœ°è°ƒç”¨å…¶ä»–æœ‰ç”¨çš„è°·æ­Œäº‘ APIï¼Œå¦‚[è¯­éŸ³è½¬æ–‡æœ¬](https://cloud.google.com/speech-to-text/)å’Œ[è§†è§‰](https://cloud.google.com/vision/)ã€‚

# åˆ›å»º Google äº‘æœåŠ¡å¸æˆ·

è¿™ä¸¤ç§æ–¹æ³•éƒ½éœ€è¦ä¸€ä¸ªè°·æ­Œäº‘[æœåŠ¡è´¦æˆ·](https://cloud.google.com/iam/docs/understanding-service-accounts)æ¥è®¤è¯æˆ‘çš„åº”ç”¨ï¼Œæ‰€ä»¥æˆ‘ç”¨[è°·æ­Œäº‘ SDK](http://cloud.google.com/sdk) ä¸­çš„`gcloud`å‘½ä»¤åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„æœåŠ¡è´¦æˆ·:

```
**> gcloud iam service-accounts create my-service-account**
Created service account [my-service-account].
```

éµå¾ªæœ€å°ç‰¹æƒåŸåˆ™ï¼Œæˆ‘ç»™äº†æœåŠ¡å¸æˆ·è¶³å¤Ÿçš„æƒé™ä» Google Cloud Container Registry ä¸­è·å– Docker å›¾åƒå¹¶å†™å…¥è°ƒè¯•ä¿¡æ¯:

ç„¶åï¼Œæˆ‘ç»™äº†æœåŠ¡å¸æˆ·è§£å¯†`appsecrets.json.encrypted:`çš„æƒé™

æˆ‘çš„æ–°æœåŠ¡è´¦æˆ·å·²ç»å‡†å¤‡å¥½äº†åœ¨ GKE ä¸Šè¿è¡Œåº”ç”¨ç¨‹åºå’Œè§£å¯†`appsecrets.json.encrypted`æ‰€éœ€çš„æœ€ä½æƒé™ã€‚

# æ–¹æ³• 1

å½“åœ¨ GKE ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„é›†ç¾¤æ—¶ï¼Œæˆ‘ä½¿ç”¨äº†`--service-account`æ ‡å¿—æ¥æŒ‡å®šæˆ‘åœ¨ä¸Šé¢åˆ›å»ºçš„æœåŠ¡å¸æˆ·ã€‚

æˆ‘ä¹Ÿå¯ä»¥è®©[åœ¨ç°æœ‰é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹æ± ](https://cloud.google.com/sdk/gcloud/reference/container/node-pools/create)ï¼Œå¹¶ä¼ é€’ç›¸åŒçš„`--service-account`æ ‡å¿—ã€‚

æˆ‘éƒ¨ç½²äº†æˆ‘çš„åº”ç”¨ç¨‹åºå¹¶æš´éœ²äº†ç«¯å£ 8080:

æˆ‘è®¿é—®äº†ç”³è¯·ä¸»é¡µã€‚å®ƒæˆåŠŸè§£å¯†äº†å¯†è¯­ï¼

![](img/bc3a0ed2f6a431dbc3d4ab4ae0620e43.png)

æˆåŠŸï¼

# æ–¹æ³• 2

**æ–¹æ³• 1** å¾ˆå¥½ï¼Œä½†æ˜¯åªæœ‰å½“æˆ‘çš„åº”ç”¨ç¨‹åºåœ¨ GKE ä¸Šè¿è¡Œæ—¶æ‰æœ‰æ•ˆã€‚å¦‚ä½•åœ¨å…¶ä»–åœ°æ–¹è¿è¡Œçš„ Kubernetes èŠ‚ç‚¹ä¸Šå®‰è£… Google äº‘æœåŠ¡å¸æˆ·å‡­è¯ï¼Ÿ

å¹¸è¿çš„æ˜¯ï¼Œæ‰€æœ‰çš„ Google å®¢æˆ·ç«¯ API åº“éƒ½ä¼šæ£€æŸ¥ç¯å¢ƒå˜é‡`GOOGLE_APPLICATION_CREDENTIALS`ã€‚ç¯å¢ƒå˜é‡`GOOGLE_APPLICATION_CREDENTIALS`å­˜å‚¨äº†ä¸€ä¸ªæœåŠ¡å¸æˆ·å¯†é’¥çš„è·¯å¾„ï¼Œæ‰€ä»¥æˆ‘é¦–å…ˆéœ€è¦çš„æ˜¯ä¸€ä¸ªæœåŠ¡å¸æˆ·å¯†é’¥ã€‚æˆ‘ç”¨`gcloud`åˆ›å»ºäº†æœåŠ¡å¸æˆ·å¯†é’¥:

å°†å¯†é’¥æ‰“åŒ…åˆ° Docker æ˜ åƒä¸­å¾ˆæœ‰è¯±æƒ‘åŠ›ï¼Œä½†è¿™å°†æ˜¯éå¸¸ä¸å®‰å…¨çš„ã€‚æ¯ä¸ªè¢«å…è®¸é˜…è¯» Docker å›¾åƒçš„äººéƒ½å¯ä»¥è§£å¯†`appsecrets.json.encrypted`ã€‚é‚£å¾ˆç³Ÿç³•ã€‚

ç„¶åæˆ‘äº†è§£äº† K[ubernetes secret](https://kubernetes.io/docs/concepts/configuration/secret/)s . Kubernetes secret æ˜¯ä¸€ä¸ªåŒ…å«å°‘é‡æ•æ„Ÿæ•°æ®çš„å¯¹è±¡ï¼Œå¦‚å¯†ç ã€ä»¤ç‰Œæˆ–å¯†é’¥ã€‚é‚£æ­£æ˜¯æˆ‘æ‰€éœ€è¦çš„ã€‚

æˆ‘åˆ›é€ äº†ä¸€ä¸ª kubernetes çš„ç§˜å¯†ï¼Œå¹¶æ·»åŠ äº†`key.json`:

æˆ‘å°è¯•ç”¨æˆ‘åœ¨**æ–¹æ³• 1** ä¸­ä½¿ç”¨çš„ç›¸åŒçš„`kubectl`å‘½ä»¤éƒ¨ç½²æˆ‘çš„åº”ç”¨ç¨‹åºï¼Œä½†æ˜¯æˆ‘å¿˜è®°è®¾ç½®`GOOGLE_APPLICATION_CREDENTIALS`ï¼Œæ‰€ä»¥åº”ç”¨ç¨‹åºä¸å¥åº·:

![](img/d25a4ba684729ea41d371bd733c5e907.png)

å®¹å™¨æ—¥å¿—å‘Šè¯‰æˆ‘ä¸ºä»€ä¹ˆï¼Œè¿™æ­£æ˜¯æˆ‘æ‰€é¢„æ–™çš„æƒé™é”™è¯¯:

![](img/c553fc835ec80b3cd6577c3af81a6ae4.png)

æ˜¯æ—¶å€™å°†ç¯å¢ƒå˜é‡`GOOGLE_APPLICATION_CREDENTIALS`è®¾ç½®ä¸ºæˆ‘åœ¨ä¸Šé¢åˆ›å»ºçš„ Kubernetes secret äº†ã€‚è¿™éœ€è¦åœ¨ 3 ä¸ªä¸åŒçš„åœ°æ–¹æ¥è§¦æˆ‘çš„éƒ¨ç½²é…ç½®ã€‚æˆ‘ç”¨å‘½ä»¤`kubectl edit deployment social-auth-v3`ç¼–è¾‘äº†éƒ¨ç½²ï¼Œå¹¶ä¿®æ”¹äº†éƒ¨ç½²ã€‚è¿™æ˜¯ä¸€ä¸ªç¼©å†™çš„ yaml æ–‡ä»¶ï¼Œæˆ‘çš„ä¿®æ”¹ç”¨æ³¨é‡Šæ ‡å‡ºã€‚

æˆ‘ç”¨ä¸€ä¸ª[æ»šåŠ¨æ›´æ–°](https://kubernetes.io/docs/tasks/run-application/rolling-update-replication-controller/)é‡å¯äº†æˆ‘çš„éƒ¨ç½²ï¼Œæœ€åï¼Œæˆ‘çš„åº”ç”¨æ‰¾åˆ°äº†æœåŠ¡è´¦æˆ·å‡­è¯å¹¶æˆåŠŸè§£å¯†äº†`appsecrets.json`ã€‚

![](img/bc3a0ed2f6a431dbc3d4ab4ae0620e43.png)

æˆåŠŸï¼

# ç»“è®º

å½“æ‚¨[åˆ›å»ºä¸€ä¸ªæ–°çš„ Kubernetes é›†ç¾¤](https://cloud.google.com/sdk/gcloud/reference/container/clusters/create)æˆ–[èŠ‚ç‚¹æ± ](https://cloud.google.com/sdk/gcloud/reference/container/node-pools/create)æ—¶ï¼Œ`[gcloud](https://cloud.google.com/sdk/)`å¯ä»¥è½»æ¾å®‰è£…æœåŠ¡å¸æˆ·å‡­è¯ã€‚ [Kubernetes secrets](https://kubernetes.io/docs/concepts/configuration/secret/) æ— è®ºæ‚¨çš„åº”ç”¨ç¨‹åºåœ¨å“ªé‡Œè¿è¡Œï¼Œéƒ½å¯ä»¥å®‰è£…æœåŠ¡å¸æˆ·å‡­è¯ã€‚

è¿™ä¸ªç»ƒä¹ ä¸­æœ€å›°éš¾çš„éƒ¨åˆ†æ˜¯æ‰¾åˆ°æ­£ç¡®çš„ã€æœ€å°çš„æƒé™é›†æ¥æˆäºˆæœåŠ¡å¸æˆ·ã€‚å¾ˆè‡ªç„¶åœ°ï¼Œåœ¨æˆ‘çš„åº”ç”¨ç¨‹åºå¯åŠ¨å¹¶è¿è¡Œåï¼Œæˆ‘ç«‹å³åœ¨è¿™é‡Œæ‰¾åˆ°äº†ç¡®åˆ‡çš„ä¿¡æ¯ã€‚[ğŸ˜€](https://en.wikipedia.org/wiki/%F0%9F%98%80)

ä½¿ç”¨æœåŠ¡å¸æˆ·éªŒè¯ Google äº‘å¹³å°çš„å®Œæ•´è¯´æ˜åœ¨[è¿™é‡Œ](https://cloud.google.com/kubernetes-engine/docs/tutorials/authenticating-to-cloud-platform)ã€‚å®Œæ•´çš„åº”ç”¨ç¨‹åºç¤ºä¾‹æºä»£ç æ˜¯[è¿™é‡Œæ˜¯](https://github.com/GoogleCloudPlatform/dotnet-docs-samples/tree/e56e9ee661d64c1309455707510b5b90c2fdfd4e/appengine/flexible/SocialAuth)ã€‚