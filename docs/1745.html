<html>
<head>
<title>Boost Istio Service Mesh by upgrading to HTTP 2 — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过升级到HTTP 2-第1部分来增强Istio服务网格</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/boost-istio-service-mesh-by-upgrading-to-http-2-part-1-65e73da57bc4?source=collection_archive---------0-----------------------#2021-01-07">https://medium.com/google-cloud/boost-istio-service-mesh-by-upgrading-to-http-2-part-1-65e73da57bc4?source=collection_archive---------0-----------------------#2021-01-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a4cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你正在使用Istio，并且你正在寻找简单的方法来加速服务网格，这是给你的帖子。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/153ed02d1ab04503e2eb462a50dec15b.png" data-original-src="https://miro.medium.com/v2/resize:fit:636/format:webp/1*xG6Mwhsp01vP8ato9SHhNA.jpeg"/></div></figure><p id="64c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于HTTP 2比HTTP 1.1有多快，效率有多高，已经有很多文章写了。你可以在这里阅读<a class="ae jl" href="https://www.thewebmaster.com/hosting/2015/dec/14/what-is-http2-and-how-does-it-compare-to-http1-1/" rel="noopener ugc nofollow" target="_blank">，在这里</a>阅读<a class="ae jl" href="https://www.tunetheweb.com/blog/http-versus-https-versus-http2/" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jm"><img src="../Images/2ac82f10f30e6d3eb0d97915f3785907.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*cy28ahAIJGUZTn7h6rO_7A.gif"/></div></figure><p id="9c2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我看到的大多数服务网格实现仍然使用古老的HTTP 1.1，并且没有将其连接升级到HTTP/2。</p><p id="8b38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，一个网格是由许多应用程序组成的。其中一些应用程序可能使用HTTP 1.1或HTTP/2。以我的经验来看，大部分app(如果不是全部的话)还是在HTTP 1.1上。升级网格上的所有微服务可能需要一些时间和精力，即使风险可以忽略不计。</p><p id="f6fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">如果我们将所有的网状网流量升级到HTTP/2，我们应该会立即得到提升，而不会冒任何额外的风险。</strong></p><p id="227a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以通过简单地检查istio-proxy日志来验证我们的服务是在HTTP1.1还是HTTP/2上。</p><p id="73a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了演示这一点，我安装了Istio附带的图书信息应用程序。</p><div class="jn jo ez fb jp jq"><a href="https://istio.io/latest/docs/setup/getting-started/" rel="noopener  ugc nofollow" target="_blank"><div class="jr ab dw"><div class="js ab jt cl cj ju"><h2 class="bd hj fi z dy jv ea eb jw ed ef hh bi translated">入门指南</h2><div class="jx l"><h3 class="bd b fi z dy jv ea eb jw ed ef dx translated">设置入口端口:$ export INGRESS _ PORT = $(ku bectl-n istio-system get service istio-Ingres gateway-o…</h3></div><div class="jy l"><p class="bd b fp z dy jv ea eb jw ed ef dx translated">istio.io</p></div></div><div class="jz l"><div class="ka l kb kc kd jz ke jj jq"/></div></div></a></div><p id="d633" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从浏览器导航到产品页面后，打开产品应用程序和下游应用程序的istio-proxy日志-详细信息。</p><p id="040d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">产品应用程序(升级前):</p><pre class="je jf jg jh fd kf kg kh ki aw kj bi"><span id="470b" class="kk kl hi kg b fi km kn l ko kp">kubectl logs -f productpage-v1-64794f5db4-fqpgp -c istio-proxy</span><span id="4ba2" class="kk kl hi kg b fi kq kn l ko kp">[2021-01-06T13:44:45.994Z] "GET /details/0 <strong class="kg hj">HTTP/1.1</strong>" 200 - "-" 0 178 2 1 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "9a425a61-b88f-9b49-858d-252ed262e549" "details:9080" "10.1.1.31:9080" <strong class="kg hj">outbound</strong>|9080||details.default.svc.cluster.local 10.1.1.36:59852 10.99.56.191:9080 10.1.1.36:42486 - default</span><span id="e764" class="kk kl hi kg b fi kq kn l ko kp">[2021-01-06T13:44:46.000Z] "GET /reviews/0 <strong class="kg hj">HTTP/1.1</strong>" 200 - "-" 0 379 15 15 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "9a425a61-b88f-9b49-858d-252ed262e549" "reviews:9080" "10.1.1.34:9080" <strong class="kg hj">outbound</strong>|9080||reviews.default.svc.cluster.local 10.1.1.36:56232 10.101.5.33:9080 10.1.1.36:48422 - default</span><span id="39e4" class="kk kl hi kg b fi kq kn l ko kp">[2021-01-06T13:44:45.990Z] "GET /productpage <strong class="kg hj">HTTP/1.1</strong>" 200 - "-" 0 5183 28 28 "192.168.65.3" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "9a425a61-b88f-9b49-858d-252ed262e549" "localhost" "127.0.0.1:9080" <strong class="kg hj">inbound</strong>|9080|| 127.0.0.1:50076 10.1.1.36:9080 192.168.65.3:0 outbound_.9080_._.productpage.default.svc.cluster.local default</span></pre><p id="564e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，<strong class="ih hj">入站</strong>和<strong class="ih hj">出站</strong>连接的默认TCP协议都在HTTP 1.1上。</p><p id="d6d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们检查一个下游应用程序的日志。</p><p id="7340" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">详细信息应用程序(升级前):</p><pre class="je jf jg jh fd kf kg kh ki aw kj bi"><span id="feb4" class="kk kl hi kg b fi km kn l ko kp">kubectl logs -f details-v1-5974b67c8-rcnr9 -c istio-proxy</span><span id="ed94" class="kk kl hi kg b fi kq kn l ko kp">[2021-01-06T13:44:46.171Z] "GET /details/0 <strong class="kg hj">HTTP/1.1</strong>" 200 - "-" 0 178 1 1 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "c00e80f6-bef2-9843-b4b9-eb1112ae3887" "details:9080" "127.0.0.1:9080" <strong class="kg hj">inbound</strong>|9080|| 127.0.0.1:49528 10.1.1.31:9080 10.1.1.36:59788 outbound_.9080_._.details.default.svc.cluster.local default</span></pre><p id="1fb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在要做的就是让Istio知道我们要升级所有的HTTP 1.1。HTTP 2的调用。</p><p id="c6a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi kr translated">注意:还有一个重要的秘密步骤，我稍后会透露。</p><h1 id="b628" class="la kl hi bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">履行</h1><p id="0d8c" class="pw-post-body-paragraph if ig hi ih b ii lx ik il im ly io ip iq lz is it iu ma iw ix iy mb ja jb jc hb bi translated">有两种方法可以解决这个问题:</p><p id="48eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选项1:升级全局网格配置，将所有HTTP 1.1连接升级到HTTP/2</p><p id="114b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选项2:一次升级目标rules 1服务</p><p id="55dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本帖中，我们将只探讨选项1。</p><h2 id="0563" class="kk kl hi bd lb mc md me lf mf mg mh lj iq mi mj ln iu mk ml lr iy mm mn lv mo bi translated">选项1</h2><p id="f605" class="pw-post-body-paragraph if ig hi ih b ii lx ik il im ly io ip iq lz is it iu ma iw ix iy mb ja jb jc hb bi translated">这很容易实现。我们必须为“istio-system”名称空间中的“istio”配置图打补丁</p><pre class="je jf jg jh fd kf kg kh ki aw kj bi"><span id="241d" class="kk kl hi kg b fi km kn l ko kp"><strong class="kg hj">h2UpgradePolicy: UPGRADE</strong></span></pre><p id="d6e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">描述istio-system命名空间中的当前istio配置映射。</p><pre class="je jf jg jh fd kf kg kh ki aw kj bi"><span id="5d9d" class="kk kl hi kg b fi km kn l ko kp">kubectl describe configmap istio -n istio-system</span></pre><p id="8bda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">记下数据/网格下的所有值。</p><p id="83af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建configmap-patch.yaml</p><p id="48a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将数据/网格下的上述值添加到下面的yaml文件+ <strong class="ih hj"> h2UpgradePolicy: UPGRADE。</strong></p><pre class="je jf jg jh fd kf kg kh ki aw kj bi"><span id="7a60" class="kk kl hi kg b fi km kn l ko kp">data:<br/>  mesh: |-<br/>    <strong class="kg hj">h2UpgradePolicy: UPGRADE</strong><br/>    accessLogFile: /dev/stdout<br/>    defaultConfig:<br/>      discoveryAddress: istiod.istio-system.svc:15012<br/>      proxyMetadata:<br/>        DNS_AGENT: ""<br/>      tracing:<br/>        zipkin:<br/>          address: zipkin.istio-system:9411<br/>    enablePrometheusMerge: true<br/>    rootNamespace: istio-system<br/>    trustDomain: cluster.local</span></pre><p id="3dee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行kubectl patch命令。</p><pre class="je jf jg jh fd kf kg kh ki aw kj bi"><span id="f979" class="kk kl hi kg b fi km kn l ko kp">kubectl patch configmap istio -n istio-system --patch "$(cat /configmap-patch.yaml)"</span></pre><p id="2e27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再次描述istio-system名称空间中的istio configmap，并验证除了新添加的值(<strong class="ih hj">H2 UPGRADE policy:UPGRADE)</strong>之外，旧值是否存在。</p><pre class="je jf jg jh fd kf kg kh ki aw kj bi"><span id="7ad1" class="kk kl hi kg b fi km kn l ko kp">kubectl describe configmap istio -n istio-system</span></pre><p id="9d51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi kr translated">注意:我们的意图是添加<strong class="ih hj">H2升级策略:升级</strong>并避免修补现有配置。</p><p id="b2ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！</p><p id="9c63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">像以前一样点击产品页面上的刷新。</p><p id="11d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">产品应用程序(升级后):</p><pre class="je jf jg jh fd kf kg kh ki aw kj bi"><span id="225e" class="kk kl hi kg b fi km kn l ko kp">kubectl logs -f productpage-v1-64794f5db4-fqpgp -c istio-proxy</span><span id="a454" class="kk kl hi kg b fi kq kn l ko kp">[2021-01-06T13:46:07.929Z] "GET /details/0 <strong class="kg hj">HTTP/1.1</strong>" 200 - "-" 0 178 6 6 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "e1a591e7-2624-9616-b7b6-45d40346bcb4" "details:9080" "10.1.1.31:9080" <strong class="kg hj">outbound</strong>|9080||<strong class="kg hj">details.default.svc.cluster.local</strong> 10.1.1.36:33304 10.99.56.191:9080 10.1.1.36:43680 - default</span><span id="7921" class="kk kl hi kg b fi kq kn l ko kp">[2021-01-06T13:46:07.940Z] "GET /reviews/0 <strong class="kg hj">HTTP/1.1</strong>" 200 - "-" 0 375 26 26 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "e1a591e7-2624-9616-b7b6-45d40346bcb4" "reviews:9080" "10.1.1.35:9080" <strong class="kg hj">outbound</strong>|9080||<strong class="kg hj">reviews.default.svc.cluster.local</strong> 10.1.1.36:46090 10.101.5.33:9080 10.1.1.36:49620 - default</span><span id="a273" class="kk kl hi kg b fi kq kn l ko kp">[2021-01-06T13:46:07.925Z] "GET /productpage <strong class="kg hj">HTTP/2</strong>" 200 - "-" 0 5179 45 44 "192.168.65.3" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "e1a591e7-2624-9616-b7b6-45d40346bcb4" "localhost" "127.0.0.1:9080" <strong class="kg hj">inbound</strong>|9080|| 127.0.0.1:51270 10.1.1.36:9080 192.168.65.3:0 outbound_.9080_._.productpage.default.svc.cluster.local default</span></pre><p id="cffd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">等等！为什么有些<strong class="ih hj">出站</strong>日志还是说协议是HTTP 1.1，而<strong class="ih hj">入站</strong>日志是HTTP/2？</p><p id="5f5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">发生这种情况是因为示例中Product App使用的HTTP客户端库使用HTTP 1.1协议。我们需要使用支持HTTP/2的库(参见下面的<strong class="ih hj">重要提示</strong>)。</p><p id="072d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">详细信息应用程序(升级后):</p><pre class="je jf jg jh fd kf kg kh ki aw kj bi"><span id="a804" class="kk kl hi kg b fi km kn l ko kp">kubectl logs -f details-v1-5974b67c8-rcnr9 -c istio-proxy</span><span id="651c" class="kk kl hi kg b fi kq kn l ko kp">[2021-01-06T13:46:07.933Z] "GET /details/0 <strong class="kg hj">HTTP/2</strong>" 200 - "-" 0 178 2 1 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "e1a591e7-2624-9616-b7b6-45d40346bcb4" "details:9080" "127.0.0.1:9080" <strong class="kg hj">inbound</strong>|9080|| 127.0.0.1:51276 10.1.1.31:9080 10.1.1.36:33304 outbound_.9080_._.details.default.svc.cluster.local default</span></pre><p id="011c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">源自产品应用程序的请求位于HTTP 1.1上(请参见升级后的产品应用程序日志)；Istio现在将其升级到HTTP/2，并将其传递给Details App。</p></div><div class="ab cl mp mq gp mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="hb hc hd he hf"><h2 id="0cee" class="kk kl hi bd lb mc md me lf mf mg mh lj iq mi mj ln iu mk ml lr iy mm mn lv mo bi translated">重要说明</h2><p id="294f" class="pw-post-body-paragraph if ig hi ih b ii lx ik il im ly io ip iq lz is it iu ma iw ix iy mb ja jb jc hb bi translated"><em class="mw">记住，我们正在指示Istio将连接从HTTP 1.1升级到HTTP/2。它不能神奇地让部署的应用程序中的HTTP/ReST客户端库使用HTTP/2。我们需要升级我们的应用程序以使用HTTP/2。</em></p><p id="2c6b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，Spring Boot支持HTTP/2，这取决于所使用的web服务器。要完全迁移到HTTP/2，我们需要指示Spring Boot迁移到HTTP/2。</p><div class="jn jo ez fb jp jq"><a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#howto-configure-http2" rel="noopener  ugc nofollow" target="_blank"><div class="jr ab dw"><div class="js ab jt cl cj ju"><h2 class="bd hj fi z dy jv ea eb jw ed ef hh bi translated">Spring Boot参考文献</h2><div class="jx l"><h3 class="bd b fi z dy jv ea eb jw ed ef dx translated">包com . example . my application；导入org . spring framework . boot . spring application；导入…</h3></div><div class="jy l"><p class="bd b fp z dy jv ea eb jw ed ef dx translated">docs.spring.io</p></div></div></div></a></div><p id="f80e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有一个有用的帖子:</p><div class="jn jo ez fb jp jq"><a href="https://byte27.com/2020/02/03/using-http-2-in-your-spring-boot-application/" rel="noopener  ugc nofollow" target="_blank"><div class="jr ab dw"><div class="js ab jt cl cj ju"><h2 class="bd hj fi z dy jv ea eb jw ed ef hh bi translated">在您的Spring Boot应用程序中使用HTTP/2</h2><div class="jx l"><h3 class="bd b fi z dy jv ea eb jw ed ef dx translated">对于本教程，我假设您有一个基于Unix的环境，在这个环境中您可以运行openssl和…</h3></div><div class="jy l"><p class="bd b fp z dy jv ea eb jw ed ef dx translated">byte27.com</p></div></div></div></a></div></div><div class="ab cl mp mq gp mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="hb hc hd he hf"><h1 id="e049" class="la kl hi bd lb lc mx le lf lg my li lj lk mz lm ln lo na lq lr ls nb lu lv lw bi translated">结论</h1><p id="b112" class="pw-post-body-paragraph if ig hi ih b ii lx ik il im ly io ip iq lz is it iu ma iw ix iy mb ja jb jc hb bi translated">Istio将我们的连接升级到一个更高效的协议真是太好了。但是，应该通过将网格上的所有应用程序移动到HTTP/2来避免升级。考虑到HTTP/2已经存在了很长时间，无论涉及到什么技术，这都不会太难。</p><p id="2c16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">风险极小，而收益巨大。</p></div></div>    
</body>
</html>