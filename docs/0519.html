<html>
<head>
<title>TCP BBR : Magic dust for network performance.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TCP BBR:网络性能的魔尘。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/tcp-bbr-magic-dust-for-network-performance-57a5f1ccf437?source=collection_archive---------0-----------------------#2018-02-15">https://medium.com/google-cloud/tcp-bbr-magic-dust-for-network-performance-57a5f1ccf437?source=collection_archive---------0-----------------------#2018-02-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/d9dc4b6b7d36750855f51f34b01f8003.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i8gFMHNLtQJj-DnrepTSjw.jpeg"/></div></div></figure><div class=""/><p id="2b53" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">大多数人都不知道，今天的互联网运行在80年代设计的算法和协议上。你知道，回到像“留言板”这样最令人兴奋的事情发生的时候。</p><p id="50f6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但这不是今天的互联网。今天的互联网分布在70亿人的设备和网络连接上，从令人惊叹的1GB /秒有线连接到……嗯..不是。</p><p id="7f01" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就带来了一个问题，也许今天的互联网需要要求并升级我们30年前制作的那些算法。</p><p id="997d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">这就是BBR TCP的用武之地。</strong>这是一种TCP拥塞控制算法，针对现代互联网的拥塞而构建。</p><figure class="jp jq jr js fd hk"><div class="bz dy l di"><div class="jt ju l"/></div></figure><h1 id="b64e" class="jv jw ht bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">TCP:分享就是关爱。</h1><p id="5cc8" class="pw-post-body-paragraph iq ir ht is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">TCP试图平衡快速(快速传输数据)和平衡(多个用户共享管道)之间的需求，更注重平衡。</p><p id="6868" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">大多数TCP实现使用退避算法，这导致您获得管道的带宽(任何大于该带宽的带宽都会排挤其他人)。不利的一面是，即使你是唯一使用管道的人，TCP通常也会大量利用你的网络连接(高达50%)。</p><p id="054c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是TCP的主要问题，它对平衡网络传输的关注导致了带宽的浪费。</p><h1 id="4fe3" class="jv jw ht bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">TCP BBR:重要的比特</h1><p id="f902" class="pw-post-body-paragraph iq ir ht is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">你可以阅读<a class="ae ky" href="http://queue.acm.org/detail.cfm?id=3022184" rel="noopener ugc nofollow" target="_blank">的论文</a>了解更多细节，但要点是BBR是一种拥塞控制技术，它:</p><p id="5e5d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">旨在应对实际拥塞，而不是丢包。</strong>BBR团队设计这种算法的目的是希望能够对实际的拥塞做出反应，而不是丢包。BBR对网络进行建模，使其发送速度与可用带宽一样快，在10Gb、100毫秒的链路上比以前的TCP快2700倍，并且只有1%的丢失</p><p id="83df" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">专注于在网络不太好时提高网络性能。</strong> TCP BBR更准确地平衡了公平性和利用率，从而在同一网络上获得更快的下载速度。这在网络不好的情况下最明显(然而，如果你在一个非常干净的网络上，这不会伤害你)</p><p id="8483" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">不要求客户端实现BBR </strong>。这是神奇的仙尘。以前的算法，如QUIC，要求客户机&amp;服务器都实现该算法。BBR不要求客户也使用BBR。这在发展中国家尤其重要，这些国家使用较旧的移动平台，带宽有限，或者网站服务还没有进行转换的地区。</p><h1 id="77ae" class="jv jw ht bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">带着BBR去兜风</h1><p id="6d65" class="pw-post-body-paragraph iq ir ht is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">这一切听起来很好，但让我们踢踢轮胎，看看这项技术到底有多好。为了进行测试，我在两个不同的区域设置了两个虚拟机，并做了一个快速的Iperf测试来检查它们的性能:</p><p id="6513" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">[4]0.0–10.0秒9.97千兆字节8.55千兆位/秒</em></p><p id="0d23" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了模拟BBR有用的理想条件(高分组丢失),我们执行下面的tc命令，模拟特定百分比的分组丢失。</p><p id="a7a6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> <em class="jo"> sudo tc qdisc add dev eth0根netem损失1.5% </em> </strong></p><p id="242f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当现有虚拟机连接时，我们看到性能显著下降(这是我们预料到的):</p><p id="1cab" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">[3]0.0–10.3秒1.10千兆字节921兆比特/秒</em></p><p id="1619" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，我们在服务器端仅使用以下命令打开BBR:</p><p id="12e0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"><em class="jo">sysctl-w net . IP v4 . TCP _ congestion _ control = BBR</em></strong></p><p id="606d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">(注意，这只是在您使用4.10+ linux内核的情况下，否则，您将需要<a class="ae ky" href="https://github.com/google/bbr/blob/master/Documentation/bbr-quick-start.md" rel="noopener ugc nofollow" target="_blank">来执行这些步骤</a>)</p><p id="12e3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们做了同样的Iperf测试</p><p id="3084" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">[3]0.0–10.0秒2.90千兆字节2.49千兆位/秒</em></p><p id="2cd5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们看到，仅仅为了在服务器中设置一个简单的标志，原始连接的带宽就增加了近两倍。</p><figure class="jp jq jr js fd hk er es paragraph-image"><div class="er es kz"><img src="../Images/0fa2edf40e26750e44a2d2c6bb3f4e02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*8Afkx9n-OnMzc0VXYUF1_w.png"/></div></figure><h1 id="a233" class="jv jw ht bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">在哪里使用TCP BBR？</h1><p id="f385" class="pw-post-body-paragraph iq ir ht is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">这是最棒的部分，如果你在谷歌云平台上构建你的技术，那么你已经让BBR在运行了。谷歌云平台的<a class="ae ky" href="https://cloud.google.com/endpoints/" rel="noopener ugc nofollow" target="_blank">前端</a>、<a class="ae ky" href="https://cloud.google.com/load-balancing/" rel="noopener ugc nofollow" target="_blank">负载均衡器</a>和<a class="ae ky" href="https://cloud.google.com/appengine/" rel="noopener ugc nofollow" target="_blank">托管服务</a>已经启用了TCP BBR，所以你在糟糕地区的任何客户端都已经看到了性能的提升。</p><p id="a16d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，如果你将一个VM端点直接暴露给用户(比方说，对于一个VPN)，那么你将需要自己启用TCP BBR(如果你的内核支持BBR，通过设置标志，或者<a class="ae ky" href="https://github.com/google/bbr/blob/master/Documentation/bbr-quick-start.md" rel="noopener ugc nofollow" target="_blank">自己编译升级</a>，或者将端点放在一个GFE接口后面(关于这方面的更多信息，请参见我以前对<a class="ae ky" rel="noopener" href="/@duhroach/profiling-gcps-load-balancers-94c552f06736"> HTTP负载平衡</a>的测试)。</p><p id="acc9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，大部分的好处将会出现在<strong class="is hu">面向不良流量区域终端的客户端上</strong>。因此，如果您在虚拟机之间启用此功能，如果情况没有明显好转，也不要惊慌。也就是说，使用它没有坏处，即使是在良好的连接区域；</p><p id="cfe7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我的建议？打开它，告诉你的用户你已经取得了巨大的性能改善，并继续去关注更重要的事情；)</p></div></div>    
</body>
</html>