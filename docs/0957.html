<html>
<head>
<title>Downsampling and Exporting Google Cloud Monitoring Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">缩减采样和导出Google云监控数据</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/downsampling-and-exporting-stackdriver-monitoring-data-c3483e88a352?source=collection_archive---------1-----------------------#2019-03-27">https://medium.com/google-cloud/downsampling-and-exporting-stackdriver-monitoring-data-c3483e88a352?source=collection_archive---------1-----------------------#2019-03-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b082" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更新:此帖子已经更新，包括自首次发布以来对平台的更改:</p><ol class=""><li id="0ced" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">Stackdriver更名为谷歌云监控。</li><li id="e4f3" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">云监控Python API出现了突破性的变化。更多详情参见<a class="ae jr" href="https://github.com/googleapis/python-monitoring/blob/master/UPGRADING.md" rel="noopener ugc nofollow" target="_blank">迁移指南</a>。</li></ol><p id="db14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌云监控包含大量关于云资源使用的信息，包括谷歌云平台(GCP)和其他来源。这篇文章将解释如何使用云监控API来读取、缩减采样和导出数据到BigQuery。发布/订阅指标将用于演示这一点。您可以将指标更改为与您更相关的类型，或者按照[发布/订阅快速入门](【https://cloud.google.com/pubsub/docs/quickstart-cli】T2)生成此处示例中使用的指标类型。</p><p id="00ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出于多种原因，您可能希望导出监控数据，包括</p><ul class=""><li id="aaef" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc js jj jk jl bi translated">对数据的即席查询，比如对时间序列进行转换和比较，或者在时间之外的维度上分析数据。这对于识别浪费尤其有用，例如虚拟机CPU占用率低、磁盘空间浪费或数据从未被访问。或者您可能对应用程序进行了更改，并希望比较效率和性能。</li><li id="eec8" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc js jj jk jl bi translated">将指标数据保留的时间长于标准的<a class="ae jr" href="https://cloud.google.com/monitoring/quotas#data_retention_policy" rel="noopener ugc nofollow" target="_blank">保留期</a>。这篇文章还将解释如何对时间序列数据进行缩减采样，以将旧数据量从云监控使用的默认1分钟间隔减少到1小时间隔。下采样降低了数据存储成本。长期数据可用于长期预测或分析长期趋势。您可能希望覆盖外部数据，如经济状况或季节性事件。</li><li id="bde9" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc js jj jk jl bi translated">保存特殊事件的数据，如性能测试或营销发布</li></ul><p id="9b6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Colab是Google提供的iPython的变体。Colab是实现我们目标的理想工具，因为它允许使用Python客户端API编写脚本来实验和探索数据。Colab还内置了许多for Google APIs，并支持执行一些shell命令。当您在Colab中导出数据时，您可能希望将它转移到由cron或<a class="ae jr" href="https://cloud.google.com/scheduler/" rel="noopener ugc nofollow" target="_blank"> Google Cloud Scheduler </a>驱动的常规作业中。</p><p id="4745" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，使用命令将<a class="ae jr" href="https://cloud.google.com/monitoring/api/ref_v3/rpc/google.monitoring.v3" rel="noopener ugc nofollow" target="_blank">monitoring _ v3 API</a>导入到Colab中</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="8fd5" class="kc kd hi jy b fi ke kf l kg kh">!pip install --upgrade google-cloud-monitoring</span></pre><p id="db8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该命令使用Colab！指令来执行shell命令。</p><p id="3cea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用Python语句向GCP进行身份验证</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="f2cf" class="kc kd hi jy b fi ke kf l kg kh">from google.colab import auth<br/>auth.authenticate_user()</span></pre><p id="6c9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将打开一个新的浏览器窗口进行身份验证。</p><p id="2c44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导入监视API，并使用以下语句创建一个客户端对象</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="599d" class="kc kd hi jy b fi ke kf l kg kh">from google.cloud import monitoring_v3<br/>client = monitoring_v3.MetricServiceClient()</span></pre><p id="07a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们设置一些变量来保存输入值:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="fa22" class="kc kd hi jy b fi ke kf l kg kh">import datetime</span><span id="1e89" class="kc kd hi jy b fi ki kf l kg kh">target_project = '[Your project]'<br/>start = datetime.datetime(2019,3,5, 0, 0, 0, 0)<br/>end = datetime.datetime(2019,3,6, 0, 0, 0, 0)<br/>topic_bytes = 'pubsub.googleapis.com/topic/byte_cost'</span></pre><p id="0a03" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将从目标项目收集为期一天的数据，从2020年11月10日凌晨1:00开始，到2020年11月10日世界协调时凌晨2:00结束。假设我们有许多项目，那么我们可以更改target_project的值，并将数据导出到一个home项目中。这将允许从许多项目中收集度量数据到一个中心位置。</p><p id="092a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将导出的发布/订阅指标之一是主题/字节成本。还有更多<a class="ae jr" href="https://cloud.google.com/monitoring/api/metrics_gcp" rel="noopener ugc nofollow" target="_blank"> GCP指标</a>可供选择，还有其他云和开源指标。</p><p id="39d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以通过下面的函数来了解这些指标</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="2a73" class="kc kd hi jy b fi ke kf l kg kh">def list_metric_descriptors(client, project_resource, metric):<br/>  resource_descriptors = client.list_metric_descriptors(<br/>      project_resource,<br/>      'metric.type="{}"'.format(metric))<br/>  for descriptor in resource_descriptors:<br/>    print(descriptor)</span></pre><p id="990b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将给出度量种类(本例中为DELTA)、值类型(int64)、描述和其他细节。如果我们在监控仪表板中查看指标，我们会看到类似于下图的低流量应用程序:</p><figure class="jt ju jv jw fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kj"><img src="../Images/6e3190579da9f9bef8accfb3633977ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fJQtV1TYH9HxC7OwiFCWAg.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx translated">主题字节增量度量类型图表</figcaption></figure><p id="378c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从该图中我们可以看到，每5分钟通过发布/订阅服务发送的数据量约为4.88 KB。</p><p id="115d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以用下面的函数对时间序列进行下采样</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="6357" class="kc kd hi jy b fi ke kf l kg kh">from google.cloud.monitoring_v3.types.metric_service import ListTimeSeriesRequest<br/>from google.protobuf import duration_pb2 as duration<br/>from google.protobuf import timestamp_pb2 as timestamp</span><span id="4191" class="kc kd hi jy b fi ki kf l kg kh">def to_csv_delta_metric(client, project_resource, filter, start, end, frequency, colname):</span><span id="e87a" class="kc kd hi jy b fi ki kf l kg kh">  """Exports downsampled metrics to a string buffer in CSV format<br/>  Exports the timeseries created between start and end with given<br/>  frequency in seconds to a string buffer in comma separated<br/>  variable format<br/>  """<br/>  end_time = timestamp.Timestamp(seconds=int(end.timestamp()))<br/>  start_time = timestamp.Timestamp(seconds=int(start.timestamp()))<br/>  interval = monitoring_v3.types.TimeInterval(end_time=end_time,<br/>                                              start_time=start_time)<br/>  aggregation = monitoring_v3.types.Aggregation(<br/>      alignment_period = duration.Duration(seconds=frequency),<br/>      per_series_aligner =   <br/>        monitoring_v3.Aggregation.Aligner.ALIGN_DELTA,<br/>      cross_series_reducer =<br/>        monitoring_v3.Aggregation.Reducer.REDUCE_SUM<br/>  )<br/>  req = ListTimeSeriesRequest(<br/>      name = project_resource,<br/>      filter = filter,<br/>      interval = interval,<br/>      view = monitoring_v3.ListTimeSeriesRequest.TimeSeriesView.FULL<br/>  )<br/>  results = client.list_time_series(req)<br/>  csv = '{0},{1}\n'.format('time', colname)<br/>  t = int(start.timestamp())<br/>  ts_array = []<br/>  for ts in results:<br/>    ts_array.append(ts)<br/>    if len(ts_array) &gt; 0:<br/>      ts = ts_array[0]<br/>      for p in ts.points:<br/>        t += frequency<br/>        v = p.value.int64_value<br/>        csv += '{0},{1}\n'.format(t, v)<br/>      return csv<br/>    else:<br/>      print('Did not get any results back')<br/></span></pre><p id="094f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个<a class="ae jr" href="https://cloud.google.com/monitoring/api/v3/filters" rel="noopener ugc nofollow" target="_blank">过滤器</a>被应用于选择相关的度量，因此可以检索多个时间序列。这种下采样功能适用于“增量”型指标。有关delta和其他度量种类的详细信息，请参见<a class="ae jr" href="https://cloud.google.com/monitoring/api/v3/metrics-details" rel="noopener ugc nofollow" target="_blank">度量种类</a>。该系列与delta减压器对齐。Delta类型的度量通常是相加的，这就是我们对上面的聚合对象所做的。结果以逗号分隔的形式放在一个字符串缓冲区中，我们将把它加载到下面的Google云存储(GCS)中。</p><p id="5c3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以使用函数将缓冲区上传到GCS</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="a835" class="kc kd hi jy b fi ke kf l kg kh">def upload_gcs(bucket, buf, filename):<br/>  fname = '/tmp/{}'.format(filename)<br/>  with open(fname, 'w') as f:<br/>    f.write(buf)<br/>  print('head {}:'.format(fname))<br/>  !gsutil cp {fname} gs://{bucket}/</span></pre><p id="3371" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些函数可以用下面的代码调用</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="23ad" class="kc kd hi jy b fi ke kf l kg kh">metric_names = ['topic/byte_cost',<br/>    'subscription/byte_cost',<br/>    'topic/send_request_count',<br/>    'topic/message_sizes']<br/>colnames = ['topic_bytes',<br/>    'sub_bytes',<br/>    'send_request_count',<br/>    'message_sizes']<br/>frequency = 3600 # 1 hour<br/>for i in range(len(metric_names)):<br/>  filter =  'metric.type="pubsub.googleapis.com/{0}"'.format(metric_names[i])<br/>  filename = '{0}.csv'.format(colnames[i])<br/>  csv_buffer = to_csv_delta_metric(client,<br/>      project_resource,<br/>      filter,<br/>      start,<br/>      end,<br/>      frequency,<br/>      colnames[i])<br/>  upload_gcs(bucket, csv_buffer, filename)</span></pre><p id="365e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将导出四个发布/订阅指标的时间序列，假设缩减采样间隔为一小时。要了解更多关于使用monitoring_v3 API提取指标的信息，请参见<a class="ae jr" href="https://cloud.google.com/monitoring/custom-metrics/reading-metrics" rel="noopener ugc nofollow" target="_blank">读取指标数据</a>。</p><p id="6e39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以用下面的语句将数据装载到BigQuery中</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="a1b3" class="kc kd hi jy b fi ke kf l kg kh">for i in range(len(colnames)):<br/>  filename = '{0}.csv'.format(colnames[i])<br/>  tablename = colnames[i]<br/>  !bq --project_id={home_project_id} \<br/>      --location=US load \<br/>      --autodetect \<br/>      --source_format=CSV {dataset}.{tablename} \<br/>      gs://{bucket}/{filename}</span></pre><p id="a962" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦数据被加载到BigQuery中，我们就可以对其进行查询。在从上面的Stackdriver中读取时间序列后，我们可以在上面对它进行查询，但是，一般来说，我们希望定期将数据加载到BigQuery中，然后过一段时间再回来对它进行特别查询。</p><p id="3fa8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们做一个简单的查询来验证下采样是正确的。可以使用BigQuery客户端API从Colab中的BigQuery查询数据。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="a759" class="kc kd hi jy b fi ke kf l kg kh">from google.cloud import bigquery</span><span id="7733" class="kc kd hi jy b fi ki kf l kg kh">bq_client = bigquery.Client(project=home_project_id)<br/>df = bq_client.query('''<br/>    SELECT<br/>      time, topic_bytes<br/>    FROM `{0}.topic_bytes`'''.format(dataset)).to_dataframe()</span><span id="81e7" class="kc kd hi jy b fi ki kf l kg kh">print(df)</span></pre><p id="0bc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">来自查询的数据被读入Pandas数据帧df。</p><p id="a3f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以使用Python图形实用程序(如matplotlib)查看数据。熊猫也可以用来创建一个简单的图表与以下声明</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="0af6" class="kc kd hi jy b fi ke kf l kg kh">df.plot.bar(y='topic_bytes',<br/>            title='Topic Byte Cost',<br/>            color=['darkgrey'])</span></pre><p id="6a4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这导致了图表</p><figure class="jt ju jv jw fd kk er es paragraph-image"><div class="er es kv"><img src="../Images/0343ac18fd684b262d6a8f58e528fc53.png" data-original-src="https://miro.medium.com/v2/resize:fit:782/format:webp/1*F217XkQiJaRPxe4agma9Rw.png"/></div><figcaption class="kr ks et er es kt ku bd b be z dx translated">降采样数据(x轴是时间，y轴是字节)</figcaption></figure><p id="9975" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们检查我们的数学。请注意，我们在一天的总时间间隔内以一小时的频率进行下采样。上图中有24根棒线，所以时间加起来就是原来的周期。目测每小时的平均值略低于60，000字节。根据上面的图表，我们在5分钟的时间间隔内有4.88 kB。12 * 4.88 = 58.56 kB小时，接近预期值(那是解脱)。</p></div></div>    
</body>
</html>