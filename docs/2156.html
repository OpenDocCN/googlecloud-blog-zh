<html>
<head>
<title>Google Cloud: Managed Microsoft Active Directory</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云:托管微软活动目录</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-managed-microsoft-active-directory-d40e3cdfbba9?source=collection_archive---------0-----------------------#2022-04-12">https://medium.com/google-cloud/google-cloud-managed-microsoft-active-directory-d40e3cdfbba9?source=collection_archive---------0-----------------------#2022-04-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a7167d065d9835a081110e552fbe404a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KzO-gYltWvwqF-g0YNHKgw.png"/></div></div></figure><p id="290b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/managed-microsoft-ad/docs/overview" rel="noopener ugc nofollow" target="_blank">托管微软活动目录</a> (MS AD)是谷歌云平台(GCP)上的一款完全托管的活动目录软件即服务。像许多托管服务一样，MS AD减少了自己运行服务的管理开销。设置很容易，因为你只需要五个输入。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jp"><img src="../Images/2ef37c8a5f62215776a7517a7a1382e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*buRuTwrzNNXpQIylZy88-w.png"/></div></div></figure><p id="054f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好处:</p><ul class=""><li id="9da8" class="ju jv hi is b it iu ix iy jb jw jf jx jj jy jn jz ka kb kc bi translated">局部性。靠近您在GCP的Microsoft工作负载的Active Directory。</li><li id="d627" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated">安全。<a class="ae jo" href="https://cloud.google.com/managed-microsoft-ad/docs/hardening" rel="noopener ugc nofollow" target="_blank">托管广告不暴露于互联网</a>。所有通信都是通过授权网络的私有IP进行的。</li><li id="ae01" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated">地理多样性。多个控制器可以部署在不同的区域。</li></ul><p id="1ea6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">基本拓扑镜像GCPs <a class="ae jo" href="https://cloud.google.com/architecture/deploy-fault-tolerant-active-directory-environment#architecture" rel="noopener ugc nofollow" target="_blank">容错微软活动目录环境</a>。为了实现高可用性，在一个区域内的不同区域中总会部署两个域控制器。可以在其他区域部署额外的控制器，以实现多区域可用性。每个域支持多达四个<a class="ae jo" href="https://cloud.google.com/managed-microsoft-ad/docs/add-remove-regions#regions" rel="noopener ugc nofollow" target="_blank">支持的区域</a>。</p><figure class="jq jr js jt fd ij er es paragraph-image"><a href="https://cloud.google.com/architecture/images/fault-tolerant-ad-overview.png"><div class="er es ki"><img src="../Images/98126f03e301a1e9f805dcebf6d3fe5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FDqoRfdvSpdxQHJETOTsww.png"/></div></a><figcaption class="kj kk et er es kl km bd b be z dx translated">最小GCP容错Microsoft Active Directory体系结构</figcaption></figure><p id="2ad1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建MS AD实例时，还会创建一个<a class="ae jo" href="https://cloud.google.com/dns/docs/zones/zones-overview#forwarding_zones" rel="noopener ugc nofollow" target="_blank"> DNS转发区域</a>，这是一种特殊类型的<a class="ae jo" href="https://cloud.google.com/dns/docs/best-practices" rel="noopener ugc nofollow" target="_blank">专用区域</a>，其中的DNS记录仅在您的组织内部可见，并且在授权的VPC和MS AD VPC之间建立DNS对等。从您指定的IP地址池中为控制器分配动态专用IP地址。这些IP地址对您不可见，因此您使用控制器的完全限定域名而不是IP地址进行连接。</p><figure class="jq jr js jt fd ij er es paragraph-image"><a href="https://cloud.google.com/managed-microsoft-ad/docs/seamless-dns"><div class="er es kn"><img src="../Images/a96f3c71c38c9ff1ba04f0849288533f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zl4L1BeLtX_ysncNqavwtg.png"/></div></a><figcaption class="kj kk et er es kl km bd b be z dx translated">托管活动目录和项目之间的VPC和DNS对等</figcaption></figure><h1 id="62a2" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">部署</h1><p id="9cb5" class="pw-post-body-paragraph iq ir hi is b it lm iv iw ix ln iz ja jb lo jd je jf lp jh ji jj lq jl jm jn hb bi translated">Google提供了一个<a class="ae jo" href="https://codelabs.developers.google.com/codelabs/cloud-managed-ad" rel="noopener ugc nofollow" target="_blank"> Codelabs </a>供你试验。下面是该过程的总结和变化。这些步骤假定已经为您的工作负载创建了VPC和子网。</p><ol class=""><li id="2c9a" class="ju jv hi is b it iu ix iy jb jw jf jx jj jy jn lr ka kb kc bi translated">启用DNS和托管身份API。</li></ol><pre class="jq jr js jt fd ls lt lu lv aw lw bi"><span id="d392" class="lx kp hi lt b fi ly lz l ma mb">gcloud services enable dns.googleapis.com<br/>gcloud services enable managedidentities.googleapis.com</span></pre><p id="8696" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.创建域控制器。指定将部署控制器的区域以及可以访问MS AD的授权VPC(网络)。保留的IP范围是您选择的私有/24 IP地址空间(<a class="ae jo" href="https://datatracker.ietf.org/doc/html/rfc1918" rel="noopener ugc nofollow" target="_blank"> RFC 1918 </a>)，并且在AD域中应该是唯一的。由于域控制器位于专用的VPC中，并使用<a class="ae jo" href="https://cloud.google.com/vpc/docs/vpc-peering" rel="noopener ugc nofollow" target="_blank"> VPC对等</a>连接到其他VPC，如果存在重叠子网，对等将不会建立。一个建议是<a class="ae jo" href="https://cloud.google.com/managed-microsoft-ad/docs/selecting-ip-address-ranges" rel="noopener ugc nofollow" target="_blank"> 192.168.255.0/24 </a>，因为这是一个不常用的有效范围。</p><pre class="jq jr js jt fd ls lt lu lv aw lw bi"><span id="9840" class="lx kp hi lt b fi ly lz l ma mb">export PROJECT_ID=$(gcloud config get-value project)<br/>export PROJECT_NUMBER=$(gcloud projects describe ${PROJECT_ID} \<br/>    --format="value(projectNumber)")<br/>export DOMAIN_NAME="ad.local"<br/>export IP_RANGE="192.168.255.0/24"<br/>export REGION="us-central1"<br/>export VPC="vpc-1"</span><span id="f07f" class="lx kp hi lt b fi mc lz l ma mb">gcloud active-directory domains create $DOMAIN_NAME \<br/>--reserved-ip-range=$IP_RANGE \<br/>--region=$REGION \<br/>--authorized-networks=projects/$PROJECT_ID/global/networks/$VPC</span></pre><p id="f29c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">验证部署状态。部署可能需要60分钟才能完成。</p><pre class="jq jr js jt fd ls lt lu lv aw lw bi"><span id="f52a" class="lx kp hi lt b fi ly lz l ma mb">gcloud active-directory domains describe $DOMAIN_NAME</span></pre><p id="ba06" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.MS AD域的默认用户名是“<a class="ae jo" href="https://cloud.google.com/managed-microsoft-ad/docs/how-to-use-delegated-admin" rel="noopener ugc nofollow" target="_blank"> setupadmin </a>”。为MS AD设置密码。如果使用GCP控制台设置密码，密码只会出现一次，因此请注意。否则，您必须重新设置。</p><pre class="jq jr js jt fd ls lt lu lv aw lw bi"><span id="c69e" class="lx kp hi lt b fi ly lz l ma mb">#Set MS AD password using the gcloud command<br/>gcloud active-directory domains reset-managed-identities-admin-password $DOMAIN_NAME</span></pre><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/1b88f7b94c03b507e07c9982401ae31c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fzBjYv8J-t7eYG4X5cmg7A.png"/></div></div><figcaption class="kj kk et er es kl km bd b be z dx translated">使用GCP控制台设置MS AD密码</figcaption></figure><p id="c60e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.要管理您的MS AD，请使用受<a class="ae jo" href="https://cloud.google.com/managed-microsoft-ad/docs/os-versions#windows-domain-join" rel="noopener ugc nofollow" target="_blank">支持的Windows版本</a>创建一个Windows虚拟机，作为管理虚拟机。因为不能直接访问MS AD，所以您需要管理虚拟机充当客户端。此外，创建防火墙规则以允许RDP连接。最后，设置windows虚拟机密码。虚拟机可能需要10分钟才能就绪。</p><pre class="jq jr js jt fd ls lt lu lv aw lw bi"><span id="2aed" class="lx kp hi lt b fi ly lz l ma mb">export REGION="us-central1"<br/>export ZONE="us-central1-a"<br/>export VPC="vpc-1"<br/>export SUBNET="subnet-1"<br/>export VM_NAME="admin-vm"</span><span id="9a6a" class="lx kp hi lt b fi mc lz l ma mb">#Create Windows VM<br/>gcloud compute instances create $VM_NAME \<br/>--zone=$ZONE \<br/>--machine-type=n1-standard-2 \<br/>--subnet=$SUBNET \<br/>--network-tier=PREMIUM \<br/>--scopes=https://www.googleapis.com/auth/cloud-platform \<br/>--image=windows-server-2016-dc-v20181009 \<br/>--image-project=windows-cloud \<br/>--boot-disk-size=50GB \<br/>--boot-disk-type=pd-standard</span><span id="1e62" class="lx kp hi lt b fi mc lz l ma mb">#Create FW rule to allow RDP<br/>gcloud compute firewall-rules create allow-rdp --network=$VPC --allow tcp:3389</span><span id="182f" class="lx kp hi lt b fi mc lz l ma mb">#Set Windows VM password<br/>gcloud compute reset-windows-password --user=user1 $VM_NAME</span></pre><p id="ecc3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.使用<a class="ae jo" href="https://cloud.google.com/compute/docs/instances/connecting-to-windows" rel="noopener ugc nofollow" target="_blank"> RDP </a>连接到管理Windows虚拟机。在我们的示例中，我们的Windows管理虚拟机是运行<a class="ae jo" href="https://docs.microsoft.com/en-us/windows-server/administration/server-manager/server-manager" rel="noopener ugc nofollow" target="_blank">服务器管理器</a>的Windows 2016服务器。你可以按照这个指南在Windows 2016上安装RSAT:<a class="ae jo" href="https://www.hammer-software.com/how-to-install-remote-server-administration-tools-rsat-on-windows-server-2016/" rel="noopener ugc nofollow" target="_blank">安装远程服务器管理工具</a><a class="ae jo" href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/system-management-components/remote-server-administration-tools" rel="noopener ugc nofollow" target="_blank">【RSAT】</a>。在其他Windows版本上，RSAT安装可能会有所不同。</p><p id="0b0f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">提示:如果您不想使用Windows GUI安装，可以在Windows Powershell(管理模式)中使用以下cmdlet来安装RSAT，该cmdlet适用于Windows Server 2016。</p><p id="5337" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">完成后，您应该在“工具”菜单下看到Active Directory工具。</p><pre class="jq jr js jt fd ls lt lu lv aw lw bi"><span id="026d" class="lx kp hi lt b fi ly lz l ma mb">Install-WindowsFeature -Name "RSAT-AD-Tools" -IncludeAllSubFeature -IncludeManagementTools -Confirm</span></pre><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/df00d643e1e7459e6c3d1bdd29940259.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m3Xa0pAjtooAmnTb-NIQ6Q.png"/></div></div><figcaption class="kj kk et er es kl km bd b be z dx translated">安装在Windows服务器管理器中的Active Directory工具</figcaption></figure><p id="3206" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.<a class="ae jo" href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/join-a-computer-to-a-domain" rel="noopener ugc nofollow" target="_blank">使用委派管理员帐户“setupadmin”和您生成的MS AD密码将管理虚拟机添加到域</a>。重新启动虚拟机以加入域。使用delegated administrator帐户再次登录，并使用您安装的<a class="ae jo" href="https://cloud.google.com/managed-microsoft-ad/docs/how-to-use-delegated-admin#using_active_directory_domain_services_tools" rel="noopener ugc nofollow" target="_blank"> AD工具</a>来连接和管理MS AD。谷歌计算引擎(GCE)虚拟机被预先配置为使用云DNS，并且在授权的VPC和MS AD VPC之间建立DNS对等。因此，<strong class="is hj">虚拟机无需任何客户端配置即可发现MS AD，</strong>这是一个很好的运营优势。</p><p id="f82c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">托管微软AD提供<a class="ae jo" href="https://cloud.google.com/managed-microsoft-ad/docs/manage-active-directory-objects" rel="noopener ugc nofollow" target="_blank">两个组织单元(ou)</a>:云和云服务对象。云是在您的托管Microsoft AD域中创建的，用于托管您的所有AD对象。您被授予对云ou的完全管理访问权限，并且只能更新云服务对象OU的某些属性。使用云OU创建用户、组、计算机或进一步的子OU。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/dec094ad6b65bec3bd4d40a7ce126992.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hD4Pgs6lTgM1GXxcZ6fWXg.png"/></div></div></figure><p id="b621" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">部署MS AD后，您可以考虑其他设计选项，如混合部署。额外的指南和注意事项列在进一步阅读部分。</p></div><div class="ab cl mf mg gp mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="hb hc hd he hf"><h2 id="4be3" class="lx kp hi bd kq mm mn mo ku mp mq mr ky jb ms mt lc jf mu mv lg jj mw mx lk my bi translated">进一步观察</h2><figure class="jq jr js jt fd ij"><div class="bz dy l di"><div class="mz na l"/></div><figcaption class="kj kk et er es kl km bd b be z dx translated">谷歌云管理微软活动目录</figcaption></figure></div><div class="ab cl mf mg gp mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="hb hc hd he hf"><pre class="jq jr js jt fd ls lt lu lv aw lw bi"><span id="b4a8" class="lx kp hi lt b fi ly lz l ma mb"><strong class="lt hj">Further Reading</strong></span><span id="f90f" class="lx kp hi lt b fi mc lz l ma mb"><a class="ae jo" href="https://cloud.google.com/blog/products/identity-security/managed-service-for-microsoft-active-directory-is-ga" rel="noopener ugc nofollow" target="_blank">Google Blog: Managed Service for Microsoft Active Directory is GA</a><br/><a class="ae jo" href="https://codelabs.developers.google.com/codelabs/cloud-managed-ad" rel="noopener ugc nofollow" target="_blank">CodeLabs: Cloud Managed Active Directory</a><br/><a class="ae jo" href="https://cloud.google.com/managed-microsoft-ad/docs" rel="noopener ugc nofollow" target="_blank">Google Cloud: MS AD Documentation</a><br/><a class="ae jo" href="https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-domain-services" rel="noopener ugc nofollow" target="_blank">Microsoft: Active Directory Domain Services Documentation</a><br/><a class="ae jo" href="https://cloud.google.com/managed-microsoft-ad/docs/faq" rel="noopener ugc nofollow" target="_blank">Google Cloud: Managed Active Directory FAQ</a><br/><a class="ae jo" rel="noopener" href="/sada-engineering/using-gcp-managed-active-directory-to-simplify-domain-authentication-4d8b4a12985b">SADA Blog: Using GCP Managed Active Directory to Simplify Domain Authentication</a><br/><a class="ae jo" href="https://cloud.google.com/managed-microsoft-ad/docs/best-practices" rel="noopener ugc nofollow" target="_blank">Google Cloud: Managed Microsoft AD Best Practices</a><br/><a class="ae jo" href="https://cloud.google.com/managed-microsoft-ad/docs/objects" rel="noopener ugc nofollow" target="_blank">Google Cloud: Automatically created AD objects</a><br/><a class="ae jo" href="https://cloud.google.com/managed-microsoft-ad/docs/troubleshooting" rel="noopener ugc nofollow" target="_blank">Google Cloud: Troubleshooting Managed Microsoft AD</a><br/><a class="ae jo" href="https://cloud.google.com/architecture/patterns-for-using-active-directory-in-a-hybrid-environment" rel="noopener ugc nofollow" target="_blank">Google Cloud: Patterns for using Active Directory in a hybrid environment</a><br/><a class="ae jo" href="https://cloud.google.com/architecture/configuring-active-directory-for-vms-to-automatically-join-the-domain" rel="noopener ugc nofollow" target="_blank">Google Cloud: Configuring Active Directory for VMs to automatically join a domain</a></span></pre></div></div>    
</body>
</html>