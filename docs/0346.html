<html>
<head>
<title>Importing GCP Projects into your Organization with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python将GCP项目导入您的组织</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/importing-gcp-projects-into-your-organization-with-python-aa9627bd8f12?source=collection_archive---------1-----------------------#2017-07-29">https://medium.com/google-cloud/importing-gcp-projects-into-your-organization-with-python-aa9627bd8f12?source=collection_archive---------1-----------------------#2017-07-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="e16a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">问题:“遗留项目”(组织前)</h1><p id="87d2" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><em class="kb">注:截止到</em><a class="ae kc" href="https://cloud.google.com/resource-manager/docs/release-notes#February_26_2021" rel="noopener ugc nofollow" target="_blank"><em class="kb">2021年2月26日</em> </a> <em class="kb">，Google已经为</em> <a class="ae kc" href="https://cloud.google.com/resource-manager/docs/project-migration" rel="noopener ugc nofollow" target="_blank"> <em class="kb">组织间迁移项目</em> </a> <em class="kb">做了一个自助服务流程，可供公众预览。</em></p><p id="a36b" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">如果你使用GCP与G套件(包括<a class="ae kc" href="https://support.google.com/a/answer/7319251?hl=en" rel="noopener ugc nofollow" target="_blank">云身份</a>)帐户，你已经熟悉<a class="ae kc" href="https://cloud.google.com/resource-manager/docs/quickstart-organizations" rel="noopener ugc nofollow" target="_blank">如何使用组织</a>更容易<a class="ae kc" href="https://cloudplatform.googleblog.com/2017/01/centrally-manage-all-your-Google-Cloud-resources-with-Cloud-Resource-Manager.html" rel="noopener ugc nofollow" target="_blank">集中管理你所有的谷歌云资源</a>。</p><p id="0d61" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">然而，如果你在<a class="ae kc" href="https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy#organization" rel="noopener ugc nofollow" target="_blank">组织资源</a>变得<a class="ae kc" href="https://cloudplatform.googleblog.com/2016/10/whats-new-with-Google-Cloud-Resource-Manager-and-other-IAM-news.html" rel="noopener ugc nofollow" target="_blank">普遍可用</a>之前就开始使用GCP，你可能有很多项目是在你的域的组织资源存在之前由你的G Suite用户<strong class="jf hj">创建的。这些项目目前不在你的控制之下。</strong></p><p id="efb5" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">您的用户可以选择加入<a class="ae kc" href="https://cloud.google.com/resource-manager/docs/migrating-projects-billing" rel="noopener ugc nofollow" target="_blank">将现有项目迁移到组织</a>中，只要在您的组织中授予他们<a class="ae kc" href="https://cloud.google.com/iam/docs/understanding-roles#predefined_roles" rel="noopener ugc nofollow" target="_blank">项目创建者</a>角色。但是，作为GCP组织的管理员，您很难找到所有这些“遗留项目”并将它们“导入”到您的组织资源中。</p><h1 id="697d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">解决方案:用Python实现自动化</h1><p id="6769" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">自动化这个过程(即使对于成千上万的用户或项目)是非常容易的，只要你能在你的G Suite域中<a class="ae kc" href="https://developers.google.com/api-client-library/python/auth/service-accounts#creatinganaccount" rel="noopener ugc nofollow" target="_blank">创建一个服务帐户</a>和<a class="ae kc" href="https://developers.google.com/api-client-library/python/auth/service-accounts#delegatingauthority" rel="noopener ugc nofollow" target="_blank">授权的域范围权限</a>。<em class="kb">(如果不是您，您可能需要联系您的G Suite管理员。)</em></p><h2 id="f86e" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">过程</h2><p id="e5e6" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这是为了发现您的领域的所有遗留项目并将其导入到您的组织资源中而要遵循的一般过程。</p><ol class=""><li id="d2f2" class="kw kx hi jf b jg kd jk ke jo ky js kz jw la ka lb lc ld le bi translated">使用具有域范围权限的服务帐户和具有超级管理员角色的用户检索G Suite域中所有用户的<strong class="jf hj">列表。</strong></li><li id="8248" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">作为域中的每个用户，检索项目及其IAM策略绑定的列表<strong class="jf hj">,以查找用户所拥有的没有组织或文件夹作为其父级的项目。</strong></li><li id="da7c" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">对于步骤#2中找到的每个项目(作为拥有项目的用户)<strong class="jf hj">添加服务帐户作为项目的所有者</strong>。</li><li id="d66c" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">作为服务帐户，<strong class="jf hj">将项目添加到组织资源</strong>。</li></ol><h2 id="29b5" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">服务帐户设置</h2><p id="743c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">为了用Python做到这一点，我们需要一个对G Suite域和GCP组织资源有适当访问权限的<a class="ae kc" href="https://developers.google.com/api-client-library/python/auth/service-accounts" rel="noopener ugc nofollow" target="_blank">服务帐户</a>。</p><ol class=""><li id="c278" class="kw kx hi jf b jg kd jk ke jo ky js kz jw la ka lb lc ld le bi translated"><a class="ae kc" href="https://developers.google.com/identity/protocols/OAuth2ServiceAccount#creatinganaccount" rel="noopener ugc nofollow" target="_blank">创建服务账户</a>(选择<em class="kb">启用G Suite全域委托</em>)</li><li id="504f" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">保存服务帐户JSON文件(例如<code class="du lk ll lm ln b">serviceaccount.json</code>)</li><li id="93eb" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated"><a class="ae kc" href="https://developers.google.com/identity/protocols/OAuth2ServiceAccount#delegatingauthority" rel="noopener ugc nofollow" target="_blank">委派服务帐户的全域性权限</a>使用以下作用域:<code class="du lk ll lm ln b">https://www.google.apis.com/auth/admin.directory.user, https://www.google.apis.com/auth/cloud-platform</code></li><li id="0568" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">在<a class="ae kc" href="https://console.cloud.google.com/apis/dashboard" rel="noopener ugc nofollow" target="_blank"> GCP控制台</a> : <code class="du lk ll lm ln b"><a class="ae kc" href="https://console.cloud.google.com/apis/api/admin.googleapis.com/overview" rel="noopener ugc nofollow" target="_blank">Admin SDK</a>, <a class="ae kc" href="https://console.cloud.google.com/apis/api/cloudresourcemanager.googleapis.com/overview" rel="noopener ugc nofollow" target="_blank">Cloud Resource Manager API</a></code>中启用API</li><li id="b651" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">授予服务帐户在组织资源中的<strong class="jf hj">项目创建者</strong>角色。</li></ol><h2 id="d6c1" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">使用Python验证</h2><p id="ba6b" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">现在我们有了一个拥有所有正确权限的服务帐户，我们可以创建凭证，并且<a class="ae kc" href="https://developers.google.com/api-client-library/python/auth/service-accounts#authorizingrequests" rel="noopener ugc nofollow" target="_blank">准备以G Suite域中超级管理员角色的用户身份进行授权调用</a>。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="7a9b" class="ki ig hi ln b fi lw lx l ly lz">from oauth2client.service_account import ServiceAccountCredentials</span><span id="342b" class="ki ig hi ln b fi ma lx l ly lz">superadmin = '<strong class="ln hj">google@mydomain.com</strong>'</span><span id="bd1f" class="ki ig hi ln b fi ma lx l ly lz">scopes = [<br/>    '<strong class="ln hj">https://www.google.apis.com/auth/admin.directory.user</strong>',<br/>    '<strong class="ln hj">https://www.google.apis.com/auth/cloud-platform</strong>'<br/>]<br/><br/>credentials = ServiceAccountCredentials.from_json_keyfile_name(<br/>    '<strong class="ln hj">serviceaccount.json</strong>',<br/>    scopes<br/>)<br/>admin_creds = credentials.create_delegated(superadmin)</span></pre><h2 id="1817" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">正在检索所有域用户</h2><p id="8fd2" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">现在，我们可以使用这些admin凭证对Admin SDK目录API进行身份验证调用，以获得域中所有用户的列表。</p><p id="8484" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated"><em class="kb">注意:使用</em> <a class="ae kc" href="https://developers.google.com/admin-sdk/directory/v1/reference/users/list" rel="noopener ugc nofollow" target="_blank"> <em class="kb"> Admin SDK目录API users.list </em> </a> <em class="kb">方法。</em></p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="2122" class="ki ig hi ln b fi lw lx l ly lz">from apiclient.discovery import build<br/><br/>admin = build('admin', 'directory_v1', credentials=<strong class="ln hj">admin_creds</strong>)</span><span id="1f69" class="ki ig hi ln b fi ma lx l ly lz">params = {<br/>    'customer': 'my_customer',<br/>    'fields': fields,<br/>}</span><span id="f17a" class="ki ig hi ln b fi ma lx l ly lz">users = admin.users()<br/>request = users.list(**params)</span><span id="2c37" class="ki ig hi ln b fi ma lx l ly lz"><strong class="ln hj">domain_users = []</strong><br/>while request is not None:<br/>    users_list = request.execute()<br/>    <strong class="ln hj">domain_users += users_list.get('users', [])</strong><br/>    request = users.list_next(request, users_list)</span></pre><h2 id="1b99" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">正在检索所有项目</h2><p id="cb28" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">有了所有域用户的列表，我们现在可以“成为”每个用户来获得他们所有项目的列表。</p><p id="959e" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated"><em class="kb">注意:使用</em> <a class="ae kc" href="https://cloud.google.com/resource-manager/reference/rest/v1/projects/list" rel="noopener ugc nofollow" target="_blank"> <em class="kb">云资源管理器的</em> </a> <em class="kb">方法。</em></p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="cb37" class="ki ig hi ln b fi lw lx l ly lz"># loop through all of the users in the domain<br/>for user in <strong class="ln hj">domain_users</strong>:<br/>    <strong class="ln hj">email = user['primaryEmail']</strong></span><span id="5311" class="ki ig hi ln b fi ma lx l ly lz">    # create credentials as the user<br/>    credentials = ServiceAccountCredentials.from_json_keyfile_name(<br/>        '<strong class="ln hj">serviceaccount.json</strong>',<br/>        scopes<br/>    )<br/>    <strong class="ln hj">user_creds</strong> = credentials.create_delegated(<strong class="ln hj">email</strong>)</span><span id="4009" class="ki ig hi ln b fi ma lx l ly lz">    # connect to cloud resource manager as the user<br/>    crm = build(<br/>        'cloudresourcemanager', <br/>        'v1', <br/>        credentials=<strong class="ln hj">user_creds<br/>    </strong>)</span><span id="e3da" class="ki ig hi ln b fi ma lx l ly lz">    # get a list of all projects visible to the user<br/>    projects = crm.projects()<br/>    request = projects.list(**params)</span><span id="15aa" class="ki ig hi ln b fi ma lx l ly lz"><strong class="ln hj">    user_projects = []</strong><br/>    while request is not None:<br/>        projects_list = request.execute()<br/>        <strong class="ln hj">user_projects += projects_list.get('projects', [])</strong><br/>        request = projects.list_next(request, projects_list)</span></pre><h2 id="b252" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">查找要导入的用户项目</h2><p id="50ab" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">对于每个用户，一旦我们获得了可见项目的列表，我们需要将列表缩小到只有<strong class="jf hj">活动的</strong>项目，这些项目没有<strong class="jf hj">父</strong>(组织或文件夹)并且由用户拥有<strong class="jf hj">。这将要求我们为每个没有父项目的活动项目获取<strong class="jf hj"> IAM策略绑定</strong>。</strong></p><p id="9b23" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated"><em class="kb">注意:使用</em> <a class="ae kc" href="https://cloud.google.com/resource-manager/reference/rest/v1/projects/getIamPolicy" rel="noopener ugc nofollow" target="_blank"> <em class="kb">云资源管理器的</em> </a> <em class="kb">端点。</em></p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="0b92" class="ki ig hi ln b fi lw lx l ly lz"># loop through each of the projects visible to the user<br/>for project in <strong class="ln hj">user_projects</strong>:</span><span id="afa7" class="ki ig hi ln b fi ma lx l ly lz">    <strong class="ln hj"># skip projects that are not active</strong><br/>    if project['lifecycleState'] != 'ACTIVE':<br/>        continue</span><span id="ded9" class="ki ig hi ln b fi ma lx l ly lz">    <strong class="ln hj"># skip projects that already have a parent</strong><br/>    if not project.get('parent', {}):<br/>        continue</span><span id="a1e8" class="ki ig hi ln b fi ma lx l ly lz">    <strong class="ln hj"># get the IAM policy bindings for the project</strong><br/>    project_id = p['projectId']<br/>    params = {<br/>        'resource': project_id,<br/>        'body': {},<br/>    }<br/><strong class="ln hj">    policy = crm.projects().getIamPolicy(**params).execute()</strong><br/>    bindings = policy.get('bindings', [])</span><span id="acfe" class="ki ig hi ln b fi ma lx l ly lz">    owner = False</span><span id="284d" class="ki ig hi ln b fi ma lx l ly lz">    <strong class="ln hj"># find out if the user is an owner of the project</strong><br/>    for b in bindings:</span><span id="80b4" class="ki ig hi ln b fi ma lx l ly lz">        <strong class="ln hj"># skip bindings other than owner</strong><br/>        if b['role'] != 'roles/owner':<br/>            continue</span><span id="fb1d" class="ki ig hi ln b fi ma lx l ly lz">        <strong class="ln hj"># see if user is one of the owners</strong><br/>        if 'user:%s' % (<strong class="ln hj">email</strong>) in b['members']:<br/>            owner = True</span><span id="0247" class="ki ig hi ln b fi ma lx l ly lz">    # if user is owner, add the project to import list<br/>    if owner:</span><span id="253f" class="ki ig hi ln b fi ma lx l ly lz">        # add bindings to the project record<br/><strong class="ln hj">        project['bindings'] = bindings</strong></span><span id="19b8" class="ki ig hi ln b fi ma lx l ly lz">       <em class="kb"> # add the service account as a project owner...</em></span><span id="092b" class="ki ig hi ln b fi ma lx l ly lz"><em class="kb">        # add the project to the organization...</em></span></pre><h2 id="250c" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">将服务帐户添加为项目所有者</h2><p id="08c2" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">既然我们知道了哪些项目需要导入到组织资源中，我们仍然需要正确的权限以便能够添加项目。我们再次以用户的身份这样做。</p><p id="0162" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated"><strong class="jf hj">我们无法通过API将超级管理员添加为所有者。</strong>向项目添加所有者会生成一个电子邮件通知，用户必须接受该通知才能被授予角色(这只能从控制台完成)。</p><p id="3257" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">如果项目已经在一个组织中，并且被添加为所有者的用户与该组织在同一个域中，则使用API添加用户作为所有者仅<strong class="jf hj">是可能的</strong>。<a class="ae kc" href="https://google-api-client-libraries.appspot.com/documentation/cloudresourcemanager/v1/python/latest/cloudresourcemanager_v1.projects.html#setIamPolicy" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj">服务账号可以不受任何限制直接成为项目业主</strong> </a>。</p><p id="fad1" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated"><em class="kb">注意:使用</em> <a class="ae kc" href="https://cloud.google.com/resource-manager/reference/rest/v1/projects/setIamPolicy" rel="noopener ugc nofollow" target="_blank"> <em class="kb">云资源管理器projects . setiampolicy</em></a><em class="kb">端点。</em></p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="86a7" class="ki ig hi ln b fi lw lx l ly lz"><strong class="ln hj"># set service account user name</strong><br/>user = 'serviceAccount:%s' % (credentials.service_account_email)</span><span id="5e5e" class="ki ig hi ln b fi ma lx l ly lz"><strong class="ln hj">newbindings = []</strong></span><span id="b748" class="ki ig hi ln b fi ma lx l ly lz">update = False</span><span id="0c72" class="ki ig hi ln b fi ma lx l ly lz"><strong class="ln hj"># check bindings for owner role and update if necessary</strong><br/>for b in project['bindings']:<br/>    if b['role'] == 'roles/owner' and user not in b['members']:<br/>        b['members'].append(user)<br/>        update = True<br/>    <strong class="ln hj">newbindings.append(b)</strong></span><span id="0a2f" class="ki ig hi ln b fi ma lx l ly lz"># <strong class="ln hj">update the project IAM policy if necessary</strong><br/>if update:<br/>    body = {'policy': {'bindings': <strong class="ln hj">newbindings</strong>}}<br/>    params = {'resource': project_id, 'body': body}<br/>    <br/>    # set the IAM policy for the project<br/>    <strong class="ln hj">crm.projects().setIamPolicy(**params).execute()</strong></span></pre><h2 id="6f0e" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">将项目添加到组织资源</h2><p id="c4e9" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">既然服务帐户是所有者(并且已经是组织中的项目创建者)，我们可以使用服务帐户的凭据将项目添加到组织中。</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="d13b" class="ki ig hi ln b fi lw lx l ly lz"># set the organization ID<strong class="ln hj"><br/>organization_id = '123456789012'</strong></span><span id="0695" class="ki ig hi ln b fi ma lx l ly lz"><strong class="ln hj"># create credentials as the service account</strong><br/>credentials = ServiceAccountCredentials.from_json_keyfile_name(<br/>    '<strong class="ln hj">serviceaccount.json</strong>',<br/>    scopes<br/>)</span><span id="5a18" class="ki ig hi ln b fi ma lx l ly lz"># removing bindings from record before updating<br/>del project['bindings']</span><span id="bc30" class="ki ig hi ln b fi ma lx l ly lz"><strong class="ln hj"># add a "parent" to the project record</strong><br/>project['parent'] = {<br/>    'type': 'organization',<br/>    'id': <strong class="ln hj">organization_id</strong><br/>}</span><span id="d12a" class="ki ig hi ln b fi ma lx l ly lz">params = {<br/>    'projectId': project_id,<br/>    'body': body,<br/>}</span><span id="fdfe" class="ki ig hi ln b fi ma lx l ly lz">crm = build(<br/>    'cloudresourcemanager', <br/>    'v1', <br/>    credentials=<strong class="ln hj">credentials<br/></strong>)</span><span id="332f" class="ki ig hi ln b fi ma lx l ly lz"># update project parent to the organization_id<br/><strong class="ln hj">crm.projects().update(**params).execute()</strong></span></pre><p id="0ed5" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated"><strong class="jf hj">搞定！</strong>由您的G Suite用户之一拥有但没有父项目的每个活动项目现在都是您的组织资源的成员，您可以开始管理您的所有用户的GCP资源了！</p><h1 id="d18e" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">示例:<a class="ae kc" href="https://github.com/lukwam/gcp-tools/blob/master/import_projects.py" rel="noopener ugc nofollow" target="_blank"> import_projects.py </a></h1><p id="1c94" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我已经在我的<a class="ae kc" href="https://github.com/lukwam/gcp-tools/" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj">GCP-tools GitHub Repo</strong></a>中添加了一个<strong class="jf hj">新工具</strong>，名为<a class="ae kc" href="https://github.com/lukwam/gcp-tools/blob/master/import_projects.py" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj">import _ projects . py</strong></a><strong class="jf hj">，</strong>，它捆绑了本文描述的所有功能。使用正确配置的服务帐户和G Suite域中超级管理员的电子邮件地址运行它，将允许您执行以下所有操作:</p><ol class=""><li id="11aa" class="kw kx hi jf b jg kd jk ke jo ky js kz jw la ka lb lc ld le bi translated">检索您的域中的所有用户</li><li id="1cc7" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">对于每个用户，检索他们的所有项目</li><li id="ce62" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">筛选活动的“遗留项目”(归您的用户所有，但不在您的组织中)</li><li id="476d" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">显示要导入的项目列表</li><li id="7bbc" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">请求权限以继续导入项目</li><li id="c1b0" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">对于每个要导入的项目，将服务帐户添加为所有者，并</li><li id="bac3" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">将项目添加到组织中。</li></ol><p id="b376" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">下面是一个使用中的例子<em class="kb">(注意，</em><strong class="jf hj"><em class="kb">google@mydomain.com</em></strong><em class="kb">是对mydomain.com G Suite域拥有超级管理员权限的用户名)</em>:</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="5ea0" class="ki ig hi ln b fi lw lx l ly lz">&gt; <strong class="ln hj">./import_projects.py google@mydomain.com</strong><br/>Retrieving users from Google Admin SDK Directory API...<br/>Found 13 users in domain.<br/><br/>Scanning all users for projects without a parent...<br/>  lukwam@mydomain.com:<br/>    * Test Project 1: test-project01 [367391543796] (ACTIVE)<br/>    * Test Project 2: test-project02 [746509631927] (ACTIVE)<br/>    * Test Project 3: test-project03 [216921026845] (ACTIVE)<br/><br/>Found 3 projects to import:<br/>   * test-project01 (lukwam@mydomain.com)<br/>   * test-project03 (lukwam@mydomain.com)<br/>   * test-project02 (lukwam@mydomain.com)<br/><br/>Preparing to move 3 projects into org: mydomain.com...<br/>   ---&gt; Are you sure you want to continue? [y/N]: y<br/><br/>Organization: mydomain.com [685481217344] (customer: C0392o3bz)<br/><br/>   * test-project01:<br/>      + added gcp-tools@ltk-gcp-tools.iam.gserviceaccount.com as project owner.<br/>      + added project to organization 685481217344.<br/><br/>   * test-project02:<br/>      + added gcp-tools@ltk-gcp-tools.iam.gserviceaccount.com as project owner.<br/>      + added project to organization 685481217344.<br/><br/>   * test-project03:<br/>      + added gcp-tools@ltk-gcp-tools.iam.gserviceaccount.com as project owner.<br/>      + added project to organization 685481217344.<br/><br/>Done.</span></pre><p id="6c1f" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">在这个项目的<a class="ae kc" href="https://github.com/lukwam/gcp-tools/wiki/Importing-Projects" rel="noopener ugc nofollow" target="_blank"> GitHub Wiki </a>中可以获得<strong class="jf hj"> import_projects.py </strong>的完整文档。bug和功能请求可以通过<a class="ae kc" href="https://github.com/lukwam/gcp-tools/issues" rel="noopener ugc nofollow" target="_blank"> GitHub Issues </a>提交。</p><h1 id="bdd7" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">参考资料:</h1><ul class=""><li id="972e" class="kw kx hi jf b jg jh jk jl jo mb js mc jw md ka me lc ld le bi translated"><a class="ae kc" href="https://gsuite.google.com/" rel="noopener ugc nofollow" target="_blank"> G套件</a></li><li id="0a0a" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka me lc ld le bi translated"><a class="ae kc" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a></li><li id="0ecf" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka me lc ld le bi translated"><a class="ae kc" href="https://cloudplatform.googleblog.com/" rel="noopener ugc nofollow" target="_blank">谷歌云平台博客</a></li><li id="d9c4" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka me lc ld le bi translated"><a class="ae kc" href="https://developers.google.com/admin-sdk/directory/" rel="noopener ugc nofollow" target="_blank">管理SDK目录API </a></li><li id="28a0" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka me lc ld le bi translated"><a class="ae kc" href="https://cloud.google.com/resource-manager/" rel="noopener ugc nofollow" target="_blank">云资源管理器</a></li><li id="f197" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka me lc ld le bi translated">"<a class="ae kc" href="https://cloudplatform.googleblog.com/2016/10/whats-new-with-Google-Cloud-Resource-Manager-and-other-IAM-news.html" rel="noopener ugc nofollow" target="_blank">谷歌云资源管理器的新功能，以及其他IAM新闻</a> " ( <a class="ae kc" href="https://twitter.com/grapesfrog" rel="noopener ugc nofollow" target="_blank"> @grapesfrog </a>)</li><li id="0971" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka me lc ld le bi translated">"<a class="ae kc" href="https://cloudplatform.googleblog.com/2017/01/centrally-manage-all-your-Google-Cloud-resources-with-Cloud-Resource-Manager.html" rel="noopener ugc nofollow" target="_blank">用云资源管理器</a>集中管理你所有的谷歌云资源"(<a class="ae kc" href="https://twitter.com/cavallimarco" rel="noopener ugc nofollow" target="_blank"> @cavallimarco </a>)</li><li id="bc6e" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka me lc ld le bi translated">"<a class="ae kc" href="https://cloudplatform.googleblog.com/2017/05/mapping-your-organization-with-the-Google-Cloud-Platform--resource-hierarchy.html" rel="noopener ugc nofollow" target="_blank">用谷歌云平台资源层级</a>映射您的组织"(<a class="ae kc" href="https://twitter.com/cavallimarco" rel="noopener ugc nofollow" target="_blank"> @cavallimarco </a>)</li></ul></div></div>    
</body>
</html>