<html>
<head>
<title>Modern Distributed Application Deployment with Kubernetes and MongoDB Atlas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kubernetes和MongoDB Atlas部署现代分布式应用程序</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/modern-distributed-application-deployment-with-kubernetes-and-mongodb-atlas-4ec9eff5bab2?source=collection_archive---------2-----------------------#2018-04-05">https://medium.com/google-cloud/modern-distributed-application-deployment-with-kubernetes-and-mongodb-atlas-4ec9eff5bab2?source=collection_archive---------2-----------------------#2018-04-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f312" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">讲故事是作为一名开发者拥护者的一部分，我很喜欢。有时故事是关于团队聚在一起保持系统运行或更快构建系统的特殊时刻。但是，关于我参与的软件部署，没有什么光荣的故事可讲。对于我们需要一天部署几次的情况，现在我们说的是噩梦。</p><p id="c858" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有一段时间，我在一家公司工作，该公司认为一天几次部署到生产对于项目速度是理想的。我们的团队致力于确保我们媒体平台上的广告软件始终得到更新和发布。其中一个问题是在向我们的应用服务器应用新代码的过程中缺乏真正的自动化。</p><p id="f64e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运营团队和开发团队的共同点是希望提高应用程序和配置部署的易用性和敏捷性。在本文中，我将展示我的一些经验，并介绍如何将MongoDB Atlas和Kubernetes结合起来简化应用程序及其底层依赖项的部署和管理过程。</p><p id="6b07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们来谈谈典型的软件部署是如何展开的:</p><ol class=""><li id="0c3d" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">开发人员会发送一个请求部署的标签</li><li id="bcc5" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">开发人员和我会商定部署最新软件版本的时间</li><li id="bc86" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">我们将使用适当的git存储库版本信息修改现有的bash脚本</li><li id="499b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">我们需要手动备份旧的部署</li><li id="5448" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">我们需要手动创建当前数据库的备份</li><li id="c8d6" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">我们会看到bash脚本在大约6台并行服务器上执行这种“部署”</li><li id="9e7f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">在我的键盘上挥舞一只死鸡</li></ol><p id="509d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其中一些部署会失败，需要返回到应用程序代码的先前版本。这个“回滚”到先前版本的过程需要我手动将存储库复制到旧版本，执行手动数据库恢复，最后与使用该系统的团队确认一切正常。这真是一团糟，我真的没有能力去改变它。</p><p id="55fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我最终进入了一个职位，这个职位让我对其他开发团队，特别是开源领域的开发团队，为软件部署所做的事情有了更多的了解。我注意到了——惊喜！—人们不再对一遍又一遍地做同样的工作感兴趣。</p><p id="a75d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在过去的几年中，通过利用容器和自动化平台，开发人员和他们的支持运营团队已经获得了一个全新世界的钥匙。由于有了Kubernetes这样的工具，您可以快速部署应用程序，而不是手工制作应用程序的环境。</p><h2 id="9ccd" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">什么是Kubernetes？</h2><p id="7344" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">Kubernetes是一个用于自动化部署、扩展和管理容器化应用的开源系统。Kubernetes可以帮助减少您的团队在部署应用程序时必须做的工作量。有了MongoDB Atlas，您可以构建可伸缩且有弹性的应用程序，这些应用程序可以承受高流量，或者可以轻松地缩减规模以降低成本。Kubernetes几乎可以在任何地方运行，几乎可以使用任何基础设施。如果您使用公共云、混合云甚至裸机解决方案，您可以利用Kubernetes快速部署和扩展您的应用程序。</p><p id="f99c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jr" href="https://cloud.google.com/kubernetes-engine/" rel="noopener ugc nofollow" target="_blank">谷歌Kubernetes引擎</a>内置于谷歌云平台，帮助你快速部署你的容器化应用。</p><p id="9150" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出于本教程的目的，我将把我们的<a class="ae jr" href="https://docs.docker.com/engine/reference/commandline/images/" rel="noopener ugc nofollow" target="_blank">图像</a>上传到GCP，然后部署到一个Kubernetes集群，这样我就可以根据需要快速扩展或缩小我们的应用程序。当我创建我们的应用程序的新版本或进行增量更改时，我可以简单地创建一个新的映像并使用Kubernetes再次部署。</p><h2 id="c53f" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">为什么阿特拉斯和库伯内特在一起？</h2><p id="d615" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">通过将这些工具一起用于您的MongoDB应用程序，<a class="ae jr" href="https://www.mongodb.com/blog/post/running-mongodb-as-a-microservice-with-docker-and-kubernetes" rel="noopener ugc nofollow" target="_blank">您可以快速地生产和部署应用程序</a>，而不必担心基础设施管理。Atlas为您的应用程序数据提供了持久的数据存储，而无需管理实际的数据库软件、复制、升级或监控。所有这些功能都是现成的，允许您快速构建和部署。</p><p id="5d26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我将为一个简单的Node.js应用程序构建一个MongoDB Atlas集群，其中包含我们的数据。然后，我将用Docker将Atlas的应用程序和配置数据转换成一个容器就绪的映像。</p><p id="549a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">MongoDB Atlas在GCP的大部分地区都可以使用，因此无论您的应用程序位于何处，您都可以将数据保存在云中。</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es ks"><img src="../Images/ae5b1b2541a3665e75a7888c699a8277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7dIxRHChTcleTnKs.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">GCP地区可用的MongoDB Atlas</figcaption></figure><h2 id="9a02" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">要求</h2><p id="e3d7" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">要学习本教程，用户需要满足以下一些要求:</p><ul class=""><li id="b992" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc li jj jk jl bi translated"><a class="ae jr" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云平台账户</a>(启用计费或信用)</li><li id="0e03" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc li jj jk jl bi translated">MongoDB Atlas账户(M10+专用集群)</li><li id="396b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc li jj jk jl bi translated"><a class="ae jr" href="https://docs.docker.com/install/" rel="noopener ugc nofollow" target="_blank">码头工人</a></li><li id="8921" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc li jj jk jl bi translated"><a class="ae jr" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank"> Node.js </a></li><li id="8b42" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc li jj jk jl bi translated"><a class="ae jr" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank">库伯内特斯</a></li><li id="e09c" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc li jj jk jl bi translated"><a class="ae jr" href="https://git-scm.com/" rel="noopener ugc nofollow" target="_blank">饭桶</a></li></ul><p id="fe0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我将下载我将使用的代码的存储库。在这种情况下，它是一个使用MongoDB、Express、React和Node ( <a class="ae jr" href="https://www.mongodb.com/blog/post/the-modern-application-stack-part-1-introducing-the-mean-stack" rel="noopener ugc nofollow" target="_blank"> MERN </a>)的基本记录应用程序。</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="b74c" class="js jt hi lk b fi lo lp l lq lr">bash-3.2$ git clone git@github.com:cefjoeii/mern-crud.git<br/>Cloning into 'mern-crud'...<br/>remote: Counting objects: 326, done.<br/>remote: Total 326 (delta 0), reused 0 (delta 0), pack-reused 326<br/>Receiving objects: 100% (326/326), 3.26 MiB | 2.40 MiB/s, done.<br/>Resolving deltas: 100% (137/137), done.<br/><br/>cd mern-crud</span></pre><p id="ef9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我将<code class="du ls lt lu lk b">npm install</code>并安装使用我们的应用程序所需的所有npm包:</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="1944" class="js jt hi lk b fi lo lp l lq lr">&gt; uws@9.14.0 install /Users/jaygordon/work/mern-crud/node_modules/uws<br/>&gt; node-gyp rebuild &gt; build_log.txt 2&gt;&amp;1 || exit 0</span></pre><h2 id="bb02" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">为地图集选择您的GCP地区</h2><p id="6925" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">每个GCP地区包括一定数量的独立区域。每个区域都有与其他区域隔离的电源、冷却、网络和控制平面。对于至少有三个区域(3Z)的地区，Atlas会跨三个区域部署集群。对于只有两个区域(2Z)的地区，Atlas跨两个区域部署集群。</p><p id="2bc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Atlas <a class="ae jr" href="https://docs.atlas.mongodb.com/create-new-cluster/" rel="noopener ugc nofollow" target="_blank"> Add New Cluster </a>表单将支持3Z集群的区域标记为推荐区域，因为它们提供了更高的可用性。如果您的首选区域只有两个区域，请考虑启用跨区域复制，并将一个副本集成员放在另一个区域，以增加群集在部分区域停机期间可用的可能性。</p><p id="ad07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个区域中的区域数量对Atlas可以部署的MongoDB节点数量没有影响。MongoDB Atlas集群总是由至少包含三个MongoDB节点的副本集组成。</p><p id="f373" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有关GCP地区和区域的一般信息，请参见关于<a class="ae jr" href="https://cloud.google.com/compute/docs/regions-zones/regions-zones" rel="noopener ugc nofollow" target="_blank">地区和区域</a>的谷歌文档。</p><h2 id="d0bf" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">创建集群并添加用户</h2><p id="af1b" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">在下面提供的图片中，你可以看到我选择了云提供商“谷歌云平台”接下来，我选择了一个实例大小，在本例中是M10。使用M10实例的部署非常适合开发。如果我要立即将这个应用程序投入生产，我可能会考虑使用M30部署。由于这是一个演示，M10对于我们的应用来说已经足够了。有关所有集群规模的完整视图，请查看<a class="ae jr" href="https://www.mongodb.com/cloud/atlas/pricing" rel="noopener ugc nofollow" target="_blank"> Atlas定价页面</a>。完成这些步骤后，我可以单击“确认&amp;部署”按钮。Atlas将在几分钟内自动启动我的部署。</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lv"><img src="../Images/0b6225017d2792ef49c6cb80f5121a6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xSv3gC0pQjhaQpDT.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">选择谷歌云和您的首选地区。</figcaption></figure><p id="7a12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们为我们的数据库创建一个用户名和密码，我们的Kubernetes部署的应用程序将使用它来访问MongoDB。</p><ul class=""><li id="65a7" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc li jj jk jl bi translated">点击页面顶部的“安全”。</li><li id="d774" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc li jj jk jl bi translated">点击“MongoDB用户”</li><li id="882d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc li jj jk jl bi translated">单击“添加新用户”</li><li id="eaad" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc li jj jk jl bi translated">单击“显示高级选项”</li><li id="90ea" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc li jj jk jl bi translated">然后，我们将为我们的<code class="du ls lt lu lk b">mern-crud</code>应用程序添加一个用户“<code class="du ls lt lu lk b">mernuser</code>”，该用户只能访问名为“<code class="du ls lt lu lk b">mern-crud</code>”的数据库，并给它一个复杂的密码。我们将为该用户指定读写权限:</li></ul><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lw"><img src="../Images/e256f43459fde085126b7ea17031ea19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*E39Bx1CIio5Axbef.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">添加您的新用户。</figcaption></figure><p id="dbae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击“添加用户”</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lx"><img src="../Images/b7dfe0cda7a5de316c13aa9175a6d62b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZdlAd23Ihzw_cHD9.png"/></div></div></figure><p id="2441" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您的数据库已经创建，您的用户也已添加。你仍然需要我们的连接字符串和通过网络进入白名单。</p><h2 id="30e2" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">连接字符串</h2><p id="4625" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">点击“集群”，然后点击Atlas管理面板中集群详情旁边的“连接”,获取连接字符串。选择connect后，您可以使用几个选项来连接到您的集群。单击“连接您的应用程序”</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es ly"><img src="../Images/01fb2a83ad6bc79c800c75fd220a2ab1.png" data-original-src="https://miro.medium.com/v2/resize:fit:660/format:webp/0*3tT_PPyioaQo9AEP.png"/></div></figure><p id="15f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">给出了MongoDB驱动程序3.6或3.4版本的选项。我使用3.4驱动程序构建了我的，所以我将只选择这个版本的连接字符串。</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lz"><img src="../Images/38929d4be3e1fa0cdba67dd803ac9809.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YAEYZZRFfYzmOJCv.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">连接字符串</figcaption></figure><p id="d644" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我通常将它粘贴到一个编辑器中，然后修改信息以匹配我的应用程序凭证和我的数据库名称:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es ma"><img src="../Images/248b0d3dc1698dc6398604dbde0dd22e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JjC7FpZk6tPF2uXq.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">将连接字符串临时保存在IDE中。</figcaption></figure><p id="b2e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我现在将它添加到应用程序的数据库配置文件，并保存它。</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mb"><img src="../Images/c48fd595cdd817406234375edae38546.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GiJ9p8l0CXFyTC-u.gif"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">修改我的配置以使用GCP托管的MongoDB Atlas。</figcaption></figure><p id="796e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我将用Docker将它打包成一个图像，并将其发送到Google Kubernetes引擎！</p><h2 id="e8c1" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">Docker和Google Kubernetes引擎</h2><p id="a1c0" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">首先在Google Cloud上创建一个帐户，然后<a class="ae jr" href="https://cloud.google.com/kubernetes-engine/docs/quickstart" rel="noopener ugc nofollow" target="_blank">按照快速入门创建一个Google Kubernetes项目</a>。</p><p id="0f82" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">项目创建完成后，您可以在Google云平台控制面板中找到它:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mc"><img src="../Images/55db2c535f4620bd1b0d3e21d425beef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mHykYbFhj3pQJU50.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">GCP控制面板</figcaption></figure><p id="7ec0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是时候在本地工作站上创建一个容器了:</p><p id="7efa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过使用以下命令检索gcloud上预先配置的项目ID，在您的shell中设置<code class="du ls lt lu lk b">PROJECT_ID</code>环境变量:</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="142c" class="js jt hi lk b fi lo lp l lq lr">export PROJECT_ID="jaygordon-mongodb"<br/>gcloud config set project $PROJECT_ID<br/>gcloud config set compute/zone us-central1-b</span></pre><p id="6164" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，在您的库的根目录下放置一个<code class="du ls lt lu lk b">Dockerfile</code>,如下所示:</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="5ee9" class="js jt hi lk b fi lo lp l lq lr">FROM node:boron</span><span id="4193" class="js jt hi lk b fi md lp l lq lr">RUN mkdir -p /usr/src/app<br/>WORKDIR /usr/src/app</span><span id="e829" class="js jt hi lk b fi md lp l lq lr">COPY . /usr/src/app</span><span id="48b9" class="js jt hi lk b fi md lp l lq lr">EXPOSE 3000</span><span id="4018" class="js jt hi lk b fi md lp l lq lr">CMD [npm, start]</span></pre><p id="fc89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要构建此应用程序的容器映像并标记它以便上传，请运行以下命令:</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="c92d" class="js jt hi lk b fi lo lp l lq lr">bash-3.2$ docker build -t gcr.io/${PROJECT_ID}/mern-crud:v1 .<br/>Sending build context to Docker daemon  40.66MB<br/>Successfully built b8c5be5def8f<br/>Successfully tagged gcr.io/jgordon-gc/mern-crud:v1</span></pre><p id="a7ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将容器映像上传到容器注册表，以便我们可以对其进行部署:</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="bcbb" class="js jt hi lk b fi lo lp l lq lr">Successfully tagged gcr.io/jaygordon-mongodb/mern-crud:v1<br/>bash-3.2$ gcloud docker -- push gcr.io/${PROJECT_ID}/mern-crud:v1The push refers to repository [gcr.io/jaygordon-mongodb/mern-crud]</span></pre><p id="595a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我将在我的工作站上进行本地测试，以确保应用程序能够加载:</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="ef1c" class="js jt hi lk b fi lo lp l lq lr">docker run --rm -p 3000:3000 gcr.io/${PROJECT_ID}/mern-crud:v1<br/>&gt; mern-crud@0.1.0 start /usr/src/app<br/>&gt; node server<br/>Listening on port 3000</span></pre><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es me"><img src="../Images/d53cd2ec65f651ab76e64b48f5fbd647.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dpDoAeOqLXVWrXkp.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">node . js“mern-crud”app！</figcaption></figure><p id="3938" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">太好了——将我的浏览器指向<a class="ae jr" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>会把我带到这个网站。现在是时候创建一个kubernetes集群并在其上部署我们的应用程序了。</p><h2 id="0df1" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">使用Google Kubernetes引擎构建您的集群</h2><p id="8b08" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">我将使用谷歌云控制面板中的<a class="ae jr" href="https://cloud.google.com/shell/" rel="noopener ugc nofollow" target="_blank">谷歌云外壳</a>来管理我的部署。cloud shell安装了所有需要的应用程序和工具，允许您部署我上传到image registry的Docker映像，而无需在我的本地工作站上安装任何其他软件。</p><p id="9ffb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我将创建kubernetes集群，在其中部署映像，这将有助于将我们的应用程序投入生产。我将包括三个节点，以确保我们的应用程序正常运行。</p><p id="3850" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先设置我们的环境:</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="1cbb" class="js jt hi lk b fi lo lp l lq lr">export PROJECT_ID="jaygordon-mongodb"<br/>gcloud config set project $PROJECT_ID<br/>gcloud config set compute/zone us-central1-b</span></pre><p id="a43e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启动集群</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="bd18" class="js jt hi lk b fi lo lp l lq lr">gcloud container clusters create mern-crud --num-nodes=3</span></pre><p id="7b67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成后，您将在控制面板中看到一个三节点kubernetes集群。几分钟后，控制台将响应以下输出:</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="3d13" class="js jt hi lk b fi lo lp l lq lr">Creating cluster mern-crud...done.<br/>Created [https://container.googleapis.com/v1/projects/jaygordon-mongodb/zones/us-central1-b/clusters/mern-crud].<br/>To inspect the contents of your cluster, go to: <a class="ae jr" href="https://console.cloud.google.com/kubernetes/workload_/gcloud/us-central1-b/mern-crud?project=jaygordon-mongodb" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/kubernetes/workload_/gcloud/us-central1-b/mern-crud?project=jaygordon-mongodb</a><br/>kubeconfig entry generated for mern-crud.<br/>NAME       LOCATION       MASTER_VERSION  MASTER_IP       MACHINE_TYPE   NODE_VERSION  NUM_NODES  STATUS<br/>mern-crud  us-central1-b  1.8.7-gke.1     35.225.138.208  n1-standard-1  1.8.7-gke.1   3          RUNNING</span></pre><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lv"><img src="../Images/0a26c5c4c2fe1484ec4b4da805e21b2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QnDg2UPM737hmpuU.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">运行Kubernetes集群</figcaption></figure><p id="99ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">只剩几步了。现在，我们将使用<a class="ae jr" href="https://kubernetes.io/docs/reference/kubectl/overview/" rel="noopener ugc nofollow" target="_blank"> kubectl </a>将我们的应用从Google Cloud Shell部署到我们的集群:</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="5f07" class="js jt hi lk b fi lo lp l lq lr">kubectl run mern-crud --image=gcr.io/${PROJECT_ID}/mern-crud:v1 --port 3000</span></pre><p id="ccbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成后的输出应该是:</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="21f5" class="js jt hi lk b fi lo lp l lq lr">jay_gordon@jaygordon-mongodb:~$ kubectl run mern-crud --image=gcr.io/${PROJECT_ID}/mern-crud:v1 --port 3000<br/>deployment "mern-crud" created</span></pre><p id="ef1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在查看应用程序部署状态:</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="c3d4" class="js jt hi lk b fi lo lp l lq lr">jay_gordon@jaygordon-mongodb:~$ kubectl get pods<br/>NAME                         READY     STATUS    RESTARTS   AGE<br/>mern-crud-6b96b59dfd-4kqrr   1/1       Running   0          1m<br/>jay_gordon@jaygordon-mongodb:~$</span></pre><p id="084c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将为集群中的三个节点创建一个负载平衡器，以便它们能够为我们的应用程序正确地提供服务:</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="f4e3" class="js jt hi lk b fi lo lp l lq lr">jay_gordon@jaygordon-mongodb:~$ kubectl expose deployment mern-crud --type=LoadBalancer --port 80 --target-port 3000 <br/>service "mern-crud" exposed</span></pre><p id="c428" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在获取负载平衡器的IP，这样如果需要，它可以绑定到一个DNS名称，您就可以开始工作了！</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="9902" class="js jt hi lk b fi lo lp l lq lr">jay_gordon@jaygordon-mongodb:~$ kubectl get service<br/>NAME         TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)        AGE<br/>kubernetes   ClusterIP      10.27.240.1              443/TCP        11m<br/>mern-crud    LoadBalancer   10.27.243.208   35.226.15.67   80:30684/TCP   2m</span></pre><p id="d91a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">快速卷曲测试显示我的应用程序在线！</p><pre class="kt ku kv kw fd lj lk ll lm aw ln bi"><span id="5de0" class="js jt hi lk b fi lo lp l lq lr">bash-3.2$ curl -v 35.226.15.67<br/>* Rebuilt URL to: 35.226.15.67/<br/>*   Trying 35.226.15.67...<br/>* TCP_NODELAY set<br/>* Connected to 35.226.15.67 (35.226.15.67) port 80 (#0)<br/>&gt; GET / HTTP/1.1<br/>&gt; Host: 35.226.15.67<br/>&gt; User-Agent: curl/7.54.0<br/>&gt; Accept: */*<br/>&gt;<br/>&lt; HTTP/1.1 200 OK<br/>&lt; X-Powered-By: Express</span></pre><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lv"><img src="../Images/7d8eb62e42d6b90c3396f2ce6a77a6a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NHtOtJtYqoGYfVDE.png"/></div></div></figure><p id="e05e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我添加了一些测试数据，正如我们所看到的，这是我通过Kubernetes部署到GCP的应用程序的一部分，并将我的持久数据存储在MongoDB Atlas中。</p><p id="dcac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我使用完Kubernetes集群后，我可以轻松地销毁它:</p><p id="8254" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ls lt lu lk b">gcloud container clusters delete mern-crud</code></p><h2 id="7ff9" class="js jt hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">下一步是什么？</h2><p id="91d5" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">现在，您已经拥有了使用MongoDB Atlas和Kubernetes构建大型项目的所有工具。</p><p id="86a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看剩余的Google Kubernetes引擎教程，了解更多关于如何使用Kubernetes构建应用程序的信息。想了解更多关于MongoDB Atlas的信息，请点击这里。</p><p id="bf81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最初发布于<a class="ae jr" href="https://www.mongodb.com/blog/post/modern-distributed-application-deployment-with-kubernetes-and-mongodb-atlas" rel="noopener ugc nofollow" target="_blank">mongodb.com。</a></p><p id="dae4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有更多问题吗？加入<a class="ae jr" href="https://community-slack.mongodb.com" rel="noopener ugc nofollow" target="_blank"> MongoDB社区Slack </a>！</p></div></div>    
</body>
</html>