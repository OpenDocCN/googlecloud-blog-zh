<html>
<head>
<title>OpenCensus and Firestore Native</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">OpenCensus和Firestore Native</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/opencensus-and-firestore-native-34bc1e3a962f?source=collection_archive---------1-----------------------#2018-11-02">https://medium.com/google-cloud/opencensus-and-firestore-native-34bc1e3a962f?source=collection_archive---------1-----------------------#2018-11-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="17c9" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">混搭</h2></div><p id="ac83" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">2018–11–02更新</strong> w/ Kubernetes部署(见结尾)</p><p id="1403" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我最受欢迎的一个故事中，我从使用数据存储的Google示例应用引擎Flex应用开始，比较了Flex和Kubernetes之间的部署。最近，我采用了相同的样本，并添加了<a class="ae jt" href="https://opencensus.io" rel="noopener ugc nofollow" target="_blank"> OpenCensus </a>。离开一段时间后，我想重温一下OpenCensus，并决定试驾一下<a class="ae jt" href="https://firebase.google.com/docs/firestore/" rel="noopener ugc nofollow" target="_blank"> Cloud Firestore </a>(原生)。</p><p id="e4ab" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，OpenCensus和Firestore Native是双向的:输出到<a class="ae jt" href="https://cloud.google.com/stackdriver/" rel="noopener ugc nofollow" target="_blank"> Stackdriver </a>和<a class="ae jt" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>。随着旋转通过<a class="ae jt" href="https://opencensus.io/core-concepts/z-pages/" rel="noopener ugc nofollow" target="_blank"> zpages </a>。</p><h2 id="7873" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">设置</h2><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="5225" class="ju jv hi ku b fi ky kz l la lb">PROJECT=[[YOUR-PROJECT]]<br/>BILLING=[[YOUR-BILLING]]</span><span id="b545" class="ju jv hi ku b fi lc kz l la lb">gcloud projects create ${PROJECT}</span><span id="dd7b" class="ju jv hi ku b fi lc kz l la lb">gcloud beta billing projects link ${PROJECT} \<br/>--billing-account=${BILLING}</span><span id="c7aa" class="ju jv hi ku b fi lc kz l la lb">gcloud services enable firestore.googleapis.com --project=${PROJECT}</span></pre><p id="b797" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们最初将在GCP之外运行客户端代码，如果我做得好，我们也将把它部署到Kubernetes。出于这些原因和良好实践，我们将根据我们的需求创建一个服务帐户:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="cf78" class="ju jv hi ku b fi ky kz l la lb">ROBOT=firestore-oc<br/>EMAIL=${ROBOT}@${PROJECT}.iam.gserviceaccount.com</span><span id="c181" class="ju jv hi ku b fi lc kz l la lb">gcloud iam service-accounts create $ROBOT \<br/>--display-name=$ROBOT \<br/>--project=$PROJECT</span><span id="664b" class="ju jv hi ku b fi lc kz l la lb">gcloud iam service-accounts keys create ./key.json \<br/>--iam-account=${ROBOT}@${PROJECT}.iam.gserviceaccount.com \<br/>--project=$PROJECT</span><span id="b20e" class="ju jv hi ku b fi lc kz l la lb">for ROLE in datastore.user cloudtrace.agent monitoring.metricWriter<br/>do<br/>  gcloud projects add-iam-policy-binding $PROJECT \<br/>  --member=serviceAccount:${EMAIL} \<br/>  --role=roles/${ROLE}<br/>done</span></pre><blockquote class="ld le lf"><p id="64b6" class="ix iy lg iz b ja jb ij jc jd je im jf lh jh ji jj li jl jm jn lj jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong> Firestore的IAM角色被称为<code class="du lk ll lm ku b">datastore.user</code>反映了它的祖先。</p><p id="d509" class="ix iy lg iz b ja jb ij jc jd je im jf lh jh ji jj li jl jm jn lj jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong>生成一个密钥(<code class="du lk ll lm ku b">key.json</code>)并存储在当前目录中。当您调用客户机时，您需要引用这个密钥文件。</p></blockquote><h2 id="0606" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">客户</h2><p id="7e61" class="pw-post-body-paragraph ix iy hi iz b ja ln ij jc jd lo im jf jg lp ji jj jk lq jm jn jo lr jq jr js hb bi translated">我提到过这个客户是一个混搭:</p><ul class=""><li id="6424" class="ls lt hi iz b ja jb jd je jg lu jk lv jo lw js lx ly lz ma bi translated">带有数据存储示例的Google App Engine Flex[<a class="ae jt" href="https://github.com/GoogleCloudPlatform/golang-samples/tree/master/appengine_flexible/datastore" rel="noopener ugc nofollow" target="_blank">链接</a> ]</li><li id="c94d" class="ls lt hi iz b ja mb jd mc jg md jk me jo mf js lx ly lz ma bi translated">OpenCensus Quickstart Go [ <a class="ae jt" href="https://opencensus.io/quickstart/go" rel="noopener ugc nofollow" target="_blank">链接</a></li><li id="b56f" class="ls lt hi iz b ja mb jd mc jg md jk me jo mf js lx ly lz ma bi translated">Firestore Golang文档[ <a class="ae jt" href="https://godoc.org/cloud.google.com/go/firestore" rel="noopener ugc nofollow" target="_blank">链接</a></li></ul><figure class="kp kq kr ks fd mg"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="7e6c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第28–31行定义了代表我们将存储在Firestore中的文档的<code class="du lk ll lm ku b">visit</code>类型。</p><p id="18cd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第39–46行定义了OpenCensus对象。</p><blockquote class="ld le lf"><p id="7b8a" class="ix iy lg iz b ja jb ij jc jd je im jf lh jh ji jj li jl jm jn lj jp jq jr js hb bi translated">在我看来，这个术语令人困惑，尤其是当你与不同的工具(例如OpenCensus、Prometheus和Stackdriver)交互时，每个工具都有自己的术语。在OpenCensus中，我们用元数据<code class="du lk ll lm ku b">Record</code>一个<code class="du lk ll lm ku b">Measure</code>可能<code class="du lk ll lm ku b">Tagging</code>这些。我们必须将每个<code class="du lk ll lm ku b">Measure</code>聚合成一个或多个<code class="du lk ll lm ku b">Views</code>。<code class="du lk ll lm ku b">Views</code>是<code class="du lk ll lm ku b">Exported</code>一个或多个监控工具，如Stackdriver、Prometheus。</p></blockquote><p id="15c9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第56–60行创建一个Firestore客户端，并确保在我们完成后关闭该客户端。</p><p id="7616" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第63–65行是我们注册的地方(这里是上面定义的<code class="du lk ll lm ku b">latencyView</code>)。</p><p id="16a7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第67–75、77–82行分别为Stackdriver(监控)和Prometheus定义了导出器。很可能你会使用一个或多个不同的出口商，并且有越来越多的<a class="ae jt" href="https://opencensus.io/guides/exporters/supported-exporters/" rel="noopener ugc nofollow" target="_blank">列表</a>已经集成了OpenCensus。</p><blockquote class="ld le lf"><p id="5aa3" class="ix iy lg iz b ja jb ij jc jd je im jf lh jh ji jj li jl jm jn lj jp jq jr js hb bi translated">集成平台的列表因语言而异。我认为我们有理由假设有一个目标来确保每个解决方案在所有语言中都能工作。</p></blockquote><p id="bf97" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第85–86行记录了出口商。</p><p id="64b1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第92–95行将Stackdriver (Trace)注册为客户端跟踪的导出器。</p><blockquote class="ld le lf"><p id="48de" class="ix iy lg iz b ja jb ij jc jd je im jf lh jh ji jj li jl jm jn lj jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong> Stackdriver是一个跨多个解决方案的品牌，包括Stackdriver监控、Stackdriver日志记录、Stackdriver跟踪、Stackdriver错误报告。而普罗米修斯则专注于监控。提供踪迹的普罗米修斯的好伙伴是耶格[ <a class="ae jt" href="https://www.jaegertracing.io" rel="noopener ugc nofollow" target="_blank">链接</a> ]。</p></blockquote><p id="de1f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第97–124行创建了3个go例程，每个例程运行一个http服务器。第一个是运行在root ( <code class="du lk ll lm ku b">/</code>)端口<code class="du lk ll lm ku b">8080</code>上的Firestore的普通前端。第二个是端口<code class="du lk ll lm ku b">9100</code>上<code class="du lk ll lm ku b">/metrics</code>的普罗米修斯(基于拉的)指标导出器。第三个是<code class="du lk ll lm ku b">/rpcz</code>上的OpenCensus zpages [ <a class="ae jt" href="https://opencensus.io/core-concepts/z-pages/" rel="noopener ugc nofollow" target="_blank"> link </a>和<code class="du lk ll lm ku b">7777</code>上的<code class="du lk ll lm ku b">/tracez</code>。作为监视和跟踪解决方案的轻量级伴侣，zpages提供了调试和监视我们的应用程序的极好方法。</p><p id="de3b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第127-158行定义了Firestore的一个普通前端(暴露在端口<code class="du lk ll lm ku b">8080</code>上的<code class="du lk ll lm ku b">/</code>)。每次刷新检索添加到Firestore的10个最新文档(按时间戳),并向Firestore添加一个新文档。由于缺少一些随机和有趣的东西，文档由guids来控制。在本节中，我们开始将跟踪跨度串连在一起。</p><blockquote class="ld le lf"><p id="2f4b" class="ix iy lg iz b ja jb ij jc jd je im jf lh jh ji jj li jl jm jn lj jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong>第133行中名为<code class="du lk ll lm ku b">handler</code>的跨度消耗上下文并返回(修改后的)上下文。返回的上下文传播该范围，以便使用该上下文创建的后续范围被视为其子范围。在第145行，名为<code class="du lk ll lm ku b">RecordVisit-Outside</code>的跨度是用这个修改后的上下文创建的，但是它不返回修改后的上下文。因此，后续跨度将是<code class="du lk ll lm ku b">handler</code>的子跨度，而不是<code class="du lk ll lm ku b">RecordVisit-Outside</code>的子跨度。当我们打开Stackdriver Trace时，我们将看到这一点。</p></blockquote><p id="0b48" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第160–195行定义了<code class="du lk ll lm ku b">recordVisit</code>，这个函数创建一个新的<code class="du lk ll lm ku b">visit</code>文档，并将它保存到Firestore。第166-174行是奇迹发生的地方。这段代码摘自OpenCensus文档。我们取函数的调用开始时间(忽略花费在日志记录上的时间)，然后定义一个延迟函数。延迟的函数将在函数调用结束时运行，此时，我们将再次获取时间并计算出所用的时间，将此持续时间记录为我们的OpenCensus度量，标记它(可能与函数名重复)并记录它。第188–192行定义了一个名为<code class="du lk ll lm ku b">RecordVisit-Inside</code>的跨度，它将是<code class="du lk ll lm ku b">handler</code>的子跨度(不是<code class="du lk ll lm ku b">RecordVisit-Outside</code>)。在这里，我们还获得了一个指向集合<code class="du lk ll lm ku b">visits</code>的Firestore <code class="du lk ll lm ku b">CollectionRef</code>，一个Firestore <code class="du lk ll lm ku b">DocumentRef </code>是使用一个新的键(guid)创建的，然后文档(在第176–179行创建)被持久化。</p><p id="6483" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第197–241行定义了<code class="du lk ll lm ku b">queryVisits</code>，该函数查询Firestore <code class="du lk ll lm ku b">visits</code>集合中最近的10个文档。唯一新颖的特性是使用Firestore查询在抓取前10名之前对收集的<code class="du lk ll lm ku b">visits</code>进行排序。</p><p id="8d03" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">唷！</p><h2 id="20f1" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">乐趣</h2><p id="c24c" class="pw-post-body-paragraph ix iy hi iz b ja ln ij jc jd lo im jf jg lp ji jj jk lq jm jn jo lr jq jr js hb bi translated">我们启用了Firestore，但没有创建它。如果我没弄错的话，您必须通过云控制台来完成此操作，用正确的值替换<code class="du lk ll lm ku b">${PROJECT}</code>，浏览:<code class="du lk ll lm ku b"><a class="ae jt" href="https://console.cloud.google.com/firestore/?project=${PROJECT}" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/firestore/?project=${PROJECT</a>}</code>并选择3号门“纯模式下的云Firestore”:</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mj"><img src="../Images/4bfce62e253fe3bd0372301d79d3ae5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cWS-k7bUhWyxtojgAWPMDQ.png"/></div></div></figure><p id="e553" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">单击“下一步”，在“创建数据库”之前选择最适合您的位置。如果一切正常，您应该会看到Firestore控制台。保持此选项卡打开:</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mq"><img src="../Images/a469285eb1b42dc43b647cb56cadb85b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N8_0mZnWFanuL7cdjr_TYg.png"/></div></div></figure><p id="225f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行客户端(服务器？):</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="5ac8" class="ju jv hi ku b fi ky kz l la lb">PROJECT_ID=${PROJECT} \<br/>GOOGLE_APPLICATION_CREDENTIALS=path/to/key.json \<br/>go run firestore.go</span></pre><p id="9791" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果一切顺利，您应该能够在各自的端点上与服务器进行交互:</p><h2 id="442c" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">Firestore客户端(<code class="du lk ll lm ku b">localhost:8080/</code></h2><p id="5b73" class="pw-post-body-paragraph ix iy hi iz b ja ln ij jc jd lo im jf jg lp ji jj jk lq jm jn jo lr jq jr js hb bi translated">第一次不是很有趣:</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div class="er es mr"><img src="../Images/5bcd7f52ef8c221438dc980d54d3419d.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/format:webp/1*cAkvrKYN6Hr39NaOSbTTxg.png"/></div></figure><p id="172f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">试几下吧！</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es ms"><img src="../Images/b01a9b0eff28a44b1d76e8b52ac706bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*Am4V_Z0tizKgTc8azQwvSw.png"/></div></div></figure><p id="cfcf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当然，在10之后，值将继续变化，但是列表长度将保持为10。</p><p id="1b32" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您现在刷新Firestore控制台页面，您应该会看到所有新创建的文档:</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mt"><img src="../Images/568bc5e7e4b13afcbe6b185f17a4fb2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l4iD2gtKTz2RmIy6Id6weA.png"/></div></div></figure><h2 id="f4f0" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">页面(http://localhost:7777)</h2><p id="01d0" class="pw-post-body-paragraph ix iy hi iz b ja ln ij jc jd lo im jf jg lp ji jj jk lq jm jn jo lr jq jr js hb bi translated"><code class="du lk ll lm ku b">/rpcz</code>上的RPC统计:</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mu"><img src="../Images/521a83ec497b5203ea55debc2110182f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_q7EQ6K009DeHmgdSp9L8w.png"/></div></div></figure><p id="cce5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并追踪<code class="du lk ll lm ku b">/tracez</code>的统计数据:</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mv"><img src="../Images/150bba4d9379c7145ccce4879365579c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7nQegnuE8AQny8sRhtPtBQ.png"/></div></div></figure><h2 id="fb0c" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">普罗米修斯度量端点(http://localhost:9100/metrics)</h2><p id="fa2a" class="pw-post-body-paragraph ix iy hi iz b ja ln ij jc jd lo im jf jg lp ji jj jk lq jm jn jo lr jq jr js hb bi translated">约定将指标端点放在端口<code class="du lk ll lm ku b">9100</code>上的<code class="du lk ll lm ku b">/metrics</code>:</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mw"><img src="../Images/04d29d2a185eabce19d281932f7cc323.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TfKDU9Ul5Dh5eBVI4WfstQ.png"/></div></div></figure><p id="1fbc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">虽然您的值会有所不同，但是请注意前缀<code class="du lk ll lm ku b">firestore_oc</code>，这是我们在创建导出器时提供给它的名称空间的值。<code class="du lk ll lm ku b">demo_latency</code>是OpenCensus测量名称(<code class="du lk ll lm ku b">demo/Latency</code>)的普罗米修斯形式，我们定义的直方图呈现为一个桶，其桶大小为I(！)在我的代码中使用，但<strong class="iz hj">不是</strong>这里使用的值【为这个疏忽道歉】。</p><h2 id="b668" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">堆栈驱动程序跟踪</h2><p id="d764" class="pw-post-body-paragraph ix iy hi iz b ja ln ij jc jd lo im jf jg lp ji jj jk lq jm jn jo lr jq jr js hb bi translated">浏览到控制台页面，查看Stackdriver Trace: <code class="du lk ll lm ku b">cloud.console.google.comn/traces/?project=${PROJECT}</code>同样，请用您的值替换<code class="du lk ll lm ku b">${PROJECT}</code>。这将提供一个类似于以下内容的控制台:</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mx"><img src="../Images/daec47733138ff03ae744c4278d5b3dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8CcXh4vUAcbm-y2v3ylBnA.png"/></div></div></figure><p id="00ff" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意“最近轨迹”的URI为<code class="du lk ll lm ku b">handler</code>，这是我们给自己创建的第一个轨迹跨度起的名字。单击以下任一项:</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mt"><img src="../Images/f2b2f289400722d7709d380c29b8d5bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s0sM1vApX5kFw6_zP4uTPQ.png"/></div></div></figure><p id="b3a2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里发生了很多事。我不会试图涵盖一切。这里你可以看到<code class="du lk ll lm ku b">handler</code>是如何成为我们的父span的。<code class="du lk ll lm ku b">RecordVisit-Outside</code>和<code class="du lk ll lm ku b">RecordVisit-Inside</code>是它的子节点。请注意，Firestore有一些跨度是自动为我们提供的:<code class="du lk ll lm ku b">Firestore.RunQuery</code>和<code class="du lk ll lm ku b">Firestore.Commit</code>。这是非常有用的，而且随着Trace和OpenCensus的发展，需要更少的开发人员干预和更多的开箱即用的魔法。</p><h2 id="de75" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">堆栈驱动程序监控</h2><p id="807b" class="pw-post-body-paragraph ix iy hi iz b ja ln ij jc jd lo im jf jg lp ji jj jk lq jm jn jo lr jq jr js hb bi translated">如果还没有，您将需要将您的项目添加到新的Stackdriver工作区，或者将您的项目添加到现有的Stackdriver工作区。对于像这样的一次性项目，我也创建了一个新的(一次性)工作空间。你的选择。</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es my"><img src="../Images/b793af7942a4c8bedd3dc3b968f336a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*82xyYcqnwDRdteYkpFPLyA.png"/></div></div></figure><p id="021c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从“Resources”中选择“Metrics Explorer ”,您应该能够浏览现在包括名为<code class="du lk ll lm ku b">firestore_oc/demo/Latency</code>的(自定义指标)和多个<code class="du lk ll lm ku b">firestore_oc/grpc.io</code>前缀指标的指标。</p><p id="a50d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我在上面暗示了这些自动生成的指标。Google已经装备了它的gRPC库，因此，在OpenCensus中使用这些库可以免费获得指标。</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mz"><img src="../Images/9c14b3e0793d99f00d1952682cdbb192.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YkMxEuEJgnx1HvvJTh1o1w.png"/></div></div></figure><p id="95cb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">坦率地说，我不理解这个图表。</p><p id="356c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Prometheus Metrics Exporter实现了我的预期。它显示了延迟值直方图。在我们的代码中，我们创建了一个直方图视图。Stackdriver为我们提供了一个度量(这又是一个命名挑战)，但是这个度量代表OpenCensus度量(不是视图)。因此，如果我看到与每次刷新Firestore客户端时记录的每个延迟相对应的一系列点，这将是有意义的(暂且不提名称)。但是，这个似乎没有做到这一点。</p><p id="c491" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">假设</strong> : Stackdriver有这个60s的报告周期。也许我只是需要更多的数据？</p><p id="4981" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们看看:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="d75f" class="ju jv hi ku b fi ky kz l la lb">for TEST in {1..1000}<br/>do<br/>  curl <a class="ae jt" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/</a><br/>  sleep 0.5s<br/>done</span></pre><p id="f6c3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">嗯……也许就是这样:</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es na"><img src="../Images/f2586b5b61f5ab3542a59d36ffa8fe7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z6n0eUQn12HUCF0vhPOZ4Q.png"/></div></div></figure><h2 id="5295" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">结论</h2><p id="9a86" class="pw-post-body-paragraph ix iy hi iz b ja ln ij jc jd lo im jf jg lp ji jj jk lq jm jn jo lr jq jr js hb bi translated">我直到昨天才使用Firestore，所以这篇文章部分是关于Firestore的。我的主要动机是重新连接OpenCensus，所以我们转换了一个现有的基于数据存储的应用程序来使用Firestore，然后放了一个OpenCensus bow。</p><p id="1892" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">仅此而已！</p><h1 id="e77c" class="nb jv hi bd jw nc nd ne ka nf ng nh ke io ni ip kh ir nj is kk iu nk iv kn nl bi translated">整理</h1><p id="1c59" class="pw-post-body-paragraph ix iy hi iz b ja ln ij jc jd lo im jf jg lp ji jj jk lq jm jn jo lr jq jr js hb bi translated">您可以不可撤销地删除整个项目:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="32c8" class="ju jv hi ku b fi ky kz l la lb">gcloud projects delete ${PROJECT} --quiet</span></pre><p id="22eb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">或者，您可以删除访问集合:</p><figure class="kp kq kr ks fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es my"><img src="../Images/fb7ccb1b3041915f9f7e7692d7e011a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3FX-9uS43mf-M2jxwwDZUA.png"/></div></div></figure><p id="97f0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我觉得(！？)您不能从项目中完全删除Firestore。嗯嗯:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="38b2" class="ju jv hi ku b fi ky kz l la lb">gcloud services disable firestore.googleapis.com \<br/>--project=${PROJECT}<br/>Operation "operations/acf.89e3a772-66c5-4ab8-bf08-03a1db8fbf6a" finished successfully.</span></pre><p id="8fc7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="332f" class="ju jv hi ku b fi ky kz l la lb">gcloud services list \<br/>--project=$PROJECT \<br/>| grep firestore<br/>firestore.googleapis.com                Cloud Firestore API</span></pre><h2 id="f16f" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">库伯内特斯</h2><p id="6d86" class="pw-post-body-paragraph ix iy hi iz b ja ln ij jc jd lo im jf jg lp ji jj jk lq jm jn jo lr jq jr js hb bi translated">使解决方案可移植的微小代码更改(通过移除Linux的“uuidgen”依赖性):</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="8325" class="ju jv hi ku b fi ky kz l la lb">import (<br/>    ...<br/>    "github.com/google/uuid"<br/>    ...<br/>)</span><span id="45f4" class="ju jv hi ku b fi lc kz l la lb">func recordVisit ... {<br/>    ...<br/>    u, err := uuid.NewRandom()<br/>    if err != nil {<br/>        log.Println(err)<br/>    }<br/>    key := u.String()<br/>    log.Printf("Key: %v", key)<br/>    ...<br/>}</span></pre><p id="f1f4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这些更改应该在代码功能没有任何明显变化的情况下编译和运行。</p><p id="0318" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Dockerfile:</p><figure class="kp kq kr ks fd mg"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="2568" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后构建它，运行它，如果它能按预期工作，就把它推到注册表中:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="2a21" class="ju jv hi ku b fi ky kz l la lb">DOCKERHUB=[[YOUR-DOCKERHUB-USERNAME]]<br/>TAG="firestore-oc:181102"</span><span id="2c3b" class="ju jv hi ku b fi lc kz l la lb">docker build \<br/>--file=Dockerfile \<br/>--tag=${DOCKERHUB}/${TAG} \<br/>.</span><span id="ea60" class="ju jv hi ku b fi lc kz l la lb">docker run \<br/>--interactive \<br/>--tty \<br/>--publish=7777:7777 \<br/>--publish=8080:8080 \<br/>--publish=9100:9100 \<br/>--env=PROJECT_ID=${PROJECT} \<br/>--env=GOOGLE_APPLICATION_CREDENTIALS=/keys/key.json \<br/>--volume=$PWD/key.json:/keys/key.json \<br/>${TAG}</span><span id="bd9f" class="ju jv hi ku b fi lc kz l la lb">docker push ${DOCKERHUB}/${TAG}</span></pre><p id="a385" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要在Kubernetes中反映服务帐户键，并为映像创建一个部署:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="bcba" class="ju jv hi ku b fi ky kz l la lb">kubectl create secret generic firestore-oc \<br/>--from-file=key.json=./key.181102.json</span></pre><p id="3395" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Deployment.yaml(包括服务):</p><figure class="kp kq kr ks fd mg"><div class="bz dy l di"><div class="mh mi l"/></div></figure><blockquote class="ld le lf"><p id="2871" class="ix iy lg iz b ja jb ij jc jd je im jf lh jh ji jj li jl jm jn lj jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong>别忘了换掉<code class="du lk ll lm ku b">${DOCKERHUB}</code>、<code class="du lk ll lm ku b">${TAB}</code>和<code class="du lk ll lm ku b">${PROJECT}</code>。</p></blockquote><p id="545a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="ff57" class="ju jv hi ku b fi ky kz l la lb">kubectl apply --filename=deployment.yaml</span></pre><p id="6937" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第一个测试是将端口转发到部署创建的单个pod:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="6f5e" class="ju jv hi ku b fi ky kz l la lb">kubectl port-forward $(\<br/>  kubectl get pod \<br/>  --selector=app=firestore-oc \<br/>  --output=jsonpath="{.items[0].metadata.name}") \<br/>8080:8080 \<br/>7777:7777 \<br/>9100:9100</span></pre><p id="472c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一切都应该和以前一样，你应该可以访问<code class="du lk ll lm ku b">:8080</code>、<code class="du lk ll lm ku b">:7777/rpcz</code>(或<code class="du lk ll lm ku b">:7777/tracez</code>)和<code class="du lk ll lm ku b">:9100/metrics</code>上的服务。</p><p id="0b13" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，如果您愿意，我们可以通过公开的节点端口，通过计算引擎实例之一来访问服务:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="70fc" class="ju jv hi ku b fi ky kz l la lb">NODE=$(\<br/>  kubectl get nodes \<br/>  --output=jsonpath="{.items[0].metadata.name}")</span><span id="0c6a" class="ju jv hi ku b fi lc kz l la lb">CLIENT=$(\<br/>  kubectl get services/firestore-oc \<br/>  --output=jsonpath='{.spec.ports[?(@.name=="client")].nodePort}')<br/>ZPAGES=$(\<br/>  kubectl get services/firestore-oc \<br/>  --output=jsonpath='{.spec.ports[?(@.name=="zpages")].nodePort}')<br/>METRIX=$(\<br/>  kubectl get services/firestore-oc \<br/>  --output=jsonpath='{.spec.ports[?(@.name=="metrics")].nodePort}')</span><span id="5a4d" class="ju jv hi ku b fi lc kz l la lb">gcloud compute ssh ${NODE} \<br/>--ssh-flag="-L 8080:localhost:${CLIENT}" \<br/>--ssh-flag="-L 7777:localhost:${ZPAGES}" \<br/>--ssh-flag="-L 9100:localhost:${METRIX}" \<br/>--project=$PROJECT</span></pre><p id="47e1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您正在使用Kubernetes引擎，并且也想提供一个HTTP/S负载均衡器，那么您可以<code class="du lk ll lm ku b">apply</code>下面的<code class="du lk ll lm ku b">ingress.yaml</code>只公开(为了简单起见)客户端应用程序:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="5f26" class="ju jv hi ku b fi ky kz l la lb">---<br/>apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: firestore-oc<br/>spec:<br/>  backend:<br/>    serviceName: firestore-oc<br/>    servicePort: 8080<br/>...</span></pre><p id="df47" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">完成后，如果您创建集群只是为了探索这个问题，那么您可能(不可挽回地！)用以下内容删除:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="c0b8" class="ju jv hi ku b fi ky kz l la lb">gcloud container clusters delete ${CLUSTER} \<br/>--project=${PROJECT} \<br/>--region=${REGION}</span></pre></div></div>    
</body>
</html>