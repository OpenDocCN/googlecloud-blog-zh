<html>
<head>
<title>How is my Cloud Storage Data being used?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我的云存储数据使用情况如何？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-is-my-cloud-storage-data-being-used-3fc9fd57a9f4?source=collection_archive---------1-----------------------#2020-07-14">https://medium.com/google-cloud/how-is-my-cloud-storage-data-being-used-3fc9fd57a9f4?source=collection_archive---------1-----------------------#2020-07-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d0279957368ea3d1917240d150c7821a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bDUxA-9q3D06rcMi.png"/></div></div></figure><p id="eaa8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本教程指导您在Data Studio中创建Google云存储日志的可视化，这为您提供了对Google云存储流量和存储数据的宝贵见解。我们将创建一个仪表板，显示与计算实例区域相比较的存储桶区域，并突出显示分区效率低下的区域。</p><p id="c15d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本教程基于<a class="ae jo" href="https://showcase.withgoogle.com/storage/" rel="noopener ugc nofollow" target="_blank">2020 Google Cloud Next Showcase for data visualization</a>。</p><p id="6f4f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">目录</strong></p><ul class=""><li id="933d" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><a class="ae jo" href="#6363" rel="noopener ugc nofollow">为您的存储桶启用云访问日志</a></li><li id="092f" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="#9ddf" rel="noopener ugc nofollow">将日志加载到BigQuery </a></li><li id="2a5a" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="#d17f" rel="noopener ugc nofollow">映射云存储桶位置</a></li><li id="20e1" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="#0709" rel="noopener ugc nofollow">映射计算引擎实例位置</a></li><li id="f314" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="#4622" rel="noopener ugc nofollow">为DataStudio可视化创建BigQuery视图</a></li><li id="944e" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="#71c7" rel="noopener ugc nofollow">连接到数据工作室</a></li><li id="1336" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="#a01c" rel="noopener ugc nofollow">结论</a></li><li id="c109" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">附录:<br/> <a class="ae jo" href="#5239" rel="noopener ugc nofollow"> A.1:自动化计算引擎实例的IP跟踪</a> <br/> <a class="ae jo" href="#f75e" rel="noopener ugc nofollow"> A.2:自动化将访问日志加载到BigQuery </a> <br/> <a class="ae jo" href="#ddb6" rel="noopener ugc nofollow"> A.3:理解单个用户请求</a></li></ul><h1 id="6363" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">为您的存储桶启用云访问日志</h1><p id="714b" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">为了分析对您数据的访问，您必须通过<a class="ae jo" href="https://cloud.google.com/storage/docs/access-logs" rel="noopener ugc nofollow" target="_blank">谷歌云访问日志</a>收集数据。使用以下命令为您想要分析的任何存储桶启用使用情况日志记录:</p><ol class=""><li id="9091" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn lg jv jw jx bi translated">选择您的存储桶名称、日志存储桶名称和日志前缀，并在您的终端中为它们设置环境变量:</li></ol><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="dc84" class="lq ke hi lm b fi lr ls l lt lu">BUCKET="your-bucket-name"<br/>LOGS_BUCKET="your-logs-bucket"<br/>LOGS_PREFIX="your-logs-prefix"</span></pre><p id="a373" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.创建新的日志存储桶:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="1715" class="lq ke hi lm b fi lr ls l lt lu">gsutil mb "gs://${LOGS_BUCKET}"</span></pre><p id="f83a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.授予必要的权限:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="c78f" class="lq ke hi lm b fi lr ls l lt lu">gsutil iam ch group:cloud-storage-analytics@google.com:objectCreator "gs://${LOGS_BUCKET}"</span></pre><p id="4315" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.为bucket<strong class="is hj">GS://your-bucket</strong>启用云访问日志，并将日志存储在<strong class="is hj"> gs://your-logs-bucket </strong>中:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="147e" class="lq ke hi lm b fi lr ls l lt lu">gsutil logging set on -b "gs://${LOGS_BUCKET}" -o "${LOGS_PREFIX}" "gs://${BUCKET}"</span></pre><p id="25aa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果为多个存储桶启用日志记录，请为所有存储桶指定相同的${LOGS_PREFIX}。否则，日志前缀默认为与日志相关联的存储桶的名称，并且在下一步中很难搜索它们。</p><h1 id="9ddf" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">将日志加载到BigQuery</h1><p id="5fe5" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">按照下面的说明将数据加载到BigQuery中。有关访问日志的更多帮助，请参考<a class="ae jo" href="https://cloud.google.com/storage/docs/access-logs" rel="noopener ugc nofollow" target="_blank">谷歌云存储文档</a>。</p><ol class=""><li id="d934" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn lg jv jw jx bi translated">下载存储使用模式:</li></ol><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="9923" class="lq ke hi lm b fi lr ls l lt lu">wget <a class="ae jo" href="http://storage.googleapis.com/pub/cloud_storage_usage_schema_v0.json" rel="noopener ugc nofollow" target="_blank">http://storage.googleapis.com/pub/cloud_storage_usage_schema_v0.json</a></span></pre><p id="1cec" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.创建大查询数据集:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="ad0c" class="lq ke hi lm b fi lr ls l lt lu">bq mk storageanalysis</span></pre><p id="c9a8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.将使用数据加载到BigQuery:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="0168" class="lq ke hi lm b fi lr ls l lt lu">bq load --skip_leading_rows=1 storageanalysis.usage "gs://$LOGS_BUCKET/${LOGS_PREFIX}_usage*" ./cloud_storage_usage_schema_v0.json</span></pre><p id="3a82" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">记得清理加载到BigQuery中的日志，这样就不会意外地重新加载它们。</p><p id="f150" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">参见本文末尾的附录，了解如何在使用Google Cloud函数触发器创建访问日志时自动加载它们。</p><h1 id="d17f" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">映射云存储桶位置</h1><p id="23b6" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">接下来，创建一个存储桶位置到国家代码的映射表，以便稍后查询每个存储桶位于哪个国家:</p><ol class=""><li id="26a1" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn lg jv jw jx bi translated">获取每个存储桶的名称和位置，并将它们存储在一个CSV文件中。请注意，这仅从一个存储桶中获取数据。如果您想要分析多个存储桶，您可能想要运行前缀搜索(例如，“gs://bucket-prefix*”)，或者多次运行此命令并保持附加到CSV:</li></ol><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="d603" class="lq ke hi lm b fi lr ls l lt lu">gsutil ls -L -b "gs://${BUCKET}" |<br/> grep -e "gs://" -e "Location constraint" |<br/> awk -F ":" ‘{printf (NR%2==0) ? $2 "\n" : $2 ","}’ |<br/> sed 's/\///g;s/[[:blank:]]//g' &gt; bucket_locations.csv</span></pre><p id="3a81" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.将CSV文件加载到名为<strong class="is hj"> storageanalysis </strong>的表中。<strong class="is hj">铲斗_位置</strong>:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="4910" class="lq ke hi lm b fi lr ls l lt lu">bq load --replace --source_format=CSV storageanalysis.bucket_locations ./bucket_locations.csv bucket_name:STRING,bucket_location:STRING</span></pre><p id="7b30" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些命令创建了一个新的BigQuery表，可以用来查找我们在使用日志中遇到的每个bucket的位置。要验证一切正常，请运行以下命令:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="b534" class="lq ke hi lm b fi lr ls l lt lu">bq ls storageanalysis</span></pre><p id="1aa5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您应该会看到类似下面的内容:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="97eb" class="lq ke hi lm b fi lr ls l lt lu">tableId Type Labels Time Partitioning Clustered Fields<br/> — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — <br/>bucket_locations TABLE<br/>usage TABLE</span></pre><h1 id="0709" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">映射计算引擎实例位置</h1><p id="b924" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">接下来，我们要查看计算引擎实例的请求日志。</p><ol class=""><li id="2e1a" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn lg jv jw jx bi translated">获取一个使用中的计算实例外部IP的CSV，其中有一个针对<strong class="is hj">国家</strong>的额外空列，我们稍后将填充该列:</li></ol><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="a86e" class="lq ke hi lm b fi lr ls l lt lu">gcloud compute instances list --format="csv(id,name,creationTimestamp,end_time,EXTERNAL_IP,INTERNAL_IP,zone,country)" --filter="status=RUNNING" &gt; compute_instance_locations.csv</span></pre><p id="dd63" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:如果您正在分析一个多项目环境，您可能需要为您的所有项目运行这个命令:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="6a39" class="lq ke hi lm b fi lr ls l lt lu">gcloud compute instances list --format="csv(id,name,creationTimestamp,end_time,EXTERNAL_IP,INTERNAL_IP,zone,country)" --filter="status=RUNNING" --project={your-project-id} &gt;&gt; compute_instance_locations.csv</span></pre><p id="c4c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.将CSV加载到名为<strong class="is hj">storage analysis . compute _ instance _ locations:</strong>的BigQuery表中</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="83ac" class="lq ke hi lm b fi lr ls l lt lu">bq load --replace --source_format=CSV --skip_leading_rows=1 storageanalysis.compute_instance_locations ./compute_instance_locations.csv resource_id:STRING,resource_name:STRING,start_time:TIMESTAMP,end_time:TIMESTAMP,external_ip:STRING,internal_ip:STRING,zone:STRING,country:STRING</span></pre><p id="8bc5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.接下来，将实例区域映射到其<a class="ae jo" href="https://cloud.google.com/compute/docs/regions-zones" rel="noopener ugc nofollow" target="_blank">计算实例位置</a>的2位数ISO国家代码。如果要从命令行运行查询，可以使用:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="c2e9" class="lq ke hi lm b fi lr ls l lt lu">bq query --use_legacy_sql=false '{QUERY_BELOW_HERE}'</span></pre><p id="89da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者您可以使用<a class="ae jo" href="https://console.cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank"> BigQuery控制台</a>。使用任一方法，运行以下查询:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="9531" class="lq ke hi lm b fi lr ls l lt lu">CREATE TEMP TABLE `mappings` AS<br/>SELECT *<br/>FROM UNNEST(<br/>[STRUCT("US" AS abbr, "US%" AS long), ("TW", "ASIA-EAST1%"),<br/>("JP", "ASIA-NORTHEAST1%"), ("HK", "ASIA-EAST2%"),<br/>("JP", "ASIA-NORTHEAST2%"),("KR", "ASIA-NORTHEAST3%"),<br/>("IN", "ASIA-SOUTH1%"),("SG", "ASIA-SOUTHEAST1%"),<br/>("AU", "AUSTRALIA%"),("FI", "EUROPE-NORTH1%"),<br/>("BE", "EUROPE-WEST1%"),("GB", "EUROPE-WEST2%"),<br/>("DE", "EUROPE-WEST3%"),("NL", "EUROPE-WEST4%"),<br/>("CH", "EUROPE-WEST6%"),("CA", "NORTHAMERICA%"),<br/>("BR", "SOUTHAMERICA%")<br/>]);<br/>UPDATE storageanalysis.compute_instance_locations<br/>SET country = abbr<br/>FROM mappings<br/>WHERE UPPER(zone) LIKE long;</span></pre><p id="adde" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请参阅本文末尾的附录，了解如何对单个用户请求执行此操作，以及如何自动跟踪短暂的计算实例IP。</p><h1 id="4622" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">为DataStudio可视化创建BigQuery视图</h1><p id="e69d" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">接下来，创建一个BigQuery视图，它允许您更新基础表，而不必重新生成这个表。换句话说，它将反映来自其他表的最新数据。</p><p id="c4ab" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以从BigQuery控制台运行该查询，并在结果上单击“Save view”将其保存到名为“visualization_view”的视图中，或者在终端中运行以下命令:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="77a6" class="lq ke hi lm b fi lr ls l lt lu">bq mk --use_legacy_sql=false --description "View for Data Studio visualization" --view '{QUERY_BELOW_HERE}' storageanalysis.visualization_view</span></pre><p id="30c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">查询如下所示:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="d648" class="lq ke hi lm b fi lr ls l lt lu">SELECT <br/> time_micros AS timestamp,<br/> SUBSTR(zone,0,length(zone)-2) as client_location,<br/> compute_instances.country as client_country,<br/> cs_bucket AS bucket_name,<br/> LOWER(bucket_location) AS bucket_location,<br/> IF(LOWER(SUBSTR(bucket_location,0,2))=LOWER(SUBSTR(zone,0,2)), “Colocated”, “Non Colocated”) AS colocated,<br/> cs_object AS object_name,<br/> sc_bytes AS egress_bytes,<br/> cs_method AS operation,<br/> IF(LOWER(SUBSTR(bucket_location,0,2))=LOWER(SUBSTR(zone,0,2)), sc_bytes/POWER(2,30)*0.01, sc_bytes/POWER(2,30)*0.10) AS calculated_cost<br/>FROM `storage-traffic-project.storageanalysis.usage` <br/>LEFT JOIN `storage-traffic-project.storageanalysis.bucket_locations`<br/>ON cs_bucket=bucket_name<br/>LEFT JOIN `storage-traffic-project.storageanalysis.compute_instance_locations` AS compute_instances<br/>ON compute_instances.external_ip=c_ip AND compute_instances.start_time &lt; TIMESTAMP_MICROS(time_micros) AND (TIMESTAMP_MICROS(time_micros) &lt; compute_instances.end_time OR compute_instances.end_time IS NULL)<br/>WHERE cs_method LIKE "GET" AND cs_object NOT LIKE "" AND cs_object IS NOT NULL AND zone IS NOT NULL;</span></pre><h1 id="71c7" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">将数据连接到Data Studio</h1><ol class=""><li id="abf8" class="jp jq hi is b it lb ix lc jb lv jf lw jj lx jn lg jv jw jx bi translated">打开<a class="ae jo" href="https://datastudio.google.com/u/0/reporting/b698db4c-f398-41ca-b3fd-82c39f70b047/page/1b1QB/" rel="noopener ugc nofollow" target="_blank"> Data Studio仪表盘</a>，其中包含模拟数据。</li><li id="dce2" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">单击顶部的“制作此报告的副本”图标</li></ol><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/140edfd0beabddab9ea3028a67ca2509.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rVMS1GHMqm5rjFoa"/></div></div></figure><p id="7216" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.在“新数据源”下，单击下拉菜单，然后单击“创建新数据源”(如果您想使用模板中的模拟数据，也可以保持不变)。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/d1ba919c63431a4303f4da65c88beb27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DpFgfQP9ZdfzG7_j"/></div></div></figure><p id="8d7c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.选择“BigQuery”作为连接器。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/c7b94f69304f13d7130633a938d3d843.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ktxdaFsg6YiggYmk"/></div></div></figure><p id="49fe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.导航到您刚刚创建的视图，选择它，然后单击右上角的“连接”。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/f4673a5349d57ae44aff428d00d285f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ck-bkDNQ6D0nz4GA"/></div></div></figure><p id="2bdd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.点按“连接”，然后点按“添加到报告”，然后点按“拷贝报告”</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/06ab51cb5eb2073f85e3ea4a58d828e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*n3mn0cnUfqp3iJ1I"/></div></div></figure><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/648c63c6cb8ee4e9de066b751aaa0141.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RlM4fGZaIVCjthfy"/></div></div></figure><figure class="lh li lj lk fd ij er es paragraph-image"><div class="ab fe cl lz"><img src="../Images/7247530134a8c6aa67c054b135695081.png" data-original-src="https://miro.medium.com/v2/0*YVsXN6bLP8tPKRez"/></div></figure><h1 id="a01c" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">结论</h1><p id="581e" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">感谢您花时间阅读本教程，并了解如何使用云存储、BigQuery和DataStudio通过请求日志可视化获得洞察力。</p><p id="559f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">准备好迈出下一步了吗？</p><ul class=""><li id="1cd2" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">学习<a class="ae jo" href="https://cloud.google.com/storage/docs/quickstart-gsutil" rel="noopener ugc nofollow" target="_blank">使用云存储执行基本任务</a></li><li id="4536" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">查看我们所有的<a class="ae jo" href="https://cloud.google.com/products/storage" rel="noopener ugc nofollow" target="_blank">谷歌云存储选项</a></li></ul><h1 id="b834" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">附录</h1><h1 id="5239" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">A.1:计算引擎实例的自动化IP跟踪</h1><p id="8bd8" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">计算引擎实例外部IP在启动时分配，在关闭时取消分配。一旦计算引擎实例关闭或删除，分配的外部IP将被取消分配，并可由另一个实例重新使用。云存储访问日志跟踪使用的外部IP，但不跟踪与之关联的特定计算引擎实例。您必须在计算引擎实例的整个生命周期中跟踪IP分配和取消分配。</p><p id="c98b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要自动跟踪计算引擎实例的IP，请使用云资产清单API的<a class="ae jo" href="https://cloud.google.com/asset-inventory/docs/overview#monitoring_asset_changes" rel="noopener ugc nofollow" target="_blank">监控资产变更特性</a>，它可以跟踪资源元数据的历史信息，并可以使用云发布/订阅让我们知道何时发生变更。我们将使用云函数来记录来自BigQuery中的发布/订阅提要的IP更新，使用之前创建的相同表(<strong class="is hj">storage analysis . compute _ instance _ locations</strong>)。</p><ol class=""><li id="5df5" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn lg jv jw jx bi translated">通过点击<a class="ae jo" href="https://console.cloud.google.com/apis/library/cloudresourcemanager.googleapis.com" rel="noopener ugc nofollow" target="_blank">链接</a>，为您的项目启用资源管理器API。</li><li id="9e0f" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">创建发布/订阅主题以关联云函数触发器:</li></ol><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="0d7f" class="lq ke hi lm b fi lr ls l lt lu">gcloud pubsub topics create compute_instance_updates</span></pre><p id="5b38" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.创建一个资产清单Feed来推送对发布/订阅主题<strong class="is hj">compute _ instance _ updates</strong>的更新:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="5d06" class="lq ke hi lm b fi lr ls l lt lu">gcloud asset feeds create feed-name --project="{your-project-id}" — content-type="resource" --asset-types="compute.googleapis.com/Instance" --pubsub-topic="projects/{your-project-id}/topics/compute_instance_updates"</span></pre><p id="6bd8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们将创建一个云函数来处理来自发布/订阅主题<strong class="is hj">compute _ instance _ updates</strong>的事件。</p><ol class=""><li id="f6d4" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn lg jv jw jx bi translated">在<a class="ae jo" href="http://console.cloud.google.com/functions/list?project=" rel="noopener ugc nofollow" target="_blank">云功能控制台</a>中，点击“创建功能”。</li><li id="f894" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">将函数命名为“计算实例更新函数”。</li><li id="dfef" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">在“Trigger”下拉列表中，选择“Cloud Pub/Sub”，然后从出现的下拉列表中选择“compute_instance_updates”主题。</li><li id="1e3d" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">单击“保存”，然后单击“下一步”</li><li id="e510" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">选择Python 3.7作为运行时。</li><li id="2551" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">选择源代码为“来自云存储的ZIP”。</li><li id="98aa" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">对于“云存储位置”，输入“GS://Storage-traffic-project/compute _ instance _ updates _ function . zip”</li><li id="15eb" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">可以<a class="ae jo" href="https://storage.googleapis.com/storage-traffic-project/compute_instance_updates_function.zip" rel="noopener ugc nofollow" target="_blank">下载zip </a>文件查看云函数的源码。</li><li id="4af2" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">对于“要执行的功能”，请输入“句柄_资产_事件”。</li><li id="981a" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">单击“部署”部署该功能。</li></ol><p id="1a43" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当计算引擎实例被创建、启动、关闭或删除时，部署的云功能将跟踪何时从计算实例分配和取消分配外部IP。使用这些信息，BigQuery可以根据IP分配给实例的时间，与云存储访问日志中的计算引擎实例相关联。</p><p id="efe9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">欲了解更多信息，请访问:</p><ul class=""><li id="7b8f" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><a class="ae jo" href="https://cloud.google.com/asset-inventory/docs/monitoring-asset-changes" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/asset-inventory/docs/monitoring-asset-changes</a></li><li id="59d8" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">【https://cloud.google.com/functions/docs/calling/pubsub T4】</li></ul><h1 id="f75e" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">A.2:自动将访问日志加载到BigQuery中</h1><p id="97ce" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">本教程描述了如何将请求日志手动加载到storagenalysis.usage表中。为了自动化这个过程，你必须使用一个基于对象事件的云函数存储触发器。</p><p id="6b08" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们将创建一个云函数，以便在创建新对象时处理云存储日志桶的事件。</p><ol class=""><li id="1ec1" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn lg jv jw jx bi translated">从<a class="ae jo" href="http://console.cloud.google.com/functions/list?project=" rel="noopener ugc nofollow" target="_blank">云功能控制台</a>中，点击“创建功能”。</li><li id="e7dc" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">将函数命名为“存储日志更新函数”。</li><li id="3a9e" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">在“Trigger”下拉列表中，选择“Cloud Storage”，然后从出现的“Event Type”下拉列表中选择“Finalize/Create”事件，并在存储访问日志的“bucket”中选择日志Bucket。</li><li id="7ad7" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">单击“保存”，然后单击“下一步”</li><li id="f6e4" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">选择Node.js 10作为运行时。</li><li id="5c65" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">选择源代码为“来自云存储的ZIP”。</li><li id="2bf7" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">对于“云存储位置”，输入“GS://Storage-traffic-project/access _ logs _ loader . zip”</li><li id="9c6d" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">可以<a class="ae jo" href="https://storage.googleapis.com/storage-traffic-project/access_logs_loader.zip" rel="noopener ugc nofollow" target="_blank">下载zip </a>文件查看云函数的源码。</li><li id="2bcf" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">对于“要执行的功能”，输入“processUsageUpdate”。</li><li id="9b4c" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn lg jv jw jx bi translated">单击“部署”部署该功能。</li></ol><h1 id="ddb6" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">A.3:了解单个用户的请求</h1><p id="617f" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">理解客户端请求的另一种方法是使用MaxMind IP to geolocation数据集来确定访问您的公共数据的国家。为此，请在此注册一个MaxMind账户<a class="ae jo" href="https://www.maxmind.com/en/geolite2/signup" rel="noopener ugc nofollow" target="_blank">。登录后，导航至左侧“GeoIP2 / GeoLite2”下的“下载文件”。单击“GeoLite2 City: CSV格式”的“下载ZIP”链接并提取ZIP文件。</a></p><p id="04ff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了获得请求您数据的用户的位置，请查找访问数据的IP地址的位置。您可以对我们刚刚下载的MaxMind GeoIP数据库使用BigQuery查询来做到这一点。有关更多详细信息，请使用BigQuery 查看<a class="ae jo" href="https://cloud.google.com/blog/products/data-analytics/geolocation-with-bigquery-de-identify-76-million-ip-addresses-in-20-seconds" rel="noopener ugc nofollow" target="_blank">地理定位。</a></p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="03e8" class="lq ke hi lm b fi lr ls l lt lu">bq load -source_format=CSV — autodetect storageanalysis.ipv6_city_locations GeoLite2-City-Locations-en.csv<br/>bq load -source_format=CSV — autodetect storageanalysis.ipv6_city_blocks GeoLite2-City-Blocks-IPv6.csv<br/>bq load -source_format=CSV — autodetect storageanalysis.city_locations</span></pre><p id="33da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我们希望将数据访问聚合到具有相同起始/目的位置的时间组中。我们最终的BigQuery查询如下所示:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="2554" class="lq ke hi lm b fi lr ls l lt lu">SELECT time_block*600 AS time, country, region, ingress, egress, requests FROM (<br/>SELECT<br/>country_name as country,<br/>CAST(FLOOR(time_micros/(1000000*600)) AS int64) AS time_block,<br/>SUM(cs_bytes) as ingress,<br/>SUM(sc_bytes) as egress,<br/>COUNT(cs_bucket) as requests,<br/>bucket_locations.location AS region<br/>FROM (<br/>SELECT *, NET.SAFE_IP_FROM_STRING(c_ip) &amp; NET.IP_NET_MASK(16, mask)<br/>network_bin<br/>FROM storageanalysis.usage, UNNEST(GENERATE_ARRAY(9,128)) mask<br/>WHERE BYTE_LENGTH(NET.SAFE_IP_FROM_STRING(c_ip)) = 16<br/>)<br/>JOIN (SELECT *<br/>, NET.IP_FROM_STRING(REGEXP_EXTRACT(network, r'(.*)/' )) network_bin<br/>, CAST(REGEXP_EXTRACT(network, r'/(.*)' ) AS INT64) mask<br/>FROM `storageanalysis.ipv6_city_blocks` AS city_blocks<br/>JOIN `storageanalysis.ipv6_city_locations` AS city_locations<br/>USING(geoname_id)<br/>)<br/>USING (network_bin, mask)<br/>LEFT OUTER JOIN<br/>storageanalysis.bucket_locations AS bucket_locations<br/>ON<br/>cs_bucket = bucket_locations.id<br/>GROUP BY country_name, time_block, region<br/>ORDER BY time_block ASC<br/>)</span></pre><p id="c9bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从这里，返回到<strong class="is hj">创建可视化表格</strong>并继续跟随。</p></div></div>    
</body>
</html>