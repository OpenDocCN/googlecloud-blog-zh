# 大查询模式设计

> 原文：<https://medium.com/google-cloud/bigquery-schema-design-45a96991a93c?source=collection_archive---------0----------------------->

设计一个模式需要我们考虑如何创建一个算法来访问数据。可能有几种不同的访问方法，例如:按行访问、按列访问等。一般来说，不同的方法会有不同的表现，我们应该注意到这种方法可能是不可并行的。

规范化数据意味着把它变成一个关系系统。它将有效地存储数据，并使查询处理成为一项清晰而直接的任务。这也将增加数据的有序性。这对节省空间很有用。规范化数据通常发生在为数据库设计模式时。反规范化是一种策略，它允许数据的表中某一列有重复的字段值，以获得处理性能。数据是重复的，而不是相关的。扁平化数据需要更多的存储，但是它使查询更有效，因为它们可以使用列处理并行处理。

反规范化数据使 BigQuery 能够高效地分布处理，从而提高查询性能。我们通常会在将数据加载到 BigQuery 之前将其反规范化。但是，在有些情况下，非规范化数据会降低性能，特别是当您必须按具有一对多关系的列进行分组时。无论如何我们要对数据进行分组，它必须被打乱。这通常是通过服务器或系统之间的网络传输数据来实现的。洗牌很慢，fortunatey BigQuery 支持包含嵌套和重复数据的列。因此，嵌套和重复字段对于处理来自关系数据库的数据非常有用。嵌套列可以理解为重复字段的一种形式。它保留了原始数据和模式的关系质量，同时支持重复嵌套字段的列和并行处理，并且是已经具有关系模式的数据的最佳替代方案。将关系转换为嵌套或重复的字段可以提高 BigQuery 的性能。它将帮助 BigQuery 处理关系数据库中数据源。

有四种不同的可排序数据类型:数组、结构、地理和 JSON。在这节课中，我们将重点讨论数组和结构。虽然数组值使我们能够灵活地深入到字段的粒度，但 STRUCT 通过将相关字段组合在一起，使我们能够在您的模式中走得更远。将大型报告表存储为结构和数组有以下好处:

*   通过加入获得显著的性能优势
*   从阵列中获取粒度数据
*   将所有业务上下文放在一个表中，而不是担心连接键和哪些表有数据

现在，另一种优化性能的方法是使用分区和集群。在按日期或时间戳列进行分区的表中，每个分区包含一天的数据。存储数据时，BigQuery 确保一个块中的所有数据都属于一个分区。分区的表在修改它的所有操作、查询作业、数据操作语言、DML 语句、数据定义语言、DDL 语句、加载作业和复制作业中维护这些属性。因此需要 BigQuery 维护比非分区表更多的元数据。随着分区数量的增加，元数据的开销也会增加。优化数据仓库中的表的一种方法是通过对表进行分区来减少成本和数据读取量。好的做法是要求查询总是包含分区过滤器，确保分区字段在左侧被隔离，因为这是 BigQuery 快速丢弃不必要分区的唯一方法。当查询或加载作业将数据写入聚集表时，BigQuery 使用聚集列中的值对数据进行排序。这些值用于将数据组织到存储中的多个块中。当我们提交包含基于集群列过滤数据的子句的查询时，BigQuery 使用已排序的块来消除对不必要数据的扫描。类似地，当提交基于值和聚类列聚合数据的查询时，性能会得到提高，因为排序后的块共同定位具有相似值的行。分区提供了一种获得精确的查询成本估计的方法，并保证了成本和性能的提高。除了分区优势之外，集群还提供了额外的成本和性能优势。

参考

*   谷歌。(未注明)。*使用数组| BigQuery | google cloud* 。谷歌。2022 年 8 月 19 日检索，来自[https://cloud . Google . com/big query/docs/reference/standard-SQL/arrays](https://cloud.google.com/bigquery/docs/reference/standard-sql/arrays)
*   谷歌。(未注明)。*在谷歌标准 SQL | BigQuery |谷歌云*中使用 JSON 数据。谷歌。检索于 2022 年 8 月 19 日，来自[https://cloud . Google . com/big query/docs/reference/standard-SQL/JSON-data](https://cloud.google.com/bigquery/docs/reference/standard-sql/json-data)