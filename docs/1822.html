<html>
<head>
<title>Dialogflow CX Response logging</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">对话流CX响应日志记录</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/dialogflow-cx-response-logging-e1b77d7a9fc6?source=collection_archive---------0-----------------------#2021-03-08">https://medium.com/google-cloud/dialogflow-cx-response-logging-e1b77d7a9fc6?source=collection_archive---------0-----------------------#2021-03-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d78f255a76bbc684fe0cc194c2a47690.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6X93Ox7UBC_ZJzIW"/></div></div></figure><p id="80ed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Dialogflow CX的一个特性是能够将其操作记录到GCP云日志中。这意味着当一个请求被提交给Dialogflow进行意图匹配时，一个日志记录被写入。当Dialogflow响应时，会生成第二个日志记录。日志记录的每个实例都是一个结构化的实体，包含一组通过JSON描述的丰富的字段。数据中包括各种各样的项目，包括:</p><ul class=""><li id="6e6c" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">日志写入的日期/时间。</li><li id="b9e3" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">用于将多个交互关联为同一对话的一部分的Dialogflow会话id。</li><li id="5910" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">话语输入。</li><li id="3612" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">匹配的意向反应。</li><li id="de5f" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">…许多附加字段。</li></ul><p id="5c09" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些数据对我们非常有用。一些可能的目的可能是:</p><ul class=""><li id="c3c6" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">将用户的交互记录为与用户相关联的交易历史的一部分。</li><li id="2408" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">调查客户询问的与意图不匹配的话语。</li><li id="d67b" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">确定附加/替代训练短语。</li><li id="90ab" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">路径流分析，了解客户在对话中采用的路径。</li><li id="c1d8" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">…许多其他使用案例。</li></ul><p id="74f0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">虽然将数据写入云日志是好事，但从分析的角度来看，这并不好。云日志对于诊断日志来说很棒，但是对于数据分析来说不是很有用。好消息是，写入云日志的日志数据可以导入BigQuery进行更丰富的分析。为此，我们定义了一个日志导出，并将BQ配置为目标。一旦完成，写入云日志的新Dialogflow记录也将作为新行写入BQ表中。从BQ表中，我们可以执行SQL查询来提取我们感兴趣的数据。</p><p id="bca2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们来看一下设置这样一个环境并查看数据的方法。</p><p id="f788" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从新项目开始…</p><p id="ceaf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">启用对话流API</p><p id="5461" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kc" href="https://console.cloud.google.com/apis/library" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/apis/library</a></p><figure class="ke kf kg kh fd ij er es paragraph-image"><div class="er es kd"><img src="../Images/de704394bfc22a30a9e0f7a9220ec0f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/0*ypaFbTFAKxrykDVL"/></div></figure><p id="914e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">访问CX对话流</p><p id="5b45" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">https://dialogflow.cloud.google.com/cx/projects<a class="ae kc" href="https://dialogflow.cloud.google.com/cx/projects" rel="noopener ugc nofollow" target="_blank"/></p><p id="225e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建代理</p><p id="0ae5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">启用stackdriver日志记录(遗憾的是这就是它的名字…因为这项技术现在是云日志记录):</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ki"><img src="../Images/b5d463bed1f0dfef422342e104402602.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YNSrzcoW-hsDQwz5"/></div></div></figure><p id="cd92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">深入代理。</p><p id="6759" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这里，我们可以在Dialogflow CX中构建我们的代理…但是，这不是我们练习的目的。我们在这里学习日志记录和处理日志输出。</p><p id="2d63" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以直接测试我们的框架代理，看看它是否有响应。在右上角，单击测试代理。</p><p id="6231" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在右下角显示“与代理交谈”的地方，输入“你好”。</p><p id="a2e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，会返回一个响应。此时，我们将工作传递给Dialogflow，它正在响应。</p><p id="a35b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这应该已经足够记录日志了。现在我们将去参观云日志。</p><p id="5522" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将Dialogflow的日志指定为消息过滤器。我们将看到我们交互的日志记录。</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/bf76a67497c4c48ec8644cfce466c923.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HLvXSuy2_4YuDe7T"/></div></div></figure><p id="99d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">展开这些日志记录并检查它们。你会发现它们包含了大量有用的信息。它们被捕获是件好事，但也不是那么有用，它们只是被写入日志。理想情况下，我们希望它们在BQ表中，这样我们就可以对它们进行查询。</p><p id="c433" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">设置好过滤器后，单击Actions菜单，然后创建sink:</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div class="er es kk"><img src="../Images/8df891d940883d6888b31ae84bcd8e38.png" data-original-src="https://miro.medium.com/v2/resize:fit:598/0*-SGo4E6RxGLTDLy7"/></div></figure><p id="9529" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我们将拥有一个云日志记录接收器。这将把日志记录写入表中。只会写入<em class="kj">新的</em>记录，不会写入历史记录。使用Dialogflow与代理交互，然后验证我们在云日志记录日志中看到新记录。</p><p id="d827" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们现在切换到BigQuery，我们会发现创建了一个新表。</p><p id="c302" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们会发现，该表包含的记录中，每条记录都与写入云日志记录的日志记录中的数据相匹配。</p><p id="cd9b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们运行一个简单的查询来查看所有记录，我们会发现我们可以从JSON的角度来查看它们以进行验证。现在记录在一个表中，我们可以对这些数据运行SQL来生成报告和执行计算。例如:</p><pre class="ke kf kg kh fd kl km kn ko aw kp bi"><span id="dddf" class="kq kr hi km b fi ks kt l ku kv">SELECT<br/> jsonPayload.queryResult.text AS input,<br/> jsonPayload.queryresult.responsemessages[OFFSET(0)].text.text AS output,<br/> labels.session_id<br/>FROM<br/> `df-cxtest.dfdemo.dialogflow_runtime_googleapis_com_requests_20210308`<br/>WHERE<br/> jsonPayload.queryresult IS NOT NULL<br/>LIMIT<br/> 1000</span></pre><p id="7eda" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将看到的是单独的请求/响应</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/8a2a5c4ec49b887a03c25f3226eeb7f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Rv1oaWBMR5YKfc2k"/></div></div></figure><p id="d737" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">作为最后一个练习，我们将使用Data Studio可视化数据。</p><p id="656b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建报告。</p><p id="f562" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">选择大查询。</p><p id="eb4e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">选择自定义查询，并选择我们正在使用的计费项目。SQL查询如上所示。</p><p id="fbed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在可以自定义表格来显示我们想要的内容:</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ba3e7178cbea59c55dfa1845c52b3d93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KIBATy5X7QhYXzeL"/></div></div></figure><p id="a662" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了进一步说明这个故事，有一个You Tube视频展示了如何将Dialogflow CX与云日志、BigQuery和Data Studio结合使用:</p><figure class="ke kf kg kh fd ij"><div class="bz dy l di"><div class="kx ky l"/></div></figure><h1 id="bc1c" class="kz kr hi bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">参考</h1></div></div>    
</body>
</html>