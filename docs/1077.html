<html>
<head>
<title>Automate Building Android APKs 📱 with Google Cloud Build CI/CD 🔧 and a Gradle Docker Image ☁️</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动构建Android APKs📱使用Google Cloud构建CI/CD🔧和一张☁️的照片</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/automate-building-android-apks-with-google-cloud-build-ci-cd-and-a-gradle-docker-image-%EF%B8%8F-44e48f76756f?source=collection_archive---------0-----------------------#2019-07-16">https://medium.com/google-cloud/automate-building-android-apks-with-google-cloud-build-ci-cd-and-a-gradle-docker-image-%EF%B8%8F-44e48f76756f?source=collection_archive---------0-----------------------#2019-07-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/114f9df5a2caec2013d4eae401162f22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8DKk0dsRr4So3S39L04Pnw.png"/></div></div></figure><p id="3671" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/cloud-build" rel="noopener ugc nofollow" target="_blank">谷歌云构建(GCB) </a>是一项在谷歌云平台基础设施上执行构建的服务。Cloud Build可以从Google Cloud Storage、Cloud Source Repositories、GitHub或Bitbucket导入源代码，按照您的规范执行构建，并生成工件。</p><p id="b819" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以编写一个构建配置来为云构建提供关于执行什么任务的指令，并且可以使用由<a class="ae jo" href="https://github.com/GoogleCloudPlatform/cloud-builders" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">云构建</strong> </a>、<a class="ae jo" href="https://github.com/GoogleCloudPlatform/cloud-builders-community" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">云构建社区</strong> </a>提供的构建步骤/构建器，或者编写您自己的<a class="ae jo" href="https://cloud.google.com/cloud-build/docs/create-custom-build-steps" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">自定义构建</strong> </a>步骤/构建器。</p><p id="075f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您还可以使用<em class="jp"> gcloud </em>命令行工具或云构建API在云构建中手动启动构建，或者使用云构建的触发功能来创建自动化的持续集成/持续交付(CI/CD)工作流，该工作流启动新的构建以响应您的代码存储库上的代码更改。</p><blockquote class="jq jr js"><p id="81b6" class="iq ir jp is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated">在本教程中，您将设置一个云构建触发器来构建您的android应用程序并将其上传到云存储桶。<br/>一旦代码被推送到您的代码库，新APK捆绑包的构建也将被自动触发。</p><p id="ff4a" class="iq ir jp is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated"><em class="hi">在撰写本文时，</em><a class="ae jo" href="https://github.com/GoogleCloudPlatform/cloud-builders" rel="noopener ugc nofollow" target="_blank"><em class="hi">GCB Builders</em></a><em class="hi">支持Gradle 4.6，因为它是最新的Gradle Cloud Builder，与Android项目不兼容。然而，我创建了一个更新的</em><a class="ae jo" href="https://fullstackgcp.com/gcr.io/fullstackgcp/gradle" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"><em class="hi">Gradle Docker映像</em> </strong> </a> <em class="hi">，我们将使用它来为我们的Android项目执行</em> <a class="ae jo" href="https://developer.android.com/studio/build/building-cmdline" rel="noopener ugc nofollow" target="_blank"> <em class="hi"> gradle构建</em> </a> <em class="hi">。</em></p></blockquote><figure class="jx jy jz ka fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jw"><img src="../Images/414fc5d7712f1b48776d8a997f31d618.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KC4PzUPLnUfrN4bp.png"/></div></div></figure><h1 id="927d" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">设置在谷歌云平台上</h1><ul class=""><li id="38dc" class="kz la hi is b it lb ix lc jb ld jf le jj lf jn lg lh li lj bi translated"><a class="ae jo" href="https://console.cloud.google.com/project" rel="noopener ugc nofollow" target="_blank">创建一个新的谷歌云平台(GCP)项目</a>，或者使用一个现有的项目。</li><li id="45ca" class="kz la hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><a class="ae jo" href="https://support.google.com/cloud/answer/6293499#enable-billing" rel="noopener ugc nofollow" target="_blank">为您的项目启用计费。</a>。</li><li id="1414" class="kz la hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><a class="ae jo" href="https://console.cloud.google.com/cloud-build/builds" rel="noopener ugc nofollow" target="_blank">启用云构建API </a></li></ul><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="er es lp"><img src="../Images/8379b5c2041d8bc6a70e05b315576309.png" data-original-src="https://miro.medium.com/v2/resize:fit:732/format:webp/0*O_I52qs_ntb_R4d9.png"/></div></figure><ul class=""><li id="a38a" class="kz la hi is b it iu ix iy jb lq jf lr jj ls jn lg lh li lj bi translated">在<a class="ae jo" href="https://console.cloud.google.com/storage/browser" rel="noopener ugc nofollow" target="_blank">上创建一个桶【谷歌云存储(GCS)】T3】</a></li></ul><p id="54df" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是您的项目apk将被存储的地方，您需要提供一个唯一的存储桶名称，我将使用<strong class="is hj"> fullstackgcp-apk-builds </strong>作为我的存储桶名称。</p><figure class="jx jy jz ka fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/85cb053d00a456fec9eb1b63ea5ea26a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*L2KcNzcAnFnG79Ro.png"/></div></div></figure><p id="42b4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">公开存储桶(可选)</p><p id="6c40" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想从你的bucket中公开访问你的apk(点击这里查看我的)，那么你可以设置Bucket级别的权限，允许互联网上的任何人访问你的Bucket文件。</p><p id="cc7f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，在您的Bucket的<em class="jp"> *Permissions </em>选项卡上单击<strong class="is hj"> Add Members </strong>并执行以下操作:</p><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="er es lu"><img src="../Images/b25be975735f0e8d01110f444d3ef0f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1118/format:webp/0*smS0MhiXGvxAhN4k.png"/></div></figure><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="er es lv"><img src="../Images/adb94be0310753b659a8c4cdf5f969e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/0*2fpFJiBvxdjYhhwL.png"/></div></figure><p id="3e90" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意:<strong class="is hj">您的存储桶是公开的，互联网上的任何人都可以访问</strong></p><ul class=""><li id="bd2c" class="kz la hi is b it iu ix iy jb lq jf lr jj ls jn lg lh li lj bi translated">授予对云存储的云构建访问权限(可选—如果您的存储区是公共的)</li></ul><p id="6a88" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云构建服务帐户的默认权限不允许该帐户管理云存储桶。要向云构建服务帐户授予云存储IAM角色，请执行以下步骤:</p><ol class=""><li id="f780" class="kz la hi is b it iu ix iy jb lq jf lr jj ls jn lw lh li lj bi translated"><a class="ae jo" href="https://console.cloud.google.com/project/_/iam-admin/iam?_ga=2.2968627.-2014380672.1551979429" rel="noopener ugc nofollow" target="_blank">在GCP控制台中打开IAM页面。</a></li><li id="91ab" class="kz la hi is b it lk ix ll jb lm jf ln jj lo jn lw lh li lj bi translated">选择您的项目并点击<strong class="is hj">继续</strong>。</li><li id="4a0f" class="kz la hi is b it lk ix ll jb lm jf ln jj lo jn lw lh li lj bi translated">在成员列表中查找您的名为<em class="jp">【项目编号】</em><a class="ae jo" href="https://fullstackgcp.com/@cloudbuild" rel="noopener ugc nofollow" target="_blank"><em class="jp">@ Cloud Build</em></a><a class="ae jo" href="https://hashnode.com/util/redirect?url=http://.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank"><em class="jp">【gserviceaccount . com</em></a>的云构建服务帐户，其中<em class="jp">【项目编号】</em>是您的GCP项目编号。</li><li id="d56a" class="kz la hi is b it lk ix ll jb lm jf ln jj lo jn lw lh li lj bi translated">单击该行中的铅笔图标。</li><li id="861a" class="kz la hi is b it lk ix ll jb lm jf ln jj lo jn lw lh li lj bi translated">点击<strong class="is hj">添加另一个角色</strong>，选择<strong class="is hj">存储</strong>下的<strong class="is hj">存储对象管理</strong>，点击保存。</li></ol><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="er es lx"><img src="../Images/3596515a0025c6a3d4dbc8e1a37968b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/0*zPvgWbZstW67T8-B.png"/></div></figure><h1 id="dddd" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">设置云构建</h1><h1 id="7dc2" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">应用程序源代码</h1><p id="d144" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ly jd je jf lz jh ji jj ma jl jm jn hb bi translated">您需要确保构建APK所需的应用程序代码和所有必要文件都可以在代码库中找到。Cloud Build目前支持云源代码库、GitHub或Bitbucket。</p><p id="a774" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本教程的演示源代码可以在GitHub上获得，你可以在这里获得它们<a class="ae jo" href="https://github.com/Timtech4u/gcb-android-tutorial" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="4912" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在您的存储库中，创建一个构建配置文件:<strong class="is hj"> cloudbuild.yaml </strong>，它包含云构建的指令。本教程的配置文件是:</p><pre class="jx jy jz ka fd mb mc md me aw mf bi"><span id="66cb" class="mg kc hi mc b fi mh mi l mj mk"># cloudbuild.yaml<br/>steps:<br/># Set a persistent volume according to https://cloud.google.com/cloud-build/docs/build-config (search for volumes)<br/>- name: 'ubuntu'<br/>  volumes:<br/>  - name: 'vol1'<br/>    path: '/persistent_volume'<br/>  args: ['cp', '-a', '.', '/persistent_volume']</span><span id="58a9" class="mg kc hi mc b fi ml mi l mj mk"># Build APK with Gradle Image from mounted /persistent_volume using name: vol1<br/>- name: 'gcr.io/cloud-builders/docker'<br/>  volumes:<br/>  - name: 'vol1'<br/>    path: '/persistent_volume'<br/>  args: ['run', '-v', 'vol1:/home/app', '--rm', 'gcr.io/fullstackgcp/gradle', '/bin/sh', '-c', 'cd /home/app &amp;&amp; ./gradlew clean assembleDebug']</span><span id="a8fe" class="mg kc hi mc b fi ml mi l mj mk"># Push the APK Output from vol1 to your GCS Bucket with Short Commit SHA.<br/>- name: 'gcr.io/cloud-builders/gsutil'<br/>  volumes:<br/>  - name: 'vol1'<br/>    path: '/persistent_volume'<br/>  args: ['cp', '/persistent_volume/app/build/outputs/apk/debug/app-debug.apk', 'gs://fullstackgcp-apk-builds/app-debug-$SHORT_SHA.apk']</span><span id="f95a" class="mg kc hi mc b fi ml mi l mj mk">timeout: 1200s</span></pre><p id="98cb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">简而言之，云构建帮助你运行下面的<em class="jp"> docker命令</em>:</p><p id="f4d4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du mm mn mo mc b">docker run -v $(pwd):/home/app --rm gcr.io/fullstackgcp/gradle /bin/bash -c 'cd /home/app &amp;&amp; ./gradlew clean assembleDebug'</code></p><p id="4aa9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在该命令中，我们指定:<strong class="is hj"> -v </strong>将当前目录挂载为卷，<strong class="is hj">-RM</strong>在退出时删除容器。</p><p id="88bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想使用其他Gradle命令，可以在您的<strong class="is hj"> cloudbuild.yaml </strong>文件上更改<strong class="is hj"> -c </strong>命令。</p><p id="44d2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云构建还将输出:<strong class="is hj"> app-debug.apk </strong>作为<strong class="is hj">app-debug-$ SHORT _ SHA . apk</strong>复制到您的GCS存储桶中，其中<em class="jp"> $SHORT_SHA </em>是触发云构建的提交的<em class="jp"> COMMIT_SHA </em>的前七个字符，这意味着在您的GCS存储桶上标记apk构建。</p><h1 id="efe0" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">云构建触发器</h1><p id="9848" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ly jd je jf lz jh ji jj ma jl jm jn hb bi translated">云构建触发器监听代码库中的更改，按照下面的步骤创建GCB触发器。</p><ul class=""><li id="d87b" class="kz la hi is b it iu ix iy jb lq jf lr jj ls jn lg lh li lj bi translated">访问<a class="ae jo" href="https://console.cloud.google.com/cloud-build/triggers" rel="noopener ugc nofollow" target="_blank">云构建触发器页面</a>并点击<strong class="is hj">创建触发器</strong></li></ul><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="er es mp"><img src="../Images/988db24927f1cfb1838b8b4500fba22c.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/format:webp/0*kk2s_elwHTVbcOvp.png"/></div></figure><ul class=""><li id="5618" class="kz la hi is b it iu ix iy jb lq jf lr jj ls jn lg lh li lj bi translated">选择代码库源</li></ul><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="er es mq"><img src="../Images/bcbf4a0e4a93a272479d7c6c2b8ed920.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/format:webp/0*IU0VxU_fwKqcDfYF.png"/></div></figure><ul class=""><li id="3e76" class="kz la hi is b it iu ix iy jb lq jf lr jj ls jn lg lh li lj bi translated">选择存储库(通过输入存储库名称来过滤您的搜索)</li></ul><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="er es mr"><img src="../Images/e14aea1997557b6e7a44fd8b96ec37f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/0*bUqPvk9YQWpHUCjy.png"/></div></figure><ul class=""><li id="6ef1" class="kz la hi is b it iu ix iy jb lq jf lr jj ls jn lg lh li lj bi translated">输入描述并设置<strong class="is hj">构建配置</strong> : <strong class="is hj"> cloudbuild.yaml </strong>(如果您想将触发限制在某些分支，您也可以设置一个<em class="jp">分支正则表达式</em>)</li></ul><figure class="jx jy jz ka fd ij er es paragraph-image"><div class="er es ms"><img src="../Images/0f6c1fdacf03a83219542c2b36f5d531.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/0*IseAxWqdajywfrvb.png"/></div></figure><figure class="jx jy jz ka fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mt"><img src="../Images/a221ddfb7e21f30f7f3c6151b296c7ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OYkTsYXXJAqzfIJORsVFGw.png"/></div></div></figure><h1 id="3036" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">云构建成本</h1><pre class="jx jy jz ka fd mb mc md me aw mf bi"><span id="0830" class="mg kc hi mc b fi mh mi l mj mk">+----------------------------------------------------------------------------------------+<br/>| | CPUs | Memory  | Price per build-minute                                            | |<br/>+----------------------------------------------------------------------------------------+<br/>| |------|---------|-------------------------------------------------------------------| |<br/>| | 1    | 3.75 GB | $0.0034 / build-minute. First 120 build minutes per day are free. | |<br/>| | 8    | 7.2 GB  | $0.016 / build-minute                                             | |<br/>| | 32   | 28.8 GB | $0.064 / build-minute                                             | |<br/>+----------------------------------------------------------------------------------------+</span></pre><p id="dacd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了避免不必要的费用，请清理为本教程创建的资源。</p><ol class=""><li id="65e0" class="kz la hi is b it iu ix iy jb lq jf lr jj ls jn lw lh li lj bi translated">删除使用的项目(如果您创建了新项目)。</li><li id="29af" class="kz la hi is b it lk ix ll jb lm jf ln jj lo jn lw lh li lj bi translated">删除云构建触发器和云存储桶。您还可以选择禁用云构建触发器。</li></ol><h1 id="ebd8" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">后续步骤</h1><p id="80d8" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ly jd je jf lz jh ji jj ma jl jm jn hb bi translated">如果您想了解有关云构建的更多信息，请查看以下资源:</p><ul class=""><li id="8e46" class="kz la hi is b it iu ix iy jb lq jf lr jj ls jn lg lh li lj bi translated"><a class="ae jo" href="https://cloud.google.com/cloud-build/docs/" rel="noopener ugc nofollow" target="_blank">云构建文档</a></li><li id="d137" class="kz la hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><a class="ae jo" href="https://github.com/GoogleCloudPlatform/cloud-builders" rel="noopener ugc nofollow" target="_blank">官方云构建器</a></li><li id="8961" class="kz la hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><a class="ae jo" href="https://github.com/GoogleCloudPlatform/cloud-builders-community" rel="noopener ugc nofollow" target="_blank">社区云建设者</a></li><li id="2682" class="kz la hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><a class="ae jo" href="https://github.com/GoogleCloudPlatform/awesome-google-cloud" rel="noopener ugc nofollow" target="_blank">谷歌云平台牛逼榜</a></li></ul><p id="d014" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">感谢通读！如果我错过了任何步骤，如果有些事情不太适合你，或者如果这个指南有帮助，请告诉我。</em></p></div></div>    
</body>
</html>