<html>
<head>
<title>Google Cloud Spanner with Active Record</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带活动记录的谷歌云扳手</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-spanner-with-active-record-7c7f2c049a02?source=collection_archive---------2-----------------------#2021-09-17">https://medium.com/google-cloud/google-cloud-spanner-with-active-record-7c7f2c049a02?source=collection_archive---------2-----------------------#2021-09-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a2a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/spanner" rel="noopener ugc nofollow" target="_blank"> Google Cloud Spanner </a>是一个全面管理、可扩展的关系数据库服务，用于区域和全球应用数据。它是第一个可扩展的、企业级的、全球分布的、高度一致的数据库服务，专为云构建，将关系数据库结构的优势与非关系水平扩展相结合。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/d8eb38f630f7dcea92344bcff4514caf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*EiilAcpGm_vLsMBU.png"/></div></figure><p id="c43f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://guides.rubyonrails.org/active_record_basics.html" rel="noopener ugc nofollow" target="_blank">活动记录</a>是Ruby的ORM实现。活动记录现在可以作为Google Cloud Spanner的对象关系映射器(O/RM ),使用它的<a class="ae jd" href="https://github.com/googleapis/ruby-spanner-activerecord" rel="noopener ugc nofollow" target="_blank">开源提供者</a>。本文将通过创建一个简单的Ruby应用程序来帮助您开始使用活动记录。</p><p id="be0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完整的示例应用程序可以在这里找到:<a class="ae jd" href="https://github.com/olavloite/spanner-activerecord-example" rel="noopener ugc nofollow" target="_blank">https://github.com/olavloite/spanner-activerecord-example</a></p><h1 id="dffc" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">配置扳手适配器和数据库</h1><p id="8a44" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">首先，通过将以下内容添加到您的gem文件 : <code class="du kp kq kr ks b">gem 'activerecord-spanner-adapter'</code>中，将Spanner活动记录适配器添加到您的项目中</p><p id="10f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们需要配置一个数据库，以便与Spanner活动记录适配器一起使用。我们在一个<code class="du kp kq kr ks b">database.yml</code>文件中这样做:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kt ku l"/></div><figcaption class="kv kw et er es kx ky bd b be z dx translated">扳手活动记录的数据库配置示例</figcaption></figure><p id="f1ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">示例配置文件将连接到本地主机上的Spanner模拟器。删除配置文件中的<code class="du kp kq kr ks b">emulator_host</code>条目，以连接到一个真实的扳手实例。</p><h1 id="0231" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">创建数据库和表</h1><p id="d473" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">通过在<code class="du kp kq kr ks b">db</code>文件夹中为您的项目创建一个初始迁移，可以很容易地在您的数据库中创建表。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kt ku l"/></div><figcaption class="kv kw et er es kx ky bd b be z dx translated">01_create_tables.rb</figcaption></figure><p id="9f32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">示例迁移文件将创建两个表；<code class="du kp kq kr ks b">singers</code>和<code class="du kp kq kr ks b">albums</code>。请注意:</p><ol class=""><li id="587c" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc le lf lg lh bi translated">表格在<code class="du kp kq kr ks b">ddl_batch</code>块中定义。DDL批处理大大减少了多个DDL语句的执行时间，强烈建议对包含多个DDL语句的所有迁移使用DDL批处理。</li><li id="c707" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated"><code class="du kp kq kr ks b">albums</code>表使用外键约束引用<code class="du kp kq kr ks b">singers</code>表。</li><li id="41e5" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated"><code class="du kp kq kr ks b">singers</code>表为歌手的全名定义了一个生成的列。该列的值总是经过计算的，不可能将其他值写入该列。</li><li id="190c" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">两个表都定义了一个<code class="du kp kq kr ks b">last_updated</code>列。这些列可以用最后更新记录的事务的提交时间戳来更新。</li></ol><h1 id="45ca" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">用测试数据填充数据库</h1><p id="7a55" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">您可以为数据库的初始(测试)数据使用一个<code class="du kp kq kr ks b">seeds.rb</code>文件。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kt ku l"/></div></figure><p id="9de8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以使用<code class="du kp kq kr ks b">rake db:seed</code>命令播种您的数据库。在示例应用程序中，这是由Rakefile自动完成的。</p><p id="aa8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意种子文件中的<code class="du kp kq kr ks b">last_updated: :commit_timestamp</code>哈希值。将标记有<code class="du kp kq kr ks b">allow_commit_timestamp</code>的字段设置为符号<code class="du kp kq kr ks b">:commit_timestamp</code>将指示Spanner活动记录适配器将数据库中记录的值设置为插入或更新记录的事务的提交时间戳。</p><h1 id="5dd2" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">运行应用程序</h1><p id="8730" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">您可以通过在项目的根目录下执行以下命令来运行示例应用程序:</p><p id="a76b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kp kq kr ks b">bundle exec rake run</code></p><p id="4d9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将调用以下脚本:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kt ku l"/></div><figcaption class="kv kw et er es kx ky bd b be z dx translated">用于运行扳手活动记录示例应用程序的Rakefile</figcaption></figure><p id="a556" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该脚本中的步骤是:</p><ol class=""><li id="7e8c" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc le lf lg lh bi translated">下载并启动Docker容器中的<a class="ae jd" href="https://cloud.google.com/spanner/docs/emulator" rel="noopener ugc nofollow" target="_blank">扳手模拟器</a></li><li id="2c15" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">在模拟器上创建一个测试实例和测试数据库。</li><li id="81a7" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">执行我们为示例应用程序定义的迁移。</li><li id="e8ff" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">对数据库执行db:seed命令。这将在seeds.rb文件中插入测试数据。</li><li id="b23d" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">运行示例应用程序。</li></ol><p id="5e8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">示例应用程序将执行几个查询，并使用ActiveRecord更新一些数据。完整文件请看一下<a class="ae jd" href="https://github.com/olavloite/spanner-activerecord-example/blob/main/application.rb" rel="noopener ugc nofollow" target="_blank">https://github . com/olavloite/spanner-active record-example/blob/main/application . Rb</a>文件。</p></div></div>    
</body>
</html>