<html>
<head>
<title>Firebase: The Server-side Story</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Firebase:服务器端的故事</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/firebase-the-server-side-story-1f89064e9c16?source=collection_archive---------0-----------------------#2017-11-27">https://medium.com/google-cloud/firebase-the-server-side-story-1f89064e9c16?source=collection_archive---------0-----------------------#2017-11-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/dbc43ee640f5b06c4937b1ac861b62ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d_hx4BxGZ9qYODhnTn-Bjg.jpeg"/></div></div></figure><div class=""/><p id="bcde" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如大多数开发者所知，许多网络和移动应用并不存在于真空中。相反，它们是一个更大的软件生态系统的一部分，包括其他应用程序、后端服务、数据库、API甚至遗留系统。因此，一个应用程序的成功往往取决于它与各种其他软件无缝集成的能力。对于一个Firebase应用程序开发者来说，这意味着能够用Firebase集成多个异构系统，并在需要时在它们之间共享数据。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><p id="0b1a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://firebase.google.com/docs/admin/setup" rel="noopener ugc nofollow" target="_blank">Firebase Admin SDK</a>正是考虑到这一关键需求而设计的。简而言之，管理SDK有助于从<em class="jw">可信环境</em>访问Firebase服务。这里的术语可信环境表示Firebase应用程序的开发人员和管理员所信任的任何编程或运行时环境。因此，Admin SDKs通常使用属于Firebase项目本身的凭证进行初始化。此外，管理SDK从不部署在最终用户设备上，从应用程序开发人员的角度来看，这是不可信的。</p><h2 id="eee5" class="jx jy ht bd jz ka kb kc kd ke kf kg kh jb ki kj kk jf kl km kn jj ko kp kq kr bi translated">谁是利益相关者？</h2><p id="eeec" class="pw-post-body-paragraph iq ir ht is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">在我们进一步讨论之前，我们需要清楚地确定与Firebase应用程序相关的两类用户。</p><ul class=""><li id="f256" class="kx ky ht is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated"><strong class="is hu"> App开发者</strong> — <strong class="is hu"> </strong>是指实施、发布和维护一个Firebase app的人。这是一个由程序员、系统管理员和各种其他DevOps人员组成的小型但多样化的团队。</li><li id="a7e7" class="kx ky ht is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated"><strong class="is hu">最终用户</strong> —指通过移动设备和/或网络浏览器下载、安装和使用Firebase应用程序的人。一个病毒式传播的应用程序可能拥有数百万的最终用户。</li></ul><p id="3318" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jw">应用开发者</em>使用Firebase客户端SDK构建应用。Firebase为iOS、Android和Web (JS)平台提供客户端SDK。一旦这样的应用程序发布，<em class="jw">最终用户</em>通过他们的移动设备和网络浏览器消费它。必要时，他们使用自己的凭据(如用户名+密码、谷歌账户、脸书账户)登录应用程序。</p><p id="965e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另一方面，使用Firebase Admin SDKs构建的软件由<em class="jw">应用开发者</em>自己部署和运行。他们决定这些软件的用途，以及如何向最终用户公开这些软件。基于管理SDK的软件通常补充Firebase应用程序，提供一些后端功能或支持与其他系统的集成。</p><h2 id="a92e" class="jx jy ht bd jz ka kb kc kd ke kf kg kh jb ki kj kk jf kl km kn jj ko kp kq kr bi translated">您可以在哪里部署管理SDK？</h2><p id="c30c" class="pw-post-body-paragraph iq ir ht is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">Firebase Admin SDKs可以部署在应用程序开发人员可以控制的任何环境中。典型的例子包括:</p><ol class=""><li id="eaba" class="kx ky ht is b it iu ix iy jb kz jf la jj lb jn ll ld le lf bi translated">由应用程序开发人员运行和管理的应用服务器，可能位于他们自己的数据中心。</li><li id="2284" class="kx ky ht is b it lg ix lh jb li jf lj jj lk jn ll ld le lf bi translated">开发者正在使用的云平台环境(例如由开发者启动的<a class="ae jo" href="https://cloud.google.com/appengine/" rel="noopener ugc nofollow" target="_blank">谷歌应用引擎</a>或<a class="ae jo" href="https://cloud.google.com/compute/" rel="noopener ugc nofollow" target="_blank">计算引擎</a>实例)。</li><li id="6741" class="kx ky ht is b it lg ix lh jb li jf lj jj lk jn ll ld le lf bi translated">开发者用来编程的无服务器框架(例如<a class="ae jo" href="https://cloud.google.com/functions/" rel="noopener ugc nofollow" target="_blank">谷歌云功能</a>)。</li></ol><p id="7ffb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，在上述所有情况下，应用程序开发人员控制环境，以及软件在每个环境中的部署方式。例如，应用程序开发人员可以随时自由更改、重新部署或终止他们的软件。应用程序开发人员还决定在这样的环境中部署时如何保护他们的代码和相关的交互。因此，他们可以<em class="jw">信任</em>环境不会被最终用户破坏。这就是这些环境适合Admin SDK的原因。</p><p id="41e4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">相比之下，最终用户移动设备和web浏览器不在Firebase应用程序开发人员的控制之下，因此不应该考虑进行Admin SDK部署。在极端情况下，最终用户甚至可能修改在这些环境中运行的代码，因此应用程序开发人员无法依赖代码始终在可接受的参数内运行。然而，最终用户设备和应用与Admin SDK代码进行远程交互是完全正常的，也是意料之中的。Admin SDKs提供了一种安全地<a class="ae jo" href="https://firebase.google.com/docs/auth/admin/verify-id-tokens" rel="noopener ugc nofollow" target="_blank">授权</a>此类远程客户端交互的方法。毕竟，集成不同的系统是管理SDK的目的。</p><p id="e1c6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jw">我打算在不久的将来与一位同事合作撰写一篇关于这个主题的更详细的文章。因此，我现在将避免进入一个详细的讨论，并恳请你保持关注。</em></p><h2 id="d35c" class="jx jy ht bd jz ka kb kc kd ke kf kg kh jb ki kj kk jf kl km kn jj ko kp kq kr bi translated">你能用管理SDK做什么？</h2><p id="547c" class="pw-post-body-paragraph iq ir ht is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">管理SDK放宽了Firebase客户端SDK中存在的一些安全措施，同时提供了对实现开发人员和管理员用例有用的API。一些流行的管理SDK用例有:</p><ul class=""><li id="9847" class="kx ky ht is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">为Firebase应用程序开发管理仪表板。</li><li id="c153" class="kx ky ht is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">为Firebase应用程序构建关键的后端服务。</li><li id="055e" class="kx ky ht is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">设置用户帐户、管理用户角色和设置权限。</li><li id="63a8" class="kx ky ht is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">与第三方用户认证系统集成。</li><li id="0afc" class="kx ky ht is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">向应用程序的用户发送通知。</li><li id="eb20" class="kx ky ht is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">归档或汇总由应用程序管理的数据。</li><li id="9ceb" class="kx ky ht is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">跨系统迁移数据。</li></ul><p id="f1eb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">诸如此类的用例可以以许多不同的形式实现，包括web应用、批处理作业、无服务器事件处理程序和命令行工具。因此，Firebase Admin SDKs经常被用来开发各种各样的软件。此外，在撰写本文时，Firebase Admin SDKs有四种编程语言版本——node . js、Java、Python和Go。这使得Firebase能够集成各种系统。</p><h2 id="0ea3" class="jx jy ht bd jz ka kb kc kd ke kf kg kh jb ki kj kk jf kl km kn jj ko kp kq kr bi translated">正在初始化Firebase管理SDK</h2><p id="1c07" class="pw-post-body-paragraph iq ir ht is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">Firebase Admin SDKs通常使用两种类型的凭证之一进行初始化。</p><ul class=""><li id="b984" class="kx ky ht is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated"><a class="ae jo" href="https://developers.google.com/identity/protocols/OAuth2ServiceAccount" rel="noopener ugc nofollow" target="_blank"> <strong class="is hu">服务账户凭证</strong> </a> —可用于授权服务器间交互的凭证。每个服务账户凭证属于一个特定的<a class="ae jo" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a> (GCP)项目，只有项目的开发者和管理员才能获得。因为Firebase项目只是伪装的GCP项目，所以服务帐户凭证也可以用于授权Admin SDK进行的Firebase交互。Firebase项目的服务帐户凭证可以作为JSON文件从<a class="ae jo" href="https://console.firebase.google.com" rel="noopener ugc nofollow" target="_blank"> Firebase控制台</a>或GCP控制台下载。</li></ul><figure class="lm ln lo lp fd hk"><div class="bz dy l di"><div class="lq lr l"/></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">清单1:用服务帐户凭证初始化(Java)</figcaption></figure><ul class=""><li id="57be" class="kx ky ht is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated"><strong class="is hu"> Google </strong> <a class="ae jo" href="https://developers.google.com/identity/protocols/application-default-credentials" rel="noopener ugc nofollow" target="_blank"> <strong class="is hu">应用默认凭证</strong> </a> <strong class="is hu"> (ADC) </strong> —一种凭证，可随时用于部署在托管环境中的代码，如Google App Engine、Google Compute Engine和Google Cloud函数。有了ADC，应用程序开发人员不必在代码中显式打包任何凭据。相反，它们只是在代码中指示应用程序应该使用ADC，应用程序将通过检查其运行时环境来<em class="jw">发现</em>适当的凭证。在幕后，ADC通常只是GCP为运行时环境隐式提供的服务帐户凭证。</li></ul><figure class="lm ln lo lp fd hk"><div class="bz dy l di"><div class="lq lr l"/></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">清单2:用Google应用程序默认凭证初始化(Java)</figcaption></figure><p id="a884" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Admin SDKs还支持第三种类型的凭证，这允许使用OAuth2刷新令牌初始化SDK。虽然前两种类型的凭证属于Firebase项目，但刷新令牌凭证通常属于个人开发人员。但是这在实践中很少使用，除了在本地测试应用程序。</p><p id="d16e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您的代码部署在Google管理的环境中，强烈建议您使用应用程序默认凭证初始化Admin SDK。对于所有其他环境(本地虚拟机、AWS、Azure和其他)，使用服务帐户凭据。但是，在少数情况下，即使部署到GCP，也必须使用服务帐户凭据。这通常是在使用Admin SDK对一些数据进行加密签名的时候。典型的例子包括:</p><ul class=""><li id="8f9b" class="kx ky ht is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated"><a class="ae jo" href="https://firebase.google.com/docs/auth/admin/create-custom-tokens" rel="noopener ugc nofollow" target="_blank">创建自定义JWT令牌</a></li><li id="e019" class="kx ky ht is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated"><a class="ae jo" href="https://cloud.google.com/storage/docs/access-control/create-signed-urls-program" rel="noopener ugc nofollow" target="_blank">为谷歌云存储对象创建签名的URL</a></li></ul><p id="dddd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些用例需要一个私钥来签署数据。目前，Admin SDK只能从明确指定的服务帐户凭据中获取私钥。这在某种程度上是Admin SDK的一个限制，可能会在未来的版本中得到解决。</p><p id="0f61" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另一个相关的注意事项是，请记住，服务帐户凭证不应该与不是Firebase项目开发人员或管理员的人共享。服务帐户允许访问与Firebase项目相关的许多资源。如果落入坏人之手，它们会导致严重的问题，从轻微的资源滥用到全面的DoS攻击。小心处理这些JSON文件，永远不要将它们签入公共版本控制。缺少显式凭证文件(可能会意外泄露)是ADC相对于服务帐户的一个主要优势。</p><h2 id="dc07" class="jx jy ht bd jz ka kb kc kd ke kf kg kh jb ki kj kk jf kl km kn jj ko kp kq kr bi translated">它的“管理”是什么？</h2><p id="82f7" class="pw-post-body-paragraph iq ir ht is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">Firebase Admin SDKs提供对Firebase服务和相关项目资源的不受监管的管理访问。把它想象成在<a class="ae jo" href="https://en.wikipedia.org/wiki/Superuser" rel="noopener ugc nofollow" target="_blank">超级用户</a>模式下操作。因此，它可以在Firebase项目中执行某些特权操作，例如删除用户帐户或重置用户密码。另一方面，Firebase客户端SDK在最终用户的环境中运行，因此只能访问给定最终用户有权访问的服务和资源。</p><p id="e4c7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这种区别在访问<a class="ae jo" href="https://firebase.google.com/docs/database/" rel="noopener ugc nofollow" target="_blank"> Firebase实时数据库(RTDB) </a>服务时最为明显。RTDB支持指定<a class="ae jo" href="https://firebase.google.com/docs/database/security/" rel="noopener ugc nofollow" target="_blank">安全规则</a>，管理哪些用户被允许访问数据库的特定部分。以下面的规则配置为例:</p><figure class="lm ln lo lp fd hk"><div class="bz dy l di"><div class="lq lr l"/></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">清单3:基于UID的访问控制的Firebase安全规则</figcaption></figure><p id="105d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该规则将对数据库节点<code class="du lw lx ly lz b">users/&lt;uid&gt;</code>的写访问权授予具有匹配用户id的认证用户。例如，用户<code class="du lw lx ly lz b">alice</code>被授权写给<code class="du lw lx ly lz b">users/alice</code>，但是<code class="du lw lx ly lz b">users/bob</code>对她是禁止的。一旦投入运行，RTDB将根据此规则评估来自Firebase客户端SDK的所有写请求，并相应地批准或拒绝它们。但是，使用Admin SDK编写的应用程序可以不受限制地访问整个数据库。由于Admin SDK以更高的权限运行，并且它不是作为任何个人最终用户执行，因此安全规则不适用于Admin SDK。这是为什么Admin SDK不应该部署在不受信任的环境中的主要原因之一。</p><p id="fa19" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，在某些情况下，这种不可知论者的行为是不可取的，甚至是完全危险的。在许多用例中，我们希望Admin SDK按照我们制定的规则运行。例如，想象这样一种情况，您依赖规则来维护保存数据的完整性。在这种情况下，给Admin SDK留下意外修改或删除数据库一部分的空间可能是灾难性的。幸运的是，我们可以很容易地将Firebase Admin SDK配置为<a class="ae jo" href="https://firebase.google.com/docs/database/admin/start#authenticate-with-limited-privileges" rel="noopener ugc nofollow" target="_blank">以有限的权限</a>操作，因此遵守了RTDB安全规则。这是通过在初始化Admin SDK时指定<code class="du lw lx ly lz b">databaseAuthVariableOverride</code>选项来完成的。</p><figure class="lm ln lo lp fd hk"><div class="bz dy l di"><div class="lq lr l"/></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">清单4:用有限特权初始化管理SDK(Java)</figcaption></figure><p id="5cee" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在上面的例子中，Admin SDK进行的任何RTDB调用都将被视为由名为<code class="du lw lx ly lz b">my-service-worker</code>的经过身份验证的最终用户进行的，并且规则将照常执行。</p><h2 id="194e" class="jx jy ht bd jz ka kb kc kd ke kf kg kh jb ki kj kk jf kl km kn jj ko kp kq kr bi translated">后续步骤…</h2><p id="681b" class="pw-post-body-paragraph iq ir ht is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">希望这有助于更清楚地描述Firebase Admin SDKs提供了什么，以及它们适合什么样的用例。更重要的是，我希望它能帮助您理解移动和web应用程序的服务器端集成的重要性，以及Firebase平台是如何促进这一点的。接下来我将推荐的是尝试用Firebase Admin SDKs实际构建一些东西。你可以从官方的<a class="ae jo" href="https://firebase.google.com/docs/admin/setup" rel="noopener ugc nofollow" target="_blank">安装指南</a>开始，挑选你喜欢的编程语言，然后继续尝试。还要注意，Firebase Admin SDKs是<a class="ae jo" href="https://opensource.google.com/projects/firebase-sdk" rel="noopener ugc nofollow" target="_blank">开源的</a>。因此，请随时报告您遇到的任何问题，记录新功能请求，并随时提供建议和请求。</p></div></div>    
</body>
</html>