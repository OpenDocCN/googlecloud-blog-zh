<html>
<head>
<title>GKE private cluster with a bastion host</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有堡垒主机的GKE专用集群</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gke-private-cluster-with-a-bastion-host-5480b44793a7?source=collection_archive---------0-----------------------#2021-01-06">https://medium.com/google-cloud/gke-private-cluster-with-a-bastion-host-5480b44793a7?source=collection_archive---------0-----------------------#2021-01-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/163812d817e6967188afbb802b0e884b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-yXfoGjebJS0RIwUNzJ6Ig.png"/></div></div></figure><div class=""/><p id="dede" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">许多GKE集群暴露在互联网的管理访问之下。对控制平面的公共访问使集群暴露于各种潜在的攻击和零日漏洞。依靠分层安全性是行业最佳实践，攻击者在获得访问权限之前必须绕过多个级别的控制。</p><p id="6a1e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本文中，您将了解到:</p><ul class=""><li id="02f6" class="jo jp ht is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">公共集群如何暴露给攻击者</li><li id="77b6" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">设置带有附加访问控制的专用集群</li><li id="2ee6" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">为安全访问创建一个带有身份识别代理(IAP)的堡垒主机</li></ul><p id="3224" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谷歌Kubernetes引擎(GKE)在设置期间提供三种操作模式供选择:</p><ul class=""><li id="df37" class="jo jp ht is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">禁用公共端点访问-不能通过互联网直接访问GKE管理API</li><li id="511c" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">通过授权网络启用公共端点访问—可通过互联网访问管理API，但要求请求来自一组特定的IP地址</li><li id="0e64" class="jo jp ht is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">启用公共端点访问—这是最不安全的选项，允许直接访问仅依赖Kubernetes身份验证功能的管理API</li></ul><p id="89e0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">像洋葱模型一样围绕资产构建安全性允许在多个级别上实施安全性规则。从物理访问，通过网络，一直到应用程序级别的身份验证。在堆栈的多个级别上建立控制可以显著降低攻击者发现漏洞从而暴露核心资产的风险。</p><figure class="kd ke kf kg fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kc"><img src="../Images/1420542d2fcc4622818a074ed87edd3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lEBL2sbcznUDza7opM-iTw.png"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx translated">洋葱安全模型</figcaption></figure><p id="1c61" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将GKE集群设为私有会为您的工作负载增加一层安全性，攻击者必须在Kubernetes身份验证的基础上额外绕过网络安全规则。</p><h2 id="7e69" class="kl km ht bd kn ko kp kq kr ks kt ku kv jb kw kx ky jf kz la lb jj lc ld le lf bi translated">Kubernetes \w公共端点访问已启用</h2><figure class="kd ke kf kg fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lg"><img src="../Images/f9a0c9e9e92a6b8a1a5137e6cdaebef1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b7bEiLfF8_TpHMszV8KGHQ.jpeg"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx translated">启用公共端点访问的Kubernetes集群管理</figcaption></figure><p id="46ff" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Kubernetes集群具有对管理API的公共访问权限，通常由管理员直接从互联网访问，在互联网上，Kubernetes的内置身份验证用于验证管理员的身份及其访问权限。</p><p id="9fb4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Kubernetes身份验证是针对攻击者的唯一保护级别。这使得群集容易受到零日攻击，新发现的漏洞可以被利用，而没有可用的修补程序。添加多层安全要求攻击者在获得对核心资产的访问权之前找到多个零日/未打补丁的漏洞。</p><h1 id="92e1" class="lh km ht bd kn li lj lk kr ll lm ln kv lo lp lq ky lr ls lt lb lu lv lw le lx bi translated">正在设置专用GKE集群</h1><figure class="kd ke kf kg fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ly"><img src="../Images/0ac188e6aa4e8387cf5bb9982003a9ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ODZ4ybVDiLz-e7uluGHinw.png"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx translated">禁用公共端点访问的Kubernetes集群管理</figcaption></figure><p id="bdbf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，我们将创建一个不允许公共访问的新GKE集群。一旦集群启动并运行，我们将需要一种访问它的方法，因为公共访问不再是一个选项，我们将在Kubernetes管理API之间建立一个堡垒主机，并允许访问来管理集群。我们将使用GCP IAM作为身份识别代理来建立到堡垒主机的安全连接。</p><figure class="kd ke kf kg fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lz"><img src="../Images/55caeef7caea2daeeaea65a8633810dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_sFZeALeXNHc1JooYo4qBg.png"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx translated">为私人GKE设置网络</figcaption></figure><p id="5249" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们从在控制台中创建一个私有集群开始。在网络设置中，我们选择一个专用集群。禁用使用外部IP的访问，我们必须指定主IP范围，该范围将用于为Kubernetes主节点分配IP地址。该范围不得与VPC中的任何其他IP地址重叠，并且必须具有/28的CIDR大小。在这种情况下，我们将使用CIDR 172.16.0.0/28。</p><p id="ec9a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦GKE集群启动并运行，我们将需要一种管理集群的方法。为此，我们在授权访问管理API的集群内部网络上部署堡垒主机。</p><p id="b4bf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将从创建一个小型计算引擎实例开始，例如“e2-micro”就足够了。该实例必须运行在与上一步中创建的Kubernetes集群相同的网络上。在这种情况下，它是默认网络和默认子网。实例运行后，让我们通过ssh进入实例(我们可以使用GCP控制台)并通过运行“sudo apt-get install tinyproxy”安装Tinyproxy。完成后，我们在/etc/tinyproxy/tinyproxy.conf中更改tinyproxy的配置，并将“Allow localhost”附加到文件末尾并保存文件。文件保存后，我们将通过执行“sudo service tinyproxy restart”来重新加载Tinyproxy</p><figure class="kd ke kf kg fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ma"><img src="../Images/bf7539273727812437aad6ab496b197e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*OZl_XqZvEmttm5F8FdYIQg.gif"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx translated">在计算引擎上安装微型代理</figcaption></figure><p id="081e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后一步是使用kubectl等常用工具从您的计算机连接到您的Kubernetes集群。此步骤在您的计算机上完成，我们首先使用以下命令下载GKE集群的凭据:</p><figure class="kd ke kf kg fd hk"><div class="bz dy l di"><div class="mb mc l"/></div><figcaption class="kh ki et er es kj kk bd b be z dx translated">设置Kubernetes身份验证配置</figcaption></figure><p id="5dfa" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将设置本地Kubernetes配置，包括可由kubectl和类似工具用来访问集群的集群凭证。最后，我们使用以下代码创建一个堡垒的身份感知代理:</p><figure class="kd ke kf kg fd hk"><div class="bz dy l di"><div class="mb mc l"/></div><figcaption class="kh ki et er es kj kk bd b be z dx translated">创建堡垒实例的HTTPS代理</figcaption></figure><p id="f14f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这为我们之前创建的堡垒创建了一个代理。堡垒的作用是将发送给它的请求转发到请求目的地，在我们的例子中是Kubernetes管理API。该命令将代理作为后台进程运行，当我们希望与群集通信时，它必须运行。</p><p id="85dc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后一步是使用kubectl的HTTPS代理环境变量来指定代理。这个变量可以用于代理对集群的请求，也可以使用其他工具，如Jenkins X的jx-cli或Octant。但是它的支持取决于应用程序。</p><figure class="kd ke kf kg fd hk"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="eecc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们有了一个具有分层安全性的群集，该群集完全运行，并有一种访问它的方法。此外，我们不应该忘记补丁管理，集群和堡垒设置应该自动化，并使用Terraform等工具定期更新。</p><p id="ebce" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">敬请关注改进集群的帖子！</p></div></div>    
</body>
</html>