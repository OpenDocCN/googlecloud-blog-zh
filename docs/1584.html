<html>
<head>
<title>GCP CIS Benchmark Terraform Module Testing with Chef Inspec, Kitchen-Terraform &amp; GitHub Actions — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP CIS基准Terraform模块测试与Chef Inspec、Kitchen-terra form &amp; GitHub Actions—第2部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-cis-benchmark-terraform-module-testing-with-chef-inspec-kitchen-terraform-github-actions-1540dd7afb36?source=collection_archive---------1-----------------------#2020-09-05">https://medium.com/google-cloud/gcp-cis-benchmark-terraform-module-testing-with-chef-inspec-kitchen-terraform-github-actions-1540dd7afb36?source=collection_archive---------1-----------------------#2020-09-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/474f08cda7b3c6bac62c71da61ec207e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hew1TsC0yW25JW85.png"/></div></div></figure><p id="421b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在上一篇<a class="ae jo" href="https://dev.to/brettcurtis/gcp-cis-benchmark-terraform-module-testing-with-chef-inspec-kitchen-terraform-github-actions-4gpl" rel="noopener ugc nofollow" target="_blank">文章</a>中，我们讨论了“本地”开发。本着<a class="ae jo" href="https://martinfowler.com/articles/continuousIntegration.html" rel="noopener ugc nofollow" target="_blank">持续整合</a>的精神，我们希望能够让团队成员整合他们的工作。如果您还记得，我们在运行<a class="ae jo" href="https://github.com/GoogleCloudPlatform/inspec-gcp-cis-benchmark" rel="noopener ugc nofollow" target="_blank"> inspec-gcp-cis-benchmark </a>概要文件时遇到的违规，我们有一些工作要做！我们将使用<a class="ae jo" href="https://github.com/newcontext-oss/kitchen-terraform" rel="noopener ugc nofollow" target="_blank"> Kitchen-Terraform </a>来完成这项工作，并在<a class="ae jo" href="https://github.com/learn/devops" rel="noopener ugc nofollow" target="_blank"> GitHub Actions </a>中运行工作流。在这篇文章中，我们将讨论厨房平台。</p><h1 id="1640" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">项目设置</h1><p id="86b8" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">使用厨房平台时，目录结构是必不可少的。我目前的结构是这样的:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div class="er es ks"><img src="../Images/5b7e7bafe66443f5c96e39f3736a8ce9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/0*vPp3s3bjC3t8ZGWl.png"/></div></figure><h1 id="5a7a" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">固定装置</h1><p id="0572" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">你需要有一个<code class="du kx ky kz la b"><a class="ae jo" href="https://github.com/lzysh/terraform-google-project/tree/master/test/fixtures" rel="noopener ugc nofollow" target="_blank">fixtures</a></code>目录。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lb"><img src="../Images/4c2baa0f2f17bab9673a81c50bdcc944.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fhJ4VsjDrTK2STNd.png"/></div></div></figure><p id="ecc4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个目录是你的Terraform根模块所在的地方，或者用厨房-Terraform语言来说，就是“测试设备”它将调用子模块，即我们正在开发的模块。该语言与<a class="ae jo" href="https://www.terraform.io/docs/configuration/modules.html" rel="noopener ugc nofollow" target="_blank">模块文档</a>一致，因此在我们的例子中，子模块位于<a class="ae jo" href="https://github.com/lzysh/terraform-google-project" rel="noopener ugc nofollow" target="_blank">库</a>的根中，并且它是我们通过GitHub发布以供重用的模块。在这个例子中，我们只有<a class="ae jo" href="https://github.com/lzysh/terraform-google-project/tree/master/test/fixtures/default-project" rel="noopener ugc nofollow" target="_blank">一个根模块</a>或者测试夹具。如果我们不能在一个设备中涵盖多个测试场景，那么可能会有更多的测试场景。如果需要的话，我还有一个共享目录，用于存放大量测试设备的公共代码。</p><h1 id="8ff9" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">综合</h1><p id="7b36" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated"><code class="du kx ky kz la b"><a class="ae jo" href="https://github.com/lzysh/terraform-google-project/tree/master/test/integration" rel="noopener ugc nofollow" target="_blank">integration</a></code>目录将保存您的<a class="ae jo" href="https://docs.chef.io/inspec/profiles/" rel="noopener ugc nofollow" target="_blank">概要文件</a>以及您想要针对测试夹具运行的<a class="ae jo" href="https://docs.chef.io/inspec/dsl_inspec/" rel="noopener ugc nofollow" target="_blank"> Chef Inspec DSL控件</a>。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lb"><img src="../Images/580ce154ae670155aceef21578220be7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gelUkWRUSnOzymtR.png"/></div></div></figure><p id="21f5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章中，我们将只关注<code class="du kx ky kz la b"><a class="ae jo" href="https://github.com/lzysh/terraform-google-project/blob/master/test/integration/default-project/controls/cis_benchmark.rb" rel="noopener ugc nofollow" target="_blank">cis_benchmark.rb</a></code>和<code class="du kx ky kz la b"><a class="ae jo" href="https://github.com/lzysh/terraform-google-project/blob/master/test/integration/default-project/inspec.yml" rel="noopener ugc nofollow" target="_blank">inspec.yml</a></code>文件。由于谷歌通过编写我们正在测试的特定基准的控件为我们做了所有繁重的工作，<a class="ae jo" href="https://github.com/GoogleCloudPlatform/inspec-gcp-cis-benchmark/blob/master/controls/3.01-networking.rb" rel="noopener ugc nofollow" target="_blank"> 3.1联网</a>和<a class="ae jo" href="https://github.com/GoogleCloudPlatform/inspec-gcp-cis-benchmark/blob/master/controls/4.04-vms.rb" rel="noopener ugc nofollow" target="_blank"> 4.4虚拟机</a>，我们可以非常快速地添加它们。首先，添加您所依赖的存储库:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lb"><img src="../Images/835f1d5ea3f981a3e9871bacfbd9427e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wNMNXBqkFEo2kW8W.png"/></div></div></figure><p id="82f9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lc">注意:输入</em> <code class="du kx ky kz la b"><em class="lc">gcp_project_id</em></code> <em class="lc">是inspec-gcp-cis-benchmark概要文件所期望的，以便知道运行测试的项目。Kitchen-Terraform可以做属性和Terraform输出映射。当我们查看</em> <code class="du kx ky kz la b"><em class="lc">kitchen.yml</em></code> <em class="lc">文件时，我会谈到为什么这很重要。</em></p><p id="1208" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后为了调用一个特定的控件，我们把它添加到<code class="du kx ky kz la b"><a class="ae jo" href="https://github.com/lzysh/terraform-google-project/blob/master/test/integration/default-project/controls/cis_benchmark.rb" rel="noopener ugc nofollow" target="_blank">cis_benchmark.rb</a></code>中，就像这样:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div class="er es ld"><img src="../Images/621b57341febd006c1dfdb4d79de4a9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/0*RY0t1X8vWIZYgdTr.png"/></div></figure><h1 id="18ab" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">kitchen.yml</h1><p id="f034" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我们需要做的最后一件事是告诉Kitchen-Terraform做什么！我们通过创建一个<code class="du kx ky kz la b"><a class="ae jo" href="https://github.com/lzysh/terraform-google-project/blob/master/.kitchen.yml" rel="noopener ugc nofollow" target="_blank">kitchen.yml</a></code>文件来做到这一点:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es le"><img src="../Images/7f44e0c5cbdd1c02ab4b775947e04d71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gWr6wkj5o184pd5i.png"/></div></div></figure><p id="7c57" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想了解更多，你可以阅读关于<a class="ae jo" href="https://docs.chef.io/workstation/config_yml_kitchen/" rel="noopener ugc nofollow" target="_blank">厨房的文档。然而，我确实想谈几件事。</a></p><p id="94c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第三行和第四行是从厨房-Terraform内部传递<code class="du kx ky kz la b">-var="foo=bar"</code>到Terraform的一种方式。在这个例子中，我将账单ID作为GitHub 中的<a class="ae jo" href="https://docs.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets" rel="noopener ugc nofollow" target="_blank">秘密。当我们在GitHub Actions中设置工作流时，我们可以对此进行更多的讨论。</a></p><p id="6954" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另一件事是第二十四行和第二十五行。这与我前面谈到的属性和Terraform输出映射有关。我花了一点时间<a class="ae jo" href="https://github.com/GoogleCloudPlatform/inspec-gcp-cis-benchmark/issues/44" rel="noopener ugc nofollow" target="_blank">学习大声</a>来解决这个问题，但是在一些帮助下，我能够做到。长话短说，这就是我如何将我的Terraform输出<code class="du kx ky kz la b">project_id</code>映射到运行inspec-gcp-cis-benchmark概要文件所需的属性。</p><h1 id="290b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">运行厨房-Terraform</h1><p id="5632" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">现在我们可以运行kitchen <a class="ae jo" href="https://docs.chef.io/workstation/ctl_kitchen/#kitchen-converge" rel="noopener ugc nofollow" target="_blank"> converge </a>看看我们有什么:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lb"><img src="../Images/ebfe82e951a8ae9ec91d2b7585d83c5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*poyi7VjWu8MF1iVg.png"/></div></div></figure><p id="5d04" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将为你做各种各样的工作。它将验证Terraform客户端版本，<a class="ae jo" href="https://www.terraform.io/docs/commands/init.html" rel="noopener ugc nofollow" target="_blank">初始化</a>terra form工作目录，并创建和切换到<a class="ae jo" href="https://www.terraform.io/docs/commands/workspace/index.html" rel="noopener ugc nofollow" target="_blank">工作区</a>:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lb"><img src="../Images/2295c0d26e3090d0a0513aa1df69e5fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ColzOPDstAjAhctx.png"/></div></div></figure><p id="6c90" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它还将<a class="ae jo" href="https://www.terraform.io/docs/commands/validate.html" rel="noopener ugc nofollow" target="_blank">验证</a>terra form配置文件，并最终运行Terraform <a class="ae jo" href="https://www.terraform.io/docs/commands/apply.html" rel="noopener ugc nofollow" target="_blank">应用</a>:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lb"><img src="../Images/577a5ab34255c6ae5c677a73fa0fbb1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UQOe4wLEw9MC6mY3.png"/></div></div></figure><p id="8a71" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们可以使用kitchen <a class="ae jo" href="https://docs.chef.io/workstation/ctl_kitchen/#kitchen-verify" rel="noopener ugc nofollow" target="_blank"> verify </a>运行测试，并查看结果:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lb"><img src="../Images/2556029a2af946fa56bd65c49547d304.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sAAp9v6PRSfuWSjj.png"/></div></div></figure><p id="2544" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我们可以使用厨房<a class="ae jo" href="https://docs.chef.io/workstation/ctl_kitchen/#kitchen-destroy" rel="noopener ugc nofollow" target="_blank">摧毁</a>来摧毁基础设施。您也可以通过运行kitchen <a class="ae jo" href="https://docs.chef.io/workstation/ctl_kitchen/#kitchen-test" rel="noopener ugc nofollow" target="_blank"> test </a>在一个命令中完成以上所有操作。</p><p id="f227" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下一篇文章中，我将讨论通过<a class="ae jo" href="https://github.com/lzysh/terraform-google-project/runs/1059655434?check_suite_focus=true#step:4:1" rel="noopener ugc nofollow" target="_blank"> GitHub Actions </a>运行测试工作流！</p></div></div>    
</body>
</html>