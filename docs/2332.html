<html>
<head>
<title>Route Datadog monitoring alerts to Google Cloud with Eventarc</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Eventarc将Datadog监控警报路由到Google Cloud</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/route-datadog-monitoring-alerts-to-google-cloud-with-eventarc-a6f3bddaa033?source=collection_archive---------0-----------------------#2022-08-29">https://medium.com/google-cloud/route-datadog-monitoring-alerts-to-google-cloud-with-eventarc-a6f3bddaa033?source=collection_archive---------0-----------------------#2022-08-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="79fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">注:这是我在谷歌云博客</em>上 <a class="ae je" href="https://cloud.google.com/blog/topics/developers-practitioners/route-datadog-monitoring-alerts-google-cloud-eventarc" rel="noopener ugc nofollow" target="_blank"> <em class="jd">原创文章</em> </a> <em class="jd">的转贴</em></p><p id="65f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几周前，我们<a class="ae je" href="https://cloud.google.com/blog/products/application-development/eventarc-3rd-party-sources-preview" rel="noopener ugc nofollow" target="_blank">宣布了<a class="ae je" href="https://cloud.google.com/eventarc/docs" rel="noopener ugc nofollow" target="_blank"> Eventarc </a>的</a> <a class="ae je" href="https://cloud.google.com/eventarc/docs/third-parties/third-parties-overview" rel="noopener ugc nofollow" target="_blank">第三方活动来源</a>，首批第三方供应商由我们的生态系统合作伙伴提供。这篇博文描述了如何监听来自第三方提供商之一<a class="ae je" href="https://www.datadoghq.com/dg/monitor/google-cloud-platform/?utm_source=Referring+Site%5B%E2%80%A6%5D=ReferringTraffic&amp;utm_campaign=ReferringTraffic-2022codelabs" rel="noopener ugc nofollow" target="_blank"> Datadog </a>的事件，并通过Eventarc将它们路由到Google Cloud中的一个服务。</p><p id="8469" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" href="https://www.datadoghq.com/dg/monitor/google-cloud-platform/?utm_source=Referring+Site%5B%E2%80%A6%5D=ReferringTraffic&amp;utm_campaign=ReferringTraffic-2022codelabs" rel="noopener ugc nofollow" target="_blank"> Datadog </a>是云应用的监控平台。它将端到端的跟踪、指标和日志结合在一起，使您的应用程序和基础设施变得可观察。在Datadog中，您可以<a class="ae je" href="https://docs.datadoghq.com/monitors/create/" rel="noopener ugc nofollow" target="_blank">创建监视器</a>来跟踪指标、事件、日志、集成可用性和网络端点，并且您可以在这些监视器上设置<a class="ae je" href="https://docs.datadoghq.com/monitors/" rel="noopener ugc nofollow" target="_blank">警报阈值</a>。一旦达到这些阈值，Datadog会通过电子邮件、Slack通知您的团队或服务，现在还会通过Eventarc通知Google云服务。</p><p id="09b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们来看看如何设置一个监视器，并在达到阈值时通知Google云服务。</p><h1 id="93ea" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">发现Datadog提供者</h1><p id="db67" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">Eventarc提供者是一种服务或实体，可以直接向Google Cloud发出事件；这些事件随后被路由到您的项目。第三方提供商，如Datadog，是通过Eventarc与Google Cloud集成的非Google Cloud提供商。</p><p id="c507" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在Google Cloud Console中的某个区域或使用<code class="du ki kj kk kl b">gcloud</code>查看所有Google Cloud提供商(以及Datadog提供商):</p><pre class="km kn ko kp fd kq kl kr ks aw kt bi"><span id="a8b6" class="ku jg hi kl b fi kv kw l kx ky">gcloud eventarc providers list --location us-central1</span><span id="7bcf" class="ku jg hi kl b fi kz kw l kx ky">NAME                             LOCATION<br/>pubsub.googleapis.com            us-central1<br/>cloudaudit.googleapis.com        us-central1<br/>firebasedatabase.googleapis.com  us-central1<br/>storage.googleapis.com           us-central1<br/>datadog                          us-central1</span></pre><h1 id="ad52" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">创建一个频道</h1><p id="691e" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">要从提供者接收事件，您需要<a class="ae je" href="https://cloud.google.com/eventarc/docs/third-parties/create-channels" rel="noopener ugc nofollow" target="_blank">建立一个通道</a>。该过程包括创建和激活与提供商的通道:</p><p id="d945" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以从Google Cloud Console的Eventarc部分创建Datadog通道:</p><figure class="km kn ko kp fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es la"><img src="../Images/15bf56fa6b535a30a0ab39139298b3a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kBwALMqyAHddJCYu.png"/></div></div></figure><p id="9678" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您向Datadog发送激活令牌之前，通道将处于挂起状态:</p><figure class="km kn ko kp fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es li"><img src="../Images/c5a4128280a6ee89c6aeb163641a5d3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hwDrPn41PUAV8aLJ.png"/></div></div></figure><p id="f45f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">登录Datadog，转到integrations页面，确保安装了Google Eventarc集成:</p><figure class="km kn ko kp fd lb er es paragraph-image"><div class="er es lj"><img src="../Images/4611203a3056aab635b9ef40c76048f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:564/format:webp/0*vv4nFJA6XZptN_WZ.png"/></div></figure><p id="53e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Google Eventarc集成的配置部分，输入完整的通道名称和激活令牌:</p><figure class="km kn ko kp fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lk"><img src="../Images/c767ea5e4e6d4fb89f37178088b5fd65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UKOtUZAtx-Obaniw.png"/></div></div></figure><p id="99d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几秒钟后，您应该会在Google Cloud控制台中看到该频道处于活动状态:</p><figure class="km kn ko kp fd lb er es paragraph-image"><div class="er es ll"><img src="../Images/c5d30df1d93fa414ae7368d5b96a30ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/0*DId9-Y0ZcNF6EmP-.png"/></div></figure><p id="b8da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您已经准备好使用通道了。</p><h1 id="cbe7" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">创建工作流</h1><p id="3579" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">您需要Google Cloud中的一个目的地来接收来自Datadog的事件。Eventarc支持许多事件目的地，包括云运行、工作流和Kubernetes服务。在这种情况下，部署一个工作流来简单地记录收到的事件。</p><pre class="km kn ko kp fd kq kl kr ks aw kt bi"><span id="b9be" class="ku jg hi kl b fi kv kw l kx ky">main:<br/>  params: [event]<br/>  steps:<br/>  - logStep:<br/>      call: sys.log<br/>      args:<br/>        data: ${event}</span></pre><p id="acaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，工作流正在接收一个事件作为参数。该事件将通过Eventarc来自Datadog监控。一旦接收到事件，工作流只记录接收到的事件。</p><h1 id="9384" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">创建Eventarc触发器</h1><p id="4162" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">现在，您可以使用Eventarc触发器将Datadog提供程序中的事件连接到工作流了。</p><p id="ab6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用数据狗通道、事件类型和工作流目标创建触发器:</p><pre class="km kn ko kp fd kq kl kr ks aw kt bi"><span id="d0fe" class="ku jg hi kl b fi kv kw l kx ky">gcloud eventarc triggers create datadog-trigger1 \<br/>  --location $REGION \<br/>  --destination-workflow $WORKFLOW_NAME \<br/>  --destination-workflow-location $REGION \<br/>  --channel $CHANNEL_NAME \<br/>  --event-filters type=datadog.v1.alert \<br/>  --service-account $<a class="ae je" href="mailto:PROJECT_NUMBER-compute@developer.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">PROJECT_NUMBER-compute@developer.gserviceaccount.com</a></span></pre><h1 id="c291" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">创建一个数据狗监视器</h1><p id="8dd7" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">现在您已经准备好创建一个Datadog监视器并将其连接到Eventarc。在本例中，它是一个简单的Hello-World类型的监视器，具有默认值。您将手动触发它来生成监控警报，这又会在Google Cloud中生成Eventarc事件。</p><p id="77d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要在Datadog中创建监视器，首先登录Datadog。然后将指针停留在主菜单中的<code class="du ki kj kk kl b">Monitors</code>上，点击<code class="du ki kj kk kl b">New Monitor</code>。显示器有多种类型。选择<code class="du ki kj kk kl b">Metric monitor</code>类型。</p><p id="3311" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du ki kj kk kl b">New Monitor</code>页面中，保留步骤1和2的默认值。</p><ul class=""><li id="0377" class="lm ln hi ih b ii ij im in iq lo iu lp iy lq jc lr ls lt lu bi translated">在步骤3中，将警报阈值设置为1</li><li id="51b5" class="lm ln hi ih b ii lv im lw iq lx iu ly iy lz jc lr ls lt lu bi translated">在步骤4中，将<code class="du ki kj kk kl b">Test monitor for Eventarc</code>设置为监视器名称，并将<code class="du ki kj kk kl b">Notify your team</code>设置为<code class="du ki kj kk kl b">@eventarc_&lt;your-project-id&gt;_&lt;your-region&gt;_&lt;your-channel-name&gt;</code></li></ul><h1 id="ab56" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">测试Datadog和Eventarc集成</h1><p id="5080" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">要测试Datadog监视器和Eventarc触发器，您可以手动触发监视器。</p><p id="bfac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在显示器创建页面的底部，点击<code class="du ki kj kk kl b">Test Notifications</code>按钮:</p><figure class="km kn ko kp fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es ma"><img src="../Images/cb33b32e4d3e716bf562c983003fe801.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hB7CUXsvOieH3nQf.png"/></div></div></figure><p id="b792" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，点击<code class="du ki kj kk kl b">Run Test</code>按钮:</p><figure class="km kn ko kp fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es mb"><img src="../Images/6d6f5a75ff674db037a4fa9345557ea9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Z09TzfVK0OY0PG-0.png"/></div></div></figure><p id="3e1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这应该模拟监视器中的状态转换并触发Eventarc事件。在工作流中，您应该看到有一个新的执行。在该执行的详细信息中，您应该可以在工作流输入和日志中看到由监控警报生成的Datadog事件类型<code class="du ki kj kk kl b">datadog.v1.alert</code>:</p><figure class="km kn ko kp fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es mc"><img src="../Images/181e00b6d58462f0852b093a2f4c8d0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bg10JXDoTxPXJmIq.png"/></div></div></figure><h1 id="75b8" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">后续步骤</h1><p id="c063" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">这篇文章讲述了如何使用Eventarc将Datadog监控警报发送到Google Cloud。如果你想在你自己的项目中运行这些步骤，我们有一个<a class="ae je" href="https://codelabs.developers.google.com/codelabs/cloud-route-datadog-eventarc-part-one" rel="noopener ugc nofollow" target="_blank">代码实验室</a>，你可以试试。</p><p id="0f25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">只有当您能够对警报采取行动时，监听警报才有用。在这个<a class="ae je" href="https://codelabs.developers.google.com/codelabs/cloud-route-datadog-eventarc-part-two#0" rel="noopener ugc nofollow" target="_blank">第二代码实验室</a>中，您将学习如何通过工作流响应Datadog监控警报。更具体地说，您将创建两个计算引擎虚拟机，并使用Datadog监视器来监视它们。一旦其中一个虚拟机被删除，您将通过Eventarc收到来自Datadog的工作流警报。反过来，工作流将重新创建已删除的虚拟机，以使正在运行的虚拟机数量恢复到两个。这只是一个简单的例子，说明如何在Google Cloud中使用服务自动响应Datadog警报。</p></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="5093" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如有任何问题或反馈，请随时通过Twitter <a class="ae je" href="https://twitter.com/meteatamel" rel="noopener ugc nofollow" target="_blank"> @meteatamel </a>联系我。</p></div></div>    
</body>
</html>