<html>
<head>
<title>Dynamic image resizing with Google Cloud Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用谷歌云功能动态调整图像大小</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/dynamic-image-resizing-with-google-cloud-functions-2fcdf935d8ce?source=collection_archive---------2-----------------------#2017-07-29">https://medium.com/google-cloud/dynamic-image-resizing-with-google-cloud-functions-2fcdf935d8ce?source=collection_archive---------2-----------------------#2017-07-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0468" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于一个小项目，我需要动态调整图像大小，这意味着我会调用一个url中的图像，附加一些参数来调整大小并返回一个更小的图像，所以类似于<code class="du jd je jf jg b">example.com/image.jpg?w=50&amp;h=50</code>。现在有几个开源项目能够做到这一点，最著名的是<a class="ae jh" href="https://github.com/thumbor/thumbor" rel="noopener ugc nofollow" target="_blank"> Thumbor </a>。</p><p id="790b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，我想尝试一些新的东西。我最近尝试了一下谷歌云功能，它看起来是个不错的选择。然而，我担心函数的初始旋转时间可能会有问题。尽管如此，我还是想尝试一下，以后再处理这个问题。</p><p id="7fbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我已经有一个谷歌云存储桶，里面有原始图像。如前所述，我希望调整大小是动态的。因此，对请求的响应是调整了大小的图像。我希望resizer输出50×50像素的图像，这样我们就可以得到一些很好的图片大小的图像。</p><p id="7a19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将从编写云函数开始。首先是一些设置步骤。</p><pre class="ji jj jk jl fd jm jg jn jo aw jp bi"><span id="3d99" class="jq jr hi jg b fi js jt l ju jv">mkdir image-serve <br/>cd image-serve <br/>git init . yarn init # Press enter on all the steps <br/>yarn add @google-cloud/storage gm</span></pre><p id="4ed0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们设置了一个git存储库，并使用yarn来设置项目。然后我们添加两个依赖项，<a class="ae jh" href="https://github.com/GoogleCloudPlatform/google-cloud-node#cloud-storage-ga" rel="noopener ugc nofollow" target="_blank"> Google云存储api客户端</a>和<a class="ae jh" href="http://aheckmann.github.io/gm/" rel="noopener ugc nofollow" target="_blank"> gm包</a>，一个imagemagick/graphicsmagick的包装器。</p><p id="1222" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来是实际云函数的编写。用以下内容创建一个<code class="du jd je jf jg b">index.js</code>文件。</p><pre class="ji jj jk jl fd jm jg jn jo aw jp bi"><span id="5e40" class="jq jr hi jg b fi js jt l ju jv">//index.js</span><span id="1382" class="jq jr hi jg b fi jw jt l ju jv">const storage = require('@google-cloud/storage')()<br/>const gm = require('gm').subClass({imageMagick: true})</span><span id="ba2e" class="jq jr hi jg b fi jw jt l ju jv">const bucket = "source-bucket-name"<br/>const width = 50<br/>const height = 50<br/>const option = "!"<br/>const quality = 90</span><span id="92ba" class="jq jr hi jg b fi jw jt l ju jv">exports.main = (req, res) =&gt; {</span><span id="1bd4" class="jq jr hi jg b fi jw jt l ju jv">    const filename = req.query.f</span><span id="d954" class="jq jr hi jg b fi jw jt l ju jv">    if(!filename) {<br/>        res.sendStatus(500).send("No file specified");<br/>        return;<br/>    }</span><span id="b8fa" class="jq jr hi jg b fi jw jt l ju jv">    const file = storage.bucket(bucket).file(filename);</span><span id="6021" class="jq jr hi jg b fi jw jt l ju jv">    let stream = file.createReadStream()</span><span id="b87f" class="jq jr hi jg b fi jw jt l ju jv">    stream.on('error', function(err) {<br/>        console.error(err);<br/>        res.sendStatus(err.code).end(err);<br/>    });</span><span id="a2e5" class="jq jr hi jg b fi jw jt l ju jv">    gm(stream)<br/>    .resize(width, height, option)<br/>    .quality(quality)<br/>    .stream()<br/>    .pipe(res);</span><span id="fe3a" class="jq jr hi jg b fi jw jt l ju jv">    console.log('Served: ' + filename );<br/>}</span></pre><p id="e002" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么这里发生了什么？首先，我们需要依赖关系，并设置一些常数，如图像输出的尺寸和质量。我们还在这里设置了一个源桶，供Google Cloud客户端查询。我们还子类化了<code class="du jd je jf jg b">gm</code>库，以使用已经存在于云函数环境中的<code class="du jd je jf jg b">imagemagick</code>二进制文件。</p><p id="14da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来是主函数。它接受两个参数，一个请求(req)和一个响应(res)。该功能类似于<a class="ae jh" href="http://expressjs.com/en/api.html#req" rel="noopener ugc nofollow" target="_blank">快速框架</a>中的功能。我们在url中寻找一个文件名，如果没有设置，就会触发一个错误。</p><p id="ef55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后，我们从Google云存储文件中获取一个读取流(假设你的文件是可公开访问的)，将这个流传递给<code class="du jd je jf jg b">gm</code>库，使用给定的选项调整它的大小，并将输出写入响应流和日志文件名。这就是云函数的编写。现在我们需要部署它。首先我们压缩我们的代码。</p><pre class="ji jj jk jl fd jm jg jn jo aw jp bi"><span id="7801" class="jq jr hi jg b fi js jt l ju jv">zip -r image-resize.zip .</span></pre><p id="ea8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在谷歌云控制台的侧边栏中，有一个指向云功能的链接。这将为您提供功能概述。点击创建功能。填写表单，它应该是这样的:</p><figure class="ji jj jk jl fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jx"><img src="../Images/52a6d4a81d12003688005911c06dff5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NUTIblnHPXdjj0kO.png"/></div></div></figure><p id="35a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将在HTTP触发器上创建一个云函数，这样就可以通过GET请求访问它。注意，执行<code class="du jd je jf jg b">main</code>的函数指的是代码中的<code class="du jd je jf jg b">main</code>函数。此外，您可能需要为要在其中部署的功能创建一个云存储空间。点击创建，你就完成了。</p><p id="cff0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在你可以进入<code class="du jd je jf jg b">https://us-central1-YOUR_PROJECT_ID.cloudfunctions.net/image-resize?f=filename.jpg</code>，它会将你的源桶中的<code class="du jd je jf jg b">filename.jpg</code>-文件的大小调整为50×50像素。请注意，它非常慢，我将在另一个时间写关于缓存响应的内容。</p><p id="396f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Github上有代码:(【https://github.com/maartenvanvliet/image-resize】T4)</p></div><div class="ab cl kf kg gp kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hb hc hd he hf"><p id="2b30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="km">原载于2017年7月29日</em><a class="ae jh" href="https://maartenvanvliet.nl/2017/07/29/dynamic-image-resizing-with-google-cloud-function/" rel="noopener ugc nofollow" target="_blank"><em class="km">maartenvanvliet . nl</em></a><em class="km">。</em></p></div></div>    
</body>
</html>