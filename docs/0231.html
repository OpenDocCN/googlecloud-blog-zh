<html>
<head>
<title>Securing Cloud PubSub Push with Cloud Endpoints</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过云端点保护云发布订阅推送</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/secure-pubsub-push-with-cloud-endpoints-6a1adc36db9f?source=collection_archive---------0-----------------------#2017-03-21">https://medium.com/google-cloud/secure-pubsub-push-with-cloud-endpoints-6a1adc36db9f?source=collection_archive---------0-----------------------#2017-03-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b724" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud PubSub是一项完全托管的实时消息和流媒体服务。到目前为止，它是我们大数据管道中最可靠的组件之一。但是不太明显的是，您可以在微服务架构中将它作为一种在整个系统中传播更改的方式。</p><p id="6687" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然大数据管道一般都是高吞吐量的，<strong class="ih hj">变化传播</strong>可能会不那么喋喋不休。对于这些场景，PubSub有一个很好的特性叫做<strong class="ih hj">推送订阅</strong>。推订阅不需要在拉模型中编写专门的代码来从订阅中提取消息，而是让PubSub在HTTP端点上发布消息。</p><h1 id="438f" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">发布订阅推送</h1><p id="361c" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">PubSub推送订阅功能消除了很多复杂性。不需要考虑确认，只需要确保您能够足够快地处理消息并返回204。当你的服务跟不上的时候，PubSub会确保消息继续发送或退回。需要注意的是，一次只推送一条消息，但是这对于低吞吐量的场景来说是可以的。记住:你不必写任何特殊的代码。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/dec5bd00ef21e6860e9524a9c841486c.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*ycgDbtKooIHp4dX7VXrnNg.png"/></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">在云控制台中创建新的API密钥</figcaption></figure><p id="46ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，总有但是……安全性呢？<a class="ae jd" href="https://cloud.google.com/pubsub/docs/faq#security" rel="noopener ugc nofollow" target="_blank"> PubSub FAQ </a>提示只接受带有密钥的消息。但是这意味着要编写额外的代码。秘密密钥也意味着管理和旋转你的密钥，再次额外的代码。除非…</p><p id="220e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您可以再次将键处理从代码中移除，会怎么样？你可以，通过使用云端点。</p><h1 id="d138" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">端点</h1><p id="0f61" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/endpoints/" rel="noopener ugc nofollow" target="_blank">云端点</a>是一个代理，你可以把它放在你的微服务前面，它可以处理你的认证、监控、记录和跟踪。它还支持API键，易于使用。您唯一需要为您的端点编写的是一个OpenAPI文件(以前称为swagger)。该文件需要使用</p><blockquote class="kt ku kv"><p id="5d27" class="if ig kw ih b ii ij ik il im in io ip kx ir is it ky iv iw ix kz iz ja jb jc hb bi translated">gcloud服务管理部署openapi.yaml</p></blockquote><p id="e614" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在下面的例子中，我们有一个我们想要保护的<strong class="ih hj">/API/hellopy/subscriptions/foobar</strong>推送端点。简单地通过添加带有api_key定义的安全定义，<em class="kw">端点</em> <em class="kw">代理</em>将处理所有的<em class="kw">密钥验证</em>。</p><pre class="ki kj kk kl fd la lb lc ld aw le bi"><span id="8be9" class="lf jf hi lb b fi lg lh l li lj"><strong class="lb hj">swagger: </strong>"2.0"<br/><strong class="lb hj">...<br/>paths:<br/></strong>...<br/>  <strong class="lb hj">"/api/hellopy/subscriptions/foobar":<br/>    post:<br/>      description: </strong>"PubSub push."<br/>      <strong class="lb hj">operationId: </strong>"pubsub_foobar"<br/>      <strong class="lb hj">produces:<br/>      </strong>- "application/json"<br/>      <strong class="lb hj">responses:<br/>        204:<br/>          description: </strong>"Ack"<br/>      <strong class="lb hj">security:<br/>        </strong>- <strong class="lb hj">api_key: </strong>[]<br/>...<br/><strong class="lb hj">securityDefinitions:<br/>  api_key:<br/>    type: </strong>"apiKey"<br/>    <strong class="lb hj">name: </strong>"key"<br/>    <strong class="lb hj">in: </strong>"query"</span></pre><p id="b680" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在云项目中你需要在API管理器中创建一个凭证<strong class="ih hj"> API key </strong>。然后，该密钥可以用作订阅url中的查询参数。就是这样。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es lk"><img src="../Images/a0ab7bd1ded7a1bac4db97c8b038785c.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/format:webp/1*Y0VtGoaR4u6Ze5CR_CMwbw.png"/></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">在URL中使用API键</figcaption></figure><p id="9267" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以通过在主题上推送一些消息来开始测试您的端点。一定要留意日志，看看你的消息是否传来。</p><p id="523b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了<em class="kw">零代码解决方案，</em>你还可以通过在<em class="kw"> API管理器</em>中按下<strong class="ih hj">重新生成密钥</strong>来旋转密钥。API管理器给你24小时的宽限期，在此期间你有时间更新你的订阅中的密钥，在此期间它将继续接受原来的密钥。</p></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><h1 id="d5ba" class="je jf hi bd jg jh ls jj jk jl lt jn jo jp lu jr js jt lv jv jw jx lw jz ka kb bi translated">结论</h1><p id="fe11" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在，这是我保护PubSub推送端点的首选方式。我当然喜欢无代码方法，因为你应该<strong class="ih hj">抵制编写自己的安全处理</strong>代码。你可以自动完成这个过程，包括钥匙旋转。但是我们遗漏了一些API。通过API更新订阅很容易，<em class="kw">但是我们这里缺少一个创建和旋转密钥的API</em>(Google你在听吗？).</p><p id="d158" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了缺少用于维护您的密钥的API之外，您现在有了一个保护您的PubSub推送订阅的好方法，而无需编写一行代码。</p></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><h2 id="1b88" class="lf jf hi bd jg lx ly lz jk ma mb mc jo iq md me js iu mf mg jw iy mh mi ka mj bi translated">谷歌的愿望清单:</h2><ul class=""><li id="61e0" class="mk ml hi ih b ii kc im kd iq mm iu mn iy mo jc mp mq mr ms bi translated">添加用于管理API密钥的API</li><li id="d943" class="mk ml hi ih b ii mt im mu iq mv iu mw iy mx jc mp mq mr ms bi translated">发布PubSub可以发布的已知IP范围列表</li></ul></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><h2 id="2873" class="lf jf hi bd jg lx ly lz jk ma mb mc jo iq md me js iu mf mg jw iy mh mi ka mj bi translated">参考</h2><ul class=""><li id="42e7" class="mk ml hi ih b ii kc im kd iq mm iu mn iy mo jc mp mq mr ms bi translated"><a class="ae jd" href="https://cloud.google.com/pubsub/docs/subscriber" rel="noopener ugc nofollow" target="_blank"> PubSub订阅指南</a>:阅读如何在Google Cloud PubSub中配置您的订阅</li><li id="d09e" class="mk ml hi ih b ii mt im mu iq mv iu mw iy mx jc mp mq mr ms bi translated"><a class="ae jd" href="https://cloud.google.com/pubsub/docs/faq#security" rel="noopener ugc nofollow" target="_blank"> PubSub安全常见问题解答</a>:push URL中使用tokes的建议</li><li id="a019" class="mk ml hi ih b ii mt im mu iq mv iu mw iy mx jc mp mq mr ms bi translated"><a class="ae jd" href="https://cloud.google.com/endpoints/docs/quickstart-container-engine" rel="noopener ugc nofollow" target="_blank">容器引擎的云端点</a>:在Kubernetes上使用端点的快速入门</li><li id="ab49" class="mk ml hi ih b ii mt im mu iq mv iu mw iy mx jc mp mq mr ms bi translated"><a class="ae jd" href="https://support.google.com/googleapi/answer/6158857?hl=en" rel="noopener ugc nofollow" target="_blank">凭证支持</a>:如何在凭证屏幕中创建API密钥</li></ul></div></div>    
</body>
</html>