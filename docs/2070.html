<html>
<head>
<title>Continuous Integration with Apigee and Github Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与Apigee和Github操作的持续集成</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/continuous-integration-with-apigee-and-github-actions-bcba4178925c?source=collection_archive---------0-----------------------#2022-01-26">https://medium.com/google-cloud/continuous-integration-with-apigee-and-github-actions-bcba4178925c?source=collection_archive---------0-----------------------#2022-01-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/355e5c4ee6a9b8f4d61ac6eff4862be9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jIj5cNXN-2HHbwasHOXGHA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">从GitHub部署到Apigee X</figcaption></figure><p id="d45b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">今天，我需要设置一个CI/CD管道，将我们的API代理从GitHub部署到运行在Google Cloud上的Apigee X组织。我采取了一种相当固执的方法来做这件事，我想与你分享。这篇博文可能需要一些GCP、Apigee和GitHub操作的常识。</p><p id="4684" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我不喜欢依赖，它们增加了复杂性，你需要时间来管理它们。因此，当从我的CI/CD管道部署到Apigee时，我尝试了一种极简的方法。有直接来自<a class="ae js" href="https://github.com/apigee/devrel" rel="noopener ugc nofollow" target="_blank"> Apigee DevRel团队</a>的优秀工具，或者像<a class="ae js" href="https://github.com/srinandan/apigeecli" rel="noopener ugc nofollow" target="_blank"> apigeecli </a>这样的优秀工具，你可能会考虑使用。我在这里的方法是使用方便的瑞士军刀工具:<a class="ae js" href="https://curl.se/" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hj"> curl </strong> </a>，它预装在GitHub托管的Ubuntu实例中。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es jt"><img src="../Images/de350cd1405fda5ba69bdbe0507bbb24.png" data-original-src="https://miro.medium.com/v2/resize:fit:908/format:webp/1*H_gOwSGDPWC9WJwyZ3dmKQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">存储库结构</figcaption></figure><p id="322b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">所以让我们从存储库结构开始(上图)。在<code class="du jy jz ka kb b">apiproxy/</code>下，Apigee代理的开发正在进行，例如使用伟大的<a class="ae js" href="https://cloud.google.com/code" rel="noopener ugc nofollow" target="_blank">Google Cloud Code</a>VS Code extension。在<code class="du jy jz ka kb b">.github/workflows/</code>文件夹中，你可以找到GitHub动作定义。</p><p id="a49f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这篇博文的重点是GitHub动作的定义。因此，我们需要设置3样东西(你可以在下面找到完整的GitHub动作工作流程):</p><ol class=""><li id="41a7" class="kc kd hi iw b ix iy jb jc jf ke jj kf jn kg jr kh ki kj kk bi translated"><strong class="iw hj">第35–42行</strong>:我们需要针对Google APIs进行认证，以便能够与Apigee APIs进行通信，因为GitHub Actions令牌符合OpenID Connect，我们可以使用<a class="ae js" href="https://cloud.google.com/iam/docs/workload-identity-federation" rel="noopener ugc nofollow" target="_blank">工作负载身份联盟</a>来集成这两者。更好的是，因为我们不是第一个遇到这个问题的人，我们可以使用一个伟大的<a class="ae js" href="https://github.com/google-github-actions/auth" rel="noopener ugc nofollow" target="_blank"> GitHub Action </a>，它已经为我们完成了繁重的工作。第一次<a class="ae js" href="https://github.com/google-github-actions/auth#setup" rel="noopener ugc nofollow" target="_blank">设置</a>有点复杂，但可以很快完成。</li><li id="7c1a" class="kc kd hi iw b ix kl jb km jf kn jj ko jn kp jr kh ki kj kk bi translated"><strong class="iw hj">第45–49行</strong>:我们需要将组成API代理的各种XML文件打包成一个. zip文件，然后上传。压缩到Apigee作为新版本。我们将修订号存储在步骤的输出变量中，这样我们就可以在下一步中使用它。我们将zip发布到<a class="ae js" href="https://cloud.google.com/apigee/docs/reference/apis/apigee/rest/v1/organizations.apis/create" rel="noopener ugc nofollow" target="_blank">创建API端点</a>来创建一个新的版本。</li><li id="2455" class="kc kd hi iw b ix kl jb km jf kn jj ko jn kp jr kh ki kj kk bi translated"><strong class="iw hj">Line 50–51</strong>:接下来我们要将新的版本部署到<code class="du jy jz ka kb b">dev</code>环境中。我们再次使用curl，并发送到<a class="ae js" href="https://cloud.google.com/apigee/docs/reference/apis/apigee/rest/v1/organizations.environments.apis.revisions.deployments/deploy" rel="noopener ugc nofollow" target="_blank">部署端点</a>。</li></ol><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="kq kr l"/></div></figure><p id="0312" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">从yaml定义中可以看出，要让管道工作，应该设置3个秘密。<br/><strong class="iw hj">WORKLOAD _ IDENTITY _ POOL _ ID</strong>采用您为设置工作负载身份联盟而创建的工作负载池的全名，例如<code class="du jy jz ka kb b">projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID</code> <br/> <strong class="iw hj"> APIGEE_ORG </strong>您的APIGEE组织的名称，通常与您的GCP项目ID<br/><strong class="iw hj">SERVICE _ ACCOUNT</strong>管道应使用的服务帐户相同(您在遵循<a class="ae js" href="https://github.com/google-github-actions/auth#setup" rel="noopener ugc nofollow" target="_blank">工作负载身份联盟设置指南</a>时设置了此名称)</p><p id="34a2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">代理的名字被硬编码到URL中，如果你愿意，你可以把它提取到一个变量中。当GitHub Actions成功运行时，您在GitHub Actions UI中的输出应该如下所示:</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ks"><img src="../Images/427b021065aa34cb67e02811a80b8def.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U5GaRzwuhf2R1VUVa4Ojzg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">GitHub操作UI中的构建</figcaption></figure><h1 id="ee7f" class="kt ku hi bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">结论</h1><p id="4641" class="pw-post-body-paragraph iu iv hi iw b ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr hb bi translated">就是这样！现在，我们可以轻松地将Apigee API代理从GitHub捆绑和部署到GCP，感谢Workload Identity Federation，我们甚至不必将密钥导出和上传到GitHub。你可以在这里找到完整的例子:<a class="ae js" href="https://github.com/cgrotz/blog-examples/tree/main/apigee-github-actions" rel="noopener ugc nofollow" target="_blank">https://github . com/cgrotz/blog-examples/tree/main/API gee-github-actions</a></p></div></div>    
</body>
</html>