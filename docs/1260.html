<html>
<head>
<title>How to replay time series data from Google BigQuery to Pub/Sub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从Google BigQuery向Pub/Sub重放时间序列数据</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-replay-time-series-data-from-google-bigquery-to-pub-sub-c0a80095124b?source=collection_archive---------0-----------------------#2020-01-20">https://medium.com/google-cloud/how-to-replay-time-series-data-from-google-bigquery-to-pub-sub-c0a80095124b?source=collection_archive---------0-----------------------#2020-01-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a1a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一篇教程文章，解释了如何将BigQuery表中的时间序列数据重放到发布/订阅主题中。有几个您可能需要它的用例:</p><ul class=""><li id="1f01" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">回溯测试。</li><li id="941f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">演示/可视化。</li><li id="bc0c" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">集成测试。</li></ul><p id="14b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用于在不同服务之间移动数据的GCP服务是数据流。虽然Google提供了很多数据流模板，但是没有一个可以将数据从BigQuery转移到Pub/Sub。</p><p id="8e13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是为什么我们开发了自己的工具来解决这个任务:<a class="ae jr" href="https://github.com/blockchain-etl/bigquery-to-pubsub" rel="noopener ugc nofollow" target="_blank">https://github.com/blockchain-etl/bigquery-to-pubsub</a>。它可以用来重放任何带有<a class="ae jr" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types#timestamp-type" rel="noopener ugc nofollow" target="_blank">时间戳</a>字段的BigQuery表。这是一个Python程序，它从一个分区的BigQuery表中顺序地提取数据块，并及时地将这些行作为JSON消息发布到一个Pub/Sub主题。下面是一个突出显示基本选项的示例:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="3a53" class="kb kc hi jx b fi kd ke l kf kg">&gt; python run_command.py \<br/><strong class="jx hj">--bigquery-table</strong> bigquery-public-data.crypto_ethereum.transactions \<br/><strong class="jx hj">--timestamp-field</strong> block_timestamp \<br/><strong class="jx hj">--start-timestamp</strong> 2019-10-23T00:00:00 \<br/><strong class="jx hj">--end-timestamp</strong> 2019-10-23T01:00:00 \<br/>--batch-size-in-seconds 1800 \<br/><strong class="jx hj">--replay-rate</strong> 0.1 \<br/><strong class="jx hj">--pubsub-topic</strong> projects/${project}/topics/bigquery-to-pubsub-test0 \</span></pre><p id="4a63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面，您将在BigQuery 中找到从<a class="ae jr" href="https://console.cloud.google.com/marketplace/details/ethereum/crypto-ethereum-blockchain?filter=solution-type:dataset&amp;filter=category:finance" rel="noopener ugc nofollow" target="_blank">以太坊数据集中重放以太坊交易的详细说明。</a></p><ol class=""><li id="50ef" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc kh jj jk jl bi translated">创建具有以下角色的服务帐户:</li></ol><ul class=""><li id="91b3" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">BigQuery管理员</li><li id="9a67" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">存储管理员</li><li id="d027" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">发布/订阅发布者</li></ul><p id="9cf8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.为服务帐户创建一个密钥文件，并作为<code class="du ki kj kk jx b">credentials_file.json</code>下载。</p><p id="cfe3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.创建一个名为<code class="du ki kj kk jx b">bigquery-to-pubsub-test0</code>的发布/订阅主题:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="5f33" class="kb kc hi jx b fi kd ke l kf kg">&gt; gcloud pubsub topics create <!-- -->bigquery-to-pubsub-test0</span></pre><p id="08ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.创建临时GCS存储桶和临时BigQuery数据集:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="6731" class="kb kc hi jx b fi kd ke l kf kg">&gt; git clone <a class="ae jr" href="https://github.com/blockchain-etl/bigquery-to-pubsub.git" rel="noopener ugc nofollow" target="_blank">https://github.com/blockchain-etl/bigquery-to-pubsub.git</a><br/>&gt; cd bigquery-to-pubsub<br/>&gt; bash create_temp_resources.sh</span></pre><p id="a126" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.为以太坊交易运行重放:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="ea44" class="kb kc hi jx b fi kd ke l kf kg">&gt; docker build -t bigquery-to-pubsub:latest -f Dockerfile .<br/>&gt; project=$(gcloud config get-value project 2&gt; /dev/null)<br/>&gt; temp_resource_name=$(./get_temp_resource_name.sh)<br/>&gt; echo "Replaying Ethereum transactions"<br/>&gt; docker run \<br/>-v /path_to_credentials_file/:/bigquery-to-pubsub/ --env GOOGLE_APPLICATION_CREDENTIALS=/bigquery-to-pubsub/credentials_file.json \<br/>    bigquery-to-pubsub:latest \<br/>--bigquery-table bigquery-public-data.crypto_ethereum.transactions \<br/>--timestamp-field block_timestamp \<br/>--start-timestamp 2019-10-23T00:00:00 \<br/>--end-timestamp 2019-10-23T01:00:00 \<br/>--batch-size-in-seconds 1800 \<br/>--replay-rate 0.1 \<br/>--pubsub-topic projects/${project}/topics/bigquery-to-pubsub-test0 \<br/>--temp-bigquery-dataset ${temp_resource_name} \<br/>--temp-bucket ${temp_resource_name}</span></pre><h2 id="78b3" class="kb kc hi bd kl km kn ko kp kq kr ks kt iq ku kv kw iu kx ky kz iy la lb lc ld bi translated">在Google Kubernetes引擎中运行</h2><p id="4001" class="pw-post-body-paragraph if ig hi ih b ii le ik il im lf io ip iq lg is it iu lh iw ix iy li ja jb jc hb bi translated">对于长时间运行的重放，在云中启动这个过程很方便。Google Kubernetes引擎是一个很好的选择，因为它提供了现成的Stackdriver日志记录和健康监控。</p><p id="3c62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是使用<a class="ae jr" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank">舵</a>在<a class="ae jr" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank"> GKE </a>中生成重放作业的说明:</p><ol class=""><li id="0960" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc kh jj jk jl bi translated">克隆GitHub存储库:</li></ol><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="c2e0" class="kb kc hi jx b fi kd ke l kf kg">&gt; git clone <a class="ae jr" href="https://github.com/blockchain-etl/bigquery-to-pubsub.git" rel="noopener ugc nofollow" target="_blank">https://github.com/blockchain-etl/bigquery-to-pubsub.git</a><br/>&gt; cd bigquery-to-pubsub/helm</span></pre><p id="bb0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.创建并初始化GKE集群、发布/订阅主题、临时存储桶和大查询数据集:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="e460" class="kb kc hi jx b fi kd ke l kf kg">&gt; bash scripts/setup.sh</span></pre><p id="40b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.复制和编辑示例值:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="f6ef" class="kb kc hi jx b fi kd ke l kf kg">&gt; cp values-sample.yaml values-dev.yaml<br/>&gt; vim values-dev.yaml</span></pre><p id="fb6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.对于<code class="du ki kj kk jx b">tempBigqueryDataset</code>和<code class="du ki kj kk jx b">tempBucket</code>使用由<code class="du ki kj kk jx b">bash scripts/get_temp_resource_name.sh</code>打印的数值</p><p id="f991" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.安装图表:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="0059" class="kb kc hi jx b fi kd ke l kf kg">&gt; helm install bigquery-to-pubsub/ -name bigquery-to-pubsub-0 -values values-dev.yaml</span></pre><p id="2f3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.检查<code class="du ki kj kk jx b">kubectl get pods</code>的输出。当状态为“已完成”时，作业完成。使用<code class="du ki kj kk jx b">kubectl logs &lt;POD&gt; -f</code>查看进度。</p><p id="fea0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.清理资源:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="9c6a" class="kb kc hi jx b fi kd ke l kf kg">&gt; bash scripts/cleanup.sh</span></pre><p id="ad19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来是一篇展示如何使用数据流和这个工具进行回溯测试的文章。</p></div></div>    
</body>
</html>