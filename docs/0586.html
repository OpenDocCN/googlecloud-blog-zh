<html>
<head>
<title>Continuous Profiling of Go programs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">围棋程序的连续剖析</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/continuous-profiling-of-go-programs-96d4416af77b?source=collection_archive---------0-----------------------#2018-04-25">https://medium.com/google-cloud/continuous-profiling-of-go-programs-96d4416af77b?source=collection_archive---------0-----------------------#2018-04-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6123" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌最有趣的部分之一是我们全舰队范围的持续剖析服务。我们可以看到谁负责CPU和内存的使用，我们可以持续监控我们的生产服务的争用和阻塞情况，我们可以生成分析和报告，并可以轻松地判断哪些是我们可以开展的极具影响力的优化项目。</p><p id="4ea9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我曾短暂地参与过<a class="ae jd" href="https://cloud.google.com/profiler/" rel="noopener ugc nofollow" target="_blank"> Google Cloud Profiler </a>的工作，这是我们的新产品，填补了云用户在云范围内的分析空白。注意，你不需要在谷歌云平台上运行你的代码来使用它。实际上，我现在每天都在开发时使用它。它还支持Java和Node.js。</p><h2 id="0610" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">生产中的剖析</h2><p id="ec2c" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">pprof在生产中使用是安全的。我们的目标是额外增加5%的CPU和堆分配分析开销。从单个实例每分钟收集10秒钟。如果你有一个Kubernetes豆荚的多个副本，我们确保我们做摊销收集。例如，如果您有一个pod的10个副本，开销将是0.5%。这使得用户可以始终保持剖析。</p><p id="4e9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们目前支持Go程序的CPU、堆、互斥和线程配置文件。</p><h2 id="365e" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">为什么？</h2><p id="a880" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">在解释如何在生产环境中使用分析器之前，解释一下为什么要在生产环境中进行分析是有帮助的。一些非常常见的情况是:</p><ul class=""><li id="3005" class="ke kf hi ih b ii ij im in iq kg iu kh iy ki jc kj kk kl km bi translated">调试性能问题仅在生产中可见。</li><li id="60ed" class="ke kf hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated">了解CPU使用情况，减少计费。</li><li id="3a29" class="ke kf hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated">了解竞争累积的位置并进行优化。</li><li id="644d" class="ke kf hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated">了解新版本的影响，例如，看到金丝雀和生产之间的差异。</li><li id="0126" class="ke kf hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated">通过<a class="ae jd" href="https://rakyll.org/profiler-labels/" rel="noopener ugc nofollow" target="_blank">将</a>与剖析样本相关联来丰富您的分布式跟踪，以了解延迟的根本原因。</li></ul><h2 id="a0be" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">使能够</h2><p id="cb75" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">Stackdriver Profiler不与<em class="ks"> net/http/pprof </em>处理程序一起工作，并且要求您在程序中安装和配置一行代理。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="b32e" class="je jf hi ky b fi lc ld l le lf">go get <a class="ae jd" href="http://cloud.google.com/go/profiler" rel="noopener ugc nofollow" target="_blank">cloud.google.com/go/profiler</a></span></pre><p id="ada3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在主函数中，启动分析器:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="013f" class="je jf hi ky b fi lc ld l le lf">if err := profiler.Start(profiler.Config{<br/>   Service:        "indexing-service",<br/>   ServiceVersion: "1.0",<br/>   ProjectID:      "bamboo-project-606", // optional on GCP<br/>}); err != nil {<br/>   log.Fatalf("Cannot start the profiler: %v", err) <br/>}</span></pre><p id="f0b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦您开始运行您的程序，分析器包将每分钟报告分析器10秒钟。</p><h2 id="534b" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">形象化</h2><p id="7027" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">一旦档案被报告到后台，你将开始在<a class="ae jd" href="https://console.cloud.google.com/profiler" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/profiler</a>看到火焰图。您可以按标签过滤并更改时间跨度，也可以按服务名称和版本细分。该数据将在30天左右。</p><figure class="kt ku kv kw fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lg"><img src="../Images/9e2f9ce08b72f58d8e3ddf63c09a713c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*JdCm1WwmTgExzee5-ZWfNw.gif"/></div></div></figure><p id="d0cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以选择一个可用的配置文件；按服务、区域和版本细分。可以在火焰中移动，按标签过滤。</p><h2 id="546b" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">解读火焰</h2><p id="de91" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">Brendan Gregg 非常全面地解释了火焰图可视化。Stackdriver Profiler添加了一点自己的特色。</p><figure class="kt ku kv kw fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lo"><img src="../Images/f2a44478310aa6cce02c1499e1846728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QqzFJlV9v7U1s1reYsaXog.png"/></div></div></figure><p id="c107" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将检查一个CPU配置文件，但所有这些也适用于其他配置文件。</p><ol class=""><li id="e04a" class="ke kf hi ih b ii ij im in iq kg iu kh iy ki jc lp kk kl km bi translated">最上面的x轴代表整个程序。火焰上的每个方框代表调用路径上的一个帧。方框的宽度与执行该功能所花费的CPU时间成比例。</li><li id="db4e" class="ke kf hi ih b ii kn im ko iq kp iu kq iy kr jc lp kk kl km bi translated">盒子从左到右排序，左边是开销最大的调用路径。</li><li id="e480" class="ke kf hi ih b ii kn im ko iq kp iu kq iy kr jc lp kk kl km bi translated">来自同一包装的框架具有相同的颜色。在这种情况下，所有运行时函数都用绿色表示。</li><li id="8d23" class="ke kf hi ih b ii kn im ko iq kp iu kq iy kr jc lp kk kl km bi translated">您可以单击任何框来进一步展开执行树。</li></ol><figure class="kt ku kv kw fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lo"><img src="../Images/0c8d6fdc824a7570c6f1b3da98599f82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1jCm6f-Fl2mpkRe3-57mTg.png"/></div></div></figure><p id="6393" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以将鼠标悬停在任何框上，以查看任何帧的详细信息。</p><h2 id="b251" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">过滤</h2><p id="4d3d" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">您可以通过符号名称显示、隐藏和高亮显示。如果你特别想了解某个特定电话或套餐的费用，这些是非常有用的。</p><figure class="kt ku kv kw fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lo"><img src="../Images/9c97e7b6c9a0ec8dd56ab417ca688600.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ka9fA-AAuKggAuIBq_uhGQ.png"/></div></div></figure><ol class=""><li id="cb38" class="ke kf hi ih b ii ij im in iq kg iu kh iy ki jc lp kk kl km bi translated">选择您的过滤器。您可以组合多个过滤器。在这种情况下，我们突出显示runtime.memmove。</li><li id="4c53" class="ke kf hi ih b ii kn im ko iq kp iu kq iy kr jc lp kk kl km bi translated">火焰将使用过滤器过滤帧，并可视化过滤后的框。在本例中，它突出显示了所有的runtime.memmove框。</li></ol></div></div>    
</body>
</html>