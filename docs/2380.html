<html>
<head>
<title>Deploy Gatekeeper policies as OCI image, the GitOps way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以OCI映像、GitOps方式部署网关守护设备策略</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/deploying-gatekeeper-policies-as-oci-artifacts-the-gitops-way-e1233429ae2?source=collection_archive---------4-----------------------#2022-09-23">https://medium.com/google-cloud/deploying-gatekeeper-policies-as-oci-artifacts-the-gitops-way-e1233429ae2?source=collection_archive---------4-----------------------#2022-09-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="13b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">2023年2月10日更新— </em> <a class="ae je" href="https://oras.land/blog/gatekeeper-policies-as-oci-image/" rel="noopener ugc nofollow" target="_blank"> <em class="jd">本帖现精选于ORAS官方博客</em> </a> <em class="jd">！</em>🎉</p><p id="9922" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">2023年1月16日更新，在谷歌云控制台中使用新的配置同步用户界面，列出同步的资源及其状态。</em></p><p id="c5fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">2023年1月10日更新，有一些</em> <code class="du jf jg jh ji b"><em class="jd">gator test</em></code> <em class="jd">的例子。自从</em> <a class="ae je" href="https://github.com/open-policy-agent/gatekeeper/releases/tag/v3.11.0" rel="noopener ugc nofollow" target="_blank"> <em class="jd">版本3.11.0 </em> </a> <em class="jd">以来，我们现在可以直接作为OCI映像测试网守策略，太棒了！</em></p><p id="387e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从<a class="ae je" href="https://cloud.google.com/anthos-config-management/docs/release-notes#September_15_2022" rel="noopener ugc nofollow" target="_blank"> Anthos配置管理1.13.0 </a>开始，除了同步存储在Git仓库中的文件，现在<a class="ae je" href="https://cloud.google.com/blog/products/containers-kubernetes/gitops-with-oci-artifacts-and-config-sync" rel="noopener ugc nofollow" target="_blank">可以用GitOps的方式同步OCI图像和舵图，配置同步</a>。</p><p id="f74a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博客中，让我们看看如何将<a class="ae je" href="https://open-policy-agent.github.io/gatekeeper/website/docs/" rel="noopener ugc nofollow" target="_blank">开放策略代理(OPA)网关守护</a>策略部署为OCI映像，这要归功于<code class="du jf jg jh ji b"><a class="ae je" href="https://oras.land/" rel="noopener ugc nofollow" target="_blank">oras</a></code>、Google工件注册和配置同步。</p><p id="4e3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是你将通过这篇博客实现的目标:</p><ul class=""><li id="45c9" class="jj jk hi ih b ii ij im in iq jl iu jm iy jn jc jo jp jq jr bi translated">创建网关守护设备策略</li><li id="92e1" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">用本地文件测试此策略</li><li id="4f5d" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">创建工件注册库</li><li id="8041" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">将把关者策略(<code class="du jf jg jh ji b">K8sAllowedRepos</code>)作为OCI映像推送到工件注册库</li><li id="2afe" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">使用此远程OCI映像测试此策略</li><li id="9bce" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">使用配置同步和策略控制器设置GKE集群</li><li id="129f" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">使用配置同步将网关守护设备策略部署为OCI映像</li><li id="fcfc" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">在集群中测试该策略</li><li id="2751" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">在结束本博客时，寻找机会创建第二个把关者策略(<code class="du jf jg jh ji b">RSyncAllowedRepos</code>)；)</li></ul><p id="e482" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">为了在这篇博客中说明这一点，我们将利用</em> <a class="ae je" href="https://cloud.google.com/anthos-config-management/docs/concepts/policy-controller" rel="noopener ugc nofollow" target="_blank"> <em class="jd">策略控制器</em> </a> <em class="jd">，但是如果您自己</em> <a class="ae je" href="https://open-policy-agent.github.io/gatekeeper/website/docs/install" rel="noopener ugc nofollow" target="_blank"> <em class="jd">安装OSS网关守护设备</em> </a> <em class="jd">，也可以使用相同的方法。</em></p><figure class="jy jz ka kb fd kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es jx"><img src="../Images/93d5948a8ef9774ecb99a2c172c6688d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HhAOEn_SUWfJ1Or9TxzDJQ.png"/></div></div></figure></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="1670" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">设置环境</h1><p id="aa17" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">以下是你在这篇博客中需要的工具:</p><ul class=""><li id="efd9" class="jj jk hi ih b ii ij im in iq jl iu jm iy jn jc jo jp jq jr bi translated"><code class="du jf jg jh ji b"><a class="ae je" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank">gcloud</a></code></li><li id="12b3" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated"><code class="du jf jg jh ji b"><a class="ae je" href="https://oras.land/cli/" rel="noopener ugc nofollow" target="_blank">oras</a></code></li><li id="0c7a" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated"><code class="du jf jg jh ji b"><a class="ae je" href="https://kubernetes.io/docs/tasks/tools/#kubectl" rel="noopener ugc nofollow" target="_blank">kubectl</a></code></li><li id="5753" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated"><code class="du jf jg jh ji b"><a class="ae je" href="https://open-policy-agent.github.io/gatekeeper/website/docs/gator/" rel="noopener ugc nofollow" target="_blank">gator</a></code></li></ul><p id="a22d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">初始化本博客中使用的公共变量:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="ab00" class="lx kr hi ji b be ly lz l ma mb">PROJECT_ID=FIXME-WITH-YOUR-PROJECT-ID<br/>REGION=us-east4<br/>ZONE=us-east4-a</span></pre><p id="a7e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了避免在整个教程中重复命令中的<code class="du jf jg jh ji b">--project</code>，让我们设置当前项目:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="e50e" class="lx kr hi ji b be ly lz l ma mb">gcloud config set project ${PROJECT_ID}</span></pre></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="9118" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">创建网关守护设备策略</h1><p id="68d5" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">我们创建一个由一个<code class="du jf jg jh ji b">Constraint</code>和一个<code class="du jf jg jh ji b">ConstraintTemplate</code>组成的网关守护设备策略。您可以用自己的策略列表轻松复制这个场景。</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="0393" class="lx kr hi ji b be ly lz l ma mb">mkdir policies</span></pre><p id="af28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">定义一个<code class="du jf jg jh ji b">ConstraintTemplate</code>，它可以确保容器图像以指定列表中的一个字符串开始:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="a1aa" class="lx kr hi ji b be ly lz l ma mb">cat &lt;&lt;EOF&gt; policies/k8sallowedrepos.yaml<br/>apiVersion: templates.gatekeeper.sh/v1<br/>kind: ConstraintTemplate<br/>metadata:<br/>  annotations:<br/>    description: Requires container images to begin with a string from the specified list.<br/>  name: k8sallowedrepos<br/>spec:<br/>  crd:<br/>    spec:<br/>      names:<br/>        kind: K8sAllowedRepos<br/>      validation:<br/>        openAPIV3Schema:<br/>          type: object<br/>          properties:<br/>            repos:<br/>              description: The list of prefixes a container image is allowed to have.<br/>              type: array<br/>              items:<br/>                type: string<br/>  targets:<br/>  - target: admission.k8s.gatekeeper.sh<br/>    rego: |<br/>      package k8sallowedrepos<br/>      violation[{"msg": msg}] {<br/>        container := input.review.object.spec.containers[_]<br/>        satisfied := [good | repo = input.parameters.repos[_] ; good = startswith(container.image, repo)]<br/>        not any(satisfied)<br/>        msg := sprintf("container &lt;%v&gt; has an invalid image repo &lt;%v&gt;, allowed repos are %v", [container.name, container.image, input.parameters.repos])<br/>      }<br/>      violation[{"msg": msg}] {<br/>        container := input.review.object.spec.initContainers[_]<br/>        satisfied := [good | repo = input.parameters.repos[_] ; good = startswith(container.image, repo)]<br/>        not any(satisfied)<br/>        msg := sprintf("initContainer &lt;%v&gt; has an invalid image repo &lt;%v&gt;, allowed repos are %v", [container.name, container.image, input.parameters.repos])<br/>      }<br/>      violation[{"msg": msg}] {<br/>        container := input.review.object.spec.ephemeralContainers[_]<br/>        satisfied := [good | repo = input.parameters.repos[_] ; good = startswith(container.image, repo)]<br/>        not any(satisfied)<br/>        msg := sprintf("ephemeralContainer &lt;%v&gt; has an invalid image repo &lt;%v&gt;, allowed repos are %v", [container.name, container.image, input.parameters.repos])<br/>      }<br/>EOF</span></pre><p id="233a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为<code class="du jf jg jh ji b">Pods</code>定义一个关联的<code class="du jf jg jh ji b">Constraint</code>，该<code class="du jf jg jh ji b">Pods</code>需要其容器映像来自允许的注册中心:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="ce52" class="lx kr hi ji b be ly lz l ma mb">cat &lt;&lt;EOF&gt; policies/pod-allowed-container-registries.yaml<br/>apiVersion: constraints.gatekeeper.sh/v1beta1<br/>kind: K8sAllowedRepos<br/>metadata:<br/>  name: pod-allowed-container-registries<br/>spec:<br/>  enforcementAction: deny<br/>  match:<br/>    kinds:<br/>    - apiGroups:<br/>      - ""<br/>      kinds:<br/>      - Pod<br/>  parameters:<br/>    repos:<br/>    - gcr.io/config-management-release/<br/>    - gcr.io/gkeconnect/<br/>    - gke.gcr.io/<br/>    - ${REGION}-docker.pkg.dev/${PROJECT_ID}/<br/>EOF</span></pre><p id="f4fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">注意:我们允许系统容器图像先用3个</em> <code class="du jf jg jh ji b"><em class="jd">repos</em></code> <em class="jd">。对于最后一个例子，假设您在这个</em> <code class="du jf jg jh ji b"><em class="jd">${REGION}-docker.pkg.dev/${PROJECT_ID}/</em></code> <em class="jd">工件注册存储库中拥有自己的容器映像。</em></p></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="7cd0" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">用本地文件测试此策略</h1><p id="ddff" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">让我们创建一个简单的<code class="du jf jg jh ji b">Pod</code>来测试这个策略:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="095b" class="lx kr hi ji b be ly lz l ma mb">cat &lt;&lt;EOF&gt; nginx-pod.yaml<br/>apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: nginx<br/>spec:<br/>  containers:<br/>  - name: nginx<br/>    image: nginx:latest<br/>    ports:<br/>    - containerPort: 80<br/>EOF</span></pre><p id="55e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们使用<code class="du jf jg jh ji b">gator</code> CLI针对该策略在本地测试这个<code class="du jf jg jh ji b">Pod</code>。不用任何Kubernetes集群就可以非常方便地测试策略！</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="a73b" class="lx kr hi ji b be ly lz l ma mb">gator test -f nginx-pod.yaml -f policies/</span></pre><p id="8eda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输出类似于:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="859c" class="lx kr hi ji b be ly lz l mc mb">["pod-allowed-container-registries"] Message: "container &lt;nginx&gt; has an invalid image repo &lt;nginx:latest&gt;, allowed repos are...</span></pre></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="30be" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">设置工件注册库</h1><p id="038a" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">创建工件注册库:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="b600" class="lx kr hi ji b be ly lz l ma mb">gcloud services enable artifactregistry.googleapis.com<br/>ARTIFACT_REGISTRY_REPO_NAME=oci-artifacts<br/>gcloud artifacts repositories create ${ARTIFACT_REGISTRY_REPO_NAME} \<br/>    --location ${REGION} \<br/>    --repository-format docker</span></pre></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="19e3" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">将网关守护设备策略作为OCI映像推送到工件注册中心</h1><p id="9944" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">登录到工件注册表:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="e6bc" class="lx kr hi ji b be ly lz l ma mb">gcloud auth configure-docker ${REGION}-docker.pkg.dev</span></pre><p id="e23e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<code class="du jf jg jh ji b"><a class="ae je" href="https://oras.land/" rel="noopener ugc nofollow" target="_blank">oras</a></code>在工件注册表中推送网关守护设备策略:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="f351" class="lx kr hi ji b be ly lz l ma mb">oras push \<br/>    ${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REGISTRY_REPO_NAME}/my-policies:1.0.0 \<br/>    policies/</span></pre><p id="d977" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，您的OCI图像已经上传到Google工件注册库中:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="a2c5" class="lx kr hi ji b be ly lz l ma mb">gcloud artifacts docker images list ${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REGISTRY_REPO_NAME}</span></pre></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="2d53" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">使用此远程OCI映像测试此策略</h1><p id="d632" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">现在，让我们使用<code class="du jf jg jh ji b">gator</code> CLI在本地测试之前根据该策略创建的<code class="du jf jg jh ji b">Pod</code>作为远程OCI映像。非常方便地在不同的地方共享和评估您的策略(例如，在本地，在持续集成过程中，等等)。)!</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="4ec1" class="lx kr hi ji b be ly lz l ma mb">gator test -f nginx-pod.yaml -i ${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REGISTRY_REPO_NAME}/my-policies:1.0.0</span></pre><p id="24e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输出类似于:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="5ba8" class="lx kr hi ji b be ly lz l mc mb">["pod-allowed-container-registries"] Message: "container &lt;nginx&gt; has an invalid image repo &lt;nginx:latest&gt;, allowed repos are...</span></pre></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="0404" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">使用配置同步和策略控制器设置GKE集群</h1><p id="d367" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">创建在机群中注册的GKE集群以启用配置管理:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="dd7a" class="lx kr hi ji b be ly lz l ma mb">gcloud services enable container.googleapis.com<br/>CLUSTER_NAME=gatkeeper-oci-cluster<br/>gcloud container clusters create ${CLUSTER_NAME} \<br/>    --workload-pool=${PROJECT_ID}.svc.id.goog \<br/>    --zone ${ZONE}<br/><br/>gcloud services enable gkehub.googleapis.com<br/>gcloud container fleet memberships register ${CLUSTER_NAME} \<br/>    --gke-cluster ${ZONE}/${CLUSTER_NAME} \<br/>    --enable-workload-identity<br/><br/>gcloud beta container fleet config-management enable</span></pre><p id="e49a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在此GKE群集中安装配置同步和策略控制器:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="56b2" class="lx kr hi ji b be ly lz l ma mb">cat &lt;&lt;EOF &gt; acm-config.yaml<br/>applySpecVersion: 1<br/>spec:<br/>  configSync:<br/>    enabled: true<br/>  policyController:<br/>    enabled: true<br/>    templateLibraryInstalled: false<br/>EOF<br/><br/>gcloud beta container fleet config-management apply \<br/>    --membership ${CLUSTER_NAME} \<br/>    --config acm-config.yaml</span></pre><p id="a1ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">注意:在这个场景中，我们没有安装</em> <a class="ae je" href="https://cloud.google.com/anthos-config-management/docs/latest/reference/constraint-template-library" rel="noopener ugc nofollow" target="_blank"> <em class="jd">默认的约束模板库</em> </a> <em class="jd">，因为我们想要部署我们自己的</em> <code class="du jf jg jh ji b"><em class="jd">ConstraintTemplate</em></code> <em class="jd">。</em></p></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="9e1a" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">使用配置同步将网关守护设备策略部署为OCI映像</h1><p id="c84e" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">创建一个专用的Google云服务帐户，对工件注册库进行细粒度的访问(<code class="du jf jg jh ji b">roles/artifactregistry.reader</code>):</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="539f" class="lx kr hi ji b be ly lz l ma mb">OCI_PULLER_GSA_NAME=configsync-oci-sa<br/>OCI_PULLER_GSA_ID=${OCI_PULLER_GSA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com<br/>gcloud iam service-accounts create ${OCI_PULLER_GSA_NAME} \<br/>    --display-name=${OCI_PULLER_GSA_NAME}<br/>gcloud artifacts repositories add-iam-policy-binding ${ARTIFACT_REGISTRY_REPO_NAME} \<br/>    --location $REGION \<br/>    --member "serviceAccount:${OCI_PULLER_GSA_ID}" \<br/>    --role roles/artifactregistry.reader</span></pre><p id="b5ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">允许配置同步同步特定<code class="du jf jg jh ji b">RootSync</code>的资源:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="c0d7" class="lx kr hi ji b be ly lz l ma mb">ROOT_SYNC_NAME=root-sync-policies<br/>gcloud iam service-accounts add-iam-policy-binding \<br/>   --role roles/iam.workloadIdentityUser \<br/>   --member "serviceAccount:${PROJECT_ID}.svc.id.goog[config-management-system/root-reconciler-${ROOT_SYNC_NAME}]" \<br/>   ${OCI_PULLER_GSA_ID}</span></pre><p id="3e96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置配置同步以从工件注册表部署此OCI映像:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="dca8" class="lx kr hi ji b be ly lz l ma mb">cat &lt;&lt; EOF | kubectl apply -f -<br/>apiVersion: configsync.gke.io/v1beta1<br/>kind: RootSync<br/>metadata:<br/>  name: ${ROOT_SYNC_NAME}<br/>  namespace: config-management-system<br/>spec:<br/>  sourceFormat: unstructured<br/>  sourceType: oci<br/>  oci:<br/>    image: ${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REGISTRY_REPO_NAME}/my-policies:1.0.0<br/>    dir: .<br/>    auth: gcpserviceaccount<br/>    gcpServiceAccountEmail: ${OCI_PULLER_GSA_ID}<br/>EOF</span></pre><p id="cd26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过运行命令<code class="du jf jg jh ji b">gcloud alpha anthos config sync resources list</code>或从云控制台导航到<strong class="ih hj"> <em class="jd"> Kubernetes引擎&gt;配置&amp;策略&gt;配置</em> </strong>，列出配置同步所同步的资源及其状态:</p><figure class="jy jz ka kb fd kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es md"><img src="../Images/f86dcf159d03800c950c4e963bc08c8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JLc5UPtHR8jGdLx-Sf1EUg.png"/></div></div></figure><p id="d4f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">瞧啊。这就是以GitOps方式通过配置同步将网关守护设备策略部署为OCI映像的简单之处。</p></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="a4eb" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">在集群中测试该策略</h1><p id="fc7f" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">现在让我们尝试在Kubernetes集群中部署之前创建的<code class="du jf jg jh ji b">Pod</code>:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="90c2" class="lx kr hi ji b be ly lz l ma mb">kubectl apply -f nginx-pod.yaml</span></pre><p id="cb2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输出类似于:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="d4ec" class="lx kr hi ji b be ly lz l mc mb">Error from server (Forbidden): error when creating "nginx-pod.yaml": admission webhook "validation.gatekeeper.sh" denied the request: [pod-allowed-container-registries] container &lt;nginx&gt; has an invalid image repo &lt;nginx:latest&gt;, allowed repos are...</span></pre></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="f221" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">结论</h1><p id="3686" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">在本文中，多亏了<code class="du jf jg jh ji b"><a class="ae je" href="https://oras.land/" rel="noopener ugc nofollow" target="_blank">oras</a></code>，您能够将一个网关守护设备策略(<code class="du jf jg jh ji b">Constraint</code>和<code class="du jf jg jh ji b">ConstraintTemplate</code>)打包成一个OCI映像，并将其推送到Google工件注册表。最后，您看到了如何使用Workload Identity访问Google Artifact Registry，将这个私有OCI映像与Config Sync的<code class="du jf jg jh ji b">RootSync</code>设置中的<code class="du jf jg jh ji b">spec.oci.auth: gcpserviceaccount</code>设置同步。</p><p id="80bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GitOps的持续协调将在现在存储在OCI注册表中的期望状态和运行在Kubernetes中的实际状态之间进行协调。作为OCI映像的网关守护设备策略现在就像从OCI注册中心获取的Kubernetes集群的任何容器映像一样。这种来自OCI注册中心的持续协调(不与Git交互)在可伸缩性、性能和安全性方面有很多好处，因为您将能够跨您的集群配置对OCI映像的细粒度访问。</p></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="a50b" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">准备好接受另一项把关政策了吗？</h1><p id="a341" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">实际上，让我们再一次根据我们刚刚得出的结论创建另一个网关守护设备策略:</p><blockquote class="me mf mg"><p id="ee5d" class="if ig jd ih b ii ij ik il im in io ip mh ir is it mi iv iw ix mj iz ja jb jc hb bi translated">OCI图像现在就像您的Kubernetes集群的任何容器图像一样，因为它们是从OCI注册表中提取的。</p></blockquote><p id="bf28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，让我们也为此创建一个网关守护设备策略，在这里我们可以确保由配置同步拉取的任何OCI映像仅仅来自我们自己的私有工件注册库。</p><p id="cb85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">定义一个<code class="du jf jg jh ji b">ConstraintTemplate</code>，它可以确保OCI图像以指定列表中的一个字符串开始:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="16d6" class="lx kr hi ji b be ly lz l ma mb">cat &lt;&lt;EOF&gt; policies/rsyncallowedrepos.yaml<br/>apiVersion: templates.gatekeeper.sh/v1<br/>kind: ConstraintTemplate<br/>metadata:<br/>  annotations:<br/>    description: Requires OCI images to begin with a string from the specified list.<br/>  name: rsyncallowedrepos<br/>spec:<br/>  crd:<br/>    spec:<br/>      names:<br/>        kind: RSyncAllowedRepos<br/>      validation:<br/>        openAPIV3Schema:<br/>          type: object<br/>          properties:<br/>            repos:<br/>              description: The list of prefixes an OCI image is allowed to have.<br/>              type: array<br/>              items:<br/>                type: string<br/>  targets:<br/>  - target: admission.k8s.gatekeeper.sh<br/>    rego: |<br/>      package rsyncallowedrepos<br/>      violation[{"msg": msg}] {<br/>        image := input.review.object.spec.oci.image<br/>        satisfied := [good | repo = input.parameters.repos[_] ; good = startswith(image, repo)]<br/>        not any(satisfied)<br/>        msg := sprintf("&lt;%v&gt; named &lt;%v&gt; has an invalid image repo &lt;%v&gt;, allowed repos are %v", [input.review.kind.kind, input.review.object.metadata.name, image, input.parameters.repos])<br/>      }<br/>EOF</span></pre><p id="1ec0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为<code class="du jf jg jh ji b"><a class="ae je" href="https://cloud.google.com/anthos-config-management/docs/reference/rootsync-reposync-fields" rel="noopener ugc nofollow" target="_blank">RootSyncs</a></code> <a class="ae je" href="https://cloud.google.com/anthos-config-management/docs/reference/rootsync-reposync-fields" rel="noopener ugc nofollow" target="_blank">和</a> <code class="du jf jg jh ji b"><a class="ae je" href="https://cloud.google.com/anthos-config-management/docs/reference/rootsync-reposync-fields" rel="noopener ugc nofollow" target="_blank">RepoSyncs</a></code>定义一个关联的<code class="du jf jg jh ji b">Constraint</code>，它们需要从允许的注册中心获得它们的OCI映像:</p><pre class="jy jz ka kb fd lt ji lu bn lv lw bi"><span id="660b" class="lx kr hi ji b be ly lz l ma mb">cat &lt;&lt;EOF&gt; policies/rsync-allowed-artifact-registries.yaml<br/>apiVersion: constraints.gatekeeper.sh/v1beta1<br/>kind: RSyncAllowedRepos<br/>metadata:<br/>  name: rsync-allowed-artifact-registries<br/>spec:<br/>  enforcementAction: deny<br/>  match:<br/>    kinds:<br/>    - apiGroups:<br/>      - configsync.gke.io<br/>      kinds:<br/>      - RootSync<br/>      - RepoSync<br/>  parameters:<br/>    repos:<br/>    - ${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REGISTRY_REPO_NAME}<br/>EOF</span></pre><p id="e496" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们不会部署也不会测试这些资源，但是您已经明白了这一点，我们只是增加了更多的治理和安全性。我们现在能够控制集装箱图像和作为OCI图像的Kubernetes清单的来源。很酷，不是吗？！</p></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="9209" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">下一步是什么</h1><ul class=""><li id="1853" class="jj jk hi ih b ii lo im lp iq mk iu ml iy mm jc jo jp jq jr bi translated"><a class="ae je" href="https://cloud.google.com/blog/products/containers-kubernetes/gitops-with-oci-artifacts-and-config-sync" rel="noopener ugc nofollow" target="_blank">使用配置同步</a>以GitOps方式部署OCI工件和舵图</li><li id="2198" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated"><a class="ae je" href="https://cloud.google.com/anthos-config-management/docs/how-to/sync-helm-charts-from-artifact-registry" rel="noopener ugc nofollow" target="_blank">从神器注册表同步舵图</a></li><li id="8fdd" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated"><a class="ae je" href="https://cloud.google.com/anthos-config-management/docs/how-to/sync-oci-artifacts-from-artifact-registry" rel="noopener ugc nofollow" target="_blank">从工件注册表同步OCI工件</a></li><li id="7055" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated"><a class="ae je" rel="noopener" href="/google-cloud/836913e74e79">带有Helm的CI/gitop、GitHub操作、GitHub容器注册和配置同步</a></li><li id="a0cb" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated"><a class="ae je" rel="noopener" href="/google-cloud/b48604191fda">带有Helm的CI/gitop、GitHub操作、Google工件注册表和配置同步</a></li></ul></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><p id="cd22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">原帖</em><a class="ae je" href="https://mathieu-benoit.github.io/" rel="noopener ugc nofollow" target="_blank"><em class="jd">Mathieu-Benoit . github . io</em></a><em class="jd">。</em></p></div></div>    
</body>
</html>