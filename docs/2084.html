<html>
<head>
<title>Introducing Google Cloud Logging Python v3.0.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">介绍Google云日志Python 3 . 0 . 0版</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/introducing-google-cloud-logging-python-v3-0-0-4c548663bab4?source=collection_archive---------0-----------------------#2022-02-02">https://medium.com/google-cloud/introducing-google-cloud-logging-python-v3-0-0-4c548663bab4?source=collection_archive---------0-----------------------#2022-02-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="2b38" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用Google Cloud管理应用程序的Python日志和相关元数据</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ix"><img src="../Images/d0b568f0a67baaa8a1e41becd0760465.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/0*CaMup_vM-C9PnGfe"/></div></figure><p id="26f6" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们很高兴地宣布发布了Google Cloud Python日志库的重大更新！</p><p id="87e5" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">3.0.0版让Python开发人员更容易从Google Cloud发送和读取日志，提供对应用程序中正在发生的事情的实时洞察。如果您是使用Google Cloud的Python开发人员，现在是尝试云日志记录的绝佳时机！</p></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="2a7f" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">如果你对<code class="du ki kj kk kl b"><a class="ae km" href="https://pypi.org/project/google-cloud-logging/" rel="noopener ugc nofollow" target="_blank">google-cloud-logging</a></code>库不熟悉，入门很简单。首先，使用<a class="ae km" href="https://www.google.com/search?q=pip&amp;oq=pip&amp;aqs=chrome..69i57j35i39j0i67l3j69i60j69i65j69i60.1209j0j1&amp;sourceid=chrome&amp;ie=UTF-8" rel="noopener ugc nofollow" target="_blank"> pip </a>下载库:</p><pre class="iy iz ja jb fd kn kl ko kp aw kq bi"><span id="3f00" class="kr ks hi kl b fi kt ku l kv kw">$ pip install "google-cloud-logging&gt;=3.0.0"</span></pre><p id="f32f" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">现在，您可以设置客户端库来使用<a class="ae km" href="https://docs.python.org/3/howto/logging.html" rel="noopener ugc nofollow" target="_blank"> Python的内置“日志”库</a>。这样做将使所有标准Python日志语句开始向Google Cloud发送数据:</p><pre class="iy iz ja jb fd kn kl ko kp aw kq bi"><span id="bd00" class="kr ks hi kl b fi kt ku l kv kw"># set up the Google Cloud Logging python client library<br/>import google.cloud.logging<br/>client = google.cloud.logging.Client()<br/>client.setup_logging()</span><span id="4f8f" class="kr ks hi kl b fi kx ku l kv kw"># use Python’s standard logging library to send logs to GCP<br/>import logging<br/>logging.warning(“Hello World”)</span></pre><p id="5dfb" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们建议<a class="ae km" href="https://googleapis.dev/python/logging/latest/std-lib-integration.html" rel="noopener ugc nofollow" target="_blank">使用标准的Python日志接口</a>来创建日志，如上所示。但是，如果您需要访问其他<a class="ae km" href="https://cloud.google.com/logging" rel="noopener ugc nofollow" target="_blank"> Google Cloud Logging特性</a>(读取日志、管理<a class="ae km" href="https://cloud.google.com/logging/docs/export/configure_export_v2" rel="noopener ugc nofollow" target="_blank">日志接收器</a>等)，您可以<a class="ae km" href="https://googleapis.dev/python/logging/latest/direct-lib-usage.html" rel="noopener ugc nofollow" target="_blank">直接使用Google . Cloud . Logging</a>:</p><pre class="iy iz ja jb fd kn kl ko kp aw kq bi"><span id="dc91" class="kr ks hi kl b fi kt ku l kv kw">import google.cloud.logging<br/>client = google.cloud.logging.Client()<br/>logger = client.logger(name="log_id")</span><span id="764b" class="kr ks hi kl b fi kx ku l kv kw"># read logs from GCP<br/>client.list_entries(max_size=5)</span><span id="c292" class="kr ks hi kl b fi kx ku l kv kw"># write log to GCP<br/>logger.log("hello world", resource={"type":"global", "labels":{}})</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es ky"><img src="../Images/2e589565dd1794b6c124390700772f10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NrBcBgzbFIfDKyYbw3Xf3Q.png"/></div></div></figure><p id="00cb" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">以下是<a class="ae km" href="https://github.com/googleapis/python-logging/blob/eac5e2db83f83b24962524fd9e0d7afa09e2785b/UPGRADING.md" rel="noopener ugc nofollow" target="_blank">新版本</a>的一些主要特性:</p></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="739a" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">支持更多云环境</strong></p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ld"><img src="../Images/15ec746d925b3df6fb078813988c974c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/0*Ga8vwGp1V0JoN1xj"/></div></figure><p id="86a2" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">以前版本的<code class="du ki kj kk kl b">google-cloud-logging</code>只支持<a class="ae km" href="https://cloud.google.com/appengine" rel="noopener ugc nofollow" target="_blank"> App引擎</a>和<a class="ae km" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank"> Kubernetes引擎</a>。用户反映，该库偶尔会在云运行和云功能等无服务器环境中丢弃日志。这是因为库会通过网络批量发送日志。当无服务器环境停止运行时，未发送的批处理可能会丢失。</p><p id="1b7f" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">3.0.0版通过利用GCP内置的<a class="ae km" href="https://cloud.google.com/logging/docs/structured-logging" rel="noopener ugc nofollow" target="_blank">结构化JSON日志功能</a> (GKE、云运行或云函数)修复了这个问题。如果该库检测到它运行在支持结构化日志记录的环境中，它将自动使用新的<code class="du ki kj kk kl b"><a class="ae km" href="https://googleapis.dev/python/logging/latest/handlers-structured-log.html" rel="noopener ugc nofollow" target="_blank">StructuredLogHandler</a>,</code>来将日志作为JSON字符串输出到标准输出。然后，Google Cloud的内置代理将解析日志，并将其提交给云日志记录，即使生成日志的代码已经停止运行。</p><p id="5ae6" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">结构化日志记录在无服务器环境中更加可靠，它允许我们在3.0.0版中支持所有主要的GCP计算环境。但是，如果您喜欢像以前一样通过网络发送日志，您可以使用<code class="du ki kj kk kl b"><a class="ae km" href="https://googleapis.dev/python/logging/latest/handlers-cloud-logging.html" rel="noopener ugc nofollow" target="_blank">CloudLoggingHandler</a></code>实例手动设置该库:</p><pre class="iy iz ja jb fd kn kl ko kp aw kq bi"><span id="2eb1" class="kr ks hi kl b fi kt ku l kv kw">from google.cloud.logging.handlers import CloudLoggingHandler<br/>from google.cloud.logging_v2.handlers import setup_logging</span><span id="71ea" class="kr ks hi kl b fi kx ku l kv kw"># explicitly set up a CloudLoggingHandler to send logs over the network</span><span id="5676" class="kr ks hi kl b fi kx ku l kv kw">handler = CloudLoggingHandler(client)<br/>setup_logging(handler)</span><span id="2692" class="kr ks hi kl b fi kx ku l kv kw">import logging<br/>logging.warning(“Hello World”)</span></pre></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="6ff9" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">元数据自动检测</strong></p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es le"><img src="../Images/36d0a65e3b0e1db041c4d2291efe7429.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*rt-VSlMYhRIk_Srb0Jesvg.png"/></div></figure><p id="466c" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在对应用程序进行故障排除时，在应用程序日志中获取尽可能多的环境信息会很有用。<code class="du ki kj kk kl b">google-cloud-logging</code>试图通过检测和附加关于您的环境的元数据到每个日志消息来帮助这个过程。目前支持以下字段:</p><ul class=""><li id="5cec" class="lf lg hi jh b ji jj jl jm jo lh js li jw lj ka lk ll lm ln bi translated"><code class="du ki kj kk kl b"><a class="ae km" href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/MonitoredResource" rel="noopener ugc nofollow" target="_blank">resource</a></code>:日志来源于<br/>的Google云资源——例如，函数、GKE或云运行</li><li id="9926" class="lf lg hi jh b ji lo jl lp jo lq js lr jw ls ka lk ll lm ln bi translated"><code class="du ki kj kk kl b"><a class="ae km" href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry#HttpRequest" rel="noopener ugc nofollow" target="_blank">httpRequest</a></code>:关于日志上下文中HTTP请求的信息<br/>——目前支持Flask和Django</li><li id="fd88" class="lf lg hi jh b ji lo jl lp jo lq js lr jw ls ka lk ll lm ln bi translated"><code class="du ki kj kk kl b"><a class="ae km" href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry#LogEntrySourceLocation" rel="noopener ugc nofollow" target="_blank">sourceLocation</a></code>:文件、行和函数名</li><li id="74f6" class="lf lg hi jh b ji lo jl lp jo lq js lr jw ls ka lk ll lm ln bi translated"><code class="du ki kj kk kl b"><a class="ae km" href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry" rel="noopener ugc nofollow" target="_blank">trace</a></code>、<code class="du ki kj kk kl b"><a class="ae km" href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry" rel="noopener ugc nofollow" target="_blank">spanId</a></code>、<code class="du ki kj kk kl b"><a class="ae km" href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry" rel="noopener ugc nofollow" target="_blank">traceSampled</a></code> : <a class="ae km" href="https://cloud.google.com/trace" rel="noopener ugc nofollow" target="_blank">云跟踪</a>元数据<br/>–支持<a class="ae km" href="https://cloud.google.com/trace/docs/setup#force-trace" rel="noopener ugc nofollow" target="_blank"> X-Cloud-Trace-Context </a>和<a class="ae km" href="https://www.w3.org/TR/trace-context/#traceparent-header" rel="noopener ugc nofollow" target="_blank"> w3c透明</a>跟踪格式</li></ul><p id="4e33" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">该库将尽可能尝试填充这些数据，但开发人员也可以使用该库显式设置这些字段:</p><pre class="iy iz ja jb fd kn kl ko kp aw kq bi"><span id="6259" class="kr ks hi kl b fi kt ku l kv kw">logging.info("hello", extra={<br/>    "labels": {"foo": "bar"},<br/>    "http_request": {"requestUrl": "localhost"},<br/>    "trace": "01234"<br/>})</span></pre></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><h2 id="c6bb" class="kr ks hi bd lt lu lv lw lx ly lz ma mb jo mc md me js mf mg mh jw mi mj mk ml bi translated"><strong class="ak">标准库集成中的JSON支持</strong></h2><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mm"><img src="../Images/70ce72da86c45333c98ce1c4b45b3aa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*OA4S9WkQswXSgc6x3Krv8Q.png"/></div></figure><p id="dc07" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">Google Cloud Logging支持LogEntries的<a class="ae km" href="https://cloud.google.com/logging/docs/structured-logging" rel="noopener ugc nofollow" target="_blank">字符串和JSON有效负载</a>，但是到目前为止，<a class="ae km" href="https://googleapis.dev/python/logging/latest/std-lib-integration.html" rel="noopener ugc nofollow" target="_blank"> Python标准库集成</a>只能发送带有字符串有效负载的日志。</p><p id="5433" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在“Google-cloud-logging”3 . 0 . 0版中，可以用两种方式记录JSON数据:</p><ol class=""><li id="6784" class="lf lg hi jh b ji jj jl jm jo lh js li jw lj ka mn ll lm ln bi translated">记录一个JSON可解析的字符串:</li></ol><pre class="iy iz ja jb fd kn kl ko kp aw kq bi"><span id="284d" class="kr ks hi kl b fi kt ku l kv kw">import logging<br/>import json</span><span id="4c89" class="kr ks hi kl b fi kx ku l kv kw">data_dict = {"hello": "world"}<br/>logging.info(json.dumps(data_dict))</span></pre><ol class=""><li id="5c2d" class="lf lg hi jh b ji jj jl jm jo lh js li jw lj ka mn ll lm ln bi translated">使用Python日志记录的“extra”参数传递“json_fields”字典:</li></ol><pre class="iy iz ja jb fd kn kl ko kp aw kq bi"><span id="72e5" class="kr ks hi kl b fi kt ku l kv kw">import logging</span><span id="386a" class="kr ks hi kl b fi kx ku l kv kw">data_dict = {"hello": "world"}<br/>logging.info("message field", extra={"json_fields": data_dict})</span></pre></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><h2 id="56bd" class="kr ks hi bd lt lu lv lw lx ly lz ma mb jo mc md me js mf mg mh jw mi mj mk ml bi translated">后续步骤</h2><ul class=""><li id="6d45" class="lf lg hi jh b ji mo jl mp jo mq js mr jw ms ka lk ll lm ln bi translated">有关最新版本的更多信息，请查看完整的<a class="ae km" href="https://googleapis.dev/python/logging/latest/UPGRADING.html" rel="noopener ugc nofollow" target="_blank"> v3.0.0迁移指南</a></li><li id="923c" class="lf lg hi jh b ji lo jl lp jo lq js lr jw ls ka lk ll lm ln bi translated">有关开发者文档，请参见<code class="du ki kj kk kl b"><a class="ae km" href="https://googleapis.dev/python/logging/latest/index.html" rel="noopener ugc nofollow" target="_blank">google-cloud-logging</a></code> <a class="ae km" href="https://googleapis.dev/python/logging/latest/index.html" rel="noopener ugc nofollow" target="_blank">用户指南</a></li><li id="1200" class="lf lg hi jh b ji lo jl lp jo lq js lr jw ls ka lk ll lm ln bi translated">如果您对最新版本有任何反馈，或者想做出任何贡献，请随时在<a class="ae km" href="https://github.com/googleapis/python-logging" rel="noopener ugc nofollow" target="_blank">我们的GitHub repo </a>上提出问题</li><li id="620c" class="lf lg hi jh b ji lo jl lp jo lq js lr jw ls ka lk ll lm ln bi translated">如果您想了解在GCP上检测代码的可观测性和可靠运行工作负载的最佳实践，请尝试<a class="ae km" href="https://cloud-ops-sandbox.dev/" rel="noopener ugc nofollow" target="_blank">云操作沙箱</a></li></ul></div></div>    
</body>
</html>