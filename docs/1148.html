<html>
<head>
<title>Using Google Cloud Key Management Service with Dataflow Templates</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过数据流模板使用谷歌云密钥管理服务</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-google-cloud-key-management-service-with-dataflow-templates-71924f0f841f?source=collection_archive---------0-----------------------#2019-09-16">https://medium.com/google-cloud/using-google-cloud-key-management-service-with-dataflow-templates-71924f0f841f?source=collection_archive---------0-----------------------#2019-09-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a706" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">作者:</strong> <a class="ae jd" rel="noopener" href="/@theodoresiu7">萧万长，</a> <a class="ae jd" rel="noopener" href="/@saabhyankar">萨梅尔·阿比扬卡</a></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/83f3bf83499c9f50e729846378f7e32e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qhp6_kX7lCe6K1D5pLJN5A.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">数据流接受并显示运行时参数，而不区分参数是否敏感。我们依靠GCP密钥管理服务(KMS)来加密/解密这些字段，以增加额外的安全层。</figcaption></figure></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><p id="3587" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们注意到，对于Google提供的数据流模板，即JDBCToBigQuery模板，传入的一些运行时参数是敏感字段。因此，这些字段可以在Dataflow Jobs UI页面上使用，也可以通过Dataflow.jobs.get API调用使用。请参见图1中UI中公开字段的示例。不幸的是，在这个时候，数据流没有一个内置的方法来隐藏秘密(密码等)。)通过管道选项传递。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kb"><img src="../Images/d57d059a26fb1ca6862c90ad69e82ddc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wQ8KcV4qepqrF6IHzLncHg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">将敏感参数和秘密作为数据流选项传入会在UI上公开它们</figcaption></figure><p id="9860" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此问题的快速解决方法包括:</p><ol class=""><li id="b002" class="kc kd hi ih b ii ij im in iq ke iu kf iy kg jc kh ki kj kk bi translated">将敏感字段嵌入模板本身。不幸的是，在编译模板时，尽管没有显示为参数，但仍然可以在模板文件中找到这些字段。此外，硬编码值会使模板失去通用性。</li><li id="92ca" class="kc kd hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">使用位于GCS中的配置blob文件来存储和读取敏感字段。这需要对代码进行一些调整，敏感字段仍然存在于GCP的其他地方。</li></ol><p id="eaa2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们最终同意的最后一个变通方法是使用Google Cloud Key Management服务来加密我们的字段，并在数据流作业期间传递加密的字段进行解密。以这种方式，我们没有四处传递秘密，而秘密在另一个GCP资源中是不可获得的。我们在模板中加入了向后兼容性，以方便那些希望继续使用原始模板的用户(尽管我们强烈反对这样做！).</p><h1 id="84d5" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">入门指南</h1><p id="3dcb" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated"><strong class="ih hj">先决条件:</strong>在开始工作之前，请确保谷歌云密钥管理服务(KMS) API已经在您的项目中启用。还要确保您作为用户拥有cloudkms.admin IAM角色或至少拥有cloudkms.editor角色，以便创建您自己的密钥/密钥环。请注意，cloudkms.encrypter/decrypter角色与密钥创建是分开的，也需要添加。我们将在下面这样做。</p><p id="9d15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了在JDBCToBigQuery模板中使用GCP KMS，首先必须创建一个KMS密匙环和对称密匙。这可以在GCP控制台的安全&gt;&gt;加密密钥选项卡下完成。确保创建一个环和一个属于该环的对称密钥！创建密钥后:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lt"><img src="../Images/139127384a063e1b7f0ef8243afbfd9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4P3IFqP0_XbbhmhCXFErSw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图2:向您的数据流服务帐户和您自己添加cryptoKeyEncrypterDecrypter角色。请注意，云KMS管理员没有加密器/解密器权限</figcaption></figure><ol class=""><li id="e631" class="kc kd hi ih b ii ij im in iq ke iu kf iy kg jc kh ki kj kk bi translated">确保您拥有正确的IAM角色来加密和解密密钥。要更新的两个帐户包括您自己和运行数据流作业的服务帐户。将角色roles/cloud kms . cryptokeyencrypter添加到这两个帐户中。这也可以在UI中完成。请参见图2，了解如何在GCP KMS用户界面上做到这一点。</li><li id="646a" class="kc kd hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">为了让KMS加密你的敏感参数，它们必须首先被转换成base64编码的字符串。要转换字符串，打开Python3并运行以下命令</li></ol><pre class="jf jg jh ji fd lu lv lw lx aw ly bi"><span id="cd8c" class="lz kr hi lv b fi ma mb l mc md">import base64<br/>base64.b64encode(b'mystringthatIwanttoencode')</span></pre><p id="721a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果使用Python2，可以运行下面的命令。</p><pre class="jf jg jh ji fd lu lv lw lx aw ly bi"><span id="fca1" class="lz kr hi lv b fi ma mb l mc md">'mystringthatIwanttoencode'.encode('base64').rstrip('\n')</span></pre><p id="bf2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意Python2代码中的右边一条<code class="du me mf mg lv b">\n</code>或新行字符。新的一行被自动追加到编码中，不需要，所以我们把它去掉。</p><p id="f0a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.使用KMS API来加密你的敏感参数。输入您的密钥名，其格式应为<code class="du me mf mg lv b">projects/*/locations/*/keyRings/*/cryptoKeys/*</code>，并在明文字段下输入您希望加密的参数<strong class="ih hj">，该参数已经转换为base64编码的字符串(参见步骤2) </strong>。对于JDBCToBigQuery模板，您需要加密<code class="du me mf mg lv b">username</code>、<code class="du me mf mg lv b">password</code>和<code class="du me mf mg lv b">connectionURL</code>。加密值作为base64编码的字符串返回。有关API的更多细节，请参见图3。请注意，如果不希望使用API UI，也可以运行以下形式的CURL命令:</p><pre class="jf jg jh ji fd lu lv lw lx aw ly bi"><span id="efa7" class="lz kr hi lv b fi ma mb l mc md">curl -s -X POST "https://cloudkms.googleapis.com/v1/projects/myproj/locations/mylocation/keyRings/keyring1/cryptoKeys/mykey:encrypt"  -d "{\"plaintext\":\"PasteBase64EncodedString\"}"  -H "Authorization:Bearer $(gcloud auth application-default print-access-token)"  -H "Content-Type:application/json"</span></pre><p id="7a83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.当运行JDBCToBigQueryTemplate时，将您的<code class="du me mf mg lv b">KMSEncryptionKey</code>设置为与您用于加密的形式<code class="du me mf mg lv b">projects/*/locations/*/keyRings/*/cryptoKeys/*</code>相同的对称密钥。对于<code class="du me mf mg lv b">username</code>、<code class="du me mf mg lv b">password</code>和<code class="du me mf mg lv b">connectionURL</code>，不用正常输入，而是使用你的加密值。运行您的数据流作业！</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mh"><img src="../Images/a56bee5b8daadfa6ef3e0d236e11ad8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zGfvTc9d_dg5e2hijNPvrQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图3:使用GCP KMS API来加密您的敏感参数。在name参数下传入您的密钥名，在请求体的plaintext参数下传入to be encrypted string参数。</figcaption></figure><h1 id="d242" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">它如何工作和未来的工作</h1><p id="4bf0" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">我们创建了一个<a class="ae jd" href="https://github.com/GoogleCloudPlatform/DataflowTemplates/blob/master/src/main/java/com/google/cloud/teleport/util/KMSEncryptedNestedValueProvider.java" rel="noopener ugc nofollow" target="_blank">KMSEncryptedNestedValueProvider</a>，它接受两个参数——普通字段，如<code class="du me mf mg lv b">username</code> ValueProvider和KMS加密密钥ValueProvider。如果KMS加密密钥为空，则正常字段被认为是未加密的，并被用作实际值。如果KMS加密密钥存在，我们使用该密钥来解密普通字段，并使用KMS解密的值。该逻辑应用于<a class="ae jd" href="https://github.com/GoogleCloudPlatform/DataflowTemplates/blob/master/src/main/java/com/google/cloud/teleport/templates/JdbcToBigQuery.java" rel="noopener ugc nofollow" target="_blank"> JDBCToBigQuery模板</a>中的<code class="du me mf mg lv b">username</code>、<code class="du me mf mg lv b">password</code>和<code class="du me mf mg lv b">connectionURL</code>字段。</p><p id="6c98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在数据流中使用敏感参数时，牢记安全性非常重要。使用GCP KMS增加了一层额外的保护，从无意中的目光，导致意外暴露凭证。请随意将相同的逻辑添加到您的其他数据流模板和光束作业中！</p></div></div>    
</body>
</html>