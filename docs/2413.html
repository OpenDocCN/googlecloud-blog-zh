<html>
<head>
<title>Workflows that pause and wait for human approvals from Google Sheets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">暂停并等待Google Sheets人工批准的工作流</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/workflows-that-pause-and-wait-for-human-approvals-from-google-sheets-53673ced2a81?source=collection_archive---------0-----------------------#2022-10-10">https://medium.com/google-cloud/workflows-that-pause-and-wait-for-human-approvals-from-google-sheets-53673ced2a81?source=collection_archive---------0-----------------------#2022-10-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6f7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我已经写了一系列的文章来展示谷歌工作空间(T2)和谷歌云(T4)的整合。</p><p id="76ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的第一篇文章<a class="ae jd" href="https://atamel.dev/posts/2022/09-09_trigger_workflows_from_sheets/" rel="noopener ugc nofollow" target="_blank">中，我展示了一个IT自动化用例，其中一个Google Sheets电子表格触发了一个工作流，在Google Cloud中创建虚拟机。在第二篇</a><a class="ae jd" href="https://atamel.dev/posts/2022/09-26_writing_google_sheets_from_workflows/" rel="noopener ugc nofollow" target="_blank">文章</a>中，我展示了如何使用工作流向Google Sheets电子表格提供来自BigQuery的数据。</p><p id="ef8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个系列的第三篇也是最后一篇文章中，我将展示如何设计一个暂停并等待来自Google Sheets的人工批准的工作流。</p><h1 id="3de6" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">用例</h1><p id="61f6" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">通过工作流<a class="ae jd" href="https://cloud.google.com/workflows/docs/creating-callback-endpoints" rel="noopener ugc nofollow" target="_blank">回调</a>，工作流可以创建一个HTTP端点并暂停执行，直到它接收到对该端点的HTTP回调。这对于创建中间型工作流非常有用。然而，在人类能够发送该批准之前，可能需要相当多的设置。工作流必须创建回调URL，然后工作流必须以某种方式通知前端该URL是什么，最后前端必须使用户能够批准并发送回调。</p><p id="c755" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">是否有更简单的方法让用户能够发送这些批准回调？</strong>当然有！你可以使用Google Sheets作为审批前端。</p><p id="1c22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">想法是这样的:</p><ol class=""><li id="ad39" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">工作流运行一些初始步骤。</li><li id="020d" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">该工作流创建一个回调，将回调信息保存到Google Sheets电子表格中，并开始等待人们对其剩余步骤的批准。</li><li id="052a" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">一个人通过Google Sheets电子表格发送他/她的批准。</li><li id="8ea4" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">工作流接收批准并运行其余步骤。</li></ol><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/8f82e7fdd6cb6939bc96cf922f6d614d.png" data-original-src="https://miro.medium.com/v2/resize:fit:878/0*JNCsPDD62kLptlCe"/></div></div></figure><p id="af0f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们更详细地看一下每个步骤。</p><h1 id="de22" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">创建一个谷歌工作表电子表格</h1><p id="10be" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">首先，创建一个Google Sheet电子表格来捕获回调批准请求。电子表格可以包含您认为批准请求所必需的任何信息。</p><p id="a807" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个电子表格示例:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lh"><img src="../Images/ebe00274cf328d3b094db3e31969b917.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*D7QZDwRKYSeU-m-u"/></div></div></figure><p id="441d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du li lj lk ll b">Approved</code>列将用于启动对工作流的回调。</p><p id="2639" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建工作表后，记下电子表格id，稍后在工作流程中会用到它。您可以在电子表格的URL中找到工作表id:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lm"><img src="../Images/b5064af8381de743377bffa578a5b425.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_6go77waLOAy8VM5"/></div></div></figure><p id="9f62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">稍后，为简单起见，您将使用默认计算服务帐户部署工作流。通过访问谷歌云控制台的<code class="du li lj lk ll b">IAM &amp; Admin -&gt; Service Accounts</code>部分找到该服务帐户的电子邮件地址:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ln"><img src="../Images/321a64dec7f92e98668e949365336a31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*58UJT2Wo6amYOr-a"/></div></div></figure><p id="ddbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确定服务帐户拥有电子表格的写入权限:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lo"><img src="../Images/4c5ba362c8547b553f925a86587e894c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oCkfIeMCogYNSYzQ"/></div></div></figure><h1 id="06bc" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">创建应用程序脚本</h1><p id="119b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">创建一个应用程序脚本来观察<code class="du li lj lk ll b">Approved</code>列中的变化。</p><p id="259b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到电子表格中的<code class="du li lj lk ll b">Extensions</code>和<code class="du li lj lk ll b">Apps Script</code>。这将打开应用程序脚本编辑器。将<code class="du li lj lk ll b">Code.gs</code>中的默认代码替换为<a class="ae jd" href="https://github.com/GoogleCloudPlatform/workflows-demos/blob/master/workspace-integration/workflows-awaits-sheets-callback/Code.gs" rel="noopener ugc nofollow" target="_blank"> Code.gs </a>中的代码，点击<code class="du li lj lk ll b">Save</code>。</p><p id="73cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该代码监视<code class="du li lj lk ll b">Approved</code>列中的变化。当该列中的一个单元格被设置为<code class="du li lj lk ll b">TRUE</code>时，它将调用带有批准者信息的工作流回调URL。</p><p id="5116" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在应用程序脚本编辑器中，转到<code class="du li lj lk ll b">Settings</code>并选择<code class="du li lj lk ll b">Show appsscript.json manifest file in editor</code>。用<a class="ae jd" href="https://github.com/GoogleCloudPlatform/workflows-demos/blob/master/workspace-integration/workflows-awaits-sheets-callback/appscript.json" rel="noopener ugc nofollow" target="_blank"> appsscript.json </a>替换<code class="du li lj lk ll b">appsscript.json</code>的内容。这确保了Apps脚本具有所需的权限。</p><p id="0661" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到<code class="du li lj lk ll b">Triggers</code>部分，在编辑工作表时创建一个从工作表到Apps脚本的触发器:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es lp"><img src="../Images/0f77f3a997b47ba9939db0a6edf17b5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/0*ySK1twMK_RT9vg9-"/></div></figure><h1 id="42eb" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">创建工作流</h1><p id="c748" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">创建一个<a class="ae jd" href="https://github.com/GoogleCloudPlatform/workflows-demos/blob/master/workspace-integration/workflows-awaits-sheets-callback/workflow.yaml" rel="noopener ugc nofollow" target="_blank"> workflow.yaml </a>来运行一些初始步骤，等待回调，并且(一旦收到回调)运行更多的步骤。确保用您自己的id替换工作表id:</p><pre class="kw kx ky kz fd lq ll lr ls aw lt bi"><span id="5625" class="lu jf hi ll b fi lv lw l lx ly">main:<br/>  steps:<br/>    - init:<br/>        assign:<br/>        # Replace with your sheetId and make sure the service account<br/>        # for the workflow has write permissions to the sheet<br/>        - sheetId: "10hieAH6b-oMeIVT_AerSLNxQck14IGhgi8ign-x2x8g"<br/>    - before_sheets_callback:<br/>        call: sys.log<br/>        args:<br/>          severity: INFO<br/>          data: ${"Execute steps here before waiting for callback from sheets"}<br/>    - wait_for_sheets_callback:<br/>        call: await_callback_sheets<br/>        args:<br/>          sheetId: ${sheetId}<br/>        result: await_callback_result<br/>    - after_sheets_callback:<br/>        call: sys.log<br/>        args:<br/>          severity: INFO<br/>          data: ${"Execute steps here after receiving callback from sheets"}<br/>    - returnResult:<br/>        return: ${await_callback_result}</span></pre><p id="95d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du li lj lk ll b">await_callback_sheets</code>子工作流接收一个工作表id，创建一个回调，将回调保存到Google工作表，并等待回调:</p><pre class="kw kx ky kz fd lq ll lr ls aw lt bi"><span id="4fa1" class="lu jf hi ll b fi lv lw l lx ly">await_callback_sheets:<br/>    params: [sheetId]<br/>    steps:<br/>        - init:<br/>            assign:<br/>              - project_id: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}<br/>              - location: ${sys.get_env("GOOGLE_CLOUD_LOCATION")}<br/>              - workflow_id: ${sys.get_env("GOOGLE_CLOUD_WORKFLOW_ID")}<br/>              - execution_id: ${sys.get_env("GOOGLE_CLOUD_WORKFLOW_EXECUTION_ID")}<br/>        - create_callback:<br/>            call: events.create_callback_endpoint<br/>            args:<br/>              http_callback_method: POST<br/>            result: callback_details<br/>        - save_callback_to_sheets:<br/>            call: googleapis.sheets.v4.spreadsheets.values.append<br/>            args:<br/>                range: ${"Sheet1!A1:G1"}<br/>                spreadsheetId: ${sheetId}<br/>                valueInputOption: RAW<br/>                body:<br/>                    majorDimension: "ROWS"<br/>                    values:<br/>                      - ["${project_id}", "${location}", "${workflow_id}", "${execution_id}", "${callback_details.url}", "", "FALSE"]<br/>        - log_and_await_callback:<br/>            try:<br/>              steps:<br/>                - log_await_start:<br/>                    call: sys.log<br/>                    args:<br/>                      severity: INFO<br/>                      data: ${"Started waiting for callback from sheet " + sheetId}<br/>                - await_callback:<br/>                    call: events.await_callback<br/>                    args:<br/>                      callback: ${callback_details}<br/>                      timeout: 3600<br/>                    result: callback_request<br/>                - log_await_stop:<br/>                    call: sys.log<br/>                    args:<br/>                      severity: INFO<br/>                      data: ${"Stopped waiting for callback from sheet " + sheetId}<br/>            except:<br/>                as: e<br/>                steps:<br/>                    - log_error:<br/>                        call: sys.log<br/>                        args:<br/>                            severity: "ERROR"<br/>                            text: ${"Received error " + e.message}<br/>        - check_null_await_result:<br/>            switch:<br/>              - condition: ${callback_request == null}<br/>                return: null<br/>        - log_await_result:<br/>            call: sys.log<br/>            args:<br/>              severity: INFO<br/>              data: ${"Approved by " + callback_request.http_request.body.approver}<br/>        - return_await_result:<br/>            return: ${callback_request.http_request.body}</span></pre><h1 id="c860" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">部署工作流</h1><p id="e0de" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">确保您有一个Google Cloud项目，并且在<code class="du li lj lk ll b">gcloud</code>中设置了项目id:</p><pre class="kw kx ky kz fd lq ll lr ls aw lt bi"><span id="2a9b" class="lu jf hi ll b fi lv lw l lx ly">PROJECT_ID =your-project-id <br/>gcloud config set project $PROJECT_ID</span></pre><p id="fd5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行<a class="ae jd" href="https://github.com/GoogleCloudPlatform/workflows-demos/blob/master/workspace-integration/workflows-awaits-sheets-callback/setup.sh" rel="noopener ugc nofollow" target="_blank"> setup.sh </a>启用所需服务，部署<a class="ae jd" href="https://github.com/GoogleCloudPlatform/workflows-demos/blob/master/workspace-integration/workflows-awaits-sheets-callback/workflow.yaml" rel="noopener ugc nofollow" target="_blank"> workflow.yaml </a>中定义的工作流。</p><h1 id="6a71" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">运行工作流</h1><p id="9dc3" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">您现在已经准备好测试端到端的流程了。</p><p id="4e5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从谷歌云控制台或<code class="du li lj lk ll b">gcloud</code>运行工作流:</p><pre class="kw kx ky kz fd lq ll lr ls aw lt bi"><span id="6e56" class="lu jf hi ll b fi lv lw l lx ly">gcloud workflows run workflows-awaits-callback-sheets</span></pre><p id="5a60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该看到工作流正在运行并等待回调:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es et"><img src="../Images/8cb6cdc8ec1032484f8056eec8e67b3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*q9SGwqsX9rwfnEIt"/></div></div></figure><p id="234e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">日志还显示工作流正在等待:</p><pre class="kw kx ky kz fd lq ll lr ls aw lt bi"><span id="0777" class="lu jf hi ll b fi lv lw l lx ly">Info<br/>2022-09-27 09:58:00.892 BST Execute steps here before waiting for callback from sheets<br/>Info<br/>2022-09-27 09:58:01.887 BST Started waiting for callback from sheet 10hieAH6b-oMeIVT_AerSLNxQck14IGhgi8ign-x2x8g</span></pre><p id="56ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回到床单上；您应该看到工作流附加的回调信息，其中<code class="du li lj lk ll b">Approved</code>列设置为<code class="du li lj lk ll b">FALSE</code>:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lz"><img src="../Images/fcd9d7acef91a0ba176c5d19414ef381.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WzBjXyiBk724i0TF"/></div></div></figure><p id="fae6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，添加批准人姓名/电子邮件，并将<code class="du li lj lk ll b">Approved</code>列更改为<code class="du li lj lk ll b">TRUE</code>:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ma"><img src="../Images/06cead5cab4791bea72a27e3c121e1b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EJcqSel5QO9Q7jbU"/></div></div></figure><p id="aa13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该看到工作流执行状态现在是<code class="du li lj lk ll b">Succeeded</code>:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mb"><img src="../Images/6a5505facbe7e3b5ed5eee1d9ae2b63f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4lrfYTAYFoB_C7UM"/></div></div></figure><p id="0d3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">日志还显示工作流已批准并完成:</p><pre class="kw kx ky kz fd lq ll lr ls aw lt bi"><span id="75ad" class="lu jf hi ll b fi lv lw l lx ly">Info<br/>2022-09-27 10:04:11.101 BST Approved by Mete Atamel<br/>Info<br/>2022-09-27 10:04:11.442 BST Execute steps here after receiving callback from sheets</span></pre></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="c0a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回调对于创建人在回路类型的工作流特别有用。Google Sheets为用户提供了一个随时可用的前端来提供他们的批准，Apps Script为开发人员提供了一个简单的方法来通知正在等待回调恢复的工作流。</p><p id="e011" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如有疑问或反馈，欢迎在Twitter <a class="ae jd" href="https://twitter.com/meteatamel" rel="noopener ugc nofollow" target="_blank"> @meteatamel </a>上联系我。</p></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="f6dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="mj">最初发布于</em><a class="ae jd" href="https://atamel.dev/posts/2022/10-10_workflows_wait_approvals_sheets/" rel="noopener ugc nofollow" target="_blank"><em class="mj">https://atamel . dev</em></a><em class="mj">。</em></p></div></div>    
</body>
</html>