<html>
<head>
<title>Cloud Run: Hot reload your Secret Manager secrets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云运行:热重装您的秘密经理的秘密</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-run-hot-reload-your-secret-manager-secrets-ff2c502df666?source=collection_archive---------1-----------------------#2022-12-21">https://medium.com/google-cloud/cloud-run-hot-reload-your-secret-manager-secrets-ff2c502df666?source=collection_archive---------1-----------------------#2022-12-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/20ba922f6030dac47c102efb7edb5b08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sOK1HFaJyoqM6IRk3ETMHA.png"/></div></div></figure><p id="9cc5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于任何类型的服务和环境，安全性都是至关重要的。存在安全地大规模地<strong class="is hj">托管、管理和提供机密的解决方案。在谷歌云上，<a class="ae jo" href="https://cloud.google.com/secret-manager" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">秘密管理器</strong> </a> <strong class="is hj">是专门负责秘密管理的原生服务</strong>。</strong></p><p id="ec4b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了简化访问秘密，<strong class="is hj"> Secret Manager被直接集成</strong>在一些Google云服务中，如Cloud Build、Cloud Functions和Cloud Run。</p><p id="1842" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">【了解云跑？查看<br/> </strong> <a class="ae jo" href="http://bit.ly/CloudRunVerify" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">使用新的专用运行时间检查</strong> </a> <strong class="is hj">验证云运行服务的可用性。】</strong></p><p id="c22a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，通常的秘密管理需要<strong class="is hj">改变、轮换和更新秘密</strong></p><blockquote class="jp"><p id="8188" class="jq jr hi bd js jt ju jv jw jx jy jn dx translated">如何在云运行实例中获得最新的秘密版本，没有延迟，不需要重新启动它们？</p></blockquote><h1 id="32c3" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">秘密的最佳实践</h1><p id="f4a5" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">其中最重要的一条规则是:“<strong class="is hj">秘密必须保密。为此，秘密管理器服务通过IAM服务确保<strong class="is hj">加密</strong> <a class="ae jo" href="https://cloud.google.com/secret-manager/docs/encryption" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> </strong>静止</a>和<a class="ae jo" href="https://cloud.google.com/docs/security/encryption-in-transit" rel="noopener ugc nofollow" target="_blank">传输</a>以及<strong class="is hj">访问许可</strong> <a class="ae jo" href="https://cloud.google.com/secret-manager/docs/access-control" rel="noopener ugc nofollow" target="_blank">。</a></strong></p><p id="8a51" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，对于长期存在的秘密(如密码或API密钥)，建议<strong class="is hj">定期轮换和更新秘密</strong>(Google Cloud文档中提到的<em class="lc">关于</em> <a class="ae jo" href="https://cloud.google.com/kms/docs/key-rotation#how_often_to_rotate_keys" rel="noopener ugc nofollow" target="_blank"> <em class="lc"> 90天</em> </a> <em class="lc">)。并且最好<strong class="is hj">对应用程序没有任何业务影响</strong>。</em></p><p id="05a5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lc">我的朋友</em><a class="ld le ge" href="https://medium.com/u/d0e632e7c73a?source=post_page-----ff2c502df666--------------------------------" rel="noopener" target="_blank"><em class="lc">Antoine Castex</em></a><em class="lc"/><a class="ae jo" rel="noopener" href="/google-cloud/the-key-wars-story-a65bb9dabe56"><em class="lc">记录了一个在欧莱雅实现的解决方案</em> </a> <em class="lc">用于Google Cloud上的密钥旋转。</em></p><h1 id="64df" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk lf km kn ko lg kq kr ks lh ku kv kw bi translated">云运行秘密集成</h1><p id="b3c1" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">Cloud Run支持与Secret Manager服务集成的两种模式。</p><ul class=""><li id="cdc3" class="li lj hi is b it iu ix iy jb lk jf ll jj lm jn ln lo lp lq bi translated">将秘密加载到环境变量中</li><li id="a9dd" class="li lj hi is b it lr ix ls jb lt jf lu jj lv jn ln lo lp lq bi translated">将秘密载入文件</li></ul><h2 id="365f" class="lw ka hi bd kb lx ly lz kf ma mb mc kj jb md me kn jf mf mg kr jj mh mi kv mj bi translated">环境变量求解的局限性</h2><p id="1090" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">Secret Manager当前最常用的用法是将机密作为环境变量加载。从代码中使用很简单:</p><ul class=""><li id="4a83" class="li lj hi is b it iu ix iy jb lk jf ll jj lm jn ln lo lp lq bi translated">直接访问操作系统环境</li><li id="1130" class="li lj hi is b it lr ix ls jb lt jf lu jj lv jn ln lo lp lq bi translated">没有要打开、关闭的文件，没有要读取的流</li><li id="d224" class="li lj hi is b it lr ix ls jb lt jf lu jj lv jn ln lo lp lq bi translated">没有要执行的字节到字符串转换</li></ul><p id="7a4e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以，<strong class="is hj">完美的解决方案开始吧！</strong></p><p id="9dfe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在云运行部署中，您必须<strong class="is hj">将一个环境变量名与一个秘密引用</strong>绑定，如下面的示例所示</p><pre class="mk ml mm mn fd mo mp mq bn mr ms bi"><span id="1f28" class="mt ka hi mp b be mu mv l mw mx">gcloud run deploy secret-read \<br/>  --set-secrets=mysecret=medium:latest</span></pre><p id="1057" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当使用环境变量模式时，<strong class="is hj">这个秘密在实例启动时被访问。</strong> <em class="lc">这时，执行环境设置了正确的标准和自定义环境变量。</em></p><p id="f939" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，<strong class="is hj">在整个实例生命周期中，这个秘密只被读取一次，不再被读取。<br/>因此，即使秘密发生变化，<strong class="is hj">当前运行的实例也不会被注意到</strong>并且您不能使用新的秘密。<strong class="is hj">只有新实例可以</strong>。<br/> <em class="lc">同样，如果你删除了这个秘密，当前的实例并不知道这个删除。</em></strong></p><p id="ac1a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您有<strong class="is hj"> 2种可能的解决方案</strong>来重新加载最新版本的秘密:</p><ul class=""><li id="24b3" class="li lj hi is b it iu ix iy jb lk jf ll jj lm jn ln lo lp lq bi translated">等待旧的实例自动停止。<br/>云运行不提供<strong class="is hj">停止正在运行的实例</strong>的能力。在处理完最后一个请求15分钟后，实例自动停止<a class="ae jo" href="https://cloud.google.com/run/docs/container-contract#idle" rel="noopener ugc nofollow" target="_blank">(空闲模式)。如果你遇到持续的交通堵塞，可能需要几个小时，甚至几天！！ </a></li><li id="056b" class="li lj hi is b it lr ix ls jb lt jf lu jj lv jn ln lo lp lq bi translated"><strong class="is hj">重新部署</strong>您的云运行服务的新版本。<br/>除了<strong class="is hj">部分无效</strong>之外，解决方案<strong class="is hj">在秘密更新</strong>上自动化起来很复杂。<br/>当然，新的请求将由新部署的修订版(加载了新的秘密版本)来服务，但是<strong class="is hj">现有实例继续服务“部署前”流量</strong>(并且可能需要长达1小时(最大云运行超时)，特别是当您服务<a class="ae jo" href="https://cloud.google.com/blog/products/serverless/cloud-run-gets-websockets-http-2-and-grpc-bidirectional-streams" rel="noopener ugc nofollow" target="_blank">双向流或websocket解决方案</a>时</li></ul><h2 id="e507" class="lw ka hi bd kb lx ly lz kf ma mb mc kj jb md me kn jf mf mg kr jj mh mi kv mj bi translated">文件挂载解决方案</h2><p id="d408" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">将一个<strong class="is hj">秘密挂载为一个文件</strong>在开始时并不那么自然，即使Kubernetes通过ConfigMap 使这种方式<strong class="is hj">流行起来。</strong></p><p id="ed2c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">借助云运行，您也可以通过命令行获得这种能力</p><pre class="mk ml mm mn fd mo mp mq bn mr ms bi"><span id="f6fd" class="mt ka hi mp b be mu mv l mw mx">gcloud run deploy secret-read \<br/>  --set-secrets=/secret/mysecret=medium:latest</span></pre><p id="34af" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lc">可以看出，与环境变量模式的区别在于</em> <strong class="is hj"> <em class="lc">以</em> </strong> <code class="du my mz na mp b"><strong class="is hj"><em class="lc">/</em></strong></code>开头的名字的前缀</p><p id="ecef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这一次，秘密被挂载为一个文件，但是<strong class="is hj">它不是一个“真实的文件”</strong>。它更像是一个<strong class="is hj">代理，捕捉秘密访问请求，并动态执行对秘密管理器服务的API调用</strong>。</p><p id="dbc6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，每次在代码中读取文件时，都会访问和读取<strong class="is hj">秘密。<br/>就这样，最新的秘密版本被访问了！</strong></p><p id="c525" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lc">只有当您的云运行实例</em> <strong class="is hj"> <em class="lc">挂载了您的</em> </strong> <code class="du my mz na mp b"><strong class="is hj"><em class="lc">latest</em></strong></code> <strong class="is hj"> <em class="lc">版本的secret </em> </strong> <em class="lc">时，此解决方案才有效。如果您设置静态版本，它将不起作用，因为</em> <strong class="is hj"> <em class="lc">秘密的版本</em> </strong> <em class="lc">在秘密管理器上是不可变的。您只能添加/删除版本，而</em> <strong class="is hj"> <em class="lc">伪版本</em></strong><code class="du my mz na mp b"><strong class="is hj"><em class="lc">latest</em></strong></code><strong class="is hj"><em class="lc"/></strong><em class="lc">始终引用最新版本。</em></p><h1 id="2fb7" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk lf km kn ko lg kq kr ks lh ku kv kw bi translated">适合正确使用情形的正确功能</h1><p id="f6f9" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">Cloud Run提供了Secret Manager服务的不同集成模式。一个是<strong class="is hj">更容易使用</strong>，并且<strong class="is hj">的好处是在实例运行时不会改变</strong>。<br/>另一个是<strong class="is hj">更通用，适应最新的秘密版本</strong>。</p><p id="58bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，请记住，在生产环境中使用 <code class="du my mz na mp b"><strong class="is hj">latest</strong></code> <strong class="is hj">版本的<strong class="is hj">机密</strong>必须被<strong class="is hj">很好地记录和假定</strong>。<br/>使用已定义的版本<strong class="is hj">允许您一致地部署和回滚</strong>到某个时间点。</strong></p><p id="0e82" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">没有完美的解决方案，但是<strong class="is hj">你有所有的选择</strong>！！选择正确的一个，并<strong class="is hj">建立可怕的，安全的东西！！</strong></p></div><div class="ab cl nb nc gp nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="hb hc hd he hf"><h1 id="b995" class="jz ka hi bd kb kc ni ke kf kg nj ki kj kk nk km kn ko nl kq kr ks nm ku kv kw bi translated">自己试试吧</h1><p id="1b25" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn hb bi translated">如果你想试一试，有几个步骤</p><p id="5816" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创造一个秘密</p><pre class="mk ml mm mn fd mo mp mq bn mr ms bi"><span id="82ee" class="mt ka hi mp b be mu mv l mw mx">echo -n "hello" | gcloud secrets create medium --data-file=- </span></pre><p id="481b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">授予云运行默认服务帐户<em class="lc">(如果您为您的部署使用默认服务帐户，即使客户管理的服务帐户是首选，它也足以用于测试)</em></p><pre class="mk ml mm mn fd mo mp mq bn mr ms bi"><span id="e9bd" class="mt ka hi mp b be mu mv l mw mx">gcloud secrets add-iam-policy-binding medium \<br/> --member=serviceAccount:&lt;PROJECT NUMBER&gt;-compute@developer.gserviceaccount.com \<br/> --role=roles/secretmanager.secretAccessor</span></pre><p id="628e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lc">用自己的项目号</em>替换 <code class="du my mz na mp b"><em class="lc">PROJECT NUMBER</em></code> <em class="lc"/></p></div><div class="ab cl nb nc gp nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="hb hc hd he hf"><p id="aa1f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，您可以在Go中使用这段代码</p><pre class="mk ml mm mn fd mo mp mq bn mr ms bi"><span id="368e" class="mt ka hi mp b be mu mv l mw mx">package main<br/><br/>import (<br/> "fmt"<br/> "io/ioutil"<br/> "net/http"<br/> "os"<br/>)<br/><br/>func main() {<br/> http.HandleFunc("/", readSecret)<br/> http.ListenAndServe(":8080", nil)<br/>}<br/><br/>func readSecret(w http.ResponseWriter, r *http.Request) {<br/> secFile, _ := ioutil.ReadFile("/secret/mysecret")<br/> secEnvVar := os.Getenv("mysecret")<br/> fmt.Fprintf(w, "the file secret value is %s.\nThe env var secret value is %s", string(secFile), secEnvVar)<br/>}</span></pre><p id="cec5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并在云上部署它</p><pre class="mk ml mm mn fd mo mp mq bn mr ms bi"><span id="ab27" class="mt ka hi mp b be mu mv l mw mx">gcloud run deploy secret-read \<br/>  --platform=managed \<br/>  --region=us-central1 \<br/>  --allow-unauthenticated \<br/>  --source=. \<br/>  --set-secrets=/secret/mysecret=medium:latest,mysecret=medium:latest</span></pre><p id="ac8e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该命令构建容器并同时部署它。请注意，该服务不是私有的(所有用户都可以访问它)，您必须使用最新版本的秘密才能使其工作。</p><p id="1934" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击提供的链接，您可以看到文件和环境变量有相同的值。</p></div><div class="ab cl nb nc gp nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="hb hc hd he hf"><p id="4ca7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，给你的秘密添加一个新版本。</p><pre class="mk ml mm mn fd mo mp mq bn mr ms bi"><span id="be27" class="mt ka hi mp b be mu mv l mw mx">echo -n "bye" | gcloud secrets versions add medium --data-file=-</span></pre><p id="ec82" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并重新加载云运行服务页面。<br/> <em class="lc">你必须在前一页载入后的15分钟内完成。如果花费更多的时间，实例将被卸载，并使用环境变量中的新秘密负载运行一个新实例。</em></p><p id="75b6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这一次，您可以看到只有<strong class="is hj">秘密通读文件具有新的秘密值</strong>，而不是环境变量。</p></div></div>    
</body>
</html>