<html>
<head>
<title>Simplifying Microservices with Istio in Google Kubernetes Engine — Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Kubernetes引擎中的Istio简化微服务—第二部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/simplifying-microservices-with-istio-in-google-kubernetes-engine-part-ii-7461b1833089?source=collection_archive---------0-----------------------#2018-02-11">https://medium.com/google-cloud/simplifying-microservices-with-istio-in-google-kubernetes-engine-part-ii-7461b1833089?source=collection_archive---------0-----------------------#2018-02-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex if ig ih ii"><div class="bz dy l di"><div class="ij ik l"/></div></figure><blockquote class="il im in"><p id="6ea1" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">我写的关于Istio的内容是Istio网站上<a class="ae jn" href="https://istio.io/docs/" rel="noopener ugc nofollow" target="_blank">精彩文档</a>的一个子集。请阅读官方文件以了解更多信息。</p></blockquote><p id="2507" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">在本系列的<a class="ae jn" rel="noopener" href="/google-cloud/simplifying-microservices-with-istio-in-google-kubernetes-engine-part-i-849555f922b8">第一部分</a>中，我们看到了如何使用<a class="ae jn" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio </a>来简化微服务之间的通信。</p><blockquote class="il im in"><p id="86e0" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated"><strong class="ir hj">在这一部分中，我们将看到Istio服务网格中的服务如何通过HTTPS与外部服务进行通信</strong></p></blockquote><figure class="js jt ju jv fd ii er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es jr"><img src="../Images/96cd24d65b06b0160119db3fc2e42e72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1eWgl06GKtkNZpN4ytG9gQ.jpeg"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">图1:服务通信模型的逻辑视图</figcaption></figure><p id="e233" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">在上面的图1中，我们的PetService(与PetDetailsService和PetMedicalHistoryService对话)<strong class="ir hj">现在也将调用位于</strong><a class="ae jn" href="https://thedogapi.co.uk/" rel="noopener ugc nofollow" target="_blank"><strong class="ir hj">https://thedogapi.co.uk/</strong></a><strong class="ir hj">的外部服务，该服务返回狗的图像URL。</strong></p><p id="bde7" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">来自Istio服务网格内部的外部服务通信如下面的图2所示。</p><ul class=""><li id="3e6d" class="kg kh hi ir b is it iw ix jo ki jp kj jq kk jm kl km kn ko bi translated">与往常一样，服务网格中服务之间的所有通信都是通过HTTP上的代理进行的</li><li id="0779" class="kg kh hi ir b is kp iw kq jo kr jp ks jq kt jm kl km kn ko bi translated">为了通过HTTPS与外部服务通信，内部服务仍然会发送HTTP请求，这些请求会被sidecar代理截获，该代理发起TLS并通过加密通道与外部服务通信。</li></ul><figure class="js jt ju jv fd ii er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es ku"><img src="../Images/56837029cc734d46b6077f111fbe03d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JIX2eAYF6mXS5Jsn5rYHLg.jpeg"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">图2:与外部服务通信的Istio服务网格表示</figcaption></figure><p id="aab5" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated"><a class="ae jn" href="https://github.com/nmallya/istiodemo" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hj"> Github回购</strong> </a></p><p id="6e75" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">完成这项工作的<strong class="ir hj"> petservice </strong>代码如下所示:</p><figure class="js jt ju jv fd ii er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kv"><img src="../Images/296f152beb475728545074a1fa4d609a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lw3WZ0bK7Ll8e3CSkBmMDA.png"/></div></div></figure><blockquote class="il im in"><p id="075e" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated"><strong class="ir hj">注意</strong>:请看我们如何调用DogAPI的https url作为<strong class="ir hj">http</strong>://API . the DogAPI . co . uk<strong class="ir hj">:443</strong>/v2/dog . PHP</p></blockquote><p id="1ab9" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">让我们看看当我们运行以下命令时会发生什么，其中108.59.82.93是入口IP地址。(见第一部分)</p><pre class="js jt ju jv fd kw kx ky kz aw la bi"><span id="737e" class="lb lc hi kx b fi ld le l lf lg">curl http://108.59.82.93/pet/123</span></pre><p id="84f4" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">响应看起来像:</p><pre class="js jt ju jv fd kw kx ky kz aw la bi"><span id="4ab8" class="lb lc hi kx b fi ld le l lf lg">{<br/>  "petDetails": {<br/>    "petName": "Maximus",<br/>    "petAge": 5,<br/>    "petOwner": "Nithin Mallya",<br/>    "petBreed": "Dog"<br/>  },<br/>  "petMedicalHistory": {<br/>    "vaccinationList": [<br/>      "Bordetella, Leptospirosis, Rabies, Lyme Disease"<br/>    ]<br/>  },<br/>  "<strong class="kx hj">dogAPIResponse": {<br/>    "message": "request to </strong><a class="ae jn" href="https://api.thedogapi.co.uk/v2/dog.php" rel="noopener ugc nofollow" target="_blank"><strong class="kx hj">https://api.thedogapi.co.uk/v2/dog.php</strong></a><strong class="kx hj"> failed, reason: read ECONNRESET",<br/>    "type": "system",<br/>    "errno": "ECONNRESET",<br/>    "code": "ECONNRESET"</strong><br/>  }<br/>}</span></pre><p id="f90d" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">您将在上面的响应中注意到，当我们的<strong class="ir hj"> petservice </strong>试图访问位于<a class="ae jn" href="https://api.thedogapi.co.uk" rel="noopener ugc nofollow" target="_blank">https://api.thedogapi.co.uk</a>的外部服务时，dogAPIResponse(不是最原始的名称)部分有一个错误</p><p id="1c37" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">这是因为默认情况下，所有外部流量(出口)都被阻止。前一篇文章中解释的sidecar代理只允许集群内部的通信。</p><blockquote class="il im in"><p id="cac7" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated"><strong class="ir hj">注意</strong>:正如我在第一部分中提到的，当我们想要控制我们的服务与外部服务对话的方式，并防止与外部系统进行任何未经授权的通信时，这个限制非常有用。</p><p id="24a7" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">医疗保健/金融系统尤其可以利用这一功能来保护PHI/PII数据不被内部服务无意甚至恶意共享。</p></blockquote><p id="2865" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">要启用出口流量，您需要创建一个<strong class="ir hj">出口规则</strong>，如下所示:</p><pre class="js jt ju jv fd kw kx ky kz aw la bi"><span id="db3c" class="lb lc hi kx b fi ld le l lf lg">cat &lt;&lt;EOF | istioctl create -f -<br/>apiVersion: config.istio.io/v1alpha2<br/>kind: EgressRule<br/>metadata:<br/>  name: dogapi-egress-rule<br/>spec:<br/>  destination:<br/>    service: api.thedogapi.co.uk<br/>  ports:<br/>    - port: 443<br/>      protocol: https<br/>EOF</span></pre><p id="520f" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">要检查这个出口规则是否已经创建，您可以运行下面的命令，您应该看到出口规则<strong class="ir hj"> dogapi-egress-rule </strong>已经创建。</p><pre class="js jt ju jv fd kw kx ky kz aw la bi"><span id="c853" class="lb lc hi kx b fi ld le l lf lg">kubectl get egressrule</span><span id="872e" class="lb lc hi kx b fi lh le l lf lg">NAME                 AGE</span><span id="38e2" class="lb lc hi kx b fi lh le l lf lg">dogapi-egress-rule   5m</span></pre><p id="043e" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">让我们再次尝试上面的curl命令:</p><pre class="js jt ju jv fd kw kx ky kz aw la bi"><span id="a0c1" class="lb lc hi kx b fi ld le l lf lg">$ curl <a class="ae jn" href="http://108.59.82.93/pet/123" rel="noopener ugc nofollow" target="_blank">http://108.59.82.93/pet/123</a></span><span id="e9d6" class="lb lc hi kx b fi lh le l lf lg">{<br/>  "petDetails": {<br/>    "petName": "Maximus",<br/>    "petAge": 5,<br/>    "petOwner": "Nithin Mallya",<br/>    "petBreed": "Dog"<br/>  },<br/>  "petMedicalHistory": {<br/>    "vaccinationList": [<br/>      "Bordetella, Leptospirosis, Rabies, Lyme Disease"<br/>    ]<br/>  },<br/>  "dogAPIResponse": {<br/>    "count": 1,<br/>    "api_version": "v2",<br/>    "error": null,<br/>    "data": [<br/>      {<br/>        "id": "rCaz-LNuzCC",<br/>        <strong class="kx hj">"url": "</strong><a class="ae jn" href="https://i.thedogapi.co.uk/rCaz-LNuzCC.jpg" rel="noopener ugc nofollow" target="_blank"><strong class="kx hj">https://i.thedogapi.co.uk/rCaz-LNuzCC.jpg</strong></a><strong class="kx hj">",</strong><br/>        "time": "2017-08-30T21:43:03.0",<br/>        "format": "jpg",<br/>        "verified": "1",<br/>        "checked": "1"<br/>      }<br/>    ],<br/>    "response_code": 200<br/>  }<br/>}</span></pre><p id="eeb8" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">而且很管用！您可以在DogAPI响应中看到一个宠物图片的示例url。</p><p id="ee14" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated"><strong class="ir hj">结论</strong>:我们看到了如何通过创建显式规则来实现从服务网格到外部服务的通信。</p><p id="385a" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated">在后续文章中，我们将看到如何做其他重要的任务，如流量路由和斜坡，使用断路器等。</p><p id="2891" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jo jb jc jd jp jf jg jh jq jj jk jl jm hb bi translated"><strong class="ir hj">资源</strong>:</p><ol class=""><li id="6d5e" class="kg kh hi ir b is it iw ix jo ki jp kj jq kk jm li km kn ko bi translated">本系列文章第一部分:<a class="ae jn" rel="noopener" href="/google-cloud/simplifying-microservices-with-istio-in-google-kubernetes-engine-part-i-849555f922b8">https://medium . com/Google-cloud/simplizing-micro services-with-istio-in-Google-kubernetes-engine-part-I-849555 f 922 b 8</a></li><li id="819f" class="kg kh hi ir b is kp iw kq jo kr jp ks jq kt jm li km kn ko bi translated">Istio主页<a class="ae jn" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank">https://istio.io/</a></li><li id="9490" class="kg kh hi ir b is kp iw kq jo kr jp ks jq kt jm li km kn ko bi translated">DevOxx Istio演示由<a class="lj lk ge" href="https://medium.com/u/a535baed6389?source=post_page-----7461b1833089--------------------------------" rel="noopener" target="_blank">Ray Tsang</a>:<a class="ae jn" href="https://www.youtube.com/watch?v=AGztKw580yQ&amp;t=231s" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=AGztKw580yQ&amp;t = 231秒</a></li><li id="8a94" class="kg kh hi ir b is kp iw kq jo kr jp ks jq kt jm li km kn ko bi translated">Github链接到这个例子:<a class="ae jn" href="https://github.com/nmallya/istiodemo" rel="noopener ugc nofollow" target="_blank">https://github.com/nmallya/istiodemo</a></li><li id="1fb1" class="kg kh hi ir b is kp iw kq jo kr jp ks jq kt jm li km kn ko bi translated">库伯内斯:<a class="ae jn" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/</a></li><li id="8f93" class="kg kh hi ir b is kp iw kq jo kr jp ks jq kt jm li km kn ko bi translated">DogAPI页面:<a class="ae jn" href="https://thedogapi.co.uk/" rel="noopener ugc nofollow" target="_blank">https://thedogapi.co.uk/</a></li></ol></div></div>    
</body>
</html>