<html>
<head>
<title>Build slim Docker images for Dart apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为Dart应用程序构建纤细的Docker图像</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/build-slim-docker-images-for-dart-apps-ee98ea1d1cf7?source=collection_archive---------0-----------------------#2020-10-26">https://medium.com/google-cloud/build-slim-docker-images-for-dart-apps-ee98ea1d1cf7?source=collection_archive---------0-----------------------#2020-10-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8fa1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你已经使用Docker在容器化的环境中运行你的Dart应用(比如<a class="ae jd" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank">谷歌Kubernetes引擎</a>或者<a class="ae jd" href="https://cloud.google.com/run" rel="noopener ugc nofollow" target="_blank">云运行</a>，你可能已经对<a class="ae jd" href="https://hub.docker.com/r/google/dart/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">谷歌/dart </strong> </a>图像的分量感到惊讶。</p><p id="22be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于Debian 10“Buster”镜像，<strong class="ih hj"> google/dart </strong>是面向开发的——并没有针对大小进行优化——目前重量达到了682 MB！</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/dd5d655e3f891a89f9bb0b667fd25803.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AW6_eXLiYzCqS81Skn-nCg.png"/></div></div></figure><p id="2586" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随着<a class="ae jd" href="https://flutter.dev/" rel="noopener ugc nofollow" target="_blank">的兴起</a>，谷歌的UI工具包继续流行，使用Dart实现后端功能的兴趣也增加了，该工具包用于从基于Dart的单一代码库为<a class="ae jd" href="https://flutter.dev/docs" rel="noopener ugc nofollow" target="_blank">移动</a>、<a class="ae jd" href="https://flutter.dev/web" rel="noopener ugc nofollow" target="_blank">网络</a>和<a class="ae jd" href="https://flutter.dev/desktop" rel="noopener ugc nofollow" target="_blank">桌面</a>构建本地编译的应用。</p><p id="5d10" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，由于侧重于客户端开发，关于如何为服务器端部署优化映像大小的指导很少。</p><p id="97bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我将向您介绍<a class="ae jd" href="https://github.com/subfuzion/dart-scratch" rel="noopener ugc nofollow" target="_blank"> dart-scratch </a>，这是一个基于<a class="ae jd" href="https://hub.docker.com/_/scratch" rel="noopener ugc nofollow" target="_blank"> scratch </a>的轻量级图像，您可以使用它为您的dart应用程序容器构建尽可能薄的图像。</p><h1 id="21ad" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">那么为什么优化图像尺寸很重要呢？</h1><p id="4082" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">当您第一次在一些(物理或虚拟)机器上创建容器时，用于创建容器的映像必须从某处的映像存储库(例如，通常是像<a class="ae jd" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>或<a class="ae jd" href="https://cloud.google.com/artifact-registry" rel="noopener ugc nofollow" target="_blank"> Google Artifact Registry </a>这样的注册表)通过网络传输。</p><p id="95fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">传输大型映像时会有延迟，这对于长时间运行的服务器来说可能不是问题，但是在按需创建新机器实例的动态扩展环境中传输大型映像的性能负担可能是有害的。</p><p id="3b68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，在构建容器时，从机器的图像缓存中读取图像层。较大的文件显然需要更多的时间来读取，这意味着在容器准备好工作之前会有更长的延迟。</p><p id="0a32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同样，对于长时间运行的服务器，这可能不是一个重要的问题，但对于需要快速响应的应用程序，响应延迟会增加，用户可能会察觉到。消除这些延迟对于不消耗资源(从而降低成本)但必须快速启动和执行任务的零扩展工作负载尤为重要。</p><h1 id="9402" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">JIT与AOT绩效对比</h1><p id="569c" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">最后，对启动时间有负面影响的另一件事是，当Dart代码在Dart VM上运行时，它是实时编译的(JIT)。启动服务器可能需要几秒钟才能准备好开始监听套接字。</p><p id="e904" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如前所述，对于某些应用程序来说，这可能不是问题，但在动态、自动扩展的环境中，这可能是非常不可取的，因为响应能力非常重要。</p><p id="f249" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了解决这个问题，可以使用<a class="ae jd" href="https://dart.dev/tools/dart2native" rel="noopener ugc nofollow" target="_blank"> dart2native </a>提前(AOT)将Dart应用程序编译成机器码。这大大缩短了启动时间。</p><p id="24f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，有一个问题。目前dart2native不支持反射(它依赖于<a class="ae jd" href="https://api.dart.dev/stable/2.10.2/dart-mirrors/dart-mirrors-library.html" rel="noopener ugc nofollow" target="_blank"> dart:mirrors </a>)。例如，元数据注释在各种web服务器、数据建模、序列化和依赖注入框架和库中很流行。</p><p id="8aa1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于代表典型的功能即服务工作负载的较短、更集中的应用程序类型，这可能根本不是问题。对于需要利用复杂框架的更大、更复杂类型的web应用程序，注释支持可能是不可或缺的。</p><blockquote class="kt ku kv"><p id="89d4" class="if ig kw ih b ii ij ik il im in io ip kx ir is it ky iv iw ix kz iz ja jb jc hb bi translated">如果你想了解更多关于JIT和AOT的性能和限制的细节，请参见这个<a class="ae jd" href="https://dart.dev/faq#q-which-is-faster--aot--or-jit-compiled-code" rel="noopener ugc nofollow" target="_blank"> FAQ </a>和<a class="ae jd" href="https://dart.dev/tools/dart2native#known-limitations" rel="noopener ugc nofollow" target="_blank"> docs page </a>。</p></blockquote><h1 id="fefe" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">对基于AOT或JIT的瘦图像使用dart-scratch</h1><p id="917f" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">如果您希望尽可能快地启动应用程序，并且不需要Dart反射(例如，为了注释支持)，那么使用如下所示的<code class="du la lb lc ld b">dart-scratch</code>。这将使用<a class="ae jd" href="https://dart.dev/tools/dart2native" rel="noopener ugc nofollow" target="_blank"> dart2native </a>构建你的应用。</p><p id="ddd3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最小的服务器应用程序映像大约为25 MB，当创建一个容器时，应用程序将在亚秒时间内启动。这非常适合功能即服务和其他需要快速执行和扩展的工作类型。</p><p id="2746" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kw">多阶段Dockerfile用AOT编译的app打造苗条形象:</em></p><pre class="jf jg jh ji fd le ld lf lg aw lh bi"><span id="2061" class="li jr hi ld b fi lj lk l ll lm">FROM google/dart<br/># uncomment next line to ensure latest Dart and root CA bundle<br/>#RUN apt -y update &amp;&amp; apt -y upgrade<br/>WORKDIR /app<br/>COPY pubspec.* .<br/>RUN pub get<br/>COPY . .<br/>RUN pub get --offline<br/>RUN dart2native /app/bin/server.dart -o /app/bin/server</span><span id="1e1a" class="li jr hi ld b fi ln lk l ll lm">FROM subfuzion/dart-scratch<br/>COPY --from=0 /app/bin/server /app/bin/server<br/># COPY any other directories or files you may require at runtime, ex:<br/>#COPY --from=0 /app/static/ /app/static/<br/>EXPOSE 8080<br/>ENTRYPOINT ["/app/bin/server"]</span></pre><p id="2f52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如前所述，如果您的应用程序依赖于<code class="du la lb lc ld b">dart:mirrors</code>，那么您就不能使用<code class="du la lb lc ld b">dart2native</code>，因此您将需要构建一个使用Dart VM的映像。</p><p id="5dfa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最小的服务器应用程序映像大约为50 MB，当创建容器时，应用程序可能需要几秒钟才能准备好侦听套接字。由于启动时间增加，这更适合生命周期较长的应用程序、对作业启动时间不太敏感的应用程序或需要反射支持的应用程序(例如，对于注释)。</p><p id="a6e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kw">用JIT编译的app构建苗条形象的多阶段docker file:</em></p><pre class="jf jg jh ji fd le ld lf lg aw lh bi"><span id="f23e" class="li jr hi ld b fi lj lk l ll lm">FROM google/dart<br/># uncomment next line to ensure latest Dart and root CA bundle<br/>#RUN apt -y update &amp;&amp; apt -y upgrade<br/>WORKDIR /app<br/>COPY pubspec.* .<br/>RUN pub get<br/>COPY . .<br/>RUN pub get --offline</span><span id="da91" class="li jr hi ld b fi ln lk l ll lm">FROM subfuzion/dart-scratch<br/>COPY --from=0 /usr/lib/dart/bin/dart /usr/lib/dart/bin/dart<br/>COPY --from=0 /root/.pub-cache /root/.pub-cache<br/># Copy over the entire app...<br/>COPY --from=0 /app /app<br/># ...or copy specific files and directories you require at runtime, ex:<br/>#COPY --from=0 /app/bin/server.dart /app/bin/server.dart<br/>#COPY --from=0 /app/lib/ /app/lib/<br/>#COPY --from=0 /app/static/ /app/static/<br/>EXPOSE 8080<br/>ENTRYPOINT ["/usr/lib/dart/bin/dart", "/app/bin/server.dart"]</span></pre></div><div class="ab cl lo lp gp lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="hb hc hd he hf"><p id="d5e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我想提一下，这目前是实验性的，在我重复这个的时候，Google还不支持。我计划接下来重点实现一个<a class="ae jd" href="https://buildpacks.io/" rel="noopener ugc nofollow" target="_blank">构建包</a>，它可以用来将Dart代码转换成可以在云无服务器环境中运行的映像。</p><p id="3e3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果这种尝试对您不起作用，或者如果您有想要分享的用例，请在<a class="ae jd" href="https://github.com/subfuzion/dart-scratch" rel="noopener ugc nofollow" target="_blank"> repo </a>中的这里打开一个问题<a class="ae jd" href="https://github.com/subfuzion/dart-scratch/issues" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>