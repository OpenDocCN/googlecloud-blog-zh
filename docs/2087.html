<html>
<head>
<title>Scaling to Zero with KEDA and GKE Autopilot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用KEDA和GKE自动驾驶仪调整到零</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/scaling-to-zero-with-keda-and-gke-autopilot-36839f69b28b?source=collection_archive---------1-----------------------#2022-02-03">https://medium.com/google-cloud/scaling-to-zero-with-keda-and-gke-autopilot-36839f69b28b?source=collection_archive---------1-----------------------#2022-02-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a375" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GKE自动驾驶仪是一项在云中运行工作负载的伟大技术。Google SREs负责运营您的Kubernetes集群，而您可以专注于您的应用程序。当在GKE自动驾驶仪上构建事件驱动的应用程序时，你可能会体验到你运行了很多没有被充分利用的pod。对于提供HTTP API或连接到发布/订阅的应用程序，您可以考虑使用云运行。但是如果您有一些其他的消息传递系统，那么动态扩展会变得更加困难。在这种情况下，如果您非常乐意从1扩展到无穷大，一种方法是水平Pod自动缩放。但是，如果您希望扩展到零，因为您的工作负载可能一天只处理几条消息，该怎么办呢？或者你有零星破裂？</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/25e30a7488ea576d832d24129660f611.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XTztQswmREaPKUmzfqtF1g.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">在<a class="ae jt" href="https://unsplash.com/s/photos/containers?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae jt" href="https://unsplash.com/@ventiviews?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Venti Views </a>拍摄的照片</figcaption></figure><p id="d36f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">KEDA是一个很好的工具。它类似于HPA，但是有更多的选项可以根据队列中未确认消息的数量来调整大小。在本教程中，我们将设置一个简单的应用程序，使用来自发布/订阅的消息，并使用KEDA扩展pod的数量。(当然，对于发布/订阅，您可以使用云运行，但对于本教程，这是一个简单的设置)。</p><h1 id="b03f" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">设置您的环境</h1><p id="ab35" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">接下来，您将设置环境，以便部署项目。</p><ol class=""><li id="eafb" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated"><a class="ae jt" href="https://console.cloud.google.com/?cloudshell=true" rel="noopener ugc nofollow" target="_blank">打开一个新的云Shell会话。</a></li><li id="136d" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated"><em class="ll">运行</em> <code class="du lm ln lo lp b">git clone <a class="ae jt" href="https://github.com/cgrotz/blog-examples" rel="noopener ugc nofollow" target="_blank">https://github.com/cgrotz/blog-examples</a>.git</code>将源代码下载到您的云shell。</li><li id="ac7c" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated"><code class="du lm ln lo lp b">cd ./keda-on-gke-autopilot</code>将目录切换到<em class="ll">教程</em>文件夹。</li><li id="5902" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">设置所需的环境变量。将[REGION]替换为要在其中运行资源的区域，例如europe-west1</li></ol><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="ff77" class="lu jv hi lp b fi lv lw l lx ly">export REGION=[REGION]</span></pre><p id="20c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了遵循本教程，您需要启用以下API。</p><ul class=""><li id="fc26" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lz ld le lf bi translated">谷歌云API</li><li id="bbb9" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lz ld le lf bi translated">工件注册API</li><li id="e45a" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lz ld le lf bi translated">Kubernetes引擎API</li><li id="92d4" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lz ld le lf bi translated">身份和访问管理(IAM) API</li><li id="3ab1" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lz ld le lf bi translated">IAM服务帐户凭据API</li><li id="2702" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lz ld le lf bi translated">云发布/订阅API</li></ul><p id="03d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用这个命令作为简写</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="37b9" class="lu jv hi lp b fi lv lw l lx ly">gcloud services enable iam.googleapis.com<br/>gcloud services enable compute.googleapis.com<br/>gcloud services enable artifactregistry.googleapis.com<br/>gcloud services enable container.googleapis.com <br/>gcloud services enable cloudapis.googleapis.com <br/>gcloud services enable iamcredentials.googleapis.com <br/>gcloud services enable pubsub.googleapis.com</span></pre><h1 id="f1d4" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">用KEDA设置GKE自动驾驶仪</h1><p id="8276" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">接下来，让我们创建一个GKE自动驾驶集群，并检索访问凭据。这可能需要一些时间，因此触发创建并获取一些咖啡:</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="9cf6" class="lu jv hi lp b fi lv lw l lx ly">gcloud container clusters create-auto test-cluster \<br/>    --region $REGION \<br/>    --project=$GOOGLE_CLOUD_PROJECT <br/>gcloud container clusters get-credentials test-cluster \<br/>    --region $REGION \<br/>    --project $GOOGLE_CLOUD_PROJECT</span></pre><p id="2eb9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当GKE自动驾驶集群创建后，我们将把KEDA部署到集群中。</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="1e40" class="lu jv hi lp b fi lv lw l lx ly">kubectl apply -f <a class="ae jt" href="https://github.com/kedacore/keda/releases/download/v2.5.0/keda-2.5.0.yaml" rel="noopener ugc nofollow" target="_blank">https://github.com/kedacore/keda/releases/download/v2.5.0/keda-2.5.0.yaml</a></span></pre><p id="24f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了让KEDA跟踪发布/订阅队列中的未决消息，我们需要将KEDA (keda-operator)的Kubernetes服务帐户(KSA)链接到一个拥有访问Google云监控权限的Google服务帐户(GSA)。</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="08d9" class="lu jv hi lp b fi lv lw l lx ly">gcloud iam service-accounts create keda-operator --project $GOOGLE_CLOUD_PROJECT</span></pre><p id="4e1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">授予云监控查看器访问GSA next的权限，并将服务帐户链接在一起。</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="9d04" class="lu jv hi lp b fi lv lw l lx ly">gcloud projects add-iam-policy-binding $GOOGLE_CLOUD_PROJECT \<br/>    --member "serviceAccount:keda-operator@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com" \<br/>    --role "roles/monitoring.viewer"</span><span id="7a08" class="lu jv hi lp b fi ma lw l lx ly">gcloud iam service-accounts add-iam-policy-binding keda-operator@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com \<br/>    --role roles/iam.workloadIdentityUser \<br/>    --member "serviceAccount:$GOOGLE_CLOUD_PROJECT.svc.id.goog[keda/keda-operator]" \<br/>    --project $GOOGLE_CLOUD_PROJECT</span><span id="0123" class="lu jv hi lp b fi ma lw l lx ly">kubectl annotate serviceaccount keda-operator \<br/>    --namespace keda \<br/>    iam.gke.io/gcp-service-account=keda-operator@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com</span></pre><h1 id="c963" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">部署演示应用程序</h1><p id="f88c" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">为了对KEDA进行测试，我们将部署一个简单的应用程序，它使用来自发布/订阅的消息并将它们记录到控制台。第一步是为容器映像创建一个工件注册库:</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="6aac" class="lu jv hi lp b fi lv lw l lx ly">gcloud artifacts repositories create test-repo \<br/>    --repository-format=docker \<br/>    --location=$REGION \<br/>    --project $GOOGLE_CLOUD_PROJECT</span></pre><p id="877e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要为回购设置Docker凭据帮助器:</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="f0bf" class="lu jv hi lp b fi lv lw l lx ly">gcloud auth configure-docker $REGION-docker.pkg.dev</span></pre><p id="cb3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们想要使用来自发布/订阅的消息，所以我们需要创建一个发布/订阅主题和订阅:</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="2305" class="lu jv hi lp b fi lv lw l lx ly">gcloud pubsub topics create test-topic --project $GOOGLE_CLOUD_PROJECT <br/>gcloud pubsub subscriptions create test-subscription --topic test-topic --project $GOOGLE_CLOUD_PROJECT</span></pre><p id="beaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">应用程序将需要一个服务帐户，该帐户有权使用来自发布/订阅的消息，并可用于工作负载标识:</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="5ba8" class="lu jv hi lp b fi lv lw l lx ly">kubectl create serviceaccount testapp --namespace default</span><span id="3316" class="lu jv hi lp b fi ma lw l lx ly">gcloud iam service-accounts create testapp --project $GOOGLE_CLOUD_PROJECT</span><span id="aa6d" class="lu jv hi lp b fi ma lw l lx ly">gcloud projects add-iam-policy-binding $GOOGLE_CLOUD_PROJECT \<br/>    --member "serviceAccount:testapp@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com" \<br/>    --role "roles/pubsub.subscriber"<br/>    <br/>gcloud iam service-accounts add-iam-policy-binding testapp@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com \<br/>    --role roles/iam.workloadIdentityUser \<br/>    --member "serviceAccount:$GOOGLE_CLOUD_PROJECT.svc.id.goog[default/testapp]" \<br/>    --project $GOOGLE_CLOUD_PROJECT<br/>    <br/>kubectl annotate serviceaccount testapp \<br/>    --namespace default \<br/>    iam.gke.io/gcp-service-account=testapp@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com</span></pre><p id="f4c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署应用程序之前的下一步是构建容器并将其推送到工件注册库:</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="1833" class="lu jv hi lp b fi lv lw l lx ly">docker build -t $REGION-docker.pkg.dev/$GOOGLE_CLOUD_PROJECT/test-repo/app:latest ./app<br/>docker push $REGION-docker.pkg.dev/$GOOGLE_CLOUD_PROJECT/test-repo/app:latest</span></pre><p id="d052" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切准备就绪，让我们部署应用程序:</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="39c6" class="lu jv hi lp b fi lv lw l lx ly">envsubst &lt; deployment.yaml | kubectl apply -f -</span></pre><p id="e8c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我们将缩放对象配置为快速缩放。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mb"><img src="../Images/9319664d158f304a51692578fa985aa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v98Oi4GaGKUzNU85TpkunA.png"/></div></div></figure><p id="84e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您通过检查副本数量时，可以看到KEDA自动将副本数量缩减为零，因为订阅中当前没有等待处理的消息:</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="1a0f" class="lu jv hi lp b fi lv lw l lx ly">kubectl get deployments</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mc"><img src="../Images/fe712b8f10ca86a2606e028cff478780.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_GHZ3rrL8R9vbT--nVxjxA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">在GKE的部署</figcaption></figure><h1 id="0779" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">发布一些消息</h1><p id="fa4c" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">您可以通过重复使用gcloud来生成一些消息:</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="5565" class="lu jv hi lp b fi lv lw l lx ly">gcloud pubsub topics publish test-topic --message="Hello World" --project $GOOGLE_CLOUD_PROJECT</span></pre><p id="2cf1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者使用以下脚本一次生成100条消息:</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="8673" class="lu jv hi lp b fi lv lw l lx ly">./generate-message.sh</span></pre><p id="4e25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您再次检查部署，您应该看到KEDA增加了处理邮件所需的副本数量。您还可以部署这个漂亮的Google Cloud Monitoring dashboard，它向您显示应用程序pod的CPU使用情况以及发布/订阅订阅中的未决消息。</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="3bd5" class="lu jv hi lp b fi lv lw l lx ly">gcloud monitoring dashboards create --config-from-file keda-tutorial-dashboard.yaml --project $GOOGLE_CLOUD_PROJECT --project $GOOGLE_CLOUD_PROJECT</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es md"><img src="../Images/987f3b46a86ea73d2ac0a735de4da77c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7HeKaOLYPtmJnWm3KMpKUw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">就这样，现在您有了一个很好的消息消费者，它可以缩减到零。</figcaption></figure><p id="8ca0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您的工作负载是容错的，您可以做的一个优化是为您的部署启用<a class="ae jt" href="https://cloud.google.com/blog/products/containers-kubernetes/announcing-spot-pods-for-gke-autopilot" rel="noopener ugc nofollow" target="_blank"> Spot Pods </a>，这样您可以从GCP Spot实例的低得多的价格中受益。为此，只需在<code class="du lm ln lo lp b">deployment.yaml</code>文件中的容器定义旁边添加以下内容。</p><pre class="je jf jg jh fd lq lp lr ls aw lt bi"><span id="d3e7" class="lu jv hi lp b fi lv lw l lx ly">nodeSelector:<br/>  cloud.google.com/gke-spot: "true"<br/>terminationGracePeriodSeconds: 25</span></pre><p id="37a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lm ln lo lp b">terminationGracePeriodSeconds</code>允许您在收到SIGTERM信号时优雅地关闭容器。</p></div></div>    
</body>
</html>