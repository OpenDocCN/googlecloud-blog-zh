<html>
<head>
<title>Upload Images to Google Cloud Storage with React Native and ExpressJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React Native和ExpressJS将图片上传到Google云存储</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/upload-images-to-google-cloud-storage-with-react-native-and-expressjs-61b8874abc49?source=collection_archive---------0-----------------------#2016-10-31">https://medium.com/google-cloud/upload-images-to-google-cloud-storage-with-react-native-and-expressjs-61b8874abc49?source=collection_archive---------0-----------------------#2016-10-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="b20f" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">也适用于React和任何其他前端Javascript框架</h2></div><p id="dc4a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">经过大约12个小时的调查和最终的成功，我觉得有必要为任何面临同样挑战的人保留一些悲伤。</p><p id="5b88" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">谷歌云存储是谷歌版的亚马逊S3桶。我使用谷歌云是因为仪表盘的导航非常好，它与谷歌的API直接相连，而且服务很容易配置和启动。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/36a90cdaf0a199070f03a71442bf3e27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5SQktDCzIZ6TSyDk-TGTwg.png"/></div></div></figure><p id="cba2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae kf" href="https://cloud.google.com/nodejs/getting-started/using-cloud-storage" rel="noopener ugc nofollow" target="_blank">这里的</a>是我关注的Google Cloud的文档部分。</p><p id="9f20" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我的特殊情况下，我通过<a class="ae kf" href="https://github.com/marcshilling/react-native-image-picker" rel="noopener ugc nofollow" target="_blank">React-Native-image-picker</a>将图片从React本地应用上传到我的express服务器上的一个端点，然后上传到Google Cloud。</p><h2 id="cbcd" class="kg kh hi bd ki kj kk kl km kn ko kp kq jg kr ks kt jk ku kv kw jo kx ky kz la bi translated">成功上传所需的I <strong class="ak"> <em class="lb">项</em> </strong>:</h2><ol class=""><li id="683f" class="lc ld hi iz b ja le jd lf jg lg jk lh jo li js lj lk ll lm bi translated">谷歌服务账户密钥文件</li><li id="8c48" class="lc ld hi iz b ja ln jd lo jg lp jk lq jo lr js lj lk ll lm bi translated"><a class="ae kf" href="https://github.com/GoogleCloudPlatform/google-cloud-node#google-cloud-storage" rel="noopener ugc nofollow" target="_blank">谷歌云节点库</a></li><li id="2892" class="lc ld hi iz b ja ln jd lo jg lp jk lq jo lr js lj lk ll lm bi translated">用于Express的<a class="ae kf" href="https://github.com/expressjs/multer" rel="noopener ugc nofollow" target="_blank"> Multer </a>库</li></ol><h2 id="35af" class="kg kh hi bd ki kj kk kl km kn ko kp kq jg kr ks kt jk ku kv kw jo kx ky kz la bi translated">成功上传所需的<strong class="ak"> <em class="lb">步骤</em> </strong></h2><ol class=""><li id="3b76" class="lc ld hi iz b ja le jd lf jg lg jk lh jo li js lj lk ll lm bi translated">通过图像拾取器/表单或任何其他文件选择器接受图像。</li><li id="19a9" class="lc ld hi iz b ja ln jd lo jg lp jk lq jo lr js lj lk ll lm bi translated">创建一个<code class="du ls lt lu lv b">FormData()</code>对象</li><li id="310d" class="lc ld hi iz b ja ln jd lo jg lp jk lq jo lr js lj lk ll lm bi translated">将图像细节追加到对象</li><li id="eb17" class="lc ld hi iz b ja ln jd lo jg lp jk lq jo lr js lj lk ll lm bi translated">以<code class="du ls lt lu lv b">multipart/form-data</code>的身份向您的快速端点执行<code class="du ls lt lu lv b">POST</code>请求</li><li id="8d3a" class="lc ld hi iz b ja ln jd lo jg lp jk lq jo lr js lj lk ll lm bi translated">使用<code class="du ls lt lu lv b">multer</code>作为中间件来解析请求，并向<code class="du ls lt lu lv b">request</code>对象添加一个<code class="du ls lt lu lv b">file</code>属性</li><li id="4c8b" class="lc ld hi iz b ja ln jd lo jg lp jk lq jo lr js lj lk ll lm bi translated">中间件服务，用于1)使用Google API进行身份验证，2)定义存储桶，3)指定文件名，4)上传图像，以及5)发送响应</li><li id="75cc" class="lc ld hi iz b ja ln jd lo jg lp jk lq jo lr js lj lk ll lm bi translated">将上述服务作为中间件传递到您的路由，上传文件并返回最终的图像URL。</li></ol></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><h2 id="908e" class="kg kh hi bd ki kj kk kl km kn ko kp kq jg kr ks kt jk ku kv kw jo kx ky kz la bi translated">获取您的Google云服务帐户密钥文件</h2><p id="b4f1" class="pw-post-body-paragraph ix iy hi iz b ja le ij jc jd lf im jf jg md ji jj jk me jm jn jo mf jq jr js hb bi translated">在你的谷歌云控制台(console.cloud.google.com)中，转到<em class="mg"> API管理器</em>。</p><ol class=""><li id="fd8d" class="lc ld hi iz b ja jb jd je jg mh jk mi jo mj js lj lk ll lm bi translated">确保<em class="mg">谷歌云存储JSON API </em>已启用。</li><li id="6243" class="lc ld hi iz b ja ln jd lo jg lp jk lq jo lr js lj lk ll lm bi translated">转到<em class="mg">凭证&gt;创建凭证&gt;服务账户密钥</em></li><li id="d501" class="lc ld hi iz b ja ln jd lo jg lp jk lq jo lr js lj lk ll lm bi translated">在<em class="mg">服务账户</em>下，选择c <em class="mg">创建新的服务账户</em></li><li id="cbfc" class="lc ld hi iz b ja ln jd lo jg lp jk lq jo lr js lj lk ll lm bi translated">一旦创建完成，就可以生成<strong class="iz hj"> JSON </strong> keyfile <strong class="iz hj">。</strong></li><li id="525c" class="lc ld hi iz b ja ln jd lo jg lp jk lq jo lr js lj lk ll lm bi translated">将密钥文件保存到Express项目目录中。</li></ol><h2 id="5f9f" class="kg kh hi bd ki kj kk kl km kn ko kp kq jg kr ks kt jk ku kv kw jo kx ky kz la bi translated">接受图像作为用户输入</h2><p id="973a" class="pw-post-body-paragraph ix iy hi iz b ja le ij jc jd lf im jf jg md ji jj jk me jm jn jo mf jq jr js hb bi translated">你可以通过定义<code class="du ls lt lu lv b">enctype=multipart/form-data</code>并将图像拾取器设置为<code class="du ls lt lu lv b">&lt;input type="file"&gt;</code>来用标准HTML实现这一点，你将能够获得相同的结果。</p><p id="9ec3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我的例子中，处理后的输入是这样的:</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="3c9d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里的关键点是<code class="du ls lt lu lv b">FormData()</code>对象构造和<code class="du ls lt lu lv b">Content-Type</code>。</p><h2 id="8e81" class="kg kh hi bd ki kj kk kl km kn ko kp kq jg kr ks kt jk ku kv kw jo kx ky kz la bi translated">接受<code class="du ls lt lu lv b">POST</code>在服务器上上传图像的请求</h2><p id="6928" class="pw-post-body-paragraph ix iy hi iz b ja le ij jc jd lf im jf jg md ji jj jk me jm jn jo mf jq jr js hb bi translated">在您的express目录中运行<code class="du ls lt lu lv b">npm install --save @google-cloud/storage multer</code>来安装Google Cloud节点库的存储段。</p><p id="7c86" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接受下面来自前端请求的图像:</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="mk ml l"/></div><figcaption class="mm mn et er es mo mp bd b be z dx translated">接受POST请求的路由</figcaption></figure><p id="375b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">图像上传中间件:您将使用在第一步中生成的服务帐户密钥文件。</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="mk ml l"/></div><figcaption class="mm mn et er es mo mp bd b be z dx translated">这几乎与GCS节点库文档一字不差</figcaption></figure><p id="067d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从路由返回一个对象:</p><pre class="ju jv jw jx fd mq lv mr ms aw mt bi"><span id="f28b" class="kg kh hi lv b fi mu mv l mw mx">{<br/>  imageUrl: <a class="ae kf" href="https://storage.googleapis.com/bucket-name/file-name" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/bucket-name/file-name</a>.jpg<br/>}</span></pre><p id="3723" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">可以在浏览器中直接访问该URL，公开提供图像供您的应用程序使用。</p><p id="ffb3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">感谢阅读！我希望这有助于你继续你的旅程，创造一些了不起的东西。</p></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><p id="a067" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这篇文章中的知识是在创建一个基于活动的约会应用程序<a class="ae kf" href="https://datehatcherapp.com" rel="noopener ugc nofollow" target="_blank"><strong class="iz hj"><em class="mg"/></strong></a><strong class="iz hj"><em class="mg"/></strong>时发现的。即将登陆您附近的应用商店。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es my"><img src="../Images/db002884ff8400436c07dd23b98694dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GKAUV2cIpoMvBK-Y-ZAUtg.png"/></div></div><figcaption class="mm mn et er es mo mp bd b be z dx translated">约会孵化器——让你约会的约会应用</figcaption></figure></div></div>    
</body>
</html>