<html>
<head>
<title>Merge, clean, transform your CSVs easily with BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用BigQuery轻松合并、清理和转换您的CSV</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/merge-clean-transform-your-csvs-easily-with-bigquery-3a73c0c26d57?source=collection_archive---------1-----------------------#2020-10-20">https://medium.com/google-cloud/merge-clean-transform-your-csvs-easily-with-bigquery-3a73c0c26d57?source=collection_archive---------1-----------------------#2020-10-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/098454327098af8c198af9e13026126d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*17epMZAuO7yqMaawam1OsA.png"/></div></div></figure><p id="3129" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">CSV(逗号分隔值)格式是<strong class="is hj">最常见的文本文件格式</strong>之一，用于共享结构化数据，易于<strong class="is hj">人类</strong>，任何软件如<strong class="is hj"> Google Sheet和Microsoft Excel </strong>，或数据库引擎如<strong class="is hj"> MySQL、PostgreSql或BigQuery </strong>阅读。</p><p id="75eb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，这种格式的流行导致<strong class="is hj">将它用于大量数据</strong>难以在本地管理<strong class="is hj">并将它们加载到软件或本地数据库中。因此，通过保持CSV格式，一些<strong class="is hj">基本操作变得无法</strong>手动快速执行:</strong></p><ul class=""><li id="579e" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><strong class="is hj">更新CSV文件内容</strong>，如清除不良值或删除过时行。</li><li id="c1cb" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj">更新字段格式</strong>，如日期格式，或单位。</li><li id="eb41" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj">合并或拆分列</strong>，如地址。</li><li id="0fdb" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">将几个文件连接在一起，尤其是当你有一个支点的时候。<br/> <strong class="is hj"> <em class="kc">例如</em> </strong>，一个客户的CSV文件(带<code class="du kd ke kf kg b">customerId</code>)和一个订单的CSV文件(每个订单带<code class="du kd ke kf kg b">customerId</code>),你要在<code class="du kd ke kf kg b">customerId</code>上加入这些文件以获得每个订单的客户详细信息。</li></ul><p id="15ef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kc">在Google Cloud上，你有，大部分时间，</em> <strong class="is hj"> <em class="kc">这些CSV文件都存储在云存储上。</em> </strong></p><h1 id="4441" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">计算引擎(坏)解决方案</h1><p id="5560" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">如果您的<strong class="is hj">本地机器不够强大</strong>来管理CSV文件，<strong class="is hj">第一个想法是在计算引擎上使用强大的云服务器</strong>。</p><p id="5901" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该过程类似于您的本地环境:</p><ul class=""><li id="cc52" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><strong class="is hj">从云存储中下载</strong>CSV文件</li><li id="9c2c" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj">在计算引擎实例上执行转换</strong></li><li id="dddd" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj">上传</strong>新的CSV文件到云存储</li></ul><p id="bee6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用<strong class="is hj"> linux bash脚本</strong>，你将能够<strong class="is hj">对文件</strong>执行如此简单的操作，比如用<code class="du kd ke kf kg b"><a class="ae lk" href="https://www.gnu.org/software/sed/manual/sed.html" rel="noopener ugc nofollow" target="_blank">sed</a></code>替换字符，或者用<code class="du kd ke kf kg b"><a class="ae lk" href="https://man7.org/linux/man-pages/man1/split.1.html" rel="noopener ugc nofollow" target="_blank">split</a></code>只提取你想要的列。</p><p id="1dee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是<strong class="is hj">很快</strong>，当你不得不<strong class="is hj">构建更高级的转换</strong>，比如合并、拆分或连接，你就有了<strong class="is hj">bash脚本的问题和困难</strong>。</p><p id="8e90" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以使用<strong class="is hj">更方便的脚本语言</strong>，像<a class="ae lk" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank"> Python脚本和熊猫</a>库，但是在内存中加载Gb，甚至Tb的数据<strong class="is hj">需要时间，磁盘空间，内存使用，因此是昂贵的</strong>。</p><h1 id="5296" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">BigQuery解决方案</h1><p id="8678" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">BigQuery是一个<strong class="is hj">强大的分析引擎，可以在几秒钟内处理Tb和Pb的数据</strong>。当你有CSV文件时，有<strong class="is hj"> 2种方法用BigQuery查询数据</strong>:</p><ul class=""><li id="f1cd" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><a class="ae lk" href="https://cloud.google.com/bigquery/docs/loading-data" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">使用加载作业将您的数据从云存储加载到BigQuery </strong> </a>原生表中。<em class="kc">操作免费。</em>你要支付BigQuery上的存储<em class="kc">(还有不删除源文件的话云存储上的存储)。</em></li><li id="2823" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj">创建一个</strong> <a class="ae lk" href="https://cloud.google.com/bigquery/external-data-cloud-storage" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">外部表</strong>，引用CSV文件</a>在云存储中的位置。你将只支付云存储上的存储；<strong class="is hj">无事成BigQuery </strong>。</li></ul><p id="b471" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这两种解决方案都有自己的首选用例</p><ul class=""><li id="bbe6" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">本机表提供了更好的性能和分区/集群能力。然而，在新文件或源文件更新的情况下，您必须执行新的加载和比较。</li><li id="c200" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj">外部表的查询速度较慢，但允许定义通配符文件模式</strong> ( <code class="du kd ke kf kg b">my-file-*.csv</code>)来动态包含所有新文件，并考虑现有文件的变化。</li></ul><p id="e23c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kc">在当前上下文中，外部表更有趣是因为</em> <strong class="is hj"> <em class="kc">我们要转换存储在云存储</em> </strong> <em class="kc">中的CSV文件，但不排他。</em></p><p id="1534" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一个<strong class="is hj">大查询表(本地或外部)是一个抽象层</strong>，当你编写查询时，你不必担心数据的位置。所以，<strong class="is hj">要查询数据，在</strong>表中执行一个简单的SQL查询！</p><p id="480f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kc">在这两种情况下，你都要为你查询的数据量付费。</em></p></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><p id="5952" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">那是用来加载和查询数据的。为了将数据导出到云存储，最近发布了一个全新的功能<a class="ae lk" href="https://cloud.google.com/bigquery/docs/release-notes#October_14_2020" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"/></a>，它在这个用例中非常有用</p><blockquote class="ls lt lu"><p id="488b" class="iq ir kc is b it iu iv iw ix iy iz ja lv jc jd je lw jg jh ji lx jk jl jm jn hb bi translated"><a class="ae lk" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/other-statements#export_data_statement" rel="noopener ugc nofollow" target="_blank">导出数据</a>:<code class="du kd ke kf kg b">EXPORT DATA</code>语句将查询结果导出到外部存储位置</p></blockquote><h2 id="9b74" class="ly ki hi bd kj lz ma mb kn mc md me kr jb mf mg kv jf mh mi kz jj mj mk ld ml bi translated">使用BigQuery转换CSV文件</h2><p id="d904" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">“从外部位置读取数据”和“导出数据”这两个特性允许您<strong class="is hj">从云存储</strong>查询数据，以及<strong class="is hj">通过<strong class="is hj">使用BigQuery引擎执行转换</strong>将结果存储到云存储</strong>。</p><p id="7a25" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，开始创建外部表</p><pre class="mm mn mo mp fd mq kg mr ms aw mt bi"><span id="5290" class="ly ki hi kg b fi mu mv l mw mx">CREATE OR REPLACE EXTERNAL TABLE mydataset.sales<br/>OPTIONS (<br/>  format = 'CSV',<br/>  uris = ['gs://mybucket/sales-2019*.csv',<br/>          'gs://mybucket/sales-2020*.csv'],<br/>  skip_leading_rows = 1<br/>)</span></pre><p id="de60" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，只需查询它并将结果导出到云存储</p><pre class="mm mn mo mp fd mq kg mr ms aw mt bi"><span id="ba27" class="ly ki hi kg b fi mu mv l mw mx">EXPORT DATA OPTIONS(<br/>  uri='gs://mybucket/transformed/sales-*.csv',<br/>  format='CSV',<br/>  overwrite=true,<br/>  header=true,<br/>  field_delimiter=';') AS<br/>SELECT field1, field2 FROM mydataset.sales ORDER BY field1 </span></pre><p id="11e8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">仅此而已！对存储在云存储中的CSV文件进行复杂的提取-转换-加载，只需几秒钟，只需几美元！停止写无聊的脚本来浪费你的时间！！</p><h1 id="3dc1" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">超出</h1><p id="cfc8" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">因为使用了BigQuery，所以<strong class="is hj">也可以使用BigQuery </strong>的所有牛逼特性。</p><ul class=""><li id="3ede" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><strong class="is hj">在转换过程中使用复杂的SQL和分析功能</strong>，</li><li id="6156" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj">将CSV数据与BigQuery数据</strong>连接，甚至从其他外部来源，如其他文件、<a class="ae lk" href="https://cloud.google.com/bigquery/external-data-drive" rel="noopener ugc nofollow" target="_blank"> Google Drive/Sheet </a>、<a class="ae lk" href="https://cloud.google.com/bigquery/docs/cloud-sql-federated-queries" rel="noopener ugc nofollow" target="_blank">云SQL数据库</a>、……</li><li id="910a" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj">用BigQuery 的</strong> <a class="ae lk" href="https://cloud.google.com/bigquery-ml/docs/introduction" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> ML功能</strong>丰富输出</a></li></ul><p id="6a20" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于所有这些，你只需为你处理的数据量付费。没有要调配的虚拟机，没有要编写、测试和应用的脚本。只有<strong class="is hj">几个配置步骤和SQL语法。</strong> <br/>尽情享受吧！！</p></div></div>    
</body>
</html>