<html>
<head>
<title>Enable Emojis in MySQL on Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google Cloud上的MySQL中启用表情符号</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/enable-full-unicode-in-mysql-on-google-cloud-aaa2635486d6?source=collection_archive---------1-----------------------#2017-11-09">https://medium.com/google-cloud/enable-full-unicode-in-mysql-on-google-cloud-aaa2635486d6?source=collection_archive---------1-----------------------#2017-11-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c2a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你在Google Cloud上使用MySQL作为你的数据库服务吗？例如，您是否希望在您的数据库中启用“完全”UTF-8支持来启用表情符号？然后继续读下去。</p><p id="6b8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有些人可能不知道，MySQL中默认的utf8字符集并不完全符合UTF-8标准。MySQL后来引入了utf8mb4编码来解决这个问题。</p><p id="1e2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Mathias 的这个<a class="ae jd" href="https://mathiasbynens.be/notes/mysql-utf8mb4" rel="noopener ugc nofollow" target="_blank">博客在概述修复MySQL方面问题的具体步骤方面做得非常出色。然而，让它在Google Cloud上工作是有一定区别的。</a></p><h1 id="b984" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">支持</h1><p id="0d94" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在我们开始之前，我们需要尽一切办法备份数据！这在Google Cloud SQL上很容易。可用的选项很少。所有这些都是从在Google Cloud SQL控制台中打开数据库实例开始的。</p><ul class=""><li id="ab98" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><strong class="ih hj">手动备份</strong>:进入管理备份，点击创建备份。搞定了。</li><li id="7c00" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><strong class="ih hj">导出您的数据库</strong>:在Google Cloud SQL控制台中打开您的数据库。您应该会看到一个导出选项。这实际上是一个mysql转储。你可以让GCP在云存储中生成一个. sql文件，一旦导出完成，你就可以轻松下载。</li><li id="da5c" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">克隆你的实例:这是我的最爱。Google允许你克隆一个包含数据的SQL实例！这太棒了。这样做可以让您在投入生产之前有一个即时的测试平台来测试您的更改。只需点击克隆，并按照步骤，你应该设置在几分钟内。</li></ul><p id="0853" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们已经备份了数据，让我们开始吧。</p><h1 id="2872" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">步骤1:创建一个数据库转换脚本</h1><p id="51c9" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">为了转换DB编码，您需要在数据库、表和列级别上编写ALTER命令。我发现这里有用的一点是创建一个包含所有迁移命令的. sql脚本。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="f953" class="le jf hi la b fi lf lg l lh li"># Convert the DB first<br/>ALTER DATABASE &lt;database_name&gt; <br/>CHARACTER SET = utf8mb4 <br/>COLLATE = utf8mb4_unicode_ci;</span><span id="0e32" class="le jf hi la b fi lj lg l lh li"># Convert each table<br/>ALTER TABLE &lt;table_name&gt; CONVERT TO <br/>CHARACTER SET utf8mb4 <br/>COLLATE utf8mb4_unicode_ci;</span><span id="bdb3" class="le jf hi la b fi lj lg l lh li"># Convert each column<br/># All varchar columns should be converted to stay consistent<br/>ALTER TABLE &lt;table_name&gt;<br/>  CHANGE &lt;varchar_col1&gt; &lt;varchar_col1&gt; VARCHAR(1024) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,<br/>  CHANGE &lt;varchar_col2&gt; &lt;varchar_col2&gt; VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</span><span id="764c" class="le jf hi la b fi lj lg l lh li"># Repair each table<br/>REPAIR TABLE &lt;table_name&gt;</span><span id="ed13" class="le jf hi la b fi lj lg l lh li"># Optimize each table<br/>OPTIMIZE TABLE &lt;table_name&gt;</span></pre><p id="1ce4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是的，我知道为每个数据库、每个表、每个列编写这个脚本很乏味，但显然这就是它的工作方式。请<strong class="ih hj">不要忽略</strong>修复/优化步骤，否则您可能会面临数据损坏问题。</p><p id="a9ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再次声明:请在尝试之前备份您的数据！一个建议是在您的数据库克隆中尝试使用这个脚本来验证您的数据。谷歌云中的克隆选项也让这变得非常简单。这是一个向后兼容的步骤，因此，您的所有服务应该没有任何中断。</p><h1 id="1fa3" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">步骤2:更新Google实例上的MySQL配置</h1><p id="9bbd" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><strong class="ih hj">注意</strong>:此步骤可能会中断您的生产服务。这需要重新启动数据库并改变连接行为！</p><p id="1431" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要在Google Cloud SQL实例上设置以下标志</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="2490" class="le jf hi la b fi lf lg l lh li"># MySQL actual config variable<br/># Google Cloud SQL actually calls this character_set_server</span><span id="3fe7" class="le jf hi la b fi lj lg l lh li">character-set-server: utf8mb4</span></pre><p id="0286" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这在<a class="ae jd" href="https://cloud.google.com/sql/docs/mysql/flags" rel="noopener ugc nofollow" target="_blank">如何更新数据库标志</a>中有很好的记录。</p><p id="3474" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>:你会看到在其他博客中，包括我之前提到的那篇，有6-7个配置变量需要在服务器端和客户端更新。MySQL 5.7对此进行了大幅简化。<strong class="ih hj">以上参数是您需要在实例</strong>上更改的唯一配置。</p><h1 id="0f3b" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">步骤3:重启实例并验证！</h1><p id="c1a9" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这是令人失望的！当您在Google控制台上编辑实例时，您可能会在UI上的实例中看到您的新标志集，但是它<strong class="ih hj">可能还没有生效</strong>！不知道这是功能还是bug。</p><p id="5008" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证这一点的最简单方法是转到控制台上的“查看错误日志”并搜索<code class="du lk ll lm la b">character_set_server</code>。注意，这不同于MySQL的<code class="du lk ll lm la b">character-set-server</code>参数。</p><figure class="kv kw kx ky fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es ln"><img src="../Images/4b189ea952789e8acd126f0504d7741b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4H7jN-KhOHkCDMVT0wivlQ.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx translated">Google Cloud上的Stackdriver日志</figcaption></figure><p id="09da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果配置有效，您应该在日志中看到<code class="du lk ll lm la b">character_set_server=utf8mb4</code>。最安全的做法是重启数据库。</p><h1 id="cfb8" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">就是这样！</h1><p id="5d34" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">就是这样！一旦数据库重新启动，您应该能够连接到您的数据库，而无需在您的客户机上做任何更改。最新的MySQL驱动程序会自动与服务器协商编码，您应该已经准备好了！</p><p id="19c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您看到失败，可能是由于以下原因。</p><ul class=""><li id="257d" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">您的应用服务器无法重新连接到重新启动的数据库实例。例如，如果您将Java与Hibernate一起使用，您需要有特定的配置来重新连接到DB。在这种情况下，重新启动应用服务器应该可以解决问题。</li><li id="8a3f" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">您的驱动程序可能无法正确协商编码。如果您使用的是旧版本的驱动程序，可能会发生这种情况。或者在连接时在连接属性中有特定的字符集配置，从而覆盖了协商。或者您正在与之对话的数据库尚未正确转换。删除客户端上的任何配置/修复数据库应该可以解决您的问题。</li></ul><p id="b39b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你需要快速回复，请发推文到<a class="ae jd" href="https://twitter.com/suvodeeppyne" rel="noopener ugc nofollow" target="_blank"> @suvodeeppyne </a>，否则欢迎在下面留下评论。</p><p id="edd0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">干杯！</p></div></div>    
</body>
</html>