<html>
<head>
<title>Quick and easy coders for POJOs in your Beam pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">波束管道中POJOs的快速简易编码器</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/quick-and-easy-coders-for-pojos-in-your-beam-pipeline-5d8e16994c1f?source=collection_archive---------0-----------------------#2021-07-23">https://medium.com/google-cloud/quick-and-easy-coders-for-pojos-in-your-beam-pipeline-5d8e16994c1f?source=collection_archive---------0-----------------------#2021-07-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7cfb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你并不孤单。当用Java编写第一个<a class="ae jd" href="https://beam.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Beam </a>管道时，我们中的许多人都被这条错误消息挡住了去路:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="5564" class="jn jo hi jj b fi jp jq l jr js">Exception in thread “main” java.lang.IllegalArgumentException: Unable to infer a coder and no Coder was specified. Please set a coder by invoking Create.withCoder() explicitly or a schema by invoking Create.withSchema().</span></pre><p id="4fe6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文演示了几种通过使用以下方法序列化普通旧Java对象(POJOs)来消除错误的方法:</p><ul class=""><li id="e738" class="jt ju hi ih b ii ij im in iq jv iu jw iy jx jc jy jz ka kb bi translated">可序列化</li><li id="7150" class="jt ju hi ih b ii kc im kd iq ke iu kf iy kg jc jy jz ka kb bi translated">阿帕奇Avro</li><li id="d889" class="jt ju hi ih b ii kc im kd iq ke iu kf iy kg jc jy jz ka kb bi translated">协议缓冲区</li></ul><p id="6414" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GitHub上的提供了完整的示例<a class="ae jd" href="https://github.com/anguillanneuf/beam-medium/tree/main/coders-beam" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="je jf jg jh fd ki er es paragraph-image"><div class="er es kh"><img src="../Images/275ef87d976f5f1eb8a53103662bcac3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*EF5aUeNOff-YXEyqBmCj4Q.png"/></div></figure></div><div class="ab cl kl km gp kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="hb hc hd he hf"><p id="4523" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看一个简单的射束管道。它创建一个<code class="du ks kt ku jj b">Player</code>对象的集合，并打印出<code class="du ks kt ku jj b">Player</code>的名称和分数。</p><ol class=""><li id="acc4" class="jt ju hi ih b ii ij im in iq jv iu jw iy jx jc kv jz ka kb bi translated">POJO —这是<code class="du ks kt ku jj b">Player</code>类的定义。</li></ol><figure class="je jf jg jh fd ki"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="7668" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.光束管道——这是一个简单的管道，首先创建一个<code class="du ks kt ku jj b">Players</code>的<code class="du ks kt ku jj b">PCollection</code>,然后在每个<code class="du ks kt ku jj b">Player</code>对象上执行一个元素式的<code class="du ks kt ku jj b">MapElement</code>转换。</p><figure class="je jf jg jh fd ki"><div class="bz dy l di"><div class="kw kx l"/></div></figure></div><div class="ab cl kl km gp kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="hb hc hd he hf"><h1 id="0fff" class="ky jo hi bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">可序列化</h1><p id="c5b7" class="pw-post-body-paragraph if ig hi ih b ii lv ik il im lw io ip iq lx is it iu ly iw ix iy lz ja jb jc hb bi translated">实现<code class="du ks kt ku jj b">Serializable</code>是序列化POJO最直接的方式。</p><ol class=""><li id="8889" class="jt ju hi ih b ii ij im in iq jv iu jw iy jx jc kv jz ka kb bi translated">使您的类从Serializable继承:</li></ol><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="2111" class="jn jo hi jj b fi jp jq l jr js">static class Player implements Serializable {}</span></pre><p id="e25c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.为<code class="du ks kt ku jj b">equal()</code>和<code class="du ks kt ku jj b">hashCode()</code>生成代码:</p><figure class="je jf jg jh fd ki er es paragraph-image"><div class="er es ma"><img src="../Images/2f4c88af4b9525bdeaa5a091d8516ec4.png" data-original-src="https://miro.medium.com/v2/resize:fit:890/0*diw8-9WalsNtDn5j"/></div></figure><p id="4259" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在IntelliJ中，这可以通过导航到<strong class="ih hj">代码</strong> &gt; <strong class="ih hj">生成……</strong>&gt;<strong class="ih hj">等于()和hashCode() </strong>来完成。</p><p id="4853" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行管道:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="a02a" class="jn jo hi jj b fi jp jq l jr js">mvn compile exec:java -Dexec.mainClass=SerializablePlayerExample</span></pre><p id="f891" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它将使用<code class="du ks kt ku jj b">DirectRunner</code>，除非你指定一个不同的流道。参见输出中的<code class="du ks kt ku jj b">Player</code>。请注意，输出元素可以按任何顺序排列。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="075b" class="jn jo hi jj b fi jp jq l jr js">kestrel: 100<br/>owl: 22<br/>finch: 95<br/>Process finished with exit code 0</span></pre><p id="5acd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完整示例见<a class="ae jd" href="https://github.com/anguillanneuf/beam-medium/blob/main/coders-beam/src/main/java/SerializablePlayerExample.java" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><h1 id="6bf8" class="ky jo hi bd kz la mb lc ld le mc lg lh li md lk ll lm me lo lp lq mf ls lt lu bi translated">Avro</h1><p id="fa52" class="pw-post-body-paragraph if ig hi ih b ii lv ik il im lw io ip iq lx is it iu ly iw ix iy lz ja jb jc hb bi translated">没听说过<a class="ae jd" href="https://avro.apache.org/" rel="noopener ugc nofollow" target="_blank">阿帕奇Avro </a>的也不用担心。它是一个广泛使用的数据序列化系统，由Beam支持。</p><p id="acb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下步骤将基于您的POJO使用Avro生成一个Java类:</p><ol class=""><li id="27a4" class="jt ju hi ih b ii ij im in iq jv iu jw iy jx jc kv jz ka kb bi translated"><a class="ae jd" href="https://avro.apache.org/releases.html#Download" rel="noopener ugc nofollow" target="_blank">下载</a> Avro。</li><li id="a344" class="jt ju hi ih b ii kc im kd iq ke iu kf iy kg jc kv jz ka kb bi translated">使用Maven构建Avro。</li></ol><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="57e6" class="jn jo hi jj b fi jp jq l jr js">cd avro-src-1.10.2/lang/java/tools/<br/>mvn clean install</span></pre><p id="da59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.创建一个符合您的类定义的JSON格式的Avro模式文件。参见支持的<a class="ae jd" href="https://avro.apache.org/docs/1.10.2/spec.html#schema_primitive" rel="noopener ugc nofollow" target="_blank">类型</a>。</p><p id="05e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ks kt ku jj b">AvroPlayer.avsc</code></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="b5c1" class="jn jo hi jj b fi jp jq l jr js">{<br/>  "type":"record",<br/>  "name":"AvroPlayer",<br/>  "namespace":"utilities",<br/>  "doc":"A player.",<br/>  "fields":[<br/>    {<br/>      "name":"name",<br/>      "type":"string",<br/>      "doc":"The player name."<br/>    },<br/>    {<br/>      "name":"score",<br/>      "type":"int",<br/>      "doc":"The player score."<br/>    }<br/>  ]<br/>}</span></pre><p id="f5f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.基于您在<code class="du ks kt ku jj b">.avsc</code>文件中的类定义生成一个Java类:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="fa7a" class="jn jo hi jj b fi jp jq l jr js">java -jar \<br/>  ~/avro-src-1.10.2/lang/java/tools/target/avro-tools-1.10.2.jar \<br/>  compile schema \<br/>  path/to/your/.avsc/file \<br/>  destination/folder/</span></pre><p id="e483" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行管道:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="03cc" class="jn jo hi jj b fi jp jq l jr js">mvn compile exec:java -Dexec.mainClass=AvroPlayerExample</span></pre><p id="230b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同样，它将使用<code class="du ks kt ku jj b">DirectRunner</code>运行。输出元素可以按任何顺序排列。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="3df9" class="jn jo hi jj b fi jp jq l jr js">kestrel: 100<br/>owl: 22<br/>finch: 95<br/>Process finished with exit code 0</span></pre><p id="d39e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看完整的例子<a class="ae jd" href="https://github.com/anguillanneuf/beam-medium/blob/main/coders-beam/src/main/java/AvroPlayerExample.java" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><h1 id="1e3e" class="ky jo hi bd kz la mb lc ld le mc lg lh li md lk ll lm me lo lp lq mf ls lt lu bi translated">协议缓冲区</h1><p id="4990" class="pw-post-body-paragraph if ig hi ih b ii lv ik il im lw io ip iq lx is it iu ly iw ix iy lz ja jb jc hb bi translated">Google <a class="ae jd" href="https://developers.google.com/protocol-buffers" rel="noopener ugc nofollow" target="_blank">协议缓冲区</a>是Beam支持的另一个广泛使用的数据序列化系统。</p><p id="0782" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下步骤将基于POJO在协议缓冲区中生成一个Java类:</p><ol class=""><li id="c1fa" class="jt ju hi ih b ii ij im in iq jv iu jw iy jx jc kv jz ka kb bi translated"><a class="ae jd" href="https://developers.google.com/protocol-buffers/docs/downloads" rel="noopener ugc nofollow" target="_blank">安装</a>协议。家酿在MacOS上为我工作。</li></ol><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="ae6b" class="jn jo hi jj b fi jp jq l jr js">brew install protoc</span></pre><p id="58fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.创建一个符合您的类定义的原型模式文件。</p><p id="979a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ks kt ku jj b">ProtoPlayer.proto</code></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="dfc0" class="jn jo hi jj b fi jp jq l jr js">syntax = "proto3";</span><span id="301d" class="jn jo hi jj b fi mg jq l jr js">package utilities;</span><span id="46d6" class="jn jo hi jj b fi mg jq l jr js">option java_outer_classname = "ProtoPlayer";</span><span id="43f2" class="jn jo hi jj b fi mg jq l jr js">message Player {<br/>  string name = 1;<br/>  int32 score = 2;<br/>}</span></pre><p id="5ae4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.中的类定义生成一个Java类。原型文件:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="58e2" class="jn jo hi jj b fi jp jq l jr js">protoc \<br/>  --proto_path /your/.proto/file/folder/ \<br/>  --java_out destination/folder/ \<br/>  path/to/your/.proto/file</span></pre><p id="cab1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再次运行管道:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="f6e4" class="jn jo hi jj b fi jp jq l jr js">mvn compile exec:java -Dexec.mainClass=ProtoPlayerExample</span></pre><p id="fe94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除非另有说明，否则它将使用<code class="du ks kt ku jj b">DirectRunner</code>运行。输出元素可以按任何顺序排列。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="7564" class="jn jo hi jj b fi jp jq l jr js">kestrel: 100<br/>owl: 22<br/>finch: 95<br/>Process finished with exit code 0</span></pre><p id="cc4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参见完整示例<a class="ae jd" href="https://github.com/anguillanneuf/beam-medium/blob/main/coders-beam/src/main/java/ProtoPlayerExample.java" rel="noopener ugc nofollow" target="_blank">此处</a>。</p></div><div class="ab cl kl km gp kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="hb hc hd he hf"><p id="cc92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文只介绍了几种序列化数据的方法，但是Beam支持更多的方法。希望我已经帮助你们中的一些人解决了使用Beam编写真正的业务逻辑的问题！</p></div></div>    
</body>
</html>