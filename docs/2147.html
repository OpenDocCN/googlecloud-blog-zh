<html>
<head>
<title>Cloud Spanner export query results using Dataproc Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dataproc无服务器导出查询结果</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-spanner-export-query-results-using-dataproc-serverless-6f2f65b583a4?source=collection_archive---------1-----------------------#2022-03-31">https://medium.com/google-cloud/cloud-spanner-export-query-results-using-dataproc-serverless-6f2f65b583a4?source=collection_archive---------1-----------------------#2022-03-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/21e39f07bd450e9d8d995cccb4999fbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OhDE3jKutut9gWzeXsq8_g.jpeg"/></div></div></figure><p id="1b80" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Cloud Spanner是完全托管的关系数据库，规模不限，一致性强，可用性高达99.999%。在这篇文章中，我们将探索使用Dataproc Serverless为扳手表或SQL查询导出数据。</p><h1 id="10b7" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">主要优势</h1><ol class=""><li id="0575" class="km kn hi is b it ko ix kp jb kq jf kr jj ks jn kt ku kv kw bi translated">Dataproc Serverless是完全管理的、无服务器的和自动伸缩的。</li><li id="f8fd" class="km kn hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated"><a class="ae lc" href="https://github.com/GoogleCloudPlatform/dataproc-templates/tree/main/java/src/main/java/com/google/cloud/dataproc/templates/databases#executing-spanner-to-gcs-template" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> SpannerToGCS </strong> </a>模板是开源的，完全可定制的，可以随时用于简单的工作。</li><li id="c567" class="km kn hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">一旦作业结束，短暂火花资源就被释放。</li><li id="58d4" class="km kn hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">您可以以<strong class="is hj"> avro、parquet、csv和orc </strong>格式导出数据。</li></ol><h1 id="1f32" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">简单用法</h1><ol class=""><li id="b328" class="km kn hi is b it ko ix kp jb kq jf kr jj ks jn kt ku kv kw bi translated">如果你要使用“默认的”由GCP生成的VPC网络，请确保你已经启用了私有谷歌访问子网。您仍然需要启用如下的私人访问。(<a class="ae lc" href="https://cloud.google.com/dataproc-serverless/docs/concepts/network" rel="noopener ugc nofollow" target="_blank">详见此处</a>)</li></ol><figure class="le lf lg lh fd ij er es paragraph-image"><div class="er es ld"><img src="../Images/3b1552393115c07b39e070abf1da4389.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/0*2OKjt1b9tkrYIcYp.png"/></div></figure><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="ae8e" class="ln jp hi lj b fi lo lp l lq lr">gcloud compute networks subnets update default --region=us-central1 --enable-private-ip-google-access</span></pre><p id="eb5d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.为jar文件创建一个GCS存储桶和暂存位置。</p><p id="ce40" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.在预装了<a class="ae lc" href="https://cloud.google.com/shell/docs/how-cloud-shell-works" rel="noopener ugc nofollow" target="_blank">各种工具</a>的云壳中克隆git repo。或者使用任何预装JDK 8+，Maven和Git的机器。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="250a" class="ln jp hi lj b fi lo lp l lq lr">git clone <a class="ae lc" href="https://github.com/GoogleCloudPlatform/dataproc-templates.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/dataproc-templates.git</a></span><span id="cff1" class="ln jp hi lj b fi ls lp l lq lr">cd dataproc-templates/java</span></pre><p id="7b57" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.获取身份验证凭据(以提交作业)。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="d4d8" class="ln jp hi lj b fi lo lp l lq lr">gcloud auth application-default login</span></pre><p id="a38d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.执行SpannerToGCS模板。<br/>例如:</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="0bbc" class="ln jp hi lj b fi lo lp l lq lr">export GCP_PROJECT=my-test-gcp-proj1<br/>export REGION=us-central1<br/>export GCS_STAGING_LOCATION=gs://my-test-gcp-proj1/staging</span><span id="05c1" class="ln jp hi lj b fi ls lp l lq lr">bin/start.sh \<br/>-- --template SPANNERTOGCS \<br/>--templateProperty project.id=my-test-gcp-proj1 \<br/>--templateProperty spanner.gcs.input.spanner.id=spann \<br/>--templateProperty spanner.gcs.input.database.id=testdb \<br/>--templateProperty "spanner.gcs.input.table.id=(select trip_id, bikeid, duration_minutes from bikeshare)" \<br/>--templateProperty spanner.gcs.output.gcs.path=gs://my-test-gcp-proj1/bikeshare/spark_export/ \<br/>--templateProperty spanner.gcs.output.gcs.saveMode=Overwrite</span></pre><p id="4540" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意</strong>:如果尚未启用，它会要求您启用Dataproc Api。</p><h1 id="1b6f" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">设置每日增量数据导出</h1><p id="bac6" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb lt jd je jf lu jh ji jj lv jl jm jn hb bi translated">有时需要日/周/月末导出。最重要的是，您可能希望只提取增量变更，因为在每次迭代中导出整个数据可能会有些过头。</p><p id="2b2c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意</strong>:无服务器Dataproc不支持实时作业。因此，如果目标是从Spanner到GCS实时复制变更，那么您将需要研究变更数据捕获(CDC)替代方案。</p><ol class=""><li id="8757" class="km kn hi is b it iu ix iy jb lw jf lx jj ly jn kt ku kv kw bi translated">使用Cloud Spanner的<a class="ae lc" href="https://cloud.google.com/spanner/docs/commit-timestamp" rel="noopener ugc nofollow" target="_blank">提交时间戳</a>特性，您可以跟踪插入/更新的行(删除不能被捕获)。</li><li id="b93c" class="km kn hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">重写提交给spark的sql查询，以捕获自上次执行以来的更改。例如:</li></ol><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="9060" class="ln jp hi lj b fi lo lp l lq lr">"spanner.gcs.input.table.id=(select trip_id, bikeid, duration_minutes from bikeshare where <!-- -->LastUpdateTime &gt;= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY);<!-- -->"</span></pre><p id="55dd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.计划批处理作业。<br/> GCP原生提供云调度+云功能，可用于提交spark批量作业。或者，也可以使用自我管理软件，如linux cron tab、jenkins等。</p><h1 id="826e" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">设置附加火花属性</h1><p id="dc2e" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb lt jd je jf lu jh ji jj lv jl jm jn hb bi translated">如果您需要<a class="ae lc" href="https://cloud.google.com/dataproc-serverless/docs/concepts/properties" rel="noopener ugc nofollow" target="_blank">指定Dataproc无服务器支持的spark属性</a>,比如调整驱动程序、内核、执行器等的数量。</p><p id="08d2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以编辑start.sh文件中的<a class="ae lc" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/bin/start.sh#L50" rel="noopener ugc nofollow" target="_blank"> OPT_PROPERTIES </a>值。</p><h1 id="60da" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">其他选择</h1><ol class=""><li id="cd13" class="km kn hi is b it ko ix kp jb kq jf kr jj ks jn kt ku kv kw bi translated">基于GUI的工具<a class="ae lc" href="https://dbeaver.io/" rel="noopener ugc nofollow" target="_blank"> DBeaver </a>将sql查询结果导出为csv格式。</li><li id="493d" class="km kn hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated"><a class="ae lc" href="https://cloud.google.com/bigquery/docs/cloud-spanner-federated-queries" rel="noopener ugc nofollow" target="_blank"> Cloud Spanner联邦查询</a>使用BigQuery将数据导出为Avro、CSV和其他支持的格式。</li><li id="af91" class="km kn hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">用于<a class="ae lc" href="https://cloud.google.com/dataflow/docs/guides/templates/provided-batch#cloud-spanner-to-cloud-storage-text" rel="noopener ugc nofollow" target="_blank">扳手到文本</a>导出为csv文件或<a class="ae lc" href="https://cloud.google.com/spanner/docs/export#exporting_a_subset_of_tables" rel="noopener ugc nofollow" target="_blank">扳手到Avro </a>的数据流模板</li></ol></div></div>    
</body>
</html>