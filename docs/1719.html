<html>
<head>
<title>Things I wish I knew about Pub/Sub, Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于Pub/Sub，我希望知道的事情，第3部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/things-i-wish-i-knew-about-pub-sub-part-3-b8947b49224b?source=collection_archive---------0-----------------------#2020-12-18">https://medium.com/google-cloud/things-i-wish-i-knew-about-pub-sub-part-3-b8947b49224b?source=collection_archive---------0-----------------------#2020-12-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2db4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第<a class="ae jd" rel="noopener" href="/google-cloud/things-i-wish-i-knew-about-google-cloud-pub-sub-852fac1ffbc6"> 1 </a>和<a class="ae jd" rel="noopener" href="/google-cloud/things-i-wish-i-knew-about-google-cloud-pub-sub-part-2-b037f1f08318"> 2 </a>部分，我的同事Megan和Alex向你介绍了Pub/Sub服务及其官方客户端库。在最后一节中，我将介绍一些剩余的主题，包括<a class="ae jd" href="https://cloud.google.com/pubsub/docs/push" rel="noopener ugc nofollow" target="_blank">推送订阅</a>、<a class="ae jd" href="https://cloud.google.com/pubsub/docs/emulator" rel="noopener ugc nofollow" target="_blank">模拟器</a>、<a class="ae jd" href="https://cloud.google.com/pubsub/docs/access-control" rel="noopener ugc nofollow" target="_blank"> IAM策略</a>和<a class="ae jd" href="https://cloud.google.com/pubsub/docs/monitoring" rel="noopener ugc nofollow" target="_blank">健康指标</a>。</p><h1 id="c361" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">什么是推送订阅，我何时使用它？</h1><h2 id="575f" class="kc jf hi bd jg kd ke kf jk kg kh ki jo iq kj kk js iu kl km jw iy kn ko ka kp bi translated">推送订阅允许发布/订阅向您发送消息:发布/订阅将消息作为HTTP POST请求发送到预定义的HTTPS地址(也称为推送端点)。</h2><p id="2593" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">与主动向Pub/Sub请求消息的拉订阅不同，推订阅允许您配置推端点，Pub/Sub将消息传递到该推端点。</p><p id="b379" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果出现以下任何情况，您应该考虑推送订阅:</p><ul class=""><li id="89ee" class="kv kw hi ih b ii ij im in iq kx iu ky iy kz jc la lb lc ld bi translated">您不能在订户应用程序中包含任何客户端库代码。</li><li id="1af0" class="kv kw hi ih b ii le im lf iq lg iu lh iy li jc la lb lc ld bi translated">您的用户不允许发出任何请求。</li><li id="0d39" class="kv kw hi ih b ii le im lf iq lg iu lh iy li jc la lb lc ld bi translated">您的订户应以相同的方式处理来自不同订阅的消息，即您对不同的订阅使用相同的推送端点。</li></ul><p id="10d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">推送订阅中的消息确认与请求订阅中的不同。在pull中，您的应用程序代码必须在接收到的消息上显式调用<strong class="ih hj">ack</strong>nowledge(<strong class="ih hj">ack</strong>)方法。在push中，push请求的成功响应代码(101、200、201、202、204之一)用作ack。</p><p id="dca2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当推送请求获得其他响应代码(表示请求失败)时，消息被视为被否定，并将发生以下情况:</p><ul class=""><li id="6474" class="kv kw hi ih b ii ij im in iq kx iu ky iy kz jc la lb lc ld bi translated">发布/订阅将尝试以指数回退的方式重新传递消息。这意味着你应该期待更长的时间之间的后续交货。</li><li id="1899" class="kv kw hi ih b ii le im lf iq lg iu lh iy li jc la lb lc ld bi translated">Pub/Sub还将降低未完成消息的限制，即Pub/Sub已经发出但尚未被确认或否定的消息。</li></ul><p id="dfe8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些措施旨在降低发送到终端的消息的速率和数量，以便终端有机会恢复。<a class="ae jd" href="https://cloud.google.com/pubsub/docs/push#quotas_limits_and_delivery_rate" rel="noopener ugc nofollow" target="_blank">关于这些计算的详细说明</a>在官方文件中。</p><p id="ffa4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">拉订阅和推订阅都满足高吞吐量需求。但是对于每个区域的每个订阅，推送传递模式的最大吞吐量是拉取传递模式的一半。要了解准确的报价单位，请查看<a class="ae jd" href="https://cloud.google.com/pubsub/quotas#quotas" rel="noopener ugc nofollow" target="_blank">配额限制</a>的参考页面。</p><h1 id="10bb" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">我如何测试服务？</h1><h2 id="f6a2" class="kc jf hi bd jg kd ke kf jk kg kh ki jo iq kj kk js iu kl km jw iy kn ko ka kp bi translated">测试你的代码而不产生任何成本的一个好方法是使用Pub/Sub <a class="ae jd" href="https://cloud.google.com/pubsub/docs/emulator" rel="noopener ugc nofollow" target="_blank">模拟器</a>，它拥有大多数基本功能，还有一些<a class="ae jd" href="https://cloud.google.com/pubsub/docs/emulator#known_limitations" rel="noopener ugc nofollow" target="_blank">已知的限制</a>。</h2><p id="d865" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">安装了cloud SDK <a class="ae jd" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank">并初始化了</a>和<a class="ae jd" href="https://cloud.google.com/sdk/docs/initializing" rel="noopener ugc nofollow" target="_blank"/>之后，您可以使用以下命令启动模拟器:</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="7567" class="kc jf hi lo b fi ls lt l lu lv">gcloud beta emulators pubsub start \<br/>    --project=abc \<br/>    --host-port=localhost:8085</span></pre><p id="d9c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个命令在您的本地主机端口8085上启动模拟器—如果您没有指定值，这也是默认的。如果您没有使用<code class="du lw lx ly lo b">--project</code>标志提供一个虚拟项目ID，模拟器将使用您用gcloud初始化的项目。从那里，您应该将环境变量<code class="du lw lx ly lo b">PUBSUB_EMULATOR_HOST</code>设置为<code class="du lw lx ly lo b">localhost:8085</code>，并且您可以开始使用官方客户端库与仿真的发布/订阅服务进行交互。</p><p id="3aaa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每次您启动模拟器时，您都是从一张白纸开始的。你不应该期待任何现有的主题或订阅。当您重新启动模拟器时，会话期间创建的主题或订阅也会消失。</p><p id="5f67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果出于集成测试或其他原因需要在容器中运行模拟器，应该将模拟器主机的<code class="du lw lx ly lo b">--host-port</code>标志更新为<code class="du lw lx ly lo b">0.0.0.0</code>，而不是使用默认的<code class="du lw lx ly lo b">localhost</code>。这将模拟器运行的端口绑定到容器的网络名称空间中的所有IP地址。无论容器的外部IP地址是什么，模拟器总是可以在指定的端口上访问。</p><p id="a34a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下命令在端口8085上启动Docker容器内的发布/订阅模拟器，并向Docker主机上的端口8080公开容器端口8085。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="6a41" class="kc jf hi lo b fi ls lt l lu lv">docker run --rm -ti -p 8080:8085 \<br/>    gcr.io/google.com/cloudsdktool/cloud-sdk:<strong class="lo hj">$VERSION</strong>-emulators \<br/>    gcloud beta emulators pubsub start \<br/>      --project=abc \<br/>      --host-port=0.0.0.0:8085</span></pre><p id="b68f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在GCP的<a class="ae jd" href="https://console.cloud.google.com/gcr/images/google.com:cloudsdktool/GLOBAL/cloud-sdk?gcrImageListsize=30" rel="noopener ugc nofollow" target="_blank">公共容器注册表</a>中，将<code class="du lw lx ly lo b"><strong class="ih hj">$VERSION</strong></code>替换为带有<code class="du lw lx ly lo b">&lt;version&gt;-emulators</code>标签的最新Google Cloud SDK映像的版本号。</p><p id="2879" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启动模拟器后，您可以在本地开发环境中将<code class="du lw lx ly lo b">PUBSUB_EMULATOR_HOST</code>设置为<code class="du lw lx ly lo b">localhost:8080</code>，使用Docker容器中运行的模拟器测试您的代码。下面的Python例子首先创建一个主题<code class="du lw lx ly lo b">my-topic</code>，然后在虚拟项目<code class="du lw lx ly lo b">abc</code>中列出主题。</p><pre class="lj lk ll lm fd ln lo lz bn ma mb bi"><span id="a446" class="mc jf hi lo b be md me l mf lv">git clone https://github.com/googleapis/python-pubsub<br/>cd python-pubsub/samples/snippets/<br/>export PUBSUB_EMULATOR_HOST=localhost:8080<br/>python publisher.py abc create my-topic<br/>python publisehr.py abc list</span></pre><p id="0bcf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽管在cloud.google.com上使用模拟器的示例是用Python编写的，但所有语言客户端库都支持使用模拟器。至于模拟器的功能与真正的发布/订阅服务的对等性，我建议随着新功能的增加，不时检查一下它的已知限制。</p><h1 id="6b4c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">如何在我的主题或订阅上配置IAM？</h1><h2 id="198b" class="kc jf hi bd jg kd ke kf jk kg kh ki jo iq kj kk js iu kl km jw iy kn ko ka kp bi translated">细粒度的<a class="ae jd" href="https://cloud.google.com/pubsub/docs/access-control" rel="noopener ugc nofollow" target="_blank">访问控制</a>可以通过在主题和订阅级别设置角色和权限来实现。</h2><p id="ffcd" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">有时，您可能希望限制用户或第三方服务对您的发布/订阅资源的操作。</p><p id="3ecb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，由某个服务帐户标识的下游消息使用者(可能来自不同的GCP项目)应该只有订阅权限，而没有更新订阅的消息保留策略的权限。这可以通过在该订阅上设置IAM策略来实现，这样它的策略成员(在本例中是服务帐户)就没有拥有<code class="du lw lx ly lo b">pubsub.subscription.update</code>权限的角色。具有该权限的角色的一个例子是<code class="du lw lx ly lo b">roles/pubsub.editor</code>。没有此权限的角色的一个例子是<code class="du lw lx ly lo b">roles/pubsub.subscriber</code>。</p><p id="c36b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在主题或订阅上设置IAM策略通常包括三个步骤:</p><ul class=""><li id="3b34" class="kv kw hi ih b ii ij im in iq kx iu ky iy kz jc la lb lc ld bi translated">获取JSON或YAML文件中主题或订阅的现有IAM策略。</li><li id="93ed" class="kv kw hi ih b ii le im lf iq lg iu lh iy li jc la lb lc ld bi translated">用您希望进行的更改更新JSON或YAML文件:添加/删除成员，添加/删除角色</li><li id="509b" class="kv kw hi ih b ii le im lf iq lg iu lh iy li jc la lb lc ld bi translated">将JSON或YAML文件中的更改应用到您的主题或订阅。</li></ul><p id="8b2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是您可以添加到主题或订阅的IAM策略中的<a class="ae jd" href="https://cloud.google.com/pubsub/docs/access-control#roles" rel="noopener ugc nofollow" target="_blank">预定义角色</a>的摘要。如果需要，还可以通过混搭<a class="ae jd" href="https://cloud.google.com/pubsub/docs/access-control#required_permissions" rel="noopener ugc nofollow" target="_blank">权限</a>自定义角色。(另见<a class="ae jd" rel="noopener" href="/google-cloud/gcp-iam-roles-explained-af84955346e7"> GCP IAM角色解释</a>)。)</p><h1 id="bde2" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">如何检查我的应用程序的健康状况？</h1><h2 id="9ccf" class="kc jf hi bd jg kd ke kf jk kg kh ki jo iq kj kk js iu kl km jw iy kn ko ka kp bi translated">发布/订阅<a class="ae jd" href="https://cloud.google.com/pubsub/docs/reference/error-codes" rel="noopener ugc nofollow" target="_blank">错误代码</a>允许您在开发过程中诊断您的问题。<a class="ae jd" href="https://cloud.google.com/monitoring/api/metrics_gcp#gcp-pubsub" rel="noopener ugc nofollow" target="_blank">指标</a>允许您检查您的主题和订阅的健康状况。</h2><p id="58de" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">新用户中常见的一些错误是认证错误，如<code class="du lw lx ly lo b">UNAUTHENTICATED</code>和<code class="du lw lx ly lo b">PERMISSION_DENIED</code>。这通常是由于将环境变量<code class="du lw lx ly lo b">GOOGLE_APPLICATION_CREDENTIALS</code>设置为不存在的或错误的服务帐户密钥文件，导致服务不知道您的请求所携带的身份或认为它缺乏适当的权限。</p><p id="44a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您使用尚未创建的主题或订阅，或者尝试创建已经创建的主题或订阅时，会出现<code class="du lw lx ly lo b">NOT_FOUND</code>和<code class="du lw lx ly lo b">ALREADY_EXISTS</code>。</p><p id="4e71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">至于最常见的指标，<a class="ae jd" href="https://console.cloud.google.com/cloudpubsub/" rel="noopener ugc nofollow" target="_blank"> Cloud Console for Pub/Sub </a>允许您查看和<a class="ae jd" href="https://cloud.google.com/monitoring/alerts/using-alerting-ui#create-policy" rel="noopener ugc nofollow" target="_blank">设置针对您的主题的<strong class="ih hj">发布请求</strong>和<strong class="ih hj">发布操作</strong>的警报</a>，以及针对您的订阅的<strong class="ih hj">未确认消息计数</strong>和<strong class="ih hj">最早消息年龄</strong>。</p><figure class="lj lk ll lm fd mh er es paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="er es mg"><img src="../Images/0c915a4cadbcec2fa23722fc258f00a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*51CrY7CqrM75v97l"/></div></div></figure><p id="4ba6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">发布请求</strong>指您发送的发布API调用，<strong class="ih hj">发布操作</strong>指发布的消息数量。当<a class="ae jd" href="https://cloud.google.com/pubsub/docs/publisher#batching" rel="noopener ugc nofollow" target="_blank">发布批处理</a>被启用时，多个消息可能在一个发布API调用中被发送，并且如果您的批处理大小大于一个消息，您应该期望<strong class="ih hj">发布操作</strong>的数量大于<strong class="ih hj">发布请求</strong>。</p><p id="d453" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">未确认消息计数</strong>和<strong class="ih hj">最早消息年龄</strong>指您订阅中未送达消息的数量和年龄。如果它们一起增长并保持上升，您应该注意，因为这意味着服务已经积累了无法传递或无法传递的消息。当积压邮件中的这些邮件在邮件保留期后过期时，您将面临永远失去它们的风险。</p><p id="aa11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想告诉你关于Pub/Sub的其他很酷的提示和技巧，但是这篇中型文章越来越长，所以我将把它们留到另一个时间。如果你想让我或我的同事写一个话题，请在下面给我们留言。感谢阅读！</p></div></div>    
</body>
</html>