<html>
<head>
<title>Identification of sources of mobile client connection failure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">识别移动客户端连接失败的原因</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/identification-of-sources-of-mobile-client-connection-failure-fec9dad8dd13?source=collection_archive---------1-----------------------#2018-05-11">https://medium.com/google-cloud/identification-of-sources-of-mobile-client-connection-failure-fec9dad8dd13?source=collection_archive---------1-----------------------#2018-05-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="401c" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">目标</h1><p id="505f" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这篇文章解释了如何为移动应用程序的开发者找到连接失败的原因，这些移动应用程序有一个提供内容的服务器后端。详细关注这一点对于减少影响用户体验的错误是必要的。</p><h1 id="e65f" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">摘要</h1><p id="39b4" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">描述了更好地理解客户端错误的想法，包括收集客户端数据、理解负载和往返时间、分布式跟踪和探测。用于检测不同错误条件的HTTP探针的示例代码位于Github gist 中，它已被用于创建下面讨论的原型Stackdriver dashboard。</p><h1 id="f477" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">背景</h1><p id="6846" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">一些应用程序会看到连接到服务器的移动客户端的客户端失败率，这很难解释。服务器日志会显示错误，但是您可能会发现客户端遇到的错误比服务器的错误率要高。这导致人们相信差异可能是由网络中的某个原因造成的。</p><p id="2901" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">可能是试图下载的媒体大小的分布以及安装了该应用的移动设备的群体中的互联网速度的变化使得没有足够的时间来为一定比例的客户端设备下载媒体。另一个原因是，移动应用程序中的请求可能会被取消。例如，用户动作触发了下载，但是当媒体需要时间来下载并且移动到另一个屏幕时，用户失去了耐心。其他潜在的错误原因包括国家或提供商阻止内容，以及用户因位置变化而失去连接。</p><h1 id="7db4" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">主意</h1><p id="a7a8" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">下面列出了一些深入了解这一点的想法。</p><h2 id="71a9" class="kh ig hi bd ih ki kj kk il kl km kn ip jo ko kp it js kq kr ix jw ks kt jb ku bi translated">1错误分析</h2><p id="aa81" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">您应该收集用户遇到的不同错误类别的数据，例如，在W3C网络错误日志建议中关于<a class="ae kb" href="https://www.w3.org/TR/network-error-logging/#reporting" rel="noopener ugc nofollow" target="_blank">错误报告</a>的章节中列出的。这些包括</p><ol class=""><li id="e5a5" class="kv kw hi jf b jg kc jk kd jo kx js ky jw kz ka la lb lc ld bi translated">无法解析DNS名称</li><li id="3112" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">无法建立TCP连接</li><li id="3be7" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">无法建立安全的TLS隧道</li><li id="2771" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">由于TLS协议错误，无法获取资源</li><li id="7838" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">由于HTTP协议错误，无法获取资源</li><li id="156c" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">由于套接字超时或错误，无法获取资源</li><li id="0026" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">由于重定向循环，无法获取资源</li></ol><p id="edee" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">错误类型可以按功能或有效负载大小(用于上传)、后端处理程序、设备、地理、协议和互联网提供商进行细分。此外，如果来源是重试或用户取消应该记录的操作。该细分可以洞察地理区域、访问能力差的提供商以及导致错误的用户操作。</p><p id="b06c" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">收集这些数据可能需要一些额外的日志记录和从客户端收集日志记录错误。Android<a class="ae kb" href="https://developer.android.com/reference/java/net/HttpURLConnection.html" rel="noopener ugc nofollow" target="_blank">HttpURLConnection</a>对象将返回HTTP响应代码，<a class="ae kb" href="https://developer.android.com/reference/java/net/HttpURLConnection.html#getResponseMessage()" rel="noopener ugc nofollow" target="_blank"> getResponseMessage() </a>获取响应消息，如果连接失败，但服务器仍然发送了有用的数据，<a class="ae kb" href="https://developer.android.com/reference/java/net/HttpURLConnection.html#getErrorStream()" rel="noopener ugc nofollow" target="_blank"> getErrorStream() </a>方法将返回错误流。如果只是在一个<a class="ae kb" href="https://developer.android.com/reference/java/net/URL.html#openConnection()" rel="noopener ugc nofollow" target="_blank"> URL.openConnection() </a>调用中捕获一个异常，那么应该记录IOException的特定子类以及消息。</p><p id="2441" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">这种方法的一个问题是，Java没有给出上述W3C定义的错误的可见性。但是，其他语言可以提供这些。详见下文。</p><h2 id="3634" class="kh ig hi bd ih ki kj kk il kl km kn ip jo ko kp it js kq kr ix jw ks kt jb ku bi translated">2往返时间分析</h2><p id="085a" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">由于慢速边缘网络导致的超时是下载媒体时最常见的问题。这个问题的研究人员大多着眼于往返时间(RTT)。使用RTT的原因是应用程序的行为不同。HTTP请求有不同的负载大小，网页有许多不同的元素必须下载，移动应用程序不同于web应用程序。测量RTT的方法在<a class="ae kb" href="https://tools.ietf.org/html/rfc2988" rel="noopener ugc nofollow" target="_blank"> RFC 2988 </a>中描述。Google Cloud Load Balancer (GCLB)服务测量RTT，并且可以使用<a class="ae kb" href="https://cloud.google.com/compute/docs/load-balancing/http/backend-service?utm_source=release-notes&amp;utm_medium=email&amp;utm_campaign=2018-april-release-notes-2-en#user-defined-request-headers" rel="noopener ugc nofollow" target="_blank">自定义头</a>为带有client_rtt_msec HTTP头的特定请求检索它。</p><p id="bd19" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">该数据还可以根据有效载荷大小、地理位置和误差进行分解，以寻找在高RTT区域中是否存在高误差率。</p><p id="729d" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">在不同条件下，可以在RTT、有效载荷大小和HTTP下载时间之间建立关联。例如，<a class="ae kb" href="https://www.switch.ch/network/tools/tcp_throughput/" rel="noopener ugc nofollow" target="_blank"> TCP吞吐量计算器</a>对稳定吞吐量进行计算。这比HTTP下载简单，HTTP下载由于初始窗口大小和客户端条件的变化(如现有连接是否存在)而变得复杂。因此，稳定下载条件下的吞吐量和下载较小文件的吞吐量会有所不同</p><p id="2e24" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">RTT可以与离服务器的地理距离大致相关。Landa (2013b)和其他人讨论了RTT的测量、影响它的主要因素，以及他们的数据集的统计建模，该数据集由超过2亿个RTT样本组成，在他们的研究中有1900万个测量值<em class="lj">测量互联网地理和RTT </em> ( <a class="ae kb" href="http://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=6614151" rel="noopener ugc nofollow" target="_blank">链接</a>)。实际数据在Landa (2013a) <em class="lj">互联网往返时间的大规模地理</em>中讨论。他们有一些关于RTT的重要发现:</p><ol class=""><li id="d317" class="kv kw hi jf b jg kc jk kd jo kx js ky jw kz ka la lb lc ld bi translated">RTT永远比光速慢。在10，000 km的路由距离处，中值RTT大约为200毫秒，但是变化到大约1，000毫秒</li><li id="c5be" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">由于可用的物理连接，路由距离通常比源和目的地之间的大圆距离更长，这在一些偏远地区可能会被夸大，如大洋洲和非洲。</li><li id="13fe" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">观察到一些不能简单地用地理上的偏远来解释的极端过度布线距离，并导致非常大的RTT。例如，作者发现东欧/西欧和亚太地区之间的一些交通通过美国进行路由，这意味着路由距离Dz为19，000 km。</li></ol><h2 id="738e" class="kh ig hi bd ih ki kj kk il kl km kn ip jo ko kp it js kq kr ix jw ks kt jb ku bi translated">3个端到端跟踪采样和探针</h2><p id="adb8" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">使用像<a class="ae kb" href="https://opencensus.io/index.html" rel="noopener ugc nofollow" target="_blank"> OpenCensus </a>、<a class="ae kb" href="https://www.jaegertracing.io/docs/" rel="noopener ugc nofollow" target="_blank"> Jaeger </a>或<a class="ae kb" href="https://zipkin.io/" rel="noopener ugc nofollow" target="_blank"> Zipkin </a>这样的工具来检测移动客户端是一种选择。或者，可以部署从不同云区域或办公室工作站中的虚拟机执行的固定探测器。</p><p id="f17e" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">httpstat是包装curl的Python工具。以下示例显示了DNS查找、TCP连接、TLS握手、服务器处理和内容传输时间的集合。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="0a86" class="kh ig hi lp b fi lt lu l lv lw">$ python httpstat.py <a class="ae kb" href="https://google.com" rel="noopener ugc nofollow" target="_blank">https://google.com</a><br/>…<br/>DNS Lookup TCP Connection TLS Handshake Server Processing Content Transfer<br/>[ 27ms | 63ms | 165ms | 75ms | 0ms ]<br/>| namelookup:27ms <br/>|       connect:90ms <br/>|              pretransfer:255ms<br/>|                       starttransfer:330ms<br/>total:330ms</span></pre><p id="fa51" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">基于上面提到的<a class="ae kb" href="https://gist.github.com/alexamies/0d7b393739114ceadfea85257b72fbcd" rel="noopener ugc nofollow" target="_blank">要点</a>编写了一个以类似方式包装curl的Python探针的原型，并使用下面显示的<a class="ae kb" href="https://cloud.google.com/stackdriver/" rel="noopener ugc nofollow" target="_blank"> Stackdriver </a>为自定义仪表板收集数据。</p><figure class="lk ll lm ln fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es lx"><img src="../Images/acb28747b5c31cfe4c9425785f65beed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*F3U97tRapXUjtHNi."/></div></div></figure><p id="511c" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">Go lang的<a class="ae kb" href="https://golang.org/pkg/net/http/httptrace/" rel="noopener ugc nofollow" target="_blank"> httptrace </a>包中包含了低级别的网络跟踪点，包括ConnectStart、GotConn、DNSStart、DNSDone、TLSHandshakeStart、TLSHandshakeDone、GotFirstResponseByte和WroteRequest ( <a class="ae kb" href="https://blog.golang.org/http-tracing" rel="noopener ugc nofollow" target="_blank"> blog </a>)。</p><p id="670f" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">OpenCensus是一个OSS工具，因此应该能够在多个云中使用，并且支持Java、C++和Go，因此可以添加到Android和iOS客户端以及多个后端项目中。OpenCensus可以执行<a class="ae kb" href="https://opencensus.io/trace.html" rel="noopener ugc nofollow" target="_blank">分布式跟踪</a>来连接客户端和后端跟踪数据，并且可以对其进行采样，因此对整体性能的影响可以忽略不计。收集的踪迹将由通过唯一踪迹id连接的嵌套范围组成。数据可以导出到Stackdriver和其他可视化工具。</p><h2 id="bf97" class="kh ig hi bd ih ki kj kk il kl km kn ip jo ko kp it js kq kr ix jw ks kt jb ku bi translated">4面向最终用户的网络故障排除帮助面板</h2><p id="3749" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">一个高层次的想法是在移动应用程序中有一个故障排除屏幕，当出现网络错误时会显示出来。这将收集有关正在使用的DNS服务器、ping、正在连接的IP的主机名查找、跟踪路由、互联网速度的统计数据，并在以后连接可用时将数据保存回服务器。这种工具的缺点是，用户可能位于他们已经知道其互联网连接很差的地理位置，而专家小组将确认这一点。</p><h1 id="a59b" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">资源</h1><ol class=""><li id="6e45" class="kv kw hi jf b jg jh jk jl jo mf js mg jw mh ka la lb lc ld bi translated"><a class="ae kb" href="https://cloud.google.com/compute/docs/load-balancing/http/#monitoring_metrics_for_https_load_balancers" rel="noopener ugc nofollow" target="_blank">监视HTTP(S)负载平衡器的度量</a> (GCP文档)</li><li id="6cb0" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated"><a class="ae kb" href="https://cloud.google.com/monitoring/api/metrics_gcp" rel="noopener ugc nofollow" target="_blank">支持负载平衡的指标</a> (GCP文档)</li><li id="c687" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated"><a class="ae kb" href="https://www.w3.org/TR/network-error-logging/" rel="noopener ugc nofollow" target="_blank">网络错误记录</a> (W3c工作组)</li><li id="d4b5" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">兰达等人，2013年a。<a class="ae kb" href="http://ieeexplore.ieee.org/document/6663531/" rel="noopener ugc nofollow" target="_blank">互联网往返时代的大规模地理</a>，(IEEE数字图书馆)</li><li id="64f8" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">兰达等人，2013年b。<a class="ae kb" href="http://ieeexplore.ieee.org/document/6614151/" rel="noopener ugc nofollow" target="_blank">测量互联网地理和RTT之间的关系</a> (IEEE数字图书馆)</li><li id="e297" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">伦纳德等人，2009年。<a class="ae kb" href="http://ieeexplore.ieee.org/document/4509610/" rel="noopener ugc nofollow" target="_blank"> Turbo King:大规模互联网延迟测量框架</a></li><li id="c74d" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated"><a class="ae kb" href="https://opencensus.io" rel="noopener ugc nofollow" target="_blank">公开普查</a> (OSS项目)</li><li id="3d31" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated"><a class="ae kb" href="https://docs.google.com/document/d/14U0YA4dlzNYciq2ke0StEMjomdBUN6ocSt1kN03HJ0s/pub" rel="noopener ugc nofollow" target="_blank">领域可靠性监控</a>(发表于chromium.org Chrome项目)</li><li id="5d38" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated"><a class="ae kb" href="https://istio.io/docs/tasks/telemetry/" rel="noopener ugc nofollow" target="_blank"> Istio遥测</a> (Istio现场)</li><li id="e267" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">负载测试工具(Istio Github网站)</li><li id="178b" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated"><a class="ae kb" href="https://itunes.apple.com/gb/app/fing-network-scanner/id430921107?mt=8" rel="noopener ugc nofollow" target="_blank"> Fing </a>(带第三方ping的手机应用)</li><li id="935d" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated"><a class="ae kb" href="https://github.com/liquidlabs/android-speedtest-mapper" rel="noopener ugc nofollow" target="_blank"> Android speedtest </a>(非谷歌Github项目)</li></ol></div></div>    
</body>
</html>