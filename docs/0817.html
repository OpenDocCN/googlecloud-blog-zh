<html>
<head>
<title>Modern Frontend CI/CD Architecture — The Missing Guide (Part. 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">现代前端CI/CD架构—缺失的指南(部分。3)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/modern-frontend-ci-cd-architecture-the-missing-guide-part-3-9a6be231d14?source=collection_archive---------3-----------------------#2018-11-15">https://medium.com/google-cloud/modern-frontend-ci-cd-architecture-the-missing-guide-part-3-9a6be231d14?source=collection_archive---------3-----------------------#2018-11-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="14f8" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">这是“现代前端CI/CD架构——缺失指南”系列的第三部分。我们建议您阅读关于如何建立持续集成管道的<a class="ae jh" rel="noopener" href="/@wassimchegham/modern-frontend-ci-cd-architecture-the-missing-guide-part-1-8444001fadc">第一部分和关于持续部署</a>的<a class="ae jh" rel="noopener" href="/@wassimchegham/modern-frontend-ci-cd-architecture-the-missing-guide-part-3-9a6be231d14">第二部分。</a></p></blockquote><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ji"><img src="../Images/31034175952138947c3e14f771c262a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jDOTKaVUU7cBGibSlGRdzA.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">TL；dr:前端CI/CD架构流水线的完整图。</figcaption></figure><h1 id="6c15" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">奖金…</h1><p id="3efc" class="pw-post-body-paragraph ii ij hi il b im kw io ip iq kx is it ky kz iw ix la lb ja jb lc ld je jf jg hb bi translated">既然我们已经有了持续集成和部署工作，让我们添加一些有用而重要的特性。</p><h2 id="4e4f" class="le jz hi bd ka lf lg lh ke li lj lk ki ky ll lm km la ln lo kq lc lp lq ku lr bi translated">评论GitHub上相应PR上的预览链接</h2><h2 id="e774" class="le jz hi bd ka lf lg lh ke li lj lk ki ky ll lm km la ln lo kq lc lp lq ku lr bi translated">1.a创建GitHub访问令牌</h2><p id="116c" class="pw-post-body-paragraph ii ij hi il b im kw io ip iq kx is it ky kz iw ix la lb ja jb lc ld je jf jg hb bi translated">为了在GitHub PR上创建评论，我们需要从GitHub获得一个个人访问令牌(PAT ),以便与GitHub API进行对话。</p><p id="b764" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">确保为这个令牌选择了<code class="du ls lt lu lv b">public_repo</code>范围。这就是我们所需要的:</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es lw"><img src="../Images/a743e1fe367467b2a6bd7ce65ec9bbc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bSRAaVZwqY9PjAwFSzBNtg.png"/></div></div></figure><p id="eeac" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">重要提示:记下这个令牌，我们下一步会用到它。</p><blockquote class="if ig ih"><p id="026e" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">注意:如果您正在您的组织中设置CI/CD管道，我们建议您为此创建一个GitHub应用程序。为了这篇文章，我们将保持这个过程简单易懂。所以一个基本的PAT就足够了。</p></blockquote><h2 id="87ae" class="le jz hi bd ka lf lg lh ke li lj lk ki ky ll lm km la ln lo kq lc lp lq ku lr bi translated">1.b使用谷歌KMS服务存储GitHub PAT</h2><p id="8b92" class="pw-post-body-paragraph ii ij hi il b im kw io ip iq kx is it ky kz iw ix la lb ja jb lc ld je jf jg hb bi translated">根据定义，访问令牌是私有令牌，不能公开共享，也不能在Git中进行版本控制。因此，为了在CI/CD管道中使用PAT，而不必在<em class="ik"> cloudbuild.yaml </em>文件中硬编码令牌，我们需要将PAT存储在云密钥管理服务(KMS)中。</p><p id="6127" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">像GCP上的任何API一样，在我们的项目中使用KMS之前，我们需要启用它:</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es lx"><img src="../Images/74b24601f3ae6de248f89cf1d9222316.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uHCEdKnpTAIjc5dlDHANxA.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">KMS空气污染指数</figcaption></figure><p id="cd1b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">接下来，我们需要创建一个密匙环(或加密密钥)来保存我们的私有令牌。从菜单侧栏中，转到安全条目，并选择加密密钥选项:</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div class="er es ly"><img src="../Images/305b16b61ad4ffae7fca692fbf45193c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/1*JsEIzy9g6EFSMzpjejBXIQ.png"/></div></figure><p id="fc1a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">在那里，我们将创建一个<strong class="il hj">全局</strong>密匙环，为简单起见，将其命名为<strong class="il hj"> GITHUB_ACCESS_TOKEN </strong>:</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es lz"><img src="../Images/27b13a05e1b5faf17a275918605032ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g_qg1fEqkEL9xER9feR-Dw.png"/></div></div></figure><p id="d79f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">现在，让我们加密并存储我们在KMS的GitHub PAT:</p><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="a17f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated"><strong class="il hj">重要提示:记下base64输出，我们将在下一步中用到它。</strong></p><p id="f57b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">在我们继续之前，我们只需要授予云构建服务帐户权限来解密我们的加密访问令牌。这将是下一步需要的:</p><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="ma mb l"/></div></figure><h2 id="eddf" class="le jz hi bd ka lf lg lh ke li lj lk ki ky ll lm km la ln lo kq lc lp lq ku lr bi translated">1.c评论GitHub上的预览链接</h2><p id="6194" class="pw-post-body-paragraph ii ij hi il b im kw io ip iq kx is it ky kz iw ix la lb ja jb lc ld je jf jg hb bi translated">现在我们已经安全地存储了GitHub个人访问令牌，我们现在可以在云构建配置文件中添加一个额外的步骤，该步骤将在PR上推送一个新的评论，提供新创建的预览链接。</p><p id="3aa4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">对于这一步，我们将使用<strong class="il hj"> google/cloud-sdk:alpine </strong>，因为它为我们提供了定制<strong class="il hj">github-create-comment . Bash</strong>脚本所需的Bash、cURL和Python命令。</p><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="dd4a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">运行定制脚本时，我们需要为它提供几个环境变量:</p><ul class=""><li id="0a88" class="mc md hi il b im in iq ir ky me la mf lc mg jg mh mi mj mk bi translated"><strong class="il hj"> PREVIEW_BUILD_URL </strong>:包含新创建的预览链接；</li><li id="3f7d" class="mc md hi il b im ml iq mm ky mn la mo lc mp jg mh mi mj mk bi translated"><strong class="il hj"> COMMIT_SHA </strong>:包含触发该构建的提交的SHA。<strong class="il hj">我们将使用这个特定的SHA来确定我们将要评论的GitHub PR(阅读下文)。</strong></li></ul><p id="5330" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">因为定制脚本将需要GitHub访问令牌来创建评论，并且因为我们的GitHub令牌现在被安全地加密并存储在KMS服务中，所以我们需要告诉云构建服务使用来自KMS的<strong class="il hj"> GITHUB_ACCESS_TOKEN </strong>密钥。我们通过在cloudbuild.yaml文件中配置<strong class="il hj"> secrets.kmsKeyName </strong>和<strong class="il hj">secrets . secret env . github _ ACCESS _ TOKEN</strong>条目来实现这一点。<a class="ae jh" href="https://cloud.google.com/cloud-build/docs/securing-builds/use-encrypted-secrets-credentials" rel="noopener ugc nofollow" target="_blank">阅读更多关于在云构建中使用加密资源的信息</a>。</p><p id="b948" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">现在让我们来看看<strong class="il hj">github-create-comment . bash</strong>脚本。它的基本功能是:</p><ol class=""><li id="ad5f" class="mc md hi il b im in iq ir ky me la mf lc mg jg mq mi mj mk bi translated">使用commit SHA来查询GitHub的GraphQL API，以获得包含该特定提交的PR。以下是GraphQL查询:</li></ol><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="d5ca" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">其中:</p><ul class=""><li id="0806" class="mc md hi il b im in iq ir ky me la mf lc mg jg mh mi mj mk bi translated"><strong class="il hj"> REPO_NAME </strong>是xlayers/xlayers；</li><li id="0d78" class="mc md hi il b im ml iq mm ky mn la mo lc mp jg mh mi mj mk bi translated"><strong class="il hj"> COMMIT_SHA </strong>是来自云构建环境的$COMMIT_SHA。</li></ul><p id="5459" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">使用主题ID——它代表GitHub问题ID——我们现在可以为该问题创建一个新的评论。我们将使用GraphQL突变操作来插入新的注释:</p><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="9274" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">其中:</p><ul class=""><li id="22e8" class="mc md hi il b im in iq ir ky me la mf lc mg jg mh mi mj mk bi translated"><strong class="il hj"> ISSUE_ID </strong>是上一次查询请求得到的主题ID；</li><li id="079b" class="mc md hi il b im ml iq mm ky mn la mo lc mp jg mh mi mj mk bi translated"><strong class="il hj"> BODY_CONTENT </strong>为发布内容。</li></ul><p id="ffc6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">下面是完整的BASH脚本:</p><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="ma mb l"/></div></figure><blockquote class="if ig ih"><p id="c806" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">注意:GraphQL请求是为cURL命令格式化的。</p></blockquote><p id="868c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">瞧啊。！！</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es mr"><img src="../Images/9a53b9377f4ede9a8b215a133935a0f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7LiBR0MMt4eLjerJuzIgew.png"/></div></div></figure><p id="54f7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">这个特定构建的预览URL已经正确生成，并指向正确的容器，我们甚至可以检查我们在应用程序的index.html(在页脚)中标记的构建ID:</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ms"><img src="../Images/f56ab118025972288ed2fdb3010cc499.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ScuMlr64VbTBVwWs8MiDdA.png"/></div></div></figure><p id="4e89" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">最后，预览URL也被正确地推送到正确的Github PR:</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es mt"><img src="../Images/e1e3df7ac9031cea3729202cd32b280b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XB_2bcK9itP-CZLH4fOEVA.png"/></div></div></figure></div><div class="ab cl mu mv gp mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hb hc hd he hf"><h1 id="4e03" class="jy jz hi bd ka kb nb kd ke kf nc kh ki kj nd kl km kn ne kp kq kr nf kt ku kv bi translated">注释和优化</h1><blockquote class="if ig ih"><p id="7f9e" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">这些注释适用于本系列的3个部分。</p></blockquote><ol class=""><li id="14f1" class="mc md hi il b im in iq ir ky me la mf lc mg jg mq mi mj mk bi translated">安全:部署(以及预览链接)将在每个PR上运行——针对任何人推送的任何提交！出于安全和性能的原因，您可能希望为核心团队成员或特定贡献者启用这个特性。</li><li id="3b60" class="mc md hi il b im ml iq mm ky mn la mo lc mp jg mq mi mj mk bi translated"><strong class="il hj">构建优化:</strong>在构建容器快照时，我们没有应用任何优化。您可能希望使用一些缓存来加速这个过程。阅读更多关于如何<a class="ae jh" href="https://cloud.google.com/cloud-build/docs/speeding-up-builds" rel="noopener ugc nofollow" target="_blank">加速你的构建</a>的信息。</li><li id="8c50" class="mc md hi il b im ml iq mm ky mn la mo lc mp jg mq mi mj mk bi translated"><strong class="il hj">工具:</strong>我们在这篇文章中没有使用Helm或者其他K8s软件包管理器。我们希望专注于核心功能。使用这样的工具来帮助您管理K8s集群取决于您自己。</li><li id="89c6" class="mc md hi il b im ml iq mm ky mn la mo lc mp jg mq mi mj mk bi translated">您可能还希望清理与GitHub PRs相关的、已经合并或关闭的、或者具有无效状态的pod、服务和容器映像(快照)。</li><li id="ef14" class="mc md hi il b im ml iq mm ky mn la mo lc mp jg mq mi mj mk bi translated">这是我们刚刚构建的体系结构的完整示意图(单击可放大):</li></ol><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ji"><img src="../Images/e3b849b9d973261bc065219f57fadc13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F2PeSW118QgKRki9WWWldw.png"/></div></div></figure></div><div class="ab cl mu mv gp mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hb hc hd he hf"><p id="2f92" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">恭喜你！现在，您拥有了一个完整的完全定制的CI/CD管道，可以根据自己的需求进行调整。玩得开心！🎊</p><p id="0127" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">特别感谢<a class="ae jh" href="https://twitter.com/dgageot" rel="noopener ugc nofollow" target="_blank"> David Gageot </a>对k8s入口配置的帮助！</p></div><div class="ab cl mu mv gp mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hb hc hd he hf"><p id="0180" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated"><em class="ik">关注</em><a class="ae jh" href="https://twitter.com/manekinekko" rel="noopener ugc nofollow" target="_blank"><em class="ik">@ manekinekko</em></a><em class="ik">了解更多关于Web和云技术的更新。</em></p></div></div>    
</body>
</html>