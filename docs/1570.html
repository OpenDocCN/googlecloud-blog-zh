<html>
<head>
<title>Enable business data with BigQuery for geospatial analysis and map visualization</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用BigQuery支持地理空间分析和地图可视化的业务数据</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/enable-business-data-with-bigquery-for-geospatial-analysis-and-map-visualization-dcddccd18e17?source=collection_archive---------2-----------------------#2020-08-24">https://medium.com/google-cloud/enable-business-data-with-bigquery-for-geospatial-analysis-and-map-visualization-dcddccd18e17?source=collection_archive---------2-----------------------#2020-08-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2547" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当涉及到商业决策时，有几个维度的信息。空间数据为决策提供了一个强大的额外信息维度。为了在地图上可视化空间数据，我们使用包含空间数据的数据集，通常是标准地理空间格式的地理列(点、线/折线或多边形信息)，如GeoJSON、WKT等。许多业务属性数据没有地理列。但是，很容易将业务属性与其他数据集关联起来，以关联地理空间信息，从而获得通过空间分析向下钻取数据的能力。例如，州、县、邮政编码、道路网络、兴趣点等。</p><p id="f9a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google BigQuery提供了一组包含地理空间信息的数据。在本文中，我们使用美国人口普查数据中的邮政编码边界作为空间数据，并以Iowa state liquor sales数据作为业务属性数据的示例，来展示如何将属性数据与空间信息关联起来，并在地图上将其可视化。</p><p id="d54c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用的BigQuery数据集:</p><ol class=""><li id="7bb8" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">公共数据集-人口普查局美国边界</li></ol><p id="0a4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该数据集包括地理和统计区域的多边形边界、一些线性要素(包括道路和水文)以及点要素。您可以在此找到关于该数据集<a class="ae jm" href="https://pantheon.corp.google.com/marketplace/product/united-states-census-bureau/us-geographic-boundaries?filter=solution-type:dataset&amp;filter=category:maps&amp;q=public%20data&amp;id=20d75072-82af-4fd3-a235-7080e71bcc1b&amp;project=dong-sce&amp;folder=&amp;organizationId=" rel="noopener ugc nofollow" target="_blank">的更多信息。</a></p><p id="6218" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个数据集中，地理空间列被称为<em class="jn"> zip_code_geom。</em>这是定义多边形边界的逗号分隔的纬度和经度对的列表。</p><p id="70a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jn">样本值如下:</em></p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="5798" class="jx jy hi jt b fi jz ka l kb kc">POLYGON((-93.648086 41.619944, -93.64766 41.6186, -93.647425 41.61818, -93.647408 41.618149, ….)</span></pre><p id="5696" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.公共数据集-爱荷华州酒类零售</p><p id="dbb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该数据集提供了整个爱荷华州零售酒类销售的完整视图。数据集包含杂货店、酒类商店、便利店等的酒类订单。，包括商店和位置的详细信息、确切的酒品牌和大小以及订购的瓶数。</p><p id="69e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该查询的目标是识别2019年每个邮政编码超过10万美元的销售额</p><p id="ae91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用的查询:</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="574f" class="jx jy hi jt b fi jz ka l kb kc">SELECT <br/>  boundary.zip_code AS zip_code, <br/>  total_sales, <br/>  zip_code_geom <br/>FROM<br/>(SELECT zip_code, county, zip_code_geom<br/>FROM `bigquery-public-data.geo_us_boundaries.zip_codes`<br/>WHERE STATE_CODE = 'IA' ) AS boundary<br/>LEFT JOIN<br/>(SELECT zip_code, sum(sale_dollars) AS total_sales<br/>FROM `bigquery-public-data.iowa_liquor_sales.sales`<br/>WHERE EXTRACT(YEAR FROM date) = 2019 <br/>GROUP BY zip_code ) AS sales<br/>ON sales.zip_code = boundary.zip_code<br/>WHERE total_sales &gt; 100000</span></pre><p id="2fb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以直接运行上述查询，也可以将查询保存到视图中，然后查询该视图。在BigQuery Geo Viz中很容易将结果可视化。下图显示了基于美元金额范围的总销售额。颜色越深，销量越大。</p><figure class="jo jp jq jr fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kd"><img src="../Images/e761faa6dd9313f5d6ebe984554fd9e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PfJhDIXeYk9HPiSI"/></div></div></figure><p id="c5fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Geo Viz适用于快速显示地理空间数据，但要将Geo Viz中的地图与您现有的应用程序集成并不容易。Google Maps API在呈现空间数据时更加灵活。您可以在javascript代码中向BigQuery提交查询，并动态地将结果添加到地图中。由于Google Maps API还提供了地理编码(将地址转换为经纬度)、反向地理编码(将经纬度转换为地址)、路线计算等功能，因此您可以在具有地理空间功能的应用程序中快速显示您的数据。</p><p id="1b9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要向BigQuery提交查询，我们可以使用BigQuery Javascript库。要获得包括两步OAuth授权的逐步设置指南，请查看本教程。</p><p id="4254" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用于设置身份验证和授权的代码段。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="9d14" class="jx jy hi jt b fi jz ka l kb kc">// Check if the user is authorized.<br/>function authorize(event) {<br/>  gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: false}, handleAuthResult);<br/>  return false;<br/>}</span><span id="87e2" class="jx jy hi jt b fi kl ka l kb kc">// If authorized, load BigQuery API<br/>function handleAuthResult(authResult) {<br/>  if (authResult &amp;&amp; !authResult.error) {<br/>    loadApi();<br/>    return;<br/>  }<br/>  console.error('Not authorized.')<br/>}</span></pre><p id="7cd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了在地图上绘制地理列，我们在查询中使用<em class="jn"> ST_ASGEOJSON() </em>函数将地理列中的数据转换为GeoJSON。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="2f9a" class="jx jy hi jt b fi jz ka l kb kc">SELECT <br/>  boundary.zip_code AS zip_code, <br/>  total_sales, <br/>  zip_code_geom <br/>FROM (<br/>  SELECT zip_code, county, <br/>    ST_ASGEOJSON(zip_code_geom) AS zip_code_geom<br/>  FROM `bigquery-public-data.geo_us_boundaries.zip_codes`<br/>  WHERE STATE_CODE = 'IA' ) AS boundary<br/>  LEFT JOIN<br/>  (SELECT zip_code, sum(sale_dollars) AS total_sales<br/>  FROM `bigquery-public-data.iowa_liquor_sales.sales`<br/>  WHERE EXTRACT(YEAR FROM date) = 2019<br/>  GROUP BY zip_code ) AS sales<br/>  ON sales.zip_code = boundary.zip_code<br/>WHERE total_sales &gt; 100000</span></pre><p id="1df4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们使用Datalayer将结果添加到Google map，data layer用于在Google Map上显示GeoJSON数据。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="a899" class="jx jy hi jt b fi jz ka l kb kc">function doMap(rows){<br/>  geojson = {<br/>      "type": "FeatureCollection",<br/>      "crs": {<br/>        "type": "name",<br/>        "properties": {<br/>          "name": "urn:ogc:def:crs:OGC:1.3:CRS84"<br/>        }<br/>      },<br/>      "features":[]<br/>  };</span><span id="d542" class="jx jy hi jt b fi kl ka l kb kc">for (let i = 0; i &lt; rows.length; i++) {<br/>      geojson.features.push(<br/>        { "type": "Feature",<br/>          "properties": {"total_sales": rows[i].f[1].v,<br/>                      "zip_code": rows[i].f[0].v},<br/>          "geometry": JSON.parse(rows[i].f[2].v)<br/>         })};</span><span id="5862" class="jx jy hi jt b fi kl ka l kb kc">map.data.addGeoJson(geojson);</span><span id="5bed" class="jx jy hi jt b fi kl ka l kb kc">map.data.setStyle(function(feature) {<br/>      var total_sales =   <br/>          parseFloat(feature.getProperty("total_sales"));<br/>      var zip_code = feature.getProperty("zip_code");<br/>      var color;<br/>      if (total_sales &gt; 15000000)<br/>        color = '#033b23'<br/>      else if (total_sales &gt; 5000000 &amp;&amp; total_sales &lt;= 15000000)<br/>        color = '#006d2c'<br/>      else if (total_sales &gt; 1000000 &amp;&amp; total_sales &lt;= 5000000)<br/>        color = '#zca25f'<br/>      else if (total_sales &gt; 500000 &amp;&amp; total_sales &lt;= 1000000)<br/>        color = '#66c2a4'<br/>      else if (total_sales &gt;= 100000 &amp;&amp; total_sales &lt;= 500000)<br/>        color = '#99d8c9'<br/>      else<br/>        color = 'white'<br/>      return {<br/>        fillColor: color,<br/>        strokeWeight: 0<br/>      };<br/>  }) ;<br/>}</span></pre><p id="3a14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">生成的地图如下所示。您可以向地图功能添加更多控件，如单击获取邮政编码信息或人口普查数据等。</p><figure class="jo jp jq jr fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kd"><img src="../Images/21fb1d76d31166af663c27a9cf4c4e83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OTaCBwUuh8ZGagz4"/></div></div></figure><p id="9565" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">下一步</strong></p><p id="1967" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以上示例使用了边界多边形(邮政编码)。同样的理论也适用于点地理空间数据，例如兴趣点。</p><p id="ca91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以使用另一个智能维度—地理位置维度来启用您的业务属性数据。数据管道可能如下所示。</p><figure class="jo jp jq jr fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kd"><img src="../Images/fa4d822b1ed3fbf340524c1583ea28cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*n6dKKW24ks05_sI1"/></div></div></figure><p id="0a95" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您有流数据，或者您的应用程序有低延迟要求，您可以考虑将空间数据处理转移到数据流。</p></div></div>    
</body>
</html>