<html>
<head>
<title>Cloud Run as an internal async worker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云作为内部异步工作器运行</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-run-as-an-internal-async-worker-480a772686e?source=collection_archive---------0-----------------------#2019-05-28">https://medium.com/google-cloud/cloud-run-as-an-internal-async-worker-480a772686e?source=collection_archive---------0-----------------------#2019-05-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/54557d5ec4989f618b578d9becec3fa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*w4RasvcFgRjz20RmrbDZlw.jpeg"/></div><figcaption class="im in et er es io ip bd b be z dx translated">云发布/订阅+云运行</figcaption></figure><h2 id="b343" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">介绍</h2><p id="4e34" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki hb bi translated">如果您听说过<a class="ae kj" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank"> Cloud Run </a>，那么您已经知道在无状态容器中旋转公共端点来处理HTTP请求/回复类型的工作负载是非常棒的。最棒的是，您只需为请求的持续时间付费！</p><p id="3e1e" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">然而，HTTP请求/回复处理并不是云运行的唯一用例。与云发布/订阅相结合，云运行非常适合内部异步工作者类型的用例，因为:</p><ol class=""><li id="9cd3" class="kp kq hi jq b jr kk jv kl jb kr jf ks jj kt ki ku kv kw kx bi translated">在云运行中，您可以拥有一个只能从具有<em class="ky">云运行调用</em> IAM角色的服务访问的内部/私有端点。</li><li id="dec2" class="kp kq hi jq b jr kz jv la jb lb jf lc jj ld ki ku kv kw kx bi translated">在云发布/订阅中，您可以进行推送订阅，即发布/订阅可以将消息推送至预定义的端点。</li><li id="2946" class="kp kq hi jq b jr kz jv la jb lb jf lc jj ld ki ku kv kw kx bi translated">您可以给发布/订阅推送订阅一个身份，并授予该身份<em class="ky">云运行调用者</em> IAM角色。</li></ol><p id="0f7e" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">所有这些意味着您可以将发布/订阅消息推送到内部云运行端点。这对内部异步工作者来说是完美的！你可以在云运行教程 中使用云发布/订阅来详细了解如何设置。</p><p id="c3b9" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">在这篇博客文章中，我们将遵循该教程，但我也想看看如何让我现有的Knative事件示例之一部署为云运行中的内部异步工作器。</p><h2 id="bb5e" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">云运行的失败事件</h2><p id="da53" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki hb bi translated">在我的<a class="ae kj" href="https://github.com/meteatamel/knative-tutorial" rel="noopener ugc nofollow" target="_blank"> Knative教程</a>中，我<a class="ae kj" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/08-visioneventing.md" rel="noopener ugc nofollow" target="_blank">展示了</a>如何使用Knative Eventing将云存储连接到Cloud Vision API:</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es le"><img src="../Images/5d1244d2250c373f6421b3e22d0dfd45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dxNLoZmJ4VcV9sUyt-T2xQ.png"/></div></div></figure><p id="575c" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">总的来说，当用户将图像放入云存储桶中时，它会触发一条到发布/订阅主题的消息，该消息又会被Knative Eventing读取。一旦Knative Eventing读取了该事件，它就被转换成CloudEvent并传递给Knative服务，以进行Vision API调用并从图像中提取标签。</p><p id="7dea" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">获取此样本并在Cloud Run上运行它需要什么？Cloud Run实现了Knative Serving，因此将服务从Knative Serving迁移到Cloud Run非常容易。然而，它并不直接实现Knative Eventing，所以从Knative Eventing到Cloud Run需要做更多的工作。</p><p id="94ea" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">让我们通过所需的步骤来了解需要什么。我假设您已经为云运行准备好了一个项目。</p><h2 id="d7c3" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">创建云发布/订阅主题</h2><p id="bae3" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki hb bi translated">首先，我们需要为云存储通知创建一个发布/订阅主题:</p><pre class="lf lg lh li fd ln lo lp lq aw lr bi"><span id="3f05" class="iq ir hi lo b fi ls lt l lu lv">gcloud pubsub topics create <strong class="lo hj">cloudrun-atamel-topic</strong></span></pre><h2 id="21ce" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">创建存储桶并启用通知</h2><p id="d729" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki hb bi translated">接下来，创建一个云存储桶来存储图像。您可以从Google Cloud控制台或使用如下的<code class="du lw lx ly lo b">gsutil</code>命令行工具来完成此操作:</p><pre class="lf lg lh li fd ln lo lp lq aw lr bi"><span id="f6d6" class="iq ir hi lo b fi ls lt l lu lv">gsutil mb gs://<strong class="lo hj">cloudrun-atamel-bucket</strong>/</span></pre><p id="6ec1" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">在存储桶上启用发布/订阅通知，并链接到之前创建的主题:</p><pre class="lf lg lh li fd ln lo lp lq aw lr bi"><span id="50a5" class="iq ir hi lo b fi ls lt l lu lv">gsutil notification create -t <strong class="lo hj">cloudrun-atamel-topic</strong> -f json gs://<strong class="lo hj">cloudrun-atamel-bucket</strong>/</span></pre><h2 id="1f28" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">部署云运行服务</h2><p id="cbfe" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki hb bi translated">我们现在准备部署我们的云运行服务。我们需要推动我们的图像到谷歌容器注册(GCR)。在<code class="du lw lx ly lo b">vision-csharp</code> <a class="ae kj" href="https://github.com/meteatamel/knative-tutorial/blob/master/eventing/vision-csharp" rel="noopener ugc nofollow" target="_blank">文件夹</a>里面，已经有一个<code class="du lw lx ly lo b">Dockerfile</code>。运行以下命令将其提交到云构建:</p><pre class="lf lg lh li fd ln lo lp lq aw lr bi"><span id="0bc7" class="iq ir hi lo b fi ls lt l lu lv">gcloud builds submit --tag gcr.io/<strong class="lo hj">cloudrun-atamel</strong>/<!-- -->vision-csharp:v1</span></pre><p id="794b" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">这将使用云构建并存储到GCR来构建映像:</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es lz"><img src="../Images/fb068a9cdea349f867004d03a3a5704c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lj90ri_kssEh9HuZjRGsGA.png"/></div></div></figure><p id="6f9c" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">运行以下命令以部署到云运行为<code class="du lw lx ly lo b">vision-csharp</code>服务:</p><pre class="lf lg lh li fd ln lo lp lq aw lr bi"><span id="7adf" class="iq ir hi lo b fi ls lt l lu lv">gcloud beta run deploy vision-csharp --image gcr.io/<strong class="lo hj">cloudrun-atamel</strong>/<!-- -->vision-csharp:v1</span></pre><p id="e918" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">在部署过程中，对“允许未经身份验证”提示响应“否”,以保持服务私有。大约一分钟后，您应该会在Google Cloud Console的Cloud Run部分看到该服务:</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es ma"><img src="../Images/5f847d6a8a30a9f4a3d7082aeb476aed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LizSboTOZfAQF8UdcycW7w.png"/></div></div></figure><h2 id="5090" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">与云发布/订阅集成</h2><p id="b00d" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki hb bi translated">此时，我们已经准备好了桶和服务，但是我们需要中间的Pub/Sub来转发消息。我们需要配置发布/订阅来将消息推送到我们内部的云运行服务。我是跟着<a class="ae kj" href="https://cloud.google.com/run/docs/tutorials/pubsub" rel="noopener ugc nofollow" target="_blank"> <em class="ky">用云Pub/Sub用云运行教程</em> </a> <em class="ky">。</em></p><ol class=""><li id="2a66" class="kp kq hi jq b jr kk jv kl jb kr jf ks jj kt ki ku kv kw kx bi translated">使您的项目能够创建云发布/订阅身份验证令牌(用您的id和编号替换项目id和编号):</li></ol><pre class="lf lg lh li fd ln lo lp lq aw lr bi"><span id="78c7" class="iq ir hi lo b fi ls lt l lu lv">gcloud projects add-iam-policy-binding <strong class="lo hj">cloudrun-atamel </strong>--member=serviceAccount:service-<strong class="lo hj">165810103461</strong>@gcp-sa-pubsub.iam.gserviceaccount.com --role=roles/iam.serviceAccountTokenCreator</span></pre><p id="4e78" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">2.创建一个服务帐户来代表云发布/订阅身份:</p><pre class="lf lg lh li fd ln lo lp lq aw lr bi"><span id="741d" class="iq ir hi lo b fi ls lt l lu lv">gcloud iam service-accounts create <strong class="lo hj">cloud-run-pubsub-invoker </strong>--display-name "<strong class="lo hj">Cloud Run Pub/Sub Invoker</strong>"</span></pre><p id="3c30" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">3.授予此服务帐户调用CloudRun服务的权限:</p><pre class="lf lg lh li fd ln lo lp lq aw lr bi"><span id="cf77" class="iq ir hi lo b fi ls lt l lu lv">gcloud beta run services add-iam-policy-binding vision-csharp<strong class="lo hj"> </strong>--member=serviceAccount:cloud-run-pubsub-invoker@<strong class="lo hj">cloudrun-atamel</strong>.iam.gserviceaccount.com --role=roles/run.invoker</span></pre><p id="9945" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">4.使用服务帐户创建云发布/订阅订阅:</p><pre class="lf lg lh li fd ln lo lp lq aw lr bi"><span id="051e" class="iq ir hi lo b fi ls lt l lu lv">gcloud beta pubsub subscriptions create <strong class="lo hj">cloudrun-atamel-subscription</strong> --topic <strong class="lo hj">cloudrun-atamel-topic</strong> --push-endpoint=<a class="ae kj" href="https://vision-csharp-u6v7imyeiq-uc.a.run.app/" rel="noopener ugc nofollow" target="_blank"><strong class="lo hj">https://vision-csharp-u6v7imyeip-uc.a.run.app</strong></a><strong class="lo hj">/</strong> --push-auth-service-account=cloud-run-pubsub-invoker@<strong class="lo hj">cloudrun-atamel</strong>.iam.gserviceaccount.com</span></pre><p id="7240" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">不可否认，这是许多手动步骤来设置发布/订阅，我希望它会变得更容易，但一旦你经历了一次，它有点意义。</p><h2 id="d1c9" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">关键时刻到了。</h2><p id="ad7d" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki hb bi translated">我们终于准备好测试我们的内部云运行服务了！我走到云存储桶，放下一张图片:</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es mb"><img src="../Images/719d3e5a4d4a944c870dbbca4da0140f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x2J5qa7BTOqJcdL56il7JQ.png"/></div></div></figure><p id="b05d" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">我转到云运行控制台，查看vision-csharp服务的日志:</p><figure class="lf lg lh li fd ij er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es mc"><img src="../Images/b802e94e5bd430919c00a101a7c99129.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_gdKCQLpKaLfNUj1Rhpw3g.png"/></div></div></figure><p id="f605" class="pw-post-body-paragraph jo jp hi jq b jr kk jt ju jv kl jx jy jb km ka kb jf kn kd ke jj ko kg kh ki hb bi translated">我的发球扔出一个<code class="du lw lx ly lo b">NullPointerException</code>！原来这是因为Knative Eventing和Cloud Run中的事件类型不同。在Knative Eventing中，您最终会收到CloudEvents，这就是我的代码试图解析的内容。在Cloud Run中，您会收到一条格式略有不同的发布/订阅推送消息。一旦我调整了代码来解析Pub/Sub push消息，我就能够调用Vision API了。</p><h2 id="3f0c" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">摘要</h2><p id="1cbb" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki hb bi translated">在这篇博文中，我们看了一下Cloud Run，以及它如何被用作内部异步工作器。手动步骤比我预期的要多，但是一旦设置好了，它就工作得很好。将Cloud Run与Cloud Pub/Sub结合起来，为Cloud Run提供了很多机会，让它像后台工作人员一样处理几乎所有的服务。</p></div></div>    
</body>
</html>