<html>
<head>
<title>Testing a Spring Boot application with the Google Cloud Spanner Emulator</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Cloud Spanner模拟器测试Spring Boot应用程序</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/testing-a-spring-boot-application-with-the-google-cloud-spanner-emulator-3c4d5d6b52fb?source=collection_archive---------2-----------------------#2020-11-19">https://medium.com/google-cloud/testing-a-spring-boot-application-with-the-google-cloud-spanner-emulator-3c4d5d6b52fb?source=collection_archive---------2-----------------------#2020-11-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a719" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cloud Spanner已经出现了一段时间，但是根据真实实例测试您的应用程序可能会很困难:</p><ul class=""><li id="d2e3" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">使用真实实例进行测试是有成本的——“不要测试太多，这是在浪费我们的钱！”</li><li id="1059" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">你必须在线，并且有像样的连接——如果你在通勤时工作，这可不太好</li></ul><p id="aae4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最近，谷歌发布了云扳手模拟器。仿真器可以在您自己的机器上运行，并且与真实的扳手实例兼容——它可以运行与真实的扳手完全相同的SQL语句。</p><p id="90e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本指南中，我们将介绍如何设置模拟器，使其作为小型Spring Boot Java应用程序的一部分运行。</p><h1 id="6841" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">使用模拟器</h1><p id="7df0" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">Cloud Spanner模拟器可以在Linux下作为正常进程运行，也可以在其他平台上与Docker一起运行。我们将在本指南中使用docker映像，因为它简单且独立，而且我喜欢我的构建在任何地方运行。</p><p id="73ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">模拟器项目在Github 上的<a class="ae ku" href="https://github.com/GoogleCloudPlatform/cloud-spanner-emulator" rel="noopener ugc nofollow" target="_blank">这里。这里有关于如何在Docker下工作的说明，但是让我们把所有这些逻辑放在我们的构建中，这样其他开发人员(和CI服务器)就不必担心它了。</a></p><h1 id="d6ae" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">一个简单的Spring Boot应用</h1><p id="d493" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我们的应用程序将非常简单，使用Spring数据进行数据访问。用于演示的几个实体:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div></figure><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="ff05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和它们的储存库:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div></figure><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div></figure><h1 id="17e8" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">测试配置</h1><p id="f532" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">对于集成测试，需要进行一些设置。这个Spring配置将用于设置测试环境:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="37a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用不同的扳手配置进行测试，从系统属性中读取项目、实例和数据库id，如果没有指定，则使用默认值。这将允许用户点击一个真正的扳手实例，如果他们想要手动运行测试，或者在特殊的CI构建上。也许我们希望将模拟器用于日常CI，但是对于发布前的构建，我们将使用真正的Spanner实例？</p><p id="24d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">环境变量SPANNER_EMULATOR_HOST将使用SPANNER模拟器的位置进行配置。如果未指定，将尝试使用真实的扳手实例。</p><p id="c507" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当Spanner模拟器启动时，有一个没有配置实例的项目可用。此代码:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="da72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查找仿真程序中唯一可用的实例配置，并查找唯一可用的项目。根据这些信息，可以创建一个新的实例，然后创建一个新的数据库。创建数据库ID提供者bean时(应用程序只创建一次)，这是设置所有这些的好时机。无论如何，在模拟器中这样做是很便宜的，所以即使你决定对每个测试方法都这样做，也不会增加太多的开销。</p><h1 id="85b7" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">集成测试</h1><p id="2356" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">现在我们已经设置好了所有这些，我们可以编写一个测试:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="97c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用存储库类删除所有数据，并在每次测试之间重新创建数据，因此我们总是在已知的状态下进行测试。然后测试几个库，只是为了证明模拟器在工作。</p><h1 id="5254" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">用一个Maven项目将所有东西连接在一起</h1><p id="7501" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我们将从一个非常简单的带有扳手相关性的Spring Boot项目开始:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="afcf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止，我们还没有运行集成测试的东西。接下来，我们将添加一个<a class="ae ku" href="http://dmp.fabric8.io" rel="noopener ugc nofollow" target="_blank"> Docker插件</a>，它将启动一个Docker容器来运行扳手模拟器:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="48d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一部分是指定Docker图像。Docker图像的名称是gcr.io/cloud-spanner-emulator/emulator:1.0.0，我们从<a class="ae ku" href="https://cloud.google.com/spanner/docs/emulator" rel="noopener ugc nofollow" target="_blank">扳手模拟器文档</a>中获得。因为我们想要一个一致的版本，我们将选择一个具体的版本号，1.0.0。可用版本列表可以通过使用gcloud命令行工具列出标签来确定:</p><pre class="kv kw kx ky fd lc ld le lf aw lg bi"><span id="ea4e" class="lh js hi ld b fi li lj l lk ll">gcloud container images list-tags <br/>gcr.io/cloud-spanner-emulator/emulator</span></pre><p id="b238" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">模拟器公开了一个我们将使用的TCP端口。配置:</p><pre class="kv kw kx ky fd lc ld le lf aw lg bi"><span id="0cc5" class="lh js hi ld b fi li lj l lk ll">&lt;<strong class="ld hj">port</strong>&gt;+spanner.emulator.host:spanner.emulator.port:9010&lt;/<strong class="ld hj">port</strong>&gt;</span></pre><p id="65a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">会将容器中的端口9010映射到主机上随机选择的空闲端口，还会保存一些包含主机端口和Docker主机本身的系统属性。通常docker主机是localhost，但现在总是——这取决于您的平台——例如，使用docker-machine启动Docker的用户将拥有一个对应于虚拟机的主机。</p><p id="0779" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们指示Docker插件在TCP端口9010响应之前不要继续构建——我们不想在模拟器完全启动之前就开始测试。</p><p id="1271" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">剩下的部分是使用故障保护插件配置集成测试本身的执行:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="5286" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">SPANNER_EMULATOR_HOST环境变量正在使用由Docker启动的模拟器的主机和端口进行配置。剩下的就是标准的故障安全集成测试配置。</p><p id="ca70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行mvn verify，Spanner模拟器将在Docker中启动，然后测试将运行，最后模拟器容器被停止并再次移除。第一次运行时，您需要网络连接来下载依赖项和Spanner Docker映像，但之后，即使您没有任何网络/互联网访问，也可以运行构建。</p><h1 id="9fff" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">使用真实的扳手实例</h1><p id="438e" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">如果需要对一个真实的扳手实例进行测试，我们可以稍微改变一下项目来实现这一点。</p><p id="54b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们定义3个可能从命令行配置的构建属性:test.projectId、test.instanceId和test.databaseId。之前编写的JUnit测试代码已经包含了这些属性，所以让我们通过重新定义故障保护插件配置，在构建文件中贯穿这些属性:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="4ad5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是模拟器呢？让我们将所有的仿真器代码移到一个Maven概要文件中:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="25c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里我们有一个概要文件，它将总是被激活，除非test.projectId被配置，所以它将像以前一样工作。只有在此配置文件处于活动状态时，才会在故障保护中设置SPANNER_EMULATOR_HOST环境变量。</p><p id="b566" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以现在，在没有设置任何属性的情况下，模拟器将运行，构建将使用模拟器运行测试。但是，如果需要运行真实的Spanner实例，请设置这三个属性:</p><pre class="kv kw kx ky fd lc ld le lf aw lg bi"><span id="6159" class="lh js hi ld b fi li lj l lk ll">mvn verify -Dtest.projectId=helix-sydney -Dtest.instanceId=myinstance -Dtest.databaseId=cats</span></pre><p id="cbc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在运行之前，您需要<a class="ae ku" href="https://cloud.google.com/sdk/gcloud/reference/auth/login" rel="noopener ugc nofollow" target="_blank">为您的实例配置凭证</a>。</p></div></div>    
</body>
</html>