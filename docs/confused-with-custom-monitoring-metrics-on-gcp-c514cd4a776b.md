# Google äº‘ç›‘æ§ API å…¥é—¨â€”ç¬¬ 1 éƒ¨åˆ†

> åŸæ–‡ï¼š<https://medium.com/google-cloud/confused-with-custom-monitoring-metrics-on-gcp-c514cd4a776b?source=collection_archive---------0----------------------->

> å¦‚æœæ‚¨å·²ç»éƒ¨ç½²äº†æ‚¨çš„åº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆæ‚¨å°¤å…¶å¸Œæœ›å°½å¿«æ¨å‡ºæ–°åŠŸèƒ½ï¼Œè€Œä¸æ˜¯èŠ±æ—¶é—´æ£€æŸ¥æ‚¨çš„æœåŠ¡æ˜¯å¦åœæœºï¼Œå¯¹å—ï¼Ÿè¿™å°±æ˜¯ç›‘æ§å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚

![](img/16e3cb78c7d06d863fce2be9d479f8a8.png)

[å›¾ç‰‡æ¥è‡ª [Pexels](https://www.pexels.com/photo/simple-workspace-at-home-6476587/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels) çš„ç±³å‡¯å°”Â·å¸ƒéš†ç»´æ–¯ç‰¹

Google cloud operations suiteï¼Œä»¥å‰ç§°ä¸º Stackdriverï¼Œæä¾›äº†ä¸€ä¸ªå†…ç½®çš„ç›‘æ§ä»ªè¡¨æ¿ï¼Œè®©æ‚¨å¯ä»¥åœ¨ GCP æˆ–æ··åˆç¯å¢ƒä¸­æ£€æŸ¥é¡¹ç›®çš„å„ç§æŒ‡æ ‡ã€‚

å‡è®¾æ‚¨æƒ³åœ¨ GCP ä¸Šå®šåˆ¶ç›‘æ§ä»ªè¡¨æ¿ï¼Œå¹¶æƒ³è‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹(æˆ–è€…æ‚¨æ˜¯ä¸€åå¼€å‘äººå‘˜ï¼Œæ›´å–œæ¬¢ç»ˆç«¯/ç¼–è¾‘å™¨ï¼Œä¸æƒ³ä½¿ç”¨ UI)ã€‚æ‚¨å¯ä»¥ä½¿ç”¨`google-cloud-monitoring`â€”â€”ç”¨äºç›‘æ§ API çš„å®¢æˆ·ç«¯åº“ã€‚

![](img/d079a4aff4fb7b59169867f4aa1e77fa.png)

æ¥æº:Reddit

åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å°†é¦–å…ˆåˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æŒ‡æ ‡ï¼Œç„¶åç”¨å®ƒæ¥åˆ›å»ºæˆ‘ä»¬çš„ä»ªè¡¨æ¿ï¼Œè€Œä¸ç”¨ç¦»å¼€æˆ‘ä»¬çš„ç¼–è¾‘å™¨ï¼âœ¨
æˆ‘ä»¬å°†ç‰¹åˆ«å…³æ³¨ä¸¤ç§æ–¹æ³•â€” `create_metric_descriptor`å’Œ`create_time_series`ã€‚ä½ ä¸ä¸€å®šè¦çŸ¥é“ API æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä½†æ˜¯æŒæ¡ä¸€äº› python çŸ¥è¯†æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚

# åˆ°åº•ä»€ä¹ˆæ˜¯åº¦é‡ï¼Ÿ

GCP çš„æŒ‡æ ‡åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªè¦ç´ :

*   ä¸€ç»„**æ•°æ®ç‚¹**ã€‚
*   **åº¦é‡å‹**ä¿¡æ¯ï¼Œå‘Šè¯‰æ‚¨æ•°æ®ç‚¹ä»£è¡¨ä»€ä¹ˆã€‚
*   **å—ç›‘æ§èµ„æº**ä¿¡æ¯ï¼Œå®ƒå‘Šè¯‰æ‚¨æ•°æ®ç‚¹çš„æ¥æºã€‚è¿™å¯ä»¥æ˜¯ä»æ‚¨çš„è™šæ‹Ÿæœºåˆ° K8s ç¾¤é›†çš„ä»»ä½•å†…å®¹ï¼Œä¹Ÿå¯ä»¥æ˜¯æ‚¨å®šä¹‰çš„ä»»ä½•ä»»åŠ¡ã€‚

æ‚¨å¯ä»¥å°è¯•åœ¨ GCP é¡¹ç›®çš„äººå·¥æ™ºèƒ½å¹³å°ä¸Šçš„ Jupyter ç¬”è®°æœ¬ä¸­åˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡ï¼Œæˆ–è€…æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ä½¿ç”¨ç›‘æ§ API è¿›è¡Œèº«ä»½éªŒè¯â€” [è®¾ç½®èº«ä»½éªŒè¯](https://cloud.google.com/monitoring/docs/reference/libraries#setting_up_authentication)ã€‚

é‡è¦çš„äº‹æƒ…å…ˆæ¥ï¼å¦‚æœä½ æ˜¯ä¸€ä¸ª python å¼€å‘è€…ï¼Œä½ åº”è¯¥å·²ç»çŸ¥é“è¿™ä¸ªè®­ç»ƒäº†ï¼Œ:D

```
pip install google-cloud-monitoring
```

# **åˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡å’Œæ—¶é—´åºåˆ—**

æ‚¨çš„å®šåˆ¶æŒ‡æ ‡åº”è¯¥æœ‰ä¸€ä¸ªåœ¨ google cloud é¡¹ç›®ä¸­æ‰€æœ‰æŒ‡æ ‡åç§°ä¸­å”¯ä¸€çš„**å­—ç¬¦ä¸²æ ‡è¯†ç¬¦**ï¼Œå¹¶ä»¥`custom.googleapis.com`ä¸ºå‰ç¼€ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨çš„åº¦é‡è¢«ç§°ä¸º`my-metric`ï¼Œæ ‡è¯†ç¬¦å°†çœ‹èµ·æ¥åƒ`custom.googleapis.com/my-metric`ã€‚

> **æ³¨æ„:**å› ä¸ºè¿™äº›æŒ‡æ ‡æ ‡è¯†ç¬¦å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥æ‚¨å¯ä»¥ç†è§£ï¼Œå¦‚æœæ‚¨è¯•å›¾å°†æ•°æ®å†™å…¥ç°æœ‰æŒ‡æ ‡ï¼Œå³å·²ç»æœ‰å®šä¹‰æºçš„æŒ‡æ ‡ï¼Œæ‚¨å°†ä¼šæ”¶åˆ°ä¸€ä¸ªé”™è¯¯ã€‚æˆ‘åœ¨ 403 å¡äº†ä¸€æ®µæ—¶é—´ï¼å¯¹æˆ‘æ¥è¯´ä¸€ç›´æœ‰æ•ˆçš„ä¸€ä¸ªæŠ€å·§æ˜¯å‚è€ƒåº“çš„æºä»£ç ï¼Œçœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆï¼Œæ€ä¹ˆæ ·ï¼æˆ–è€…åªæ˜¯åœ¨æ¯ä¸€æ­¥ç»§ç»­æ‰“å°ğŸ˜›

ç°åœ¨è½¬åˆ°**å—ç›‘æ§çš„èµ„æº**ï¼Œå‡è®¾æˆ‘ä»¬çš„è¿™ä¸ªè‡ªå®šä¹‰æŒ‡æ ‡æ˜¯ç”±ä¸€ä¸ªè™šæ‹Ÿæœºç”Ÿæˆçš„ï¼Œé‚£ä¹ˆæ‚¨çš„èµ„æºç±»å‹æ˜¯`gce_instance`ã€‚æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°èµ„æºç±»å‹åˆ—è¡¨ã€‚æ‚¨å¯ä»¥æ·»åŠ â€œæ ‡ç­¾â€å­—æ®µæ¥æŒ‡å®šèµ„æºçš„ä»»ä½•æ ‡ç­¾ã€‚æ¯”å¦‚`instance_id`æˆ–è€…`zone`ã€‚è¯·è®°ä½ï¼Œè¿™æ˜¯å…³äºæˆ‘ä»¬çš„æ•°æ®æºçš„**é™„åŠ ä¿¡æ¯ã€‚**

> ã€‚create_metric_descriptor()

å¦‚æœæ‚¨åœ¨è‡ªå®šä¹‰æŒ‡æ ‡çš„æŒ‡æ ‡æè¿°ç¬¦å°šä¸å­˜åœ¨æ—¶å†™å…¥æŒ‡æ ‡æ•°æ®ï¼Œåˆ™ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæŒ‡æ ‡æè¿°ç¬¦ã€‚åº¦é‡æè¿°ç¬¦çš„è‡ªåŠ¨åˆ›å»ºæ˜¯æœ‰é™åˆ¶çš„ï¼Œæ‰€ä»¥æœ€å¥½è‡ªå·±æ·»åŠ è¿™äº›æ•°æ®ã€‚
åœ¨æè¿°ç¬¦çš„ä¸¤ä¸ªç»„æˆéƒ¨åˆ†â€”â€”`metric_kind`å’Œ`value_type`ä¸­ï¼Œæˆ‘ç‰¹åˆ«æ··æ·†äº†`metric kind`ã€‚åº¦é‡æ•°æ®çš„*ç§ç±»*å‘Šè¯‰æ‚¨å¦‚ä½•è§£é‡Šå½¼æ­¤ç›¸å…³çš„å€¼ã€‚å®ƒå¯ä»¥æ˜¯`GAUGE`ï¼Œä»£è¡¨æŸä¸ªç‰¹å®šç‚¹çš„æŒ‡æ ‡å€¼ï¼Œä¸åƒ`DELTA`ï¼Œvalue è¡¡é‡è‡ªä¸Šæ¬¡è®°å½•ä»¥æ¥çš„å˜åŒ–ã€‚

```
descriptor = client.create_metric_descriptor(name=project_name, metric_descriptor=descriptor)
```

ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªè‡ªå®šä¹‰æŒ‡æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™æˆ‘ä»¬çš„æ•°æ®ç‚¹ï¼Œä»¥ä¾¿åœ¨ç›‘æ§ä»ªè¡¨æ¿ä¸Šæ˜¾ç¤ºå®ƒä»¬ã€‚

![](img/3f0eddbf307bc719bfffa463540bb489.png)

åœ¨ç›‘æ§>æŒ‡æ ‡æµè§ˆå™¨ä¸­æŸ¥æ‰¾æ‚¨çš„è‡ªå®šä¹‰æŒ‡æ ‡

é€šè¿‡å°†ä¸€åˆ—`[TimeSeries](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/TimeSeries)`å¯¹è±¡ä¼ é€’ç»™`[timeSeries.create](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.timeSeries/create)`æ¥å†™å…¥æ•°æ®ç‚¹ã€‚æœ€å¤§åˆ—è¡¨å¤§å°ä¸º 200ã€‚æ¯ä¸ª`[TimeSeries](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/TimeSeries)`å¯¹è±¡åªèƒ½åŒ…å«ä¸€ä¸ª`[Point](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/TimeSeries#Point)`å¯¹è±¡ã€‚å¦‚æœä½ æƒ³å¯¹åŒä¸€ä¸ªæ—¶é—´åºåˆ—å†™å¤šä¸ªç‚¹ï¼Œé‚£ä¹ˆä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„å¯¹`[timeSeries.create](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.timeSeries/create)`çš„è°ƒç”¨ã€‚

> ã€‚åˆ›å»ºæ—¶é—´åºåˆ—()

å› æ­¤ï¼Œé€šè¿‡æ›´æ”¹é”®`double_value`çš„å€¼å¹¶è¿è¡Œå‡ æ¬¡ä»£ç ï¼Œæ‚¨å¯ä»¥é’ˆå¯¹ç‰¹å®šæ—¶é—´åºåˆ—çš„é—´éš”æ¨é€å€¼ã€‚è¿™å¯ç”¨äºåœ¨æŒ‡æ ‡å€¼å‘ç”Ÿå˜åŒ–æ—¶ç«‹å³æ¨é€æ•°æ®ã€‚æ‚¨å¯ä»¥åœ¨ celery ä¸­ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡åˆ›å»ºè§¦å‘å™¨ï¼Œæˆ–è€…ä½¿ç”¨äº‘å‘å¸ƒ/è®¢é˜…ã€‚ä¸è¦ä»¥æ¯ 10 ç§’ä¸€ä¸ªç‚¹çš„é€Ÿåº¦å‘å•ä¸ªæ—¶é—´åºåˆ—å†™å…¥æ•°æ®ã€‚

æŸ¥çœ‹ metrics explorer ä¸‹çš„ç›‘æ§ä»ªè¡¨æ¿ï¼Œè§‚å¯Ÿæ‚¨çš„æ—¶é—´åºåˆ—äº§ç”Ÿçš„æ³¢åŠ¨ï¼ğŸ¥³

![](img/a98a3c3a439cfc35b3296f176f70d010.png)

åœ¨ä¸ºæ—¶é—´åºåˆ—å†™äº†å‡ ä¸ªå€¼ä¹‹å

æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒ[https://cloud . Google . com/monitoring/custom-metrics/creating-metrics](https://cloud.google.com/monitoring/custom-metrics/creating-metrics#writing-ts)ï¼Œæˆ–åœ¨ twitter ä¸Š ping æˆ‘@ [arpana_naa](https://twitter.com/arpana_naa) ï¼

åœ¨â€” [ç¬¬äºŒéƒ¨åˆ†](/google-cloud/fetching-monitoring-metrics-data-from-gcp-into-your-application-using-python-214358b0047e)ã€[ç¬¬ä¸‰éƒ¨åˆ†](/google-cloud/missing-data-points-in-your-monitoring-api-response-use-page-iterators-81d27e954c70)ä¸­æ‰¾åˆ°æœ¬ç³»åˆ—çš„å…¶ä»–å¸–å­ã€‚

[](/google-cloud/fetching-monitoring-metrics-data-from-gcp-into-your-application-using-python-214358b0047e) [## ä½¿ç”¨ python å°†ç›‘æ§æŒ‡æ ‡æ•°æ®ä» GCP æå–åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºä¸­

### åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å°†è§£é‡Šå¦‚ä½•ä½¿ç”¨ python å®¢æˆ·ç«¯åº“ä¸­çš„â€œlist_time_seriesâ€æ–¹æ³•â€¦

medium.com](/google-cloud/fetching-monitoring-metrics-data-from-gcp-into-your-application-using-python-214358b0047e)