<html>
<head>
<title>Summarizing videos in 300 lines of code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用300行代码总结视频</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/%EF%B8%8F-auto-generate-video-summaries-with-a-machine-learning-model-and-a-serverless-pipeline-c2f261c8035c?source=collection_archive---------0-----------------------#2020-05-30">https://medium.com/google-cloud/%EF%B8%8F-auto-generate-video-summaries-with-a-machine-learning-model-and-a-serverless-pipeline-c2f261c8035c?source=collection_archive---------0-----------------------#2020-05-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="1e81" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">⏳2021年10月8日更新</h1><ul class=""><li id="9c6b" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">更新<a class="ae jv" href="https://github.com/PicardParis/cherry-on-py/tree/main/gcf_video_summary" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj"> GitHub版本</strong> </a>最新库版本+ Python 3.7 → 3.9</li></ul></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="2d2d" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">👋你好！</h1><p id="663c" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">亲爱的开发者们:</p><p id="8f82" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">你喜欢谚语“一图胜千言”吗？我愿意。我们来看看对<em class="lc">“一图抵千帧”</em>是否也适用。</p><p id="c72d" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">在本教程中，您将看到以下内容:</p><ul class=""><li id="e973" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">如何在一瞬间理解一个视频的内容，</li><li id="edd9" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">在不到300行的Python (3.7)代码中。</li></ul><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es ll"><img src="../Images/e17571674b294b925c87d0790c527c29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sBJJr_f1TVd9Ocwl.jpeg"/></div></div><figcaption class="lx ly et er es lz ma bd b be z dx translated">由35个序列(镜头)组成的2'42 "视频生成的视觉摘要。摘要是一个网格，其中每个单元格是一帧，代表一个视频镜头。</figcaption></figure></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="d506" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">🔭目标</h1><p id="3f72" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">本教程有两个目标，一个是实践目标，一个是技术目标:</p><ol class=""><li id="a463" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq mb js jt ju bi translated">自动生成视频的可视摘要</li><li id="fbe1" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq mb js jt ju bi translated">使用以下属性构建处理管道:</li></ol><ul class=""><li id="b0e1" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">托管(随时准备就绪，易于设置)</li><li id="6a39" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">可扩展(能够并行摄取多个视频)</li><li id="e7a7" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">不使用时不花费任何东西</li></ul></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="b4c7" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">🛠️工具</h1><p id="f9a0" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">一些工具就足够了:</p><ul class=""><li id="bf4a" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">视频和结果的存储空间</li><li id="ca12" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">运行代码的无服务器解决方案</li><li id="15a1" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">用于分析视频的机器学习模型</li><li id="023c" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">从视频中提取帧的库</li><li id="8700" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">生成可视摘要的库</li></ul></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="4dda" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">🧱建筑</h1><p id="de6e" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">下面是使用3个谷歌云服务(<a class="ae jv" href="https://cloud.google.com/storage/docs" rel="noopener ugc nofollow" target="_blank">云存储</a>、<a class="ae jv" href="https://cloud.google.com/functions/docs" rel="noopener ugc nofollow" target="_blank">云功能</a>和<a class="ae jv" href="https://cloud.google.com/video-intelligence/docs" rel="noopener ugc nofollow" target="_blank">视频智能API </a>)的可能架构:</p><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es mc"><img src="../Images/75b7a4f08bd6c4006acc7f56e9abf21d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WSqvJEpDo9DVkCua.png"/></div></div></figure><p id="ea77" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">处理管道遵循以下步骤:</p><ol class=""><li id="9aad" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq mb js jt ju bi translated">您将视频上传到第一个存储桶(存储桶是云中的存储空间)</li><li id="4eea" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq mb js jt ju bi translated">上传事件自动触发第一个功能</li><li id="57e8" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq mb js jt ju bi translated">该函数向视频智能API发送请求以检测镜头</li><li id="6500" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq mb js jt ju bi translated">视频智能API分析视频并将结果(注释)上传到第二个存储桶</li><li id="0085" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq mb js jt ju bi translated">上传事件触发第二个功能</li><li id="3ab6" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq mb js jt ju bi translated">该功能下载注释和视频文件</li><li id="6ad8" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq mb js jt ju bi translated">该函数将摘要呈现并上传到第三个存储桶</li><li id="8057" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq mb js jt ju bi translated">视频摘要准备好了！</li></ol></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="f52e" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">🐍Python库</h1><p id="3fd8" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">开源客户端库让您可以用惯用的Python与Google云服务进行交互。您将使用以下内容:</p><p id="f6a7" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated"><code class="du md me mf mg b">Cloud Storage</code></p><ul class=""><li id="9a74" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">管理下载和上传</li><li id="7849" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated"><a class="ae jv" href="https://pypi.org/project/google-cloud-storage" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/google-cloud-storage</a></li></ul><p id="e4f1" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated"><code class="du md me mf mg b">Video Intelligence API</code></p><ul class=""><li id="3528" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">来分析视频</li><li id="0ace" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated"><a class="ae jv" href="https://pypi.org/project/google-cloud-videointelligence" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/google-cloud-videointelligence</a></li></ul><p id="92d8" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">这里有两个额外的Python库可供选择，以满足图形需求:</p><p id="843a" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated"><code class="du md me mf mg b">OpenCV</code></p><ul class=""><li id="9fbf" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">提取视频帧</li><li id="1b62" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">甚至还有一个无头版本(没有GUI特性)，这是服务的理想选择</li><li id="6126" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated"><a class="ae jv" href="https://pypi.org/project/opencv-python-headless" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/opencv-python-headless</a></li></ul><p id="009a" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated"><code class="du md me mf mg b">Pillow</code></p><ul class=""><li id="2d21" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">为了生成视觉摘要</li><li id="0af7" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated"><code class="du md me mf mg b">Pillow</code>是一个非常流行的图像库，既广泛又易于使用</li><li id="3401" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated"><a class="ae jv" href="https://pypi.org/project/Pillow" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/Pillow</a></li></ul></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="9b8f" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">⚙️项目设置</h1><p id="dad6" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">假设你有一个Google Cloud账户，你可以用<code class="du md me mf mg b">gcloud</code>和<code class="du md me mf mg b">gsutil</code>命令从Cloud Shell中设置架构。这让您可以以可重复的方式从头开始编写所有内容。</p><h2 id="f7cc" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">环境变量</h2><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="e2ca" class="mh ig hi mg b fi mz na l nb nc"># Project<br/><strong class="mg hj">PROJECT_NAME="Visual Summary"<br/>PROJECT_ID="visual-summary-REPLACE_WITH_UNIQUE_SUFFIX"<br/></strong># Cloud Storage region (https://cloud.google.com/storage/docs/locations)<br/><strong class="mg hj">GCS_REGION="europe-west1"<br/></strong># Cloud Functions region (https://cloud.google.com/functions/docs/locations)<br/><strong class="mg hj">GCF_REGION="europe-west1"<br/></strong># Source<br/><strong class="mg hj">GIT_REPO="cherry-on-py"<br/>PROJECT_SRC=~/$PROJECT_ID/$GIT_REPO/gcf_video_summary<br/><br/></strong># Cloud Storage buckets (environment variables)<br/><strong class="mg hj">export VIDEO_BUCKET="b1-videos_${PROJECT_ID}"<br/>export ANNOTATION_BUCKET="b2-annotations_${PROJECT_ID}"<br/>export SUMMARY_BUCKET="b3-summaries_${PROJECT_ID}"</strong></span></pre><blockquote class="nd ne nf"><p id="449f" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:您可以使用您的GitHub用户名作为唯一的后缀。</p></blockquote><h2 id="83d4" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">新项目</h2><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="842b" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">gcloud projects create $PROJECT_ID \<br/>  --name="$PROJECT_NAME" \<br/>  --set-as-default</strong></span><span id="dd24" class="mh ig hi mg b fi nj na l nb nc">Create in progress for [https://cloudresourcemanager.googleapis.com/v1/projects/PROJECT_ID].<br/>Waiting for [operations/cp...] to finish...done.<br/>Enabling service [cloudapis.googleapis.com] on project [PROJECT_ID]...<br/>Operation "operations/acf..." finished successfully.<br/>Updated property [core/project] to [PROJECT_ID].</span></pre><h2 id="9327" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">账单账户</h2><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="32ff" class="mh ig hi mg b fi mz na l nb nc"># Link project with billing account (single account)<br/><strong class="mg hj">BILLING_ACCOUNT=$(gcloud beta billing accounts list \<br/>    --format 'value(name)')</strong><br/># Link project with billing account (specific one among multiple accounts)<br/>BILLING_ACCOUNT=$(gcloud beta billing accounts list  \<br/>    --format 'value(name)' \<br/>    --filter "displayName='My Billing Account'")<br/><br/><strong class="mg hj">gcloud beta billing projects link $PROJECT_ID --billing-account $BILLING_ACCOUNT</strong></span><span id="94e4" class="mh ig hi mg b fi nj na l nb nc">billingAccountName: billingAccounts/XXXXXX-YYYYYY-ZZZZZZ<br/>billingEnabled: true<br/>name: projects/PROJECT_ID/billingInfo<br/>projectId: PROJECT_ID</span></pre><h2 id="79f6" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">大量</h2><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="773c" class="mh ig hi mg b fi mz na l nb nc"># Create buckets with uniform bucket-level access<br/><strong class="mg hj">gsutil mb -b on -c regional -l $GCS_REGION gs://$VIDEO_BUCKET<br/>gsutil mb -b on -c regional -l $GCS_REGION gs://$ANNOTATION_BUCKET<br/>gsutil mb -b on -c regional -l $GCS_REGION gs://$SUMMARY_BUCKET</strong></span><span id="5024" class="mh ig hi mg b fi nj na l nb nc">Creating gs://VIDEO_BUCKET/...<br/>Creating gs://ANNOTATION_BUCKET/...<br/>Creating gs://SUMMARY_BUCKET/...</span></pre><p id="2c4d" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">你可以在<a class="ae jv" href="https://console.cloud.google.com/storage/browser" rel="noopener ugc nofollow" target="_blank">云控制台</a>中查看它的样子:</p><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nk"><img src="../Images/4d2428a17571f55b249c7e29bad09308.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*X1EtcCS5kT9NC0mX.png"/></div></div></figure><h2 id="40c5" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">服务帐户</h2><p id="d3a6" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">创建服务帐户。这仅用于开发目的(生产不需要)。这为您提供了在本地运行代码的凭据。</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="8cd3" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">mkdir ~/$PROJECT_ID<br/>cd ~/$PROJECT_ID<br/><br/>SERVICE_ACCOUNT_NAME="dev-service-account"<br/>SERVICE_ACCOUNT="${SERVICE_ACCOUNT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com"<br/>gcloud iam service-accounts create $SERVICE_ACCOUNT_NAME<br/>gcloud iam service-accounts keys create ~/$PROJECT_ID/key.json --iam-account $SERVICE_ACCOUNT</strong></span><span id="6027" class="mh ig hi mg b fi nj na l nb nc">Created service account [SERVICE_ACCOUNT_NAME].<br/>created key [...] of type [json] as [~/PROJECT_ID/key.json] for [SERVICE_ACCOUNT]</span></pre><p id="6c80" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">设置<code class="du md me mf mg b">GOOGLE_APPLICATION_CREDENTIALS</code>环境变量，并检查它是否指向服务帐户密钥。当您在当前shell会话中运行应用程序代码时，客户端库将使用这些凭据进行身份验证。如果打开新的shell会话，请再次设置该变量。</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="822f" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">export GOOGLE_APPLICATION_CREDENTIALS=~/$PROJECT_ID/key.json<br/>cat $GOOGLE_APPLICATION_CREDENTIALS</strong></span><span id="9d5c" class="mh ig hi mg b fi nj na l nb nc">{<br/>  "type": "service_account",<br/>  "project_id": "PROJECT_ID",<br/>  "private_key_id": "...",<br/>  "private_key": "-----BEGIN PRIVATE KEY-----\n...",<br/>  "client_email": "SERVICE_ACCOUNT",<br/>  ...<br/>}</span></pre><p id="71aa" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">授权服务帐户访问存储桶:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="933c" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">IAM_BINDING="serviceAccount:${SERVICE_ACCOUNT}:roles/storage.objectAdmin"<br/>gsutil iam ch $IAM_BINDING gs://$VIDEO_BUCKET<br/>gsutil iam ch $IAM_BINDING gs://$ANNOTATION_BUCKET<br/>gsutil iam ch $IAM_BINDING gs://$SUMMARY_BUCKET</strong></span></pre><h2 id="3c8a" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">蜜蜂</h2><p id="8ec0" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">默认情况下，会启用一些API:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="b3d4" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">gcloud services list</strong></span><span id="d5e6" class="mh ig hi mg b fi nj na l nb nc">NAME                              TITLE<br/>bigquery.googleapis.com           BigQuery API<br/>bigquerystorage.googleapis.com    BigQuery Storage API<br/>cloudapis.googleapis.com          Google Cloud APIs<br/>clouddebugger.googleapis.com      Cloud Debugger API<br/>cloudtrace.googleapis.com         Cloud Trace API<br/>datastore.googleapis.com          Cloud Datastore API<br/>logging.googleapis.com            Cloud Logging API<br/>monitoring.googleapis.com         Cloud Monitoring API<br/>servicemanagement.googleapis.com  Service Management API<br/>serviceusage.googleapis.com       Service Usage API<br/>sql-component.googleapis.com      Cloud SQL<br/>storage-api.googleapis.com        Google Cloud Storage JSON API<br/>storage-component.googleapis.com  Cloud Storage</span></pre><p id="886a" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">启用视频智能和云功能API:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="4d59" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">gcloud services enable \<br/>  videointelligence.googleapis.com \<br/>  cloudfunctions.googleapis.com</strong></span><span id="1931" class="mh ig hi mg b fi nj na l nb nc">Operation "operations/acf..." finished successfully.</span></pre><h2 id="38da" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">源代码</h2><p id="5b9e" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">检索源代码:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="2547" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">cd ~/$PROJECT_ID<br/>git clone </strong><a class="ae jv" href="https://github.com/PicardParis/$GIT_REPO.git" rel="noopener ugc nofollow" target="_blank"><strong class="mg hj">https://github.com/PicardParis/$GIT_REPO.git</strong></a></span><span id="8029" class="mh ig hi mg b fi nj na l nb nc">Cloning into 'GIT_REPO'...<br/>...</span></pre></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="c0f7" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">🧠视频分析</h1><h2 id="798b" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">视频镜头检测</h2><p id="2d8f" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">视频智能API是一个预先训练好的机器学习模型，可以分析视频。多个功能之一是视频镜头检测。对于第一个云函数，这里有一个调用<code class="du md me mf mg b">annotate_video()</code>的核心函数，带有<code class="du md me mf mg b">SHOT_CHANGE_DETECTION</code>特性:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><h2 id="b749" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">本地开发和测试</h2><p id="ecc0" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">在部署该功能之前，您需要开发和测试它。创建一个Python 3虚拟环境并激活它:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="51be" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">cd ~/$PROJECT_ID<br/>python3 -m venv venv<br/>source venv/bin/activate</strong></span></pre><p id="2946" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">安装依赖项:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="942a" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">pip install -r $PROJECT_SRC/gcf1_detect_shots/requirements.txt</strong></span></pre><p id="cb12" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">检查依赖关系:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="800b" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">pip list</strong></span><span id="9103" class="mh ig hi mg b fi nj na l nb nc">Package                        Version<br/>------------------------------ ----------<br/>...<br/>google-cloud-storage           1.28.1<br/>google-cloud-videointelligence 1.14.0<br/>...</span></pre><p id="a35e" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">您可以使用主作用域在脚本模式下测试函数:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><blockquote class="nd ne nf"><p id="ce08" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:您已经在shell会话中导出了<code class="du md me mf mg b">ANNOTATION_BUCKET</code>环境变量；您还将在稍后的部署阶段定义它。这使得代码变得通用，并允许您独立于输出桶重用它。</p></blockquote><p id="72c8" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">测试功能:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="ae59" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">VIDEO_PATH="</strong><strong class="mg hj">cloud-samples-data/video</strong><strong class="mg hj">/gbikes_dinosaur.mp4"<br/>VIDEO_URI="gs://$VIDEO_PATH"<br/>python $PROJECT_SRC/gcf1_detect_shots/main.py $VIDEO_URI</strong></span><span id="5bf3" class="mh ig hi mg b fi nj na l nb nc">Launching shot detection for &lt;gs://<!-- -->cloud-samples-data/video<!-- -->/gbikes_dinosaur.mp4&gt;...</span></pre><blockquote class="nd ne nf"><p id="a5e8" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:测试视频<code class="du md me mf mg b">&lt;gbikes_dinosaur.mp4&gt;</code>位于外部桶中。这是可行的，因为视频是公开的。</p></blockquote><p id="443c" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">稍等片刻，检查注释是否已经生成:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="e820" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">gsutil ls -r gs://$ANNOTATION_BUCKET</strong></span><span id="6470" class="mh ig hi mg b fi nj na l nb nc">964  YYYY-MM-DDThh:mm:ssZ  gs://ANNOTATION_BUCKET/VIDEO_PATH.json<br/>TOTAL: 1 objects, 964 bytes (964 B)</span></pre><p id="860e" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">检查注释文件的最后200个字节:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="a2d0" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">gsutil cat -r -200 gs://$ANNOTATION_BUCKET/$VIDEO_PATH.json</strong></span><span id="e114" class="mh ig hi mg b fi nj na l nb nc">}<br/>    }, {<br/>      "start_time_offset": {<br/>        "seconds": 28,<br/>        "nanos": 166666000<br/>      },<br/>      "end_time_offset": {<br/>        "seconds": 42,<br/>        "nanos": 766666000<br/>      }<br/>    } ]<br/>  } ]<br/>}</span></pre><blockquote class="nd ne nf"><p id="2ad5" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:这些是最后一个视频镜头的开始和结束位置。一切似乎都很好。</p></blockquote><p id="073f" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">完成后清理干净:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="458f" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">gsutil rm gs://$ANNOTATION_BUCKET/$VIDEO_PATH.json<br/><br/>deactivate<br/><br/>rm -rf venv</strong></span></pre><h2 id="48c9" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">函数入口点</h2><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><blockquote class="nd ne nf"><p id="1999" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:每当一个视频被上传到定义为触发器的桶时，这个函数将被调用。</p></blockquote><h2 id="7243" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">功能部署</h2><p id="4c02" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">部署第一个功能:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="1ffd" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">GCF_NAME="gcf1_detect_shots"<br/>GCF_SOURCE="$PROJECT_SRC/gcf1_detect_shots"<br/>GCF_ENTRY_POINT="gcf_detect_shots"<br/>GCF_TRIGGER_BUCKET="$VIDEO_BUCKET"<br/>GCF_ENV_VARS="ANNOTATION_BUCKET=$ANNOTATION_BUCKET"<br/>GCF_MEMORY="128MB"<br/><br/>gcloud functions deploy $GCF_NAME \<br/>  --runtime python37  \<br/>  --source $GCF_SOURCE \<br/>  --entry-point $GCF_ENTRY_POINT \<br/>  --update-env-vars $GCF_ENV_VARS \<br/>  --trigger-bucket $GCF_TRIGGER_BUCKET \<br/>  --region $GCF_REGION \<br/>  --memory $GCF_MEMORY \<br/>  --quiet</strong></span></pre><blockquote class="nd ne nf"><p id="7270" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:为云函数分配的默认内存是256MB(可能的值是128MB、256 MB、512MB、1024MB和2048MB)。由于该函数没有内存或CPU需求(它发送一个简单的API请求)，最小内存设置就足够了。</p></blockquote><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="e172" class="mh ig hi mg b fi mz na l nb nc">Deploying function (may take a while - up to 2 minutes)...done.<br/>availableMemoryMb: 128<br/>entryPoint: gcf_detect_shots<br/>environmentVariables:<br/>  ANNOTATION_BUCKET: b2-annotations...<br/>eventTrigger:<br/>  eventType: google.storage.object.finalize<br/>...<br/>status: ACTIVE<br/>timeout: 60s<br/>updateTime: 'YYYY-MM-DDThh:mm:ss.mmmZ'<br/>versionId: '1'</span></pre><blockquote class="nd ne nf"><p id="b75e" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:<code class="du md me mf mg b">ANNOTATION_BUCKET</code>环境变量是用<code class="du md me mf mg b">--update-env-vars</code>标志定义的。使用环境变量可以让您用不同的触发器和输出桶部署完全相同的代码。</p></blockquote><p id="8337" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">下面是它在<a class="ae jv" href="https://console.cloud.google.com/functions/list" rel="noopener ugc nofollow" target="_blank">云控制台</a>中的样子:</p><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nk"><img src="../Images/99791706a19abca834dead8b31894010.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IPQ5AixblUiLf8G_.png"/></div></div></figure><h2 id="43a3" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">生产测试</h2><p id="cd87" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">确保在生产中测试该功能。将视频拷贝到视频桶中:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="3ff7" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">VIDEO_NAME="gbikes_dinosaur.mp4"<br/>SRC_URI="gs://</strong><strong class="mg hj">cloud-samples-data/video</strong><strong class="mg hj">/$VIDEO_NAME"<br/>DST_URI="gs://$VIDEO_BUCKET/$VIDEO_NAME"<br/><br/>gsutil cp $SRC_URI $DST_URI</strong></span><span id="aebf" class="mh ig hi mg b fi nj na l nb nc">Copying gs://<!-- -->cloud-samples-data/video<!-- -->/gbikes_dinosaur.mp4 [Content-Type=video/mp4]...<br/>- [1 files][ 62.0 MiB/ 62.0 MiB]<br/>Operation completed over 1 objects/62.0 MiB.</span></pre><p id="9860" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">查询日志以检查该功能是否已被触发:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="52d6" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">gcloud functions logs read --region $GCF_REGION</strong></span><span id="cfa9" class="mh ig hi mg b fi nj na l nb nc">LEVEL  NAME               EXECUTION_ID  TIME_UTC  LOG<br/>D      gcf1_detect_shots  ...           ...       Function execution started<br/>I      gcf1_detect_shots  ...           ...       Launching shot detection for &lt;gs://VIDEO_BUCKET/VIDEO_NAME&gt;...<br/>D      gcf1_detect_shots  ...           ...       Function execution took 874 ms, finished with status: 'ok'</span></pre><p id="ef8b" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">稍等片刻，检查注释存储桶:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="0bc5" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">gsutil ls -r gs://$ANNOTATION_BUCKET</strong></span></pre><p id="7d92" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">您应该会看到注释文件:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="c6d0" class="mh ig hi mg b fi mz na l nb nc">gs://ANNOTATION_BUCKET/VIDEO_BUCKET/:<br/>gs://ANNOTATION_BUCKET/VIDEO_BUCKET/VIDEO_NAME.json</span></pre><p id="ec85" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">第一个功能是可操作的！</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="c4b6" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">🎞️视觉摘要</h1><h2 id="5729" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">代码结构</h2><p id="cbcc" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">有趣的是将代码分成两个主要的类:</p><ul class=""><li id="0c40" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated"><code class="du md me mf mg b">StorageHelper</code>用于本地文件和云存储对象管理</li><li id="4423" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated"><code class="du md me mf mg b">VideoProcessor</code>用于图形处理</li></ul><p id="17af" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">下面是一个可能的核心函数:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><blockquote class="nd ne nf"><p id="a0d7" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:如果出现异常，用<code class="du md me mf mg b">logging.exception()</code>记录它们以获得生产日志中的堆栈跟踪是很方便的。</p></blockquote><h2 id="d66e" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">类别<code class="du md me mf mg b">StorageHelper</code></h2><p id="291f" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">该类管理以下内容:</p><ul class=""><li id="ebd2" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">视频镜头注释的检索和解析</li><li id="c34a" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">源视频的下载</li><li id="029f" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">上传生成的可视摘要</li><li id="8bfc" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">文件名</li></ul><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="3dc1" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">源视频在<code class="du md me mf mg b">with</code>语句上下文管理器中处理:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><blockquote class="nd ne nf"><p id="9837" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注:下载后，视频将使用<code class="du md me mf mg b">/tmp</code> RAM磁盘中的存储空间(无服务器功能的唯一可写空间)。最好在不再需要临时文件时将其删除，以避免将来调用该函数时出现潜在的内存不足错误。</p></blockquote><p id="9053" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">使用方法<code class="du md me mf mg b">storage.Blob.download_as_string()</code>和<code class="du md me mf mg b">json.loads()</code>检索注释:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="47a3" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">解析由这个<code class="du md me mf mg b">VideoShot</code>助手类处理:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="0717" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">视频拍摄信息可以通过getter和generator公开:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="236a" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">选择命名约定是为了在不同的存储桶之间保持一致的对象路径。这也允许您从注释URI中推断出视频路径:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="133b" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">视频直接用<code class="du md me mf mg b">storage.Blob.download_to_filename()</code>下载:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="ae6b" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">相反，可以使用<code class="du md me mf mg b">storage.Blob.upload_from_string()</code>上传结果:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><blockquote class="nd ne nf"><p id="b485" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:<code class="du md me mf mg b">from_string</code>在这里表示<code class="du md me mf mg b">from_bytes</code>(Python 2遗留)。<code class="du md me mf mg b">Pillow</code>支持使用内存镜像，避免了管理本地文件。</p></blockquote><p id="cee8" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">最后，这里是摘要文件的一个可能的命名约定:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><h2 id="7561" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">类别<code class="du md me mf mg b">VideoProcessor</code></h2><p id="2e4e" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">该类管理以下内容:</p><ul class=""><li id="81be" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">视频帧提取</li><li id="a1bd" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">可视化摘要生成</li></ul><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="0dd8" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">打开和关闭视频在<code class="du md me mf mg b">with</code>语句上下文管理器中处理:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="3493" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">视频摘要是一个单元格网格，可以用两个发生器在单个循环中渲染:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><blockquote class="nd ne nf"><p id="5641" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:<code class="du md me mf mg b">shot_ratio</code>默认设置为<code class="du md me mf mg b">0.5</code>，提取视频拍摄的中间帧。</p></blockquote><p id="390c" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">第一个生成器生成细胞图像:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="6f3f" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">第二个生成器产生单元格位置:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="8eb4" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated"><code class="du md me mf mg b">OpenCV</code>轻松提取给定位置的视频帧:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="08c4" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">选择摘要网格构成是任意的。下面是一个示例，用于编写保留视频比例的摘要:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="b14d" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">最后，<code class="du md me mf mg b">Pillow</code>提供了对图像序列化的完全控制:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><blockquote class="nd ne nf"><p id="233c" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:使用内存中的映像可以避免管理本地文件，并使用较少的内存。</p></blockquote><h2 id="951f" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">本地开发和测试</h2><p id="5ae5" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">您可以使用主作用域在脚本模式下测试函数:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="0398" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">测试功能:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="3853" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">cd ~/$PROJECT_ID<br/>python3 -m venv venv<br/>source venv/bin/activate<br/><br/>pip install -r $PROJECT_SRC/gcf2_generate_summary/requirements.txt<br/><br/>VIDEO_NAME="gbikes_dinosaur.mp4"<br/>ANNOTATION_URI="gs://$ANNOTATION_BUCKET/$VIDEO_BUCKET/$VIDEO_NAME.json"<br/><br/>python $PROJECT_SRC/gcf2_generate_summary/main.py $ANNOTATION_URI</strong></span><span id="5493" class="mh ig hi mg b fi nj na l nb nc">Downloading -&gt; /tmp/SUMMARY_BUCKET/VIDEO_BUCKET/VIDEO_NAME<br/>Generating summary...<br/>Uploading -&gt; VIDEO_BUCKET/VIDEO_NAME.summary004.jpeg</span></pre><blockquote class="nd ne nf"><p id="8ec4" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注:上传的视频摘要显示4个镜头。</p></blockquote><p id="27e9" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">清理:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="34b9" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">deactivate<br/>rm -rf venv</strong></span></pre><h2 id="f6a8" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">函数入口点</h2><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><blockquote class="nd ne nf"><p id="e525" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:每当一个注释文件被上传到定义为触发器的桶时，这个函数就会被调用。</p></blockquote><h2 id="a0b9" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">功能部署</h2><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="2b0c" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">GCF_NAME="gcf2_generate_summary"<br/>GCF_SOURCE="$PROJECT_SRC/gcf2_generate_summary"<br/>GCF_ENTRY_POINT="gcf_generate_summary"<br/>GCF_TRIGGER_BUCKET="$ANNOTATION_BUCKET"<br/>GCF_ENV_VARS="SUMMARY_BUCKET=$SUMMARY_BUCKET"<br/>GCF_TIMEOUT="540s"<br/>GCF_MEMORY="512MB"<br/><br/>gcloud functions deploy $GCF_NAME \<br/>  --runtime python37  \<br/>  --source $GCF_SOURCE \<br/>  --entry-point $GCF_ENTRY_POINT \<br/>  --update-env-vars $GCF_ENV_VARS \<br/>  --trigger-bucket $GCF_TRIGGER_BUCKET \<br/>  --region $GCF_REGION \<br/>  --timeout $GCF_TIMEOUT \<br/>  --memory $GCF_MEMORY \<br/>  --quiet</strong></span></pre><p id="cf6e" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">注意事项:</p><ul class=""><li id="caf3" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">云函数的默认超时是60秒。当您部署一个可能需要长时间处理的后台函数时，将其设置为最大值(540秒= 9分钟)。</li><li id="6e45" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">你还需要为视频和图像处理增加一点内存。根据视频的大小和输出摘要的最大分辨率，或者如果您需要更快地生成摘要(内存大小和vCPU速度相关)，您可以使用更高的值(1024MB或2048MB)。</li></ul><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="3e47" class="mh ig hi mg b fi mz na l nb nc">Deploying function (may take a while - up to 2 minutes)...done.<br/>availableMemoryMb: 512<br/>entryPoint: gcf_generate_summary<br/>environmentVariables:<br/>  SUMMARY_BUCKET: b3-summaries...<br/>...<br/>status: ACTIVE<br/>timeout: 540s<br/>updateTime: 'YYYY-MM-DDThh:mm:ss.mmmZ'<br/>versionId: '1'</span></pre><p id="a96d" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">下面是它在<a class="ae jv" href="https://console.cloud.google.com/functions/list" rel="noopener ugc nofollow" target="_blank">云控制台</a>中的样子:</p><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nk"><img src="../Images/09759d1e834a26df4ec881a97442992e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ci683g0AQEorLvDE.png"/></div></div></figure><h2 id="5e04" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">生产测试</h2><p id="9211" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">确保在生产中测试该功能。您可以在第二个存储桶中上传注释文件:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="a824" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">VIDEO_NAME="gbikes_dinosaur.mp4"<br/>ANNOTATION_FILE="$VIDEO_NAME.json"<br/>ANNOTATION_URI="gs://$ANNOTATION_BUCKET/$VIDEO_BUCKET/$ANNOTATION_FILE"<br/>gsutil cp $ANNOTATION_URI .<br/>gsutil cp $ANNOTATION_FILE $ANNOTATION_URI<br/>rm $ANNOTATION_FILE</strong></span></pre><blockquote class="nd ne nf"><p id="2fdc" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:这将重用先前的本地测试注释文件并覆盖它。覆盖桶中的文件也会触发附加的函数。</p></blockquote><p id="8d5e" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">等待几秒钟，并查询日志以检查该功能是否已被触发:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="4d0e" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">gcloud functions logs read --region $GCF_REGION</strong></span><span id="ab16" class="mh ig hi mg b fi nj na l nb nc">LEVEL  NAME                   EXECUTION_ID  TIME_UTC  LOG<br/>...<br/>D      gcf2_generate_summary  ...           ...       Function execution started<br/>I      gcf2_generate_summary  ...           ...       Downloading -&gt; /tmp/SUMMARY_BUCKET/VIDEO_BUCKET/VIDEO_NAME<br/>I      gcf2_generate_summary  ...           ...       Generating summary...<br/>I      gcf2_generate_summary  ...           ...       Uploading -&gt; VIDEO_BUCKET/VIDEO_NAME.summary004.jpeg<br/>D      gcf2_generate_summary  ...           ...       Function execution took 11591 ms, finished with status: 'ok'</span></pre><p id="90da" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">第二个功能正在运行，管道已经到位！现在，您可以通过在第一个桶中复制新视频来进行端到端测试。</p><h2 id="6b00" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">结果</h2><p id="9a37" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">将生成的摘要下载到您的计算机上:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="cd37" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">cd ~/$PROJECT_ID<br/>gsutil cp -r gs://$SUMMARY_BUCKET/**.jpeg .<br/>cloudshell download *.jpeg</strong></span></pre><p id="cc6e" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">以下是<code class="du md me mf mg b">gbikes_dinosaur.mp4</code> (4个检测到的镜头)的视觉摘要:</p><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es ll"><img src="../Images/a4e29826d6cbe5cf2e4521c8049142e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5kElus_pB3EIoDxU.jpeg"/></div></div></figure><p id="ee83" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">您也可以从<a class="ae jv" href="https://console.cloud.google.com/storage/browser/" rel="noopener ugc nofollow" target="_blank">云控制台</a>直接预览文件:</p><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nk"><img src="../Images/1eeb933ad7ad66a345d3c01646a1b1d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3iMF9kMT7x7xgtWq.png"/></div></div></figure></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="596a" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">🍒Py上的樱桃🐍</h1><p id="5864" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">现在，蛋糕上的糖衣(或者我们用法语说的“馅饼上的樱桃”)…</p><p id="cb11" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">基于相同的架构和代码，您可以添加一些功能:</p><ul class=""><li id="9102" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">触发其他桶中视频的处理</li><li id="8fb5" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">生成多种格式的摘要(如JPEG、PNG、WEBP)</li><li id="076e" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">生成动画摘要(也有多种格式，如GIF、PNG、WEBP)</li></ul><p id="2c86" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">丰富架构以复制2个项目:</p><ul class=""><li id="54a2" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">视频镜头检测功能，使其作为HTTP端点运行</li><li id="9ddc" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">处理动画图像的摘要生成功能</li></ul><p id="c26b" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">调整代码以支持新功能:</p><ul class=""><li id="db65" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">用于生成静态或动态摘要的<code class="du md me mf mg b">animated</code>参数</li><li id="1147" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">以多种格式保存和上传结果</li></ul><h2 id="c8e9" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">架构(第2版)</h2><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es mc"><img src="../Images/8840f846967d8cbe723fd3fa5487cb30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VQdimtG1UCuy4KkK.png"/></div></div></figure><ul class=""><li id="7deb" class="jd je hi jf b jg kx ji ky jk ld jm le jo lf jq jr js jt ju bi translated">A.视频镜头检测也可以通过HTTP GET请求手动触发</li><li id="e6b7" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">B.静态和动态摘要在两个函数中并行生成</li><li id="8605" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq jr js jt ju bi translated">C.摘要以多种图像格式上传</li></ul><h2 id="ad52" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">HTTP入口点</h2><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><blockquote class="nd ne nf"><p id="a129" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:这是与<code class="du md me mf mg b">gcf_detect_shots</code>相同的代码，带有从GET请求中提供的视频URI参数。</p></blockquote><h2 id="35e6" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">功能部署</h2><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="c6c9" class="mh ig hi mg b fi mz na l nb nc">GCF_NAME="gcf1_detect_shots_http"<br/>GCF_SOURCE="$PROJECT_SRC/gcf1_detect_shots"<br/>GCF_ENTRY_POINT="gcf_detect_shots_http"<br/>GCF_TRIGGER_BUCKET="$VIDEO_BUCKET"<br/>GCF_ENV_VARS="ANNOTATION_BUCKET=$ANNOTATION_BUCKET"<br/>GCF_MEMORY="128MB"<br/><br/>gcloud functions deploy $GCF_NAME \<br/>  --runtime python37  \<br/>  --source $GCF_SOURCE \<br/>  --entry-point $GCF_ENTRY_POINT \<br/>  --update-env-vars $GCF_ENV_VARS \<br/>  --trigger-http \<br/>  --region $GCF_REGION \<br/>  --memory $GCF_MEMORY \<br/>  --quiet</span></pre><p id="dcb5" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">下面是它在<a class="ae jv" href="https://console.cloud.google.com/functions/list" rel="noopener ugc nofollow" target="_blank">云控制台</a>中的样子:</p><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nk"><img src="../Images/06d4abe164a2b1a15a1ae305a85e40cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4fPdiARXnY-_41-C.png"/></div></div></figure><h2 id="63c8" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">动画支持</h2><p id="ee12" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">在核心功能中增加一个<code class="du md me mf mg b">animated</code>选项:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="718c" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">定义您有兴趣生成的格式:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="802f" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">添加支持以不同格式生成静态和动态摘要:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="e0e2" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">序列化仍然可以在单个函数中进行:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><blockquote class="nd ne nf"><p id="d50f" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:<code class="du md me mf mg b">Pillow</code>是通用和一致的，允许重要和干净的代码分解。</p></blockquote><p id="0574" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">向<code class="du md me mf mg b">StorageHelper</code>类添加一个<code class="du md me mf mg b">animated</code>可选参数:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><p id="9fed" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">最后，在入口点添加一个<code class="du md me mf mg b">ANIMATED</code>可选环境变量:</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="nl nm l"/></div></figure><h2 id="4972" class="mh ig hi bd ih mi mj mk il ml mm mn ip jk mo mp it jm mq mr ix jo ms mt jb mu bi translated">功能部署</h2><p id="454e" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">使用附加的<code class="du md me mf mg b">ANIMATED</code>环境变量复制第二个函数:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="1565" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">GCF_NAME="gcf2_generate_summary_animated"<br/>GCF_SOURCE="$PROJECT_SRC/gcf2_generate_summary"<br/>GCF_ENTRY_POINT="gcf_generate_summary"<br/>GCF_TRIGGER_BUCKET="$ANNOTATION_BUCKET"<br/>GCF_ENV_VARS1="SUMMARY_BUCKET=$SUMMARY_BUCKET"<br/>GCF_ENV_VARS2="ANIMATED=1"<br/>GCF_TIMEOUT="540s"<br/>GCF_MEMORY="2048MB"<br/><br/>gcloud functions deploy $GCF_NAME \<br/>  --runtime python37  \<br/>  --source $GCF_SOURCE \<br/>  --entry-point $GCF_ENTRY_POINT \<br/>  --update-env-vars $GCF_ENV_VARS1 \<br/>  --update-env-vars $GCF_ENV_VARS2 \<br/>  --trigger-bucket $GCF_TRIGGER_BUCKET \<br/>  --region $GCF_REGION \<br/>  --timeout $GCF_TIMEOUT \<br/>  --memory $GCF_MEMORY \<br/>  --quiet</strong></span></pre><p id="c7b0" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">下面是它在<a class="ae jv" href="https://console.cloud.google.com/functions/list" rel="noopener ugc nofollow" target="_blank">云控制台</a>中的样子:</p><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nk"><img src="../Images/aff146adcee461ba070dd13060c6af21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JgdtT1hHxExMKhg1.png"/></div></div></figure></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="9924" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">🎉最终测试</h1><p id="961c" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">HTTP端点允许您用GET请求触发管道:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="29e4" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">GCF_NAME="gcf1_detect_shots_http"<br/>VIDEO_URI="gs://</strong><strong class="mg hj">cloud-samples-data/video</strong><strong class="mg hj">/visionapi.mp4"<br/>GCF_URL="https://$GCF_REGION-$PROJECT_ID.cloudfunctions.net/$GCF_NAME?video_uri=$VIDEO_URI"<br/><br/>curl $GCF_URL -H "Authorization: bearer $(gcloud auth print-identity-token)"</strong></span><span id="05d7" class="mh ig hi mg b fi nj na l nb nc">Launched shot detection for video_uri &lt;VIDEO_URI&gt;</span></pre><blockquote class="nd ne nf"><p id="8f5f" class="ki kj lc jf b jg kx kk kl ji ky km kn ng kz kp kq nh la ks kt ni lb kv kw jq hb bi translated">注意:测试视频<code class="du md me mf mg b">&lt;visionapi.mp4&gt;</code>位于一个外部存储桶中，但可以公开访问。</p></blockquote><p id="e626" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">此外，将一个或多个视频复制到视频桶中。您可以拖放视频:</p><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nk"><img src="../Images/f8f936189d1adc5499dc691f55b5f06f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2piYMwPyLnx4sP61.gif"/></div></div></figure><p id="f6a5" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">然后视频被并行处理。以下是一些日志:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="62de" class="mh ig hi mg b fi mz na l nb nc">LEVEL NAME                           EXECUTION_ID ... LOG<br/>...<br/>D     gcf2_generate_summary_animated f6n6tslsfwdu ... Function execution took 49293 ms, finished with status: 'ok'<br/>I     gcf2_generate_summary          yd1vqabafn17 ... Uploading -&gt; b1-videos.../JaneGoodall.mp4.summary035_still.png<br/>I     gcf2_generate_summary_animated qv9b03814jjk ... shot_ratio: 43%<br/>I     gcf2_generate_summary          yd1vqabafn17 ... Uploading -&gt; b1-videos.../JaneGoodall.mp4.summary035_still.webp<br/>D     gcf2_generate_summary          yd1vqabafn17 ... Function execution took 54616 ms, finished with status: 'ok'<br/>I     gcf2_generate_summary_animated g4d2wrzxz2st ... shot_ratio: 71%<br/>...<br/>D     gcf2_generate_summary          amwmov1wk0gn ... Function execution took 65256 ms, finished with status: 'ok'<br/>I     gcf2_generate_summary_animated 7pp882fz0x84 ... shot_ratio: 57%<br/>I     gcf2_generate_summary_animated i3u830hsjz4r ... Uploading -&gt; b1-videos.../JaneGoodall.mp4.summary035_anim.png<br/>I     gcf2_generate_summary_animated i3u830hsjz4r ... Uploading -&gt; b1-videos.../JaneGoodall.mp4.summary035_anim.webp<br/>D     gcf2_generate_summary_animated i3u830hsjz4r ... Function execution took 70862 ms, finished with status: 'ok'<br/>...</span></pre><p id="bb09" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">在第三个桶中，您将找到所有静态和动态摘要:</p><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es nk"><img src="../Images/ae909eabb7d1e5a94bf452fb10152e80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NTDWw5uXmNWsWr6n.png"/></div></div></figure><p id="517b" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">你已经看到了作为本教程介绍的<code class="du md me mf mg b">&lt;JaneGoodall.mp4&gt;</code>的静态摘要。在动画版本中，只有6帧，你会对<a class="ae jv" href="https://storage.googleapis.com/cloud-samples-data/video/JaneGoodall.mp4" rel="noopener ugc nofollow" target="_blank">的整个视频</a>有更好的了解:</p><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es ll"><img src="../Images/8fa83f631fd18de398472e3eb4621037.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*O18noPhqhyceU85Q.gif"/></div></div></figure><p id="eaa6" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">如果您不想保留您的项目，您可以删除它:</p><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="0a4c" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">gcloud projects delete $PROJECT_ID</strong></span></pre></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="09a6" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">➕还有一件事</h1><pre class="lm ln lo lp fd mv mg mw mx aw my bi"><span id="f9cf" class="mh ig hi mg b fi mz na l nb nc"><strong class="mg hj">first_line_after_licence=16<br/>find $PROJECT_SRC -name '*.py' -exec tail -n +$first_line_after_licence {} \; | grep -v "^$" | wc -l</strong></span><span id="6f5d" class="mh ig hi mg b fi nj na l nb nc">289</span></pre><p id="8e6d" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated">你用不到300行Python代码就完成了所有工作。少台词，少bug！</p><p id="94b6" class="pw-post-body-paragraph ki kj hi jf b jg kx kk kl ji ky km kn jk kz kp kq jm la ks kt jo lb kv kw jq hb bi translated"><strong class="jf hj">🔥🐍任务完成！🐍🔥</strong></p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="04f5" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">🖖再见</h1><p id="1241" class="pw-post-body-paragraph ki kj hi jf b jg jh kk kl ji jj km kn jk ko kp kq jm kr ks kt jo ku kv kw jq hb bi translated">我希望你能欣赏这篇教程，并乐意阅读你的反馈。也可以<a class="ae jv" href="https://twitter.com/PicardParis" rel="noopener ugc nofollow" target="_blank">在Twitter上关注我</a>。</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="48aa" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">⏳更新</h1><ul class=""><li id="bda9" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated"><strong class="jf hj">2021–10–08</strong>:更新<a class="ae jv" href="https://github.com/PicardParis/cherry-on-py/tree/main/gcf_video_summary" rel="noopener ugc nofollow" target="_blank"> GitHub版本</a>最新库版本+ Python 3.7 → 3.9</li></ul></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="70f5" class="if ig hi bd ih ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc bi translated">📜同样在这个系列中</h1><ol class=""><li id="ca83" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq mb js jt ju bi translated">总结视频</li><li id="14bb" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq mb js jt ju bi translated"><a class="ae jv" rel="noopener" href="/google-cloud/video-object-tracking-as-a-service-18eb4227df34?source=friends_link&amp;sk=c9602c33c77aa950a59282b6de5c0c57">跟踪视频对象</a></li><li id="efe5" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq mb js jt ju bi translated"><a class="ae jv" rel="noopener" href="/google-cloud/face-detection-and-processing-in-300-lines-of-code-38dc51a115d4?source=friends_link&amp;sk=cc252ab86eab9ed2e8583963d0598661">人脸检测和处理</a></li><li id="b6e5" class="jd je hi jf b jg lg ji lh jk li jm lj jo lk jq mb js jt ju bi translated"><a class="ae jv" rel="noopener" href="/google-cloud/deploy-a-coloring-page-generator-in-minutes-with-cloud-run-bff59e59d890?source=friends_link&amp;sk=a3d6e22e7e77828e411592f46025531e">处理图像</a></li></ol></div></div>    
</body>
</html>