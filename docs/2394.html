<html>
<head>
<title>GKE configuration discovery for connecting from outside of the cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于从群集外部连接的GKE配置发现</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/dynamic-kubernetes-configuration-for-gke-b249afb92017?source=collection_archive---------0-----------------------#2022-09-30">https://medium.com/google-cloud/dynamic-kubernetes-configuration-for-gke-b249afb92017?source=collection_archive---------0-----------------------#2022-09-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="419b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有时，您希望从集群外部更改或检查GKE集群上的资源。例如，您可能有一个简单的云功能或云运行服务，它会为您安排一个Pod。挑战可能在于正确设置配置以连接到Kubernetes主API。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/a06182a1158b9b60a88e38cb559e9942.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*2FQxTx96LoeEgAQtJeyYQQ.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">这个代码的高级设置可能是有用的</figcaption></figure><p id="5e31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一种方法是将K8S配置文件放入容器或函数代码中，但这意味着您有一个特定于环境的容器或函数。这并不是我们真正想要的，因为它限制了我们可部署的可移植性。</p><p id="6e15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我看来，更好的方法是使用GKE API从集群中发现我们需要的信息。第一步是加载GKE集群信息，为此我们可以使用gcloud sdk for Golang:</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="15b1" class="ju jv hi jq b fi jw jx l jy jz">func getClusterFromGkeApi(clusterName string) (*containerpb.Cluster, error) {<br/> ctx := context.Background()<br/> c, err := container.NewClusterManagerClient(ctx)<br/> if err != nil {<br/>  return nil, err<br/> }<br/> req := &amp;containerpb.GetClusterRequest{<br/>  Name: clusterName,<br/> }<br/> cluster, err := c.GetCluster(ctx, req)<br/> if err != nil {<br/>  return nil, err<br/> }<br/> defer c.Close()<br/> return cluster, err<br/>}</span></pre><p id="eae4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ka kb kc jq b">clusterName</code>是集群的全限定名称，形状为<code class="du ka kb kc jq b">projects/&lt;project_id&gt;/locations/&lt;zone or region&gt;/clusters/&lt;cluster_name&gt;</code>。接下来，我们使用群集创建K8S配置:</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="1c56" class="ju jv hi jq b fi jw jx l jy jz">func autoDiscoverGkeConfig() (*clientcmdapi.Config, error) {<br/> cluster, err := getClusterFromGkeApi(*gkeClusterName)<br/> if err != nil {<br/> log.Printf(“Failed retrieving cluster via API %v”, err)<br/> return nil, fmt.Errorf(“unable to retrieve cluster”)<br/> }<br/> config, err := createKubeConfig(cluster.Endpoint, cluster.MasterAuth.ClusterCaCertificate)<br/> if err != nil {<br/> log.Printf(“Failed creating cluster config %v”, err)<br/> return nil, fmt.Errorf(“unable to create config”)<br/> }<br/> return config, nil<br/>}</span></pre><p id="f61c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在下面完整的例子中找到<code class="du ka kb kc jq b">createKubeConfig</code>函数，它只是为我们生成配置结构。我们现在可以在创建K8S客户端时使用<code class="du ka kb kc jq b">autoDiscoverGkeConfig</code>:</p><pre class="je jf jg jh fd jp jq jr js aw jt bi"><span id="8282" class="ju jv hi jq b fi jw jx l jy jz">config, err = clientcmd.BuildConfigFromKubeconfigGetter(“”, autoDiscoverGkeConfig)<br/> if err != nil {<br/> log.Fatalf(“failed creating k8s client via autodiscovery %v”, err.Error())<br/> }</span><span id="b7ae" class="ju jv hi jq b fi kd jx l jy jz">clientset, err := kubernetes.NewForConfig(config)<br/> if err != nil {<br/> log.Fatalf(“failed creating the clientset %v”, err.Error())<br/> }</span></pre><p id="b861" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个完整的例子，我在它周围添加了一些方便的功能，使它成为一个更好的独立例子。在不提供任何配置的情况下，它将在您的用户家中尝试您的“普通”kubeconfig文件。但是当通过<code class="du ka kb kc jq b">gke_cluster_name</code>标志提供GKE集群名称时，它将使用上述发现机制，这使得配置机制可以在整个环境中移植。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ke kf l"/></div></figure></div></div>    
</body>
</html>