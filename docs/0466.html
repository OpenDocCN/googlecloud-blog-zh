<html>
<head>
<title>4 pods for Rails 5 in GKE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GKE Rails 5的4个pod</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/4-pods-for-rails-5-in-gke-9f375ab4c9f7?source=collection_archive---------2-----------------------#2017-12-17">https://medium.com/google-cloud/4-pods-for-rails-5-in-gke-9f375ab4c9f7?source=collection_archive---------2-----------------------#2017-12-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="7a71" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">背景</h1><p id="85c3" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我一直很喜欢将PoC或MVP部署到Heroku的简单性。我也听到了那些在其上扩展生产应用的人对成本的抱怨。削减成本的一个措施是转向AWS或GCE这样的平台，这样公司可以通过拥有自己的虚拟基础设施来节省大量成本。<a class="ae kb" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>是一款开源工具，可以通过在一组节点或主机上编排分级应用来优化虚拟机或物理机的计算能力。我最近有机会探索如何在谷歌的<a class="ae kb" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank"> Kubernetes引擎</a>平台上部署和资助一个Rails应用。这需要一个学习曲线和对应用程序配置的最小调整，但看到垂直或水平扩展应用程序是多么容易，这很快就变得有趣了。</p><h1 id="9df4" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">入门指南</h1><p id="18aa" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">设置一个帐户并初始化一个有2个<code class="du kc kd ke kf b">n1-standard-1</code>节点的GKE集群太简单了。这样我们只有2个vCPU和7.5 GB的内存。我在谷歌云控制台的初始设置中犯了一个错误，因为我不知道在集群启动时需要配置节点以拥有某些权限——有些权限不能在以后添加(看着你，Stackdriver Monitoring)。</p><p id="8078" class="pw-post-body-paragraph jd je hi jf b jg kg ji jj jk kh jm jn jo ki jq jr js kj ju jv jw kk jy jz ka hb bi translated">我在文档页面上读过Kubernetes，所以我对基本概念很有信心:集群、部署、pod和服务等等。我的vanilla Rails 5应用程序由3个容器组成:puma HTTP应用程序、用于ActionCable的puma websocket应用程序和Sidekiq容器。我可以这样配置:1个pod包含所有3个容器，或者3个pod各包含1个容器。我决定使用3个pod，每个pod一个容器，这样我可以单独扩展服务，以免容器闲置。</p><h1 id="4702" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">云SQL + GKE</h1><p id="1052" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在配置我的部署和服务时，我犯了一个错误，那就是弄清楚如何从集群网络内部利用云SQL这样的托管数据库。<a class="ae kb" href="https://cloud.google.com/sql/docs/mysql/connect-kubernetes-engine" rel="noopener ugc nofollow" target="_blank">这篇博文</a>向我透露了sidecar方法，我尝试了几次，才在几分钟内重建了我的集群。sidecar方法背后的基本思想是在任何需要访问云SQL实例的pod内部运行一个代理容器(所有3个容器都需要这样)。现在我有3个pod，每个pod定义了2个容器，1个pod运行所有3个pod共享的主Redis实例:</p><pre class="kl km kn ko fd kp kf kq kr aw ks bi"><span id="33fd" class="kt ig hi kf b fi ku kv l kw kx">$ kubectl get pods<br/>NAME                                  READY     STATUS    RESTARTS   AGE<br/>cable-deployment-ddd7699d6-jnrbs      2/2       Running   0          16d<br/>redis-master-6767cb984b-fpx9v         1/1       Running   0          17d<br/>sidekiq-deployment-686dd47976-rtxnt   2/2       Running   0          16d<br/>web-deployment-869559b4b9-hxftm       2/2       Running   0          16d</span></pre><h1 id="7d13" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">Redis，让我们加密，和Stackdriver</h1><p id="fbc7" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">随着应用程序的扩展，我设想为每个服务添加一个专用的Redis实例。Sidekiq需要很多连接，作为持久性存储比作为缓存性能更好。另一方面，web部署确实以多种方式使用<a class="ae kb" href="https://github.com/redis-store/redis-rails" rel="noopener ugc nofollow" target="_blank"> Redis作为缓存</a>(缓存静态资产不是其中之一)。ActionCable实例使用Redis的发布/订阅功能。目前，考虑到每分钟的最小请求数，这个测试很棒。</p><p id="ab64" class="pw-post-body-paragraph jd je hi jf b jg kg ji jj jk kh jm jn jo ki jq jr js kj ju jv jw kk jy jz ka hb bi translated">让我们按照手动安装过程加密工作像一个魅力。现在所有的流量都是HTTP和WSS。我测试了Auto Scale功能，该功能允许您配置集群来根据资源使用情况管理节点。有几次，我添加并随后删除了副本集，以体验管理pod的数量是多么快速和容易。</p><figure class="kl km kn ko fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ky"><img src="../Images/a0497fd212128fd2ac4805cbb5e19358.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*14eRQ7xO29qi4PyuNmz5zQ.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">组件图和持续集成流程图</figcaption></figure><p id="78ef" class="pw-post-body-paragraph jd je hi jf b jg kg ji jj jk kh jm jn jo ki jq jr js kj ju jv jw kk jy jz ka hb bi translated">这次经历中值得一提的最后一点是免费的stackdriver监控工具。这非常令人印象深刻，因为我可以看到它取代了我通常使用的一些订阅服务，如Sentry，Papertrail。我很想试驾一下<a class="ae kb" href="https://cloud.google.com/trace/docs/setup/ruby" rel="noopener ugc nofollow" target="_blank"> Stackdriver Trace </a>，看看不花钱买NewRelic或Skylight能得到什么样的详细性能监控。不幸的是，我无法将<code class="du kc kd ke kf b">stackdriver</code> gem安装在我的容器所基于的Alpine Linux发行版上。在gem的依赖升级之前，这有点令人失望。</p><h1 id="ee0e" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">底线</h1><p id="d16d" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这种体验是值得的，但如果您推断每月1日至15日期间云SQL实例的成本为25美元，2个虚拟机的成本为35美元，网络负载平衡器流量的成本为10美元(很小，甚至为零),则成本看起来大约为每月140美元。但是，嘿，当你注册一个新账户的时候，他们会给你300美元的信用。如果你能在你的十亿美元想法实现之前承担成本，我强烈建议你尝试一下，但现在我会坚持使用Heroku，或者甚至尝试一下这个<a class="ae kb" href="https://github.com/githubsaturn/captainduckduck" rel="noopener ugc nofollow" target="_blank"> CaptainDuckDuck </a>作为我的下一个概念证明。</p></div></div>    
</body>
</html>