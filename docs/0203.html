<html>
<head>
<title>Exploring the Nuances of PCI and PCIe</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">探索PCI和PCIe的细微差别</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/exploring-the-nuances-of-pci-and-pcie-7edf44acef94?source=collection_archive---------0-----------------------#2017-02-09">https://medium.com/google-cloud/exploring-the-nuances-of-pci-and-pcie-7edf44acef94?source=collection_archive---------0-----------------------#2017-02-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="70f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在谷歌云，我们最近开始向GCP客户提供使用GPU的能力。但在我们这样做之前，我们需要100%确定这些通过PCI Express (PCIe)连接的设备不会受到威胁。这导致我们的团队探索PCIe规范及其前身PCI规范的细微差别，为构建一个软件模糊器来测试拟议的设备做准备。以下是我们发现的一些例子，重点是安全性。</p><h1 id="d846" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">然后:PCI</h1><p id="ca8b" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">如果您在90年代在计算机中安装新的声卡、网络卡或视频卡，它可能是根据旧的PCI标准构建的，该标准描述了如何通过物理线路将这些设备链接到计算机的其他部分。</p><p id="27ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PCI在当时是令人兴奋的。PCI设备比按照以前的ISA标准制造的设备更容易安装。当ISA设备插入I/O总线时，计算机可以通过总线上的匹配地址进行通信来访问它。但是很难预先知道什么设备会响应请求，设备在I/O空间中的位置，计算机是否有正确的驱动程序与ISA卡交互，或者设备是否能避免相互冲突。</p><p id="6e05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PCI通过引入“配置空间”的概念改变了这一点，配置空间是设备区域上的一组寄存器，它允许系统向卡请求有关自身的信息，并相应地做出响应。</p><p id="a121" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PCI也比它的前辈有更大的带宽，因此它很快变得无处不在。然而，随着时间的推移，PCI的局限性变得更加明显:</p><ul class=""><li id="009d" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc kl km kn ko bi translated">一组PCI设备的速度被限制为总线上最慢设备的速度。连接一个过时的外围设备会降低所有设备的速度。</li><li id="1264" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">与此同时，随着千兆位以太网的普及，对速度的需求空前高涨，而PCI设备却跟不上。</li></ul><p id="0480" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要一个新的标准。</p><h1 id="f2d6" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">现在:PCIe</h1><p id="cc8e" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">为了克服PCI的局限性，PCIe需要解决总线共享和总线争用的问题。</p><p id="a64c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当多个设备在同一个PCI总线上时，PCI被迫“减速”并与总线上最慢设备的速度相匹配。PCIe用一些电子小聪明来解决这个问题。通过使用<a class="ae ku" href="https://en.wikipedia.org/wiki/8b/10b_encoding" rel="noopener ugc nofollow" target="_blank"> 8b/10b线路代码</a>对数据进行编码，PCIe能够在一个信号中对数据和时钟信息进行编码，无需外部时钟，大大增加了潜在带宽。(<a class="ae ku" href="https://en.wikipedia.org/wiki/PCI_Express#History_and_revisions" rel="noopener ugc nofollow" target="_blank">PCIe</a>的更新版本在此基础上继续改进；PCIe 3.0及更高版本采用128b/130b编码，传输速率更快。)</p><p id="e997" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，PCIe需要一种方法来处理高速数据流。如果一个设备没有足够的缓冲来包含它想要的所有数据——比如说，高清视频——那么你自然会希望该设备持续传输数据。然而，当该设备忙于传输大量数据时，它会束缚总线，阻止所有其他设备做任何事情。PCIe通过允许<em class="kv">数据包分段</em>来解决这个问题，将数据流分解成更小的数据包，这些数据包可以通过PCIe结构下的事务层协议进行传输。</p><p id="8fb5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，更容易把PCIe想象成一个网络，而不是一条物理总线。每个设备都有一个地址，规范描述了流量控制、错误检测和重新传输的功能，这些功能在PCI中都不存在。</p><p id="2e49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于像GPU这样对性能敏感的设备来说，这都是好消息。然而，它也引入了一系列的安全问题。</p><h1 id="75a6" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">聚焦PCIe</h1><p id="a1cf" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">安全社区已经注意到，<a class="ae ku" href="http://cc.thinkst.com/talk/view/50835/" rel="noopener ugc nofollow" target="_blank">标准和规范通常以可证明的设计漏洞的形式包含容易获得的成果</a>。我们的团队花了大量的时间梳理规范，寻找要防御的边缘案例和缺口。</p><p id="a056" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在规范中一个无关紧要的部分，有一个例子是关于多播TLP的说明:</p><p id="804b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi kw translated"><span class="l kx ky kz bm la lb lc ld le di">"除了ACS源验证，ACS访问控制不适用于多播TLP(见6.14节)，对它们没有影响。"</span></p><p id="1cc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些TLP必须免于ACS控制是不直观的。幸运的是，通过将设备分配到允许相互多播的“多播组”,有一个单独的机制来保护多播TLP。然而，这需要系统设计者和管理员进行额外的规划和努力。</p><p id="13bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仔细阅读PCIe规范揭示了多个类似的边缘案例，这对确保这些设备的安全至关重要。</p><p id="3dc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">规格复杂性</strong></p><p id="3bc8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ku" href="https://members.pcisig.com/wg/PCI-SIG/document/download/8257" rel="noopener ugc nofollow" target="_blank"> PCIe规范</a>跨越了一千多页，涵盖了错误处理、数据和事务层设计、物理链路结构、几十个功能寄存器等等——这还只是规范。规范的实现可能会有所不同，并引入额外的复杂性。要了解该规范在特定器件中如何实现的细节——哪些寄存器对应于哪些PCIe设置，哪些寄存器由基址寄存器访问，等等——您必须打开该器件的手册。这些手册通常包含数百个附加页面，安全团队在测试设备时需要参考这些页面。</p><p id="5332" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">勘误表和更新</strong></p><p id="75bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PCIe现在是一个老标准。最初创建于2003年，十多年来一直在修订、更新和扩展，<a class="ae ku" href="https://pcisig.com/specifications/pciexpress?field_technology_value%5B%5D=express&amp;speclib=" rel="noopener ugc nofollow" target="_blank">最近一次更新是在2016年12月</a>。另外，<a class="ae ku" href="https://pcisig.com/sites/default/files/specification_documents/PCIe_Base_r3%201_Errata_2015-09-18_clean.pdf" rel="noopener ugc nofollow" target="_blank">每个版本都有大量的勘误表</a>。从安全的角度来看，这些更改中的大部分是无害的，但是检查将漏洞作为其他更改的意外后果引入的修订仍然很重要。</p><p id="2e7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">网络架构</strong></p><p id="a865" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PCIe像一个网络一样运行，以TLP(事务层数据包)和DLLPs(数据链路层数据包)的形式完成自己的协议。这种方法有一些安全好处。如果PCIe设备使用传统的硬件总线，就没有有效的方法来处理不可信的设备——没有办法知道数据访问来自哪里。相比之下，网络体系结构允许我们查看每个数据包的源ID和目的ID，并允许我们在每个交换机上管理是否希望数据包继续前进到目的地。这提供了一种降低恶意设备行为风险的机制。但是，这也导致了额外的复杂性，必须小心管理以限制安全风险。</p><p id="d5f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">有限集成安全性</strong></p><p id="a5b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PCIe有一套被称为访问控制服务(ACS)的功能，这个名称表明它可能为保护PCIe设备提供一个方便、明确的解决方案。然而，PCIe工作组并没有一套正式的指导原则，来说明在云中安全运行设备需要ACS设置的哪些子集。此外，查看最初的ACS提案，我们会发现设备安全性只是ACS目的的一部分。所描述的一些项目是面向安全的，例如下游组件之间请求的权限验证，但其他项目则侧重于优雅地处理损坏或故障设备，例如减轻数据包损坏的影响。发生故障的设备会造成伤害；然而，恶意设备也是一个严重的问题。我们着重于探索ACS作为防范有动机的攻击者的安全措施的功效。</p><p id="c388" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以此为背景，我们开始建造我们的fuzzer。有关我们如何做到这一点的更多信息，请查看谷歌云平台博客上的<a class="ae ku" href="https://cloudplatform.googleblog.com/2017/02/fuzzing-PCI-Express-security-in-plaintext.html" rel="noopener ugc nofollow" target="_blank">“模糊PCI Express:明文安全”</a>。</p></div></div>    
</body>
</html>