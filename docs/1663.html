<html>
<head>
<title>BigQuery Authorised View verification workflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery授权视图验证工作流</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bigquery-authorised-view-verification-workflow-75c334cccde1?source=collection_archive---------0-----------------------#2020-11-15">https://medium.com/google-cloud/bigquery-authorised-view-verification-workflow-75c334cccde1?source=collection_archive---------0-----------------------#2020-11-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/1f3064b5874cdb5434e132067f1229f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KRBAcxovuHuaIpEr"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">保罗·斯科鲁普斯卡斯在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="3333" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"><em class="jt">TL；DR:在BigQuery数据集中验证您的视图，以确保授权的视图能够工作而不会中断您的ETL。</em> </strong></p><p id="ffe1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">客户希望验证BigQuery数据仓库(DW)上的所有视图，以评估是否所有视图都根据DW内部或外部的现有数据集进行了授权。</p><p id="9856" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">BigQuery API还没有为此实现一个方法，所以我们选择使用BigQuery对象开发一个Python解决方案，收集项目、数据集、表级别的信息。</p><h2 id="9d9e" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated"><strong class="ak"> <em class="kp">用例1(添加到DW中的新数据集):</em> </strong></h2><blockquote class="kq kr ks"><p id="9016" class="iv iw jt ix b iy iz ja jb jc jd je jf kt jh ji jj ku jl jm jn kv jp jq jr js hb bi translated">一个新的数据集被添加到DW中。</p><p id="f484" class="iv iw jt ix b iy iz ja jb jc jd je jf kt jh ji jj ku jl jm jn kv jp jq jr js hb bi translated">启动一个流程，收集所需的信息。</p><p id="d44e" class="iv iw jt ix b iy iz ja jb jc jd je jf kt jh ji jj ku jl jm jn kv jp jq jr js hb bi translated">查看数据集，寻找视图。</p><p id="3826" class="iv iw jt ix b iy iz ja jb jc jd je jf kt jh ji jj ku jl jm jn kv jp jq jr js hb bi translated">查看每个视图，并收集SQL代码。</p><p id="df42" class="iv iw jt ix b iy iz ja jb jc jd je jf kt jh ji jj ku jl jm jn kv jp jq jr js hb bi translated">从SQL获取外部数据源。</p><p id="eeaa" class="iv iw jt ix b iy iz ja jb jc jd je jf kt jh ji jj ku jl jm jn kv jp jq jr js hb bi translated">获取现任数据集，并验证该视图已针对该数据集获得授权。</p><p id="90e6" class="iv iw jt ix b iy iz ja jb jc jd je jf kt jh ji jj ku jl jm jn kv jp jq jr js hb bi translated">否则，向源数据集和目标数据集的所有者发送通知(电子邮件、空闲时间等)，以便他们采取措施。</p><p id="27fc" class="iv iw jt ix b iy iz ja jb jc jd je jf kt jh ji jj ku jl jm jn kv jp jq jr js hb bi translated">数据集被验证为授权的，并被添加到目录系统中。</p></blockquote><h2 id="7959" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated"><strong class="ak">用例2(定期检查现有数据集，寻找变化):</strong></h2><blockquote class="kq kr ks"><p id="5e62" class="iv iw jt ix b iy iz ja jb jc jd je jf kt jh ji jj ku jl jm jn kv jp jq jr js hb bi translated">用例1的重复验证。</p><p id="0f66" class="iv iw jt ix b iy iz ja jb jc jd je jf kt jh ji jj ku jl jm jn kv jp jq jr js hb bi translated">每隔(天、周……)对数据仓库上的所有数据集和视图启动一次批量验证。</p><p id="e2ee" class="iv iw jt ix b iy iz ja jb jc jd je jf kt jh ji jj ku jl jm jn kv jp jq jr js hb bi translated">创建一个报告，抛出异常，并向数据集所有者发送单独的通知。</p></blockquote><h2 id="e5d2" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated"><strong class="ak"> <em class="kp">解决方案:</em> </strong></h2><p id="0116" class="pw-post-body-paragraph iv iw hi ix b iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated"><strong class="ix hj">步骤1 —在给定项目上列出所有数据集。</strong>这一步将收集给定项目的所有数据集。<em class="jt"> Project = client.project </em>(包含当前项目)。</p><figure class="lb lc ld le fd ij"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="1929" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行该代码，输出将如下所示:</p><pre class="lb lc ld le fd lh li lj lk aw ll bi"><span id="0e60" class="ju jv hi li b fi lm ln l lo lp">Datasets in project bq-sme:</span><span id="2795" class="ju jv hi li b fi lq ln l lo lp">dataset1</span><span id="16a5" class="ju jv hi li b fi lq ln l lo lp">dataset2</span></pre><p id="1030" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">参考资料:</p><p id="81b5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://cloud.google.com/bigquery/docs/listing-datasets#python" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/listing-datasets # python</a></p><p id="5e1b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://cloud.google.com/bigquery/docs/reference/rest/v2/datasets/list" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/reference/rest/v2/datasets/list</a></p><p id="96d9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">收集数据集列表将使我们进入下一步。</p><p id="9a5c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">步骤2——在给定的数据集上，列出所有视图。</strong>这一步将收集给定数据集的所有视图。</p><figure class="lb lc ld le fd ij"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="b871" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行该代码，输出将如下所示:</p><pre class="lb lc ld le fd lh li lj lk aw ll bi"><span id="c8dc" class="ju jv hi li b fi lm ln l lo lp">Got dataset 'bq-sme.dataset1' with friendly_name 'None'.</span><span id="b676" class="ju jv hi li b fi lq ln l lo lp">Description: sample dataset 1</span><span id="6720" class="ju jv hi li b fi lq ln l lo lp">Labels:</span><span id="de0b" class="ju jv hi li b fi lq ln l lo lp">type: sample</span><span id="a04b" class="ju jv hi li b fi lq ln l lo lp">Tables:</span><span id="4c5e" class="ju jv hi li b fi lq ln l lo lp">Table1 - TABLE</span><span id="0f20" class="ju jv hi li b fi lq ln l lo lp">View1 - VIEW</span><span id="49d7" class="ju jv hi li b fi lq ln l lo lp">View2 - VIEW</span></pre><p id="5fd1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">参考资料:</p><p id="f240" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://cloud.google.com/bigquery/docs/dataset-metadata#python" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/dataset-metadata # python</a></p><p id="a9c7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://cloud.google.com/bigquery/docs/reference/rest/v2/tables/list" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/reference/rest/v2/tables/list</a></p><p id="1732" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该示例代码将检索所有的表，因此您只能获得该示例的类型视图。</p><p id="1a88" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">步骤3——获取视图元数据，收集视图的SQL定义。</strong>这一步将收集给定视图的元数据，检索相应的SQL元数据。</p><p id="9583" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">元数据将告诉我们在这个视图中是否使用了外部数据集。</p><figure class="lb lc ld le fd ij"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="4895" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行该代码，输出将如下所示:</p><pre class="lb lc ld le fd lh li lj lk aw ll bi"><span id="0775" class="ju jv hi li b fi lm ln l lo lp">View at bq-sme:dataset1.View1</span><span id="2d38" class="ju jv hi li b fi lq ln l lo lp">View Query:</span><span id="9517" class="ju jv hi li b fi lq ln l lo lp">SELECT station_id FROM `bq-sme.dataset2.ny_citibike`</span></pre><p id="ec2d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">参考资料:</p><p id="ea3d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://cloud.google.com/bigquery/docs/view-metadata#python" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/bigquery/docs/view-metadata#python</a></p><p id="10bf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://cloud.google.com/bigquery/docs/reference/rest/v2/tables/get" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/reference/rest/v2/tables/get</a></p><p id="6c1d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如我们所看到的，数据集上有一个视图(表类型视图)，指向另一个数据集，因此这是一个需要授权的视图的示例。</p><p id="5cf8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">步骤4——验证一个数据集是否包含另一个数据集中视图的授权。</strong>获取数据集元数据，查看访问属性并验证给定视图是否在授权视图列表中。</p><figure class="lb lc ld le fd ij"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="c012" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行该代码，输出将如下所示:</p><pre class="lb lc ld le fd lh li lj lk aw ll bi"><span id="30e6" class="ju jv hi li b fi lm ln l lo lp">Got dataset 'bq-sme.dataset2' with friendly_name 'None'.</span><span id="d431" class="ju jv hi li b fi lq ln l lo lp">Description: sample dataset 2</span><span id="a569" class="ju jv hi li b fi lq ln l lo lp">Labels:</span><span id="a572" class="ju jv hi li b fi lq ln l lo lp">type: sample</span><span id="6c13" class="ju jv hi li b fi lq ln l lo lp">Access:</span><span id="157f" class="ju jv hi li b fi lq ln l lo lp">[&lt;AccessEntry: role=WRITER, specialGroup=projectWriters&gt;, &lt;AccessEntry: role=OWNER, specialGroup=projectOwners&gt;, &lt;AccessEntry: role=OWNER, userByEmail=email@domain.com&gt;, &lt;AccessEntry: role=READER, specialGroup=projectReaders&gt;, &lt;AccessEntry: role=None, view={u'projectId': u'bq-sme', u'tableId': u'View1', u'datasetId': u'dataset1'}&gt;]</span></pre><p id="5726" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">参考资料:</p><p id="57ad" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://cloud.google.com/bigquery/docs/dataset-metadata#python" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/dataset-metadata # python</a></p><p id="868f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://cloud.google.com/bigquery/docs/reference/rest/v2/datasets/get" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/reference/rest/v2/datasets/get</a></p><p id="111c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://cloud.google.com/bigquery/docs/reference/rest/v2/datasets#Dataset" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/reference/rest/v2/datasets # Dataset</a></p><p id="7271" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有了这个响应，您就可以从原始数据集获取一个视图，并结束这个循环。</p><p id="6814" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果没有找到授权，您可以向数据集所有者发送通知，以便解决问题。</p><h2 id="1943" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">可扩展性:</h2><ul class=""><li id="e772" class="lr ls hi ix b iy kw jc kx jg lt jk lu jo lv js lw lx ly lz bi translated">将代码部署在作为谷歌应用引擎(GAE)的可扩展任务管理器上，将对给定的数据集或视图进行原子请求，并且可以管理请求的吞吐量，并管理潜在的100或1000个数据集和视图。</li><li id="0ade" class="lr ls hi ix b iy ma jc mb jg mc jk md jo me js lw lx ly lz bi translated">此外，云功能或GKE或云运行，可以以自动化的方式为BigQuery上的任何新视图执行此过程，并为当天验证运行夜间运行。</li></ul><h2 id="af81" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">进化:</h2><p id="6645" class="pw-post-body-paragraph iv iw hi ix b iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">本文中描述的过程可以扩展到Bigquery上的表ACL，并且有可能验证给定的表是否与现任组或用户共享。</p></div></div>    
</body>
</html>