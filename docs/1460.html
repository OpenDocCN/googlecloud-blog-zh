<html>
<head>
<title>Packer and ShieldedVM support</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">封隔器和屏蔽dVM支架</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/packer-and-shieldedvm-support-7573fbe65e30?source=collection_archive---------2-----------------------#2020-06-05">https://medium.com/google-cloud/packer-and-shieldedvm-support-7573fbe65e30?source=collection_archive---------2-----------------------#2020-06-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8dc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/shielded-vm/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> <em class="je">屏蔽的虚拟机</em> </strong> </a>是来自谷歌云平台(<em class="je"> gcp </em>)的一个很棒的工具，它允许您拥有定制的映像，经过预先批准、烘焙和屏蔽(不可修改)，随时可以在谷歌计算引擎(<em class="je"> gce </em>)中进行配置。</p><p id="f07e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="je">屏蔽的虚拟机</em> </strong>在与<strong class="ih hj"> <em class="je">约束/compute . requireshieldevm</em></strong>约束(来自<a class="ae jd" href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints" rel="noopener ugc nofollow" target="_blank">组织策略</a>)结合使用时效果极佳。</p><p id="ad0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一方面，<strong class="ih hj"> <em class="je"> Packer </em> </strong>是处理和管理跨不同云提供商的定制映像的创建和维护的绝佳工具。</p><p id="0f48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了烘焙出新的形象<strong class="ih hj"> <em class="je">张风</em> </strong>有各种各样的<a class="ae jd" href="https://www.packer.io/docs/builders/index.html" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"><em class="je"/></strong></a>。构建者的目标是在选择的云(<strong class="ih hj"> <em class="je"> gce </em> </strong>)内部署和供应虚拟机。调配虚拟机后，构建器还负责根据之前配置的磁盘创建新映像。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/861fd29e1b4402e718528a8de1431ef9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5xMUbOn45pnI6tZwaB7FdQ.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">包装机架构和工作流程</figcaption></figure><p id="68c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<strong class="ih hj"><em class="je">【GCP】</em></strong>中使用<strong class="ih hj"> <em class="je"> Packer </em> </strong>作为提供和管理映像的工具的缺点是它不具备与<strong class="ih hj"> <em class="je">屏蔽的虚拟机</em> </strong>接口的能力。换句话说，<a class="ae jd" href="https://www.packer.io/docs/builders/googlecompute.html" rel="noopener ugc nofollow" target="_blank"> googlecompute </a>构建器缺乏基于<strong class="ih hj"> <em class="je">屏蔽虚拟机</em> </strong>创建屏蔽映像的能力。</p><p id="546e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了克服这个障碍，我在<strong class="ih hj"> <em class="je"> Packer的</em> </strong> <a class="ae jd" href="https://github.com/hashicorp/packer" rel="noopener ugc nofollow" target="_blank">源代码</a>上做了一点小调整。</p><p id="c1e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，必须了解<strong class="ih hj"> <em class="je"> Packer </em> </strong>的内部架构以及它的局限性。</p><p id="e325" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="je"> Packer </em> </strong>依赖于go和官方同行提供的现有云库(在我们这里是google项目)。</p><p id="a3e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">经过仔细考虑，我发现谷歌已经提供了(在其go库级别)对<strong class="ih hj"> <em class="je">屏蔽虚拟机</em> </strong>的支持。因此，剩下唯一要做的就是在<strong class="ih hj"> <em class="je">封隔器</em> </strong>层启用它们。</p><p id="2645" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，您可能需要查看位于<a class="ae jd" href="https://github.com/hashicorp/packer/blob/master/builder/googlecompute/driver_gce.go" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"><em class="je">packer/builder/Google compute/driver _ GCE . go</em></strong></a>的<strong class="ih hj"><em class="je">GCP</em></strong>provisioner文件。</p><p id="a276" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你仔细观察，你会发现对于<strong class="ih hj"> <em class="je">屏蔽虚拟机</em> </strong>没有配置块。同样，要启用它，需要添加以下配置块:</p><pre class="jg jh ji jj fd jv jw jx jy aw jz bi"><span id="93d0" class="ka kb hi jw b fi kc kd l ke kf">ShieldedInstanceConfig: &amp;compute.ShieldedInstanceConfig{<br/>   EnableSecureBoot: true,<br/>   EnableVtpm: true,<br/>   EnableIntegrityMonitoring: true,<br/>}</span></pre><p id="56f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我知道这可以通过添加变量而不是硬编码来修饰。但是你要记住，这样做是为了验证使用<strong class="ih hj"> <em class="je"> Packer </em> </strong>作为<strong class="ih hj"> <em class="je">屏蔽虚拟机</em> </strong>在<strong class="ih hj"><em class="je">【GCP】</em></strong>内的管理工具的可行性。</p><p id="0a3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将把diff留给您，这样您就可以继续修补您的<strong class="ih hj"> <em class="je">打包器</em> </strong>代码副本，构建它并使用它在<strong class="ih hj"> <em class="je"> gce </em> </strong>中提供定制的<strong class="ih hj"> <em class="je">屏蔽虚拟机</em> </strong>映像。</p><pre class="jg jh ji jj fd jv jw jx jy aw jz bi"><span id="05e3" class="ka kb hi jw b fi kc kd l ke kf">diff --git a/builder/googlecompute/driver_gce.go b/builder/googlecompute/driver_gce.go<br/>index f2adaa591..82761d129 100644<br/>--- a/builder/googlecompute/driver_gce.go<br/>+++ b/builder/googlecompute/driver_gce.go<br/>@@ -420,6 +420,11 @@ func (d *driverGCE) RunInstance(c *InstanceConfig) (&lt;-chan error, error) {<br/>   Tags: &amp;compute.Tags{<br/>    Items: c.Tags,<br/>   },<br/>+  ShieldedInstanceConfig: &amp;compute.ShieldedInstanceConfig{<br/>+   EnableSecureBoot: true,<br/>+   EnableVtpm: true,<br/>+   EnableIntegrityMonitoring: true,<br/>+  },<br/>  }</span><span id="c88d" class="ka kb hi jw b fi kg kd l ke kf">d.ui.Message("Requesting instance creation...")</span></pre><p id="0d4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了完成这个壮举，你可能想参考一下<strong class="ih hj"> <em class="je"> Packer的</em> </strong>官方文档，了解如何<a class="ae jd" href="https://github.com/hashicorp/packer/blob/master/.github/CONTRIBUTING.md" rel="noopener ugc nofollow" target="_blank">构建和贡献</a>这个项目。</p></div></div>    
</body>
</html>