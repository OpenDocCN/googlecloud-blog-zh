<html>
<head>
<title>Stop Worrying About BigQuery PII: How to Automate Data Governance at Scale.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不要再担心BigQuery PII:如何大规模自动化数据治理。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/stop-worrying-about-bigquery-pii-how-to-automate-data-governance-at-scale-81abb3e47e0c?source=collection_archive---------0-----------------------#2022-05-09">https://medium.com/google-cloud/stop-worrying-about-bigquery-pii-how-to-automate-data-governance-at-scale-81abb3e47e0c?source=collection_archive---------0-----------------------#2022-05-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="a9cd" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">BigQuery的PII发现、分类和访问控制</h2></div><blockquote class="ix iy iz"><p id="872c" class="ja jb jc jd b je jf ij jg jh ji im jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated"><strong class="jd hj"> TL:DR </strong>毫无疑问，管理和保护PII数据是许多组织的头等大事，尤其是不遵守PII法案可能会给企业带来严重的物质和非物质损失。如果没有管理PII的自动化框架，这一敏感流程可能是手动的、不可扩展的，或者会带来更大的失败风险(例如，创建数据集的PII和非PII拷贝)</p><p id="dc0f" class="ja jb jc jd b je jf ij jg jh ji im jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">为了解决这个问题，我们引入了一个<a class="ae jx" href="https://github.com/GoogleCloudPlatform/bq-pii-classifier" rel="noopener ugc nofollow" target="_blank">开源解决方案</a>，根据您组织的敏感级别层次结构，自动发现、分类和限制对BigQuery中PII数据字段的访问。</p></blockquote><p id="8c37" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">许多组织正在将他们的数据迁移到BigQuery(或者已经这样做了)，并着手解决如何“处理”他们的个人身份信息的问题(<strong class="jd hj"> PII </strong>)。根据组织的业务需求、法规遵从性要求或成熟度，术语“处理”可能指不同的主题，例如常见的任务可能是:</p><ul class=""><li id="df5a" class="kb kc hi jd b je jf jh ji jy kd jz ke ka kf jw kg kh ki kj bi translated"><strong class="jd hj">发现</strong>哪些列和表包含PII。</li><li id="6bde" class="kb kc hi jd b je kk jh kl jy km jz kn ka ko jw kg kh ki kj bi translated"><strong class="jd hj">根据等级对</strong> PII类型进行分类(例如，高灵敏度、低灵敏度等)</li><li id="3043" class="kb kc hi jd b je kk jh kl jy km jz kn ka ko jw kg kh ki kj bi translated"><strong class="jd hj">将元数据标签</strong>添加到基于PII类型/类的列中，作为对数据进行编目的一种方式</li><li id="20ba" class="kb kc hi jd b je kk jh kl jy km jz kn ka ko jw kg kh ki kj bi translated">管理<strong class="jd hj">谁可以在你的项目中读取哪个PII </strong>类型/类(对于用户和服务帐户)</li></ul><p id="a024" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">虽然处理PII数据有更多的层次和方向(例如加密、匿名化、去标识化等)，但在本文中，<strong class="jd hj">我们将重点关注上面列出的步骤，作为在不创建数据副本<strong class="jd hj">的情况下就地管理和保护PII数据</strong>的最低要求。</strong>对于<strong class="jd hj">，</strong>我们假设您已经将数据加载到BigQuery中，数据为原始格式(无屏蔽)，并且可能会暴露PII(例如着陆区)。听起来很熟悉？继续读！</p><p id="ca8d" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">在接下来的章节中，我们将介绍每一个步骤以及实现这些步骤的GCP产品和功能。最后，我们将讨论<a class="ae jx" href="https://github.com/GoogleCloudPlatform/bq-pii-classifier" rel="noopener ugc nofollow" target="_blank"> <strong class="jd hj"> BQ PII分类器</strong> </a>开源解决方案来自动化整个过程。</p><div class="kp kq ez fb kr ks"><a href="https://github.com/GoogleCloudPlatform/bq-pii-classifier" rel="noopener  ugc nofollow" target="_blank"><div class="kt ab dw"><div class="ku ab kv cl cj kw"><h2 class="bd hj fi z dy kx ea eb ky ed ef hh bi translated">GitHub-Google cloud platform/bq-pii-分类器:</h2><div class="kz l"><h3 class="bd b fi z dy kx ea eb ky ed ef dx translated">跨BigQuery表自动发现和标记PII数据，并基于以下内容应用列级访问控制</h3></div><div class="la l"><p class="bd b fp z dy kx ea eb ky ed ef dx translated">github.com</p></div></div><div class="lb l"><div class="lc l ld le lf lb lg lh ks"/></div></div></a></div></div><div class="ab cl li lj gp lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hb hc hd he hf"><h1 id="16d5" class="lp lq hi bd lr ls lt lu lv lw lx ly lz io ma ip mb ir mc is md iu me iv mf mg bi translated">第一步:发现PII</h1><p id="2f15" class="pw-post-body-paragraph ja jb hi jd b je mh ij jg jh mi im jj jy mj jm jn jz mk jq jr ka ml ju jv jw hb bi translated">“如何发现GCP的PII数据？”的简短回答通常是<a class="ae jx" href="https://cloud.google.com/dlp" rel="noopener ugc nofollow" target="_blank">防数据丢失API ( <em class="jc"> DLP </em> ) </a>。这是原生的GCP产品，您可以简单地从云控制台(UI)使用它来创建一个“<a class="ae jx" href="https://cloud.google.com/dlp/docs/creating-job-triggers" rel="noopener ugc nofollow" target="_blank"> <em class="jc">检查作业</em> </a>”，该作业基于一个<em class="jc">“检查模板”</em>(列出某些现成的或定制的PII<em class="jc"/><a class="ae jx" href="https://cloud.google.com/dlp/docs/concepts-infotypes" rel="noopener ugc nofollow" target="_blank"><em class="jc">信息类型</em></a><em class="jc"/>)扫描一个数据资源(例如BigQuery表)并报告<em class="jc">结果</em></p><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es mm"><img src="../Images/d9cf527227c5b0747568656ffe3c9a93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6F3ndR-YIIZT8ZXi7d3PKA.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">样品检验模板</figcaption></figure><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es nb"><img src="../Images/a12b614856a8581318e43df4f26ee1bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*970BgH5mI8p0fOLSbZj4EQ.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">BigQuery表的示例检查作业</figcaption></figure><p id="2389" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">对我们来说最相关的"<em class="jc">操作</em>将是<a class="ae jx" href="https://cloud.google.com/dlp/docs/querying-findings" rel="noopener ugc nofollow" target="_blank"> <strong class="jd hj">将调查结果保存到BigQuery </strong> </a> <strong class="jd hj"> </strong>以导出最细粒度的工作调查结果。一个“<em class="jc">发现</em>”详述了某一行和列中的一个PII检测以及匹配的可能性。请注意，我们可能会在同一列中检测到多个具有不同匹配可能性的PII类型，例如，以“215 Nelson Mandela Street”作为customer_address列的数据行可能会生成两个结果；{ <em class="jc"> InfoType: STREET_ADDRESS，likelity:VERY _ LIKELY }</em>和<em class="jc"> {InfoType: PERSON_NAME，likelity:LIKELY }</em>。然而，如果需要的话，我们可以通过“<a class="ae jx" href="https://cloud.google.com/dlp/docs/creating-custom-infotypes-rules" rel="noopener ugc nofollow" target="_blank">规则集</a>”来控制这样的行为</p><p id="0f2f" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">我们如何使用这个特性来实现自动检测BigQuery表中的PII的目标呢？</p><ul class=""><li id="dc62" class="kb kc hi jd b je jf jh ji jy kd jz ke ka kf jw kg kh ki kj bi translated">定义和定制我们要搜索的PII信息类型，并将其列在<em class="jc">检验模板</em>中</li><li id="197d" class="kb kc hi jd b je kk jh kl jy km jz kn ka ko jw kg kh ki kj bi translated">拥有一个应用层，它通过<a class="ae jx" href="https://cloud.google.com/dlp/docs/apis" rel="noopener ugc nofollow" target="_blank"> DLP客户端库和API </a>中的一个以编程方式为每个表创建一个<em class="jc">检查作业</em>(我们将在本文的后面讨论一个本机特性Auto DLP，以及如何使用它来实现我们的目标)</li><li id="9934" class="kb kc hi jd b je kk jh kl jy km jz kn ka ko jw kg kh ki kj bi translated">配置<em class="jc">检查作业</em>将结果存储在BigQuery表中，以便在后续步骤中进一步处理</li></ul></div><div class="ab cl li lj gp lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hb hc hd he hf"><h1 id="3ee7" class="lp lq hi bd lr ls lt lu lv lw lx ly lz io ma ip mb ir mc is md iu me iv mf mg bi translated">步骤2:定义PII分类层次结构</h1><p id="e18c" class="pw-post-body-paragraph ja jb hi jd b je mh ij jg jh mi im jj jy mj jm jn jz mk jq jr ka ml ju jv jw hb bi translated">PII分类层级的一个简单而常见的例子可以是敏感度等级(例如高、中、低)，其中每个PII类型(即DLP <em class="jc">信息类型</em>)属于一个分类。对PII类型进行分类的原因可能各不相同，但通常是为了数据治理向用户/组授予一定级别的安全许可。</p><p id="d0ec" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">GCP通过<a class="ae jx" href="https://cloud.google.com/bigquery/docs/best-practices-policy-tags" rel="noopener ugc nofollow" target="_blank"> <strong class="jd hj"> <em class="jc">数据目录和策略标签分类法</em> </strong> </a> <strong class="jd hj"> <em class="jc">完全涵盖了这个用例。</em></strong>“<em class="jc">策略标签分类法”</em>是一种资源，用户在数据目录中将其定义为对业务有意义的任意用户定义的节点层次结构。该层次结构中的每个父节点或叶节点可以用作“<em class="jc">策略标记”</em>，该标记可以链接到BigQuery列(即，用策略标记来标记列)。策略标记有两个主要用途:</p><ul class=""><li id="5630" class="kb kc hi jd b je jf jh ji jy kd jz ke ka kf jw kg kh ki kj bi translated">1)充当可在数据目录中<a class="ae jx" href="https://cloud.google.com/data-catalog/docs/how-to/search-reference#qualified_predicates" rel="noopener ugc nofollow" target="_blank">发现的</a>元数据字段(例如，搜索所有列标有“高敏感度”策略标签的表)</li><li id="2118" class="kb kc hi jd b je kk jh kl jy km jz kn ka ko jw kg kh ki kj bi translated">2)在BigQuery 中启用<a class="ae jx" href="https://cloud.google.com/bigquery/docs/column-level-security-intro" rel="noopener ugc nofollow" target="_blank">列级访问控制。这样，我们定义了一次访问控制(在策略标记上)，并通过标记将其应用于BigQuery中的多个列。</a></li></ul><p id="3f82" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">总之，为了定义PII分类层次结构，我们只需在数据目录中创建一个<em class="jc">策略标签分类</em>，其中包括我们已经在DLP检查模板中定义的所有PII <em class="jc">信息类型</em>的节点</p><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es nc"><img src="../Images/216e76edc815d74a5c668ece8b0037c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0GLKzmpXnZbbBhXem9RQnw.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">PII的策略标签分类示例</figcaption></figure></div><div class="ab cl li lj gp lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hb hc hd he hf"><h1 id="1e9a" class="lp lq hi bd lr ls lt lu lv lw lx ly lz io ma ip mb ir mc is md iu me iv mf mg bi translated">步骤3:标记BigQuery PII列</h1><p id="d83f" class="pw-post-body-paragraph ja jb hi jd b je mh ij jg jh mi im jj jy mj jm jn jz mk jq jr ka ml ju jv jw hb bi translated">手动列标记是从云控制台(UI)直接进行的。我们需要编辑表的模式，选择列，并从分类法中选择策略标记。</p><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es nd"><img src="../Images/f575919219f048c4929d4b8e4b753bbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*21m1x2K050W13sm03Hz28g.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">BigQuery列标记(控制台)</figcaption></figure><p id="0b1e" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">但是，我们希望多次重复这个过程，以覆盖所有表中的所有PII列。更不用说，做标记的人可能不知道一个列是否包含PII。</p><p id="0663" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">还记得DLP <em class="jc">检验岗位</em>吗？我们将它配置为将详细的结果保存到BigQuery？现在我们需要根据这些发现采取行动。</p><p id="241f" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">对于我们想要标记其列的每个表，我们可以执行以下操作:</p><ul class=""><li id="c7e0" class="kb kc hi jd b je jf jh ji jy kd jz ke ka kf jw kg kh ki kj bi translated">从详细的结果BigQuery表中读取DLP结果</li><li id="030e" class="kb kc hi jd b je kk jh kl jy km jz kn ka ko jw kg kh ki kj bi translated">对于每个表列；查找DLP检测到的信息类型。如果DLP为该列找到多种信息类型，我们会提升其中一种(考虑到发现的数量和可能性，或者通过报告特殊占位符“混合”)</li><li id="ad54" class="kb kc hi jd b je kk jh kl jy km jz kn ka ko jw kg kh ki kj bi translated">在数据目录分类法中查找该信息类型，并返回对应于该信息类型策略标记ID</li><li id="0340" class="kb kc hi jd b je kk jh kl jy km jz kn ka ko jw kg kh ki kj bi translated">将策略标记ID应用于BigQuery列</li></ul></div><div class="ab cl li lj gp lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hb hc hd he hf"><h1 id="8b7f" class="lp lq hi bd lr ls lt lu lv lw lx ly lz io ma ip mb ir mc is md iu me iv mf mg bi translated">步骤4:管理对PII的访问控制</h1><p id="a1df" class="pw-post-body-paragraph ja jb hi jd b je mh ij jg jh mi im jj jy mj jm jn jz mk jq jr ka ml ju jv jw hb bi translated">现在，我们结束了一个设置，其中BigQuery中的某些列由数据目录中的层次结构/分类中定义的策略标记来标记。我们需要做的就是转到策略标签分类法，将“<a class="ae jx" href="https://cloud.google.com/iam/docs/understanding-roles#data-catalog-roles" rel="noopener ugc nofollow" target="_blank"> <em class="jc">”细粒度读者角色</em></a><em class="jc">”</em>分配给用户和组。这种分配可以在层次结构的任何级别上。例如，在“Email”标记(叶节点)上分配<em class="jc"> user1@ </em>的细粒度读者角色意味着<em class="jc"> user1 </em>将有权访问用这个精确的策略标记标记的列。或者，在“中等敏感度”标记(父节点)上为他们分配相同的角色，这意味着他们可以访问标记有该父节点下任何叶节点的列(即电子邮件和电话号码)。</p><p id="c740" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">为了遵循IAM最佳实践，我们建议使用组而不是用户来执行此步骤。例如，有3个组来管理对PII的访问[<em class="jc">pii-高敏感度读者@ </em>、<em class="jc">pii-中等敏感度读者@ </em>、<em class="jc">pii-低敏感度读者@ </em> ]，每个组都被授予相应分类级别的细粒度读者角色。在这种情况下，当我们想要将新用户或服务帐户添加到任何级别时，只需将他们添加到所需的组中即可。</p><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es ne"><img src="../Images/a096f028f324041e6bd1ba62cfdc8213.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dtFbhr8Lhmt3gz5eNA95Ag.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">授予对标记PII字段的访问权限</figcaption></figure><p id="47a7" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">让我们以一个假设的表“<em class="jc">订单</em>为例。此表包含我们应用策略标签的PII列[客户电子邮件、客户地址]和其他非PII列[项目、订单日期、价格等]。用户访问该表需要两层IAM:</p><ul class=""><li id="22b8" class="kb kc hi jd b je jf jh ji jy kd jz ke ka kf jw kg kh ki kj bi translated">表、数据集或项目级别的标准<em class="jc"> BigQuery数据查看器</em>角色。这将授予对表的访问权，以读取不受策略标记限制的所有列。</li><li id="7f45" class="kb kc hi jd b je kk jh kl jy km jz kn ka ko jw kg kh ki kj bi translated">额外的<em class="jc">数据目录</em> <em class="jc">细粒度读者角色</em>授予对带标签的PII列的访问权限。</li></ul><p id="caaa" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">这里值得一提的是一个方便的特性，它是一个对给定分类的“<a class="ae jx" href="https://cloud.google.com/bigquery/docs/column-level-security" rel="noopener ugc nofollow" target="_blank"> <em class="jc">强制访问控制</em></a><em class="jc"/>的开关。当此开关关闭时，我们可以试验列标记，而不会影响用户对标记列的访问。</p><p id="1862" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">不言而喻，本节中解释的IAM绑定也可以通过编程来完成，我们将在下一节中看到，我们试图将所有这些步骤一起自动化</p></div><div class="ab cl li lj gp lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hb hc hd he hf"><h1 id="dd4c" class="lp lq hi bd lr ls lt lu lv lw lx ly lz io ma ip mb ir mc is md iu me iv mf mg bi translated">全部自动化</h1><p id="729f" class="pw-post-body-paragraph ja jb hi jd b je mh ij jg jh mi im jj jy mj jm jn jz mk jq jr ka ml ju jv jw hb bi translated">现在，我们已经理解了在BigQuery上实现管理PII的目标的每一步背后的GCP概念(即PII发现、分类、标记和访问控制)，是时候将所有东西<em class="jc">【glue】</em>在一起，将其应用到N个大规模的表中了。为此，我们开发了<a class="ae jx" href="https://github.com/GoogleCloudPlatform/bq-pii-classifier" rel="noopener ugc nofollow" target="_blank"> <strong class="jd hj"> BQ PII分类器</strong> </a>开源解决方案。</p><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es nf"><img src="../Images/8e0c5f050e3c8521ba3a7670f9bf81ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CWplYjUTKPDFQ-407DoIJw.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">BQ PII分类器解决方案步骤</figcaption></figure><p id="1596" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated"><strong class="jd hj">架构概述</strong></p><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es ng"><img src="../Images/53542643f69947050d8f429c3552cb90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IDVd_drDa-Zp5yl4pPNpbg.jpeg"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">BQ PII分类器解决方案架构(标准模式)</figcaption></figure><p id="ebbb" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated"><em class="jc">检查调度服务</em> <br/>云运行服务，充当解决方案的入口点。它期望大查询扫描范围表示为项目、数据集和表的包含和排除列表。该范围可以是一个或多个表。</p><p id="8540" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">检查调度程序将调用BigQuery API来列出扫描范围中包含的所有表，并在Inspector Tasks主题中提交该表的DLP检查请求。</p><p id="2871" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated"><em class="jc">检查员任务主题</em> <br/>该发布主题将检查调度程序与检查员分离，以处理DLP API的速率限制，并应用带补偿的自动重试。</p><p id="aa95" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated"><em class="jc"> Inspector Service </em> <br/>一种云运行服务，期望请求扫描一个表。它将根据配置的检查模板和其他参数(如扫描限制、结果表、通知主题等)向DLP提交该表的检查作业。</p><p id="cdcc" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">为了控制成本，该服务将根据表格大小和用户定义的配置来限制要扫描的行数，该配置确定了限制间隔(例如，0–1000行→样本100、1001–10000→样本500等)。这个样本将从表中随机抽取。</p><p id="f3ff" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated"><em class="jc">标记器任务主题</em> <br/>该发布订阅主题将DLP API通知从标记器服务中分离出来，以便处理BigQuery列标记操作的速率限制，并应用带回退的自动重试。</p><p id="a416" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated"><em class="jc"> Tagger服务</em>一个云服务，它需要一个BigQuery表的信息。它将根据最新的DLP结果确定每一列的信息类型，并应用适当的策略标记。</p><p id="6acc" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated"><em class="jc">标记调度服务</em> <br/>云运行服务，充当解决方案的入口点。它需要一个BigQuery范围，表示为项目、数据集和表的包含和排除列表。该范围可以是一个或多个表。</p><p id="b484" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">标记调度程序将列出扫描范围中包含的所有具有现有DLP扫描结果的表，并在标记器任务主题中提交该表的表标记请求。</p><p id="1f7d" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">此服务用于触发重新标记运行，而无需重新检查表。这在分类体系发生变化，但底层数据保持不变的情况下很有帮助。</p><p id="82d1" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated"><em class="jc"> BigQuery配置视图</em> <br/> Terraform根据定义的映射和配置生成配置视图。这些配置视图主要由Tagger服务用来确定策略标记逻辑。</p><p id="34f4" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated"><em class="jc">日志</em>除此之外，还有许多BigQuery视图可以帮助监控和调试调用链以及对列进行标记操作。</p><p id="c735" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated"><strong class="jd hj">部署</strong></p><p id="5fa0" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">要部署该解决方案，您必须配置以下主要部分(通过Terraform ),这些部分对应于我们之前讨论的GCP概念:</p><ul class=""><li id="3ea1" class="kb kc hi jd b je jf jh ji jy kd jz ke ka kf jw kg kh ki kj bi translated"><strong class="jd hj"> BigQuery Scope: </strong>要在运行中包含或排除的项目、数据集或表格的列表(即扫描和标记)。它还附带了一个CRON时间表来确定这种运行的频率。</li></ul><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es nh"><img src="../Images/c1a00b7190ff2dd47f52e89653a9e564.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GoTyXPP3qhK34Hh8WxuX0g.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">BigQuery扫描范围配置</figcaption></figure><ul class=""><li id="aeb1" class="kb kc hi jd b je jf jh ji jy kd jz ke ka kf jw kg kh ki kj bi translated"><strong class="jd hj">数据分类分类法:</strong>标准和自定义的JSON列表<em class="jc"> " </em> <a class="ae jx" href="https://cloud.google.com/dlp/docs/concepts-infotypes" rel="noopener ugc nofollow" target="_blank"> <em class="jc">信息类型</em> </a> <em class="jc"> " </em>定义为一个层次结构(如高、中、低)。该列表将被转换成两个GCP资源；1)数据目录策略标记分类2)DLP检查模板</li></ul><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es ni"><img src="../Images/f8ccd7babccf7cacfdb85ebd0c5fae78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B1OYOAEWxzGEebLgLV9dwg.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">分类分类法配置</figcaption></figure><ul class=""><li id="279d" class="kb kc hi jd b je jf jh ji jy kd jz ke ka kf jw kg kh ki kj bi translated"><strong class="jd hj">域映射:</strong>如果您需要区分跨业务单位的PII数据访问(例如，营销PII的读者只能访问营销PII，而不能访问财务PII)，那么您需要在项目或数据集级别告诉解决方案哪些数据属于哪个<em class="jc">“域】</em>(即业务单位)。这将导致在数据目录中创建N个策略标记分类，每个域一个(所有副本)，其中每个策略标记分类用于标记属于某个域的表。</li></ul><figure class="mn mo mp mq fd mr er es paragraph-image"><div class="er es nj"><img src="../Images/4ea086ac60e0af0bda6a67fcb32489f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*Ow6w0afAVD7pa8zApF5dww.png"/></div><figcaption class="mx my et er es mz na bd b be z dx translated">域映射配置</figcaption></figure><ul class=""><li id="13ba" class="kb kc hi jd b je jf jh ji jy kd jz ke ka kf jw kg kh ki kj bi translated"><strong class="jd hj"> IAM映射:</strong>IAM用户和组的列表，这些用户和组应该能够访问特定域和保密级别组合(在前面的分类中定义)的PII数据</li></ul><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es nk"><img src="../Images/ac525785c6b4ce2000f898d28fb49724.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MMHEpj6LMcokXp1zzKW5LA.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">IAM映射配置</figcaption></figure><ul class=""><li id="b451" class="kb kc hi jd b je jf jh ji jy kd jz ke ka kf jw kg kh ki kj bi translated"><strong class="jd hj"> DLP扫描限制:</strong>为了控制成本，该解决方案提供了一种配置，可根据表格大小确定DLP检查作业随机选择的行数(或百分比)。(PS:此配置仅适用于我们将在部署部分讨论的标准模式部署)</li></ul><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es nl"><img src="../Images/31cd2ba5c168e13364f1dc1436c3bedb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H9Y0JGBj19z9_ZRFZY8zpg.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">DLP扫描限制配置</figcaption></figure><p id="e542" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">虽然这些是配置的主要亮点，但是您需要遵循解决方案自述文件来了解完整的配置和部署过程。</p><p id="5335" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated"><strong class="jd hj">运行解决方案</strong></p><p id="5c49" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">一旦解决方案部署到GCP，人们可以通过云调度器上的入口点<em class="jc">检查调度器</em>轻松触发它:</p><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es nm"><img src="../Images/fe0cc31c6d5a33d4bb532c4624467e00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZYPEGVSQpCFlkhoib9yCJg.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">通过云调度程序触发检查运行</figcaption></figure><p id="0df9" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">这将触发<strong class="jd hj"> Dispatcher </strong>服务，该服务列出所提供的BigQuery扫描范围内的所有表(即项目、数据集和表的包含和排除列表),并将每个表的一个请求提交给<strong class="jd hj"> Inspector </strong>服务</p><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es nn"><img src="../Images/97686776a817dbe8bf8b02d1b1efd1c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rH4nIPe8x8cU2soc4e1jBg.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">Dispatcher Service日志，显示发送给Inspector Service的消息</figcaption></figure><p id="1922" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">一旦Inspector服务收到给定表的检查请求，它将为该表创建并提交DLP检查作业，同时设置所有必需的参数(例如，检查模板、结果表等)</p><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es no"><img src="../Images/5cde6a99d73e6f7642d990f5ec616e49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YVstYBZk4WQ3qcFEdBr9FQ.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">显示一个表检查请求的处理步骤的检查员服务日志</figcaption></figure><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es np"><img src="../Images/f79f3d93c65bff9a3fca2177afba1a21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3g2q1Rax6m1WiXOHZZBmNQ.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">解决方案根据表创建的DLP检验作业</figcaption></figure><p id="6712" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">最后，一旦DLP作业完成，它将发送一条PubSub通知消息，该消息将触发Tagger服务来解释DLP结果并将相应的策略标记分配给列。</p><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es nq"><img src="../Images/a3b042ede6bf71ca3f05f04f54f06b7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yngoMH4U8I9DIQdgIxBg8Q.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">显示表字段标记操作的标记器服务日志</figcaption></figure><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es nr"><img src="../Images/f675af152d5b85e36cf81317d2b5a735.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hS4hpM093hJzJGqd4BoF0w.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">显示给定运行/表的标记操作的BigQuery视图</figcaption></figure><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es ns"><img src="../Images/3d0d54fdb62e230d0c63c78963f63238.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dp0XmOW5lv1PV00z2PvTPA.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">为访问控制分配了策略标记的BigQuery表</figcaption></figure></div><div class="ab cl li lj gp lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hb hc hd he hf"><h1 id="f481" class="lp lq hi bd lr ls lt lu lv lw lx ly lz io ma ip mb ir mc is md iu me iv mf mg bi translated">标准与自动DLP</h1><p id="4862" class="pw-post-body-paragraph ja jb hi jd b je mh ij jg jh mi im jj jy mj jm jn jz mk jq jr ka ml ju jv jw hb bi translated">随着<a class="ae jx" href="https://cloud.google.com/blog/products/identity-security/automatic-dlp-for-bigquery" rel="noopener ugc nofollow" target="_blank">自动DLP </a>于2022年4月正式上市，<a class="ae jx" href="https://github.com/GoogleCloudPlatform/bq-pii-classifier" rel="noopener ugc nofollow" target="_blank"> <strong class="jd hj"> BQ PII分类器</strong> </a>扩展了其功能，构建在自动DLP之上。为此，它有两种部署方式，“标准DLP模式”和“自动DLP模式”(标准DLP是我们到目前为止一直在谈论的一种模式)。</p><p id="4a75" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">在“自动DLP模式”下，该解决方案将跳过检查员服务(即，为每个表生成DLP检查作业)，而是依赖于自动DLP外部生成的数据配置文件；其他一切都保持不变。</p><figure class="mn mo mp mq fd mr er es paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="er es nt"><img src="../Images/31a17aa159dd71742b46be048a5ae8c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UgHnVIJwJQ2VUR6kje6biw.jpeg"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated">BQ PII分类器解决方案架构(自动DLP模式)</figcaption></figure><p id="8f32" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated"><strong class="jd hj">建议尽可能使用“自动DLP模式”</strong>以利用本地产品功能的可靠性和可扩展性。您可能倾向于“标准DLP模式”的唯一原因是，如果您正在寻找以下一项或多项:</p><ul class=""><li id="12cc" class="kb kc hi jd b je jf jh ji jy kd jz ke ka kf jw kg kh ki kj bi translated"><strong class="jd hj">严格的DLP成本保证:</strong>“标准DLP模式”提供了一个函数来定义BigQuery表的采样大小，使您能够估计解决方案产生的DLP成本。在撰写本文时(2022年4月), Auto DLP不提供成本估算，但它是一项正在开发的功能。</li><li id="b569" class="kb kc hi jd b je kk jh kl jy km jz kn ka ko jw kg kh ki kj bi translated"><strong class="jd hj">粒度大查询范围:</strong>“标准DLP模式”允许您通过包含和排除列表配置项目、数据集和表级别的扫描和标记范围，而自动DLP允许您配置组织、文件夹或项目级别的扫描范围(无排除列表)。</li><li id="8a54" class="kb kc hi jd b je kk jh kl jy km jz kn ka ko jw kg kh ki kj bi translated"><strong class="jd hj">运行频率的粒度控制:</strong>使用<strong class="jd hj">“</strong>标准DLP模式”可以配置N个具有不同BigQuery范围和CRON运行频率的云调度器。使用Auto DLP，您可以选择在某些触发条件下(例如模式更改和添加行)每天或每月重新扫描一次表，但是您不能显式触发运行。</li></ul></div><div class="ab cl li lj gp lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hb hc hd he hf"><h1 id="c312" class="lp lq hi bd lr ls lt lu lv lw lx ly lz io ma ip mb ir mc is md iu me iv mf mg bi translated">结论</h1><p id="1f35" class="pw-post-body-paragraph ja jb hi jd b je mh ij jg jh mi im jj jy mj jm jn jz mk jq jr ka ml ju jv jw hb bi translated">在本文中，我们解释了在大规模BigQuery中管理PII数据的一些步骤。我们展示了每一步背后的主要GCP功能，并向cased <a class="ae jx" href="https://github.com/GoogleCloudPlatform/bq-pii-classifier" rel="noopener ugc nofollow" target="_blank">展示了一个开源解决方案</a>，您可以部署它来实现整个端到端流程的自动化。</p></div></div>    
</body>
</html>