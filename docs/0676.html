<html>
<head>
<title>Trillian: Ben Laurie’s “Registers” Example</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">特里安:本·劳里的“寄存器”例子</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/trillian-ben-lauries-registers-example-8bf19e297e80?source=collection_archive---------0-----------------------#2018-07-05">https://medium.com/google-cloud/trillian-ben-lauries-registers-example-8bf19e297e80?source=collection_archive---------0-----------------------#2018-07-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="e8ce" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">2019–05–08更新</strong>:Ben的repo for Registers中的代码过期。请在<a class="ae jh" href="https://github.com/google/trillian-examples" rel="noopener ugc nofollow" target="_blank">https://github.com/google/trillian-examples</a>使用他的解决方案的副本</p><p id="b88a" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">2018–12–11更新</strong>:感谢我的同事Paul对这篇文章的有益反馈，这篇文章现已收录。</p></blockquote><p id="dd17" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我最近写了一篇文章解释如何在GCP部署谷歌的万亿项目。当时，我说我也会为特里安写一个例子。谷歌的本·劳里利用英国政府的<a class="ae jh" href="https://www.registers.service.gov.uk/" rel="noopener ugc nofollow" target="_blank">注册处</a>和Trillian联合开发了一个优雅的<a class="ae jh" href="https://github.com/benlaurie/trillian-examples" rel="noopener ugc nofollow" target="_blank">例子</a>。</p><p id="abbf" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">这个故事是本回购协议中代码的预演，向您展示如何处理它。这是本许可写的。虽然本教程使用Google Cloud SQL，但是任何MySQL实例都可以。Trillian和Ben的示例代码运行在您的本地工作站上，没有部署到GCP。</p><h2 id="198d" class="jn jo hi bd jp jq jr js jt ju jv jw jx ji jy jz ka jj kb kc kd jk ke kf kg kh bi translated">设置</h2><p id="6c11" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it ji kk iw ix jj kl ja jb jk km je jf jg hb bi translated">环境:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="1728" class="jn jo hi ks b fi kw kx l ky kz">BILLING=[[YOUR-BILLING]]<br/>PROJECT=[[YOUR-PROJECT]]<br/>REGION=[[YOUR-REGION]]<br/>INSTANCE=[[YOUR-INSTANCE]]</span></pre><p id="0722" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后，如果需要，创建一个GCP项目并启用开单。您需要启用计费，因为我们将使用云SQL:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="6e3d" class="jn jo hi ks b fi kw kx l ky kz">gcloud projects create ${PROJECT}<br/>gcloud beta billing projects link ${PROJECT} \<br/>--billing-account=${BILLING}</span></pre><p id="f1bb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">创建一个SQL实例(<code class="du la lb lc ks b">${INSTANCE}</code>)并确保其root密码未设置。别担心，我们将使用云SQL代理来访问实例，因此您的实例仍然是安全的:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="66c0" class="jn jo hi ks b fi kw kx l ky kz">gcloud sql instances create ${INSTANCE} \<br/>--database-version=MYSQL_5_7 \<br/>--tier=db-g1-small \<br/>--region=${REGION} \<br/>--project=${PROJECT}</span><span id="8384" class="jn jo hi ks b fi ld kx l ky kz">gcloud sql users set-password root \<br/>--instance=${INSTANCE} \<br/>--host=% \<br/>--password='' \<br/>--project=${PROJECT}</span></pre><blockquote class="if ig ih"><p id="215e" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">更新2018–11–19</strong>:为所有主机(<code class="du la lb lc ks b">%</code>)复制<code class="du la lb lc ks b">Test</code>用户，避免使用云SQL时出现本地主机问题</p></blockquote><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="496a" class="jn jo hi ks b fi kw kx l ky kz">gcloud sql users create test \<br/>--instance=${INSTANCE} \<br/>--host=% \<br/>--password='zaphod' \<br/>--project=${PROJECT}</span></pre><p id="c6a3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">下载云SQL代理，并让它在单独的shell中运行:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="7244" class="jn jo hi ks b fi kw kx l ky kz">wget <a class="ae jh" href="https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64" rel="noopener ugc nofollow" target="_blank">https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64</a> -O cloud_sql_proxy</span><span id="e5ce" class="jn jo hi ks b fi ld kx l ky kz">chmod +x cloud_sql_proxy</span><span id="1b0b" class="jn jo hi ks b fi ld kx l ky kz">./cloud_sql_proxy \<br/>-instances=${PROJECT}:${REGION}:${INSTANCE}=tcp:3306</span></pre><p id="e96d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您可以通过从另一个终端会话连接代理来测试代理:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="ee16" class="jn jo hi ks b fi kw kx l ky kz">mysql \<br/>--host=127.0.0.1 \<br/>--port=3306 \<br/>--user=root \<br/>--password=''</span></pre><blockquote class="if ig ih"><p id="59be" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">要实现这一点，请使用<code class="du la lb lc ks b">127.0.0.1</code>而不是<code class="du la lb lc ks b">localhost</code>。</p></blockquote><h2 id="f9fa" class="jn jo hi bd jp jq jr js jt ju jv jw jx ji jy jz ka jj kb kc kd jk ke kf kg kh bi translated">崔莉安</h2><p id="889c" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it ji kk iw ix jj kl ja jb jk km je jf jg hb bi translated">建立一个Golang工作区并获取Trillian:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="4c8f" class="jn jo hi ks b fi kw kx l ky kz">mkdir go<br/>export GOPATH=$PWD/go<br/>export PATH=$PATH:$GOPATH/bin</span><span id="8265" class="jn jo hi ks b fi ld kx l ky kz">go get github.com/google/trillian</span><span id="15af" class="jn jo hi ks b fi ld kx l ky kz">cd ${GOPATH}/src/github.com/google/trillian/<br/>go get -t -u -v ./...</span></pre><p id="d405" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">重置云SQL数据库:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="c6f6" class="jn jo hi ks b fi kw kx l ky kz">MYSQL_HOST=127.0.0.1 ./scripts/resetdb.sh</span></pre><blockquote class="if ig ih"><p id="561f" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">更新2018–11–19:</strong><code class="du la lb lc ks b">DB_HOST</code>现为<code class="du la lb lc ks b">MYSQL_HOST</code>。</p></blockquote><p id="ea78" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">可选:如果您愿意，您可以运行Trillian的集成测试:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="b4f3" class="jn jo hi ks b fi kw kx l ky kz">MYSQL_HOST=127.0.0.1 ./integration/integration_test.sh</span></pre><h2 id="2d13" class="jn jo hi bd jp jq jr js jt ju jv jw jx ji jy jz ka jj kb kc kd jk ke kf kg kh bi translated">例子</h2><p id="a021" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it ji kk iw ix jj kl ja jb jk km je jf jg hb bi translated">然后克隆本的例子:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="180c" class="jn jo hi ks b fi kw kx l ky kz">mkdir -p ${GOPATH}/src/github.com/benlaurie &amp;&amp; \<br/>cd ${GOPATH}/src/github.com/benlaurie<br/>git clone <a class="ae jh" href="https://github.com/benlaurie/trillian-examples" rel="noopener ugc nofollow" target="_blank">https://github.com/benlaurie/trillian-examples</a><br/>cd trillian-examples<br/>tree</span><span id="d92d" class="jn jo hi ks b fi ld kx l ky kz">.<br/>├── AUTHORS<br/>├── CONTRIBUTING.md<br/>├── CONTRIBUTORS<br/>├── etherslurp<br/>├── LICENSE<br/>└── README.md</span></pre><p id="8f5d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">本的例子有7个步骤，每个步骤都在他的回购协议的不同分支中有所体现。</p><h2 id="6752" class="jn jo hi bd jp jq jr js jt ju jv jw jx ji jy jz ka jj kb kc kd jk ke kf kg kh bi translated">1.获取数据</h2><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="59fa" class="jn jo hi ks b fi kw kx l ky kz">git checkout register-1<br/>go get ./...</span><span id="7bd4" class="jn jo hi ks b fi ld kx l ky kz">git branch</span><span id="7144" class="jn jo hi ks b fi ld kx l ky kz">master<br/><strong class="ks hj">* register-1</strong></span><span id="daff" class="jn jo hi ks b fi ld kx l ky kz">tree<br/>.<br/>├── AUTHORS<br/>├── CONTRIBUTING.md<br/>├── CONTRIBUTORS<br/>├── etherslurp<br/>├── LICENSE<br/>├── README.md<br/>├── <strong class="ks hj">registers</strong><br/>└── <strong class="ks hj">scripts</strong></span></pre><p id="4ff3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">注意分支包括<code class="du la lb lc ks b">registers</code>和<code class="du la lb lc ks b">scripts</code>。</p><p id="f330" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后，您应该能够成功地:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="e39c" class="jn jo hi ks b fi kw kx l ky kz">cd registers<br/>go run dump/main.go</span></pre><p id="1f48" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您将开始看到Registers站点数据被转储为JSON:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="3caa" class="jn jo hi ks b fi kw kx l ky kz">2018/07/04 11:28:12 &amp;register.Register{baseURL:"<a class="ae jh" href="https://register.register.gov.uk/" rel="noopener ugc nofollow" target="_blank">https://register.register.gov.uk/</a>", info:map[string]interface {}{"total-records":44, "total-entries":66, "register-record":map[string]interface {}{"phase":"beta", "register":"register", "fields":[]interface {}{"register", "text", "registry", "phase", "copyright", "fields"}, "registry":"cabinet-office", "text":"Registers maintained by the UK government"}, "custodian":"Arnau Siches", "last-updated":"2018-07-03T09:56:50Z", "domain":"register.gov.uk"}}<br/>2018/07/04 11:28:13 map[string]interface {}{"index-entry-number":"1", "entry-number":"1", "entry-timestamp":"2016-08-04T14:45:41Z", "key":"register", "item-hash":[]interface {}{"sha-256:5fa9c4b569a71542c9c791203d54b6b94c125f189a9c529c63466a0b34cbe38c"}} sha-256:5fa9c4b569a71542c9c791203d54b6b94c125f189a9c529c63466a0b34cbe38c map[string]interface {}{"fields":[]interface {}{"register", "text", "registry", "phase", "copyright", "fields"}, "register":"register", "phase":"beta", "registry":"cabinet-office", "text":"Registers maintained by HM Government"}<br/>...</span></pre><p id="3297" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">你可以中断转储。</p><blockquote class="if ig ih"><p id="8c66" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">如果你想知道哪个寄存器被使用了，那就是寄存器中的寄存器。您可以在<a class="ae jh" href="https://www.registers.service.gov.uk/registers/register" rel="noopener ugc nofollow" target="_blank">https://www.registers.service.gov.uk/registers/register</a>预览这些数据</p></blockquote><p id="ed5e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">每个分支都有一个修改过的<code class="du la lb lc ks b">TUTORIAL.md</code>文件，总结了正在做的事情。我不想重复本的内容，但为了避免你来回移动，我会在我们进行的过程中添加摘要。</p><h2 id="111a" class="jn jo hi bd jp jq jr js jt ju jv jw jx ji jy jz ka jj kb kc kd jk ke kf kg kh bi translated">2.向日志中添加数据</h2><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="7085" class="jn jo hi ks b fi kw kx l ky kz">git checkout register-2<br/>go get ./...</span><span id="6a0a" class="jn jo hi ks b fi ld kx l ky kz">git branch</span><span id="3ec7" class="jn jo hi ks b fi ld kx l ky kz">  master<br/>  register-1<br/><strong class="ks hj">* register-2</strong></span></pre><p id="ef1f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">此步骤将注册数据添加到万亿日志中。</p><blockquote class="if ig ih"><p id="c589" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj"> NB </strong>在接下来的步骤中，您将希望能够同时运行多个shells来监控各个进程的输出。</p></blockquote><p id="edfa" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">确保您的云SQL代理正在运行。</p><p id="2a2e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们也启动一个万亿日志服务器:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="f791" class="jn jo hi ks b fi kw kx l ky kz">$GOPATH/bin/trillian_log_server --logtostderr</span></pre><p id="43c9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您应该输出类似如下的内容:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="241e" class="jn jo hi ks b fi kw kx l ky kz">Using MySQL QuotaManager<br/>RPC server starting on localhost:8090<br/>HTTP server starting on localhost:8091<br/>Deleted tree GC started</span></pre><p id="bce3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">下一步生成一个新的日志，并返回日志的ID。因此，我们可以在同一个(！)会话:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="b506" class="jn jo hi ks b fi kw kx l ky kz">LOGID=$($GOPATH/bin/createtree --admin_server=localhost:8090) &amp;&amp; \<br/>echo ${LOGID}</span></pre><p id="c05e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">它将输出日志的唯一ID，格式如下:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="4cff" class="jn jo hi ks b fi kw kx l ky kz">1234567890123456789</span></pre><p id="b80d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后运行以下命令:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="26e9" class="jn jo hi ks b fi kw kx l ky kz">go run dump/main.go -log_id=${LOGID}</span></pre><p id="f47f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">当每个记录从寄存器中取出并添加到Trillian日志中时，您应该会看到类似于步骤1的输出。</p><p id="d2e2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">这一次，请让命令运行完成。它应该以类似于以下内容的输出结束:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="d7a2" class="jn jo hi ks b fi kw kx l ky kz">2018/07/04 15:49:04 New entries: 66<br/>2018/07/04 15:49:04 Duplicate entries: 0</span></pre><h2 id="53c8" class="jn jo hi bd jp jq jr js jt ju jv jw jx ji jy jz ka jj kb kc kd jk ke kf kg kh bi translated">3.提取日志条目</h2><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="2d01" class="jn jo hi ks b fi kw kx l ky kz">git checkout register-3<br/>Switched to a new branch 'register-3'</span><span id="d7ad" class="jn jo hi ks b fi ld kx l ky kz">git branch<br/>  master<br/>  register-1<br/>  register-2<br/><strong class="ks hj">* register-3</strong></span></pre><p id="a9e7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们将从运行Trillian日志签名程序开始。打开另一个外壳，然后:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="4826" class="jn jo hi ks b fi kw kx l ky kz">$GOPATH/bin/trillian_log_signer \<br/>--logtostderr \<br/>--force_master \<br/>--http_endpoint=localhost:8092 \<br/>--rpc_endpoint=localhost:8093 \<br/>--batch_size=1000 \<br/>--sequencer_guard_window=0 \<br/>--sequencer_interval=200ms<br/></span></pre><blockquote class="if ig ih"><p id="4078" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">注意</strong>我已经为<code class="du la lb lc ks b">rpc_endpoint</code>添加了一个不同的端口(<code class="du la lb lc ks b">8093</code>，以避免与日志服务器的<code class="du la lb lc ks b">rpc_endpoint</code>发生冲突。</p></blockquote><p id="44f0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您应该会看到以下形式的输出:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="6e26" class="jn jo hi ks b fi kw kx l ky kz">**** Log Signer Starting ****<br/>**** Acting as master for all logs ****<br/>Using MySQL QuotaManager<br/>Creating HTTP server starting on localhost:8092<br/>Log operation manager starting<br/>HTTP server starting<br/>creating mastership tracker for [3558678532662980721 5598166607403133250]<br/>create master election goroutine for 3558678532662980721<br/>create master election goroutine for 5598166607403133250<br/>now acting as master for 0 / 2, master for:<br/>...<br/>Group run completed in 0.20 seconds: 2 succeeded, 0 failed, 0 items processed<br/>...</span></pre><p id="56f2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们可以运行Ben的日志提取器:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="c414" class="jn jo hi ks b fi kw kx l ky kz">go run extract/main.go --log_id=${LOGID}</span></pre><p id="84d3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">是的，到目前为止，我们已经提取了寄存器的条目，将它们添加到万亿日志中，然后再将它们提取出来。</p><p id="6d40" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">但是这里的目的是提供一种添加和获取万亿级日志数据的模式。而且，因为这是一个万亿级的日志，所以数据保存在Merkle树中(本身由云SQL支持)。Merkle树为我们添加的数据的完整性提供了保证。</p><h2 id="a744" class="jn jo hi bd jp jq jr js jt ju jv jw jx ji jy jz ka jj kb kc kd jk ke kf kg kh bi translated">4.创建一个万亿地图</h2><p id="b997" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it ji kk iw ix jj kl ja jb jk km je jf jg hb bi translated">Trillian支持两种模式。首先，我们使用的是它的仅附加日志。第二个是键值映射。在这一步中，我们将迭代现在万亿级日志中的寄存器数据，并将每个记录添加到万亿级映射中。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="6a98" class="jn jo hi ks b fi kw kx l ky kz">git checkout register-4<br/>Switched to a new branch 'register-4'<br/>git branch<br/>  master<br/>  register-1<br/>  register-2<br/>  register-3<br/><strong class="ks hj">* register-4</strong></span></pre><p id="c7ce" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要一个万亿地图服务器(我们将继续使用日志服务器)。因此，打开另一个外壳:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="4730" class="jn jo hi ks b fi kw kx l ky kz">$GOPATH/bin/trillian_map_server \<br/>--logtostderr \<br/>--rpc_endpoint=localhost:8095 \<br/>--http_endpoint=localhost:8096</span></pre><blockquote class="if ig ih"><p id="60a7" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj"> NB </strong>您不需要指定<code class="du la lb lc ks b">— http-endpoint</code>标志，但是这样做可以避免当地图服务器试图在日志服务器使用的相同默认端口(8091)上打开HTTP端点时出现错误。</p></blockquote><p id="a62a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">输出类似于日志服务器的输出:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="9ab1" class="jn jo hi ks b fi kw kx l ky kz">Using MySQL QuotaManager<br/>RPC server starting on localhost:8095<br/>HTTP server starting on localhost:8096<br/>Deleted tree GC started</span></pre><p id="88e2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">与我们在步骤2中为日志服务器创建日志的方式类似，我们将为地图服务器创建一个地图:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="af64" class="jn jo hi ks b fi kw kx l ky kz">MAPID=$(\<br/>  $GOPATH/bin/createtree \<br/>  --admin_server=localhost:8095 \<br/>  --tree_type=MAP \<br/>  --hash_strategy=TEST_MAP_HASHER) &amp;&amp; \<br/>echo ${MAPID}</span></pre><p id="225f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您将获得另一个唯一的ID。这张是为了地图。</p><p id="4479" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后，我们将运行遍历日志、提取条目并创建映射条目的代码:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="350b" class="jn jo hi ks b fi kw kx l ky kz">go run mapper/main.go \<br/>--log_id=${LOGID} \<br/>--map_id=${MAPID}</span></pre><p id="2760" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您应该看到所有的66个条目(步骤#2结束)都添加到了映射中，即:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="a141" class="jn jo hi ks b fi kw kx l ky kz">2018/07/04 16:35:40 k: country ts: 2016-08-04 14:45:41 +0000 UTC<br/>2018/07/04 16:35:40 key=country leaf=<br/>evicting country -&gt; &amp;{map[index-entry-number:2 item-hash:[sha-256:610bde42d3ae2ed3dd829263fe461542742a10ca33865d96d31ae043b242c300] key:country entry-number:2 entry-timestamp:2016-08-04T14:45:41Z] [map[fields:[country name official-name citizen-names start-date end-date] phase:beta register:country registry:foreign-commonwealth-office text:British English-language names and descriptive terms for countries]]}</span></pre><h2 id="f964" class="jn jo hi bd jp jq jr js jt ju jv jw jx ji jy jz ka jj kb kc kd jk ke kf kg kh bi translated">5.提取地图条目</h2><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="90bb" class="jn jo hi ks b fi kw kx l ky kz">git checkout register-5<br/>Switched to a new branch 'register-5'<br/>git branch<br/>  master<br/>  register-1<br/>  register-2<br/>  register-3<br/>  register-4<br/><strong class="ks hj">* register-5</strong></span></pre><p id="901c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后，通过仔细查看在上述步骤#4中通过摄取创建的键(例如，如图所示的“T1”)，您可以运行特定键的提取映射:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="8d9e" class="jn jo hi ks b fi kw kx l ky kz">go run extractmap/main.go \<br/>--map_id=${MAPID} \<br/>country</span><span id="d3dd" class="jn jo hi ks b fi ld kx l ky kz">country<br/>{"Entry":{"entry-number":"49","entry-timestamp":"2018-06-07T13:43:14Z","index-entry-number":"49","item-hash":["sha-256:7a0afa860ea3fd1f92c9c3d96a5df26cd9345360adaf6fc8d6ac1e0a282d372f"],"key":"country"},"Items":[{"fields":["country","name","official-name","citizen-names","start-date","end-date"],"phase":"beta","register":"country","registry":"foreign-commonwealth-office","text":"British English names and descriptive terms for countries as recognised by the UK government"}]}</span><span id="212b" class="jn jo hi ks b fi ld kx l ky kz">go run extractmap/main.go \<br/>--map_id=${MAPID} \<br/>territory</span><span id="4b20" class="jn jo hi ks b fi ld kx l ky kz">territory<br/>{"Entry":{"entry-number":"56","entry-timestamp":"2018-06-07T13:46:32Z","index-entry-number":"56","item-hash":["sha-256:e5a90c513739ee7636987485e3b69ec721b3860868a3c6487367930299c6593d"],"key":"territory"},"Items":[{"fields":["territory","name","official-name","start-date","end-date"],"phase":"beta","register":"territory","registry":"foreign-commonwealth-office","text":"British English names and descriptive terms for political, administrative and geographical entities that are not recognised as countries by the UK government"}]}</span></pre><h2 id="be28" class="jn jo hi bd jp jq jr js jt ju jv jw jx ji jy jz ka jj kb kc kd jk ke kf kg kh bi translated">6.重构</h2><p id="70a4" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it ji kk iw ix jj kl ja jb jk km je jf jg hb bi translated">在第7步中，我们将在万亿地图服务器前放置一个web服务器。web服务器需要能够获取键的范围，因此这一步重构了第5步中的<code class="du la lb lc ks b">extractmap</code>来实现这一点:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="51d3" class="jn jo hi ks b fi kw kx l ky kz">git checkout register-3<br/>Switched to a new branch 'register-3'<br/>git branch<br/>  master<br/>  register-1<br/>  register-2<br/>  register-3<br/>  register-4<br/>  register-5<br/><strong class="ks hj">* register-6</strong></span></pre><p id="8df3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">为简单起见，我将偏离Ben的指示，不删除并创建一个新树，而是创建一个新树:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="ce54" class="jn jo hi ks b fi kw kx l ky kz">MAPID=$(\<br/>  $GOPATH/bin/createtree \<br/>  --admin_server=localhost:8095 \<br/>  --tree_type=MAP \<br/>  --hash_strategy=TEST_MAP_HASHER) &amp;&amp; \<br/>echo ${MAPID}</span></pre><blockquote class="if ig ih"><p id="044f" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj"> NB </strong>如果您希望保留对第一棵树的访问，请在覆盖${MAPID}的值或使用不同的变量之前保留其副本。</p></blockquote><p id="9ff9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后重新运行日志→映射器:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="f34f" class="jn jo hi ks b fi kw kx l ky kz">go run mapper/main.go \<br/>--log_id=${LOGID} \<br/>--map_id=${MAPID}</span></pre><p id="9aaa" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们可以提取整个地图:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="f1ab" class="jn jo hi ks b fi kw kx l ky kz">go run extractmap/main.go --map_id=${MAPID}</span></pre><p id="ba3b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">最后…</p><h2 id="ff16" class="jn jo hi bd jp jq jr js jt ju jv jw jx ji jy jz ka jj kb kc kd jk ke kf kg kh bi translated">7.网络服务器</h2><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="3a73" class="jn jo hi ks b fi kw kx l ky kz">git checkout register-7<br/>git branch<br/>  master<br/>  register-1<br/>  register-2<br/>  register-3<br/>  register-4<br/>  register-5<br/>  register-6<br/><strong class="ks hj">* register-7</strong></span></pre><p id="19e0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="ed37" class="jn jo hi ks b fi kw kx l ky kz">go run webserver/main.go --map_id=${MAPID}</span></pre><p id="d597" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您应该能够在主机的端口<code class="du la lb lc ks b">8080</code>上浏览<code class="du la lb lc ks b">/records.json</code>:</p><figure class="kn ko kp kq fd lf er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es le"><img src="../Images/6dd91ac0ebdf3e82363ef2cf66c0b53f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q9i5orpyDaHUvvwgTg3UKQ.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">本地主机:8080/records.json</figcaption></figure><h2 id="3c13" class="jn jo hi bd jp jq jr js jt ju jv jw jx ji jy jz ka jj kb kc kd jk ke kf kg kh bi translated">结论</h2><p id="7d32" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it ji kk iw ix jj kl ja jb jk km je jf jg hb bi translated">希望这个快速成功的故事向您展示了如何导航一个优秀的示例Trillian应用程序，并通过这个过程更好地了解Trillian。</p><p id="2451" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">下一步…打造我们自己的app！</p><h2 id="9ea0" class="jn jo hi bd jp jq jr js jt ju jv jw jx ji jy jz ka jj kb kc kd jk ke kf kg kh bi translated">拆毁</h2><p id="468a" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it ji kk iw ix jj kl ja jb jk km je jf jg hb bi translated">假设您想要恢复所有内容，请终止注销到您创建的各个会话的每个进程。</p><p id="d0f5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您也可以终止云SQL代理。</p><p id="01c5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您只能删除云SQL数据库。如果要删除云SQL实例，数据库也会随之删除。</p><p id="c6b5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated"><strong class="il hj">注意</strong>这些操作<strong class="il hj">是不可撤销的</strong>:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="80c3" class="jn jo hi ks b fi kw kx l ky kz">gcloud sql databases delete test \<br/>--instance=${INSTANCE} \<br/>--project=${PROJECT}</span><span id="b16a" class="jn jo hi ks b fi ld kx l ky kz">gcloud sql instances delete ${INSTANCE} \<br/>--project=${PROJECT}</span></pre><p id="d0cf" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">如果您希望删除GCP项目:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="6a18" class="jn jo hi ks b fi kw kx l ky kz">gcloud projects delete ${PROJECT}</span></pre><p id="7b52" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">仅此而已！</p></div></div>    
</body>
</html>