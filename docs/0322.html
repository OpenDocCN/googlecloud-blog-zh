<html>
<head>
<title>Whack-a-pod: The Kubernetes cluster whack-a-mole game</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">打地鼠:Kubernetes集群打地鼠游戏</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/whack-a-pod-359cbfb61662?source=collection_archive---------0-----------------------#2017-06-27">https://medium.com/google-cloud/whack-a-pod-359cbfb61662?source=collection_archive---------0-----------------------#2017-06-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="23c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本周早些时候，我发布了一个开源版本的“敲打一个豆荚”，这是一个演示，我在谷歌云的团队已经在<a class="ae jd" href="https://cloudnext.withgoogle.com/" rel="noopener ugc nofollow" target="_blank">谷歌云Next </a>、<a class="ae jd" href="https://events.google.com/io/" rel="noopener ugc nofollow" target="_blank">谷歌I/O </a>和各种地区活动中使用过。对于那些没有看过演示的人来说，它将一个Kubernetes集群变成了一个打地鼠游戏，其中Kubernetes pods是鼹鼠，并且您试图打倒足够多的pod/鼹鼠来中断这些pod/鼹鼠提供的服务。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/108933f9831b1ec9c745a8e367ba11f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*qjsHiyp0zmWEBIeB3ZpXyw.gif"/></div></div></figure><p id="0058" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在活动中使用的版本包括一个物理打地鼠机器，它连接到我们的游戏，所以你可以通过挥动锤子实际上杀死Kubernetes豆荚。物理钻机上的工作由<a class="ae jd" href="http://www.sparksonline.com/" rel="noopener ugc nofollow" target="_blank"> Sparks </a>完成，不包括在本报告中。但是，您可以在任何地方运行这个版本，只需要最低的硬件要求——一个屏幕和一个界面，基于触摸屏或鼠标。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es jq"><img src="../Images/e0125d3731b8a9d9f98ecb4ccfd3349c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7AJAnzgAYkQPNQlG.jpg"/></div></div></figure><h1 id="3ba9" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">为什么要建？</h1><p id="01d0" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我想要一种简单有趣的方式来解释Kubernetes。我想要一个可以连接到真实事物上的东西，让你可以触摸云中的东西。我想让大家明白Kubernetes是有弹性的。</p><p id="7ca0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我还想制作一系列基于嘉年华的游戏，所有的游戏都和嘉年华版的wha-a-pod具有相同的外观和感觉。他们因过于异想天开而被拒绝。但那是后话了。</p><h1 id="195b" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">它是如何工作的？</h1><p id="6cd6" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">整个应用程序由三个独立的应用程序组成，它们都托管在同一个Kubernetes集群上。我们还创建了三个服务来公开应用程序。</p><h2 id="a180" class="ku js hi bd jt kv kw kx jx ky kz la kb iq lb lc kf iu ld le kj iy lf lg kn lh bi translated">应用程序接口</h2><p id="5fe3" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">这就是摩尔代表的应用。我们启动了一个部署，该部署创建了一个副本集，其中包含保持12个副本始终运行的指令。</p><p id="5d29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[api-service]/api/color" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">http://【API-service】/API/color</strong></a></p><p id="ef57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是圆荚体保持的基本服务。它非常简单——当轮询时，它返回一个随机的十六进制颜色值。</p><p id="218f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[api-service]/api/color-complete" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">http://[API-service]/API/color-complete</strong></a></p><p id="448d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是上面的颜色api的一个稍微调整的版本，用于高级界面。除了颜色之外，它还返回响应请求的pod的唯一的Kubernetes生成的名称。</p><h2 id="53f5" class="ku js hi bd jt kv kw kx jx ky kz la kb iq lb lc kf iu ld le kj iy lf lg kn lh bi translated">管理</h2><p id="7e6f" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">这是一组命令，允许我们的前端针对Kubernetes集群发出命令，而不需要凭证。它基本上是Kubernetes API的代理，具有一组有限的可能操作。</p><p id="e61e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[admin-service]/api/k8s/createdeploy" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> http://【管理服务】/api/k8s/createdeploy </strong> </a></p><p id="ee65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为运行提供API应用程序的pod创建部署。启动时在所有界面中使用。</p><p id="663f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[admin-service]/api/k8s/deleteallpods" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> http://【管理服务】/api/k8s/deleteallpods </strong> </a></p><p id="e89a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除API部署的所有窗格。</p><p id="ee05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[admin-service]/api/k8s/deletedeploy" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">http://[admin-service]/API/k8s/delete deploy</strong></a></p><p id="9957" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除API应用程序的部署。当游戏完成部署时，在所有界面中使用</p><p id="d894" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[admin-service]/api/k8s/deletepod" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">http://[admin-service]/API/k8s/delete pod</strong></a></p><p id="9edd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除单个pod。当你重击一个豆荚的时候在所有的界面中使用。</p><p id="9e9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[admin-service]/api/k8s/drain" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">http://[admin-service]/API/k8s/drain</strong></a></p><p id="dbee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">封锁一个节点以防止任何pod在其上被调度，然后它杀死所有正在该节点上运行的API pods。用于高级界面。</p><p id="ab82" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[admin-service]/api/k8s/getnodes" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> http://【管理服务】/api/k8s/getnodes </strong> </a></p><p id="5d21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获取有关Kubernetes群集节点的信息。用于高级界面。</p><p id="d884" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[admin-service]/api/k8s/getpods" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">http://[admin-service]/API/k8s/get pods</strong></a></p><p id="7003" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获取有关运行API服务的所有pod的信息。在所有界面中用于填充pod/moles列表。</p><p id="0d7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[admin-service]/api/k8s/uncordon" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">http://[admin-service]/API/k8s/un cordon</strong></a></p><p id="3406" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">重置一个节点，以便它可以开始接受新计划的单元。用于高级界面。</p><h2 id="5c12" class="ku js hi bd jt kv kw kx jx ky kz la kb iq lb lc kf iu ld le kj iy lf lg kn lh bi translated">比赛</h2><p id="2312" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">这个游戏由几个独立的HTML/JS/CSS应用程序组合而成。它们都以相同的方式工作。</p><p id="97d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">演示开始时没有pod运行。每个版本都会提示您部署吊舱。部署会创建一个运行12个单元的副本集。</p><p id="0ae7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">UI定期轮询API/颜色服务。如果它得到一个结果，服务就启动，如果它没有得到一个结果，服务就关闭。顶部有一个指示器，给玩家服务状态的反馈。</p><p id="1f28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">pod显示在网格中，它们的状态由颜色差异(或摩尔位置差异)表示。状态包括:开始、运行、终止。起始和终止的pod不能被“重击”当你敲击一个正在运行的pod时，UI调用admin/api/k8s/deletepod/。pod在终止后会保留一段时间，并被处于启动状态的pod所取代。</p><p id="1882" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[game-service]/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> http://【游戏-服务】/</strong>/T3】</a></p><p id="23b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是基本的游戏。它有一个有趣的嘉年华主题，旨在成为一个有趣的，分散注意力的游戏，而不是一个关于Kubernetes的真实课程。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es li"><img src="../Images/f3a1271413674a337f3f6efc471e6ff2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*L7S2yQKxyr1fUJz6.png"/></div></div></figure><p id="cef5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[game-service]/next.html" rel="noopener ugc nofollow" target="_blank">T5】http://[游戏-服务]/next . htmlT7】</a></p><p id="866b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是基本游戏，但没有嘉年华主题。这更符合谷歌云下一次活动的品牌。我们已经在一些地区性的云Next活动中在触摸屏上使用了这个版本。</p><p id="00e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它还有一个面板，显示Kubernetes命令的JSON响应的节略版本。为什么删节？因为Kubernetes的大部分单个回复都是超过100行的格式化JSON。相反，该应用程序显示的是突出的细节。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lj"><img src="../Images/2d24d57597d0de9f4fd60026f0144f28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uB2daKH1y-Nd3Y4i.png"/></div></div></figure><p id="741f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[game-service]/advanced.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> http://【游戏-服务】/advanced.html </strong> </a></p><p id="6e5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当在各种活动中展示演示时，我们发现自己希望在对话开始深入时获得另一种信息。高级视图是对此的回应。它去掉了时间元素，而是在pod填充集群节点时显示它们，而不是在固定的网格中显示。我们直接显示服务响应。我们还展示了哪个pod实际上正在响应服务请求。该界面包括排空集群节点的功能，以模拟节点停机。杀死一个实际的节点需要更长的时间，所以这似乎是模拟节点死亡的合理方式。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lk"><img src="../Images/5ba08cc7ac671fbe5049357c0a7f44f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GwXWZPrWGbO1ZeaY.png"/></div></div></figure><h1 id="9940" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">选择</h1><h2 id="32ee" class="ku js hi bd jt kv kw kx jx ky kz la kb iq lb lc kf iu ld le kj iy lf lg kn lh bi translated">为什么是三种服务？</h2><p id="73f0" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我最初把它写成一个应用程序。当你关闭了所有的pod，中断了服务，你也就关闭了用户界面。当您运行演示时，这与不一致的缓存行为相结合导致了非常奇怪的问题。把它们分开更有意义，这样在你玩游戏的时候就不会破坏游戏。</p><h2 id="953f" class="ku js hi bd jt kv kw kx jx ky kz la kb iq lb lc kf iu ld le kj iy lf lg kn lh bi translated">为什么选择PHP？</h2><p id="c3b5" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">首先，我为Google Cloud向PHP社区推广。但我也开始写这个快速和肮脏的原型。当我想快速完成某件事时，我会用PHP来写。这对我很有帮助。我使用了App Engine flexible environment的PHP运行时的Docker映像来让它工作。</p><p id="041c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当到了收紧一切的时候，我考虑重写所有的API来使用Golang。但是选择PHP和GAE灵活运行时的一个副作用是启动服务有一点开销——与编写一个只做一件事的精益go应用程序相反。这种开销只有几秒钟，但有了它，演示就可以展示pod的整个生命周期。</p><h2 id="e0df" class="ku js hi bd jt kv kw kx jx ky kz la kb iq lb lc kf iu ld le kj iy lf lg kn lh bi translated">为什么没有公开演示？</h2><p id="0de1" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我还没有想出一种方法将这个演示转换成多租户演示。因此，它是一个Kubernetes集群的前端客户端。所以多个玩家会互相干扰。目前，它涉及到试图关闭一个与特定IP直接相关的服务。我肯定有办法重写它来做到这一点，我只是没有时间去做。</p><h1 id="9549" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">我学到了什么</h1><h2 id="ac71" class="ku js hi bd jt kv kw kx jx ky kz la kb iq lb lc kf iu ld le kj iy lf lg kn lh bi translated">Kubectl太棒了</h2><p id="cc85" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">在很多情况下，我只是试图重新创建一个kubectl命令来绑定到前端。具体的例子有kubectl删除部署和kubectl排出。在这两种情况下，它们实际上做了很多工作，但是隐藏在一个命令后面。在kubectl delete deployment的例子中，命令是删除部署，然后是副本集，然后是每个pod，使之成为一件事。如果您只是通过API删除部署，那么所有的子节点都会保留下来——如果您没有预料到，您会感到困惑。</p><p id="ad20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">kubectl可以用一个标志来调用，以揭示这些底层调用，这一点非常值得赞赏。标志是"-v=8 "，以防你需要。</p><h2 id="761b" class="ku js hi bd jt kv kw kx jx ky kz la kb iq lb lc kf iu ld le kj iy lf lg kn lh bi translated">Kubernetes是一个weeble而不是一个堡垒</h2><p id="7694" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我认为这是我学到的最令人惊讶的事情之一。我没有刻意让系统变得超级有弹性或超级脆弱，但是在大多数情况下，如果您能够直接删除所有的pod，您可能会导致您的服务出现重大中断。但是，这些中断很少会持续很长时间。事实上，在Google I/O，我们跟踪了人们关闭服务的时间，我们看到最多的是50%的停机时间。这是两个非常积极的人在鼹鼠一出现时就打它们。大部分时间我们看到市中心不到30%。再次提醒，记住游戏机制的要点是尽可能多地造成停机。</p><h2 id="6bfd" class="ku js hi bd jt kv kw kx jx ky kz la kb iq lb lc kf iu ld le kj iy lf lg kn lh bi translated">一个死了的豆荚只是大部分死了</h2><p id="7daa" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">在一些事件中，我们遇到了这样的问题:没有一个可见的pod处于“运行”状态，但是服务仍然在运行。我以为是因为UI怪异。原来这是由于运行Kubernetes delete pod命令将pod标记为“终止”,然后允许正常终止。因此，如果请求被路由到它们，而它们仍然在响应请求，它们仍然可以返回结果，即使标记为终止。如果我费心稍微仔细地阅读一下文档的话，我早就知道了。</p><h2 id="46f8" class="ku js hi bd jt kv kw kx jx ky kz la kb iq lb lc kf iu ld le kj iy lf lg kn lh bi translated">当鼹鼠倒下时，打地鼠机器休息</h2><p id="a961" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">当鼹鼠向上时，机器在工作，当他们向下时，机器在休息。当Sparks第一次将物理打地鼠机器连接到Kubernetes集群时(实际上，一个在我们的数据中心，另一个在活动现场)，鼹鼠一直在工作，因为，嗯，这就是Kubernetes所做的。长话短说，我们的第一台打地鼠机器烧坏了，因为当21世纪的云技术与20世纪70年代的街机技术发生碰撞时，云技术获胜。</p><h1 id="778b" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">结论</h1><p id="1370" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">这是一个非常有趣的项目。它帮助我了解了很多关于Kubernetes的知识，同时也让我有了一次很好的关于Kubernetes的教育经历。另外，我让人造了一个打地鼠机器。太棒了。</p><p id="7dd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://github.com/tpryan/whack_a_pod" rel="noopener ugc nofollow" target="_blank">在github上获取源码</a>。</p></div></div>    
</body>
</html>