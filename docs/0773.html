<html>
<head>
<title>Continuous Delivery of HashiCorp Vault on Google Kubernetes Engine: Sandbox Development</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google Kubernetes引擎上持续交付HashiCorp Vault:沙盒开发</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/continuous-delivery-of-hashicorp-vault-on-google-kubernetes-engine-sandbox-development-f603e0bceaf1?source=collection_archive---------0-----------------------#2018-09-27">https://medium.com/google-cloud/continuous-delivery-of-hashicorp-vault-on-google-kubernetes-engine-sandbox-development-f603e0bceaf1?source=collection_archive---------0-----------------------#2018-09-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3388" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">这是一个系列的第5部分:</strong> <a class="ae jd" rel="noopener" href="/@blzysh/continuous-delivery-of-hashicorp-vault-on-google-kubernetes-engine-bcbf4e75f0f6"> <strong class="ih hj">指数</strong> </a></p><h1 id="37cc" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">概述:</h1><p id="fd62" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><a class="ae jd" href="https://continuousdelivery.com" rel="noopener ugc nofollow" target="_blank">连续交付</a>的基础之一是<a class="ae jd" href="https://continuousdelivery.com/foundations/continuous-integration" rel="noopener ugc nofollow" target="_blank">连续集成</a>。持续集成的实践之一是频繁的签入。频繁的签入<strong class="ih hj">不会</strong>发生在对提交代码没有信心的团队中。</p><p id="db1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">想象一下应用程序开发人员过渡到运营开发，或者想象一下一个系统管理员团队刚刚开始学习IaC。这是一个相当大的变化，大多数人不喜欢大声学习。这个环境解决了这个问题，为开发人员提供了一个可以进行编码和测试的全功能环境。当我说“测试”时，我指的是测试基础设施的变化以及应用程序的变化，甚至弄清楚应用程序是如何工作的。</p></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><p id="d063" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些都记录在GitHub上的my <a class="ae jd" href="https://github.com/lzysh/ops-gke-vault/blob/master/README.md" rel="noopener ugc nofollow" target="_blank"> README.md </a>中，并将继续维护和更新。这个设置是为了在Linux机器上进行IaC开发。</p><h1 id="4b64" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">安装Google Cloud SDK:</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="14ee" class="kx jf hi kt b fi ky kz l la lb">curl https://sdk.cloud.google.com | bash<br/>exec -l $SHELL<br/>gcloud init<br/>gcloud components install kubectl beta</span></pre><h1 id="9105" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">项目设置:</h1><p id="1d04" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">您将需要自己的沙盒项目，如初始设置中所述。就像上面提到的ops-tools-prod项目一样，这个项目是相同的，但是是为您自己的IaC个人沙盒开发的。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="ec7e" class="kx jf hi kt b fi ky kz l la lb">export project=ops-bcurtis-sb<br/>gcloud config set project ${ptoject}</span></pre><p id="4c13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建一个</strong> <a class="ae jd" href="https://cloud.google.com/dns/zones" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Google Cloud托管的DNS区域</strong> </a> <strong class="ih hj"> : </strong></p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="40bf" class="kx jf hi kt b fi ky kz l la lb">gcloud dns managed-zones create obs-lzy-sh \<br/>--description="My Sandbox Domain" --dns-name="obs.lzy.sh"</span></pre><p id="4f51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在ops-tools-prod: </strong>中向托管dns区域注册该区域</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="7edb" class="kx jf hi kt b fi ky kz l la lb">gcloud dns record-sets list --zone obs-lzy-sh</span><span id="d90d" class="kx jf hi kt b fi lc kz l la lb">NAME               TYPE  TTL    DATA<br/>obs.lzy.sh.        NS    21600  ns-cloud-a1.googledomains.com.,ns-cloud-a2.googledomains.com.,ns-cloud-a3.googledomains.com.,ns-cloud-a4.googledomains.com.<br/>obs.lzy.sh.        SOA   21600  ns-cloud-a1.googledomains.com. cloud-dns-hostmaster.google.com. 1 21600 3600 259200 300</span></pre><p id="de4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将显示您的NS记录，获取数据并在ops-tools-prod project lzy-sh managed cloud DNS zone中创建NS记录。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="ca8b" class="kx jf hi kt b fi ky kz l la lb">gcloud --project ops-tools-prod dns record-sets transaction \<br/>start -z=lzy-sh</span><span id="840f" class="kx jf hi kt b fi lc kz l la lb">gcloud --project ops-tools-prod dns record-sets transaction \<br/>add -z=lzy-sh --name="obs.lzy.sh." --type=NS --ttl=300 \<br/>"ns-cloud-a1.googledomains.com." "ns-cloud-a2.googledomains.com." \<br/>"ns-cloud-a3.googledomains.com." "ns-cloud-a4.googledomains.com."</span><span id="1d32" class="kx jf hi kt b fi lc kz l la lb">gcloud --project ops-tools-prod dns record-sets transaction \<br/>execute -z=lzy-sh</span></pre><p id="c98d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建一个</strong> <a class="ae jd" href="https://cloud.google.com/storage/docs/creating-buckets" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Google云存储桶</strong> </a> <strong class="ih hj">为</strong> <a class="ae jd" href="https://www.terraform.io/docs/state/remote.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Terraform远程状态</strong> </a> <strong class="ih hj"> : </strong></p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="4a48" class="kx jf hi kt b fi ky kz l la lb">gsutil mb -p ${project} -c multi_regional -l US \<br/>gs://${project}_tf_state</span></pre><p id="63e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同时启用<a class="ae jd" href="https://cloud.google.com/storage/docs/object-versioning" rel="noopener ugc nofollow" target="_blank">对象版本</a>:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="424d" class="kx jf hi kt b fi ky kz l la lb">gsutil versioning set on gs://${project}_tf_state</span></pre></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><h1 id="a1f1" class="je jf hi bd jg jh ld jj jk jl le jn jo jp lf jr js jt lg jv jw jx lh jz ka kb bi translated">安装Terraform:</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="ddf8" class="kx jf hi kt b fi ky kz l la lb">curl -O https://releases.hashicorp.com/terraform/0.11.8/terraform_0.11.8_linux_amd64.zip</span><span id="73c4" class="kx jf hi kt b fi lc kz l la lb">sudo unzip terraform_0.11.8_linux_amd64.zip -d /usr/local/bin</span></pre></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><h1 id="5ad4" class="je jf hi bd jg jh ld jj jk jl le jn jo jp lf jr js jt lg jv jw jx lh jz ka kb bi translated">设置Google应用程序默认凭据:</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="acbd" class="kx jf hi kt b fi ky kz l la lb">gcloud auth application-default login</span></pre><h1 id="04bc" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">克隆项目:</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="edd8" class="kx jf hi kt b fi ky kz l la lb">git clone git@github.com:lzysh/ops-gke-vault.git</span></pre><h1 id="4ea9" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">初始化地形:</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="0c4f" class="kx jf hi kt b fi ky kz l la lb">cd ops-gke-vault/terraform</span><span id="c7b5" class="kx jf hi kt b fi lc kz l la lb">terraform init -backend-config="bucket=${project}_tf_state" \<br/>-backend-config="project=${project}"</span></pre><blockquote class="li lj lk"><p id="7915" class="if ig ll ih b ii ij ik il im in io ip lm ir is it ln iv iw ix lo iz ja jb jc hb bi translated"><em class="hi">注意:此时你被设置为在Terraform中使用</em> <a class="ae jd" href="https://www.terraform.io/docs/state/remote.html" rel="noopener ugc nofollow" target="_blank"> <em class="hi">远程状态</em> </a> <em class="hi">。</em></p></blockquote><h1 id="bc4a" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置变量:</h1><p id="69fc" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">创建一个local.tfvars文件，并根据需要进行编辑:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="43fb" class="kx jf hi kt b fi ky kz l la lb">cp local.tfvars.EXAMPLE local.tfvars</span></pre><blockquote class="li lj lk"><p id="d339" class="if ig ll ih b ii ij ik il im in io ip lm ir is it ln iv iw ix lo iz ja jb jc hb bi translated"><em class="hi">注意:folder_id变量将是您设置了适当IAM角色的Sanbox文件夹的id。</em></p></blockquote><h1 id="7dd2" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">地形规划和应用:</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="9b37" class="kx jf hi kt b fi ky kz l la lb">random=$RANDOM</span><span id="cd30" class="kx jf hi kt b fi lc kz l la lb">terraform plan -out="plan.out" -var-file="local.tfvars" \<br/>-var="project=ops-vault-${random}-sb" \<br/>-var="host=vault-${random}"</span><span id="d684" class="kx jf hi kt b fi lc kz l la lb">terraform apply "plan.out"</span></pre><p id="a67d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">terraform应用完成后，大约需要5-10分钟才能访问Vault实例。入口正在做它的事情，DNS正在传播，SSL证书正在颁发。</p><p id="ad58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">解密根令牌的URL和命令在Terraform输出中。</p><h1 id="93fc" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">在本地安装Vault</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="8f7e" class="kx jf hi kt b fi ky kz l la lb">curl -O https://releases.hashicorp.com/vault/0.11.1/vault_0.11.1_linux_amd64.zip</span><span id="cbbf" class="kx jf hi kt b fi lc kz l la lb">sudo unzip vault_0.11.1_linux_amd64.zip -d /usr/local/bin</span></pre><h1 id="9cf4" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">保险库测试示例</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="6225" class="kx jf hi kt b fi ky kz l la lb">export VAULT_ADDR="$(terraform output url)"</span><span id="3b54" class="kx jf hi kt b fi lc kz l la lb">export VAULT_SKIP_VERIFY=true (Use for testing only)</span><span id="b95a" class="kx jf hi kt b fi lc kz l la lb">export VAULT_TOKEN="$(decrypted token)"</span></pre><p id="be5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">启用</strong><a class="ae jd" href="https://www.vaultproject.io/docs/secrets/kv/kv-v2.html" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">KV2</strong></a><strong class="ih hj">:</strong></p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="304e" class="kx jf hi kt b fi ky kz l la lb">vault kv enable-versioning secret</span></pre><p id="6ee9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">发布/获取秘密:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="5baa" class="kx jf hi kt b fi ky kz l la lb">vault kv put secret/my_team/pre-prod/api_key \ key=QWsDEr876d6s4wLKcjfLPxxuyRTE</span><span id="d2b5" class="kx jf hi kt b fi lc kz l la lb">vault kv get secret/my_team/pre-prod/api_key<br/>====== Metadata ======<br/>Key              Value<br/>---              -----<br/>created_time     2018-09-16T04:04:50.14260161Z<br/>deletion_time    n/a<br/>destroyed        false<br/>version          1</span><span id="bd92" class="kx jf hi kt b fi lc kz l la lb">=== Data ===<br/>Key    Value<br/>---    -----<br/>key    QWsDEr876d6s4wLKcjfLPxxuyRTE</span></pre><p id="35bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">放置/获取多值机密:</strong></p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="9361" class="kx jf hi kt b fi ky kz l la lb">vault kv put secret/my_team/pre-prod/db_info url=foo.example.com:35533 db_name=users username=admin password=passw0rd</span><span id="dca4" class="kx jf hi kt b fi lc kz l la lb">vault kv get secret/my_team/pre-prod/db_info<br/>====== Metadata ======<br/>Key              Value<br/>---              -----<br/>created_time     2018-09-16T04:09:55.452868097Z<br/>deletion_time    n/a<br/>destroyed        false<br/>version          1</span><span id="5145" class="kx jf hi kt b fi lc kz l la lb">====== Data ======<br/>Key         Value<br/>---         -----<br/>db_name     users<br/>password    passw0rd<br/>url         foo.example.com:35533<br/>username    admin</span></pre><h1 id="889f" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">地形破坏</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="e1b8" class="kx jf hi kt b fi ky kz l la lb">terraform destroy -var-file="local.tfvars" \<br/>-var="project=ops-vault-${random}-sb" \<br/>-var="host=vault-${random}"</span></pre></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><p id="f172" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为一个开发团队，我们现在可以在本地工作，尝试清理一些像这样的事情<a class="ae jd" href="https://www.terraform.io/docs/provisioners/null_resource.html" rel="noopener ugc nofollow" target="_blank">null _ resource</a><a class="ae jd" href="https://www.terraform.io/docs/provisioners/local-exec.html" rel="noopener ugc nofollow" target="_blank">local-exec</a><a class="ae jd" href="https://github.com/lzysh/ops-gke-vault/blob/master/terraform/main.tf#L267" rel="noopener ugc nofollow" target="_blank">code</a>。你不需要知道任何关于地形、拱顶、库伯内特等的知识。跟着自述文件走吧，<strong class="ih hj">这是你学习</strong>的地方。</p></div></div>    
</body>
</html>