<html>
<head>
<title>Events for Cloud Run for Anthos &gt;= Knative Eventing on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Anthos的云运行事件&gt; = Kubernetes上的Knative事件</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/events-for-cloud-run-for-anthos-knative-eventing-on-kubernetes-9966f44a4cad?source=collection_archive---------0-----------------------#2020-10-08">https://medium.com/google-cloud/events-for-cloud-run-for-anthos-knative-eventing-on-kubernetes-9966f44a4cad?source=collection_archive---------0-----------------------#2020-10-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="d931" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="6b91" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们最近<a class="ae kb" href="https://cloud.google.com/blog/products/serverless/cloud-run-for-anthos-adds-events" rel="noopener ugc nofollow" target="_blank">宣布了</a>一项新功能，<em class="kc">Events for Cloud Run for Anthos</em>，在Google Kubernetes Engine (GKE)上构建事件驱动系统。在公告中，我们还声明该解决方案是基于开源的<a class="ae kb" href="https://knative.dev/" rel="noopener ugc nofollow" target="_blank"> Knative </a>。</p><p id="04c4" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">在这篇博文中，我想进一步解释这个新特性和Knative之间的关系。我还想让你相信，我们的解决方案是在Google Cloud上部署Knative兼容事件消费服务的一种更简单的方式。</p><p id="e6cb" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated"><strong class="jf hj">TLDR:<em class="kc">Events for Cloud Run for Anthos</em>是</strong><a class="ae kb" href="https://knative.dev/docs/eventing/" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj">Knative Events</strong></a><strong class="jf hj">为Google Cloud打包简化。</strong></p><p id="fb94" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">当然，您仍然可以创建一个GKE集群，安装Istio，在上面安装Knative，并自行部署读取Knative事件的服务。然而，这将花费你更长的时间来设置一切，更不用说跟踪所有版本和依赖项的维护工作了。</p><p id="2b49" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">让我们通过一个例子来深入了解细节。假设您想要部署一个服务来从Google云存储桶中读取事件。在Knative vs. Cloud Run for Anthos中设置此功能需要什么？</p><h1 id="0920" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">破坏性事件</h1><h2 id="c694" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">创建启用事件的集群</h2><p id="ce34" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">要使用Knative eventing读取Google云存储事件，首先，您需要一个启用Knative的集群，并且您需要安装事件源来读取Google Cloud事件。大致步骤如下:</p><ol class=""><li id="ddb5" class="kw kx hi jf b jg kd jk ke jo ky js kz jw la ka lb lc ld le bi translated">创建GKE集群。</li><li id="b414" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">安装Istio。</li><li id="002d" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">安装有创意的服务。</li><li id="045f" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">安装Knative Eventing。</li><li id="8eba" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">用GCP组件安装和配置Knative。</li></ol><p id="0065" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">我实际上试图在我的<a class="ae kb" href="https://medium.com/r?url=https%3A%2F%2Fgithub.com%2Fmeteatamel%2Fknative-tutorial" rel="noopener"> Knative教程</a>中维护一个<a class="ae kb" href="https://github.com/meteatamel/knative-tutorial/tree/master/setup" rel="noopener ugc nofollow" target="_blank">设置脚本</a>来做所有这些，每次有新版本的Knative时都要更新这个脚本，这是一个很大的工作量。</p><h2 id="04fb" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">部署服务并连接到事件</h2><p id="a560" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">拥有集群后，您需要:</p><ol class=""><li id="bb63" class="kw kx hi jf b jg kd jk ke jo ky js kz jw la ka lb lc ld le bi translated">创建一个CloudStorageSource，将云存储事件读入集群。</li><li id="86cc" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">在名称空间中注入一个代理来接收事件。</li><li id="871c" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">部署一个Knative服务来消费事件。</li><li id="13e7" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">创建一个触发器来过滤云存储事件，并将其从代理传递到Knative服务。</li></ol><p id="7fd5" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">我不会用细节来烦你，在我的实用教程中有一个<a class="ae kb" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/storageeventing.md" rel="noopener ugc nofollow" target="_blank">云存储触发的服务示例</a>,里面有详细的说明，包括多个yaml文件、部署等等。绝对不是一个快速简单的过程。</p><h1 id="0bd6" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">Anthos的云运行事件</h1><p id="d1ea" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">现在，让我们为Anthos创建相同的云运行示例。</p><h2 id="827d" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">创建启用事件的集群</h2><p id="2239" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">像以前一样，我们需要一个支持事件的GKE集群。这是一个分两步走的过程。</p><p id="79bd" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">在<strong class="jf hj">快速</strong>频道上创建一个带有<strong class="jf hj"> CloudRun附加组件</strong>的GKE集群:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="e276" class="ki ig hi lp b fi lt lu l lv lw">gcloud beta container clusters create ${CLUSTER_NAME} \<br/>  --addons=HttpLoadBalancing,HorizontalPodAutoscaling,CloudRun \<br/>  --machine-type=n1-standard-4 \<br/>  --enable-autoscaling --min-nodes=3 --max-nodes=10 \<br/>  --no-issue-client-certificate --num-nodes=3 --image-type=cos \<br/>  --enable-stackdriver-kubernetes \<br/>  --scopes=cloud-platform,logging-write,monitoring-write,pubsub \<br/>  --zone ${CLUSTER_ZONE} \<br/>  --release-channel=rapid</span></pre><p id="b37c" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">使用事件组件初始化集群:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="eab8" class="ki ig hi lp b fi lt lu l lv lw">gcloud beta events init</span></pre><p id="56a1" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">此时，您将拥有一个启用了事件的集群，所有设置都已完成。没有Istio安装，没有Knative安装，没有Knative-GCP安装和配置！</p><h2 id="e9cb" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">部署服务并连接到事件</h2><p id="06c6" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这是一个与Knative Eventing相似但稍微简化的过程，包括代理、触发器等。</p><p id="a5a6" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">首先，在名称空间中注入一个代理:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="bf58" class="ki ig hi lp b fi lt lu l lv lw">gcloud beta events brokers create default --namespace default</span></pre><p id="fe08" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">将云运行服务部署为事件消费者:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="fd32" class="ki ig hi lp b fi lt lu l lv lw">gcloud run deploy event-display \<br/>   --image gcr.io/knative-releases/knative.dev/eventing-contrib/cmd/event_display@sha256:8da2440b62a5c077d9882ed50397730e84d07037b1c8a3e40ff6b89c37332b27</span></pre><p id="dd33" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">创建一个触发器来过滤云存储事件，并将其从代理传递到云运行服务:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="2232" class="ki ig hi lp b fi lt lu l lv lw">gcloud beta events triggers create trigger-storage \<br/>  --target-service event-display \<br/>  --type=google.cloud.storage.object.v1.finalized \<br/>  --parameters bucket=bucket-name</span></pre><p id="6ec4" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">注意，我们不必手动创建一个<code class="du lx ly lz lp b">CloudStorageSource</code>，触发器已经为我们创建了它。我们不必处理yaml文件，而是依靠gcloud命令来为我们做正确的事情。最重要的是，我们不必手动升级Knative Eventing前进，GKE运营商可以为我们做到这一点！</p></div><div class="ab cl ma mb gp mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hb hc hd he hf"><p id="13c1" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">希望这篇文章澄清了Anthos 云运行的Knative事件和<em class="kc">事件之间的关系。</em></p><p id="25b4" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">要了解更多信息:</p><ul class=""><li id="e07a" class="kw kx hi jf b jg kd jk ke jo ky js kz jw la ka mh lc ld le bi translated">参见<a class="ae kb" href="https://cloud.google.com/run/docs/events/anthos/quickstart" rel="noopener ugc nofollow" target="_blank">快速入门</a>。</li><li id="5481" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka mh lc ld le bi translated">尝试codelab: <a class="ae kb" href="https://codelabs.developers.google.com/codelabs/cloud-run-events-anthos/" rel="noopener ugc nofollow" target="_blank">为Anthos运行云的事件</a>。</li><li id="ef06" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka mh lc ld le bi translated">尝试qwiklab: <a class="ae kb" href="https://google.qwiklabs.com/focuses/14220?parent=catalog" rel="noopener ugc nofollow" target="_blank">为Anthos构建一个包含云运行事件的BigQuery处理管道</a>。</li></ul><p id="d49d" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">欢迎在Twitter <a class="ae kb" href="https://twitter.com/meteatamel" rel="noopener ugc nofollow" target="_blank"> @meteatamel </a>上联系我，或者阅读我以前在<a class="ae kb" rel="noopener" href="/@meteatamel"> medium/@meteatamel </a>上的帖子。</p></div><div class="ab cl ma mb gp mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hb hc hd he hf"><p id="c8c5" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated"><em class="kc">原载于</em><a class="ae kb" href="https://atamel.dev/posts/2020/10-09_events_cloud_run_anthos_knative_eventing/" rel="noopener ugc nofollow" target="_blank"><em class="kc">https://atamel . dev</em></a><em class="kc">。</em></p></div></div>    
</body>
</html>