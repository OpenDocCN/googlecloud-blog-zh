<html>
<head>
<title>Optimize BigQuery costs with Flex Slots</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用灵活插槽优化BigQuery成本</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/optimize-bigquery-costs-with-flex-slots-e06ec5e4aa90?source=collection_archive---------1-----------------------#2020-04-22">https://medium.com/google-cloud/optimize-bigquery-costs-with-flex-slots-e06ec5e4aa90?source=collection_archive---------1-----------------------#2020-04-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d7ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(2020年5月13日更新:代码现在使用保留的<a class="ae jd" href="https://googleapis.dev/python/bigqueryreservation/latest/index.html" rel="noopener ugc nofollow" target="_blank">客户端库</a></p><p id="3db2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌云最近增加了<a class="ae jd" href="https://cloud.google.com/blog/products/data-analytics/introducing-bigquery-flex-slots" rel="noopener ugc nofollow" target="_blank"> Flex Slots </a>作为BigQuery的新定价选项。使用<a class="ae jd" href="https://cloud.google.com/bigquery/pricing#flat_rate_pricing" rel="noopener ugc nofollow" target="_blank">统一费率承诺</a>的用户不再按扫描的字节数为查询付费，而是为预留的计算资源付费；使用<a class="ae jd" href="https://cloud.google.com/bigquery/pricing#flex-slots-pricing" rel="noopener ugc nofollow" target="_blank">弹性时段承诺</a>，用户现在可以在60秒后随时取消预订。按每秒20美元/500个时段计费，Flex Slots可以为查询大小超过1tb的按需客户节省大量成本。</p><p id="db82" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我将向您展示您的应用程序如何使用Reservations APIs，以与单个4tb按需查询(当前定价为<a class="ae jd" href="https://cloud.google.com/bigquery/pricing#on_demand_pricing" rel="noopener ugc nofollow" target="_blank"> $5/TiB </a>)相同的价格，对500个插槽的预留运行<strong class="ih hj"/><strong class="ih hj">小时的查询。在<a class="ae jd" href="https://console.cloud.google.com/bigquery/admin/reservations" rel="noopener ugc nofollow" target="_blank">预订用户界面</a>中也有相同的功能。</strong></p><h2 id="c557" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">管理项目设置</h2><p id="abe9" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">BigQuery预订的推荐最佳实践是维护一个用于管理预订的专用项目。在本指南中，该项目将被称为“管理项目”。</p><p id="ac91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了创建预订，您的用户将需要项目上的<strong class="ih hj"> bigquery.resourceAdmin </strong>角色和至少500个预订API插槽的可用<a class="ae jd" href="https://cloud.google.com/bigquery/docs/reservations-intro#quotas" rel="noopener ugc nofollow" target="_blank">配额</a>。</p><h2 id="4a0c" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">用户项目设置</h2><p id="0523" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">将需要创建BigQuery“用户项目”。为了简单起见，您的用户应该在用户项目中拥有<strong class="ih hj"> bigquery.admin </strong>角色，允许您附加预订和运行查询。</p><p id="3246" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从云壳集到你的用户项目。</p><pre class="ke kf kg kh fd ki kj kk kl aw km bi"><span id="97d4" class="je jf hi kj b fi kn ko l kp kq">$gcloud projects add-iam-policy-binding $DEVSHELL_PROJECT_ID member='user:myuser@org.com' role='roles/bigquery.admin'</span></pre><h2 id="5141" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">在笔记本中测试行为</h2><p id="cdcc" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">为了展示API，我将使用一个协同实验室(Colab)笔记本，它将允许您在浏览器中运行Python。(另一种选择，如BigQuery quickstart文档中的<a class="ae jd" href="https://cloud.google.com/bigquery/docs/quickstarts/quickstart-client-libraries#client-libraries-usage-python" rel="noopener ugc nofollow" target="_blank">所示，是使用经过认证的Python客户端。)</a></p><p id="8898" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置<a class="ae jd" href="https://colab.research.google.com/" rel="noopener ugc nofollow" target="_blank"> Colab </a>环境，并在出现提示时启动新的笔记本选项。</p><p id="8d24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在初始单元格中输入该代码。</p><figure class="ke kf kg kh fd kr"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="c6a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要将# '您的_管理_项目'和# '您的_用户_项目'替换为您之前创建的项目。</p><p id="99f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提示:按Shift-Enter执行单元格中的代码。</p><p id="df3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">colab项目现在以您的用户身份登录，其中一个基本项目设置为您的用户项目。</p><p id="a1ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您将创建一系列专用函数来演示Flex Slots特性。</p><p id="423c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，创建run_query函数，默认情况下，该函数将估计样本查询的大小。若要执行查询，请将dry_run标志设置为False。</p><figure class="ke kf kg kh fd kr"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="cff0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">调用时，您将看到run_query估计大约扫描了3.2TiB，或者按需定价的运行成本超过15美元。</p><p id="c1f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，创建一个预订客户机。</p><figure class="ke kf kg kh fd kr"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="8a22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，创建购买承诺的函数。承诺是购买时段的机制。弹性承诺购买以500时段小时为增量收取20美元；这相当于约33 /时段分钟。希望更快查询或更多并发性的客户可以增加他们的槽承诺。</p><figure class="ke kf kg kh fd kr"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="e814" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，创建一个函数来创建预订。预留创建一个指定的插槽分配，并且是将插槽分配给项目所必需的。</p><figure class="ke kf kg kh fd kr"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="3747" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，创建一个函数来创建分配。分配将保留分配给组织、文件夹或项目。该函数将在管理项目中创建的保留分配给用户项目。</p><figure class="ke kf kg kh fd kr"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="f0da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，创建一个清理函数。<a class="ae jd" href="https://cloud.google.com/bigquery/docs/reservations-concepts#commitment_plans" rel="noopener ugc nofollow" target="_blank">槽承诺</a>不能删除，直到60秒承诺，结束时间已到；使用简单的<a class="ae jd" href="https://googleapis.dev/python/google-api-core/latest/retry.html" rel="noopener ugc nofollow" target="_blank">重试</a>，直到可以删除资源。</p><figure class="ke kf kg kh fd kr"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="6e3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然已经创建了所有的效用函数，您将把所有的东西放在一起并观察结果。创建以下承诺将为您的项目收取预计运行5-10分钟的费用。</p><p id="58ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ku">注意:在撰写本文的时候，BigQuery Reservations API将会在插槽分配就绪之前指出它是活动的。该脚本包括3分钟的等待时间，以便预留附加的时间。如果你愿意的话，你可以在等的时候吃点小吃。</em></p><figure class="ke kf kg kh fd kr"><div class="bz dy l di"><div class="ks kt l"/></div></figure><h2 id="699e" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated"><strong class="ak">确认查询预约</strong></h2><figure class="ke kf kg kh fd kr er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es kv"><img src="../Images/1899f1fee30705e29ca8ad8210c88991.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MbD4H5Gvm6j6oSVr"/></div></div><figcaption class="lc ld et er es le lf bd b be z dx translated">预订名称和查询前缀以红色突出显示</figcaption></figure><p id="c9b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在BigQuery控制台的<a class="ae jd" href="https://console.cloud.google.com/bigquery?page=queries" rel="noopener ugc nofollow" target="_blank"> BigQuery查询历史选项卡</a>中看到格式良好的查询统计数据。预留名称将由使用预留槽的查询的属性来指示。</p><h2 id="0151" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">解释结果</h2><figure class="ke kf kg kh fd kr er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es lg"><img src="../Images/5d3d021da8af2d6fd91a95e788bb48b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dsIFjERRMCpXxFCZ"/></div></div><figcaption class="lc ld et er es le lf bd b be z dx translated">随着插槽的增加，性能接近线性增长</figcaption></figure><figure class="ke kf kg kh fd kr er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es lg"><img src="../Images/346b49e17894a6095335c85825a0a19f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2JtIjC0SmJHfak7CDh5gGg.png"/></div></div><figcaption class="lc ld et er es le lf bd b be z dx translated">灵活插槽可节省60%至80%的成本</figcaption></figure><p id="9f4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些图表比较了按需运行的查询时间和成本，2000个槽的<a class="ae jd" href="https://cloud.google.com/bigquery/docs/release-notes#December_10_2019" rel="noopener ugc nofollow" target="_blank">和2000个槽的增量为500个槽的运行。重要的是要记住，Flex Slots客户也将为闲置时间付费，对于较大的预订，这些成本可能会很快增加。然而，即使加上三分钟的空闲时间，<strong class="ih hj"> Flex Slots的成本</strong> <strong class="ih hj">比本教程的大型示例查询的按需定价成本</strong>低60%到80%。</a></p></div></div>    
</body>
</html>