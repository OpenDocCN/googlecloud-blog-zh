# æˆ‘æ˜¯å¦‚ä½•æ‰¾åˆ°æœ€å¥½çš„æŠ«è¨åº—çš„ğŸ•åœ¨ 13ï¼Œ000 ä¸ªåŸå¸‚ä½¿ç”¨äº‘ä»»åŠ¡ã€äº‘åŠŸèƒ½å’Œè°·æ­Œåœ°å›¾ğŸ—ºï¸

> åŸæ–‡ï¼š<https://medium.com/google-cloud/how-i-found-the-best-pizza-restaurant-in-13-000-cities-using-cloud-tasks-cloud-functions-and-db888675db71?source=collection_archive---------2----------------------->

![](img/69e386621d5c0b14418c3f247b04a1e9.png)

æ¯ä¸ªåˆ«é’ˆéƒ½æ ‡å¿—ç€é‚£ä¸ªåŸå¸‚/é•‡ä¸Šæœ€å¥½çš„æ¯”è¨é¥¼é¤é¦†ã€‚æ˜¯çš„ï¼Œç”šè‡³é‚£äº›çœ‹èµ·æ¥åœ¨æ°´é‡Œçš„(å²›å±¿)ã€‚

ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œåœ¨ä¸€ä¸ªæ–°åŸå¸‚ï¼Œå“ªé‡Œå¯ä»¥æ‰¾åˆ°æœ€å¥½çš„æŠ«è¨ï¼Ÿè°ä¸å–œæ¬¢è¾£é¦™è‚ æŠ«è¨ï¼Ÿ(æˆ–è€…ä¸€å—ç½—é©¬ç•ªèŒ„æ— éº¸é¦™è’œæ¯”è¨ï¼Ÿ)

**è°·æ­Œäº‘**ä¸º*åˆ†å¸ƒå¼è®¡ç®—*æä¾›äº†ä¸€äº›ä»¤äººéš¾ä»¥ç½®ä¿¡çš„å¼¹æ€§ä¼¸ç¼©æŠ€æœ¯ã€‚æœ€æ£’çš„æ˜¯ï¼Œä½ ä¸å¿…è€ƒè™‘æŠ€æœ¯åŸºç¡€è®¾æ–½æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

> å…³æ³¨ä½ çš„ä»£ç ï¼Œè€Œä¸æ˜¯ä½ çš„åŸºç¡€è®¾æ–½ã€‚

# å®ƒå§‹äºä¸¤ä¸ªé—®é¢˜

*   å¦‚ä½•æ˜¾ç¤ºè°·æ­Œäº‘ä»»åŠ¡çš„è§„æ¨¡ï¼Ÿ
*   æˆ‘å¦‚ä½•é€šè¿‡ç¼–ç¨‹æ‰¾åˆ°ä¸–ç•Œä¸Šæœ€å¥½çš„æ¯”è¨é¥¼åˆ‡ç‰‡ï¼Ÿ

åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªè„šæœ¬æ¥åˆ›å»ºå¤šä¸ªé’ˆå¯¹ Google Cloud åŠŸèƒ½çš„*ä»»åŠ¡*ã€‚ä¸ºäº†è®©äº‹æƒ…å˜å¾—æœ‰è¶£ï¼Œ**æˆ‘ä»¬å°†ä½¿ç”¨è°·æ­Œåœ°å›¾ APIï¼Œåœ¨å…¨çƒ *13ï¼Œ000 ä¸ªåŸå¸‚*æœç´¢æœ€å¥½çš„æŠ«è¨ã€‚æˆ‘ä»¬ä¼šå°†ç»“æœå­˜å‚¨åœ¨ Firestore ä¸­ã€‚ä¸ºäº†å¯è§†åŒ–æˆ‘ä»¬çš„æ•°æ®ï¼Œä¸€ä¸ªåµŒå…¥äº† Google åœ°å›¾çš„ç®€å•ç½‘é¡µæ˜¾ç¤ºäº†æ¯å®¶æŠ«è¨åº—çš„ pinã€‚**

## æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¦‚ä½•å·¥ä½œ

è¿™æ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„æ¶æ„å›¾:

![](img/efbb31a81f9d59eaa5b9385b66742f25.png)

äº‘ä»»åŠ¡|äº‘åŠŸèƒ½|åœ°å›¾ APIs |äº‘ Firestore

åœ¨å·¦è¾¹çš„**å’Œ**ä¸­ï¼Œæˆ‘ä»¬æœ‰æ’é˜Ÿ 13ï¼Œ000 ä¸ª HTTP è¯·æ±‚çš„äº‘ä»»åŠ¡ã€‚

> *ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦åœ¨è¿™é‡Œä½¿ç”¨äº‘ä»»åŠ¡ï¼Ÿä¹Ÿè®¸æˆ‘ä»¬æƒ³è¦*é™åˆ¶*å¯¹æˆ‘ä»¬ API çš„è°ƒç”¨ï¼Œæˆ–è€…èƒ½å¤Ÿ*æš‚åœå¯¹æˆ‘ä»¬ API çš„è¯·æ±‚*ï¼Œæˆ–è€…å¯¹äº*é‡å¤è¯·æ±‚*ä¸è°ƒç”¨ APIã€‚åœ¨è¿™é‡Œï¼Œ*é¢„è£…*æˆ‘ä»¬çš„ 13000 ä¸ª URL ç›®æ ‡æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚*
> 
> *è¿™ä¸ªç”¨ä¾‹éå¸¸é€‚åˆäº‘ä»»åŠ¡ã€‚*

åœ¨å›¾çš„**ä¸­å¿ƒ**ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª Google Cloud å‡½æ•°(ç”¨ Node ç¼–å†™)ã€‚è¿™ç§äº‘åŠŸèƒ½æ˜¯æˆ‘ä»¬å®ç°ä»¥ä¸‹ç›®æ ‡çš„ä¸­å¿ƒåˆ‡å…¥ç‚¹:

*   å‘ˆç° Google åœ°å›¾ Web ç”¨æˆ·ç•Œé¢çš„ Web æµè§ˆå™¨è¯·æ±‚
*   è·å– Google Maps API çš„ API è¯·æ±‚å°†æ•°æ®å­˜å‚¨åœ¨ Firestore ä¸­

> è¯¥åº”ç”¨ç¨‹åºç”±[èŠ‚ç‚¹åŠŸèƒ½æ¡†æ¶](https://github.com/GoogleCloudPlatform/functions-framework-nodejs)æä¾›æ”¯æŒï¼Œè¯¥æ¡†æ¶æ”¯æŒè°·æ­Œäº‘åŠŸèƒ½çš„æœ¬åœ°å¼€å‘ã€‚

åœ¨**å³ä¾§**ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨[åœ°å›¾åœ°ç†ç¼–ç  API](https://developers.google.com/maps/documentation/geocoding/intro) æ¥æŸ¥æ‰¾æˆ‘ä»¬æŸ¥è¯¢çš„çº¬åº¦/æ¶²åŒ–å¤©ç„¶æ°”ï¼Œä½¿ç”¨[åœ°å›¾åœ°ç‚¹æœç´¢ API](https://developers.google.com/places/web-service/search) æ¥æŸ¥æ‰¾çº¬åº¦/æ¶²åŒ–å¤©ç„¶æ°”é™„è¿‘æœ€å¥½çš„æ¯”è¨é¥¼é¤é¦†ã€‚ç»“æœå­˜å‚¨åœ¨ Firestore ä¸­(åœ¨**åº•éƒ¨**)ã€‚

# è®¾ç½®æˆ‘ä»¬çš„åº”ç”¨ç¨‹åº

é¦–å…ˆï¼Œä¸€äº›è®¾ç½®ã€‚æˆ‘ä»¬çš„æ¼”ç¤ºå±•ç¤ºäº†ä¸€ä¸ªç«¯åˆ°ç«¯çš„**åº”ç”¨*ï¼Œå®ƒä»è°·æ­Œåœ°å›¾æ”¶é›†æ•°æ®ï¼Œå­˜å‚¨åœ¨ Firestore ä¸­ï¼Œå¹¶ä½¿ç”¨å…·æœ‰äº‘åŠŸèƒ½çš„å…¬å…± URL æ˜¾ç¤ºæ•°æ®ã€‚æˆ‘ä»¬éœ€è¦è®¾ç½®å­˜å‚¨å’Œè®¡ç®—ã€‚è¿™ç›¸å½“ç®€å•ï¼Œä½†éœ€è¦å‡ åˆ†é’Ÿã€‚*

## *ä¸‹è½½åº”ç”¨ç¨‹åºçš„ä»£ç *

*å…‹éš†å›è´­ã€github.com/GoogleCloudPlatform/cloud-tasks-pizza-map :*

*`git clone [git@github.com](mailto:git@github.com):GoogleCloudPlatform/cloud-tasks-pizza-map.git`*

## *å¯ç”¨ Google APIs*

*æˆ‘ä»¬å¯ä»¥ä½¿ç”¨[è¿™ä¸ªç‰¹æ®Šé“¾æ¥](https://console.cloud.google.com/flows/enableapi?apiid=cloudtasks.googleapis.com,firestore.googleapis.com,places-backend.googleapis.com,static-maps-backend.googleapis.com,geocoding-backend.googleapis.com)æ¥å¯ç”¨æˆ‘ä»¬é¡¹ç›®çš„æ‰€æœ‰ API:*

*   *`Cloud Tasks API`:å…·æœ‰é‡å¤æ•°æ®åˆ é™¤ã€æ’­æ”¾/æš‚åœã€é‡è¯•ç­‰é…ç½®çš„é˜Ÿåˆ—*
*   *`Maps Places API`:å¯»æ‰¾æŠ«è¨åº—*
*   *`Maps Geocoding API`:æŸ¥æ‰¾ç»™å®šâ€œåœ°ç‚¹ idâ€çš„é¤é¦†çš„ lat/lng*
*   *`Firestore API`:å­˜å‚¨æ•°æ®*

## ***å»ºç«‹æ•°æ®åº“***

*[å»ºç«‹ä¸€ä¸ª Firestore æ•°æ®åº“](https://firebase.google.com/docs/firestore/quickstart#create)ï¼Œç”¨äºå­˜å‚¨æˆ‘ä»¬çš„ Google Maps API æ•°æ®ï¼Œé…ç½®å¦‚ä¸‹:*

*   *æ¨¡å¼:`Test mode`*
*   *æ”¶è—:`tasks-pizza`*

## *åˆ›å»ºä¸€ä¸ªè°·æ­Œåœ°å›¾ API å¯†é’¥*

*åœ¨æ­¤å¤„ä¸ºåœ°å›¾åˆ›å»º API å¯†é’¥:*

*[![](img/fd40eab143637306e6cccacd7936c65c.png)](https://cloud.google.com/maps-platform/#get-started)

ç‚¹å‡»æ­¤æŒ‰é’®åˆ›å»º API å¯†é’¥ã€‚([é“¾æ¥](https://developers.google.com/maps/documentation/geocoding/start#auth))* 

*å°†å¯†é’¥ä¿å­˜åœ¨å¦‚ä¸‹æ‰€ç¤ºçš„`.env`æ–‡ä»¶ä¸­:*

```
*KEY=AIzaSyDh7gKIvLzFA0q_ICfkO8ryvEMm3Nrde-c*
```

# *æœ¬åœ°è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åº*

*è¦åœ¨æœ¬åœ°æµ‹è¯•æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼Œè¯·ä½¿ç”¨ä¸Šä¸€æ­¥ä¸­çš„`KEY`éµå¾ªè¿™äº›è¯´æ˜:*

```
*npm i
KEY=... npm start*
```

*æˆ‘ä»¬å°†çœ‹åˆ° CLI è¾“å‡ºå…³äºæˆ‘ä»¬åº”ç”¨ç¨‹åºçš„æœ‰ç”¨ä¿¡æ¯:*

```
*> tasks-pizza@1.0.0 start /github/GoogleCloudPlatform/cloud-tasks-pizza-map
> FUNCTION_SOURCE=src npx [@google](http://twitter.com/google)-cloud/functions-frameworkServing function...
Function: function
URL: [http://localhost:8080/](http://localhost:8080/)*
```

*åœ¨`localhost:8080`ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„è·¯çº¿(æˆ‘åœ¨è¿™é‡Œåšäº†æ³¨é‡Š):*

```
*[
  "/tasks/start", // starts creating all Cloud Tasks
  "/tasks/listnames", // lists Tasks names
  "/maps/add", // adds restaurant data to the database
  "/maps/get", // gets restaurant data
  "/maps/listnames", // lists names of cities from a gist
  "/maps/key", // prints the GMP API key for the front-end
  "/target", // our Cloud Tasks target (same as /maps/add)
  "/web" // our web UI for displaying our map
]*
```

*ä½ åœ¨æœ¬åœ°è¿è¡Œè°·æ­Œäº‘åŠŸèƒ½ï¼å¤ªå¥½äº†ï¼ç°åœ¨æˆ‘ä»¬å¦‚ä½•è®©è¿™äº›å¤§å¤´é’ˆå‡ºç°åœ¨åœ°å›¾ä¸Šï¼ŸğŸ¤”*

*è¿™é‡Œæœ‰ä¸€äº›è¿è¡Œæ¼”ç¤ºçš„æ“ä½œé¡ºåº:*

*   ***é€šè¿‡è¿è¡Œ`/tasks/start`åŠ è½½äº‘ä»»åŠ¡é˜Ÿåˆ—**ã€‚è¿™å°†éœ€è¦å‡ åˆ†é’Ÿçš„æ—¶é—´ï¼Œå› ä¸ºå®ƒä¼šä¸ºä¸–ç•Œä¸Šçš„æ¯ä¸ªåŸå¸‚åˆ›å»ºå¤§çº¦ 13ï¼Œ000 ä¸ªç‹¬ç‰¹çš„ä»»åŠ¡ã€‚*
*   *é€šè¿‡è½¬åˆ°[https://console.cloud.google.com/cloudtasks](https://console.cloud.google.com/cloudtasks)ï¼Œç¡®ä¿äº‘ä»»åŠ¡**é˜Ÿåˆ—æœªæŒ‚èµ·**ã€‚å–æ¶ˆæ’é˜Ÿå°†å¡«å……æˆ‘ä»¬çš„ Firestore æ•°æ®åº“ã€‚*
*   ***åœ¨`localhost:8080/web`æ‰“å¼€æˆ‘ä»¬çš„å‰ç«¯**æ¥å¯è§†åŒ–æˆ‘ä»¬æ•°æ®åº“ä¸­çš„æ•°æ®ã€‚*

## *æµ‹è¯•æˆ‘ä»¬çš„åº”ç”¨*

*åœ¨`/web`ï¼Œå½“å‰ç«¯ UI è¯»å–æˆ‘ä»¬çš„æ•°æ®åº“è®°å½•æ—¶ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¼•è„šä¸‹é™ã€‚*

*![](img/f39503e427a49fe5008e5ff255d67b31.png)*

*å½“æˆ‘ä»¬çš„å‰ç«¯åŠ è½½æˆ‘ä»¬çš„ç»“æœæ—¶ï¼Œå¼•è„šæ‰è½ã€‚æ¯æ ¹é’ˆéƒ½æ˜¯çœŸå®çš„ğŸ•é¤å…ã€‚*

> *æ³¨æ„:æˆ‘ä»¬æ•…æ„é™ä½å‰ç«¯é€Ÿåº¦æ¥åˆ¶ä½œè¿™ä¸ªåŠ¨ç”»ï¼Œå®ƒéœ€è¦ 20 åˆ†é’Ÿæ¥åŠ è½½æ‰€æœ‰çš„ 13k ç®¡è„šã€‚*

*ä¾‹å¦‚ï¼Œåœ¨æ›¼å“ˆé¡¿ä¸­åŸï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåˆ°ä¹”æ°æ¯”è¨åº—çš„é“¾æ¥ï¼Œå¤§çº¦æœ‰ 7k ä¸ªè¯„åˆ†ï¼Œå¹³å‡ä¸º 4.5 â­s.*

*![](img/1e9d869be00faa81f620cc5ca8d9fbe3.png)*

*çº½çº¦æ›¼å“ˆé¡¿ä¸­åŸçš„ä¹”æ°æŠ«è¨åº—ã€‚*

*é‚£äº›çœ‹èµ·æ¥åœ¨æµ·æ´‹é‡Œçš„å¤§å¤´é’ˆä¸æ˜¯é”™è¯¯ã€‚ä¸–ç•Œä¸Šæœ‰å¾ˆå¤šåƒæŠ«è¨çš„å²›å±¿:*

*![](img/3bd3ccf7e4dc5f7df338a68f739d8fc5.png)*

*ä½›å¾—è§’(4.3 â­s)çš„ Boa Pizza æŠ«è¨åº—ä¼šæ ¹æ®è¦æ±‚é€åˆ°æµ·æ»©ã€‚ä¹Ÿæ˜¯â€œå¯¹å­©å­å¥½â€ã€‚*

*æˆ‘å·²ç»ç”¨è¿™ä¸ªåº”ç”¨ç¨‹åºåœ¨è°·æ­Œåœ°å›¾ä¸Šæ¢ç´¢äº†å‡ ä¸ªå°æ—¶çš„æ¯”è¨é¥¼ä¸–ç•Œï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä¸€æ•´ç¯‡æ–‡ç« ä¸­è°ˆè®ºæœ€ç‹¬ç‰¹çš„æ¯”è¨é¥¼é¤é¦†ã€‚ä½†æ˜¯è®©æˆ‘ä»¬å›åˆ°å¼€å‘æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚*

# *éƒ¨ç½²æˆ‘ä»¬çš„åº”ç”¨ç¨‹åº*

*å…³äºæˆ‘ä»¬çš„æ¼”ç¤ºï¼Œå¾ˆæ£’çš„ä¸€ç‚¹æ˜¯ï¼Œå°†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ä¸éœ€è¦ç‰¹æ®Šçš„é…ç½®ã€‚*

*å¾ˆå®¹æ˜“æ”¹å˜æˆ‘ä»¬çš„æ¼”ç¤ºï¼Œä½¿æˆ‘ä»¬ä¸ä½¿ç”¨`localhost`ï¼Œè€Œæ˜¯åœ¨è°·æ­Œäº‘ä¸Šä½¿ç”¨ä¸€ä¸ªçœŸæ­£çš„`https` URLã€‚*

*æˆ‘ä»¬å¯ä»¥ç®€å•åœ°è¿è¡Œ`npm run deploy`ï¼Œå®ƒå®é™…ä¸Šè¿è¡Œè¿™ä¸ªå‘½ä»¤:*

```
*gcloud functions deploy tasks-pizza
  \ --trigger-http
  \ --runtime=nodejs10
  \ --env-vars-file=.env.yaml*
```

*å¤§çº¦ 30 ç§’åï¼Œæ‚¨å°†ä¼šçœ‹åˆ°ä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„å…¬å…± URL:*

```
*https://us-central1-my-project.cloudfunctions.net/tasks-pizza*
```

> *æ³¨æ„:é‚£ä¸æ˜¯ä¸€ä¸ªçœŸå®çš„ URLã€‚*

## *æ„Ÿè°¢é˜…è¯»*

*å¦‚æœä½ å–œæ¬¢è¿™ç¯‡åšå®¢ï¼Œçœ‹çœ‹è¿™äº›èµ„æº:*

*   *ğŸ’»æ¥æº:github.com/GoogleCloudPlatform/cloud-tasks-pizza-map*
*   *ğŸŒä¸–ç•ŒåŸå¸‚æ•°æ®:ã€simplemaps.com/data/world-cities *
*   *ğŸ”§èŒèƒ½æ¡†æ¶:ã€github.com/GoogleCloudPlatform/functions-framework-nodejs *

*å¤šäºäº†è¿™ä¸ªåº”ç”¨ç¨‹åºï¼Œæˆ‘æ‰ä¸ä¼šæŒ¨é¥¿ğŸ˜‹ğŸ•*