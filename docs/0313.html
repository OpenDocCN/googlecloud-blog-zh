<html>
<head>
<title>GCR.io Tips &amp; Tricks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCR.io提示和技巧</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcr-io-tips-tricks-d80b3c67cb64?source=collection_archive---------1-----------------------#2017-06-14">https://medium.com/google-cloud/gcr-io-tips-tricks-d80b3c67cb64?source=collection_archive---------1-----------------------#2017-06-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/11aec756c71d0f3790be7d6a8f968e61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BRLjh8s4naNpt8nlynoDnA.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">图片来源:塞缪尔·泽勒</figcaption></figure><div class=""/><p id="607d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae js" href="http://gcr.io/" rel="noopener ugc nofollow" target="_blank"> Google Container Registry </a>可能是最容易使用的容器图像存储解决方案。我想分享一些我在过去几个月里发现的技巧和诀窍:</p><h1 id="c7bc" class="jt ju hx bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">GCR 101大楼</h1><p id="ee9f" class="pw-post-body-paragraph iu iv hx iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">GCR是谷歌云平台的私有Docker图像注册服务。它与<a class="ae js" href="https://cloud.google.com/container-engine/" rel="noopener ugc nofollow" target="_blank"> Google容器引擎</a>集群和Google计算引擎实例一起工作，开箱即用，无需设置任何身份验证。每个谷歌云项目都有一个名为<code class="du kw kx ky kz b">gcr.io/{PROJECT_ID}</code>的注册表。您可以拉/推至GCR，如下所示:</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="3433" class="li ju hx kz b fi lj lk l ll lm">docker build -t gcr.io/{PROJECT_ID}/{image}:tag</span><span id="d341" class="li ju hx kz b fi ln lk l ll lm">gcloud docker -- push gcr.io/{PROJECT_ID}/{image}:tag</span><span id="ef44" class="li ju hx kz b fi ln lk l ll lm">gcloud docker -- pull gcr.io/{PROJECT_ID}/{image}:tag</span></pre><p id="e53b" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这是使用GCR应该知道的全部内容，这就是它的美妙之处。</p><h1 id="2238" class="jt ju hx bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">无gcloud的推/拉</h1><p id="03d3" class="pw-post-body-paragraph iu iv hx iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">如果您想避免使用<code class="du kw kx ky kz b">gcloud docker --</code>前缀，而只是使用docker CLI进行推/拉，您可以运行以下命令，这将为您提供对GCR的短期访问:</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="8a9f" class="li ju hx kz b fi lj lk l ll lm">gcloud docker -a</span></pre><p id="a585" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后你可以做一个:</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="657b" class="li ju hx kz b fi lj lk l ll lm">docker [push/pull] gcr.io/{PROJECT_ID}/{image}:tag</span></pre><p id="be49" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">像往常一样直接使用docker CLI。</p><h1 id="6eea" class="jt ju hx bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">无停靠站的构建/推送</h1><p id="da81" class="pw-post-body-paragraph iu iv hx iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">如果你的机器上没有安装Docker怎么办？gcloud仍然允许你(在云上)构建映像并自动推送到GCR。如果有docker文件，可以直接构建/推送，不需要docker:</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="89b7" class="li ju hx kz b fi lj lk l ll lm">gcloud container builds submit -t gcr.io/{PROJECT_ID}/{image}:tag .</span></pre><p id="d40a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">当您运行它时，源代码被压缩成一个tar文件，上传到GCS bucket，然后<a class="ae js" href="https://cloud.google.com/container-builder/docs/" rel="noopener ugc nofollow" target="_blank">云容器构建器</a>构建它，并将结果映像推送到GCR。我之前在博客上讨论过这件事。</p><h1 id="246b" class="jt ju hx bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">列出/搜索图像</h1><p id="bae5" class="pw-post-body-paragraph iu iv hx iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">您可以使用以下命令列出注册表中的所有容器图像:</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="6179" class="li ju hx kz b fi lj lk l ll lm">gcloud container images list</span></pre><p id="b55b" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">该命令仅显示最后几幅图像。所以试着加上<code class="du kw kx ky kz b">--limit=99999</code>来获得一个更长的列表。</p><p id="548b" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">或者使用关键字搜索，如:</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="c3af" class="li ju hx kz b fi lj lk l ll lm">gcloud container images list --filter=blog</span></pre><p id="2629" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">此命令也可用于列出公共注册表中的图像:</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="9e25" class="li ju hx kz b fi lj lk l ll lm">gcloud container images list --repository=gcr.io/google-containers</span></pre><p id="acb1" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">对于公共注册中心，您也可以直接使用“docker搜索”:</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="7ae7" class="li ju hx kz b fi lj lk l ll lm">docker search gcr.io/google-containers/kube</span></pre><h1 id="7165" class="jt ju hx bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">创建公共注册中心</h1><p id="96eb" class="pw-post-body-paragraph iu iv hx iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">你可以在GCR上方便地向公众公开你的整个集装箱注册。由于GCR目前是建立在<a class="ae js" href="https://cloud.google.com/storage/" rel="noopener ugc nofollow" target="_blank">谷歌云存储(GCS) </a>之上的，运行几个命令使存储桶公开可读就是你所需要的:</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="0ac4" class="li ju hx kz b fi lj lk l ll lm">gsutil defacl ch -u AllUsers:R gs://artifacts.{PROJECT_ID}.appspot.com</span><span id="ad3b" class="li ju hx kz b fi ln lk l ll lm">gsutil acl ch -r -u AllUsers:R gs://artifacts.{PROJECT_ID}.appspot.com</span><span id="39b9" class="li ju hx kz b fi ln lk l ll lm">gsutil acl ch -u AllUsers:R gs://artifacts.{PROJECT_ID}.appspot.com</span></pre><p id="7f42" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">第一个命令更新默认权限，使将来的对象对公众可读。第二个命令使现有对象公开可读，第三个命令使bucket本身公开可读。这里的<a class="ae js" href="https://cloud.google.com/container-registry/docs/access-control" rel="noopener ugc nofollow" target="_blank">记录了这一点</a>。</p><blockquote class="lo lp lq"><p id="3004" class="iu iv lr iw b ix iy iz ja jb jc jd je ls jg jh ji lt jk jl jm lu jo jp jq jr hb bi translated"><em class="hx">注意:当其他人从你的公共注册表中提取图片时，你将支付出口网络费用。</em></p></blockquote><p id="c787" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">目前，据我所知，没有办法保持注册表默认为私有，并使个别图像公开。</p><h1 id="8360" class="jt ju hx bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">更快地从码头中心拉货</h1><p id="bcc1" class="pw-post-body-paragraph iu iv hx iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">GCR为Docker Hub提供了一个托管的<a class="ae js" href="https://docs.docker.com/registry/recipes/mirror/" rel="noopener ugc nofollow" target="_blank">注册表镜像</a>。如果你<a class="ae js" href="https://cloud.google.com/container-registry/docs/using-dockerhub-mirroring" rel="noopener ugc nofollow" target="_blank">配置</a>你的Docker引擎使用<code class="du kw kx ky kz b">mirror.gcr.io</code>和<code class="du kw kx ky kz b">--registry-mirror</code>，你就可以通过这个镜像获取Docker Hub镜像。它速度更快，而且您可以将自己与Docker Hub中断隔离得更远。</p><p id="9960" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">直接从mirror.gcr.io提取图像<strong class="iw hy">不是受支持的用例</strong>，但是您仍然可以:</p><ol class=""><li id="508a" class="lv lw hx iw b ix iy jb jc jf lx jj ly jn lz jr ma mb mc md bi translated">该图像必须是Docker Hub(如库/节点)上的<a class="ae js" href="https://hub.docker.com/explore/" rel="noopener ugc nofollow" target="_blank">官方图像</a>之一</li><li id="11e7" class="lv lw hx iw b ix me jb mf jf mg jj mh jn mi jr ma mb mc md bi translated">您只能拉出“:最新”标签。</li></ol><p id="10e6" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">示例:</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="b717" class="li ju hx kz b fi lj lk l ll lm">docker pull mirror.gcr.io/library/node</span></pre><p id="f1f3" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您可以通过以下方式找到支持的图像列表:</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="0197" class="li ju hx kz b fi lj lk l ll lm">gcloud container images list --repository=mirror.gcr.io/library</span></pre><h1 id="70c9" class="jt ju hx bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">找出注册表的总大小</h1><p id="7ee9" class="pw-post-body-paragraph iu iv hx iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">同样，由于GCR目前使用GCS进行存储，您可以看到存储容量。</p><p id="57e9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">你可以用它来计算你的图片占用了多少存储空间。运行:</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="bb5f" class="li ju hx kz b fi lj lk l ll lm">$ gsutil du -hs gs://artifacts.{PROJECT_ID}.appspot.com<br/>781.16 MiB gs://artifacts.ahmet-blog.appspot.com</span></pre><p id="2b79" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">由于docker-registry将所有图像层存储在一个单一的平面目录中，因此不容易找出特定图像的所有标签使用的总存储空间。你必须写代码来做到这一点。但是你可以在谷歌云平台控制台→容器注册部分找到每个标签的图片大小。</p><h1 id="2370" class="jt ju hx bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">清理旧图像</h1><p id="e287" class="pw-post-body-paragraph iu iv hx iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">当您的持续集成管道每天都在构建和推送数十个映像时，过一段时间后，您将最终拥有大量映像。如果不再需要超过一段时间的容器图像，可以在脚本的帮助下删除它们。</p><p id="2ef8" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">要查询某个日期之前推送的图像(例如，下面的2017–04–01):</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="7659" class="li ju hx kz b fi lj lk l ll lm">gcloud container images list-tags gcr.io/PROJECT/image \<br/>  --limit=999999 --sort-by=TIMESTAMP \<br/>  --filter="timestamp.datetime &amp;lt; '2017-04-01'" \<br/>  --format='get(digest)'</span></pre><p id="e62a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后，您可以使用jq命令从JSON中提取图像摘要，然后使用一个简单的for循环将它传递给gcloud命令进行删除:</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="139d" class="li ju hx kz b fi lj lk l ll lm">IMAGE=gcr.io/ahmetb-starter/coffeedirectory<br/>DELETE_BEFORE=2017-04-01</span><span id="5237" class="li ju hx kz b fi ln lk l ll lm">for digest in $(gcloud container images list-tags \<br/>  gcr.io/ahmetb-starter/coffeedirectory --limit=999999 \<br/>  --sort-by=TIMESTAMP \<br/>  --filter="timestamp.datetime &lt; '${DELETE_BEFORE}'" \<br/>  --format='get(digest)'; do<br/>    gcloud container images delete -q --force-delete-tags\<br/>      "${IMAGE}@${digest}"<br/>done</span></pre><p id="086a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我创建了一个更好的版本(带有适当的错误检查等)<a class="ae js" href="https://gist.github.com/ahmetb/7ce6d741bd5baa194a3fac6b1fec8bb7" rel="noopener ugc nofollow" target="_blank">作为脚本</a>您可以直接下载和使用:</p><p id="e54c" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae js" href="https://gist.github.com/ahmetb/7ce6d741bd5baa194a3fac6b1fec8bb7" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/ahmetb/7 ce 6d 741 BD 5b aa 194 a3 fac 6 B1 FEC 8 bb 7</a></p><h1 id="c1f9" class="jt ju hx bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">了解更多信息</h1><p id="ef74" class="pw-post-body-paragraph iu iv hx iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">我希望你喜欢这些建议。如果你有更多，请在评论中告诉我或发邮件给我，我会在这里补充。如果您有兴趣了解更多信息，请查看GCR的文档和T2的云容器构建器。</p><p id="b271" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="lr">免责声明:我在谷歌云工作，但不从事容器注册产品。</em></p></div><div class="ab cl mj mk gp ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="hb hc hd he hf"><p id="b5e8" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="lr">最初发布于</em><a class="ae js" href="https://ahmet.im/blog/google-container-registry-tips/" rel="noopener ugc nofollow" target="_blank"><em class="lr">Ahmet . im</em></a><em class="lr">。如果你喜欢这篇文章，你可以在推特</em> <a class="ae js" href="https://twitter.com/ahmetb" rel="noopener ugc nofollow" target="_blank"> <em class="lr">上关注我</em> </a> <em class="lr">或者</em> <a class="ae js" href="https://feedburner.google.com/fb/a/mailverify?uri=ahmet-alp-balkan" rel="noopener ugc nofollow" target="_blank"> <em class="lr">通过电子邮件</em> </a> <em class="lr">订阅我的博客(不超过一篇文章/月)。</em></p></div></div>    
</body>
</html>