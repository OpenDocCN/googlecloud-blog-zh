<html>
<head>
<title>Istio 101 (1.0) on GKE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GKE的Istio 101 (1.0)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/istio-101-1-0-on-gke-c4ece1067709?source=collection_archive---------1-----------------------#2018-08-06">https://medium.com/google-cloud/istio-101-1-0-on-gke-c4ece1067709?source=collection_archive---------1-----------------------#2018-08-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9697" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Istio 1.0终于<a class="ae jd" href="https://istio.io/blog/2018/announcing-1.0/" rel="noopener ugc nofollow" target="_blank">公布</a>！在这篇文章中，我用Istio 1.0的具体说明更新了<a class="ae jd" href="https://meteatamel.wordpress.com/2018/06/07/istio-101-0-8-0-on-gke/" rel="noopener ugc nofollow" target="_blank">我之前的Istio 101文章</a>。大多数指令是相同的，但是在内容的位置上有一些小的不同(文件夹名/位置改变了),而且大多数命令现在默认为kubectl而不是istioctl。</p><p id="8fff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于那些没有读过我的Istio 101帖子的人，我展示了如何在谷歌Kubernetes引擎(GKE)上安装Istio 1.0，部署样例BookInfo应用程序，并展示了一些附加组件和流量路由。</p><h1 id="b8c8" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">创建Kubernetes集群</h1><p id="c919" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">首先，我们需要一个Kubernetes集群来安装Istio。在GKE，这是一个简单的命令:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="1388" class="kq jf hi km b fi kr ks l kt ku">gcloud container clusters create hello-istio \ --cluster-version=latest \ --zone europe-west1-b \ --num-nodes 4</span></pre><p id="9893" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用4个工作节点。这是BookInfo示例的推荐节点数。</p><p id="90a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦创建了集群，我们还需要为Istio创建一个<em class="kv">集群角色绑定</em>，以便能够管理集群:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="227b" class="kq jf hi km b fi kr ks l kt ku">kubectl create clusterrolebinding cluster-admin-binding \ --clusterrole=cluster-admin \ --user=$(gcloud config get-value core/account)</span></pre><h1 id="382d" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">下载和设置Istio</h1><p id="ae81" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在我们有了一个集群，让我们下载最新的Istio(从今天起是1.0.0):</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="47ac" class="kq jf hi km b fi kr ks l kt ku">curl -L <a class="ae jd" href="https://git.io/getLatestIstio" rel="noopener ugc nofollow" target="_blank">https://git.io/getLatestIstio</a> | ISTIO_VERSION=1.0.0 sh -</span></pre><p id="c705" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将Istio的命令行工具<em class="kv"> istioctl </em>添加到您的路径中。我们以后会用到它:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="09cd" class="kq jf hi km b fi kr ks l kt ku">export PATH="$PATH:./istio-1.0.0/bin"</span></pre><h1 id="6852" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">安装Istio</h1><p id="9cb1" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">是时候在边车之间安装带相互认证的Istio了:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="3647" class="kq jf hi km b fi kr ks l kt ku">kubectl apply -f install/kubernetes/istio-demo-auth.yaml</span></pre><p id="36c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成后，您可以检查pods是否在istio-system名称空间下运行:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="3273" class="kq jf hi km b fi kr ks l kt ku">kubectl get pods -n istio-system</span></pre><p id="bd7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你会发现，除了Istio基本组件(例如，导频、混音器、入口、出口)，还安装了许多附加组件(例如，prometheus、servicegraph、grafana)。这与之前的Istio版本不同。</p><h1 id="257b" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">启用边车注射</h1><p id="e8d4" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">当我们配置和运行服务时，Envoy sidecars可以自动注入到服务的每个pod中。为此，我们需要为我们将用于微服务的名称空间启用sidecar注入(“默认”)。我们通过贴标签来做到这一点:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="9531" class="kq jf hi km b fi kr ks l kt ku">kubectl label namespace default istio-injection=enabled</span></pre><p id="1554" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并验证标签已成功贴上:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a939" class="kq jf hi km b fi kr ks l kt ku">kubectl get namespace -L istio-injection</span></pre><h1 id="1f57" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">部署BookInfo应用程序</h1><p id="5dec" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在让我们部署BookInfo示例应用程序:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="350a" class="kq jf hi km b fi kr ks l kt ku">kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml</span></pre><p id="1301" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保所有的舱都在运行。请注意，每个服务有2个pods个实际服务和1个边车):</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="0ff8" class="kq jf hi km b fi kr ks l kt ku">kubectl get pods</span></pre><h1 id="2d9c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">部署BookInfo网关</h1><p id="827b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在Istio 1.0.0中，您需要为入口流量创建一个网关。让我们继续为BookInfo应用程序创建一个网关:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="3941" class="kq jf hi km b fi kr ks l kt ku">kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml</span></pre><h1 id="4154" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">使用BookInfo应用程序</h1><p id="43cb" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我们终于可以看看这个应用了。我们需要找到入口网关IP和端口:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="2d5f" class="kq jf hi km b fi kr ks l kt ku">kubectl get svc istio-ingressgateway -n istio-system</span></pre><p id="75ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了方便起见，让我们定义一个<em class="kv"> GATEWAY_URL </em>变量:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a3c0" class="kq jf hi km b fi kr ks l kt ku">export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}') export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].port}') export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT</span></pre><p id="5041" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看这个应用程序是否有效。用curl你应该得到200:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="4698" class="kq jf hi km b fi kr ks l kt ku">curl -o /dev/null -s -w "%{http_code}\n" <a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/${GATEWAY_URL}/productpage">http://${GATEWAY_URL}/productpage</a></span></pre><p id="71d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您也可以打开浏览器，查看产品页面的web前端。此时，我们已经通过Istio的基本安装部署和管理了应用程序。</p><p id="88ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将看看一些附加组件。与以前的版本不同，附加组件已经自动安装。让我们先开始发送一些流量:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a3d0" class="kq jf hi km b fi kr ks l kt ku">for i in {1..100}; do curl -o /dev/null -s -w "%{http_code}\n" <a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/${GATEWAY_URL}/productpage;">http://${GATEWAY_URL}/productpage;</a> done</span></pre><h1 id="0733" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">Grafana仪表板</h1><p id="d968" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这是格拉法纳的仪表板。让我们先设置端口转发:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="2855" class="kq jf hi km b fi kr ks l kt ku">kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=grafana -o jsonpath='{.items[0].metadata.name}') 8080:3000</span></pre><p id="1d42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导航到<a class="ae jd" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>查看仪表板:</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/9074f3d96386bd64acc32a0bced82e0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CrG23EoQfeaHTxf0"/></div></div></figure><h1 id="a219" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">普罗米修斯矩阵</h1><p id="0797" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">接下来，让我们看看普罗米修斯的度量标准。设置端口转发:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="d39c" class="kq jf hi km b fi kr ks l kt ku">kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=prometheus -o jsonpath='{.items[0].metadata.name}') 8083:9090</span></pre><p id="f8e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导航到<a class="ae jd" href="http://localhost:8083/graph" rel="noopener ugc nofollow" target="_blank">http://localhost:8083/graph</a>看普罗米修斯:</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/f420086dac52cdb4b2ec607a81a29315.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4jhFDLs67tvEkSiS"/></div></div></figure><h1 id="f482" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">服务图表</h1><p id="0562" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">对于依赖关系的可视化，我们可以看看ServiceGraph:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="5b20" class="kq jf hi km b fi kr ks l kt ku">kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=servicegraph -o jsonpath='{.items[0].metadata.name}') 8082:8088</span></pre><p id="44f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导航到<a class="ae jd" href="http://localhost:8082/dotviz" rel="noopener ugc nofollow" target="_blank">http://localhost:8082/dot viz</a>:</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/6fdf7e3b5fc3bc07668dd64e71772f91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7--p9w3c0qSTf1hM"/></div></div></figure><h1 id="0fc2" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">描摹</h1><p id="b399" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">对于HTTP追踪，有Jaegar和Zipkin。让我们来看看耶格。照常设置端口转发:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="e76c" class="kq jf hi km b fi kr ks l kt ku">kubectl port-forward -n istio-system $(kubectl get pod -n istio-system -l app=jaeger -o jsonpath='{.items[0].metadata.name}') 8084:16686</span></pre><p id="1c80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导航到<a class="ae jd" href="http://localhost:8084/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8084 </a></p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/11f1f2445453845af0aae91ca7f0d325.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Z7SjmUVJ036IjpMa"/></div></div></figure><h1 id="b6b6" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">交通管理</h1><p id="a497" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在使用Istio控制Bookinfo版本路由之前，您需要在目标规则中定义可用的版本，称为子集。运行以下命令为Bookinfo服务创建默认目标规则:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="509c" class="kq jf hi km b fi kr ks l kt ku">kubectl apply -f samples/bookinfo/networking/destination-rule-all-mtls.yaml</span></pre><p id="43a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以看到现有的虚拟服务和目标规则，如下所示:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="63b5" class="kq jf hi km b fi kr ks l kt ku">kubectl get virtualservices -o yaml kubectl get destinationrules -o yaml</span></pre><p id="d9a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当你进入BookInfo应用的产品页面，做几次浏览器刷新，你会看到右边的评论部分一直在变(星星变颜色)。这是因为有3个不同的审查微服务，每次都调用不同的微服务。让我们将所有微服务绑定到版本1:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="fcba" class="kq jf hi km b fi kr ks l kt ku">kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span></pre><p id="b7a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将创建将所有微服务固定到版本1所需的虚拟服务和目标规则。现在，如果您返回到产品页面并刷新浏览器，什么都不会改变，因为评论微服务现在被固定到版本1。</p><p id="f17e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要将特定用户(例如Jason)固定到特定版本(v2)，我们可以执行以下操作:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="6840" class="kq jf hi km b fi kr ks l kt ku">kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml</span></pre><p id="822c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据此规则，如果您使用用户名“Jason”登录产品页面，您应该会看到评论微服务的v2版本。</p><p id="8e4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要清理所有目的地规则，请运行以下命令，现在我们从3个不同版本的微服务开始:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="06bb" class="kq jf hi km b fi kr ks l kt ku">kubectl delete -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span></pre><h1 id="e544" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">清除</h1><p id="dfdc" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这包含了我想在GKE上展示的Istio 1.0.0的所有基本功能。为了清理，我们先删除BookInfo应用程序:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a4aa" class="kq jf hi km b fi kr ks l kt ku">kubectl delete -f samples/bookinfo/networking/bookinfo-gateway.yaml kubectl delete -f samples/bookinfo/platform/kube/bookinfo.yaml</span></pre><p id="c1ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确认BookInfo应用程序已删除:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="ddab" class="kq jf hi km b fi kr ks l kt ku">kubectl get gateway <br/>kubectl get virtualservices <br/>kubectl get pods</span></pre><p id="7c34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，清理Istio:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="3dfb" class="kq jf hi km b fi kr ks l kt ku">kubectl delete -f install/kubernetes/istio-demo.yaml</span></pre><p id="ab81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确认Istio已离开:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="0d80" class="kq jf hi km b fi kr ks l kt ku">kubectl get pods -n istio-system</span></pre></div><div class="ab cl le lf gp lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="hb hc hd he hf"><p id="19a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kv">原载于2018年8月6日</em><a class="ae jd" href="https://meteatamel.wordpress.com/2018/08/06/istio-101-1-0-on-gke/" rel="noopener ugc nofollow" target="_blank"><em class="kv">meteatamel.wordpress.com</em></a><em class="kv">。</em></p></div></div>    
</body>
</html>