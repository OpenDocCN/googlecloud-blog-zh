<html>
<head>
<title>Proactive Network Monitoring with GCP Network Analyzer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GCP网络分析仪进行主动网络监控</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/proactive-network-monitoring-with-gcp-network-analyzer-94c5be824e06?source=collection_archive---------0-----------------------#2022-12-17">https://medium.com/google-cloud/proactive-network-monitoring-with-gcp-network-analyzer-94c5be824e06?source=collection_archive---------0-----------------------#2022-12-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4331" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主动网络健康管理计划对于所有云部署和业务流程都至关重要。尽管云计算功能强大且动态，但当客户无意中部署次优或易出错的网络配置时，他们有时会感到复杂。例如，组织可能会实施一些更改，从而在不知不觉中引入错误配置、违反最佳实践、超过IP地址利用率配额，或者低效地分配IP地址。在某些情况下，它甚至可能导致服务中断。让组织的内部或外部用户无法使用该服务可能会对其业务和声誉造成灾难性的影响。在服务中断后，团队通常求助于反应式工作流来排查和解决此类问题，即手动运行耗时的诊断。</p><p id="8ea4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实现主动网络健康管理的一种方法是使用网络监控工具。这些工具可以持续监控网络中的问题，例如高网络使用率、低带宽和延迟问题。他们还可以提醒IT人员注意潜在的问题，以便在造成中断之前解决这些问题。</p><p id="3b1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主动网络健康管理的另一个重要方面是实施网络配置和管理的最佳实践。这可能包括遵循IP地址分配的指导原则，确保安全协议到位并保持最新，以及定期测试和更新网络配置以确保最佳性能。</p><p id="0924" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主动网络健康管理还包括实施持续网络维护和优化流程。这可能包括定期系统更新、性能调整以及使用分析工具来识别和解决网络瓶颈。</p><p id="9a3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">总体而言，主动网络健康管理对于确保云部署的稳定性和可靠性以及防止代价高昂的服务中断至关重要。通过持续监控和优化网络，组织可以最大限度地降低中断风险，并为其用户保持高水平的性能。</p><p id="dbca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌云平台(GCP)上的网络智能中心的网络分析器模块帮助您在网络问题导致服务中断之前主动识别和修复网络问题。这项功能在Google Cloud Next’22上正式推出，包括一系列分析器，可以检测和预测潜在的网络问题，并将其作为洞察呈现出来。使用Network Analyzer，您可以设置警报来接收有关网络中任何错误配置的即时通知。</p><p id="8932" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将探讨Network Analyzer提供的不同见解，以及如何为它们配置警报。</p><h1 id="9ab5" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">从网络分析仪中可以获得什么样的见解？</h1><p id="b48b" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">网络分析器洞察分为5个不同的类别:</p><p id="f20b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1。VPC网络洞察:</strong>这涵盖了与您的VPC网络相关的常见问题，如-</p><ul class=""><li id="351c" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc kl km kn ko bi translated">未使用的外部IP地址:您需要支付一个外部IP地址的费用，该地址是保留的，但没有连接到您环境中的任何资源。当保留的外部IP地址超过24小时未分配时，网络分析仪上会显示一条警报。</li><li id="facd" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">IP地址利用率:如果VPC中任何子网的IP地址利用率超过75%,则会被标记。</li><li id="9dad" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">无效的VPC路由:如果VPC路由的下一跳是无效位置或配置不正确，那么它会在网络分析器上被标记。在这种情况下可能有多种情况，例如路由的下一跳是GCE实例被停止或删除，或者没有将实例属性<code class="du ku kv kw kx b">canIPForward</code>设置为<code class="du ku kv kw kx b">True</code>，路由的下一跳是关闭的VPN隧道等等..</li></ul><p id="97ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2。网络服务洞察:</strong>这涵盖了错误配置的负载平衡器的问题，如-</p><ul class=""><li id="816c" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc kl km kn ko bi translated">防火墙规则不允许或仅部分允许负载平衡器运行状况检查。</li><li id="3b93" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">负载平衡器后端服务对运行状况检查和流量使用不同的端口。</li></ul><p id="7e3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3。Kubernetes Engine Insights : </strong>与GKE相关的见解归入此类别。</p><ul class=""><li id="b2b2" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc kl km kn ko bi translated">GKE节点到控制面板的连接配置错误(VPC路由)或被阻止(防火墙规则)</li><li id="e598" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">GKE控制面板到节点的连接配置错误(VPC路由)或被阻止(防火墙规则)</li><li id="fd00" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">分配的pod/服务子网范围的高IP利用率。</li><li id="11ea" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">从私有GKE集群访问Google APIs。</li></ul><p id="860a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 4。混合连接洞察:</strong>检测被子网或静态路由遮蔽或部分遮蔽的动态路由。被遮蔽的动态路由可能是从VPC网络上的云路由器获知的路由，也可能是从VPC对等网络导入的路由。</p><p id="b01c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 5。托管服务洞察:</strong>该洞察小组涵盖了Google托管服务的连接性问题。</p><ul class=""><li id="97af" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc kl km kn ko bi translated">与云SQL实例的连接配置错误(VPC路由)或被阻止(防火墙规则)</li></ul><blockquote class="ky kz la"><p id="20f0" class="if ig lb ih b ii ij ik il im in io ip lc ir is it ld iv iw ix le iz ja jb jc hb bi translated">GCP正在向该模块添加越来越多的分析仪，您可以参考<a class="ae lf" href="https://cloud.google.com/network-intelligence-center/docs/network-analyzer/overview" rel="noopener ugc nofollow" target="_blank">官方文档</a>了解当前列表。</p></blockquote><h1 id="25cb" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">网络洞察多久生成一次？</h1><p id="c5c5" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">每当进行相关配置更改时，Network Analyzer都会定期生成见解。进行相关配置更改后大约10分钟触发分析。每天至少进行一次定期分析。</p><h1 id="d7d0" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">如何获得实时通知？</strong></h1><p id="a29c" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">您可以在网络分析仪页面上的云控制台中查看细节。Network Analyzer也以API的形式公开，因此您可以通过编程的方式使用这些见解，并将它们包含到现有的工作流中，或者在此基础上创建新的工作流。</p><p id="2ad3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">来自Network Analyzer的见解也作为平台日志记录在云日志中。您可以在这些日志上配置基于自定义日志的指标，并使用云监控创建警报。</p><p id="27d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看如何配置实时通知。首先，让我们为网络分析器洞察创建一个基于日志的度量，该度量被优先排序为<em class="lb">关键</em>或<em class="lb">高</em>，并且属于类型<em class="lb">错误</em>。</p><pre class="lg lh li lj fd lk kx ll bn lm ln bi"><span id="03f6" class="lo je hi kx b be lp lq l lr ls">gcloud logging metrics create criticalHighNetworkIssue \<br/>      --description "Critical or High Impact insight from Network Analyzer" \<br/>      --log-filter "LOG_ID("networkanalyzer.googleapis.com%2Fanalyzer_reports") AND<br/>(jsonPayload.priority="CRITICAL" OR jsonPayload.priority="HIGH") AND <br/>jsonPayload.type = "ERROR""</span></pre><blockquote class="ky kz la"><p id="fd96" class="if ig lb ih b ii ij ik il im in io ip lc ir is it ld iv iw ix le iz ja jb jc hb bi translated">根据问题的严重性，Network Analyzer洞察力分为关键、高、中和低四个优先级。更多细节<a class="ae lf" href="https://cloud.google.com/network-intelligence-center/docs/network-analyzer/overview#priority" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="26bd" class="if ig lb ih b ii ij ik il im in io ip lc ir is it ld iv iw ix le iz ja jb jc hb bi translated">洞察类型可以是信息、警告或错误。更多详情<a class="ae lf" href="https://cloud.google.com/network-intelligence-center/docs/network-analyzer/overview#status" rel="noopener ugc nofollow" target="_blank">此处</a>。</p></blockquote><p id="e68d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建指标后，您可以轻松配置警报策略来获取通知-</p><figure class="lg lh li lj fd lu er es paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="er es lt"><img src="../Images/883cbad00061efbee884fe10c082847d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*k0iZ1z3FFwnWHYv2yPOH4Q.gif"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">从基于自定义网络分析器日志的度量创建警报</figcaption></figure><ol class=""><li id="526b" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc mf km kn ko bi translated">转到日志记录下的基于日志的指标。</li><li id="c28b" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc mf km kn ko bi translated">从我们的自定义指标的三点菜单中，选择“从指标创建警报”选项。它将打开“创建警报策略”窗口。</li><li id="4fc3" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc mf km kn ko bi translated">选择时间序列聚合为无，然后单击下一步按钮。</li><li id="3b4a" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc mf km kn ko bi translated">在“配置预警触发器”窗口中，选择条件类型为阈值，预警触发器为任何时间序列变量，阈值位置高于阈值，阈值为0。</li><li id="d977" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc mf km kn ko bi translated">为条件命名，然后单击下一步。</li><li id="c45e" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc mf km kn ko bi translated">在“配置通知和完成警报”窗口中，切换选择使用通知通道，并从下拉列表中选择您配置的通知通道。</li><li id="f44d" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc mf km kn ko bi translated">为警报策略命名，然后单击下一步。</li><li id="c43f" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc mf km kn ko bi translated">查看并单击创建策略。</li></ol><blockquote class="ky kz la"><p id="fc2d" class="if ig lb ih b ii ij ik il im in io ip lc ir is it ld iv iw ix le iz ja jb jc hb bi translated">您可以提前为工具创建一个通知渠道(电子邮件、Slack、pagerduty等..)使用<a class="ae lf" href="https://cloud.google.com/monitoring/support/notification-options#creating_channels" rel="noopener ugc nofollow" target="_blank">本指南</a>进行选择。我使用了电子邮件通知渠道。</p></blockquote><p id="b6d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想要向任何外部标签/通知系统发送通知，除了日志记录之外，您还可以使用云发布/订阅和云功能来完成此操作。下图显示了相同的参考架构示例-</p><figure class="lg lh li lj fd lu er es paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="er es mg"><img src="../Images/b52362ae41f2b2bbe5295148d0f58816.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KOXIU6TaszOtGN2Ie9qirQ.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">向外部系统发送通知</figcaption></figure><h1 id="88bc" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">如何一起监控多个项目？</h1><p id="6ac2" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">组织拥有复杂的网络架构，包括共享VPC、VPC对等、具有互连和VPN的混合连接、专用服务连接等。监控整个网络比监控单个项目更重要。</p><p id="cb7d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与监视一样，您可以通过更改度量范围来查看多个项目的network analyzer细节。创建单个范围界定项目，并将其他项目作为受监控项目添加到其中。这将确保您可以集中查看所有项目中的network analyzer洞察。更多详情<a class="ae lf" href="https://cloud.google.com/monitoring/settings" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><h1 id="0800" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="57e5" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">这个工具对于检测网络错误配置或问题非常有用。如本博客所述，通过将network analyzer insights与日志记录和监控相结合，我们甚至可以获得实时警报，并在问题影响业务运营之前采取预防措施。</p></div></div>    
</body>
</html>