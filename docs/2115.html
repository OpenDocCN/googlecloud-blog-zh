<html>
<head>
<title>Google Cloud: configuring workload identity federation with Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Cloud:用Azure配置工作负载身份联邦</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/configuring-workload-identity-federation-with-azure-672a1e1f3eec?source=collection_archive---------0-----------------------#2022-02-17">https://medium.com/google-cloud/configuring-workload-identity-federation-with-azure-672a1e1f3eec?source=collection_archive---------0-----------------------#2022-02-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0cf3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jd translated">对于运行在Google Cloud之外的工作负载来说，调用Google Cloud APIs最直接的方法是使用下载的服务帐户密钥。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es jm"><img src="../Images/4408390adb1885045efb02870feec7b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*S5H68MBCat6JHQxD1xW1IQ.png"/></div></figure><p id="b017" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，这种方法有两个主要难点:</p><ul class=""><li id="4d0c" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">这是一个管理难题，密钥需要安全存储并经常轮换。</li><li id="1ba0" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">安全风险，密钥是可能被泄露的长期凭证。</li></ul><p id="d480" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">Workload identity Federation</strong>支持在Google Cloud之外运行的应用程序用短期访问令牌替换长期服务帐户密钥。这是通过将Google Cloud配置为信任外部身份提供者来实现的，因此应用程序可以使用外部身份提供者颁发的凭据来模拟服务帐户。</p><p id="9e2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前，Google Cloud支持与以下IDP集成:</p><ul class=""><li id="91d3" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">自动警报系统</li><li id="7359" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">符合OIDC标准的境内流离失所者</li><li id="0a94" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">符合SAML的国内流离失所者(预览版)</li></ul><p id="f768" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图说明了工作负载身份联合在幕后的实际工作方式:</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es ki"><img src="../Images/9489e95b52c5b407896d09304308a3ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hJ4vaRXijbFnil3JS7bjfA.png"/></div></div></figure><ol class=""><li id="56bc" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc kn ka kb kc bi translated">在内部或另一个云提供商中运行的工作负载提交一个请求，以根据IdP进行身份验证。</li><li id="12b0" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc kn ka kb kc bi translated">IdP验证与该工作负载相关联的身份，并返回帐户凭证。</li><li id="71d0" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc kn ka kb kc bi translated">工作负载调用Google Cloud Secure Token Service(STS ),提供IdP颁发的帐户凭证。</li><li id="c5ee" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc kn ka kb kc bi translated">STS验证提供的令牌并返回一个短期令牌。</li><li id="4588" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc kn ka kb kc bi translated">工作负载使用该令牌来模拟服务帐户。</li><li id="48ba" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc kn ka kb kc bi translated">最后，工作负载可以访问Google Cloud上受保护的资源。</li></ol><p id="49e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我将解释如何使用Azure (OIDC兼容的IdP)配置工作负载身份联盟，以便在Azure VM上运行的工作负载可以模拟一个服务帐户来执行Google云资源上的操作。</p><p id="98d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每当我们配置工作负载身份联合时，都需要遵循3个关键步骤:</p><ol class=""><li id="5442" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc kn ka kb kc bi translated">准备外部IdP。</li><li id="bde9" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc kn ka kb kc bi translated">定义一个<strong class="ih hj">属性映射</strong>和一个可选的<strong class="ih hj">属性条件</strong>，以将IdP凭证映射到外部身份。</li><li id="4bdc" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc kn ka kb kc bi translated">准备Google Cloud与外部IdP建立信任。</li></ol><p id="89ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们一步一步地了解整个过程。</p><h1 id="3d2b" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">准备外部IdP</h1><p id="4dbb" class="pw-post-body-paragraph if ig hi ih b ii lm ik il im ln io ip iq lo is it iu lp iw ix iy lq ja jb jc hb bi translated">在解释Azure中需要设置的细节之前，了解身份和访问管理(IAM)在Azure上的工作方式是很重要的。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="1f39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Azure Active Directory (AAD)是微软基于云的IAM服务，它帮助组织的员工登录和访问以下资源:</p><ul class=""><li id="ae1a" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">外部资源，如Microsoft 365、Azure门户和其他SaaS应用程序。</li><li id="2842" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">内部资源，如公司网络和内联网上的应用程序，以及组织开发的任何云应用程序。</li></ul><p id="e217" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AAD <strong class="ih hj">租户</strong>是组织在与微软建立关系之初收到的AAD的专用实例。这种关系可以从注册Azure或微软365开始。</p><p id="4de5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个<strong class="ih hj">应用程序</strong>必须在一个租户中注册，才能将身份和访问管理委托给AAD。在门户网站中，这是在<em class="ly">应用注册</em>刀片上完成的。</p><p id="c283" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当一个应用程序被注册时，需要指定它是单租户还是多租户。应用程序由其唯一的应用程序对象定义，该对象驻留在应用程序注册的租户中。应用程序对象用作创建一个或多个服务主体对象的模板。在使用应用程序的每个租户中都创建了一个<strong class="ih hj">服务主体</strong>，它们可以在门户的<em class="ly">企业应用</em>刀片中进行管理。</p><p id="e5bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">托管身份</strong> (MI) <strong class="ih hj"> </strong>向Azure托管资源提供AAD身份。在这些资源上运行的代码可以使用MI为支持AAD身份验证的服务请求访问令牌。有两种类型的托管身份:</p><ul class=""><li id="fbce" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated"><strong class="ih hj">系统分配的</strong> —一些Azure服务允许直接在服务实例上启用托管身份。如果启用，将在AAD中创建一个身份，它与服务实例的生命周期相关联。</li><li id="6982" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><strong class="ih hj">用户分配的</strong> —托管身份也可以创建为独立的Azure资源，然后分配给Azure服务的一个或多个实例。在这种情况下，身份与服务实例的生命周期无关。</li></ul><p id="7b66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，在AAD租户中注册的应用程序可供成功通过身份验证的租户的身份使用。应用程序RBAC是一种对租户可用的应用程序实施授权的机制。应用程序开发人员定义角色。然后，管理员可以将这些角色分配给不同的身份(例如，虚拟机的托管身份)。</p><p id="2f29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图描述了到目前为止所描述的不同实体之间的关系:</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lz"><img src="../Images/04163e208ae6db95656d49c6ef264fb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iFORGx2s4UWgGUaq_L9seg.png"/></div></div></figure><p id="cd3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在虚拟机上运行的代码可以使用与虚拟机关联的托管标识，从Azure实例元数据服务器(IMDS)中的令牌端点请求资源的访问令牌，该令牌只能从虚拟机内部访问。关于如何调用该端点的更多细节可以在这里找到<a class="ae ma" href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-use-vm-token#get-a-token-using-http" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="e6ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">序列图描述了获取资源令牌并使用它来访问资源的过程。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es mb"><img src="../Images/cecafcf8322746431e4cd64c74e0f2a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jhwOszy-IvM-j9gYLu3eVA.png"/></div></div></figure><p id="616d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Azure应用服务或Azure功能的情况下，具有关联MI的应用通过定义2个环境变量使端点请求可用的访问令牌:</p><ul class=""><li id="9330" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated"><strong class="ih hj"> IDENTITY_ENDPOINT </strong> —本地令牌服务的URL。</li><li id="89b7" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><strong class="ih hj"> IDENTITY_HEADER </strong> —用于帮助缓解SSRF攻击的报头。该值由平台旋转。</li></ul><p id="6902" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于如何调用端点检查<a class="ae ma" href="https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=portal%2Chttp#rest-endpoint-reference" rel="noopener ugc nofollow" target="_blank">的更多细节，请点击这里</a>。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="4d52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好了，现在已经清楚了IAM在Azure中的工作方式，让我们看看需要在Azure中设置什么来实现与Google Cloud的工作负载身份联邦集成。你只需要遵循以下步骤:</p><ol class=""><li id="27d2" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc kn ka kb kc bi translated">创建一个新的AAD应用程序，专门用于获取Google Cloud凭据。</li><li id="6650" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc kn ka kb kc bi translated">设置一个应用程序ID URI，它在你的Azure Active Directory中唯一地标识该应用程序，并记下它，因为在Google Cloud中进行配置时将需要它。</li><li id="b0b9" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc kn ka kb kc bi translated">为应用程序分配角色。</li><li id="2ad7" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc kn ka kb kc bi translated">在AAD租户中为应用程序创建服务主体。</li></ol><p id="adc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您使用Terraform进行自动化，您可以按如下方式轻松完成:</p><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="f8e7" class="mh kp hi md b fi mi mj l mk ml">resource “azuread_application” “app” {</span><span id="4aa1" class="mh kp hi md b fi mm mj l mk ml">display_name = &lt;<strong class="md hj">APP_NAME&gt;</strong></span><span id="5025" class="mh kp hi md b fi mm mj l mk ml">identifier_uris = [&lt;<strong class="md hj">APPLICATION_ID_URI&gt;</strong>]</span><span id="a225" class="mh kp hi md b fi mm mj l mk ml">app_role {<br/>    allowed_member_types = [“Application”]<br/>    description = &lt;<strong class="md hj">ROLE_DESCRIPTION&gt;<br/>    </strong>display_name = &lt;<strong class="md hj">ROLE_DISPLAY_NAME&gt;<br/>    </strong>enabled = true<br/>    id = &lt;<strong class="md hj">UUID&gt;<br/>    </strong>value = &lt;<strong class="md hj">ROLE_VALUE&gt;<br/>  </strong>}<br/>}</span><span id="67bd" class="mh kp hi md b fi mm mj l mk ml">resource “azuread_service_principal” “service_principal” {</span><span id="c5bf" class="mh kp hi md b fi mm mj l mk ml">application_id = azuread_application.app.application_id<br/>  app_role_assignment_required = true</span><span id="98ec" class="mh kp hi md b fi mm mj l mk ml">}</span></pre><h1 id="a6a6" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">定义属性映射和可选的属性条件</h1><p id="a500" class="pw-post-body-paragraph if ig hi ih b ii lm ik il im ln io ip iq lo is it iu lp iw ix iy lq ja jb jc hb bi translated">在工作负载的上下文中，IdP凭证(在我们的例子中是由AAD发布的JWT令牌)中的身份联合声明被称为<strong class="ih hj">断言属性</strong>并表示为断言。[姓名]。</p><p id="5262" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要一个<strong class="ih hj">属性映射</strong>来将断言属性映射到由工作负载身份联盟识别的预定义目标属性，如下所列:</p><ul class=""><li id="b634" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated"><strong class="ih hj"> google.sub </strong> —外部身份的唯一标识符。对于OIDC提供者，比如我们正在合作的那个，需要为这个目标属性提供一个映射。</li><li id="0224" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><strong class="ih hj"> google.groups </strong> —身份所属的一组组。</li><li id="2e59" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><strong class="ih hj">属性。[名称] </strong> —最多50个自定义属性。</li></ul><p id="7b69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">稍后，我们将看到在与我们将尝试模拟的服务帐户相关联的IAM策略中创建IAM绑定时，如何使用此目标属性。</p><p id="ff06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">属性映射采用以下形式:</p><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="2bbe" class="mh kp hi md b fi mi mj l mk ml">TARGET_ATTRIBUTE=SOURCE_EXPRESSION</span></pre><p id="c27e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ma" href="https://cloud.google.com/certificate-authority-service/docs/using-cel" rel="noopener ugc nofollow" target="_blank"> CEL(公共表达式语言</a>)可用于定义对断言属性进行操作的源表达式。</p><p id="09b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">适合我们用例的映射如下所示:</p><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="b9cf" class="mh kp hi md b fi mi mj l mk ml">google.subject=assertion.sub</span></pre><p id="53f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可选地，我们还可以添加一个<strong class="ih hj">属性条件</strong>来建立接受外部凭证的环境。条件被写成可以检查断言属性和目标属性的CEL表达式。如果条件评估为真，则接受凭证。否则，凭证被拒绝。为了简单起见，我们不指定条件。</p><h1 id="204f" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">准备Google Cloud与外部IdP建立信任</h1><p id="ffa5" class="pw-post-body-paragraph if ig hi ih b ii lm ik il im ln io ip iq lo is it iu lp iw ix iy lq ja jb jc hb bi translated">我们差不多完成了。最后一步是继续在Google Cloud上进行配置。为此，我们需要在Google Cloud项目中创建一个工作负载身份池和提供者。提供者将被配置为信任由我们的AAD租户为之前创建的应用程序颁发的令牌。</p><p id="087d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud项目需要启用以下API:</p><ul class=""><li id="81cf" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">cloudresourcemanager.googleapis.com</li><li id="3585" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">iam.googleapis.com</li><li id="d91a" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">iamcredentials.googleapis.com</li><li id="4294" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">sts.googleapis.com</li></ul><p id="78e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要创建工作负载身份池和提供者，需要在该项目中授予以下角色之一:</p><ul class=""><li id="706a" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated"><em class="ly">工作负载身份池管理</em></li><li id="3495" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><em class="ly">所有者</em>(不建议生产)</li></ul><p id="36c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以使用以下代码在Terraform上创建这两个资源:</p><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="a2c5" class="mh kp hi md b fi mi mj l mk ml">resource "google_iam_workload_identity_pool" "pool" {</span><span id="01bd" class="mh kp hi md b fi mm mj l mk ml">  provider                  = google-beta<br/>  project                   = &lt;<strong class="md hj">PROJECT_ID&gt;<br/>  </strong>workload_identity_pool_id = &lt;<strong class="md hj">POOL_ID&gt;</strong></span><span id="9ef4" class="mh kp hi md b fi mm mj l mk ml">}</span><span id="44de" class="mh kp hi md b fi mm mj l mk ml">resource "google_iam_workload_identity_pool_provider" "provider" {</span><span id="2eca" class="mh kp hi md b fi mm mj l mk ml">  provider                           = google-beta<br/>  project                            = &lt;<strong class="md hj">PROJECT_ID&gt;<br/>  </strong>workload_identity_pool_id          =   google_iam_workload_identity_pool.pool.workload_identity_pool_id<br/>  workload_identity_pool_provider_id = &lt;<strong class="md hj">PROVIDER_ID&gt;</strong></span><span id="cdf9" class="mh kp hi md b fi mm mj l mk ml">  attribute_mapping = {</span><span id="5121" class="mh kp hi md b fi mm mj l mk ml">    "google.subject" = "assertion.sub"</span><span id="99c7" class="mh kp hi md b fi mm mj l mk ml">  }</span><span id="f201" class="mh kp hi md b fi mm mj l mk ml">  oidc {</span><span id="f63a" class="mh kp hi md b fi mm mj l mk ml">    allowed_audiences = [&lt;<strong class="md hj">APPLICATION_ID_URI&gt;</strong>]<br/>    issuer_uri        = "https://sts.windows.net/&lt;<strong class="md hj">AAD_TENANT_ID&gt;</strong>"</span><span id="d17e" class="mh kp hi md b fi mm mj l mk ml">  }</span><span id="1df8" class="mh kp hi md b fi mm mj l mk ml">}</span></pre><h1 id="700b" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">测试我们的设置</h1><p id="7e88" class="pw-post-body-paragraph if ig hi ih b ii lm ik il im ln io ip iq lo is it iu lp iw ix iy lq ja jb jc hb bi translated">好了，所有的配置都完成了。现在让我们确认它实际上是有效的。我们如何做到这一点？</p><p id="4994" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1.让我们首先用系统分配的MI在Azure中创建一个Linux VM，并在其上安装gcloud CLI。</p><p id="f764" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.一旦VM准备就绪，在Azure中创建一个应用程序角色分配，这样与VM相关联的MI就可以为AAD应用程序请求访问令牌。使用Terraform，可按如下方式完成:</p><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="c248" class="mh kp hi md b fi mi mj l mk ml">resource “google_service_account_iam_binding” “admin-account-iam” {</span><span id="5e74" class="mh kp hi md b fi mm mj l mk ml">service_account_id = &lt;<strong class="md hj">SERVICE_ACCOUNT_EMAIL&gt;<br/>  </strong>role = “roles/iam.workloadIdentityUser”<br/>  members = [ "principalSet://iam.googleapis.com/projects/&lt;<strong class="md hj">PROJECT_NUMBER&gt;</strong>/locations/global/workloadIdentityPools/&lt;<strong class="md hj">POOL_ID&gt;</strong>/*" ]</span><span id="3bd6" class="mh kp hi md b fi mm mj l mk ml">}</span></pre><p id="d9e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.在Google Cloud中，授予外部身份一个服务帐户上的<em class="ly">工作负载身份用户</em>角色，该角色被授予在资源上执行所需操作所需的权限。</p><p id="5edb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">IAM绑定中的成员可以按如下方式引用:</p><ul class=""><li id="9607" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">特定的外部身份</li></ul><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="cbcf" class="mh kp hi md b fi mi mj l mk ml">principal://iam.googleapis.com/projects/&lt;<strong class="md hj">PROJECT_NUMBER&gt;</strong>/locations/global/workloadIdentityPools/&lt;<strong class="md hj">POOL_ID&gt;</strong>/subject/&lt;<strong class="md hj">SUBJECT&gt;</strong></span></pre><ul class=""><li id="2ea8" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">一组外部身份</li></ul><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="b905" class="mh kp hi md b fi mi mj l mk ml">principal://iam.googleapis.com/projects/&lt;<strong class="md hj">PROJECT_NUMBER&gt;</strong>/locations/global/workloadIdentityPools/&lt;<strong class="md hj">POOL_ID&gt;</strong>/group/&lt;<strong class="md hj">GROUP&gt;</strong></span></pre><ul class=""><li id="a577" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">通过在自定义属性中具有特定值来标识的一组外部身份。</li></ul><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="7ea8" class="mh kp hi md b fi mi mj l mk ml">principalSet://iam.googleapis.com/projects/&lt;<strong class="md hj">PROJECT_NUMBER&gt;</strong>/locations/global/workloadIdentityPools/&lt;<strong class="md hj">POOL_ID&gt;</strong>/<strong class="md hj">attribute.&lt;ATTRIBUTE_NAME&gt;</strong>/&lt;<strong class="md hj">ATTRIBUTE_VALUE&gt;</strong></span></pre><ul class=""><li id="a5d6" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">工作负荷标识池中的所有外部标识。</li></ul><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="c9ee" class="mh kp hi md b fi mi mj l mk ml">principalSet://iam.googleapis.com/projects/&lt;<strong class="md hj">PROJECT_NUMBER&gt;</strong>/locations/global/workloadIdentityPools/&lt;<strong class="md hj">POOL_ID&gt;</strong>/*</span></pre><p id="5cc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个特殊的例子中，我们授予池中的所有身份模拟服务帐户的权限。</p><p id="c313" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.使用gcloud CLI生成一个凭据文件。</p><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="0537" class="mh kp hi md b fi mi mj l mk ml">gcloud iam workload-identity-pools create-cred-config \<br/>projects/&lt;<strong class="md hj">PROJECT_NUMBER&gt;</strong>/locations/global/workloadIdentityPools/&lt;<strong class="md hj">POOL_ID&gt;</strong>/providers/&lt;<strong class="md hj">PROVIDER_ID&gt;</strong> \<br/>--service-account=&lt;<strong class="md hj">SERVICE_ACCOUNT_EMAIL&gt;</strong> \<br/>--azure \<br/>--app-id-uri &lt;<strong class="md hj">APPLICATION_ID_URI&gt;</strong> \<br/>--output-file=&lt;<strong class="md hj">FILEPATH&gt;</strong>.json</span></pre><p id="e9de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有一个警告。在这种情况下生成的凭据文件适合在虚拟机中运行的工作负载。如果您检查该文件，您将看到Azure IMDS url被引用为IdP令牌端点。但是，此端点不适合Azure App Service或Azure Functions上的应用程序。在这种情况下，令牌端点将由环境变量INDETITY _ ENDPOINT给出，并且需要添加一个带有环境变量IDENTIT_HEADER值的X-IDENTITY-HEADER HTTP头。</p><p id="adf0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.使用生成的凭证文件登录Google Cloud。</p><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="d31e" class="mh kp hi md b fi mi mj l mk ml">gcloud auth login –cred-file &lt;<strong class="md hj">FILEPATH&gt;</strong>.json</span></pre><p id="3a5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.运行特定的gcloud命令对资源执行操作。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="db78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望这篇文章能帮助你更好地理解workload identity Federation for Azure是如何工作和设置的。请查看与此示例相关的<a class="ae ma" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric/tree/master/examples/cloud-operations/workload-identity-federation" rel="noopener ugc nofollow" target="_blank">代码</a>，您可以在云基础架构存储库中查看该代码。</p><p id="6148" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我打算写一篇关于如何为AD FS设置工作负载身份联邦的后续文章。一旦文章写好了，再见。</p></div></div>    
</body>
</html>