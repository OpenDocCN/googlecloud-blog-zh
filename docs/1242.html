<html>
<head>
<title>IoT Tank Monitoring Solution Part 2 — MicroPython device with ESP8266 to collect tank level data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">物联网储罐监控解决方案第2部分——采用ESP8266的MicroPython设备收集储罐液位数据</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/iot-tank-monitoring-solution-part-2-micropython-device-with-esp8266-to-collect-tank-level-data-d74a1b947f60?source=collection_archive---------2-----------------------#2020-01-06">https://medium.com/google-cloud/iot-tank-monitoring-solution-part-2-micropython-device-with-esp8266-to-collect-tank-level-data-d74a1b947f60?source=collection_archive---------2-----------------------#2020-01-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="66a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用云计算跟踪储罐液位的端到端解决方案，无需过多担心基础设施管理。</strong></p><p id="00fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个关于如何在谷歌云上创建一个农场储罐监控解决方案的3部分教程。</p><ul class=""><li id="4c4a" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">第1部分— <a class="ae jm" rel="noopener" href="/@alvaroviebrantz/iot-tank-monitoring-solution-part-1-build-a-rest-api-using-cloud-run-and-django-rest-framework-a8b9770eaa87">使用Cloud Run和Django Rest框架构建Rest API</a></li><li id="ba6a" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">第2部分—收集储罐数据的MicroPython设备</li><li id="5ca2" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">第3部分— <a class="ae jm" rel="noopener" href="/@alvaroviebrantz/iot-tank-monitoring-solution-part-3-visualizing-data-using-cloudsql-federated-queries-bigquery-1a92d1a565a3">使用BigQuery联邦查询和Data Studio可视化数据</a></li></ul><p id="102d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本系列教程的这一部分中，我将介绍使用相当便宜的WiFi设备和使用MicroPython的超声波传感器构建一个物联网设备来收集液位数据的步骤。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/87775cee2460c2cc7ac53a6a492f4ad3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EjBwoQhCDZWZ6P8DoFf5tQ.png"/></div></div></figure><p id="18b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">原理图和零件</strong></p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es ke"><img src="../Images/8efeeb42d40c8738699355699a1a16d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g93LysCNhL9Ezyjkus7pFA.jpeg"/></div></div></figure><ul class=""><li id="f97f" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">ESP8266 WiFi微控制器</li><li id="1662" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">HC-SR04超声波传感器</li><li id="c2be" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">针织套衫</li></ul><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es kf"><img src="../Images/ecab6d1c409714fb71f2265fc7552517.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fXUXVLP5pG5G1_Dqlz3z_g.png"/></div></div></figure><p id="32d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在设备上安装MicroPython</strong></p><p id="6992" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要在设备上安装MicroPython环境。为此，我们需要访问MicroPython网站，下载与您将要使用的设备相关的二进制文件。</p><div class="kg kh ez fb ki kj"><a href="http://micropython.org/download#esp8266" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">MicroPython —用于微控制器的Python</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">MicroPython是使用git开发的，用于源代码管理，主存储库可以在GitHub上找到，网址是…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">micropython.org</p></div></div><div class="ks l"><div class="kt l ku kv kw ks kx kc kj"/></div></div></a></div><p id="0c76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们需要安装esptool，以便能够在我们的计算机上刷新设备，我们将使用Adafruit的ampy工具与MicroPython设备对话，并将代码复制到其中。您可以运行以下命令来安装这两者:</p><p id="867d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">pip安装esptool ampy</p><p id="8c20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在确定您计算机上的主板端口。在Unix系统上，您可以运行<code class="du ky kz la lb b">ls /dev/tty.*</code>来列出串行设备。我的一些董事会例如是<code class="du ky kz la lb b">/dev/tty.SLAB_USBtoUART</code>和<code class="du ky kz la lb b">/dev/tty.usbserial-1410*</code>。现在，使用以下命令清理设备并刷新MicroPython固件:</p><pre class="jt ju jv jw fd lc lb ld le aw lf bi"><span id="0247" class="lg lh hi lb b fi li lj l lk ll">export SERIAL_PORT=/dev/tty.SLAB_USBtoUART<br/>esptool.py — -port $SERIAL_PORT erase_flash<br/># for ESP8266<br/>esptool.py — port $SERIAL_PORT — baud 460800 write_flash — flash_size=detect 0 esp8266–20170108-v1.8.7.bin</span></pre><p id="b3c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，随着MicroPython在设备上运行，是时候复制项目文件并设置一些配置来开始发送数据了。</p><p id="97cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">设备和配置上的设置代码</strong></p><div class="kg kh ez fb ki kj"><a href="https://github.com/alvarowolfx/cloud-run-django-rest-iot/tree/master/firmware" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">alvarowolfx/cloud-run-django-rest-IOT</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">让我们使用Django Rest框架作为项目的基础，创建一个农场储罐监控解决方案。拯救农场…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">github.com</p></div></div><div class="ks l"><div class="lm l ku kv kw ks kx kc kj"/></div></div></a></div><p id="dd3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在计算机上克隆项目文件。设备相关文件位于固件文件夹中。使用您的WiFi凭据和后端运行的URL更改config.py文件，以便设备可以向其发送数据。</p><p id="7e0e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了从超声波传感器读取数据，我在这里使用了这个库<a class="ae jm" href="https://github.com/rsc1975/micropython-hcsr04" rel="noopener ugc nofollow" target="_blank">GitHub—RSC 1975/micropython-hcsr 04:超声波传感器HC-SR04的Micropython驱动程序</a>之后，将文件复制到设备。</p><pre class="jt ju jv jw fd lc lb ld le aw lf bi"><span id="b568" class="lg lh hi lb b fi li lj l lk ll">export SERIAL_PORT=/dev/tty.SLAB_USBtoUART<br/>ampy — p $SERIAL_PORT -d 0.5 -b 115200 put firmware/config.py<br/>ampy — p $SERIAL_PORT -d 0.5 -b 115200 put firmware/hcsr04.py<br/>ampy — p $SERIAL_PORT -d 0.5 -b 115200 put firmware/sensor.py<br/>ampy — p $SERIAL_PORT -d 0.5 -b 115200 put firmware/main.py</span></pre><p id="ab90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就这样，代码将使用设备Mac地址的一部分作为设备ID，并开始默认每10分钟向我们的后端发送一次距离数据。您可以调试从串行端口读取的设备:</p><pre class="jt ju jv jw fd lc lb ld le aw lf bi"><span id="7696" class="lg lh hi lb b fi li lj l lk ll"><strong class="lb hj">$ </strong>screen -L $SERIAL_PORT 115200 -L</span></pre><p id="e352" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个输出示例:</p><pre class="jt ju jv jw fd lc lb ld le aw lf bi"><span id="288a" class="lg lh hi lb b fi li lj l lk ll">connecting to network...<br/>network config: ('192.168.0.120', '255.255.255.0', '192.168.0.1', '192.168.0.1')<br/>Distance = 13.1838cm<br/>sending:  {'distance': 13.1838, 'device_id': '487ada00'}<br/>data sent!</span></pre><p id="24fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">结论</strong></p><p id="33d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一部分相对较短，但只是为了展示使用MicroPython和一些廉价设备构建解决方案原型是多么简单。一如既往，正如第一部分所提到的，这里还有改进的空间，但是有一个是针对设备的。</p><p id="f35b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以添加设备认证，有一篇非常好的文章展示了如何将物联网核心与MicroPython结合使用，并使与云的连接更加安全。物联网核心依靠JWT令牌来进行身份认证，因此我们也可以以此为基础，通过我们的后端运行我们自己的身份认证。</p><p id="2dbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">参考文献</strong></p><ul class=""><li id="dbf7" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><a class="ae jm" href="https://cloud.google.com/iot-core/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/iot-core/</a></li><li id="8646" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated"><a class="ae jm" href="https://github.com/GoogleCloudPlatform/iot-core-micropython" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/iot-core-micropython</a></li><li id="6d03" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated"><a class="ae jm" rel="noopener" href="/google-cloud/connecting-micropython-devices-to-google-cloud-iot-core-3680e632681e">https://medium . com/Google-cloud/connecting-micropython-devices-to-Google-cloud-IOT-core-3680 e 632681 e</a></li><li id="cc73" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated"><a class="ae jm" href="http://micropython.org/" rel="noopener ugc nofollow" target="_blank">http://micropython.org/</a></li><li id="17b0" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated"><a class="ae jm" href="https://gist.github.com/miguelgrinberg/80973081596f1069057ec6668142be15" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/miguelgrinberg/80973081596 f 1069057 EC 6668142 be 15</a></li></ul></div></div>    
</body>
</html>