<html>
<head>
<title>Hyperparameter tuning BigQuery ML</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">超参数调整BigQuery ML</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/hyperparameter-tuning-directly-within-bigquery-ml-a0affb0991ae?source=collection_archive---------1-----------------------#2021-07-13">https://medium.com/google-cloud/hyperparameter-tuning-directly-within-bigquery-ml-a0affb0991ae?source=collection_archive---------1-----------------------#2021-07-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="176e" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">BigQuery ML可以使用顶点人工智能来调整通用模型参数</h2></div><h2 id="bacc" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">什么是BigQuery ML？</h2><p id="85b4" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">BigQuery ML允许您根据BigQuery中的数据快速训练ML模型。例如，假设您想要训练线性ML模型来预测自行车租赁的持续时间，您可以使用:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="1608" class="ix iy hi kt b fi kx ky l kz la">CREATE OR REPLACE MODEL ch09eu.bicycle_model_linear<br/>OPTIONS(<br/> model_type='linear_reg', input_label_cols=['duration']<br/>)<br/>AS<br/>SELECT <br/>  start_station_name,<br/>  CAST(EXTRACT(DAYOFWEEK FROM start_date) AS STRING) AS dayofweek,<br/>  CAST(EXTRACT HOUR FROM start_date) AS STRING) AS hourofday,<br/>  duration<br/>FROM `bigquery-public-data.london_bicycles.cycle_hire`</span></pre><p id="b47c" class="pw-post-body-paragraph jv jw hi jx b jy lb ij ka kb lc im kd ji ld kf kg jm le ki kj jq lf kl km kn hb bi translated">BigQuery ML还支持在推理过程中自动重复的特征工程。稍微复杂一点的深度神经网络模型可能是:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="8ac9" class="ix iy hi kt b fi kx ky l kz la">CREATE OR REPLACE MODEL ch09eu.bicycle_model_dnn<br/><strong class="kt hj">TRANSFORM(<br/>   start_station_name,<br/>   CAST(EXTRACT(DAYOFWEEK FROM start_date) AS STRING) AS dayofweek,<br/>   ML.BUCKETIZE(EXTRACT(HOUR FROM start_date), [0, 6, 12, 18, 24]) AS hourofday,<br/>   duration<br/>)</strong><br/>OPTIONS(<br/> <strong class="kt hj">model_type='dnn_regressor'</strong>, input_label_cols=['duration'], <br/> hidden_units=[32, 8],<br/> learn_rate=0.1,<br/> dropout=0.25,<br/>)<br/>AS<br/>SELECT <br/>  start_station_name, start_date, duration<br/>FROM `bigquery-public-data.london_bicycles.cycle_hire`</span></pre><h2 id="fbd6" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">超参数调谐</h2><p id="5bef" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">但是如果你想尝试不同的学习速度呢？这称为超参数调整，您可以指定模型参数的范围或候选值:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="d879" class="ix iy hi kt b fi kx ky l kz la">CREATE OR REPLACE MODEL ch09eu.bicycle_model_dnn_hparam<br/>TRANSFORM(<br/>   start_station_name,<br/>   CAST(EXTRACT(DAYOFWEEK FROM start_date) AS STRING) AS dayofweek,<br/>   ML.BUCKETIZE(EXTRACT(HOUR FROM start_date), [0, 6, 12, 18, 24]) AS hourofday,<br/>   duration<br/>)<br/>OPTIONS(<br/> model_type='dnn_regressor', input_label_cols=['duration'], <br/> <strong class="kt hj">num_trials=10,</strong><br/> <strong class="kt hj">hidden_units=hparam_candidates([struct([32,8])</strong>, struct([32]), struct([64,32,4])]),<br/> <strong class="kt hj">learn_rate=hparam_range(0, 0.5),<br/> dropout=hparam_candidates([0, 0.1, 0.25, 0.4])</strong><br/>)<br/>AS<br/>SELECT <br/>  start_station_name, start_date, duration<br/>FROM `bigquery-public-data.london_bicycles.cycle_hire`</span></pre><p id="7af6" class="pw-post-body-paragraph jv jw hi jx b jy lb ij ka kb lc im kd ji ld kf kg jm le ki kj jq lf kl km kn hb bi translated">BigQuery ML将使用Vertex AI的超参数调优服务在您指定的预算(这里是10次试验)内选择最佳参数。</p><p id="1c8e" class="pw-post-body-paragraph jv jw hi jx b jy lb ij ka kb lc im kd ji ld kf kg jm le ki kj jq lf kl km kn hb bi translated">请注意，每种型号类型<a class="ae lg" href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-hyperparameter-tuning#hyperparameters_and_objectives" rel="noopener ugc nofollow" target="_blank">只允许对少数参数</a>进行调整。例如，对于DNN模型，您可以调整batch_size、dropout、learn_rate、optimizer等。</p><p id="1b9b" class="pw-post-body-paragraph jv jw hi jx b jy lb ij ka kb lc im kd ji ld kf kg jm le ki kj jq lf kl km kn hb bi translated">如果您想要更改存储桶间隔，该怎么办？或者试试有没有个性特色？在这种情况下，你应该<a class="ae lg" href="https://towardsdatascience.com/how-to-do-hyperparameter-tuning-of-a-bigquery-ml-model-29ba273a6563" rel="noopener" target="_blank">遵循本文</a>中的方法，构建一个Python支架。这样的Python支架会给你很大的灵活性。</p><p id="8379" class="pw-post-body-paragraph jv jw hi jx b jy lb ij ka kb lc im kd ji ld kf kg jm le ki kj jq lf kl km kn hb bi translated">但是，对于调整基本模型参数，请使用内置的顶点AI集成。</p><h2 id="d06f" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">调用最佳模型</h2><p id="143b" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">培训完成后，您可以查看每个试验的评估指标:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="bed3" class="ix iy hi kt b fi kx ky l kz la">SELECT * FROM ML.EVALUATE(MODEL ch09eu.bicycle_model_dnn_hparam) <br/>ORDER BY mean_absolute_error ASC</span></pre><p id="988a" class="pw-post-body-paragraph jv jw hi jx b jy lb ij ka kb lc im kd ji ld kf kg jm le ki kj jq lf kl km kn hb bi translated">并调用最佳模型，使用:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="1fa4" class="ix iy hi kt b fi kx ky l kz la">SELECT * FROM ML.PREDICT(MODEL ch09eu.bicycle_model_dnn_hparam,<br/> (<br/>   SELECT <br/>     CURRENT_TIMESTAMP() AS start_date, <br/>     'Waterloo Station 1, Waterloo' AS start_station_name<br/> )<br/>)</span></pre></div></div>    
</body>
</html>