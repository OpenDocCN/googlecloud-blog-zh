<html>
<head>
<title>Traffic Based Horizontal Pod Autoscaler for GKE Clusters</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GKE集群基于流量的水平Pod自动缩放</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/traffic-based-horizontal-pod-autoscaler-for-gke-clusters-efaff0d8cecc?source=collection_archive---------0-----------------------#2022-12-06">https://medium.com/google-cloud/traffic-based-horizontal-pod-autoscaler-for-gke-clusters-efaff0d8cecc?source=collection_archive---------0-----------------------#2022-12-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e5c9a91d7f96d9cb104b5560e5048c95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uRn6IM3kG_ztOonKZAOI0g.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">水平吊舱自动定标器</figcaption></figure><p id="bbb7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">HPA或水平机架自动缩放是指自动增加或减少服务于工作负载的机架数量。</p><p id="7db6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">但是，当我们谈论水平Pod自动缩放时，CPU和内存指标是每个人首先想到的指标。但是某些应用程序受限于容量限制，这并没有反映在它们的CPU或内存使用中。因此，将流量利用率指标/每秒请求数(RPS)指标也添加到HPA中，可以在这些情况下提供一种全面的自动扩展方法，因为它与应用程序使用情况更加一致。</p><p id="a3f4" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">因此，我们可以使用GCP <a class="ae js" href="https://cloud.google.com/kubernetes-engine/docs/concepts/gateway-api" rel="noopener ugc nofollow" target="_blank">网关控制器API </a>来展示具有当前处于<a class="ae js" href="https://cloud.google.com/products#product-launch-stages" rel="noopener ugc nofollow" target="_blank">预览</a>模式的特性的应用程序，该特性在本地提供从负载平衡器到Kubernetes API服务器到自动缩放pod的流量信号的集成。</p><p id="6a91" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在这篇博客中，我们将为一个hello-world示例应用程序演示如何使用Gateway Controller和Horizontal Pod Autoscaler进行基于流量的自动缩放。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="733a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们从演示开始。</p><h1 id="6494" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">先决条件</h1><ol class=""><li id="d275" class="ky kz hi iw b ix la jb lb jf lc jj ld jn le jr lf lg lh li bi translated">我们需要一个版本为1.24或更高版本的GKE集群。</li><li id="29c8" class="ky kz hi iw b ix lj jb lk jf ll jj lm jn ln jr lf lg lh li bi translated">应该为您的GKE集群安装和配置kubectl CLI。</li><li id="3748" class="ky kz hi iw b ix lj jb lk jf ll jj lm jn ln jr lf lg lh li bi translated">gcloud CLI应与GCP项目一起安装和配置。</li></ol><blockquote class="lo lp lq"><p id="bc8c" class="iu iv lr iw b ix iy iz ja jb jc jd je ls jg jh ji lt jk jl jm lu jo jp jq jr hb bi translated">请参考GKE网关控制器<a class="ae js" href="https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-gateways#requirements" rel="noopener ugc nofollow" target="_blank">要求</a>。</p></blockquote><h1 id="7392" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">启用网关控制器API</h1><p id="b114" class="pw-post-body-paragraph iu iv hi iw b ix la iz ja jb lb jd je jf lv jh ji jj lw jl jm jn lx jp jq jr hb bi translated">在现有集群gke-gateway-demo上启用网关API。</p><pre class="ly lz ma mb fd mc md me bn mf mg bi"><span id="68d6" class="mh kb hi md b be mi mj l mk ml">gcloud container clusters update gke-gateway-demo \<br/> - gateway-api=standard \<br/> - zone=europe-west3-c</span></pre><h1 id="7251" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">使用ClusterIP服务部署应用程序</h1><p id="4548" class="pw-post-body-paragraph iu iv hi iw b ix la iz ja jb lb jd je jf lv jh ji jj lw jl jm jn lx jp jq jr hb bi translated">在GKE集群上部署hello world应用程序，并使用ClusterIP服务在内部公开它。</p><pre class="ly lz ma mb fd mc md me bn mf mg bi"><span id="3612" class="mh kb hi md b be mi mj l mk ml">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: hello-world<br/>spec:<br/>  replicas: 2<br/>  selector:<br/>    matchLabels:<br/>      app: hello-world<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: hello-world<br/>    spec:<br/>      containers:<br/>      - name: whereami<br/>        image: us-docker.pkg.dev/google-samples/containers/gke/whereami:v1.2.11<br/>        ports:<br/>          - containerPort: 8080<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: hello-world<br/>  annotations:<br/>    networking.gke.io/max-rate-per-endpoint: "10"</span></pre><p id="5cd2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">上述YAML将创建:</p><ul class=""><li id="ad4c" class="ky kz hi iw b ix iy jb jc jf mm jj mn jn mo jr mp lg lh li bi translated">有两个副本的部署。</li><li id="0d7c" class="ky kz hi iw b ix lj jb lk jf ll jj lm jn ln jr mp lg lh li bi translated">通过<code class="du mq mr ms md b"><strong class="iw hj">max-rate-per-endpoint</strong></code> <strong class="iw hj"> </strong>注释将服务容量设置为<code class="du mq mr ms md b"><strong class="iw hj">10</strong></code>的ClusterIP服务。</li></ul><blockquote class="lo lp lq"><p id="212a" class="iu iv lr iw b ix iy iz ja jb jc jd je ls jg jh ji lt jk jl jm lu jo jp jq jr hb bi translated"><a class="ae js" href="https://cloud.google.com/kubernetes-engine/docs/concepts/traffic-management#service_capacity" rel="noopener ugc nofollow" target="_blank">服务容量</a>在使用基于流量的自动扩展时是一个关键元素，因为它定义了服务在每个Pod上每秒应接收的最大请求流量。它是使用服务注释<code class="du mq mr ms md b">networking.gke.io/max-rate-per-endpoint</code>配置的。</p></blockquote><h1 id="a7ff" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">创建网关资源</h1><p id="de23" class="pw-post-body-paragraph iu iv hi iw b ix la iz ja jb lb jd je jf lv jh ji jj lw jl jm jn lx jp jq jr hb bi translated">使用GKE网关向外界公开应用程序。</p><pre class="ly lz ma mb fd mc md me bn mf mg bi"><span id="d726" class="mh kb hi md b be mi mj l mk ml">kind: Gateway<br/>apiVersion: gateway.networking.k8s.io/v1beta1<br/>metadata:<br/>  name: hello-world<br/>spec:<br/>  gatewayClassName: gke-l7-gxlb<br/>  listeners:<br/>  - name: http<br/>    protocol: HTTP<br/>    port: 80</span></pre><p id="1694" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">上述YAML将为GKE集群创建全局HTTP负载平衡器:</p><ul class=""><li id="c105" class="ky kz hi iw b ix iy jb jc jf mm jj mn jn mo jr mp lg lh li bi translated"><code class="du mq mr ms md b">gatewayClassName: gke-l7-gxlb</code>:指定网关类。<code class="du mq mr ms md b">gke-l7-rilb</code>对应全局外部HTTP(S)负载均衡器。</li><li id="eb54" class="ky kz hi iw b ix lj jb lk jf ll jj lm jn ln jr mp lg lh li bi translated"><code class="du mq mr ms md b">port: 80</code>:指定网关仅公开端口80来监听HTTP流量。</li></ul><blockquote class="lo lp lq"><p id="ef54" class="iu iv lr iw b ix iy iz ja jb jc jd je ls jg jh ji lt jk jl jm lu jo jp jq jr hb bi translated">仅单GKE集群的全局和内部负载平衡器支持基于流量的自动扩展。有关网关类功能的更多信息，请参考官方<a class="ae js" href="https://cloud.google.com/kubernetes-engine/docs/how-to/gatewayclass-capabilities" rel="noopener ugc nofollow" target="_blank">文档</a>。</p></blockquote><h1 id="4f31" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">创建HTTPRoute</h1><p id="99d3" class="pw-post-body-paragraph iu iv hi iw b ix la iz ja jb lb jd je jf lv jh ji jj lw jl jm jn lx jp jq jr hb bi translated">创建一个<a class="ae js" href="https://cloud.google.com/kubernetes-engine/docs/concepts/gateway-api#httproute" rel="noopener ugc nofollow" target="_blank"> HTTPRoute </a>资源，它定义了特定于协议的规则，用于将流量从网关映射到Kubernetes后端服务。</p><pre class="ly lz ma mb fd mc md me bn mf mg bi"><span id="76b9" class="mh kb hi md b be mi mj l mk ml">kind: HTTPRoute<br/>apiVersion: gateway.networking.k8s.io/v1beta1<br/>metadata:<br/>  name: hello-world<br/>  labels:<br/>    gateway: hello-world<br/>spec:<br/>  parentRefs:<br/>  - name: hello-world<br/>  rules:<br/>  - backendRefs:<br/>    - name: hello-world<br/>      port: 8080</span></pre><p id="370c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">上述YAML将以下列方式创建路由规则:</p><ul class=""><li id="1f71" class="ky kz hi iw b ix iy jb jc jf mm jj mn jn mo jr mp lg lh li bi translated">去往网关IP的所有流量都去往服务<code class="du mq mr ms md b">hello-world</code>。</li></ul><p id="1cce" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这是一个非常简单的HTTPRoute，但我们可以基于主机、路径甚至基于报头的路由来生成更复杂的流量路由。</p><h1 id="f18f" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">测试应用程序</h1><p id="dc9f" class="pw-post-body-paragraph iu iv hi iw b ix la iz ja jb lb jd je jf lv jh ji jj lw jl jm jn lx jp jq jr hb bi translated">获取网关创建的HTTP负载平衡器的IP地址，并访问应用程序。</p><pre class="ly lz ma mb fd mc md me bn mf mg bi"><span id="c347" class="mh kb hi md b be mi mj l mk ml">export GATEWAY_IP_ADDRESS=`kubectl get gateway -o=jsonpath='{.items[?(@.metadata.name=="hello-world")].status.addresses[0].value}'`<br/>curl http://$GATEWAY_IP_ADDRESS/</span></pre><p id="ec32" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您应该会得到如下回应:</p><figure class="ly lz ma mb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mt"><img src="../Images/a1a391110140d20fac87143d68c26b54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nBguLUIl8x-k3kUOJzGCpw.png"/></div></div></figure><p id="b923" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，我们已经设置好了应用程序，并准备好部署HPA。</p><h1 id="c1dc" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">部署HPA</h1><p id="8e13" class="pw-post-body-paragraph iu iv hi iw b ix la iz ja jb lb jd je jf lv jh ji jj lw jl jm jn lx jp jq jr hb bi translated">部署基于流量的HPA。</p><pre class="ly lz ma mb fd mc md me bn mf mg bi"><span id="7371" class="mh kb hi md b be mi mj l mk ml">apiVersion: autoscaling/v2<br/>kind: HorizontalPodAutoscaler<br/>metadata:<br/>  name: hello-world<br/>spec:<br/>  scaleTargetRef:<br/>    apiVersion: apps/v1<br/>    kind: Deployment<br/>    name: hello-world<br/>  minReplicas: 1<br/>  maxReplicas: 10<br/>  metrics:<br/>  - type: Object<br/>    object:<br/>      describedObject:<br/>        kind: Service<br/>        name: hello-world<br/>      metric:<br/>        name: "autoscaling.googleapis.com|gclb-capacity-utilization"<br/>      target:<br/>        averageValue: 70<br/>        type: AverageValue</span></pre><p id="f298" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">上面的YAML描述了一个具有以下属性的<code class="du mq mr ms md b">HorizontalPodAutoscaler</code>:</p><ul class=""><li id="45f3" class="ky kz hi iw b ix iy jb jc jf mm jj mn jn mo jr mp lg lh li bi translated"><code class="du mq mr ms md b">scaleTargetRef.name: hello-world</code>:对<code class="du mq mr ms md b">hello-world</code>部署的引用，该部署定义了由水平Pod自动缩放器缩放的资源。</li><li id="5382" class="ky kz hi iw b ix lj jb lk jf ll jj lm jn ln jr mp lg lh li bi translated"><code class="du mq mr ms md b">metric.name: "autoscaling.googleapis.com|gclb-capacity-utilization"</code>:引用负载平衡器容量利用率度量进行自动扩展。</li><li id="3863" class="ky kz hi iw b ix lj jb lk jf ll jj lm jn ln jr mp lg lh li bi translated"><code class="du mq mr ms md b">averageValue: 70</code>:HPA的产能利用率目标平均值。</li></ul><h1 id="39dd" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">查看HPA的运行情况</h1><p id="9706" class="pw-post-body-paragraph iu iv hi iw b ix la iz ja jb lb jd je jf lv jh ji jj lw jl jm jn lx jp jq jr hb bi translated">现在让我们<a class="ae js" href="https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-multi-cluster-gateways#verify_traffic_using_load_testing" rel="noopener ugc nofollow" target="_blank">部署一个具有20个RPS的流量生成器</a>来验证基于流量的自动伸缩行为。用您的网关IP地址更新<code class="du mq mr ms md b">GATEWAY_IP_ADDRESS</code>。</p><pre class="ly lz ma mb fd mc md me bn mf mg bi"><span id="0888" class="mh kb hi md b be mi mj l mk ml">kubectl run --context=gke-gateway-demo -i --tty --rm loadgen  \<br/>    --image=cyrilbkr/httperf  \<br/>    --restart=Never  \<br/>    -- /bin/sh -c 'httperf  \<br/>    --server=GATEWAY_IP_ADDRESS \<br/>    --hog --uri="/zone" --port 80  --wsess=100000,1,1 --rate 20'</span></pre><p id="4cd3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">部署扩展到大约4个副本，因此每个副本理想情况下接收5 RPS的流量，即每个Pod 50%的利用率。这低于70%的目标利用率，因此可以适当扩展机架。</p><figure class="ly lz ma mb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/1003e448f6f177f8fe5c6db9650b6cec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T0jk5JCVFoBzmX0-zi_1cg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">高功率放大器（high-power amplifier的缩写）</figcaption></figure><p id="18c9" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">根据流量波动，自动缩放副本的数量也可能会波动。</p><p id="0f7c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">自动缩放器尝试缩放副本以实现以下等式:</p><blockquote class="lo lp lq"><p id="48f9" class="iu iv lr iw b ix iy iz ja jb jc jd je ls jg jh ji lt jk jl jm lu jo jp jq jr hb bi translated">副本数=上限[当前流量/(平均利用率*每个端点的最大速率)]</p></blockquote><h1 id="8d8d" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">结论</h1><p id="88f9" class="pw-post-body-paragraph iu iv hi iw b ix la iz ja jb lb jd je jf lv jh ji jj lw jl jm jn lx jp jq jr hb bi translated">我们已经在实践中了解了如何利用本地网关功能在GKE集群中实现基于流量的工作负载自动扩展。在Istio、Prometheus和Prometheus adapter等服务网格的帮助下，我们也可以做到这一点。但是通过GKE网关，这是内置的，不需要任何服务网格和适配器。</p><p id="0d36" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">请记住，基于GKE网关控制器流量的自动缩放仍处于<a class="ae js" href="https://cloud.google.com/kubernetes-engine/docs/how-to/gatewayclass-capabilities#gatewayclass_capabilities" rel="noopener ugc nofollow" target="_blank">预览模式</a>，随着正式上市，您可以期待一些变化。</p><p id="625f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">请参考官方文档以了解更多关于<a class="ae js" href="https://cloud.google.com/kubernetes-engine/docs/concepts/gateway-api" rel="noopener ugc nofollow" target="_blank"> GKE门户</a>的信息。希望你觉得有用。快乐学习。</p></div></div>    
</body>
</html>