# äº‘è¿è¡Œä¸Šçš„ gRPC

> åŸæ–‡ï¼š<https://medium.com/google-cloud/grpc-on-cloud-run-743ed586d4ad?source=collection_archive---------1----------------------->

![](img/afe0883521bf1d8f78d238bd2759b9a4.png)

gRPC +äº‘è¿è¡Œ

gRPC æ˜¯ä¸€ä¸ªç°ä»£çš„ã€å¼€æºçš„ã€é«˜æ€§èƒ½çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)æ¡†æ¶ï¼Œå¯ä»¥åœ¨ä»»ä½•ç¯å¢ƒä¸­è¿è¡Œã€‚å®ƒå…è®¸æ‚¨ç›´æ¥è°ƒç”¨å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºï¼Œå°±åƒå®ƒæ˜¯ä¸€ä¸ªæœ¬åœ°æœåŠ¡ä¸€æ ·ã€‚æ‚¨è¿˜å¯ä»¥åœ¨æœåŠ¡ä¹‹é—´é«˜æ•ˆåœ°ä¼ è¾“æ•°æ®ã€‚æ­¤å¤–ï¼ŒGoogle APIs é€šè¿‡ gRPC æ”¯æŒè¯·æ±‚ï¼Œå…è®¸æ‚¨æ„å»ºé«˜æ•ˆã€é«˜ååé‡çš„ç³»ç»Ÿã€‚

åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç» gRPC åè®®ä»¥åŠå¦‚ä½•åœ¨äº‘è¿è¡Œä¸­ä½¿ç”¨å®ƒä»¬ï¼

## äº†è§£ gRPC

gRPC å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯ä»¥åœ¨å„ç§ç¯å¢ƒä¸­è¿è¡Œå¹¶ç›¸äº’å¯¹è¯â€”â€”ä» Google å†…éƒ¨çš„æœåŠ¡å™¨åˆ°æ‚¨è‡ªå·±çš„æ¡Œé¢â€”â€”å¹¶ä¸”å¯ä»¥ç”¨ gRPC æ”¯æŒçš„ä»»ä½•è¯­è¨€ç¼–å†™ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°ç”¨ Java åˆ›å»º gRPC æœåŠ¡å™¨ï¼Œç”¨ Goã€Python æˆ– Ruby åˆ›å»ºå®¢æˆ·æœºã€‚

è¿™æ˜¯ä¸€å¼ å›¾ç‰‡:

![](img/c9071ea889c7de08abb0ef9255f1455c.png)

ä¸€ä¸ª C++ gRPC æœåŠ¡å™¨ä¸ä¸€ä¸ª Ruby å’Œ Android å®¢æˆ·ç«¯å¯¹è¯ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒgRPC ä½¿ç”¨ [**åè®®ç¼“å†²åŒº**](https://developers.google.com/protocol-buffers) è¿›è¡Œæ•°æ®åºåˆ—åŒ–ã€‚ä½¿ç”¨åè®®ç¼“å†²åŒºçš„ç¬¬ä¸€æ­¥æ˜¯ä¸ºæˆ‘ä»¬è¦åœ¨`.proto`æ–‡ä»¶ä¸­å‘é€çš„æ•°æ®å®šä¹‰*ç»“æ„*ï¼Œæ¶ˆæ¯åŒ…æ‹¬å¦‚ä¸‹å­—æ®µ:

```
// A Person message.
// Numbers are used to *identify* fields in the binary encoded data. **message** **Person** {
  **string** name = 1;
  **int32** id = 2;
  **bool** likes_dogecoin = 3;
}
```

`protoc`å·¥å…·å¯ä»¥åŸºäºè¿™ä¸ª`proto`æ–‡ä»¶ç”Ÿæˆè¯­è¨€å®šä¹‰ã€‚

> æ³¨:`protoc`å¯ä»¥ç”¨`brew install protobuf`å’Œ[å…¶ä»–æ–¹å¼](https://grpc.io/docs/protoc-installation/)å®‰è£…ã€‚

## ç¤ºä¾‹åº”ç”¨ç¨‹åº:è®¡ç®—å™¨

è®©æˆ‘ä»¬æ„å»ºä¸€ä¸ªç¤ºä¾‹åº”ç”¨ç¨‹åºâ€”â€”ä¸€ä¸ªé€šè¿‡ gRPC æ¥å—è®¡ç®—è¯·æ±‚çš„è®¡ç®—å™¨ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹`calculator.proto`çš„å®šä¹‰:

åŒ…å«æ¶ˆæ¯å’ŒæœåŠ¡çš„æ ·æœ¬åŸå‹æ–‡ä»¶ã€‚

åŸå‹æ–‡ä»¶ä»ä¸€äº›å®šä¹‰å’ŒæœåŠ¡ RPC æ¥å£å¼€å§‹ã€‚ä¸æ™®é€šçš„å‡½æ•°è°ƒç”¨ä¸€æ ·ï¼Œ`Calculate` rpc æ¥å—ä¸¤ä¸ªæµ®ç‚¹æ•°å’Œ`ADD`æˆ–`SUBTRACT`çš„æ“ä½œã€‚è¯¥æœåŠ¡æœŸå¾…ä¸€ä¸ª`BinaryOperation`æ¶ˆæ¯å¹¶è¿”å›ä¸€ä¸ª`CalculationResult`æ¶ˆæ¯ã€‚

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªè¿™æ ·çš„èŠ‚ç‚¹æœåŠ¡æ¥ä¾¦å¬ gRPC è¯·æ±‚(ä¸æ˜¯ HTTP è¯·æ±‚):

å¸¦æœ‰è®¡ç®—å™¨æœåŠ¡çš„ gRPC æœåŠ¡å™¨ã€‚

> æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨äº†`createInsecure`æ–¹æ³•ã€‚Cloud Run çš„ä»£ç†ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ª TLS åŠ å¯†çš„ä»£ç†ï¼Œä¸ºæˆ‘ä»¬å¤„ç†è®¾ç½®è¯ä¹¦çš„éº»çƒ¦äº‹ã€‚ä»ä»£ç†åˆ°è£…æœ‰ gRPC æœåŠ¡å™¨çš„å®¹å™¨çš„æµé‡é€šè¿‡ä¸€ä¸ªåŠ å¯†çš„éš§é“ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦æ‹…å¿ƒè‡ªå·±å¤„ç†å®ƒã€‚Cloud Run åŸç”Ÿå¤„ç† HTTP/2ï¼Œæ‰€ä»¥ gRPC çš„ä¼ è¾“å¾—åˆ°äº†å¾ˆå¥½çš„æ”¯æŒã€‚

å½“æ‚¨ä½¿ç”¨`server.addService`æ—¶ï¼Œæ‚¨æ­£åœ¨å‘æœåŠ¡å™¨æ·»åŠ  *proto* æœåŠ¡ï¼Œè¿™å°†è°ƒç”¨`calculate`å‡½æ•°:

> å®Œæ•´ä»£ç åœ¨[https://github . com/grpc-ecosystem/grpc-cloud-run-example/tree/master/node](https://github.com/grpc-ecosystem/grpc-cloud-run-example/tree/master/node)

## éƒ¨ç½²åˆ°äº‘è¿è¡Œ

è®©æˆ‘ä»¬å°†è¿™ä¸ªæœåŠ¡éƒ¨ç½²åˆ° Cloud Runã€‚å¦‚æœæ²¡æœ‰ Dockerfileï¼Œæºä»£ç å°†ä½¿ç”¨ [Google Cloud Buildpacks](https://github.com/GoogleCloudPlatform/buildpacks) ï¼Œå®ƒå°†è‡ªåŠ¨æ£€æµ‹æˆ‘ä»¬çš„è¯­è¨€(å› ä¸º`package.json`è€Œæˆä¸ºèŠ‚ç‚¹)å¹¶æ„å»ºæˆ‘ä»¬çš„å®¹å™¨ã€‚

ä½¿ç”¨ Cloud Run çš„ä¸€ä¸ªå¥½å¤„æ˜¯å®ƒæ”¯æŒ gRPC å¼€ç®±å³ç”¨ï¼Œéƒ¨ç½²æ—¶ä¸éœ€è¦é¢å¤–çš„æ ‡å¿—ã€‚

> æ³¨æ„:å¦‚æœä½ æƒ³ç”¨ HTTP/2 æµ gRPCsï¼Œæ·»åŠ æ ‡å¿—`--use-http2` [ğŸ”—](https://cloud.google.com/run/docs/configuring/http2)ã€‚

ä½¿ç”¨`â€”-source`æ ‡å¿—éƒ¨ç½²äº‘è·‘åº”ç”¨ç¨‹åº:

```
gcloud beta run deploy --source .
```

ä¸ºäº†æµ‹è¯•æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥é¦–å…ˆè·å¾—è¿è¡Œç«¯ç‚¹ï¼Œç„¶åä½¿ç”¨`[grpcurl](https://github.com/fullstorydev/grpcurl)`ï¼Œä¸€ä¸ªç±»ä¼¼ cURL çš„å·¥å…·ï¼Œä½†æ˜¯å¯¹äº gRPC:

ä¸€ä¸ªç”¨äºäº‘è¿è¡Œæµ‹è¯•çš„ä¾¿æ·è„šæœ¬

å˜£ã€‚ç°åœ¨ä½ æœ‰äº†ä¸€ä¸ªè‡ªåŠ¨ç¼©æ”¾è®¡ç®—å™¨ gRPC æœåŠ¡ï¼

æˆ‘ä»¬åšåˆ°äº†ï¼å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹é“¾æ¥:

*   ğŸ™[https://github.com/grpc-ecosystem/grpc-cloud-run-example](https://github.com/grpc-ecosystem/grpc-cloud-run-example)
*   ğŸ“„[https://cloud.google.com/run/docs/triggering/grpc](https://cloud.google.com/run/docs/triggering/grpc)