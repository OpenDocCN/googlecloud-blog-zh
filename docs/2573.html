<html>
<head>
<title>GCP — Break the shutdown period limitation and perform backup for Managed Instance Group VMs as long as required</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP —打破关闭时间限制，根据需要对托管实例组虚拟机执行备份</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-managed-instance-group-extend-vm-shutdown-period-beyond-90-sec-b1faad24ac6a?source=collection_archive---------3-----------------------#2022-11-30">https://medium.com/google-cloud/gcp-managed-instance-group-extend-vm-shutdown-period-beyond-90-sec-b1faad24ac6a?source=collection_archive---------3-----------------------#2022-11-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9a0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">托管实例组(MIG)使用您指定的实例模板创建虚拟机实例。当MIG确定虚拟机由于自动扩展或自动修复操作而需要删除或重新创建时，它会将虚拟机置于停止状态，然后关闭虚拟机。在这里，MIG允许您运行最多90秒的关机脚本，以确保您的进程正常关闭。<a class="ae jd" href="https://cloud.google.com/compute/docs/shutdownscript#specifications" rel="noopener ugc nofollow" target="_blank">这里的</a>是GCP强制执行的停机时间限制，以及对B <a class="ae jd" href="https://b.corp.google.com/issues/35904817" rel="noopener ugc nofollow" target="_blank"> uganizer </a>的相同功能要求。</p></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><p id="10d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博客中，我将向您展示如何开发一个框架来帮助您实现延长的停机时间，以执行长时间运行的备份操作，该操作可以超过90秒或您想要的任何时间。只有当您的系统满足以下要求时，该解决方案才有效:</p><ul class=""><li id="f37b" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">您有一个包含按需实例的托管实例组</li><li id="c263" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">MIG在横向扩展模式下启用了自动扩展</li><li id="db0a" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">米格已经关闭了自动修复功能。自动修复方面由框架负责。因此，您需要禁用自动修复功能</li><li id="6691" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">MIG可以通过负载平衡器、发布/订阅或任何其他技术实现负载平衡。该框架的工作与所使用的负载平衡器无关</li><li id="992b" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">米格公司在机会主义模式下部署战略</li></ul></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><h1 id="89ed" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">概观</h1><p id="dd09" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">当实例由于扩展或自动修复而被确定为关闭时，想法是将其转换为独立的虚拟机(从MIG中取出虚拟机),以便根据需要在虚拟机进程上执行备份或任何其他长时间操作。这些操作包括将应用程序日志、系统日志、网络日志、内存转储、线程转储和任何其他文件存储到远程存储中。为了确保虚拟机不会永远运行，一旦虚拟机的TTL(生存时间)过去，它们就会被外部服务关闭。如果虚拟机上的所有操作都在TTL之前完成，也可以通过内部脚本删除/关闭虚拟机。通过将实例模板元数据设置为</p><pre class="lc ld le lf fd lg lh li bn lj lk bi"><span id="fda1" class="ll ka hi lh b be lm ln l lo lp">vm_shutdown_extenstion_enabled:yes/no.</span></pre></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><p id="7f9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该解决方案针对部署在特定区域的所有MIG。如果您想在全球范围内覆盖MIG，您必须在所有需要的地区单独部署该解决方案。下面是该框架如何处理MIG的主要方面:</p><p id="65cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">自动缩放:</strong>MIG配置为横向扩展模式，而横向扩展决策仍由自动缩放器做出，实际的移除或删除由外部服务完成。这样，缩放计算/决策由GCP管理，不会给系统带来任何额外开销。由于该解决方案根据autoscaler建议的大小来控制虚拟机的删除，因此可以按照所需的顺序删除虚拟机。例如，可以根据创建时间戳首先删除较旧的实例。</p><p id="9aa0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">自动修复</strong>:米格战机在自动修复被禁用的情况下被制造。虚拟机的运行状况由外部服务跟踪。运行在独立虚拟机(每个MIG一个虚拟机)上的外部服务仅在运行状况检查探测失败的次数达到不正常阈值时，才从MIG中执行实例删除(放弃)。它只跟踪处于<em class="lq">运行</em>状态且<em class="lq">无</em>动作由MIG执行的虚拟机。它从为特定MIG创建的运行状况检查资源中加载运行状况检查配置。该链接在MIG模板元数据中被声明为<em class="lq">健康检查名称:{http检查资源名称}。</em></p><p id="b93d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">部署:</strong>该解决方案支持机会主义的部署模式，即使用新版本的模板/代码创建新实例。由于虚拟机的删除可以按其创建日期的升序进行，因此较旧的实例会首先被扩展，从而使新实例在部署过程中保持部署状态，不会受到扩展操作的影响或被删除。</p><p id="9f47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">先决条件:</strong> MIG实例模板应具有以下元数据-</p><pre class="lc ld le lf fd lg lh li bn lj lk bi"><span id="5875" class="ll ka hi lh b be lm ln l lo lp">1. vm_shutdown_extension_enabled: yes/no <br/>  -  This is to have the flexibility of switching off/on the solution.<br/>2. vm_time_to_live: 30 (No hard limit. To be entered in mins)<br/>  - It lets instances live till the TTL elapses after removal.<br/>3. health_check_name: {http_check_resource_name}.</span></pre><p id="8fd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">高层次设计:</strong>下面的架构概述了端到端流程和涉及的各种组件。云功能是区域性的，作用于所有的MIG。以下解决方案充分利用了计算引擎、MIG管理器和自动缩放器所提供的rest APIs您还可以利用Google提供的客户端库来使用这些API。API参考请参考附录部分。建筑组件:</p><pre class="lc ld le lf fd lg lh li bn lj lk bi"><span id="86ef" class="ll ka hi lh b be lm ln l lo lp">1. Cloud Scheduler<br/>2. Cloud Functions<br/>3. Cloud Logging and alerts<br/>4. MIGs<br/>5. Stand-alone VM<br/>6. Cron Job</span></pre><figure class="lc ld le lf fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es lr"><img src="../Images/45ede0934b7a39efb6d706aca12eb8a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FRFzNX4TckzWdaHIp-S9qw.png"/></div></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">推迟MIG随需应变实例关闭的架构(在新选项卡中打开图像以便清晰查看)</figcaption></figure><h2 id="e872" class="md ka hi bd kb me mf mg kf mh mi mj kj iq mk ml kn iu mm mn kr iy mo mp kv mq bi translated"><strong class="ak">组件:</strong></h2><p id="ac12" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated"><strong class="ih hj"> <em class="lq">云函数【resizeInstanceGroups】:</em></strong><em class="lq">resizeInstanceGroup</em>函数由来自云调度器作业的pub/sub消息每5分钟周期性触发，输入<em class="lq">区域</em>和<em class="lq">项目列表</em>。该服务跟踪来自自动缩放器的<em class="lq">推荐大小</em>和来自MIGs的当前大小，以决定是否扩大。如果recommendedSize小于currentSize，服务将放弃较旧的实例，使当前大小等于建议的大小。它不会删除实例，而是放弃它们，以便在不关闭的情况下从MIG中排除它们进行备份活动。</p><p id="2956" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="lq">云函数【deleteInstanceGroupVMs】:</em></strong>该函数加载所有为特定MIG启用关机扩展的废弃虚拟机。它通过从当前时期减去移除时期来计算虚拟机的年龄，以确保如果差异超过TTL间隔，则删除它们。它还会为虚拟机生成缺失TTL和删除时期的警报，以便让管理员了解无法由外部服务删除的虚拟机。这个函数可以增加丢失的删除时间，以确保在以后的运行中删除虚拟机。</p><p id="13ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="lq">独立虚拟机:</em> </strong>虚拟机有一个元数据来知道它必须探测的MIG。元数据可以设置如下:</p><pre class="lc ld le lf fd lg lh li bn lj lk bi"><span id="9912" class="ll ka hi lh b be lm ln l lo lp">MIG_name: {target_mig_name}</span></pre><p id="1e99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虚拟机运行一个服务来为指定的MIG执行运行状况检查。它从虚拟机元数据中提到的指定运行状况检查资源加载运行状况检查配置。然后，如果达到故障阈值，它会探测虚拟机以启动删除操作。一旦虚拟机被删除或放弃，在其中运行的cron作业将在删除函数的epoch中设置删除时间，以计算虚拟机的年龄。如果由于虚拟机冻结而无法由内部作业设置移除时间，则删除服务将添加缺失的移除时间标签。</p><p id="b353" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="lq"> Cron job: </em> </strong>它等待虚拟机变成废弃状态<em class="lq">(虚拟机不是MIG的一部分。请参考附录中提到的API，了解如何检查虚拟机是否不再是MIG的一部分)</em>。一旦虚拟机被声明为被放弃，它就用<em class="lq">删除时期(当前时期)</em>时间来标记虚拟机，删除服务使用该时间来跟踪其年龄并做出删除决定。最后，脚本可以按照客户编写的脚本触发备份操作。备份脚本可以更新TTL值，以继续推迟由deleteInstanceGroupVMs函数控制的删除操作。</p><p id="392f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意事项</strong>:</p><ul class=""><li id="300b" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">该解决方案适用于所有MIG，与负载平衡策略无关。</li><li id="3b6f" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">放弃虚拟机时，连接排出不受影响；虚拟机仍在等待连接耗尽期结束，然后才真正从MIG中删除它们。</li><li id="450f" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">放弃操作不会影响虚拟机的运行进程，因此可以轻松获取内存和线程快照。</li><li id="b41f" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">由于云功能是由GCP管理的无服务器平台即服务，它可以自动扩展到最大限度。它符合可伸缩性要求。</li><li id="a0fd" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">正确设置日志和警报将确保系统的可靠性。</li><li id="59b8" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">TTL告诉虚拟机在删除后应该保持活动状态多长时间。如果需要延长时间(超过30分钟)，可以通过增加time_to_live元数据值以编程方式完成。</li><li id="4115" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">此框架不考虑用户启动的重启、选择性模式下的虚拟机更新或虚拟机更换。由于这些是由用户从控制台或脚本启动的强制操作，因此客户端需要在启动此类操作之前远程运行备份。</li></ul><p id="c928" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">记录:</strong></p><ul class=""><li id="bcff" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">需要为云功能和调度程序生成日志，以确保<em class="lq"> resizeInstanceGroup </em>和<em class="lq"> deleteInstanceGroupVMs </em>正常工作，并且MIG实例在需要时被移除和删除。</li><li id="44b3" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">虚拟机移除的原因由云功能和独立虚拟机记录。最终用户可以创建控制面板或生成警报，以便随时了解情况。</li></ul><p id="95c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">警报:</strong>您可以生成以下警报，以避免因虚拟机持续运行而造成的成本损失:</p><ul class=""><li id="5908" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">如果云功能没有以预期的方式运行。</li><li id="f6d1" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">如果启用了该功能的任何被放弃的实例缺少生存时间和删除时期值。</li><li id="5855" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">如果正在删除虚拟机。</li></ul><p id="e7ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">改进</strong>:</p><ul class=""><li id="4271" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">在GCP，独立虚拟机可以被云功能或任何其他计算选项所取代。</li><li id="303e" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">备份脚本可以由外部服务触发。您可以让外部服务监视被放弃的虚拟机，这也会触发备份。</li></ul><p id="1a79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">附录:<strong class="ih hj"> API引用:</strong></p><ul class=""><li id="e935" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">I <a class="ae jd" href="https://cloud.google.com/compute/docs/reference/rest/v1/regionInstanceGroupManagers" rel="noopener ugc nofollow" target="_blank">实例组管理器API</a></li><li id="627b" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated"><a class="ae jd" href="https://cloud.google.com/compute/docs/reference/rest/v1/autoscalers/get" rel="noopener ugc nofollow" target="_blank">自动缩放APIs获取推荐的大小</a></li><li id="a5f4" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated"><a class="ae jd" href="https://cloud.google.com/compute/docs/reference/rest/v1/regionInstanceGroups/listInstances" rel="noopener ugc nofollow" target="_blank">实例组API</a></li><li id="6fd9" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated"><a class="ae jd" href="https://cloud.google.com/compute/docs/reference/rest/v1/regionInstanceGroupManagers/abandonInstances" rel="noopener ugc nofollow" target="_blank">放弃的实例</a></li><li id="1863" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated"><a class="ae jd" href="https://cloud.google.com/compute/docs/reference/rest/v1/regionInstanceGroupManagers/deleteInstances" rel="noopener ugc nofollow" target="_blank">删除实例</a></li><li id="e5fb" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated"><a class="ae jd" href="https://cloud.google.com/compute/docs/reference/rest/v1/regionInstanceGroupManagers/listManagedInstances" rel="noopener ugc nofollow" target="_blank">列出实例</a></li></ul></div></div>    
</body>
</html>