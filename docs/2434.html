<html>
<head>
<title>Use Google Cloud Spanner with the Online Boutique sample</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用谷歌云扳手与在线精品样本</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/use-google-cloud-spanner-with-the-online-boutique-sample-apps-f7248e077339?source=collection_archive---------2-----------------------#2022-10-18">https://medium.com/google-cloud/use-google-cloud-spanner-with-the-online-boutique-sample-apps-f7248e077339?source=collection_archive---------2-----------------------#2022-10-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="198a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">于2022年12月8日更新，通过其</em> <a class="ae je" rel="noopener" href="/google-cloud/246119e46d53"> <em class="jd">掌舵图</em> </a> <em class="jd">部署线上精品。</em></p><p id="e988" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，<a class="ae je" href="https://github.com/GoogleCloudPlatform/microservices-demo" rel="noopener ugc nofollow" target="_blank">在线精品样本</a>的<code class="du jf jg jh ji b">cartservice</code>将其数据存储在集群内Redis数据库中。然而，在你的Google Kubernetes引擎(GKE)集群之外使用一个完全托管的数据库服务，比如<a class="ae je" rel="noopener" href="/google-cloud/64b71969318d"> Memorystore (Redis) </a>可以带来更大的弹性和更高的安全性。</p><p id="052e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从最近的<a class="ae je" href="https://github.com/GoogleCloudPlatform/microservices-demo/releases/tag/v0.4.0" rel="noopener ugc nofollow" target="_blank"> v0.4.0版本</a>开始，在线精品样本现在可以将其数据存储在<a class="ae je" href="https://cloud.google.com/spanner" rel="noopener ugc nofollow" target="_blank"> Google Cloud Spanner </a>中。</p><blockquote class="jj"><p id="b71d" class="jk jl hi bd jm jn jo jp jq jr js jc dx translated"><em class="jt"> Cloud Spanner是一款全托管的关系数据库，规模不限，一致性强，可用性高达99.999%。</em></p></blockquote></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><p id="02bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，让我们看看如何将在线精品示例连接到Google Cloud Spanner。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/bf5f3749217883423ee1caac9ae4e212.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*A8lG1q1M29P72YWY.png"/></div></div></figure></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="6c3e" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">目标</h1><ul class=""><li id="c096" class="ll lm hi ih b ii ln im lo iq lp iu lq iy lr jc ls lt lu lv bi translated">创建一个带有工作负载标识的Google Kubernetes引擎(GKE)集群</li><li id="50d6" class="ll lm hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">为扳手数据库提供一个<a class="ae je" href="https://cloud.google.com/blog/products/spanner/try-cloud-spanner-databases" rel="noopener ugc nofollow" target="_blank">自由扳手实例</a></li><li id="40b0" class="ll lm hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">授予<code class="du jf jg jh ji b">cartservice</code>的服务帐户以最低权限角色分配访问扳手数据库的权限</li><li id="bb61" class="ll lm hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">部署连接到扳手数据库的在线精品样本及其舵图</li></ul></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="bea8" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">费用</h1><p id="e3f1" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated">本教程使用Google Cloud的付费组件，包括:</p><ul class=""><li id="4894" class="ll lm hi ih b ii ij im in iq me iu mf iy mg jc ls lt lu lv bi translated"><a class="ae je" href="https://cloud.google.com/kubernetes-engine/pricing" rel="noopener ugc nofollow" target="_blank"> Kubernetes发动机</a></li><li id="ff0d" class="ll lm hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated"><a class="ae je" href="https://cloud.google.com/spanner/pricing" rel="noopener ugc nofollow" target="_blank">扳手</a>(在本教程中，我们将利用<a class="ae je" href="https://cloud.google.com/blog/products/spanner/try-cloud-spanner-databases" rel="noopener ugc nofollow" target="_blank">自由扳手实例</a>)。</li></ul><p id="3b6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<a class="ae je" href="https://cloud.google.com/products/calculator" rel="noopener ugc nofollow" target="_blank">定价计算器</a>根据您的预计使用量生成成本估算。</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="76d9" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">开始之前</h1><p id="9726" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated">本指南假设您拥有Google Cloud项目的所有者IAM权限。在生产中，您不需要所有者许可。</p><ol class=""><li id="01b0" class="ll lm hi ih b ii ij im in iq me iu mf iy mg jc mh lt lu lv bi translated"><a class="ae je" href="https://console.cloud.google.com/projectselector2" rel="noopener ugc nofollow" target="_blank">选择或创建一个谷歌云项目</a>。</li><li id="074a" class="ll lm hi ih b ii lw im lx iq ly iu lz iy ma jc mh lt lu lv bi translated"><a class="ae je" href="https://cloud.google.com/billing/docs/how-to/modify-project" rel="noopener ugc nofollow" target="_blank">验证您的项目是否启用了计费</a>。</li></ol></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="1aeb" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">设置您的环境</h1><p id="f6aa" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated">初始化本教程中使用的通用变量:</p><pre class="kc kd ke kf fd mi ji mj mk aw ml bi"><span id="4569" class="mm ko hi ji b fi mn mo l mp mq">PROJECT_ID=FIXME-WITH-YOUR-PROJECT-ID<br/>REGION=us-east5<br/>ZONE=us-east5-a</span></pre><p id="94cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了避免在整个教程中重复命令中的<code class="du jf jg jh ji b">--project</code>,让我们设置当前项目:</p><pre class="kc kd ke kf fd mi ji mj mk aw ml bi"><span id="690d" class="mm ko hi ji b fi mn mo l mp mq">gcloud config set project ${PROJECT_ID}</span></pre></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="381a" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">在项目中启用所需的API</h1><p id="9606" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated">在项目中启用所需的API:</p><pre class="kc kd ke kf fd mi ji mj mk aw ml bi"><span id="4527" class="mm ko hi ji b fi mn mo l mp mq">gcloud services enable \<br/>    spanner.googleapis.com \<br/>    container.googleapis.com</span></pre></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="71d4" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">创建GKE集群</h1><p id="29be" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated">创建启用了工作负荷标识的GKE集群:</p><pre class="kc kd ke kf fd mi ji mj mk aw ml bi"><span id="e4cb" class="mm ko hi ji b fi mn mo l mp mq">CLUSTER=spanner-with-onlineboutique<br/>gcloud container clusters create ${CLUSTER} \<br/>    --zone ${ZONE} \<br/>    --machine-type=e2-standard-4 \<br/>    --num-nodes 4 \<br/>    --workload-pool ${PROJECT_ID}.svc.id.goog</span></pre></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="8bb5" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">提供扳手数据库</h1><p id="6b3c" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated">设置扳手实例:</p><pre class="kc kd ke kf fd mi ji mj mk aw ml bi"><span id="f290" class="mm ko hi ji b fi mn mo l mp mq">SPANNER_REGION_CONFIG=regional-${REGION}<br/>SPANNER_INSTANCE_NAME=onlineboutique</span><span id="999a" class="mm ko hi ji b fi mr mo l mp mq">gcloud spanner instances create ${SPANNER_INSTANCE_NAME} \<br/>    --description="online boutique shopping cart" \<br/>    --instance-type free-instance \<br/>    --config ${SPANNER_REGION_CONFIG}</span></pre><p id="f903" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">注意:使用最新版本的gcloud，我们可以提供一个</em> <a class="ae je" href="https://cloud.google.com/blog/products/spanner/try-cloud-spanner-databases" rel="noopener ugc nofollow" target="_blank"> <em class="jd">自由扳手实例</em> </a> <em class="jd">。</em></p><p id="4f97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提供扳手数据库:</p><pre class="kc kd ke kf fd mi ji mj mk aw ml bi"><span id="a442" class="mm ko hi ji b fi mn mo l mp mq">SPANNER_DATABASE_NAME=carts</span><span id="d549" class="mm ko hi ji b fi mr mo l mp mq">gcloud spanner databases create ${SPANNER_DATABASE_NAME} \<br/>    --instance ${SPANNER_INSTANCE_NAME} \<br/>    --database-dialect GOOGLE_STANDARD_SQL \<br/>    --ddl "CREATE TABLE CartItems (userId STRING(1024), productId STRING(1024), quantity INT64) PRIMARY KEY (userId, productId); CREATE INDEX CartItemsByUserId ON CartItems(userId);"</span></pre></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="abf8" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">授予<code class="du jf jg jh ji b">cartservice</code>的服务帐户访问扳手数据库的权限</h1><p id="f36f" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated">创建一个专用的最低权限Google服务帐户，允许<code class="du jf jg jh ji b">cartservice</code>的Kubernetes服务帐户与Spanner数据库通信；</p><pre class="kc kd ke kf fd mi ji mj mk aw ml bi"><span id="0169" class="mm ko hi ji b fi mn mo l mp mq">SPANNER_DB_USER_GSA_NAME=spanner-db-user-sa<br/>SPANNER_DB_USER_GSA_ID=${SPANNER_DB_USER_GSA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com<br/>ONLINEBOUTIQUE_NAMESPACE=onlineboutique<br/>CARTSERVICE_KSA_NAME=cartservice</span><span id="3b95" class="mm ko hi ji b fi mr mo l mp mq">gcloud iam service-accounts create ${SPANNER_DB_USER_GSA_NAME} \<br/>    --display-name=${SPANNER_DB_USER_GSA_NAME}</span><span id="3346" class="mm ko hi ji b fi mr mo l mp mq">gcloud spanner databases add-iam-policy-binding ${SPANNER_DATABASE_NAME} \<br/>    --instance ${SPANNER_INSTANCE_NAME} \<br/>    --member "serviceAccount:${SPANNER_DB_USER_GSA_ID}" \<br/>    --role roles/spanner.databaseUser</span><span id="fe15" class="mm ko hi ji b fi mr mo l mp mq">gcloud iam service-accounts add-iam-policy-binding ${SPANNER_DB_USER_GSA_ID} \<br/>    --member "serviceAccount:${PROJECT_ID}.svc.id.goog[${ONLINEBOUTIQUE_NAMESPACE}/${CARTSERVICE_KSA_NAME}]" \<br/>    --role roles/iam.workloadIdentityUser</span></pre></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="7893" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">部署连接到扳手数据库的在线精品</h1><p id="efb9" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated">为了自动部署与Spanner集成的在线精品，我们将利用其相关的Helm图表:</p><pre class="kc kd ke kf fd mi ji mj mk aw ml bi"><span id="a35f" class="mm ko hi ji b fi mn mo l mp mq">SPANNER_CONNECTION_STRING=projects/<!-- -->${PROJECT_ID}<!-- -->/instances/<!-- -->${SPANNER_INSTANCE_NAME}<!-- -->/databases/<!-- -->${SPANNER_DATABASE_NAME}</span><span id="e045" class="mm ko hi ji b fi mr mo l mp mq">helm upgrade onlineboutique oci://us-docker.pkg.dev/online-boutique-ci/charts/onlineboutique \<br/>    --install \<br/>    --create-namespace \<br/>    -n onlineboutique \<br/>    --set cartDatabase.inClusterRedis.create=false \<br/>    --set cartDatabase.type=spanner \<br/>    --set cartDatabase.connectionString=${SPANNER_CONNECTION_STRING} \<br/>    --set serviceAccounts.create=true \<br/>    --set serviceAccounts.annotationsOnlyForCartservice=true \<br/>    --set "serviceAccounts.annotations.iam\.gke\.io/gcp-service-account=<!-- -->${SPANNER_DB_USER_GSA_ID}<!-- -->"</span></pre><p id="ca0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有应用程序成功部署后，您可以点击以下链接导航至在线精品网站:</p><pre class="kc kd ke kf fd mi ji mj mk aw ml bi"><span id="5039" class="mm ko hi ji b fi mn mo l mp mq">echo -n "http://" &amp;&amp; kubectl get svc frontend-external -n ${ONLINEBOUTIQUE_NAMESPACE} -o json | jq -r '.status.loadBalancer.ingress[0].ip'</span></pre><p id="9b17" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从在线精品网站，您可以在购物车中添加一些产品，然后点击下面的链接，查看您和<code class="du jf jg jh ji b">loadgenerator</code>应用程序在扳手数据库中序列化的所有数据:</p><pre class="kc kd ke kf fd mi ji mj mk aw ml bi"><span id="57db" class="mm ko hi ji b fi mn mo l mp mq">echo -e "https://console.cloud.google.com/spanner/instances/${SPANNER_INSTANCE_NAME}/databases/${SPANNER_DATABASE_NAME}/tables/CartItems/details/data?project=${PROJECT_ID}"</span></pre><p id="e932" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">瞧。这就是你将在线精品样品连接到扳手数据库的简单方法，恭喜你！</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="6ffe" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">清理</h1><p id="b248" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated">为了避免向您的Google Cloud帐户收取费用，您可以删除本教程中使用的资源。</p><p id="1a47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除GKE群集:</p><pre class="kc kd ke kf fd mi ji mj mk aw ml bi"><span id="2518" class="mm ko hi ji b fi mn mo l mp mq">gcloud container clusters delete ${CLUSTER} \<br/>    --zone ${ZONE}</span></pre><p id="a16a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除扳手数据库:</p><pre class="kc kd ke kf fd mi ji mj mk aw ml bi"><span id="98ae" class="mm ko hi ji b fi mn mo l mp mq">gcloud spanner instances delete ${SPANNER_INSTANCE_NAME}</span></pre></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="cea8" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">结论</h1><p id="c440" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq mb is it iu mc iw ix iy md ja jb jc hb bi translated">通过托管服务将数据库部署在GKE集群之外，可以为您带来更高的弹性和安全性，而借助这一新的云扳手选项，在线精品店将变得更加高度可用。这种设置允许复杂的场景，比如将应用程序分布在多个集群中，等等。</p><p id="5ffe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于最初实现了<a class="ae je" href="https://www.linkedin.com/in/%F0%9F%8C%8Ddaniel-quinlan-51126016/" rel="noopener ugc nofollow" target="_blank"> Daniel Quinlan </a>，这个新的扳手选项现在在线精品GitHub资源库中的每个人都可以使用，请随意尝试一下<a class="ae je" href="https://github.com/GoogleCloudPlatform/microservices-demo/blob/main/helm-chart/values.yaml#L109" rel="noopener ugc nofollow" target="_blank">头盔图</a>或<a class="ae je" href="https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/kustomize/components/spanner" rel="noopener ugc nofollow" target="_blank"> Kustomize叠加图</a>！</p><p id="3726" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一帆风顺，干杯！</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><p id="1e8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">原帖</em><a class="ae je" href="https://mathieu-benoit.github.io/" rel="noopener ugc nofollow" target="_blank"><em class="jd">Mathieu-Benoit . github . io</em></a><em class="jd">。</em></p></div></div>    
</body>
</html>