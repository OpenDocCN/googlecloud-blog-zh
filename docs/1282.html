<html>
<head>
<title>Securing Google Cloud Functions Using Service Account and How to Access it in Service-Service Communications.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨æœåŠ¡å¸æˆ·ä¿æŠ¤Google CloudåŠŸèƒ½ä»¥åŠå¦‚ä½•åœ¨æœåŠ¡-æœåŠ¡é€šä¿¡ä¸­è®¿é—®å®ƒã€‚</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/google-cloud/securing-google-cloud-functions-using-service-account-and-how-to-access-it-in-service-service-582b4b5f210?source=collection_archive---------0-----------------------#2020-02-09">https://medium.com/google-cloud/securing-google-cloud-functions-using-service-account-and-how-to-access-it-in-service-service-582b4b5f210?source=collection_archive---------0-----------------------#2020-02-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1864" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloudçš„åŠŸèƒ½æä¾›äº†ä¸€ç§æœºåˆ¶æ¥ç¡®ä¿ä½ çš„æ¯ä¸ªç«¯ç‚¹åªè¢«å…è®¸çš„ç”¨æˆ·ä½¿ç”¨ï¼Œå³åˆ é™¤IAMä¸­çš„<code class="du jd je jf jg b">allUsers</code>å’Œ<code class="du jd je jf jg b">allAuthenticatedUsers</code>ã€‚å¯¹äºæœåŠ¡åˆ°æœåŠ¡çš„é€šä¿¡ï¼Œå½“æ‚¨æƒ³è¦åˆ›å»ºå¯¹Google Cloud Functionsç«¯ç‚¹çš„è¯·æ±‚æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æœåŠ¡å¸æˆ·æ¥ç”Ÿæˆä»¤ç‰Œã€‚Google OAuth 2.0ç³»ç»Ÿæ”¯æŒæœåŠ¡å™¨åˆ°æœåŠ¡å™¨çš„äº¤äº’ï¼Œä¾‹å¦‚webåº”ç”¨ç¨‹åºå’ŒGoogleæœåŠ¡ä¹‹é—´çš„äº¤äº’ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œæ‚¨éœ€è¦ä¸€ä¸ªæœåŠ¡å¸æˆ·ï¼Œå®ƒæ˜¯å±äºæ‚¨çš„åº”ç”¨ç¨‹åºçš„å¸æˆ·ï¼Œè€Œä¸æ˜¯å±äºå•ä¸ªæœ€ç»ˆç”¨æˆ·çš„å¸æˆ·ã€‚æ‚¨çš„åº”ç”¨ç¨‹åºä»£è¡¨æœåŠ¡å¸æˆ·è°ƒç”¨Google APIsï¼Œå› æ­¤ç”¨æˆ·ä¸ç›´æ¥å‚ä¸ã€‚åœ¨åº”ç”¨ç¨‹åºè·å¾—è®¿é—®ä»¤ç‰Œåï¼Œå®ƒåœ¨ä¸€ä¸ª<a class="ae jh" href="https://developer.mozilla.org/docs/Web/HTTP/Headers/Authorization" rel="noopener ugc nofollow" target="_blank"> HTTPæˆæƒè¯·æ±‚å¤´</a>ä¸­å°†ä»¤ç‰Œå‘é€ç»™Google APIã€‚</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div class="er es ji"><img src="../Images/258ffb83d237f399f4772524405f56c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:650/format:webp/1*eUMSytVOPLft36rVxLQSvA.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">æœåŠ¡å™¨åˆ°æœåŠ¡å™¨çš„é€šä¿¡ã€‚</figcaption></figure><p id="c7c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google æä¾›äº†å„ç§å®¢æˆ·ç«¯ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯<a class="ae jh" href="https://github.com/google/google-api-javascript-client" rel="noopener ugc nofollow" target="_blank"> Javascript </a>ã€‚åœ¨ä½¿ç”¨æ‚¨çš„æœåŠ¡å¸æˆ·ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²ç»ä¸ºæ‚¨çš„æœåŠ¡å¸æˆ·æ·»åŠ äº†<a class="ae jh" href="https://cloud.google.com/functions/docs/reference/iam/roles" rel="noopener ugc nofollow" target="_blank"> Google Cloud Functions IAM </a>ä¸­çš„<code class="du jd je jf jg b">roles/cloudfunctions.invoker</code>è§’è‰²ã€‚è¦è·å–JWTå®¢æˆ·ç«¯çš„ç”µå­é‚®ä»¶å’Œå¯†é’¥ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨çš„æœåŠ¡å¸æˆ·:</p><pre class="jj jk jl jm fd ju jg jv jw aw jx bi"><span id="62e1" class="jy jz hi jg b fi ka kb l kc kd">const fs = require('fs')</span><span id="a86d" class="jy jz hi jg b fi ke kb l kc kd">const SERVICE_ACCOUNT_PATH = process.env.GOOGLE_APPLICATION_CREDENTIALS</span><span id="5e45" class="jy jz hi jg b fi ke kb l kc kd">const rawServiceAccountData = fs.readFileSync(SERVICE_ACCOUNT_PATH)</span><span id="aa92" class="jy jz hi jg b fi ke kb l kc kd">const serviceAccount = JSON.parse(rawServiceAccountData)</span></pre><p id="7186" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">åœ¨calleråº”ç”¨ç¨‹åºä¸­ï¼Œæ‚¨å¯ä»¥æ·»åŠ ä»¥ä¸‹ä»£ç ï¼Œä»¥ä¾¿åœ¨æ¯æ¬¡æƒ³è¦åˆ›å»ºå¯¹äº‘å‡½æ•°ç«¯ç‚¹çš„è¯·æ±‚æ—¶è·å–ä»¤ç‰Œã€‚</p><pre class="jj jk jl jm fd ju jg jv jw aw jx bi"><span id="e98d" class="jy jz hi jg b fi ka kb l kc kd">const { google } = require('googleapis')</span><span id="5718" class="jy jz hi jg b fi ke kb l kc kd">app.post('/&lt;path&gt;', function (req, res, next) {<br/> const ENDPOINT = &lt;your-endpoint&gt;<br/> const client = new google.auth.JWT({<br/>   email: serviceAccount.client_email,<br/>   key: serviceAccount.private_key,<br/> })<br/> client.fetchIdToken(ENDPOINT).then(idToken =&gt; {<br/>    const options = {<br/>     method: 'POST',<br/>     uri: `${ENDPOINT}/&lt;your-path&gt;`,<br/>     body: req.body,<br/>     json: true<br/>    }<br/>   request(options).auth(null, null, true, idToken)<br/>  .then(response =&gt; {<br/>    res.send(response)<br/>  })<br/>  .catch (error =&gt; {<br/>    console.log('[ERROR]', error.message)<br/>    res.send("Not authorized.")<br/>  })<br/> })<br/>})</span></pre><p id="f37a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">å°±è¿™äº›ï¼Œå¸Œæœ›æœ‰å¸®åŠ©ğŸ™‚ã€‚è°¢è°¢å¹¶ç¥ä½ æ„‰å¿«ã€‚ğŸ‘‹</p></div></div>    
</body>
</html>