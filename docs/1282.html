<html>
<head>
<title>Securing Google Cloud Functions Using Service Account and How to Access it in Service-Service Communications.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用服务帐户保护Google Cloud功能以及如何在服务-服务通信中访问它。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/securing-google-cloud-functions-using-service-account-and-how-to-access-it-in-service-service-582b4b5f210?source=collection_archive---------0-----------------------#2020-02-09">https://medium.com/google-cloud/securing-google-cloud-functions-using-service-account-and-how-to-access-it-in-service-service-582b4b5f210?source=collection_archive---------0-----------------------#2020-02-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1864" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud的功能提供了一种机制来确保你的每个端点只被允许的用户使用，即删除IAM中的<code class="du jd je jf jg b">allUsers</code>和<code class="du jd je jf jg b">allAuthenticatedUsers</code>。对于服务到服务的通信，当您想要创建对Google Cloud Functions端点的请求时，可以使用服务帐户来生成令牌。Google OAuth 2.0系统支持服务器到服务器的交互，例如web应用程序和Google服务之间的交互。对于这种情况，您需要一个服务帐户，它是属于您的应用程序的帐户，而不是属于单个最终用户的帐户。您的应用程序代表服务帐户调用Google APIs，因此用户不直接参与。在应用程序获得访问令牌后，它在一个<a class="ae jh" href="https://developer.mozilla.org/docs/Web/HTTP/Headers/Authorization" rel="noopener ugc nofollow" target="_blank"> HTTP授权请求头</a>中将令牌发送给Google API。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div class="er es ji"><img src="../Images/258ffb83d237f399f4772524405f56c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:650/format:webp/1*eUMSytVOPLft36rVxLQSvA.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">服务器到服务器的通信。</figcaption></figure><p id="c7c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google 提供了各种客户端。在这种情况下，我使用的是<a class="ae jh" href="https://github.com/google/google-api-javascript-client" rel="noopener ugc nofollow" target="_blank"> Javascript </a>。在使用您的服务帐户之前，请确保您已经为您的服务帐户添加了<a class="ae jh" href="https://cloud.google.com/functions/docs/reference/iam/roles" rel="noopener ugc nofollow" target="_blank"> Google Cloud Functions IAM </a>中的<code class="du jd je jf jg b">roles/cloudfunctions.invoker</code>角色。要获取JWT客户端的电子邮件和密钥，您可以使用您的服务帐户:</p><pre class="jj jk jl jm fd ju jg jv jw aw jx bi"><span id="62e1" class="jy jz hi jg b fi ka kb l kc kd">const fs = require('fs')</span><span id="a86d" class="jy jz hi jg b fi ke kb l kc kd">const SERVICE_ACCOUNT_PATH = process.env.GOOGLE_APPLICATION_CREDENTIALS</span><span id="5e45" class="jy jz hi jg b fi ke kb l kc kd">const rawServiceAccountData = fs.readFileSync(SERVICE_ACCOUNT_PATH)</span><span id="aa92" class="jy jz hi jg b fi ke kb l kc kd">const serviceAccount = JSON.parse(rawServiceAccountData)</span></pre><p id="7186" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在caller应用程序中，您可以添加以下代码，以便在每次想要创建对云函数端点的请求时获取令牌。</p><pre class="jj jk jl jm fd ju jg jv jw aw jx bi"><span id="e98d" class="jy jz hi jg b fi ka kb l kc kd">const { google } = require('googleapis')</span><span id="5718" class="jy jz hi jg b fi ke kb l kc kd">app.post('/&lt;path&gt;', function (req, res, next) {<br/> const ENDPOINT = &lt;your-endpoint&gt;<br/> const client = new google.auth.JWT({<br/>   email: serviceAccount.client_email,<br/>   key: serviceAccount.private_key,<br/> })<br/> client.fetchIdToken(ENDPOINT).then(idToken =&gt; {<br/>    const options = {<br/>     method: 'POST',<br/>     uri: `${ENDPOINT}/&lt;your-path&gt;`,<br/>     body: req.body,<br/>     json: true<br/>    }<br/>   request(options).auth(null, null, true, idToken)<br/>  .then(response =&gt; {<br/>    res.send(response)<br/>  })<br/>  .catch (error =&gt; {<br/>    console.log('[ERROR]', error.message)<br/>    res.send("Not authorized.")<br/>  })<br/> })<br/>})</span></pre><p id="f37a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就这些，希望有帮助🙂。谢谢并祝你愉快。👋</p></div></div>    
</body>
</html>