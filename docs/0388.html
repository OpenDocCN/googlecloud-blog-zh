<html>
<head>
<title>Using Deployment Manager to automate the creation of GCP’s Shared VPC</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用部署管理器自动创建GCP的共享VPC</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-deployment-manager-to-automate-the-creation-of-gcps-shared-vpc-1339e78d2545?source=collection_archive---------0-----------------------#2017-09-22">https://medium.com/google-cloud/using-deployment-manager-to-automate-the-creation-of-gcps-shared-vpc-1339e78d2545?source=collection_archive---------0-----------------------#2017-09-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b5f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GCP有一个非常好的网络方式，我非常喜欢的一个功能是共享VPC的。共享VPC允许你创建一个相关项目可以使用的VPC网络。下图形象化了这个概念。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/bc7f8e3bb77d30c1c69d9f3c99683703.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*01VSL5lW0TyJ7pKt."/></div></div></figure><p id="7a3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建共享的VPC包括许多步骤，如这里的<a class="ae jd" href="https://cloud.google.com/compute/docs/shared-vpc/provisioning-shared-vpc" rel="noopener ugc nofollow" target="_blank">文档所述。虽然一步一步地浏览所有内容是理解所有概念的好方法，但是当您开始构建GCP环境时，自动化创建是部署您的环境的万无一失的方法，因此您只需运行一两个gcloud命令。</a></p><p id="0139" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GCP的博客文章很好地介绍了<a class="ae jd" href="https://cloudplatform.googleblog.com/2017/04/automating-project-creation-with-Google-Cloud-Deployment-Manager.html" rel="noopener ugc nofollow" target="_blank">部署管理器项目创建模板</a>，在这篇文章中，我们将解释如何扩展它们，以便创建可重复的、一致的共享VPC环境。</p><p id="76fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要遵循的步骤是:</p><ol class=""><li id="cf66" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc jv jw jx jy bi translated">使用DM项目创建模板可以</li></ol><p id="e56a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">a.创建目标VPC主机和服务项目</p><p id="ab64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">b.启用所需的API</p><p id="dd8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">c.向身份授予权限</p><p id="9c9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.创建一个模板，使项目成为VPC主机和服务项目</p><p id="fa5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.使用新创建的模板将项目启用为支持共享VPC的主机和服务项目。</p><h1 id="8e9c" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">使用部署管理器创建共享的VPC和服务项目</h1><h1 id="7662" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">第一步:</h1><p id="e7a7" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">这在<a class="ae jd" href="https://cloudplatform.googleblog.com/2017/04/automating-project-creation-with-Google-Cloud-Deployment-Manager.html" rel="noopener ugc nofollow" target="_blank">部署管理器项目创建模板</a>的帖子中有详细介绍。</p><p id="cdbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用模板创建宿主和服务项目，这些项目在本演练中被标识为:</p><p id="5113" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主机共享VPC项目:my-xpn-host-myID</p><p id="43f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">服务项目:service-xpn-myID</p><p id="ddd1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lc">注意:在我的例子中，myID代表一个惟一的标识符，它被标记在一个更具描述性的项目名称上，以创建一个惟一的项目名称。您可以使用一个日期加上一些递增的数字来创建唯一的项目名称。</em></p><p id="61b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在创建每个项目之前，需要对每个项目的项目创建配置YAML文件进行一些添加</p><p id="1744" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lc">注意:如果您愿意，您可以将两个项目的配置细节保存在一个配置中。YAML文件</em></p><p id="425d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于共享的vpc主机项目yaml (my-xpn-host-myID)</p><p id="b929" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确定要为其分配适当角色的成员，并在配置的iam-policy资源部分授予他们以下角色。YAML文件:</p><ul class=""><li id="26d4" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc ld jw jx jy bi translated">roles/compute . xpn admin-这是负责管理VPC的身份</li><li id="8ef8" class="jq jr hi ih b ii le im lf iq lg iu lh iy li jc ld jw jx jy bi translated">roles/compute.networkUser —这些是服务项目的成员，有权使用主机项目中所有现有和未来的子网</li></ul><p id="8cbc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您希望限制服务项目可以利用的子网，则需要在子网级别设置权限</p><p id="ead1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lc">注:会员是指用户或服务账户</em></p><p id="929c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按照<a class="ae jd" href="https://github.com/GoogleCloudPlatform/deploymentmanager-samples/tree/master/examples/v2/project_creation" rel="noopener ugc nofollow" target="_blank">自述文件</a>中的描述创建项目。请特别注意设置允许部署管理器创建项目的权限所需的步骤。除了所描述的权限之外，您还需要将roles/compute.xpnAdmin授予在<a class="ae jd" href="https://github.com/GoogleCloudPlatform/deploymentmanager-samples/tree/master/examples/v2/project_creation" rel="noopener ugc nofollow" target="_blank">自述文件</a>中标识的服务帐户</p><h1 id="db43" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">第二步:</h1><p id="8539" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">创建配置。定义您的VPC主机项目和服务项目的YAML文件</p><p id="ad99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在下面的例子中，我们定义了两个资源</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="5715" class="lo ka hi lk b fi lp lq l lr ls">resources:</span><span id="3323" class="lo ka hi lk b fi lt lq l lr ls">- name: my-xpn-host</span><span id="b4bd" class="lo ka hi lk b fi lt lq l lr ls">type: compute.beta.xpnHost</span><span id="ed8a" class="lo ka hi lk b fi lt lq l lr ls">properties:</span><span id="ae65" class="lo ka hi lk b fi lt lq l lr ls">organization-id: “123456789”</span><span id="bf7e" class="lo ka hi lk b fi lt lq l lr ls"># organization’s billing account</span><span id="9739" class="lo ka hi lk b fi lt lq l lr ls">billing-account-name: billingAccounts/01234A-56789B-012345C</span><span id="4238" class="lo ka hi lk b fi lt lq l lr ls">project: my-xpn-host-myID</span><span id="9d6f" class="lo ka hi lk b fi lt lq l lr ls">- name: my-resource</span><span id="6a64" class="lo ka hi lk b fi lt lq l lr ls">type: compute.beta.xpnResource</span><span id="1a8a" class="lo ka hi lk b fi lt lq l lr ls">properties:</span><span id="c720" class="lo ka hi lk b fi lt lq l lr ls">organization-id: “123456789”</span><span id="bec2" class="lo ka hi lk b fi lt lq l lr ls"># organization’s billing account</span><span id="b5ae" class="lo ka hi lk b fi lt lq l lr ls">billing-account-name: billingAccounts/01234A-56789B-012345C</span><span id="c636" class="lo ka hi lk b fi lt lq l lr ls">project: my-xpn-host-myID</span><span id="6936" class="lo ka hi lk b fi lt lq l lr ls">xpnResource:</span><span id="d10c" class="lo ka hi lk b fi lt lq l lr ls">id: service-xpn-myID</span><span id="43ac" class="lo ka hi lk b fi lt lq l lr ls">type: PROJECT</span><span id="f4df" class="lo ka hi lk b fi lt lq l lr ls">metadata:</span><span id="b60e" class="lo ka hi lk b fi lt lq l lr ls">dependsOn:</span><span id="b94e" class="lo ka hi lk b fi lt lq l lr ls">- my-xpn-host</span></pre><p id="40d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">VPC主机项目由具有计算βxpn host类型的名称my-xpn-host标识，而服务项目由具有计算βxpn resource类型的名称my-resource标识。</p><h1 id="76dc" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">第三步:</h1><p id="4c83" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">在我的示例中，要使用gcloud命令部署配置，该命令如下所示。</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="90ee" class="lo ka hi lk b fi lp lq l lr ls"><em class="lc">gcloud deployment-manager deployments create xpn-project-assignments — config sharedvpc.yaml</em></span></pre><p id="daf5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将创建一个名为<em class="lc"> xpn-project-assignments </em>的部署，将项目my-xpn-host-myID指定为共享的VPC主机项目，将项目service-xpn-myID指定为服务项目。</p><h1 id="649a" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">第四步:</h1><p id="34c6" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">最后一步是确保您共享的VPC主机项目不会被意外删除。</p><p id="615a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过创建一个共享的VPC主机项目，将自动对该项目加锁(留置权)。默认情况下，宿主项目所有者可以删除此留置权，除非创建了组织级别的策略来阻止它。按照<a class="ae jd" href="https://cloud.google.com/compute/docs/shared-vpc/provisioning-shared-vpc#protectsharedvpc" rel="noopener ugc nofollow" target="_blank">保护共享的VPC主机项目不被删除</a>文档中详述的步骤，添加组织级策略，并针对主机VPC项目的意外删除提供更高级别的保险。</p><p id="3d6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，项目是用默认的自动模式VPC网络创建的。默认的自动模式VPC网络在每个区域都有一个子网，每个子网都有一个<a class="ae jd" href="https://cloud.google.com/compute/docs/vpc/#ip-ranges" rel="noopener ugc nofollow" target="_blank">预定义的IP范围</a>。在本演示中，默认设置是没问题的。</p><p id="47dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主机项目中的所有子网都与服务项目共享。在主机项目级别被授予compute.networkUser角色的任何身份都可以在主机项目的任何子网中启动实例。要限制特定子网，请在<a class="ae jd" href="https://cloud.google.com/compute/docs/shared-vpc/provisioning-shared-vpc#networkuseratsubnet" rel="noopener ugc nofollow" target="_blank">子网级别</a>授予compute.networkUser角色</p></div></div>    
</body>
</html>