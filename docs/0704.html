<html>
<head>
<title>Knative 1/2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Knative 1/2</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/knative-408dacbc1953?source=collection_archive---------1-----------------------#2018-07-27">https://medium.com/google-cloud/knative-408dacbc1953?source=collection_archive---------1-----------------------#2018-07-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="e7a5" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">库伯内特斯历险记</h2></div><p id="aba8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我个人认为“Knative”应该像“Knight”一样发音为不发音的“K ”,因为如果你永远要解释K不发音…</p><p id="aafb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我已经陷入(是的，陷入)最近的掌舵和“我不爱它”。因此，在阅读了许多描述本周<code class="du jt ju jv jw b">pronounced kay-nay-tiv</code>发布的文章后，我很想在周五下午的“深度工作”时间尝试一下。</p><p id="ad54" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我对这项技术的雄心有一种感觉，但我承认，阅读本周写的内容并没有让我更加清楚。我将用这个故事来阐述我认为这里正在发生的事情。需要澄清的是:虽然我是一名谷歌人，也是Kubernetes和Istio的热情拥护者，但我并没有参与任何这些解决方案的工程设计。</p><h2 id="44d8" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jg ki kj kk jk kl km kn jo ko kp kq kr bi translated">警告</h2><p id="a393" class="pw-post-body-paragraph ix iy hi iz b ja ks ij jc jd kt im jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">这个故事是我对Google文档的遍历。我没有做任何新奇的事情。如果你想保持权威性，我建议你参考谷歌文档:</p><p id="dd9b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae kx" href="https://github.com/knative/docs/blob/master/install/Knative-with-GKE.md" rel="noopener ugc nofollow" target="_blank">https://github . com/Knative/docs/blob/master/install/Knative-with-gke . MD</a></p><h2 id="4cef" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jg ki kj kk jk kl km kn jo ko kp kq kr bi translated">设置</h2><p id="05d2" class="pw-post-body-paragraph ix iy hi iz b ja ks ij jc jd kt im jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">我将使用Kubernetes引擎和一个自安装的Knative，因为Google的用于Kubernetes引擎的无服务器插件还不可用。我也是区域集群的支持者，因此，使用下面的命令也可以得到一个闪亮的区域集群:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="e5ba" class="jx jy hi jw b fi lg lh l li lj">PROJECT=[[YOUR-PROJECT-ID]]<br/>BILLING=[[YOUR-BILLING-ID]]<br/>CLUSTER=[[YOUR-CLUSTER-NAME]]<br/>REGION=[[YOUR-REGION]]         # us-west1<br/>LATEST="1.10.5-gke.3"</span><span id="3628" class="jx jy hi jw b fi lk lh l li lj">gcloud projects create ${PROJECT}</span><span id="a870" class="jx jy hi jw b fi lk lh l li lj">gcloud beta billing projects link ${PROJECT} \<br/>--billing-account=${BILLING}</span><span id="7b2a" class="jx jy hi jw b fi lk lh l li lj">gcloud services enable container.googleapis.com \<br/>--project=${PROJECT}</span><span id="6a76" class="jx jy hi jw b fi lk lh l li lj">gcloud beta container clusters create $CLUSTER \<br/>--username="" \<br/>--cluster-version=${LATEST} \<br/>--machine-type=custom-2-8192 \<br/>--image-type=COS \<br/>--num-nodes=1 \<br/>--enable-autorepair \<br/>--enable-autoscaling \<br/>--enable-autoupgrade \<br/>--enable-stackdriver-kubernetes \<br/>--min-nodes=1 \<br/>--max-nodes=3 \<br/>--region=${REGION} \<br/>--project=${PROJECT} \<br/>--preemptible \<br/>--scopes="<a class="ae kx" href="https://www.googleapis.com/auth/cloud-platform" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/cloud-platform</a>"</span><span id="621a" class="jx jy hi jw b fi lk lh l li lj">kubectl create clusterrolebinding cluster-admin-binding \<br/>--clusterrole=cluster-admin \<br/>--user=$(gcloud config get-value core/account)</span></pre><p id="aea1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我第一次安装Istio时遇到了问题。如果你有问题，重击和重新安装Istio似乎(！)要解决问题:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="0daa" class="jx jy hi jw b fi lg lh l li lj">kubectl apply \<br/>--filename=<a class="ae kx" href="https://storage.googleapis.com/knative-releases/serving/latest/istio.yaml" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/knative-releases/serving/latest/istio.yaml</a></span><span id="a3f0" class="jx jy hi jw b fi lk lh l li lj">kubectl label namespace default istio-injection=enabled</span><span id="bb68" class="jx jy hi jw b fi lk lh l li lj">kubectl get pods \<br/>--namespace=istio-system \<br/>--watch</span></pre><p id="f8e3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您希望通过类似于以下内容的pod列表来实现稳定:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="07ec" class="jx jy hi jw b fi lg lh l li lj">NAME                                        READY     STATUS      <br/>istio-citadel-6fd4747d74-cz784              1/1       Running<br/>istio-cleanup-secrets-jpqwt                 0/1       Completed<br/>istio-egressgateway-8689d84656-x8pzj        1/1       Running<br/>istio-galley-bc65ccfc4-7nr2s                1/1       Running<br/>istio-ingressgateway-84ffcdd574-kqcvd       1/1       Running<br/>istio-mixer-post-install-1.0-fs4q8          0/1       Completed<br/>istio-pilot-878dd49f6-7bcvt                 2/2       Running<br/>istio-policy-d9d9d7d6-r8n5z                 2/2       Running<br/>istio-sidecar-injector-7b4f7c4bcc-bblbj     1/1       Running<br/>istio-statsd-prom-bridge-6889648ccf-mjdvk   1/1       Running<br/>istio-telemetry-698c747dc5-zzcqs            2/2       Running</span></pre><p id="9389" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Kubernetes发动机控制台中(由<code class="du jt ju jv jw b">Namespace:istio-system</code>过滤):</p><figure class="ky kz la lb fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es ll"><img src="../Images/b2bddbdb7b40fa944545392b14cc1614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EAAt-QhKOq6awQKK4_u-tg.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">Kubernetes引擎控制台`命名空间:istio-system '</figcaption></figure><p id="cd09" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong> Istio创建了一个网络(TCP)负载均衡器，有点令人困惑地称为<code class="du jt ju jv jw b">istio-ingressgateway</code>，但它不是Kubernetes入口资源:</p><figure class="ky kz la lb fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es ll"><img src="../Images/b33547e867deb9c883b2ae2d00a957cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bYuFdTn65SOoR3nbVGktxg.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">Kubernetes引擎控制台——Istio的网络负载平衡器</figcaption></figure><p id="3dc2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此外，云控制台显示了相同的网络负载平衡器:</p><figure class="ky kz la lb fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lx"><img src="../Images/11c68531d96614721e2e594c722eb1e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OHTi06nHwAu7PJwCD0dG7w.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">云控制台:网络服务——Istio的网络负载平衡器</figcaption></figure><p id="97b3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Knative安装没有问题:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="f8e1" class="jx jy hi jw b fi lg lh l li lj">kubectl apply \<br/>--filename=<a class="ae kx" href="https://storage.googleapis.com/knative-releases/serving/latest/release.yaml" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/knative-releases/serving/latest/release.yaml</a></span></pre><p id="c0f4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="8346" class="jx jy hi jw b fi lg lh l li lj">kubectl get pods \<br/>--namespace=knative-serving</span><span id="f1f5" class="jx jy hi jw b fi lk lh l li lj">NAME                          READY     STATUS    RESTARTS   AGE<br/>activator-9988b7887-vq69k     2/2       Running   0          1m<br/>autoscaler-664f4986c9-8vnqh   2/2       Running   0          1m<br/>controller-79f897b6c9-7tfzp   1/1       Running   0          1m<br/>webhook-5c664c7c88-cfdj2      1/1       Running   0          1m</span></pre><p id="7037" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="e68e" class="jx jy hi jw b fi lg lh l li lj">kubectl apply \<br/>--filename=<a class="ae kx" href="https://storage.googleapis.com/knative-releases/build/latest/release.yaml" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/knative-releases/build/latest/release.yaml</a></span></pre><p id="64d1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="c33b" class="jx jy hi jw b fi lg lh l li lj">kubectl get pods \<br/>--namespace=knative-build</span><span id="d699" class="jx jy hi jw b fi lk lh l li lj">NAME                                READY     STATUS      RESTARTS<br/>build-controller-5cb4f5cb67-nb2n9   2/2       Running     0<br/>build-controller-6b88fbb445-949zq   2/2       Running     0<br/>build-webhook-6b4c65546b-tqprz      2/2       Running     2<br/>build-webhook-988b797b4-dzfls       1/2       Completed   1</span></pre><p id="3951" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以通过通配符名称空间(<code class="du jt ju jv jw b">Namespace:knative-*</code>)过滤Kubernetes引擎控制台:</p><figure class="ky kz la lb fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es ly"><img src="../Images/a818c4ce10e7a24662d64727930b7d1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f43u9cgf2czbw6vP5DcT4A.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">Kubernetes引擎控制台`命名空间:knative-* `</figcaption></figure><p id="11f7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">被动部署导致Istio创建另一个网络负载平衡器:</p><figure class="ky kz la lb fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lz"><img src="../Images/b02740b6ef0748c557abde999fade9b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dbsouFtM_0o9dtiygMPoZw.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">Kubernetes引擎控制台:` knative-Ingres gateway '</figcaption></figure><p id="6abb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong>在我的例子中，已知的“入口”(不是Kubernetes入口，而是网络LB)位于<code class="du jt ju jv jw b">35.233.225.250</code>。这两个LBs都是由Istio创建的，位于<code class="du jt ju jv jw b">istio-system</code>名称空间中。</p><p id="2360" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">向自己证明随后使用的是哪个网络LB是有用的。您可以使用以下命令来确定这一点:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="c42e" class="jx jy hi jw b fi lg lh l li lj">kubectl get services/knative-ingressgateway \<br/>--namespace=istio-system \<br/>--output=jsonpath="{.status.loadBalancer.ingress[0].ip}"</span><span id="2656" class="jx jy hi jw b fi lk lh l li lj"># Your value will differ<br/>35.233.225.250</span></pre><p id="6478" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且，使用云控制台:</p><figure class="ky kz la lb fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es ma"><img src="../Images/dc708c229371f8e07c05e02fce6ecef9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NWZW8IZQ1ZV1ZAdsj11v3Q.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">网络服务:2个网络负载平衡器</figcaption></figure><p id="8dbb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">移除名称空间过滤器应该类似于:</p><figure class="ky kz la lb fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es ma"><img src="../Images/b47bdb37d5d19b702c9f9bc1e2820181.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DFIiGS0HVihL_zMSdmRJmw.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">Kubernetes发动机控制台</figcaption></figure><p id="b61d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">注意</strong>我有几个未解决的问题:<code class="du jt ju jv jw b">grafana</code>和<code class="du jt ju jv jw b">kube-state-metrics</code>部署在一个初始化容器(<code class="du jt ju jv jw b">istio-init</code>)问题上受阻:<code class="du jt ju jv jw b">iptables v1.6.0: can’t initialize iptables table `nat’: Permission denied (you must be root)</code>。不好，但没有给我带来明显的问题。</p><h2 id="e2f2" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jg ki kj kk jk kl km kn jo ko kp kq kr bi translated">破坏性部署</h2><p id="274a" class="pw-post-body-paragraph ix iy hi iz b ja ks ij jc jd kt im jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">我推荐你从简单的<code class="du jt ju jv jw b">helloworld</code>样本开始。如果您想有机会调整和测试正在发生的事情，可以克隆样本并进行尝试。</p><p id="3cf7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可能想节省Docker图像的大小，如果你有兴趣探索Google的<a class="ae kx" href="https://github.com/GoogleContainerTools/distroless" rel="noopener ugc nofollow" target="_blank">distroles</a>项目，我推荐以下Docker文件:</p><figure class="ky kz la lb fd lm"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="8a46" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因为你使用的是Kubernetes引擎，我们手头有Google容器注册(GCR ),我建议你构建并推送这个到DockerHub它更近、更快、更便宜:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="d23b" class="jx jy hi jw b fi lg lh l li lj">docker build \<br/>--tag=gcr.io/${PROJECT}/helloworld \<br/>. # Don't forget the period</span><span id="80c1" class="jx jy hi jw b fi lk lh l li lj">docker push gcr.io/${PROJECT}/helloworld</span></pre><p id="9980" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后确保您的部署反映GCR和您的<code class="du jt ju jv jw b">${PROJECT}</code>也许:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="d363" class="jx jy hi jw b fi lg lh l li lj">echo "<br/>apiVersion: serving.knative.dev/v1alpha1<br/>kind: Service<br/>metadata:<br/>  name: helloworld<br/>  namespace: default<br/>spec:<br/>  runLatest:<br/>    configuration:<br/>      revisionTemplate:<br/>        spec:<br/>          container:<br/>            image: gcr.io/${PROJECT}/helloworld<br/>            env:<br/>            - name: TARGET<br/>              value: 'Knative'<br/>" | kubectl apply --filename=-</span></pre><p id="4c76" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您应该会看到:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="9fb1" class="jx jy hi jw b fi lg lh l li lj">service.serving.knative.dev/helloworld created</span></pre><p id="de83" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">针对这个Knative API部署一个<code class="du jt ju jv jw b">Service</code>会产生2个Kubernetes部署:一个以我们部署的服务命名并附加了-deployment，另一个附加了-autoscaler(在knative-service名称空间中:</p><figure class="ky kz la lb fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es ly"><img src="../Images/a59d0b0e426c02c75a7f6d4620a0923b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WM1fapTxeSr_nWUm7Dolaw.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">Kubernetes引擎控制台:名为“helloworld-*”的工作负载</figcaption></figure><p id="1a12" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="a673" class="jx jy hi jw b fi lg lh l li lj">kubectl get deployments --namespace=default</span><span id="04a6" class="jx jy hi jw b fi lk lh l li lj">NAME                          DESIRED   CURRENT   UP-TO-DATE<br/>helloworld-00001-deployment   1         1         1</span></pre><p id="bb0f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="3aa5" class="jx jy hi jw b fi lg lh l li lj">kubectl get deployments \<br/>--selector=serving.knative.dev/configuration=helloworld \<br/>--namespace=knative-serving</span><span id="1f1a" class="jx jy hi jw b fi lk lh l li lj">NAME                          DESIRED   CURRENT   UP-TO-DATE<br/>helloworld-00001-autoscaler   0         0         0</span></pre><blockquote class="md me mf"><p id="1fa4" class="ix iy mg iz b ja jb ij jc jd je im jf mh jh ji jj mi jl jm jn mj jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong>一个小技巧，通过值为<code class="du jt ju jv jw b">helloworld</code>的标签为<code class="du jt ju jv jw b">service.knative.dev/configuration</code>的部署来过滤<code class="du jt ju jv jw b">knative-serving</code>名称空间中的部署。</p></blockquote><p id="980a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">还有一项常规的Kubernetes服务:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="9734" class="jx jy hi jw b fi lg lh l li lj">kubectl get service/helloworld --namespace=default<br/>NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE<br/>helloworld   ClusterIP   10.31.246.198   &lt;none&gt;        80/TCP    2m</span></pre><figure class="ky kz la lb fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lz"><img src="../Images/0cf779ac2b07bfc3c42322a4d0c5be3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CpJ8PEHvRpPOBOYPJbX2hQ.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">Kubernetes发动机控制台:“helloworld”服务</figcaption></figure><p id="485a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且:</p><figure class="ky kz la lb fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es ll"><img src="../Images/1622636797810e108270cc859c7953d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CervQpZEJNBM_zI7cAy5bA.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">Kubernetes引擎控制台:“helloworld”服务详情</figcaption></figure><p id="ac7a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">保持这种想法！</p><p id="1a3a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，根据您所遵循的文档，会告诉您运行以下命令:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="6255" class="jx jy hi jw b fi lg lh l li lj">kubectl get services.serving.knative.dev<br/>NAME         CREATED AT<br/>helloworld   20s</span></pre><blockquote class="md me mf"><p id="873d" class="ix iy mg iz b ja jb ij jc jd je im jf mh jh ji jj mi jl jm jn mj jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong>没错<code class="du jt ju jv jw b">services.serving.knative.dev</code></p></blockquote><p id="f7a3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">等等，什么？<code class="du jt ju jv jw b">services.serving.knative.dev</code>？事实证明，如果您查看部署的顶部，<code class="du jt ju jv jw b">apiVersion: serving.knative.dev/v1alpha1</code>和<code class="du jt ju jv jw b">Kind: Service</code>有助于解释这一点，同时快速检查<code class="du jt ju jv jw b">kubectl get --help</code>表明:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="faf5" class="jx jy hi jw b fi lg lh l li lj">Usage:<br/>  kubectl get<br/>(<strong class="jw hj">TYPE[.VERSION][.GROUP]</strong> [NAME | -l label] | TYPE[.VERSION][.GROUP]/NAME ...) [flags] [options]</span></pre><p id="fc5d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以<code class="du jt ju jv jw b"><strong class="iz hj">TYPE</strong></code>是<code class="du jt ju jv jw b">Service</code>，<code class="du jt ju jv jw b"><strong class="iz hj">GROUP</strong></code>是<code class="du jt ju jv jw b">service.knative.dev</code>，<code class="du jt ju jv jw b"><strong class="iz hj">VERSION</strong></code>是<code class="du jt ju jv jw b">v1alpha1</code>。所以我们可以:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="2a92" class="jx jy hi jw b fi lg lh l li lj">kubectl get services.<strong class="jw hj">serving.knative.dev</strong><br/>NAME         CREATED AT<br/>helloworld   20s</span></pre><p id="d973" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们还可以:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="a89e" class="jx jy hi jw b fi lg lh l li lj">kubectl get services.<strong class="jw hj">v1alpha1</strong>.serving.knative.dev<br/>NAME         CREATED AT<br/>helloworld   20s</span></pre><p id="2bc5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这并没有告诉我们太多，除此之外，我们确实创建了一个叫做<code class="du jt ju jv jw b">helloworld</code>的服务。我们将调整<code class="du jt ju jv jw b">get</code>命令，从结果中提取特定的值:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="682c" class="jx jy hi jw b fi lg lh l li lj">HELLOWORLD=$(\<br/>  kubectl get <strong class="jw hj">services.serving.knative.dev</strong>/helloworld \<br/>  --namespace=default \<br/>  --output=jsonpath="{.status.domain}") &amp;&amp; echo ${HELLOWORLD}</span><span id="80ab" class="jx jy hi jw b fi lk lh l li lj">helloworld.default.example.com</span></pre><blockquote class="md me mf"><p id="435e" class="ix iy mg iz b ja jb ij jc jd je im jf mh jh ji jj mi jl jm jn mj jp jq jr js hb bi translated">我们的Knative服务有一个完全合格的域名<code class="du jt ju jv jw b">helloworld.default.example.com</code>。<code class="du jt ju jv jw b">helloworld</code>是我们提供的名称。<code class="du jt ju jv jw b">default</code>对应于你可能漏掉的命名空间，也在那里；尝试创建一个新的名称空间并将<code class="du jt ju jv jw b">helloworld</code>部署到其中。</p></blockquote><p id="459e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了调用服务，我们将引用这个全限定名称作为头，并将其传递给<code class="du jt ju jv jw b">knative-ingressgateway</code>。还记得我们之前提到的IP地址吗？</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="eafd" class="jx jy hi jw b fi lg lh l li lj">KNATIVE_INGRESS=$(\<br/>  kubectl get services/knative-ingressgateway \<br/>  --namespace=istio-system \<br/>  --output=jsonpath="{.status.loadBalancer.ingress[0].ip}")</span></pre><p id="7d46" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以我们可以:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="1ff9" class="jx jy hi jw b fi lg lh l li lj">curl \<br/>--header "Host: ${HELLOWORLD}" \<br/><a class="ae kx" href="http://${KNATIVE_INGRESS" rel="noopener ugc nofollow" target="_blank">http://${KNATIVE_INGRESS</a>}</span><span id="341a" class="jx jy hi jw b fi lk lh l li lj">Hello Henry: Knative</span></pre><p id="19b5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您的值会有所不同，但是您应该会看到<code class="du jt ju jv jw b">Hello World</code>以及您在部署服务时为<code class="du jt ju jv jw b">TARGET</code>使用的任何值。</p><h2 id="4098" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jg ki kj kk jk kl km kn jo ko kp kq kr bi translated">结论</h2><p id="8080" class="pw-post-body-paragraph ix iy hi iz b ja ks ij jc jd kt im jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">假设集群、Istio和Knative已经安装并准备好供我们使用，我们所要做的就是编写一些代码和<code class="du jt ju jv jw b">kubectl apply</code>一个引用我们的容器的spec文件，以便部署我们的服务。Knative负责通过Istio mesh和Istio Ingress为我们公开服务。</p><p id="5be1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从我们的角度来看，Istio在这个场景中只扮演了一个次要的角色，但是它为那些表面上代表我们管理集群的人提供了丰富的功能，包括监控(w/ Prometheus和命运多舛的Grafana pod)、安全性和流量路由。</p><p id="cc3b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">希望这个故事能为你的故事增添一点色彩。这是一项有趣的技术，我期待着了解更多。</p><h2 id="e224" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jg ki kj kk jk kl km kn jo ko kp kq kr bi translated">整理一下！</h2><p id="4445" class="pw-post-body-paragraph ix iy hi iz b ja ks ij jc jd kt im jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">如果你只是为了这个练习的目的而创建了一个谷歌云平台项目，并且你准备删除上面的一切，你可以简单地(不可挽回地！)删除项目:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="ef4a" class="jx jy hi jw b fi lg lh l li lj">gcloud projects delete ${PROJECT} --quiet</span></pre><p id="a732" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您希望保留项目，但(不可撤销地)删除Kubernetes集群、Istio、Knative和部署的功能，您可以:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="2815" class="jx jy hi jw b fi lg lh l li lj">gcloud container clusters delete ${CLUSTER} --project=${PROJECT}</span></pre><p id="df89" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你想解开上面的一切，使用以下的一些子集:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="4780" class="jx jy hi jw b fi lg lh l li lj"># Delete Services</span><span id="56fe" class="jx jy hi jw b fi lk lh l li lj">kubectl <strong class="jw hj">delete</strong> services.serving.knative.dev/helloworld \<br/>--namespace=default</span><span id="4e30" class="jx jy hi jw b fi lk lh l li lj"># Delete Knative Build|Serving</span><span id="4e79" class="jx jy hi jw b fi lk lh l li lj">kubectl <strong class="jw hj">delete</strong> \<br/>--filename=<a class="ae kx" href="https://storage.googleapis.com/knative-releases/build/latest/release.yaml" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/knative-releases/build/latest/release.yaml</a></span><span id="1d4b" class="jx jy hi jw b fi lk lh l li lj">kubectl <strong class="jw hj">delete</strong> \<br/>--filename=<a class="ae kx" href="https://storage.googleapis.com/knative-releases/serving/latest/release.yaml" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/knative-releases/serving/latest/release.yaml</a></span><span id="1aa2" class="jx jy hi jw b fi lk lh l li lj"># Delete Istio</span><span id="ef62" class="jx jy hi jw b fi lk lh l li lj">kubectl <strong class="jw hj">delete</strong> \<br/>--filename=https://storage.googleapis.com/knative-releases/serving/latest/istio.yaml</span><span id="8310" class="jx jy hi jw b fi lk lh l li lj"># Then delete the Cluster and or the Project</span></pre><p id="31a4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">仅此而已！</p></div></div>    
</body>
</html>