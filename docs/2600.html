<html>
<head>
<title>Export Snowflake query results to GCS using Dataproc Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dataproc无服务器将雪花查询结果导出到GCS</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/export-snowflake-query-results-to-gcs-using-dataproc-serverless-3d68f5a01ca9?source=collection_archive---------2-----------------------#2022-12-07">https://medium.com/google-cloud/export-snowflake-query-results-to-gcs-using-dataproc-serverless-3d68f5a01ca9?source=collection_archive---------2-----------------------#2022-12-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/85695af0b8b993e6ce4c749b260179d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2meIxhG4F8owSsOJbXRfsw.png"/></div></div></figure><p id="b3c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> Dataproc无服务器</strong>运行批处理工作负载，无需配置和管理集群。它只是在幕后管理所有的基础架构配置和管理。</p><p id="923d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">主要优势:</strong></p><ol class=""><li id="6ea9" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">它可以动态地调整工作负载资源，比如执行器的数量，以便高效地运行您的工作负载。</li><li id="051e" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">完全托管的无服务器解决方案。</li><li id="c105" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">短暂的，一旦作业结束，资源就会被释放。</li></ol><p id="a9c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> Dataproc无服务器模板:</strong>现成可用的、开源的、基于data proc Spark无服务器的可定制模板。这些模板帮助数据工程师进一步简化在Dataproc Serverless上的开发过程，根据他们的需求消费和定制现有的模板。</p><p id="3ca7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章中，我们将探索如何使用Dataproc Serverless将数据从雪花表导出到GCS。</p><h1 id="8e43" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">雪花到GCS模板</h1><p id="724e" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">该模板从雪花表或查询结果中读取数据，并将其写入Google云存储位置。它将<a class="ae lf" href="https://docs.snowflake.com/en/user-guide/spark-connector.html#snowflake-connector-for-spark" rel="noopener ugc nofollow" target="_blank">雪花连接器用于Spark </a>，使Spark能够从雪花中读取数据。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lg"><img src="../Images/254227a5c956a2b15ebb5146641b8375.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4bkxM9xLlk9fXOYpvLwBnA.png"/></div></div></figure><p id="843f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该模板允许通过执行命令配置以下参数:</p><ol class=""><li id="24ab" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><em class="ll">雪花. gcs.sfurl </em>:雪花账号网址。<br/>格式:&lt;账户标识&gt; .snowflakecomputing.com</li><li id="76de" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><em class="ll">雪花. gcs.sfuser </em>:雪花用户名</li><li id="41d0" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><em class="ll">雪花. gcs.sfpassword </em>:雪花用户密码</li><li id="c0ff" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><em class="ll">雪花. gcs.sfdatabase </em>:雪花数据库名称</li><li id="3ef2" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><em class="ll">雪花. gcs.sfschema </em>:雪花模式名</li><li id="dab1" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><em class="ll">snow flake . GCS . SF warehouse</em>:雪花仓库<br/>注:<br/>♀这是一个可选属性<br/>♀如果没有通过执行命令明确指定，则考虑雪花配置的默认仓库。</li><li id="72dd" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><em class="ll">snow flake . GCS . autopushdown</em>:雪花查询下推特性<br/>注意:<br/>♀这是一个可选属性<br/>♀如果没有通过执行命令明确指定，默认值为on。</li><li id="599d" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><em class="ll">雪花. gcs .表</em>:雪花输入表</li><li id="412a" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><em class="ll">雪花. gcs.query </em>:雪花选择查询<br/>注意:模板属性<em class="ll">雪花. gcs.table </em>和<em class="ll">雪花. gcs.query </em>必须提供其中一个。</li><li id="5edf" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><em class="ll">snow flake . GCS . output . location</em>:GCS输出位置<br/>格式:GS://&lt;bucket-name&gt;/&lt;dir&gt;</li><li id="86b0" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><em class="ll">snow flake . GCS . output . format</em>:GCS输出文件格式。<br/>可接受的值:csv、avro、orc、json或parquet</li></ol><h1 id="29e8" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">运行模板</h1><ol class=""><li id="7827" class="jo jp hi is b it la ix lb jb lm jf ln jj lo jn jt ju jv jw bi translated">请确保您已经启用了带有专用Google访问的子网。如果您使用的是GCP创建的“默认”VPC，您仍然需要启用如下的私人访问。</li></ol><figure class="lh li lj lk fd ij er es paragraph-image"><div class="er es lp"><img src="../Images/11788f19a5b5cad0a91cf467b5655a6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/0*Olpmc1Zv2yZphmap.png"/></div></figure><pre class="lh li lj lk fd lq lr ls bn lt lu bi"><span id="a701" class="lv kd hi lr b be lw lx l ly lz">gcloud compute networks subnets update default --region=us-central1 --enable-private-ip-google-access</span></pre><p id="d02c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.为jar文件创建一个GCS存储桶和暂存位置。</p><p id="3b6d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.在预装了各种工具的云壳中克隆git repo。或者使用任何预装JDK 8+，Maven和Git的机器。</p><pre class="lh li lj lk fd lq lr ls bn lt lu bi"><span id="efb1" class="lv kd hi lr b be lw lx l ly lz">git clone https://github.com/GoogleCloudPlatform/dataproc-templates.git<br/>cd dataproc-templates/java</span></pre><p id="f5ef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.认证gcloud CLI</p><pre class="lh li lj lk fd lq lr ls bn lt lu bi"><span id="cf25" class="lv kd hi lr b be lw lx l ly lz">gcloud auth login</span></pre><p id="a9da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.执行SnowflakeToGCS模板</p><p id="a813" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="ll">样本执行命令:</em></p><pre class="lh li lj lk fd lq lr ls bn lt lu bi"><span id="e2d2" class="lv kd hi lr b be lw lx l ly lz">export GCP_PROJECT=&lt;gcp-project-id&gt;<br/>export REGION=&lt;gcp-project-region&gt;<br/>export GCS_STAGING_LOCATION=&lt;gcs-bucket-staging-folder-path&gt;<br/>export SUBNET=&lt;gcp-project-dataproc-clusters-subnet&gt;<br/><br/>bin/start.sh \<br/>-- \<br/>--template SNOWFLAKETOGCS \<br/>--templateProperty snowflake.gcs.sfurl &lt;snowflake-account-url&gt; \<br/>--templateProperty snowflake.gcs.sfuser &lt;snowflake-user&gt; \<br/>--templateProperty snowflake.gcs.sfpassword &lt;snowflake-user-password&gt; \<br/>--templateProperty snowflake.gcs.sfdatabase &lt;snowflake-database&gt; \<br/>--templateProperty snowflake.gcs.sfschema &lt;snowflake-schema&gt; \<br/>--templateProperty snowflake.gcs.sfwarehouse &lt;snowflake-warehouse&gt; \<br/>--templateProperty snowflake.gcs.query &lt;snowflake-select-query&gt; \<br/>--templateProperty snowflake.gcs.output.location &lt;gcs-output-location&gt; \<br/>--templateProperty snowflake.gcs.output.format &lt;csv|avro|orc|json|parquet&gt; \<br/>--templateProperty snowflake.gcs.output.mode &lt;Overwrite|ErrorIfExists|Append|Ignore&gt; \<br/>--templateProperty snowflake.gcs.output.partitionColumn &lt;gcs-output-partitionby-columnname&gt; \<br/>--templateProperty snowflake.gcs.autopushdown &lt;on|off&gt;6. Monitor the Spark batch jo</span></pre><p id="de44" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.在<a class="ae lf" href="https://console.cloud.google.com/dataproc/batches" rel="noopener ugc nofollow" target="_blank"> Dataproc Batches UI </a>中提交作业后，您可以监视日志并查看度量。</p><h1 id="3294" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">其他高级作业配置</h1><p id="bc6b" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated"><strong class="is hj"> HISTORY_SERVER_CLUSER </strong>:一个现有的Dataproc集群，作为Spark历史服务器。该属性可用于指定专用服务器，您可以在其中查看正在运行和已完成的Spark作业的状态。示例:</p><pre class="lh li lj lk fd lq lr ls bn lt lu bi"><span id="05a5" class="lv kd hi lr b be lw lx l ly lz">export HISTORY_SERVER_CLUSER=projects/&lt;project_id&gt;/regions/&lt;region&gt;/clusters/&lt;cluster_name&gt;</span></pre><p id="1010" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> SPARK_PROPERTIES </strong>:如果您需要指定Dataproc无服务器支持的SPARK属性，比如调整驱动程序、内核、执行器等的数量。使用它来获得对火花配置的更多控制。示例:</p><pre class="lh li lj lk fd lq lr ls bn lt lu bi"><span id="523b" class="lv kd hi lr b be lw lx l ly lz">export SPARK_PROPERTIES=spark.executor.instances=50,spark.dynamicAllocation.maxExecutors=200</span></pre><h1 id="f084" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">参考</h1><ul class=""><li id="68ff" class="jo jp hi is b it la ix lb jb lm jf ln jj lo jn ma ju jv jw bi translated"><a class="ae lf" href="https://cloud.google.com/dataproc-serverless/docs/overview" rel="noopener ugc nofollow" target="_blank"> Dataproc无服务器文档</a></li><li id="97de" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn ma ju jv jw bi translated"><a class="ae lf" href="https://github.com/GoogleCloudPlatform/dataproc-templates" rel="noopener ugc nofollow" target="_blank"> Dataproc模板GitHub库</a></li><li id="e37f" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn ma ju jv jw bi translated"><a class="ae lf" href="http://docs.snowflake.com/en/user-guide/spark-connector.html#snowflake-connector-for-spark" rel="noopener ugc nofollow" target="_blank">火花雪花连接器</a></li><li id="4264" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn ma ju jv jw bi translated"><a class="ae lf" rel="noopener" href="/google-cloud/cloud-spanner-export-query-results-using-dataproc-serverless-6f2f65b583a4"> Medium — Cloud Spanner使用Dataproc Serverless导出查询结果</a></li></ul><p id="be96" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如有任何疑问或建议，请联系:dataproc-templates-support-external@googlegroups.com</p></div></div>    
</body>
</html>