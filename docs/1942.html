<html>
<head>
<title>GCP CA Service: A practical demo on how to get started!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP CA服务:如何开始的实用演示！</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-ca-service-how-to-get-started-6eba056c9e12?source=collection_archive---------0-----------------------#2021-08-17">https://medium.com/google-cloud/gcp-ca-service-how-to-get-started-6eba056c9e12?source=collection_archive---------0-----------------------#2021-08-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/19fbfa3b9fd8cd0be35931b571d1e570.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JZR_9ZtkriYJ7zm_.png"/></div></div></figure><p id="10c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">管理私有CA基础架构可能会很困难，通常由十年前的服务器或虚拟机组成，这些服务器或虚拟机被小心地放置在具有非常严格的网络策略的区域，在某些情况下，用户界面体验还停留在21世纪初。</p><p id="b03b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本帖中，我们通过使用基础设施作为代码来部署演示，以实用的方式介绍了GCP的新CA服务。</p><h1 id="1ee8" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">背景</h1><p id="d6a2" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">GCP最近发布了新的CA服务(在这里阅读全部内容:<a class="ae kr" href="https://cloud.google.com/blog/products/identity-security/google-cloud-certificate-authority-service-is-now-ga" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/blog/products/identity-security/Google-cloud-certificate-authority-Service-is-now-ga</a>)，在这里您可以部署私有CA的架构，为您的私有服务提供私有证书。</p><p id="02af" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这绝对是一个奇妙的服务，因为它简化了通常需要的基础设施，允许您告别丑陋的服务器及其维护，同时向API驱动的证书请求、CRL和证书管理问好！</p><p id="fdda" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这与对Terraform、JetStack Cert-Manager和Hashicorp Vault的支持相结合，提供了一种现代的、无服务器的方式来提供私有CA架构。(阅读:不再有windows 2008 R2服务器坐在那里积灰，被隔离在一个周界中，安全团队祈祷在他们缓慢而小心地修补时不要妥协)</p><p id="0ed2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">那么，我们如何开始使用Terraform呢？</p><h1 id="5e49" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">先决条件</h1><ul class=""><li id="e39c" class="ks kt hi is b it km ix kn jb ku jf kv jj kw jn kx ky kz la bi translated">需要一些基础的Terraform知识！</li><li id="b161" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">继续专门为此建立一个GCP项目。</li><li id="a506" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">权限:为了平稳运行演示环境，请确保您已经获得:</li><li id="3f7f" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">项目IAM管理，以便您可以应用IAM策略；KMS管理，以便您可以创建和销毁密钥环和密钥CAS服务操作符，以便您可以在CA服务中构建您需要的东西。请记住，对于生产环境，您可能希望遵循最低权限的方法，并对这些权限进行更细粒度的控制。</li><li id="4b68" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">我的示例代码使用了变量，所以请使用我的repo中提供的示例variables.tf文件。</li></ul></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><h1 id="d2fe" class="jo jp hi bd jq jr ln jt ju jv lo jx jy jz lp kb kc kd lq kf kg kh lr kj kk kl bi translated">设计</h1><p id="1ac7" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在本演示中，我们将使用CA服务来提供根CA和从属CA。根据您所在的行业，您可能不得不采用混合方法，在这种方法中，您的根CA保留在本地，但这没关系，因为CA服务支持它！</p><p id="f8bc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">CA服务提供了完全由服务管理的密钥选项，但在本演示中，我们更倾向于客户管理的密钥，其材料由KMS通过HSM密钥保护选项(FIPS 140–3)进行保护，从未如此简单..)</p><p id="4a52" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，需要注意的是，CA服务依赖于KMS和GCS。KMS存储关键材料，GCS管理CRL。GCS可以由服务管理，也可以由客户管理，但出于本演示的目的，我们将采用服务管理。</p><h1 id="88b9" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">第一步:拿钥匙</h1><p id="cce2" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">首先，我们将创建一个密钥环，创建一个密钥，并确保其hsm受到保护。</p><figure class="ls lt lu lv fd ij"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="f176" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这有几个作用。</p><ol class=""><li id="40e9" class="ks kt hi is b it iu ix iy jb ly jf lz jj ma jn mb ky kz la bi translated">首先，它使用名称和地区创建一个密匙环。请记住，密钥是地区性的！(第2-5行)</li><li id="6040" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn mb ky kz la bi translated">在密钥环中创建一个密钥，给它一个名称(第8、9行)并设置为非对称(第10行)。在那里，它设置了我们需要的所有东西，例如密钥的算法<code class="du mc md me mf b">rsa_sign_pss_3072_sha256</code>,并在那里使用HSM级密钥保护来保护密钥材料(FIPS 140–3..搞定了。).因为这是一个演示，我们也禁用了防止破坏键值。</li><li id="7e86" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn mb ky kz la bi translated">最后，我们为terraform创建了一个<code class="du mc md me mf b">data</code>块，以便以后引用。</li></ol><p id="0ab9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们要在这里施展一些魔法。因为我们在这里使用客户管理的密钥，所以我们必须确保CA服务使用的服务帐户能够针对该密钥执行所需的操作。</p><figure class="ls lt lu lv fd ij"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="c083" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">简单地说，这做了两件事:</p><ol class=""><li id="0254" class="ks kt hi is b it iu ix iy jb ly jf lz jj ma jn mb ky kz la bi translated">将cloudkms.signerverifier角色添加到CAS服务帐户</li><li id="440d" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn mb ky kz la bi translated">将“查看者”基本角色添加到CAS服务帐户</li></ol><p id="f351" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们和KMS结束了！</p><h1 id="7462" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">第二步:建一个游泳池</h1><p id="e931" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">下一步是构建CA池，然后将东西(CA的！)投入其中。ca池是一个简洁的概念——它们提供了在池中的子CA之间分发请求的能力，以获得每秒更好的查询，还提供了一种简洁的方法来废弃和替换池中的子CA，而不必让您的证书使用者重新编码任何东西！</p><figure class="ls lt lu lv fd ij"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="6f6a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">很好很容易！我们已经在这里创建了两个池，一个用于根ca，一个用于subca！将根CA池和子CA池分开很重要。这个想法是，同一个池中的所有ca是完全可以互换的；要获得池的好处，您需要让服务在池中为您选择实际的颁发CA。</p><p id="85e6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，如果你的根和下属都在同一个池中，这意味着你的一堆叶证书将由根颁发，这很可能不是你想要的！</p><p id="7bb6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们给它一个名称，在一个区域中弹出它(使用与您的kms钥匙圈相同的一个，这就是为什么我们使用相同的变量)并提供一个层。</p><p id="b1e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在有两层:</p><ul class=""><li id="2954" class="ks kt hi is b it iu ix iy jb ly jf lz jj ma jn kx ky kz la bi translated">DevOps</li><li id="0859" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">企业。</li></ul><p id="cba4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">关键区别在于跟踪。企业提供CRL和撤销能力。DevOps没有。然而，DevOps提供了更高的每秒查询值(25，vs . 7 ),因此可以发布更多的短期证书。由于安全性始终是GCP的一个优势，较便宜的DevOps层仍然允许使用HSM，但警告必须是服务管理的密钥。</p><p id="e955" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">希望这能很好地描述何时使用哪一层，但是要经常查看<a class="ae kr" href="https://cloud.google.com/certificate-authority-service/docs/tiers" rel="noopener ugc nofollow" target="_blank">文档</a></p><h1 id="aabb" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">第三步:进入游泳池</h1><p id="f0c2" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">现在我们有了钥匙，我们有了游泳池..是时候去游泳了。</p><p id="3fd9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，让我们创建根CA！</p><figure class="ls lt lu lv fd ij"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="4ea1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以我们在这里做了一些事情</p><ol class=""><li id="18b0" class="ks kt hi is b it iu ix iy jb ly jf lz jj ma jn mb ky kz la bi translated">创建根CA并将其分配给我们之前创建的池</li><li id="7e08" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn mb ky kz la bi translated">配置成为CA所需的基本x.509值</li><li id="ec47" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn mb ky kz la bi translated">定义基本密钥和扩展密钥的用法(例如，我能签署证书吗，我能提供CRL吗，以及它能提供哪种证书)</li><li id="e8ab" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn mb ky kz la bi translated">定义证书本身的值(通常的事情！)</li><li id="27cd" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn mb ky kz la bi translated">指定要使用的密钥版本。这是一个有点疯狂的开始，但我知道它很快就会被修复。目前在terraform中，没有办法获得CAS构建服务所需的关键版本名(如路径中所示)。因此，您需要调用keyversion的id，然后使用trimprefix删除它返回的API值的URL部分。</li></ol><p id="6c1f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就这样。现在我们有一个根CA，准备好了！为了构建一个CA，我们基本上复制并粘贴代码(或者如果我们没有使用示例..构建一个TF模块并引用它)</p><figure class="ls lt lu lv fd ij"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="cdb6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">又是同样的事情！</p><h1 id="a22c" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">接下来是什么？</h1><p id="392f" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">概括地说，从不到150行的Terraform中，我们构建了:</p><ul class=""><li id="2001" class="ks kt hi is b it iu ix iy jb ly jf lz jj ma jn kx ky kz la bi translated">由根CA和子CA组成的专用CA拓扑，两者都位于一个池中，使用客户管理的加密密钥</li><li id="fbfa" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">一种客户管理的加密密钥，其密钥材料受HSM保护</li><li id="528e" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">按照当前推荐的doco，使其工作所需的所有IAM权限。</li></ul><p id="e4f9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在剩下的就是完成CA的典型功能，我不会在这里介绍(但是如果以后有需求的话可能会介绍)。这包括:</p><ul class=""><li id="3b67" class="ks kt hi is b it iu ix iy jb ly jf lz jj ma jn kx ky kz la bi translated">通过向根请求证书来激活子CA。根签名，然后你把它上传回CA。</li><li id="010f" class="ks kt hi is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">将证书本身提供给最终用户。这是一个与上面非常相似的步骤。</li></ul></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><h1 id="2b5f" class="jo jp hi bd jq jr ln jt ju jv lo jx jy jz lp kb kc kd lq kf kg kh lr kj kk kl bi translated">结论</h1><p id="241f" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">希望这篇文章展示了通过使用GCP CA服务，以现代方式部署一个安全的、可伸缩的私有CA架构是多么容易。</p><p id="bcea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你正在实现基础设施现代化的进程中，你也应该考虑如何在各个层面实现安全保障的现代化。这包括私有CA体系结构，该体系结构需要进行扩展，以满足其旨在保护的扩展基础架构不断增长的需求。</p><h1 id="a390" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">参考</h1><p id="838f" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">回购:</p><div class="mg mh ez fb mi mj"><a href="https://github.com/dgulli/JATGEP/tree/main/Examples/Dev/Services/CAS%20Demo/Pure%20cloud" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hj fi z dy mo ea eb mp ed ef hh bi translated">jat GEP/Examples/Dev/Services/CAS Demo/Pure cloud at main dgu lli/jat GEP</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">构建一个项目，然后在GCP构建gce实例。通过在…上创建帐户，为dgulli/JATGEP开发做出贡献</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">github.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx io mj"/></div></div></a></div><p id="1a62" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">文献:<a class="ae kr" href="https://cloud.google.com/certificate-authority-service" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/certificate-authority-service</a></p></div></div>    
</body>
</html>