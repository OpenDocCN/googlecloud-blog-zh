<html>
<head>
<title>Displaying BigQuery results on Google Maps using Data Studio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Data Studio在Google Maps上显示BigQuery结果</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/displaying-bigquery-results-on-google-maps-using-data-studio-bded264bfd53?source=collection_archive---------0-----------------------#2020-05-08">https://medium.com/google-cloud/displaying-bigquery-results-on-google-maps-using-data-studio-bded264bfd53?source=collection_archive---------0-----------------------#2020-05-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="b9df" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">数据工作室有一个谷歌地图层</h2></div><p id="a29f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae jt" href="https://www.google.com/covid19/mobility/" rel="noopener ugc nofollow" target="_blank">谷歌移动报告</a>提供了由于新冠肺炎相关问题和公共健康建议，零售和娱乐场所的访问量下降的程度。但是这些报告给你的是pdf或CSV格式的数据。</p><p id="cbf4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你想要一张这样的地图呢？</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ju"><img src="../Images/a56c7c323f5a7dfca0c7d693f2d87f86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*276-JvGNgI9jwEmKKZZ4Qw.png"/></div></div><figcaption class="kg kh et er es ki kj bd b be z dx translated">美国各地对零售和娱乐场所的访问是如何变化的。绿点表示游客数量大幅下降的县，红点表示游客数量基本持平的县。</figcaption></figure><h2 id="fce9" class="kk kl hi bd km kn ko kp kq kr ks kt ku jg kv kw kx jk ky kz la jo lb lc ld le bi translated">SQL查询</h2><p id="8479" class="pw-post-body-paragraph ix iy hi iz b ja lf ij jc jd lg im jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">移动性数据在BigQuery中作为公共数据集，因此转到https://console.cloud.google.com/BigQuery的<a class="ae jt" href="https://console.cloud.google.com/BigQuery" rel="noopener ugc nofollow" target="_blank">并运行以下查询:</a></p><pre class="jv jw jx jy fd lk ll lm ln aw lo bi"><span id="30c3" class="kk kl hi ll b fi lp lq l lr ls">WITH agg AS (<br/>SELECT <br/>  MAX(date) AS latest_date<br/>FROM `bigquery-public-data.covid19_google_mobility.mobility_report`<br/>),</span><span id="d3b3" class="kk kl hi ll b fi lt lq l lr ls">latest_data AS (<br/>  SELECT<br/>    country_region_code, sub_region_1, sub_region_2, retail_and_recreation_percent_change_from_baseline<br/>  FROM `bigquery-public-data.covid19_google_mobility.mobility_report`, agg<br/>  WHERE date = agg.latest_date AND country_region_code = 'US' <br/>  AND retail_and_recreation_percent_change_from_baseline IS NOT NULL<br/>),</span><span id="d13d" class="kk kl hi ll b fi lt lq l lr ls">with_state_fips AS (<br/>  SELECT <br/>    state_fips_code AS sfc,<br/>    TRIM(REPLACE(sub_region_2, 'County', '')) AS trimmed_county_name,<br/>    retail_and_recreation_percent_change_from_baseline<br/>  FROM latest_data<br/>  JOIN `bigquery-public-data`.utility_us.us_states_area<br/>  ON sub_region_1 = state_name<br/>)</span><span id="767d" class="kk kl hi ll b fi lt lq l lr ls">SELECT <br/>    CONCAT(ST_Y(ST_CENTROID(county_geom)),',',ST_X(ST_CENTROID(county_geom))) AS marker,<br/>    (100 + retail_and_recreation_percent_change_from_baseline) AS mobility<br/>  FROM with_state_fips<br/>  JOIN `bigquery-public-data`.utility_us.us_county_area<br/>  ON trimmed_county_name = county_name AND sfc = state_fips_code</span></pre><p id="e44e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上面的查询由以下部分组成:</p><ol class=""><li id="bf26" class="lu lv hi iz b ja jb jd je jg lw jk lx jo ly js lz ma mb mc bi translated">查找流动报告可用的最晚日期</li><li id="ea5a" class="lu lv hi iz b ja md jd me jg mf jk mg jo mh js lz ma mb mc bi translated">获取美国每个州/县的最新数据。</li><li id="4371" class="lu lv hi iz b ja md jd me jg mf jk mg jo mh js lz ma mb mc bi translated">使用州名(例如，WA)获取州FIPS代码(例如，53)并修改县名(例如，King county)以去掉单词County。</li><li id="83af" class="lu lv hi iz b ja md jd me jg mf jk mg jo mh js lz ma mb mc bi translated">根据县信息的公共数据集进行连接，以获得每个县的质心。</li></ol><p id="6c6d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">结果数据如下所示:</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es mi"><img src="../Images/90149798d64fd0f44a62e89b1e31c39a.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/format:webp/1*FMdQcuG7nJEatEpqtroQbA.png"/></div></figure><h2 id="0129" class="kk kl hi bd km kn ko kp kq kr ks kt ku jg kv kw kx jk ky kz la jo lb lc ld le bi translated">在Data Studio中查看</h2><p id="86f5" class="pw-post-body-paragraph ix iy hi iz b ja lf ij jc jd lg im jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">在BigQuery web控制台中，单击“浏览数据”按钮并选择Data Studio。</p><p id="7e7c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">选择谷歌地图层(见下图)</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es mj"><img src="../Images/8b340ed4074d9199290bde465405f5fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*sWMwcQeP5sfSn4Rd1rr-rQ.png"/></div></figure><p id="2b43" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将气泡位置更改为“标记”，并将类型编辑为地理&gt;纬度、经度。</p><p id="b267" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">去掉气泡尺寸——我们希望所有的点都一样大。</p><p id="70c9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将气泡颜色字段更改为“移动性”。</p><p id="da40" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，切换到样式选项卡。将气泡数增加到5000。然后，改变颜色，使最大=红色，中等=黄色，最小=绿色，如下所示。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es mk"><img src="../Images/faef31b923dc389de18958afbfa36cbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:586/format:webp/1*AuapGQlPzatDhe4seB6P_Q.png"/></div></figure><p id="9bdd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您将拥有一个类似于本文开头的仪表板。现在让我们构建一个显示案例数量的仪表板。</p><h2 id="e568" class="kk kl hi bd km kn ko kp kq kr ks kt ku jg kv kw kx jk ky kz la jo lb lc ld le bi translated">新增确诊病例</h2><p id="0d5c" class="pw-post-body-paragraph ix iy hi iz b ja lf ij jc jd lg im jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">使用此查询连接来自纽约时报的已确认病例数(它也是BigQuery中的公共数据集):</p><pre class="jv jw jx jy fd lk ll lm ln aw lo bi"><span id="01b8" class="kk kl hi ll b fi lp lq l lr ls">CREATE TEMPORARY FUNCTION trim_county(sub_region_2 STRING) <br/>AS (<br/>TRIM(REPLACE(sub_region_2, 'County', ''))<br/>);</span><span id="2fec" class="kk kl hi ll b fi lt lq l lr ls">WITH agg AS (<br/>SELECT <br/>  MAX(date) AS latest_date<br/>FROM `bigquery-public-data.covid19_google_mobility.mobility_report`<br/>),</span><span id="f54a" class="kk kl hi ll b fi lt lq l lr ls">latest_data AS (<br/>  SELECT<br/>    country_region_code, <br/>    sub_region_1, <br/>    county AS trimmed_county_name,<br/>    retail_and_recreation_percent_change_from_baseline,<br/>    confirmed_cases<br/>  FROM `bigquery-public-data`.covid19_google_mobility.mobility_report, agg<br/>  JOIN `bigquery-public-data`.covid19_nyt.us_counties AS nyt<br/>  ON sub_region_1 = state_name AND trim_county(sub_region_2) = county AND mobility_report.date = nyt.date<br/>  WHERE nyt.date = agg.latest_date AND country_region_code = 'US' <br/>  AND retail_and_recreation_percent_change_from_baseline IS NOT NULL<br/>),</span><span id="1382" class="kk kl hi ll b fi lt lq l lr ls">with_state_fips AS (<br/>  SELECT <br/>    state_fips_code AS sfc,<br/>    trimmed_county_name,<br/>    retail_and_recreation_percent_change_from_baseline,<br/>    confirmed_cases<br/>  FROM latest_data<br/>  JOIN `bigquery-public-data`.utility_us.us_states_area<br/>  ON sub_region_1 = state_name<br/>)</span><span id="c3ac" class="kk kl hi ll b fi lt lq l lr ls">SELECT <br/>    CONCAT(ST_Y(ST_CENTROID(county_geom)),',',ST_X(ST_CENTROID(county_geom))) AS marker,<br/>    (100 + retail_and_recreation_percent_change_from_baseline) AS mobility,<br/>    LOG(confirmed_cases) AS log_cases<br/>  FROM with_state_fips<br/>  JOIN `bigquery-public-data`.utility_us.us_county_area<br/>  ON trimmed_county_name = county_name AND sfc = state_fips_code</span></pre><p id="c194" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">设置Data Studio以显示基于log_cases的气泡大小:</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es ml"><img src="../Images/9388f34f84c98302838a6d20608ce781.png" data-original-src="https://miro.medium.com/v2/resize:fit:316/format:webp/1*AixmZF4ZfzgNb4blBX7OCg.png"/></div></figure><p id="4320" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">结果将如下所示:</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es mm"><img src="../Images/bc8cfdc39f47734dcace007099e3e01f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZD2dt76c-Acsz71ChWE5-w.png"/></div></div></figure><p id="6de2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意科罗拉多和德克萨斯在行为和结果上的差异…</p><h2 id="cfcc" class="kk kl hi bd km kn ko kp kq kr ks kt ku jg kv kw kx jk ky kz la jo lb lc ld le bi translated">共享</h2><p id="c262" class="pw-post-body-paragraph ix iy hi iz b ja lf ij jc jd lg im jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">您可以像共享任何Data Studio仪表板一样共享此Data Studio仪表板。目前(感谢<a class="mn mo ge" href="https://medium.com/u/279fe54c149a?source=post_page-----bded264bfd53--------------------------------" rel="noopener" target="_blank">费利佩·霍法</a>提供的信息)，嵌入地图是不可能的。</p><p id="906a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">想看一步一步的教程？看看这个来自菲利普和玉峰的视频:</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="mp mq l"/></div></figure><p id="d093" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">尽情享受吧！</p></div></div>    
</body>
</html>