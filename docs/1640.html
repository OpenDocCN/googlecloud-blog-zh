<html>
<head>
<title>Conditionally unmask columns in BigQuery using Authorized UDFs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用授权的UDF有条件地取消BigQuery中列的掩码</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/conditionally-unmasking-columns-in-bigquerys-using-authorized-udfs-f3a55a9665fb?source=collection_archive---------0-----------------------#2020-10-29">https://medium.com/google-cloud/conditionally-unmasking-columns-in-bigquerys-using-authorized-udfs-f3a55a9665fb?source=collection_archive---------0-----------------------#2020-10-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9996" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">BigQuery数据仓库在管理员如何设置<a class="ae jd" href="https://cloud.google.com/bigquery/docs/access-control#overview" rel="noopener ugc nofollow" target="_blank">访问控制</a>和<a class="ae jd" href="https://cloud.google.com/bigquery/docs/column-level-security-intro" rel="noopener ugc nofollow" target="_blank">列级安全性</a>方面有很大的灵活性。然而，BigQuery的列级安全性目前只允许在访问敏感列时出现两种结果:查询成功显示列的明文或查询失败。</p><p id="2fcf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">组织经常需要更大的灵活性，例如，他们经常想要截断时间戳或只显示电话号码的最后四位数字。在复杂的情况下，一个组织可能希望共享T <a class="ae jd" href="https://github.com/google/tink" rel="noopener ugc nofollow" target="_blank"> ink加密的</a>数据，同时还控制对对称密钥的访问。</p><p id="c3a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我将向您展示如何将BigQuery的AEAD加密函数嵌入到授权的UDF中，以便有条件地操作解密后的值，而不会将加密密钥暴露给最终用户。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/5e30c8361c462fa7fa78261f2f330823.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s0eELS7Gum-EmIFZOzeudA.jpeg"/></div></div></figure><p id="231b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jq">本指南假设您遵循使用</em> <a class="ae jd" href="https://cloud.google.com/shell/docs" rel="noopener ugc nofollow" target="_blank"> <em class="jq">云壳</em> </a> <em class="jq">的说明，并使用bash脚本格式化</em><a class="ae jd" href="https://cloud.google.com/sdk/gcloud" rel="noopener ugc nofollow" target="_blank"><em class="jq">g Cloud</em></a><em class="jq">和</em> <a class="ae jd" href="https://cloud.google.com/bigquery/docs/bq-command-line-tool" rel="noopener ugc nofollow" target="_blank"> <em class="jq"> bq </em> </a> <em class="jq">命令。除了从服务帐户查询BigQuery之外，所有执行的操作都可以在</em> <a class="ae jd" href="https://cloud.google.com/compute/docs/console" rel="noopener ugc nofollow" target="_blank"> <em class="jq">谷歌云控制台</em> </a> <em class="jq">中执行。</em></p><h2 id="22ff" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated">创建二级用户</h2><p id="1860" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">需要第二个帐户来模拟具有条件数据访问的用户。本指南将模拟具有服务帐户的第二个用户。</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="1601" class="jr js hi ks b fi kw kx l ky kz">gcloud iam service-accounts create bq-test-acct \<br/>--display-name="bq-test-acct"</span><span id="e23a" class="jr js hi ks b fi la kx l ky kz">#assign the full sevice account name to a variable<br/>SERV_ACCT=$(gcloud iam service-accounts list --format="value(email)" | grep bq-test-acct)</span><span id="931f" class="jr js hi ks b fi la kx l ky kz">gcloud projects add-iam-policy-binding $DEVSHELL_PROJECT_ID \<br/>--member="serviceAccount:${SERV_ACCT}" \<br/>--role='roles/bigquery.jobUser'</span></pre><h2 id="0d5b" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated">设置测试数据</h2><p id="7a75" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">在一个对普通用户安全的<code class="du lb lc ld ks b">private</code>数据集中，创建一个将AEAD键集映射到数据类别的表。</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="56ca" class="jr js hi ks b fi kw kx l ky kz">ACCT=$(gcloud auth list \<br/>--filter=status:ACTIVE --format="value(account)")</span><span id="bb3b" class="jr js hi ks b fi la kx l ky kz">bq mk --dataset --location=US private</span><span id="6d5a" class="jr js hi ks b fi la kx l ky kz">SQL=$(cat &lt;&lt;- EOM<br/>  CREATE OR REPLACE TABLE private.keys<br/>  CLUSTER BY category<br/>  AS (<br/>    SELECT <br/>      'category_a' as category,<br/>      KEYS.NEW_KEYSET('AEAD_AES_GCM_256') as keys<br/>    UNION ALL<br/>    SELECT<br/>      'category_b' as category,<br/>      KEYS.NEW_KEYSET('AEAD_AES_GCM_256') as keys<br/>  )<br/>EOM<br/>)</span><span id="de6a" class="jr js hi ks b fi la kx l ky kz">bq query --use_legacy_sql=false ${SQL}</span></pre><p id="9225" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在创建<code class="du lb lc ld ks b">private.user_keys</code>表，将用户映射到每个类别的访问级别。该脚本授予服务帐户用户“1级”访问权限，授予您的当前用户“2级”访问权限。级别值将决定如何转换返回给请求用户的解密值。</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="c53b" class="jr js hi ks b fi kw kx l ky kz">SQL=$(cat &lt;&lt;- EOM<br/>  CREATE OR REPLACE TABLE private.user_keys<br/>  CLUSTER BY category, username<br/>  AS (<br/>    SELECT<br/>      '${SERV_ACCT}' as username,<br/>      1 as level,<br/>      category,<br/>      keys<br/>    FROM private.keys a<br/>    WHERE category = 'category_a'<br/>    UNION ALL<br/>    SELECT<br/>      '${ACCT}' as username,<br/>      2 as level,<br/>      category,<br/>      keys<br/>    FROM private.keys a<br/>    WHERE category = 'category_a'<br/>  )<br/>EOM<br/>)</span><span id="7fda" class="jr js hi ks b fi la kx l ky kz">bq query --use_legacy_sql=false ${SQL}</span></pre><p id="2d2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用在<code class="du lb lc ld ks b">private.keys</code>表中创建的加密密钥，在<code class="du lb lc ld ks b">public</code>数据集中创建一个表，使用<a class="ae jd" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/aead_encryption_functions#aeadencrypt" rel="noopener ugc nofollow" target="_blank"> AEAD.encrypt </a>函数，将加密的值呈现给最终用户。</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="9ac0" class="jr js hi ks b fi kw kx l ky kz">bq mk --dataset --location=US public</span><span id="57e8" class="jr js hi ks b fi la kx l ky kz">SQL=$(cat &lt;&lt;- EOM<br/>  DECLARE KEYSTRING BYTES;<br/>  SET KEYSTRING = (SELECT keys FROM private.keys a WHERE  category='category_a');</span><span id="5549" class="jr js hi ks b fi la kx l ky kz">  CREATE OR REPLACE TABLE public.sample_data <br/>  AS (<br/>    SELECT <br/>      unique_key, <br/>      AEAD.encrypt(<br/>        KEYSTRING, <br/>        CAST(created_date as STRING), <br/>        CAST(unique_key as string)<br/>      ) AS sec_created_date, <br/>      status_notes<br/>    FROM \`bigquery-public-data.san_francisco.311_service_requests\`<br/>    LIMIT 10000<br/>  );<br/>EOM<br/>)</span><span id="c925" class="jr js hi ks b fi la kx l ky kz">bq query --use_legacy_sql=false ${SQL}</span></pre><p id="e9b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了完成环境设置，授予服务帐户访问<code class="du lb lc ld ks b">public</code>数据集中对象的必要权限，但不授予<code class="du lb lc ld ks b">private</code>数据集中对象的权限。在这个例子中，我使用了<a class="ae jd" href="https://stedolan.github.io/jq/manual/" rel="noopener ugc nofollow" target="_blank"> jq </a>实用程序来简化json解析，这是在<a class="ae jd" href="https://cloud.google.com/bigquery/docs/dataset-access-controls#controlling_access_to_a_dataset" rel="noopener ugc nofollow" target="_blank">命令行方法</a>上更新数据集权限所必需的。</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="722f" class="jr js hi ks b fi kw kx l ky kz">bq show --format=prettyjson public &gt; dataset.json</span><span id="a393" class="jr js hi ks b fi la kx l ky kz">JQE=$(cat &lt;&lt;- EOM<br/>.access += <br/>[{ <br/>   "role":"WRITER",<br/>   "userByEmail":"${SERV_ACCT}"<br/>}]<br/>EOM<br/>)</span><span id="db7b" class="jr js hi ks b fi la kx l ky kz">cat dataset.json | jq "${JQE}" &gt; grant.json</span><span id="df75" class="jr js hi ks b fi la kx l ky kz">bq update --source grant.json public</span></pre><h2 id="25f9" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated">创建授权的UDF</h2><p id="8318" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">授权UDF与常规UDF的区别在于，对象被授权访问底层GCP资源，即使会话用户没有被授权。</p><p id="1e70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该UDF检查当前用户，并根据他们的访问级别应用转换。具有“级别1”访问权限的用户可以看到结果的截断版本，而具有“级别2”访问权限的用户将获得完整的值。</p><p id="05f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您的项目管理员创建该功能时，登录到云外壳。</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="4753" class="jr js hi ks b fi kw kx l ky kz">SQL=$(cat &lt;&lt;- EOM<br/>  CREATE OR REPLACE FUNCTION public.cond_timestamp_unmask(col BYTES, add_data STRING, key_category STRING)<br/>  AS ((<br/>    SELECT <br/>      CASE b.level<br/>        WHEN 1 <br/>        THEN TIMESTAMP_TRUNC(<br/>          CAST(aead.decrypt_string(b.keys, col, add_data) as TIMESTAMP),<br/>          DAY<br/>        )<br/>        WHEN 2 <br/>        THEN CAST(aead.decrypt_string(b.keys, col, add_data) as TIMESTAMP)<br/>        ELSE NULL<br/>      END AS datevalue <br/>    FROM private.user_keys b<br/>    WHERE b.category = key_category<br/>    AND b.username = session_user()<br/>  ));<br/>EOM<br/>)</span><span id="1255" class="jr js hi ks b fi la kx l ky kz">bq query --use_legacy_sql=false ${SQL}</span></pre><p id="1697" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过授予UDF对<code class="du lb lc ld ks b">private</code>数据集的访问权限来授权UDF。在这个例子中，我再次使用“<a class="ae jd" href="https://stedolan.github.io/jq/manual/" rel="noopener ugc nofollow" target="_blank"> jq </a>”实用程序来简化更新数据集权限以<a class="ae jd" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/user-defined-functions?hl=nl#authorized_udfs" rel="noopener ugc nofollow" target="_blank">授权UDF </a>所需的json解析。</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="d295" class="jr js hi ks b fi kw kx l ky kz">bq show --format=prettyjson private &gt; priv.json</span><span id="8435" class="jr js hi ks b fi la kx l ky kz">JQE=$(cat &lt;&lt;- EOM<br/>.access += <br/>[{ "routine": <br/>  {"datasetId":"public",<br/>   "projectId":"${DEVSHELL_PROJECT_ID}",<br/>   "routineId":"cond_timestamp_unmask"} <br/>}]<br/>EOM<br/>)</span><span id="0c57" class="jr js hi ks b fi la kx l ky kz">cat priv.json | jq "${JQE}" &gt; authorized.json</span><span id="3d6b" class="jr js hi ks b fi la kx l ky kz">bq update --source authorized.json private</span></pre><h2 id="235b" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated">使用服务帐户</h2><p id="4b4b" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">为了使说明保持简单，本指南将服务帐户密钥下载到云外壳中。或者，您可以考虑创建一个虚拟机，将“bq-test-acct”作为虚拟机的服务帐户。</p><p id="3dff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无论是哪种情况，都建议在云外壳内打开第二个终端会话<a class="ae jd" href="https://cloud.google.com/shell/docs/using-cloud-shell#opening_multiple_terminal_sessions" rel="noopener ugc nofollow" target="_blank">以服务帐户用户的身份运行。</a></p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="6892" class="jr js hi ks b fi kw kx l ky kz">SERV_ACCT=$(gcloud iam service-accounts list --format="value(email)" | grep bq-test-acct)</span><span id="148e" class="jr js hi ks b fi la kx l ky kz">gcloud iam service-accounts keys create key.json \<br/>--iam-account ${SERV_ACCT}</span><span id="58be" class="jr js hi ks b fi la kx l ky kz">gcloud auth activate-service-account ${SERV_ACCT} \<br/>--key-file="key.json"</span><span id="4e5d" class="jr js hi ks b fi la kx l ky kz">#should show the service account<br/>bq query --use_legacy_sql=false 'select session_user()'</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es le"><img src="../Images/dbecbcce5406b5f7479fe0662e38704b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0adTvFT3CL6kiwO6fSdvAQ.jpeg"/></div></div></figure><p id="6e79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确认对具有加密数据的表的访问，同时拒绝对具有密钥材料的表的访问。</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="7cf2" class="jr js hi ks b fi kw kx l ky kz">#Query should be successful<br/>bq query --use_legacy_sql=false \<br/>'select * from public.sample_data limit 1'</span><span id="a1c2" class="jr js hi ks b fi la kx l ky kz">#Query should return denied<br/>bq query --use_legacy_sql=false \<br/>'select * from private.keys limit 1'</span></pre><h2 id="4c9a" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated">测试UDF</h2><p id="18f6" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">使用条件函数作为普通用户帐户和服务帐户发出查询。普通用户帐户将会看到完整的解析时间戳，而服务帐户将会看到截断到一天的时间戳。</p><pre class="jf jg jh ji fd kr ks kt ku aw kv bi"><span id="a360" class="jr js hi ks b fi kw kx l ky kz">SQL=$(cat &lt;&lt;- EOM<br/>  SELECT<br/>    unique_key,<br/>    session_user() as user,<br/>    public.cond_timestamp_unmask(<br/>      sec_created_date, <br/>      cast(unique_key as string), <br/>      'category_a'<br/>    ) as unmask<br/>  FROM public.sample_data<br/>  LIMIT 10;<br/>EOM<br/>)</span><span id="aa84" class="jr js hi ks b fi la kx l ky kz">bq query --use_legacy_sql=false ${SQL}</span></pre><p id="b745" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">服务帐户的结果。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lf"><img src="../Images/4853eb9b168d6f1001f75ef4db828862.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rnBZWkM_qfKRwrg4LYdByQ.jpeg"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">“1级”用户可以使用截断的时间戳</figcaption></figure><p id="4f52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用户帐户的结果。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lk"><img src="../Images/8c56236d121996a04dab4ba708aa0381.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8L_74UsYbSS3Q5pygtnCJA.jpeg"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">显示完整时间戳的“2级”用户帐户</figcaption></figure><h2 id="1ce9" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated">性能影响</h2><p id="e72f" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">当处理加密操作和UDF时，查询成本是一个经常关注的问题。查看云控制台中的<a class="ae jd" href="https://cloud.google.com/bigquery/query-plan-explanation#viewing_information_cloud_console" rel="noopener ugc nofollow" target="_blank">执行细节</a>；这个UDF是使用散列连接有效实现的。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ll"><img src="../Images/144f1a153977ac79684fb6a3a4db149a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ICrKcWSnty77ffWJMZlCLw.jpeg"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">使用哈希联接执行的查询计划</figcaption></figure><h2 id="0d2c" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated">额外资源</h2><ul class=""><li id="c00a" class="lm ln hi ih b ii km im kn iq lo iu lp iy lq jc lr ls lt lu bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/how-to-control-access-to-bigquery-at-row-level-with-groups-1cbccb111d9e">如何将Google Cloud IAM组信息同步到BigQuery</a></li><li id="8323" class="lm ln hi ih b ii lv im lw iq lx iu ly iy lz jc lr ls lt lu bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/bigquery-encryption-functions-part-i-data-deletion-retention-with-crypto-shredding-7085ecf6e53f">关于将Tink加密数据导入BigQuery的指南</a></li></ul></div></div>    
</body>
</html>