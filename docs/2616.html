<html>
<head>
<title>Use Helm to simplify and secure the deployment of Online Boutique, with Service Mesh, GitOps, and more!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Helm通过Service Mesh、GitOps等简化和保护在线精品店的部署！</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/online-boutiques-helm-chart-to-simplify-the-setup-of-advanced-scenarios-with-service-mesh-and-246119e46d53?source=collection_archive---------0-----------------------#2022-12-12">https://medium.com/google-cloud/online-boutiques-helm-chart-to-simplify-the-setup-of-advanced-scenarios-with-service-mesh-and-246119e46d53?source=collection_archive---------0-----------------------#2022-12-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/bac640cd8736012bd4d428a1e09a7784.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_P0s535_CO3-MnYugddwDQ.png"/></div></div></figure><p id="3a7d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">2023年1月16日更新，在谷歌云控制台中使用新的配置同步用户界面，列出同步的资源及其状态。</em></p><p id="6e0b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从0.4.2版本开始，在线精品有了自己的掌舵图，在<a class="ae jp" href="https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/helm-chart" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>和公共工件注册库:<code class="du jq jr js jt b">us-docker.pkg.dev/online-boutique-ci/charts/onlineboutique</code>。</p><p id="b2b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个掌舵图的意图是简化在线精品店的部署方式，特别是对于高级场景:用<code class="du jq jr js jt b">NetworkPolicies</code>，用“钹店”的品牌；未经<code class="du jq jr js jt b">frontend</code> app公开曝光；用<code class="du jq jr js jt b">ServiceAccounts</code>；同<code class="du jq jr js jt b">AuthorizationPolicies</code>；等等。</p><p id="be66" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们看看如何在这篇博客文章中使用这个掌舵图，从默认设置到更复杂的场景，我们希望在服务网格中部署一个安全的在线精品店。最后，我们将看到如何通过配置同步以GitOps的方式部署这个舵图。</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="080d" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">部署默认在线精品店</h1><p id="de57" class="pw-post-body-paragraph iq ir hi is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hb bi translated">创建GKE集群:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="96d2" class="lm kc hi jt b be ln lo l lp lq">PROJECT_ID=FIXME-WITH-YOUR-PROJECT-ID<br/>CLUSTER=onlineboutique-with-helm<br/>ZONE=northamerica-northeast1-a<br/>PROJECT_NUMBER=$(gcloud projects describe ${PROJECT_ID} --format='get(projectNumber)')<br/>gcloud services enable container.googleapis.com<br/>gcloud container clusters create ${CLUSTER} \<br/>    --zone ${ZONE} \<br/>    --machine-type=e2-standard-4 \<br/>    --workload-pool ${PROJECT_ID}.svc.id.goog \<br/>    --enable-dataplane-v2 \<br/>    --labels mesh_id=proj-${PROJECT_NUMBER}</span></pre><p id="5105" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过掌舵图部署在线精品店:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="0842" class="lm kc hi jt b be ln lo l lp lq">ONLINEBOUTIQUE_NAMESPACE=onlineboutique<br/>helm upgrade onlineboutique oci://us-docker.pkg.dev/online-boutique-ci/charts/onlineboutique \<br/>    --install \<br/>    --create-namespace \<br/>    -n ${ONLINEBOUTIQUE_NAMESPACE}</span></pre><p id="8bb2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您稍等片刻，当<code class="du jq jr js jt b">Pods</code>部署完成后，您可以点击以下网址访问在线精品网站:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="2a9c" class="lm kc hi jt b be ln lo l lp lq">echo -n "http://" &amp;&amp; kubectl get svc frontend-external -n ${ONLINEBOUTIQUE_NAMESPACE} -o json | jq -r '.status.loadBalancer.ingress[0].ip'</span></pre><p id="3124" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">恭喜你。您刚刚通过在线精品店的头盔图部署了默认设置！</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="dbf5" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">使用<code class="du jq jr js jt b">NetworkPolicies</code>保护在线精品店</h1><p id="3b21" class="pw-post-body-paragraph iq ir hi is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hb bi translated">现在，让我们通过添加预定义的细粒度<code class="du jq jr js jt b">NetworkPolicies</code>(每个应用一个)来增加这一默认在线精品设置的安全性:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="7d0f" class="lm kc hi jt b be ln lo l lp lq">helm upgrade onlineboutique oci://us-docker.pkg.dev/online-boutique-ci/charts/onlineboutique \<br/>    --install \<br/>    --create-namespace \<br/>    -n ${ONLINEBOUTIQUE_NAMESPACE} \<br/>    --set networkPolicies.create=true</span></pre><p id="368a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您运行以下命令，您可以看到<code class="du jq jr js jt b">NetworkPolicies</code>已部署:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="4fb0" class="lm kc hi jt b be ln lo l lp lq">kubectl get networkpolicies -n ${ONLINEBOUTIQUE_NAMESPACE}</span></pre><p id="f16f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出类似于:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="936f" class="lm kc hi jt b be ln lo l lp lq">NAME                    POD-SELECTOR                AGE<br/>adservice               app=adservice               4m42s<br/>cartservice             app=cartservice             4m42s<br/>checkoutservice         app=checkoutservice         4m42s<br/>currencyservice         app=currencyservice         4m42s<br/>deny-all                &lt;none&gt;                      4m42s<br/>emailservice            app=emailservice            4m42s<br/>frontend                app=frontend                4m42s<br/>loadgenerator           app=loadgenerator           4m42s<br/>paymentservice          app=paymentservice          4m42s<br/>productcatalogservice   app=productcatalogservice   4m42s<br/>recommendationservice   app=recommendationservice   4m42s<br/>redis-cart              app=redis-cart              4m42s<br/>shippingservice         app=shippingservice         4m42s</span></pre><p id="3414" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以点击以下网址，确认您仍然可以访问在线精品店网站:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="b824" class="lm kc hi jt b be ln lo l lp lq">echo -n "http://" &amp;&amp; kubectl get svc frontend-external -n ${ONLINEBOUTIQUE_NAMESPACE} -o json | jq -r '.status.loadBalancer.ingress[0].ip'</span></pre><p id="aefc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过在<a class="ae jp" href="https://cloud.google.com/anthos/fleet-management/docs" rel="noopener ugc nofollow" target="_blank">车队</a>中注册您的GKE集群，您甚至可以在谷歌云控制台中看到您的安全状况刚刚得到改善:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="e3a9" class="lm kc hi jt b be ln lo l lp lq">gcloud services enable gkehub.googleapis.com<br/><br/>gcloud container fleet memberships register ${CLUSTER} \<br/>    --gke-cluster ${ZONE}/${CLUSTER} \<br/>    --enable-workload-identity</span></pre><p id="c3fa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在你的谷歌云控制台中导航到<strong class="is hj"> Anthos &gt; Security </strong>页面，你可以看到<strong class="is hj"> Kubernetes网络策略</strong>在<strong class="is hj">策略审计</strong>选项卡上的在线精品名称空间中被启用:</p><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/6971c2f0622360fac86b749501f87738.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Ejo-yei-KAR7X9baEEhAw.png"/></div></div></figure></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="eb1e" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">在服务网格中部署在线精品</h1><p id="43cd" class="pw-post-body-paragraph iq ir hi is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hb bi translated">现在，让我们在您的GKE集群上启用的Anthos服务网格中部署在线精品。</p><p id="46b4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，让我们在GKE集群上启用Anthos服务网格:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="b705" class="lm kc hi jt b be ln lo l lp lq">gcloud services enable anthos.googleapis.com \<br/>    mesh.googleapis.com<br/><br/>gcloud container fleet mesh enable<br/><br/>gcloud container fleet mesh update \<br/>    --management automatic \<br/>    --memberships ${CLUSTER}</span></pre><p id="7f47" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">等待托管Anthos服务网格在您的GKE集群上成功启用(<code class="du jq jr js jt b">controlePlaneManagement</code>和<code class="du jq jr js jt b">dataPlaneManagement</code>与<code class="du jq jr js jt b">state: ACTIVE</code>):</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="10d3" class="lm kc hi jt b be ln lo l lp lq">gcloud container fleet mesh describe</span></pre><p id="d2d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了在这个服务网格中拥有在线精品店，我们需要标记它的<code class="du jq jr js jt b">Namespace</code>:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="f42f" class="lm kc hi jt b be ln lo l lp lq">kubectl label namespace ${ONLINEBOUTIQUE_NAMESPACE} istio-injection=enabled</span></pre><p id="a5b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们在网上精品店的<code class="du jq jr js jt b">Deployments</code>上强制注入Istio的sidecar代理:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="9599" class="lm kc hi jt b be ln lo l lp lq">kubectl rollout restart deployments \<br/>    -n ${ONLINEBOUTIQUE_NAMESPACE}</span></pre><p id="5703" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您稍微等一下，直到<code class="du jq jr js jt b">Pods</code>被重新部署，您可以通过点击以下URL访问在线精品网站:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="67e5" class="lm kc hi jt b be ln lo l lp lq">echo -n "http://" &amp;&amp; kubectl get svc frontend-external -n ${ONLINEBOUTIQUE_NAMESPACE} -o json | jq -r '.status.loadBalancer.ingress[0].ip'</span></pre><p id="63ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，通过在Google Cloud控制台中导航到<strong class="is hj"> Anthos &gt;服务网格</strong>页面，您可以看到相关的<strong class="is hj">拓扑</strong>:</p><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/159d77f99fabce6ca733255e4694ba75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j7mbCvWMH32-ZYcmSMRVJw.png"/></div></div></figure><p id="15e3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">恭喜你。您刚刚通过Helm chart在您的服务网格中部署了在线精品店！</p><p id="ff12" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了遵循Istio的最佳实践，我们甚至可以部署细粒度的<code class="du jq jr js jt b">Sidecars</code>，每个应用一个，以便优化每个应用的sidecar代理的CPU和内存资源利用率:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="b6be" class="lm kc hi jt b be ln lo l lp lq">helm upgrade onlineboutique oci://us-docker.pkg.dev/online-boutique-ci/charts/onlineboutique \<br/>    --install \<br/>    --create-namespace \<br/>    -n ${ONLINEBOUTIQUE_NAMESPACE} \<br/>    --set networkPolicies.create=true \<br/>    --set sidecars.create=true</span></pre><p id="5570" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您运行以下命令，您可以看到<code class="du jq jr js jt b">Sidecars</code>已部署:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="7c90" class="lm kc hi jt b be ln lo l lp lq">kubectl get sidecars -n ${ONLINEBOUTIQUE_NAMESPACE}</span></pre><p id="715d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出类似于:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="4ab7" class="lm kc hi jt b be ln lo l lp lq">NAME                    AGE<br/>adservice               36h<br/>cartservice             36h<br/>checkoutservice         36h<br/>currencyservice         36h<br/>emailservice            36h<br/>frontend                36h<br/>loadgenerator           36h<br/>paymentservice          36h<br/>productcatalogservice   36h<br/>recommendationservice   36h<br/>redis-cart              36h<br/>shippingservice         36h</span></pre></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="d779" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">使用<code class="du jq jr js jt b">AuthorizationPolicies</code>保护在线精品店</h1><p id="cc48" class="pw-post-body-paragraph iq ir hi is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hb bi translated">现在，让我们通过添加预定义的精细粒度<code class="du jq jr js jt b">AuthorizationPolicies</code>，为服务网格设置中的在线精品店添加更多安全性，每个应用一个:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="b536" class="lm kc hi jt b be ln lo l lp lq">helm upgrade onlineboutique oci://us-docker.pkg.dev/online-boutique-ci/charts/onlineboutique \<br/>    --install \<br/>    --create-namespace \<br/>    -n ${ONLINEBOUTIQUE_NAMESPACE} \<br/>    --set networkPolicies.create=true \<br/>    --set sidecars.create=true \<br/>    --set serviceAccounts.create=true \<br/>    --set authorizationPolicies.create=true</span></pre><p id="22e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您运行以下命令，您可以看到<code class="du jq jr js jt b">AuthorizationPolicies</code>已部署:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="fee9" class="lm kc hi jt b be ln lo l lp lq">kubectl get authorizationpolicies -n ${ONLINEBOUTIQUE_NAMESPACE}</span></pre><p id="fdd8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出类似于:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="3c5a" class="lm kc hi jt b be ln lo l lp lq">NAME                    AGE<br/>adservice               22m<br/>cartservice             22m<br/>checkoutservice         22m<br/>currencyservice         22m<br/>deny-all                12m<br/>emailservice            22m<br/>frontend                22m<br/>paymentservice          22m<br/>productcatalogservice   22m<br/>recommendationservice   22m<br/>redis-cart              22m<br/>shippingservice         22m</span></pre><p id="fffa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">注意:为了定义这些细粒度的</em> <code class="du jq jr js jt b"><em class="jo">AuthorizationPolicies</em></code> <em class="jo">，我们也需要为每个应用创建一个</em> <code class="du jq jr js jt b"><em class="jo">ServiceAccount</em></code> <em class="jo">，而不是为所有应用使用</em> <code class="du jq jr js jt b"><em class="jo">default</em></code> <em class="jo"> </em> <code class="du jq jr js jt b"><em class="jo">ServiceAccount</em></code> <em class="jo">。</em></p><p id="1ec4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以点击以下网址，确认您仍然可以访问在线精品店网站:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="7e60" class="lm kc hi jt b be ln lo l lp lq">echo -n "http://" &amp;&amp; kubectl get svc frontend-external -n ${ONLINEBOUTIQUE_NAMESPACE} -o json | jq -r '.status.loadBalancer.ingress[0].ip'</span></pre><p id="2c41" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过在您的谷歌云控制台中导航到<strong class="is hj"> Anthos &gt; Security </strong>页面，您可以看到<strong class="is hj">服务访问控制</strong>已在在线精品名称空间中启用:</p><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/bcfe78a206cbe18ce35ca6d379446e8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SEbbC7t9YbrLPF80A7OGMw.png"/></div></div></figure></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="3695" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">在Istio的入口网关后部署在线精品店</h1><p id="333f" class="pw-post-body-paragraph iq ir hi is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hb bi translated">为了遵循Istio的最佳实践，让我们保护我们在线精品店的应用程序和Istio的入口网关。</p><p id="4522" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们部署一个Istio的入口网关:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="1c08" class="lm kc hi jt b be ln lo l lp lq">INGRESS_NAMESPACE=asm-ingress<br/>kubectl create namespace ${INGRESS_NAMESPACE}<br/>kubectl label namespace ${INGRESS_NAMESPACE} istio-injection=enabled<br/>kubectl label namespace ${INGRESS_NAMESPACE} name=${INGRESS_NAMESPACE}<br/>kubectl apply -f https://github.com/GoogleCloudPlatform/anthos-service-mesh-samples/raw/main/docs/ingress-gateway-asm-manifests/base/deployment-service.yaml -n ${INGRESS_NAMESPACE}<br/>kubectl apply -f https://github.com/GoogleCloudPlatform/anthos-service-mesh-samples/raw/main/docs/ingress-gateway-asm-manifests/base/gateway.yaml -n ${INGRESS_NAMESPACE}<br/>kubectl apply -f https://github.com/GoogleCloudPlatform/anthos-service-mesh-samples/raw/main/docs/ingress-gateway-asm-manifests/with-authorization-policies/authorizationpolicy.yaml -n ${INGRESS_NAMESPACE}</span></pre><p id="6ee1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们更新在线精品部署，以便将<code class="du jq jr js jt b">frontend</code>应用程序置于入口网关之后:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="d4d3" class="lm kc hi jt b be ln lo l lp lq">helm upgrade onlineboutique oci://us-docker.pkg.dev/online-boutique-ci/charts/onlineboutique \<br/>    --install \<br/>    --create-namespace \<br/>    -n ${ONLINEBOUTIQUE_NAMESPACE} \<br/>    --set networkPolicies.create=true \<br/>    --set sidecars.create=true \<br/>    --set serviceAccounts.create=true \<br/>    --set authorizationPolicies.create=true \<br/>    --set frontend.externalService=false \<br/>    --set frontend.virtualService.create=true \<br/>    --set frontend.virtualService.gateway.name=asm-ingressgateway \<br/>    --set frontend.virtualService.gateway.namespace=${INGRESS_NAMESPACE} \<br/>    --set frontend.virtualService.gateway.labelKey=asm \<br/>    --set frontend.virtualService.gateway.labelValue=ingressgateway</span></pre><p id="56cc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">等待入口网关名称空间中的<code class="du jq jr js jt b">Pod</code>成功部署。然后，您可以点击以下URL，通过入口网关端点访问在线精品网站:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="aa84" class="lm kc hi jt b be ln lo l lp lq">echo -n "http://" &amp;&amp; kubectl get svc asm-ingressgateway -n ${INGRESS_NAMESPACE} -o json | jq -r '.status.loadBalancer.ingress[0].ip'</span></pre><p id="657c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过在Google Cloud控制台中导航到<strong class="is hj"> Anthos &gt;服务网格</strong>页面，您可以看到关联的<strong class="is hj">拓扑</strong>现在包含入口网关:</p><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lu"><img src="../Images/34537c8a03a3f8207fb7348ba66dc4d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZzoWP3v0hMckXX8Y4FBvkg.png"/></div></div></figure><p id="8b20" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并且，通过导航到Google Cloud控制台中的<strong class="is hj"> Anthos &gt; Security </strong>页面，在<strong class="is hj"> Policy Audit </strong>选项卡上，您可以看到<strong class="is hj">服务访问控制</strong>也在入口网关名称空间中启用:</p><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lv"><img src="../Images/67a7de894be9acd11eba27fdb9e857b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gwuRyICABAGjfC68XG2Lbg.png"/></div></div></figure><p id="089e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后一件事，本质上与在线精品店无关，但这是一个在服务网格中增加更多安全性的快速胜利，通过为服务网格中您的应用程序之间的通信添加<code class="du jq jr js jt b">STRICT</code>MTL:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="9b3b" class="lm kc hi jt b be ln lo l lp lq">cat &lt;&lt; EOF | kubectl apply -f -<br/>apiVersion: security.istio.io/v1beta1<br/>kind: PeerAuthentication<br/>metadata:<br/>  name: default<br/>  namespace: istio-system<br/>spec:<br/>  mtls:<br/>    mode: STRICT<br/>EOF</span></pre><p id="d23d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过在你的谷歌云控制台中导航到<strong class="is hj"> Anthos &gt;安全</strong>页面，你可以看到<strong class="is hj"> mTLS状态</strong>在你的服务网格中被启用:</p><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lw"><img src="../Images/9e4b100ac22948a330842170af972132.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UIFebiEyzFiRCbG0UId2Dw.png"/></div></div></figure></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="5009" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">通过配置同步以GitOps方式部署在线精品</h1><p id="6d7d" class="pw-post-body-paragraph iq ir hi is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hb bi translated">Config Sync是一个GitOps工具，您可以将其用于GKE集群，它允许您将GKE集群与来自Helm registry(在我们的例子中是Google Artifact Registry)的Helm chart同步。让我们来看看你是如何做到这一点的。</p><p id="8fa0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，在GKE集群上启用配置同步:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="7dcb" class="lm kc hi jt b be ln lo l lp lq">gcloud beta container fleet config-management enable<br/><br/>cat &lt;&lt;EOF &gt; acm-config.yaml<br/>applySpecVersion: 1<br/>spec:<br/>  configSync:<br/>    enabled: true<br/>EOF<br/><br/>gcloud beta container fleet config-management apply \<br/>    --membership ${CLUSTER} \<br/>    --config acm-config.yaml</span></pre><p id="c009" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">等待在您的GKE集群上成功启用配置同步(作为<code class="du jq jr js jt b">NOT_CONFIGURED</code><code class="du jq jr js jt b">Status</code>):</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="e13d" class="lm kc hi jt b be ln lo l lp lq">gcloud beta container fleet config-management status</span></pre><p id="fc7f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，部署<code class="du jq jr js jt b">RootSync</code>配置，在您的GKE集群中同步这个掌舵图:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="d71b" class="lm kc hi jt b be ln lo l lp lq">cat &lt;&lt; EOF | kubectl apply -f -<br/>apiVersion: configsync.gke.io/v1beta1<br/>kind: RootSync<br/>metadata:<br/>  name: root-sync-helm<br/>  namespace: config-management-system<br/>spec:<br/>  spec:<br/>  sourceFormat: unstructured<br/>  sourceType: helm<br/>  helm:<br/>    repo: oci://us-docker.pkg.dev/online-boutique-ci/charts<br/>    chart: onlineboutique<br/>    releaseName: onlineboutique<br/>    namespace: onlineboutique<br/>    auth: none<br/>    values:<br/>      networkPolicies:<br/>        create: true<br/>      sidecars:<br/>        create: true<br/>      serviceAccounts:<br/>        create: true<br/>      authorizationPolicies:<br/>        create: true<br/>      frontend:<br/>        externalService: false<br/>        virtualService:<br/>          create: true<br/>          gateway:<br/>            name: asm-ingressgateway<br/>            namespace: ${INGRESS_NAMESPACE}<br/>            labelKey: asm<br/>            labelValue: ingressgateway<br/>EOF</span></pre><p id="19f1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过导航到谷歌云控制台中的<strong class="is hj"> Kubernetes引擎&gt;配置&amp;策略&gt;配置</strong>页面，您可以看到通过配置同步从在线精品掌舵图同步的所有73个资源:</p><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/10c0b8f881702e1ea3dec49dac9554da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HiHISi55TkhI419XD9ZndQ.png"/></div></div></figure><p id="5c6e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是这个掌舵图部署的所有资源的列表，以及我们在这篇博客文章中使用的值:</p><pre class="le lf lg lh fd li jt lj bn lk ll bi"><span id="958c" class="lm kc hi jt b be ln lo l lp lq">AuthorizationPolicy adservice<br/>AuthorizationPolicy cartservice<br/>AuthorizationPolicy checkoutservice<br/>AuthorizationPolicy currencyservice<br/>AuthorizationPolicy deny-all<br/>AuthorizationPolicy emailservice<br/>AuthorizationPolicy frontend<br/>AuthorizationPolicy paymentservice<br/>AuthorizationPolicy productcatalogservice<br/>AuthorizationPolicy recommendationservice<br/>AuthorizationPolicy redis-cart<br/>AuthorizationPolicy shippingservice<br/>Deployment adservice<br/>Deployment cartservice<br/>Deployment checkoutservice<br/>Deployment currencyservice<br/>Deployment emailservice<br/>Deployment frontend<br/>Deployment loadgenerator<br/>Deployment paymentservice<br/>Deployment productcatalogservice<br/>Deployment recommendationservice<br/>Deployment redis-cart<br/>Deployment shippingservice<br/>NetworkPolicy adservice<br/>NetworkPolicy cartservice<br/>NetworkPolicy checkoutservice<br/>NetworkPolicy currencyservice<br/>NetworkPolicy deny-all<br/>NetworkPolicy emailservice<br/>NetworkPolicy frontend<br/>NetworkPolicy loadgenerator<br/>NetworkPolicy paymentservice<br/>NetworkPolicy productcatalogservice<br/>NetworkPolicy recommendationservice<br/>NetworkPolicy redis-cart<br/>NetworkPolicy shippingservice<br/>Service adservice<br/>Service cartservice<br/>Service checkoutservice<br/>Service currencyservice<br/>Service emailservice<br/>Service frontend<br/>Service paymentservice<br/>Service productcatalogservice<br/>Service recommendationservice<br/>Service redis-cart<br/>Service shippingservice<br/>ServiceAccount adservice<br/>ServiceAccount cartservice<br/>ServiceAccount checkoutservice<br/>ServiceAccount currencyservice<br/>ServiceAccount emailservice<br/>ServiceAccount frontend<br/>ServiceAccount loadgenerator<br/>ServiceAccount paymentservice<br/>ServiceAccount productcatalogservice<br/>ServiceAccount recommendationservice<br/>ServiceAccount redis-cart<br/>ServiceAccount shippingservice<br/>Sidecar adservice<br/>Sidecar cartservice<br/>Sidecar checkoutservice<br/>Sidecar currencyservice<br/>Sidecar emailservice<br/>Sidecar frontend<br/>Sidecar loadgenerator<br/>Sidecar paymentservice<br/>Sidecar productcatalogservice<br/>Sidecar recommendationservice<br/>Sidecar redis-cart<br/>Sidecar shippingservice<br/>VirtualService frontend</span></pre></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="926f" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">结论</h1><p id="0ef6" class="pw-post-body-paragraph iq ir hi is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hb bi translated">在线精品店的掌舵图允许部署默认的基本设置以及更高级、复杂和安全的服务网络设置。</p><p id="0247" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们刚刚看到了如何使用其细粒度的<code class="du jq jr js jt b">NetworkPolicies</code>、<code class="du jq jr js jt b">Sidecars</code>、<code class="du jq jr js jt b">ServiceAccounts</code>和<code class="du jq jr js jt b">AuthorizationPolicies</code>来部署在线精品。我们还看到了如何通过Istio入口网关展示在线精品店的<code class="du jq jr js jt b">frontend</code>应用。</p><p id="d07b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后但同样重要的是，我们也看到了如何通过配置同步以GitOps方式同步这个舵图。</p><p id="84e6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以从中获得灵感，针对自己的工作负载改进自己的安全状况。</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><h1 id="ad6b" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">更多示例</h1><p id="7b1a" class="pw-post-body-paragraph iq ir hi is b it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn hb bi translated">你也可以在下面的博客中找到利用这个掌舵图的高级场景:</p><ul class=""><li id="e117" class="ly lz hi is b it iu ix iy jb ma jf mb jj mc jn md me mf mg bi translated"><a class="ae jp" rel="noopener" href="/google-cloud/b5bd26253a4c">带Kubernetes 1.24+ </a>的gRPC健康探头</li><li id="3d5d" class="ly lz hi is b it mh ix mi jb mj jf mk jj ml jn md me mf mg bi translated"><a class="ae jp" rel="noopener" href="/google-cloud/f7248e077339">使用谷歌云扳手与网上精品样品</a></li><li id="8a4b" class="ly lz hi is b it mh ix mi jb mj jf mk jj ml jn md me mf mg bi translated"><a class="ae jp" rel="noopener" href="/google-cloud/use-google-cloud-memorystore-redis-with-the-online-boutique-sample-on-gke-82f7879a900d">使用谷歌云存储(Redis)和GKE的在线精品样品</a></li><li id="f98b" class="ly lz hi is b it mh ix mi jb mj jf mk jj ml jn md me mf mg bi translated"><a class="ae jp" rel="noopener" href="/google-cloud/use-google-cloud-memorystore-redis-with-the-online-boutique-sample-on-gke-82f7879a900d">使用谷歌云存储(Redis)和GKE的在线精品样品</a></li><li id="012e" class="ly lz hi is b it mh ix mi jb mj jf mk jj ml jn md me mf mg bi translated"><a class="ae jp" rel="noopener" href="/google-cloud/64b71969318d">无缝加密从服务网格中的任何应用到Memorystore (Redis)的流量</a></li></ul></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><p id="8301" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">原帖</em><a class="ae jp" href="https://mathieu-benoit.github.io/" rel="noopener ugc nofollow" target="_blank"><em class="jo">Mathieu-Benoit . github . io</em></a><em class="jo">。</em></p></div></div>    
</body>
</html>