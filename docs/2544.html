<html>
<head>
<title>Multi-cloud GitLab CI/CD for IaC automation on Google Kubernetes Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于Google Kubernetes引擎上IaC自动化的多云GitLab CI/CD</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/multi-cloud-gitlab-ci-cd-for-iac-automation-on-google-kubernetes-engine-f8afc7b55b2f?source=collection_archive---------1-----------------------#2022-11-23">https://medium.com/google-cloud/multi-cloud-gitlab-ci-cd-for-iac-automation-on-google-kubernetes-engine-f8afc7b55b2f?source=collection_archive---------1-----------------------#2022-11-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="abd1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">毫无疑问，Gitlab一直是VCS企业的首选。同样，它最近因其CI/CD产品而广受欢迎。无论是为GitLab选择托管服务器的灵活性，还是它多年来在DevOps领域获得的成熟性，都使它成为该领域的一个强有力的竞争对手。</p><p id="e751" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Medium上有许多文章讲述了在GKE上设置GitLab CI/CD所涉及的步骤，在本文中，我们将进一步讨论如何处理多云GitLab CI/CD自动化需求。</p><h1 id="3f84" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">设计考虑事项—多云概要设计</h1><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/7f3f13f7172781989b28b4a388226f96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HWD53dZk1fjjNWOvDZBtig.png"/></div></div></figure><p id="53be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上述架构中，GitLab VCS托管在Google Kubernetes引擎上，而负责CI/CD的GitLab runners分别托管在不同的云提供商各自的Kubernetes托管服务产品上。前任。谷歌云上的Gitlab runner托管在GKE，AWS上的另一个runner托管在EKS，而Azure上的第三个runner托管在AKS上。</p><h1 id="5781" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">建筑破冰</h1><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kn"><img src="../Images/174d2e79f7aee8742c7522cf4604cc52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r13FCURrTULGM5HQByaG9A.png"/></div></div></figure><p id="5937" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述架构显示了所涉及的多个组件块的细节，以及它们如何组合在一起以实现multi cloud GitLab CI/CD。</p><p id="9dbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主题可分为监控、GitLab Cloud原生混合架构细节、多管道设计、人工制品交换和监控、跑步者和GitLab服务器之间的多云通信。</p><h1 id="2ee8" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">VPC网络图-轴辐式</h1><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es ko"><img src="../Images/a8a1f8b4aa237e83e0b2f80c352d05b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jDtlDGEWaRu6_GLWvZzHDw.png"/></div></div></figure><p id="08e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个典型的GCP轴辐式网络架构，中转VPC是一个集线器，通过互连连接到本地，利用VPC对等与其他VPC对等。</p><p id="3cb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">VPC以共享方式运行VPCs(内部)VPCs主要托管面向内部的工作负载，非军事区VPCs主要托管服务于互联网的工作负载。</p><p id="338b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在当前的架构中，所有的VPC也受VPC服务控制(VPC-SC)的控制，其中每个共享的VPC受其自己的边界保护，以限制跨VPC-SC的API访问。</p><h1 id="b7f4" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">IaC组件的网络设计</h1><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kp"><img src="../Images/27ed93186f1ce61a6870b9c13c72c776.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FAov1825lEtpyWy45WLT1w.png"/></div></div></figure><p id="6fdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我们在上一节中看到的一般网络架构，如果我们在其中添加IaC组件，那么修改后的网络设计如下所示。根据谷歌VPC设计最佳实践和谷歌VPC服务控制最佳实践，这里引入了管理VPC。这个管理VPC是云基础架构其余部分的控制平面，由于其数据和工作负载的敏感性，这个管理VPC被放置在一个单独的边界中，以防止来自其他边界的API调用。</p><h1 id="af1a" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">使用GitLab的IaC基础设施CI管道工作流</h1><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kq"><img src="../Images/b43c9cff265f56fd4b73c64ee1e7c567.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0zSfgsZHNSe9JzkU536GUw.png"/></div></div></figure><ol class=""><li id="2d9e" class="kr ks hi ih b ii ij im in iq kt iu ku iy kv jc kw kx ky kz bi translated">一名开发人员更新了<strong class="ih hj"> Terraform代码</strong>，向GitLab提交代码，并创建了一个<strong class="ih hj">合并请求</strong>来部署基础设施资源。</li><li id="9721" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">GitLab runner executor对CI职位进行投票。</li><li id="cc33" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">运行程序选择一个作业，并提取为管道配置的容器映像。</li><li id="290f" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">使用容器映像，运行人员使用CI管道中配置的服务帐户将Kubernetes Pod旋转到作业。</li><li id="4ac3" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">管道从云存储中获取tfstate文件。</li><li id="d4b0" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">通过具有<strong class="ih hj">工作负载标识</strong>的Google云服务账户执行Terraform计划。</li></ol><h1 id="c63a" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">使用GitLab的IaC基础设施CD管道工作流程</h1><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es lf"><img src="../Images/7d2f4922e37b093b51f0e41b84f60c53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CFAPGTnezuVFobzL91rl6g.png"/></div></div></figure><ol class=""><li id="609e" class="kr ks hi ih b ii ij im in iq kt iu ku iy kv jc kw kx ky kz bi translated"><strong class="ih hj">审阅者和批准者</strong>允许合并请求，这将触发CD作业。</li><li id="15d3" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">GitLab runner executor轮询CD作业。</li><li id="552e" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">运行程序选择一个作业，并提取为管道配置的容器映像。</li><li id="0ec4" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">使用容器映像，运行人员使用CD管道中配置的服务帐户将Kubernetes Pod旋转到作业。</li><li id="7253" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">管道从云存储中获取tfstate文件，并执行Terraform计划。</li><li id="92a5" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">通过带有<strong class="ih hj">工作量标识</strong>的Google云服务账户管理工作量项目基础设施资源。</li></ol><h1 id="7e11" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="4d7c" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">随着企业在其已经托管的云DC中逐渐成熟，作为科技巨头的下一步，多重云最近受到了极大的欢迎。无论是他们的高可用性和灾难恢复目标是实现多云，还是他们的客户要求在特定的云提供商上提供SaaS解决方案，企业和科技巨头都在努力实现多云。</p><p id="2caa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我介绍了一个这样的用例，企业可以在Google Kubernetes引擎上利用多云GitLab CI/CD，并有效地满足他们的基础设施自动化目标。</p></div></div>    
</body>
</html>