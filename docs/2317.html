<html>
<head>
<title>Running Eclipse HONO and Ditto on Google Cloud (5)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在谷歌云上运行Eclipse HONO和Ditto)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/running-eclipse-hono-and-ditto-on-google-cloud-5-8c4ad80a8c6e?source=collection_archive---------6-----------------------#2022-08-20">https://medium.com/google-cloud/running-eclipse-hono-and-ditto-on-google-cloud-5-8c4ad80a8c6e?source=collection_archive---------6-----------------------#2022-08-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="ca94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在撰写本文时，Eclipse Ditto为HTTP推送连接提供了几个<a class="ae jd" href="https://www.eclipse.org/ditto/connectivity-protocol-bindings-http.html" rel="noopener ugc nofollow" target="_blank">认证机制</a>。</p><ul class=""><li id="4a20" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated"><a class="ae jd" href="https://www.eclipse.org/ditto/connectivity-protocol-bindings-http.html#client-certificate-authentication" rel="noopener ugc nofollow" target="_blank">客户端证书认证</a></li><li id="2c28" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" href="https://www.eclipse.org/ditto/connectivity-protocol-bindings-http.html#hmac-request-signing" rel="noopener ugc nofollow" target="_blank"> HMAC请求签约</a></li><li id="711c" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" href="https://www.eclipse.org/ditto/connectivity-protocol-bindings-http.html#oauth2-client-credentials-flow" rel="noopener ugc nofollow" target="_blank"> OAuth 2客户端凭证授予</a></li></ul><p id="cb3f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">遗憾的是，在撰写本文时，Google Cloud不支持上述认证机制。为了保护云功能，有几种选择。</p><ul class=""><li id="9389" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">通过网络隔离保护云功能。</li><li id="ba44" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">通过支持上述认证机制的其他服务来保护云功能。</li><li id="8ff8" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">通过自定义代码保护云功能。</li><li id="2061" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">结合上述不同的选择。</li></ul><p id="3743" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过自定义代码和另一个支持OAuth或HMAC签名的服务来保护云功能，这里暂时不讨论。我将设置一个网络隔离，以便云功能只接受来自同一个VPC网络的连接。</p><h1 id="0d7b" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">通过网络隔离保护云功能</h1><p id="5773" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">VPC中的云资源可以通过私有服务连接从VPC调用云功能。为此，您需要创建一个私有服务连接器，并将云功能配置为使用该连接器。下图所示的高级架构图。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/d49461ac0ed08c99ea8376a4dc217687.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zOShtEm7CWSp3OXEyoYUXw.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">高级专用服务连接架构</figcaption></figure><ul class=""><li id="ba10" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">创建专用服务连接器</li></ul><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="95b7" class="lq jt hi lm b fi lr ls l lt lu">export VPC_SUBNET_NAME=&lt;YOUR VPC SUBNET NAME&gt;</span><span id="19d2" class="lq jt hi lm b fi lv ls l lt lu">gcloud services enable vpcaccess.googleapis.com<br/>gcloud compute networks vpc-access connectors create my-psc-connector \<br/>--region asia-east1 \<br/>--subnet $VPC_SUBNET_NAME</span></pre><ul class=""><li id="a785" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">按照本说明<a class="ae jd" href="https://cloud.google.com/vpc/docs/configure-serverless-vpc-access#functions" rel="noopener ugc nofollow" target="_blank">更新云功能以使用私有服务连接器。</a></li></ul><p id="5cab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置完成后，您的云功能只接受来自同一VPC或同一VPC服务控制范围内的请求。你可以通过在VPC外运行curl来验证这一点。</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="af6d" class="lq jt hi lm b fi lr ls l lt lu">curl -m 70 -X POST https://$YOUR_FUNCTION_URL \<br/>-H "Authorization:bearer $(gcloud auth print-identity-token)" \<br/>-H "Content-Type:application/json" \<br/>-d '{}'</span></pre><p id="573f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该会得到一个HTTP 403错误。</p><p id="a0e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们验证您的Eclipse集群是否能够将遥测数据转发给云功能。</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="3d63" class="lq jt hi lm b fi lr ls l lt lu">curl -X POST -i -u ${DEVICE_ID}-auth@${TENANT_NAME}:my-password \<br/>-H ‘Content-Type: application/json’ \<br/>-d ‘{“hum”: 12.17}’ <a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/${HTTP_ADAPTER_IP}:${HTTP_ADAPTER_PORT_http}/telemetry">http://${HTTP_ADAPTER_IP}:${HTTP_ADAPTER_PORT_http}/telemetry</a></span></pre><p id="f668" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该在云日志中看到一个日志条目。</p><p id="87e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/running-eclipse-hono-and-ditto-on-google-cloud-6-a715c59a5d05">第六部分</a></p></div></div>    
</body>
</html>