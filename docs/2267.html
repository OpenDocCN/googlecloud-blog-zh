<html>
<head>
<title>SFTPGo access to GCS via SFTP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SFTPGo通过SFTP访问GCS</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/sftpgo-access-to-gcs-via-sftp-e203e0783f6f?source=collection_archive---------0-----------------------#2022-07-16">https://medium.com/google-cloud/sftpgo-access-to-gcs-via-sftp-e203e0783f6f?source=collection_archive---------0-----------------------#2022-07-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/050f6005fa13613506ccec5a93cf2358.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tee2GKvYQGq2zzfwUqcSkA.png"/></div></div></figure><p id="c04d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://github.com/drakkan/sftpgo" rel="noopener ugc nofollow" target="_blank"> SFTPGo </a>是一个<a class="ae jo" href="https://en.wikipedia.org/wiki/SSH_File_Transfer_Protocol" rel="noopener ugc nofollow" target="_blank"> SFTP </a>服务器，作为一个开源项目发布，具有访问谷歌云存储(GCS)的内置能力。我们可以使用SFTPGo作为通过SFTP访问GCS的机制。本文将带我们了解一个让它工作的方法，并增加一些使用时的额外考虑。</p><p id="7fd8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从整体架构的角度来看，SFTPGo可以安装在Google云计算引擎上。安装后，它运行并维护自己的有状态本地配置。然后，基于浏览器/web的管理控制台可用于进一步的详细配置。然后，我们将创建SFTPGo已知的用户身份。这些用户身份中的每一个都有关联的名称和密码。定义用户时，我们还命名了一个GCP存储桶，它将被用作用户通过SFTP客户端看到的存储。为了访问bucket，我们还将提供一些服务帐户凭证，SFTPGo将使用这些凭证代表用户与bucket进行交互。这种配置非常灵活，因为它允许按用户存储桶访问和服务帐户配置，这意味着不同的用户可以对不同的存储桶进行不同的访问。配置完成后，用户就可以连接SFTP客户端(或者可选的web界面)来浏览、上传和获取存储在云存储中的文件。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jp"><img src="../Images/660a3687ad967f49223c4ce0c5fd0b4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5C6OfsMU6fNWBFNE"/></div></div></figure><p id="8ec3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这个故事中，我们将从这样一个想法开始:我们将创建一个托管在具有公共IP地址的计算引擎上的SFTP服务器。然后，我们将允许客户端访问这个SFTP服务器，他们上传和下载的文件将被映射到GCS桶。</p><p id="8af5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将从一个新创建的运行Debian的计算引擎开始。启动后，我使用SSH登录。</p><p id="3240" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们按照步骤使用apt安装它。这些都记录在<a class="ae jo" href="https://github.com/drakkan/sftpgo/blob/main/docs/repo.md" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="0f5c" class="jz ka hi jv b fi kb kc l kd ke">curl -sS <a class="ae jo" href="https://ftp.osuosl.org/pub/sftpgo/apt/gpg.key" rel="noopener ugc nofollow" target="_blank">https://ftp.osuosl.org/pub/sftpgo/apt/gpg.key</a> | sudo gpg --dearmor -o /usr/share/keyrings/sftpgo-archive-keyring.gpg<br/>CODENAME=`lsb_release -c -s`<br/>echo "deb [signed-by=/usr/share/keyrings/sftpgo-archive-keyring.gpg] <a class="ae jo" href="https://ftp.osuosl.org/pub/sftpgo/apt" rel="noopener ugc nofollow" target="_blank">https://ftp.osuosl.org/pub/sftpgo/apt</a> ${CODENAME} main" | sudo tee /etc/apt/sources.list.d/sftpgo.list<br/>sudo apt update<br/>sudo apt install sftpgo</span></pre><p id="0eed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">安装完成后，<code class="du kf kg kh jv b">sftpgo </code>将启动并运行。</p><p id="3572" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，创建一个防火墙规则，允许传入流量通过端口8080和2022进入您的VPC。</p><p id="258c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">打开浏览器进入<code class="du kf kg kh jv b"><a class="ae jo" href="http://[COMPUTE_ENGINE_IP]:8080" rel="noopener ugc nofollow" target="_blank">http://[COMPUTE_ENGINE_IP]:8080</a></code></p><p id="14b2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您将看到一个面板，提示您输入要创建的SFTPGo管理员用户id。选择安全的密码。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ki"><img src="../Images/a41aa70e3f310f7dd3c775684c8abb9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iGJr1rsZW0E_SnMZ"/></div></div></figure><p id="85a7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您现在将看到SFTPGo管理屏幕。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kj"><img src="../Images/2b1243009393b2a21707743693a80781.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XJdukS3JeMj8aJxF"/></div></div></figure><p id="e014" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在是时候创建用户了。这些用户将被授权登录SFTP服务器。然而，在我们创建用户之前，我们需要为GCS访问做准备。SFTPGo的默认功能是作为一个SFTP服务器，使用本地文件系统作为数据存储。在我们的故事中，我们希望使用GCS作为商店。要与GCS交互，我们需要提供Google Cloud身份验证证明，证明我们是已知的身份。为此，我们创建一个服务帐户，并检索该帐户的JSON凭证。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kk"><img src="../Images/5e21316508ba6f9c485a986398ee0e96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0DPs5_h88C0NTUFy"/></div></div></figure><p id="262f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击<code class="du kf kg kh jv b">DONE</code>，因为我们不需要设置任何其他属性。</p><p id="0eb2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们想要创建一个JSON键</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kl"><img src="../Images/e20ddce918d3bd4b608e17e50686cc1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Dv65WzzLnZp-D2n9"/></div></div></figure><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es km"><img src="../Images/c1416a160f023ad58de88d9d15a5c535.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*loPwItvFW3kJG67M"/></div></div></figure><p id="ff7a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将被下载到您的计算机上。我建议将其重命名，以匹配服务帐户的名称，这是关键。</p><p id="2d2f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建了服务帐户后，我们需要授予它访问bucket的权限。至少，<code class="du kf kg kh jv b">Storage Object Viewer</code>角色将允许该帐户获取文件，<code class="du kf kg kh jv b">Storage Object Creator</code>将允许用户创建文件，而<code class="du kf kg kh jv b">Storage Object Admin</code>将额外允许一切，包括删除现有文件。</p><p id="186c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">剩下的工作就是定义允许访问SFTP服务器的用户。当SFTP客户端试图连接到SFTP服务器时，它必须进行身份验证。它可以使用用户id/密码对，或者提供SSH凭证。我们可以定义SFTPGo将通过管理网页识别的用户。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ki"><img src="../Images/6d8e151ebcb258e251e3d6348d256502.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DuIZPjKaiQm-RUe-"/></div></div></figure><p id="cb14" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们首先在选择面板中单击用户。在那里，显示“查看和管理用户”屏幕。如果我们点击“+”，我们将定义我们的用户:</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kn"><img src="../Images/676c824e88229912bb857b52086f8348.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pTF2gkL5qhCgLc9M"/></div></div></figure><p id="b113" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个面板上发生了很多事情，让我们来分解一下。首先，我们提供用户名和密码。这种组合将允许SFTP客户端(或web客户端)访问SFTPGo。这些用户名和密码与谷歌账户等其他身份来源没有任何关系。只有SFTPGo使用这些身份。</p><p id="a012" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下一个重要的项目是文件系统条目。当用户连接到SFTPGo时，正是这个定义定义了向用户呈现什么文件系统。默认为“本地”,这意味着显示的是计算引擎的本地Linux文件系统。在我们的故事中，我们将其更改为Google云存储，因为我们想要访问GCS存储桶。当我们选择Storage = Google Cloud Storage条目时，其他属性会发生变化，以反映特定于Google Cloud的条目。我们必须提供另外两种设置。第一个是我们正在处理的GCS bucket的名称。第二个是我们之前导出的GCP服务帐户凭据JSON文件。SFTPGo上传并存储这个凭证文件。</p><p id="64b7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">仅此而已。现在，当我们连接SFTP客户端时，系统会提示我们输入用户名和密码，我们可以输入我们创建的信息。然后，我们将能够执行SFTP命令，如“ls”来列出文件，“put”来上传文件，以及“get”来获取文件。将使用凭据文件引用的服务帐户来访问GCS。GCS还将只允许与服务帐户相关联的IAM角色所允许的操作。例如，如果帐户只有存储对象查看器，则不能创建新文件，而如果只有存储对象创建器，则不能检索现有文件。</p><p id="e308" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当我们创建SFTPGo用户时，我们可能不希望不断地指定GCP凭证和bucket细节(但是我们可以这样做)。相反，我们可以在SFTPGo组的规范中定义我们的文件系统细节，并将我们创建的用户与这些组相关联。在下文中，我们展示了我们称之为“读组”的新组的定义</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/6bb472d29b1f8e04ffba81bd404f0b55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fjWzKQjujVaEKgjt"/></div></div></figure><p id="0c45" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，当我们创建一个用户时，我们可以引用这个组并放弃用户页面上的特定文件系统定义。组的文件系统定义优先于用户特定的文件系统定义。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/25bca60cff643deb19ad1479481a9c92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5i8esEk-4471Y8RE"/></div></div></figure><p id="6c94" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们不仅可以使用SFTP客户端连接到SFTPGo，还可以选择使用其内置的特定于客户端的Web UI。如果我们使用浏览器访问端口8080的计算引擎，系统会提示我们以SFTPGo用户身份登录。从那里我们看到了:</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kp"><img src="../Images/541920588ceadb7fcfccac472aaabfd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IlhfsHRD5fu6lVKk"/></div></div></figure><p id="f1b7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请花点时间看看这个屏幕。它的核心是一个文件系统视图，显示文件、它们的大小以及它们上次修改的时间。这些文件是我们从SFTP客户那里看到的GCS文件。从这里我们可以执行一些重要的操作，包括下载文件，上传文件，删除文件等等。我想指出的一个特性是编辑功能。如果我们单击与文件相关联的编辑图标，我们会立即在基于浏览器的编辑器中看到该文件的内容。我们不仅可以看到内容，还可以更改内容，并将其写回以替换原始文件。实际上，我们有一个GCS文件编辑器！</p><p id="1843" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">关于SFTPGo还有很多可以说的，我会把你引向GitHub项目主页以获得更多的细节。由于这是一个开源项目，您可以免费下载和使用它。另一方面是没有正式的支持。如果您发现了问题，您可以提出问题，但是没有解决问题的SLA。因为源代码也是存在的，所以你有能力自己修复它，但是我们知道，说起来容易做起来难。</p><p id="6112" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">除了SFTPGo，还有各种其他的SFTP解决方案和文件浏览器用于GCS。</p><h1 id="496f" class="kq ka hi bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">录像</h1><p id="bc5f" class="pw-post-body-paragraph iq ir hi is b it ln iv iw ix lo iz ja jb lp jd je jf lq jh ji jj lr jl jm jn hb bi translated">这里有一个简短的视频，演示了本文的许多概念:</p><figure class="jq jr js jt fd ij"><div class="bz dy l di"><div class="ls lt l"/></div></figure><h1 id="57b9" class="kq ka hi bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">排除故障</h1><p id="585d" class="pw-post-body-paragraph iq ir hi is b it ln iv iw ix lo iz ja jb lp jd je jf lq jh ji jj lr jl jm jn hb bi translated">如果您需要执行一些调试，SFTPGo会将SFTPGo日志记录写入本地<code class="du kf kg kh jv b">/var/log/syslog</code>文件。</p><h1 id="6cef" class="kq ka hi bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">另请参见:</h1><ul class=""><li id="481b" class="lu lv hi is b it ln ix lo jb lw jf lx jj ly jn lz ma mb mc bi translated"><a class="ae jo" href="https://github.com/drakkan/sftpgo" rel="noopener ugc nofollow" target="_blank"> GitHub — drakkan/sftpgo:功能全面且高度可配置的SFTP服务器，支持可选的HTTP/S、FTP/S和WebDAV—S3、谷歌云存储、Azure Blob </a></li><li id="ce7a" class="lu lv hi is b it md ix me jb mf jf mg jj mh jn lz ma mb mc bi translated"><a class="ae jo" href="https://www.howtoforge.com/how-to-install-sftpgo-on-ubuntu-22-04/" rel="noopener ugc nofollow" target="_blank">如何在Ubuntu 22.04上安装SFTPGo</a></li><li id="2cf5" class="lu lv hi is b it md ix me jb mf jf mg jj mh jn lz ma mb mc bi translated"><a class="ae jo" href="https://console.cloud.google.com/marketplace/product/filemage-public/filemage-gateway-linux" rel="noopener ugc nofollow" target="_blank">文件图像SFTP/FTP网关</a></li><li id="fb64" class="lu lv hi is b it md ix me jb mf jf mg jj mh jn lz ma mb mc bi translated"><a class="ae jo" href="https://console.cloud.google.com/marketplace/details/trillo-vm-prod/trillo-platform-vm" rel="noopener ugc nofollow" target="_blank"> Trillo —云存储的文件管理器和SFTP</a></li><li id="14ec" class="lu lv hi is b it md ix me jb mf jf mg jj mh jn lz ma mb mc bi translated"><a class="ae jo" href="https://couchdrop.io/" rel="noopener ugc nofollow" target="_blank"> Couchdrop </a></li></ul></div></div>    
</body>
</html>