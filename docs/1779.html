<html>
<head>
<title>Call a Workflow from a Function!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从函数中调用工作流！</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/call-a-workflow-from-a-function-51fc7fc8e1ff?source=collection_archive---------1-----------------------#2021-01-28">https://medium.com/google-cloud/call-a-workflow-from-a-function-51fc7fc8e1ff?source=collection_archive---------1-----------------------#2021-01-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/31984f6fc53eb69027c3fc4db7ee8121.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*z4PTP6s0_S6cGvfLTDMmxg.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated">工作流+功能</figcaption></figure><p id="ea17" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云工作流允许您编排和自动化Google云和基于HTTP的API服务。</p><p id="37c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可能会问，如何将这些工作流与您现有的云功能相集成？—很好的问题。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><p id="d7e5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章中，你将学习如何从云函数中调用工作流！🚀</p><h1 id="26cb" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">部署云工作流</h1><p id="a17f" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">首先，您的项目中需要一个工作流(如果您还没有的话)。用以下内容创建一个名为<code class="du ky kz la lb b">myFirstWorkflow.yaml</code>的新文件:</p><figure class="lc ld le lf fd ij"><div class="bz dy l di"><div class="lg lh l"/></div><figcaption class="im in et er es io ip bd b be z dx translated">myFirstWorkflow.yaml</figcaption></figure><p id="1ebc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">阅读上面的YAML，工作流执行以下操作:</p><ol class=""><li id="77f2" class="li lj hi is b it iu ix iy jb lk jf ll jj lm jn ln lo lp lq bi translated">从公共云功能获取当前日期/时间。</li><li id="5ae7" class="li lj hi is b it lr ix ls jb lt jf lu jj lv jn ln lo lp lq bi translated">用查询参数<code class="du ky kz la lb b">dayOfTheWeek</code>调用Wikipedia (opensearch) API。</li><li id="72ea" class="li lj hi is b it lr ix ls jb lt jf lu jj lv jn ln lo lp lq bi translated">从维基百科返回最热门的结果。</li></ol><p id="b415" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们用<code class="du ky kz la lb b">gcloud</code>部署工作流:</p><pre class="lc ld le lf fd lw lb lx ly aw lz bi"><span id="ff00" class="ma jw hi lb b fi mb mc l md me">gcloud workflows deploy myFirstWorkflow \<br/>--source=myFirstWorkflow.yaml</span></pre><p id="dcbe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您愿意，可以通过以下方式测试工作流程:</p><pre class="lc ld le lf fd lw lb lx ly aw lz bi"><span id="b8f2" class="ma jw hi lb b fi mb mc l md me">gcloud workflows run myFirstWorkflow</span></pre><p id="2d54" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用该命令，您将执行工作流并等待结果。<br/>响应将包括如下详细信息:</p><pre class="lc ld le lf fd lw lb lx ly aw lz bi"><span id="3d1d" class="ma jw hi lb b fi mb mc l md me">result: '["Tuesday","Tuesday Weld","Tuesday Night Music Club","Tuesday (ILoveMakonnen<br/>  song)","Tuesday Group","Tuesdays with Morrie","Tuesday Knight","Tuesday (Burak Yeter<br/>  song)","Tuesday Morning Quarterback","Tuesday Vargas"]'<br/><br/>state: SUCCEEDED</span></pre><p id="20aa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不错！✔️</p><h1 id="7b3b" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">创建云函数</h1><p id="8cdd" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">所以现在我们不从<code class="du ky kz la lb b">gcloud</code>运行工作流，而是从云函数调用工作流。您可以想象这对于创建发票或运行图像处理管道非常有用。</p><p id="8ba5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云函数使得调用工作流变得相当容易，因为我们不需要编写任何授权代码。让我们使用函数框架创建一个轻量级节点函数。</p><h2 id="b05a" class="ma jw hi bd jx mf mg mh kb mi mj mk kf jb ml mm kj jf mn mo kn jj mp mq kr mr bi translated">创建一个<code class="du ky kz la lb b">package.json</code>文件:</h2><figure class="lc ld le lf fd ij"><div class="bz dy l di"><div class="lg lh l"/></div><figcaption class="im in et er es io ip bd b be z dx translated">package.json</figcaption></figure><p id="826f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个文件描述了我们的节点程序，它使用了<a class="ae ms" href="https://github.com/GoogleCloudPlatform/functions-framework-nodejs" rel="noopener ugc nofollow" target="_blank">功能框架</a>和<a class="ae ms" href="https://github.com/googleapis/nodejs-workflows" rel="noopener ugc nofollow" target="_blank">云工作流API客户端库</a>。</p><h2 id="8a79" class="ma jw hi bd jx mf mg mh kb mi mj mk kf jb ml mm kj jf mn mo kn jj mp mq kr mr bi translated">创建一个<code class="du ky kz la lb b">index.js</code>文件:</h2><p id="da43" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">对于您的函数，创建以下<code class="du ky kz la lb b">index.js</code>文件:</p><figure class="lc ld le lf fd ij"><div class="bz dy l di"><div class="lg lh l"/></div><figcaption class="im in et er es io ip bd b be z dx translated">索引. js</figcaption></figure><p id="2453" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是代码的简要说明:</p><ul class=""><li id="69b1" class="li lj hi is b it iu ix iy jb lk jf ll jj lm jn mt lo lp lq bi translated"><code class="du ky kz la lb b">exports.runWorkflow</code>是你的云函数，传递给你的Express <code class="du ky kz la lb b">(req, res)</code>参数。我们接受POST请求，调用<code class="du ky kz la lb b">callWorkflowsAPI</code>函数并返回结果。</li><li id="965f" class="li lj hi is b it lr ix ls jb lt jf lu jj lv jn mt lo lp lq bi translated">有一个云工作流API客户端的小设置</li><li id="bf23" class="li lj hi is b it lr ix ls jb lt jf lu jj lv jn mt lo lp lq bi translated"><code class="du ky kz la lb b">callWorkflowsAPI</code>函数创建我们工作流的执行，然后使用指数补偿等待工作流完成执行。</li><li id="80f9" class="li lj hi is b it lr ix ls jb lt jf lu jj lv jn mt lo lp lq bi translated">如果得到响应，我们立即返回，否则我们将超时并返回<code class="du ky kz la lb b">{ "success": false }</code>。</li></ul><p id="6c22" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您愿意，可以删除日志记录和指数补偿部分，以使代码更短。</p><blockquote class="mu mv mw"><p id="014d" class="iq ir mx is b it iu iv iw ix iy iz ja my jc jd je mz jg jh ji na jk jl jm jn hb bi translated">要在本地主机上测试，运行<code class="du ky kz la lb b">npm i</code>和<code class="du ky kz la lb b">npm start</code>。你可以用一个类似<code class="du ky kz la lb b">curl -XPOST localhost:8080</code>的命令来测试这个功能。<br/>您可能需要使用<code class="du ky kz la lb b">gcloud auth application-default</code>登录。</p></blockquote><h1 id="509f" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">部署到云功能</h1><p id="1abb" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">运行以下命令将函数部署到云函数:</p><figure class="lc ld le lf fd ij"><div class="bz dy l di"><div class="lg lh l"/></div><figcaption class="im in et er es io ip bd b be z dx translated">部署并测试我们的功能</figcaption></figure><p id="5a75" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们已经将这个云功能设为私有，但是我们可以通过使用来自<code class="du ky kz la lb b">gcloud</code>的认证令牌来测试这个云功能。工作流结果将出现在HTTP响应中。</p><pre class="lc ld le lf fd lw lb lx ly aw lz bi"><span id="bba9" class="ma jw hi lb b fi mb mc l md me">Result: ["Wednesday","Wednesday Night Wars","Wednesday 13","Wednesday Campanella","Wednesday Addams","Wednesday Night Hockey (American TV program)","Wednesdayite","Wednesday Campanella discography","Wednesday Morning, 3 A.M.","Wednesday Theatre"]</span></pre><p id="78c3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果有问题，我们还可以查看函数的Stackdriver日志。</p><h1 id="23e5" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">感谢阅读</h1><p id="afdb" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">现在，您已经有了一个与云功能相关联的工作流，或许可以使用Cloud Scheduler为您的功能添加一个计划。你的思维是极限！</p><p id="167d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您喜欢这篇文章，我推荐您观看YouTube上关于云工作流的视频:</p><figure class="lc ld le lf fd ij"><div class="bz dy l di"><div class="nb lh l"/></div><figcaption class="im in et er es io ip bd b be z dx translated">介绍Google云工作流</figcaption></figure><p id="7b14" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并在GitHub上查看我们所有的几十个工作流示例:</p><p id="1935" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae ms" href="https://github.com/GoogleCloudPlatform/workflows-samples" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/workflows-samples</a></p></div></div>    
</body>
</html>