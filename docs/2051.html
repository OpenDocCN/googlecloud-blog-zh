<html>
<head>
<title>Deploy to Cloud Run from Cloud Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">部署到云从云部署运行</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/deploy-to-cloud-run-from-cloud-deploy-4f83628cf045?source=collection_archive---------0-----------------------#2022-01-12">https://medium.com/google-cloud/deploy-to-cloud-run-from-cloud-deploy-4f83628cf045?source=collection_archive---------0-----------------------#2022-01-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7817" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">2022–09–15更新:</strong> Cloud Deploy现在支持原生云运行(<a class="ae jd" href="https://cloud.google.com/deploy/docs/deploy-app-run" rel="noopener ugc nofollow" target="_blank">链接</a>)。我改编了这篇博文来反映这一点。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/190ff5a935af20453334907e3bcde2d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*pX-XiZB08VQpHKbaQNFWCQ.png"/></div></figure><p id="95e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/deploy" rel="noopener ugc nofollow" target="_blank"> Google Cloud Deploy </a>，是谷歌全新的全托管连续交付服务，便于扩展。它允许您在YAML定义您的连续交付管道，并在GCP运行它们。对于这篇博文，如果你对Skaffold、Cloud Run和Helm有一些基本的了解，可能会有所帮助。你可以在我的例子<a class="ae jd" href="https://github.com/cgrotz/blog-examples/tree/main/cloud-delpoy-to-cloud-run" rel="noopener ugc nofollow" target="_blank">回购</a>中找到片段。</p><p id="ec92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cloud Deploy允许您创建和操作部署管道，而无需托管基础架构并将应用程序版本部署到Google Kubernetes Engine (GKE)和Cloud Run。Cloud Deploy在幕后使用<a class="ae jd" href="https://skaffold.dev/" rel="noopener ugc nofollow" target="_blank"> Skaffold </a>来管理部署。Skaffold是一个很棒的工具，它允许你明确地声明你的持续开发周期，专注于开发而不是把事情粘在一起。</p><h2 id="a13f" class="jm jn hi bd jo jp jq jr js jt ju jv jw iq jx jy jz iu ka kb kc iy kd ke kf kg bi translated">设置</h2><p id="44d8" class="pw-post-body-paragraph if ig hi ih b ii kh ik il im ki io ip iq kj is it iu kk iw ix iy kl ja jb jc hb bi translated">你需要在你运行的机器上安装Skaffold，Helm和Docker。你还需要一个Docker注册表，我推荐<a class="ae jd" href="https://cloud.google.com/artifact-registry" rel="noopener ugc nofollow" target="_blank">工件注册表</a>。</p><p id="9767" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">建议不要使用默认的计算服务帐户运行您的应用程序，因此让我们为云运行服务创建一个服务帐户，它不需要任何额外的权限。</p><pre class="jf jg jh ji fd km kn ko kp aw kq bi"><span id="5096" class="jm jn hi kn b fi kr ks l kt ku">gcloud iam service-accounts create runner --project $GOOGLE_CLOUD_PROJECT</span></pre><p id="ce13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们创建一个服务帐户来运行Cloud Deploy，并赋予它适当的权限。</p><pre class="jf jg jh ji fd km kn ko kp aw kq bi"><span id="c847" class="jm jn hi kn b fi kr ks l kt ku">gcloud iam service-accounts create deployer --project $GOOGLE_CLOUD_PROJECT</span><span id="34a5" class="jm jn hi kn b fi kv ks l kt ku"># Allow the deployer SA to run Cloud Deploy jobs<br/>gcloud projects add-iam-policy-binding $<!-- -->GOOGLE_CLOUD_PROJECT<!-- --> \<br/>    --member=serviceAccount:deployer@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com \<br/>    --role="roles/clouddeploy.jobRunner"</span><span id="6185" class="jm jn hi kn b fi kv ks l kt ku"># Allow the deployer SA to create Cloud Run services<br/>gcloud projects add-iam-policy-binding $<!-- -->GOOGLE_CLOUD_PROJECT<!-- --> \<br/>    --member=serviceAccount:deployer@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com \<br/>    --role="roles/run.developer"</span><span id="f370" class="jm jn hi kn b fi kv ks l kt ku"># Allow the deployer service account to impersonate the Runner SA<br/>gcloud iam service-accounts add-iam-policy-binding runner@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com \<br/>--role roles/iam.serviceAccountUser \<br/>--member "serviceAccount:deployer@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com" \<br/>--project $GOOGLE_CLOUD_PROJECT</span></pre><p id="8002" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经准备好设置部署管道了。我在我的示例回购中准备了一切，供您检查:</p><div class="kw kx ez fb ky kz"><a href="https://github.com/cgrotz/blog-examples/tree/main/cloud-deploy-to-cloud-run" rel="noopener  ugc nofollow" target="_blank"><div class="la ab dw"><div class="lb ab lc cl cj ld"><h2 class="bd hj fi z dy le ea eb lf ed ef hh bi translated">blog-examples/cloud-deploy-to-cloud-run at main cgrotz/blog-examples</h2><div class="lg l"><h3 class="bd b fi z dy le ea eb lf ed ef dx translated">我的博客中提到的小例子。通过在…上创建帐户，为cgrotz/blog-examples开发做出贡献</h3></div><div class="lh l"><p class="bd b fp z dy le ea eb lf ed ef dx translated">github.com</p></div></div><div class="li l"><div class="lj l lk ll lm li ln jk kz"/></div></div></a></div><p id="5e8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想在守则中指出几件事。首先你应该检查一下<code class="du lo lp lq kn b">clouddeploy.yaml</code>中的变量，并为<code class="du lo lp lq kn b">PROJECT_ID</code>、<code class="du lo lp lq kn b">REGION</code>和<code class="du lo lp lq kn b">DEPLOYER_SA_EMAIL</code>设置正确的值。在<code class="du lo lp lq kn b">run-dev.yaml</code>中，将<code class="du lo lp lq kn b">service_account</code>替换为我们为运行云运行服务而创建的服务帐户的名称。</p><h2 id="7df8" class="jm jn hi bd jo jp jq jr js jt ju jv jw iq jx jy jz iu ka kb kc iy kd ke kf kg bi translated">让我们进行云部署</h2><p id="2ac2" class="pw-post-body-paragraph if ig hi ih b ii kh ik il im ki io ip iq kj is it iu kk iw ix iy kl ja jb jc hb bi translated">为了构建示例应用程序，只需调用Skaffold build。它将构建Docker映像并将其推送到远程存储库。您需要捕获图像的标签，我们将在下一步中需要它。</p><pre class="jf jg jh ji fd km kn ko kp aw kq bi"><span id="d699" class="jm jn hi kn b fi kr ks l kt ku">skaffold build --default-repo &lt;your repo base path&gt;</span></pre><p id="6301" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们应用管道，这将在Cloud Deploy中配置管道，之后您将能够在web ui中看到它。</p><pre class="jf jg jh ji fd km kn ko kp aw kq bi"><span id="30ed" class="jm jn hi kn b fi kr ks l kt ku">gcloud beta deploy apply --file=clouddeploy.yaml \<br/>                         --region=<!-- -->$REGION \<br/>                         --project=<!-- -->$GOOGLE_CLOUD_PROJECT</span></pre><p id="23b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了创建一个版本，您将需要来自前面构建步骤的Docker映像信息。创建发行版只需要这个简单的命令:</p><pre class="jf jg jh ji fd km kn ko kp aw kq bi"><span id="1c01" class="jm jn hi kn b fi kr ks l kt ku">gcloud beta deploy releases create test-release-001 \<br/>  --project=$<!-- -->GOOGLE_CLOUD_PROJECT<!-- --> \<br/>  --region=$REGION \<br/>  --delivery-pipeline=<!-- -->example-app <!-- -->\<br/>  --images=app=&lt;repo&gt;:&lt;tag_to_deploy&gt;</span></pre><p id="4705" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来你需要推广这个版本，你也可以通过<a class="ae jd" href="https://console.cloud.google.com/deploy/delivery-pipelines?_ga=2.222358235.1547780063.1641801270-1776040249.1639939346" rel="noopener ugc nofollow" target="_blank"> web ui </a>来做，但是你可以通过命令行来做:</p><pre class="jf jg jh ji fd km kn ko kp aw kq bi"><span id="afc8" class="jm jn hi kn b fi kr ks l kt ku">gcloud beta deploy releases promote --release=test-release-001 \<br/>  --to-target=qsdev \<br/>  --delivery-pipeline=<!-- -->example-app \<br/>  <!-- -->--project=$<!-- -->GOOGLE_CLOUD_PROJECT<!-- --> \<br/>  --region=$REGION</span></pre><p id="bea4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将触发部署，一段时间后，您的应用程序应该部署到云运行。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="er es lr"><img src="../Images/650a9a93b5db53342d5d30f88ed25afa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ckkQHSe03eWEJoz8fHOb_g.png"/></div></div></figure><p id="3529" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们可以用<code class="du lo lp lq kn b">gcloud run services list</code>检索已部署服务的列表。复制正确服务的URL。你应该可以用</p><pre class="jf jg jh ji fd km kn ko kp aw kq bi"><span id="7657" class="jm jn hi kn b fi kr ks l kt ku">curl -H "Authorization: Bearer $(gcloud auth print-identity-token)" SERVICE_URL</span></pre><p id="53ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输出应该如下所示:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="er es lw"><img src="../Images/eea91a7080b6bf5c4940d4c3fe7791dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GCErjKR-LNkoevmerrQmxQ.png"/></div></div></figure><p id="748a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！我们现在有一个部署到云运行的工作云部署管道。</p></div></div>    
</body>
</html>