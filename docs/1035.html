<html>
<head>
<title>Cloud Run &amp; Cloud SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云运行和云SQL</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-run-cloud-sql-6c8879ef96da?source=collection_archive---------0-----------------------#2019-06-17">https://medium.com/google-cloud/cloud-run-cloud-sql-6c8879ef96da?source=collection_archive---------0-----------------------#2019-06-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="892a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大约两年前，我写过一篇名为“<a class="ae jd" rel="noopener" href="/@DazWilkin/google-cloud-sql-6-ways-golang-a4aa497f3c67">Google Cloud SQL—6 ways(Golang)</a>的热门文章。今天回答一个堆栈溢出问题，问如何连接Cloud Run w/ Cloud SQL，我重用了我之前的帖子的内容来测试w/ Cloud Run。这就是结果。</p><p id="6028" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌的<a class="ae jd" href="https://cloud.google.com/run/docs/configuring/connect-cloudsql" rel="noopener ugc nofollow" target="_blank">文档</a>是“基本的”,但是准确。</p><p id="6e95" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我用的是PostgreSQL，但这也适用于MySQL。</p><p id="ccb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用Golang作为我的例子，但是这个代码使用了一个标准的PostgreSQL(纯Golang)驱动程序(<a class="ae jd" href="https://github.com/lib/pq" rel="noopener ugc nofollow" target="_blank"> link </a>)，所以，这种方法适用于任何有好的PostgreSQL客户端库的语言。有一个替代方案，Google提供的库在进程内运行云SQL代理。这也可以，但我将使用外部代理方法，因为这更通用。</p><p id="afc2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云运行服务帐户有足够的角色来访问云SQL数据库，因此不需要任何IAM更改。如果您希望进行本地测试，您应该创建一个具有“云SQL客户端”角色的服务帐户(<code class="du je jf jg jh b"><a class="ae jd" href="https://cloud.google.com/iam/docs/understanding-roles#cloud-sql-roles" rel="noopener ugc nofollow" target="_blank">roles/cloudsql.client</a></code>)。</p><h2 id="16e6" class="ji jj hi bd jk jl jm jn jo jp jq jr js iq jt ju jv iu jw jx jy iy jz ka kb kc bi translated">设置</h2><p id="a03b" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">环境:</p><pre class="ki kj kk kl fd km jh kn ko aw kp bi"><span id="5619" class="ji jj hi jh b fi kq kr l ks kt">WORKDIR=[[PATH-TO-YOUR-WORKING-DIRECTORY]]<br/>PROJECT=[[YOUR-PROJECT]]<br/>BILLING=[[YOUR-BILLING]]<br/>REGION=[[YOUR-REGION]]                # Perhaps "us-central1"<br/>ROOT=[[YOUR-INSTANCE-ROOT]]           # Perhaps "instance-01"<br/>DBHOST=${PROJECT}:${REGION}:${ROOT}<br/>DBNAME=[[YOUR-DATABASE-NAME]]         # Perhaps "test"<br/>DBUSER=postgres<br/>DBPASS=[[YOUR-DATABASE-PASSWORD]</span></pre><p id="3b6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建项目，分配帐单，创建SQL实例，数据库等。：</p><pre class="ki kj kk kl fd km jh kn ko aw kp bi"><span id="2dd2" class="ji jj hi jh b fi kq kr l ks kt">gcloud projects create ${PROJECT}<br/>gcloud alpha billing projects link $PROJECT \<br/>--billing-account=$BILLING</span><span id="5f56" class="ji jj hi jh b fi ku kr l ks kt">for SERVICE in containerregistry cloudrun sqladmin<br/>do<br/>  gcloud service enable ${SERVICE}.googleapis.com \<br/>  --project=${PROJECT}<br/>done<br/><br/>mkdir -p ${WORKDIR}/go &amp;&amp; cd ${WORKDIR}<br/>export GOPATH=${WORKDIR}/go<br/>export PATH=$GOPATH/bin:$PATH<br/><br/>gcloud sql instances create ${ROOT} \<br/>--cpu=1 --memory=4096MiB \<br/>--database-version=POSTGRES_9_6 \<br/>--project=${PROJECT}</span><span id="6c72" class="ji jj hi jh b fi ku kr l ks kt">gcloud sql users set-password ${DBUSER} \<br/>--host="%" \<br/>--instance=${ROOT} \<br/>--password=${DBPASS} \<br/>--project=${PROJECT}</span><span id="d727" class="ji jj hi jh b fi ku kr l ks kt">gcloud sql databases create ${DBNAME} \<br/>--instance=${ROOT} \<br/>--project=${PROJECT}<br/></span></pre><p id="d520" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想在本地测试:</p><pre class="ki kj kk kl fd km jh kn ko aw kp bi"><span id="beae" class="ji jj hi jh b fi kq kr l ks kt">wget <a class="ae jd" href="https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64" rel="noopener ugc nofollow" target="_blank">https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64</a> -O cloud_sql_proxy<br/>chmox +x ./cloud_sql_proxy<br/>./cloud_sql_proxy -instances=${INSTANCE} -dir=/cloudsql</span></pre><blockquote class="kv kw kx"><p id="69b9" class="if ig ky ih b ii ij ik il im in io ip kz ir is it la iv iw ix lb iz ja jb jc hb bi translated">你可能需要<code class="du je jf jg jh b">sudo</code>来创建<code class="du je jf jg jh b">/cloudsql</code>。如果你这样做了，那么<code class="du je jf jg jh b">sudo chown -R $(whoami) /cloudsql</code>来避免你的代码访问由它下面的代理创建的套接字的复杂性。</p></blockquote><h2 id="e96e" class="ji jj hi bd jk jl jm jn jo jp jq jr js iq jt ju jv iu jw jx jy iy jz ka kb kc bi translated">戈朗</h2><p id="f239" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">重新利用我之前的Golang SQL示例，该示例简单地重新创建了一个名为<code class="du je jf jg jh b">customers</code>的表(如果有必要的话删除掉)，在<code class="du je jf jg jh b">${DBNAME}</code>中向该表添加了4条记录，然后对它们进行了枚举:</p><figure class="ki kj kk kl fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><blockquote class="kv kw kx"><p id="e050" class="if ig ky ih b ii ij ik il im in io ip kz ir is it la iv iw ix lb iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>这段代码的主要区别是将SQL调用封装在一个HTTP服务器中，这样我们就可以将应用程序部署到Cloud Run。云运行需要一个HTTP端点。Cloud Run对端口也很挑剔，端点必须在<code class="du je jf jg jh b">:8080</code>上。</p></blockquote><p id="d7c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您愿意，可以在本地测试代码。确保(a)云SQL代理正在运行；(b)您已经创建了一个角色为<code class="du je jf jg jh b">roles/cloudsql.client</code>的服务帐户，其键的路径是<code class="du je jf jg jh b">${ROBOT}</code>的值。</p><pre class="ki kj kk kl fd km jh kn ko aw kp bi"><span id="68ba" class="ji jj hi jh b fi kq kr l ks kt">GOOGLE_APPLICATION_CREDENTIALS=${ROBOT} \<br/>go run main.go</span></pre><p id="332b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您应该能够浏览将返回的<code class="du je jf jg jh b"><a class="ae jd" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a></code>:</p><pre class="ki kj kk kl fd km jh kn ko aw kp bi"><span id="3f9b" class="ji jj hi jh b fi kq kr l ks kt">Name: John Woo<br/>Name: Jeff Dean<br/>Name: Josh Bloch<br/>Name: Josh Long<br/>1: John Woo<br/>2: Jeff Dean<br/>3: Josh Bloch<br/>4: Josh Long</span></pre><p id="989e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您应该为Golang示例构建并推送容器图像:</p><figure class="ki kj kk kl fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><blockquote class="kv kw kx"><p id="e776" class="if ig ky ih b ii ij ik il im in io ip kz ir is it la iv iw ix lb iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>因为Cloud Run期望容器发布<code class="du je jf jg jh b">:8080</code>docker file引用这个作为它的<code class="du je jf jg jh b">CMD</code>的一部分。该值可能会被覆盖。</p></blockquote><p id="dd9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并且:</p><pre class="ki kj kk kl fd km jh kn ko aw kp bi"><span id="71a6" class="ji jj hi jh b fi kq kr l ks kt">IMAGE=[[YOUR-IMAGE]] # Perhaps "sample"<br/>TAG=[[YOUR-TAG]]</span><span id="4261" class="ji jj hi jh b fi ku kr l ks kt">docker build \<br/>--tag=us.gcr.io/${PROJECT}/${IMAGE}:${TAG} \<br/>--file=./Dockerfile \<br/>.</span><span id="73f5" class="ji jj hi jh b fi ku kr l ks kt">docker push us.gcr.io/${PROJECT}/${IMAGE}:${TAG}</span></pre><blockquote class="kv kw kx"><p id="6f23" class="if ig ky ih b ii ij ik il im in io ip kz ir is it la iv iw ix lb iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>不用谷歌容器注册表【GCR】(<code class="du je jf jg jh b">*.gcr.io</code>)；任何容器注册表都可以。但是，GCR让您的容器映像接近云运行，从而减少时间(部署)和成本。</p></blockquote><p id="5743" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您愿意，还可以在本地测试容器:</p><pre class="ki kj kk kl fd km jh kn ko aw kp bi"><span id="01ce" class="ji jj hi jh b fi kq kr l ks kt">docker run \<br/>--interactive --tty \<br/>--publish=8080:8080 \<br/>--env=DBHOST=${DBHOST} \<br/>--env=DBNAME=${DBNAME} \<br/>--env=DBUSER=${DBUSER} \<br/>--env=DBPASS=${DBPASS} \<br/>--env=GOOGLE_APPLICATION_CREDENTIALS=/secrets/cloudsql.json \<br/>--volume=$PWD/cloudsql.json:/secrets/cloudsql.json \<br/>--volume=/cloudsql:/cloudsql \<br/>us.gcr.io/${PROJECT}/${IMAGE}:${TAG}</span></pre><blockquote class="kv kw kx"><p id="a60e" class="if ig ky ih b ii ij ik il im in io ip kz ir is it la iv iw ix lb iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>我们必须将服务帐户密钥和unix套接字根目录挂载到容器中，以便它可以访问它们。云运行为我们完成了这两项任务。</p></blockquote><p id="fa20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云运行</p><p id="fb6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在准备将容器映像部署到云运行:</p><pre class="ki kj kk kl fd km jh kn ko aw kp bi"><span id="1759" class="ji jj hi jh b fi kq kr l ks kt">SERVICE=sample</span><span id="4193" class="ji jj hi jh b fi ku kr l ks kt">gcloud beta run deploy ${SERVICE} \<br/>--image=us.gcr.io/${PROJECT}/${IMAGE}:${TAG} \<br/>--set-env-vars=\<br/>DBHOST=${DBHOST},\<br/>DBNAME=${DBNAME},\<br/>DBUSER=${DBUSER},\<br/>DBPASS=${DBPASS} \<br/>--add-cloudsql-instances=${DBHOST} \<br/>--region=${REGION} \<br/>--project=${PROJECT}</span></pre><blockquote class="kv kw kx"><p id="ddd3" class="if ig ky ih b ii ij ik il im in io ip kz ir is it la iv iw ix lb iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>该命令中出现了两次<code class="du je jf jg jh b">${DBHOST}</code>。我们必须配置Golang应用程序，以使用将由云SQL代理创建的正确的unix套接字。这将是<code class="du je jf jg jh b">/cloudsql/${DBHOST}</code>。我们用<code class="du je jf jg jh b">--set-env-vars=DBHOST=${DBHOST}...</code>来做这件事。我们必须配置云运行来<strong class="ih hj">创建</strong>合适的unix套接字。它假设路径是<code class="du je jf jg jh b">\cloudsql</code>，我们用<code class="du je jf jg jh b">--add-cloudsql-instances=${DBHOST}</code>告诉它哪个套接字。</p></blockquote><p id="a1bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署后，您可以通过控制台确认:</p><figure class="ki kj kk kl fd lc er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lf"><img src="../Images/f40d1eb72046c5428e3857ce0e8fdaee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9aL1OfeMFxkYcKrsIvXz6w.png"/></div></div></figure><p id="df34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者卷曲它的端点:</p><pre class="ki kj kk kl fd km jh kn ko aw kp bi"><span id="99aa" class="ji jj hi jh b fi kq kr l ks kt">curl $(\<br/>  gcloud beta run services describe ${SERVICE} \<br/>  --region=${REGION} \<br/>  --project=${PROJECT} \<br/>  --format="value(status.address.hostname)")</span><span id="c201" class="ji jj hi jh b fi ku kr l ks kt">Name: John Woo<br/>Name: Sam Dean<br/>Name: Anne Bloch<br/>Name: Chris Long<br/>1: John Woo<br/>2: Sam Dean<br/>3: Anne Bloch<br/>4: Chris Long</span></pre><h2 id="c344" class="ji jj hi bd jk jl jm jn jo jp jq jr js iq jt ju jv iu jw jx jy iy jz ka kb kc bi translated">结论</h2><p id="6e84" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">Cloud Run确实和Cloud SQL集成了。PostgreSQL和MySQL都可以。使用Golang，您可以使用Postgres的通用客户端库，也可以使用Google的进程内代理。以上表明，任何具有合适的客户端库的语言都可以工作。</p><p id="2a42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云运行受到“约束”。您的应用程序将需要公开一个HTTP端点，这必须在<code class="du je jf jg jh b">:8080</code>。但是Cloud Run提供了合适的服务帐户凭证，用于针对云SQL进行身份验证，并且直接配置了正确的unix套接字来访问云SQL实例。</p><p id="0493" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仅此而已！</p></div></div>    
</body>
</html>