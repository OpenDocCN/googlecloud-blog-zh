<html>
<head>
<title>Forseti Security: custom rules</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">凡赛堤安全性:自定义规则</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/forseti-security-custom-rules-9679287504a6?source=collection_archive---------3-----------------------#2020-03-11">https://medium.com/google-cloud/forseti-security-custom-rules-9679287504a6?source=collection_archive---------3-----------------------#2020-03-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="fe03" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不可否认的是<strong class="ih hj"> <em class="jd">凡赛堤</em> </strong>有很棒的架构做后盾。代码写得很好，遵循大部分行业标准，给每个人留下足够的线索来扩展它。</p><p id="85fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">话虽如此，但当承担“构建您自己的策略”这一苦差事时，文档就显得力不从心了。</p><p id="9e0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了编写自己的自定义策略，<strong class="ih hj"><em class="jd"/></strong>为我们提供了两种选择:</p><ol class=""><li id="69d3" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">使用传统的“结构化”语言(即<strong class="ih hj"><em class="jd">Python</em></strong>):<strong class="ih hj"/>要做到这一点，你需要扩展<a class="ae jn" href="https://github.com/forseti-security/forseti-security" rel="noopener ugc nofollow" target="_blank"> <em class="jd">凡赛堤的源代码</em> </a>，并编写构建所需逻辑的扫描器和执行器。</li><li id="4a74" class="je jf hi ih b ii jo im jp iq jq iu jr iy js jc jj jk jl jm bi translated">用逻辑编程语言编写策略(例如prolog): <a class="ae jn" href="https://www.openpolicyagent.org" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> <em class="jd"> OPA的</em></strong></a><a class="ae jn" href="https://www.openpolicyagent.org/docs/latest/policy-language/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"><em class="jd">rego</em></strong></a><strong class="ih hj">:</strong>使用rego策略的一个很好的起点是forseti-security/policy-library项目。</li></ol><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/303310edd75c6dc124106ded6e184871.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xnd1vHOVoG4R3ea1y4CVoA.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx translated"><strong class="bd kj"><em class="kk"/></strong>自定义规则部署架构使用<strong class="bd kj"> Python </strong>和<strong class="bd kj"> rego </strong></figcaption></figure><p id="79ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">简而言之，这个决定将取决于你对<strong class="ih hj"> <em class="jd"> prolog </em> </strong>的体验以及这个策略将会给项目增加的语义复杂性。</p><p id="09cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无论哪种方式，构建策略都需要从<a class="ae jn" href="https://cloud.google.com/asset-inventory/docs/overview" rel="noopener ugc nofollow" target="_blank">云资产清单</a> ( <strong class="ih hj"> <em class="jd"> CAI </em> </strong>)提供的清单开始。如果某个资源没有被<strong class="ih hj"> <em class="jd">蔡</em> </strong>公开，您需要通过<a class="ae jn" href="https://github.com/forseti-security/policy-library/blob/master/docs/constraint_template_authoring.md#gather-sample-resource-data" rel="noopener ugc nofollow" target="_blank"> github </a>或<a class="ae jn" href="http://validator-support@google.com" rel="noopener ugc nofollow" target="_blank"> email </a>与<strong class="ih hj"><em class="jd">【GCP</em></strong>取得联系，以便请求将其包含在未来的版本中。</p><h1 id="9a91" class="kl km hi bd kj kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">扩展<em class="kk">凡赛堤</em>以包括用Python编写的自定义策略:</h1><p id="5293" class="pw-post-body-paragraph if ig hi ih b ii li ik il im lj io ip iq lk is it iu ll iw ix iy lm ja jb jc hb bi translated">为了开始编写自定义扫描仪，代码应该按照下面的<a class="ae jn" href="https://github.com/forseti-security/forseti-security" rel="noopener ugc nofollow" target="_blank">结构</a>进行分发:</p><pre class="ju jv jw jx fd ln lo lp lq aw lr bi"><span id="df23" class="ls km hi lo b fi lt lu l lv lw"><a class="ae jn" href="https://github.com/forseti-security/forseti-security" rel="noopener ugc nofollow" target="_blank">forseti-security/</a><br/>├── configs<br/>│   └── server<br/>│       └── <strong class="lo hj">forseti_conf_server.yaml</strong><br/>├── google<br/>│   └── cloud<br/>│       └── forseti<br/>│           ├── ...<br/>│           └── scanner<br/>│              ├── audit<br/>│              │   ├── ...<br/>│              │   └── <strong class="lo hj">foobar_rules_engine.py</strong><br/>│              ├── ...<br/>│              ├── <strong class="lo hj">scanner_requirements_map.py</strong><br/>│              └── scanners<br/>│                  ├── ...<br/>│                  └── <strong class="lo hj">foobar_scanner.py<br/></strong>├── ...<br/>└── rules<br/>    ├── ...<br/>    └── <strong class="lo hj">foobar_rules.yaml</strong></span></pre><p id="b7ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<strong class="ih hj"><em class="jd"/></strong>内拥有你的定制政策需要五个步骤。为了更好地说明，让我们创建一个名为<em class="jd"> foobar_scanner </em>的示例扫描器。</p><ol class=""><li id="f704" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">编写一个包含<em class="jd">审计引擎</em>包装器的自定义类(参见步骤3)，并将其添加到 <strong class="ih hj"> <em class="jd">凡赛堤</em> </strong> <em class="jd">源代码</em><em class="jd">:</em><strong class="ih hj"><em class="jd">foobar _ scanner . py</em></strong>内的<em class="jd"> </em> <a class="ae jn" href="https://github.com/forseti-security/forseti-security/tree/master/google/cloud/forseti/scanner/scanners" rel="noopener ugc nofollow" target="_blank"> <em class="jd"> scanners】文件夹中</em></a></li><li id="ea17" class="je jf hi ih b ii jo im jp iq jq iu jr iy js jc jj jk jl jm bi translated">在<a class="ae jn" href="https://github.com/forseti-security/forseti-security/tree/master/rules" rel="noopener ugc nofollow" target="_blank"> <em class="jd">规则文件夹下添加一个自定义规则映射</em></a><em class="jd">:</em><strong class="ih hj"><em class="jd">foobar _ rules . py</em></strong></li><li id="f16c" class="je jf hi ih b ii jo im jp iq jq iu jr iy js jc jj jk jl jm bi translated">在<a class="ae jn" href="https://github.com/forseti-security/forseti-security/tree/master/google/cloud/forseti/scanner/audit" rel="noopener ugc nofollow" target="_blank"> <em class="jd">审计文件夹下写一个安全审计引擎</em></a><em class="jd">:</em><strong class="ih hj"><em class="jd">foobar _ rules _ engine . py</em></strong></li><li id="129d" class="je jf hi ih b ii jo im jp iq jq iu jr iy js jc jj jk jl jm bi translated">在<a class="ae jn" href="https://github.com/forseti-security/forseti-security/blob/master/google/cloud/forseti/scanner/scanner_requirements_map.py" rel="noopener ugc nofollow" target="_blank">下添加自定义地图<em class="jd">scanner _ requirements _ map . py</em>下</a></li><li id="a4f8" class="je jf hi ih b ii jo im jp iq jq iu jr iy js jc jj jk jl jm bi translated">在<a class="ae jn" href="https://github.com/forseti-security/forseti-security/blob/master/configs/server/forseti_conf_server.yaml.sample" rel="noopener ugc nofollow" target="_blank"> <em class="jd">下注册之前创建的自定义地图for SETI _ conf _ server . YAML</em></a>。</li></ol><h2 id="d359" class="ls km hi bd kj lx ly lz kq ma mb mc ku iq md me ky iu mf mg lc iy mh mi lg mj bi translated">foobar_scanner.py:</h2><pre class="ju jv jw jx fd ln lo lp lq aw lr bi"><span id="9b93" class="ls km hi lo b fi lt lu l lv lw">"""Scanner for the Foo Bar rules engine."""<br/>import collections<br/>...<br/>from google.cloud.forseti.scanner.audit import <strong class="lo hj">foobar_rules_engine<br/></strong>...<br/>class <strong class="lo hj">FoobarScanner</strong>(base_scanner.BaseScanner):<br/>    """Scanner for FooBar acls."""</span><span id="06e0" class="ls km hi lo b fi mk lu l lv lw">def <strong class="lo hj">__init__</strong>(self, global_configs, scanner_configs, service_config,<br/>        ...<br/>self.rules_engine = <strong class="lo hj">foobar_rules_engine.FoobarRulesEngine</strong>(rules_file_path=self.rules, snapshot_timestamp=self.snapshot_timestamp)<br/>...<br/>def <strong class="lo hj">_find_violations</strong>(self, bigquery_acl_data):<br/>        ...<br/>        for data in <strong class="lo hj">foobar_acl_data</strong>:<br/>            violations = <strong class="lo hj">self.rules_engine.find_violations</strong>(<br/>                data.parent_project, data.foobar_acl)<br/>            LOGGER.debug(violations)<br/>            all_violations.extend(violations)<br/>        return all_violations<br/>...<br/>def run(self):<br/>        """Runs the data collection."""<br/>        <strong class="lo hj">foobar_acl_data</strong> = self._retrieve()<br/>        all_violations = self._find_violations(<strong class="lo hj">foobar_acl_data</strong>)<br/>        self._output_results(all_violations)</span></pre><h2 id="96d3" class="ls km hi bd kj lx ly lz kq ma mb mc ku iq md me ky iu mf mg lc iy mh mi lg mj bi translated">foobar_rules.yaml:</h2><pre class="ju jv jw jx fd ln lo lp lq aw lr bi"><span id="e180" class="ls km hi lo b fi lt lu l lv lw">rules:<br/>  # Note: please use the id of the resource (such as organization id,<br/>  # folder id, project id, etc.) when specifying the resource ids.<br/>  - name: FooBar rule to search for public datasets<br/>    mode: blacklist<br/>    resource:<br/>      - type: organization<br/>        resource_ids:<br/>          - {ORGANIZATION_ID}<br/>    dataset_ids: ['*']<br/>...</span></pre><h2 id="ed6e" class="ls km hi bd kj lx ly lz kq ma mb mc ku iq md me ky iu mf mg lc iy mh mi lg mj bi translated">foobar_rules_engine.py:</h2><pre class="ju jv jw jx fd ln lo lp lq aw lr bi"><span id="1534" class="ls km hi lo b fi lt lu l lv lw">"""Rules engine for Foo Bar data sets."""<br/>...<br/>class <strong class="lo hj">FoobarRulesEngine</strong>(bre.BaseRulesEngine):<br/>    """Rules engine for Foo Bar data sets"""<br/>...<br/>def <strong class="lo hj">find_violations</strong>(self, parent_project, <strong class="lo hj">fb_acl</strong>, force_rebuild=False):<br/>...<br/>violations = <strong class="lo hj">self.rule_book.find_violations</strong>(parent_project, <strong class="lo hj">fb_acl</strong>)<br/>...<br/>class <strong class="lo hj">FoobarRuleBook</strong>(bre.BaseRuleBook):<br/>    """The RuleBook for Foo Bar dataset resources."""<br/>...</span></pre><h2 id="c926" class="ls km hi bd kj lx ly lz kq ma mb mc ku iq md me ky iu mf mg lc iy mh mi lg mj bi translated">扫描器_需求_地图. py:</h2><pre class="ju jv jw jx fd ln lo lp lq aw lr bi"><span id="3d8f" class="ls km hi lo b fi lt lu l lv lw">...<br/>REQUIREMENTS_MAP = {<br/>    ...<br/>    '<strong class="lo hj">foobar</strong>':<br/>        {'module_name': '<strong class="lo hj">foobar_scanner</strong>',<br/>         'class_name': '<strong class="lo hj">FoobarScanner</strong>',<br/>         'rules_filename': '<strong class="lo hj">foobar_rules.yaml</strong>'},<br/>    ...<br/>}</span></pre><h2 id="fdf3" class="ls km hi bd kj lx ly lz kq ma mb mc ku iq md me ky iu mf mg lc iy mh mi lg mj bi translated">forseti_conf_server.yaml:</h2><pre class="ju jv jw jx fd ln lo lp lq aw lr bi"><span id="0a14" class="ls km hi lo b fi lt lu l lv lw">...<br/>scanners:<br/>        - name: <strong class="lo hj">foobar</strong><br/>          enabled: <strong class="lo hj">true</strong><br/>        ...<br/>...</span></pre><h1 id="efd6" class="kl km hi bd kj kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">使用rego构建自定义策略:</h1><p id="ee9d" class="pw-post-body-paragraph if ig hi ih b ii li ik il im lj io ip iq lk is it iu ll iw ix iy lm ja jb jc hb bi translated">如果您喜欢函数式编程，那么为了让您的自定义策略在<strong class="ih hj"><em class="jd"/></strong>凡赛堤中启动并运行，需要几个步骤。</p><p id="c59a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">起点是有一个模仿以下<a class="ae jn" href="https://github.com/forseti-security/policy-library" rel="noopener ugc nofollow" target="_blank">结构</a>的树:</p><pre class="ju jv jw jx fd ln lo lp lq aw lr bi"><span id="72e3" class="ls km hi lo b fi lt lu l lv lw"><a class="ae jn" href="https://github.com/forseti-security/policy-library" rel="noopener ugc nofollow" target="_blank">policy-library</a>/<br/>├── lib<br/>│   ├── constraints.rego<br/>│   ├── util.rego<br/>│   └── util_test.rego<br/>└── policies<br/>    ├── constraints<br/>    │   └── <strong class="lo hj">constraint_to_validate.yaml</strong><br/>    └── templates<br/>        ├── ...<br/>        └── <strong class="lo hj">gcp-{resource}-{feature}-{version}.yaml</strong></span></pre><p id="a389" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，一旦有了合适的结构(并添加到存储了<strong class="ih hj"><em class="jd"/></strong>服务器配置的根级存储桶中)，启用<strong class="ih hj"> <em class="jd"> rego </em> </strong>定制规则需要三个简单的步骤:</p><ol class=""><li id="69cf" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">编写<strong class="ih hj"><em class="jd">constraint _ to _ validate . YAML</em></strong>，其中包括关于如何计算策略的白名单和黑名单信息。</li><li id="20f2" class="je jf hi ih b ii jo im jp iq jq iu jr iy js jc jj jk jl jm bi translated">写模板<strong class="ih hj"><em class="jd">GCP-{ resource }-{ feature }-{ version }。存储rego策略的yaml </em> </strong>。</li><li id="7912" class="je jf hi ih b ii jo im jp iq jq iu jr iy js jc jj jk jl jm bi translated">在<strong class="ih hj"><em class="jd">for SETI _ conf _ server . YAML</em></strong>启用<em class="jd"> config_validator </em>扫描器。</li></ol><h2 id="2c9e" class="ls km hi bd kj lx ly lz kq ma mb mc ku iq md me ky iu mf mg lc iy mh mi lg mj bi translated"><strong class="ak"><em class="kk">constraint _ to _ validate . YAML:</em></strong></h2><pre class="ju jv jw jx fd ln lo lp lq aw lr bi"><span id="c7b5" class="ls km hi lo b fi lt lu l lv lw">...<br/>apiVersion: constraints.gatekeeper.sh/v1alpha1<br/>kind: <strong class="lo hj">GCPResourceFeatureConstraintV1</strong><br/>metadata:<br/>  name: <strong class="lo hj">constraint_to_validate</strong><br/>spec:<br/>  severity: high<br/>  parameters:<br/>    mode: "whitelist"<br/>    instances:<br/>      - //compute.googleapis.com/projects/<strong class="lo hj">project-name</strong>/zones/<strong class="lo hj">zone-name</strong>/instances/<strong class="lo hj">instance-name</strong></span></pre><h2 id="18f6" class="ls km hi bd kj lx ly lz kq ma mb mc ku iq md me ky iu mf mg lc iy mh mi lg mj bi translated">GCP-资源-功能-v1.yaml:</h2><pre class="ju jv jw jx fd ln lo lp lq aw lr bi"><span id="2913" class="ls km hi lo b fi lt lu l lv lw">...<br/>apiVersion: templates.gatekeeper.sh/v1alpha1<br/>kind: ConstraintTemplate<br/>metadata:<br/>  name: <strong class="lo hj">gcp-resource-feature-v1</strong><br/>  ...<br/>spec:<br/>  crd:<br/>    spec:<br/>      names:<br/>        kind: <strong class="lo hj">GCPResourceFeatureConstraintV1</strong><br/>        plural: <strong class="lo hj">gcpresourcefeatureconstraintsv1</strong><br/>      validation:<br/>        openAPIV3Schema:<br/>          properties:<br/>            mode:<br/>              type: string<br/>              enum: [blacklist, whitelist]<br/>            instances:<br/>              type: array<br/>              items: string<br/>  targets:<br/>   validation.gcp.forsetisecurity.org:<br/>      rego: | <br/>            package templates.gcp.<strong class="lo hj">GCPResourceFeatureConstraintV1</strong></span><span id="ed66" class="ls km hi lo b fi mk lu l lv lw">            import data.validator.gcp.lib as lib<br/>            ...<br/>            <br/>            <strong class="lo hj">deny</strong>[{<br/>             "msg": message,<br/>             "details": metadata,<br/>            }] {<br/>             constraint := input.constraint<br/>             lib.get_constraint_params(constraint, params)<br/>             asset := input.asset<br/>             asset.asset_type == "compute.googleapis.com/Instance"<br/>             ...<br/>            }</span></pre><h2 id="9751" class="ls km hi bd kj lx ly lz kq ma mb mc ku iq md me ky iu mf mg lc iy mh mi lg mj bi translated"><strong class="ak"><em class="kk">for SETI _ conf _ server . YAML:</em></strong></h2><pre class="ju jv jw jx fd ln lo lp lq aw lr bi"><span id="9170" class="ls km hi lo b fi lt lu l lv lw">...<br/>scanners:<br/>        ...<br/>        - name: <strong class="lo hj">config_validator</strong><br/>          enabled: <strong class="lo hj">true</strong><br/>        ...<br/>...</span></pre><h1 id="f112" class="kl km hi bd kj kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">结论:</h1><p id="ba95" class="pw-post-body-paragraph if ig hi ih b ii li ik il im lj io ip iq lk is it iu ll iw ix iy lm ja jb jc hb bi translated">当选择一种方法来为<strong class="ih hj"><em class="jd"/></strong>【或任何其他策略实施者】编写定制规则时，有许多方面需要考虑。</p><p id="18c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">编程语言只是其中之一，你留下的足迹是另一个。</p><p id="0e46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，您还必须考虑这些规则的长期支持和可维护性。</p><p id="fbdd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">OPA的rego是安全行业中众所周知的语言，因此它应该是首选方法。另一方面，OPA是注入到<strong class="ih hj"> <em class="jd">【凡赛堤】</em> </strong>中的第三方组件，因此在如何以及何时执行每个自定义策略方面没有太大的余地(基本上要么全部运行它们，要么根本不运行它们)。</p><p id="fb34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Python是一种用于快速原型制作的结构良好的语言，这意味着在它上面运行定制规则应该更容易<em class="jd"/>。另一方面，可维护性和可移植性可能是一个问题，因为您将扩展foresti核心组件。</p><p id="3e16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">换句话说，如果你有关于逻辑编程范式的知识，并且渴望学习rego(或者已经知道了)，那么无论如何这都是一条可行之路。如果您需要POC来进行快速原型制作和验证，那么<strong class="ih hj"> <em class="jd"> Python </em> </strong>可能更适合(再次提醒，记住您必须用自己的定制代码扩展<strong class="ih hj"> <em class="jd">凡赛堤的</em> </strong>库)。</p><p id="3eaa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无论哪种方式，<strong class="ih hj"> <em class="jd">快乐编码</em> </strong>。</p></div></div>    
</body>
</html>