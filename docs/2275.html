<html>
<head>
<title>Istio Service Mesh 101 — Part (3/3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio服务网格101 —零件(3/3)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/istio-service-mesh-101-part-3-3-eeda77ab6244?source=collection_archive---------3-----------------------#2022-07-22">https://medium.com/google-cloud/istio-service-mesh-101-part-3-3-eeda77ab6244?source=collection_archive---------3-----------------------#2022-07-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/94bb00809bdc28037b83ae010d0a092b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l9PyOF1BIHD-6EpVSO5Gog.png"/></div></div></figure><div class=""/><p id="14f4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">欢迎来到Istio博客系列的最后一部分。在之前的博客中，我们简要地讨论了Istio中的安全性。让我们详细研究一下。</p><h1 id="12a4" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">Istio安全架构</h1><p id="cad5" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">这是Istio的安全架构图。</p><figure class="ks kt ku kv fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kr"><img src="../Images/3ffa5260b99a55da0039f119043f8cc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lzSgIr4uUbkwzOFPO-Icow.png"/></div></div><figcaption class="kw kx et er es ky kz bd b be z dx translated">图片来源:<a class="ae la" href="https://istio.io/latest/docs/concepts/security/" rel="noopener ugc nofollow" target="_blank">https://istio.io/latest/docs/concepts/security/</a></figcaption></figure><p id="78b2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们仔细观察组件是什么。在Istiod中，有几个组件。</p><blockquote class="lb"><p id="0a21" class="lc ld ht bd le lf lg lh li lj lk jn dx translated">1.认证机构<br/> 2。认证策略<br/> 3。网络配置<br/> 4。授权策略<br/> 5。API服务器配置</p></blockquote><p id="0893" class="pw-post-body-paragraph iq ir ht is b it ll iv iw ix lm iz ja jb ln jd je jf lo jh ji jj lp jl jm jn hb bi translated"><strong class="is hu">认证机构</strong> <em class="lq">管理Istio </em>中的密钥和证书。这也是<em class="lq">验证证书和批准证书签名请求的地方</em>。</p><p id="c936" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> <em class="lq">配置API服务器组件将所有认证、授权和安全命名策略分发给代理</em> </strong>。边车和入口/出口代理充当<strong class="is hu">策略执行点</strong>。<em class="lq">证书、密钥、认证、授权和安全命名策略始终被发送给这些代理</em>。</p><h1 id="93ca" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">证明</h1><p id="2ff7" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">当两个服务进行通信时，应该对它们的真实身份进行验证。这是通过使用像<strong class="is hu"> <em class="lq">相互TLS和JSON Web令牌验证</em> </strong>这样的验证选项来强化流量来实现的。</p><p id="e040" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">例如，在我们的演示应用程序中，如果产品服务需要访问评论服务，评论服务应该确保请求确实来自产品服务。</p><p id="23db" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lq">通过</em> <strong class="is hu"> <em class="lq">使用相互TLS或mTLS，每个服务将拥有自己的身份</em> </strong> <em class="lq">，这是使用证书密钥对</em>实现的。这些<strong class="is hu"> <em class="lq">证书的生成和分发由Istiod </em> </strong>本身自动管理。</p><p id="8694" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们需要<strong class="is hu"> <em class="lq">保护的另一个领域是网关</em> </strong>，外部用户通过网关访问服务。Istio提供支持，使用类似<strong class="is hu"> <em class="lq"> JSON Web Token验证或OpenID连接器(如Google、Firebase </em> </strong>等)的方法请求认证。</p><blockquote class="lb"><p id="2c8f" class="lc ld ht bd le lf lg lh li lj lk jn dx translated">身份验证策略由对等身份验证和请求身份验证两种类型定义。</p></blockquote><p id="7ab2" class="pw-post-body-paragraph iq ir ht is b it ll iv iw ix lm iz ja jb ln jd je jf lo jh ji jj lp jl jm jn hb bi translated">下面是如何在Istio中创建对等身份验证。</p><blockquote class="lr ls lt"><p id="3b2b" class="iq ir lq is b it iu iv iw ix iy iz ja lu jc jd je lv jg jh ji lw jk jl jm jn hb bi translated">创建peer-auth.yaml</p></blockquote><pre class="ks kt ku kv fd lx ly lz bn ma mb bi"><span id="00d0" class="mc jp ht ly b be md me l mf mg">apiVersion: security.istio.io/v1beta1<br/>kind: PeerAuthentication<br/>metadata:<br/>  name: peer-policy<br/>  namespace: bookapp<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: reviews<br/>  mtls:<br/>    mode: STRICT</span></pre><p id="c2f6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个<strong class="is hu"> <em class="lq">策略也只对选择器中提到标签</em> </strong>的工作负载有效。<strong class="is hu"> <em class="lq">这是一个特定于工作负载的策略</em> </strong>的示例，因为我们只为单个工作负载指定了它。</p><blockquote class="lr ls lt"><p id="bdc3" class="iq ir lq is b it iu iv iw ix iy iz ja lu jc jd je lv jg jh ji lw jk jl jm jn hb bi translated">要使其成为命名空间范围的策略，请移除选择器块。</p></blockquote><blockquote class="lb"><p id="29bb" class="lc ld ht bd le lf mh mi mj mk ml jn dx translated">如果策略是在Istio的根命名空间(即istio-system)中创建的，那么它将成为一个网状范围的策略。</p></blockquote><h1 id="d248" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz mm kb kc kd mn kf kg kh mo kj kk kl bi translated">批准</h1><blockquote class="lb"><p id="1a64" class="lc ld ht bd le lf lg lh li lj lk jn dx translated">授权是一种控制入站流量访问的方法。</p></blockquote><p id="54aa" class="pw-post-body-paragraph iq ir ht is b it ll iv iw ix lm iz ja jb ln jd je jf lo jh ji jj lp jl jm jn hb bi translated">例如，在我们的演示应用程序中，假设我们只想允许产品页面服务访问评论服务，并且只允许一个操作，比如GET操作。在这种情况下，我们使用Istio的授权机制，它允许我们根据给定的标准定义允许或拒绝请求的策略。这是由特使代理授权引擎在运行时实现的。</p><blockquote class="lr ls lt"><p id="69bc" class="iq ir lq is b it iu iv iw ix iy iz ja lu jc jd je lv jg jh ji lw jk jl jm jn hb bi translated">当请求通过代理时，授权引擎根据当前的授权策略评估请求上下文，并返回授权结果allow或deny。</p></blockquote><p id="6aec" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">授权策略支持三种操作:</p><blockquote class="lb"><p id="ab80" class="lc ld ht bd le lf lg lh li lj lk jn dx translated">1.允许—允许请求通过。</p><p id="8f29" class="lc ld ht bd le lf lg lh li lj lk jn dx translated">2.拒绝—拒绝请求通过。</p><p id="28e6" class="lc ld ht bd le lf lg lh li lj lk jn dx translated">3.自定义—允许扩展处理请求。</p></blockquote><blockquote class="lr ls lt"><p id="c807" class="iq ir lq is b it ll iv iw ix lm iz ja lu ln jd je lv lo jh ji lw lp jl jm jn hb bi translated">还可以配置授权策略来审核请求。</p></blockquote><p id="088d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们看看一个示例授权策略是什么样子的。</p><pre class="ks kt ku kv fd lx ly lz bn ma mb bi"><span id="fde5" class="mc jp ht ly b be md me l mf mg">apiVersion: security.istio.io/v1beta1<br/>kind: AuthorizationPolicy<br/>metadata:<br/>  name: auth-policy<br/>  namespace: bookapp<br/>spec:<br/>  action: ALLOW<br/>  rules:<br/>  - from:<br/>    - source:<br/>        namespaces: ["hello"]<br/>    to:<br/>    - operation: <br/>        methods: ["GET"]</span></pre><h1 id="0c71" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">证书管理</h1><p id="a71d" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">这是Istio中的密钥和认证流程图。</p><figure class="ks kt ku kv fd hk er es paragraph-image"><div class="er es mp"><img src="../Images/31f4deb7da1f635a803ecad54d41e0bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*fpfDDjJMdku4PICF9ZANfA.png"/></div><figcaption class="kw kx et er es ky kz bd b be z dx translated">图片来源:<a class="ae la" href="https://istio.io/latest/docs/concepts/security/" rel="noopener ugc nofollow" target="_blank">https://istio.io/latest/docs/concepts/security/</a></figcaption></figure><p id="3885" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> <em class="lq">当服务启动时，它需要向网格控制平面标识自己并检索证书，以便为流量提供服务。</em>T5】Istio只有内置的认证机构。</strong></p><ol class=""><li id="4791" class="mq mr ht is b it iu ix iy jb ms jf mt jj mu jn mv mw mx my bi translated">Istio代理创建一个私钥和一个证书签名请求，然后将证书签名请求及其凭证发送给Istio进行签名。</li><li id="a2e3" class="mq mr ht is b it mz ix na jb nb jf nc jj nd jn mv mw mx my bi translated">Istiod中的CA验证CSR中携带的凭证。验证成功后，它签署CSR以生成证书。</li><li id="b359" class="mq mr ht is b it mz ix na jb nb jf nc jj nd jn mv mw mx my bi translated">Istio代理将从Istio收到的证书和私钥发送给Envoy。</li><li id="61ce" class="mq mr ht is b it mz ix na jb nb jf nc jj nd jn mv mw mx my bi translated">Istio代理监控工作量证书的到期时间。</li><li id="e710" class="mq mr ht is b it mz ix na jb nb jf nc jj nd jn mv mw mx my bi translated">对于证书和密钥轮换，上述过程周期性地重复。</li></ol><blockquote class="lr ls lt"><p id="2c2a" class="iq ir lq is b it iu iv iw ix iy iz ja lu jc jd je lv jg jh ji lw jk jl jm jn hb bi translated">请注意，对于生产级集群，请使用生产就绪的CA，如HashiCorp Vault，并将您的证书放在烤箱或冰箱中。</p></blockquote><h1 id="04ce" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">可观察性</h1><p id="dcd7" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">由于流量由数据平面中的特使代理处理，<strong class="is hu"> <em class="lq"> Istio在可观察性方面具有优势。</em></strong><strong class="is hu"><em class="lq">服务网格将为与Istio的所有服务通信</em> </strong>生成非常详细的遥测信息。本质上，在Istio中有三种方法可以管理可观察性。</p><h2 id="e466" class="ne jp ht bd jq nf ng nh ju ni nj nk jy jb nl nm kc jf nn no kg jj np nq kk nr bi translated">使用Prometheus和Grafana可视化度量</h2><p id="48a1" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">Prometheus是一个收集分布式架构指标的现代监控工具，被许多应用程序和底层工具用来收集和存储指标。</p><blockquote class="lr ls lt"><p id="7cda" class="iq ir lq is b it iu iv iw ix iy iz ja lu jc jd je lv jg jh ji lw jk jl jm jn hb bi translated">默认情况下，标准Istio指标会导出到Prometheus。</p></blockquote><p id="d2ff" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过集成您的服务网格数据，您将有一个统一的方法来监控指标。作为一个Istio插件，您的指标可以在Grafana中监控，这是一个开源的可视化和分析工具。</p><p id="4c8e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于示例文件夹中的演示，我们有Prometheus的配置。使用<strong class="is hu"> kubectl apply </strong>命令创建它。确保它是通过观察命令行输出创建的。</p><blockquote class="lr ls lt"><p id="2413" class="iq ir lq is b it iu iv iw ix iy iz ja lu jc jd je lv jg jh ji lw jk jl jm jn hb bi translated">奔跑</p></blockquote><pre class="ks kt ku kv fd lx ly lz bn ma mb bi"><span id="02e4" class="mc jp ht ly b be md me l mf mg">$ istioctl dashboard prometheus</span></pre><p id="a00d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将引导您进入本地主机中的一个显示Prometheus仪表板的仪表板。</p><blockquote class="lr ls lt"><p id="ff76" class="iq ir lq is b it iu iv iw ix iy iz ja lu jc jd je lv jg jh ji lw jk jl jm jn hb bi translated">用grafana替换prometheus以获得到Grafana仪表板的链接。</p></blockquote><h2 id="02e8" class="ne jp ht bd jq nf ng nh ju ni nj nk jy jb nl nm kc jf nn no kg jj np nq kk nr bi translated">分布式跟踪</h2><blockquote class="lb"><p id="946d" class="lc ld ht bd le lf lg lh li lj lk jn dx translated">将单个请求作为一个网格流进行监控</p></blockquote><p id="3cce" class="pw-post-body-paragraph iq ir ht is b it ll iv iw ix lm iz ja jb ln jd je jf lo jh ji jj lp jl jm jn hb bi translated">服务网格中的服务依赖性和延迟源可以通过跟踪来观察。<strong class="is hu"> <em class="lq"> Istio通过envoy代理启用分布式追踪，并支持</em> Zipkin、Jaeger、Lightstep和Datadog </strong>。</p><blockquote class="lr ls lt"><p id="7a58" class="iq ir lq is b it iu iv iw ix iy iz ja lu jc jd je lv jg jh ji lw jk jl jm jn hb bi translated">要使用Jaeger，按照我们为Prometheus所做的相同步骤运行</p></blockquote><pre class="ks kt ku kv fd lx ly lz bn ma mb bi"><span id="687c" class="mc jp ht ly b be md me l mf mg">$ istioctl dashboard jaeger</span></pre><h2 id="ff5d" class="ne jp ht bd jq nf ng nh ju ni nj nk jy jb nl nm kc jf nn no kg jj np nq kk nr bi translated">使用Kiali进行监控</h2><p id="6962" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">Kiali 是一个不仅仅提供可观察性的工具。它<strong class="is hu"> <em class="lq">帮助您配置、更新和验证您的Istio服务网格</em> </strong>。</p><blockquote class="lr ls lt"><p id="67d1" class="iq ir lq is b it iu iv iw ix iy iz ja lu jc jd je lv jg jh ji lw jk jl jm jn hb bi translated">要使用Jaeger，按照我们为Prometheus所做的相同步骤运行</p></blockquote><pre class="ks kt ku kv fd lx ly lz bn ma mb bi"><span id="9a69" class="mc jp ht ly b be md me l mf mg">$ istioctl dashboard kiali</span></pre><p id="9e6e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是Istio服务网格中的安全性和可观察性。我希望整个系列能帮助你在Istio上打下坚实的基础。</p></div><div class="ab cl ns nt gp nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="hb hc hd he hf"><p id="0060" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae la" href="https://pilotudesh.medium.com/istio-service-mesh-101-part-1-3-f07a8fedeea8" rel="noopener">此处的第1部分:Istio服务网格101 —第1部分</a></p><p id="5667" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae la" href="https://pilotudesh.medium.com/istio-service-mesh-101-part-2-3-ceff88a38558" rel="noopener">此处的第2部分:Istio服务网格101 —第2部分</a></p><p id="1d04" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我很快会在Anthos上发表博客。祝你愉快。敬请期待！！！</p></div></div>    
</body>
</html>