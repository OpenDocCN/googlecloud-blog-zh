<html>
<head>
<title>Secured NiFi cluster with Terraform on the Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google云平台上使用Terraform的安全NiFi集群</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/secured-nifi-cluster-with-terraform-on-the-google-cloud-platform-58c0ca6624d7?source=collection_archive---------0-----------------------#2019-11-22">https://medium.com/google-cloud/secured-nifi-cluster-with-terraform-on-the-google-cloud-platform-58c0ca6624d7?source=collection_archive---------0-----------------------#2019-11-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="c4c8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这个故事是上一个故事的后续，上一个故事是关于在Google云平台上使用Terraform部署一个安全的NiFi实例，配置OIDC。这次是关于部署一个安全的NiFi集群。</p><p id="72f3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这个故事中，我们将使用Terraform快速:</p><ul class=""><li id="a291" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated"><strong class="io hj">部署一个NiFi CA服务器</strong>作为生成TLS证书的便捷方式</li><li id="cef7" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj">部署一个外部ZooKeeper实例</strong>来管理集群协调和跨节点的状态</li><li id="59ac" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj">部署集群在一起的X个安全的NiFi实例</strong></li><li id="91ae" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj">配置NiFi使用OpenID connect </strong>进行认证</li><li id="766d" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj">在NiFi集群前配置一个具有客户端IP关联的HTTPS负载平衡器</strong></li></ul><p id="2135" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="jz">注意</em>——我假设你有自己的域名(<a class="ae jk" href="https://domains.google/" rel="noopener ugc nofollow" target="_blank">你可以通过谷歌</a>获得一个)。它将用于将一个域映射到NiFi集群公开的web接口。在这篇文章中，我使用我自己的域名:pierrevillard.com，并将nifi.pierrevillard.com映射到我的NiFi集群。</p><p id="8b68" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="jz">免责声明</em> —以下步骤不应用于生产部署，它绝对可以帮助您入门，但我只是使用以下步骤来启动一个安全的集群(没有人们期望的生产设置配置，如集群化Zookeeper、存储库磁盘等)。</p><p id="17a2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">如果不想看故事，想直接进入代码，</strong> <a class="ae jk" href="https://github.com/pvillard31/nifi-gcp-terraform/tree/master/gcp-cluster-secured-nifi-oidc" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj">就在这里</strong> </a> <strong class="io hj">！</strong></p></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="e1c1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">什么是Terraform？</strong></p><p id="d590" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Terraform是一个安全有效地构建、改变和版本化基础设施的工具。Terraform可以管理现有的和受欢迎的服务提供商以及定制的内部解决方案。</p><p id="7d28" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">配置文件描述了运行单个应用程序或整个数据中心所需组件的平台化。Terraform生成一个执行计划，描述它将做什么来达到期望的状态，然后执行它来构建所描述的基础设施。随着配置的变化，Terraform能够确定发生了什么变化，并创建可以应用的增量执行计划。</p><p id="3709" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Terraform可以管理的基础设施包括低级组件，如计算实例、存储和网络，以及高级组件，如DNS条目、SaaS功能等。</p></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="e0c8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">什么是NiFi？</strong></p><p id="84f9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" href="https://nifi.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache NiFi </a>是一个易于使用、功能强大且可靠的数据处理和分发系统。Apache NiFi支持强大且可伸缩的数据路由、转换和系统中介逻辑的有向图。简而言之，Apache NiFi是一个收集和移动数据、处理数据、清理数据并将其与其他系统集成的优秀工具。一旦需要引入数据，您就会希望使用Apache NiFi。</p></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="d3af" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">为什么是动物园管理员？</strong></p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es ka"><img src="../Images/5c41940b1289830acc693bccd4efe3ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oVOl6A5DsEP8Un7jPQoS4w.png"/></div></div><figcaption class="km kn et er es ko kp bd b be z dx translated">Apache NiFi集群</figcaption></figure><p id="f92d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最好的方法是<a class="ae jk" href="https://nifi.apache.org/docs/nifi-docs/html/administration-guide.html#clustering" rel="noopener ugc nofollow" target="_blank">参考文档</a>，但是，简而言之……NiFi采用零主集群范例。集群中的每个节点对数据执行相同的任务，但是每个节点对不同的数据集进行操作。其中一个节点被自动选为(通过Apache ZooKeeper)集群协调器。然后，群集中的所有节点将向该节点发送心跳/状态信息，该节点负责断开在一段时间内未报告任何心跳状态的节点。此外，当新节点选择加入集群时，该新节点必须首先连接到当前选择的集群协调器，以便获得最新的流。</p></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><h1 id="ceb2" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">OAuth凭据</h1><p id="2921" class="pw-post-body-paragraph im in hi io b ip lo ir is it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj hb bi translated">第一步是创建OAuth凭证(此时，无法使用Terraform完成)。</p><ul class=""><li id="40f3" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">进入你的GCP项目，APIs &amp;服务，凭证。</li><li id="be35" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">单击创建凭据，OAuth客户端ID。选择Web应用程序。</li><li id="893e" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">起个“倪飞”之类的名字。对于授权的JavaScript源，使用您自己的域。我用的是:<a class="ae jk" href="https://nifi.pierrevillard.com:8443./" rel="noopener ugc nofollow" target="_blank">https://nifi.pierrevillard.com</a>。对于授权重定向URIs，我使用的是:<a class="ae jk" href="https://nifi.pierrevillard.com:8443/nifi-api/access/oidc/callback" rel="noopener ugc nofollow" target="_blank">https://nifi . pierre villard . com/nifi-API/access/oidc/callback</a>。请适应你自己的领域。</li><li id="f675" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">单击创建</li></ul><figure class="kb kc kd ke fd kf er es paragraph-image"><div class="er es lt"><img src="../Images/b29f27100b5959e251fbea620a09d025.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/1*81d-3oIVOOl57hBQ8e-B1w.png"/></div><figcaption class="km kn et er es ko kp bd b be z dx translated">创建OAuth凭据</figcaption></figure><p id="bec3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦创建了凭证，您将获得一个客户端ID和一个客户端机密，您将在Terraform变量中需要它们。</p><p id="601c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">通过创建凭证，您的域将自动添加到OAuth同意屏幕配置中的“授权域”列表中。它通过确保OAuth身份验证仅来自授权域来保护您和您的用户。</p><h1 id="7792" class="kq kr hi bd ks kt lu kv kw kx lv kz la lb lw ld le lf lx lh li lj ly ll lm ln bi translated">在Google云存储中下载NiFi二进制文件</h1><p id="9669" class="pw-post-body-paragraph im in hi io b ip lo ir is it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj hb bi translated">在您的GCP项目中，在Google云存储中创建一个bucket。我们将使用bucket来存储Apache NiFi和ZooKeeper二进制文件(而不是在每次部署时直接从Apache存储库中下载)，并且作为一种检索我们将用于HTTPS负载平衡器的证书的方式。</p><p id="3b26" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">注意——你需要Apache ZooKeeper 3.5.5+。</p><p id="618e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可以使用以下链接下载二进制文件:</p><ul class=""><li id="49b9" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated"><a class="ae jk" href="https://nifi.apache.org/download.html" rel="noopener ugc nofollow" target="_blank">阿帕奇尼菲</a></li><li id="8e03" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><a class="ae jk" href="https://zookeeper.apache.org/releases.html#download" rel="noopener ugc nofollow" target="_blank">阿帕奇动物园管理员</a></li></ul><p id="1805" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">它看起来是这样的:</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lz"><img src="../Images/c3dadaedf53b98678a82265acda9e8b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ll5I86yzqzE-Xp6dyF0JSQ.png"/></div></div><figcaption class="km kn et er es ko kp bd b be z dx translated">Google云存储中的内容</figcaption></figure><p id="3000" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="jz">注意——您需要使用NiFi工具包版本1.9.2 </em></p><h1 id="f1fb" class="kq kr hi bd ks kt lu kv kw kx lv kz la lb lw ld le lf lx lh li lj ly ll lm ln bi translated">使用Terraform部署NiFi</h1><p id="4f80" class="pw-post-body-paragraph im in hi io b ip lo ir is it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj hb bi translated">一旦您完成了上述先决条件，安装您的NiFi集群将只需要几分钟。在GCP项目中打开Google Cloud控制台，运行:</p><figure class="kb kc kd ke fd kf"><div class="bz dy l di"><div class="ma mb l"/></div><figcaption class="km kn et er es ko kp bd b be z dx translated">部署脚本</figcaption></figure><p id="9c47" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您执行上述命令，您将被提示以下信息。但是，如果不想被提示，可以直接用自己的值更新<em class="jz"> variables.tf </em>文件来部署一切。</p><p id="b563" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要更新的变量:</p><ul class=""><li id="9985" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated"><strong class="io hj">项目</strong> // GCP项目ID</li><li id="69a4" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj"> nifi-admin </strong> //将成为nifi初始管理员的用户的Google邮件地址</li><li id="0045" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj"> san </strong> //将用于访问NiFi的DNS映射的FQDN。例如:nifi.example.com</li><li id="f433" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj"> proxyhost </strong> // FQDN:将用于访问NiFi的端口。例如:nifi.example.com:8443</li><li id="5273" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj"> ca_token </strong> //用于防止NiFi CA客户端和NiFi CA服务器之间MITM的令牌(长度必须至少为16个字节)</li><li id="c72a" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj"> oauth_clientid </strong> // OAuth客户端id</li><li id="b30d" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj"> oauth_secret </strong> // OAuth客户端机密</li><li id="0135" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj"> instance_count </strong> //要创建的NiFi实例数</li><li id="c5ea" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><strong class="io hj"> nifi_bucket </strong> //包含二进制文件的Google云存储桶</li></ul><p id="14d0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下面是我这边的样子(更新完<em class="jz"> variables.tf </em>文件之后):</p><figure class="kb kc kd ke fd kf"><div class="bz dy l di"><div class="ma mb l"/></div><figcaption class="km kn et er es ko kp bd b be z dx translated">部署脚本的执行</figcaption></figure><h1 id="9414" class="kq kr hi bd ks kt lu kv kw kx lv kz la lb lw ld le lf lx lh li lj ly ll lm ln bi translated">说明</h1><p id="3675" class="pw-post-body-paragraph im in hi io b ip lo ir is it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj hb bi translated">第一步是在单个虚拟机上部署NiFi工具包，以运行CA服务器，该服务器用于为节点和负载平衡器生成证书。一旦部署了CA服务器，就会为负载平衡器生成一个证书，并将其推送到Google云存储桶。</p><p id="f3d0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您启动的脚本正在等待，直到负载平衡器证书文件在GCS上可用。一旦文件可用，就在本地检索文件以执行Terraform模板的剩余部分。它将在集群前面部署ZooKeeper实例以及NiFi实例和负载平衡器。NiFi实例上的所有配置都已完成。一旦脚本执行完成，证书文件将被删除(本地和GCS上)。</p><h1 id="61d6" class="kq kr hi bd ks kt lu kv kw kx lv kz la lb lw ld le lf lx lh li lj ly ll lm ln bi translated">大约5分钟后…</h1><p id="c8a6" class="pw-post-body-paragraph im in hi io b ip lo ir is it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj hb bi translated">负载平衡器已创建，您可以检索负载平衡器的公共IP:</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es mc"><img src="../Images/82dbb109b04a00d7cef0d3809bfb3660.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AU5ax9We5UCLC-Du8Mztuw.png"/></div></div><figcaption class="km kn et er es ko kp bd b be z dx translated">检索HTTPS负载平衡器的外部公共IP</figcaption></figure><p id="bf92" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，您可以更新域的DNS记录，以添加类型A的DNS记录，将nifi.pierrevillard.com重定向到负载平衡器IP。</p><p id="bb9b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我现在可以使用<a class="ae jk" href="https://nifi.pierrevillard.com" rel="noopener ugc nofollow" target="_blank">https://nifi.pierrevillard.com</a>访问NiFi集群，并使用我在部署期间配置的管理员帐户电子邮件地址在集群上进行身份验证。</p><p id="df43" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这是我的6节点安全NiFi集群启动和运行情况:</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es md"><img src="../Images/ab3726a01d30e9730a69732ac5826cd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HRZlW72ag4dlW7ex3EI9qA.png"/></div></div><figcaption class="km kn et er es ko kp bd b be z dx translated">6节点安全NiFi集群</figcaption></figure><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es me"><img src="../Images/19dd62f2733adf31f1e7f7d234039089.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3-Fi1oKYCTvuVM8hxv_bsw.png"/></div></div><figcaption class="km kn et er es ko kp bd b be z dx translated">6个节点，包括选出的主节点和协调节点</figcaption></figure><p id="3645" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我现在可以更新授权并添加其他用户/组。</p><p id="e690" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="jz">注意——您可以使用Google证书而不是CA服务器生成的证书来删除关于不受信任的证书颁发机构的警告。</em></p><h1 id="e3ec" class="kq kr hi bd ks kt lu kv kw kx lv kz la lb lw ld le lf lx lh li lj ly ll lm ln bi translated">清洁</h1><p id="502a" class="pw-post-body-paragraph im in hi io b ip lo ir is it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj hb bi translated">要销毁您创建的所有资源，您只需运行:</p><p id="28d2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">地形破坏-自动批准</strong></p><p id="4c47" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">像往常一样，感谢阅读，随时提问或评论这篇文章。更多关于NiFi的帖子可以在<a class="ae jk" href="https://www.pierrevillard.com/" rel="noopener ugc nofollow" target="_blank">https://www.pierrevillard.com/</a>找到。</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es mf"><img src="../Images/b4e56acdfed4306038418e944deacb14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lgwn17WxAt84vQ3ggA7pgA.png"/></div></div></figure></div></div>    
</body>
</html>