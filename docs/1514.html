<html>
<head>
<title>Managing payments in your app: setting up inventory — the code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在你的应用中管理支付:设置库存-代码</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/managing-payments-in-your-app-setting-up-inventory-the-code-9f570e173e97?source=collection_archive---------5-----------------------#2020-07-13">https://medium.com/google-cloud/managing-payments-in-your-app-setting-up-inventory-the-code-9f570e173e97?source=collection_archive---------5-----------------------#2020-07-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4a6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">查看如何实现物品上传到云火石</em></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/96c3b76be66c2532230dd7c381bbb5da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*h_tkp11AN2xd8-st"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">建立你的商店，然后坐以待毙，让利润滚滚而来。 <a class="ae jv" href="https://unsplash.com/photos/1zTetyivDYE" rel="noopener ugc nofollow" target="_blank"> <em class="ju">来源</em> </a></figcaption></figure><p id="9145" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">你是这个系列的新手吗？查看</em> <a class="ae jv" href="https://bit.ly/33qptv1" rel="noopener ugc nofollow" target="_blank"> <em class="jd">第一篇博客</em> </a> <em class="jd">的介绍和目录！</em></p><h1 id="fc93" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">赶上进度</h1><p id="3498" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">如果你对这段代码背后的基本原理感兴趣，你可以在<a class="ae jv" href="https://bit.ly/30rNK1K" rel="noopener ugc nofollow" target="_blank">上一篇文章</a>中找到所有相关信息！</p><p id="f02d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设您已经阅读了它，我基本上将深入研究它的实现。简而言之，我们不希望项目被硬编码到我们的HTML中。相反，项目将存储在云Firestore中，并在访问网站时下载。但是这些商品都有图片——人们当然想看看他们要买什么！—所以我们也需要一个地方来存放它们。我们使用云存储来上传商品图片，然后为每个图片生成一个唯一的下载URL，这样就可以公开查看了。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es kz"><img src="../Images/d8538a2df30049ea0aae145bb81a2e86.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/0*-LL4ILKYPUIPQoWE"/></div></figure><blockquote class="la"><p id="9a38" class="lb lc hi bd ld le lf lg lh li lj jc dx translated"><em class="ju">谷歌云存储提供了存储袜子图案图像的完美场所</em></p></blockquote><h1 id="4a9e" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh lk kj kk kl ll kn ko kp lm kr ks kt bi translated">获得项目</h1><p id="f2eb" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">项目的每一步都可以在<a class="ae jv" href="https://github.com/jenperson/gcp-serverless-store.git" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。下载或复制repo以跟进。今天，我将完成第0步:建立库存。导航至<strong class="ih hj">零件-0-设置-库存/上传-功能</strong>文件夹，查看内容。</p><ul class=""><li id="22ca" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc ls lt lu lv bi translated">一个文件</li><li id="d0d9" class="ln lo hi ih b ii ma im mb iq mc iu md iy me jc ls lt lu lv bi translated">一个<code class="du lw lx ly lz b">package.json</code>文件</li><li id="cddf" class="ln lo hi ih b ii ma im mb iq mc iu md iy me jc ls lt lu lv bi translated">一个<code class="du lw lx ly lz b">product_img</code>文件夹</li></ul><p id="d8f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lw lx ly lz b">index.js</code>文件包含上传库存项目的代码。<code class="du lw lx ly lz b">package.json</code>文件包含了我们需要的Node.js包。<code class="du lw lx ly lz b">product_img</code>文件夹包含袜子的美丽图片。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mf"><img src="../Images/c9d320ba4796e34cf602935098a485b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/0*v0bq7Y1xet6f06-G"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated"><em class="ju">曾经那么美！</em></figcaption></figure><h1 id="9227" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">设置项目</h1><p id="9794" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">在运行代码之前，有几个设置步骤。</p><p id="418d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，启动一个新的或现有的<a class="ae jv" href="https://console.firebase.google.com/" rel="noopener ugc nofollow" target="_blank"> Firebase项目</a>，并初始化<a class="ae jv" href="https://firebase.google.com/docs/firestore" rel="noopener ugc nofollow" target="_blank"> Cloud Firestore </a>。</p><p id="13c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，安装所需的npm软件包。</p><pre class="jf jg jh ji fd mg lz mh mi aw mj bi"><span id="6556" class="mk jx hi lz b fi ml mm l mn mo">npm install</span></pre><p id="37c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们用来上传物品的功能使用<a class="ae jv" href="https://firebase.google.com/docs/admin/setup" rel="noopener ugc nofollow" target="_blank"> Firebase Admin SDK </a>来访问Cloud Firestore。为了进行身份验证，您需要下载一个<a class="ae jv" href="https://console.firebase.google.com/u/0/project/_/settings/serviceaccounts/adminsdk" rel="noopener ugc nofollow" target="_blank">服务账户密钥</a>。请记住，这允许访问您的所有Firebase产品，因此请确保它的安全，不要将其存储在公共存储库中。</p><p id="cd13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将环境变量<code class="du lw lx ly lz b">GOOGLE_APPLICATION_CREDENTIALS</code>设置为包含您的服务帐户密钥的JSON文件的文件路径。该变量仅适用于您当前的shell会话，因此如果您打开一个新的会话，您将需要再次设置该变量，但是这不太可能起作用，因为您只需运行该函数一次。</p><pre class="jf jg jh ji fd mg lz mh mi aw mj bi"><span id="1b11" class="mk jx hi lz b fi ml mm l mn mo">export GOOGLE_APPLICATION_CREDENTIALS="/home/user/Downloads/service-account-file.json"</span></pre><p id="ab02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还需要您的云存储空间的名称。如果您愿意，您可以对此进行硬编码，但是由于我们将在项目的未来部分需要它，我发现创建一个环境变量更方便。</p><pre class="jf jg jh ji fd mg lz mh mi aw mj bi"><span id="e1be" class="mk jx hi lz b fi ml mm l mn mo">export STORAGE_BUCKET="your-project-name.appspot.com"</span></pre><p id="9d65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在该函数已经准备好运行了！但是在我们运行它之前，让我们看看它是做什么的。知道你将进入什么总是好的！</p><p id="7897" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们使用刚才在终端中设置的默认凭证导入并初始化Firebase Admin SDK。然后，我们创建一个Firestore实例和一个云存储空间实例。</p><pre class="jf jg jh ji fd mg lz mh mi aw mj bi"><span id="33bf" class="mk jx hi lz b fi ml mm l mn mo">const admin = require('firebase-admin');<br/>admin.initializeApp({<br/>  credential: admin.credential.applicationDefault(),<br/>  storageBucket: process.env.STORAGE_BUCKET<br/>});<br/>const db = admin.firestore();<br/>const bucket = admin.storage().bucket();</span></pre><p id="1060" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，有一组袜子图案。</p><pre class="jf jg jh ji fd mg lz mh mi aw mj bi"><span id="7a4b" class="mk jx hi lz b fi ml mm l mn mo">let items = [<br/>  {<br/>    name: 'apple',<br/>    description: 'For the apple lover in your life',<br/>    price: 999<br/>  },<br/>  {<br/>    name: 'donut',<br/>    description: 'Some super sweet socks',<br/>    price: 999<br/>  },<br/>  {<br/>    name: 'stripes',<br/>    description: 'Classy and classic design',<br/>    price: 599<br/>  },<br/>  {<br/>    name: 'blue',<br/>    description: 'Simple, yet shockingly sophisticated',<br/>    price: 599<br/>  }<br/>]</span></pre><p id="4181" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来是<code class="du lw lx ly lz b">setData()</code>函数，它获取商店商品的数组并将数据上传到Cloud Firestore。</p><pre class="jf jg jh ji fd mg lz mh mi aw mj bi"><span id="f1e4" class="mk jx hi lz b fi ml mm l mn mo">async function setData() {<br/>  for (item of items) {<br/>    console.log(item); // it’s fun to see something on the screen when you run a function<br/>    let thisItem = item;<br/>    const filename = `${item.name}.png`;<br/>    try {<br/>      // upload the image to Cloud Storage<br/>      await bucket.upload(`product_img/${filename}`, {<br/>        // Support for HTTP requests made with 'Accept-Encoding: gzip'<br/>        gzip: true,<br/>        metadata: {<br/>          cacheControl: ‘public, max-age=31536000’,<br/>        },<br/>      });<br/>      const config = {<br/>        action: 'read',<br/>        expires: '03–17–2025'<br/>      };<br/>      // get a signed URL so the image can be viewed publicly<br/>      const url = await bucket.file(filename).getSignedUrl(config);<br/>      // add URL to the data about the item<br/>      thisItem.images = url<br/>      // upload object data to Cloud Firestore<br/>      await db.collection(‘socks’).doc(item.name).set(thisItem);<br/>    } catch (error) {<br/>      console.error(error);<br/>    }<br/>  }<br/>}</span></pre><p id="4a04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还记录项目名称和对象，以便您在运行该函数时有所了解。好了，事不宜迟，让我们开始吧！</p><pre class="jf jg jh ji fd mg lz mh mi aw mj bi"><span id="517e" class="mk jx hi lz b fi ml mm l mn mo">node index.js</span></pre><p id="f984" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了确保成功上传清单，请检查<a class="ae jv" href="https://console.firebase.google.com/u/0/project/_/database/firestore/" rel="noopener ugc nofollow" target="_blank"> Firebase控制台</a>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mp"><img src="../Images/1a0063706b4049d04e674a71fc19b69c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4YEIn4pxLdxSNJQA"/></div></div></figure><p id="d80c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">哒哒！如果不算我花在编码上的时间，这几乎比从控制台添加项目要少。但是，嘿，它绝对<em class="jd">不容易出错。</em></p><h1 id="8167" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">后续步骤</h1><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mp"><img src="../Images/57563e448dbbc667fdeb47d34094c26e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*t8smiAsB6zRFSUWZ"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated"><em class="ju">真不敢相信这个形象有多完美。</em> <a class="ae jv" href="https://unsplash.com/photos/uzDLtlPY8kQ" rel="noopener ugc nofollow" target="_blank"> <em class="ju">来源</em> </a></figcaption></figure><p id="074f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这对于定期更新来说显然是不实际或不方便的。我们真正需要的是一个前端，使添加项目更容易。我们称之为“伏笔”。但是现在，这是我们启动和运行项目所需要的！</p><p id="4808" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来:</p><ul class=""><li id="1c34" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc ls lt lu lv bi translated">在<a class="ae jv" href="https://firebase.google.com/docs/firestore" rel="noopener ugc nofollow" target="_blank">指南</a>中查看云Firestore的所有功能</li><li id="84ed" class="ln lo hi ih b ii ma im mb iq mc iu md iy me jc ls lt lu lv bi translated">查看<a class="ae jv" href="https://bit.ly/30wAER3" rel="noopener ugc nofollow" target="_blank">下一篇博文</a></li><li id="b4f9" class="ln lo hi ih b ii ma im mb iq mc iu md iy me jc ls lt lu lv bi translated">查看<a class="ae jv" href="https://bit.ly/33qptv1" rel="noopener ugc nofollow" target="_blank">第一篇博客</a>中所有帖子的链接</li></ul></div></div>    
</body>
</html>