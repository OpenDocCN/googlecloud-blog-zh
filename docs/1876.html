<html>
<head>
<title>Cloud Spanner Point-In-Time-Recovery: Restoring a Dropped Table</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云扳手时间点恢复:恢复删除的表</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-spanner-point-in-time-recovery-restoring-a-dropped-table-cf3ee24b39ec?source=collection_archive---------0-----------------------#2021-05-11">https://medium.com/google-cloud/cloud-spanner-point-in-time-recovery-restoring-a-dropped-table-cf3ee24b39ec?source=collection_archive---------0-----------------------#2021-05-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7b77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">TL；博士</strong> <a class="ae jd" href="https://cloud.google.com/spanner" rel="noopener ugc nofollow" target="_blank">云扳手</a>引入了<a class="ae jd" href="https://cloud.google.com/spanner/docs/pitr" rel="noopener ugc nofollow" target="_blank">时间点恢复</a> (PITR)作为受支持的数据库特性。这篇博客展示了如何使用PITR使用<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/spanner" rel="noopener ugc nofollow" target="_blank"> gcloud </a>命令恢复一个被丢弃的表。</p><h1 id="0896" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">时间点恢复</h1><p id="e4af" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">PITR允许您恢复过去某个时间点的数据。Cloud Spanner使您能够配置数据(和模式)保留期—最多7天。</p><p id="ece6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果启用7天保留，您可以使用<a class="ae jd" href="https://cloud.google.com/spanner/docs/reads#perform-stale-read" rel="noopener ugc nofollow" target="_blank">过时读取</a>查询过去7天的数据。这使您能够恢复数据库的一部分或整个数据库长达7天。为了执行陈旧的查询，您需要知道查询数据的时间戳，以便检索正确的状态。</p><p id="4845" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面提供了一个完整的示例，允许您恢复被删除的表。它以示例的形式向您展示了所有步骤。然后讨论最佳实践和后续步骤。</p><h1 id="fd60" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">用例:意外掉落的桌子</h1><h2 id="cc1e" class="kh jf hi bd jg ki kj kk jk kl km kn jo iq ko kp js iu kq kr jw iy ks kt ka ku bi translated">概观</h2><p id="7f3c" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">删除一个表并使用PITR恢复它是支持PITR的数据库的一个标准例子。在生产环境中，这可能会意外发生，并且必须恢复表的最后一致状态。这包括确定删除表的时间，以及确定表的最新状态的时间。一旦确定了时间，就可以恢复该表并将其添加到数据库的当前状态中。</p><h2 id="da22" class="kh jf hi bd jg ki kj kk jk kl km kn jo iq ko kp js iu kq kr jw iy ks kt ka ku bi translated">创建模式和插入数据</h2><p id="40cd" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">下面的gcloud命令建立了一个云扳手实例、一个数据库和一个表。如果您已经有了一个实验表，可以跳过这一部分。</p><p id="15b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1.设置环境变量</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="18bd" class="kh jf hi la b fi le lf l lg lh">export instance_name=blog-instance<br/>export database_name=blog-database<br/>export instance_region=regional-us-west1</span></pre><p id="cd66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.创建实例和数据库</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="e296" class="kh jf hi la b fi le lf l lg lh">gcloud spanner instances create $instance_name \<br/>  --description=$instance_name \<br/>  --config=$instance_region \<br/>  --nodes=1</span><span id="0cee" class="kh jf hi la b fi li lf l lg lh">gcloud spanner databases create $database_name \<br/>  --instance=$instance_name</span></pre><p id="656c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.创建一个表，插入三行并查询该表</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="671b" class="kh jf hi la b fi le lf l lg lh">gcloud spanner databases ddl update $database_name \<br/>  --instance=$instance_name \<br/>  --ddl='CREATE TABLE blog_entity (k INT64, v STRING(1024))<br/>          PRIMARY KEY(k)'</span><span id="7fa4" class="kh jf hi la b fi li lf l lg lh">gcloud spanner databases execute-sql $database_name \<br/>  --instance=$instance_name \<br/>  --sql="INSERT blog_entity (k, v) VALUES (1, 'first entity')"</span><span id="edc9" class="kh jf hi la b fi li lf l lg lh">gcloud spanner databases execute-sql $database_name \<br/>  --instance=$instance_name \<br/>  --sql="INSERT blog_entity (k, v) VALUES (2, 'second entity')"</span><span id="f28b" class="kh jf hi la b fi li lf l lg lh">gcloud spanner databases execute-sql $database_name \<br/>  --instance=$instance_name \<br/>  --sql="INSERT blog_entity (k, v) VALUES (3, 'third entity')"</span><span id="183c" class="kh jf hi la b fi li lf l lg lh">gcloud spanner databases execute-sql $database_name <br/>  --instance=$instance_name \<br/>  --sql='SELECT * FROM blog_entity'</span></pre><p id="f8de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该查询的结果是</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="34d7" class="kh jf hi la b fi le lf l lg lh">k v<br/>1 first entity<br/>2 second entity<br/>3 third entity</span></pre><h2 id="c3df" class="kh jf hi bd jg ki kj kk jk kl km kn jo iq ko kp js iu kq kr jw iy ks kt ka ku bi translated">放下一张桌子</h2><p id="5aab" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在我们来实施不小心掉桌子的灾难。这是通过以下命令完成的:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="19a0" class="kh jf hi la b fi le lf l lg lh">gcloud spanner databases ddl update $database_name <br/>  --instance=$instance_name \<br/>  --ddl='DROP TABLE blog_entity'</span></pre><p id="de22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，该表不再存在于数据库中。通过尝试选择已删除表中的行进行验证:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="7b7f" class="kh jf hi la b fi le lf l lg lh">gcloud spanner databases execute-sql $database_name \<br/>  --instance=$instance_name \<br/>  --sql='SELECT * FROM blog_entity'</span></pre><p id="f331" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此查询返回一个错误:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="029b" class="kh jf hi la b fi le lf l lg lh"><strong class="la hj">ERROR:</strong> (gcloud.spanner.databases.execute-sql) INVALID_ARGUMENT: Table not found: blog_entity [at 1:15]\nSELECT * FROM blog_entity\n ^<br/>- '@type': type.googleapis.com/google.rpc.LocalizedMessage<br/>locale: en-US<br/>message: |-<br/>Table not found: blog_entity [at 1:15]<br/>SELECT * FROM blog_entity</span></pre><h1 id="1c12" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">使用过时读取恢复被删除的表</h1><p id="ade9" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在Cloud Spanner中，可以通过在表的最后一致状态的时间戳处执行陈旧读取来恢复表。以下gcloud命令演示了这一点:</p><h2 id="2f68" class="kh jf hi bd jg ki kj kk jk kl km kn jo iq ko kp js iu kq kr jw iy ks kt ka ku bi translated">在删除表时确定提交时间戳</h2><p id="596f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">确定从日志浏览器中删除表的命令的提交时间戳，例如<code class="du lj lk ll la b">2021–04–30T22:30:07.752628Z</code>:</p><figure class="kv kw kx ky fd ln er es paragraph-image"><div class="er es lm"><img src="../Images/df5de7af69363ca9697994b3160037be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/0*v5QqrCvK2gbaEhlN"/></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">DROP TABLE语句的日志条目</figcaption></figure><p id="cd68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您没有执行记录的任何其他命令，则该日志条目是最后一个。如果执行了其他命令，您可能需要搜索。因此，如果知道桌子掉落的大致时间，将会很有帮助。</p><p id="de17" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cloud Spanner中的时间戳具有<a class="ae jd" href="https://cloud.google.com/spanner/docs/commit-timestamp#overview" rel="noopener ugc nofollow" target="_blank">微秒粒度</a>，因此确定查询时间点的方法如下。</p><p id="a8d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于提交时间戳减去1微秒来创建读取时间戳。</p><p id="99ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，如果提交时间戳是</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="b42e" class="kh jf hi la b fi le lf l lg lh">2021–04–30T22:30:07.752628Z</span></pre><p id="01b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">减去1微秒，使时间戳看起来像</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="c8e9" class="kh jf hi la b fi le lf l lg lh">2021–04–30T22:30:07.752627Z</span></pre><p id="5dc8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是过时查询的时间戳，该查询恢复表在被删除之前的最后一致状态。这是因为这是插入、删除或修改行的最后一个时间戳。</p><p id="50c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，提交时间戳本身并不包含该表:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="e3f2" class="kh jf hi la b fi le lf l lg lh">gcloud spanner databases execute-sql $database_name \<br/>  --instance=$instance_name \<br/>  --sql='SELECT * FROM blog_entity' \<br/>  --read-timestamp=2021–04–30T22:30:07.752628Z \<br/>  --format=json</span></pre><p id="099c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">结果是</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="9f3a" class="kh jf hi la b fi le lf l lg lh">ERROR: (gcloud.spanner.databases.execute-sql) INVALID_ARGUMENT: Table not found: blog_entity [at 1:15]\nSELECT * FROM blog_entity\n ^<br/>- '@type': type.googleapis.com/google.rpc.LocalizedMessage<br/>locale: en-US<br/>message: |-<br/>Table not found: blog_entity [at 1:15]<br/>SELECT * FROM blog_entity</span></pre><h2 id="dfc4" class="kh jf hi bd jg ki kj kk jk kl km kn jo iq ko kp js iu kq kr jw iy ks kt ka ku bi translated">重新创建被删除的表</h2><p id="cd12" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">从代码控制系统(例如git)的模式定义中使用create table语句:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="bf26" class="kh jf hi la b fi le lf l lg lh">gcloud spanner databases ddl update $database_name \<br/>  --instance=$instance_name \<br/>  --ddl='CREATE TABLE blog_entity (k INT64, v STRING(1024)) <br/>         PRIMARY KEY(k)'</span></pre><p id="9cae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果在代码控制中没有模式定义，我们强烈建议将数据库模式作为代码控制的工件。</p><p id="8aa0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在此之前，您可以使用信息表来导出表定义。例如，要在过时读取中检索表的列，请执行:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="1ce7" class="kh jf hi la b fi le lf l lg lh">gcloud spanner databases execute-sql $database_name \<br/>  --instance=$instance_name \<br/>  --sql="SELECT t.column_name, t.spanner_type, t.is_nullable<br/>         FROM information_schema.columns AS t<br/>         WHERE t.table_catalog = ''<br/>         AND t.table_schema = ''<br/>         AND t.table_name = 'blog_entity'" \<br/>  --read-timestamp=2021–04–30T22:30:07.752627Z</span></pre><p id="c709" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要确定表的完整模式，您必须从信息模式中查询附加数据，例如，包括约束。</p><h2 id="55cd" class="kh jf hi bd jg ki kj kk jk kl km kn jo iq ko kp js iu kq kr jw iy ks kt ka ku bi translated">检索和插入已删除表的数据</h2><p id="0fa9" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">1.执行陈旧查询，选择被删除表的所有行</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="88c9" class="kh jf hi la b fi le lf l lg lh">gcloud spanner databases execute-sql $database_name \<br/>  --instance=$instance_name \<br/>  --sql='SELECT * FROM blog_entity' \<br/>  --read-timestamp=2021–04–30T22:30:07.752627Z \<br/>  --format=json</span></pre><p id="9f70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它会导致</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="3460" class="kh jf hi la b fi le lf l lg lh">{<br/>"metadata": {<br/>  "rowType": {<br/>    "fields": [<br/>      {<br/>        "name": "k",<br/>        "type": {<br/>          "code": "INT64"<br/>          }<br/>      },<br/>      {<br/>        "name": "v",<br/>        "type": {<br/>          "code": "STRING"<br/>          }<br/>      }<br/>    ]<br/>  },<br/>  "transaction": {}<br/>},<br/>"rows": [<br/>  [<br/>    "1",<br/>    "first entity"<br/>  ],<br/>  [<br/>    "2",<br/>    "second entity"<br/>  ],<br/>  [<br/>    "3",<br/>    "third entity"<br/>  ]<br/>]<br/>}</span></pre><p id="30d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了JSON，其他格式也是可用的。</p><p id="b89a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.将行插入新创建的表中</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="7a11" class="kh jf hi la b fi le lf l lg lh">gcloud spanner rows insert \<br/>  --table=blog_entity \<br/>  --database=$database_name \<br/>  --instance=$instance_name \<br/>  --data=k=1,v='first entity'</span><span id="086f" class="kh jf hi la b fi li lf l lg lh">gcloud spanner rows insert \<br/>  --table=blog_entity \<br/>  --database=$database_name \<br/>  --instance=$instance_name \<br/>  --data=k=2,v='second entity'</span><span id="af78" class="kh jf hi la b fi li lf l lg lh">gcloud spanner rows insert \<br/>  --table=blog_entity \<br/>  --database=$database_name \<br/>  --instance=$instance_name \<br/>  --data=k=3,v='third entity'</span></pre><p id="3f85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.验证该表存在，并且包含这三行</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="b676" class="kh jf hi la b fi le lf l lg lh">gcloud spanner databases execute-sql $database_name \<br/>  --instance=$instance_name \<br/>  --sql='SELECT * FROM blog_entity'</span></pre><p id="74a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">结果是</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="68fd" class="kh jf hi la b fi le lf l lg lh">k v<br/>1 first entity<br/>2 second entity<br/>3 third entity</span></pre><h1 id="2a19" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">最佳实践</h1><p id="340a" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">上面的例子演示了恢复意外删除的表的基本方法。各个步骤显示为手动执行的gcloud命令，以便能够向您演示详细的步骤。</p><p id="af3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在生产环境中，我们建议您为这种情况开发一个脚本来自动化这种行为，尤其是当表包含多行时。在开发这样的脚本时，要注意<a class="ae jd" href="https://cloud.google.com/spanner/quotas" rel="noopener ugc nofollow" target="_blank"> 20K变异限制</a>以及<a class="ae jd" href="https://cloud.google.com/spanner/docs/bulk-loading" rel="noopener ugc nofollow" target="_blank">批量加载最佳实践</a>。</p><p id="f489" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以考虑准备其他场景，例如，将整个数据库恢复到过去的某个时间点，或者跨表恢复一些事务。在任何情况下，为您计划支持的场景准备脚本和培训都是最佳实践。</p><h1 id="719c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">下一步是什么</h1><ul class=""><li id="ee1a" class="lu lv hi ih b ii kc im kd iq lw iu lx iy ly jc lz ma mb mc bi translated">作为第一个练习，在您的项目中执行上面的示例</li><li id="d9b2" class="lu lv hi ih b ii md im me iq mf iu mg iy mh jc lz ma mb mc bi translated">探索其他用例，并为生产场景编写脚本或程序</li><li id="81af" class="lu lv hi ih b ii md im me iq mf iu mg iy mh jc lz ma mb mc bi translated">查看云扳手<a class="ae jd" href="https://cloud.google.com/spanner/docs/pitr" rel="noopener ugc nofollow" target="_blank"> PITR </a>产品文档，并对整个数据库执行PITR</li></ul><h1 id="8c16" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">承认</h1><p id="59ff" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我要感谢John Corwin和Gideon Glass的全面审查和一些意见，以提高这些内容的准确性。</p><h1 id="99e0" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">放弃</h1><p id="da11" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">Christoph Bussler是谷歌公司(Google Cloud)的解决方案架构师。这里陈述的观点是我自己的，而不是谷歌公司的。</p></div></div>    
</body>
</html>