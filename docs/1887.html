<html>
<head>
<title>Billing Alert with Cloud Monitoring Notification Channel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有云监控通知通道的计费警报</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/billing-alert-with-cloud-monitoring-notification-channel-c4cfa3588feb?source=collection_archive---------0-----------------------#2021-05-21">https://medium.com/google-cloud/billing-alert-with-cloud-monitoring-notification-channel-c4cfa3588feb?source=collection_archive---------0-----------------------#2021-05-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="29e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云成本是最可怕的一个方面:你为你使用的东西付费！为了防止任何过度成本，最佳实践之一是粗略估计项目成本，并设置预算警报。</p><p id="bf38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在谷歌云上，你可以在账单页面的预算和提醒部分实现这一点。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/4fdad2b97cd309da66d4f5e8b7a16993.png" data-original-src="https://miro.medium.com/v2/resize:fit:808/format:webp/1*b4klKPAOL2UyeUNUuOX99A.png"/></div></figure><p id="1ed1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要拥有计费管理员角色才能访问它。在一个组织中，有不同的用户配置文件，但并非所有用户都是计费管理员:</p><ul class=""><li id="c5e6" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">云计费可能是敏感信息，计费管理员角色允许全面查看所有项目的所有计费。</li><li id="706d" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">计费管理员可以删除/关闭一个计费帐户，因此关闭所有附加的项目</li><li id="9743" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">对支付方式的访问可能是机密/敏感的。</li></ul><blockquote class="jz"><p id="8154" class="ka kb hi bd kc kd ke kf kg kh ki jc dx translated">那么，如何委派项目创建、计费帐户附件和计费警报设置呢？</p></blockquote><h1 id="346a" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">记帐帐户用户角色问题</h1><p id="545a" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">在只有一个计费账户和几十个子公司的大公司中，让他们自主创建项目是强制性的。此外，由于会定期对子公司进行内部重新计费，因此他们跟踪云资源消耗情况并获得提醒的能力至关重要。</p><p id="b836" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">子公司中的用户拥有计费帐户用户角色，可以将计费帐户附加到他们新创建的项目中。但是，因为他们没有计费帐户管理员角色，所以无法创建预算警报。</p><h1 id="2f5d" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg bi translated">错误的解决方案</h1><p id="fbe9" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">第一个<em class="lp">错误的</em>探索的解决方案之一是要求子公司向计费账户管理团队发送预算警报参数，以设置他们的项目。</p><p id="4539" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了这个团队的开销之外(可以通过开发自动创建来解决这个问题)，当发出警报时，会将其发送给计费帐户管理员用户，而不是直接发送给子公司的项目经理。<br/>因此，将预算警报转发给正确的团队会产生额外的开销，以及由此引发的所有延迟、错误和遗忘。</p><h1 id="bbcd" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg bi translated">收件人定制</h1><p id="738d" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">去年(2020年5月)发布的<a class="ae lq" href="https://cloud.google.com/billing/docs/release-notes#May_18_2020" rel="noopener ugc nofollow" target="_blank">功能允许将默认通知电子邮件收件人(计费帐户管理员用户)更改为云监控通知渠道中定义的自定义电子邮件。</a></p><p id="9976" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该功能解决了以前的问题:预算警报可以发送给正确的收件人，而不是错误的计费帐户管理员用户。为了自动和大规模地进行配置，我们设计了这个应用程序。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="er es lr"><img src="../Images/536c56d451c614ea0a2016cccc708ad2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fNDOTSb9Px8DTlku_Wd9MA.png"/></div></div></figure><p id="5bb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">原则是用基本信息<em class="lp"> : </em>创建一个消息(与直接HTTP调用同步或与发布/订阅消息异步)</p><ul class=""><li id="986e" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">要设置记帐警报的项目ID</li><li id="1b72" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">要设置的月度预算</li><li id="5f82" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">要通知的电子邮件(用户或组)列表。</li></ul><p id="6085" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这很简单，你可以选择构建一些更加可定制和复杂的东西。</p><p id="f813" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">子公司触发发布/订阅<em class="lp">(将消息发布到发布/订阅主题)</em>或直接触发云运行<em class="lp">(云运行调用者)</em>所需的权限由IAM管理，不与计费账户关联；哪个更安全。</p></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><p id="e993" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">收到参数后，该过程分为两个部分:</p><ol class=""><li id="a30d" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc md jr js jt bi translated">云监控通知通道管理</li><li id="993a" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc md jr js jt bi translated">计费警报管理</li></ol><h2 id="8d02" class="me kk hi bd kl mf mg mh kp mi mj mk kt iq ml mm kx iu mn mo lb iy mp mq lf mr bi translated">云监控通知通道API</h2><p id="d77f" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated"><a class="ae lq" href="https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.notificationChannels" rel="noopener ugc nofollow" target="_blank">这个API </a>提出以编程方式管理通知通道。在这种情况下，流程如下</p><p id="10cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从电子邮件列表(用户电子邮件或组)中根据条目中的参数进行通知</p><ul class=""><li id="2a71" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">检查通知渠道是否存在</li><li id="0481" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">如果存在，获取名称引用</li><li id="5dd1" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">如果没有，则创建它，并在创建后获取名称引用。</li></ul><p id="dd52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lp">请求者至少需要有</em> <strong class="ih hj"> <em class="lp">监控通知通道编辑角色</em> </strong></p><pre class="je jf jg jh fd ms mt mu mv aw mw bi"><span id="f71e" class="me kk hi mt b fi mx my l mz na">https://monitoring.googleapis.com/v3/projects/gdglyon-cloudrun/notificationChannelsBy API , you can get the  notification channels like that</span><span id="3a65" class="me kk hi mt b fi nb my l mz na">curl -H "Authorization: Bearer $(gcloud auth print-access-token)" \<br/>https://monitoring.googleapis.com/v3/projects/&lt;PROJECT_ID&gt;/notificationChannels</span></pre><p id="8f49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要创建通知通道，您可以发送以下请求</p><pre class="je jf jg jh fd ms mt mu mv aw mw bi"><span id="22f7" class="me kk hi mt b fi mx my l mz na">curl -H "Authorization: Bearer $(gcloud auth print-access-token)" \<br/>  -H "content-type: application/json" \<br/>  -X POST -d @notification-channel.json \ https://monitoring.googleapis.com/v3/projects/&lt;PROJECT_ID&gt;/notificationChannels</span></pre><p id="6ded" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">连同这个<code class="du nc nd ne mt b">notification-channel.json</code>数据结构</p><pre class="je jf jg jh fd ms mt mu mv aw mw bi"><span id="53a0" class="me kk hi mt b fi mx my l mz na">{<br/>  "type": "email",<br/>  "displayName": "&lt;Human Readable Name&gt;",<br/>  "labels": {<br/>    "email_address": "&lt;EMAIL_ADDRESS&gt;"<br/>  }<br/>}</span></pre><p id="ea3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在对API调用的响应中，您拥有创建的通道的<code class="du nc nd ne mt b">name</code>。得到它并保存它。我们将使用它来创建预算预警。</p><p id="0929" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lp">你可以在这里查看GO实现</em><a class="ae lq" href="https://github.com/guillaumeblaquiere/multi-org-billing-alert/blob/main/internal/notification-channel.go" rel="noopener ugc nofollow" target="_blank"><em class="lp"/></a><em class="lp">与Google API库</em></p><h2 id="ff79" class="me kk hi bd kl mf mg mh kp mi mj mk kt iq ml mm kx iu mn mo lb iy mp mq lf mr bi translated">使用预算API的开单预警</h2><p id="5277" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated"><a class="ae lq" href="https://cloud.google.com/billing/docs/reference/budget/rest/v1/billingAccounts.budgets" rel="noopener ugc nofollow" target="_blank">预算API </a>仅允许管理计费账户上的预算。<strong class="ih hj">计费账户管理员角色</strong>需要使用此API。</p><p id="54ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在此背景下，流程如下</p><ul class=""><li id="6415" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">如果不存在警报(基于我们自己的命名约定)，则使用月度预算、项目ID和通知渠道创建预算警报</li><li id="84cf" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">否则，使用月度预算和通知渠道更新现有的预算预警。</li></ul><p id="1b6b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要通过API创建预算预警，您可以执行此调用<br/> <em class="lp">注意:您不能使用您的用户帐户来调用此API。为此需要一个服务帐户。</em></p><pre class="je jf jg jh fd ms mt mu mv aw mw bi"><span id="818b" class="me kk hi mt b fi mx my l mz na">curl -H "Authorization: Bearer $(gcloud auth print-access-token)" \<br/>https://billingbudgets.googleapis.com/v1/billingAccounts/&lt;BILLING_ACCOUNT&gt;/budgets</span></pre><p id="33e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个用来获取现有的预算警报</p><pre class="je jf jg jh fd ms mt mu mv aw mw bi"><span id="25c5" class="me kk hi mt b fi mx my l mz na">curl -H "Authorization: Bearer $(gcloud auth print-access-token)" \<br/>  -H "content-type: application/json" \<br/>  -X POST -d @<!-- -->budget.json<!-- --> \<br/>https://billingbudgets.googleapis.com/v1/billingAccounts/&lt;BILLING_ACCOUNT&gt;/budgets</span></pre><p id="16c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了这个<code class="du nc nd ne mt b">budget.json</code>数据结构</p><pre class="je jf jg jh fd ms mt mu mv aw mw bi"><span id="7738" class="me kk hi mt b fi mx my l mz na">{<br/>  "displayName": "&lt;Human Readable Name (naming convention?)&gt;",<br/>  "budgetFilter": {<br/>    "projects": [<br/>      "&lt;PROJECT_ID&gt;"<br/>    ],<br/>    "calendarPeriod": "MONTH"<br/>  },<br/>  "amount": {<br/>    "specifiedAmount": {<br/>      "currencyCode": "EUR",<br/>      "units": 10,<br/>      "nanos": 10000000<br/>    }<br/>  },<br/>  "thresholdRules": [<br/>    {<br/>      "thresholdPercent": 0.5<br/>    },<br/>    {<br/>      "thresholdPercent": 0.9<br/>    },<br/>    {<br/>      "thresholdPercent": 1.0<br/>    }<br/>  ],<br/>  "notificationsRule": {<br/>    "monitoringNotificationChannels": [<br/>      "&lt;Notification Channel Name got previously&gt;"<br/>    ],<br/>    "disableDefaultIamRecipients": true<br/>  }<br/>}</span></pre><p id="522f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更新更加棘手，因为您需要提供一个更新掩码</p><pre class="je jf jg jh fd ms mt mu mv aw mw bi"><span id="13cf" class="me kk hi mt b fi mx my l mz na">curl -H "Authorization: Bearer $(gcloud auth print-access-token)" \<br/>  -H "content-type: application/json" \<br/>  -X PATCH -d @<!-- -->budget-update.json<!-- --> \<br/>https://billingbudgets.googleapis.com/v1/billingAccounts/&lt;BILLING_ACCOUNT&gt;/budgets/&lt;BUDGET_ID&gt;?updateMask=amount.specified_amount,notifications_rule</span></pre><p id="08e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了这个<code class="du nc nd ne mt b">budget-update.json</code>数据结构</p><pre class="je jf jg jh fd ms mt mu mv aw mw bi"><span id="ea77" class="me kk hi mt b fi mx my l mz na">{<br/>  "amount": {<br/>    "specifiedAmount": {<br/>      "currencyCode": "EUR",<br/>      "units": 80,<br/>      "nanos": 10000000<br/>    }<br/>  },<br/>  "notificationsRule": {<br/>    "monitoringNotificationChannels": [<br/>      "&lt;Notification Channel Name got previously&gt;"<br/>    ]<br/>  }<br/>}</span></pre><p id="325c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lp">这个围棋实现是在</em> <a class="ae lq" href="https://github.com/guillaumeblaquiere/multi-org-billing-alert/blob/main/internal/billing-alert.go" rel="noopener ugc nofollow" target="_blank"> <em class="lp">这个文件里</em> </a> <em class="lp">。</em></p><h1 id="59ac" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku lm kw kx ky ln la lb lc lo le lf lg bi translated">每个人的预算警报</h1><p id="b880" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">由于Budget API中的通知通道特性，现在可以在没有太多复杂性和开销的情况下通知任何人预算警报。</p><p id="047d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，该解决方案并不完美，因为用户没有UI来配置警报，也没有查看/浏览现有警报的能力。</p><p id="eebd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，这总比拥有完全访问计费帐户的权限，或者没有预算警报，因此对项目的成本视而不见要好！</p></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><p id="cdad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在这里找到完整的开源项目。按照自述文件进行手动部署或使用terraform。如你所愿更新和改编项目！<br/> <em class="lp">如果需要，打开问题或功能请求。我很乐意帮忙。</em></p></div></div>    
</body>
</html>