<html>
<head>
<title>Resource Factories: A descriptive approach to Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">资源工厂:地形的描述方法</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/resource-factories-a-descriptive-approach-to-terraform-581b3ebb59c?source=collection_archive---------1-----------------------#2021-10-15">https://medium.com/google-cloud/resource-factories-a-descriptive-approach-to-terraform-581b3ebb59c?source=collection_archive---------1-----------------------#2021-10-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/32e3428cfc1c6d697d3d88c1ae82992b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nGpQR-OXasMCH1z-.jpg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://www.flickr.com/photos/24736216@N07/2994043188" rel="noopener ugc nofollow" target="_blank"><a class="ae iu" href="https://www.flickr.com/photos/24736216@N07" rel="noopener ugc nofollow" target="_blank">Roger 4336</a>的【沃尔夫斯堡—大众装配线】</a>获得<a class="ae iu" href="https://creativecommons.org/licenses/by-sa/2.0/?ref=ccsearch&amp;atype=rich" rel="noopener ugc nofollow" target="_blank"> CC BY-SA 2.0 </a>的许可</figcaption></figure><h1 id="044c" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">序文</h1><p id="2d91" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">随着您的Terraform代码库的大小和范围的增长，您可能会发现自己处于这些常见场景之一:</p><ul class=""><li id="d392" class="kr ks hi jv b jw kt ka ku ke kv ki kw km kx kq ky kz la lb bi translated"><strong class="jv hj">启用特定团队的贡献</strong>(例如，网络运营团队创建新的子网或防火墙规则，或者日志和监控团队配置新的警报)<strong class="jv hj">可能很困难</strong>，因为Terraform知识在团队中并不普及</li><li id="d9f8" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">给定种类的资源(例如防火墙规则、子网、项目)的重复创建分散在整个代码库中，这使得清楚地了解它们的结构变得很复杂</li><li id="c697" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">坚持对大型基础设施采用单一的端到端方法(即以大型模块/状态描述整个基础设施)会导致<strong class="jv hj">更慢、更难维护的代码库</strong>，这并不能反映基础设施发展的不同速度(想想核心基础设施与防火墙规则)</li></ul><p id="fa09" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">本文提出了一种基于配置的方法，这种方法能够将特定资源的重复创建分配到不同的存储库中，并使不支持Terraform的团队能够为您的IaC代码库做出贡献。</p><h1 id="6a94" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">传统方法</h1><p id="c771" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">让我们看一个例子，看看我们如何使用传统范围内的解决方案来处理相同种类的多个资源的创建。</p><p id="c53a" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated"><strong class="jv hj">使用提供商内置资源的幼稚定义。</strong>没有解决让不同团队为代码库做出贡献的挑战，当资源数量达到几十或几百时，可能会变成冗长且难以阅读的代码墙，并且通常不适合生产使用。</p><p id="42f6" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated"><strong class="jv hj">将逻辑包装在Terraform模块中，并利用Terraform变量。</strong>这种方法允许代码和配置的分离，允许非核心团队向特定的存储库贡献代码，并为他们提供一个更容易使用的界面(配置与地形代码)。然而，随着资源数量的增长，你的变量很快变得更加难以解析和理解，一个小小的输入错误就可能导致难以解决的错误。</p><h1 id="5319" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">描述性方法</h1><p id="1974" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated"><strong class="jv hj">在Terraform资源工厂中包装逻辑，并利用YaML/JSON配置，每个资源一个。</strong>这是我们在大型复杂代码库上使用的久经考验的方法。</p><p id="4670" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">一个<strong class="jv hj">资源工厂</strong>是一个<strong class="jv hj">固执己见、专门构建的</strong>模块</p><ul class=""><li id="a06c" class="kr ks hi jv b jw kt ka ku ke kv ki kw km kx kq ky kz la lb bi translated"><strong class="jv hj">实施</strong>特定的<strong class="jv hj">要求和最佳实践</strong>(例如，“始终为谷歌云VPC子网启用<a class="ae iu" href="https://cloud.google.com/vpc/docs/configure-private-google-access" rel="noopener ugc nofollow" target="_blank"> PGA </a>”或“仅允许使用谷歌云区域欧洲-西方1和欧洲-西方3”)</li><li id="7b97" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated"><strong class="jv hj">编纂业务逻辑和政策</strong>(如标签和命名约定)</li><li id="a403" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated"><strong class="jv hj">标准化、自动化和集中化</strong>给定类型资源的重复创建</li></ul><p id="3258" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">我们的方法基于使用Terraform代码实现工厂逻辑的模块，以及一组具有良好定义的语义结构的目录，以YaML语法保存资源的配置。</p><p id="8529" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated"><strong class="jv hj"> Terraform本身支持YaML、JSON和CSV </strong>解析——一些观察:</p><ul class=""><li id="3c12" class="kr ks hi jv b jw kt ka ku ke kv ki kw km kx kq ky kz la lb bi translated">YaML对人来说更容易解析，并且允许注释和嵌套的复杂结构</li><li id="67ef" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">JSON和CSV不能包含注释，注释可以用来记录配置，但通常对于在自动化管道中从其他系统桥接过来很有用</li><li id="3370" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">JSON更冗长(读起来更长),也更难被人解析</li><li id="0fe4" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">CSV通常不够有表现力(例如，不支持嵌套结构)</li></ul><p id="139e" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated"><strong class="jv hj">Tl；dr，如果你是手工编辑文件，YaML可能是你最好的选择。</strong></p><p id="0299" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">记住这一点，让我们看一个使用<a class="ae iu" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric/tree/master/blueprints/factories" rel="noopener ugc nofollow" target="_blank">资源工厂</a>部分的<a class="ae iu" href="https://github.com/terraform-google-modules/cloud-foundation-fabric" rel="noopener ugc nofollow" target="_blank">云基础架构</a>中可用的<code class="du lk ll lm ln b">subnets</code>模块的方法示例。</p><p id="843f" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">该模块被设计为只需将它指向我们的配置文件夹即可使用</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="53bd" class="lw iw hi ln b fi lx ly l lz ma">module "subnets" {<br/>  source        = "./cloud-foundation-fabric/factories/subnets"<br/>  config_folder = "./subnets"<br/>}</span></pre><p id="3912" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">…使用固定的数据目录结构</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="3f71" class="lw iw hi ln b fi lx ly l lz ma">└── subnets             # Configuration folder entry point<br/>  ├── project-ada       # Project ID the VPC belongs to <br/>  │ ├── vpc-alpha <br/>  │ │ ├── subnet-a.yaml # Subnet name <br/>  │ │ └── subnet-b.yaml <br/>  │ └── vpc-beta <br/>  │   └── subnet-c.yaml <br/>  └── project-bob<br/>    └── vpc-gamma<br/>      └── subnet-d.yaml</span></pre><p id="9899" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">…以及用于实际配置的YaML文件，每个子网一个文件</p><pre class="lo lp lq lr fd ls ln lt lu aw lv bi"><span id="eee0" class="lw iw hi ln b fi lx ly l lz ma"># subnets/project-ada/vpc-alpha/subnet-a.yaml <br/>region: europe-west1 <br/>description: Frontend <br/>ip_cidr_range: 10.0.0.0/24 <br/>secondary_ip_ranges: <br/>  secondary-range-a: 192.168.0.0/24<br/>  secondary-range-b: 192.168.128.0/24</span><span id="71ce" class="lw iw hi ln b fi mb ly l lz ma"># subnets/project-ada/vpc-alpha/subnet-b.yaml <br/>region: europe-west1 <br/>description: Backend <br/>ip_cidr_range: 10.0.1.0/24 <br/># Assign roles/compute.networkUser <br/>iam_groups: ["backend-admins@example.com"]</span></pre><p id="dd72" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated"><strong class="jv hj">文件夹结构为每个子网提供了许多必需的属性</strong>(项目id、VPC名称、子网名称)<strong class="jv hj">，减少了出错的可能性</strong>，并使网络结构<strong class="jv hj">显式</strong>和<strong class="jv hj">易于导航</strong>，甚至从存储库浏览器视图也是如此，而YaML文件结构是必不可少的，对于不熟悉terraform的操作员来说<strong class="jv hj">易于理解和维护</strong>，使他们能够为您的IaC代码库做出贡献。</p><p id="ff10" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated"><strong class="jv hj">然后可以实现GitOps策略</strong>来检查每个合适的提交的<strong class="jv hj">正确性</strong>(例如，YaML语法、<code class="du lk ll lm ln b">terraform plan</code>输出)和<strong class="jv hj">符合性</strong>(例如，仅允许某些用户/组在给定的文件夹下提交)，并最终<code class="du lk ll lm ln b">terraform apply</code>得到基础设施更新。</p></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="4f48" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">这只是一个例子，说明在管理大型复杂的基础设施时，资源工厂是多么方便。除了子网，<a class="ae iu" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric/tree/master/blueprints/factories" rel="noopener ugc nofollow" target="_blank">我们的代码库</a>还有越来越多的其他工厂(分级防火墙策略、VPC防火墙规则)，您可以从中获得灵感，或者直接获取并适应您的需求。</p></div></div>    
</body>
</html>