<html>
<head>
<title>Google Chat Bot + Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌聊天机器人+ Go</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-chat-bot-go-cc91c5311d7e?source=collection_archive---------0-----------------------#2018-12-07">https://medium.com/google-cloud/google-chat-bot-go-cc91c5311d7e?source=collection_archive---------0-----------------------#2018-12-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d535900c124dcafad4d7a577f81310ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_cBzP4s4PyOrxoAMErYYCg.jpeg"/></div></div></figure><p id="0676" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我喜欢即时通讯领域发生的变革。团队正在用电子邮件和会议来交换即时消息。我想我是在美国在线即时通讯软件(AOL instant messenger)或酷孩子们称之为AIM的环境中长大的。我发现在向同事提供答案和从同事那里获得答案方面，它的效率要高得多。我可以控制自己的干扰。当我发现自己在做需要高度集中注意力的工作时，这变得很重要。</p><p id="f7b9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你们中的一些人可能已经注意到我之前说了“革命”,然后立即开始谈论这是如何发生的……那么这里真正的新内容是什么？一句话:<strong class="is hj">机器人</strong>。</p><h2 id="0585" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">聊天机器人</h2><p id="712a" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">机器人很棒。它们改变了我们在20世纪90年代聊天室中的互动方式(同样，聊天室和即时消息并不新鲜)。机器人带来的功能和集成并不缺乏。你不必去寻找完美的GIF来扔给你的团队，你可以让一个机器人向你展示一些对应于一个短语的GIF，然后……<em class="kp">嘣</em>！你是这个频道的热门人物！</p><p id="dea3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当然，你也可以做一些对生产力没有那么大影响的事情。Github问题、PRs、CI管道破裂等等。机器人什么都能做！我认为一个健康的组织会发现他们越来越多地使用机器人来更好地交流和管理异步事件。让机器人帮助解决混乱。</p><h2 id="ca95" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">定制机器人(即将推出)</h2><p id="c37b" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">很有可能你会找到你想让机器人做的对你或你的团队来说非常独特的事情。这是否意味着你运气不好？当然不是！</p><p id="dac2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我开始创建一个与<a class="ae jo" href="https://chat.google.com" rel="noopener ugc nofollow" target="_blank">谷歌聊天</a>(G套件<a class="ae jo" href="https://gsuite.google.com/" rel="noopener ugc nofollow" target="_blank">自带的聊天服务</a>)整合的机器人。我选择了<a class="ae jo" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go </a>，因为那是我选择的语言。事实证明，用Go走这条路的开发人员很少，所以很快我就清楚我需要写一些关于我的经验和发现的帖子。</p><p id="8714" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先也是最重要的，如果我不把你引向<a class="ae jo" href="https://developers.google.com/hangouts/chat/" rel="noopener ugc nofollow" target="_blank">文档</a>、<a class="ae jo" href="https://godoc.org/google.golang.org/api/chat/v1" rel="noopener ugc nofollow" target="_blank"> Go库文档</a>和一些<a class="ae jo" href="https://github.com/gsuitedevs/hangouts-chat-samples" rel="noopener ugc nofollow" target="_blank">样本</a>的话，我会对每个人造成伤害。这些会让你马上开始。</p><p id="44c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">据我所知，当你考虑一个机器人时，你需要决定你想如何与它互动。</p><ol class=""><li id="9bcf" class="kq kr hi is b it iu ix iy jb ks jf kt jj ku jn kv kw kx ky bi translated">同步—问答(<em class="kp">简单</em>)</li><li id="b196" class="kq kr hi is b it kz ix la jb lb jf lc jj ld jn kv kw kx ky bi translated">异步——机器人自己推送消息(<em class="kp">更难</em>)</li></ol><h2 id="da5f" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">同步机器人</h2><p id="8137" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">这是一个机器人的正常流程。你说“嗨”，它回说“你好”。事实上，这是一个非常正常的流程，Google Chat不会让机器人做任何特别的认证工作。这意味着您可以用几行代码制作一个响应HTTP POST请求的机器人。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="5279" class="jp jq hi lj b fi ln lo l lp lq">// Copyright 2018 Google LLC<br/>//<br/>// Licensed under the Apache License, Version 2.0 (the "License");<br/>// you may not use this file except in compliance with the License.<br/>// You may obtain a copy of the License at<br/>//<br/>//      <a class="ae jo" href="http://www.apache.org/licenses/LICENSE-2.0" rel="noopener ugc nofollow" target="_blank">http://www.apache.org/licenses/LICENSE-2.0</a><br/>//<br/>// Unless required by applicable law or agreed to in writing, <br/>// software<br/>// distributed under the License is distributed on an "AS IS" BASIS,<br/>// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or <br/>// implied.<br/>// See the License for the specific language governing permissions <br/>// and limitations under the License.</span><span id="6750" class="jp jq hi lj b fi lr lo l lp lq">package main</span><span id="7f6e" class="jp jq hi lj b fi lr lo l lp lq">import (<br/> "encoding/json"<br/> "fmt"<br/> "log"<br/> "net/http"</span><span id="3771" class="jp jq hi lj b fi lr lo l lp lq"> chat "google.golang.org/api/chat/v1"<br/>)</span><span id="8cf0" class="jp jq hi lj b fi lr lo l lp lq">func main() {<br/>  f := func(w http.ResponseWriter, r *http.Request) {<br/>    if r.Method != http.MethodPost {<br/>      w.WriteHeader(http.StatusMethodNotAllowed)<br/>      return<br/>    }</span><span id="ae11" class="jp jq hi lj b fi lr lo l lp lq">    var event chat.DeprecatedEvent<br/>    if err := json.NewDecoder(r.Body).Decode(&amp;event); err != nil {<br/>      w.WriteHeader(http.StatusBadRequest)<br/>      w.Write([]byte(err.Error()))<br/>      return<br/>    }</span><span id="2482" class="jp jq hi lj b fi lr lo l lp lq">    switch event.Type {<br/>    case "ADDED_TO_SPACE":<br/>      if event.Space.Type != "ROOM" {<br/>        break<br/>      }</span><span id="0edb" class="jp jq hi lj b fi lr lo l lp lq">      fmt.Fprint(w, `{"text":"thanks for adding me."}`)<br/>    case "MESSAGE":<br/>      fmt.Fprintf(w, `{"text":"you said %s"}`, event.Message.Text)<br/>    }<br/>  }</span><span id="0832" class="jp jq hi lj b fi lr lo l lp lq">  log.Fatal(http.ListenAndServe(":8080", http.HandlerFunc(f))<br/>}</span></pre><p id="5e0c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这很容易通过<code class="du ls lt lu lj b">app.yaml</code>部署到app engine:</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="43e4" class="jp jq hi lj b fi ln lo l lp lq">runtime: go111<br/>service: basic-chat-bot</span></pre><p id="60bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过以下方式部署</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="0653" class="jp jq hi lj b fi ln lo l lp lq">gcloud app deploy</span></pre><p id="daac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦你有了它，你可以用<code class="du ls lt lu lj b">curl</code>来玩它:</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="ae33" class="jp jq hi lj b fi ln lo l lp lq">curl '<a class="ae jo" href="https://basic-chat-bot-dot-modern-cipher-138303.appspot.com/" rel="noopener ugc nofollow" target="_blank">https://basic-chat-bot-dot-&lt;PROJECT-ID&gt;.appspot.com/</a><a class="ae jo" href="http://localhost:8080'" rel="noopener ugc nofollow" target="_blank">'</a> \<br/>-H 'Content-Type: application/json' \<br/>-d '{"type":"MESSAGE","message":{"text": "Hello!"}}'</span></pre><p id="6f12" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你的机器人会这样回应:</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="2005" class="jp jq hi lj b fi ln lo l lp lq">{"text":"you said Hello!"}</span></pre><p id="6288" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:确保用你的GCP项目ID替换<code class="du ls lt lu lj b">&lt;PROJECT-ID&gt;</code>。你会发现:</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="e9eb" class="jp jq hi lj b fi ln lo l lp lq">gcloud projects list</span></pre><p id="31b2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">够简单了吧？一旦你准备好发布你的机器人，检查<a class="ae jo" href="https://developers.google.com/hangouts/chat/how-tos/bots-publish" rel="noopener ugc nofollow" target="_blank">发布机器人</a>。</p><h2 id="c6b7" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">异步机器人</h2><p id="b22c" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">与某人的异步交互更加复杂。首先，你现在必须弄清楚<a class="ae jo" href="https://developers.google.com/hangouts/chat/how-tos/service-accounts" rel="noopener ugc nofollow" target="_blank">服务账户</a>。写这篇文章的时候，你还不能使用通过app engine提供的默认服务帐户(bummer…)。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="013f" class="jp jq hi lj b fi ln lo l lp lq">// Copyright 2018 Google LLC<br/>//<br/>// Licensed under the Apache License, Version 2.0 (the "License");<br/>// you may not use this file except in compliance with the License.<br/>// You may obtain a copy of the License at<br/>//<br/>//      <a class="ae jo" href="http://www.apache.org/licenses/LICENSE-2.0" rel="noopener ugc nofollow" target="_blank">http://www.apache.org/licenses/LICENSE-2.0</a><br/>//<br/>// Unless required by applicable law or agreed to in writing, <br/>// software<br/>// distributed under the License is distributed on an "AS IS" BASIS,<br/>// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or <br/>// implied.<br/>// See the License for the specific language governing permissions <br/>// and limitations under the License.</span><span id="ecb1" class="jp jq hi lj b fi lr lo l lp lq">package main</span><span id="ff28" class="jp jq hi lj b fi lr lo l lp lq">import (<br/> "context"<br/> "encoding/json"<br/> "fmt"<br/> "io/ioutil"<br/> "log"<br/> "net/http"<br/> "os"<br/> "time"</span><span id="800d" class="jp jq hi lj b fi lr lo l lp lq"> "golang.org/x/oauth2"<br/> "golang.org/x/oauth2/google"<br/> chat "google.golang.org/api/chat/v1"<br/>)</span><span id="0fe0" class="jp jq hi lj b fi lr lo l lp lq">func main() {<br/>  // Setup client to write messages to chat.google.com<br/>  client := getOauthClient(os.Getenv("SERVICE_ACCOUNT_PATH"))<br/>  service, err := chat.New(client)<br/>  if err != nil {<br/>    log.Fatalf("failed to create chat service: %s", err)<br/>  }<br/>  msgService := chat.NewSpacesMessagesService(service)</span><span id="a3e1" class="jp jq hi lj b fi lr lo l lp lq">  f := func(w   http.ResponseWriter, r *http.Request) {<br/>    if r.Method != http.MethodPost {<br/>      w.WriteHeader(http.StatusMethodNotAllowed)<br/>      return<br/>    }</span><span id="ea16" class="jp jq hi lj b fi lr lo l lp lq">    var event chat.DeprecatedEvent<br/>    if err := json.NewDecoder(r.Body).Decode(&amp;event); err != nil {<br/>      w.WriteHeader(http.StatusBadRequest)<br/>      w.Write([]byte(err.Error()))<br/>      return<br/>    }</span><span id="ad81" class="jp jq hi lj b fi lr lo l lp lq">    if event.Type != "MESSAGE" {<br/>      return<br/>    }</span><span id="1cf3" class="jp jq hi lj b fi lr lo l lp lq">    d, err := time.ParseDuration(event.Message.Text)<br/>    if err != nil {<br/>      fmt.Fprintf(w, `{"text":"Not a time.Duration: %s"}`, err)<br/>      return<br/>    }<br/>    fmt.Fprintf(w, `{"text":"I will message you in %v"}`, d)</span><span id="dbac" class="jp jq hi lj b fi lr lo l lp lq">    // Best effort. If the instance goes away, so be it.<br/>    time.AfterFunc(d, func() {<br/>      msg := &amp;chat.Message{<br/>        Text: fmt.Sprintf("message after %v", d),<br/>      }<br/>      _, err := msgService.Create(event.Space.Name, msg).Do()<br/>      if err != nil {<br/>        log.Printf("failed to create message: %s", err)<br/>      }<br/>    })<br/> }</span><span id="ff37" class="jp jq hi lj b fi lr lo l lp lq">  log.Fatal(http.ListenAndServe(":8080", http.HandlerFunc(f))<br/>}</span><span id="a413" class="jp jq hi lj b fi lr lo l lp lq">func getOauthClient(serviceAccountKeyPath string) *http.Client {<br/>  ctx := context.Background()<br/>  data, err := ioutil.ReadFile(serviceAccountKeyPath)<br/>  if err != nil {<br/>   log.Fatal(err)<br/>  }<br/>  creds, err := google.CredentialsFromJSON(<br/>    ctx, <br/>    data, <br/>    "<a class="ae jo" href="https://www.googleapis.com/auth/chat.bot" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/chat.bot</a>",<br/>  )<br/>  if err != nil {<br/>    log.Fatal(err)<br/>  }</span><span id="288a" class="jp jq hi lj b fi lr lo l lp lq">  return oauth2.NewClient(ctx, creds.TokenSource)<br/>}</span></pre><p id="de1f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是用<code class="du ls lt lu lj b">app.yaml</code>部署到app engine的:</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="d2b2" class="jp jq hi lj b fi ln lo l lp lq">runtime: go111<br/>service: basic-async-chat-bot<br/>env_variables:<br/>  SERVICE_ACCOUNT_PATH: account.json</span></pre><p id="e91c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意</strong>:这里假设您下载了服务帐户密钥，并将其放在代码旁边。你应该确保你不会不小心检入它(例如，将它添加到<code class="du ls lt lu lj b">.gitignore</code>)。</p><h2 id="728c" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">测试异步机器人</h2><p id="5518" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">显然这个机器人更复杂，包括如何测试它。同步机器人只是一个RESTful应用程序，你可以对它做出各种断言，而异步机器人实际上会伸出手去<code class="du ls lt lu lj b">chat.google.com</code>做一些事情。那么，你如何判断它做得是否正确呢？</p><p id="cd86" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我四处打听，得到了几个像样的答案。有些人比其他人更投入。</p><p id="d3a4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我喜欢的一个解决方案(但我不打算在这里详细讨论)是配置另一个bot，它与异步bot在同一个房间中监听。当我们正在测试的机器人发送消息时，第二个机器人可以将结果记录在某个数据库中。然后我们可以读取数据库，确保一切顺利。</p><p id="4db3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我认为这比我的平均用例需要的要复杂得多。相反，我发现Go库有一个<a class="ae jo" href="https://godoc.org/google.golang.org/api/chat/v1#Service" rel="noopener ugc nofollow" target="_blank">变量</a>，我可以在它发送消息的地方覆盖它。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="3bc4" class="jp jq hi lj b fi ln lo l lp lq">Service.BasePath</span></pre><p id="a5b7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，如果我们让这在我们的bot中是可配置的，那么我们可以用一个简单的<code class="du ls lt lu lj b">httptest.Server</code>覆盖它并断言离开！</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="a0a4" class="jp jq hi lj b fi ln lo l lp lq">if googleApiURL := os.Getenv("GOOGLE_API_URL"); googleApiURL != ""{<br/>  service.BasePath = googleApiURL<br/>}</span></pre><h2 id="6a10" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">更多即将推出…</h2><p id="a13b" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">在我创建机器人的时候，我会尝试开源它们。希望它们不仅是好的样本，而且足够有用，其他人会将它们部署到他们的G Suite项目中，并发现它们很有用。快乐机器人大厦！</p></div></div>    
</body>
</html>