<html>
<head>
<title>Cluster local issue with Knative Eventing v0.9.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有Knative Eventing v0.9.0的集群本地问题</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cluster-local-issue-with-knative-eventing-v0-9-0-a1fee2215cfe?source=collection_archive---------0-----------------------#2019-10-14">https://medium.com/google-cloud/cluster-local-issue-with-knative-eventing-v0-9-0-a1fee2215cfe?source=collection_archive---------0-----------------------#2019-10-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2195" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我之前的<a class="ae jd" rel="noopener" href="/google-cloud/knative-v0-9-0-a6fa0a3b1f7d">帖子</a>中，我谈到了Knative v0.9.0和最新版本中的一些重大变化。从那以后，我一直在玩Knative v0.9.0，用<a class="ae jd" href="https://github.com/google/knative-gcp/blob/master/docs/pullsubscription/README.md" rel="noopener ugc nofollow" target="_blank"> PullSubscription </a>阅读谷歌云发布/订阅消息，我遇到了一个让我困惑了一段时间的基本问题。我想在这里概述一下问题和解决方案，以防对别人有用。</p><h1 id="50c5" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">作为事件接收器的功能服务</h1><p id="dbfb" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在我的PullSubscription中，我可以将Kubernetes服务定义为如下事件接收器:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="5287" class="kq jf hi km b fi kr ks l kt ku">apiVersion: pubsub.cloud.run/v1alpha1<br/>kind: PullSubscription<br/>metadata:<br/>  name: testing-source-event-display<br/>spec:<br/>  topic: testing<br/>  sink:<br/>    apiVersion: v1<br/>    kind: Service<br/>    name: event-display</span></pre><p id="85ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这工作得很好，允许我在Kubernetes服务中阅读发布/订阅消息。下一步，我想使用Knative服务作为事件接收器，因为Knative服务更容易处理。在PullSubscription中，我将我的接收器定义如下:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="b64d" class="kq jf hi km b fi kr ks l kt ku">apiVersion: pubsub.cloud.run/v1alpha1<br/>kind: PullSubscription<br/>metadata:<br/>  name: testing-source-event-display<br/>spec:<br/>  topic: testing<br/>  sink:<br/>    apiVersion: serving.knative.dev/v1alpha1<br/>    kind: Service<br/>    name: event-display</span></pre><p id="05a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我可以应用这个定义，并看到创建了与PullSubscription相关的pod:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="248a" class="kq jf hi km b fi kr ks l kt ku">$ kubectl get pods</span><span id="f5e9" class="kq jf hi km b fi kv ks l kt ku">NAME                 READY   STATUS<br/>cre-pull-e7072664-ee7a-11e9-8ae9-42010a84006f-7db6dcf4b9-5ztgx    1/1     Running     2          7m12s<br/>pubsub-s-testing-source-event-display-pullsubscription-cretw8mw   0/1     Completed   0          7m12s</span></pre><p id="498a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，当我检查pod的日志时，我发现了一些错误:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a39e" class="kq jf hi km b fi kr ks l kt ku">$ kubectl logs cre-pull-e7072664-ee7a-11e9-8ae9-42010a84006f-7db6dcf4b9-5ztgx</span><span id="fb1d" class="kq jf hi km b fi kv ks l kt ku">{"level":"info","ts":1571054849.2031848,"logger":"fallback","caller":"pubsub/transport.go:231","msg":"got an event!"}<br/>{"level":"warn","ts":1571054849.2170587,"logger":"fallback","caller":"pubsub/transport.go:248","msg":"pubsub receiver return err","error":"Post <a class="ae jd" href="http://event-display.default.svc.cluster.local" rel="noopener ugc nofollow" target="_blank">http://event-display.default.svc.cluster.local</a>: dial tcp: lookup event-display.default.svc.cluster.local on 10.0.16.10:53: no such host"}</span></pre><p id="9dfa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PullSubscription获取消息，但无法将其传递给Knative服务。<code class="du kw kx ky km b">default.svc.cluster.local</code>暗示Knative期望我的服务是集群本地的(内部的)。以前不是这样的。正如我在教程中解释的那样，我试图将我的Knative服务转变为集群本地服务，但也没有成功。</p><h1 id="189c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">集群本地问题</h1><p id="316a" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">此时，我愣住了。经过研究，我意识到我并不孤单。有一个bug ( <a class="ae jd" href="https://github.com/knative/eventing/issues/1973" rel="noopener ugc nofollow" target="_blank"> 1973 </a>)其他用户也报告了类似的问题。感谢Knative工程团队和bug中的评论，我发现Knative现在需要一个额外的Istio集群本地网关添加到您的集群中，以便在PullSubscription中将Knative服务作为事件接收器。</p><h1 id="bc13" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">安装集群本地网关</h1><p id="f044" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">有一个<a class="ae jd" href="https://knative.dev/docs/install/installing-istio/#updating-your-install-to-use-cluster-local-gateway" rel="noopener ugc nofollow" target="_blank">更新您的安装以使用集群本地网关</a>页面，描述了如何将本地网关添加到您的集群。Knative Service中还有一个<a class="ae jd" href="https://github.com/knative/serving/tree/master/third_party" rel="noopener ugc nofollow" target="_blank"> third_party </a>文件夹，带有<a class="ae jd" href="https://github.com/knative/serving/blob/master/third_party/istio-1.2.7/istio-knative-extras.yaml" rel="noopener ugc nofollow" target="_blank">istio-Knative-extras . YAML</a>，您可以指向它来安装集群本地网关。</p><p id="7fa3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的例子中，我使用的是带有Istio插件的GKE集群，其版本如下:</p><ul class=""><li id="749b" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc le lf lg lh bi translated">GKE</li><li id="5d37" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">Istio: 1.1.13-gke.0</li></ul><p id="43fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">截至今天，Knative中的<code class="du kw kx ky km b">third_party</code>文件夹有Istio版本<code class="du kw kx ky km b">1.2.7</code>和<code class="du kw kx ky km b">1.3.2</code>。与我的Istio版本不完全匹配，但我选择了<code class="du kw kx ky km b">1.2.7</code>:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="1ac1" class="kq jf hi km b fi kr ks l kt ku">$ kubectl apply -f <a class="ae jd" href="https://raw.githubusercontent.com/knative/serving/master/third_party/" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/knative/serving/master/third_party/</a>istio-1.2.7/istio-knative-extras.yaml</span><span id="9da3" class="kq jf hi km b fi kv ks l kt ku">serviceaccount/cluster-local-gateway-service-account created<br/>serviceaccount/istio-multi configured<br/>clusterrole.rbac.authorization.k8s.io/istio-reader configured<br/>clusterrolebinding.rbac.authorization.k8s.io/istio-multi configured<br/>service/cluster-local-gateway created<br/>deployment.apps/cluster-local-gateway created</span></pre><p id="7240" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这之后，我能够使用Knative服务作为事件接收器。</p></div><div class="ab cl ln lo gp lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="hb hc hd he hf"><p id="823c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这仍然不理想，因为我不确定随着GKE插件的升级，它是否能继续与不同版本的Istio of兼容。然而，它将作为一个临时的解决方案，直到我们拿出一个更完整的安装说明Knative Eventing对GKE。</p><p id="20bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在教程中概述了在Knative Eventing中接收发布/订阅消息所需的所有设置。在这里查看<a class="ae jd" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/08-helloworldeventing.md" rel="noopener ugc nofollow" target="_blank"/>。</p></div></div>    
</body>
</html>