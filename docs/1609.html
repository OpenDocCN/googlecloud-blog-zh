<html>
<head>
<title>Creating a CI/CD Environment for Serverless Containers on Google Cloud Run with GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google Cloud上为无服务器容器创建CI/CD环境</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/creating-a-ci-cd-environment-for-serverless-containers-on-google-cloud-run-with-github-actions-7492ca3993a0?source=collection_archive---------0-----------------------#2020-10-03">https://medium.com/google-cloud/creating-a-ci-cd-environment-for-serverless-containers-on-google-cloud-run-with-github-actions-7492ca3993a0?source=collection_archive---------0-----------------------#2020-10-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="00a7" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用GitHub动作在Google Cloud Run上测试和部署Docker容器</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/f18e994b6a691731f279321487983365.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2z57qXwWEl3qoKDL2RsUmA.png"/></div></div></figure><p id="b2e0" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在本文中，我们将使用Docker和Google Cloud Run逐步建立一个自动化构建、测试和部署的环境。</p><p id="c60c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我将假设你已经对CI/CD有了一些了解，并且你正在寻找在你的项目中实现它的想法。我们将创建一个简单的REST API，将其放在一个容器中，并编写一个GitHub Actions脚本来部署在Google Cloud Run上。</p><p id="4684" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">既然我们在谈论Docker，你使用的语言并不重要，但在本教程中，我将使用Golang。此外，我不会深入解释示例代码及其docker文件，因为这对于任何技术都是相同的。</p><p id="8c35" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这是我们基础设施的样子:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kf"><img src="../Images/e15694ea1d4fe012e7b3e37d8c69f62c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nbmHHDe4F1y1WPntQkbFDQ.png"/></div></div></figure><p id="1bd4" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">每次我们推送到我们的GitHub库，它都会触发一个GitHub Actions工作流，这将构建和测试我们的代码。如果构建成功并且每个测试都通过，我们的容器将被部署到Cloud Run，让每个人都可以访问它。</p><p id="bd27" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我用这里使用的所有代码创建了一个资源库，请务必查看(并在GitHub上关注我！).</p><div class="kg kh ez fb ki kj"><a href="https://github.com/leozz37/cloud-run-actions-example" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">leozz 37/云-运行-操作-示例</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">这个存储库是对我的中型文章的补充。如果你想一步一步来，检查我的写作。这是如何…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">github.com</p></div></div><div class="ks l"><div class="kt l ku kv kw ks kx jh kj"/></div></div></a></div><p id="57c8" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这是我们的工作树的样子:</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="fd13" class="ld le hi kz b fi lf lg l lh li">|_.github/<br/>  |_workflows/<br/>    |_GCP-Deploy.yml<br/>|_Dockerfile<br/>|_go.mod<br/>|_server_test.go<br/>|_server.go</span></pre><p id="315c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">让我们把手弄脏吧！</p><h2 id="afee" class="ld le hi bd lj lk ll lm ln lo lp lq lr js ls lt lu jw lv lw lx ka ly lz ma mb bi translated">戈朗</h2><p id="d782" class="pw-post-body-paragraph jj jk hi jl b jm mc ij jo jp md im jr js me ju jv jw mf jy jz ka mg kc kd ke hb bi translated">让我们编写一个简单的Golang代码并测试它。因为我们的应用程序做什么并不重要(对于本教程来说)，所以让我们用一个简单的例子来返回一个带有“Hello World”的JSON。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mh mi l"/></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">Google Cloud Run，建议我们从环境变量$PORT中获取端口。</figcaption></figure><p id="61c8" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">以及对Hello World函数的单元测试，验证该函数是否返回“Hello World”字符串。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="00a2" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">Golang需要一个模块文件，告诉所有的代码依赖关系。创建一个GitHub存储库(但不要推送您的代码)，复制它的URL并运行以下命令:</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="e65c" class="ld le hi kz b fi lf lg l lh li">$ go mod init $"YOUR_GITHUB_URL"</span></pre><blockquote class="mn mo mp"><p id="412f" class="jj jk mq jl b jm jn ij jo jp jq im jr mr jt ju jv ms jx jy jz mt kb kc kd ke hb bi translated">应该是这样的:</p><p id="1676" class="jj jk mq jl b jm jn ij jo jp jq im jr mr jt ju jv ms jx jy jz mt kb kc kd ke hb bi translated"><code class="du mu mv mw kz b">$ go mod init github.com/leozz37/cicd-actions-cloud-run</code></p></blockquote><h2 id="798a" class="ld le hi bd lj lk ll lm ln lo lp lq lr js ls lt lu jw lv lw lx ka ly lz ma mb bi translated">码头工人</h2><p id="1d6d" class="pw-post-body-paragraph jj jk hi jl b jm mc ij jo jp md im jr js me ju jv jw mf jy jz ka mg kc kd ke hb bi translated">让我们为我们的代码写一个docker文件。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mh mi l"/></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">我使用了多级docker来缩小我们的图像。</figcaption></figure><p id="839f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">Cloud Run为端口设置了一个环境变量，他们建议你从环境中获取那个端口。但是如果需要的话可以设置自定义端口。</p><h2 id="ac12" class="ld le hi bd lj lk ll lm ln lo lp lq lr js ls lt lu jw lv lw lx ka ly lz ma mb bi translated">谷歌云运行</h2><p id="813e" class="pw-post-body-paragraph jj jk hi jl b jm mc ij jo jp md im jr js me ju jv jw mf jy jz ka mg kc kd ke hb bi translated">Google Cloud Run是一个完全托管的计算平台，用于快速部署和扩展容器化的应用程序。</p><p id="0fdc" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">要使用谷歌云平台，你需要一张有效的信用卡。你有三个月的免费试用期，任何服务都需要30万美元，但要使用它，你需要一个付费账户。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mx mi l"/></div></figure><p id="bbc1" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们可以用多种方式设置GCP，但在本教程中，我将使用CLI。请随意使用web控制台。您可以在此下载CLI:</p><div class="kg kh ez fb ki kj"><a href="https://cloud.google.com/sdk/docs/install" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">安装Google Cloud SDK | Cloud SDK文档</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">发送反馈此页面包含选择和维护云SDK安装的说明。如果你落后了…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">cloud.google.com</p></div></div><div class="ks l"><div class="my l ku kv kw ks kx jh kj"/></div></div></a></div><p id="4c9d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">为了使您的生活更容易，导出这些环境变量，以便您可以复制和粘贴这里使用的命令。选择您想要的任何名称，但是$PROJECT_ID必须是唯一的名称。</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="45ba" class="ld le hi kz b fi lf lg l lh li">export PROJECT_ID=<br/>export ACCOUNT_NAME=</span></pre><blockquote class="mn mo mp"><p id="46f5" class="jj jk mq jl b jm jn ij jo jp jq im jr mr jt ju jv ms jx jy jz mt kb kc kd ke hb bi translated">应该是这样的:</p><p id="228e" class="jj jk mq jl b jm jn ij jo jp jq im jr mr jt ju jv ms jx jy jz mt kb kc kd ke hb bi translated"><code class="du mu mv mw kz b"><em class="hi">$ export PROJECT_ID=project-example</em></code></p><p id="9eeb" class="jj jk mq jl b jm jn ij jo jp jq im jr mr jt ju jv ms jx jy jz mt kb kc kd ke hb bi translated"><code class="du mu mv mw kz b"><em class="hi">$ export ACCOUNT_NAME=account-example</em></code></p></blockquote><p id="1420" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在使用您的Google帐户登录，创建一个项目，并选择该项目:</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="4b69" class="ld le hi kz b fi lf lg l lh li">$ gcloud auth login</span><span id="8ca5" class="ld le hi kz b fi mz lg l lh li">$ gcloud projects create $PROJECT_ID</span><span id="7278" class="ld le hi kz b fi mz lg l lh li">$ gcloud config set project $PROJECT_ID</span></pre><p id="c9fe" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">为您的项目启用计费(如果您没有计费配置文件，请创建一个)，并启用我们将使用的服务:</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="dc60" class="ld le hi kz b fi lf lg l lh li">$ open "https://console.cloud.google.com/billing/linkedaccount?project=$PROJECT_ID"</span><span id="39b1" class="ld le hi kz b fi mz lg l lh li">$ gcloud services enable cloudbuild.googleapis.com run.googleapis.com containerregistry.googleapis.com</span></pre><p id="fd8c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们需要创建一个服务帐户，并为其提供云运行管理员、存储管理员和服务帐户用户角色(我们无法一次提供所有角色，因此您必须单独运行该命令三次)。</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="e999" class="ld le hi kz b fi lf lg l lh li">$ gcloud iam service-accounts create $ACCOUNT_NAME \<br/>    --description="Cloud Run deploy account" \<br/>    --display-name="Cloud-Run-Deploy"</span><span id="fdba" class="ld le hi kz b fi mz lg l lh li">$ gcloud projects add-iam-policy-binding $PROJECT_ID \<br/>--member=serviceAccount:$ACCOUNT_NAME@$PROJECT_ID.iam.gserviceaccount.com \<br/>    --role=roles/run.admin</span><span id="dd31" class="ld le hi kz b fi mz lg l lh li">$ gcloud projects add-iam-policy-binding $PROJECT_ID \<br/>--member=serviceAccount:$ACCOUNT_NAME@$PROJECT_ID.iam.gserviceaccount.com \<br/>    --role=roles/<em class="mq">storage</em>.<em class="mq">admin</em></span><span id="c948" class="ld le hi kz b fi mz lg l lh li">$gcloud projects add-iam-policy-binding $PROJECT_ID --member=serviceAccount:$ACCOUNT_NAME@$PROJECT_ID.iam.gserviceaccount.com \<br/>    --role=roles/iam.serviceAccountUser</span></pre><p id="1621" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们还需要用我们的凭证生成一个JSON文件，这样我们的GitHub工作流就可以认证进入GCP。</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="2467" class="ld le hi kz b fi lf lg l lh li">$ gcloud iam service-accounts keys create key.json \<br/>    --iam-account $ACCOUNT_NAME<a class="ae na" href="mailto:example-account@example-cicd.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">@</a>$PROJECT_ID<a class="ae na" href="mailto:example-account@example-cicd.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">.iam.gserviceaccount.com</a></span></pre><p id="2c27" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">它将使用您的凭据创建一个key.json文件，稍后我们将使用它的内容对GCP进行GitHub身份验证。</p><h2 id="092d" class="ld le hi bd lj lk ll lm ln lo lp lq lr js ls lt lu jw lv lw lx ka ly lz ma mb bi translated">开源代码库</h2><p id="40c0" class="pw-post-body-paragraph jj jk hi jl b jm mc ij jo jp md im jr js me ju jv jw mf jy jz ka mg kc kd ke hb bi translated">在GitHub上，我们需要在我们的存储库中设置一些秘密环境。它们是:</p><ul class=""><li id="664a" class="nb nc hi jl b jm jn jp jq js nd jw ne ka nf ke ng nh ni nj bi translated">GCP项目标识=这是你的$项目标识</li><li id="2e63" class="nb nc hi jl b jm nk jp nl js nm jw nn ka no ke ng nh ni nj bi translated">GCP应用名称=为你的应用选择一个名称</li><li id="a06d" class="nb nc hi jl b jm nk jp nl js nm jw nn ka no ke ng nh ni nj bi translated">GCP电子邮件=这是来自我们创建的服务帐户的电子邮件，如下所示:＄ACCOUNT _ NAME @＄PROJECT _ id . iam . gserviceaccount . com</li><li id="40ab" class="nb nc hi jl b jm nk jp nl js nm jw nn ka no ke ng nh ni nj bi translated">GPC_CREDENTIALS =这是我们刚刚创建的JSON(key . JSON)的内容</li></ul><blockquote class="mn mo mp"><p id="46df" class="jj jk mq jl b jm jn ij jo jp jq im jr mr jt ju jv ms jx jy jz mt kb kc kd ke hb bi translated">应该是这样的:</p><p id="1177" class="jj jk mq jl b jm jn ij jo jp jq im jr mr jt ju jv ms jx jy jz mt kb kc kd ke hb bi translated"><code class="du mu mv mw kz b">GCP_PROJECT_ID = <em class="hi">project-example</em></code></p><p id="c622" class="jj jk mq jl b jm jn ij jo jp jq im jr mr jt ju jv ms jx jy jz mt kb kc kd ke hb bi translated"><code class="du mu mv mw kz b"><em class="hi">GCP_APP_NAME = app-name</em></code></p><p id="f2f5" class="jj jk mq jl b jm jn ij jo jp jq im jr mr jt ju jv ms jx jy jz mt kb kc kd ke hb bi translated"><code class="du mu mv mw kz b"><em class="hi">GCP_EMAIL = account-name@project-example.iam.gserviceaccount.com</em></code></p></blockquote><p id="5c98" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">将key.json内容复制并粘贴到GCP _凭据秘密上。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es np"><img src="../Images/d28906405391bc13133f0ab4b5f8c6c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qZAkfDo-GSACm8WVj9tcQA.png"/></div></div></figure><p id="f30e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">你的秘密应该是这样的:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nq"><img src="../Images/75c862c312eb029a3fca760444d27a11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fmd1sEUWWD5sjcRIACX0lQ.png"/></div></div></figure><p id="dcf1" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在我们只需要创建一个yml文件，告诉我们的工作流应该运行哪些命令。在您的项目目录中，创建一个名为。github”并在其中创建另一个名为“workflows”的应用程序。</p><p id="29fb" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">创建一个“GCP-部署. yml”文件，并将以下内容复制到其中:</p><p id="53bf" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">你的工作树应该是这样的:</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="ac29" class="ld le hi kz b fi lf lg l lh li">|_.github/<br/>  |_workflows/<br/>    |_GCP-Deploy.yml</span></pre><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mh mi l"/></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">如果您的应用程序需要特定的端口，请在“部署Docker映像”步骤中传递<code class="du mu mv mw kz b">--port</code>参数。</figcaption></figure><p id="b62d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在提交你所有的修改并推送到GitHub，然后进入你的库主页。当您的构建运行时，您应该会在文件列表上看到一个黄色的球:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nr"><img src="../Images/73cd9e4d1949db7eb2ec1ed5d7e6f4b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n3BmwbhBCzut7nETE7iseQ.png"/></div></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">(您的存储库可能不是这样的)</figcaption></figure><p id="e53d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果你进入你的行动(点击黄色球)，你可以实时看到你正在执行的步骤:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ns"><img src="../Images/49765dd573cc73ad529c7dfe74f74294.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uD0YTGx8xkc5WcfwDNtVrw.png"/></div></div></figure><p id="bd06" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">您可以列出您的服务并获取其链接，然后在浏览器上访问它:</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="46aa" class="ld le hi kz b fi lf lg l lh li">$ gcloud run services list</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nt"><img src="../Images/5114ff179b68e8e1185389e631bc6cf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*NLUkADHuLWGpCJkBcUO9iA.png"/></div></figure><p id="92c5" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">就是这样！现在你对你的项目所做的每一个改变，并把它推送到主分支，GitHub会自动构建、测试和部署它。</p></div></div>    
</body>
</html>