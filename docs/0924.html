<html>
<head>
<title>How To Control Access To BigQuery At Row Level With Groups</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用组在行级别控制对BigQuery的访问</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-control-access-to-bigquery-at-row-level-with-groups-1cbccb111d9e?source=collection_archive---------1-----------------------#2019-02-19">https://medium.com/google-cloud/how-to-control-access-to-bigquery-at-row-level-with-groups-1cbccb111d9e?source=collection_archive---------1-----------------------#2019-02-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="df54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">更新2021–06–25:</em></strong><em class="jd">big query现在有原生的</em> <a class="ae je" href="https://cloud.google.com/bigquery/docs/row-level-security-intro" rel="noopener ugc nofollow" target="_blank"> <em class="jd">行级安全</em> </a> <em class="jd">功能。在使用本文描述的技术之前，您应该检查一下这一点。</em></p><h1 id="e562" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">介绍</h1><p id="8f59" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">BigQuery是一个无服务器、高度可伸缩的数据仓库系统，为各种用例提供了巨大的灵活性。BigQuery有一个基于<a class="ae je" href="https://cloud.google.com/iam/" rel="noopener ugc nofollow" target="_blank"> Google Cloud的IAM </a>功能的安全模型，这让管理员可以通过角色、组和个人用户来控制对数据集的访问。</p><p id="97b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，在某些用例中，可能有必要在比数据集更细粒度的级别上控制对数据的访问。例如，不同的用户可能需要访问表中行的不同子集。对于这种情况，BigQuery具有<a class="ae je" href="https://cloud.google.com/bigquery/docs/share-access-views" rel="noopener ugc nofollow" target="_blank">授权视图</a>功能，允许您授予对数据集的视图访问权，而不是像组那样的IAM实体。然后，该视图可以实现任何必要的过滤器，并与最终用户共享，最终用户只能查看过滤后的数据。</p><p id="40a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在GCP中设置访问控制的一种常见(推荐)方法是将用户添加到组中，并向这些组授予权限。通常，组织已经为其他资源这样做了，并在他们的G Suite管理或公司LDAP系统中保持组成员的更新。本文解释了如何通过Google Groups和G Suite Admin API(或云身份API)将这个组成员数据与授权视图集成，以便创建基于组的行级访问控制方案。</p><h1 id="7d26" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">体系结构</h1><p id="b3cf" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">为了同步组成员，我们将同时使用<a class="ae je" href="https://developers.google.com/admin-sdk/directory/" rel="noopener ugc nofollow" target="_blank"> G套件管理目录API </a>(或<a class="ae je" href="https://cloud.google.com/identity/docs/" rel="noopener ugc nofollow" target="_blank">云身份API </a>)和<a class="ae je" href="https://cloud.google.com/bigquery/docs/reference/rest/v2/" rel="noopener ugc nofollow" target="_blank">大查询API </a>。Google Cloud函数将被安排执行定期同步，用所有组成员填充BigQuery表。然后创建一个授权视图，将组成员资格与业务数据表连接起来。下图显示了它的工作原理:</p><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es ki"><img src="../Images/51596bfab2e27bf49910dac27db3309c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/0*Qs9sAqyfNz5oJgGY"/></div></figure><h1 id="82ec" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">先决条件</h1><p id="9cea" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">您将需要一个启用了以下API的GCP项目:</p><ul class=""><li id="c1a7" class="kq kr hi ih b ii ij im in iq ks iu kt iy ku jc kv kw kx ky bi translated"><a class="ae je" href="https://console.cloud.google.com/apis/library/bigquery-json.googleapis.com" rel="noopener ugc nofollow" target="_blank"> BigQuery API </a></li><li id="e6c3" class="kq kr hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated"><a class="ae je" href="https://console.cloud.google.com/apis/library/cloudfunctions.googleapis.com" rel="noopener ugc nofollow" target="_blank">云函数API </a></li><li id="a828" class="kq kr hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated"><a class="ae je" href="https://console.cloud.google.com/apis/library/cloudscheduler.googleapis.com" rel="noopener ugc nofollow" target="_blank">云调度API </a></li><li id="aa1a" class="kq kr hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated"><a class="ae je" href="https://console.cloud.google.com/apis/library/admin.googleapis.com" rel="noopener ugc nofollow" target="_blank">管理软件开发套件</a></li><li id="9f25" class="kq kr hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated"><a class="ae je" href="https://console.cloud.google.com/apis/library/cloudidentity.googleapis.com" rel="noopener ugc nofollow" target="_blank">云身份API </a></li></ul><p id="65e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还需要一个G Suite或云身份组织，并拥有对这两者的管理权限。</p><h1 id="874f" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">设置</h1><p id="ff6b" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">为了自动化这个过程并访问管理API，您需要做的第一件事是创建一个允许模拟G Suite管理员用户的服务帐户，这在GCP的说法中称为“Google Apps域范围委托”。</p><p id="354f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先创建一个服务帐户:</p><ol class=""><li id="496e" class="kq kr hi ih b ii ij im in iq ks iu kt iy ku jc le kw kx ky bi translated">打开<a class="ae je" href="https://console.developers.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank">服务账户页面</a>。如果出现提示，请选择一个项目。</li><li id="e03c" class="kq kr hi ih b ii kz im la iq lb iu lc iy ld jc le kw kx ky bi translated">点击<strong class="ih hj">创建服务账户</strong>。</li><li id="00d5" class="kq kr hi ih b ii kz im la iq lb iu lc iy ld jc le kw kx ky bi translated">在创建服务帐户窗口中，键入服务帐户的名称，并选择<strong class="ih hj">启用Google Apps全域委托</strong>。然后单击保存。</li></ol><p id="1e81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您需要通过以下步骤授权此服务帐户访问您的G Suite/Cloud身份域:</p><ol class=""><li id="9c1d" class="kq kr hi ih b ii ij im in iq ks iu kt iy ku jc le kw kx ky bi translated">转到您的G Suite域的<a class="ae je" href="http://admin.google.com/" rel="noopener ugc nofollow" target="_blank">管理控制台</a>。</li><li id="eaea" class="kq kr hi ih b ii kz im la iq lb iu lc iy ld jc le kw kx ky bi translated">从控制列表中选择<strong class="ih hj">安全</strong>。如果您没有看到安全列表，请从页面底部的灰色栏中选择<strong class="ih hj">更多控制</strong>，然后从控制列表中选择安全。</li><li id="6a46" class="kq kr hi ih b ii kz im la iq lb iu lc iy ld jc le kw kx ky bi translated">从选项列表中选择<strong class="ih hj">高级设置</strong>。</li><li id="552d" class="kq kr hi ih b ii kz im la iq lb iu lc iy ld jc le kw kx ky bi translated">在<strong class="ih hj">认证</strong>部分选择<strong class="ih hj">管理API客户端访问</strong>。</li><li id="433d" class="kq kr hi ih b ii kz im la iq lb iu lc iy ld jc le kw kx ky bi translated">在<strong class="ih hj">客户端名称</strong>字段中输入服务帐户的客户端ID。</li><li id="2c71" class="kq kr hi ih b ii kz im la iq lb iu lc iy ld jc le kw kx ky bi translated">在<strong class="ih hj">一个或多个API范围</strong>字段中输入这些范围之一:<a class="ae je" href="https://www.googleapis.com/auth/admin.directory.group" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/admin.directory.group</a>用于G Suite管理目录API (Google Groups)或<a class="ae je" href="https://www.googleapis.com/auth/cloud-identity.groups.readonly" rel="noopener ugc nofollow" target="_blank">https://www . Google API . com/auth/Cloud-Identity . Groups . readonly</a>用于云身份API</li><li id="a6e7" class="kq kr hi ih b ii kz im la iq lb iu lc iy ld jc le kw kx ky bi translated">点击<strong class="ih hj">授权</strong>按钮。</li></ol><p id="42db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我们开始使用命令行的地方，所以让我们定义一些我们需要的变量:</p><pre class="kj kk kl km fd lf lg lh li aw lj bi"><span id="e87b" class="lk jg hi lg b fi ll lm l ln lo">export PROJECT_ID= # your project id</span><span id="c260" class="lk jg hi lg b fi lp lm l ln lo">export REGION= # your region, e.g. us-central1</span><span id="fc47" class="lk jg hi lg b fi lp lm l ln lo">export SERVICE_ACCOUNT_USERNAME= # service account you created above</span><span id="bd32" class="lk jg hi lg b fi lp lm l ln lo">export SERVICE_ACCOUNT=$SERVICE_ACCOUNT_USERNAME@$PROJECT_ID.iam.gserviceaccount.com</span></pre><p id="7c5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">服务帐户还需要使用BigQuery和颁发身份验证令牌的权限。您可以使用以下命令授予这些角色:</p><pre class="kj kk kl km fd lf lg lh li aw lj bi"><span id="5257" class="lk jg hi lg b fi ll lm l ln lo">gcloud projects add-iam-policy-binding $PROJECT_ID \</span><span id="9fbf" class="lk jg hi lg b fi lp lm l ln lo"> --member serviceAccount:$SERVICE_ACCOUNT \</span><span id="ca49" class="lk jg hi lg b fi lp lm l ln lo"> --role roles/bigquery.user</span><span id="52a9" class="lk jg hi lg b fi lp lm l ln lo">gcloud projects add-iam-policy-binding $PROJECT_ID \</span><span id="b0cd" class="lk jg hi lg b fi lp lm l ln lo"> --member serviceAccount:$SERVICE_ACCOUNT \</span><span id="78df" class="lk jg hi lg b fi lp lm l ln lo"> --role roles/iam.serviceAccountTokenCreator</span></pre><p id="b9f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们来看将执行所有魔术的<a class="ae je" href="https://github.com/GoogleCloudPlatform/professional-services/tree/master/examples/bigquery-row-access-groups" rel="noopener ugc nofollow" target="_blank">实际代码。首先，检查代码:</a></p><pre class="kj kk kl km fd lf lg lh li aw lj bi"><span id="76a5" class="lk jg hi lg b fi ll lm l ln lo">git clone git@github.com:GoogleCloudPlatform/professional-services.git</span></pre><p id="8c81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，用文本编辑器打开<code class="du lq lr ls lg b">main.py</code>，更新以下变量的值以反映您的环境:</p><pre class="kj kk kl km fd lf lg lh li aw lj bi"><span id="b248" class="lk jg hi lg b fi ll lm l ln lo">DOMAIN = # Your G Suite/Cloud Identity domain, e.g. 'cbcloudtest.com'</span><span id="b32e" class="lk jg hi lg b fi lp lm l ln lo">ADMIN_EMAIL = # The email of a domain administrator, e.g. 'admin@cbcloudtest.com'</span><span id="7ad8" class="lk jg hi lg b fi lp lm l ln lo">DATASET = # The name of a dataset that will be created to hold the user mapping table, e.g. 'bq_iam'</span><span id="570c" class="lk jg hi lg b fi lp lm l ln lo">GROUPS_USERS_TABLE_NAME = # Name to give the user mapping table, e.g. 'groups_users'</span></pre><p id="ee8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，代码准备使用G Suite API。如果您使用的是云身份，那么您需要在脚本<code class="du lq lr ls lg b">group_sync.py</code>中修改几行代码。打开文件，查找以“For Cloud Identity”开头的注释，这表示需要更改的行。</p><p id="8129" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一步是通过运行以下代码将代码部署为云函数:</p><pre class="kj kk kl km fd lf lg lh li aw lj bi"><span id="0b2e" class="lk jg hi lg b fi ll lm l ln lo">gcloud beta functions deploy sync_groups \</span><span id="4393" class="lk jg hi lg b fi lp lm l ln lo"> --project $PROJECT_ID \</span><span id="ca6b" class="lk jg hi lg b fi lp lm l ln lo"> --runtime python37 \</span><span id="b5cc" class="lk jg hi lg b fi lp lm l ln lo"> --trigger-http \</span><span id="cf4c" class="lk jg hi lg b fi lp lm l ln lo"> --timeout 300 \</span><span id="0c11" class="lk jg hi lg b fi lp lm l ln lo"> --service-account $SERVICE_ACCOUNT</span></pre><p id="5c77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，您可以使用<code class="du lq lr ls lg b">gcloud functions run sync_groups</code>手动运行该功能。在if完成之后，您应该能够看到用BigQuery中的数据填充的新数据集和表:</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es lt"><img src="../Images/64682bbe43ce6080ffabe49ad813eeda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b5uz3bDnsyJwBGQO"/></div></div></figure><p id="e627" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您对结果满意时，您可以安排该功能定期进行同步。您可以运行以下命令来调度它，根据<a class="ae je" href="https://en.wikipedia.org/wiki/Cron#Overview" rel="noopener ugc nofollow" target="_blank"> crontab格式</a>根据您的需要调整<code class="du lq lr ls lg b">— schedule</code>参数:</p><pre class="kj kk kl km fd lf lg lh li aw lj bi"><span id="3a00" class="lk jg hi lg b fi ll lm l ln lo">gcloud beta scheduler jobs create http group_sync \</span><span id="268b" class="lk jg hi lg b fi lp lm l ln lo"> --project $PROJECT_ID \</span><span id="ad57" class="lk jg hi lg b fi lp lm l ln lo"> --schedule=”11 * * * *” \</span><span id="3052" class="lk jg hi lg b fi lp lm l ln lo"> --uri=https://$REGION-$PROJECT_ID.cloudfunctions.net/group_sync \</span><span id="11a4" class="lk jg hi lg b fi lp lm l ln lo"> --description=”Synchronizes group membership between G Suite and BigQuery”</span></pre><h1 id="a907" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">创建过滤视图</h1><p id="f49b" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">既然已经在BigQuery中拥有了组成员资格数据，就可以开始将它与您自己的业务表连接起来，以便为每个用户进行适当的过滤。</p><p id="4d2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设您有一个包含客户数据的下表，并且您希望将某个分析师可以访问的数据限制在他们自己的地理区域内:</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es ly"><img src="../Images/5ff928d51621dbaba6cf945e2483c7e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1RbwyYZeutGRc1W_oChZiA.png"/></div></div></figure><p id="9aa8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，假设您的组成员表如下所示:</p><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es lz"><img src="../Images/13f270f0e458b77a162e7a7652315f12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*lBXR7hD3B7NidUVJDyaWnQ.png"/></div></figure><p id="a99c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了对每个用户应用合适的过滤器，您需要使用<a class="ae je" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/security_functions#session_user" rel="noopener ugc nofollow" target="_blank"> SESSION_USER </a>函数。这个函数总是返回当前登录的Google帐户的电子邮件。</p><p id="d598" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以<a class="ae je" href="https://cloud.google.com/bigquery/docs/share-access-views" rel="noopener ugc nofollow" target="_blank">使用以下查询(在标准SQL中)创建一个授权视图</a>:</p><pre class="kj kk kl km fd lf lg lh li aw lj bi"><span id="e6c6" class="lk jg hi lg b fi ll lm l ln lo">SELECT c.customer_name, c.customer_id</span><span id="1740" class="lk jg hi lg b fi lp lm l ln lo">FROM private.customers c</span><span id="e82e" class="lk jg hi lg b fi lp lm l ln lo">JOIN <strong class="lg hj">user_groups</strong> g</span><span id="5419" class="lk jg hi lg b fi lp lm l ln lo">  ON <strong class="lg hj">SESSION_USER()</strong> = g.user_id</span><span id="20ef" class="lk jg hi lg b fi lp lm l ln lo">WHERE c.country IN (</span><span id="e84c" class="lk jg hi lg b fi lp lm l ln lo">  CASE</span><span id="735a" class="lk jg hi lg b fi lp lm l ln lo">    WHEN g.group='analysts_br' THEN 'br'</span><span id="3da8" class="lk jg hi lg b fi lp lm l ln lo">    WHEN g.group='analysts_ca' THEN 'ca'</span><span id="4364" class="lk jg hi lg b fi lp lm l ln lo">    WHEN g.group='analysts_us' THEN 'us'</span><span id="c34b" class="lk jg hi lg b fi lp lm l ln lo">  END</span><span id="38d6" class="lk jg hi lg b fi lp lm l ln lo">)</span></pre><p id="338b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以授予用户对该视图的访问权限，而不是对原始表的访问权限，用户将只能查看他们有权查看的数据。</p><h1 id="d86a" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">限制</h1><p id="7b3a" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">使用这种技术时，有几个方面需要记住。</p><p id="69ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，它只适用于原生BigQuery表，其数据存储在BigQuery中。对于联合源，即从GCS或其他数据库提取数据的源，执行查询的用户需要能够访问底层资源，这在这种情况下会违背目的。</p><p id="def6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一个重要的限制是，由于<code class="du lq lr ls lg b">SESSION_USER </code>函数是不确定的，BigQuery不会缓存这些视图上的查询结果，这可能会影响成本。</p><h1 id="d151" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">相关著作</h1><p id="7aac" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">另请查看<a class="ae je" rel="noopener" href="/google-cloud/share-data-with-confidence-cell-level-access-controls-in-bigquery-and-data-studio-cf753fa173a4">论文</a>文章，该文章展示了一套全面的技术来控制对BigQuery数据的访问，给出了用户权限的映射。</p></div><div class="ab cl ma mb gp mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hb hc hd he hf"><p id="48d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">特别感谢“Woogie”Wolgemuth贡献了验证码，感谢Jake Ferriero审阅了验证码和文章，感谢edu·马雷托提供了文章输入。</em></p></div></div>    
</body>
</html>