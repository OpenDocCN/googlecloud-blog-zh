<html>
<head>
<title>Writing to Google Sheets from Workflows</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从工作流写入Google工作表</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/writing-to-google-sheets-from-workflows-eb5876a7b6f9?source=collection_archive---------2-----------------------#2022-09-26">https://medium.com/google-cloud/writing-to-google-sheets-from-workflows-eb5876a7b6f9?source=collection_archive---------2-----------------------#2022-09-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="579c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我之前的<a class="ae jd" href="https://atamel.dev/posts/2022/09-09_trigger_workflows_from_sheets/" rel="noopener ugc nofollow" target="_blank">帖子</a>中，我展示了如何使用Apps脚本从Google Sheets电子表格触发Google Cloud中的工作流。在这篇文章中，我展示了如何反向操作:从Google Cloud中的一个工作流写入Google Sheets。</p><h1 id="a3d6" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">用例</h1><p id="c98b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">假设您在BigQuery中有一些数据集。您希望定期查询和提取数据集的子集，并将其保存到Google Sheets电子表格中。您可以很容易地用工作流实现这样的过程。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/cdf37cfcbdba44214eb49f0c1826dc60.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/0*3_tDZRUKUThSMSK5.png"/></div></figure><p id="661c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面我们来详细看一下步骤。</p><h1 id="c1c1" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">在Google Sheets中创建电子表格</h1><p id="4884" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">首先，在Google Sheets中创建一个电子表格，工作流会将结果写入其中。</p><p id="62e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建工作表后，记下电子表格id；稍后您将在工作流中需要它。您可以在电子表格的url中找到工作表id:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es kp"><img src="../Images/d2c0048db75390c1606ad6a7c7d37a66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*N70UN7f5q3qZndbt.png"/></div></div></figure><p id="4a3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为简单起见，您将使用默认的计算服务帐户部署工作流。在Google Cloud Console的<code class="du ku kv kw kx b">IAM &amp; Admin</code>-&gt;-<code class="du ku kv kw kx b">Service Accounts</code>部分找到这个服务账号的邮箱地址:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es ky"><img src="../Images/f13beb24ed01fd93cedeb1a443e81668.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MYu6Lc2mQtuh5Hmh.png"/></div></div></figure><p id="0624" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确定此服务帐户拥有电子表格的写入权限:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es kz"><img src="../Images/d03039852799d51269f6e7ebc887a7a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*55ODOwy2K0WLCA9T.png"/></div></div></figure><h1 id="2276" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">探索公共BigQuery数据集</h1><p id="b78f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">对于此示例，您将使用<code class="du ku kv kw kx b">usa_names.usa_1910_2013</code>公共BigQuery数据集，其中包含1910年至2013年美国个人的信息。</p><p id="dc47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以看到该查询的前100行:</p><pre class="ki kj kk kl fd la kx lb lc aw ld bi"><span id="0ea6" class="le jf hi kx b fi lf lg l lh li">SELECT *<br/>FROM `bigquery-public-data.usa_names.usa_1910_2013`<br/>LIMIT 100</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es lj"><img src="../Images/77c77dc9cf88d48c5296c879fbe44870.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s7fpiKu8nYsLwiHD.png"/></div></div></figure><p id="25ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过以下查询找到100个最受欢迎的名字:</p><pre class="ki kj kk kl fd la kx lb lc aw ld bi"><span id="7176" class="le jf hi kx b fi lf lg l lh li">SELECT name, gender, SUM(number) AS total<br/>FROM `bigquery-public-data.usa_names.usa_1910_2013`<br/>GROUP BY name, gender<br/>ORDER BY total DESC<br/>LIMIT 100</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es lk"><img src="../Images/79cb7b53027e2be5717f32da3d7e328c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PO9Wm1E66VX47gad.png"/></div></div></figure><p id="4e0e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是您将在示例工作流中使用的查询。</p><h1 id="57a3" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">创建工作流</h1><p id="d67d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">创建一个<a class="ae jd" href="https://github.com/GoogleCloudPlatform/workflows-demos/blob/master/workspace-integration/workflows-to-sheets/workflow.yaml" rel="noopener ugc nofollow" target="_blank"> workflow.yaml </a>从BigQuery公共数据集中找到最流行的名字，并写入Google Sheets中的电子表格。</p><p id="e7c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，定义您的工作表id和限制:</p><pre class="ki kj kk kl fd la kx lb lc aw ld bi"><span id="f542" class="le jf hi kx b fi lf lg l lh li">main:<br/>    steps:<br/>    - init:<br/>        assign:<br/>        # Replace with your sheetId and make sure the service account<br/>        # for the workflow has write permissions to the sheet<br/>        - sheetId: "1D8n7uoU8kGwQvR4rcLkF10CdAfnUKE2o0yl6P-Z7nfM"<br/>        - limit: 100</span></pre><p id="703a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对BigQuery公共数据集运行查询:</p><pre class="ki kj kk kl fd la kx lb lc aw ld bi"><span id="9de4" class="le jf hi kx b fi lf lg l lh li">- runQuery:<br/>        call: googleapis.bigquery.v2.jobs.query<br/>        args:<br/>            projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}<br/>            body:<br/>                useLegacySql: false<br/>                # Query name and gender of most popular names<br/>                query: ${"SELECT name, gender, SUM(number) AS total<br/>                    FROM `bigquery-public-data.usa_names.usa_1910_2013`<br/>                    GROUP BY name, gender<br/>                    ORDER BY total DESC<br/>                    LIMIT " + limit}<br/>        result: queryResult</span></pre><p id="b4b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">初始化行列表，解析查询结果，并将每一行插入行列表:</p><pre class="ki kj kk kl fd la kx lb lc aw ld bi"><span id="9b98" class="le jf hi kx b fi lf lg l lh li">- init_header_row:<br/>        assign:<br/>        - rows:<br/>            - ["Name", "Gender", "Total"]<br/>    - process_query_result:<br/>        for:<br/>            value: row<br/>            in: ${queryResult.rows}<br/>            steps:<br/>            - process_each_row:<br/>                assign:<br/>                - name: ${row.f[0].v}<br/>                - gender: ${row.f[1].v}<br/>                - total: ${row.f[2].v}<br/>                - row: ["${name}", "${gender}", "${total}"]<br/>                - rows: ${list.concat(rows, row)}</span></pre><p id="126a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，清除电子表格中的任何现有值，并使用工作流的<a class="ae jd" href="https://cloud.google.com/workflows/docs/reference/googleapis/sheets/Overview" rel="noopener ugc nofollow" target="_blank"> Google Sheets API连接器</a>插入行:</p><pre class="ki kj kk kl fd la kx lb lc aw ld bi"><span id="e57e" class="le jf hi kx b fi lf lg l lh li">- clear_existing_values:<br/>        call: googleapis.sheets.v4.spreadsheets.values.clear<br/>        args:<br/>            range: "Sheet1"<br/>            spreadsheetId: ${sheetId}<br/>        result: clearResult<br/>    - update_sheet:<br/>        call: googleapis.sheets.v4.spreadsheets.values.update<br/>        args:<br/>            range: ${"Sheet1!A1:C" + (limit + 1)}<br/>            spreadsheetId: ${sheetId}<br/>            valueInputOption: RAW<br/>            body:<br/>                majorDimension: "ROWS"<br/>                values: ${rows}<br/>        result: updateResult<br/>    - returnResult:<br/>        return: ${updateResult}</span></pre><h1 id="819b" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">部署工作流</h1><p id="0d9f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">确保您有一个Google Cloud项目，并且项目id在<code class="du ku kv kw kx b">gcloud</code>中设置:</p><pre class="ki kj kk kl fd la kx lb lc aw ld bi"><span id="1310" class="le jf hi kx b fi lf lg l lh li">PROJECT_ID =your-project-id<br/>gcloud config set project $PROJECT_ID</span></pre><p id="0e82" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行一个<a class="ae jd" href="https://github.com/GoogleCloudPlatform/workflows-demos/blob/master/workspace-integration/workflows-to-sheets/setup.sh" rel="noopener ugc nofollow" target="_blank"> setup.sh </a>脚本来启用所需的服务，并使用默认的计算服务帐户部署<a class="ae jd" href="https://github.com/GoogleCloudPlatform/workflows-demos/blob/master/workspace-integration/workflows-to-sheets/workflow.yaml" rel="noopener ugc nofollow" target="_blank"> workflow.yaml </a>中定义的工作流。</p><h1 id="d2a6" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">运行工作流程</h1><p id="471d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">您现在已经准备好测试工作流了。</p><p id="8e91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从谷歌云控制台或<code class="du ku kv kw kx b">gcloud</code>运行工作流:</p><pre class="ki kj kk kl fd la kx lb lc aw ld bi"><span id="be79" class="le jf hi kx b fi lf lg l lh li">gcloud workflows run read-bigquery-write-sheets</span></pre><p id="abf2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几秒钟后，您应该会看到工作流执行已经完成，并且电子表格中有来自BigQuery数据集的查询结果:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es ll"><img src="../Images/ca8d6d1ebd39b98cbd8c4988ea6da36e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1356/format:webp/0*nyUfhF7faMJJmGHY.png"/></div></figure></div><div class="ab cl lm ln gp lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="hb hc hd he hf"><p id="ace5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这只是如何使用<a class="ae jd" href="https://cloud.google.com/workflows/docs/reference/googleapis/sheets/Overview" rel="noopener ugc nofollow" target="_blank"> Google Sheets API连接器</a>从工作流写入Google Sheets的一个例子。您还可以使用<a class="ae jd" href="https://cloud.google.com/workflows/docs/reference/googleapis/forms/Overview" rel="noopener ugc nofollow" target="_blank"> Google Forms API连接器</a>，它提供了工作流和Google Forms之间简单有趣的集成机会，以及一整套<a class="ae jd" href="https://developers.google.com/workspace/products#toc" rel="noopener ugc nofollow" target="_blank">Google Workspace REST API</a>，即使没有连接器，您也可以相对容易地从工作流中调用它们。</p><p id="4b8f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如有任何问题或反馈，请随时在Twitter <a class="ae jd" href="https://twitter.com/meteatamel" rel="noopener ugc nofollow" target="_blank"> @meteatamel </a>上联系我。</p></div><div class="ab cl lm ln gp lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="hb hc hd he hf"><p id="2d98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lt">最初发布于</em><a class="ae jd" href="https://atamel.dev/posts/2022/09-26_writing_google_sheets_from_workflows/" rel="noopener ugc nofollow" target="_blank"><em class="lt">https://atamel . dev</em></a><em class="lt">。</em></p></div></div>    
</body>
</html>