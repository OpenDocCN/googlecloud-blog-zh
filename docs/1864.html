<html>
<head>
<title>Automated, Static, re-ip of GCP Windows VM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP Windows虚拟机的自动化、静态、重新ip化</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/automated-static-re-ip-of-gcp-windows-vm-a30821b629f5?source=collection_archive---------1-----------------------#2021-04-26">https://medium.com/google-cloud/automated-static-re-ip-of-gcp-windows-vm-a30821b629f5?source=collection_archive---------1-----------------------#2021-04-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="de6d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">问题陈述</h1><p id="b074" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">让我们把场景设在这里。您有一个实例被配置为在GCP地区使用静态IP地址。您的灾难恢复策略是在生产区域创建实例的映像，并在灾难恢复区域恢复它。生产子网和灾难恢复子网是不同的。</p><p id="df0d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">当您从该映像创建实例时，在模拟灾难恢复事件(希望是模拟)的过程中，您会惊恐地发现该实例无法在网络上通信，因为它被设置为原始静态ip地址，该地址不在它被恢复到的子网范围内。</p><p id="5307" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这引发了许多话题，我不会在这里深入探讨。</p><ol class=""><li id="7061" class="kg kh hi jf b jg kb jk kc jo ki js kj jw kk ka kl km kn ko bi translated">请使用DHCP，以便云平台可以接管IP地址的分配，即使是“静态”的。</li><li id="64d1" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka kl km kn ko bi translated">创建映像是合适的备份方法吗？</li></ol><h1 id="f90b" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">我们如何解决这个问题？</h1><p id="1557" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">GCP上的实例有一个“来宾环境”。这些默认安装在所有谷歌提供的公共图像上。来宾环境是一组脚本、守护程序和二进制文件，它们读取元数据服务器的内容，以使虚拟机在计算引擎上正常运行。<a class="ae ku" href="https://cloud.google.com/compute/docs/storing-retrieving-metadata" rel="noopener ugc nofollow" target="_blank">元数据服务器</a>是用于将信息从客户端传输到客户操作系统的通信通道。</p><p id="3b4c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><a class="ae ku" href="https://cloud.google.com/compute/docs/images/guest-environment" rel="noopener ugc nofollow" target="_blank">这里有一个链接</a>，可以获得更多关于游客环境的信息。我们将广泛使用元数据服务器将所需的指标传递到虚拟机，以促进切换到新的静态IP地址的过程。</p><p id="6bcd" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">如果您愿意，可以更深入地研究代码。<a class="ae ku" href="https://github.com/GoogleCloudPlatform/compute-image-windows" rel="noopener ugc nofollow" target="_blank">这里有一个到github repo的链接</a>，它包含了主要在powershell中的windows代码。它包含可调用的函数，您可以利用这些函数来访问windows注册表、文件系统和GCP库，例如<a class="ae ku" href="https://cloud.google.com/deployment-manager/runtime-configurator" rel="noopener ugc nofollow" target="_blank">运行时配置器</a>。运行时配置器也是另一篇文章的主题，但是它可以帮助您同步环境的部署，以便在创建下一波基础设施时，所有的依赖项都已就绪。</p><p id="8472" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">回到手头的任务。这些如何帮助我们用新的静态IP部署一个实例？GCP允许启动脚本运行，当一台机器启动时，非常好地记录<a class="ae ku" href="https://cloud.google.com/compute/docs/startupscript" rel="noopener ugc nofollow" target="_blank">在这里</a>。它们可以在云控制台、gcloud命令行工具或REST API中提供。</p><p id="9535" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">它们可以传入:</p><ol class=""><li id="f9cc" class="kg kh hi jf b jg kb jk kc jo ki js kj jw kk ka kl km kn ko bi translated">直接地</li><li id="82c8" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka kl km kn ko bi translated">作为谷歌云存储中文件的路径</li><li id="ad98" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka kl km kn ko bi translated">作为本地文件的路径</li></ol><p id="3068" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">下表解释了时间和方式:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/737a8c8861860787baef6f012bf9b068.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3KybXA0jt7_bNdJExS4E8A.png"/></div></div></figure><p id="0eb6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">使用Powershell是因为它的丰富性，并且您需要它在sysprep完成后运行，因此将输入的用于标识脚本的元数据键是<strong class="jf hj"> windows-startup-script-ps1。</strong>这将指向一个本地Powershell文件，该文件将在第一次引导时以提升的管理员身份执行。它将在每次后续引导时运行，因此您需要在第一次也是唯一一次执行后将其从元数据服务器中删除。</p><h1 id="a585" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">获取脚本的参数</h1><p id="617d" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">要使用新的IP地址设置实例，您需要提供以下信息:</p><ul class=""><li id="70a1" class="kg kh hi jf b jg kb jk kc jo ki js kj jw kk ka lh km kn ko bi translated">IP地址</li><li id="6882" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka lh km kn ko bi translated">门</li></ul><p id="86ed" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">要将它们传递到启动时以管理员身份运行的脚本中，请将它们放在元数据中。</p><h2 id="bb22" class="li ig hi bd ih lj lk ll il lm ln lo ip jo lp lq it js lr ls ix jw lt lu jb lv bi translated">向实例添加元数据</h2><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lw"><img src="../Images/63a4d40dde134f2effe405cb5a4f2136.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yt22SciUVJekb2bTq5uGcw.png"/></div></div></figure><p id="1325" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">gcloud命令的解释</p><ul class=""><li id="95bb" class="kg kh hi jf b jg kb jk kc jo ki js kj jw kk ka lh km kn ko bi translated">我们使用的是gcloud beta，所以我们可以直接从机器映像创建一个实例</li><li id="901f" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka lh km kn ko bi translated">我们传入IP和网关</li><li id="79ce" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka lh km kn ko bi translated">metadata-from-file参数在运行gcloud的实例上查找本地文件。该路径可以相对于您的工作目录。</li></ul><p id="a74e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">注意:还可以使用以下命令向正在运行的实例添加任何随机元数据:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lx"><img src="../Images/01c8f2fba2079040580ee6e9aa5b2d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aJFy559mkL5w3H0PJxPAUw.png"/></div></div></figure><p id="6ed4" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这不在本文讨论范围之内，但是您可以将脚本添加到一个正在运行的实例中，重新启动，它会改变它的ip地址。</p><h1 id="92cb" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">从脚本访问实例元数据</h1><p id="9c5b" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">您需要在脚本“windows-set-static.ps1”中获取“ipaddr”和“gateway”的元数据。</p><p id="d8e6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在powershell脚本中从元数据中获取这些值的命令如下:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ly"><img src="../Images/92334ae7549d1aafd826238ae5395630.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kCDLb8mJKT9mBaci_HkHHw.png"/></div></div></figure><p id="530c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">注:169.254.169.254是安装了<a class="ae ku" href="https://cloud.google.com/compute/docs/images/guest-environment" rel="noopener ugc nofollow" target="_blank">客户环境</a>的本地元数据服务器的地址。</p><p id="772e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">从实例元数据中删除脚本的命令在最后完成，以防止后续执行:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lz"><img src="../Images/a3ece341bf7fa2b74288a82d45c9269e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VWeik_MI_G0agXBUV7ZX2A.png"/></div></div></figure><p id="446c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">Powershell脚本</strong></p><p id="098f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">脚本可以在这里找到:<a class="ae ku" href="https://github.com/barry-searle/win-crossregion-reip" rel="noopener ugc nofollow" target="_blank">链接</a></p><p id="3155" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">实例使用原始ip地址启动，该地址位于它无法通信的子网上。要解决这个问题，您需要:</p><ul class=""><li id="2447" class="kg kh hi jf b jg kb jk kc jo ki js kj jw kk ka lh km kn ko bi translated">启用DHCP，以便它用本地IP地址和网关刷新NIC</li><li id="7c70" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka lh km kn ko bi translated">将适配器设置回静态</li><li id="c9d3" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka lh km kn ko bi translated">添加带有新ip地址和网关的新网络地址</li><li id="7a8b" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka lh km kn ko bi translated">将新网关也设置为DNS服务器地址(您可以将它作为另一段元数据传入)</li></ul><p id="4da6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">Powershell中实现这些目标的命令有:</p><ul class=""><li id="2a3c" class="kg kh hi jf b jg kb jk kc jo ki js kj jw kk ka lh km kn ko bi translated">set-netip接口</li><li id="a0b4" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka lh km kn ko bi translated">新网络地址</li><li id="970f" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka lh km kn ko bi translated">获取网络路由</li><li id="3220" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka lh km kn ko bi translated">删除-网络路由</li><li id="bda9" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka lh km kn ko bi translated">Set-DNSClientServerAddress</li></ul><p id="b445" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在我的环境中，这已经证明是一种很好的方法，但是在您的环境中，许多事情可能会有所不同，因此本文并不声称是该问题的最终解决方案。它概述了一种对我有效的可能方法。</p></div></div>    
</body>
</html>