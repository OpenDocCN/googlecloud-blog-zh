<html>
<head>
<title>Migrate Kedro Pipeline on Vertex AI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Vertex AI上迁移Kedro管道</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/migrate-kedro-pipeline-on-vertex-ai-fa3f2c6f7aad?source=collection_archive---------1-----------------------#2021-12-17">https://medium.com/google-cloud/migrate-kedro-pipeline-on-vertex-ai-fa3f2c6f7aad?source=collection_archive---------1-----------------------#2021-12-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="ece5" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">实验方法</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/799a437463880fe920f23342249996bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qx4if-zmti_NYmLs"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图。1 —使用Vertex AI的Kedro项目开发工作流</figcaption></figure><h1 id="6da4" class="jn jo hi bd jp jq jr js jt ju jv jw jx io jy ip jz ir ka is kb iu kc iv kd ke bi translated">好吧，你说，我听！</h1><p id="425a" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">关于Google Cloud 上的<strong class="kh hj"> </strong> <a class="ae lb" href="https://cloud.google.com/data-science" rel="noopener ugc nofollow" target="_blank">数据科学，你有什么想看的想法？请填写</a><a class="ae lb" href="https://forms.gle/H89eNLTVtCdpP1ro6" rel="noopener ugc nofollow" target="_blank">这张表格</a>让我知道。这将对我以后的博客帖子有所帮助=)</p><h1 id="c2d5" class="jn jo hi bd jp jq jr js jt ju jv jw jx io jy ip jz ir ka is kb iu kc iv kd ke bi translated">放弃</h1><p id="09f8" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">你对凯卓了解多少？如果你没有，我给<a class="ae lb" href="https://www.youtube.com/watch?v=KEdmJ2ADy_M" rel="noopener ugc nofollow" target="_blank">留了一个简短的介绍视频</a>和一篇<a class="ae lb" rel="noopener" href="/quantumblack/introducing-kedro-the-open-source-library-for-production-ready-machine-learning-code-d1c6d26ce2cf">中型文章</a>。我还假设你知道顶点AI。但是你有<a class="ae lb" href="https://cloud.google.com/blog/products/ai-machine-learning/vertex-ai-overview" rel="noopener ugc nofollow" target="_blank">这篇文章</a>开发者支持者分享了更多关于它的内容。最后，本文基于最近引入顶点AI管道支持的<a class="ae lb" href="https://kedro-kubeflow.readthedocs.io/en/0.4.4/index.html" rel="noopener ugc nofollow" target="_blank"> kedro-kubeflow </a>插件。<strong class="kh hj">还在实验阶段</strong>。但我觉得探索一下可能会很有趣。</p><h1 id="0e99" class="jn jo hi bd jp jq jr js jt ju jv jw jx io jy ip jz ir ka is kb iu kc iv kd ke bi translated">前提</h1><p id="9356" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">最近，我有机会与几个数据科学团队交谈。我们还讨论了他们在制作现成代码时面临的主要挑战。结果是交付时间通常会变长，因为</p><ol class=""><li id="6623" class="lc ld hi kh b ki le kl lf ko lg ks lh kw li la lj lk ll lm bi translated"><strong class="kh hj">由不同背景的数据工程师和数据科学家组成的团队</strong>面临的管理挑战。此外，在大多数情况下，他们都缺乏软件工程技能。而且，如果我们加上工作场所的混乱环境，严格的截止日期和令人分心的事情，就会导致薄弱的流程、低效的协作和糟糕的代码质量。</li><li id="6409" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la lj lk ll lm bi translated"><strong class="kh hj">实验</strong>。在通往“最佳”ML方法的过程中，您使用不同的数据、建模方法和参数配置进行了几次实验。作为管理挑战的结果，团队不能产生适当的文档，并且不能保证代码的可再现性和可重用性。</li><li id="4e85" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la lj lk ll lm bi translated"><strong class="kh hj">属地</strong>。与传统软件不同，ML代码具有数据和系统依赖等依赖性。它们侵蚀了封装和模块化设计为了维护代码而帮助创建的边界。同时，让测试和监控变得非常具有挑战性。</li><li id="5b97" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la lj lk ll lm bi translated"><strong class="kh hj">缺乏标准化。</strong>最后，一旦您找到了最佳模型，团队需要重新设计代码以满足IT规范，并构建一个可复制的管道来自动重新训练和部署模型。</li></ol><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ls"><img src="../Images/e8046e9b5da7c6bf81228483dc7fc9e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JEjUOY6ZoegdN_O4JT9QeA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图2 —没有工作流框架的数据科学难点</figcaption></figure><p id="ea27" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">出于这些原因，大多数团队决定致力于他们所谓的<strong class="kh hj">【模板】</strong>或<strong class="kh hj">【工作流框架】</strong>或<strong class="kh hj">【界面】</strong>。他们中的一些人从零开始建造了一个，另一些人采用了CookieCutter，或者像这次一样，采用了Kedro。最后，目标是在他们的数据科学平台SDK之上引入一个标准化层，以便在软件工程最佳实践方面创建可复制的ML项目。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lw"><img src="../Images/d6e45d66ea7d343002d8909718c60a4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_nj7giLES06eGNQ7J0HGEA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图3 —工作流框架带来的数据科学优势</figcaption></figure><p id="a2e5" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">在这一点上，你可能想知道:</p><blockquote class="lx"><p id="ee00" class="ly lz hi bd ma mb mc md me mf mg la dx translated">Vertex AI如何融入这个故事？Kedro和Vertex AI有什么联系？</p></blockquote><p id="df6c" class="pw-post-body-paragraph kf kg hi kh b ki mh ij kk kl mi im kn ko mj kq kr ks mk ku kv kw ml ky kz la hb bi translated">让我们看看。</p><h1 id="0d0d" class="jn jo hi bd jp jq jr js jt ju jv jw jx io jy ip jz ir ka is kb iu kc iv kd ke bi translated">我们的场景</h1><p id="e179" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">假设你是一家小型农业咨询公司创新部门的一员。一个更大的农民联盟希望将三种不同小麦品种的分类过程自动化:卡马、罗莎和加拿大小麦。为了验证ML方法，与一个重要的农业物理研究所合作，使用软X射线技术检测了内核内部结构的高质量可视化。提供数据是为了验证概念。</p><p id="36db" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">目标是为这三种类型的小麦建立一个固体分类器。为了加快ML实验阶段的速度并提供一个现成的代码，您的团队采用了Kedro作为项目框架。由于成员的数量和要处理的数据量，您一直在寻找一种可让您轻松扩展的托管服务。事实上，谈到Kedro，当您必须在生产中交付模型时，它使用Docker或Airflow提供了一个强大的管道和打包框架，这意味着您的Kedro管道至少可以无缝部署在Kubernetes (Kubeflow Operator)或Airflow cluster (DAG)上。但是你仍然需要找出他们完成工作所需的资源。事情是这样的:</p><blockquote class="lx"><p id="4594" class="ly lz hi bd ma mb mc md me mf mg la dx translated">如果您可以找到一种托管的方式来部署Kedro管道，那会怎么样呢？</p></blockquote><p id="1839" class="pw-post-body-paragraph kf kg hi kh b ki mh ij kk kl mi im kn ko mj kq kr ks mk ku kv kw ml ky kz la hb bi translated">你当时想到的唯一答案是:<strong class="kh hj">顶点AI管道*。</strong>根据<a class="ae lb" href="https://kedro.readthedocs.io/en/stable/10_deployment/06_kubeflow.html" rel="noopener ugc nofollow" target="_blank">公开文档</a>，Kedro管道可以转换为Kubeflow管道，这意味着它们可以部署在Vertex AI服务上。至少在理论上，这足以让团队在这个概念验证中一试身手。</p><h1 id="047b" class="jn jo hi bd jp jq jr js jt ju jv jw jx io jy ip jz ir ka is kb iu kc iv kd ke bi translated">我们的数据集</h1><p id="d059" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">该数据集来自卢布林大学和克拉科夫工业大学的马佐格扎塔·查里亚塔诺维奇、耶日·尼翁扎斯、彼得·库尔奇基、彼得·科瓦尔斯基、西曼·祖卡斯克和萨沃米尔·扎克提供的<a class="ae lb" href="https://archive.ics.uci.edu/ml/datasets/seeds" rel="noopener ugc nofollow" target="_blank"> UCI种子数据集</a>。利用软X射线技术和GRAINS软件包，从210个小麦样品中构造了以下7个实值几何参数:面积A、周长P、紧密度C、粒长、粒宽、非对称系数和粒槽长度。</p><h1 id="0ec9" class="jn jo hi bd jp jq jr js jt ju jv jw jx io jy ip jz ir ka is kb iu kc iv kd ke bi translated">从Kedro到Vertex AI，通过插件和简单的安排</h1><p id="968d" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">让我们假设您已经按照Kedro文档中的描述构建了自己的管道。如果你做了正确的事情，你应该有以下的文件夹结构。</p><pre class="iy iz ja jb fd mm mn mo mp aw mq bi"><span id="f705" class="mr jo hi mn b fi ms mt l mu mv">.<br/>├── README.md<br/>├── conf<br/>│   ├── README.md<br/>│   ├── base<br/>│   └── local<br/>├── data<br/>│   ├── 01_raw<br/>│   ├── 02_intermediate<br/>│   ├── 03_primary<br/>│   ├── 04_feature<br/>│   ├── 05_model_input<br/>│   ├── 06_models<br/>│   ├── 07_model_output<br/>│   └── 08_reporting<br/>├── docs<br/>│   ├── build<br/>│   └── source<br/>├── info.log<br/>├── logs<br/>│   ├── info.log<br/>│   └── journals<br/>├── notebooks<br/>│   ├── 1_kedro_vertex_wheat_beam_clf_xgb.ipynb<br/>│   └── notebook_template.ipynb<br/>├── pyproject.toml<br/>├── setup.cfg<br/>└── src<br/>    ├── requirements.in<br/>    ├── requirements.txt<br/>    ├── setup.py<br/>    ├── tests<br/>    ├── wk_classification</span></pre><p id="0455" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">其中<em class="mw">1 _柯德罗_顶点_小麦_梁_ clf _ XB . ipynb</em>是我用来围绕ML方法做一些实验的笔记本。在本例中，我最终使用了XGBoost模型。</p><p id="7bf7" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">下面你可以看到我的管道可视化</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mx"><img src="../Images/3de40bf3016b99fc50291fce87bb151e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5MnDZ363YYoWsv_v"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图Kedro Viz上的Kedro管道执行图</figcaption></figure><p id="156e" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">从这里开始，我几乎无法按照以下顺序来表达我所讲述的将Kedro管道部署到Vertex AI的步骤:<strong class="kh hj"> Package。采纳。转换。安排一下。跑。</strong></p><h2 id="4126" class="mr jo hi bd jp my mz na jt nb nc nd jx ko ne nf jz ks ng nh kb kw ni nj kd nk bi translated">打包。</h2><p id="a919" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">为了将Kedro项目作为Vertex AI管道交付，我安装了<em class="mw">文档中描述的<em class="mw"> kedro-docker </em>插件，并且构建了docker映像。</em></p><p id="7819" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">这个插件有很好的命令行功能。你只需要跑</p><pre class="iy iz ja jb fd mm mn mo mp aw mq bi"><span id="d456" class="mr jo hi mn b fi ms mt l mu mv">kedro docker init</span></pre><p id="81fc" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">并生成<em class="mw"> Dockerfile。还有dockerignore。为您的项目提供dive-ci </em>文件。为了让它发挥作用，我刚刚更改了Dockerfile中的BASE_IMAGE，并扩展了<em class="mw">。doctrignore</em>包括数据文件夹。在<em class="mw">文件</em>下方:</p><pre class="iy iz ja jb fd mm mn mo mp aw mq bi"><span id="cf04" class="mr jo hi mn b fi ms mt l mu mv"><strong class="mn hj">ARG BASE_IMAGE=google/cloud-sdk:latest</strong><br/>FROM $BASE_IMAGE</span><span id="aac0" class="mr jo hi mn b fi nl mt l mu mv"># install project requirements<br/>COPY src/requirements.txt /tmp/requirements.txt<br/>RUN pip install -r /tmp/requirements.txt &amp;&amp; rm -f /tmp/requirements.txt</span><span id="1fca" class="mr jo hi mn b fi nl mt l mu mv"># add kedro user<br/>ARG KEDRO_UID=999<br/>ARG KEDRO_GID=0<br/>RUN groupadd -f -g ${KEDRO_GID} kedro_group &amp;&amp; \<br/>useradd -d /home/kedro -s /bin/bash -g ${KEDRO_GID} -u ${KEDRO_UID} kedro</span><span id="693e" class="mr jo hi mn b fi nl mt l mu mv"># copy the whole project except what is in .dockerignore<br/>WORKDIR /home/kedro<br/>COPY . .</span><span id="a4d1" class="mr jo hi mn b fi nl mt l mu mv">RUN chown -R kedro:${KEDRO_GID} /home/kedro<br/>USER kedro<br/>RUN chmod -R a+w /home/kedro</span><span id="61f1" class="mr jo hi mn b fi nl mt l mu mv">EXPOSE 8888</span><span id="3522" class="mr jo hi mn b fi nl mt l mu mv">CMD [“kedro”, “run”]</span></pre><p id="b27f" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">还有<em class="mw">。doctrignore</em></p><pre class="iy iz ja jb fd mm mn mo mp aw mq bi"><span id="75f9" class="mr jo hi mn b fi ms mt l mu mv">##########################<br/># Kedro PROJECT<br/><br/># ignore Dockerfile and .dockerignore<br/>Dockerfile<br/>.dockerignore<br/><br/># ignore potentially sensitive credentials files<br/>conf/**/*credentials*<br/><br/># ignore all local configuration<br/>conf/local<br/>!conf/local/.gitkeep<br/><br/># ignore everything in the following folders<br/># data<br/>logs<br/>notebooks<br/>references<br/>results<br/><br/># except the following<br/>!logs/.gitkeep<br/>!notebooks/.gitkeep<br/>!references/.gitkeep<br/>!results/.gitkeep<br/><strong class="mn hj">!data/01_raw</strong></span></pre><p id="1556" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">现在，我们应该拥有了将Kedro项目容器化并使用Kubeflow Pipelines进行部署所需的全部资源。基于<a class="ae lb" href="https://kedro.readthedocs.io/en/stable/10_deployment/06_kubeflow.html" rel="noopener ugc nofollow" target="_blank">原始文档</a>，您需要运行提供的脚本，该脚本将Kedro节点和依赖关系转换为相应的工作流规范。我遇到的一些限制与脚本使用的处于折旧模式的KFP v1和ContainerOp有关。我还做了一些测试，生成的规范不符合Vertex AI管道服务所需的格式。</p><p id="a431" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">因此，我开始深入探讨“对话”挑战，我发现即使我们按原样转换管道，它也无法在自行管理的Kubernetes集群或Vertex AI管道服务上工作。原因何在？因为:</p><ol class=""><li id="0233" class="lc ld hi kh b ki le kl lf ko lg ks lh kw li la lj lk ll lm bi translated">在Kubeflow上运行Kedro pipeline时，节点不共享内存。那么<em class="mw"> MemoryDataSets </em>就不起作用了，每个工件都需要存储为一个文件。</li><li id="9b24" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la lj lk ll lm bi translated">由于无服务器服务，必须传递一组不同的参数，以便在Vertex AI管道上成功部署管道。</li></ol><p id="69da" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">对我们来说幸运的是，<a class="ae lb" href="https://kedro-kubeflow.readthedocs.io/en/0.4.4/index.html" rel="noopener ugc nofollow" target="_blank"> <em class="mw"> kedro-kubeflow </em> </a>插件最近引入了一个扩展，允许在与Vertex AI服务兼容的KFP标准中转换kedro管道。尽管它仍处于试验阶段，但我发现它能够通过做一些安排来应对其中的一些挑战。</p><h2 id="49aa" class="mr jo hi bd jp my mz na jt nb nc nd jx ko ne nf jz ks ng nh kb kw ni nj kd nk bi translated">适应。</h2><p id="951d" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">一旦我<a class="ae lb" href="https://kedro-kubeflow.readthedocs.io/en/0.4.4/source/02_installation/01_installation.html#plugin-installation" rel="noopener ugc nofollow" target="_blank">安装了插件</a>，为了设置顶点AI管道作为运行基础设施，我创建了一个新的gcp配置文件夹。然后，由于无服务器服务，为了成功地部署管道，必须传递一组不同的参数。在插件文档中，你会找到它们的完整描述。我还修改了目录，以处理“不共享内存”节点的限制。为简单起见，您可以在下面找到目录</p><pre class="iy iz ja jb fd mm mn mo mp aw mq bi"><span id="c848" class="mr jo hi mn b fi ms mt l mu mv">seeds:<br/> type: pandas.CSVDataSet<br/> filepath: /gcs/${KEDRO_CONFIG_BUCKET}/data/seeds.csv<br/> layer: raw<br/>preprocessed_seeds:<br/> type: pandas.CSVDataSet<br/> filepath: /gcs/${KEDRO_CONFIG_BUCKET}/data/preprocessed_seeds.csv<br/> layer: processing<br/>X_train:<br/> type: pandas.CSVDataSet<br/> filepath: /gcs/${KEDRO_CONFIG_BUCKET}/data/X_train.csv<br/> layer: processing<br/>X_test:<br/> type: pandas.CSVDataSet<br/> filepath: /gcs/${KEDRO_CONFIG_BUCKET}/data/X_test.csv<br/> layer: processing<br/>y_train:<br/> type: pandas.CSVDataSet<br/> filepath: /gcs/${KEDRO_CONFIG_BUCKET}/data/y_train.csv<br/> layer: processing<br/>y_test:<br/> type: pandas.CSVDataSet<br/> filepath: /gcs/${KEDRO_CONFIG_BUCKET}/data/y_test.csv<br/> layer: processing<br/>xgboost_classifier:<br/> type: pickle.PickleDataSet<br/> filepath: /gcs/${KEDRO_CONFIG_BUCKET}/models/xgboost<br/> backend: joblib<br/> versioned: true<br/> layer: model</span></pre><p id="b005" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">和配置</p><pre class="iy iz ja jb fd mm mn mo mp aw mq bi"><span id="6503" class="mr jo hi mn b fi ms mt l mu mv">host: vertex-ai-pipelines<br/>project_id: ${KEDRO_CONFIG_PROJECT_ID}<br/>region: ${KEDRO_CONFIG_REGION}<br/>run_config:<br/> root: ${KEDRO_CONFIG_BUCKET}/pipelines<br/> image: gcr.io/${KEDRO_CONFIG_PROJECT_ID}/classify_wheat_kernel<br/> experiment_name: classify-wheat-kernel<br/> run_name: classify-wheat-kernel</span></pre><p id="b14c" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">其中${…}将利用<a class="ae lb" href="https://kedro.readthedocs.io/en/stable/kedro.config.TemplatedConfigLoader.html#kedro-config-templatedconfigloader" rel="noopener ugc nofollow" target="_blank"> TemplatedConfigLoader </a>类，该类允许基于配置的模板值。</p><p id="4ea6" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">到目前为止，一切都准备好了。是时候转换管道了</p><h2 id="d244" class="mr jo hi bd jp my mz na jt nb nc nd jx ko ne nf jz ks ng nh kb kw ni nj kd nk bi translated">转换。安排。快跑。</h2><p id="fb1c" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">老实说，转换本身简单明了。用<em class="mw"> dockerfile </em>和<em class="mw">。我构建图像，正确标记，并把它推送到项目的容器注册表中。</em></p><pre class="iy iz ja jb fd mm mn mo mp aw mq bi"><span id="b737" class="mr jo hi mn b fi ms mt l mu mv">kedro docker build --docker-args="--no-cache" --base-image="google/cloud-sdk:latest"<br/>docker tag classify-wheat-kernel gcr.io/$PROJECT_ID/classify_wheat_kernel<br/>docker push gcr.io/$PROJECT_ID/classify_wheat_kernel</span></pre><p id="9558" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">然后我运行命令</p><pre class="iy iz ja jb fd mm mn mo mp aw mq bi"><span id="8302" class="mr jo hi mn b fi ms mt l mu mv">kedro kubeflow -e gcp compile -o ../pipeline/kedro-vertex-classify-wheat-kernel-pipeline.json</span></pre><p id="e5e2" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">就是这样。这是因为该命令将生成一个PipelineSpec，它应该与Vertex AI服务兼容。但是，根据我的经验，我必须稍微调整一下输出才能让它工作。在我所做的更改列表下面</p><ol class=""><li id="0317" class="lc ld hi kh b ki le kl lf ko lg ks lh kw li la lj lk ll lm bi translated">更换<em class="mw">系统。数据集"</em>到<em class="mw">"系统。Model" </em>为了存储具有正确元数据类型的模型工件</li><li id="8d14" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la lj lk ll lm bi translated">从kedro运行命令行中删除每个节点的<em class="mw">–-params</em>参数</li><li id="c708" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la lj lk ll lm bi translated">更正cp路径，将管道工件移动到正确的元数据路径下。例如，我将<em class="mw"> /home/kedro//gcs/ </em>改为<em class="mw"> /home/kedro/gcs/ </em></li></ol><p id="dc0d" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated"><strong class="kh hj">更新:</strong>请查看“附加备注”部分以获得进一步的说明。</p><p id="05eb" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">好了，当我完成了这些，我只是使用一个自定义脚本和<a class="ae lb" href="https://cloud.google.com/vertex-ai/docs/pipelines/run-pipeline#vertex-ai-sdk-for-python" rel="noopener ugc nofollow" target="_blank"> Vertex AI SDK </a>将管道提交给Vertex AI。下面你可以看到顶点AI上转换后的流水线的执行图。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nm"><img src="../Images/7abc358688200caf17cfb9edebc566e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MsSdTf_5LW5JiwI5Jih9Cg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图5 —顶点AI管道上的Kedro管道执行图</figcaption></figure><p id="2a36" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">我可以高兴地说:转换完成！</p><h1 id="db8f" class="jn jo hi bd jp jq jr js jt ju jv jw jx io jy ip jz ir ka is kb iu kc iv kd ke bi translated">下一步是什么</h1><p id="5fa6" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">在本文中，我使用一个简单的管道示例来展示如何将Kedro管道转换为Vertex AI管道。我利用了Kedro生态系统中一些最棒的插件，比如<a class="ae lb" href="https://github.com/quantumblacklabs/kedro-docker" rel="noopener ugc nofollow" target="_blank"><em class="mw"/></a>和<a class="ae lb" href="https://github.com/getindata/kedro-kubeflow" rel="noopener ugc nofollow" target="_blank"> <em class="mw"> kedro-kubeflow </em>。</a></p><p id="4659" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">正如我在开始时提到的，整个方法是实验性的，因为Kedro Kubeflow插件支持Vertex AI管道。例如，除了一些调整之外，我无法弄清楚如何跟踪InputParameters和OutputParameters，如上图所示。但是提交几个命令来将整个项目转换成一个几乎可以投入生产的可扩展管道的想法对我来说仍然很有价值。这就是为什么我期待与插件的生产版本一起工作。</p><p id="5ff4" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">同时，我希望你会对这篇文章感兴趣。如果有，就鼓掌或者留言评论。欢迎通过LinkedIn<a class="ae lb" href="https://www.linkedin.com/in/ivan-nardini/" rel="noopener ugc nofollow" target="_blank">或Twitter</a>与我联系，进行进一步讨论或在Google Cloud上就数据科学进行交流！</p><p id="bc5e" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated"><em class="mw">感谢Tuba Islam、Janos Bana、Manuel Hurtado、Mariusz Strzelecki和Marek Wiewiorka提供的宝贵反馈。</em></p><h1 id="db66" class="jn jo hi bd jp jq jr js jt ju jv jw jx io jy ip jz ir ka is kb iu kc iv kd ke bi translated">参考</h1><ul class=""><li id="31c6" class="lc ld hi kh b ki kj kl km ko nn ks no kw np la nq lk ll lm bi translated"><a class="ae lb" href="https://kedro.readthedocs.io/en/stable/index.html" rel="noopener ugc nofollow" target="_blank">https://kedro.readthedocs.io/en/stable/index.html</a></li><li id="6cb0" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la nq lk ll lm bi translated"><a class="ae lb" href="https://kedro.readthedocs.io/en/stable/03_tutorial/01_spaceflights_tutorial.html" rel="noopener ugc nofollow" target="_blank">https://kedro . readthe docs . io/en/stable/03 _ tutorial/01 _ space flights _ tutorial . html</a></li><li id="e8a3" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la nq lk ll lm bi translated"><a class="ae lb" href="https://kedro.readthedocs.io/en/stable/10_deployment/06_kubeflow.html" rel="noopener ugc nofollow" target="_blank">https://kedro . readthe docs . io/en/stable/10 _ deployment/06 _ kube flow . html</a></li><li id="9b86" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la nq lk ll lm bi translated"><a class="ae lb" href="https://github.com/quantumblacklabs/kedro-docker" rel="noopener ugc nofollow" target="_blank">https://github.com/quantumblacklabs/kedro-docker</a></li><li id="e352" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la nq lk ll lm bi translated"><a class="ae lb" href="https://kedro-kubeflow.readthedocs.io/en/0.4.4/index.html" rel="noopener ugc nofollow" target="_blank">https://kedro-kubeflow.readthedocs.io/en/0.4.4/index.html</a></li><li id="3ad6" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la nq lk ll lm bi translated"><a class="ae lb" href="https://cloud.google.com/python/docs/reference/aiplatform/latest" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/python/docs/reference/ai platform/latest</a></li><li id="03eb" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la nq lk ll lm bi translated"><a class="ae lb" href="https://google-cloud-pipeline-components.readthedocs.io/en/google-cloud-pipeline-components-0.2.0/" rel="noopener ugc nofollow" target="_blank">https://Google-cloud-pipeline-components . readthedocs . io/en/Google-cloud-pipeline-components-0 . 2 . 0/</a></li></ul><h1 id="1d6d" class="jn jo hi bd jp jq jr js jt ju jv jw jx io jy ip jz ir ka is kb iu kc iv kd ke bi translated">附加备注</h1><p id="2bbc" class="pw-post-body-paragraph kf kg hi kh b ki kj ij kk kl km im kn ko kp kq kr ks kt ku kv kw kx ky kz la hb bi translated">同时，我有机会与<a class="nr ns ge" href="https://medium.com/u/48a677777117?source=post_page-----fa3f2c6f7aad--------------------------------" rel="noopener" target="_blank"> Mariusz Strzelecki </a>和<a class="nr ns ge" href="https://medium.com/u/978aad755da?source=post_page-----fa3f2c6f7aad--------------------------------" rel="noopener" target="_blank"> Marek Wiewiorka </a>讨论，他们是<em class="mw"> kedro-kubeflow </em>插件的维护者。他们对我遇到的案例提供了很好的反馈。按顺序:</p><ol class=""><li id="60b7" class="lc ld hi kh b ki le kl lf ko lg ks lh kw li la lj lk ll lm bi translated"><a class="ae lb" href="https://github.com/getindata/kedro-kubeflow/blob/0.4.4/kedro_kubeflow/vertex_ai/io.py#L57" rel="noopener ugc nofollow" target="_blank">最新版本(0.4.4)支持模型工件</a>，只要工件的图层设置为“模型”。作为旁注，该插件最初是为KFP v1协议兼容性(AI平台管道)而创建的。那个版本没有区分工件类型。现在它支持数据集和模型。</li><li id="0ec1" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la lj lk ll lm bi translated">需要进一步调查。<a class="ae lb" href="https://github.com/getindata/kedro-kubeflow/blob/0.4.4/kedro_kubeflow/vertex_ai/generator.py#L144" rel="noopener ugc nofollow" target="_blank">插件支持参数</a>。我要在Github上开一期。</li><li id="e21d" class="lc ld hi kh b ki ln kl lo ko lp ks lq kw lr la lj lk ll lm bi translated">这与顶点AI文档建议/gcs/ as前缀的事实有关，而插件代码以不同的方式处理它。</li></ol></div><div class="ab cl nt nu gp nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="hb hc hd he hf"><p id="cf69" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated">*你们中的一些人可能会争辩为什么我不建议作曲家。下面是来自<a class="ae lb" href="https://cloud.google.com/architecture/ml-on-gcp-best-practices" rel="noopener ugc nofollow" target="_blank">“在谷歌云上实现机器学习的最佳实践”</a>文章的注释:</p><p id="abb5" class="pw-post-body-paragraph kf kg hi kh b ki le ij kk kl lf im kn ko lt kq kr ks lu ku kv kw lv ky kz la hb bi translated"><em class="mw">"虽然您可以考虑其他编排器，如</em> <a class="ae lb" href="https://cloud.google.com/composer" rel="noopener ugc nofollow" target="_blank"> <em class="mw">【云作曲】</em> </a> <em class="mw">(参见</em> <a class="ae lb" href="https://airflow.apache.org/docs/apache-airflow/stable/tutorial.html" rel="noopener ugc nofollow" target="_blank"> <em class="mw">气流</em> </a> <em class="mw">)，但管道是更好的选择，因为它包括对常见ML操作的内置支持，并跟踪特定于ML的元数据和沿袭。沿袭对于验证您的管道在生产中是否正常运行尤为重要。</em></p></div></div>    
</body>
</html>