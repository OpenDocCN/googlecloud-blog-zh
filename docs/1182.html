<html>
<head>
<title>Connecting Cloud SQL - Public IP + SQL Proxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">连接云SQL -公共IP + SQL代理</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-sql-public-ip-proxy-5513f59e5a9e?source=collection_archive---------3-----------------------#2019-10-25">https://medium.com/google-cloud/cloud-sql-public-ip-proxy-5513f59e5a9e?source=collection_archive---------3-----------------------#2019-10-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/23ae89e680f61cca63c0c7af884f9bfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*efvnGXZbvpu0ib5qBdUfuQ.png"/></div></div></figure><p id="fbfb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">嗨，朋友们！</p><p id="aaea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这篇博客将带您一步步了解如何使用公共IP选项连接到您的云SQL实例，以及如何通过Google SQL代理进行连接。一个常见的用例是，如果您有一个本地应用程序或设备想要连接到由云管理的SQL数据库。这通常是将情况从所有内部部署转移到所有云中的第一步。</p><p id="8826" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想了解更多关于云SQL连接的背景知识，请查看我的<a class="ae jo" rel="noopener" href="/@GabeWeiss/connecting-google-cloud-sql-94025ba27071">连接介绍</a>博客文章。这篇文章还链接到更多关于不同用例和方法的分步文章，以及为什么您可能想要选择一种方法而不是另一种方法。所有这些帖子都假设你已经有了自己的谷歌云平台(GCP)项目，并设置了计费。如果没有，请点击此处的<a class="ae jo" href="https://console.cloud.google.com/freetrial" rel="noopener ugc nofollow" target="_blank">按钮</a>开始项目，或点击此处的<a class="ae jo" href="https://console.cloud.google.com/billing" rel="noopener ugc nofollow" target="_blank">按钮</a>为项目设置账单。</p><h1 id="6ff8" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">指南:</h1><p id="3326" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated"><strong class="is hj">创建云SQL实例</strong>。我将在云控制台中完成它，但是如果你知道如何在命令行中使用<code class="du ks kt ku kv b">gcloud</code>,那也很酷。</p><p id="e1a1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">到这里<a class="ae jo" href="https://console.cloud.google.com/sql/instances" rel="noopener ugc nofollow" target="_blank">去</a>。如果您已经有了实例，那么点击顶部导航栏中的<code class="du ks kt ku kv b">CREATE INSTANCE</code>按钮:</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/dbab561d11a2a52566507cd2eb598d10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Hv4mNR_rDLFGlWFW"/></div></div></figure><p id="6fe6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你还没有，那么点击对话框中蓝色的<code class="du ks kt ku kv b">Create instance</code>按钮。</p><p id="4af0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">选择您的数据库风格，对于本教程来说，选择哪种类型并不重要。</p><p id="06bd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">设置一个实例ID，一个root密码，然后展开<code class="du ks kt ku kv b">Show configuration options</code></p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es lb"><img src="../Images/e17e10567211bb4ab0ba6fe926329cfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:436/0*Vy-aRx4qHBc5pbVe"/></div></figure><p id="bd6a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">确认在<code class="du ks kt ku kv b">Connectivity</code>标签下写着<code class="du ks kt ku kv b">Public IP enabled</code></p><ul class=""><li id="7d56" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">如果没有，请展开该部分，并选中公共IP复选框</li><li id="1d64" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">不要担心网络方面的东西，我们使用代理，所以在本教程中我们不需要担心它</li></ul><p id="cfe2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击<code class="du ks kt ku kv b">Create</code>按钮，你将返回到实例列表，并会看到你的实例</p><ul class=""><li id="5a04" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">您可以点击进入实例，并看到横幅说它还没有准备好。</li></ul><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/a3088c58c8868114b8beb8e4a3cc5148.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*L570PzUAtT-dEg2i"/></div></div></figure><ul class=""><li id="06d9" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">这可能需要几分钟的时间，因此在此过程中，我们将继续让代理一切就绪</li></ul><h2 id="450d" class="lr jq hi bd jr ls lt lu jv lv lw lx jz jb ly lz kd jf ma mb kh jj mc md kl me bi translated"><strong class="ak">设置Google SQL代理</strong></h2><p id="a819" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">转到此处的<a class="ae jo" href="https://console.cloud.google.com/apis/library/sqladmin.googleapis.com" rel="noopener ugc nofollow" target="_blank">以启用云SQL管理API(代理连接到您的项目时需要)</a></p><ul class=""><li id="cc39" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">如果你已经启用了它，你会看到一个<code class="du ks kt ku kv b">MANAGE</code>按钮，如果你没有启用，你会看到<code class="du ks kt ku kv b">ENABLE</code>按钮</li></ul><p id="9567" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下载适用于您平台的代理:</p><p id="8bbe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> Linux 64位</strong>:<code class="du ks kt ku kv b">wget <a class="ae jo" href="https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64" rel="noopener ugc nofollow" target="_blank">https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64</a> -O cloud_sql_proxy<br/></code>T14】Linux 32位 : <code class="du ks kt ku kv b">wget <a class="ae jo" href="https://dl.google.com/cloudsql/cloud_sql_proxy.linux.386" rel="noopener ugc nofollow" target="_blank">https://dl.google.com/cloudsql/cloud_sql_proxy.linux.386</a> -O cloud_sql_proxy</code></p><p id="1c7b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> Macos 64位</strong>:<code class="du ks kt ku kv b">curl -o cloud_sql_proxy <a class="ae jo" href="https://dl.google.com/cloudsql/cloud_sql_proxy.darwin.amd64" rel="noopener ugc nofollow" target="_blank">https://dl.google.com/cloudsql/cloud_sql_proxy.darwin.amd64</a><br/></code>T18】MAC OS 32位 : <code class="du ks kt ku kv b">curl -o cloud_sql_proxy <a class="ae jo" href="https://dl.google.com/cloudsql/cloud_sql_proxy.darwin.386" rel="noopener ugc nofollow" target="_blank">https://dl.google.com/cloudsql/cloud_sql_proxy.darwin.386</a></code></p><p id="f6ef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在Windows上，只需点击链接应该下载它，或者您可以右键单击链接并选择“另存为”并下载exe。</p><ul class=""><li id="f613" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated"><strong class="is hj">Win-32</strong>:<code class="du ks kt ku kv b"><a class="ae jo" href="https://dl.google.com/cloudsql/cloud_sql_proxy_x86.exe" rel="noopener ugc nofollow" target="_blank">https://dl.google.com/cloudsql/cloud_sql_proxy_x86.exe</a><br/></code><strong class="is hj">Win-64</strong>:<code class="du ks kt ku kv b"><a class="ae jo" href="https://dl.google.com/cloudsql/cloud_sql_proxy_x64.exe" rel="noopener ugc nofollow" target="_blank">https://dl.google.com/cloudsql/cloud_sql_proxy_x64.exe</a></code></li></ul><p id="f907" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于Linux和Macos，运行<code class="du ks kt ku kv b">chmod +x cloud_sql_proxy</code></p><p id="cca9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于Windows，将可执行文件重命名为cloud_sql_proxy.exe，如果不这样做也没关系，但是请记住，本教程后面链接的任何命令都需要更改可执行文件的名称以与之匹配</p><p id="13c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们需要创建一个<strong class="is hj">服务帐户</strong>来授予对云SQL的代理访问权</p><p id="a2f7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">转到<a class="ae jo" href="https://console.cloud.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank">这里</a>，点击页面顶部的<code class="du ks kt ku kv b">CREATE SERVICE ACCOUNT</code>按钮</p><p id="7f87" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为您的服务帐户提供一个唯一的名称和ID，然后单击<code class="du ks kt ku kv b">CREATE</code></p><p id="34c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下一页上，单击<code class="du ks kt ku kv b">Select a role</code>的下拉菜单</p><ul class=""><li id="b4da" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">过滤“云SQL”并选择<code class="du ks kt ku kv b">Cloud SQL Client</code>角色</li><li id="de00" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">这个角色授予<code class="du ks kt ku kv b">get</code>和<code class="du ks kt ku kv b">list</code>对项目中云SQL实例的访问权限。注意，这不是用户对数据库本身的访问。这通常使用<code class="du ks kt ku kv b">GRANT</code>查询来处理。</li></ul><p id="8b38" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击<code class="du ks kt ku kv b">CONTINUE</code></p><p id="f9b5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下一页，点击<code class="du ks kt ku kv b">CREATE KEY</code>按钮</p><ul class=""><li id="7dc7" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">保持在<code class="du ks kt ku kv b">JSON</code>上，点击<code class="du ks kt ku kv b">CREATE</code></li><li id="88eb" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">这将把密钥下载到您的本地机器上。JSON密钥需要放在运行代理的地方</li></ul><p id="1cc1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击<code class="du ks kt ku kv b">DONE</code>完成服务账户的创建</p><p id="a6ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">启动代理的时间到了</p><p id="c40f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">回到<a class="ae jo" href="https://console.cloud.google.com/sql/instances" rel="noopener ugc nofollow" target="_blank">这里</a>。单击新创建的实例(现在应该已经完成了实例化)</p><p id="1fd4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在<code class="du ks kt ku kv b">Connect to this instance</code>部分，复制<code class="du ks kt ku kv b">Instance connection name</code>，它看起来会像<code class="du ks kt ku kv b">myproject:us-central1:myinstance</code></p><p id="7431" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用以下命令启动代理:</p><ul class=""><li id="fa74" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated"><code class="du ks kt ku kv b">./cloud_sql_proxy -instances=&lt;INSTANCE_CONNECTION_NAME&gt;=tcp:5432 -credential_file=&lt;PATH_TO_SERVICE_ACCOUNT_FILE&gt;</code></li><li id="3949" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">注意这个端口是用于Postgres的，如果你使用MySQL，那么它应该是<code class="du ks kt ku kv b">tcp:3306</code>，如果你使用SQL Server，那么默认情况下它应该是<code class="du ks kt ku kv b">tcp:1433</code>。</li><li id="cbf5" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">更改这些端口是没问题的，特别是如果您已经在端口上运行了某些东西(比如您正在本地运行PostgreSQL)。如果您这样做了，请记住，在下一节中，您需要用您指定的任何内容来指定<code class="du ks kt ku kv b">--port</code>标志，以便验证连通性。</li></ul><p id="eded" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">验证连通性</strong></p><p id="949b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">验证连通性最简单的方法是使用类似<a class="ae jo" href="http://postgresguide.com/utilities/psql.html" rel="noopener ugc nofollow" target="_blank"> psql </a>的东西:</p><ul class=""><li id="f2ab" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated"><code class="du ks kt ku kv b">psql “host=127.0.0.1 port=5432 sslmode=disable user=postgres”</code>然后输入您在创建数据库时指定的密码</li><li id="4377" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">注意，即使设置了<code class="du ks kt ku kv b">sslmode=disable</code>，Google SQL代理也提供了加密的连接</li></ul><p id="2414" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">总结</strong></p><p id="52f3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要清理这些，您需要做的就是删除云SQL实例。遇到什么问题了吗？请让我知道！请在下面的评论中回复，或者在<a class="ae jo" href="https://twitter.com/GabeWeiss_" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上联系我。我的DMs打开了！</p></div></div>    
</body>
</html>