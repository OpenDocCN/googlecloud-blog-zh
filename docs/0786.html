<html>
<head>
<title>Wrapping Google Cloud Functions HTTP Triggers in Endpoints</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在端点中包装Google Cloud函数HTTP触发器</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/wrapping-google-cloud-functions-http-triggers-in-endpoints-666e141e5e3b?source=collection_archive---------1-----------------------#2018-10-05">https://medium.com/google-cloud/wrapping-google-cloud-functions-http-triggers-in-endpoints-666e141e5e3b?source=collection_archive---------1-----------------------#2018-10-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c093" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随着谷歌云功能生态系统的发展，有许多有用的功能变得可用。然而，锁定<a class="ae jd" href="https://cloud.google.com/functions/docs/writing/http" rel="noopener ugc nofollow" target="_blank"> GCF HTTP函数</a>仍然有点困难。例如，您可能希望添加身份验证并保护这些功能免受来自开放互联网的攻击。另一方面，<a class="ae jd" href="https://cloud.google.com/endpoints/docs/" rel="noopener ugc nofollow" target="_blank">谷歌云端点</a>已经存在了一段时间，并且是专门为受保护的HTTP访问而设计的。您可以使用API密钥来限制端点，将它们放在负载平衡器的后面以托管在一致的域上，并使用云盔甲来保护它们。这篇文章将演示如何将Nodejs HTTP云函数导入到App Engine上托管的端点API中。</p><p id="ab64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">将云功能导入应用引擎</strong><br/>en points API可以托管在<a class="ae jd" href="https://cloud.google.com/docs/choosing-a-compute-option" rel="noopener ugc nofollow" target="_blank">多个不同的计算选项</a>上。这篇文章将解释如何在App Engine上运行一个例子。App Engine Nodejs运行时使用<a class="ae jd" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express </a>，这是一个流行的web框架，它不是特别固执己见，并使将GCF函数导入App Engine应用程序变得简单。GCF使用的JavaScript模块方法使得无需修改即可轻松移植代码。</p><p id="045b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">遵循<a class="ae jd" href="https://cloud.google.com/functions/docs/quickstart" rel="noopener ugc nofollow" target="_blank"> GCF快速入门</a>中的说明，包括<a class="ae jd" href="https://github.com/GoogleCloudPlatform/nodejs-docs-samples" rel="noopener ugc nofollow" target="_blank">Google cloud platform/nodejs-docs-samples</a>的克隆。快速入门导出函数helloGET，该函数将“Hello World”文本写入HTTP响应对象。快速入门的代码包含在nodejs-docs-samples/functions/hello world目录中。注意，App Engine 中Node.js的<br/> <a class="ae jd" href="https://cloud.google.com/appengine/docs/standard/nodejs/quickstart" rel="noopener ugc nofollow" target="_blank">快速入门包含在同一个GitHub repo中。</a></p><p id="594f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从GoogleCloudPlatform目录开始，将GCF文件复制到<br/> App Engine标准helloworld示例目录:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="6dfa" class="jn jo hi jj b fi jp jq l jr js">cp functions/helloworld/index.js appengine/hello-world/standard/.</span></pre><p id="4b17" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对app.js中的App Engine代码进行一些更改，以便按照以下代码行导入函数:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="dd55" class="jn jo hi jj b fi jp jq l jr js">var mygcf = require(‘./index’); </span></pre><p id="658f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并将app.js中的/ route替换为:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="8785" class="jn jo hi jj b fi jp jq l jr js">app.get(‘/’, (req, res) =&gt; {<br/> res.status(200);<br/> mygcf.helloGET(req, res);<br/> res.end();<br/>});</span></pre><p id="5ed6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装一些HTTP触发器不需要的额外的东西，但是在GCF Quickstart的其他地方使用了<br/>,所以我们不需要改变GCF文件:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="2e41" class="jn jo hi jj b fi jp jq l jr js">cd appengine/hello-world/standard/<br/>npm install -save <a class="ae jd" href="http://twitter.com/google" rel="noopener ugc nofollow" target="_blank">@google</a>-cloud/debug-agent<br/>npm install -save pug<br/>npm install -save safe-buffer</span></pre><p id="0a88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尝试在本地运行应用程序</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="51ae" class="jn jo hi jj b fi jp jq l jr js">npm start</span></pre><p id="81e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查它是否在本地正常运行:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="3bef" class="jn jo hi jj b fi jp jq l jr js">curl <a class="ae jd" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a></span></pre><p id="4a68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署到应用引擎标准:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="736b" class="jn jo hi jj b fi jp jq l jr js">gcloud app deploy</span></pre><p id="3d13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查应用程序是否正常工作</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="da41" class="jn jo hi jj b fi jp jq l jr js">gcloud app browse</span></pre><p id="d5ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">向云端点导入云函数</strong> <br/>让我们对App Engine端点的例子做同样的尝试。按照<a class="ae jd" href="https://cloud.google.com/endpoints/docs/openapi/get-started-app-engine#node" rel="noopener ugc nofollow" target="_blank">App Engine Flexible<br/>环境</a>中的<br/>说明开始使用端点。用openapi-appengine.yaml文件中的项目ID替换字符串YOUR-PROJECT-ID，用完整的主机名替换app.yaml文件中的ENDPOINTS-SERVICE-NAME。</p><p id="9f5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从GoogleCloudPlatform目录开始，复制文件:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="540b" class="jn jo hi jj b fi jp jq l jr js">cp functions/helloworld/index.js endpoints/getting-started/.<br/>cd endpoints/getting-started</span></pre><p id="3208" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据本<a class="ae jd" href="https://gist.github.com/alexamies/f2cda3c2db21dd4603d896a3b9079ab7" rel="noopener ugc nofollow" target="_blank">要点</a>，对App Engine代码进行一些更改以导入函数。具体来说，在app.js的顶部附近添加下面一行来导入您的GCF函数:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="2702" class="jn jo hi jj b fi jp jq l jr js">const mygcf = require(‘./index’);</span></pre><p id="df35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用这个实现替换echo <a class="ae jd" href="https://expressjs.com/en/guide/routing.html" rel="noopener ugc nofollow" target="_blank"> Express route </a>:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="d0e5" class="jn jo hi jj b fi jp jq l jr js">app.post(‘/echo’, (req, res) =&gt; {<br/> res.status(200).json({ message: mygcf.helloGET(req, res) }).end();<br/>});</span></pre><p id="adaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装额外的节点模块</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="9389" class="jn jo hi jj b fi jp jq l jr js">npm install -save <a class="ae jd" href="http://twitter.com/google" rel="noopener ugc nofollow" target="_blank">@google</a>-cloud/debug-agent<br/>npm install -save pug</span></pre><p id="d022" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署端点服务和后端:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="4081" class="jn jo hi jj b fi jp jq l jr js">gcloud endpoints services deploy openapi-appengine.yaml<br/>gcloud app deploy</span></pre><p id="068b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过向API端点发送请求来测试结果:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="edff" class="jn jo hi jj b fi jp jq l jr js">PROJECT_ID={Your project}<br/>ENDPOINTS_HOST=${PROJECT_ID}.appspot.com<br/>ENDPOINTS_KEY={Your key}<br/>curl — request POST \<br/> — header “content-type:application/json” \<br/> — data ‘{“message”:”hello world”}’ \<br/> “${ENDPOINTS_HOST}/echo?key=${ENDPOINTS_KEY}”</span></pre><p id="b125" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这很容易，可能比用GCF编写自己的认证和DDoS保护要容易得多。</p><p id="c072" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">修改端点API</p><p id="4748" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止，该解决方案利用了端点接口的API。这可以很容易地改变，以更好地匹配您正在移植的功能的语义。用gist中的版本替换您的openapi-appengine.yaml和app.js文件，然后重新部署端点服务和后端:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="3f4f" class="jn jo hi jj b fi jp jq l jr js">gcloud endpoints services deploy openapi-appengine.yaml<br/>gcloud app deploy</span></pre><p id="59f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">向新的API发送请求</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="fa67" class="jn jo hi jj b fi jp jq l jr js">curl --request GET \<br/>    --header "content-type:application/json" \<br/>    "${ENDPOINTS_HOST}/helloget?key=${ENDPOINTS_KEY}"<br/>curl --request POST \<br/>    --header "content-type:application/json" \<br/>    --data '{"name":"Tester"}' \<br/>    "${ENDPOINTS_HOST}/hellohttp?key=${ENDPOINTS_KEY}"</span></pre><p id="65d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">新的端点API现在更适合GCF示例:<br/>对/helloget的GET请求不带参数，对/hellohttp的POST请求带一个名为‘name’的参数。</p></div></div>    
</body>
</html>