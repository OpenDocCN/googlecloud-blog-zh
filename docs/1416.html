<html>
<head>
<title>Using Bigtable’s monitoring tools, meant for a petabyte-scale database, to… make art</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Bigtable的监控工具，意味着一个Pb级的数据库，来…制作艺术</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-a-petabyte-scale-databases-monitoring-tools-to-make-art-8aa8eb17234?source=collection_archive---------0-----------------------#2020-05-05">https://medium.com/google-cloud/using-a-petabyte-scale-databases-monitoring-tools-to-make-art-8aa8eb17234?source=collection_archive---------0-----------------------#2020-05-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/be67ce4618b988c215fb8e2086b9c3d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4KxPdCIkIQSChJSZSDSLuw.png"/></div></div></figure><p id="8ea9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">两年来，我一直在为谷歌的云Bigtable处理开发者关系。这是一个旨在处理数Pb数据的数据库，为许多核心谷歌服务提供支持，包括搜索、分析、地图和Gmail。然而，我创建的最大的表大约是100 MB——甚至不接近Bigtable所能支持的。</p><p id="c5c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Bigtable团队最近推出了他们的监控工具<a class="ae jo" href="https://cloud.google.com/blog/products/databases/cloud-database-monitoring-for-bigtable" rel="noopener ugc nofollow" target="_blank"> Key Visualizer </a>的改进版本，并且最近获得了一些额外的空闲时间，现在似乎是尝试加载大量数据并使用更新工具的好时机。</p><p id="9757" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我写了10TB的数据，并发现我可以对关键的可视化工具进行逆向工程，以创建艺术作品。</p><h1 id="9d53" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">什么是Bigtable</h1><p id="06f2" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">云Bigtable是<a class="ae jo" href="https://cloud.google.com/bigtable" rel="noopener ugc nofollow" target="_blank">谷歌的NoSQL大数据数据库服务</a>。它非常适合运行大型分析工作负载和构建低延迟应用程序。</p><p id="6eb6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您试图获得Bigtable的心理模型，有行和列，每个行/列交叉点是一个单元格。单元格中可以有多个值存储为版本，因此Bigtable表是一个包含行、列和版本的三维表。Bigtable是一个相当低级的数据库，所以它可以提供很好的QPS和可伸缩性，但是它提供了非常基本的查询功能，这些功能主要集中在行键上。您可以通过rowkey获取单行或扫描一系列行。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ks"><img src="../Images/aecf770905831113814fb46cfb9cca37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZwNTozEOUI1nmzonr36mcQ.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">一个关于移动设备的示例数据库。第一个单元具有多个时间版本，带有connected_wifi值的时间戳。</figcaption></figure><p id="79a3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于<a class="ae jo" href="https://cloud.google.com/bigtable/docs/schema-design" rel="noopener ugc nofollow" target="_blank">如何组织数据</a>，有许多潜在的安排，但基本上，你不希望过于频繁地查询同一个行键或一系列行键，这会导致性能问题。这就是关键可视化工具的用武之地。它允许您查看哪些行键或行键组被过于频繁地查询。</p><p id="0872" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我看到key visualizer可以基于读取吞吐量生成如下图所示的详细图像，所以我想知道<em class="lb">我是否可以颠倒这个过程，得出一组可以生成特定图像的读取结果？</em></p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lc"><img src="../Images/94ed9c0532318c9ed29906f51f665ea3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MOj0gIRQfUEfmo4D"/></div></div></figure><h1 id="d057" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">将10TB的数据加载到Bigtable中(不要在家里尝试)</h1><p id="4b79" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我使用Bigtable key visualizer的第一步是创建并填充一个数据库。我想加载1pb，但这似乎有点过分，并且不想占用太多可用于关键业务的资源。</p><p id="4086" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Github上提供了所有使用的代码和关于如何运行它的说明，所以我将给出代码做什么的高层次概述，但不会在这篇文章中进入太多的细节。</p><p id="5a71" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过云控制台创建和扩展Bigtable实例非常容易。对于10TB，我可以使用8个节点，这为我提供了足够的存储和吞吐量来快速加载我的数据。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lc"><img src="../Images/2f4af810dce00f91e22548da7066447b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9bxb8wgnnuBx7JUp"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">通过用户界面创建Bigtable实例。</figcaption></figure><p id="6d68" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可能会在侧边栏上注意到这是相当昂贵的，所以不要在家里尝试！对于在家尝试的更便宜的替代方法，您可以创建一个单节点实例，完成后应该关闭它。</p><p id="cddc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建实例后，我使用数据流将每行100MB的随机字节写入表中。总共10TB和每行100MB意味着我们将写入100，000行。为了避免<a class="ae jo" href="https://cloud.google.com/bigtable/docs/schema-design#sequential_numeric_ids" rel="noopener ugc nofollow" target="_blank">顺序写入</a>的任何问题，我使用了一个rowkey，它反转迭代次数并用零填充。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lc"><img src="../Images/0a5f000636c406428b9300970543903d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5MF75vJ3Ic22Lw61"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">运行数据流作业以加载数据</figcaption></figure><div class="kt ku kv kw fd ab cb"><figure class="ld ij le lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/af22a77034519904cad50ab22141df45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*632q9aI41fDG5lYG"/></div></figure><figure class="ld ij le lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/2ec238cde38d1eb574b7bfb2a3d977ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*OfOdHrruqe2CXHNt"/></div><figcaption class="kx ky et er es kz la bd b be z dx lj di lk ll translated">我在数据流作业增加时对其进行了监控(左图),并在Bigtable监控工具中看到了类似的活动增加(右图)</figcaption></figure></div><p id="8559" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">反向行键有所帮助，但我最终添加了一些节点，以保持在最大CPU利用率之下。数据加载后，我减少了节点。</p><h1 id="4a1f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">创建将激活KeyViz中像素的查询</h1><p id="3ea8" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">现在数据已经在表中了，我可以开始使用key visualizer来监控使用模式。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/2a4ee27a662c40bc2cae8cbb01965ecb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0TxfKeI6rxl9x_dWN4WQSQ.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">由加载数据作业生成的可视化效果。</figcaption></figure><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/934561d542fb09e1453d109d28ad6e5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wEfQH66fI5wyEseZCsC19Q.png"/></div></div></figure><p id="c39d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我发现，如果我不断地对某些细胞进行范围扫描，它们会在关键可视化器中激活。我写了一个数据流作业，可以根据输入的CSV执行范围扫描。我开始画了一个简单的笑脸。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/c13d817717be6042a2dee7d730e9513f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ve5JoyxE6oLQDVi2pX9nlA.png"/></div></div></figure><p id="6d8d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这让我知道，一旦我用那种格式写了图像，我就能画出各种各样的图像，但我想知道我是否能给图像增加更多的深度，并通过比其他区域更频繁地扫描某些区域来使用渐变。关键可视化提供15分钟的窗口输出。如果我的作业有一个范围的输入. 7，它将有70%的机会扫描该范围。由于每个窗口都有数百次扫描，我希望应用程序会做出相应的响应。我试着用下面的CSV扫描，很高兴看到我能够在我的图像中包含深度。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lc"><img src="../Images/51b190ddfe98362d7cbc0a80c44f48ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cz6kotaU6qD-46r9"/></div></div></figure><p id="5b6c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦我知道了key visualizer的功能，我做了一点数学和脚本来获取任何图像并将其转换成所需的CSV。为此，我写了一个<a class="ae jo" href="https://codepen.io/billyjacobson/pen/OJVxVzO" rel="noopener ugc nofollow" target="_blank">的便捷代码笔</a>，这样我就可以方便地添加更多的图片。我还添加了一个小时数的输入，它决定了生成的图像的质量。</p><p id="ef3f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦我创建了图像并上传到<a class="ae jo" href="https://cloud.google.com/storage/docs/access-control/making-data-public" rel="noopener ugc nofollow" target="_blank">公共桶</a>，我就运行一个管道来完成以下工作:</p><ol class=""><li id="5499" class="lo lp hi is b it iu ix iy jb lq jf lr jj ls jn lt lu lv lw bi translated">下载图像CSV</li><li id="a207" class="lo lp hi is b it lx ix ly jb lz jf ma jj mb jn lt lu lv lw bi translated">根据CSV的尺寸平均分配所有行键</li><li id="35bc" class="lo lp hi is b it lx ix ly jb lz jf ma jj mb jn lt lu lv lw bi translated">基于多个行键范围创建扫描–为了在visualizer中获得不同的强度/深度，使用CSV中的像素值有条件地使用特定范围</li><li id="9042" class="lo lp hi is b it lx ix ly jb lz jf ma jj mb jn lt lu lv lw bi translated">扫描桌子</li><li id="4d8e" class="lo lp hi is b it lx ix ly jb lz jf ma jj mb jn lt lu lv lw bi translated">每秒重复一次，每15分钟移动到下一列(每次监控更新的最小宽度)</li></ol><p id="d729" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您还可以从Github 查看和运行ReadData管道。</p><h1 id="9b97" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">大结局！</h1><p id="210b" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">然后…我等着！为了获得最高质量的图像，需要在几天内生成图像。关键可视化工具以15分钟的间隔给出更新，图像宽度的每个额外像素花费15分钟。图像高度由平板电脑的数量决定，大约是每千兆字节存储1个平板电脑，这相当大，所以在这里不是一个很大的限制。如果你在家里用一个更小的桌子，你的图像质量会更低，但仍然可以辨认。</p><p id="f6cd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我设置了几个表和作业同时运行，这样我可以得到更多的结果，如下所示:</p><div class="kt ku kv kw fd ab cb"><figure class="ld ij mc lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/78c4bb567dbae04be0577f94c8943339.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/0*yu4-dE4yRzVaAwKZ"/></div></figure><figure class="ld ij md lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/6e0ce7d508a121013f9307bf6a85e5b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/0*sL4PU1IwQSLr3-2k"/></div></figure></div><p id="8994" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有几个参数可以使用。亮度会改变图像的缩放比例，如果您想要深入查看较小的区域，这会很有帮助。</p><div class="kt ku kv kw fd ab cb"><figure class="ld ij me lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/e598f4898c81b9459a72a993abfefc7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/0*oM0I5s64IxdTM8-Z"/></div></figure><figure class="ld ij me lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/c918edb6e8a62ad14f6c962cc4afecfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/0*MQhoBOLb_rsBmfxk"/></div></figure><figure class="ld ij me lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/29a41a30e143e80aef21ebb7c236ca2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/0*QgC3R3XqJz2m4WNb"/></div></figure></div><div class="ab cb"><figure class="ld ij le lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/c8b7c8fc811d0cbe8a366fe14b3b5761.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*SdryG-EvCGpyGTaz"/></div></figure><figure class="ld ij le lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/2a50be44215a72cae34e68d60f5ebbf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*llgNzEYQ_9F0tLKX"/></div></figure></div><p id="44d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您还可以调整显示哪个指标。“读取字节客户端”似乎产生平滑的图像，而“Ops”产生更多线条的图像，在某些图像上看起来真的很酷。</p><div class="kt ku kv kw fd ab cb"><figure class="ld ij le lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/a0d9249add0c4845e4c1fec944d08311.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/0*MMfTQ1_t6X2CnFMV"/></div></figure><figure class="ld ij le lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/eee64d2b171caace4a885922650bd320.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/0*DthgjqdevVwEX4_L"/></div></figure></div><div class="ab cb"><figure class="ld ij mf lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/65d260cf9d0790f43277d5a8cc154129.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/0*eOpvBOehyFX7lyMd"/></div></figure><figure class="ld ij mg lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/77c216b0bd6a9a265c84791c5ee02974.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/0*Uw4bM03RGRNCV62y"/></div></figure></div><p id="57bd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，如果你和我一样是<a class="ae jo" href="http://twitter.com/theannalytical" rel="noopener ugc nofollow" target="_blank">变装和露波变装比赛的狂热爱好者，那么你就会明白为什么我也必须在关键的可视化工具中让变装皇后永垂不朽。</a></p><div class="kt ku kv kw fd ab cb"><figure class="ld ij mh lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/e6b44824a5526ffbc5ccbbed18c1884a.png" data-original-src="https://miro.medium.com/v2/resize:fit:742/0*Akooh6OnMHDpkAyT"/></div></figure><figure class="ld ij mi lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/24454c2cb62e3dc76add2548968acb38.png" data-original-src="https://miro.medium.com/v2/resize:fit:588/0*qJpGUXNThargT9KX"/></div></figure><figure class="ld ij mj lf lg lh li paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/bcea10b3dafcf6c8513f595feb86e091.png" data-original-src="https://miro.medium.com/v2/resize:fit:674/0*6K2r8ufMEb2v0vtA"/></div></figure></div></div></div>    
</body>
</html>