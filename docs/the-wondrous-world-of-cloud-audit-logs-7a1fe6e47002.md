# äº‘å®¡è®¡æ—¥å¿—çš„å¥‡å¦™ä¸–ç•Œï¼

> åŸæ–‡ï¼š<https://medium.com/google-cloud/the-wondrous-world-of-cloud-audit-logs-7a1fe6e47002?source=collection_archive---------0----------------------->

![](img/db90e5ababd8da6293cc9dcebf5d759c.png)

äº§ç”Ÿå®¡è®¡æ—¥å¿—çš„è°·æ­Œäº‘æœåŠ¡

å‡ ä¹æ¯ä¸ªè°·æ­Œäº‘æœåŠ¡éƒ½èƒ½åœ¨ä½ çš„é¡¹ç›®ä¸­äº§ç”Ÿä¸€ä¸ªäº‹ä»¶ï¼Œç§°ä¸º*äº‘å®¡è®¡æ—¥å¿—*ã€‚è¿™äº›æ—¥å¿—è®°å½•äº†é¡¹ç›®ä¸­çš„æ´»åŠ¨ã€‚ç¤ºä¾‹æ´»åŠ¨åŒ…æ‹¬:åˆ›å»ºæ–°çš„è™šæ‹Ÿæœºã€ä¿®æ”¹ IAM è§’è‰²æˆ–è®¿é—®äº‘å­˜å‚¨æ¡¶ã€‚

åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢äº‘å®¡è®¡æ—¥å¿—ï¼Œå¹¶å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Eventarc æ¥ç›‘å¬è¿™äº›æ—¥å¿—æµï¼Œé…ç½®äº‹ä»¶è¿‡æ»¤å™¨ï¼Œå¹¶è§¦å‘æ‚¨çš„äº‘è¿è¡ŒæœåŠ¡ã€‚

# ä»€ä¹ˆæ˜¯äº‘å®¡è®¡æ—¥å¿—ï¼Ÿ

äº‘å®¡è®¡æ—¥å¿—æ˜¯é’ˆå¯¹*ç®¡ç†æ´»åŠ¨*ã€*æ•°æ®è®¿é—®*ã€*ç³»ç»Ÿäº‹ä»¶*å’Œ*ç­–ç•¥è¢«æ‹’ç»*äº‹ä»¶çš„æ—¥å¿—æµã€‚è¿™äº›äº‹ä»¶é€šå¸¸ç”¨äºå¸®åŠ©å®¢æˆ·æ»¡è¶³å®¡è®¡å’Œæ³•è§„éµä»æ€§éœ€æ±‚ã€‚ä»–ä»¬ä¼šå›ç­”ä½ é¡¹ç›®ä¸­çš„â€œè°åœ¨ä½•æ—¶ä½•åœ°åšäº†ä»€ä¹ˆâ€ã€‚[ğŸ”—](https://cloud.google.com/logging/docs/audit)

ä»¥ä¸‹æ˜¯å®¡è®¡æ—¥å¿—ç±»å‹:

1 ***ç®¡ç†æ´»åŠ¨*** *å®¡è®¡æ—¥å¿—*åŒ…å« **API è°ƒç”¨**æˆ–**ä¿®æ”¹** **é…ç½®**æˆ–å…ƒæ•°æ®çš„å…¶ä»–æ“ä½œçš„æ—¥å¿—æ¡ç›®ã€‚[ğŸ”—](https://cloud.google.com/logging/docs/audit#admin-activity)

2 ***æ•°æ®è®¿é—®*** *å®¡è®¡æ—¥å¿—*è®°å½•è¯»å–èµ„æºé…ç½®ã€å…ƒæ•°æ®çš„ API è°ƒç”¨ï¼Œæˆ–è€…è¯»å–æˆ–å†™å…¥èµ„æºæ•°æ®çš„**ç”¨æˆ·çº§ API è°ƒç”¨**ã€‚[ğŸ”—](https://cloud.google.com/logging/docs/audit#data-access)

3 ***ç³»ç»Ÿäº‹ä»¶*** *å®¡è®¡æ—¥å¿—*è®°å½•ä» Google systems ç”Ÿæˆçš„ç³»ç»Ÿç®¡ç†ä¿¡æ¯â€”â€”ä¸æ˜¯ç”±ç”¨æˆ·ç›´æ¥æ“ä½œé©±åŠ¨çš„ã€‚[ğŸ”—](https://cloud.google.com/logging/docs/audit#system-event)

4 ***ç­–ç•¥è¢«æ‹’ç»*** *å®¡è®¡æ—¥å¿—*è®°å½•æœåŠ¡å¸æˆ·æˆ–ç”¨æˆ·å¯¹æœåŠ¡çš„æœªæˆæƒè®¿é—®å°è¯•ï¼Œè¿™åœ¨æŸäº›æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ã€‚[ğŸ”—](https://cloud.google.com/logging/docs/audit#policy_denied)

æˆ‘ä¸ªäººå‘ç° ***æ•°æ®è®¿é—®*** æ—¥å¿—åŒ…å«æœ‰ç”¨çš„äº‹ä»¶ä¿¡æ¯ã€‚æˆ‘ä»¬å°†åœ¨è¿™ç¯‡åšæ–‡çš„å…¶ä½™éƒ¨åˆ†å¼•ç”¨è¿™äº›æ—¥å¿—ã€‚

# å¯ç”¨å®¡è®¡æ—¥å¿—

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæˆ‘ä»¬æƒ³è¦ç”Ÿæˆå®¡è®¡äº‹ä»¶çš„æœåŠ¡å¯ç”¨æ•°æ®è®¿é—®å®¡è®¡æ—¥å¿—ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ IAM å’Œ Admin ä¸‹çš„ Audit Logs é¡µé¢ä¸­å¯ç”¨äº‹ä»¶:

![](img/9c8aef486c1fa0946de99a9d342b6347.png)

[https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit)

> æ‚¨å¯ä»¥ä½¿ç”¨é»˜è®¤é…ç½®ä¸ºæ‰€æœ‰æœåŠ¡å¯ç”¨å®¡è®¡æ—¥å¿—ï¼Œå°½ç®¡æˆ‘å‘ç°é€šè¿‡å•ç‹¬é€‰æ‹©æœåŠ¡æ›´å®¹æ˜“æ‰¾åˆ°æˆ‘æƒ³è¦è§‚å¯Ÿçš„æ—¥å¿—æ¡ç›®ã€‚

# æŸ¥çœ‹å®¡è®¡æ—¥å¿—

å¯ç”¨å®¡è®¡æ—¥å¿—åï¼Œæ‚¨çš„é¡¹ç›®å°†å¼€å§‹ç”Ÿæˆå¹¶ä¿ç•™è¿™äº›æ—¥å¿—ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ•°æ®è®¿é—®æ—¥å¿—ä¿ç•™ 30 å¤©ã€‚

## æ—¥å¿—æµè§ˆå™¨

æŸ¥çœ‹æ—¥å¿—çš„ä¸€ä¸ªå¥½æ–¹æ³•æ˜¯é€šè¿‡æ—¥å¿—æµè§ˆå™¨ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨æœ‰ä¸€ä¸ªå¼ºå¤§çš„æŸ¥è¯¢ç•Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­æŸ¥çœ‹æˆ‘ä»¬çš„æ•°æ®è®¿é—®æ—¥å¿—:

![](img/60d838e1263acc09b0264215eb66b4da.png)

[æ—¥å¿—æµè§ˆå™¨>æ—¥å¿—åç§°è¿‡æ»¤å™¨](https://console.cloud.google.com/logs/query)

å½“åœ¨æ‚¨çš„é¡¹ç›®ä¸­æ‰§è¡ŒæŸä¸ªæ“ä½œæ—¶ï¼Œæ‚¨å°†ä¼šçœ‹åˆ°ä¸€ä¸ªå®¡è®¡æ—¥å¿—ï¼Œæ¯”å¦‚è¿™ä¸ªåˆ›å»ºäº‘å‡½æ•°çš„æ—¥å¿—(ä¸€äº›ä¸ªäººæ•°æ®æ˜¯ä¼ªé€ çš„):

![](img/40da41de90ca5d6184b610ffce4e1a58.png)

å¸¦æœ‰çº¢è‰²çŸ©å½¢çš„æ‰©å±•å®¡è®¡æ—¥å¿—æ¡ç›®ï¼Œçªå‡ºæ˜¾ç¤ºæ—¥å¿—çš„ ***æœåŠ¡å*** ã€**æ–¹æ³•å**å’Œ**èµ„æºå**ã€‚

åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼Œå…¶ä¸­åŒ…å«æˆ‘ä»¬çš„`protoPayload`ä¸­ä¸€äº›æœ‰ç”¨çš„å­—æ®µã€‚ä»¥ä¸‹æ˜¯ä¸€äº›äº®ç‚¹:

*   `serviceName`(å§‹ç»ˆå­˜åœ¨):è¢«è®°å½•çš„ API/æœåŠ¡ã€‚
*   `methodName`(å§‹ç»ˆå­˜åœ¨):åœ¨æœåŠ¡ä¸­æ‰§è¡Œçš„åŠ¨ä½œã€‚
*   `resourceName`(æœ‰æ—¶å­˜åœ¨):æ‰§è¡ŒåŠ¨ä½œæ—¶è¢«ä¿®æ”¹çš„èµ„æºã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è®°å½•äº†æ–¹æ³•(`CreateFunction`)å’Œå…³äºå‡½æ•°çš„ç»†èŠ‚(å‡½æ•°åœ¨`secret-project`ï¼Œä½ç½®`us-central1`ï¼Œå‡½æ•°å`new-function`)ã€‚

# ä½¿ç”¨ Eventarc è§¦å‘äº‘è¿è¡ŒæœåŠ¡

ç°åœ¨æ‚¨å·²ç»åˆ›å»ºäº†ä¸€ä¸ªå®¡è®¡æ—¥å¿—ï¼Œæ‚¨å¯ä»¥ç”¨è¿™äº›ä¿¡æ¯åšä»€ä¹ˆå‘¢ï¼Ÿ

ä½¿ç”¨ Eventarcï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨æ¥ç›‘å¬è¿™äº›å®¡è®¡æ—¥å¿—ï¼Œå¹¶ä»¥ CloudEvent çš„å½¢å¼å‘äº‘è¿è¡ŒæœåŠ¡å‘é€ HTTP è¯·æ±‚ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ª`gcloud`å‘½ä»¤çš„ä¾‹å­:

åˆ›å»ºæ–° Eventarc è§¦å‘å™¨çš„ gcloud å‘½ä»¤

å› æ­¤ï¼Œæ¯å½“æ‚¨çš„é¡¹ç›®çœ‹åˆ°å¸¦æœ‰è¿™ä¸ª`serviceName`å’Œ`methodName`çš„å®¡è®¡æ—¥å¿—æ—¶ï¼ŒEventarc å°†å‘æ‚¨çš„è¿è¡ŒæœåŠ¡å‘é€ä¸€ä¸ªå¸¦æœ‰å®¡è®¡æ—¥å¿—çš„ HTTP ä¸»ä½“çš„`POST`è¯·æ±‚ã€‚

## (å¯é€‰)ä½¿ç”¨ Google CloudEvent åº“

æ ¹æ®æ‚¨çš„äº‘è¿è¡ŒæœåŠ¡çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ‚¨å¯èƒ½å¸Œæœ›ä¸º CloudEvent æœ‰æ•ˆè´Ÿè½½æä¾›æŸç§ç±»å‹çš„è‡ªåŠ¨å®Œæˆã€‚

Google æä¾›äº†ä¸€äº›ç±»å‹åº“ï¼Œå¯ä»¥å¸®åŠ©æ‚¨çš„åº”ç”¨ç¨‹åºä½¿ç”¨è¿™äº›äº‹ä»¶:

*   **èŠ‚ç‚¹/æ‰“å­—ç¨¿**:[github.com/googleapis/google-cloudevents-nodejs](https://github.com/googleapis/google-cloudevents-nodejs)
*   **èµ°**:[github.com/googleapis/google-cloudevents-go](https://github.com/googleapis/google-cloudevents-go)
*   **Java**:[github.com/googleapis/google-cloudevents-java](https://github.com/googleapis/google-cloudevents-java)

å‡ºäºå¥½å¥‡ï¼Œè¿™äº›åº“æ˜¯ä» GitHub ä¸Šå¼€æºçš„ *protobufs* å’Œ *JSON schemas* ä¸­ç”Ÿæˆçš„:

> [https://github.com/googleapis/google-cloudevents](https://github.com/googleapis/google-cloudevents)

æ„Ÿè°¢é˜…è¯»ï¼å¦‚æœä½ å­¦åˆ°äº†ä»€ä¹ˆï¼Œè¯·æ‰“ç¢å®ƒğŸ‘ï¼