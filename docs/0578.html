<html>
<head>
<title>How to deploy a React application to Google Cloud using Bitbucket Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Bitbucket管道将React应用程序部署到Google Cloud</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-deploy-a-react-application-to-google-cloud-using-bitbucket-pipelines-8bc59d78d3af?source=collection_archive---------0-----------------------#2018-04-20">https://medium.com/google-cloud/how-to-deploy-a-react-application-to-google-cloud-using-bitbucket-pipelines-8bc59d78d3af?source=collection_archive---------0-----------------------#2018-04-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="cd3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在过去的几周里，我一直在拼凑多篇文章、博客帖子和文档。为了回馈社区，我正在分享我所学到的东西。</p><p id="2671" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">注意:我将把各种文档的部分拼凑在一起。我意识到一些文档可能会有一些差异，我的目标是让你以最简单的方式开始完成。</em></p><h2 id="8eb6" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">示例变量</h2><p id="4a32" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">Google Cloud Project = <code class="du ke kf kg kh b">your-project-name</code> <br/>节点版本= <code class="du ke kf kg kh b">9.11.1</code> <br/>源代码目录(不部署)= <code class="du ke kf kg kh b">app/</code> <br/>编译目录(部署)= <code class="du ke kf kg kh b">dist/</code></p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ki"><img src="../Images/82d7846d523a7c446ae49666b9de1e82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QQUhuRgF0N1A-ZhMWKFESA.jpeg"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated">照片由<a class="ae ky" href="https://www.pexels.com/@pixabay" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>拍摄</figcaption></figure><h1 id="3f3e" class="kz jf hi bd jg la lb lc jk ld le lf jo lg lh li jr lj lk ll ju lm ln lo jx lp bi translated">设置谷歌云</h1><p id="25cc" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">首先，如果你还没有的话，你需要建立一个谷歌云账户。</p><ol class=""><li id="c118" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc lv lw lx ly bi translated">选择或创建GCP项目(<a class="ae ky" href="https://console.cloud.google.com/cloud-resource-manager" rel="noopener ugc nofollow" target="_blank">管理资源页面</a>)</li><li id="5b0f" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">确保您的项目启用了计费功能(<a class="ae ky" href="https://cloud.google.com/billing/docs/how-to/modify-project" rel="noopener ugc nofollow" target="_blank">了解如何使用</a>)</li><li id="1e75" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">启用应用引擎管理API ( <a class="ae ky" href="https://console.cloud.google.com/flows/enableapi?apiid=appengine" rel="noopener ugc nofollow" target="_blank">启用API</a>)</li></ol><h2 id="f2e1" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">为位桶创建授权凭据</h2><p id="3767" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">创建应用引擎服务帐户和API密钥。Bitbucket需要这些信息来部署到App Engine。</p><ol class=""><li id="f79c" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc lv lw lx ly bi translated">在谷歌云平台控制台，进入<a class="ae ky" href="https://console.cloud.google.com/apis/credentials" rel="noopener ugc nofollow" target="_blank">凭证</a>页面。</li><li id="c40f" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">点击<strong class="ih hj">创建凭证&gt;服务账号键</strong>。</li><li id="4a84" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">在下一页中，在服务帐户下拉列表中选择<strong class="ih hj">计算引擎默认服务帐户</strong>。</li><li id="66fd" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">点击<strong class="ih hj">创建</strong>按钮。JSON文件的副本将下载到您的计算机上。<strong class="ih hj"> <em class="jd">(这是你的JSON凭证文件)</em> </strong></li></ol><h2 id="5cad" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">创建应用程序引擎应用程序</h2><p id="5c67" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">管道脚本要求您的项目具有App Engine应用程序。要创建App Engine应用程序:</p><ol class=""><li id="3a71" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc lv lw lx ly bi translated">在云平台控制台，转到<a class="ae ky" href="https://console.cloud.google.com/?cloudshell=true" rel="noopener ugc nofollow" target="_blank">云壳</a>。</li><li id="0bbc" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">运行<code class="du ke kf kg kh b">gcloud app create</code>来创建你的默认应用引擎应用</li></ol><h2 id="04c0" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">配置应用引擎</h2><p id="3b5b" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">创建一个新文件，将其另存为<code class="du ke kf kg kh b">app.yaml</code>，并将以下代码粘贴到其中。确保将该文件保存在项目的根目录下(与<code class="du ke kf kg kh b">package.json</code>在同一个位置)。</p><p id="19b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，当Google Cloud部署时，它会上传项目中的每个文件。如果你像我一样，不想等待<strong class="ih hj">小时</strong>来上传所有未编译的源代码(包括<code class="du ke kf kg kh b">node_modules</code>)，那么你需要修改下面配置中的<code class="du ke kf kg kh b">skip_files</code>。将<code class="du ke kf kg kh b">dist</code>替换为编译后的代码目录，将<code class="du ke kf kg kh b">app</code>替换为源文件目录。</p><p id="0d46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">指定跳过哪些文件会覆盖默认设置，所以我也把它们放在我的<code class="du ke kf kg kh b">node_modules/</code>下面，以免意外上传任何额外的东西。</p><pre class="kj kk kl km fd me kh mf mg aw mh bi"><span id="763d" class="je jf hi kh b fi mi mj l mk ml">runtime: python27<br/>api_version: 1<br/>threadsafe: true<br/>handlers:<br/>- url: /(.*\.(html|css|js|png|jpg|woff|json))<br/>  static_files: dist/\1<br/>  upload: dist/(.*\.(html|css|js|png|jpg|woff|json))<br/>- url: /.*<br/>  static_files: dist/index.html<br/>  upload: dist/index.html<br/>- url: /<br/>  static_dir: build<br/>skip_files:<br/>- app/<br/>- node_modules/<br/>- ^\.git/.*<br/>- ^(.*/)?#.*#$<br/>- ^(.*/)?.*~$<br/>- ^(.*/)?.*\.py[co]$<br/>- ^(.*/)?.*/RCS/.*$<br/>- ^(.*/)?\..*$<br/>- ^(.*/)?.*\.bak$</span></pre><p id="88b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">注意:如果使用制表符，文件将无法正常执行。</em> <code class="du ke kf kg kh b"><em class="jd">.yml</em></code> <em class="jd">文件只能使用空格。</em></p><h1 id="f355" class="kz jf hi bd jg la lb lc jk ld le lf jo lg lh li jr lj lk ll ju lm ln lo jx lp bi translated">设置位桶</h1><p id="de66" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">如果您还没有创建回购，那么您将需要启用<strong class="ih hj">管道</strong>。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mm"><img src="../Images/9267945fca2f37846593760eb8af5f89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YYabh3F8DNmNzdXAdISLVg.png"/></div></div></figure><p id="54e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择<strong class="ih hj"> JavaScript </strong>作为您的选项，并将配置更新为</p><pre class="kj kk kl km fd me kh mf mg aw mh bi"><span id="859e" class="je jf hi kh b fi mi mj l mk ml">image: node:9.11.1</span><span id="3c85" class="je jf hi kh b fi mn mj l mk ml">options:<br/>  max-time: 10<br/>pipelines:<br/> default:<br/> — step:<br/> name: Build Application<br/> caches:<br/> — node<br/> script:<br/> — npm install<br/> — npm run build<br/> artifacts:<br/> — dist/** # change this to your build directory<br/> — step:<br/> name: Deploy to GCloud<br/> deployment: staging<br/> script:<br/> # Set a couple variables for readability<br/> — SDK_VERSION=197.0.0<br/> — SDK_FILENAME=google-cloud-sdk-${SDK_VERSION}-linux-x86_64.tar.gz<br/> # Install Google Cloud SDK<br/> — curl -o /tmp/google-cloud-sdk.tar.gz <a class="ae ky" href="https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/${SDK_FILENAME" rel="noopener ugc nofollow" target="_blank">https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/${SDK_FILENAME</a>}<br/> — tar -xvf /tmp/google-cloud-sdk.tar.gz -C /tmp/<br/> — /tmp/google-cloud-sdk/install.sh -q<br/> — source /tmp/google-cloud-sdk/path.bash.inc<br/> — gcloud -v<br/> # Authenticating with the service account key file<br/> — echo $GCLOUD_API_KEYFILE | base64 — decode — ignore-garbage &gt; ./gcloud-api-key.json<br/> — gcloud auth activate-service-account — key-file gcloud-api-key.json<br/> # Linking to the Google Cloud project<br/> — gcloud config set project $GCLOUD_PROJECT<br/> # Deploying the application<br/> — gcloud app deploy</span></pre><p id="acd2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">注意:如果使用制表符，文件将无法正常执行。</em> <code class="du ke kf kg kh b"><em class="jd">.yml</em></code> <em class="jd">文件只能使用空格。</em></p><h2 id="73ea" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">配置管道脚本所需的环境变量</h2><p id="e2d0" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">打开您的终端，浏览到您之前的<strong class="ih hj"> JSON凭证文件</strong>的位置。然后运行下面的命令以base64格式编码您的文件。将命令的输出复制到剪贴板。</p><p id="57ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ke kf kg kh b">base64 &lt;your-credentials-file.json&gt;</code></p><p id="470c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到Bitbucket中的存储库设置，并导航到<strong class="ih hj">管道</strong> &gt; <strong class="ih hj">环境变量</strong> <em class="jd">。</em>创建一个名为<code class="du ke kf kg kh b">GCLOUD_API_KEYFILE</code>的新变量，并将编码后的服务帐户凭证粘贴到其中。</p><p id="2ceb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加另一个名为<code class="du ke kf kg kh b">GCLOUD_PROJECT</code>的变量，并将该值设置为您在第一步<code class="du ke kf kg kh b">your-project-name</code>中创建的Google Cloud项目的键</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mo"><img src="../Images/97ca642d48471b7dede1b54ab9f2ef4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M4L5-vHnGAbB__VC8hsFXA.png"/></div></div></figure><p id="626f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">注意:您不需要为这些字段</em>中的任何一个勾选 <strong class="ih hj"> <em class="jd">安全</em> </strong> <em class="jd"/></p><h1 id="3827" class="kz jf hi bd jg la lb lc jk ld le lf jo lg lh li jr lj lk ll ju lm ln lo jx lp bi translated">配置节点</h1><p id="0f92" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">Google Cloud不能从<code class="du ke kf kg kh b">devDependencies</code>开始读取，所以你会想把任何必要的包扔进<code class="du ke kf kg kh b">dependencies</code>中，对我来说，那最终是<strong class="ih hj">所有的东西</strong>，但是我会通过它返回并在可能的地方清理。</p><p id="863d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的<code class="du ke kf kg kh b">package.json</code>中添加一个部分，指定您的项目运行在哪个版本的节点上。</p><pre class="kj kk kl km fd me kh mf mg aw mh bi"><span id="2ed1" class="je jf hi kh b fi mi mj l mk ml">"engines": {<br/>  "node": "9.11.1"<br/>}</span></pre><h1 id="025d" class="kz jf hi bd jg la lb lc jk ld le lf jo lg lh li jr lj lk ll ju lm ln lo jx lp bi translated">结论</h1><p id="80d1" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">如果一切都设置妥当，那么这就是您的部署流程。</p><ol class=""><li id="71ac" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc lv lw lx ly bi translated">将代码推送到您的bitbucket repo</li><li id="c46a" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">比特桶运行<code class="du ke kf kg kh b">npm install</code>和<code class="du ke kf kg kh b">npm run build</code></li><li id="5e38" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">来自<code class="du ke kf kg kh b">npm run build</code>的静态文件可以在<code class="du ke kf kg kh b">dist/</code>(你编译的代码目录)获得</li><li id="1ed2" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">Bitbucket安装谷歌云SDK</li><li id="b19c" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">比特桶运行<code class="du ke kf kg kh b">gcloud app deploy</code></li><li id="467f" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">Google Cloud App Deploy会将所有文件从<code class="du ke kf kg kh b">dist/</code>上传到Google Cloud Bucket</li><li id="6224" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">Google Cloud App Deploy将更新您的Google Cloud App Engine服务</li><li id="9dd7" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">您的应用程序被部署到<code class="du ke kf kg kh b"><a class="ae ky" href="https://your-project-name.appspot.com" rel="noopener ugc nofollow" target="_blank">https://your-project-name.appspot.com</a></code></li></ol><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es mp"><img src="../Images/8d6dd89c58305fb9359897141ecf2161.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*bR3z88JWuF7rBetZbMBVkg.gif"/></div><figcaption class="ku kv et er es kw kx bd b be z dx translated">万岁，你做到了！</figcaption></figure><h1 id="df9d" class="kz jf hi bd jg la lb lc jk ld le lf jo lg lh li jr lj lk ll ju lm ln lo jx lp bi translated">资源</h1><p id="4e56" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">这些是我拼凑起来的各种文件和文章</p><ul class=""><li id="ad60" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc mq lw lx ly bi translated"><a class="ae ky" href="https://confluence.atlassian.com/bitbucket/deploy-to-google-cloud-900820342.html" rel="noopener ugc nofollow" target="_blank">https://confluence . atlassian . com/bit bucket/deploy-to-Google-cloud-900820342 . html</a></li><li id="5a56" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc mq lw lx ly bi translated"><a class="ae ky" rel="noopener" href="/google-cloud/how-to-deploy-a-static-react-site-to-google-cloud-platform-55ff0bd0f509">https://medium . com/Google-cloud/how-to-deploy-a-static-react-site-to-Google-cloud-platform-55 ff 0 BD 0 f 509</a></li><li id="6de3" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc mq lw lx ly bi translated"><a class="ae ky" href="https://cloud.google.com/solutions/continuous-delivery-bitbucket-app-engine" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/solutions/continuous-delivery-bit bucket-app-engine</a></li><li id="3dbd" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc mq lw lx ly bi translated"><a class="ae ky" href="https://cloud.google.com/appengine/docs/standard/python/getting-started/deploying-the-application" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/app engine/docs/standard/python/getting-started/deploying-the-application</a></li></ul><h2 id="c09e" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated"><strong class="ak"> <em class="mr"> Bug:部署超时问题</em> </strong></h2><p id="c1e7" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">有一个谷歌知道的已知问题导致部署无缘无故挂起。我建议给你的<code class="du ke kf kg kh b">bitbucket-pipelines.yml</code>增加一个选项，我在上面提到过，让<code class="du ke kf kg kh b">max-time: 10</code>如果花费超过10分钟，这将导致管道失败。请确保根据您的部署时间进行调整，我的应该需要2-3分钟。如果失败，您将需要手动重新运行管道，有时需要尝试几次。</p></div></div>    
</body>
</html>