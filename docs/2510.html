<html>
<head>
<title>GCP — BigQuery — Data Security at rest (Part 4)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP —大查询—静态数据安全(第4部分)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-bigquery-data-security-at-rest-part-4-c6f4db9a0f13?source=collection_archive---------5-----------------------#2022-11-15">https://medium.com/google-cloud/gcp-bigquery-data-security-at-rest-part-4-c6f4db9a0f13?source=collection_archive---------5-----------------------#2022-11-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="660d" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">到目前为止，在博客的第3部分中，我们讨论了作为GCP一部分的aead加密功能。</p><p id="5bb6" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">我们将进一步讨论如何使用DLP和云KMS对列数据进行加密，以及如何设计一个通用的加密/解密工具。这个博客的重点是展示Bigquery与其他GCP服务更广泛、更丰富的集成。</p><p id="efbc" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">这篇博客是“Bigquery —静态数据安全”5部分系列文章的一部分。<br/>点击此处查看<a class="ae jh" rel="noopener" href="/google-cloud/gcp-bigquery-data-security-at-rest-part-3-915ce0cff883">系列第四部</a> <br/>点击此处查看<a class="ae jh" rel="noopener" href="/google-cloud/gcp-bigquery-data-security-at-rest-series-menu-1e59e1793deb">系列菜单</a></p></blockquote><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ji"><img src="../Images/34cfaa93c06bdc8958cdbb3eff79f503.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BHbXZ4n0NLf9EF_cGpYppA.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">Bigquery安全控件。</figcaption></figure></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><h2 id="2cf5" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">使用云KMS和DLP进行加密</h2><p id="e131" class="pw-post-body-paragraph ii ij hi il b im ld io ip iq le is it kq lf iw ix ku lg ja jb ky lh je jf jg hb bi translated">在本主题中，我们将讨论如何创建一个可重用的实用程序，它不仅可以执行来自Bigquery的加密/解密请求，还可以执行来自任何其他客户端(REST、python)的加密/解密请求。</p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><h2 id="963d" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">使用Bigquery实现云KMS</h2><p id="017e" class="pw-post-body-paragraph ii ij hi il b im ld io ip iq le is it kq lf iw ix ku lg ja jb ky lh je jf jg hb bi translated">在博客的第3部分，我们看到了大量关于如何利用由tink库和云KMS支持的AEAD加密来加密/解密数据的内容。</p><p id="ab71" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">在本节中，我们将看到另一种具有集中式云功能的方法，它可以用作利用远程功能的加密/解密工具。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es li"><img src="../Images/1243a1b2056c27645527a8aad20b5d97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_-PUfQE10s1xGt5PPpq2UA.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">用于加密/解密的云KMS</figcaption></figure><p id="de23" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">首先，我们将创建一个云KMS密钥和云函数，可以使用该密钥执行加密/解密。</p><p id="39fe" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">为了让Bigquery远程函数工作，有效负载需要满足下面的<a class="ae jh" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/remote-functions#input_format" rel="noopener ugc nofollow" target="_blank">标准</a>。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es lj"><img src="../Images/c22c0b6254a59172af6b3fe3892a282b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AnO3QNy13x1QRVpHIPwiTA.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">Bigquery远程函数(请求)</figcaption></figure><p id="9d38" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">使用来自云KMS的对称密钥执行加密/解密的云函数如下</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es lk"><img src="../Images/763d28a449d847cccd9465e0d4bbf0a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iigrtuLMg7o5vteNRz4leg.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">使用云KMS加密</figcaption></figure><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ll"><img src="../Images/12019a2e4ca8980486c4fb557e2720c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3_xCmcVLH1IxCKVDuNn07g.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">使用云KMS解密</figcaption></figure><p id="2a3e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">应向云功能服务帐户提供访问云KMS密钥和执行操作所需的角色</p><p id="bca8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">一旦该函数启动并运行，就可以创建一个BigQuery连接和远程函数，如下所示</p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><p id="571d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">需要创建一个提供连接服务帐户的Bigquery连接，需要向该帐户提供CloudFunctionInvoker角色。</p><pre class="jj jk jl jm fd lm ln lo bn lp lq bi"><span id="90bf" class="lr kg hi ln b be ls lt l lu lv">bq mk --connection --display_name='encrypt_decrypt' \<br/>--connection_type=CLOUD_RESOURCE \<br/>--project_id=&lt;&gt; \<br/>--location=us-central1 \<br/>encrypt_decrypt_connection</span></pre><p id="ab57" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">大查询远程功能可以设置如下</p><pre class="jj jk jl jm fd lm ln lo bn lp lq bi"><span id="5c19" class="lr kg hi ln b be ls lt l lu lv">CREATE FUNCTION `&lt;&gt;.&lt;&gt;`.symmetric_encrypt(data string) RETURNS string<br/>REMOTE WITH CONNECTION `&lt;&gt;.us-central1.encrypt_decrypt_connection`<br/>OPTIONS (endpoint = 'https://us-central1-&lt;&gt;.cloudfunctions.net/encrypt_decrypt_function',<br/>  user_defined_context= [("mode","encrypt"), ("key_type","symmetric")]);<br/><br/>CREATE FUNCTION `&lt;&gt;.&lt;&gt;`.symmetric_decrypt(data string) RETURNS string<br/>REMOTE WITH CONNECTION `&lt;&gt;.us-central1.encrypt_decrypt_connection`<br/>OPTIONS (endpoint = 'https://us-central1-&lt;&gt;.cloudfunctions.net/encrypt_decrypt_function',<br/>  user_defined_context= [("mode","decrypt"), ("key_type","symmetric")]);</span></pre><blockquote class="if ig ih"><p id="9520" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">“用户定义的上下文”用于指示请求是<strong class="il hj">加密</strong>还是<strong class="il hj">解密。<br/> </strong>这可以认为是将参数传递给一个函数，并根据参数采取行动。</p></blockquote><p id="43bb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">设置完成后，可以通过远程函数调用bigquery加密/解密。</p><pre class="jj jk jl jm fd lm ln lo bn lp lq bi"><span id="ed1c" class="lr kg hi ln b be ls lt l lu lv">select name, <br/>`&lt;&gt;`.&lt;&gt;.symmetric_encrypt(name) as symmetric_encrypted,<br/>from<br/>(select name from `&lt;&gt;.dataset_us_central1.basic_df_users` limit 5);</span></pre><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es lw"><img src="../Images/448932d08179821cb2e2751d7befd912.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RFioRFl2HoMidtUUz0_B0g.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">来自Bigquery的加密调用</figcaption></figure><p id="927d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">解密函数可以以类似的方式调用。</p><pre class="jj jk jl jm fd lm ln lo bn lp lq bi"><span id="8e5e" class="lr kg hi ln b be ls lt l lu lv">select <br/>`&lt;&gt;`.&lt;&gt;.symmetric_decrypt(symmetric_encrypted) as symmetric_decrypted,<br/>from <br/>`&lt;&gt;.encrypted_table`;</span></pre><figure class="jj jk jl jm fd jn er es paragraph-image"><div class="er es lx"><img src="../Images/573ff78bd8c1bd704cbcf84163b16ad3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*L4BR3zbxAJS_rxcbNGFUrQ.png"/></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">解密数据输出。</figcaption></figure><p id="ceb8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">云功能也可以独立调用。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ly"><img src="../Images/6d2f3368a6c620debd73f036c1ba9832.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W4Iw_gCAnrO2yIUBKegZLA.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">云函数测试</figcaption></figure><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es lz"><img src="../Images/ea8653bdc11f112d06cf316cf5c0980b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZT0cfRUxjmQb1TAbRnkMRg.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">加密响应</figcaption></figure></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><blockquote class="if ig ih"><p id="4099" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">注意事项<br/> 1。</strong>云KMS提供了执行对称和非对称加密的能力，但是如果要求确定性加密，则应使用aead或dlp。<br/> 2。云KMS库目前不提供批处理请求，因此应该检查批量加密场景的性能影响。</p></blockquote></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><h2 id="b874" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">使用云DLP加密</h2><p id="b280" class="pw-post-body-paragraph ii ij hi il b im ld io ip iq le is it kq lf iw ix ku lg ja jb ky lh je jf jg hb bi translated">使用云DLP的加密遵循与上述云KMS完全相同的设置。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ma"><img src="../Images/5ecf4e3f5d7114b39ee7c6110e7b14c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oVMNmhgeovp3-apuFlSGUQ.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">用于加密/解密的云DLP</figcaption></figure><p id="0323" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">在此设置中，云DLP识别模板是使用格式保留加密创建的。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es mb"><img src="../Images/be395a688269b6822b80b4d1ed8cd300.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3WyI8fJva4CFIrS0iYqNZw.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">取消模板标识</figcaption></figure><p id="7eaa" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">其余的设置与云KMS类似，唯一的区别是云函数调用DLP API进行加密/解密</p><blockquote class="if ig ih"><p id="404a" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">注意事项<br/> 1。</strong>调用DLP APIs需要成本，设置<br/> 2时应考虑这一点。应根据请求数量和配额限制来监控加密/解密的性能。<br/> 3。DLP允许对请求进行批处理，在实施过程中应该注意这一点。</p></blockquote></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><blockquote class="if ig ih"><p id="bf4c" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">我们将继续本系列的<a class="ae jh" rel="noopener" href="/google-cloud/gcp-bigquery-data-security-at-rest-part-5-965caba934ea">第5部分的最后一部分——行级安全性。</a></p></blockquote><p id="52c6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">如有任何疑问，请通过https://www.linkedin.com/in/murli-krishnan-a1319842/<a class="ae jh" href="https://www.linkedin.com/in/murli-krishnan-a1319842/" rel="noopener ugc nofollow" target="_blank">与我联系。</a></p><p id="af79" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">快乐学习。</p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><h2 id="83a9" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated"><strong class="ak">参考文献</strong></h2><p id="ece0" class="pw-post-body-paragraph ii ij hi il b im ld io ip iq le is it kq lf iw ix ku lg ja jb ky lh je jf jg hb bi translated"><a class="ae jh" href="https://cloud.google.com/functions/quotas" rel="noopener ugc nofollow" target="_blank">云功能配额/限额</a> <br/> <a class="ae jh" href="https://cloud.google.com/functions/pricing" rel="noopener ugc nofollow" target="_blank">云功能定价</a> <br/> <a class="ae jh" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/remote-functions" rel="noopener ugc nofollow" target="_blank">云远程功能</a> <br/> <a class="ae jh" href="https://cloud.google.com/dlp/pricing" rel="noopener ugc nofollow" target="_blank">云DLP定价</a> <br/> <a class="ae jh" href="https://cloud.google.com/kms/pricing" rel="noopener ugc nofollow" target="_blank">云KMS定价</a></p></div></div>    
</body>
</html>