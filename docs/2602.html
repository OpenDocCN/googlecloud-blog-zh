<html>
<head>
<title>From Pub/Sub to BigQuery: Streaming Data in Near Real Time</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从发布/订阅到大查询:近乎实时的数据流</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/from-pub-sub-to-bigquery-streaming-data-in-near-real-time-b550aeff595d?source=collection_archive---------1-----------------------#2022-12-08">https://medium.com/google-cloud/from-pub-sub-to-bigquery-streaming-data-in-near-real-time-b550aeff595d?source=collection_archive---------1-----------------------#2022-12-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c940e4bafa2ee8e98e1c47da2dd0dd0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u441xfX2Kdx-H9Q96hx5Qw.jpeg"/></div></div></figure><p id="6a90" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本帖中，我们将使用一个Dataproc无服务器模板将数据从发布/订阅流式传输到大查询。</p><blockquote class="jo jp jq"><p id="b07b" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated">如果您想要将您当前的Hadoop/Spark集群迁移到云，或者如果您想要利用市场上大量熟练的Hadoop/Spark工程师，以及比您可以根据您的用例扩展的现有模板更好的模板，那么Cloud Dataproc是一个不错的选择。</p></blockquote><h2 id="6bbd" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jb kg kh ki jf kj kk kl jj km kn ko kp bi translated">在我们深入了解这个过程之前，让我们先了解一下我们的媒介(Dataproc)是如何工作的:</h2><p id="dc94" class="pw-post-body-paragraph iq ir hi is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn hb bi translated">它将计算和存储分开。假设一个外部应用程序向您发送想要分析的日志，并且您将它们保存到一个数据源。Dataproc使用云存储(GCS)中的数据进行处理，然后将数据存储回GCS、BigQuery或Bigtable中。此外，您可以使用笔记本中的信息进行分析，并将日志发送到云日志和监控。</p><p id="ca11" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为存储是隔离的，所以长期集群的每个作业可以有多个集群，但是为了降低成本，您可以使用按标签分组和选择的短期集群。为了满足应用程序的需求，您还可以使用内存、CPU和磁盘的适当组合。</p><h2 id="4e3f" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jb kg kh ki jf kj kk kl jj km kn ko kp bi translated">那么，让我们开始吧…</h2><pre class="kv kw kx ky fd kz la lb bn lc ld bi"><span id="f404" class="le jw hi la b be lf lg l lh li"># This program prints Hello, world!<br/><br/>print('Hello, world!')</span></pre><p id="8225" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jr">开玩笑，我们已经过了好的老程序了；)</em></p><h2 id="d995" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jb kg kh ki jf kj kk kl jj km kn ko kp bi translated"><strong class="ak">信号源设置</strong></h2><p id="20dd" class="pw-post-body-paragraph iq ir hi is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn hb bi translated">1.创建发布/订阅主题</p><p id="236b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，我们需要创建一个发布/订阅主题。我们将使用云壳来创建它。</p><pre class="kv kw kx ky fd kz la lb bn lc ld bi"><span id="eee4" class="le jw hi la b be lf lg l lh li">gcloud pubsub topics create DataprocBlog</span></pre><p id="7d9a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.创建主题订阅</p><p id="ea05" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，我们还需要创建一个订阅，这样我们就可以从主题中接收数据</p><pre class="kv kw kx ky fd kz la lb bn lc ld bi"><span id="5a4e" class="le jw hi la b be lf lg l lh li">gcloud pubsub subscriptions create --topic DataprocBlog yourSubscrption</span></pre><p id="477c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以在发布/订阅控制台视图中进行检查，以验证主题和订阅是否都存在。</p><h2 id="748b" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jb kg kh ki jf kj kk kl jj km kn ko kp bi translated"><strong class="ak">准备目标</strong></h2><p id="f588" class="pw-post-body-paragraph iq ir hi is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn hb bi translated">1.创建BigQuery表来存储流数据</p><pre class="kv kw kx ky fd kz la lb bn lc ld bi"><span id="86d4" class="le jw hi la b be lf lg l lh li">bq mk --dataset $DEVSHELL_PROJECT_ID:DataprocBlog</span></pre><p id="dd10" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.为中转/临时着陆区创建存储桶</p><pre class="kv kw kx ky fd kz la lb bn lc ld bi"><span id="64d3" class="le jw hi la b be lf lg l lh li">gsutil mb gs://$DEVSHELL_PROJECT_ID</span></pre><h2 id="8e9b" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jb kg kh ki jf kj kk kl jj km kn ko kp bi translated"><strong class="ak">板载Dataproc模板</strong></h2><ol class=""><li id="e715" class="lj lk hi is b it kq ix kr jb ll jf lm jj ln jn lo lp lq lr bi translated">如果您打算使用GCP生成的“默认”VPC网络，请确保您已经为该子网启用了专用Google访问。您仍然必须启用私人访问，如下所述。(<a class="ae ls" href="https://cloud.google.com/dataproc-serverless/docs/concepts/network" rel="noopener ugc nofollow" target="_blank">详见此处</a></li></ol><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es lt"><img src="../Images/c04e79b2602fdb44ba936eb42e7ae301.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/0*8VJE7YWfvN35hMUf.png"/></div></figure><pre class="kv kw kx ky fd kz la lb bn lc ld bi"><span id="a195" class="le jw hi la b be lf lg l lh li">gcloud compute networks subnets update default - region=us-central1 - enable-private-ip-google-access</span></pre><p id="0c47" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.在预装了<a class="ae ls" href="https://cloud.google.com/shell/docs/how-cloud-shell-works" rel="noopener ugc nofollow" target="_blank">各种工具</a>的云壳中克隆git repo。或者使用任何预装JDK 8+，Maven和Git的机器。</p><pre class="kv kw kx ky fd kz la lb bn lc ld bi"><span id="c996" class="le jw hi la b be lf lg l lh li">git clone https://github.com/GoogleCloudPlatform/dataproc-templates.git cd dataproc-templates/java</span></pre><p id="1362" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.获取身份验证凭据以提交作业。</p><pre class="kv kw kx ky fd kz la lb bn lc ld bi"><span id="fbe0" class="le jw hi la b be lf lg l lh li">gcloud auth application-default login</span></pre><p id="e54e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.执行<a class="ae ls" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/src/main/java/com/google/cloud/dataproc/templates/pubsub/PubSubToBQ.java" rel="noopener ugc nofollow" target="_blank">PubSubToBQ.java</a>模板。</p><p id="5dc3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jr">一般执行</em> </strong></p><pre class="kv kw kx ky fd kz la lb bn lc ld bi"><span id="3b73" class="le jw hi la b be lf lg l lh li">GCP_PROJECT=&lt;gcp-project-id&gt; \<br/>REGION=&lt;region&gt; \<br/>SUBNET=&lt;subnet&gt; \<br/>GCS_STAGING_LOCATION=&lt;gcs-staging-bucket-folder&gt;<br/># ID of Dataproc cluster running permanent history server to access historic logs.<br/>#export HISTORY_SERVER_CLUSTER=&lt;gcp-project-dataproc-history-server-id&gt;<br/><br/><br/>bin/start.sh \<br/>-- --template PUBSUBTOBQ \<br/>--templateProperty pubsub.input.project.id=&lt;pubsub project id&gt; \<br/>--templateProperty pubsub.input.subscription=&lt;pubsub subscription&gt; \<br/>--templateProperty pubsub.bq.output.dataset=&lt;bq output dataset&gt; \<br/>--templateProperty pubsub.bq.output.table=&lt;bq output table&gt;<br/></span></pre><p id="32a1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jr">可配置参数</em> </strong></p><p id="7d27" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jr">命令行或</em><a class="ae ls" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/src/main/resources/template.properties" rel="noopener ugc nofollow" target="_blank"><em class="jr">template . properties</em></a><em class="jr">文件中有以下属性:</em></p><pre class="kv kw kx ky fd kz la lb bn lc ld bi"><span id="e90c" class="le jw hi la b be lf lg l lh li">## Project that contains the input Pub/Sub subscription to be read<br/>pubsub.input.project.id=&lt;pubsub project id&gt;<br/>## PubSub subscription name<br/>pubsub.input.subscription=&lt;pubsub subscription&gt;<br/>## Stream timeout, for how long the subscription will be read<br/>pubsub.timeout.ms=60000<br/>## Streaming duration, how often wil writes to BQ be triggered<br/>pubsub.streaming.duration.seconds=15<br/>## Number of streams that will read from Pub/Sub subscription in parallel<br/>pubsub.total.receivers=5<br/>## Project that contains the output table<br/>pubsub.bq.output.project.id=&lt;pubsub to bq output project id&gt;<br/>## BigQuery output dataset<br/>pubsub.bq.output.dataset=&lt;bq output dataset&gt;<br/>## BigQuery output table<br/>pubsub.bq.output.table=&lt;bq output table&gt;<br/>## Number of records to be written per message to BigQuery<br/>pubsub.bq.batch.size=1000</span></pre><p id="f2b0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意</strong> : <em class="jr">如果尚未启用，它将要求您启用Dataproc Api。</em></p><p id="d046" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi lu translated"><span class="l lv lw lx bm ly lz ma mb mc di">答</span>我们已经完成了从发布/订阅到大型查询的平稳流程。</p><p id="5195" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jr">敬请关注&amp;敬请关注更多此类博客:)</em></p><p id="805f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">参考文献</strong><br/><a class="ae ls" rel="noopener" href="/google-cloud/cloud-spanner-export-query-results-using-dataproc-serverless-6f2f65b583a4">https://medium . com/Google-cloud/cloud-spanner-export-query-results-using-data proc-server less-6 F2 f 65 b 583 a4</a><br/>T22】https://cloud.google.com/pubsub/docs/overview<br/>T25】https://github.com/GoogleCloudPlatform/dataproc-templates</p></div></div>    
</body>
</html>