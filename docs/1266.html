<html>
<head>
<title>Setting up a small Kafka server on Google Cloud Platform for testing purposes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google云平台上设置一个小型Kafka服务器用于测试</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/setting-up-a-small-kafka-server-on-google-cloud-platform-for-testing-purposes-9958a47ea8b9?source=collection_archive---------1-----------------------#2020-01-23">https://medium.com/google-cloud/setting-up-a-small-kafka-server-on-google-cloud-platform-for-testing-purposes-9958a47ea8b9?source=collection_archive---------1-----------------------#2020-01-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/ea679e7d5ada15a4bbeb6d0fc8fdb819.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/1*NSOrXbYjDh9Q6pJ9cixkXQ.gif"/></div><figcaption class="im in et er es io ip bd b be z dx translated">我们一起玩卡夫卡吧！</figcaption></figure><p id="a447" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在许多情况下，我们可能希望在<a class="ae jo" href="http://cloud.google.com" rel="noopener ugc nofollow" target="_blank">谷歌云平台(GCP) </a>上有一个<a class="ae jo" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> Kafka服务器</a>来做一些测试——例如，测试一个流<a class="ae jo" href="http://cloud.google.com/dataflow" rel="noopener ugc nofollow" target="_blank">数据流</a>管道如何与Kafka一起工作。</p><p id="d323" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">GCP市场上有几个选项，其中一些提供了在集群上部署Confluent的Kafka的全功能部署。然而，很可能我们不想建立一个可伸缩的Kafka集群，也不想为一些小的测试支付许可费。同时，在VM中手动部署Kafka也很麻烦。难道我们不能有一个中间选项，允许我们在半托管的解决方案中使用开源的Kafka版本吗？</p><p id="7638" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">市场中可用的选项之一解决了这个问题:<a class="ae jo" href="https://console.cloud.google.com/marketplace/details/click-to-deploy-images/kafka?" rel="noopener ugc nofollow" target="_blank">https://console . cloud . Google . com/market place/details/click-to-deploy-images/Kafka</a></p><p id="47e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该选项部署了一台<em class="jp"> n1-standard-1 </em>机器，估计每月花费24.75美元——如果我们想用我们的免费GCP信用来测试Kafka，这是完美的选择！(如果我们根据需要打开和关闭它，我们只需支付非常少的费用)。</p><p id="c376" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章的其余部分，我假设你已经准备好了一个谷歌云平台项目。你可以按照这个例子使用免费的GCP信用点数。</p><h1 id="ee52" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">设置Kafka服务器</h1><p id="f871" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">转到以下链接并选择您的GCP项目:<a class="ae jo" href="https://console.cloud.google.com/marketplace/details/click-to-deploy-images/kafka" rel="noopener ugc nofollow" target="_blank">https://console . cloud . Google . com/market place/details/click-to-deploy-images/Kafka</a></p><p id="f97f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击蓝色按钮<em class="jp">在计算引擎上启动。</em></p><p id="d63d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将<em class="jp">部署名称</em>改为<em class="jp"> kafka </em>(会生成一个名为<em class="jp"> kafka-vm </em>的VM)，选择一个zone。在我的例子中，我将选择<em class="jp">欧洲-西方1-d. </em></p><p id="1616" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们在控制台的<a class="ae jo" href="https://console.cloud.google.com/home/dashboard?cloudshell=true" rel="noopener ugc nofollow" target="_blank">云壳中查看一下。在提示中，您应该看到黄色的项目名称，在这里我们检查它以确保我们列出了我们项目的虚拟机(在我的例子中，我的项目是<em class="jp"> ihr-kafka-dataflow </em>)。我们在云Shell中编写的命令以粗体显示。在本文的其余部分，云Shell提示符将只是<code class="du kt ku kv kw b"><strong class="is hj">$</strong></code>(其他虚拟机的提示符将在<code class="du kt ku kv kw b"><strong class="is hj">$</strong></code>符号前有机器的名称):</a></p><pre class="kx ky kz la fd lb kw lc ld aw le bi"><span id="78ef" class="lf jr hi kw b fi lg lh l li lj"><strong class="kw hj">$ gcloud config get-value project</strong><br/>Your active configuration is: [cloudshell-14881]<br/>ihr-kafka-dataflow<br/><strong class="kw hj">$ gcloud compute instances list</strong><br/>NAME     ZONE MACHINE_TYPE PRE... INTERNAL_IP EXTERNAL_IP    STATUS<br/>kafka-vm eu.. n1-standard-1       10.132.0.3  146.148.22.176 RUNNING</span></pre><p id="83c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意<code class="du kt ku kv kw b">EXTERNAL_IP</code>字段。我们可能认为我们的Kafka服务器是暴露在世界面前的。但是，默认情况下，不允许任何流量连接到该IP。</p><h1 id="b25d" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">检查子网中与Kafka的连接</h1><p id="1f53" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">流量被限制在同一个子网内。让我们在同一个区域创建另一个小型虚拟机来测试与Kafka服务器的连接。我们创建机器(如果您的首选区域不同，请更改区域):</p><pre class="kx ky kz la fd lb kw lc ld aw le bi"><span id="80a6" class="lf jr hi kw b fi lg lh l li lj"><strong class="kw hj">$ export ZONE=europe-west1-d</strong><br/><strong class="kw hj">$ gcloud compute instances create test-vm --zone=$ZONE                 --machine-type=g1-small<br/></strong>Created [<a class="ae jo" href="https://www.googleapis.com/compute/v1/projects/ihr-kafka-dataflow/zones/europe-west1-d/instances/test-vm" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/compute</a>...<br/>NAME     ZONE            MACHINE_TYPE  PREEMPTIBLE  INTERNAL_IP ...<br/>test-vm  europe-west1-d  g1-small                   10.132.0.4  ....</span></pre><p id="f14d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们连接到这台机器，并检查它是否可以到达Kafka服务器(我们将必须创建一个SSH密钥，您可以留下一个空密码作为访问私钥的密码)。我们还安装了命令行Kafka客户端，以检查我们是否能够连接到Kafka代理。请注意，在对test-vm执行SSH之后，提示符是<code class="du kt ku kv kw b">test-vm</code>之一:</p><pre class="kx ky kz la fd lb kw lc ld aw le bi"><span id="4a57" class="lf jr hi kw b fi lg lh l li lj"><strong class="kw hj">$ gcloud compute ssh test-vm --zone=$ZONE<br/></strong>...<br/><strong class="kw hj">ihr@test-vm:~$ export BROKER_IP=10.132.0.3<br/>ihr@test-vm:~$ sudo apt install -y kafkacat     <br/></strong>Reading package lists... Done<br/>Building dependency tree       <br/>Reading state information... Done<br/>The following additional packages will be installed:<br/>  librdkafka1 libyajl2<br/>The following NEW packages will be installed:<br/>  kafkacat librdkafka1 libyajl2<br/>[...]<br/>Setting up kafkacat (1.3.0-1+b1) ...<br/><strong class="kw hj">ihr@test-vm:~$ echo 'Hi from test vm' | kafkacat -b $BROKER_IP:9092 -t test_topic</strong><br/>% Auto-selecting Producer mode (use -P or -C to override)<br/><strong class="kw hj">ihr@test-vm:~$ kafkacat -e -b $BROKER_IP:9092 -t test_topic</strong><br/>% Auto-selecting Consumer mode (use -P or -C to override)<br/><strong class="kw hj"><em class="jp">Hi from test vm</em></strong><br/>% Reached end of topic test_topic [0] at offset 3<br/><strong class="kw hj">ihr@test-vm:~$ exit</strong></span></pre><p id="e89b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，与Kafka服务器的连接工作正常！</p><p id="d49c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您需要将连接扩展到其他网络，您可能需要添加一些防火墙规则。注意:你的虚拟机有一个公共接口，取决于你如何设置你的防火墙规则，你可能会向世界开放你的Kafka服务器！</p><h1 id="c5a0" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">将此服务器与其他服务一起使用</h1><p id="ac52" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">现在我们有了一个Kafka服务器，我们如何与其他服务共享呢？</p><p id="c8c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当我们需要指定连接到Kafka服务器的设置时，该服务将需要2或3个参数:</p><ul class=""><li id="e4e3" class="lk ll hi is b it iu ix iy jb lm jf ln jj lo jn lp lq lr ls bi translated">Kafka经纪人地址</li><li id="3245" class="lk ll hi is b it lt ix lu jb lv jf lw jj lx jn lp lq lr ls bi translated">卡夫卡经纪人港</li><li id="c056" class="lk ll hi is b it lt ix lu jb lv jf lw jj lx jn lp lq lr ls bi translated">主题名称</li></ul><p id="a1ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们的机器中，因为我们没有使用集群，而只是使用了一个虚拟机，所以Kafka代理地址就是虚拟机的IP地址。如果我们让设置如上所示，我们可以使用私有IP。有了适当的防火墙规则，您也可以使用公共IP来提供外部服务。但是请注意，在这个小的测试虚拟机中没有身份验证，所以您的Kafka服务器将对世界开放。</p><p id="53de" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">端口是9092，这是Kafka中默认的代理端口。</p><p id="e901" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">至于主题名，服务器是“空的”，所以您需要创建一个主题。《Apache Kafka快速入门》包含了一些关于如何创建主题的细节:<a class="ae jo" href="https://kafka.apache.org/quickstart" rel="noopener ugc nofollow" target="_blank">https://kafka.apache.org/quickstart</a>(参见步骤3)。</p><p id="6b92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Kafka安装在<code class="du kt ku kv kw b">/opt/kafka</code>中的VM中，在那里你也可以找到一些管理服务器的工具。您将在<code class="du kt ku kv kw b">/opt/kafka/bin/kafka-topics.sh.</code>中找到第3步中使用的实用程序，选项<code class="du kt ku kv kw b">—-bootstrap-server</code>在我们虚拟机的脚本中不存在，您需要使用<code class="du kt ku kv kw b">--zookeeper</code>来代替(本地主机作为服务器，端口2181是默认的Zookeeper端口)。</p><p id="0aee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想创建一个主题，连接到<code class="du kt ku kv kw b">kafka-vm</code>并使用那个脚本(从云外壳，使用下面的命令)</p><pre class="kx ky kz la fd lb kw lc ld aw le bi"><span id="6bea" class="lf jr hi kw b fi lg lh l li lj"><strong class="kw hj">$ gcloud compute ssh kafka-vm --zone=$ZONE<br/></strong>...<br/><strong class="kw hj">ihr@kafka-vm:~$ /opt/kafka/bin/kafka-topics.sh --create               --zookeeper localhost:2181  --replication-factor 1 --partitions 1   --topic mytopic<br/></strong>Created topic "mytopic".<br/><strong class="kw hj">ihr@kafka-vm:~$ /opt/kafka/bin/kafka-topics.sh --list                <br/>--zookeeper localhost:2181<br/></strong>mytopic</span></pre><p id="d45e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在任何情况下，许多服务将能够自己创建主题，因此可能没有必要手动创建它。</p><h1 id="de88" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">清除</h1><p id="df02" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">现在，您可以通过使用云外壳中的gcloud来移除<code class="du kt ku kv kw b">test-vm</code>:</p><pre class="kx ky kz la fd lb kw lc ld aw le bi"><span id="5064" class="lf jr hi kw b fi lg lh l li lj"><strong class="kw hj">$ gcloud compute instances delete test-vm --zone=$ZONE</strong></span></pre><p id="9b4e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想保留您的Kafka服务器，并为将来的测试节省一些资金，只需停止机器并根据需要启动它。要停止机器:</p><pre class="kx ky kz la fd lb kw lc ld aw le bi"><span id="373b" class="lf jr hi kw b fi lg lh l li lj"><strong class="kw hj">$ gcloud compute instances stop kafka-vm --zone=$ZONE</strong></span></pre><p id="9f42" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">开始吧:</p><pre class="kx ky kz la fd lb kw lc ld aw le bi"><span id="11c7" class="lf jr hi kw b fi lg lh l li lj"><strong class="kw hj">$ gcloud compute instances start kafka-vm --zone=$ZONE</strong></span></pre><p id="688b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">磁盘容量为10 GB，因此如果机器停止运行，您每月需要支付大约0.40美元来维护存储的磁盘。</p><p id="457d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想完全删除您在此项目中所做的一切，您可以在GCP控制台中删除该项目。要删除使用Marketplace部署脚本完成的设置，部署可从<a class="ae jo" href="https://console.cloud.google.com/dm/deployments/details/kafka" rel="noopener ugc nofollow" target="_blank">https://console . cloud . Google . com/DM/deployments/details/Kafka</a>获得，您可以使用控制台中的页面删除它(打开该页面时选择您的特定项目)。</p><h1 id="2f4a" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">总结</h1><p id="5753" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">在这篇文章中，我们已经看到了如何设置你自己的小型Kafka服务器进行测试。</p><ul class=""><li id="83d5" class="lk ll hi is b it iu ix iy jb lm jf ln jj lo jn lp lq lr ls bi translated">我们使用了在GCP市场上可以买到的Kafka开源版本，在单个虚拟机中部署Kafka。</li><li id="4cff" class="lk ll hi is b it lt ix lu jb lv jf lw jj lx jn lp lq lr ls bi translated">你可以使用GCP的免费版本来学习这个教程。如果这台机器正常运行，每月大约花费25美元，如果停止运行，每月大约花费0.40美元。</li><li id="84aa" class="lk ll hi is b it lt ix lu jb lv jf lw jj lx jn lp lq lr ls bi translated">如果你需要改变服务器的配置，通过SSH连接到<code class="du kt ku kv kw b">kafka-vm</code>机器，Kafka安装在<code class="du kt ku kv kw b">/opt/kafka</code>目录中。</li></ul></div></div>    
</body>
</html>