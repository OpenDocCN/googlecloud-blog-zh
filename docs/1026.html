<html>
<head>
<title>Monitoring JVM within a Docker container using Stackdriver</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Stackdriver监控Docker容器中的JVM</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/monitoring-jvm-within-a-docker-container-using-stackdriver-e53f53e4f5d6?source=collection_archive---------0-----------------------#2019-06-10">https://medium.com/google-cloud/monitoring-jvm-within-a-docker-container-using-stackdriver-e53f53e4f5d6?source=collection_archive---------0-----------------------#2019-06-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="75d1" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="a566" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">既然您已经登陆了这篇文章，那么您一定正在Google Compute Engine (GCE) VM实例中运行您的Dockerized Java应用程序，并且显然想要监视它。这篇文章将向你展示如何使用Stackdriver监控代理和JVM插件来监控JVM。虽然网上有许多其他方法可以利用不同的监控工具，但为什么不使用GCP本地工具来完成同样的任务呢？毕竟这确实让事情变得简单了。</p><h2 id="2b2a" class="kb ig hi bd ih kc kd ke il kf kg kh ip jo ki kj it js kk kl ix jw km kn jb ko bi translated">您可能已经知道…</h2><p id="9616" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">Java应用程序运行在名为Java虚拟机(JVM)的虚拟机中。Java为Java应用程序的管理和联网提供了一套工具，称为Java管理扩展(JMX)。因此，JMX基本上支持即时监控JVM，我们需要做的只是在特定端口上启用它，这样我们的代理就可以读取并获得所有有用的信息，如线程数、内存使用、垃圾收集、打开的文件描述符等。</p><h1 id="fe90" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">部署Java应用程序</h1><p id="6578" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">如果你已经在你的集装箱应用程序上启用了JMX遥控器，那么你可以进入下一部分，否则请继续阅读…</p><h2 id="f773" class="kb ig hi bd ih kc kd ke il kf kg kh ip jo ki kj it js kk kl ix jw km kn jb ko bi translated">1.构建Docker映像</h2><p id="6a42" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在dockerfile文件中，确保运行应用程序的Java命令包含启用JMX远程处理的系统属性。</p><p id="5224" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">例如，如果启动应用程序的java命令是:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="9bce" class="kb ig hi kz b fi ld le l lf lg">java -jar /.app.jar</span></pre><p id="be94" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">然后修改它，如下所示:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="e8c6" class="kb ig hi kz b fi ld le l lf lg">java -Dcom.sun.management.jmxremote \<br/>     -Dcom.sun.management.jmxremote.port=&lt;<strong class="kz hj">JMX_PORT</strong>&gt; \<strong class="kz hj"><br/>     </strong>-Dcom.sun.management.jmxremote.ssl=false \<br/>     -Dcom.sun.management.jmxremote.authenticate=false \<br/>     -jar /.app.jar</span></pre><p id="b0ee" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated"><strong class="jf hj"> <em class="lh">有些事情要注意:</em> </strong></p><ul class=""><li id="6333" class="li lj hi jf b jg kp jk kq jo lk js ll jw lm ka ln lo lp lq bi translated"><em class="lh">选择您选择的有效端口，而不是JMX端口(例如:9001)。</em></li><li id="b406" class="li lj hi jf b jg lr jk ls jo lt js lu jw lv ka ln lo lp lq bi translated"><em class="lh">在本例中，我们禁用了对JMX的SSL和身份验证。如果您的用例需要，请启用并配置它们。</em></li></ul><h2 id="e390" class="kb ig hi bd ih kc kd ke il kf kg kh ip jo ki kj it js kk kl ix jw km kn jb ko bi translated">2.在GCE VM实例中部署容器</h2><p id="f099" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">创建一个运行linux的GCE VM实例，确保在创建时将一个服务帐户连接到VM实例。一旦创建了实例，就在其上安装Docker。使用<code class="du lw lx ly kz b">docker run</code>命令部署容器，确保JMX端口监听容器。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="0d3d" class="kb ig hi kz b fi ld le l lf lg">$ docker run <em class="lh">... &lt;app specific options&gt; ... </em><strong class="kz hj">--publish=&lt;JMX_LOCAL_PORT&gt;:&lt;JMX_PORT&gt;</strong></span></pre><ul class=""><li id="0a33" class="li lj hi jf b jg kp jk kq jo lk js ll jw lm ka ln lo lp lq bi translated">JMX本地端口是在GCE虚拟机上映射的端口。</li><li id="b525" class="li lj hi jf b jg lr jk ls jo lt js lu jw lv ka ln lo lp lq bi translated">JMX端口与之前创建映像时在Dockerfile中设置的端口相同。</li></ul><h1 id="e403" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">启用堆栈驱动程序监控</h1><p id="0aa3" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">现在容器已经启动并运行，启用了JMX监听器，我们将安装Stackdriver监控代理和JVM插件，该插件将从容器中查询指标并转发到Stackdriver监控服务。</p><h2 id="7ba5" class="kb ig hi bd ih kc kd ke il kf kg kh ip jo ki kj it js kk kl ix jw km kn jb ko bi translated">1.在GCP上设置正确的IAM访问</h2><p id="0e60" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">为了使代理能够将指标上传到Stackdriver Monitoring，必须在项目级别为其分配必要的IAM角色。在项目级别向GCE实例服务帐户授予<code class="du lw lx ly kz b">roles/monitoring.metricWriter</code> <strong class="jf hj"> <em class="lh"> </em> </strong>。</p><p id="7419" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">点击 可以了解更多关于设置堆栈驱动监控<a class="ae lz" href="https://cloud.google.com/monitoring/access-control" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj">的访问控制。</strong></a></p><h2 id="a1fd" class="kb ig hi bd ih kc kd ke il kf kg kh ip jo ki kj it js kk kl ix jw km kn jb ko bi translated">2.安装监控代理</h2><p id="949e" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">安装linux的Stackdriver监控代理。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="b6e0" class="kb ig hi kz b fi ld le l lf lg">$ curl -sSO https://dl.google.com/cloudagents/install-monitoring-agent.sh</span><span id="b919" class="kb ig hi kz b fi ma le l lf lg">$ sudo bash install-monitoring-agent.sh</span></pre><p id="3130" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">你可以在这里 阅读更多关于安装Stackdriver监控代理<a class="ae lz" href="https://cloud.google.com/monitoring/agent/install-agent" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj">的内容。</strong></a></p><h2 id="8298" class="kb ig hi bd ih kc kd ke il kf kg kh ip jo ki kj it js kk kl ix jw km kn jb ko bi translated">3.添加JVM插件</h2><p id="81a7" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">通过下载配置文件并将其添加到代理配置中，启用<a class="ae lz" href="https://cloud.google.com/monitoring/agent/plugins/jvm#enabling_the_jvm_monitoring_plugin" rel="noopener ugc nofollow" target="_blank"> Stackdriver JVM监控插件</a>。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="67d4" class="kb ig hi kz b fi ld le l lf lg">$ (cd /opt/stackdriver/collectd/etc/collectd.d/ &amp;&amp; sudo curl -O https://raw.githubusercontent.com/Stackdriver/stackdriver-agent-service-configs/master/etc/collectd.d/jvm-sun-hotspot.conf)</span></pre><h2 id="d2c4" class="kb ig hi bd ih kc kd ke il kf kg kh ip jo ki kj it js kk kl ix jw km kn jb ko bi translated">4.更新JMX插件配置</h2><p id="37b5" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">编辑下载的JMX插件配置文件(jvm-sun-hotspot.conf ),将JMX端口替换为之前在运行docker容器时设置的JMX本地端口端口号。</p><h2 id="8a09" class="kb ig hi bd ih kc kd ke il kf kg kh ip jo ki kj it js kk kl ix jw km kn jb ko bi translated">5.重新启动监控代理</h2><p id="47dd" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">重新启动监控代理，让它获取JVM插件配置。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="84ff" class="kb ig hi kz b fi ld le l lf lg">$ sudo service stackdriver-agent restart</span></pre><h1 id="ebe6" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">在Stackdriver监控控制台上验证</h1><p id="b973" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">既然已经设置了代理来收集和导出JVM指标，那么是时候在Stackdriver监控控制台上验证这一点了。</p><h2 id="756c" class="kb ig hi bd ih kc kd ke il kf kg kh ip jo ki kj it js kk kl ix jw km kn jb ko bi translated">1.选择项目工作环境</h2><p id="74c7" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">转到Stackdriver监控控制台，选择项目的工作区。如果它是一个新项目，那么默认情况下将为此项目创建一个新的工作区，或者您可以将您的项目添加到现有的工作区。</p><figure class="ku kv kw kx fd mc er es paragraph-image"><div class="er es mb"><img src="../Images/284e0d68cb5157940293146d05bcd0a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:830/format:webp/0*8rBpdX_bYNhLH7mP.png"/></div></figure><p id="e240" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">点击阅读更多关于Stackdriver工作区<a class="ae lz" href="https://cloud.google.com/monitoring/workspaces/" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><h2 id="1b32" class="kb ig hi bd ih kc kd ke il kf kg kh ip jo ki kj it js kk kl ix jw km kn jb ko bi translated">2.选择Java虚拟机度量资源</h2><p id="2750" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在左侧面板中，浏览资源&gt; Java虚拟机</p><figure class="ku kv kw kx fd mc er es paragraph-image"><div class="er es mf"><img src="../Images/400fb12d5b04d2ed60c8b2689fb05acb.png" data-original-src="https://miro.medium.com/v2/resize:fit:958/0*I2cil6kHD-zpqPDb"/></div><figcaption class="mg mh et er es mi mj bd b be z dx translated">显示JVM资源选择器的Stackdriver监控控制台。</figcaption></figure><h2 id="88ee" class="kb ig hi bd ih kc kd ke il kf kg kh ip jo ki kj it js kk kl ix jw km kn jb ko bi translated">3.查看不同的指标</h2><p id="d941" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">单击<em class="lh"> Java虚拟机</em>后，如果一切都配置正确，您应该会看到GCE实例名和JVM指标图表。</p><figure class="ku kv kw kx fd mc er es paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="er es mk"><img src="../Images/ff2120f68c470ede63b6c92e98fff4fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oISMpUp1dT-Xph0X"/></div></div><figcaption class="mg mh et er es mi mj bd b be z dx translated">显示不同收集指标的Stackdriver JVM监视窗口。</figcaption></figure><h2 id="52cc" class="kb ig hi bd ih kc kd ke il kf kg kh ip jo ki kj it js kk kl ix jw km kn jb ko bi translated">看不到您的GCE实例的指标？</h2><p id="405f" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">如果在JVM监控控制台上看不到GCE VM实例名，那么请遵循Stackdriver Monitoring agent <a class="ae lz" href="https://cloud.google.com/monitoring/agent/troubleshooting" rel="noopener ugc nofollow" target="_blank">故障排除指南</a>中的不同建议。</p></div></div>    
</body>
</html>