<html>
<head>
<title>Terraform plan in Pull Requests with Google Cloud Build</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Cloud Build的拉式请求中的地形计划</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/terraform-plan-in-pull-requests-with-gcp-cloud-build-603790a2b734?source=collection_archive---------0-----------------------#2020-12-26">https://medium.com/google-cloud/terraform-plan-in-pull-requests-with-gcp-cloud-build-603790a2b734?source=collection_archive---------0-----------------------#2020-12-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e37e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本地运行Terraform只是为了审查一个拉取请求，这总是有点让人头疼。好的一面是，有一些好人在经营像<a class="ae jd" href="https://github.com/runatlantis/atlantis" rel="noopener ugc nofollow" target="_blank">亚特兰蒂斯</a>这样的项目，如果你自己主持或者使用<a class="ae jd" href="https://spacelift.io/" rel="noopener ugc nofollow" target="_blank"> Spacelift </a>，你会做得很好。</p><p id="969c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我总是觉得管理亚特兰蒂斯只是运行计划和应用程序有点太多了。相反，我深入到<a class="ae jd" href="https://cloud.google.com/cloud-build" rel="noopener ugc nofollow" target="_blank">云构建</a>中，试图复制同样的想法，但是以一种无服务器的方式。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/997c29a706ed5f7fa8c952a6fcfed0a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R96UFRJOf2LuxgiF8v92oA.png"/></div></div></figure><h1 id="eadd" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">公关评论是一个问题</h1><p id="aa93" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">当我试图将所有组件缝合在一起时，有一个组件丢失了:Github CLI的容器化云构建器。是的，Github有一个新的<a class="ae jd" href="https://github.com/cli/cli" rel="noopener ugc nofollow" target="_blank"> CLI </a>，可以让你在PRs上发表评论。多酷啊。</p><p id="79e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以我在<a class="ae jd" href="https://github.com/GoogleCloudPlatform/cloud-builders-community/pull/469" rel="noopener ugc nofollow" target="_blank"> PR#469 </a>中把Github CLI builder贡献到了<a class="ae jd" href="https://github.com/GoogleCloudPlatform/cloud-builders-community" rel="noopener ugc nofollow" target="_blank">cloud-builders-community</a>(当你读到这篇文章的时候，它可能已经在master中了，如果没有，请随意使用分支)。</p><p id="003d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">&gt;<strong class="ih hj">编辑:</strong>贡献被合并，下面的安装步骤被更新。</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="b451" class="ky jr hi ku b fi kz la l lb lc">git clone https://github.com/GoogleCloudPlatform/cloud-builders-community.git &amp;&amp; cd cloud-builders-community/github<br/>gcloud builds submit --config=cloudbuild.yaml .</span></pre><p id="68b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该脚本将Github builder安装到您的Google Cloud项目中。如果你错过了地形，只需<code class="du ld le lf ku b">cd ../terraform</code>并以同样的方式提交构建。</p><h1 id="d1c9" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">规划云构建中的平台</h1><p id="2567" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">首先，我们要使用<a class="ae jd" href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/terraform" rel="noopener ugc nofollow" target="_blank"> terraform builder </a>来初始化和计划变更。确保您的云构建服务帐户有足够的权限在terraform中执行您需要的任何操作。</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="826b" class="ky jr hi ku b fi kz la l lb lc">steps:<br/>  - name: 'gcr.io/$PROJECT_ID/terraform'<br/>    args: [<br/>        'init'<br/>    ]<br/>  - name: 'gcr.io/$PROJECT_ID/terraform'<br/>    entrypoint: 'bash'<br/>    args: [<br/>        '-c',<br/>        'terraform plan -no-color &gt; plan.txt'<br/>    ]</span></pre><p id="8e27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第二步将其输出放入名为<code class="du ld le lf ku b">plan.txt</code>的文件中。在<code class="du ld le lf ku b">/workspace</code>目录中的文件在步骤之间被保留，使得它在接下来的步骤中可用。</p><h1 id="6bd8" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">提供Github令牌</h1><p id="79f4" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">下一步是为我们的CLI提供一个Github令牌。我们可以生成一个进入<a class="ae jd" href="https://github.com/settings/tokens" rel="noopener ugc nofollow" target="_blank">设置/开发者设置/个人访问令牌</a>的导航。该令牌需要具有以下权限:</p><ul class=""><li id="163b" class="lg lh hi ih b ii ij im in iq li iu lj iy lk jc ll lm ln lo bi translated"><code class="du ld le lf ku b">repo</code>这样它就可以从你的私有存储库中读取数据并写评论</li><li id="8282" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated">如果你正在为一个组织使用它</li></ul><p id="43a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你的令牌被创建，复制它，并在你的项目的<a class="ae jd" href="https://console.cloud.google.com/security/secret-manager" rel="noopener ugc nofollow" target="_blank">秘密管理器</a>中创建一个新的秘密。你可以把这个秘密叫做<code class="du ld le lf ku b">github-personal-token</code>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lu"><img src="../Images/fbd36690158e333ac50432692eb1d18e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tU7zTLAhibnsmYCIcsaVjg.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx translated">在秘密管理器中创建秘密</figcaption></figure><h1 id="e05a" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">将计划发布到Github PR中</h1><p id="366f" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">要发布计划结果的注释，我们需要<a class="ae jd" href="https://console.cloud.google.com/cloud-build/triggers/add" rel="noopener ugc nofollow" target="_blank">为Pull请求事件创建一个触发器</a>，连接到您的terraform存储库。之后，我们将在我们的<code class="du ld le lf ku b">cloudbuild.yaml</code>中增加两个步骤。这些步骤将获得Github令牌，并在Github builder中使用它来发布评论。</p><p id="29bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">首先，让我们创建我们的触发器。</strong>将其放在<em class="lz"> Pull Request </em>事件上，并连接您的存储库，如下例所示。您还可以启用<em class="lz">注释控制</em>，以防您希望仅针对协作者或所有者手动触发(以确保您不会在预批准的PRs上执行计划)。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ma"><img src="../Images/3539d9ae1bd2f4957fd1b2f62dd2cd91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*48GzO0ZwG-9Q6g6iyILc5w.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx translated">创建新的地形图触发器</figcaption></figure><p id="d77a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">其次，我们将更新我们的构建配置。</strong>添加的步骤执行以下操作:</p><ul class=""><li id="3223" class="lg lh hi ih b ii ij im in iq li iu lj iy lk jc ll lm ln lo bi translated">从秘密管理器获取Github令牌，这样我们就可以将它作为授权传递给我们的Github构建器</li><li id="c462" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated">使用Github builder将计划注释为PR中的可折叠代码</li></ul><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="b951" class="ky jr hi ku b fi kz la l lb lc">- name: gcr.io/cloud-builders/gcloud<br/>  entrypoint: 'bash'<br/>  args: [<br/>      '-c',<br/>      "gcloud secrets versions access latest --secret=github-personal-token --format='get(payload.data)' | tr '_-' '/+' | base64 -d &gt; token.txt"<br/>  ]<br/>- name: 'gcr.io/$PROJECT_ID/github'<br/>  entrypoint: 'bash'<br/>  args:<br/>    - '-c'<br/>    - |-<br/>      read -r -d "" gh_comment_template &lt;&lt; EOF<br/>      &lt;details&gt;<br/>        &lt;summary&gt;Terraform Plan Results&lt;/summary&gt;<br/><br/>        \`\`\`<br/>        %s<br/>        \`\`\`<br/>      &lt;/details&gt;<br/>      EOF<br/><br/>      gh_comment=$(printf "$$gh_comment_template" "$(cat plan.txt)")<br/>      /usr/bin/gh.bash pr review $_PR_NUMBER -R $_GITHUB_USER/$REPO_NAME -c -b "$$gh_comment"</span></pre><p id="0868" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第二步可能看起来有点多，但是，它使评论折叠。多次运行触发器不会创建带有地形图的无限滚动PRs。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mb"><img src="../Images/6a80ef2ef603b2b1cddd6db340561af4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B674_QyHDX3DZQ11OpbafA.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx translated">折叠地形图导致拉式请求</figcaption></figure><p id="381d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置完成后，您将在PR注释中看到完整的<code class="du ld le lf ku b">terraform plan</code>输出。</p></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="dd4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你有任何问题，请打我的<a class="ae jd" href="https://twitter.com/petomalina" rel="noopener ugc nofollow" target="_blank"> Twitter </a></p><p id="4210" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽情享受吧！</p></div></div>    
</body>
</html>