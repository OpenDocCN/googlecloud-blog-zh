<html>
<head>
<title>Google Container Registry and Portainer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌容器注册和门户网站</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-container-registry-and-portainer-57198bdae070?source=collection_archive---------0-----------------------#2018-03-08">https://medium.com/google-cloud/google-container-registry-and-portainer-57198bdae070?source=collection_archive---------0-----------------------#2018-03-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="775a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">* * 2018–03–08更新:</strong>谷歌的一名工程师为这个问题提供了更好的解决方案。他建议使用更优雅的解决方案，即使用服务帐户的凭证，而不是使用我下面展示的短期令牌。这需要稍微多一点的工作，但是被Google ( <a class="ae jd" href="https://cloud.google.com/container-registry/docs/advanced-authentication#using_a_json_key_file" rel="noopener ugc nofollow" target="_blank"> link </a>)和works记录下来；我刚刚确认了。我建议您遵循这个路径(Service Account | JSON key ),而不是我下面描述的访问令牌。如果您想要完整的说明，请滚动到这篇文章的末尾，然后选择“<strong class="ih hj">使用服务帐户</strong>”。</p><p id="70e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我最近在<a class="ae jd" rel="noopener" href="/google-cloud/google-container-registry-4aca1fc6cf74">的博客</a>上发表了关于<a class="ae jd" href="https://cloud.google.com/container-registry/" rel="noopener ugc nofollow" target="_blank">谷歌容器注册中心</a> (GCR)的文章，并解释了(来自谷歌的文档)一种可以轻松<a class="ae jd" href="https://cloud.google.com/container-registry/docs/advanced-authentication#using_an_access_token" rel="noopener ugc nofollow" target="_blank">配置</a> Docker的CLI以访问GCR (gcr.io)而不是docker.io的方法</p><p id="c186" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">嗯，我真的很喜欢用Portainer来管理我的本地Docker映像、容器、网络等。自己去看看吧:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="4f1c" class="jn jo hi jj b fi jp jq l jr js">docker run \<br/>--detach \<br/>--publish=9000:9000 \<br/>--volume=/var/run/docker.sock:/var/run/docker.sock \<br/>--volume=portainer_data:/data \<br/>portainer/portainer</span></pre><p id="48a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后<code class="du jt ju jv jj b">http://localhost:9000</code></p><p id="325e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个非常好的工具:</p><figure class="je jf jg jh fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es jw"><img src="../Images/ace2ae2c40c78997d97410841fc6d225.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZGjDhV1KcmY3BLPGd0zvqQ.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">便携式集装箱</figcaption></figure><p id="5886" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想，我应该可以通过Portainer访问GCR。</p><p id="d4e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并且，您可以:</p><figure class="je jf jg jh fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es ki"><img src="../Images/7639a3de50e6a204f12301f7dea87aed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yNOeXi4iD0LJQEWngDDEFA.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">配置为使用GCR的Portainer</figcaption></figure><p id="74d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，为您当前认证的用户帐户获取一个<code class="du jt ju jv jj b">access-token</code>:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="7b93" class="jn jo hi jj b fi jp jq l jr js">gcloud auth application-default print-access-token</span></pre><p id="b090" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">结果将开始<code class="du jt ju jv jj b">ya29.</code></p><p id="9d23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，在Poirtainer UI中，创建一个新的自定义注册表:</p><figure class="je jf jg jh fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es kj"><img src="../Images/afaba249acaf17e41e23c2f3b4aca747.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FMD2KAT8FUUCcXstXpTtSA.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">Portainer:自定义注册表</figcaption></figure><p id="9fd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">命名注册中心，也许在你的GCP项目ID之后，注册中心URL将是形式<code class="du jt ju jv jj b">gcr.io/[[YOUR-PROJECT-ID]]</code>并且滑动认证滑块。对于用户名，您可以使用占位符<code class="du jt ju jv jj b">oauth2accesstoken</code>，对于密码，请输入<code class="du jt ju jv jj b">access-token</code>的值，包括<code class="du jt ju jv jj b">ya29.</code></p><p id="64d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">像这样:</p><figure class="je jf jg jh fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es kk"><img src="../Images/f93972cb13e13c4958f3c066615a87f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IhnGRmAPEOyADPBQ2yRojQ.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">集装箱:GCR配置</figcaption></figure><p id="e1c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后点击“添加注册表”。</p><p id="71c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切正常，GCR注册表现在应该如下所示:</p><figure class="je jf jg jh fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es kl"><img src="../Images/3e349b7eb8f9eb5d5e1246dfbc074f9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m6k4lrZ10hxulYVa1FwH5A.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">门户网站:包括GCR在内的注册管理机构</figcaption></figure><p id="b749" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以根据需要添加任意数量。</p><p id="796c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以使用Portainer直接从GCR存储库中提取图像:</p><figure class="je jf jg jh fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es km"><img src="../Images/6c3ae21569c255d1d8246e59a35cf68e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H9HPU8cdke-kRx2sMJtQtg.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">从GCR回购拉图片</figcaption></figure><p id="b915" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和/或直接从GCR存储库创建容器:</p><figure class="je jf jg jh fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es kn"><img src="../Images/4ebfac0ede1224739bc53c40a8971ef7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b8PjXbVtHvDzhQSr5Z4ClQ.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">直接从GCR仓库创建集装箱</figcaption></figure><h2 id="9a0d" class="jn jo hi bd ko kp kq kr ks kt ku kv kw iq kx ky kz iu la lb lc iy ld le lf lg bi translated">结论</h2><p id="d406" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">Portainer是一个有用的工具。Portainer结合Google容器注册表就更有用了。</p><p id="272e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用服务账户</strong></p><p id="b7ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一名Google工程师证实了一个更好的解决方案，使用服务帐户(JSON)密钥而不是短期访问令牌来解决这个问题。</p><p id="1548" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设有一个名为<code class="du jt ju jv jj b">${PROJECT}</code>的项目和一个名为<code class="du jt ju jv jj b">gcr.io/${PROJECT}</code>的GCR存储库:</p><ol class=""><li id="cd00" class="lm ln hi ih b ii ij im in iq lo iu lp iy lq jc lr ls lt lu bi translated">创建一个服务账户(名为<code class="du jt ju jv jj b">portainer</code>)，专门供Portainer用于本次回购:</li></ol><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="9f07" class="jn jo hi jj b fi jp jq l jr js">ROBOT="portainer"</span><span id="47ec" class="jn jo hi jj b fi lv jq l jr js">gcloud iam service-accounts create ${ROBOT} \<br/>--display-name=${ROBOT} \<br/>--project=${PROJECT}<!-- --> </span></pre><p id="c1af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.为这个名为<code class="du jt ju jv jj b">portainer.key.json</code>的服务帐户生成一个JSON密钥:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="56b9" class="jn jo hi jj b fi jp jq l jr js">gcloud iam service-accounts keys create ./${ROBOT}.key.json \<br/>--iam-account=${ROBOT}@${PROJECT}.iam.gserviceaccount.com \<br/>--project=${PROJECT}</span></pre><p id="6b56" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.授予服务帐户“objectViewer”(可以读取)对支持GCR存储库的<a class="ae jd" href="https://cloud.google.com/storage/" rel="noopener ugc nofollow" target="_blank"> Google云存储</a> (GCS)存储桶的权限。此处记录了<a class="ae jd" href="https://cloud.google.com/container-registry/docs/access-control#granting_users_and_other_projects_access_to_a_registry" rel="noopener ugc nofollow" target="_blank">。</a></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="5e6c" class="jn jo hi jj b fi jp jq l jr js">gsutil iam ch serviceAccount:${ROBOT}@${PROJECT}.iam.gserviceaccount.com:objectViewer gs://artifacts.${PROJECT}.appspot.com</span></pre><p id="86e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用GCS浏览器确认此更改(如果您愿意，也可以进行此更改):</p><p id="422d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">https://console.cloud.google.com/storage/browser?project=${项目}</p><figure class="je jf jg jh fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es lw"><img src="../Images/1413a2d19a3beeb786e7fda8a63ebfed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4LnyBPdY54-dTfaH_dghkQ.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">GCS浏览器:“存储对象查看器”</figcaption></figure><blockquote class="lx ly lz"><p id="5af6" class="if ig ma ih b ii ij ik il im in io ip mb ir is it mc iv iw ix md iz ja jb jc hb bi translated">“存储对象查看器”成员是我们的服务帐户。</p></blockquote><p id="2790" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.在Portainer中创建“自定义注册表”:</p><ul class=""><li id="672f" class="lm ln hi ih b ii ij im in iq lo iu lp iy lq jc me ls lt lu bi translated"><code class="du jt ju jv jj b">Name: gcr.io/${PROJECT}</code></li><li id="a74b" class="lm ln hi ih b ii mf im mg iq mh iu mi iy mj jc me ls lt lu bi translated"><code class="du jt ju jv jj b">Registry URL: gcr.io/${PROJECT}</code></li><li id="896e" class="lm ln hi ih b ii mf im mg iq mh iu mi iy mj jc me ls lt lu bi translated"><code class="du jt ju jv jj b">Username: _json_key</code></li><li id="bcab" class="lm ln hi ih b ii mf im mg iq mh iu mi iy mj jc me ls lt lu bi translated"><code class="du jt ju jv jj b">Password</code> -将<code class="du jt ju jv jj b">${ROBOT}.key.json</code>的内容复制粘贴到此处</li><li id="9089" class="lm ln hi ih b ii mf im mg iq mh iu mi iy mj jc me ls lt lu bi translated">点击<code class="du jt ju jv jj b">add registry</code></li></ul><figure class="je jf jg jh fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es ki"><img src="../Images/5287e05946a87199fc04b2869d2fda15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TnxvDgbFodCsBMxa6hW0bw.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">Portainer“自定义注册表”</figcaption></figure><p id="5619" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以随意使用注册表。</p></div></div>    
</body>
</html>