<html>
<head>
<title>Building your first Action for Google Home (part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为Google Home构建您的第一个动作(第2部分)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/building-your-first-action-for-google-home-part-2-594888a8c09b?source=collection_archive---------0-----------------------#2017-04-10">https://medium.com/google-cloud/building-your-first-action-for-google-home-part-2-594888a8c09b?source=collection_archive---------0-----------------------#2017-04-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3126" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第一篇文章中，我们在Google Cloud上设置了一个环境，使用Google Cloud函数在Google上部署了我们的第一个动作，并使用文本或web模拟器或Google Home设备对其进行了测试。你能让示例应用程序与模拟器一起工作吗？如果是这样，恭喜你，这是最困难的部分；暂时如此。如果没有，请在Twitter上给我发消息，我很乐意帮助你让它运行起来。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/2aeac38a2330b6a1ca372635abf042c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fOCu6qBRZBK27GYPEmYPMQ.png"/></div></div></figure><blockquote class="jr js jt"><p id="0cf7" class="if ig ju ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">你看过<a class="jd je ge" href="https://medium.com/u/a8c4b9a13374?source=post_page-----594888a8c09b--------------------------------" rel="noopener" target="_blank">南迪尼斯托克</a>的<a class="ae jy" href="https://developers.google.com/actions/design/checklist" rel="noopener ugc nofollow" target="_blank">设计清单</a>吗？如果没有，请在继续之前完成。在这一系列文章中，我们将继续讨论设计最佳实践。</p></blockquote><p id="8116" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将快速浏览一下代码，更好地理解它是如何工作的。然后，我将更详细地向您介绍JSON响应。</p><p id="5bdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要了解生产中的应用，比如说，</p><blockquote class="jz"><p id="3aac" class="ka kb hi bd kc kd ke kf kg kh ki jc dx translated"><strong class="ak">“嘿谷歌，我想和疯人院谈谈”</strong>。</p></blockquote><p id="2fff" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">好吧，很可爱对吧？这是一个随机的房间生成器，有三扇门可供选择。这是一个非常基本的应用程序，有点娱乐性。我们将把它用于学习目的，但是要知道它缺乏在Google上创建一个伟大的行动所需的对话式交互和用户参与。</p><p id="45b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为Google编写一个动作有几种不同的方法:</p><ol class=""><li id="6724" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc kt ku kv kw bi translated">使用HTTP POST/JSON RESTful API滚动您自己的代码</li><li id="e0c4" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">使用用Javascript编写的Google Actions SDK for node . js</li><li id="0942" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">用API写一个app。人工智能工具</li><li id="6b6e" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">使用支持谷歌操作的第三方工具</li></ol><p id="c7f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在为Google Home 构建第一个动作的<a class="ae jy" rel="noopener" href="/google-cloud/building-your-first-action-for-google-home-in-30-minutes-ec6c65b7bd32">第1部分中部署的代码基于第一种方法。</a></p><blockquote class="jr js jt"><p id="f3fd" class="if ig ju ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">如果你还没有下载代码，你可以从<a class="ae jy" href="https://github.com/eisenzopf/google-action-three-doors" rel="noopener ugc nofollow" target="_blank">https://github.com/eisenzopf/google-action-three-doors</a>下载或者直接运行:</p><p id="5220" class="if ig ju ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated"><code class="du lc ld le lf b">git <a class="ae jy" href="https://github.com/eisenzopf/google-action-three-doors.git" rel="noopener ugc nofollow" target="_blank">https://github.com/eisenzopf/google-action-three-doors.git</a></code></p></blockquote><p id="9105" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为回顾，我们在第1部分看到了一个序列图，展示了Google Home设备和我们的Google Cloud Function (Node.js)应用程序之间的HTTP/JSON交互。让我们再看一遍。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es lg"><img src="../Images/af45f63c86ea478e6ded9d4886998048.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*9S_2J4Wxk6EaQgxbbq01fg.png"/></div><figcaption class="lh li et er es lj lk bd b be z dx translated">对话API序列图</figcaption></figure><p id="aeaa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你是否看到上面的Google Home设备在步骤1中获取用户话语，“嘿，Google…”然后看到Google Action Platform如何将其传递给我们的Google Cloud功能，然后在步骤2中我们如何传回一个问题，用户如何选择一扇门？我们现在来看看代码，看看它是如何工作的。</p><p id="cca6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你曾经与这个应用程序交互过，你可能会惊讶地发现这个应用程序只有不到50行代码(准确地说是39行)。出于学习目的，我保持了代码的简洁，所以请注意，Google上真正的产品级操作需要有更强大的对话能力。</p></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><h1 id="296e" class="ls lt hi bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">index.js源代码的快速摘要</h1><p id="0a81" class="pw-post-body-paragraph if ig hi ih b ii mq ik il im mr io ip iq ms is it iu mt iw ix iy mu ja jb jc hb bi translated">现在来看代码(包含在index.js中)。花点时间通读一下。在整篇文章中，我们将通过行号引用它。</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="mv mw l"/></div></figure><p id="1418" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是对每个代码块的简要描述:</p><ul class=""><li id="80e1" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc mx ku kv kw bi translated"><strong class="ih hj">第4–11行</strong>加载默认的对话API JSON响应以及我们将用来为用户创建提示的内容。我已经将内容分为房间(不同的房间描述)、对象(存在于房间中)、问候(我们在应用程序开始时播放的其中一个)、nomatch(我们用于对话修复)、pickDoor(要求用户选择门的不同措辞)和doors(描述用户开门时发生的事情的不同短语)。</li><li id="c34d" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mx ku kv kw bi translated"><strong class="ih hj">第12行</strong>加载<a class="ae jy" href="https://github.com/lodash/lodash" rel="noopener ugc nofollow" target="_blank"> lodash </a>库，该库包含一组很棒的文本实用函数。</li><li id="28ca" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mx ku kv kw bi translated"><strong class="ih hj">第14–16行</strong>导出我们的<code class="du lc ld le lf b">three_doors</code>函数，这就是我们如何为Google Cloud Functions平台封装东西。注意，应用程序类型必须设置为<code class="du lc ld le lf b">application/json</code>，我们需要在HTTP响应头中将<code class="du lc ld le lf b">Google-Assistant-API-Version</code>设置为<code class="du lc ld le lf b">v1</code>。你可以在<a class="ae jy" href="https://cloud.google.com/functions/docs/writing/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/functions/docs/writing/</a>找到更多关于如何创建谷歌云功能的文档</li><li id="0023" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mx ku kv kw bi translated"><strong class="ih hj">第18行</strong>创建对来自Google Home设备的包含用户输入字符串的HTTP JSON请求部分的引用。这样做只是为了方便。您可以在以下位置查看JSON请求的完整示例:<a class="ae jy" href="https://developers.google.com/actions/reference/conversation#request" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/actions/reference/conversation # request</a></li><li id="803c" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mx ku kv kw bi translated"><strong class="ih hj">第20–23行</strong>检查<code class="du lc ld le lf b">req.body.conversation.type</code>的值，它是HTTP JSON请求的元素，告诉我们这是否是该用户会话对应用程序的第一次调用。如果是<strong class="ih hj"> 1 </strong>(这意味着这是该会话的第一次调用)，我们将创建一个提示，该提示将通过文本到语音的方式向用户播放，它由一个串联的字符串组成，该字符串使用<code class="du lc ld le lf b">lodash</code> <code class="du lc ld le lf b">sample()</code>函数从<code class="du lc ld le lf b">greetings</code>、<code class="du lc ld le lf b">doors</code>、<code class="du lc ld le lf b">rooms</code>、<code class="du lc ld le lf b">objects</code>和<code class="du lc ld le lf b">pickDoor</code> JSON对象中选取一个随机值。如果是<strong class="ih hj"> 2 </strong>，这意味着这是该用户会话的后续调用。</li><li id="b009" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mx ku kv kw bi translated"><strong class="ih hj">如果用户说出任何包含单词<strong class="ih hj"> stop </strong>的内容，则第25–26行</strong>匹配。因此，它将发送回<code class="du lc ld le lf b">action_final_response</code> JSON，从而结束会话。</li><li id="beea" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mx ku kv kw bi translated"><strong class="ih hj">第28–31行</strong>这是一个棘手的问题，因为NLP部分会很快变得困难。这是当应用程序要求用户选择门时处理用户输入的代码。为了简洁起见，我使用了一个正则表达式来匹配用户可能选择门的各种方式(1–3)。这个正则表达式并不完美，在某些情况下可能不是正确的NLP方法，但是，您可以在我保存我的会话的<a class="ae jy" href="http://regexr.com/3fjd6" rel="noopener ugc nofollow" target="_blank">http://regexr.com/3fjd6</a>使用它，看看它匹配什么，您可以进一步优化它以更好地匹配输入并消除误报。请把你的改进发给我。如果有匹配，这意味着用户(可能)选择了三扇门中的一扇门，我们在第<strong class="ih hj"> 30 </strong>行随机生成另一个房间。</li><li id="b8e7" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mx ku kv kw bi translated"><strong class="ih hj">第33–37行</strong>处理这种情况:不是第一次调用应用程序，用户的输入与门不匹配，他们没有说<strong class="ih hj">停止</strong>。这意味着他们说了些别的。鉴于这是一个示例应用程序，我们不会像往常一样尝试高级会话修复；相反，我们将从<code class="du lc ld le lf b">nomatch</code> JSON文件中选择一个随机提示，并再次要求他们选择一扇门。只是在这里再次强调，这是糟糕的设计实践；如果你在野外这么做，你的用户会惩罚你。</li><li id="58a9" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mx ku kv kw bi translated"><strong class="ih hj">第38行</strong>将HTTP响应码设置为200，告知客户端请求成功。这也终结了谷歌云功能代码块。</li></ul><p id="e97c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就这样，这就是代码。这给了你一个基本的开始来玩和扩展。我们将在下一篇文章中深入探讨调试和测试。本文的其余部分提供了对JSON响应文件的进一步解释，以帮助您更好地理解Google Conversation API上的操作是如何工作的。</p><h1 id="da91" class="ls lt hi bd lu lv my lx ly lz mz mb mc md na mf mg mh nb mj mk ml nc mn mo mp bi translated">常量声明(第4–12行)</h1><h2 id="a48d" class="nd lt hi bd lu ne nf ng ly nh ni nj mc iq nk nl mg iu nm nn mk iy no np mo nq bi translated">常量操作_最终_响应</h2><p id="b279" class="pw-post-body-paragraph if ig hi ih b ii mq ik il im mr io ip iq ms is it iu mt iw ix iy mu ja jb jc hb bi translated">第一个常量<code class="du lc ld le lf b">action_final_response</code> <strong class="ih hj"> </strong>加载一个JSON文件，如果用户说了一些带有单词<strong class="ih hj"> stop </strong>的话，作为他们对输入提示的响应的一部分，该文件由应用程序返回。例如，当游戏要求我选择一扇门时，我可能会说<em class="ju">“我想我要</em> <strong class="ih hj"> <em class="ju">停止</em> </strong> <em class="ju">玩这个游戏”</em>作为我的回应。</p><blockquote class="jr js jt"><p id="9cd8" class="if ig ju ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">有关JSON请求(Google Home发送给我们的应用程序的内容)和响应格式(我们的应用程序发送回Google Home的内容)的完整描述，请参见<a class="ae jy" href="https://developers.google.com/actions/reference/conversation#request" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/actions/reference/conversation # request</a></p></blockquote><p id="2bf8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lc ld le lf b">action-final-response.json</code>文件的内容如下:</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="mv mw l"/></div></figure><p id="4561" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以上是当用户说<strong class="ih hj"> stop </strong>并符合Google Conversation API上的动作时，我们发送回Google Home设备的JSON响应。在index.js的第25–26行中，您会找到在<code class="du lc ld le lf b">userInput</code>上执行正则表达式<code class="du lc ld le lf b">match()</code>函数并将<code class="du lc ld le lf b">action_final_response</code>写入Google Cloud functions <code class="du lc ld le lf b">res</code>对象的代码，该函数编写我们的HTTP JSON响应。我们使用<code class="du lc ld le lf b">res.json</code>函数显式地将<code class="du lc ld le lf b">action_final_response</code>对象转换成JSON格式(即使它已经是JSON)。</p><h2 id="720b" class="nd lt hi bd lu ne nf ng ly nh ni nj mc iq nk nl mg iu nm nn mk iy no np mo nq bi translated">常量操作_响应</h2><p id="eadd" class="pw-post-body-paragraph if ig hi ih b ii mq ik il im mr io ip iq ms is it iu mt iw ix iy mu ja jb jc hb bi translated"><code class="du lc ld le lf b"><strong class="ih hj">action_response</strong></code> <strong class="ih hj"> </strong>常量加载一个带有通用对话API JSON响应的JSON文件，我们将为向用户回放的每个提示重载和定制该响应。</p><blockquote class="jr js jt"><p id="0ecf" class="if ig ju ih b ii ij ik il im in io ip jv ir is it jw iv iw ix jx iz ja jb jc hb bi translated">有关JSON响应格式的更多详细信息，请参考<a class="ae jy" href="https://developers.google.com/actions/reference/conversation#http-response" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/actions/reference/conversation # http-response</a>。</p></blockquote><p id="3f2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lc ld le lf b">action-response.json</code>文件的内容如下:</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="mv mw l"/></div></figure><p id="6be7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是该文件重要部分的摘要:</p><ul class=""><li id="5bc1" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc mx ku kv kw bi translated"><strong class="ih hj">第2行</strong> <code class="du lc ld le lf b">conversation_token</code>是你控制的一个状态变量。客户端将在下一个请求中传回您分配的任何内容。您可以使用它来跟踪用户在对话流中的位置。然而，我们并没有在这个例子中使用它。</li><li id="62e5" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mx ku kv kw bi translated"><strong class="ih hj">第3行</strong> <code class="du lc ld le lf b">expected_user_response</code>可以设置为<strong class="ih hj">真</strong>或<strong class="ih hj">假</strong>。将它设置为<strong class="ih hj"> true </strong>意味着应用程序将期待(并且Google Home将收集)用户输入。</li><li id="28a8" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mx ku kv kw bi translated"><strong class="ih hj">第8–11行</strong>包含收集输入前将向用户播放的提示。</li><li id="d6f5" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mx ku kv kw bi translated"><strong class="ih hj">第13–23行</strong>包含(最多)3个无提示。当5秒钟后没有收到用户的输入时，播放这些内容。</li><li id="27e1" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mx ku kv kw bi translated"><strong class="ih hj">第25–29行</strong>告诉客户我们将等待客户的文本。我们将在以后的文章中讨论其他选项。</li></ul><p id="a7f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就结束了我们创建Google的第一个动作系列的第2部分。在第3部分中，我们将看看可以用来快速调试应用程序的工具。</p><p id="caf3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请随时提出问题、编辑或对未来主题的要求。只要在推特上给乔纳森·艾森佐夫发个消息就行了。如果你喜欢这篇文章，请把它变成你的最爱，并与你的朋友分享。</p></div></div>    
</body>
</html>