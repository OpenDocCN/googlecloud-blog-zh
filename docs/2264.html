<html>
<head>
<title>Save Money by shutting down GCE instances using Cloud Composer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过使用Cloud Composer关闭GCE实例来节省资金</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/save-money-by-shuting-down-gce-instances-using-cloud-composer-e70d7a3f6c98?source=collection_archive---------1-----------------------#2022-07-15">https://medium.com/google-cloud/save-money-by-shuting-down-gce-instances-using-cloud-composer-e70d7a3f6c98?source=collection_archive---------1-----------------------#2022-07-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5ff4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大多数GCP用户使用计算引擎资源，这使得在GCP上设置不同大小和风格的虚拟机变得很容易。这些资源是根据它们的运行时间计费的。通过明智地减少这些GCE实例的运行时间，可以节省大量资金。</p><p id="a7d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以通过多种方式优化GCE成本。其中之一是在GCE实例不被使用时关闭它们。例如，我们可以在周末关闭“开发”环境中的所有实例。这可以为我们节省很多钱。最好的方法是使用GCP上可用的工具和服务实现自动化。有一个非常好的<a class="ae jd" href="https://cloud.google.com/scheduler/docs/start-and-stop-compute-engine-instances-on-a-schedule" rel="noopener ugc nofollow" target="_blank">指南</a>使用云调度器、发布/订阅和云函数来按照给定的时间表停止和启动实例。</p><p id="41c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文重点介绍如何使用Cloud Composer来调度Dag以停止和启动实例。Cloud Scheduler+Pub/Sub+Cloud Function组合和Cloud Composer选择哪一个取决于很多因素，我们不打算在本文中详细讨论。一个因素可能是，如果您的环境中已经在使用Cloud Composer，那么对这种自动化也使用相同的组件是有意义的。</p><h1 id="1fe6" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">先决条件</h1><ol class=""><li id="6999" class="kc kd hi ih b ii ke im kf iq kg iu kh iy ki jc kj kk kl km bi translated">用户已经部署了Cloud Composer环境，并且能够计划他/她的Dag。</li><li id="9f13" class="kc kd hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated">获取composer工作节点使用的服务帐户。用户可以执行下面的gcloud命令来获得相同的结果:</li></ol><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="608d" class="lb jf hi kx b fi lc ld l le lf">gcloud composer environments describe &lt;composer_env_name&gt; --location &lt;region&gt; --project &lt;composer_env_project_id&gt; --format json | jq '.config.nodeConfig.serviceAccount'</span></pre><p id="474d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.为composer worker服务帐户分配计算实例管理员角色，以便Dag停止/启动实例。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="79df" class="lb jf hi kx b fi lc ld l le lf">gcloud projects add-iam-policy-binding &lt;compute_instance_project_id&gt; --member='serviceAccount:&lt;composer_worker_sa_email&gt;' --role="roles/compute.instanceAdmin.v1"</span></pre><p id="cffb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.获取composer存储其Dag的GCS位置。用户可以执行下面的gcloud命令来获得相同的结果。我们将使用这个桶来上传Dag。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="af58" class="lb jf hi kx b fi lc ld l le lf">gcloud composer environments describe &lt;composer_env_name&gt; --location &lt;region&gt; --project &lt;composer_env_project_id&gt; --format json | jq '.config.dagGcsPrefix'</span></pre><h1 id="bc11" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">Dag详细信息</h1><p id="db10" class="pw-post-body-paragraph if ig hi ih b ii ke ik il im kf io ip iq lg is it iu lh iw ix iy li ja jb jc hb bi translated">使用以下代码创建DAG以停止实例。根据您的env替换PROJECT_ID和ZONE变量的值。这将在每周星期六上午12点停止给定项目和区域中带有标签“env:dev”的所有实例。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="55fc" class="lb jf hi kx b fi lc ld l le lf"><strong class="kx hj">import</strong> <strong class="kx hj">logging</strong><br/><br/><strong class="kx hj">from</strong> <strong class="kx hj">airflow</strong> <strong class="kx hj">import</strong> models, utils <strong class="kx hj">as</strong> airflow_utils<br/><strong class="kx hj">from</strong> <strong class="kx hj">airflow.models</strong> <strong class="kx hj">import</strong> BaseOperator<br/><strong class="kx hj">from</strong> <strong class="kx hj">airflow.utils.decorators</strong> <strong class="kx hj">import</strong> apply_defaults<br/><strong class="kx hj">from</strong> <strong class="kx hj">airflow.operators.dummy_operator</strong> <strong class="kx hj">import</strong> DummyOperator<br/><strong class="kx hj">import</strong> <strong class="kx hj">googleapiclient.discovery</strong><br/><strong class="kx hj">from</strong> <strong class="kx hj">oauth2client.client</strong> <strong class="kx hj">import</strong> GoogleCredentials<br/><br/>ENVIRONMENT = "dev"<br/>PROJECT_ID = &lt;project_id&gt;<br/>ZONE = &lt;zone&gt;<br/><br/><br/>DEFAULT_ARGS = {<br/>    'owner': 'airflow',<br/>    'start_date': airflow_utils.dates.days_ago(7)<br/>}<br/><br/><strong class="kx hj">class</strong> <strong class="kx hj">StopInstanceOperator</strong>(BaseOperator):<br/>    <em class="lj">"""Stops the virtual machine instances."""</em><br/>    @apply_defaults<br/>    <strong class="kx hj">def</strong> __init__(self, project, zone, *args, **kwargs):<br/>        self._compute = <strong class="kx hj">None</strong><br/>        self.project = project<br/>        self.zone = zone<br/>        super(StopInstanceOperator, self).__init__(*args, **kwargs)<br/>        <br/>    <strong class="kx hj">def</strong> get_compute_api_client(self):<br/>        <strong class="kx hj">if</strong> self._compute <strong class="kx hj">is</strong> <strong class="kx hj">None</strong>:<br/>            credentials=GoogleCredentials.get_application_default()<br/>            self._compute = googleapiclient.discovery.build(<br/>                'compute', 'v1', cache_discovery=<strong class="kx hj">False</strong>,<br/>                credentials=credentials)<br/>        <strong class="kx hj">return</strong> self._compute<br/>    <br/>    <strong class="kx hj">def</strong> list_instances(self):<br/>        instance_res=self.get_compute_api_client().instances().list(<br/>            project=self.project, zone=self.zone,<br/>            filter=f"labels.env={ENVIRONMENT}").execute()<br/>        <strong class="kx hj">return</strong> [instance['name'] <br/>                <strong class="kx hj">for</strong> instance <strong class="kx hj">in</strong> instance_res.get('items', [])]<br/>            <br/>    <strong class="kx hj">def</strong> execute(self, context):<br/>        <strong class="kx hj">for</strong> instance <strong class="kx hj">in</strong> self.list_instances():<br/>            logging.info(<br/>                'Stopping instance %s in project %s and zone %s',<br/>                instance, self.project, self.zone)<br/>            self.get_compute_api_client().instances().stop(<br/>                project=self.project, zone=self.zone,   <br/>                instance=instance).execute()<br/><br/><br/><strong class="kx hj">with</strong> models.DAG(<br/>    "stop_gce_instances",<br/>    default_args=DEFAULT_ARGS,<br/>    schedule_interval='0 0 * * 6',<br/>    tags=["stop_gce_instances"],<br/>) <strong class="kx hj">as</strong> dag:<br/>    begin = DummyOperator(task_id='begin')<br/>    end = DummyOperator(task_id='end')<br/>    stop_gce_instances = StopInstanceOperator(<br/>        project=PROJECT_ID, zone=ZONE, task_id='stop_gce_instances')<br/>    begin &gt;&gt; stop_gce_instances &gt;&gt; end</span></pre><p id="6f2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下代码创建DAG以启动实例。根据您的env替换PROJECT_ID和ZONE变量的值。这将在每周一上午5点启动给定项目和区域中标签为“env:dev”的所有实例。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="793f" class="lb jf hi kx b fi lc ld l le lf"><strong class="kx hj">import</strong> <strong class="kx hj">logging</strong><br/><br/><strong class="kx hj">from</strong> <strong class="kx hj">airflow</strong> <strong class="kx hj">import</strong> models, utils <strong class="kx hj">as</strong> airflow_utils<br/><strong class="kx hj">from</strong> <strong class="kx hj">airflow.models</strong> <strong class="kx hj">import</strong> BaseOperator<br/><strong class="kx hj">from</strong> <strong class="kx hj">airflow.utils.decorators</strong> <strong class="kx hj">import</strong> apply_defaults<br/><strong class="kx hj">from</strong> <strong class="kx hj">airflow.operators.dummy_operator</strong> <strong class="kx hj">import</strong> DummyOperator<br/><strong class="kx hj">import</strong> <strong class="kx hj">googleapiclient.discovery</strong><br/><strong class="kx hj">from</strong> <strong class="kx hj">oauth2client.client</strong> <strong class="kx hj">import</strong> GoogleCredentials<br/><br/>ENVIRONMENT = "dev"<br/>PROJECT_ID = &lt;project_id&gt;<br/>ZONE = &lt;zone&gt;<br/><br/><br/>DEFAULT_ARGS = {<br/>    'owner': 'airflow',<br/>    'start_date': airflow_utils.dates.days_ago(7)<br/>}<br/><br/><strong class="kx hj">class</strong> <strong class="kx hj">StartInstanceOperator</strong>(BaseOperator):<br/>    <em class="lj">"""Start the virtual machine instances."""</em><br/>    @apply_defaults<br/>    <strong class="kx hj">def</strong> __init__(self, project, zone, *args, **kwargs):<br/>        self._compute = <strong class="kx hj">None</strong><br/>        self.project = project<br/>        self.zone = zone<br/>        super(StartInstanceOperator, self).__init__(*args, **kwargs)<br/>        <br/>    <strong class="kx hj">def</strong> get_compute_api_client(self):<br/>        <strong class="kx hj">if</strong> self._compute <strong class="kx hj">is</strong> <strong class="kx hj">None</strong>:<br/>            credentials= GoogleCredentials.get_application_default()<br/>            self._compute = googleapiclient.discovery.build(<br/>                'compute', 'v1', cache_discovery=<strong class="kx hj">False</strong>, <br/>                credentials=credentials)<br/>        <strong class="kx hj">return</strong> self._compute<br/>    <br/>    <strong class="kx hj">def</strong> list_instances(self):<br/>        instance_res=self.get_compute_api_client().instances().list(<br/>            project=self.project, zone=self.zone, <br/>            filter=f"labels.env={ENVIRONMENT}").execute()<br/>        <strong class="kx hj">return</strong> [instance['name'] <br/>                <strong class="kx hj">for</strong> instance <strong class="kx hj">in</strong> instance_res.get('items', [])]<br/>            <br/>    <strong class="kx hj">def</strong> execute(self, context):<br/>        <strong class="kx hj">for</strong> instance <strong class="kx hj">in</strong> self.list_instances():<br/>            logging.info(<br/>                'Starting instance %s in project %s and zone %s',<br/>                instance, self.project, self.zone)<br/>            self.get_compute_api_client().instances().start(<br/>                project=self.project, zone=self.zone, <br/>                instance=instance).execute()<br/><br/><br/><strong class="kx hj">with</strong> models.DAG(<br/>    "start_gce_instances",<br/>    default_args=DEFAULT_ARGS,<br/>    schedule_interval='0 5 * * 1',<br/>    tags=["start_gce_instances"],<br/>) <strong class="kx hj">as</strong> dag:<br/>    begin = DummyOperator(task_id='begin')<br/>    end = DummyOperator(task_id='end')<br/>    start_gce_instances = StartInstanceOperator(<br/>        project=PROJECT_ID, zone=ZONE,  <br/>        task_id='start_gce_instances')<br/>    begin &gt;&gt; start_gce_instances &gt;&gt; end</span></pre><p id="257a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将dag上传到composer dags存储桶文件夹。为了进行测试，从composer UI中触发Dag。DAG应该成功完成。</p><p id="e4ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我借用了这篇<a class="ae jd" href="https://cloud.google.com/architecture/automating-infrastructure-using-cloud-composer" rel="noopener ugc nofollow" target="_blank">文章</a>的大部分代码，做了非常小的修改。</p><p id="a124" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">省钱！！快乐阅读！！！欢迎评论和建议。</p></div></div>    
</body>
</html>