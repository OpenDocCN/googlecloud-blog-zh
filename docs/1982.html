<html>
<head>
<title>Change Data Capture with Debezium Server on GKE from CloudSQL for PostgreSQL to Pub/Sub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将GKE上Debezium服务器的数据捕获从CloudSQL for PostgreSQL更改为发布/订阅</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/change-data-capture-with-debezium-server-on-gke-from-cloudsql-for-postgresql-to-pub-sub-d1c0b92baa98?source=collection_archive---------0-----------------------#2021-10-15">https://medium.com/google-cloud/change-data-capture-with-debezium-server-on-gke-from-cloudsql-for-postgresql-to-pub-sub-d1c0b92baa98?source=collection_archive---------0-----------------------#2021-10-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/5dcc9c9bc84b472f99c0d9af55798611.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wEGuCV59gA5SL7a2H0FGLQ.png"/></div></div></figure><div class=""/><p id="9571" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">变更数据捕获(CDC)是一种设计模式，它跟踪源系统上的变更数据，并将这些变更传输到其他系统。</p><p id="f36c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本文中，我们将捕获CloudSQL for PostgreSQL上的一个表的变化，并在一个发布/订阅主题上流式传输它们。</p><p id="4811" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我假设之前已经创建了一个PostgreSQL实例和一个GKE集群。(因为这些是托管服务，所以您可以轻松地创建它们。)</p><p id="9405" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有3个不同的部分来实现这一目标。这些是DB、Pub/Sub和Debezium服务器。</p><h1 id="7cac" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">数据库ˌ资料库</h1><p id="2b40" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">首先我们需要通过在 上将<strong class="is hu"><em class="kr">cloudsql . logical _ decoding</em></strong>标志设置为<strong class="is hu"> <em class="kr">来启用逻辑解码。</em></strong></p><p id="5108" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">之后，我们创建一个具有复制属性的数据库用户:</p><figure class="ks kt ku kv fd hk"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="1f27" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我们创建一个测试表来捕获:</p><figure class="ks kt ku kv fd hk"><div class="bz dy l di"><div class="kw kx l"/></div></figure><h1 id="8c3b" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">发布/订阅</h1><p id="6959" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我们需要创建一个名为<strong class="is hu"><em class="kr">debezium-test-db . public . debezium-test</em></strong>的发布/订阅主题，它使用类似于<strong class="is hu"> <em class="kr"> &lt;服务器名称&gt;的模式。&lt;模式名&gt;。&lt;表格名称&gt; </em> </strong>。我们将在下面的Debezium配置中设置服务器名称。</p><p id="67eb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们还需要创建一个订阅来获取相关主题的变更消息。</p><h1 id="3d16" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">Debezium服务器</h1><p id="cea0" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">要在Kubernetes上部署Debezium服务器，我们需要定义一些Kubernetes对象。Debezium服务器需要在一个文件中保存偏移量信息，所以我们将把它部署为一个StatefulSet。我们还为StatefulSet创建了一个服务，并创建了一个ConfigMap来保存Debezium配置。</p><figure class="ks kt ku kv fd hk"><div class="bz dy l di"><div class="kw kx l"/></div></figure><figure class="ks kt ku kv fd hk"><div class="bz dy l di"><div class="kw kx l"/></div></figure><figure class="ks kt ku kv fd hk"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="b9d3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">注意:</strong> Debezium服务器在捕获时会将变更事件推送到发布/订阅主题。为此，它必须具有所需的权限。工作负载标识是实现这一点的好方法。您可以创建一个GCP服务帐户并授予所需的权限。之后，使用工作负载身份，您可以将其绑定到Kubernetes服务帐户，这样，Kubernetes服务帐户就充当了GCP服务帐户。</p><p id="71c7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就是这样。您可以在表上插入、更新或删除数据，事件将被发送到相关主题。</p><p id="f4dc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">参考文献</strong></p><ul class=""><li id="ba1c" class="ky kz ht is b it iu ix iy jb la jf lb jj lc jn ld le lf lg bi translated"><a class="ae lh" href="https://cloud.google.com/sql/docs/postgres/replication/configure-logical-replication" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/SQL/docs/postgres/replication/configure-logical-replication</a></li><li id="6909" class="ky kz ht is b it li ix lj jb lk jf ll jj lm jn ld le lf lg bi translated"><a class="ae lh" href="https://debezium.io/documentation/reference/operations/debezium-server.html" rel="noopener ugc nofollow" target="_blank">https://debezium . io/documentation/reference/operations/debezium-server . html</a></li></ul></div></div>    
</body>
</html>