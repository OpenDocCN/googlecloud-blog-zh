<html>
<head>
<title>Building APIs with Cloud Functions and API Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用云功能和API网关构建API</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/building-apis-with-cloud-functions-and-api-gateway-3892e1301cb4?source=collection_archive---------1-----------------------#2022-02-10">https://medium.com/google-cloud/building-apis-with-cloud-functions-and-api-gateway-3892e1301cb4?source=collection_archive---------1-----------------------#2022-02-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="466b" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">使用云运行构建API</h1><p id="4329" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">如果我想构建一个API，我通常会使用云运行。在云运行中，您运行一个容器，在该容器中，您运行一个处理以下格式的基本URL的web服务器:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="5437" class="kk ig hi kg b fi kl km l kn ko">https://&lt;service-name&gt;-&lt;hash&gt;-&lt;region&gt;.a.run.app</span></pre><p id="4793" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">然后，您可以让web服务器处理该基本URL下的任何路径，例如:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="5b9e" class="kk ig hi kg b fi kl km l kn ko">https://&lt;service-name&gt;-&lt;hash&gt;-&lt;region&gt;.a.run.app/hello https://&lt;service-name&gt;-&lt;hash&gt;-&lt;region&gt;.a.run.app/bye</span></pre><h1 id="3452" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">构建具有云功能的API</h1><p id="0114" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在云函数中，您只能访问一个函数(没有web服务器),并且该函数只能处理基本路径:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="1f66" class="kk ig hi kg b fi kl km l kn ko">https://&lt;region&gt;-&lt;project&gt;.cloudfunctions.net/&lt;function&gt;</span></pre><p id="fdef" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">该基本路径下不能有其他路径。这是<strong class="jf hj">一任务一功能</strong>设计的云功能。</p><p id="8348" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">这是否意味着不能使用云函数构建多路径API？不一定。</p><h1 id="c6db" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">变通办法</h1><p id="a1ae" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><a class="ae ku" href="https://twitter.com/gblaquiere" rel="noopener ugc nofollow" target="_blank">我们的云GDE Guillaume Blaquiere</a>讲述了Python中的几个变通方法，并继续讲述了如何在云函数中处理多个路径:</p><ul class=""><li id="6a8e" class="kv kw hi jf b jg kp jk kq jo kx js ky jw kz ka la lb lc ld bi translated"><a class="ae ku" rel="noopener" href="/google-cloud/use-multiple-paths-in-cloud-functions-python-and-flask-fc6780e560d3">在云函数、Python和Flask中使用多路径</a></li><li id="54d4" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated"><a class="ae ku" rel="noopener" href="/google-cloud/hack-use-cloud-functions-as-a-webserver-with-golang-42edc7935247"> Hack:使用云功能作为Golang的网络服务器</a></li></ul><p id="1bb7" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">我的同事<a class="ae ku" href="https://twitter.com/glaforge" rel="noopener ugc nofollow" target="_blank"> Guillaume Laforge </a>也谈到了如何在Node.js/Express应用和云功能中实现多路径:</p><ul class=""><li id="88a3" class="kv kw hi jf b jg kp jk kq jo kx js ky jw kz ka la lb lc ld bi translated"><a class="ae ku" href="https://glaforge.appspot.com/article/serverless-tip-7-create-mini-apis-with-cloud-functions-and-express-routing" rel="noopener ugc nofollow" target="_blank">无服务器提示#7 —创建具有云功能和快速路由的迷你API</a></li></ul><p id="ae07" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">如果你想在一个单一的云功能中找到一个简单的解决方案，这些可能是可行的，但是它们只是权宜之计，有点违背云功能的设计。</p><h1 id="b133" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">API网关</h1><p id="71cf" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">更好的方法是使用<a class="ae ku" href="https://cloud.google.com/api-gateway" rel="noopener ugc nofollow" target="_blank"> API网关</a>。您让每个云函数处理单个路径，并让API Gateway根据您定义的规则路由子路径:</p><figure class="kb kc kd ke fd lk er es paragraph-image"><div class="er es lj"><img src="../Images/3a40bec6b6e9930c43c836dc5c085938.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/0*qdFWc2Sn-aHaliSC.png"/></div></figure><p id="2c4b" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">你可以查看我的<a class="ae ku" href="https://github.com/meteatamel/cloud-functions-api" rel="noopener ugc nofollow" target="_blank">cloud-functions-API</a>repo，了解如何设置的细节，但它涉及4个步骤:</p><ol class=""><li id="deaa" class="kv kw hi jf b jg kp jk kq jo kx js ky jw kz ka ln lb lc ld bi translated">部署两个功能<code class="du lo lp lq kg b">helloWorld</code>和<code class="du lo lp lq kg b">byeWorld</code>。</li><li id="5e4f" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka ln lb lc ld bi translated">创建一个API。</li><li id="20a4" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka ln lb lc ld bi translated">使用OpenAPI规范创建API配置，以定义哪个路径指向哪个函数。</li><li id="ccec" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka ln lb lc ld bi translated">将API配置部署到网关。</li></ol><p id="a168" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">API配置文件<a class="ae ku" href="https://github.com/meteatamel/cloud-functions-api/blob/main/openapi2-functions.yaml" rel="noopener ugc nofollow" target="_blank">open API 2-functions . YAML</a>定义路径如下:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="3b21" class="kk ig hi kg b fi kl km l kn ko">paths:<br/>  /hello:<br/>    get:<br/>      summary: Greet a user<br/>      operationId: hello<br/>      x-google-backend:<br/>        address: <a class="ae ku" href="https://REGION-PROJECT_ID.cloudfunctions.net/helloWorld" rel="noopener ugc nofollow" target="_blank">https://REGION-PROJECT_ID.cloudfunctions.net/helloWorld</a><br/>      responses:<br/>        '200':<br/>          description: A successful response<br/>          schema:<br/>            type: string<br/>  /bye:<br/>    get:<br/>      summary: Greet a user<br/>      operationId: bye<br/>      x-google-backend:<br/>        address: <a class="ae ku" href="https://REGION-PROJECT_ID.cloudfunctions.net/byeWorld" rel="noopener ugc nofollow" target="_blank">https://REGION-PROJECT_ID.cloudfunctions.net/byeWorld</a><br/>      responses:<br/>        '200':<br/>          description: A successful response<br/>          schema:<br/>            type: string</span></pre><p id="d3b7" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">有了这个设置，您就有了一个由两个云功能支持的API，并由API网关提供支持:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="f902" class="kk ig hi kg b fi kl km l kn ko"># Test hello<br/>curl <a class="ae ku" href="https://greeter-gateway-5abbajef.ew.gateway.dev/hello" rel="noopener ugc nofollow" target="_blank">https://greeter-gateway-5abbajef.ew.gateway.dev/hello</a><br/>Hello, World</span><span id="f4d6" class="kk ig hi kg b fi lr km l kn ko"># Test bye<br/>curl <a class="ae ku" href="https://greeter-gateway-5abbajef.ew.gateway.dev/bye" rel="noopener ugc nofollow" target="_blank">https://greeter-gateway-5abbajef.ew.gateway.dev/bye</a><br/>Bye, World</span></pre><p id="358f" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">如有任何问题/反馈，请随时通过Twitter <a class="ae ku" href="https://twitter.com/meteatamel" rel="noopener ugc nofollow" target="_blank"> @meteatamel </a>联系我。</p></div><div class="ab cl ls lt gp lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hb hc hd he hf"><p id="bc4f" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated"><em class="lz">最初发布于</em><a class="ae ku" href="https://atamel.dev/posts/2022/02-10_cloud_functions_api_gateway/" rel="noopener ugc nofollow" target="_blank"><em class="lz">https://atamel . dev</em></a><em class="lz">。</em></p></div></div>    
</body>
</html>