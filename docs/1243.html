<html>
<head>
<title>IoT Tank Monitoring Solution Part 3 — Visualizing data using BigQuery Federated Queries, CloudSQL and Data Studio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">物联网储罐监控解决方案第3部分—使用BigQuery联邦查询、CloudSQL和Data Studio可视化数据</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/iot-tank-monitoring-solution-part-3-visualizing-data-using-cloudsql-federated-queries-bigquery-1a92d1a565a3?source=collection_archive---------3-----------------------#2020-01-06">https://medium.com/google-cloud/iot-tank-monitoring-solution-part-3-visualizing-data-using-cloudsql-federated-queries-bigquery-1a92d1a565a3?source=collection_archive---------3-----------------------#2020-01-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="a4d0" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用云计算跟踪储罐液位的端到端解决方案，无需过多担心基础设施管理。</h2></div><p id="2306" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是一个关于如何在谷歌云上创建一个农场储罐监控解决方案的3部分教程。</p><ul class=""><li id="458f" class="jt ju hi iz b ja jb jd je jg jv jk jw jo jx js jy jz ka kb bi translated">第1部分— <a class="ae kc" rel="noopener" href="/@alvaroviebrantz/iot-tank-monitoring-solution-part-1-build-a-rest-api-using-cloud-run-and-django-rest-framework-a8b9770eaa87">使用Cloud Run和Django Rest框架构建Rest API</a></li><li id="da35" class="jt ju hi iz b ja kd jd ke jg kf jk kg jo kh js jy jz ka kb bi translated">第二部分— <a class="ae kc" rel="noopener" href="/@alvaroviebrantz/iot-tank-monitoring-solution-part-2-micropython-device-with-esp8266-to-collect-tank-level-data-d74a1b947f60">收集坦克数据的MicroPython装置</a></li><li id="1600" class="jt ju hi iz b ja kd jd ke jg kf jk kg jo kh js jy jz ka kb bi translated">第3部分—使用BigQuery联邦查询和Data Studio可视化数据</li></ul><p id="11ff" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这最后一部分，我们将把模型数据和设备发送的遥测数据可视化。我们将在BigQuery上使用一个名为联邦查询的特性，它基本上允许我们在BigQuery内部查询外部数据，混合不同的数据源并更容易地构建我们的数据湖。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ki"><img src="../Images/db771b11f8916662149c5000c04bba44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SINiYcYahhCTPUDM4GGIlQ.png"/></div></div></figure><blockquote class="ku kv kw"><p id="ac4e" class="ix iy kx iz b ja jb ij jc jd je im jf ky jh ji jj kz jl jm jn la jp jq jr js hb bi translated">BigQuery Federated Queries目前处于测试阶段，接受连接到Google云存储和Google Cloud Big Table中的云SQL、CSV文件。</p></blockquote><h2 id="be32" class="lb lc hi bd ld le lf lg lh li lj lk ll jg lm ln lo jk lp lq lr jo ls lt lu lv bi translated">设置对我们的云SQL数据库的联合访问</h2><p id="6fe0" class="pw-post-body-paragraph ix iy hi iz b ja lw ij jc jd lx im jf jg ly ji jj jk lz jm jn jo ma jq jr js hb bi translated">这里的所有步骤都将在Google Cloud UI上进行，因为这样做似乎更容易。首先，我们转到BigQuery UI并添加一个外部源:</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mb"><img src="../Images/712daaebc1f99e60bf262ada20844e6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TcVffJvAjaKPPn8x11ENRQ.jpeg"/></div></div></figure><p id="9132" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，我们选择Cloud SQL数据源并添加我们数据库实例信息，我们使用相同的配置(实例连接、用户名、密码和数据库名称)在Cloud Run上部署我们的Django Rest后端。这里的一个附加配置是连接名，将在BigQuery上使用它来查询我们的外部数据。我把我的叫做“坦克监控”。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mc"><img src="../Images/56c42daa08f95922564062241cfe8f91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wWJhwDVSmGRsxOsaHQfkSA.jpeg"/></div></div></figure><p id="aa23" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">基本上就是这样，现在我们可以使用“EXTERNAL_QUERY”命令从BigQuery查询云SQL数据。下面是一个使用BigQuery从我们的云SQL数据库获取农场列表的例子(您可以在<a class="ae kc" href="https://console.cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank"> BigQuery UI </a>中测试它:</p><pre class="kj kk kl km fd md me mf mg aw mh bi"><span id="2ad2" class="lb lc hi me b fi mi mj l mk ml"><br/>select farms.*<br/>from EXTERNAL_QUERY(“[YOUR_PROJECT_NAME].us.tank-monitoring.farms”) farms</span></pre><p id="a8eb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在让我们使用这两个数据源来构建我们的仪表板。</p><h2 id="e101" class="lb lc hi bd ld le lf lg lh li lj lk ll jg lm ln lo jk lp lq lr jo ls lt lu lv bi translated">在Data Studio上构建仪表板</h2><p id="8c31" class="pw-post-body-paragraph ix iy hi iz b ja lw ij jc jd lx im jf jg ly ji jj jk lz jm jn jo ma jq jr js hb bi translated">我们希望将遥测数据可视化，并能够按农场和坦克进行筛选。因此，我们将创建一个查询，使用日期范围过滤器返回报告的所有数据，以避免返回过多的遥测数据。为此，我编写了一个查询，并根据配置的高度计算每个水箱的液位。“DS_START_DATE”和“DS_END_DATE”是将由Data Studio填充的参数。您可以注释日期过滤器，并在BigQuery上运行这个查询来查看一些数据。</p><pre class="kj kk kl km fd md me mf mg aw mh bi"><span id="59bc" class="lb lc hi me b fi mi mj l mk ml">SELECT <br/> device.deviceId,<br/> tank.id as tankId,<br/> tank.name as tankName,<br/> tank.height,<br/> farm.id as farmId,<br/> farm.name as farmName,<br/> JSON_EXTRACT(telemetry.data, ‘$.distance’) as distance,<br/> if(tank.height &gt; 0, 100*(tank.height — CAST(JSON_EXTRACT(telemetry.data, ‘$.distance’) as float64))/tank.height, 0) as level,<br/> telemetry.time<br/>FROM <br/> EXTERNAL_QUERY(“[YOUR_PROJECT_NAME].us.tank-monitoring”, “SELECT * FROM tank_monitoring_farm;”) farm<br/> left outer join EXTERNAL_QUERY(“[YOUR_PROJECT_NAME].us.tank-monitoring”, “SELECT * FROM tank_monitoring_tank;”) tank<br/> on tank.farm_id = farm.id<br/> left outer join EXTERNAL_QUERY(“[YOUR_PROJECT_NAME].us.tank-monitoring”, “SELECT * FROM tank_monitoring_device;”) device <br/> on device.tank_id = tank.id<br/> left outer join `[YOUR_PROJECT_NAME].tank_monitoring_dataset.device_telemetry` telemetry<br/> on CAST(device.id as string) = telemetry.device_id <br/>where telemetry.time between PARSE_TIMESTAMP(‘%Y%m%d’,<a class="ae kc" href="http://twitter.com/DS_START_DATE" rel="noopener ugc nofollow" target="_blank">@DS_START_DATE</a>) and PARSE_TIMESTAMP(‘%Y%m%d’,<a class="ae kc" href="http://twitter.com/DS_END_DATE" rel="noopener ugc nofollow" target="_blank">@DS_END_DATE</a>)<br/>order by telemetry.time</span></pre><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mm"><img src="../Images/d59ad3702f3ae7caf76c337dc037e43f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8eL8RpYXbZ_irygwa-3OsQ.png"/></div></div></figure><p id="8809" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">转到Data Studio开始创建仪表板，然后单击create Blank Report。</p><div class="mn mo ez fb mp mq"><a href="https://datastudio.google.com" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">Data Studio产品概述</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">轻松访问各种数据。Data Studio的内置连接器和合作伙伴连接器可以连接到…</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">datastudio.google.com</p></div></div><div class="mz l"><div class="na l nb nc nd mz ne ks mq"/></div></div></a></div><p id="8014" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，创建一个新的数据源，搜索BigQuery连接器并选择它。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es nf"><img src="../Images/c35e0dbff60e336499fda972c9d99ddb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bgGZjsxNYtRvdbBmI_jknQ.png"/></div></div></figure><p id="4b3c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在下一个屏幕上，选择自定义查询&gt;[您的项目名称]&gt;输入自定义查询。在这里复制我们的SQL查询加入云SQL数据库和BigQuery。启用日期参数以填充“DS_START_DATE”和“DS_END_DATE”参数。然后点击连接。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ng"><img src="../Images/f88886e8a0fe3164cfacbfeb55c97fca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*50F2CUi4BDXR4dPssdj_UA.png"/></div></div></figure><p id="0ba0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">其余的主要是拖放一些组件来构建您的仪表板。我不会仔细考虑每一步，但是在Data Studio上获得数据后，构建相同的东西应该非常简单。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ki"><img src="../Images/db771b11f8916662149c5000c04bba44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SINiYcYahhCTPUDM4GGIlQ.png"/></div></div></figure><h2 id="760e" class="lb lc hi bd ld le lf lg lh li lj lk ll jg lm ln lo jk lp lq lr jo ls lt lu lv bi translated">结论</h2><p id="6cd1" class="pw-post-body-paragraph ix iy hi iz b ja lw ij jc jd lx im jf jg ly ji jj jk lz jm jn jo ma jq jr js hb bi translated">这最后一部分也有点短，但只是为了展示我们合并来自云SQL和BigQuery的数据是多么简单，并展示在一个仪表板上，用户可以访问并看到系统上的数据流。我希望通过这篇教程，你能更好地理解如何使用谷歌云构建端到端的解决方案。</p></div></div>    
</body>
</html>