<html>
<head>
<title>BigQuery: deltas to latest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery:最新的增量</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bigquery-deltas-to-latest-e84999fdb311?source=collection_archive---------2-----------------------#2020-05-13">https://medium.com/google-cloud/bigquery-deltas-to-latest-e84999fdb311?source=collection_archive---------2-----------------------#2020-05-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="65de" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">挑战</h1><p id="1a91" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">一位同事向我提出了一个挑战:</p><blockquote class="kb kc kd"><p id="78b9" class="jd je ke jf b jg kf ji jj jk kg jm jn kh ki jq jr kj kk ju jv kl km jy jz ka hb bi translated">我进行了一系列更新，只设置了更改的字段。空表示没有变化。我有原始记录。我如何在BigQuery中处理这个问题？</p></blockquote><p id="e820" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo ki jq jr js kk ju jv jw km jy jz ka hb bi translated">将这些放到一个<a class="ae kn" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting" rel="noopener ugc nofollow" target="_blank"> BigQuery脚本</a>中会是另外一天，但是现在的焦点将是使用BigQuery <a class="ae kn" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#array_agg" rel="noopener ugc nofollow" target="_blank"> ARRAY_AGG </a>来处理这些变化。</p><p id="a369" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo ki jq jr js kk ju jv jw km jy jz ka hb bi translated"><em class="ke">更新—一个额外的模式被添加到</em><a class="ae kn" rel="noopener" href="/@mescanne/bigquery-delta-to-latest-all-history-c8f28f889c91"><em class="ke">big query:deltas to latest—所有历史</em> </a> <em class="ke">。</em></p><h1 id="eba3" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">解决方案</h1><h2 id="5a26" class="ko ig hi bd ih kp kq kr il ks kt ku ip jo kv kw it js kx ky ix jw kz la jb lb bi translated">测试数据</h2><p id="2e81" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">OriginalData将捕获所有字段的当前非空状态。在本例中，name是主键，id是递增的INT64，表示“最新”和最佳值。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="1ae9" class="ko ig hi lh b fi ll lm l ln lo">OriginalData AS (SELECT * FROM UNNEST([<br/>  STRUCT('nameA' AS name, 0 AS id, 20 AS age, 'superA' AS type),<br/>  STRUCT('nameB' AS name, 0 AS id, 21 AS age, 'superB' AS type),<br/>  STRUCT('nameC' AS name, 0 AS id, 22 AS age, 'superC' AS type),<br/>  STRUCT('nameD' AS name, 0 AS id, 23 AS age, 'superD' AS type)<br/>]))</span></pre><p id="6a14" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo ki jq jr js kk ju jv jw km jy jz ka hb bi translated">UpdatedData表示传入的增量。始终设置姓名和id，但年龄和类型可能为空</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="f4b2" class="ko ig hi lh b fi ll lm l ln lo">UpdatedData AS (SELECT * FROM UNNEST([<br/>  STRUCT('nameA' AS name,<br/>    3 AS id,<br/>    10 AS age,<br/>  CAST(NULL AS STRING) AS type),<br/>      STRUCT('nameA' AS name,<br/>    2 AS id,<br/>    23 AS age,<br/>    'superA-2' AS type),<br/>  STRUCT('nameA' AS name,<br/>    4 AS id,<br/>    CAST(NULL AS INT64) AS age,<br/>    CAST(NULL AS STRING) AS type)<br/>]))</span></pre><h2 id="74c0" class="ko ig hi bd ih kp kq kr il ks kt ku ip jo kv kw it js kx ky ix jw kz la jb lb bi translated">询问</h2><p id="a88d" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">将其放入一个可运行的查询中。</p><p id="23f1" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo ki jq jr js kk ju jv jw km jy jz ka hb bi translated">数据被联合在一起，所以我们有变更和原始数据，并按名称分组。</p><p id="7f97" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo ki jq jr js kk ju jv jw km jy jz ka hb bi translated">ARRAY_AGG在逐个字段的基础上执行以下操作:</p><ul class=""><li id="906d" class="lp lq hi jf b jg kf jk kg jo lr js ls jw lt ka lu lv lw lx bi translated">将所有非空字段排列成一个数组</li><li id="07a8" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated">按ID降序排列(因此第一个位置的值是最大的ID)</li><li id="4196" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated">拉出0处的偏移</li></ul><p id="a7b8" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo ki jq jr js kk ju jv jw km jy jz ka hb bi translated">全部在一个查询中:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="0203" class="ko ig hi lh b fi ll lm l ln lo">WITH<br/>  OriginalData AS (SELECT * FROM UNNEST([<br/>    STRUCT('nameA' AS name, 0 AS id, 20 AS age, 'superA' AS type),<br/>    STRUCT('nameB' AS name, 0 AS id, 21 AS age, 'superB' AS type),<br/>    STRUCT('nameC' AS name, 0 AS id, 22 AS age, 'superC' AS type),<br/>    STRUCT('nameD' AS name, 0 AS id, 23 AS age, 'superD' AS type)<br/>  ])),<br/>  UpdatedData AS (SELECT * FROM UNNEST([<br/>    STRUCT('nameA' AS name,<br/>      3 AS id,<br/>      10 AS age,<br/>      CAST(NULL AS STRING) AS type),<br/>    STRUCT('nameA' AS name,<br/>      2 AS id,<br/>      23 AS age,<br/>      'superA-2' AS type),<br/>    STRUCT('nameA' AS name,<br/>      4 AS id,<br/>      CAST(NULL AS INT64) AS age,<br/>      CAST(NULL AS STRING) AS type)<br/>  ]))<br/>SELECT<br/>  name,<br/>  MAX(id) AS id,<br/>  ARRAY_AGG(age IGNORE NULLS ORDER BY id DESC)[OFFSET(0)] AS age,<br/>  ARRAY_AGG(type IGNORE NULLS ORDER BY id DESC)[OFFSET(0)] AS type<br/>FROM<br/>(<br/>  SELECT * FROM OriginalData<br/>  UNION ALL<br/>  SELECT * FROM UpdatedData<br/>)<br/>GROUP BY<br/>  name;</span></pre><h1 id="9e48" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">结论</h1><p id="f192" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这展示了如何逐个字段地使用ARRAY_AGG来查找最新的非空值。</p><p id="c662" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo ki jq jr js kk ju jv jw km jy jz ka hb bi translated">使用BigQuery脚本，这可以合并到将增量应用于快照并更新快照的脚本中。那是以后的事了。</p></div></div>    
</body>
</html>