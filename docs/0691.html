<html>
<head>
<title>Monitoring HTTP Latency with OpenCensus and Stackdriver</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用OpenCensus和Stackdriver监控HTTP延迟</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/monitoring-http-latency-with-opencensus-and-stackdriver-bf561608e81a?source=collection_archive---------0-----------------------#2018-07-12">https://medium.com/google-cloud/monitoring-http-latency-with-opencensus-and-stackdriver-bf561608e81a?source=collection_archive---------0-----------------------#2018-07-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="608d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章将描述如何编写你自己的监控探针，在功能上类似于谷歌云上的Stackdriver正常运行时间检查。代码、配置文件、命令和详细说明在本随附的<a class="ae jd" href="https://gist.github.com/alexamies/b183e36b1f7019ba4d98e80e5b16cc80" rel="noopener ugc nofollow" target="_blank">要点</a>中提供。</p><h1 id="fe60" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">背景</h1><p id="9526" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">Stackdriver <a class="ae jd" href="https://cloud.google.com/monitoring/uptime-checks/" rel="noopener ugc nofollow" target="_blank"> uptime checks </a>特性是一个非常棒的特性，它让监控web应用程序可用性变得非常简单。它探测成功的HTTP响应的给定URL，并具有丰富的选项和功能，例如在您的网站关闭时配置警报。但是，如果您想做一些不具备开箱即用正常运行时间检查的独特工作，该怎么办呢？这篇文章将解释如何通过在Go中编写代码来用<a class="ae jd" href="https://opencensus.io/" rel="noopener ugc nofollow" target="_blank"> OpenCensus </a>实现你自己的探测器。该代码将被部署到位于不同地区的Kubernetes集群网络中，并被导出到Stackdriver以在仪表板上查看。</p><p id="cc37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">OpenCensus是一个用于分布式追踪和监控的开源库。OpenCensus APIs和stack driver API之间存在重叠，因此一种替代方法是使用stack driver API开发探测器。但是，使用OpenCensus有几个优点:</p><ol class=""><li id="281a" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">您避免了对专有API的显式依赖。这对开发开源项目的人和希望独立于供应商的公司来说非常重要。代码见<a class="ae jd" href="https://github.com/census-instrumentation" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>。</li><li id="81a0" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">OpenCensus具有额外的指标聚合功能，可以智能地帮助减少监控数据量和控制监控成本。有关如何定制的详细信息，请参见<a class="ae jd" href="https://godoc.org/go.opencensus.io/stats/view#Aggregation" rel="noopener ugc nofollow" target="_blank">聚合</a>类型。</li><li id="4074" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">OpenCensus支持多个后端的出口商。这使得it部门能够为收集器开发代码，将监控统计数据导出到多个云中。这篇文章使用<a class="ae jd" href="https://godoc.org/go.opencensus.io/exporter/stackdriver" rel="noopener ugc nofollow" target="_blank"> Stackdriver exporter </a>将数据发送到Google Cloud。其他出口商见<a class="ae jd" href="https://godoc.org/go.opencensus.io" rel="noopener ugc nofollow" target="_blank"> OpenCensus文档</a>。</li><li id="da9a" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">OpenCensus supports为本地库特性(如HTTP和gRPC)预建了工具。这篇文章的代码使用了OpenCensus <a class="ae jd" href="https://godoc.org/go.opencensus.io/plugin/ochttp" rel="noopener ugc nofollow" target="_blank"> HTTP插件</a>，减少了需要编写的代码量。</li></ol><h1 id="3326" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">体系结构</h1><p id="00ae" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">为了方便起见，示例代码被部署到Kubernetes集群，但是也可以直接部署到虚拟机。如果您对部署到Android移动客户端感兴趣，那么您可能想要查看OpenCensus Java API。架构图如下所示。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/8c6fa74dc86318a7d07bc598fe5f01bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yPpqYs0QQWJRMnQSu0TjYA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated"><strong class="bd jg">图:探头架构</strong></figcaption></figure><h1 id="871f" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">代码走查</h1><p id="b912" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">代码基于OpenCensus Github项目中的<a class="ae jd" href="https://github.com/census-instrumentation/opencensus-go/tree/master/examples/http" rel="noopener ugc nofollow" target="_blank">示例</a> net/http服务器和客户端。首先，注册一个Stackdriver导出程序:</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="e27e" class="lq jf hi lm b fi lr ls l lt lu">prefix := "http-probe"<br/>se, err := stackdriver.NewExporter(stackdriver.Options{<br/>  MetricPrefix: prefix,<br/>})<br/>view.RegisterExporter(se)<br/>view.SetReportingPeriod(10 * time.Second)</span></pre><p id="5446" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里定义的前缀将在以后构建Stackdriver仪表板时使用。OpenCensus HTTP传输为主机、路径和其他参数提供标签。请注意SetReportingPeriod()调用，这是一个控制指标聚合的函数。OpenCensus HTTP传输包含许多标签，如主机和路径。该代码还定义了一个自定义标签来表示代码部署到的区域。</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="d916" class="lq jf hi lm b fi lr ls l lt lu">zoneKey, err = tag.NewKey("zone")</span></pre><p id="1b89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是因为地理位置对于我们理解延迟非常重要，因为路由距离会随着地理位置的变化而变化。</p><p id="1d8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个使用OpenCensus HTTP传输的HTTP客户端客户端:</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="f8cc" class="lq jf hi lm b fi lr ls l lt lu">client := &amp;http.Client{Transport: &amp;ochttp.Transport{}}</span></pre><p id="8fb1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后使用本地Go代码进行HTTP调用。注意，不需要计时语句，因为OpenCensus HTTP传输内置了计时。与带有定制指标的<a class="ae jd" href="https://cloud.google.com/monitoring/custom-metrics/creating-metrics#monitoring_create_metric-go" rel="noopener ugc nofollow" target="_blank">stack driver API相比，这是一个优势</a>，有助于保持您的产品代码整洁。</p><h1 id="0754" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">运行代码</h1><p id="57ab" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">按照自述文件中的说明构建代码并创建Docker容器。提供了命令和docker文件以及代码。Stackdriver的设置说明也包含在Gist README中。编辑config.yaml文件以添加您希望监控的URL。在命令行上，将ZONE环境变量的值设置为要将第一个探测器部署到的区域。然后创建Kubernetes集群。举个例子，</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="8bd0" class="lq jf hi lm b fi lr ls l lt lu">ZONE=us-west1<br/>CLUSTER_NAME=probes-$ZONE<br/>gcloud container clusters create $CLUSTER_NAME \<br/> — zone $ZONE \<br/> — num-nodes 1 \<br/> — enable-cloud-logging</span></pre><p id="6640" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后将探测器作为工作负载部署到集群。对其他区域重复此操作，以建立一个探针网络。</p><h1 id="e575" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">查看数据</h1><p id="5804" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">如果我们使用探针代码中定义的前缀“http-probe”来创建一个组，将有助于创建一个漂亮的仪表板。下面显示了一个截图。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lv"><img src="../Images/081ed287613111dbcced9bad1203288d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*L-z1843T_x8E9JrG"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated"><strong class="bd jg">图:用探针的前缀</strong>定义一个Stackdriver组</figcaption></figure><p id="3d3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，创建一个仪表板来查看结果。下面显示了从探头收集的数据的屏幕截图。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lw"><img src="../Images/e6185ba155b6b8896875e6e39888c846.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uRoO6mSkd3pyH7hd"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated"><strong class="bd jg">图:OpenCensus导出的Stats数据的Stackdriver监控图</strong></figcaption></figure></div></div>    
</body>
</html>