<html>
<head>
<title>GCP: Nested Virtualization on Centos8</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP:centos 8上的嵌套虚拟化</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/nested-virtualization-can-you-run-a-vm-inside-another-vm-c969afe0738f?source=collection_archive---------1-----------------------#2020-09-30">https://medium.com/google-cloud/nested-virtualization-can-you-run-a-vm-inside-another-vm-c969afe0738f?source=collection_archive---------1-----------------------#2020-09-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c9a897e69284f5aba93d04cfe4372964.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N-JpifdK3oKdaGeQBjJEUw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><em class="iu">图片由</em> <a class="ae iv" href="https://cloud.google.com/compute/images/nested-virtualization-diagram.svg" rel="noopener ugc nofollow" target="_blank"> <em class="iu">谷歌</em> </a>提供</figcaption></figure><blockquote class="iw"><p id="1c7f" class="ix iy hi bd iz ja jb jc jd je jf jg dx translated">我可以在虚拟机中运行虚拟机吗？</p></blockquote><p id="e71e" class="pw-post-body-paragraph jh ji hi jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd jg hb bi translated">这个更哲学的问题已经成为许多争论的主题。然而事实证明，这样做是完全可能的。事实上，如果你在谷歌上搜索，实际上有一个术语来描述它— <strong class="jj hj">嵌套虚拟化</strong>。</p><p id="f607" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">这听起来有点像《盗梦空间》(电影)，但就虚拟化而言，这确实是一种不可避免的邪恶。随着当前云计算的发展，运行裸机实例变得越来越不重要。</p><p id="60e5" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">然而，小众场景仍然存在，它们继续需要支持虚拟化的环境，即使是在云环境中。一个典型的例子是，如果您尝试使用GCP来设置混合云环境。</p><p id="1ae8" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">现在，GCP在这方面有一系列选项，其中大部分都是特定于场景的，但对于已经预构建并且依赖KVM的工作负载，您需要跨越一系列障碍才能将它们迁移到云。</p><p id="c933" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">仔细想想，有时甚至不值得这么麻烦，因为这种需求可能只是暂时的，也许只是为了短暂的故障转移。因此，嵌套虚拟机允许您将实例从本地迁移到云中，反之亦然。</p><p id="6982" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">还有许多其他利基场景。事实上，既然你在这里，你可能正在处理其中的一个。</p><p id="69b4" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">因此，让我们来看一下如何启动和运行嵌套的虚拟机。</p><h1 id="96c2" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated"><strong class="ak">先决条件</strong></h1><p id="1a54" class="pw-post-body-paragraph jh ji hi jj b jk lh jm jn jo li jq jr js lj ju jv jw lk jy jz ka ll kc kd jg hb bi translated">1.在<a class="ae iv" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云平台控制台</a>中创建一个项目。<br/> 2。为您的项目启用计费。<br/> 3。设置<a class="ae iv" href="https://cloud.google.com/compute/docs/gcloud-compute#set_default_zone_and_region_in_your_local_client" rel="noopener ugc nofollow" target="_blank">区域和地区详情</a></p><h1 id="d26c" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated"><strong class="ak">入门</strong></h1><p id="7634" class="pw-post-body-paragraph jh ji hi jj b jk lh jm jn jo li jq jr js lj ju jv jw lk jy jz ka ll kc kd jg hb bi translated">1.首先创建一个标准的VM实例。请记住，我们将使用这个实例来构建引导映像，因此您可能希望将配置与您想要的最终结果相匹配。在我的例子中，我希望以一个带有<code class="du lm ln lo lp b">2CPU and 8GB memory</code>的嵌套VM结束。如果你愿意，你可以把这个换一下。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="d586" class="ly kk hi lp b fi lz ma l mb mc">gcloud compute instances create testing-nesting --zone=us-central1-a --machine-type=n2-standard-2 --image=centos-8-v20200910 --image-project=centos-cloud --boot-disk-size=20GB --boot-disk-type=pd-standard --boot-disk-device-name=testing-nesting</span></pre><p id="c7ba" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">您可以进入虚拟机，通过运行该命令查看嵌套虚拟化是否启用。零响应确认其未启用。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="0714" class="ly kk hi lp b fi lz ma l mb mc">grep -cw vmx /proc/cpuinfo</span></pre><p id="6609" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">2.关闭虚拟机实例。</p><p id="40d2" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">3.基于刚刚为虚拟机实例创建的磁盘，创建一个自定义映像。请注意，下面的命令使用您创建的磁盘作为源磁盘。您也可以使用您已经创建的任何其他磁盘。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="a33a" class="ly kk hi lp b fi lz ma l mb mc">gcloud compute images create test-nesting-image --source-disk testing-nesting --source-disk-zone us-central1-a --licenses "https://www.googleapis.com/compute/v1/projects/vm-options/global/licenses/enable-vmx"</span></pre><p id="df43" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">这个新图像现在应该出现在您的图像列表中，您可以通过检查<a class="ae iv" href="https://console.cloud.google.com/compute/images" rel="noopener ugc nofollow" target="_blank">计算机图像列表</a>来确认。</p><p id="733f" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">现在，您的映像已经准备好了，您可以创建嵌套的VM实例了。</p><p id="e36e" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">如果您使用控制台GUI来构建新的实例，那么应该可以在Custom Images下找到新的映像。</p><figure class="lq lr ls lt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/08f612baf74fd954d32f9db97b016d98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nnIOBF6M3QCaSoaFKzF0uw.png"/></div></div></figure><p id="dd03" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">在命令行上，您的<code class="du lm ln lo lp b">gcloud</code>命令看起来像这样</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="1763" class="ly kk hi lp b fi lz ma l mb mc">gcloud compute instances create testing-nested-vm --zone=us-central1-a --machine-type=n2-standard-2 --image=test-nesting-image --boot-disk-size=20GB --boot-disk-type=pd-standard --boot-disk-device-name=new-nested-disk</span></pre><p id="05b4" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">一旦您的虚拟机实例启动，登录并检查嵌套虚拟化是否已启用。非零响应意味着它已被启用。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="f0f9" class="ly kk hi lp b fi lz ma l mb mc">grep -cw vmx /proc/cpuinfo</span></pre><p id="89f4" class="pw-post-body-paragraph jh ji hi jj b jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka ki kc kd jg hb bi translated">通过这些简单的步骤，您现在有了一个可以工作的嵌套实例，此时您甚至可以继续为您的工作负载设置虚拟机管理程序。</p></div></div>    
</body>
</html>