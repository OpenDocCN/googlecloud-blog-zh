<html>
<head>
<title>Announcing google-cloud-bigquery Version 1.17.0: Query Results to DataFrame 31x Faster with Apache Arrow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">宣布google-cloud-bigquery版本1.17.0:使用Apache Arrow将数据帧的查询结果提高31倍</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/announcing-google-cloud-bigquery-version-1-17-0-1fc428512171?source=collection_archive---------1-----------------------#2019-07-29">https://medium.com/google-cloud/announcing-google-cloud-bigquery-version-1-17-0-1fc428512171?source=collection_archive---------1-----------------------#2019-07-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="6b24" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="a20c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">升级到最新的<code class="du kb kc kd ke b">google-cloud-bigquery</code>和<code class="du kb kc kd ke b">google-cloud-bigquery-storage packages</code>，将查询结果下载到数据帧的速度比版本1.16.0的相同方法快4.5倍。如果您还没有使用BigQuery存储API，那么使用它下载查询结果的速度比BigQuery API快15倍。(31次，如果你不介意使用默认的箭头来熊猫转换。)</p><p id="efc1" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo kh jq jr js ki ju jv jw kj jy jz ka hb bi translated">这种加速也适用于<code class="du kb kc kd ke b">pandas-gbq</code>图书馆。更新，<code class="du kb kc kd ke b">google-cloud-bigquery</code>和<code class="du kb kc kd ke b">google-cloud-bigquery-storage</code>打包安装<code class="du kb kc kd ke b">pyarrow</code>，并将<code class="du kb kc kd ke b">use_bqstorage_api</code>参数设置为<code class="du kb kc kd ke b">True</code>。</p><h1 id="54db" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">代码示例</h1><p id="14bc" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">要使用更快的方法下载大型结果，请使用Python程序或笔记本中的BigQuery存储API。</p><h1 id="398b" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">开始之前</h1><ul class=""><li id="9b0a" class="kk kl hi jf b jg jh jk jl jo km js kn jw ko ka kp kq kr ks bi translated">启用BigQuery存储API:<a class="ae kt" href="https://console.cloud.google.com/apis/library/bigquerystorage.googleapis.com" rel="noopener ugc nofollow" target="_blank">https://console . cloud . Google . com/APIs/library/bigquerystorage . Google APIs . com</a></li><li id="1dfa" class="kk kl hi jf b jg ku jk kv jo kw js kx jw ky ka kp kq kr ks bi translated">安装所需Python包的最新版本(包括依赖项)。</li><li id="c4b1" class="kk kl hi jf b jg ku jk kv jo kw js kx jw ky ka kp kq kr ks bi translated">conda的步骤:</li></ul><pre class="kz la lb lc fd ld ke le lf aw lg bi"><span id="0175" class="lh ig hi ke b fi li lj l lk ll">conda install --channel conda-forge 'google-cloud-bigquery&gt;=1.17.0' \<br/>  'google-cloud-bigquery-storage&gt;=0.7.0' \<br/>  'pandas-gbq&gt;=0.10.0'</span></pre><ul class=""><li id="5502" class="kk kl hi jf b jg kf jk kg jo lm js ln jw lo ka kp kq kr ks bi translated">pip的步骤:</li></ul><pre class="kz la lb lc fd ld ke le lf aw lg bi"><span id="337b" class="lh ig hi ke b fi li lj l lk ll">pip install --upgrade google-cloud-bigquery<br/>pip install --upgrade google-cloud-bigquery-storage<br/>pip install --upgrade pyarrow<br/>pip install --upgrade google-cloud-core<br/>pip install --upgrade google-api-core[grpcio]</span></pre><p id="67d0" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo kh jq jr js ki ju jv jw kj jy jz ka hb bi translated">从笔记本环境，步骤是相同的，只是预先考虑！呼唤贝壳。例如:</p><pre class="kz la lb lc fd ld ke le lf aw lg bi"><span id="1855" class="lh ig hi ke b fi li lj l lk ll">!pip install --upgrade google-cloud-bigquery</span></pre><h1 id="5049" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">使用熊猫-gbq</h1><pre class="kz la lb lc fd ld ke le lf aw lg bi"><span id="8823" class="lh ig hi ke b fi li lj l lk ll">import pandas_gbq</span><span id="94be" class="lh ig hi ke b fi lp lj l lk ll">sql = "SELECT * FROM `bigquery-public-data.irs_990.irs_990_2012`"</span><span id="b1b9" class="lh ig hi ke b fi lp lj l lk ll"># Use the BigQuery Storage API to download results more quickly.<br/>df = pandas_gbq.read_gbq(sql, use_bqstorage_api=True)</span></pre><h1 id="7de4" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">使用BigQuery客户端库</h1><pre class="kz la lb lc fd ld ke le lf aw lg bi"><span id="32ce" class="lh ig hi ke b fi li lj l lk ll">import google.auth<br/>from google.cloud import bigquery<br/>from google.cloud import bigquery_storage_v1beta1</span><span id="8138" class="lh ig hi ke b fi lp lj l lk ll"># Create a BigQuery client and a BigQuery Storage API client with the same<br/># credentials to avoid authenticating twice.<br/>credentials, project_id = google.auth.default(<br/>    scopes=["https://www.googleapis.com/auth/cloud-platform"]<br/>)<br/>client = bigquery.Client(credentials=credentials, project=project_id)<br/>bqstorage_client = bigquery_storage_v1beta1.BigQueryStorageClient(<br/>    credentials=credentials<br/>)<br/>sql = "SELECT * FROM `bigquery-public-data.irs_990.irs_990_2012`"</span><span id="9ad4" class="lh ig hi ke b fi lp lj l lk ll"># Use a BigQuery Storage API client to download results more quickly.<br/>df = client.query(sql).to_dataframe(bqstorage_client=bqstorage_client)</span></pre><h1 id="6cea" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">下一步是什么</h1><ul class=""><li id="1451" class="kk kl hi jf b jg jh jk jl jo km js kn jw ko ka kp kq kr ks bi translated">阅读<a class="ae kt" href="https://cloud.google.com/bigquery/docs/reference/storage/" rel="noopener ugc nofollow" target="_blank"> BigQuery存储API参考文档</a>。</li><li id="043c" class="kk kl hi jf b jg ku jk kv jo kw js kx jw ky ka kp kq kr ks bi translated">阅读<a class="ae kt" href="https://cloud.google.com/bigquery/docs/bigquery-storage-python-pandas" rel="noopener ugc nofollow" target="_blank">官方指南，了解如何将BigQuery存储API用于pandas </a>。</li></ul><h1 id="c8dc" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">新功能</h1><p id="c9de" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">除了更快的性能，<code class="du kb kc kd ke b">google-cloud-bigquery</code>包版本1.17.0增加了一个<code class="du kb kc kd ke b"><a class="ae kt" href="https://googleapis.github.io/google-cloud-python/latest/bigquery/generated/google.cloud.bigquery.table.RowIterator.html#google.cloud.bigquery.table.RowIterator.to_arrow" rel="noopener ugc nofollow" target="_blank">RowIterator.to_arrow()</a></code>方法来下载一个表或查询结果作为一个<code class="du kb kc kd ke b"><a class="ae kt" href="https://arrow.apache.org/docs/python/generated/pyarrow.Table.html" rel="noopener ugc nofollow" target="_blank">pyarrow.Table</a></code>对象。</p><p id="bec2" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo kh jq jr js ki ju jv jw kj jy jz ka hb bi translated">Arrow为内存中面向列的数据提供了一个跨语言的标准，其中包含一组丰富的数据类型。用这种方法可以很快地从箭头表创建熊猫数据帧。有了<a class="ae kt" href="https://fletcher.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> fletcher库</a>，Arrow表可以直接用作pandas扩展数组的后台数据结构。</p><h1 id="a32a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">更好的性能</h1><p id="052a" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们通过对<a class="ae kt" href="https://pantheon.corp.google.com/marketplace/details/city-of-new-york/nyc-tlc-trips" rel="noopener ugc nofollow" target="_blank">BigQuery-public-data . new _ York _ taxi _ trips . TLC _ green _ trips _ *</a>表进行采样，测试了将big query表数据下载到pandas DataFrame和Arrow表的性能。</p><p id="0e89" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo kh jq jr js ki ju jv jw kj jy jz ka hb bi translated">然后，我们计算了从谷歌计算引擎n1-standard-8 (8个vCPUs，30 GB内存)机器上下载这些数据到熊猫数据帧所用的时间。我们使用了以下方法:</p><ul class=""><li id="25ce" class="kk kl hi jf b jg kf jk kg jo lm js ln jw lo ka kp kq kr ks bi translated">答:<code class="du kb kc kd ke b">to_dataframe()</code>——使用BigQuery tabledata.list API。</li><li id="1794" class="kk kl hi jf b jg ku jk kv jo kw js kx jw ky ka kp kq kr ks bi translated">B: <code class="du kb kc kd ke b">to_dataframe(bqstorage_client=bqstorage_client)</code>，包版本1 . 16 . 0——使用Avro数据格式的BigQuery存储API。</li><li id="a751" class="kk kl hi jf b jg ku jk kv jo kw js kx jw ky ka kp kq kr ks bi translated">C: <code class="du kb kc kd ke b">to_dataframe(bqstorage_client=bqstorage_client)</code>，包版本1 . 17 . 0——使用带有箭头数据格式的BigQuery存储API。</li><li id="54bf" class="kk kl hi jf b jg ku jk kv jo kw js kx jw ky ka kp kq kr ks bi translated">D: <code class="du kb kc kd ke b">to_arrow(bqstorage_client=bqstorage_client).to_pandas()</code>，包版本1 . 17 . 0——使用带箭头数据格式的BigQuery存储API。</li></ul><figure class="kz la lb lc fd lr er es paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="er es lq"><img src="../Images/5028ab077a5ebfadcdb03d21e5096865.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DyY2gPYWyJBzMipS.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx translated">Pandas跨表大小的性能大查询。(值越低越好)</figcaption></figure><p id="f297" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo kh jq jr js ki ju jv jw kj jy jz ka hb bi translated">在不同的数据大小下，加速是相当稳定的。与BigQuery tabledata.list API相比，使用Avro数据格式的BigQuery存储API的速度提高了约3.5倍。使用箭头数据格式的<code class="du kb kc kd ke b">to_dataframe()</code>方法可以获得大约15倍的加速，使用<code class="du kb kc kd ke b">to_arrow()</code>方法可以获得31倍的加速，然后是使用BigQuery存储API的<code class="du kb kc kd ke b">to_pandas()</code>。</p><figure class="kz la lb lc fd lr er es paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="er es mc"><img src="../Images/286293e4651f4a77a6f0e58810b20919.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Vd-yc8tZUNzlxvsK.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx translated">与原始的tabledata.list API相比，Pandas的BigQuery得到了加速。(数值越高越好)</figcaption></figure><p id="6f67" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo kh jq jr js ki ju jv jw kj jy jz ka hb bi translated">总之，从BigQuery获得熊猫数据帧的最快方法是调用<code class="du kb kc kd ke b">RowIterator.to_arrow(bqstorage_client=bqstorage_client).to_pandas()</code>。这种差异的原因是<code class="du kb kc kd ke b">to_dataframe()</code>将每个消息转换成一个数据帧，然后在最后将它们连接成一个数据帧。而<code class="du kb kc kd ke b">to_arrow()</code>将每条消息转换成一个记录批，并在最后创建一个表。时间差可能是因为<code class="du kb kc kd ke b">pandas.concat(dfs)</code>可以复制，而<code class="du kb kc kd ke b">pyarrow.Table.from_batches()</code>不能复制。还有，<code class="du kb kc kd ke b">pyarrow.Table.to_pandas()</code>往往是零抄。</p><h1 id="2c6f" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">限制</h1><p id="62ee" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这个BigQuery存储API没有空闲层，并且不包含在BigQuery沙箱中。由于这些限制，您需要有一个计费帐户才能使用这个API。详见<a class="ae kt" href="https://cloud.google.com/bigquery/pricing#storage-api" rel="noopener ugc nofollow" target="_blank"> BigQuery存储API定价页面</a>。</p><p id="b9c1" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo kh jq jr js ki ju jv jw kj jy jz ka hb bi translated">BigQuery存储API还不能读取小型匿名查询结果表。</p><p id="4e4a" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo kh jq jr js ki ju jv jw kj jy jz ka hb bi translated">对重新排序投影列的能力和行过滤器谓词的复杂性有一些限制。目前，使用Apache Avro序列化数据时的过滤支持比使用Apache Arrow时更成熟。</p><p id="a336" class="pw-post-body-paragraph jd je hi jf b jg kf ji jj jk kg jm jn jo kh jq jr js ki ju jv jw kj jy jz ka hb bi translated"><em class="md">原载于2019年7月29日</em><a class="ae kt" href="https://friendliness.dev/2019/07/29/bigquery-arrow/" rel="noopener ugc nofollow" target="_blank"><em class="md">https://friendness . dev</em></a><em class="md">。</em></p></div></div>    
</body>
</html>