<html>
<head>
<title>Calling a private Google Cloud Function from on-prem</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从内部调用私有Google云功能</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/calling-a-private-google-cloud-function-from-on-prem-91eb628c85ac?source=collection_archive---------0-----------------------#2021-07-20">https://medium.com/google-cloud/calling-a-private-google-cloud-function-from-on-prem-91eb628c85ac?source=collection_archive---------0-----------------------#2021-07-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f61e026aafe392ce739e1496b63ea25f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5ECUZ7XHIspSMtTzTo-_iQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">通过私有服务连接端点实现私有云功能</figcaption></figure><p id="bd57" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">许多企业客户来到<a class="ae js" href="https://cloud.google.com/consulting" rel="noopener ugc nofollow" target="_blank">Google Cloud Professional Services</a>，询问他们如何以私人方式从本地服务器调用Google Cloud功能，而不将其暴露在互联网上。</p><p id="4803" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">出于安全原因，他们不想为其云功能提供公共端点(即使可能需要身份验证)，但要求网络流量保持在客户的本地和GCP专用网络上。</p><p id="d559" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在创建新的云功能时，您可以将连接入口设置为仅允许内部流量，但如果我们仔细阅读<a class="ae js" href="https://cloud.google.com/functions/docs/networking/network-settings#ingress_settings" rel="noopener ugc nofollow" target="_blank">文档页面</a>，它说:“<em class="jt">仅允许来自同一项目中的VPC网络或</em> <a class="ae js" href="https://cloud.google.com/vpc-service-controls/docs/service-perimeters" rel="noopener ugc nofollow" target="_blank"> <em class="jt"> VPC服务控制周界</em> </a> <em class="jt">的请求。所有其他请求因出现</em> <code class="du ju jv jw jx b"><em class="jt">403</em></code> <em class="jt">错误而被拒绝。</em>“这意味着我们仍然不能从一个项目中调用我们的函数，这个项目不是我们部署函数的项目。</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jy"><img src="../Images/82bd92270a1053dcdbcea340ff885960.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*QAC4Lp7yjmS7X2NbWWHPOQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">创建云功能时的入口设置</figcaption></figure><h1 id="60d4" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">私人服务连接到救援</h1><p id="f34e" class="pw-post-body-paragraph iu iv hi iw b ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn lf jp jq jr hb bi translated"><a class="ae js" href="https://cloud.google.com/vpc/docs/private-service-connect#benefits-apis" rel="noopener ugc nofollow" target="_blank">Private Service Connect</a>(PSC)允许您通过在包含云功能的项目的VPC网络中创建的端点来访问Google云服务。</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div class="er es lg"><img src="../Images/6e01cc858c6ff9a4c77252623862d247.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/format:webp/1*6ZQY0yrS8raNPJtUbZkaGA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">用于访问Google服务的私有服务连接端点</figcaption></figure><p id="0917" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您可以将请求发送到这个私有服务连接端点的内部IP地址，而不是将API请求发送到服务端点的公共可用IP地址，例如<strong class="iw hj">storage.googleapis.com</strong>。流经此端点的所有调用将表现为好像它们是从同一个项目中发出的。</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lh"><img src="../Images/a446e324fe08d99ed0ab2f83320db7fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IqcGfFtoqKtjSotib8NjGw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Google云控制台中的私有服务连接配置</figcaption></figure><p id="6ef3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">请注意，这个端点将允许您访问任何Google服务，因此您应该设置防火墙规则，禁止那些不应该访问的主机的这种行为。</p><h1 id="e188" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">使用一些DNS和路由完成设计</h1><p id="a086" class="pw-post-body-paragraph iu iv hi iw b ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn lf jp jq jr hb bi translated">既然私有服务连接端点已经准备好接受请求，那么您必须以某种方式将所有云函数调用请求从本地发送到这个IP地址。</p><p id="879c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">要做到这一点，您必须配置本地DNS，使您的特定项目对云功能子域的每个调用最终都解析到您刚刚创建的端点。</p><p id="f418" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您创建的每个HTTP云函数(即使是私有的)都会有一个URL，格式为<strong class="iw hj">https://<em class="jt">YOUR _ REGION</em>-<em class="jt">YOUR _ PROJECT _ ID</em>. Cloud functions . net/<em class="jt">Function _ NAME</em></strong>。<br/>这意味着您必须在本地DNS中创建一个条目来翻译<strong class="iw hj">YOUR _ REGION-YOUR _ PROJECT _ id . cloud functions . net</strong>子域以指向私有服务连接端点。</p><p id="21ab" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">剩下唯一要做的事情就是将流量路由到私有服务连接端点。通常，内部环境将通过<a class="ae js" href="https://cloud.google.com/network-connectivity/docs/vpn/concepts/overview#ha-vpn" rel="noopener ugc nofollow" target="_blank"> HA VPN </a>或<a class="ae js" href="https://cloud.google.com/network-connectivity/docs/interconnect/concepts/overview" rel="noopener ugc nofollow" target="_blank">云互联</a>连接到谷歌云。这些连接方法涉及使用云路由器在Google Cloud和您的本地环境之间建立BGP会话。利用这个BGP会话，我们可以向本地公布私有服务连接端点的IP地址。</p><h1 id="f9de" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">给我看看代码！</h1><p id="59f6" class="pw-post-body-paragraph iu iv hi iw b ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn lf jp jq jr hb bi translated">因为一个例子胜过千言万语，所以我做了一个Terraform演示，可以用来模拟我刚才描述的场景。你可以在GitHub上找到这个库:<a class="ae js" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric/tree/master/examples/networking/private-cloud-function-from-onprem" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/Google cloud platform/cloud-foundation-fabric/tree/master/examples/networking/private-cloud-function-from-on prem</a></p><h1 id="58fe" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">总结</h1><p id="8d42" class="pw-post-body-paragraph iu iv hi iw b ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn lf jp jq jr hb bi translated">在这篇文章中，我们看到了如何在你的私有网络中的任何地方调用一个私有的Google Cloud函数。</p><ul class=""><li id="e332" class="li lj hi iw b ix iy jb jc jf lk jj ll jn lm jr ln lo lp lq bi translated">私有云功能只能由同一Google Cloud项目中的资源调用。</li><li id="f5eb" class="li lj hi iw b ix lr jb ls jf lt jj lu jn lv jr ln lo lp lq bi translated">Private Service Connect是一种通过私有端点访问Google云服务的便捷方式，我们可以利用它来调用私有云功能。</li><li id="8788" class="li lj hi iw b ix lr jb ls jf lt jj lu jn lv jr ln lo lp lq bi translated">DNS和路由是任何网络架构的基础，我们利用它们将流量从本地路由到私有服务连接端点。</li></ul></div></div>    
</body>
</html>