<html>
<head>
<title>Backporting the latest Google Cloud operators in Apache Airflow and Cloud Composer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Apache Airflow和Cloud Composer中支持最新的Google Cloud operators</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/backporting-google-cloud-operators-in-apache-airflow-34b6c9efffc8?source=collection_archive---------1-----------------------#2020-11-20">https://medium.com/google-cloud/backporting-google-cloud-operators-in-apache-airflow-34b6c9efffc8?source=collection_archive---------1-----------------------#2020-11-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a16f446fe905103eb9a35cfde33c77d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Dj582MsBNhLfIrg2"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">劳尔·卡乔·奥斯在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="21ca" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Apache Airflow的Google Cloud operators提供了一种从DAG连接到BigQuery、Dataflow、Dataproc等服务的便捷方式。如果您没有使用最新的Airflow版本，您可能会被一组没有提供最新功能的操作符所困扰。</p><p id="e0f2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">随着云服务的快速发展，这可能会成为一个问题，阻止您在数据管道中利用最新的谷歌云功能。在这篇文章中，我们展示了如何反向移植最新版本的谷歌云操作器，重点是<a class="ae iu" href="https://cloud.google.com/composer" rel="noopener ugc nofollow" target="_blank"> Cloud Composer </a>(谷歌云的Apache Airflow管理版本)，这样你就可以使用它们，而不必被迫升级你的Airflow版本。</p><p id="b6dc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于这篇文章，我们假设你使用的是Airflow 1.10.6。使用Cloud Composer的最新可用版本是1.10.10 。因此，在本例中，系统中默认可用的Google Cloud操作符是Airflow 1.10.6中附带的操作符。</p><p id="c099" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，最新版本的<code class="du jt ju jv jw b">DataprocSubmitJobOperator</code>有一个额外的选项，如果Airflow web UI重新启动，这个选项会很方便。您可以重新附加到现有作业或再次启动它(参见<a class="ae iu" href="https://issues.apache.org/jira/browse/AIRFLOW-3211" rel="noopener ugc nofollow" target="_blank"> AIRFLOW-3211 </a>)。</p><p id="578f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您在旧版本的Airflow中，并且想要使用该行为，该怎么办？<strong class="ix hj">如何更新Composer以将这些操作员引入我当前的环境？</strong></p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><p id="2c93" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你不必更新你现有的气流版本。您可以将最新版本的Google Cloud operators应用到部署在Composer实例中的Airflow版本，而无需任何停机时间或集群升级过程。此处显示的程序适用于气流1.10。*并且将允许您从气流2中带任何操作员。*适应您现有的气流。<a class="ae iu" href="https://airflow.readthedocs.io/en/latest/backport-providers.html" rel="noopener ugc nofollow" target="_blank">气流文件</a>中给出了这些背端口组件的全部细节。</p><p id="eece" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设您的Composer实例名为<code class="du jt ju jv jw b">&lt;COMPOSER_INSTANCE&gt;</code>，位于区域<code class="du jt ju jv jw b">&lt;COMPOSER_REGION&gt;</code>，并且您拥有更新该实例的权限，要在Cloud Composer中安装一个backport包，只需运行:</p><pre class="ke kf kg kh fd ki jw kj kk aw kl bi"><span id="f4df" class="km kn hi jw b fi ko kp l kq kr">gcloud composer environments update --location=&lt;COMPOSER_REGION&gt;       --update-pypi-package=apache-airflow-backport-providers-google &lt;COMPOSER_INSTANCE&gt;</span></pre><p id="6341" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更新将需要几分钟时间。此后，任何新的DAG运行都将有新的操作符可用。</p><p id="a3df" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">如何检查更新是否成功？</strong></p><p id="86ce" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更新之后，您可能会想，更新真的成功了吗？您需要<a class="ae iu" href="https://cloud.google.com/composer/docs/how-to/using/installing-python-dependencies#viewing_installed_python_packages" rel="noopener ugc nofollow" target="_blank">连接到worker并检查已安装的Python依赖项</a>。一旦你创建了必要的<code class="du jt ju jv jw b">kubectl </code>配置，找出一个气流工人舱的名字。首先，检查气流工作者运行的名称空间，用</p><pre class="ke kf kg kh fd ki jw kj kk aw kl bi"><span id="2159" class="km kn hi jw b fi ko kp l kq kr">kubectl get namespaces</span></pre><p id="5158" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您将得到与此类似的输出(在<strong class="ix hj">粗体</strong>中，Airflow worker pods运行的名称空间):</p><pre class="ke kf kg kh fd ki jw kj kk aw kl bi"><span id="0bf5" class="km kn hi jw b fi ko kp l kq kr">NAME                                      STATUS AGE<br/><strong class="jw hj">composer-1–10–4-airflow-1–10–6-f15cbe22</strong>   Active 160d<br/>default                                   Active 160d<br/>kube-node-lease                           Active 160d<br/>kube-public                               Active 160d<br/>kube-system                               Active 160d</span></pre><p id="231d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在让我们获取该名称空间中的pod名称(根据您的名称空间更改<em class="ks">composer-1–10–4-air flow-1–10–6-f15 CBE 22</em>)。</p><pre class="ke kf kg kh fd ki jw kj kk aw kl bi"><span id="6ed0" class="km kn hi jw b fi ko kp l kq kr">kubectl -n composer-1–10–4-airflow-1–10–6-f15cbe22 get pods</span></pre><p id="11dc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您将得到如下列表。我们需要记下其中一个worker pod名称:</p><pre class="ke kf kg kh fd ki jw kj kk aw kl bi"><span id="889b" class="km kn hi jw b fi ko kp l kq kr"><br/>NAME                                 READY STATUS  RESTARTS AGE<br/>airflow-scheduler-6b5cff877f-j9l4t   2/2   Running 0        27m <br/>airflow-worker-d977fffc4–6l9vb       2/2   Running 0        25s<br/>airflow-worker-d977fffc4-kktz2       2/2   Running 0        27s</span></pre><p id="af0b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们可以连接到一个工人:</p><pre class="ke kf kg kh fd ki jw kj kk aw kl bi"><span id="4a95" class="km kn hi jw b fi ko kp l kq kr">kubectl exec -itn &lt;COMPOSER_NAMESPACE&gt; &lt;WORKER_NAME&gt; --/bin/bash</span></pre><p id="c119" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">其中<code class="du jt ju jv jw b">&lt;WORKER_NAME&gt;</code>可以是上面列表中的<em class="ks">air flow-worker-d 977 fffc 4–6l9vb</em>或<em class="ks">air flow-worker-d 977 fffc 4-KKT z2</em>，在本例中<code class="du jt ju jv jw b">&lt;COMPOSER_NAMESPACE&gt;</code>是<em class="ks">composer-1–10–4-air flow-1–10–6-f15 CBE 22</em>。</p><p id="da90" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，您可以检查我们刚刚安装的新依赖项:</p><pre class="ke kf kg kh fd ki jw kj kk aw kl bi"><span id="973a" class="km kn hi jw b fi ko kp l kq kr">pip freeze | grep airflow-backport</span></pre><p id="d1dd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您应该得到与下面类似的输出(可能是更新的版本，这取决于您何时运行该命令):</p><p id="702e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="ks">Apache-air flow-backport-providers-Google = = 2020 . 11 . 13</em></p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><p id="66c5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Cloud Composer为Apache气流提供托管服务。当您创建Composer实例时，您将被固定到特定的Airflow版本，除非您对整个集群进行升级。但是，为了享受最新版本的Google Cloud操作符，您不需要更新Airflow版本:您可以将最新的操作符从Airflow 2.x反向移植到任何使用Airflow 1.10.x的Composer实例。</p></div></div>    
</body>
</html>