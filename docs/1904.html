<html>
<head>
<title>Monitoring SQL Scripts with BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用BigQuery监控SQL脚本</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/monitoring-sql-scripts-with-bigquery-a26102628256?source=collection_archive---------0-----------------------#2021-06-21">https://medium.com/google-cloud/monitoring-sql-scripts-with-bigquery-a26102628256?source=collection_archive---------0-----------------------#2021-06-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3263" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随着BigQuery 中的<a class="ae jd" href="https://cloud.google.com/blog/products/data-analytics/command-and-control-now-easier-in-bigquery-with-scripting-and-stored-procedures" rel="noopener ugc nofollow" target="_blank">脚本现在可用，有了新的方法来分析与脚本相关的作业事件。例如，您可以跟踪作业度量，如与脚本关联的数据操作语言(DML)查询所受影响的行数，以获得有关脚本执行情况的更多详细信息。</a></p><p id="2fb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">BigQuery日志的新版本，<a class="ae jd" href="https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata" rel="noopener ugc nofollow" target="_blank"> BigQueryAuditMetadata </a>，提供了对脚本执行的丰富见解。通过在BigQuery中结合云日志和脚本，您可以跳过手动记录作业事件数据，直接对其进行分析。这些数据可以让您深入了解脚本性能、数据修改等。</p><p id="e8ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章是关于如何通过以下步骤监控ELT BigQuery作业的分步指南:</p><ol class=""><li id="adfe" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">为BigQuery设置一个云日志接收器，它将导出BigQuery脚本事件。</li><li id="9139" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">运行预先编写的SQL视图，将导出的数据转换为可查询的字段。</li><li id="32f2" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">运行在视图顶部运行的查询，以分析导出的作业事件。</li></ol><p id="d58b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">跟踪DML语句的结果通常是通过在每个DML语句结束后读取系统变量，然后将它们的值写入单独的日志记录表来实现的。然而，这种方法并不总是最佳的。以下面的脚本为例:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/150ab158646d1b2ec6edd39ac35db91a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ue1WegNHLUwfcKCnmCIYcA.png"/></div></div></figure><p id="02d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以看到，您必须设置系统变量并编写一个日志调用来存储脚本中每个DML语句后的状态。如果您一天要运行数千个(如果不是更多的话)脚本，这会变得非常乏味。</p><p id="6ea8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了BigQuery，您不再需要记录SQL语句结果，因为云日志允许您存储、搜索、分析、监控和警告所有BigQuery脚本活动。</p><h1 id="aec0" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">1.提取和加载:导出云日志记录日志</h1><p id="e96b" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">您还可以使用INFORMATION_SCHEMA来获取作业元数据，但是保留期是180天。云日志中数据访问日志的保留期为30天。导出日志的好处是它们的保留时间比保留期更长。</p><h1 id="d774" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">创建云日志过滤器</h1><p id="6d53" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">首先，导航到日志浏览器和<a class="ae jd" href="https://cloud.google.com/logging/docs/view/advanced-queries#getting-started" rel="noopener ugc nofollow" target="_blank">切换到一个高级过滤器</a>。现在，您可以创建一个仅捕获BigQuery脚本事件的过滤器。</p><p id="d3fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我们将使用的过滤器——将<a class="ae jd" href="https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/views/audit#protopayloadmetadatatypetypegoogleapiscomgooglecloudauditbigqueryauditmetadata-and--protopayloadmetadatajobchangejobjobconfigqueryconfigstatementtypescript-and-protopayloadmetadatajobchangejobjobstatusjobstatedone--or--protopayloadmetadatajobchangejobjobstatsparentjobname-and-protopayloadmetadatajobchangejobjobstatusjobstatedone-or-protopayloadmetadatatabledatachangereason-or-protopayloadmetadatatabledatareadreason--or-protopayloadmetadatatabledeletionreason-" rel="noopener ugc nofollow" target="_blank">过滤器</a>粘贴到高级过滤器字段。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es lh"><img src="../Images/94e9e226ec0c73c659c6a8dbeb56526e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k1adjNKmx6COQEtTXEllJQ.png"/></div></div></figure><p id="bdf9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些都是什么意思？！</p><p id="df28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是该过滤器的这些组件的简要概述:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es li"><img src="../Images/d31591a888d83f078d58f4640a9f4ba0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KmiDaT69LkjZEDMAE0y4tw.png"/></div></div></figure><h1 id="f476" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">创建大查询接收器</h1><p id="6157" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">通过该筛选器，您可以使用BigQuery接收器为匹配该筛选器的作业事件设置一个目标。按照<a class="ae jd" href="https://cloud.google.com/logging/docs/export/configure_export_v2#dest-create" rel="noopener ugc nofollow" target="_blank">这个指南</a>来设置一个sink，并确保选择BigQuery作为sink服务。还强烈建议启用<a class="ae jd" href="https://cloud.google.com/bigquery/docs/partitioned-tables" rel="noopener ugc nofollow" target="_blank">分区</a>选项，因为它将根据事件的时间戳对您的数据进行分区，从而在您对导出的数据运行查询时提高查询性能。</p><p id="22fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>:每当创建或更新接收器过滤器时，在过滤器创建或更新之前由BigQuery事件生成的任何日志都不会被接收器捕获。只有在应用过滤器后生成的日志才会被捕获。</p><h1 id="6cea" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">创建您的BigQuery脚本</h1><p id="0f51" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">现在，您可以创建自己的BigQuery脚本了。一种方法是用BigQuery编写一个存储过程，如下例所示。</p><p id="d483" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">___________________________________________________________________</p><p id="dfcc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建或替换过程`<strong class="ih hj">project _ id . dataset _ id . script _ name</strong>`()</p><p id="1851" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">开始</p><p id="beae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">…</p><p id="829a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">结束；</p><p id="a9c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">___________________________________________________________________</p><p id="8b70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.执行脚本以生成作业事件数据</p><h1 id="ade9" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">在云壳中调用脚本</h1><p id="124b" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">执行示例脚本的一种方式是通过<a class="ae jd" href="https://cloud.google.com/shell/docs/using-cloud-shell" rel="noopener ugc nofollow" target="_blank">云外壳</a>中的<a class="ae jd" href="https://cloud.google.com/sdk/docs" rel="noopener ugc nofollow" target="_blank"> gcloud命令行</a>。</p><p id="5b4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦<strong class="ih hj">云外壳</strong>打开，创建一个SQL文件。打开文件，粘贴下面的行，并用在BigQuery中创建脚本的路径替换<strong class="ih hj">dataset _ name . script _ name</strong>。</p><p id="4d05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">调用<strong class="ih hj">dataset _ name . script _ name()</strong></p><p id="fd72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">保存并退出文件。现在，您可以通过执行该文件来执行脚本。将下面的命令复制并粘贴到云壳中。</p><p id="caf0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">bq查询— nouse_legacy_sql </p><p id="559f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是对标签的解释。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es lj"><img src="../Images/ae701494fc936f319b74805eb66a0985.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kFCCBX6nl1orcWFGMrNXlw.png"/></div></div></figure><p id="73c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您运行这个命令时，您会看到BigQuery接收器中填充了来自云日志记录的作业事件。</p><p id="dad1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转换:使用视图将作业事件数据解析为可查询的字段</p><h1 id="55e7" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">使用新视图查询您的职务数据</h1><p id="6f4a" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">现在BigQuery中有了日志数据，您可以更容易地查询这些日志。如果仔细观察表模式，可以看到日志是以JSON格式表示的。查询BigQueryAuditMetadata字段需要取消导出日志条目的嵌套。我们可以在BigQuery中使用<a class="ae jd" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/json_functions" rel="noopener ugc nofollow" target="_blank"> JSON函数</a>来实现这一点，但是这会变得很复杂。相反，这个视图——<a class="ae jd" href="https://github.com/GoogleCloudPlatform/bigquery-utils/blob/master/views/audit/bigquery_script_logs_v2.sql" rel="noopener ugc nofollow" target="_blank">bigquery _ script _ logs _ v2 . SQL</a>，它充当云日志记录和big query之间的接口——可以用来转换导出的日志数据，并允许您在视图之上编写简单的查询。按照<a class="ae jd" href="https://github.com/GoogleCloudPlatform/bigquery-utils/blob/master/views/audit/big_query_elt_script_logging.sql" rel="noopener ugc nofollow" target="_blank">这些说明</a>使用视图。</p><p id="6400" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了新版本的云日志和BigQuery支持的脚本，就有了监视脚本查询性能的新机会。像我们在这里所做的那样设置管道使您能够以更简单的方式查看脚本作业数据。</p><p id="77a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">接下来的步骤</strong></p><p id="a7e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然日志字段是可查询的，那么您可以在视图的顶部编写查询来获得对BigQuery脚本事件的洞察。首先，查看本自述文件<a class="ae jd" href="https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/views/audit" rel="noopener ugc nofollow" target="_blank">中的示例查询。</a></p><p id="46fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您甚至可以更进一步，使用诸如<a class="ae jd" href="https://datastudio.google.com/" rel="noopener ugc nofollow" target="_blank"> DataStudio </a>之类的BI工具来可视化您的工作数据和绩效。</p><p id="e9c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lk">要了解关于BigQuery的更多信息，请访问我们的网站</em>  <em class="lk">。</em></p></div></div>    
</body>
</html>