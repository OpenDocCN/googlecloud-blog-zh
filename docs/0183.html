<html>
<head>
<title>How to automate project creation using gcloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用gcloud自动创建项目</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-automate-project-creation-using-gcloud-4e71d9a70047?source=collection_archive---------0-----------------------#2017-01-04">https://medium.com/google-cloud/how-to-automate-project-creation-using-gcloud-4e71d9a70047?source=collection_archive---------0-----------------------#2017-01-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3254" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将为大约30人举办Cloud ML培训课程，并希望给他们每个人一个原始的谷歌云项目。还有，我想让账单来找我。显然，我不想在项目创建过程中点击鼠标，所以我编写了脚本。</p><p id="1111" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你需要为一群人创建单独的谷歌云项目，请随意使用我的<a class="ae jd" href="https://github.com/GoogleCloudPlatform/training-data-analyst/tree/master/blogs/gcloudprojects" rel="noopener ugc nofollow" target="_blank">脚本</a>。即使你没有这种特殊的需求，本文也展示了如何使用<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> gcloud </strong> </a>来自动化重复的任务。这是一项需要掌握的有用技能。</p><h1 id="d752" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">如何运行脚本</h1><p id="79c5" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">首先，您需要找到您的帐单帐户id。打开<a class="ae jd" href="https://cloud.google.com/shell/" rel="noopener ugc nofollow" target="_blank">云壳</a>运行:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="c915" class="kq jf hi km b fi kr ks l kt ku">gcloud alpha billing accounts list</span></pre><p id="ad8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">记帐帐户将采用0x 0x 0x 0 x-0x 0x 0x 0 x-0x 0x 0x 0 x的形式。然后，通过运行以下命令创建项目:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="e87f" class="kq jf hi km b fi kr ks l kt ku">curl <a class="ae jd" href="https://raw.githubusercontent.com/GoogleCloudPlatform/training-data-analyst/master/blogs/gcloudprojects/create_projects.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/GoogleCloudPlatform/training-data-analyst/master/blogs/gcloudprojects/create_projects.sh</a> -o create_projects.sh</span><span id="c5fe" class="kq jf hi km b fi kv ks l kt ku">chmod +x create_projects.sh</span><span id="d850" class="kq jf hi km b fi kv ks l kt ku">./create_projects.sh 0X0X0X-0X0X0X-0X0X0X learnml-20170106  somebody@gmail.com someother@gmail.com</span></pre><p id="28a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">create_projects.sh的第一个参数是账单id。第二个是项目前缀——所有创建的项目都有这个前缀。因为项目id必须是唯一的，所以选择一个相对唯一的前缀。然后，只需提供电子邮件地址列表。</p><h1 id="cd32" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">整个剧本</h1><p id="3075" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这就是create _ projects . sh[<a class="ae jd" href="https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/blogs/gcloudprojects/create_projects.sh" rel="noopener ugc nofollow" target="_blank">github link</a>]的样子:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="ec5e" class="kq jf hi km b fi kr ks l kt ku">#!/bin/bash</span><span id="17c2" class="kq jf hi km b fi kv ks l kt ku">if [ "$#" -lt 3 ]; then<br/>   echo "Usage:  ./create_projects.sh billingid project-prefix  email1 [email2 [email3 ...]]]"<br/>   echo "   eg:  ./create_projects.sh 0X0X0X-0X0X0X-0X0X0X learnml-20170106  <a class="ae jd" href="mailto:somebody@gmail.com" rel="noopener ugc nofollow" target="_blank">somebody@gmail.com</a> <a class="ae jd" href="mailto:someother@gmail.com" rel="noopener ugc nofollow" target="_blank">someother@gmail.com</a>"<br/>   exit<br/>fi</span><span id="347c" class="kq jf hi km b fi kv ks l kt ku">ACCOUNT_ID=$1<br/>shift<br/>PROJECT_PREFIX=$1<br/>shift<br/>EMAILS=$@</span><span id="44c1" class="kq jf hi km b fi kv ks l kt ku">gcloud components update<br/>gcloud components install alpha</span><span id="31ae" class="kq jf hi km b fi kv ks l kt ku">for EMAIL in $EMAILS; do<br/>   PROJECT_ID=$(echo "${PROJECT_PREFIX}-${EMAIL}" | sed 's/@/-/g' | sed 's/\./-/g' | cut -c 1-30)<br/>   echo "Creating project $PROJECT_ID for $EMAIL ... "</span><span id="94df" class="kq jf hi km b fi kv ks l kt ku">   # Create project<br/>   gcloud alpha projects create $PROJECT_ID</span><span id="7381" class="kq jf hi km b fi kv ks l kt ku">   # Add user to project<br/>   gcloud alpha projects get-iam-policy $PROJECT_ID --format=json &gt; iam.json.orig<br/>   cat iam.json.orig | sed s'/"bindings": \[/"bindings": \[ \{"members": \["user:'$EMAIL'"\],"role": "roles\/editor"\},/g' &gt; iam.json.new<br/>   gcloud alpha projects set-iam-policy $PROJECT_ID iam.json.new</span><span id="ed7f" class="kq jf hi km b fi kv ks l kt ku">   # Set billing id of project<br/>   gcloud alpha billing accounts projects link $PROJECT_ID --account-id=$ACCOUNT_ID</span><span id="be74" class="kq jf hi km b fi kv ks l kt ku">done</span></pre><p id="7dcf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们一块一块来看。前几行只是确保用户已经传入了所需的参数(账单id、项目前缀和电子邮件地址列表)。</p><h1 id="73c3" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">1.设置</h1><p id="caa4" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这些是使用普通bash语法从命令行参数中提取的(shift使用第一个参数，$@是现在保留的命令行参数数组):</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="7451" class="kq jf hi km b fi kr ks l kt ku">ACCOUNT_ID=$1<br/>shift<br/>PROJECT_PREFIX=$1<br/>shift<br/>EMAILS=$@</span></pre><p id="56da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我接下来更新gcloud并安装alpha模块，因为项目创建功能目前在public alpha:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a74d" class="kq jf hi km b fi kr ks l kt ku">gcloud components update<br/>gcloud components install alpha</span></pre><h1 id="e22c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">2.唯一的项目id</h1><p id="01f1" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">接下来，我一封一封地浏览邮件，并为每封邮件创建项目:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="e94c" class="kq jf hi km b fi kr ks l kt ku">for EMAIL in $EMAILS; do<br/>   PROJECT_ID=$(echo "${PROJECT_PREFIX}-${EMAIL}" | sed 's/@/-/g' | sed 's/\./-/g' | cut -c 1-30)<br/>   echo "Creating project $PROJECT_ID for $EMAIL ... "</span><span id="30c8" class="kq jf hi km b fi kv ks l kt ku">   ...</span><span id="8147" class="kq jf hi km b fi kv ks l kt ku">done</span></pre><p id="5c20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用项目前缀和电子邮件地址为每个用户提供一个单独的项目id。因为项目id不能包含@符号或点，所以我用连字符替换了它们，并且因为项目id被限制在30个字符以内(不要问我为什么)，所以我在30个字符的限制内去掉了名称。</p><h1 id="7f48" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">3.创建项目</h1><p id="4b2f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在，我们准备创建项目本身。为了创建一个项目，我使用gcloud命令:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="26b2" class="kq jf hi km b fi kr ks l kt ku">gcloud alpha projects create $PROJECT_ID</span></pre><h1 id="aa01" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">4.添加用户</h1><p id="9d0b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在，这个项目已经由我创建，并以我为所有者。我需要添加我的培训课程中作为编辑的人的电子邮件地址(这将让他们做大多数事情，但我仍然是所有者):</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a34f" class="kq jf hi km b fi kr ks l kt ku">gcloud alpha projects get-iam-policy $PROJECT_ID --format=json &gt; iam.json.orig<br/>   <br/>cat iam.json.orig | sed s'/"bindings": \[/"bindings": \[ \{"members": \["user:'$EMAIL'"\],"role": "roles\/editor"\},/g' &gt; iam.json.new<br/>   <br/>gcloud alpha projects set-iam-policy $PROJECT_ID iam.json.new</span></pre><p id="2354" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的代码获取项目的当前身份访问管理(IAM)策略，可能如下所示:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="8250" class="kq jf hi km b fi kr ks l kt ku">{<br/>  "bindings": [<br/>    {<br/>      "members": [<br/>        "user:<a class="ae jd" href="mailto:vlakshmanan@google.com" rel="noopener ugc nofollow" target="_blank">myemail@google.com</a>"<br/>      ],<br/>      "role": "roles/owner"<br/>    }<br/>  ],<br/>  "etag": "BwVFSYizPdc=",<br/>  "version": 1<br/>}</span></pre><p id="81dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我使用sed替换bindings行，以便新用户作为编辑者被添加:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="9728" class="kq jf hi km b fi kr ks l kt ku">"bindings": [ {"members": ["user:somebody2@gmail.com"],"role": "roles/editor"},</span></pre><h1 id="b8c5" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">5.演员表</h1><p id="e8c3" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">最后，我将新创建的项目与我的账单id关联起来，这样账单就会出现在我面前:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="9d94" class="kq jf hi km b fi kr ks l kt ku">gcloud alpha billing accounts projects link $PROJECT_ID --account-id=$ACCOUNT_ID</span></pre><p id="c776" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！</p><h1 id="36f4" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">清理</h1><p id="b27b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">培训结束后，我将使用delete _ projects . sh[<a class="ae jd" href="https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/blogs/gcloudprojects/delete_projects.sh" rel="noopener ugc nofollow" target="_blank">github link</a>]循环删除这些项目，其关键行是:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="9fa3" class="kq jf hi km b fi kr ks l kt ku">for EMAIL in $EMAILS; do<br/>    PROJECT_ID=$(echo "${PROJECT_PREFIX}-${EMAIL}" | sed 's/@/-/g' | sed 's/\./-/g' | cut -c 1-30)</span><span id="8073" class="kq jf hi km b fi kv ks l kt ku">    gcloud alpha projects delete $PROJECT_ID</span><span id="cd97" class="kq jf hi km b fi kv ks l kt ku">done</span></pre><p id="b0dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>只为你完全信任的一群人提供这样的项目，比如你公司内部的人，因为他们所做的一切都要向你收费…</p></div></div>    
</body>
</html>