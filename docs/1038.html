<html>
<head>
<title>Mapping Kubernetes Service Accounts to GCP IAMs using Workload Identity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用工作负荷标识将Kubernetes服务帐户映射到GCP IAMs</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/mapping-kubernetes-service-accounts-to-gcp-iams-using-workload-identity-b53496d543e0?source=collection_archive---------0-----------------------#2019-06-18">https://medium.com/google-cloud/mapping-kubernetes-service-accounts-to-gcp-iams-using-workload-identity-b53496d543e0?source=collection_archive---------0-----------------------#2019-06-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="6737" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">GKE的GCP凭证管理变得简单多了</h2></div><p id="3c66" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们喜欢谷歌Kubernetes引擎(GKE)，但直到最近，我们还没有一个很好的故事，如何让我们的服务在Kubernetes上运行所需的谷歌云平台(GCP)的许可。</p><p id="872f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们探索了一系列围绕GCP服务帐户凭证管理的工具——一路上利用了Terraform、Vault、Kubernetes Secrets和KMS加密凭证——但没有一个工具能给我们提供我们一直在寻找的干净、可扩展、短命的令牌解决方案。</p><p id="bf8a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们真正想要的(也是我们多次要求的)是一种让Kubernetes服务账户充当GCP服务账户的方式Google现在终于通过<a class="ae jt" href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity" rel="noopener ugc nofollow" target="_blank"> <strong class="iz hj">工作负载身份实现了这一点。</strong>T3】</a></p><p id="15a2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们看一个例子来说明这是如何工作的。</p><h2 id="a493" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">设置</h2><ul class=""><li id="9a44" class="kp kq hi iz b ja kr jd ks jg kt jk ku jo kv js kw kx ky kz bi translated">我们有一个运行在服务帐户下的GKE集群:<br/><strong class="iz hj">gke-cluster-sa @ Louis-testing-project . iam . gserviceaccount . com</strong></li><li id="74ab" class="kp kq hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated">我们有一个桶<strong class="iz hj">GS://workload-identity-test</strong></li><li id="9f9b" class="kp kq hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated">我们有一个不同的服务帐户可以读取bucket:<br/><strong class="iz hj">bucket-lister-sa @ Louis-testing-project . iam . gserviceaccount . com</strong></li></ul><p id="e616" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">目标:</strong>在我们的GKE集群上运行的特定pod可以在我们的bucket中列出对象，而无需接触GCP服务帐户密钥或安装任何秘密。</p><h2 id="cc44" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">以前事情是如何运作的</h2><p id="c3f1" class="pw-post-body-paragraph ix iy hi iz b ja kr ij jc jd ks im jf jg lf ji jj jk lg jm jn jo lh jq jr js hb bi translated">让我们尝试在不启用工作负载标识的情况下列出存储桶内容。</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="f6f2" class="ju jv hi ln b fi lr ls l lt lu">kubectl run -i -tty test1 -image gcr.io/cloud-builders/gsutil ls gs://workload-identity-test</span><span id="41d7" class="ju jv hi ln b fi lv ls l lt lu">&gt; AccessDeniedException: 403 gke-cluster-sa@louis-testing-project.iam.gserviceaccount.com does not have storage.objects.list access to workload-identity-test.</span></pre><p id="9122" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里发生了什么？在pod中运行的gsutil CLI访问了节点的元数据端点，该端点返回了运行node - <strong class="iz hj"> gke-cluster-sa </strong>的服务帐户的令牌。这个服务帐户没有权限读取存储桶，所以我们得到403。</p><h2 id="f625" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">设置工作量标识</h2><p id="17d6" class="pw-post-body-paragraph ix iy hi iz b ja kr ij jc jd ks im jf jg lf ji jj jk lg jm jn jo lh jq jr js hb bi translated">我们需要做的第一件事是在GKE集群上启用工作负载身份。</p><figure class="li lj lk ll fd lx er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es lw"><img src="../Images/6f1bde603b0ce1193f6cac45f23521cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7rIyx6N1hDEX48U9"/></div></div></figure><p id="b5bf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在集群编辑UI中静态定义的身份命名空间将Kubernetes服务帐户名称映射到用于身份和访问管理(IAM)绑定的虚拟GCP服务帐户句柄(下面将详细介绍)。</p><h2 id="89dd" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">启用元数据服务器</h2><p id="c9c3" class="pw-post-body-paragraph ix iy hi iz b ja kr ij jc jd ks im jf jg lf ji jj jk lg jm jn jo lh jq jr js hb bi translated">元数据服务器在每个GKE节点上运行，并改变元数据端点的行为。这也保护了元数据端点，消除了对<a class="ae jt" href="https://cloud.google.com/kubernetes-engine/docs/how-to/protecting-cluster-metadata" rel="noopener ugc nofollow" target="_blank">元数据隐藏</a>的需要。让我们在默认节点池上启用元数据服务器。</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="c7cc" class="ju jv hi ln b fi lr ls l lt lu">gcloud beta container node-pools update default-pool \<br/> — cluster=workload-identity-test \<br/> — workload-metadata-from-node=GKE_METADATA_SERVER \<br/> — zone=us-central1-b</span></pre><p id="c9d5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">随着元数据服务器在我们的节点上运行，让我们看看现在尝试列出我们的bucket内容会发生什么。</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="b43b" class="ju jv hi ln b fi lr ls l lt lu">kubectl run -i — tty test2 — image gcr.io/cloud-builders/gsutil ls gs://workload-identity-test</span><span id="b8de" class="ju jv hi ln b fi lv ls l lt lu">&gt; ServiceException: 401 Invalid Credentials</span></pre><p id="7820" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们有进展了。随着元数据端点的加强，我们无法再检索运行节点的服务帐户的令牌，因此我们现在得到401错误，而不是403。</p><h2 id="9666" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">创建并绑定Kubernetes服务帐户</h2><p id="5140" class="pw-post-body-paragraph ix iy hi iz b ja kr ij jc jd ks im jf jg lf ji jj jk lg jm jn jo lh jq jr js hb bi translated">让我们创建一个特别注释的Kubernetes服务帐户— <em class="me"> witest </em></p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="9f11" class="ju jv hi ln b fi lr ls l lt lu">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  annotations:<br/>    iam.gke.io/gcp-service-account: bucket-lister-sa@louis-testing-project.iam.gserviceaccount.com<br/>  name: witest<br/>  namespace: default</span></pre><p id="5889" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里，我们在<em class="me">默认</em>名称空间中定义了一个服务帐户<em class="me"> witest </em>，并且我们提供了一个注释，定义了我们想要映射到的GCP服务帐户。</p><p id="9add" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，我们需要将派生的虚拟GCP服务帐户句柄绑定到我们想要充当的真实GCP服务帐户。</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="e889" class="ju jv hi ln b fi lr ls l lt lu">gcloud iam service-accounts add-iam-policy-binding \<br/>  --role roles/iam.workloadIdentityUser \<br/>  --member "serviceAccount:louis-testing-     project.svc.id.goog[default/witest]" \<br/>  bucket-lister-sa@louis-testing-project.iam.gserviceaccount.com</span></pre><p id="d6b6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">service account:Louis-testing-project . SVC . id . goog【default/witest】</strong>源自启用工作负载标识时定义的标识名称空间，以及我们绑定的Kubernetes服务帐户的名称空间和名称。</p><h2 id="80a6" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">确认它有效</h2><p id="6c5b" class="pw-post-body-paragraph ix iy hi iz b ja kr ij jc jd ks im jf jg lf ji jj jk lg jm jn jo lh jq jr js hb bi translated">在配置好一切之后，让我们试着列出我们的bucket的内容。</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="4646" class="ju jv hi ln b fi lr ls l lt lu">kubectl run --serviceaccount=witest -i --tty test3 --image gcr.io/cloud-builders/gsutil ls gs://workload-identity-test</span><span id="2c7d" class="ju jv hi ln b fi lv ls l lt lu">&gt; gs://workload-identity-test/success/</span></pre><p id="e2be" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">太棒了，这个工作很漂亮。我们能够列出桶的内容，但看不到任何长期令牌。这是一个巨大的特性，使我们的凭证管理和安全故事变得更好——感谢谷歌！</p></div></div>    
</body>
</html>