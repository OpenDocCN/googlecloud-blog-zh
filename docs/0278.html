<html>
<head>
<title>GAE Startup time and the dependency problem</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GAE启动时间和依赖性问题</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gae-startup-time-and-the-dependency-problem-b866d92c1e6f?source=collection_archive---------0-----------------------#2017-05-11">https://medium.com/google-cloud/gae-startup-time-and-the-dependency-problem-b866d92c1e6f?source=collection_archive---------0-----------------------#2017-05-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/d9dc4b6b7d36750855f51f34b01f8003.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i8gFMHNLtQJj-DnrepTSjw.jpeg"/></div></div></figure><div class=""/><p id="1388" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上周，我和一个曾经在游戏行业工作的好朋友一起吃午饭。她哀叹Google.com作为计算器的局限性:</p><blockquote class="jo jp jq"><p id="8146" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated">“Google.com是我用过的最简单的计算器之一。但是最近我已经达到了极限。它甚至不会计算1024的阶乘。”</p></blockquote><p id="acc8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">结果是，她创建了自己版本的Google.com计算器(甚至从主网站复制了CSS/HTML)，名为“<em class="jr"> Platy-Calc </em>”。然而，她的版本运行在App Engine上，并使用python运行时(可以轻松计算1024的阶乘)评估提交的数学表达式。</p><p id="937e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对我来说，这太棒了，于是我立即开始使用<em class="jr"> Platy-Calc </em>作为我的主要计算器。</p><p id="7e65" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，我开始注意到一天中的第一个请求总是比随后的请求慢一点。鉴于我最近一直在谈论冷启动时间，我联系了我的朋友，要求对应用程序进行一些分析。</p><figure class="jv jw jx jy fd hk"><div class="bz dy l di"><div class="jz ka l"/></div><figcaption class="kb kc et er es kd ke bd b be z dx translated">嘿！忙到没时间看书？看TL；上面的DR视频！</figcaption></figure><h1 id="d482" class="kf kg ht bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">初始轮廓</h1><p id="da4e" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">Platy-Calc的冷启动时间的第一个概要显示了我所期望的:比正常的冷启动时间要长。</p><figure class="jv jw jx jy fd hk er es paragraph-image"><div class="er es li"><img src="../Images/564aaa75a37cec01aefcbe92cc362e2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/1*ajN2umIIxWj1ZIkD-wLtJQ.png"/></div></figure><p id="d449" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Platy-Calc的代码非常简单；启动路径中没有全局变量，没有锁定问题，也没有数据库调用。在全球范围内，在导入期间，唯一与正常的“Hello World”不同的是这些导入:</p><figure class="jv jw jx jy fd hk"><div class="bz dy l di"><div class="lj ka l"/></div></figure><p id="2a8f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">鉴于我们已经对一个简单的“Hello World”应用程序进行了计时，并看到了启动时间的样子，这些导入看起来像是一个罪魁祸首。</p><p id="1f32" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">作为测试，我们删除了那些导入并重新计时启动过程，只是为了看看GAE启动时间是否突然倒退了，或者是否有其他问题正在发生。</p><figure class="jv jw jx jy fd hk er es paragraph-image"><div class="er es lk"><img src="../Images/3a591c247ac3b1311d951ca6e512fb6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/1*VMStALcSeaBEN4A1JOJDtg.png"/></div></figure><p id="4afe" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谢天谢地，我们没有发疯，因为我们的计时显示了与我之前看到的几乎相同的启动行为<a class="ae ll" rel="noopener" href="/@duhroach/understanding-and-profiling-app-engine-cold-boot-time-908431aa971d">。</a></p><h1 id="569b" class="kf kg ht bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">进口征税</h1><p id="6519" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">在这一点上，排除过程清楚地指出导入是启动时间问题的来源。然而，简单地彻底抛弃它们是错误的；我们需要更多的信息。</p><p id="37f1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，我们整理了一小段代码(类似于<a class="ae ll" href="http://stackoverflow.com/questions/6025635/python-speed-up-imports" rel="noopener ugc nofollow" target="_blank"> this SO post </a>)来为每个导入的模块计时，看看哪个模块可能会让我们心痛:</p><figure class="jv jw jx jy fd hk er es paragraph-image"><div class="er es lm"><img src="../Images/bdf92d3c603032596e86f84c932be3d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*efkKWeDSA6C4t1HH4M_CCA.png"/></div></figure><p id="1b30" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上图讲述了两个主要故事:</p><p id="217d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1)导入的总和很容易使应用程序的冷启动时间增加约1.25秒</p><p id="8933" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2)显然，有些进口比其他进口需要更长的时间。</p><p id="713f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">#2确实是这里有趣的一点，值得花点时间来讨论。</p><h1 id="e06c" class="kf kg ht bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">悲哀是依赖</h1><p id="6398" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">在我那个时代，我们不得不担心C++头文件的复杂性如何影响我们2000万行应用程序的link +编译时间。在现代函数式语言中，大部分开销已经从编译时转移到运行时。一个库/模块可以在你需要的时候加载<em class="jr">而不是在应用程序开始的时候。为了支持这一点，大多数函数式语言在加载和实例化代码时都发展了相当大的灵活性…这通常会对您的加载时间产生负面影响。</em></p><p id="79ce" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在冷启动期间，您的应用程序代码将忙于扫描和导入依赖项。这样做的时间越长，执行第一行代码的时间就越长。一些语言可以优化这一过程，使其异常快速，其他语言较慢，但提供更大的灵活性。公平地说，在大多数情况下，一个标准的应用程序导入几个模块是不够有效的。然而，当第三方库变得足够大时，我们开始看到它们在导入语义上做一些奇怪的事情，并且经常会严重影响您的启动时间。</p><p id="a9eb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于app engine，这个问题的完美例子是Java的<a class="ae ll" href="https://cloud.google.com/appengine/articles/spring_optimization" rel="noopener ugc nofollow" target="_blank"> Spring framework </a>，它大量使用了该语言的某些方面，这些方面造成了不太理想的启动开销:Spring需要在加载时扫描所有类(以便确定依赖关系)，这严重影响了实例启动时间，从而影响了您的整体响应能力。事实上，只要谷歌一下“<a class="ae ll" href="https://www.google.com/webhp?&amp;ie=UTF-8#q=app%20engine%20spring%20slow" rel="noopener ugc nofollow" target="_blank"> <em class="jr"> App发动机弹簧缓慢</em> </a>”就会发现前6个话题都与弹簧影响冷启动时间有关:</p><figure class="jv jw jx jy fd hk er es paragraph-image"><div class="er es ln"><img src="../Images/75714c95ce9b6c5b91d2f7d9f6795591.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*92yPPrUXmwNraZHDE00E6g.png"/></div></figure><p id="bc11" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">虽然看起来我是专门针对<a class="ae ll" href="https://projects.spring.io/spring-framework/" rel="noopener ugc nofollow" target="_blank">弹簧</a>的，但我不是。你的第三方库越大，功能越多，他们就越有可能需要做一些奇怪的事情来让他们的代码运行起来，移动并提供功能。</p><h1 id="530b" class="kf kg ht bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">简单的解决办法</h1><p id="fa0f" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">考虑到操作需要导入，我们的手在优雅的解决方案方面有点受限。尽管如此，我们还是想出了一些办法来解决这个问题:</p><ul class=""><li id="ef57" class="lo lp ht is b it iu ix iy jb lq jf lr jj ls jn lt lu lv lw bi translated"><strong class="is hu">使用预热请求</strong> —当网站从静态资产加载时，向计算器服务发送一个快速ping，它将在您输入等式的相同时间内导入所需的库。</li><li id="689b" class="lo lp ht is b it lx ix ly jb lz jf ma jj mb jn lt lu lv lw bi translated"><strong class="is hu">惰性加载导入</strong> — Python通过允许模块的全局与局部导入来支持这种操作。所以我们可以将所有的导入都转移到函数局部；这样，如果你只是想做2+2，你就不用等着导入整个SciPy模块了。只有当我们检测到一些特定的关键字时，我们才会导入那些特定的东西。</li><li id="6d7d" class="lo lp ht is b it lx ix ly jb lz jf ma jj mb jn lt lu lv lw bi translated"><strong class="is hu">修剪依赖树</strong>——我们发现了很多关于如何通过显式导入子部分或者一些有趣的技巧(包括镜像模块和删除内容)来手动修剪依赖树的SO帖子和教程。</li></ul><p id="ee85" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">考虑到这一切..我们决定什么也不做。</p><p id="7891" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">没错。<em class="jr"> Platy-Calc </em>并不是一个庞大的、价值100万美元的QPS服务。它只是一些真正需要从命令行界面计算大数的朋友使用的一个小应用程序(出于某些疯狂的原因..).所以在我们的例子中，每隔几天为一个查询多等一秒钟并没有什么大不了的。</p><p id="4611" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">尽管我很想宣扬性能，但事实是，考虑到需要进行的修复工作，特定性能改进给最终用户带来的结果有时并不合理。</p><p id="ff4b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以，记住:每一毫秒都很重要！(除了在少数地方..这真的不重要..；)</p><h2 id="a317" class="mc kg ht bd kh md me mf kl mg mh mi kp jb mj mk kt jf ml mm kx jj mn mo lb mp bi translated">嘿！</h2><p id="8855" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">想了解更多关于如何<a class="ae ll" rel="noopener" href="/@duhroach/understanding-and-profiling-app-engine-cold-boot-time-908431aa971d">剖析App引擎启动时间</a>？<br/>想了解更多关于<a class="ae ll" rel="noopener" href="/@duhroach/app-engine-scheduler-settings-and-instance-count-4d1e669f33d5"> GAE的调度器设置</a>？<br/>想知道首先避免<a class="ae ll" rel="noopener" href="/@duhroach/app-engine-startup-time-and-the-global-variable-problem-7ab10de1f349">启动新实例的方法</a>？<br/>想成为<a class="ae ll" href="http://shop.oreilly.com/product/0636920052036.do" rel="noopener ugc nofollow" target="_blank">数据压缩专家</a>？</p></div></div>    
</body>
</html>