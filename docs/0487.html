<html>
<head>
<title>Refreshing JSON Web Tokens (JWTs) in Google Cloud IoT Core</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">刷新谷歌云物联网核心中的JSON Web令牌(jwt)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/refreshing-json-web-tokens-jwts-for-google-cloud-iot-core-897318df3836?source=collection_archive---------1-----------------------#2018-01-05">https://medium.com/google-cloud/refreshing-json-web-tokens-jwts-for-google-cloud-iot-core-897318df3836?source=collection_archive---------1-----------------------#2018-01-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="103d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要向Google Cloud IoT Core认证并从设备发送消息，每个设备必须在建立MQTT或HTTP连接之前创建一个JWT。jwt是一种安全的签名方法，在设备和云物联网核心主题之间验证和发送数据。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/4cef871fec502cafba94b80dac7383bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*FT7w-pP1-KQkeu6s2j4CVA.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">云物联网核心JWT和密钥认证</figcaption></figure><p id="2011" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，在<a class="ae jp" href="https://github.com/GoogleCloudPlatform/python-docs-samples/blob/master/iot/api-client/mqtt_example/cloudiot_mqtt_example.py" rel="noopener ugc nofollow" target="_blank">快速入门示例</a>中，JWT exp(“expiration”)的最大生命周期为60分钟或3600秒:</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="2795" class="jv jw hi jr b fi jx jy l jz ka">token = {            <br/># The time that the token was issued at            <br/>'iat': datetime.datetime.utcnow(),            <br/># The time the token expires.            <br/>'exp': datetime.datetime.utcnow() + datetime.timedelta(minutes=60),            # The audience field should always be set to the GCP project id.                       'aud': project_id    <br/>}</span></pre><p id="c74b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您不刷新JWT，您可能会在Cloud IoT Core中看到如下错误(mqtt: SERVER:授权令牌过期)。这将延迟设备发布，并为需要维护可靠数据流的传感器带来问题。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kb"><img src="../Images/e6fd404690c03ea21c3756c9b5e99a13.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/1*7gQ953e1ftLiB5kiceo_Jg.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">设备未刷新JWT令牌，运行不畅</figcaption></figure><p id="1d6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看<a class="ae jp" href="https://github.com/GoogleCloudPlatform/python-docs-samples/blob/master/iot/api-client/mqtt_example/cloudiot_mqtt_example.py" rel="noopener ugc nofollow" target="_blank"> python物联网核心MQTT示例</a>的第<a class="ae jp" href="https://github.com/GoogleCloudPlatform/python-docs-samples/blob/adaa3678af4ed30f458ecbf8c1ac19d3e81dafc8/iot/api-client/mqtt_example/cloudiot_mqtt_example.py#L223" rel="noopener ugc nofollow" target="_blank">222–233</a>行，了解如何在脚本中插入JWT刷新的代码。更多详细信息，请访问<a class="ae jp" href="https://cloud.google.com/iot/docs/how-tos/credentials/jwts" rel="noopener ugc nofollow" target="_blank">云物联网核心文档页面</a>。</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="4269" class="jv jw hi jr b fi jx jy l jz ka">seconds_since_issue = (datetime.datetime.utcnow() - jwt_iat).seconds<br/>if seconds_since_issue &gt; 60 * jwt_exp_mins:<br/>    print('Refreshing token after {}s').format(seconds_since_issue)<br/>    client.loop_stop()<br/>    jwt_iat = datetime.datetime.utcnow()<br/>    client = get_client(<br/>        args.project_id, args.cloud_region,<br/>        args.registry_id, args.device_id, args.private_key_file,<br/>        args.algorithm, args.ca_certs, args.mqtt_bridge_hostname,<br/>        args.mqtt_bridge_port)</span></pre><p id="b898" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，查看我的github问题<a class="ae jp" href="https://github.com/GoogleCloudPlatform/python-docs-samples/issues/1264" rel="noopener ugc nofollow" target="_blank">这里</a>更多关于JWT刷新和<a class="ae jp" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JWT.io </a>几乎每种语言的助手库。</p><p id="474d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢<a class="kc kd ge" href="https://medium.com/u/282bfd5a4236?source=post_page-----897318df3836--------------------------------" rel="noopener" target="_blank"> Gus Class </a>的代码辅助和<a class="ae jp" href="https://github.com/noerog" rel="noopener ugc nofollow" target="_blank"> @noerog </a>让GCP文档每天都变得更好。</p><p id="e76a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jp" href="https://github.com/teifip" rel="noopener ugc nofollow" target="_blank"> Paolo </a>联系我，让我了解他创建的助手，该助手在node中创建物联网核心MQTT客户端。这对于偶尔断开连接的弱连接设备来说非常好。谢谢保罗。你可以在这里查看<a class="ae jp" href="https://github.com/teifip/gcic-mqtt-client" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="7c4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更新:自2018年4月起，您可以使用更长的过期时间，从发布时间+偏移时间起24小时<a class="ae jp" href="https://cloud.google.com/iot/docs/how-tos/credentials/jwts#jwt_claims" rel="noopener ugc nofollow" target="_blank">。这可以使您不必在受约束的设备上重新生成令牌。</a></p></div></div>    
</body>
</html>