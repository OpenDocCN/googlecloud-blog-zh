<html>
<head>
<title>Distributed Tracing Spring Boot Microservices with Stackdriver Trace</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Stackdriver Trace的分布式跟踪Spring Boot微服务</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/distributed-tracing-spring-boot-microservices-with-stackdriver-trace-7fe42c6de3f3?source=collection_archive---------0-----------------------#2017-01-28">https://medium.com/google-cloud/distributed-tracing-spring-boot-microservices-with-stackdriver-trace-7fe42c6de3f3?source=collection_archive---------0-----------------------#2017-01-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="bcef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大约在2006年，我在一家咨询公司工作，被指派为一家公用事业客户的集成解决方案架构师，负责实现面向服务的架构。我记得我的经理当时坚持让我们开发一个框架，这个框架将生成一个请求ID，并将相同的请求ID传播给所有后续的服务调用。经理还坚持记录服务调用持续时间，并将它们绑定到同一个请求ID。目标是能够:</p><ol class=""><li id="ee75" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">在复杂的服务世界中确定一连串的呼叫。</li><li id="7ebe" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">调试请求并找出哪个服务导致了服务调用链中的错误。</li><li id="cb6d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">确定服务在延迟/性能方面是否符合服务级别协议。</li></ol><p id="0581" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一晃10多年过去了，我意识到我们实现的实际上是一种分布式跟踪。在微服务领域，我们比以往任何时候都更需要分布式跟踪。</p><h1 id="630e" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">堆栈驱动程序跟踪</h1><p id="b5bd" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">谷歌云平台有一个分布式追踪解决方案，叫做<a class="ae ku" href="https://cloud.google.com/trace/" rel="noopener ugc nofollow" target="_blank"> Stackdriver Trace </a>。Stackdriver Trace是一项托管服务，因此您无需自己管理服务器组件或复杂的存储。Stackdriver Trace公开了一个API，这样无论你是在Google云平台还是其他任何地方运行服务，你都可以发送跟踪信息。</p><p id="6a05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不想编写定制代码来直接使用<a class="ae ku" href="https://docs.google.com/document/d/1CzzNcfAAfzTerYJCWlpf1iOnUhdxoPxoo3TIQzGmpzI/edit#" rel="noopener ugc nofollow" target="_blank"> Google Cloud Trace API </a>，而是想使用现成的组件和<em class="kv">事实上的</em>标准，这样我就可以有一个可移植的应用程序，避免供应商锁定(我也有点懒:)。</p><h2 id="e425" class="kw js hi bd jt kx ky kz jx la lb lc kb iq ld le kf iu lf lg kj iy lh li kn lj bi translated">Stackdriver Trace已经准备好了</h2><p id="e3aa" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">好消息是已经有了Stackdriver Trace的Zipkin代理。我可以专注于用优秀的框架(比如Spring Boot和Spring Cloud)编写我的应用程序，我可以记录和存储分布式跟踪数据，而不必担心基础设施。</p><p id="7ee4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">代理可以作为JAR文件或Docker容器运行。配置它们的方式是相同的。</p><p id="fd22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">更新2017年4月6日</strong>:<em class="kv">stack driver Trace Zipkin Proxy现移至</em><a class="ae ku" href="https://github.com/openzipkin/zipkin-gcp" rel="noopener ugc nofollow" target="_blank"><em class="kv">openzipkin/Zipkin-GCP</em></a><em class="kv">资源库！另外，如果你使用的是Spring Boot，可以使用与春云Sleuth无缝集成的</em> <a class="ae ku" href="https://docs.spring.io/spring-cloud-gcp/docs/1.0.0.M2/reference/htmlsingle/#_spring_cloud_sleuth" rel="noopener ugc nofollow" target="_blank"> <em class="kv">春云GCP痕迹启动器</em> </a> <em class="kv">。</em></p><p id="efbe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在<a class="ae ku" href="https://mvnrepository.com/artifact/com.google.cloud.trace.adapters.zipkin/collector" rel="noopener ugc nofollow" target="_blank"> Stackdriver Trace Maven资源库</a>中找到可执行文件Zipkin proxy JAR的最新版本，或者下载最新版本:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="3f5c" class="kw js hi lp b fi lt lu l lv lw">$ wget -O zipkin-stackdriver-collector.jar \ '<a class="ae ku" href="https://search.maven.org/remote_content?g=com.google.cloud.trace.adapters.zipkin&amp;a=collector&amp;v=LATEST'" rel="noopener ugc nofollow" target="_blank">https://search.maven.org/remote_content?g=com.google.cloud.trace.adapters.zipkin&amp;a=collector&amp;v=LATEST</a>'</span></pre><p id="9f3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有几种方法可以将此代理配置为与Stackdriver Trace进行安全通信:</p><ol class=""><li id="d331" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">如果您安装了<a class="ae ku" href="https://cloud.google.com/sdk/" rel="noopener ugc nofollow" target="_blank"> gcloud SDK </a>，它将使用来自gcloud SDK的凭证，无需额外配置。</li><li id="e672" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">如果你在谷歌云平台虚拟机或应用引擎上运行它，它将能够使用机器凭证，而无需额外配置。</li><li id="b505" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">如果您想使用一致的凭证在任何地方运行它，您可以通过环境变量将其配置为使用服务帐户。</li></ol><h2 id="dd39" class="kw js hi bd jt kx ky kz jx la lb lc kb iq ld le kf iu lf lg kj iy lh li kn lj bi translated">服务帐户</h2><p id="5615" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我喜欢便携，所以我选择使用服务帐户。如果您不想使用服务帐户，请参阅下一节。要创建服务帐户，请导航至<strong class="ih hj">IAM&amp;Admin</strong>&gt;<strong class="ih hj">服务帐户</strong>，然后单击<strong class="ih hj">创建服务帐户</strong>:</p><figure class="lk ll lm ln fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es lx"><img src="../Images/14c83a1521114de5ffafcdf60bda2a1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*B9gzc-CuRbCIIrNz."/></div></div></figure><p id="7a3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保为该服务帐户添加<strong class="ih hj">云跟踪代理</strong>角色，并选择<strong class="ih hj">提供一个新的私钥</strong>和<strong class="ih hj"> JSON密钥类型</strong>:</p><figure class="lk ll lm ln fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es lx"><img src="../Images/2a76b77a56c3ce3b69cdb5dc45487abd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jFPVGsP3G4lSUf84."/></div></div></figure><p id="93ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，点击<strong class="ih hj">创建</strong>创建服务账户。这还会提示您下载服务帐户JSON文件。安全地存储此文件；这是将用于发送和存储跟踪数据的凭据。如果此凭据被破坏，您可以使密钥失效并提供新的密钥。因为此服务帐户仅具有云跟踪代理角色，所以凭据将无法读取任何跟踪数据，也无法针对任何其他Google云平台API进行操作。如果您的应用程序需要使用多个Google Cloud Platform APIs，您可以使用同一个服务帐户启用多个角色。</p><h2 id="e6c5" class="kw js hi bd jt kx ky kz jx la lb lc kb iq ld le kf iu lf lg kj iy lh li kn lj bi translated">在本地运行Zipkin代理</h2><p id="cf6b" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">让我们用一些环境变量来启动代理，以指向Google Cloud项目和之前创建的服务帐户:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="8306" class="kw js hi lp b fi lt lu l lv lw">$ PROJECT_ID=springboot-zipkin-example \<br/>  GOOGLE_APPLICATION_CREDENTIALS=/path/to/service/account.json \<br/>  java -jar zipkin-stackdriver-collector.jar</span></pre><p id="48d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦启动，它将在默认端口(9411)上接受Zipkin跟踪数据。</p><p id="1061" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您不使用服务帐户，但在本地安装了gcloud SDK(并经过鉴定)，则无需任何额外配置即可启动它:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="de5c" class="kw js hi lp b fi lt lu l lv lw">java -jar zipkin-stackdriver-collector.jar</span></pre><p id="870c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在幕后，Zipkin代理将把Zipkin请求翻译成Stackdriver跟踪请求，然后通过高性能gRPC API把请求发送给Stackdriver。该代理还预先配置了netty-tcnative组件，这是安全gRPC访问所必需的。</p><h1 id="ad16" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">Spring Boot和《春云探案》</h1><p id="77df" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">Spring Cloud Sleuth 是一个Spring Boot组件，可以轻松地绑定到Spring Boot微服务框架中，并拦截服务调用以记录跟踪事件。Sleuth标配Zipkin适配器。如果您有自己的Spring Boot应用程序，只需添加Spring Cloud Sleuth依赖项:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="4be9" class="kw js hi lp b fi lt lu l lv lw">&lt;dependencies&gt;<br/>...<br/>  &lt;dependency&gt;<br/>    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br/>    &lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId<br/>  &lt;/dependency&gt;<br/>  &lt;dependency&gt;<br/>    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br/>    &lt;artifactId&gt;spring-cloud-sleuth-zipkin&lt;/artifactId&gt;<br/>  &lt;/dependency&gt;<br/>...<br/>&lt;/dependencies&gt;</span></pre><p id="8d5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在GitHub上找到了一个有用的例子，我将把它作为我的试金石:【https://github.com/openzipkin/sleuth-webmvc-example<a class="ae ku" href="https://github.com/openzipkin/sleuth-webmvc-example" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="7400" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，克隆这个例子:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="5e4b" class="kw js hi lp b fi lt lu l lv lw">$ git clone <a class="ae ku" href="https://github.com/openzipkin/sleuth-webmvc-example" rel="noopener ugc nofollow" target="_blank">https://github.com/openzipkin/sleuth-webmvc-example</a><br/>$ cd sleuth-webmvc-example</span></pre><p id="3ab1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，Sleuth不会为每个请求发送跟踪数据。您可能也不想跟踪每一个请求。可以通过配置spring . sleuth . sampler . percentage属性来调整跟踪采样率。</p><p id="6eea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出于演示目的，我将把采样率提高到100%:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="cf1a" class="kw js hi lp b fi lt lu l lv lw">$ echo “spring.sleuth.sampler.percentage=1.0” &gt;&gt; src/main/resources/application.properties</span></pre><p id="6991" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切就绪。我可以编译代码，启动后端，然后启动前端:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="d771" class="kw js hi lp b fi lt lu l lv lw">$ ./mvnw compile<br/>$ ./mvnw exec:java -Dexec.mainClass=sleuth.webmvc.Backend<br/>$ ./mvnw exec:java -Dexec.mainClass=sleuth.webmvc.Frontend</span></pre><p id="a995" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你没有使用Spring Boot，不用担心。Zipkin代理可以接受来自任何Zipkin兼容客户端的请求。例如，<a class="ae ku" href="https://github.com/openzipkin/brave" rel="noopener ugc nofollow" target="_blank"> Brave </a> Zipkin客户端可以和gRPC、JAX-RS、Jersey、RestEasy等等一起使用。</p><h2 id="0602" class="kw js hi bd jt kx ky kz jx la lb lc kb iq ld le kf iu lf lg kj iy lh li kn lj bi translated">测试一下</h2><p id="d182" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">到目前为止一切顺利！后端运行在端口9000，前端运行在端口8081。大约需要100个请求才能分析汇总的跟踪指标。我使用Apache Benchmark来生成请求:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="128a" class="kw js hi lp b fi lt lu l lv lw">$ ab -n 100 -c 10 <a class="ae ku" href="http://localhost:8081/" rel="noopener ugc nofollow" target="_blank">http://localhost:8081/</a></span></pre><h1 id="bea6" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">看数据</h1><p id="fe5a" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">目前，Zipkin代理只能接收跟踪数据，但不能用于可视化或分析数据。但是可以直接在Stackdriver Trace中看到数据。</p><p id="9a66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导航到谷歌云平台控制台中的<strong class="ih hj"> Trace </strong>查看数据。有了足够的数据，您可以看到汇总的摘要，显示延迟密度分布、百分位数、最近的跟踪、最频繁的URIs等等。</p><figure class="lk ll lm ln fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es lx"><img src="../Images/6c0b62b3a0e6a95cda93ca2bc8c8ed53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YZv7R2jRg6YGSRvH."/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">延迟分布概述</figcaption></figure><figure class="lk ll lm ln fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es lx"><img src="../Images/459b502c98514145ee81dfc2a0c0caea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FQZWP4iGoqOkP8-q."/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">查看跟踪列表</figcaption></figure><figure class="lk ll lm ln fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es lx"><img src="../Images/0fbcebe225b147cd5cba1972b1611471.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UJKYdxueZocqXFwL."/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">详细查看痕迹</figcaption></figure><p id="fbc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不仅可以看到不同请求之间的时间分布，还可以看到额外的属性，比如Spring组件名和Spring控制器类名和方法。那有用！</p><h2 id="062c" class="kw js hi bd jt kx ky kz jx la lb lc kb iq ld le kf iu lf lg kj iy lh li kn lj bi translated">检测性能回归</h2><p id="bbc7" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我发现Stackdriver Trace最吸引人的地方是能够比较和对比两个不同时间段的数据。</p><p id="6c43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设您运行应用程序的1.0版一个月，明天升级到1.1版。即使是小改版升级，怎么知道有没有性能回归？在Stackdriver Trace中，只需选择两个不同的时间范围来比较延迟分布:</p><figure class="lk ll lm ln fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mj"><img src="../Images/2e771ba7ba8a844e39e8c4774a57b8e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aCSPRDfV5X4mnET6."/></div></div></figure><h1 id="7062" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">试一试</h1><p id="1392" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">如果你想试一试，你可以注册<a class="ae ku" href="https://cloud.google.com/freetrial" rel="noopener ugc nofollow" target="_blank">谷歌云平台免费试用</a>。参见<a class="ae ku" href="https://cloud.google.com/trace/docs/zipkin#how_to_configure_zipkin_tracers" rel="noopener ugc nofollow" target="_blank">将Stackdriver Trace与Zipkin </a>一起使用，了解更多使用示例和常见问题。我也想听听你的反馈和想法。</p></div></div>    
</body>
</html>