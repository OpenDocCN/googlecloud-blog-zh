<html>
<head>
<title>SFTP access to Google Cloud Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SFTP访问谷歌云存储</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/sftp-access-to-google-cloud-storage-43ffd6134b0e?source=collection_archive---------0-----------------------#2020-11-28">https://medium.com/google-cloud/sftp-access-to-google-cloud-storage-43ffd6134b0e?source=collection_archive---------0-----------------------#2020-11-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e02835eb7be15d6da0dba38827a724cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CN0t0tYYuJwWUQj1"/></div></div></figure><p id="c648" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2022–07:自从第一次发表这篇文章以来，在用于为SFTP提供GCS访问的开源领域出现了一个新的参与者。这是一个名为<a class="ae jo" href="https://github.com/drakkan/sftpgo" rel="noopener ugc nofollow" target="_blank"> SFTPGo </a>的项目。另外一篇<a class="ae jo" rel="noopener" href="/@kolban1/sftpgo-access-to-gcs-via-sftp-e203e0783f6f">文章</a>已经写好了关于结合GCS使用SFTPGo。</p><p id="f29f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谷歌云存储(GCS)为数据提供blob存储。文件可以上传到GCS，随后进行检索。这种存储价格低廉，并且具有出色的可用性和耐用性。GCS提供了各种编程语言API，可由定制应用程序使用，并且Google的许多产品都是预先构建的，用于向GCS生成数据和从GCS消费数据。命令行工具如<code class="du jp jq jr js b">gsutil</code>也提供脚本访问。如果数据可以使用存储传输产品通过web寻址，则可以自动接收数据。</p><p id="a689" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Google在开箱即用的GCS故事中提供的<em class="jt">而不是</em>是通过任何文件传输协议(FTP)访问GCS数据的能力。在本文中，我们描述了通过<a class="ae jo" href="https://en.wikipedia.org/wiki/SSH_File_Transfer_Protocol" rel="noopener ugc nofollow" target="_blank">安全文件传输协议</a> (SFTP)和相应的SFTP客户端工具访问GCS。</p><p id="1b32" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">SFTP是一种开放式规范，用于与远程文件系统交互，以在分层文件系统中存储、检索和列出文件。SFTP交换所有数据，并对飞行中的流量进行完全加密。这意味着无论你在移动什么数据，都不能通过网络进行检查。SFTP常见的公共客户包括:</p><ul class=""><li id="856a" class="ju jv hi is b it iu ix iy jb jw jf jx jj jy jn jz ka kb kc bi translated"><a class="ae jo" href="https://linux.die.net/man/1/sftp" rel="noopener ugc nofollow" target="_blank"> sftp </a> (Linux/Unix)</li><li id="d083" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><a class="ae jo" href="https://winscp.net/eng/index.php" rel="noopener ugc nofollow" target="_blank"> WinSCP </a> (Windows SFTP客户端)</li><li id="0fe3" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><a class="ae jo" href="https://filezilla-project.org/" rel="noopener ugc nofollow" target="_blank"> FileZilla </a></li><li id="0fca" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><a class="ae jo" href="https://cyberduck.io/" rel="noopener ugc nofollow" target="_blank">赛博鸭</a></li><li id="8eda" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><a class="ae jo" href="https://en.wikipedia.org/wiki/Category:SFTP_clients" rel="noopener ugc nofollow" target="_blank">其他</a> …</li></ul><p id="ea0f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">SFTP规范有一些优秀的开源库实现，这意味着我们可以编写客户端和服务器SFTP实现。其中一个库叫做<a class="ae jo" href="https://www.npmjs.com/package/ssh2" rel="noopener ugc nofollow" target="_blank"> ssh2 </a>，可用于Node.js。使用这个库，我们编写了一个示例，它将自己公开为SFTP服务器，但使用GCS作为后端存储系统。这意味着SFTP客户端可以连接到我们的SFTP服务器(我们称之为sftp-gcs)。然后根据GCS执行上传文件、获取文件、列出文件和其他文件操作的请求。从SFTP客户端的角度来看，它的行为与处理任何其他分层文件系统是一样的，区别在于数据是由GCS支持的。如果您的应用程序或工具目前希望使用SFTP处理文件数据，那么这可能是将GCS引入您的故事的一个极好的组件。</p><p id="510a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">sftp-gcs程序通过<a class="ae jo" href="https://github.com/kolban-google/sftp-gcs" rel="noopener ugc nofollow" target="_blank"> Github </a>以源代码形式提供。要使用，您需要克隆存储库并运行应用程序。因为它是用Node.js在JavaScript中实现的，所以您还需要安装<a class="ae jo" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>。安装完成后，我们使用以下工具运行应用程序:</p><pre class="ki kj kk kl fd km js kn ko aw kp bi"><span id="1074" class="kq kr hi js b fi ks kt l ku kv">node sftp-gcs.js --bucket=my-bucket</span></pre><p id="27dc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以使用一些命令行标志。仅需要<code class="du jp jq jr js b">bucket</code>。</p><ul class=""><li id="010e" class="ju jv hi is b it iu ix iy jb jw jf jx jj jy jn jz ka kb kc bi translated"><code class="du jp jq jr js b">--bucket [BUCKET_NAME]</code> —要操作的桶的名称。</li><li id="4074" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><code class="du jp jq jr js b">--port [PORT_NUMBER]</code> —服务器监听的TCP/IP端口号。默认为22。</li><li id="cb91" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><code class="du jp jq jr js b">--user [USER_NAME]</code> —用户名，如果我们希望使用用户名登录。</li><li id="f286" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><code class="du jp jq jr js b">--password [PASSWORD]</code> —如果我们希望使用用户名登录，则输入密码。</li><li id="964d" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><code class="du jp jq jr js b">--public-key-file [PUBLIC_KEY_FILE]</code> —包含用于SSH登录的公共SSH密钥的文件。</li><li id="f3fb" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><code class="du jp jq jr js b">--service-account-key-file [KEY_FILE]</code> —包含服务帐户密钥的本地文件的路径。</li><li id="0a1d" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><code class="du jp jq jr js b">--debug [DEBUG_LEVEL]</code> —开启调试。为最大调试提供“调试”。</li></ul><p id="0976" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">SFTP服务器将充当GCS存储的网关。它被设计为每个实例只允许访问一个存储桶。我们总是可以配置多个实例，其中每个实例可以被定义为使用不同的存储桶。如果对多存储桶支持有需求/兴趣，可以在以后添加。</p><p id="f233" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">作为SFTP服务器，SFTP客户端必须连接到它。这意味着它必须侦听TCP/IP端口。我们可以向端口提供<code class="du jp jq jr js b">--port</code>参数。如果没有提供，默认为22，这是SSH使用的相同端口。如果您计划使用SSH同时运行服务器，那么您可能需要提供一个备用端口。</p><p id="bf3c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">安全性是首要考虑的因素，我们必须检查安全性的两个方面。首先是可以使用什么身份来访问SFTP服务器。第二个问题是，一旦SFTP服务器被访问，向GCS出示什么身份以允许访问？</p><p id="0792" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们看看SFTP服务器访问。有三种可能性:</p><ol class=""><li id="b5c1" class="ju jv hi is b it iu ix iy jb jw jf jx jj jy jn kw ka kb kc bi translated">没有安全感。对SFTP服务器的连接请求将立即成功，没有任何挑战。通过授予SFTP服务器的GCS权限，安全性将回到到GCS的连接。</li><li id="f8ad" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn kw ka kb kc bi translated">用户标识/密码。对SFTP服务器的连接请求将导致对用户id/密码对的请求，该用户id/密码对必须与配置期间提供的相匹配。</li><li id="3637" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn kw ka kb kc bi translated">SSH键。只有当调用者拥有与配置给服务器的公钥相对应的私钥时，到SFTP服务器的连接请求才会成功。</li></ol><p id="8523" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要使用用户标识/密码安全，请提供<code class="du jp jq jr js b">--user</code>和<code class="du jp jq jr js b">--password</code>。</p><p id="03ab" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要使用基于SSH密钥的安全性，使用<code class="du jp jq jr js b">--public-key-file</code>提供一个公钥文件。</p><p id="26c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果不使用任何安全性，请不要提供<code class="du jp jq jr js b">--user</code>、<code class="du jp jq jr js b">--password</code>和<code class="du jp jq jr js b">--public-key-file</code>中的任何一个。</p><p id="bf6c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦客户端连接到SFTP服务器，上传和获取文件的请求将被发送到GCS。发出请求的身份要么是Google应用程序的默认凭证，要么是用<code class="du jp jq jr js b">--service-account-key-file</code>指定的服务帐户。应用默认凭据是在GCP计算引擎中运行或设置环境变量<code class="du jp jq jr js b">GOOGLE_APPLICATION_CREDENTIALS</code>时发现的隐式凭据环境。</p><p id="d441" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦它开始运行，我们就可以将一个符合协议的SFTP客户端连接到服务器，并开始发出SFTP命令。以下视频说明了服务器的安装和使用。</p><figure class="ki kj kk kl fd ij"><div class="bz dy l di"><div class="kx ky l"/></div></figure><h1 id="31ac" class="kz kr hi bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">问题和答案</h1><p id="5e3c" class="pw-post-body-paragraph iq ir hi is b it lw iv iw ix lx iz ja jb ly jd je jf lz jh ji jj ma jl jm jn hb bi translated"><strong class="is hj">问</strong>:我们可以在无服务器环境下运行这个解决方案吗，比如云功能或者云运行？</p><p id="85c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">答</strong>:很遗憾不能。原因是，截至2020年12月，云功能和云运行都不支持除HTTP(s)之外的任何协议。只能通过Internet接收HTTP请求进行处理。我们的SFTP解决方案使用SSH协议承载SFTP子协议请求。虽然我们可以让我们的SFTP-GCS服务器监听一个通常用于HTTP(s)的TCP端口，但这没有用。除非我们能够从无服务器请求中发现TCP协议，否则我们不会取得任何进展。查看与计算引擎相关联的托管实例组(MIG)可能会有一些好处，但我不确定这些好处是否可以减少到零。</p></div><div class="ab cl mb mc gp md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="hb hc hd he hf"><p id="6a67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">问</strong>:我如何在开机时启动恶魔？</p><p id="b8b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">答</strong>:在虚拟机启动时启动恶魔与其说是一个与<em class="jt">这个</em>恶魔相关的具体问题，不如说是一个一般性的问题。我的建议是研究一下<code class="du jp jq jr js b">systemd</code>文档，这是Linux环境中引导管理的最新故事。有很多关于为<code class="du jp jq jr js b">systemd</code>创建<em class="jt">单元</em>的好文章。</p></div><div class="ab cl mb mc gp md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="hb hc hd he hf"><h1 id="2da7" class="kz kr hi bd la lb mi ld le lf mj lh li lj mk ll lm ln ml lp lq lr mm lt lu lv bi translated">链接</h1><ul class=""><li id="62bf" class="ju jv hi is b it lw ix lx jb mn jf mo jj mp jn jz ka kb kc bi translated"><a class="ae jo" href="https://github.com/kolban-google/sftp-gcs" rel="noopener ugc nofollow" target="_blank"> Github sftp-gcs </a></li><li id="6768" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><a class="ae jo" rel="noopener" href="/google-cloud/scheduled-mirror-sync-sftp-to-gcs-b167d0eb487a">中:计划镜像/同步SFTP到GCS—2019–03</a></li><li id="f653" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><a class="ae jo" href="https://console.cloud.google.com/marketplace/product/filemage-public/filemage-gateway-linux" rel="noopener ugc nofollow" target="_blank">文件图像SFTP/FTP网关</a></li><li id="ccc2" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><a class="ae jo" href="https://console.cloud.google.com/marketplace/details/trillo-vm-prod/trillo-platform-vm" rel="noopener ugc nofollow" target="_blank"> Trillo —云存储的文件管理器和SFTP</a></li><li id="ee04" class="ju jv hi is b it kd ix ke jb kf jf kg jj kh jn jz ka kb kc bi translated"><a class="ae jo" href="https://couchdrop.io/" rel="noopener ugc nofollow" target="_blank"> Couchdrop </a></li></ul></div></div>    
</body>
</html>