<html>
<head>
<title>Multi-Cloud Analytics with BigQuery Omni : No time to load !</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用BigQuery Omni的多云分析:没有时间加载！</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/multi-cloud-analytics-with-bigquery-omni-no-time-to-load-ed187a9dcf20?source=collection_archive---------0-----------------------#2022-03-27">https://medium.com/google-cloud/multi-cloud-analytics-with-bigquery-omni-no-time-to-load-ed187a9dcf20?source=collection_archive---------0-----------------------#2022-03-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8e3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随着越来越多的组织采用多云计算战略，数据移动已经成为分析团队争论的焦点。数据蔓延和主机云提供商的出口成本是一些严重的副作用。</p><p id="67f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为客户开发多租户数据平台的独立软件供应商(ISV)发现跨多个云分布数据的场景极具挑战性。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/8fe1b21f7a7f2df9f504bb5a9ac19640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1kR-zs7dA1cA1czGA8bPpw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">BigQuery Omni报到！</figcaption></figure><p id="035d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据GCPs的核心理念，即构建一个真正开放且符合多云计算的平台，BigQuery Omni为正在实施多云计算的数据分析团队和组织注入了一剂强心针。</p><p id="3d0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">BigQuery的核心是分离存储和计算。它的本质是，通过BigQuery，工程师希望将计算带到大数据所在的位置，而不是将数据带到计算所在的位置。这是传统大规模数据仓库运作方式的一个范式转变。这实现了计算相对于存储的独立扩展，也是BigQuery提供巨大可扩展性和灵活性的关键原因之一。</p><p id="137b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">BigQuery Omni跨云环境扩展了存储与计算的解耦，使团队可以在数据驻留在亚马逊S3或Azure云Blob存储中时从BigQuery查询数据。它是由完全由Google cloud管理的Anthos集群实现的，因此团队不需要提供或管理任何额外的东西。Anthos集群运行在数据所在的同一区域，因此由于洗牌导致的延迟会进一步减少。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jt"><img src="../Images/c19e06020997d032c823ece875064fd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ky8AOkp_ohkcBNCCispgwQ.png"/></div></div></figure><p id="752a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过这种设置，传统的三步式数据管道<strong class="ih hj">定位、加载和转换</strong>流程现在简化为两步式流程，即<strong class="ih hj">定位和转换</strong>。需要制作数据的副本和编写额外的ETL管道的加载部分现在被消除了！</p><p id="0e2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">整合后的数据堆栈如下所示，使BigQuery成为满足所有分析需求的单一平台，而不管数据驻留在哪个云中。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ju"><img src="../Images/a89a01e3b8a383d710f3ae78029dd624.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AI77tn-rcKl906C_Z4-Jpg.png"/></div></div></figure><p id="ae3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">分享以下AWS S3样本数据集的完整实施步骤，</p><ol class=""><li id="1fa7" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ka kb kc kd bi translated">在AWS IAM中创建策略和角色，以启用BigQuery连接来访问S3中的文件。</li><li id="2c89" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">创建到AWS S3的BigQuery外部连接</li><li id="62d7" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">基于AWS S3中的数据从BigQuery创建外部表</li></ol><p id="5c85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们深入了解每一步的细节，</p><ol class=""><li id="f373" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ka kb kc kd bi translated"><strong class="ih hj">在AWS IAM中创建策略和角色，使BigQuery连接能够访问S3的文件</strong>。</li></ol><p id="38b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在美国东部1区的S3创建一个存储桶，并加载需要处理的数据。对于今天的演示，我们将以csv格式加载熟悉的员工和部门数据集，如这里的<a class="ae kj" href="http://www.cems.uwe.ac.uk/~pchatter/resources/html/emp_dept_data+schema.html" rel="noopener ugc nofollow" target="_blank">所示</a></p><p id="d507" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">复制S3 URIs，因为稍后在BigQuery中创建表时会用到它。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kk"><img src="../Images/a4837cadd71d08dfbff4d90b92543015.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bJT4nxhZKIUcM1I_HmBpxg.png"/></div></div></figure><p id="cc94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建策略从BigQuery中列出和获取对象，IAM &gt; Policies &gt; Create Policy，比如说<em class="kl"> bqomniread </em></p><pre class="je jf jg jh fd km kn ko kp aw kq bi"><span id="03b5" class="kr ks hi kn b fi kt ku l kv kw">{<br/>"Version": "2012-10-17",<br/>"Statement": [<br/>{<br/>  "Effect": "Allow",<br/>  "Action": ["s3:ListBucket"],<br/>  "Resource": ["arn:aws:s3:::BUCKET_NAME"]<br/>},<br/>{<br/>  "Effect": "Allow",<br/>  "Action": [<br/>    "s3:GetObject"<br/>  ],<br/>  "Resource": ["arn:aws:s3:::BUCKET_NAME/*"]<br/>}<br/>]<br/>}</span></pre><p id="4ae3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建新的角色，它将被用于从BigQuery面板连接到S3，进入IAM &gt;创建新的角色，并选择如下选项，给你的角色名称，比如说<em class="kl"> bqomniread。</em>复制已创建角色的ARN。这将在BigQuery中用于建立连接。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kx"><img src="../Images/30b1d8acae63341696be7e720237cc9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NHjABZJKTMIqIfZb86tdxg.png"/></div></div></figure><p id="5542" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2。创建一个到AWS S3的BigQuery外部连接</strong></p><p id="f4a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在将使用BigQuery外部连接选项建立从BigQuery到AWS S3的连接。</p><p id="f282" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单击添加数据&gt;外部数据源&gt;选择AWS(通过BigQuery Omni)输入我们之前在AWS角色id中创建的AWS角色的ARN详细信息。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ky"><img src="../Images/cdd69e47881a40544c3f8b1e21e58de2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UxSAv4QYzKPZMT3JeJ4wsQ.png"/></div></div></figure><p id="5484" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦创建了连接，它将出现在外部连接下面，如下所示，</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kz"><img src="../Images/108543d5a20500b9e313bffc23c25e1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mIBHNA1JWa0BF7vZl1yojg.png"/></div></div></figure><p id="302f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单击连接以获取连接详细信息，</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es la"><img src="../Images/37b34732b6159296cfbb1aca8fda0f8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s78qYOJviUrrUQ0xnnM4Eg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">BigQuery外部连接详细信息</figcaption></figure><p id="5e51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在创建的连接必须是可信的，以承担<em class="kl"> bqomni_read_only的角色。</em>要信任连接，导航到AWS IAM &gt;点击角色创建&gt;信任关系&gt;粘贴下面的json代码，用BigQuery外部连接细节中的BigQuery Google Identity值替换“Identity ID”如下所示，</p><pre class="je jf jg jh fd km kn ko kp aw kq bi"><span id="b846" class="kr ks hi kn b fi kt ku l kv kw">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Principal": {<br/>        "Federated": "accounts.google.com"<br/>      },<br/>      "Action": "sts:AssumeRoleWithWebIdentity",<br/>      "Condition": {<br/>        "StringEquals": {<br/>          "accounts.google.com:sub": "IDENTITY_ID"<br/>        }<br/>      }<br/>    }<br/>  ]<br/>}</span></pre><p id="c196" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除此之外，我们现在必须为BigQuery外部连接配置身份提供者，为此，导航到AWS IAM &gt;身份提供者&gt;输入提供者url，如下所示，并输入BigQuery Google身份(来自BigQuery外部连接)作为受众。完成后，将要求您分配角色，选择之前创建的bq_omni_read_only角色。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lb"><img src="../Images/86c9b7fdc29473a39731678ce5fcd15a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mi4kO5PBUw7ZnHfblHIFKA.png"/></div></div></figure><p id="0b43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经准备好从BigQuery控制台创建外部表。</p><p id="dcc4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3。从AWS S3 </strong>中的数据上的BigQuery创建一个外部表。</p><p id="76c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个数据集，比如说，<em class="kl"> bqomni </em>，选择地区为aws-us-east-1</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lc"><img src="../Images/0191de44aabfc7ca0dda71299bdfc063.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*scUkNtOWGyRRj88mzzWnEg.png"/></div></div></figure><p id="7a60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导航到新创建的数据集并创建新表，输入如下详细信息，然后选择自动检测模式。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ld"><img src="../Images/7933cb2ae626c9cffa5587754790366f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p2hSnHUHX0g2BhyA05UQ5A.png"/></div></div></figure><p id="a2b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可能会弹出一条错误消息，提示连接无法承担角色，如果我们是第一次创建该连接，请稍后再试。这可能是由于传播延迟，请等待一段时间，然后再次连接。这次应该能成功。</p><p id="e929" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦创建了表，您就可以在其上测试正在运行的查询，正如预期的那样，它将在右上角显示“查询将处理0B ”,因为数据是存储在BigQuery中的<em class="kl">而不是</em>。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es le"><img src="../Images/874c3b344e5ca82b143b5d9712e0e215.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BTDDUm8UfjqohjtBK4-o-w.png"/></div></div></figure><p id="6a6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们运行查询时，会遇到下面的错误，</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lf"><img src="../Images/24daa21da90c2bd1e1e4c1b7a6cdb612.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lfvxxM3RkcVsijKgvvIf7w.png"/></div></div></figure><p id="3c7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于BigQuery Omni，我们需要为查询预留100个位置。每月100个插槽的承诺最初让我失望，因为我没有查询该表，但这正是Flex插槽预留的救星。</p><p id="1b38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">购买100个Flex类型的插槽，详情如下所示。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lg"><img src="../Images/4a56eff2277ba4de059a22dea1afe5ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*alrCnV_fIHGwyGP90pGq_w.png"/></div></div></figure><p id="87c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦您进行了测试运行，并对能够连接和处理来自BigQuery的驻留在S3的数据感到兴奋，您可以回来取消这个承诺。假设您将在查询上工作大约一个小时，您将为此活动花费5美元。</p><p id="a1e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦创建了槽，下一步就是为创建了<em class="kl"> bqomni </em>数据集的项目保留它们，</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lh"><img src="../Images/c270d873b79ed36ec31068124e0de08d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XnhaA3LT97yLXMllL_fJUA.png"/></div></div></figure><p id="03d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在reservation选项卡下，单击slots created行并选择Create assignment，在下拉列表中选择创建<em class="kl"> bqomni </em>的项目。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es li"><img src="../Images/74efb87a6e91a00c549d2ab2066d4307.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l_xCjwxsgvZQc_oENPzlVQ.png"/></div></div></figure><p id="c150" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦创建了分配，您可以看到如下所示的分配，</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lj"><img src="../Images/2455d361bab63c4ef431c3492a402f16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rhTudyI-iDjj559zxhSGiQ.png"/></div></div></figure><p id="83b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经准备好查询我们的外部表了！</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lk"><img src="../Images/ab684aa4c772beef00152013cb1c8dd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eEwF8MRx1_XPmZztzeWekw.png"/></div></div></figure><p id="a007" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您也可以用类似的方式创建employee表，然后将employee表和department表连接起来，得到两个数据位于S3的表的输出，</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ll"><img src="../Images/09cbfe3135207be5d5c33d477f1ebb84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vIkWroIvhgB5ITbSfsfT8g.png"/></div></div></figure><p id="fb3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在S3加载一些更大的数据集，并检查这个联邦查询的性能。正如预期的那样，这比数据驻留在BigQuery或GCP平台上要低一些。然而，它在可比较的范围内，对于生产工作负载来说当然值得实施。</p><p id="37ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你完成测试，<em class="kl">不要忘记取消预订和你用flex类型创建的插槽！</em></p><p id="f266" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在生产场景中，如果您没有统一费率预留类型，并且如果您有几个联合管道要开始，那么灵活插槽是开始的最佳方式。</p><p id="e562" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设您有一个类似Cloud Composer(managed Apache air flow)的编排工具，下面是如何以自动化的方式实现上述管道，</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lm"><img src="../Images/ac0cf9a865a2dbf77fac4c7b6caa2d00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uye3dqtgsRNhmfKWN-0Wng.png"/></div></div></figure><p id="898f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于驻留在Azure blob存储中的数据，也可以进行类似的实现。</p><p id="2616" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以在这些外部表上创建Looker和BigQuery ML模型，这与在内部表上启用它的方式非常相似。这使得BQ Omni对现有的BigQuery用户来说更加强大！</p></div></div>    
</body>
</html>