<html>
<head>
<title>BigQuery Sensor in Composer/User defined sensor implementation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Composer/ç”¨æˆ·å®šä¹‰çš„ä¼ æ„Ÿå™¨å®ç°ä¸­çš„BigQueryä¼ æ„Ÿå™¨</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/google-cloud/bigquery-sensor-in-composer-b526c9a91c26?source=collection_archive---------1-----------------------#2022-12-16">https://medium.com/google-cloud/bigquery-sensor-in-composer-b526c9a91c26?source=collection_archive---------1-----------------------#2022-12-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="660c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">æƒ³è¦åœ¨æºæ•°æ®åº“åˆ·æ–°å’Œç›®æ ‡æ•°æ®åº“åŠ è½½ä½œä¸šä¹‹é—´åˆ›å»ºä¾èµ–å…³ç³»å—ï¼Ÿ</p><p id="b27f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">æƒ³è®©OLAPåŠ è½½ä½œä¸šä¸€ç›´ç­‰åˆ°æºOLTPç³»ç»Ÿæ›´æ–°å—ï¼Ÿç»§ç»­ä¸‹å»ï¼Œçœ‹çœ‹è¿™ä¸ªæ•™ç¨‹ã€‚</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/c5cb799fbd750f21b4681c55f5726d21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PZanVJM_L982D9YLlabkrw.png"/></div></div></figure></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><p id="7496" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">å‡†å¤‡:</strong>å¯é‡ç”¨æ€§ã€åšå®¢ã€ç¤¾åŒºè´¡çŒ®</p><p id="be6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">å‡è®¾</strong></p><p id="8449" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">æœ¬æ•™ç¨‹å‡è®¾æ‚¨ç†Ÿæ‚‰:</p><ul class=""><li id="60c8" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kb kc kd ke bi translated">Composerï¼ŒBigQueryï¼ŒPython</li></ul><h1 id="2f2b" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">ç¤ºä¾‹ä½¿ç”¨æ¡ˆä¾‹:</h1><p id="9cb9" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">åªæœ‰åœ¨æŒ‡å®šçš„æ—¶é—´èŒƒå›´(å¯ä¿®æ”¹)å†…æ›´æ–°æºè¡¨æ—¶ï¼Œæ‰åº”è¯¥æ‰§è¡Œä¸€äº›ä¸‹æ¸¸ä»»åŠ¡ã€‚</p><p id="a975" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">æºé¡¹ç›®é™åˆ¶äº†å…ƒæ•°æ®æŸ¥çœ‹å™¨æƒé™ï¼Œå®ƒå¯ä»¥é€šè¿‡APIè°ƒç”¨ï¼Œä½†æ˜¯å®ƒä»¬é™åˆ¶äº†é€šè¿‡Information_schemaæŸ¥è¯¢å…ƒæ•°æ®ã€‚</p><p id="fc5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">è®®ç¨‹æ˜¯é€šè¿‡bigquery APIæ£€æŸ¥è¡¨çš„lastmodifiedtimeï¼Œå¦‚æœè¡¨æ²¡æœ‰åœ¨æŒ‡å®šçš„èŒƒå›´å†…æ›´æ–°ï¼Œåˆ™é‡æ–°è°ƒåº¦DAGã€‚</p><p id="8f99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">pokeæ–¹æ³•å°†åœ¨ä¸Šè¿°æ—¶é—´é—´éš”åé‡è¯•ï¼Œå¹¶åœ¨æºè¡¨æ›´æ–°æ—¶è‡ªåŠ¨æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</p><p id="140f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ä¸éœ€è¦äººå·¥å¹²é¢„ã€‚</p><p id="34c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ä¸éœ€è¦åœ¨å›ºå®šçš„æ—¶é—´é—´éš”å®‰æ’DAGæ¥æ£€æŸ¥è¿™ä¸€ç‚¹ã€‚</p><p id="8b93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">åœºæ™¯:</strong>æœ‰ä¸€ä¸ªOLTPæºè¡¨â€˜OLTP _ customerâ€™ã€‚æœ‰ä¸€ä¸ªOLAPç›®æ ‡è¡¨dim_customerã€‚åªæœ‰å½“æºè¡¨åœ¨è¿™ä¸€å°æ—¶å†…è¢«ä¿®æ”¹æ—¶ï¼Œä¸‹ä¸€ä¸ªä»æºè¡¨åŠ è½½ç»´åº¦è¡¨çš„ä»»åŠ¡æ‰ä¼šæ‰§è¡Œã€‚åœ¨ä¿®æ”¹æºè¡¨ä¹‹å‰ï¼Œä»»åŠ¡å°†ç»§ç»­è¢«é‡æ–°è°ƒåº¦ã€‚</p><p id="525c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">å¤©ç©ºé¢œè‰²è¡¨ç¤ºé‡æ–°è®¡åˆ’çš„çŠ¶æ€ã€‚æ¯å½“æ›´æ–°æºè¡¨æ—¶ï¼ŒDAGéƒ½ä¼šè‡ªåŠ¨å¼€å§‹è¿è¡Œä»¥ä¸‹ä»»åŠ¡å¹¶å®Œæˆè¯¥è¿‡ç¨‹</p><h1 id="9dd5" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated"><strong class="ak">è§£å†³æ–¹æ¡ˆ:</strong></h1><h2 id="8d96" class="li kg hi bd kh lj lk ll kl lm ln lo kp iq lp lq kt iu lr ls kx iy lt lu lb lv bi translated">ä»‹ç»</h2><p id="fc93" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">æ°”æµä¼ æ„Ÿå™¨å…è®¸æ‚¨æ£€æŸ¥æ˜¯å¦æ»¡è¶³å®Œæˆæ ‡å‡†ã€‚</p><p id="ae37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Bigquery Sensorå¯ä»¥ä½œä¸ºæ°”æµæ’ä»¶åˆ›å»ºï¼Œå¹¶å¯ä»¥ä½œä¸ºpythonæ¨¡å—å¯¼å…¥åˆ°æ°”æµDAGä¸­ã€‚</p><p id="863b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">è¯¥è§£å†³æ–¹æ¡ˆåŸºäºä¸€ä¸ªåŸºäºBigQueryå®¢æˆ·ç«¯çš„ç”¨æˆ·è‡ªå®šä¹‰ä¼ æ„Ÿå™¨ã€‚</p><p id="34de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Airflowæœ‰ä¸€ä¸ªç®€å•çš„å†…ç½®æ’ä»¶ç®¡ç†å™¨ï¼Œå¯ä»¥é€šè¿‡ç®€å•åœ°å°†æ–‡ä»¶æ”¾å…¥$AIRFLOW_HOME/pluginsæ–‡ä»¶å¤¹ä¸­ï¼Œå°†å¤–éƒ¨åŠŸèƒ½é›†æˆåˆ°å…¶æ ¸å¿ƒä¸­ã€‚</p><p id="aa27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">æ’ä»¶æ–‡ä»¶å¤¹ä¸­çš„pythonæ¨¡å—è¢«å¯¼å…¥ï¼Œå®å’Œwebè§†å›¾è¢«é›†æˆåˆ°Airflowçš„ä¸»é›†åˆä¸­ï¼Œå¯ä¾›ä½¿ç”¨ã€‚</p><h2 id="622c" class="li kg hi bd kh lj lk ll kl lm ln lo kp iq lp lq kt iu lr ls kx iy lt lu lb lv bi translated">å»ºç­‘/è®¾è®¡:</h2><p id="3856" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated"><strong class="ih hj">æ­¥éª¤1: </strong>å½“æºè¡¨åœ¨æœ€åä¸€ä¸ªå°æ—¶æ²¡æœ‰è¢«ä¿®æ”¹æ—¶ã€‚DAGå·²å¯åŠ¨ï¼Œå®ƒæ£€æŸ¥åˆ°æºè¡¨æœªæ›´æ–°ï¼Œå› æ­¤å®ƒé‡æ–°è®¡åˆ’äº†DAGã€‚ä»»åŠ¡IsModifiedSourceæ˜¯å¤©ç©ºé¢œè‰²ï¼Œè¿™æ„å‘³ç€å®ƒå¤„äºé‡æ–°è®¡åˆ’çŠ¶æ€ã€‚</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lw"><img src="../Images/901824d1bac13b506dd3b5ade6a68bc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Hya7CqEpeI9zIVq-"/></div></div></figure><p id="adf7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">ç¬¬äºŒæ­¥:</strong>ä¿®æ”¹æºè¡¨ã€‚æ’å…¥ä¸€æ¡è®°å½•</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lx"><img src="../Images/a11ff58f54b2a7f8035bf9ee1be91522.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YxVLoypS8ZJYGC0f"/></div></div></figure><p id="1764" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">æ­¥éª¤3: </strong>é‡æ–°è°ƒåº¦çš„ä»»åŠ¡â€œIsSourceModifiedâ€å¼€å§‹è¿è¡Œï¼Œä¼ æ„Ÿå™¨è„šæœ¬åœ¨æ¯ä¸ªpoke_intervalä¹‹åæ£€æŸ¥è¡¨ä¿®æ”¹æ—¶é—´ï¼Œåªè¦ä¸å½“å‰å°æ—¶ç›¸åŒ¹é…ï¼Œå°±æ‰§è¡Œè¯¥ä»»åŠ¡</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lw"><img src="../Images/d07dbb74f0b27c8068468c67240d0ac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OOQVJu23ki6kmX9U"/></div></div></figure><p id="1d71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">æ­¥éª¤4:</strong>DAGå®Œæˆï¼Œç»´åº¦è¡¨ä»oltpæºè¡¨åŠ è½½</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lw"><img src="../Images/6b0a50d3c605347aaca062ef35d6063d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0Uqc9BNDPcRF_twL"/></div></div></figure><h2 id="c635" class="li kg hi bd kh lj lk ll kl lm ln lo kp iq lp lq kt iu lr ls kx iy lt lu lb lv bi translated">ä½¿ç”¨æ°”æµä¼ æ„Ÿå™¨çš„å¥½å¤„:</h2><p id="6c72" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">ä¼ æ„Ÿå™¨æ˜¯ä¸€ä¸ªæ“ä½œå‘˜<strong class="ih hj">åœ¨ä¸€æ®µæ—¶é—´é—´éš”å†…è¯„ä¼°æ˜¯å¦ç¬¦åˆæ ‡å‡†/æ¡ä»¶ã€‚</strong>å¦‚æœæ˜¯ï¼Œåˆ™æˆåŠŸï¼Œå¦åˆ™é‡è¯•ï¼Œç›´åˆ°è¶…æ—¶ã€‚</p><p id="6dd8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">æ°”æµä¼šå¸¦æ¥ä¸åŒçš„ä¼ æ„Ÿå™¨ï¼Œä»¥ä¸‹æ˜¯æœ€å¸¸ç”¨çš„ä¸€äº›ä¼ æ„Ÿå™¨:</p><ul class=""><li id="4fd5" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kb kc kd ke bi translated"><em class="ly">æ–‡ä»¶ä¼ æ„Ÿå™¨</em>:ç­‰å¾…æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹è¿›å…¥æ–‡ä»¶ç³»ç»Ÿã€‚</li><li id="7b39" class="jw jx hi ih b ii lz im ma iq mb iu mc iy md jc kb kc kd ke bi translated"><em class="ly">s3key sensor</em>:ç­‰å¾…ä¸€æŠŠé’¥åŒ™å‡ºç°åœ¨S3æ¡¶é‡Œã€‚</li><li id="6b76" class="jw jx hi ih b ii lz im ma iq mb iu mc iy md jc kb kc kd ke bi translated">SqlSensor :é‡å¤è¿è¡Œä¸€æ¡sqlè¯­å¥ï¼Œç›´åˆ°æ»¡è¶³ä¸€ä¸ªæ ‡å‡†ã€‚</li><li id="d588" class="jw jx hi ih b ii lz im ma iq mb iu mc iy md jc kb kc kd ke bi translated">HivePartitionSensor :ç­‰å¾…ä¸€ä¸ªåˆ†åŒºå‡ºç°åœ¨Hiveä¸­ã€‚</li><li id="9430" class="jw jx hi ih b ii lz im ma iq mb iu mc iy md jc kb kc kd ke bi translated"><em class="ly">ExternalTaskSensor</em>:ç­‰å¾…ä¸åŒDAGæˆ–ä¸åŒDAGä¸­çš„ä»»åŠ¡åœ¨ç‰¹å®šæ‰§è¡Œæ—¥æœŸå®Œæˆã€‚(æŒºæœ‰ç”¨çš„é‚£ä¸ªğŸ¤“)</li><li id="70ed" class="jw jx hi ih b ii lz im ma iq mb iu mc iy md jc kb kc kd ke bi translated"><em class="ly">datetime sensor</em>:ç­‰å¾…æŒ‡å®šçš„æ—¥æœŸæ—¶é—´(ç”¨äºä¸ºæ‚¨çš„Dagæ·»åŠ ä¸€äº›å»¶è¿Ÿ)</li></ul><h2 id="fa3c" class="li kg hi bd kh lj lk ll kl lm ln lo kp iq lp lq kt iu lr ls kx iy lt lu lb lv bi translated">æ ¹æ®ä¸šåŠ¡é€»è¾‘åˆ›å»ºç”¨æˆ·å®šä¹‰ä¼ æ„Ÿå™¨ï¼Œå³BigQueryä¼ æ„Ÿå™¨:</h2><p id="db61" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">æˆ‘ä»¬è¿˜å¯ä»¥æ ¹æ®æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘åˆ›å»ºå®šåˆ¶çš„ä¼ æ„Ÿå™¨ã€‚</p><p id="0338" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">è¯¥èµ„äº§åŸºäºç”¨æˆ·å®šä¹‰çš„ä¼ æ„Ÿå™¨ï¼Œè¯¥ä¼ æ„Ÿå™¨åŸºäºBigQueryå®¢æˆ·ç«¯è¡¨ModifiedTimeã€‚æˆ‘ä»¬å¯ä»¥åœ¨å¤šä¸ªDagä¸­é‡ç”¨åŒä¸€ä¸ªä¼ æ„Ÿå™¨æ¥æ£€æŸ¥è¿™äº›å…ˆå†³æ¡ä»¶ã€‚æ­¤å¤–ï¼Œé€šè¿‡ä½¿ç”¨è¯¥è„šæœ¬ä½œä¸ºæ¨¡æ¿ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åˆ›å»ºå…·æœ‰ä¸åŒä¸šåŠ¡é€»è¾‘çš„ä¸åŒBigQueryä¼ æ„Ÿå™¨ã€‚</p><ul class=""><li id="f829" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kb kc kd ke bi translated">è¿™ä¸ªä¾‹å­åŒ…æ‹¬å¦‚ä½•ä»BigQuery APIè®¿é—®å…ƒæ•°æ®ä¿¡æ¯</li><li id="5559" class="jw jx hi ih b ii lz im ma iq mb iu mc iy md jc kb kc kd ke bi translated">è¯¥ç¤ºä¾‹è¿˜åŒ…æ‹¬ä½¿ç”¨Google Secret Manageræ¥ä¿æŠ¤æœåŠ¡å¸æˆ·å‡­è¯ã€‚</li></ul><h2 id="ff0b" class="li kg hi bd kh lj lk ll kl lm ln lo kp iq lp lq kt iu lr ls kx iy lt lu lb lv bi translated">è„šæœ¬:</h2><p id="37bd" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated"><strong class="ih hj">1)bigquerytablemodified sensor . py</strong></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lw"><img src="../Images/8afb5561de01c251124511b8e630945b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8Cbq9hYRJedck9-D"/></div></div></figure><pre class="je jf jg jh fd me mf mg bn mh mi bi"><span id="6033" class="mj kg hi mf b be mk ml l mm mn">"""This module contains a Google Bigquery SQL sensor."""<br/>from typing import Optional, Sequence, Union<br/>from airflow.hooks import BaseHook<br/>from airflow.sensors import BaseSensorOperator<br/>from airflow.exceptions import AirflowException<br/>import datetime<br/>from google.cloud import bigquery<br/>from google.oauth2 import service_account<br/>from google.cloud import secretmanager<br/>import pendulum<br/>import logging<br/>import json<br/>class BigQueryTableModifiedSensor(BaseSensorOperator):<br/>"""<br/>Checks for the True or False output in Google Bigquery Query Job output.<br/>:param sql: The query to return True or False as Final output<br/>:type sql: str<br/>:param use_legacy_sql: Option to run legacy SQL<br/>:type use_legacy_sql: Boolean<br/>:param bigquery_conn_id: The connection ID to use when connecting to<br/>Google BigQuery.<br/>:type bigquery_conn_id: str<br/>"""<br/>template_fields = (<br/>'sql',<br/>'use_legacy_sql',<br/>'bigquery_conn_id',<br/>'full_table_identifier',<br/>'secret_manager_project_name',<br/>'secret_name'<br/>)<br/>ui_color = '#f0eee2'<br/># accept table identifiers from main DAG<br/>def __init__(self,*,bigquery_conn_id: str = 'google_cloud_default',<br/>use_legacy_sql: bool = False,sql: str = None,full_table_identifier,secret_manager_project_name,secret_name,**kwargs) -&gt; None:<br/>super().__init__(**kwargs)<br/>self.bigquery_conn_id = bigquery_conn_id<br/>self.sql = None<br/>self.use_legacy_sql = use_legacy_sql<br/>self.full_table_identifier=full_table_identifier<br/>self.secret_manager_project_name=secret_manager_project_name<br/>self.secret_name=secret_name<br/>def access_secret_version(self,project_id, secret_id, version_id):<br/># Create the Secret Manager client.<br/>client = secretmanager.SecretManagerServiceClient()<br/># Build the resource name of the secret version.<br/>name = f"projects/{project_id}/secrets/{secret_id}/versions/{version_id}"<br/>logging.info(name)<br/>logging.info("inside get_table_modified before accessing")<br/># Access the secret version.<br/>response = client.access_secret_version(name)<br/>payload = response.payload.data.decode("UTF-8")<br/>#logging.info(payload)<br/>return payload<br/>def poke(self,context: dict) -&gt; bool:<br/>full_table_identifier=self.full_table_identifier<br/>secret_manager_project_name=self.secret_manager_project_name<br/>secret_name=self.secret_name<br/>key_content=self.access_secret_version(secret_manager_project_name,<br/>secret_name,"1")<br/>service_account_info = json.loads(key_content,strict=False)<br/>logging.info("returned from gsm function")<br/>logging.info(service_account_info)<br/>credentials=<br/>service_account.Credentials.from_service_account_info(service_account_info)<br/>client = bigquery.Client(credentials=credentials,project=credentials.project_id)<br/>table = client.get_table(full_table_identifier)<br/>logging.info(table.modified)<br/>logging.info(table.modified.date())<br/>logging.info(table.modified.hour)<br/>if table.modified.hour == datetime.datetime.now().hour:<br/>logging.info("IsModifiedThisHour TRUE")<br/>else:<br/>logging.info("IsModifiedThisHour False")<br/>return table.modified.hour == datetime.datetime.now().hour</span></pre><p id="3991" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2)æ ·æœ¬DAGä½¿ç”¨æ°”æµæ’ä»¶ä½œä¸ºç”¨æˆ·å®šä¹‰çš„ä¼ æ„Ÿå™¨</strong></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lw"><img src="../Images/cb3b6b4d17ec242a6a0d4a20ab744814.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xAry5q7HWo1q76lf"/></div></div></figure><pre class="je jf jg jh fd me mf mg bn mh mi bi"><span id="88ab" class="mj kg hi mf b be mk ml l mm mn">from sensors.BigQueryTableModifiedSensor import BigQueryTableModifiedSensor<br/>import os<br/>import json<br/>import datetime<br/>import airflow<br/>from airflow import DAG<br/>from airflow import models<br/>from airflow.models import Variable<br/>from airflow.operators import DummyOperator<br/>from airflow.operators import BashOperator<br/>from airflow.contrib.operators import bigquery_to_bigquery<br/>from airflow.contrib.operators import bigquery_to_gcs<br/>from airflow.contrib.operators import gcs_to_bq<br/>from airflow.contrib.operators import bigquery_operator<br/>from airflow.providers.google.cloud.operators.bigquery import BigQueryExecuteQueryOperator<br/>import datetime<br/>from google.cloud import bigquery<br/>from google.oauth2 import service_account<br/>from google.cloud import secretmanager<br/>import pendulum<br/>import logging<br/>import re<br/>from airflow.contrib.operators.bigquery_operator import BigQueryOperator<br/>from airflow.providers.google.cloud.operators.bigquery import BigQueryInsertJobOperator<br/>from airflow.contrib.operators.gcs_list_operator import GoogleCloudStorageListOperator<br/>from airflow.contrib.operators.gcs_to_gcs import GoogleCloudStorageToGoogleCloudStorageOperator<br/>from google.cloud import storage<br/>from airflow.providers.google.cloud.operators.bigquery import BigQueryExecuteQueryOperator<br/>from airflow.operators import DummyOperator<br/>from airflow.operators.python_operator import PythonOperator<br/>logger = logging.getLogger("airflow.task")<br/>local_tz = pendulum.timezone("Europe/Amsterdam")<br/>secret_manager_project_name=Variable.get('secret_manager_project')<br/>secret_name=Variable.get('secret_name')<br/>project_name=Variable.get('project_name')<br/>dataset_name=Variable.get('dataset_name')<br/>source_table_name=Variable.get('source_table_name')<br/>full_table_identifier=project_name+'.'+dataset_name+'.'+source_table_name<br/>target_table_name=Variable.get('target_table_name')<br/>#Default args for the DAG execution<br/>default_args = {<br/>'email_on_failure': True,<br/>'email_on_retry': False<br/>}<br/>#DAG initialization<br/>#DAG initialization<br/>with airflow.DAG(<br/>'load_oltp_table_to_dimension_table',<br/>start_date=datetime.datetime(2021, 1, 1),<br/>schedule_interval=None) as dag:<br/>logging.info("inside DAG")<br/>start = DummyOperator(<br/>task_id='start',<br/>dag=dag)<br/>finish = DummyOperator(<br/>task_id='finish',<br/>dag=dag)<br/>check_precondition = BigQueryTableModifiedSensor(<br/>task_id ='IsSourceModified',<br/>bigquery_conn_id = 'bigquery_default',<br/>use_legacy_sql = False,<br/>sql = None,<br/>full_table_identifier=full_table_identifier,<br/>secret_manager_project_name=secret_manager_project_name,<br/>secret_name=secret_name,<br/>poke_interval = 60,<br/>timeout = 3600,<br/>mode = 'reschedule',<br/>dag=dag<br/>)<br/>run_new_job = BigQueryOperator(<br/>task_id='RunLoadJobWhenSourceModified',<br/>sql='insert into `'+project_name+'.'+dataset_name+'.'+target_table_name+'` select generate_uuid(),c.customer_id,c.customer_name,c.customer_city,current_timestamp(),null,"Yes" from `'+project_name+'.'+dataset_name+'.'+source_table_name+'` c;',<br/>use_legacy_sql=False,<br/>bigquery_conn_id='bigquery_default',<br/>dag=dag)<br/>start&gt;&gt;check_precondition&gt;&gt;run_new_job&gt;&gt;finish</span></pre><h1 id="e6b1" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">ä¼ æ„Ÿå™¨è„šæœ¬çš„è§£é‡Š:</h1><p id="1231" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">æ‰€æœ‰ä¼ æ„Ÿå™¨éƒ½ç»§æ‰¿è‡ªBaseSensorOperatorï¼Œå¹¶å…·æœ‰ä»¥ä¸‹å‚æ•°:</p><ul class=""><li id="7831" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kb kc kd ke bi translated">æ¨¡å¼:ä¼ æ„Ÿå™¨å¦‚ä½•å·¥ä½œã€‚æœ‰ä¸¤ç§æ¨¡å¼:</li><li id="888e" class="jw jx hi ih b ii lz im ma iq mb iu mc iy md jc kb kc kd ke bi translated">æˆ³:è¿™æ˜¯é»˜è®¤æ¨¡å¼ã€‚ä½¿ç”¨pokeæ—¶ï¼Œä¼ æ„Ÿå™¨ä¼šåœ¨æ•´ä¸ªæ‰§è¡Œæ—¶é—´å†…å ç”¨ä¸€ä¸ªå·¥ä½œæ’æ§½ï¼Œå¹¶åœ¨ä¸¤æ¬¡pokeä¹‹é—´ä¼‘çœ ã€‚</li><li id="302e" class="jw jx hi ih b ii lz im ma iq mb iu mc iy md jc kb kc kd ke bi translated">é‡æ–°å®‰æ’:å¦‚æœä¸ç¬¦åˆæ ‡å‡†ï¼Œä¼ æ„Ÿå™¨å°†é‡Šæ”¾å…¶å·¥ä½œæ’æ§½ï¼Œå¹¶é‡æ–°å®‰æ’ä¸‹æ¬¡æ£€æŸ¥æ—¶é—´ã€‚</li><li id="00b3" class="jw jx hi ih b ii lz im ma iq mb iu mc iy md jc kb kc kd ke bi translated">poke_interval:ä½¿ç”¨pokeæ¨¡å¼æ—¶ï¼Œè¿™æ˜¯ä¼ æ„Ÿå™¨åœ¨å†æ¬¡æ£€æŸ¥æ¡ä»¶ä¹‹å‰ç­‰å¾…çš„æ—¶é—´(ç§’)ã€‚é»˜è®¤å€¼ä¸º30ç§’ã€‚</li><li id="ab0a" class="jw jx hi ih b ii lz im ma iq mb iu mc iy md jc kb kc kd ke bi translated">è¶…æ—¶:ä¼ æ„Ÿå™¨æ£€æŸ¥çŠ¶å†µçš„æœ€é•¿æ—¶é—´(ç§’)ã€‚å¦‚æœè¾¾åˆ°è¯¥æ—¶é—´æ—¶è¿˜æ²¡æœ‰æ»¡è¶³æ¡ä»¶ï¼Œåˆ™ä»»åŠ¡å¤±è´¥ã€‚</li></ul><p id="a5cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">æ ¹æ®ç»™å®šçš„ä¸šåŠ¡é€»è¾‘ï¼Œå¯ä»¥åœ¨ä¼ æ„Ÿå™¨ç±»çš„__init__æ–¹æ³•ä¸­ä¼ é€’å¯å˜æ•°é‡çš„å‚æ•°ã€‚</p><p id="d79c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ç„¶åï¼Œå¯ä»¥ä»ä»»ä½•DAGè°ƒç”¨ä¼ æ„Ÿå™¨æ¥æ£€æŸ¥æ˜¯å¦æ»¡è¶³å‰ææ¡ä»¶ã€‚</p><pre class="je jf jg jh fd me mf mg bn mh mi bi"><span id="8117" class="mj kg hi mf b be mk ml l mm mn">check_precondition = BigQueryTableModifiedSensor(<br/>task_id ='IsSourceModified',<br/>bigquery_conn_id = 'bigquery_default',<br/>use_legacy_sql = False,<br/>sql = None,<br/>full_table_identifier=full_table_identifier,<br/>secret_manager_project_name=secret_manager_project_name,<br/>secret_name=secret_name, - - - Only needed if you use Google Secret Manager<br/>poke_interval = 60,<br/>timeout = 3600,<br/>mode = 'reschedule',<br/>dag=dag<br/>)</span></pre><h1 id="297b" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">å¦‚ä½•åœ¨DAGä¸­ä½¿ç”¨BigQueryä¼ æ„Ÿå™¨è„šæœ¬</h1><p id="99ef" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">ä½¿ç”¨ç¬¬ä¸€ä¸ªè„šæœ¬bigquerytablemodifiedssensor . pyåˆ›å»ºä¼ æ„Ÿå™¨ã€‚</p><p id="641d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">æ ¹æ®ä¸šåŠ¡é€»è¾‘ä¿®æ”¹è„šæœ¬ã€‚</p><p id="bcc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">å°†è„šæœ¬æ–‡ä»¶æ”¾åœ¨æ°”æµç¯å¢ƒçš„ä»¥ä¸‹è·¯å¾„ä¸­</p><p id="f2a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">æ°”æµ-ç¯å¢ƒ-æ¡¶/æ’ä»¶/ä¼ æ„Ÿå™¨/bigquerytablemodified sensor<strong class="ih hj">ã€‚</strong> py</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lw"><img src="../Images/57e6ca5a28932deb936a4c8d46d21c08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pdeOdHhW5vtp8m27"/></div></div></figure><p id="8c42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">å°†BigQueryTableModifiedSensoræ¨¡å—å¯¼å…¥åˆ°æ‚¨æƒ³è¦ä½¿ç”¨å®ƒçš„DAGä¸­ã€‚</p></div></div>    
</body>
</html>