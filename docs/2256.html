<html>
<head>
<title>Schedule GCP STS Transfer Job with Cloud Composer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Cloud Composer计划GCP STS传输作业</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/schedule-gcp-sts-transfer-job-with-cloud-composer-2aa947fb1948?source=collection_archive---------1-----------------------#2022-07-09">https://medium.com/google-cloud/schedule-gcp-sts-transfer-job-with-cloud-composer-2aa947fb1948?source=collection_archive---------1-----------------------#2022-07-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e102" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">存储传输服务可用于将数据从本地存储系统传输到GCS存储桶。它提供了许多有用的功能，如一次性和定期传输，数据完整性检查，元数据保存等。</p><p id="5f84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">存储传输服务目前支持一小时作为最小计划频率。如果需要以分钟级别的频率进行调度，那么我们需要使用云调度器和云合成器等调度工具。我的同事<a class="ae jd" rel="noopener" href="/@bambang20">bam bang Satrijotomo</a><strong class="ih hj"/>写了一篇非常好的<a class="ae jd" rel="noopener" href="/@bambang20/schedule-google-cloud-sts-transfer-job-with-cloud-scheduler-7e25e9943e4e">文章</a>介绍如何使用云调度器调度STS作业。云调度程序使用起来更简单，但是目前它还不支持像VPC SC这样的功能。如果用户环境中已经使用了Cloud Composer，则建议使用Cloud Composer。</p><p id="bc94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将实现一个cloud composer dag，它将运行STS传输作业。我们将安排此dag每十分钟运行一次。</p><h1 id="5b91" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated"><strong class="ak">先决条件</strong></h1><ol class=""><li id="b65c" class="kc kd hi ih b ii ke im kf iq kg iu kh iy ki jc kj kk kl km bi translated">用户已经部署了Cloud Composer环境，并且能够计划他/她的Dag。</li><li id="ca2d" class="kc kd hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated">用户有一个现有的正在运行的STS作业，需要定期运行。</li><li id="c278" class="kc kd hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated">获取composer工作节点使用的服务帐户。用户可以执行下面的gcloud命令来获得相同的结果:</li></ol><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="251f" class="lb jf hi kx b fi lc ld l le lf">gcloud composer environments describe &lt;composer_env_name&gt; --location &lt;region&gt; --project &lt;composer_env_project_id&gt; --format json | jq '.config.nodeConfig.serviceAccount'</span></pre><p id="b4c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.获取composer存储其Dag的GCS位置。用户可以执行下面的gcloud命令来获得相同的结果:</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="0ac2" class="lb jf hi kx b fi lc ld l le lf">gcloud composer environments describe &lt;composer_env_name&gt; --location &lt;region&gt; --project &lt;composer_env_project_id&gt; --format json | jq '.config.dagGcsPrefix'</span></pre><p id="b4ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.将存储传输用户角色分配给composer worker服务帐户。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="9ea0" class="lb jf hi kx b fi lc ld l le lf">gcloud projects add-iam-policy-binding &lt;sts_job_project_id&gt; --member='serviceAccount:&lt;composer_worker_sa_email&gt;' --role="roles/storagetransfer.user"</span></pre><h1 id="c45f" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">Dag详细信息</h1><p id="2f9f" class="pw-post-body-paragraph if ig hi ih b ii ke ik il im kf io ip iq lg is it iu lh iw ix iy li ja jb jc hb bi translated">使用下面的代码创建一个DAG。根据您的环境替换项目ID和TSOP作业名称变量的值。我计划每10分钟运行一次dag，用户可以根据自己的需要选择这个时间间隔。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="54fb" class="lb jf hi kx b fi lc ld l le lf">import datetime<br/>import logging<br/>import time<br/><br/>from airflow import models, utils as airflow_utils<br/>from airflow.models import BaseOperator<br/>from airflow.utils.decorators import apply_defaults<br/>import googleapiclient.discovery<br/>from oauth2client.client import GoogleCredentials<br/><br/><br/><br/>PROJECT_ID = &lt;sts_job_project_id&gt;<br/>TSOP_JOB_NAME = &lt;transfer_job_name&gt;<br/><br/>DEFAULT_ARGS = {<br/>    'owner': 'airflow',<br/>    'start_date': airflow_utils.dates.days_ago(7),<br/>}<br/><br/><br/>class TSOPJobRunOperator(BaseOperator):<br/>  """Runs the TSOP job."""<br/><br/>  @apply_defaults<br/>  def __init__(self, project, job_name,  *args, **kwargs):<br/>    self._tsop = None<br/>    self.project = project<br/>    self.job_name = job_name<br/>    super(TSOPJobRunOperator, self).__init__(*args, **kwargs)<br/><br/>  def get_tsop_api_client(self):<br/>    if self._tsop is None:<br/>      credentials = GoogleCredentials.get_application_default()<br/>      self._tsop = googleapiclient.discovery.build(<br/>        'storagetransfer', 'v1', cache_discovery=False,       <br/>        credentials=credentials)<br/>    return self._tsop<br/><br/>  def execute(self, context):<br/>    logging.info('Running Job %s in project %s',<br/>                 self.job_name, self.project)<br/>    self.get_tsop_api_client().transferJobs().run(<br/>      jobName=self.job_name,<br/>      body={'project_id': self.project}).execute()<br/><br/>with models.DAG(<br/>    "run_tsop_transfer_job",<br/>    default_args=DEFAULT_ARGS,<br/>    schedule_interval=<!-- -->'*/10 * * * *'<br/>    tags=["tsop_job"],<br/>    user_defined_macros={"TSOP_JOB_NAME": TSOP_JOB_NAME},<br/>) as dag:<br/>    run_tsop_job = TSOPJobRunOperator(<br/>        project=PROJECT_ID, job_name=TSOP_JOB_NAME, <br/>        task_id='run_tsop_job')</span></pre><p id="304a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将dag上传到composer dags存储桶文件夹。为了进行测试，从composer UI中触发DAG。DAG应该成功完成。可以从云控制台验证STS作业运行。</p></div><div class="ab cl lj lk gp ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hb hc hd he hf"><p id="2dc2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">欢迎建议和评论！！！快乐阅读。</p></div></div>    
</body>
</html>