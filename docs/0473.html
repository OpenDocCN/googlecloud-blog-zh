<html>
<head>
<title>Kubernetes 10-domain Ingress</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes 10域入口</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/kubernetes-10-domain-ingress-c6c2bbf381bb?source=collection_archive---------0-----------------------#2017-12-22">https://medium.com/google-cloud/kubernetes-10-domain-ingress-c6c2bbf381bb?source=collection_archive---------0-----------------------#2017-12-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="964d" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">“因为一个人可以”系列</h2></div><p id="da59" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一个客户有兴趣通过每个客户的TLS端点公开其多租户<a class="ae jt" href="https://cloud.google.com/kubernetes-engine/" rel="noopener ugc nofollow" target="_blank"> Google Kubernetes引擎</a> (GKE)服务。GCP L7LB仅支持<a class="ae jt" href="https://cloud.google.com/compute/docs/load-balancing/http/#ssl_certificates" rel="noopener ugc nofollow" target="_blank"> 10 certs </a>(有计划扩展这一功能)，但我决定尝试一下10，并在途中尝试一些其他东西，包括<a class="ae jt" href="http://jsonnet.org/" rel="noopener ugc nofollow" target="_blank"> Jsonnet </a>和<a class="ae jt" href="https://cloud.google.com/dns/" rel="noopener ugc nofollow" target="_blank">谷歌云DNS </a> <a class="ae jt" href="https://cloud.google.com/dns/records/" rel="noopener ugc nofollow" target="_blank">事务</a>。</p><h2 id="4703" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">设置</h2><p id="3c71" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">我以前讨论过这个领域的大部分内容，您可能已经知道如何创建Kubernetes引擎集群。我将创建一个<a class="ae jt" href="https://cloud.google.com/kubernetes-engine/docs/concepts/multi-zone-and-regional-clusters#regional" rel="noopener ugc nofollow" target="_blank">区域集群</a>并与<a class="ae jt" href="https://kubernetes.io/docs/admin/authorization/rbac/" rel="noopener ugc nofollow" target="_blank"> RBAC </a>发生冲突，如果您对此感兴趣，请继续阅读:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="9446" class="ju jv hi kz b fi ld le l lf lg">export ROOT=$(whoami)-$(date +%y%m%d)<br/>export PROJECT=${ROOT}-multi-domain<br/>export CLUSTER=${ROOT}-cluster-01<br/>export BILLING=[[YOUR-BILLING-ID]]<br/>export REGION=[[YOUR-PREFERRED-REGION] #us-west1</span><span id="545e" class="ju jv hi kz b fi lh le l lf lg">gcloud alpha projects create $PROJECT</span><span id="f363" class="ju jv hi kz b fi lh le l lf lg">gcloud beta billing projects link $PROJECT \<br/>--billing-account=$BILLING</span><span id="5757" class="ju jv hi kz b fi lh le l lf lg">gcloud services enable container.googleapis.com \<br/>--project=$PROJECT</span></pre><p id="4047" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以指定主版本和节点版本，但是您需要确定您所在地区的可用版本。你可以看看这里的版本，选择你最喜欢的:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="90e1" class="ju jv hi kz b fi ld le l lf lg">gcloud beta container get-server-config \<br/>--project=$PROJECT \<br/>--region=${REGION}</span></pre><p id="76db" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后创建集群:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="7857" class="ju jv hi kz b fi ld le l lf lg">gcloud beta container clusters create $CLUSTER \<br/>--username="" \<br/>--cluster-version=1.8.4-gke.1 \<br/>--machine-type=custom-1-4096 \<br/>--image-type=COS \<br/>--preemptible \<br/>--num-nodes=1 \<br/>--enable-autorepair \<br/>--enable-autoscaling \<br/>--enable-autoupgrade \<br/>--enable-cloud-logging \<br/>--enable-cloud-monitoring \<br/>--min-nodes=1 \<br/>--max-nodes=2 \<br/>--labels=medium=c6c2bbf381bb \<br/>--region=$REGION \<br/>--project=$PROJECT</span></pre><p id="d124" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于broad(！)RBAC权限:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="69b5" class="ju jv hi kz b fi ld le l lf lg">ACCOUNT=$(gcloud config get-value account)</span><span id="2044" class="ju jv hi kz b fi lh le l lf lg">kubectl create clusterrolebinding $(whoami)-cluster-admin-binding --clusterrole=cluster-admin --<a class="ae jt" href="mailto:user=dazwilkin@google.com" rel="noopener ugc nofollow" target="_blank">user=$</a>ACCOUNT</span><span id="e7a4" class="ju jv hi kz b fi lh le l lf lg">kubectl create clusterrolebinding kube-system-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:default</span><span id="f541" class="ju jv hi kz b fi lh le l lf lg">kubectl create clusterrolebinding default-cluster-admin --clusterrole=cluster-admin --serviceaccount=default:default</span></pre><p id="46d3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后一点:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="d597" class="ju jv hi kz b fi ld le l lf lg">gcloud beta container clusters get-credentials $CLUSTER \<br/>--project=$PROJECT \<br/>--region=$REGION</span><span id="cb17" class="ju jv hi kz b fi lh le l lf lg">kubectl proxy --port=0 &amp;</span></pre><p id="8ee9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">代理命令应该报告</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="aa90" class="ju jv hi kz b fi ld le l lf lg">Starting to serve on [[SOME-URL]]</span></pre><p id="ff87" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一切正常后，您就可以打开Kube UI了:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="3ca4" class="ju jv hi kz b fi ld le l lf lg">https://[[SOME-URL]]/ui</span></pre><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es li"><img src="../Images/8d6bfb0d68ee87b7a0e66f035d1513ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xpa_xda6_TCrNMP3pPZ2tA.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">Kube UI</figcaption></figure><p id="adcf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">和/或通过云控制台:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="0fed" class="ju jv hi kz b fi ld le l lf lg">http://console.cloud.google.com/<a class="ae jt" href="https://pantheon.corp.google.com/kubernetes/list?project=dazwilkin-171222-multi-domain&amp;organizationId=433637338589" rel="noopener ugc nofollow" target="_blank">kubernetes/list?project=$</a>{PROJECT}</span></pre><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es li"><img src="../Images/dc889413489227d4308c06a3e3a9e1ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bBUiGvXH1wdwpjkt5gRmHA.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">云控制台:Kubernetes</figcaption></figure><h2 id="4f95" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">秘密</h2><p id="1018" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">让我们为我们计划的入口创建10个TLS证书。有一种快速生成TLS证书并将其作为Kubernetes秘密的好方法:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="f86b" class="ju jv hi kz b fi ld le l lf lg">PREFIX=[[YOUR-PREFIX]]<br/>DOMAIN=[[YOUR-DOMAIN]]</span><span id="3b38" class="ju jv hi kz b fi lh le l lf lg">for NUM in {0..9}<br/>do<br/>  NAME=${PREFIX}${NUM}.${DOMAIN}<br/>  openssl req \<br/>  -x509 \<br/>  -nodes \<br/>  -days 365 \<br/>  -newkey rsa:2048 \<br/>  -keyout ${NAME}.key \<br/>  -out ${NAME}.crt \<br/>  -subj "/CN=${NAME}"<br/>done</span></pre><p id="1dcb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后(如果你愿意，也可以合并)</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="7441" class="ju jv hi kz b fi ld le l lf lg">for NUM in {0..9}<br/>do<br/>  NAME=${PREFIX}${NUM}.${DOMAIN}<br/>  echo "<br/>  apiVersion: v1<br/>  kind: Secret<br/>  metadata:<br/>    name: ${NAME}<br/>  data:<br/>    tls.crt: `base64 --wrap 0 ./${NAME}.crt`<br/>    tls.key: `base64 --wrap 0 ./${NAME}.key`<br/>  " | kubectl apply --filename -<br/>done</span></pre><p id="6a24" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一切正常，下面应该包括10个秘密领域${NUM}。＄{ DOMAIN }和默认令牌:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="cdf2" class="ju jv hi kz b fi ld le l lf lg">kubectl get secrets --output=name</span></pre><h2 id="d728" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">部署|服务</h2><p id="7ab5" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">使用我的定位测试图像为入口创建基础服务:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="e456" class="ju jv hi kz b fi ld le l lf lg">kubectl run whoami \<br/>--image=emilevauge/whoami \<br/>--replicas=2 \<br/>--port=80</span><span id="8a42" class="ju jv hi kz b fi lh le l lf lg">kubectl expose deployment/whoami \<br/>--port=9999 \<br/>--target-port=80 \<br/>--type=NodePort</span></pre><p id="3032" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我使用Jsonnet(见下文)重新设计了部署和服务，并将包括下面的内容，但将重点解释入口。</p><h2 id="f465" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">Jsonnet</h2><p id="6c0c" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">Kube UI是观察Kubernetes的优秀工具，云控制台UI工具也越来越好。作为一个题外话，有人向我指出(我同意),在Kubernetes(豆荚、服务、入口)和GCP世界之间切换可能会不和谐。我不完全相信云控制台用户界面能解决这个问题。</p><p id="a2cc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不管怎样，对于改变Kubernetes来说，命令行仍然是最好的工具，尽管kubectl提供了许多(经过深思熟虑的)命令来创建部署、服务等。等等。在早期，你只需要抓住配置文件的角，并熟练地制作、理解和应用它们。</p><p id="2e3e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有各种各样的努力正在进行中，以避免开发人员编写配置文件。我被迫尝试Ksonnet，但今天我将坚持使用一个更早、更简单的工具<a class="ae jt" href="http://jsonnet.org" rel="noopener ugc nofollow" target="_blank"> Jsonnet </a>:</p><p id="acce" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以从其GitHub repo中获取Jsonnet，然后“制作”它:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="9031" class="ju jv hi kz b fi ld le l lf lg">git clone <a class="ae jt" href="https://github.com/google/jsonnet.git" rel="noopener ugc nofollow" target="_blank">https://github.com/google/jsonnet.git</a><br/>cd jsonnet<br/>make<br/>jsonnet --help</span><span id="f558" class="ju jv hi kz b fi lh le l lf lg">Jsonnet commandline interpreter v0.9.5</span><span id="cae6" class="ju jv hi kz b fi lh le l lf lg">General commandline:<br/>jsonnet [&lt;cmd&gt;] {&lt;option&gt;} { &lt;filename&gt; }<br/>Note: &lt;cmd&gt; defaults to "eval"</span><span id="9a9d" class="ju jv hi kz b fi lh le l lf lg">The eval command:<br/>jsonnet eval {&lt;option&gt;} &lt;filename&gt;<br/>Note: Only one filename is supported</span></pre><p id="97d3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我遵循一种模式(感谢Bitnami<a class="ae jt" href="https://github.com/bitnami/kube-manifests" rel="noopener ugc nofollow" target="_blank">kube-manifests</a>GitHub repo提供的指导和最佳实践)，拥有一个实例文件(whoami-ingress.jsonnet)和一个“类”文件(ingress.jsonnet):</p><figure class="ku kv kw kx fd lj"><div class="bz dy l di"><div class="lu lv l"/></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">whoami-ingress.jsonnet</figcaption></figure><figure class="ku kv kw kx fd lj"><div class="bz dy l di"><div class="lu lv l"/></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">ingress.jsonnet</figcaption></figure><p id="a009" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请千万不要把这些当成Jsonnet里的大师课。我让他们工作，这就是我所能提供的一切；-)whoami-ingress导入“类”并为必需的参数提供值。如果没有提供这些，就会产生“错误”。</p><p id="839b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">入口文件旨在生成一个入口<a class="ae jt" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.9/#ingress-v1beta1-extensions" rel="noopener ugc nofollow" target="_blank">规范</a>。参见“种类”和“apiVersion ”,您应该可以识别该模式。Jsonnet的动机是这个YAML有“规则”和“tls”的重复部分(10个),模板化的两个优点是变量替换(覆盖)和迭代。Jsonnet的循环与Python类似。我用的是:[{ X(N)} for N in[…]。]].两个循环都迭代0..9，两者都会在数组中生成10个JSON副本。这两个循环都利用了一个名为“name”的闭包，该闭包将它的单个参数——循环迭代器值(num)——与脚本全局的“prefix”和“domain”值结合起来。</p><blockquote class="lw lx ly"><p id="d20f" class="ix iy lz iz b ja jb ij jc jd je im jf ma jh ji jj mb jl jm jn mc jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong> closure vs. function可能有点学术性，但是在这种情况下,“name”是一个函数，它接受一个参数(num ),但是在脚本中对“prefix”和“domain”的全局值进行封闭。所以“名”是一个函数闭包；-)</p><p id="7d8e" class="ix iy lz iz b ja jb ij jc jd je im jf ma jh ji jj mb jl jm jn mc jp jq jr js hb bi translated"><strong class="iz hj">注意</strong>这里前缀“$”表示“前缀”和“域”对于脚本是全局的。</p></blockquote><p id="464c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Jsonnet处理whoami-ingress.jsonnet的结果只是一个ingress资源。您可以看到生成了以下内容:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="8c23" class="ju jv hi kz b fi ld le l lf lg">jsonnet whoami-ingress.jsonnet<br/>{<br/>   "apiVersion": "extensions/v1beta1",<br/>   "kind": "Ingress",<br/>   "metadata": {<br/>      "annotations": {<br/>         "kubernetes.io/ingress.class": "gce"<br/>      },<br/>      "name": "multi-domain"<br/>   },<br/>   ...<br/>}</span></pre><p id="b0d7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以将它直接应用于您的集群:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="2cc3" class="ju jv hi kz b fi ld le l lf lg">jsonnet whoami-ingress.jsonnet \<br/>| kubectl apply --filename -</span><span id="2ab6" class="ju jv hi kz b fi lh le l lf lg">ingress "multi-domain" unchanged</span></pre><p id="283a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Heptio的优秀人员为Jsonnet提供了一个Visual Studio代码插件:</p><div class="md me ez fb mf mg"><a href="https://marketplace.visualstudio.com/items?itemName=heptio.jsonnet" rel="noopener  ugc nofollow" target="_blank"><div class="mh ab dw"><div class="mi ab mj cl cj mk"><h2 class="bd hj fi z dy ml ea eb mm ed ef hh bi translated">Jsonnet - Visual Studio市场</h2><div class="mn l"><h3 class="bd b fi z dy ml ea eb mm ed ef dx translated">Jsonnet的Visual Studio代码语言支持扩展</h3></div><div class="mo l"><p class="bd b fp z dy ml ea eb mm ed ef dx translated">marketplace.visualstudio.com</p></div></div></div></a></div><p id="97e3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将预览输出:</p><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es mp"><img src="../Images/59a0f30f5b59641e5ab8d2f435537699.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Ci4pffDcPWxmbnShPOqkQ.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">heptio Jsonnet:Jsonnet→JSON(YAML)</figcaption></figure><p id="cd08" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Kube UI对入口资源没有太多作用，但是:</p><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es li"><img src="../Images/2bd3c60abb9dffc54f7cb5b57452ad28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jy1maY8WRklWosvutOaQGw.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">Kube UI:入口“多域”</figcaption></figure><p id="b3b0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里是更有趣的云控制台视图:</p><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es mq"><img src="../Images/689ef00d52c1ba3c95d93d17d5cb7255.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1VoPCw-q0ZUYUdrXLjmmOQ.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">云控制台:工作负载“多域”</figcaption></figure><p id="2907" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">L7配置为:</p><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es li"><img src="../Images/6e1d15b10a13166ed0a83dcdaf7a4c3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3bfEt1Af5jVsRkmnA5w8xQ.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">云控制台:发现和负载平衡</figcaption></figure><p id="c101" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我挑战任何人找到一个比用Kubernetes入口资源更简单的方法来编程GCP l7。</p><p id="fa69" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">剩下的工作就是将这些域名添加到我们的DNS记录中。</p><h2 id="2bfd" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">云DNS</h2><p id="2318" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">如果您使用的是云DNS，那么使用云SDK(又名“g Cloud”)编写这些附加功能的脚本就相对简单了。在继续之前，您可能希望获取当前DNS区域配置的快照。以防万一:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="4aab" class="ju jv hi kz b fi ld le l lf lg">DNS_ZONE=[[YOUR-CLOUD-DNS-ZONE]]</span><span id="a342" class="ju jv hi kz b fi lh le l lf lg">gcloud dns record-sets export ${DNS_ZONE}.yaml \<br/>--zone ${DNS_ZONE} \<br/>--project=${PROJECT}</span></pre><p id="3d10" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将使用事务，注意这是通过创建一个transaction.yaml脚本来实现的:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="b914" class="ju jv hi kz b fi ld le l lf lg">DNS_ZONE=[[YOUR-CLOUD-DNS-ZONE]]</span><span id="4e8a" class="ju jv hi kz b fi lh le l lf lg">gcloud beta dns record-sets transaction start \<br/>--zone=${DNS_ZONE} \<br/>--project=${PROJECT}</span><span id="bd18" class="ju jv hi kz b fi lh le l lf lg">Transaction started [transaction.yaml].</span></pre><p id="24b3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是我运行这个命令时产生的transaction.yaml:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="e4f9" class="ju jv hi kz b fi ld le l lf lg">---<br/>additions:<br/>- kind: dns#resourceRecordSet<br/>  name: domain.com.<br/>  rrdatas:<br/>  - ns-cloud-d1.googledomains.com. cloud-dns-hostmaster.google.com. 5 21600 3600 259200<br/>    300<br/>  ttl: 21600<br/>  type: SOA<br/>deletions:<br/>- kind: dns#resourceRecordSet<br/>  name: domain.com.<br/>  rrdatas:<br/>  - ns-cloud-d1.googledomains.com. cloud-dns-hostmaster.google.com. 1 21600 3600 259200<br/>    300<br/>  ttl: 21600<br/>  type: SOA</span></pre><p id="c3e0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我相信(！？)奇怪的添加和删除看似相同的条目是因为条目确实有细微的不同。在我的案例版本(！？)“4”被删除，而“5”被创建。我会确认这种行为。</p><p id="676a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们简单地遍历10个主机域，并将它们添加为指向Ingres创建的负载平衡器的IP的(lias)记录:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="7d25" class="ju jv hi kz b fi ld le l lf lg">PREFIX=[[YOUR-PREFIX]]<br/>DOMAIN=[[YOUR-DOMAIN]]</span><span id="d688" class="ju jv hi kz b fi lh le l lf lg">LB=$(kubectl get ingress/multi-domain \<br/>--output=jsonpath='{ .status.loadBalancer.ingress[0].ip }')</span><span id="2e26" class="ju jv hi kz b fi lh le l lf lg">for NUM in {0..9}<br/>do<br/>  gcloud beta dns record-sets transaction add "${LB}" \<br/>  --name=${PREFIX}${NUM}.${DOMAIN} \<br/>  --ttl=300 \<br/>  --type=A \<br/>  --zone=${DNS_ZONE} \<br/>  --project=${PROJECT}<br/>done</span></pre><p id="dd8b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后提交更改:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="77b8" class="ju jv hi kz b fi ld le l lf lg">gcloud beta dns record-sets transaction execute \<br/>--zone=${DNS_ZONE} \<br/>--project=${PROJECT}</span></pre><p id="bbc9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且，您应该能够确认更改已经生效:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="e9a3" class="ju jv hi kz b fi ld le l lf lg">gcloud beta dns record-sets list \<br/>--zone=${DNS_ZONE} \<br/>--project=${PROJECT} \<br/>| grep "${PREFIX}[0-9].${DOMAIN}"</span></pre><h2 id="4e00" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">试验</h2><p id="c0c6" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">您可以使用以下命令确认更改对客户端的DNS查找是否有效:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="688a" class="ju jv hi kz b fi ld le l lf lg">for NUM in {0..9}<br/>do<br/>  nslookup ${PREFIX}${NUM}.${DOMAIN} 8.8.8.8<br/>done</span></pre><p id="94c6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">而且，你应该能够卷曲端点:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="08d1" class="ju jv hi kz b fi ld le l lf lg">for NUM in {0..9}<br/>do<br/>  curl --silent --insecure <a class="ae jt" href="https://${PREFIX}${NUM}.${DOMAIN}/" rel="noopener ugc nofollow" target="_blank">https://${PREFIX}${NUM}.${DOMAIN}/</a> \<br/>  | grep "Host: ${PREFIX}[0-9].${DOMAIN}"<br/>done</span></pre><h2 id="8b8d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">结论</h2><p id="2465" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">这些入口资源可能是粗糙的，但这里有一个支持10(你不能得到更多的[今天])域。它的创建得益于一次在Jsonnet的奇妙之旅。</p><p id="d32b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">谷歌的SRE人试图避免“辛劳”，通常你可以通过自动化来避免辛劳。有时候为了自动化，你必须学习新的工具。Jsonnet非常强大，我相信，如果我继续使用它，我会灵活运用我的知识，它将成为我的工具集的一个有用的补充。</p><p id="7407" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">云DNS很棒。它并不总是最容易编程的。但是，如你所见，情况正在好转。</p><h2 id="6899" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">整理</h2><p id="b087" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">您应该恢复您的DNS记录:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="4e28" class="ju jv hi kz b fi ld le l lf lg">gcloud beta dns record-sets transaction start \<br/>--zone=${DNS_ZONE} \<br/>--project=${PROJECT}</span><span id="78c8" class="ju jv hi kz b fi lh le l lf lg">for NUM in {0..9}<br/>do<br/>  gcloud beta dns record-sets transaction remove "${LB}" \<br/>  --name=${PREFIX}${NUM}.${DOMAIN} \<br/>  --ttl=300 \<br/>  --type=A \<br/>  --zone=${DNS_ZONE} \<br/>  --project=${PROJECT}<br/>done</span><span id="1ad6" class="ju jv hi kz b fi lh le l lf lg">gcloud beta dns record-sets transaction execute \<br/>--zone=${DNS_ZONE} \<br/>--project=${PROJECT}</span></pre><p id="01fb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行我们之前的测试应该返回零:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="b987" class="ju jv hi kz b fi ld le l lf lg">gcloud beta dns record-sets list \<br/>--zone=${DNS_ZONE} \<br/>--project=${PROJECT} \<br/>| grep "${PREFIX}[0-9].${DOMAIN}"</span></pre><p id="14ca" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果出现任何问题，你听从了我的建议，做了备份，所以你可以恢复它。</p><p id="2146" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我为每个任务创建集群，并经常删除它们:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="ca57" class="ju jv hi kz b fi ld le l lf lg">gcloud beta container clusters delete $CLUSTER \<br/>--project=$PROJECT \<br/>--region=$REGION \<br/>--quiet</span></pre><p id="a121" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是，如果你想整理，你可以删除我们创造的所有美好的东西:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="0ace" class="ju jv hi kz b fi ld le l lf lg">kubectl delete ingress/multi-domain</span><span id="47c3" class="ju jv hi kz b fi lh le l lf lg">for NUM in {0..9}<br/>do<br/>  kubectl delete secret/${PREFIX}${NUM}.${DOMAIN}<br/>done</span><span id="d40b" class="ju jv hi kz b fi lh le l lf lg">kubectl delete service/multi-domain<br/>kubectl delete deployment/multi-domain</span></pre><p id="db5d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您想要(不可撤销地)删除GCP项目(这是不可撤销的)，您可以:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="30f9" class="ju jv hi kz b fi ld le l lf lg">gcloud projects delete ${RPOJECT} --quiet</span></pre><p id="470b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">那都是乡亲们！</p></div></div>    
</body>
</html>