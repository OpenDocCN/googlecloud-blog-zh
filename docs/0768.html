<html>
<head>
<title>How to kick off a Dataflow pipeline via Cloud Functions for Firebase</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何通过Firebase的云函数启动数据流管道</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-kick-off-a-dataflow-pipeline-via-cloud-functions-696927975d4e?source=collection_archive---------0-----------------------#2018-09-24">https://medium.com/google-cloud/how-to-kick-off-a-dataflow-pipeline-via-cloud-functions-696927975d4e?source=collection_archive---------0-----------------------#2018-09-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a723" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在Soru的数据管道依赖于谷歌数据流。我选择它而不是Dataproc，因为在我们的小团队中，无服务器架构的便利性非常重要。Apache Beam与我在谷歌经常使用的内部工具Flume的相似性也在这个选择中发挥了作用。</p><p id="1884" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的数据流管道是用Python编写的。我通常从我的本地计算机开始一次性工作，直到它准备好集成到我们的生产管道中。我将在另一篇博文中讲述如何为各种用例构建数据流管道。</p><p id="e9c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以编程方式从另一个系统调用数据流管道的最简单方法是</p><ul class=""><li id="175d" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">创建您的自定义数据流模板。这里是<a class="ae jd" href="https://cloud.google.com/dataflow/docs/templates/creating-templates" rel="noopener ugc nofollow" target="_blank">指令</a>。</li></ul><p id="bded" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请务必仔细阅读文档。SDK中可能有一些限制。</p><p id="a4ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，在Python SDK中，只有基于文件的IOs支持ValueProvider。当我对管道进行模板化时，我必须将输入参数从BigQuery更改为TextIO。参见https://issues.apache.org/jira/browse/BEAM-1440的<a class="ae jd" href="https://issues.apache.org/jira/browse/BEAM-1440" rel="noopener ugc nofollow" target="_blank"/></p><ul class=""><li id="0bfa" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">将其部署到GCS存储桶。我写了一个简单的部署脚本，因为我们有测试、试运行和生产项目，我们需要将我们的系统部署到其中的每一个项目。</li></ul><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="2a68" class="jw jx hi js b fi jy jz l ka kb">def deploy(project, bucket, template_name):<br/>    command = '''<br/>        python -m {template_name} \<br/>            --runner DataflowRunner \<br/>            --project {project} \<br/>            --requirements_file requirements.txt \<br/>            --staging_location gs://{bucket}/staging \<br/>            --temp_location gs://{bucket}/temp \<br/>            --template_location \<br/>                gs://{bucket}/templates/{template_name}<br/>    '''.format(project=project, bucket=bucket,<br/>               template_name=template_name)<br/>    os.system(command)<br/>    os.system('''<br/>        gsutil cp {template_name}_metadata \<br/>            gs://{bucket}/templates/<br/>    '''.format(bucket=bucket, template_name=template_name))</span></pre><p id="82cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个脚本假设您有<template>。py，<template>_元数据和requirements.txt文件在同一个目录下。</template></template></p><ul class=""><li id="2d96" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">通过REST API调用管道。</li></ul><p id="b2f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最近，我们越来越依赖无服务器架构。我们在Node.js 6运行时使用Firebase云函数，所以我们需要从那里开始处理数据流模板。不幸的是，客户端库支持有点挑剔。我必须说，做这件事一点也不好玩，所以我不想麻烦你。顺便说一下，这段代码很可能也适用于GCP的云函数，尽管我还没有测试过。</p><p id="4e55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是我们的代码大致的样子。我们依赖“Google APIs”:“33 . 0 . 0”。</p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="60ed" class="jw jx hi js b fi jy jz l ka kb">const { google } = require('googleapis');<br/>const dataflow = google.dataflow('v1b3');</span><span id="6c25" class="jw jx hi js b fi kc jz l ka kb">const TEMPLATE_BUCKET = `your template bucket on GCS`;</span><span id="5b22" class="jw jx hi js b fi kc jz l ka kb">const kickOffDataflow = (input, output) =&gt; {<br/>  var jobName = `your job name`;<br/>  var tmpLocation = `gs://${TEMPLATE_BUCKET}/tmp`;<br/>  var templatePath = `gs://${TEMPLATE_BUCKET}/templates/` +<br/>    `your_template_name`;<br/>  var request = {<br/>    projectId: process.env.GCLOUD_PROJECT,<br/>    requestBody: {<br/>      jobName: jobName,<br/>      parameters: {<br/>        input: input,<br/>        output: output<br/>      },<br/>      environment: {<br/>        tempLocation: tmpLocation<br/>      }<br/>    },<br/>    gcsPath: templatePath<br/>  }<br/>  return<br/>    google.auth.getClient({<br/>      scopes: ['<a class="ae jd" href="https://www.googleapis.com/auth/cloud-platform'" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/cloud-platform'</a>]<br/>    })<br/>    .then(auth =&gt; {<br/>      request.auth = auth;<br/>      return dataflow.projects.templates.launch(request);<br/>    })<br/>    .catch(error =&gt; {<br/>      console.error(error);<br/>      throw error;<br/>    });<br/>}</span></pre><p id="6b0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我知道这是否有帮助，并随时提出改进建议。编码快乐！</p></div></div>    
</body>
</html>