<html>
<head>
<title>IaaS/CI /CD with Kubernetes on GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">IaaS/CI /CD与GCP的Kubernetes</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/iaas-ci-cd-with-kubernetes-on-gcp-694905653382?source=collection_archive---------3-----------------------#2019-02-04">https://medium.com/google-cloud/iaas-ci-cd-with-kubernetes-on-gcp-694905653382?source=collection_archive---------3-----------------------#2019-02-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="760b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们最近在一个客户那里完成了一个项目，我们使用“谷歌部署管理器”、“谷歌云构建”和“Spinnaker”修改了它的整个devops。虽然这是以Kubernetes engine为中心的(如果您希望为您的应用程序充分利用云的优势，这是一种方法)，但该框架可以用于在VM上部署monolith应用程序，在app engine上部署云功能和应用程序。外面有许多工具用于执行devops然而，我们确信本文中描述的GCP和开源工具的组合是最有效和用户友好的。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="553e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们首先对所使用的架构有一个高度的概述，一个架构图胜过千言万语。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/29f06ec0ac1396b4af3a55ff9df5278a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CblT51bgn-wTwsia"/></div></div></figure><p id="424a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一切都从代码库开始，拥有一个全面的git策略是先决条件之一。GCP现在有了自己的版本控制模块，叫做源代码库，它可以即时从Bitbuckets和Github镜像你的代码。在我们的例子中，客户端的代码在Bitbucket上，我们镜像到源存储库。将您的代码库放在GCP上可以更容易地与云构建集成，也可以在Kubernetes上进行调试。除此之外，它还有一个不错的免费层。</p><p id="c4b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如前所述，在实现CI/CD管道之前，您需要有一个git策略。外面有大量的文献，对于这个项目，我们选择了<a class="ae jw" href="https://nvie.com/posts/a-successful-git-branching-model/" rel="noopener ugc nofollow" target="_blank">成功的git分支模型</a>和<a class="ae jw" href="https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow" rel="noopener ugc nofollow" target="_blank"> git-flow扩展</a>。接下来是关于你的团队应该如何合作的争论(他们需要改变基础、快速合并、挤压等等)。).这真的取决于你的团队的规模以及他们过去是如何工作的。我们的方法是:</p><ul class=""><li id="f014" class="jx jy hi ih b ii ij im in iq jz iu ka iy kb jc kc kd ke kf bi translated">一个特征-一个分支</li><li id="5f16" class="jx jy hi ih b ii kg im kh iq ki iu kj iy kk jc kc kd ke kf bi translated">特征完成→挤压所有提交</li><li id="beae" class="jx jy hi ih b ii kg im kh iq ki iu kj iy kk jc kc kd ke kf bi translated">拉取请求</li><li id="78c0" class="jx jy hi ih b ii kg im kh iq ki iu kj iy kk jc kc kd ke kf bi translated">管理员将该功能合并到开发分支</li></ul><p id="beec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了基于源代码库的代码库和定义好的git策略，您现在可以启动CI/CD管道，让您的开发人员只关注编码，并能够在几分钟内测试和部署他们的应用程序。所使用的工具也促进了您的devops团队的生活，因为他们的工作从手动步骤、调试和热修复的混合变成了监控和确保不同工具顺利工作的工作。</p><blockquote class="kl"><p id="3971" class="km kn hi bd ko kp kq kr ks kt ku jc dx translated">这个框架将您的开发人员从无附加值的任务中解放出来，并赋予您的devops团队更多有趣和战略性的任务。</p></blockquote></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="c532" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在深入研究CI和CD工具之前，让我们先讨论一下项目架构，因为这对于客户来说是一件很有附加值的事情。我们选择将不同的环境分成不同的项目，并为所有共享服务增加一个项目。后一个项目与所有devops有关，并将托管容器映像、云构建触发器、K8s清单、带有spinnaker的集群等。这种项目分离和devops专用项目允许有非常精细的访问策略，并使每个项目的目的更加清晰。没有什么是混合的，其背后的理念是“一个项目，一个目的”。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kv"><img src="../Images/119e5b2d987eb5cabdc19678cfe7ad6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JFGNtQhALyAXDNTP1oHlQw.png"/></div></div></figure></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="39ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们关注云构建的持续集成部分。它的唯一目标是</p><ul class=""><li id="9394" class="jx jy hi ih b ii ij im in iq jz iu ka iy kb jc kc kd ke kf bi translated">在Google容器注册表上烘焙一个容器图像</li><li id="5132" class="jx jy hi ih b ii kg im kh iq ki iu kj iy kk jc kc kd ke kf bi translated">在谷歌云存储上复制一次新的K8s清单文件</li></ul><p id="035b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦在代码库上完成了特定的推送，这两个动作就会发生，所述推送分别包括应用或K8s清单文件中的变化(云构建将通过不同的触发器来监听这些变化)。云构建需要一系列步骤，每个步骤都定义了要完成的操作。遇到的主要步骤是获取代码库、运行单元测试和构建映像。基本上，任何操作都可以通过云构建来执行，因为每一步都是一个独立的容器应用程序。一旦cloud build完成了所有步骤，GCR上的新映像或GCS上的新K8s文件将向Pub/Sub发送一个通知，将Spinnaker作为订阅者。</p><blockquote class="kl"><p id="eefd" class="km kn hi bd ko kp kq kr ks kt ku jc dx translated">GCP面向消息的中间件Pub/Sub是CI和CD部分之间的通信支柱。</p></blockquote></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="3e69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2现在让我们转到部署部分。这是通过部署在共享服务项目集群上的开源软件Spinnaker来完成的。部署完成后，您可以轻松地将UI配置为可以在公共域上使用oauth2.0访问(参见<a class="ae jw" href="https://www.spinnaker.io/setup/quickstart/halyard-gke-public/" rel="noopener ugc nofollow" target="_blank">教程</a>)。一旦您通过了一些配置设置，Spinnaker用户友好的UI使得创建管道和在您不同的GCP项目上部署变得非常简单。已开发的两条管道如下:</p><ul class=""><li id="4b23" class="jx jy hi ih b ii ij im in iq jz iu ka iy kb jc kc kd ke kf bi translated"><strong class="ih hj">开发管道</strong>在开发项目的集群上部署您的映像。它还将运行一些集成测试，如果任何测试失败，部署将停止并恢复到以前的映像。</li></ul><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kw"><img src="../Images/6a5487df60a82d468d1c67f7d137289d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qnvBt0ZAqKUxj_or7P-6MQ.png"/></div></div></figure><ul class=""><li id="c948" class="jx jy hi ih b ii ij im in iq jz iu ka iy kb jc kc kd ke kf bi translated"><strong class="ih hj"> Prod pipeline </strong>首先在QA项目集群上部署的映像上运行大量测试。然后，团队可以手动测试QA项目上的应用程序，一旦他们满意，他们可以在Spinnaker上手动批准，这将触发prod项目集群上的canary部署。canary部署是一种高级部署，它会将90%的流量发送到您的早期版本，将5%的流量发送到具有早期版本的全新基准集群，最后将剩余的5%发送到具有新版本的集群(称为canary集群)。创建一个全新的基线集群可以确保所产生的指标不受长时间运行的流程的影响。金丝雀分析然后通过Kayenta库分析基线集群和金丝雀集群之间的大量指标。如果结果令人满意，100%的流量被发送到新版本。否则整个流量又回到之前的版本。</li></ul><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es kx"><img src="../Images/623c3ac9ef91d300bf02938f1bfa8846.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*YVaB7CxnJm33u7my-mvqjg.png"/></div></figure><ul class=""><li id="275d" class="jx jy hi ih b ii ij im in iq jz iu ka iy kb jc kc kd ke kf bi translated"><strong class="ih hj">特性管道</strong>:来自K8s开发者的一个主要抱怨是难以快速测试一个特性。一种解决方案是为推送到特性分支的代码创建CI/CD管道。这将在特定的GCR子文件夹中烘焙一个映像，然后这个spinnaker管道将在dev项目的集群上部署该映像，其名称空间为feature分支。然后，开发人员可以在开发环境中快速测试他们的更改，而不会影响将在默认名称空间上部署的普通应用程序。</li></ul></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="ddb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">等等，IaaS在这一切中处于什么位置，我为什么需要它？</strong></p><p id="aea5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过Google Deployment Manager，IaaS是一种实践，它通过使用代码来描述基础设施的配置，从而使基础设施的配置可复制、可伸缩且易于审查。基础设施即代码源于对基础设施也是“软件”的认识，对于公共云来说尤其如此。</p><blockquote class="kl"><p id="421a" class="km kn hi bd ko kp kq kr ks kt ku jc dx translated">基本上，它会翻译您在GCP UI中所做的任何UI操作(创建集群、设置IAM策略、创建bucket等)。)转化成代码。</p></blockquote><p id="b3c0" class="pw-post-body-paragraph if ig hi ih b ii ky ik il im kz io ip iq la is it iu lb iw ix iy lc ja jb jc hb bi translated">一旦您的基础设施发生变化，您只需在代码中进行更改，然后通过gcloud命令进行更新。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="3f37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文档描述了各种工具，如果没有一个通知工具将它们集成在一起，事情会变得很混乱。这就是Slack的用武之地，它与本文中提到的所有工具进行了静态和动态集成。从git集成通知您可以动态接受的拉取请求，到Spinnaker手动判断，您真的可以使用slack应用程序和Google云功能开发任何类型的通知。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es ld"><img src="../Images/8689317d5ff19e55bf47269d93f808b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:738/format:webp/1*4OdaWcA2jIIEzuen0LTc6w.png"/></div></figure></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="419a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要帮助您开发K8s应用程序的这种改进的CI/CD管道吗？我们经验丰富的开发人员将指导您完成所有不同的步骤，咨询可以从简单的架构设计和技巧到完全定制的实施。请随时通过niels@fourcast.io或charles.verleyen@fourcast.io联系我们。niels和charles是K8s four cast和GCP devo PS tech的主要开发人员。</p><p id="6f01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请登录<a class="ae jw" href="http://www.fourcast.io" rel="noopener ugc nofollow" target="_blank"> www.fourcast.io </a>访问我们</p></div></div>    
</body>
</html>