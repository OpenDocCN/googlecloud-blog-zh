<html>
<head>
<title>GCP — BigQuery — Data Security at rest (Part 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP —大查询—静态数据安全(第3部分)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-bigquery-data-security-at-rest-part-3-915ce0cff883?source=collection_archive---------2-----------------------#2022-11-15">https://medium.com/google-cloud/gcp-bigquery-data-security-at-rest-part-3-915ce0cff883?source=collection_archive---------2-----------------------#2022-11-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="99c3" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">到目前为止，在博客的第2部分中，我们已经详细讨论了列级访问控制和列的动态屏蔽。在这篇博客中，重点将是列数据的加密。</p><p id="5144" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">这篇博客是“Bigquery —静态数据安全”5部分系列文章的一部分。<br/>点击此处查看<a class="ae jh" rel="noopener" href="/google-cloud/gcp-bigquery-data-security-at-rest-part-2-f4e3c741c162">系列</a>第二部<br/>点击此处查看<a class="ae jh" rel="noopener" href="/google-cloud/gcp-bigquery-data-security-at-rest-series-menu-1e59e1793deb">系列菜单</a></p></blockquote><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ji"><img src="../Images/34cfaa93c06bdc8958cdbb3eff79f503.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BHbXZ4n0NLf9EF_cGpYppA.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">Bigquery安全控件。</figcaption></figure></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><h2 id="cf37" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">列级加密</h2><p id="f871" class="pw-post-body-paragraph ii ij hi il b im ld io ip iq le is it kq lf iw ix ku lg ja jb ky lh je jf jg hb bi translated">列级加密的基本原理是数据用数据加密密钥(DEK)加密，密钥用密钥加密密钥(KEK)进一步加密，并在云KMS中维护。</p><p id="61e6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">现在，为了让用户访问纯文本，用户需要对表列加上云KMS密钥(KEK)进行访问，该密钥用于加密数据加密密钥(DEK)。</p><p id="19e5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated"><strong class="il hj">术语</strong> <br/> <strong class="il hj"> DEK </strong> —数据加密密钥—用于加密数据的密钥，该密钥由谷歌<br/> <strong class="il hj"> KEK </strong>生成—密钥加密密钥—用于包装或加密DEK的密钥，在云KMS中维护</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es li"><img src="../Images/7cddf2c7001d0f9012a07444ae9ac55c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hh2TrNC-Yi3dAAFsHCJ2oA.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated"><a class="ae jh" href="https://cloud.google.com/kms/docs/envelope-encryption#how_to_encrypt_data_using_envelope_encryption" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/kms/docs/envelope-encryption # how _ to _ encrypt _ data _ using _ envelope _ encryption</a></figcaption></figure><blockquote class="if ig ih"><p id="c0cf" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">与CMEK不同，在CMEK中，Bigquery服务帐户只需要访问CMEK密钥来加密和解密数据集/表。<br/>为了使列级加密工作，用户需要访问KMS密钥(KEK)</p></blockquote><p id="476c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated"><strong class="il hj"> AEAD </strong> — <strong class="il hj">带关联数据的认证加密。</strong> <br/>这种<strong class="il hj">加密</strong>背后的想法是通过用提供的<strong class="il hj">关联数据</strong>验证签名来确保<strong class="il hj">加密的数据不被篡改。</strong></p><p id="331b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">关联数据可以是在加密过程中提供的简单字节，类似于需要在解密过程中提供的密码。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es lj"><img src="../Images/eaf8662ec327c4355e689159505c7622.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*25gLJZ6T4HsmfZdAZhNT0Q.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">AEAD加密过程。</figcaption></figure><p id="0630" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">AEAD支持不同类型的模式(<a class="ae jh" href="https://developers.google.com/tink/aead#choosing_a_key_type" rel="noopener ugc nofollow" target="_blank">密钥类型</a>)，用于使用<a class="ae jh" href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard" rel="noopener ugc nofollow" target="_blank"> AES(高级加密标准)</a>算法加密数据</p><blockquote class="if ig ih"><p id="e98b" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">在幕后，Bigquery列级加密使用Tink加密库进行加密和解密</p></blockquote><p id="27ff" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">Tink加密库利用了称为原语、密钥类型、密钥集和密钥集句柄的概念。</p><p id="235b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated"><strong class="il hj">原语— </strong> <a class="ae jh" href="https://developers.google.com/tink/primitives-by-language" rel="noopener ugc nofollow" target="_blank">原语</a>简单来说可以认为是一个执行加密和解密的接口。原语定义要使用的密钥类型和加密算法。<br/>例如:AEAD，AEAD确定性，MAC..</p><p id="b888" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated"><strong class="il hj">键类型— </strong> <a class="ae jh" href="https://developers.google.com/tink/supported-key-types" rel="noopener ugc nofollow" target="_blank">键类型</a>定义实现。每个原语都有一组受支持的密钥类型可供选择，例如:AEAD原语— AES GCM密钥类型。</p><p id="efc1" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated"><strong class="il hj">密钥集— </strong>密钥集可视为组合在一起的一组密钥，其中一个密钥是用于加密的主要密钥，其余密钥用于解密</p><p id="fbd4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated"><strong class="il hj">按键手柄</strong> —按键手柄有助于以安全的方式提供按键接口。</p><p id="18de" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">让我们看看Tink生成的纯文本密钥集是什么样子的<br/><strong class="il hj">值</strong>是用于加密数据的实际密钥类型材料。</p><pre class="jj jk jl jm fd lk ll lm bn ln lo bi"><span id="18a1" class="lp kg hi ll b be lq lr l ls lt">{<br/>  "primaryKeyId": 1920493436,<br/>  "key": [<br/>    {<br/>      "keyData": {<br/>        "typeUrl": "type.googleapis.com/google.crypto.tink.AesGcmKey",<br/>        "value": "&lt;redacted&gt;",<br/>        "keyMaterialType": "SYMMETRIC"<br/>      },<br/>      "status": "ENABLED",<br/>      "keyId": 1920493436,<br/>      "outputPrefixType": "TINK"<br/>    }<br/>  ]<br/>}</span></pre><blockquote class="if ig ih"><p id="38d2" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">密钥集不应该以明文生成，而应该使用KMS系统(如云KMS)进行加密</p></blockquote></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><p id="b0cb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">现在，让我们尝试使用Bigquery来实现上述概念，简单地创建一个带有keytype的tink键集</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es lu"><img src="../Images/1e40c5e4bd17df359ea29ac8505a9f6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ejTwzSjwVT8Jsbsf4Z7wdw.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">键集函数</figcaption></figure><p id="b158" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">让我们尝试用AEAD_AES_GCM_256 keytype创建一个键集。</p><pre class="jj jk jl jm fd lk ll lm bn ln lo bi"><span id="bf7d" class="lp kg hi ll b be lq lr l ls lt"><br/>SELECT KEYS.NEW_KEYSET('AEAD_AES_GCM_256');<br/>--COWSm/UNEmQKWAowdHlwZS5nb29nbGVhcGlzLm&lt;redacted&gt;</span></pre><p id="77bf" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">NEW_KEYSET返回tink键集的序列化字节表示。</p><p id="d4f8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">让我们试着将序列化的字节解码成更容易识别的格式，如下所示</p><pre class="jj jk jl jm fd lk ll lm bn ln lo bi"><span id="84db" class="lp kg hi ll b be lq lr l ls lt">SELECT KEYS.KEYSET_TO_JSON(<br/>FROM_BASE64("COWSm/UNEmQKWAowdHlwZS5nb29nbGVhcGlzLm&lt;readacted&gt;"));<br/>/*<br/>{<br/>   "key":[<br/>      {<br/>         "keyData":{<br/>            "keyMaterialType":"SYMMETRIC",<br/>            "typeUrl":"type.googleapis.com/google.crypto.tink.AesGcmKey",<br/>            "value":"&lt;redacted&gt;"<br/>         },<br/>         "keyId":3735472485,<br/>         "outputPrefixType":"TINK",<br/>         "status":"ENABLED"<br/>      }<br/>   ],<br/>   "primaryKeyId":3735472485<br/>}<br/>*/ </span></pre><p id="9d2d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">类似地，钥匙。KEYSET_FROM_JSON可以用来提供KEYSET的JSON表示，并获得序列化的字节。<br/>对于使用Bigquery加密/解密函数进行加密和解密的所有意图和目的，我们将需要序列化的字节。</p><p id="926f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">让我们看一个用上述密钥集进行<strong class="il hj">加密</strong>和<strong class="il hj">解密</strong>的例子。</p><pre class="jj jk jl jm fd lk ll lm bn ln lo bi"><span id="ad56" class="lp kg hi ll b be lq lr l ls lt">--Encryption Process<br/>SELECT AEAD.ENCRYPT(<br/>FROM_BASE64("COWSm/UNEmQKWAowdHlwZS5nb29nbGVhcGlzLm&lt;redacted&gt;"), <br/>"Albert Einstein", <br/>"Scientist") AS encrypted_bytes<br/><br/>--Ad6myWWr9tJJhEG9DKRXuR15FVQO3h4tFi3O/4odapCqY3JyVJSmUCBo7LJ4hPwM<br/><br/>--Decryption Process<br/>SELECT AEAD.DECRYPT_STRING(<br/>FROM_BASE64("COWSm/UNEmQKWAowdHlwZS5nb29nbGVhcGlzLm&lt;redacted&gt;"), <br/>FROM_BASE64("Ad6myWWr9tJJhEG9DKRXuR15FVQO3h4tFi3O/4odapCqY3JyVJSmUCBo7LJ4hPwM"),<br/>"Scientist") as decrypted_string;<br/>--Albert Einstein</span></pre><p id="518b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">“<strong class="il hj">科学家</strong>”是相关的关键字，用于认证加密数据，并证明加密数据未被篡改。</p><p id="5f6f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">生成的密钥集可以使用密钥与新密钥一起旋转。密钥集_旋转</p><pre class="jj jk jl jm fd lk ll lm bn ln lo bi"><span id="101e" class="lp kg hi ll b be lq lr l ls lt">SELECT KEYS.ROTATE_KEYSET(FROM_BASE64("COWSm/UNEmQKWAowdHlwZS5nb29nbGVhcGlzL&lt;redacted&gt;), "AEAD_AES_GCM_256");<br/>--CMKtlcAKEmQKWAowdHlwZS5nb29nbGVhcGlzLmNvbS9nb29nbGUuY3J5cHRvLnRpbmsuQWVzR2NtS2V5EiIaIDXINLdEdJU/rsQp5ovIBv/k/5Al7/ &lt;redacted&gt;<br/><br/>SELECT KEYS.KEYSET_TO_JSON(FROM_BASE64("CMKtlcAKEmQKWAowdHlwZS5nb29nbGVhcGlzLmNvbS9nb29nbGUuY3J5cHRvLnRpbmsuQWVzR2NtS2V5EiIaIDXINLdEdJU/rsQp5ovIBv/k/5Al7/&lt;redacted"));</span></pre><pre class="lv lk ll lm bn ln lo bi"><span id="1e59" class="lp kg hi ll b be lq lr l ls lt">{<br/>  "key": [<br/>    {<br/>      "keyData": {<br/>        "keyMaterialType": "SYMMETRIC",<br/>        "typeUrl": "type.googleapis.com/google.crypto.tink.AesGcmKey",<br/>        "value": "&lt;redacted&gt;"<br/>      },<br/>      "keyId": 3735472485,<br/>      "outputPrefixType": "TINK",<br/>      "status": "ENABLED"<br/>    },<br/>    {<br/>      "keyData": {<br/>        "keyMaterialType": "SYMMETRIC",<br/>        "typeUrl": "type.googleapis.com/google.crypto.tink.AesGcmKey",<br/>        "value": "&lt;redacted&gt;"<br/>      },<br/>      "keyId": 2818922178,<br/>      "outputPrefixType": "TINK",<br/>      "status": "ENABLED"<br/>    }<br/>  ],<br/>  "primaryKeyId": 2818922178<br/>}</span></pre><blockquote class="if ig ih"><p id="ee05" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">使用这种加密/解密的最大好处是它的本机tink库用法。上面的JSON密钥集信息可以用来解密原生tink库中的加密字符串。</p></blockquote><pre class="jj jk jl jm fd lk ll lm bn ln lo bi"><span id="e1ae" class="lp kg hi ll b be lq lr l ls lt">import tink<br/>from tink import aead, cleartext_keyset_handle<br/>import base64<br/><br/># The TINK KEY SET file is the above plain text key set ouput<br/>TINK_KEYSET_FILE = "bq_keyset.json"<br/><br/>aead.register()<br/><br/>text = open(TINK_KEYSET_FILE, "rt").read()<br/>keyset_handle = cleartext_keyset_handle.read(tink.JsonKeysetReader(text))<br/><br/>cipher = keyset_handle.primitive(aead.Aead)<br/><br/># Encrypted output from the aead.encrypt function.<br/>output = cipher.decrypt(base64.b64decode("Ad6myWWr9tJJhEG9DKRXuR15FVQO3h4tFi3O/4odapCqY3JyVJSmUCBo7LJ4hPwM".encode("utf-8")), b"Scientist")<br/><br/>print(output.decode("utf-8"))<br/># Albert Einstein.</span></pre><blockquote class="if ig ih"><p id="67b2" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">使用bq加密函数编码的数据可以使用支持语言的tink库解密。这为该方法提供了更大的灵活性。</p><p id="66b1" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">现在<strong class="il hj"> NEW_KEYSET </strong>函数提供了序列化格式的密钥集，可以对其进行反序列化以获得纯文本密钥材料，因此这应该仅用于测试目的。</p><p id="a6d0" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">我们将通过<strong class="il hj">包装的键集和键集_链</strong>概念来理解<strong class="il hj">云KMS如何增强该过程</strong></p></blockquote><p id="79c8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">以下命令创建由指定的云KMS密钥加密的密钥集</p><pre class="jj jk jl jm fd lk ll lm bn ln lo bi"><span id="2350" class="lp kg hi ll b be lq lr l ls lt">SELECT KEYS.NEW_WRAPPED_KEYSET("gcp-kms://projects/&lt;redacted&gt;/locations/us/keyRings/tink_us_keyring/cryptoKeys/tink_key", "AEAD_AES_GCM_256");<br/>--CiQA3GVtLInRIEJQ5oUHo4v0hICcEeL+vdH0WFXSWWIL+&lt;redacted&gt;</span></pre><p id="a316" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">现在我们将创建一个密钥集链，它有助于动态解密加密的密钥。我们将以类似的方式加密一个简单的文本。<br/>加密密钥的值需要作为查询参数或select的一部分传递，如下所示</p><pre class="jj jk jl jm fd lk ll lm bn ln lo bi"><span id="e7a0" class="lp kg hi ll b be lq lr l ls lt">DECLARE KEY BYTES;<br/>SET KEY = (SELECT FROM_BASE64("CiQA3GVtLEAKCJE3Kmny5Cvg163nrtU0xLa2rvLCqA4DO0wrhqsS&lt;redacted&gt;"));<br/>SELECT AEAD.ENCRYPT<br/>(KEYS.KEYSET_CHAIN("gcp-kms://projects/&lt;redacted&gt;/locations/us/keyRings/tink_us_keyring/cryptoKeys/tink_key", <br/>KEY),<br/>"Albert Einstein",<br/>"Scientist"<br/>)<br/><br/>--ARmnidmkrodK2qVQZ0POOCU65Ci9R7jMAHyXTNUpzsum2NjoyGtC25sfLezclc7p</span></pre><p id="6307" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">类似地，解密函数的工作方式如下</p><pre class="jj jk jl jm fd lk ll lm bn ln lo bi"><span id="431b" class="lp kg hi ll b be lq lr l ls lt">DECLARE KEY BYTES;<br/>SET KEY = (SELECT FROM_BASE64("CiQA3GVtLEAKCJE3Kmny5Cvg163nrtU0xLa2rvLCqA4DO0wrhqsS&lt;redacted&gt;"));<br/>SELECT AEAD.DECRYPT_STRING<br/>(KEYS.KEYSET_CHAIN("gcp-kms://projects/&lt;redacted&gt;/locations/us/keyRings/tink_us_keyring/cryptoKeys/tink_key", <br/>KEY),<br/>FROM_BASE64("ARmnidmkrodK2qVQZ0POOCU65Ci9R7jMAHyXTNUpzsum2NjoyGtC25sfLezclc7p"),<br/>"Scientist"<br/>)<br/><br/>--Albert Einstein</span></pre><p id="cd77" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">包装的密钥集可以分发，并且只能由对用作KEK的云KMS密钥拥有权限的用户解密</p><p id="a3f3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">让我们尝试解密加密的密钥，并查看密钥的内容</p><pre class="jj jk jl jm fd lk ll lm bn ln lo bi"><span id="0b75" class="lp kg hi ll b be lq lr l ls lt">echo "CiQA3GVtLEAKCJE3Kmny5Cvg163nrtU0xLa2rvLCqA4DO0wrhqs&lt;redacted&gt;" | base64 -d &gt; wrapped_key<br/><br/>gcloud kms decrypt --key tink_key \<br/>--keyring tink_us_keyring \<br/>--location us \<br/>--ciphertext-file wrapped_key \<br/>--plaintext-file unwrapped_key<br/><br/>cat unwrapped_key | base64<br/>--CILf5s8IEmQKWAowdHlwZS5nb29nbGVhcGlzLmNvbS9nb29nbGUuY3J5cHR&lt;redacted&gt;</span></pre><p id="02ba" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">现在密钥被解密了，让我们看看密钥集的JSON格式</p><pre class="jj jk jl jm fd lk ll lm bn ln lo bi"><span id="a2d4" class="lp kg hi ll b be lq lr l ls lt">select KEYS.KEYSET_TO_JSON(FROM_BASE64("CILf5s8IEmQKWAowdHlwZS5nb29nbGVhcGlzLmNvbS9nb29nbGUuY3J5cHR&lt;redacted&gt;"));</span></pre><pre class="lv lk ll lm bn ln lo bi"><span id="cc40" class="lp kg hi ll b be lq lr l ls lt">{<br/>  "key": [<br/>    {<br/>      "keyData": {<br/>        "keyMaterialType": "SYMMETRIC",<br/>        "typeUrl": "type.googleapis.com/google.crypto.tink.AesGcmKey",<br/>        "value": "&lt;redacted&gt;"<br/>      },<br/>      "keyId": 430410201,<br/>      "outputPrefixType": "TINK",<br/>      "status": "ENABLED"<br/>    },<br/>    {<br/>      "keyData": {<br/>        "keyMaterialType": "SYMMETRIC",<br/>        "typeUrl": "type.googleapis.com/google.crypto.tink.AesGcmKey",<br/>        "value": "&lt;redacted&gt;"<br/>      },<br/>      "keyId": 2314841986,<br/>      "outputPrefixType": "TINK",<br/>      "status": "ENABLED"<br/>    }<br/>  ],<br/>  "primaryKeyId": 2314841986<br/>}</span></pre><blockquote class="if ig ih"><p id="c4e1" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">对云KMS密钥的访问只需要提供给需要访问的进程或组。</p></blockquote><p id="f8fc" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">与KEYSET_ROTATE类似，ROTATE_WRAPPED_KEYSET用于旋转包装的键。</p><p id="bf7a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">生成的包装密钥集也可以作为使用tink库的python程序的一部分。</p><blockquote class="if ig ih"><p id="a64e" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">下面的程序只是一个示例程序，展示了tink客户端程序和BQ加密函数之间的可互换性。请不要使用下面的，因为它包含明文句柄，只能用于测试目的。</p><p id="bd83" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">更喜欢使用gcp kms的<a class="ae jh" href="https://developers.google.com/tink/generate-encrypted-keyset" rel="noopener ugc nofollow" target="_blank">加密密钥集句柄</a></p></blockquote><pre class="jj jk jl jm fd lk ll lm bn ln lo bi"><span id="77a6" class="lp kg hi ll b be lq lr l ls lt">import tink<br/>from tink import aead, cleartext_keyset_handle<br/>from tink.integration import gcpkms<br/>import base64<br/>import io<br/>from google.cloud import kms_v1<br/><br/>aead.register()<br/><br/>PROJECT = "&lt;&gt;"<br/>LOCATION = "us"<br/>KEY_RING = "tink_us_keyring"<br/><br/># Decrypting the Encrypted KEK from BQ Wrapped Keyset<br/>text = "CiQA3GVtLEAKCJE3Kmny5Cvg163nrtU0xLa2rvLCqA4DO0wrhqs&lt;redacted&gt;"<br/>client = kms_v1.KeyManagementServiceClient()<br/>key_name = client.crypto_key_path(project=PROJECT, location=LOCATION, key_ring=KEY_RING, crypto_key="tink_key")<br/>decrypt_response =  client.decrypt(request={'name': key_name, 'ciphertext': text })<br/>cipher = decrypt_response.plaintext<br/><br/># Creating handle for reading the binary decrypted keyset<br/>###### Only for demo purposes not for actual use<br/>keyset_handle = cleartext_keyset_handle.read(tink.BinaryKeysetReader(cipher))<br/>cipher = keyset_handle.primitive(aead.Aead)<br/>data = "AYn5r4LTlCK/dUgUGljXK29zl9cAATdCF4R1qrkFPKwxXYt5cBvO69EOftwK7ODp"<br/>output = cipher.decrypt(base64.b64decode(data.encode("utf-8")), b"Scientist")<br/>print(output.decode("utf-8"))<br/># Albert Einstein</span></pre></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><blockquote class="if ig ih"><p id="837e" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">我们将在系列的<a class="ae jh" rel="noopener" href="/google-cloud/gcp-bigquery-data-security-at-rest-part-4-c6f4db9a0f13">第4部分继续介绍动态安全控制的加密部分(DLP，KMS)。</a></p></blockquote><p id="52c6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">如有任何疑问，请通过https://www.linkedin.com/in/murli-krishnan-a1319842/与我联系。</p><p id="af79" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kq iv iw ix ku iz ja jb ky jd je jf jg hb bi translated">快乐学习。</p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><h2 id="5841" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">参考</h2><p id="1231" class="pw-post-body-paragraph ii ij hi il b im ld io ip iq le is it kq lf iw ix ku lg ja jb ky lh je jf jg hb bi translated"><a class="ae jh" href="https://developers.google.com/tink/" rel="noopener ugc nofollow" target="_blank"> Tink密码库</a> <br/> <a class="ae jh" href="https://www.youtube.com/watch?v=od44W45sCQ4" rel="noopener ugc nofollow" target="_blank"> AEAD密码简介</a> <br/> <a class="ae jh" href="https://cloud.google.com/kms/docs/envelope-encryption" rel="noopener ugc nofollow" target="_blank">信封加密</a> <br/> <a class="ae jh" href="https://en.wikipedia.org/wiki/Galois/Counter_Mode" rel="noopener ugc nofollow" target="_blank"> GCM(伽罗瓦计数器模式)</a> <br/> <a class="ae jh" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/aead_encryption_functions" rel="noopener ugc nofollow" target="_blank">加解密功能</a></p></div></div>    
</body>
</html>