<html>
<head>
<title>Warehousing Cloud Monitoring Alerts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">仓储云监控警报</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/warehousing-cloud-monitoring-alerts-b648e3746d9?source=collection_archive---------1-----------------------#2020-06-09">https://medium.com/google-cloud/warehousing-cloud-monitoring-alerts-b648e3746d9?source=collection_archive---------1-----------------------#2020-06-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/622c831bcec3cefc81e6b093144248e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LM95BmA01hzaXGs5g8mr2Q.png"/></div></div></figure><p id="01fe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在监控仪表板中，我们可以定义警报策略，以便在事件发生时通知我们。警报策略可以触发给操作人员的通知(例如电子邮件)。我们还可以看到以前事件的历史。但是，如果我们想要一个永久的事件记录用于审计或进一步分析，该怎么办呢？</p><p id="6e2e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一种解决方案是认识到当我们定义一个警报策略时，我们也有能力定义多个通知通道。我们可以使用的通知渠道类型包括发布/订阅。这意味着当事件打开或关闭时，描述事件性质的消息会发布到指定的发布/订阅主题。从这里，我们可以注册一个可以处理这些事件的订阅者，并保存它们以备后用。然后，我们可以将它们写入数据仓库(如BigQuery)或存储子系统(如Google Cloud Storage)。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es jo"><img src="../Images/2ff609fb122fb74d4e383cd36561440c.png" data-original-src="https://miro.medium.com/v2/resize:fit:806/format:webp/1*6pL3g3hpblT8V4tp5C3akA.png"/></div></figure><p id="4dbb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本文的剩余部分，我们将描述如何完成这项任务。我们将通过教程来说明这个故事。我们假设有一个名为“micro-1”的计算引擎实例正在运行。我们将设置一个CPU使用警报。当CPU变高时，警报将被触发，这是我们人为造成的。当警报触发时，它会将消息发布到Pub/Sub，我们将会看到这些消息。</p><ol class=""><li id="7c08" class="jt ju hi is b it iu ix iy jb jv jf jw jj jx jn jy jz ka kb bi translated">创建一个名为“提醒”的GCP发布/订阅主题。</li></ol><p id="19fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">转到发布/订阅页面，然后单击主题。</p><p id="aa93" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击+创建主题。</p><p id="8177" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输入名称“alerts”作为主题ID。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es kc"><img src="../Images/d85f80c8f43dbd72b7c238bef882cb56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/0*lrSoDG0FIkt4Rahm"/></div></figure><p id="482f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">单击创建主题。</p><p id="2d73" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.创建名为“提醒”的GCP发布/订阅。</p><p id="dd28" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">仍在名为“alerts”的主题的“主题详细信息”页面上，单击“创建订阅”按钮。</p><p id="49e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于订阅ID，输入通知的名称。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kd"><img src="../Images/d8193abb10cc498bf47a260f628d9e0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/0*w0MDl33Gh4GuwyFa"/></div></div></figure><p id="ee85" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.创建指向发布/订阅主题的云监控通知通道。</p><p id="7bef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在“警报”选项卡的“监视”页面中，单击编辑通知通道。</p><p id="bb2b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">找到云发布/订阅的条目，然后单击添加新项。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ke"><img src="../Images/540621dbe9fda8a5740681e864a82157.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zgBF4TyeqIcyYYYm"/></div></div></figure><p id="5d29" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为新通道指定显示名称alerts-pub-sub，并提供格式为的主题名称:</p><pre class="jp jq jr js fd kf kg kh ki aw kj bi"><span id="9783" class="kk kl hi kg b fi km kn l ko kp">projects/[PROJECT_ID]/topics/alerts</span></pre><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es kq"><img src="../Images/321a8cead28bcb5c842f62bd8a4ae7bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/0*nyBRBzouOlUqog0Z"/></div></figure><p id="0f58" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.允许监控发布到主题。</p><p id="8324" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在警报主题的发布/订阅页面中，单击显示信息面板。单击添加成员。</p><pre class="jp jq jr js fd kf kg kh ki aw kj bi"><span id="96da" class="kk kl hi kg b fi km kn l ko kp">service-<strong class="kg hj">PROJECT_NUMBER</strong>@gcp-sa-monitoring-notification.iam.gserviceaccount.com</span></pre><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es kr"><img src="../Images/9c92a3c682ab54698125a2b1e38d8d55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/0*pCUYJooSvDGITrBe"/></div></figure><p id="3bc6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.创建云监控警报策略。</p><p id="80f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击警报。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es ks"><img src="../Images/b381df3cfaeab50df917d5679df5068d.png" data-original-src="https://miro.medium.com/v2/resize:fit:582/0*wNALn5A_djXApxQZ"/></div></figure><p id="5e5e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击+创建策略</p><p id="512f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将该策略命名为“高cpu”。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es kt"><img src="../Images/0fbd5250b8c9b0ded0610f4f012a28be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1318/0*NZNsNKoxfiys5gg-"/></div></figure><p id="b631" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击“添加条件”</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es ku"><img src="../Images/454b9b373502e162b0cc9711b1e4fa07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/0*GVsx0nRVwsaWEd7d"/></div></figure><p id="8b40" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击添加。</p><p id="6205" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击添加通知渠道:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es kv"><img src="../Images/029aacd6abda417dbbe45f6e17f96688.png" data-original-src="https://miro.medium.com/v2/resize:fit:1114/0*wh-ZfRqRCpkmOaPX"/></div></figure><p id="6b8b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击保存。</p><p id="4a68" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.登录我们名为“micro-1”的计算引擎，并在其上运行CPU负载。</p><p id="cd2f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用SSH登录计算引擎。安装Linux压力命令:</p><pre class="jp jq jr js fd kf kg kh ki aw kj bi"><span id="ae01" class="kk kl hi kg b fi km kn l ko kp">sudo apt-get install stress</span></pre><p id="c9ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将CPU负载运行至100%</p><pre class="jp jq jr js fd kf kg kh ki aw kj bi"><span id="e927" class="kk kl hi kg b fi km kn l ko kp">stress --cpu 1</span></pre><p id="b5c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此时，计算引擎上的CPU负载为100%。如果我们连接了第二个SSH终端并运行top，我们将看到0%空闲。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/4b9016f6cb34e479314ab449bc97e710.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8GRVfNhpMSVqS7Fu"/></div></div></figure><p id="bee5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">等待三到四分钟，直到触发警报。访问云监控中的警报页面，每隔几分钟刷新一次页面，直到您看到一个活动事件:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kx"><img src="../Images/f294eb5172ca786e819694ef5dc338ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1baSnL5qxEJKHeT9"/></div></div></figure><p id="c76e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们查看发布的消息之前，我们现在将取消加载，并再次等待事件清除。在运行stress命令的终端中，用CTRL+C中断它。同样，在三到四分钟后不断刷新警报窗口，以查看事件消失。</p><p id="3869" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在可以访问发布/订阅页面，切换到订阅选项卡，查看警报订阅的详细信息。我们会发现有两条未确认的消息在等着我们。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ky"><img src="../Images/5baaaebe67c9e41d508538fad5a894d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DGFEH3_5HdyGT5iT"/></div></div></figure><p id="afb7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当CPU负载过高时，会打开一条事件消息。第二条消息是当CPU负载恢复正常时事件关闭。要查看这些消息，我们将从订阅中取出它们来查看它们的内容。从云Shell中，我们可以运行以下命令:</p><pre class="jp jq jr js fd kf kg kh ki aw kj bi"><span id="5f8b" class="kk kl hi kg b fi km kn l ko kp">gcloud pubsub subscriptions pull alerts \<br/>  --format="value(message.data)"</span></pre><p id="32a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将向我们显示消息的JSON内容。我们可以将它复制到一个JSON编辑器中，并重新格式化以提高可读性:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/3d7674fda6b323996769d9184a286e2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7Tu2YNwOshzh0ZMV"/></div></div></figure><p id="ea51" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们检查数据，我们会发现它包含了事件的所有细节。需要注意的一些事项是:</p><ul class=""><li id="ac97" class="jt ju hi is b it iu ix iy jb jv jf jw jj jx jn la jz ka kb bi translated">policy_name —导致事件生成的警报策略。</li><li id="1e47" class="jt ju hi is b it lb ix lc jb ld jf le jj lf jn la jz ka kb bi translated">状态—事件的状态。在本例中，它是开放的。</li><li id="27a7" class="jt ju hi is b it lb ix lc jb ld jf le jj lf jn la jz ka kb bi translated">started_at —检测到事件时的时间戳。</li><li id="3b9a" class="jt ju hi is b it lb ix lc jb ld jf le jj lf jn la jz ka kb bi translated">摘要—事件的可读描述。</li></ul><p id="b742" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在已经到了这样一个阶段，云指标生成的警报被捕获为订阅消息中的数据。我们现在可以根据需要将这些消息作为记录存储在文件中，或者插入到BigQuery之类的数据仓库中。要插入到BigQuery中，一种可能是将消息以换行符终止的JSON记录导出到一个文件中，然后从该文件创建一个BigQuery表。</p><p id="ee52" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是创建该文件的脚本:</p><figure class="jp jq jr js fd ij"><div class="bz dy l di"><div class="lg lh l"/></div></figure><p id="3c0b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后我们可以在大查询中创建一个表，使用:</p><figure class="jp jq jr js fd ij"><div class="bz dy l di"><div class="lg lh l"/></div></figure><p id="aab3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我们可以在BigQuery中看到数据:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es li"><img src="../Images/de366e61d19aa319a979f150a89ab68b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z2XNuzoo2PUKxfrb"/></div></div></figure><p id="02f7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想观看这项技术的演示，请点击这里:</p><figure class="jp jq jr js fd ij"><div class="bz dy l di"><div class="lj lh l"/></div></figure></div></div>    
</body>
</html>