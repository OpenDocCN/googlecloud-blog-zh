<html>
<head>
<title>Upload file to GCS, access with URL which expires using Spring Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将文件上传到GCS，通过使用Spring Cloud过期的URL访问</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/upload-file-to-gcs-create-url-which-expires-using-spring-cloud-f58d132aac74?source=collection_archive---------1-----------------------#2020-11-19">https://medium.com/google-cloud/upload-file-to-gcs-create-url-which-expires-using-spring-cloud-f58d132aac74?source=collection_archive---------1-----------------------#2020-11-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0659" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想上传一个文件到谷歌云存储(GCS)——无论是在GCP境内还是境外——并通过一个过期的URL访问上传的文件，这就是你要找的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/30682efd68a510adc974e0f683efbd96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pxVX6vfbTP7OuMnV1NKmjA.png"/></div></div></figure><p id="865b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将结合Spring Cloud libs使用Spring Boot反应库Webflux来访问Google云存储。</p><p id="7d9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将创建一个存储桶和一个私钥来访问该存储桶。然后，我们使用这个密钥从GCP外部访问这个桶。</p><h1 id="4aa1" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">履行</h1><p id="82ca" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated"><strong class="ih hj">第1部分:创建bucket，从服务帐户下载密钥</strong></p><p id="2158" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">登录您的GCP控制台。打开Google Shell并创建一个Bucket。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="6b09" class="kx jq hi kt b fi ky kz l la lb">gsutil mb gs://some-bucket</span></pre><p id="16dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保创建了存储桶后，导航到服务帐户部分。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lc"><img src="../Images/60f614f1a590dbb1417306c7460599e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kvVEQesNgOOCJD_TPuHtIw.png"/></div></div></figure><p id="34c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查找与新创建的存储桶相关联的服务帐户。</p><p id="86da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加新密钥:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ld"><img src="../Images/0949e3c2d0a0dae1ed7f771ae84b5c27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TIGdQBIWXWCiDQL0rRBjOA.png"/></div></div></figure><p id="6124" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该密钥将自动下载到浏览器中。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es le"><img src="../Images/498a3f3f060811ad3067c15bf27cd6b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K3zDuwk2uXgdOducghy9_A.png"/></div></div></figure><p id="d0d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">json的内容看起来会像这样。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="843f" class="kx jq hi kt b fi ky kz l la lb">{<br/>  <strong class="kt hj">"type"</strong>: <strong class="kt hj">"service_account"</strong>,<br/>  <strong class="kt hj">"project_id"</strong>: <strong class="kt hj">"someaccount-gcp-01-7f11684e7047"</strong>,<br/>  <strong class="kt hj">"private_key_id"</strong>: <strong class="kt hj">"..."</strong>,<br/>  <strong class="kt hj">"private_key"</strong>: <strong class="kt hj">"..."</strong>,<br/>  <strong class="kt hj">"client_email"</strong>: <strong class="kt hj">"someaccount-gcp-01-7f11684e7047@someaccount-gcp-01-7f11684e7047.iam.gserviceaccount.com"</strong>,<br/>  <strong class="kt hj">"client_id"</strong>: <strong class="kt hj">"..."</strong>,<br/>  <strong class="kt hj">"auth_uri"</strong>: <strong class="kt hj">"https://accounts.google.com/o/oauth2/auth"</strong>,<br/>  <strong class="kt hj">"token_uri"</strong>: <strong class="kt hj">"https://oauth2.googleapis.com/token"</strong>,<br/>  <strong class="kt hj">"auth_provider_x509_cert_url"</strong>: <strong class="kt hj">"https://www.googleapis.com/oauth2/v1/certs"</strong>,<br/>  <strong class="kt hj">"client_x509_cert_url"</strong>: <strong class="kt hj">"https://www.googleapis.com/robot/v1/metadata/x509/someaccount-gcp-01-7f11684e7047%40someaccount-gcp-01-7f11684e7047.iam.gserviceaccount.com"<br/></strong>}</span></pre><p id="bd96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第二部分:创建一个Spring Boot应用</strong></p><p id="6f91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">pom.xml</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="3abb" class="kx jq hi kt b fi ky kz l la lb"><em class="lf">&lt;?</em><strong class="kt hj">xml version="1.0" encoding="UTF-8"</strong><em class="lf">?&gt;<br/></em>&lt;<strong class="kt hj">project  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br/>   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</strong>&gt;<br/>   &lt;<strong class="kt hj">modelVersion</strong>&gt;4.0.0&lt;/<strong class="kt hj">modelVersion</strong>&gt;<br/>   &lt;<strong class="kt hj">parent</strong>&gt;<br/>      &lt;<strong class="kt hj">groupId</strong>&gt;org.springframework.boot&lt;/<strong class="kt hj">groupId</strong>&gt;<br/>      &lt;<strong class="kt hj">artifactId</strong>&gt;spring-boot-starter-parent&lt;/<strong class="kt hj">artifactId</strong>&gt;<br/>      &lt;<strong class="kt hj">version</strong>&gt;2.3.5.RELEASE&lt;/<strong class="kt hj">version</strong>&gt;<br/>      &lt;<strong class="kt hj">relativePath</strong>/&gt; <em class="lf">&lt;!-- lookup parent from repository --&gt;<br/>   </em>&lt;/<strong class="kt hj">parent</strong>&gt;<br/>   &lt;<strong class="kt hj">groupId</strong>&gt;com.example&lt;/<strong class="kt hj">groupId</strong>&gt;<br/>   &lt;<strong class="kt hj">artifactId</strong>&gt;springboot-gcs-signed-url&lt;/<strong class="kt hj">artifactId</strong>&gt;<br/>   &lt;<strong class="kt hj">version</strong>&gt;0.0.1-SNAPSHOT&lt;/<strong class="kt hj">version</strong>&gt;<br/>   &lt;<strong class="kt hj">name</strong>&gt;springboot-gcs-signed-url&lt;/<strong class="kt hj">name</strong>&gt;<br/>   &lt;<strong class="kt hj">description</strong>&gt;To upload a document to GCS and create a signed URL from it&lt;/<strong class="kt hj">description</strong>&gt;</span><span id="748f" class="kx jq hi kt b fi lg kz l la lb">   &lt;<strong class="kt hj">properties</strong>&gt;<br/>      &lt;<strong class="kt hj">java.version</strong>&gt;1.8&lt;/<strong class="kt hj">java.version</strong>&gt;<br/>      &lt;<strong class="kt hj">spring-cloud.version</strong>&gt;Hoxton.SR9&lt;/<strong class="kt hj">spring-cloud.version</strong>&gt;<br/>   &lt;/<strong class="kt hj">properties</strong>&gt;</span><span id="aa25" class="kx jq hi kt b fi lg kz l la lb">   &lt;<strong class="kt hj">dependencies</strong>&gt;<br/>      &lt;<strong class="kt hj">dependency</strong>&gt;<br/>         &lt;<strong class="kt hj">groupId</strong>&gt;org.springframework.boot&lt;/<strong class="kt hj">groupId</strong>&gt;<br/>         &lt;<strong class="kt hj">artifactId</strong>&gt;spring-boot-starter-webflux&lt;/<strong class="kt hj">artifactId</strong>&gt;<br/>      &lt;/<strong class="kt hj">dependency</strong>&gt;<br/>      &lt;<strong class="kt hj">dependency</strong>&gt;<br/>         &lt;<strong class="kt hj">groupId</strong>&gt;org.springframework.cloud&lt;/<strong class="kt hj">groupId</strong>&gt;<br/>         &lt;<strong class="kt hj">artifactId</strong>&gt;spring-cloud-gcp-starter-storage&lt;/<strong class="kt hj">artifactId</strong>&gt;<br/>      &lt;/<strong class="kt hj">dependency</strong>&gt;</span><span id="758a" class="kx jq hi kt b fi lg kz l la lb">      &lt;<strong class="kt hj">dependency</strong>&gt;<br/>         &lt;<strong class="kt hj">groupId</strong>&gt;org.springframework.boot&lt;/<strong class="kt hj">groupId</strong>&gt;<br/>         &lt;<strong class="kt hj">artifactId</strong>&gt;spring-boot-starter-test&lt;/<strong class="kt hj">artifactId</strong>&gt;<br/>         &lt;<strong class="kt hj">scope</strong>&gt;test&lt;/<strong class="kt hj">scope</strong>&gt;<br/>         &lt;<strong class="kt hj">exclusions</strong>&gt;<br/>            &lt;<strong class="kt hj">exclusion</strong>&gt;<br/>               &lt;<strong class="kt hj">groupId</strong>&gt;org.junit.vintage&lt;/<strong class="kt hj">groupId</strong>&gt;<br/>               &lt;<strong class="kt hj">artifactId</strong>&gt;junit-vintage-engine&lt;/<strong class="kt hj">artifactId</strong>&gt;<br/>            &lt;/<strong class="kt hj">exclusion</strong>&gt;<br/>         &lt;/<strong class="kt hj">exclusions</strong>&gt;<br/>      &lt;/<strong class="kt hj">dependency</strong>&gt;<br/>      &lt;<strong class="kt hj">dependency</strong>&gt;<br/>         &lt;<strong class="kt hj">groupId</strong>&gt;io.projectreactor&lt;/<strong class="kt hj">groupId</strong>&gt;<br/>         &lt;<strong class="kt hj">artifactId</strong>&gt;reactor-test&lt;/<strong class="kt hj">artifactId</strong>&gt;<br/>         &lt;<strong class="kt hj">scope</strong>&gt;test&lt;/<strong class="kt hj">scope</strong>&gt;<br/>      &lt;/<strong class="kt hj">dependency</strong>&gt;<br/>      &lt;<strong class="kt hj">dependency</strong>&gt;<br/>         &lt;<strong class="kt hj">groupId</strong>&gt;org.projectlombok&lt;/<strong class="kt hj">groupId</strong>&gt;<br/>         &lt;<strong class="kt hj">artifactId</strong>&gt;lombok&lt;/<strong class="kt hj">artifactId</strong>&gt;<br/>      &lt;/<strong class="kt hj">dependency</strong>&gt;<br/>   &lt;/<strong class="kt hj">dependencies</strong>&gt;</span><span id="66e5" class="kx jq hi kt b fi lg kz l la lb">   &lt;<strong class="kt hj">dependencyManagement</strong>&gt;<br/>      &lt;<strong class="kt hj">dependencies</strong>&gt;<br/>         &lt;<strong class="kt hj">dependency</strong>&gt;<br/>            &lt;<strong class="kt hj">groupId</strong>&gt;org.springframework.cloud&lt;/<strong class="kt hj">groupId</strong>&gt;<br/>            &lt;<strong class="kt hj">artifactId</strong>&gt;spring-cloud-dependencies&lt;/<strong class="kt hj">artifactId</strong>&gt;<br/>            &lt;<strong class="kt hj">version</strong>&gt;${spring-cloud.version}&lt;/<strong class="kt hj">version</strong>&gt;<br/>            &lt;<strong class="kt hj">type</strong>&gt;pom&lt;/<strong class="kt hj">type</strong>&gt;<br/>            &lt;<strong class="kt hj">scope</strong>&gt;import&lt;/<strong class="kt hj">scope</strong>&gt;<br/>         &lt;/<strong class="kt hj">dependency</strong>&gt;<br/>      &lt;/<strong class="kt hj">dependencies</strong>&gt;<br/>   &lt;/<strong class="kt hj">dependencyManagement</strong>&gt;</span><span id="5cc8" class="kx jq hi kt b fi lg kz l la lb">   &lt;<strong class="kt hj">build</strong>&gt;<br/>      &lt;<strong class="kt hj">plugins</strong>&gt;<br/>         &lt;<strong class="kt hj">plugin</strong>&gt;<br/>            &lt;<strong class="kt hj">groupId</strong>&gt;org.springframework.boot&lt;/<strong class="kt hj">groupId</strong>&gt;<br/>            &lt;<strong class="kt hj">artifactId</strong>&gt;spring-boot-maven-plugin&lt;/<strong class="kt hj">artifactId</strong>&gt;<br/>         &lt;/<strong class="kt hj">plugin</strong>&gt;<br/>      &lt;/<strong class="kt hj">plugins</strong>&gt;<br/>   &lt;/<strong class="kt hj">build</strong>&gt;</span><span id="cfc8" class="kx jq hi kt b fi lg kz l la lb">&lt;/<strong class="kt hj">project</strong>&gt;</span></pre><p id="a218" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里的关键库是:</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="65b5" class="kx jq hi kt b fi ky kz l la lb">spring-cloud-gcp-starter-storage</span></pre><p id="43e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在resources文件夹中创建文件key.json，并添加在第1部分的浏览器中下载的文件的内容。</p><p id="8ffb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">告诉GCP库像这样从key.json加载凭证:</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="ceef" class="kx jq hi kt b fi ky kz l la lb"><strong class="kt hj">spring.cloud.gcp.credentials.location</strong>=classpath:key.json</span></pre><p id="3030" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建StorageController。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="1877" class="kx jq hi kt b fi ky kz l la lb">@RestController<br/>@Slf4j<br/><strong class="kt hj">class </strong>StorageController {<br/><br/>    @Getter(AccessLevel.<strong class="kt hj"><em class="lf">PROTECTED</em></strong>)<br/>    @Setter(AccessLevel.<strong class="kt hj"><em class="lf">PROTECTED</em></strong>)<br/>    @Autowired<br/>    <strong class="kt hj">private </strong>Storage <strong class="kt hj">storage</strong>;<br/><br/>    @Value(<strong class="kt hj">"bucketname"</strong>)<br/>    String <strong class="kt hj">bucketName</strong>;<br/>    @Value(<strong class="kt hj">"subdirectory"</strong>)<br/>    String <strong class="kt hj">subdirectory</strong>;<br/><br/>    @PostMapping(value = <strong class="kt hj">"/upload"</strong>, consumes = MediaType.<strong class="kt hj"><em class="lf">MULTIPART_FORM_DATA_VALUE</em></strong>)<br/>    <strong class="kt hj">public </strong>Mono&lt;URL&gt; uploadFile(@RequestPart(<strong class="kt hj">"file"</strong>) FilePart filePart) {<br/>        <em class="lf">//Convert the file to a byte array<br/>        </em><strong class="kt hj">final byte</strong>[] byteArray = convertToByteArray(filePart);<br/><br/>        <em class="lf">//Prepare the blobId<br/>        //BlobId is a combination of bucketName + subdirectiory(optional) + fileName<br/>        </em><strong class="kt hj">final </strong>BlobId blobId = constructBlobId(<strong class="kt hj">bucketName</strong>, <strong class="kt hj">subdirectory</strong>, filePart.filename());<br/><br/>        <strong class="kt hj">return </strong>Mono.<em class="lf">just</em>(blobId)<br/>                <em class="lf">//Create the blobInfo<br/>                </em>.map(bId -&gt; BlobInfo.<em class="lf">newBuilder</em>(blobId)<br/>                        .setContentType(<strong class="kt hj">"text/plain"</strong>)<br/>                        .build())<br/>                <em class="lf">//Upload the blob to GCS<br/>                </em>.doOnNext(blobInfo -&gt; getStorage().create(blobInfo, byteArray))<br/>                <em class="lf">//Create a Signed "Path Style" URL to access the newly created Blob<br/>                //Set the URL expiry to 10 Minutes<br/>                </em>.map(blobInfo -&gt; createSignedPathStyleUrl(blobInfo, 10, TimeUnit.<strong class="kt hj"><em class="lf">MINUTES</em></strong>));<br/>    }<br/><br/>    <strong class="kt hj">private </strong>URL createSignedPathStyleUrl(BlobInfo blobInfo,<br/>                                         <strong class="kt hj">int </strong>duration, TimeUnit timeUnit) {<br/>        <strong class="kt hj">return </strong>getStorage()<br/>                .signUrl(blobInfo, duration, timeUnit, Storage.SignUrlOption.<em class="lf">withPathStyle</em>());<br/>    }<br/><br/>    <em class="lf">/**<br/>     * Construct Blob ID<br/>     *<br/>     * </em><strong class="kt hj"><em class="lf">@param bucketName<br/>     </em></strong><em class="lf">* </em><strong class="kt hj"><em class="lf">@param subdirectory </em></strong><em class="lf">optional<br/>     * </em><strong class="kt hj"><em class="lf">@param fileName<br/>     </em></strong><em class="lf">* </em><strong class="kt hj"><em class="lf">@return<br/>     </em></strong><em class="lf">*/<br/>    </em><strong class="kt hj">private </strong>BlobId constructBlobId(String bucketName, @Nullable String subdirectory,<br/>                                   String fileName) {<br/>        <strong class="kt hj">return </strong>Optional.<em class="lf">ofNullable</em>(subdirectory)<br/>                .map(s -&gt; BlobId.<em class="lf">of</em>(bucketName, subdirectory + <strong class="kt hj">"/" </strong>+ fileName))<br/>                .orElse(BlobId.<em class="lf">of</em>(bucketName, fileName));<br/>    }<br/><br/>    <em class="lf">/**<br/>     * Here, we convert the file to a byte array to be sent to GCS Libraries<br/>     *<br/>     * </em><strong class="kt hj"><em class="lf">@param filePart </em></strong><em class="lf">File to be used<br/>     * </em><strong class="kt hj"><em class="lf">@return </em></strong><em class="lf">Byte Array with all the contents of the file<br/>     */<br/>    </em>@SneakyThrows<br/>    <strong class="kt hj">private byte</strong>[] convertToByteArray(FilePart filePart) {<br/>        <strong class="kt hj">try </strong>(ByteArrayOutputStream bos = <strong class="kt hj">new </strong>ByteArrayOutputStream()) {<br/>            filePart.content()<br/>                    .subscribe(dataBuffer -&gt; {<br/>                        <strong class="kt hj">byte</strong>[] bytes = <strong class="kt hj">new byte</strong>[dataBuffer.readableByteCount()];<br/>                        <strong class="kt hj"><em class="lf">log</em></strong>.trace(<strong class="kt hj">"readable byte count:" </strong>+ dataBuffer.readableByteCount());<br/>                        dataBuffer.read(bytes);<br/>                        DataBufferUtils.<em class="lf">release</em>(dataBuffer);<br/>                        <strong class="kt hj">try </strong>{<br/>                            bos.write(bytes);<br/>                        } <strong class="kt hj">catch </strong>(IOException e) {<br/>                            <strong class="kt hj"><em class="lf">log</em></strong>.error(<strong class="kt hj">"read request body error..."</strong>, e);<br/>                        }<br/>                    });<br/><br/>            <strong class="kt hj">return </strong>bos.toByteArray();<br/>        }<br/>    }<br/><br/>}</span></pre><p id="a25b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们分解上面的代码，理解每一部分。</p><p id="419e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们将FilePart文件转换成一个字节数组。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="0c3b" class="kx jq hi kt b fi ky kz l la lb"><em class="lf">/**<br/> * Here, we convert the file to a byte array to be sent to GCS Libraries<br/> *<br/> * </em><strong class="kt hj"><em class="lf">@param filePart </em></strong><em class="lf">File to be used<br/> * </em><strong class="kt hj"><em class="lf">@return </em></strong><em class="lf">Byte Array with all the contents of the file<br/> */<br/></em>@SneakyThrows<br/><strong class="kt hj">private byte</strong>[] convertToByteArray(FilePart filePart) {<br/>    <strong class="kt hj">try </strong>(ByteArrayOutputStream bos = <strong class="kt hj">new </strong>ByteArrayOutputStream()) {<br/>        filePart.content()<br/>                .subscribe(dataBuffer -&gt; {<br/>                    <strong class="kt hj">byte</strong>[] bytes = <strong class="kt hj">new byte</strong>[dataBuffer.readableByteCount()];<br/>                    <strong class="kt hj"><em class="lf">log</em></strong>.trace(<strong class="kt hj">"readable byte count:" </strong>+ dataBuffer.readableByteCount());<br/>                    dataBuffer.read(bytes);<br/>                    DataBufferUtils.<em class="lf">release</em>(dataBuffer);<br/>                    <strong class="kt hj">try </strong>{<br/>                        bos.write(bytes);<br/>                    } <strong class="kt hj">catch </strong>(IOException e) {<br/>                        <strong class="kt hj"><em class="lf">log</em></strong>.error(<strong class="kt hj">"read request body error..."</strong>, e);<br/>                    }<br/>                });<br/><br/>        <strong class="kt hj">return </strong>bos.toByteArray();<br/>    }<br/>}</span></pre><p id="298a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们构造BlobId。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="e507" class="kx jq hi kt b fi ky kz l la lb"><em class="lf">/**<br/> * Construct Blob ID<br/> *<br/> * </em><strong class="kt hj"><em class="lf">@param bucketName<br/> </em></strong><em class="lf">* </em><strong class="kt hj"><em class="lf">@param subdirectory </em></strong><em class="lf">optional<br/> * </em><strong class="kt hj"><em class="lf">@param fileName<br/> </em></strong><em class="lf">* </em><strong class="kt hj"><em class="lf">@return<br/> </em></strong><em class="lf">*/<br/></em><strong class="kt hj">private </strong>BlobId constructBlobId(String bucketName, @Nullable String subdirectory,<br/>                               String fileName) {<br/>    <strong class="kt hj">return </strong>Optional.<em class="lf">ofNullable</em>(subdirectory)<br/>            .map(s -&gt; BlobId.<em class="lf">of</em>(bucketName, subdirectory + <strong class="kt hj">"/" </strong>+ fileName))<br/>            .orElse(BlobId.<em class="lf">of</em>(bucketName, fileName));<br/>}</span></pre><p id="d30a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个BlobId用于创建BlobInfo。这个BlobInfo用于将文件上传到GCS。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="522f" class="kx jq hi kt b fi ky kz l la lb">Mono.<em class="lf">just</em>(blobId)<br/>        <em class="lf">//Create the blobInfo<br/>        </em>.map(bId -&gt; BlobInfo.<em class="lf">newBuilder</em>(blobId)<br/>                .setContentType(<strong class="kt hj">"text/plain"</strong>)<br/>                .build())<br/>        <em class="lf">//Upload the blob to GCS<br/>        </em>.doOnNext(blobInfo -&gt; getStorage().create(blobInfo, byteArray))<br/>        <em class="lf">//Create a Signed "Path Style" URL to access the newly created Blob<br/>        //Set the URL expiry to 10 Minutes<br/>        </em>.map(blobInfo -&gt; createSignedPathStyleUrl(blobInfo, 10, TimeUnit.<strong class="kt hj"><em class="lf">MINUTES</em></strong>));</span></pre><p id="9952" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们继续创建一个设置了到期时间的URL。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="95e7" class="kx jq hi kt b fi ky kz l la lb"><strong class="kt hj">private </strong>URL createSignedPathStyleUrl(BlobInfo blobInfo,<br/>                                     <strong class="kt hj">int </strong>duration, TimeUnit timeUnit) {<br/>    <strong class="kt hj">return </strong>getStorage()<br/>            .signUrl(blobInfo, duration, timeUnit, <strong class="kt hj">Storage.SignUrlOption.<em class="lf">withPathStyle</em>()</strong>);<br/>}</span></pre><p id="50e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi lh translated">注意:我们正在使用“路径样式”创建一个URL。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="1412" class="kx jq hi kt b fi ky kz l la lb">Storage.SignUrlOption.<em class="lf">withPathStyle</em>()</span></pre><p id="a240" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">生成一个路径样式的URL，它将桶名放在URL的路径部分，而不是主机名中，例如'<a class="ae lq" href="https://storage.googleapis.com/mybucket/...'" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/mybucket/...'</a>。</p><p id="032f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，您可以使用其他样式，如虚拟托管样式，它将存储桶添加到URI的主机部分，而不是路径中，例如'<a class="ae lq" href="https://mybucket.storage.googleapis.com/...'" rel="noopener ugc nofollow" target="_blank">https://mybucket.storage.googleapis.com/...'</a></p><p id="68dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，在application.properties中添加以下属性</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="5a50" class="kx jq hi kt b fi ky kz l la lb"><strong class="kt hj">bucketname</strong>=bucketName<strong class="kt hj"><br/>subdirectory</strong>=media<strong class="kt hj"><br/>spring.cloud.gcp.credentials.location</strong>=classpath:key.json</span></pre><p id="bf11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">包的结构将是这样的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lr"><img src="../Images/ce766007c39f66c8a1784f1e9e9dccaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/1*8ffULQb2mCVULfrklvuT_w.png"/></div></figure><p id="ef75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在可以运行应用程序并执行下面的curl。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="ee1b" class="kx jq hi kt b fi ky kz l la lb">curl — location — request POST ‘<a class="ae lq" href="http://localhost:8080/upload'" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/upload'</a> \<br/> — form ‘file=@/Users/Sample.txt’</span></pre><p id="d469" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你会得到一个“路径风格”的网址。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="e095" class="kx jq hi kt b fi ky kz l la lb"><a class="ae lq" href="https://storage.googleapis.com/clwcirsomni-cart-podoc-stage/podocs/ad7313fc-0c54-4de4-9371-e3990bd2f7b4?GoogleAccessId=sa-gcs-omni-cart-podoc-stage@gcp-ushi-carbon-svcs-stage.iam.gserviceaccount.com&amp;Expires=1605773822&amp;Signature=FwQjidH9lryP9UjnKMixOsKVzksowirRIYNnthbcL%2FyVmQ8DkLvBXhMGoXys3qAVAuYQAPHEnl2KvetB%2FyVwF5kdHR4o3UeB3AyGvL1zJRjNq2Ymf%2F%2FTOue3bBmZJ6pal4bpxwryWECIzxhJm8CCnAZ1d6TIZtcoU7SzJBILlLwzGTT7n%2FOFthWdbvA7mjMKw%2Fg%2BnlQA8Ltr4mlTIBpfCsmw5Hl2jm%2FbI8zaOJc7%2BtpWhGTdiZww3hgjpEqIZe%2F2r9ZRDQRDPgEntZSymoV3xuI1WBAheYkY0ov7QbRrWi9eH8vGjnBRmwT7znUmS9rj3nUwVKsKfCRziCsOf3jdgw%3D%3D" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/some-bucket/media/ad7313fc-0c54-4de4-9371-e3990bd2f7b4?GoogleAccessId=sa-gcs-someaccount@some-project.iam.gserviceaccount.com&amp;Expires=1605773822&amp;Signature=FwQjidH9lryP9UjnKMixOsKVzksowirRIYNnthbcL%2FyVmQ8DkLvBXhMGoXys3qAVAuYQAPHEnl2KvetB%2FyVwF5kdHR4o3UeB3AyGvL1zJRjNq2Ymf%2F%2FTOue3bBmZJ6pal4bpxwryWECIzxhJm8CCnAZ1d6TIZtcoU7SzJBILlLwzGTT7n%2FOFthWdbvA7mjMKw%2Fg%2BnlQA8Ltr4mlTIBpfCsmw5Hl2jm%2FbI8zaOJc7%2BtpWhGTdiZww3hgjpEqIZe%2F2r9ZRDQRDPgEntZSymoV3xuI1WBAheYkY0ov7QbRrWi9eH8vGjnBRmwT7znUmS9rj3nUwVKsKfCRziCsOf3jdgw%3D%3D</a></span></pre><p id="d59b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将它粘贴到浏览器中，您就可以下载该文件了。</p><p id="5a37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">等待10分钟，让URL过期，然后再次尝试访问该URL。您将得到一个错误。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ls"><img src="../Images/ca4225e15149b49c453d510dc45b24d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nZSVtaPD1sGxnudFrK7GWw.png"/></div></div></figure><p id="284d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在GitHub <a class="ae lq" href="https://github.com/anoophp777/springboot-gcs-signed-url" rel="noopener ugc nofollow" target="_blank">中找到完整的项目。</a></p></div></div>    
</body>
</html>