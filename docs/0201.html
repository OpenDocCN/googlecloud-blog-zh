<html>
<head>
<title>Infrastructure as Code on Google Cloud Platform: Beginning Templates</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google云平台上的基础设施代码:初始模板</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/infrastructure-as-code-on-google-cloud-platform-beginning-templates-68882e68d666?source=collection_archive---------0-----------------------#2017-02-03">https://medium.com/google-cloud/infrastructure-as-code-on-google-cloud-platform-beginning-templates-68882e68d666?source=collection_archive---------0-----------------------#2017-02-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="625f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我使用谷歌部署管理器(GDM)所学到的知识的系列文章的第4部分</p><p id="d92e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">更新2017.09.01 </strong>:上周收到通知，下面提到的bug已经修复。我还没有机会测试它。</p><p id="c4bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">更新2017.04.04 </strong>:无法通过引用将服务账号权限分配给发布/订阅主题/订阅(见本文最后一个代码块)已经被Google承认为bug。目前还没有修复的预计时间:<a class="ae je" href="https://issuetracker.google.com/issues/35903722" rel="noopener ugc nofollow" target="_blank">https://issuetracker.google.com/issues/35903722</a></p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><p id="ef3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我上次提到我正在开始使用模板。我使用模板的目的是允许开发人员提供一个简化的配置，概述他们需要的基础设施，以便他们可以根据需要创建和修改它。如果你读了我的上一篇文章，你会发现开发人员要学习创建一个部署配置所需的所有东西需要做多少工作——我是说真的，开发人员有编程之类的事情要做，你知道吗？如果我能提供一个简化的配置，并在一个模板中处理所有潜在的复杂性，哇哦！</p><p id="44ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我还没有自大到认为自己足够聪明，可以用负载平衡器开始我的模板之旅。我从更简单的东西开始——我是服务客户。到目前为止，我已经将所有的配置文件存储在一个config文件夹中。为了便于组织，我决定在子目录中创建模板，并在其中创建助手:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="bc49" class="jv jw hi jr b fi jx jy l jz ka">[dbayer: ~/tmp]$ tree -d config<br/>config<br/>└── templates<br/>    └── helpers</span></pre><p id="d17e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从服务帐户的现有配置开始:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="02b8" class="jv jw hi jr b fi jx jy l jz ka">resources:<br/>- name: dav-svcaccount<br/>  type: iam.v1.serviceAccount<br/>  properties:<br/>    accountId: dav-svcaccount<br/>    displayName: dav-svcaccount</span><span id="59cb" class="jv jw hi jr b fi kb jy l jz ka">outputs:<br/>- name: serviceAccountEmail<br/>  value: $(ref.dav-svcaccount.email)</span></pre><p id="647b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这很简单，但肯定有一些重复可以消除。模板可以用Python或者Jinja编写。因为它更像原始配置中的YAML(也更像我顺便熟悉的ERB模板)，我选择了Jinja。目前有4个可用的环境变量:project(GCP项目名称)、deployment(部署名称)、name(资源名称)和type(资源类型)。这是我想到的:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="c799" class="jv jw hi jr b fi jx jy l jz ka">resources:<br/>- name: {{ env['name'] }}-serviceaccount<br/>  type: iam.v1.serviceAccount<br/>  properties:<br/>    accountId: {{ env['name'] }}<br/>    displayName: {{ env['name'] }}</span><span id="c3f0" class="jv jw hi jr b fi kb jy l jz ka">outputs:<br/>- name: email<br/>  value: $(ref.{{ env['name'] }}-serviceaccount.email)</span></pre><p id="f2c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">记住要在模板中输出电子邮件地址——这就是它稍后显示在您的配置文件中的方式。现在，我可以重写我的配置以使用该模板—您必须导入该模板以使其可用:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="9057" class="jv jw hi jr b fi jx jy l jz ka">imports:<br/>- path: templates/svcaccount.jinja</span><span id="e712" class="jv jw hi jr b fi kb jy l jz ka">resources:<br/>- name: dav-svcaccount<br/>  type: templates/svcaccount.jinja</span><span id="4f96" class="jv jw hi jr b fi kb jy l jz ka">outputs:<br/>- name: serviceAccountEmail<br/>  value: $(ref.dav-svcaccount.email)</span></pre><p id="ffc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">嘿——现在我的开发人员只需要指定模板和服务帐户名！(最终，我的目标是简化流程并将其添加到Jenkins基础设施中，但这是以后的事了。)</p><p id="9642" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们转到稍微难一点的话题——发布/订阅主题和订阅。让我们从基本配置开始:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="ec08" class="jv jw hi jr b fi jx jy l jz ka">resources:<br/>- name: dav-pubsub-topic<br/>  type: pubsub.v1.topic<br/>  properties:<br/>    topic: dav-pubsub-topic<br/>  accessControl:<br/>    gcpIamPolicy:<br/>      bindings:<br/>      - role: roles/pubsub.publisher<br/>        members:<br/>        - "serviceAccount:dav-svcaccount@myproject.iam.gserviceaccount.com"<br/>      - role: roles/pubsub.viewer<br/>        members:<br/>        - "serviceAccount:dav-svcaccount@myproject.iam.gserviceaccount.com"<br/>- name: dav-pubsub-subscription<br/>  type: pubsub.v1.subscription<br/>  properties:<br/>    subscription: dav-pubsub-subscription<br/>    topic: $(ref.dav-pubsub-topic.name)<br/>    ackDeadlineSeconds: 600<br/>  accessControl:<br/>    gcpIamPolicy:<br/>      bindings:<br/>      - role: roles/pubsub.subscriber<br/>        members:<br/>        - "serviceAccount:dav-svcaccount@myproject.iam.gserviceaccount.com"<br/>      - role: roles/pubsub.viewer<br/>        members:<br/>        - "serviceAccount:dav-svcaccount@myproject.iam.gserviceaccount.com"</span></pre><p id="fa35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同样，这里有很多重复，所以它是一个很好的模板候选。以下是Jinja中的模板:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="db90" class="jv jw hi jr b fi jx jy l jz ka">resources:<br/>- name: {{ env['name'] }}-topic<br/>  type: pubsub.v1.topic<br/>  properties:<br/>    topic: {{ env['name'] }}<br/>  accessControl:<br/>    gcpIamPolicy:<br/>      bindings:<br/>      - role: roles/pubsub.publisher<br/>        members:<br/>        - "serviceAccount:{{ properties['serviceAccountEmail'] }}"<br/>      - role: roles/pubsub.viewer<br/>        members:<br/>        - "serviceAccount:{{ properties['serviceAccountEmail'] }}"<br/>- name: {{ env['name'] }}-subscription<br/>  type: pubsub.v1.subscription<br/>  properties:<br/>    subscription: {{ env['name'] }}-sub<br/>    topic: $(ref.{{ env['name'] }}-topic.name)<br/>    ackDeadlineSeconds: {{ properties['ackDeadlineSeconds'] }}<br/>  accessControl:<br/>    gcpIamPolicy:<br/>      bindings:<br/>      - role: roles/pubsub.subscriber<br/>        members:<br/>        - "serviceAccount:{{ properties['serviceAccountEmail'] }}"<br/>      - role: roles/pubsub.viewer<br/>        members:<br/>        - "serviceAccount:{{ properties['serviceAccountEmail'] }}"</span></pre><p id="2076" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这允许以下更简单的配置:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="0e4d" class="jv jw hi jr b fi jx jy l jz ka">imports:<br/>- path: templates/pubsub.jinja</span><span id="7899" class="jv jw hi jr b fi kb jy l jz ka">resources:<br/>- name: dav-pubsub<br/>  type: templates/vst-pubsub.jinja<br/>  properties:<br/>    serviceAccountEmail: "dav-svcaccount@myproject.iam.gserviceaccount.com"<br/>    ackDeadlineSeconds: 600</span></pre><p id="7ef1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们对存储桶做同样的尝试。采用以下配置:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="a7c4" class="jv jw hi jr b fi jx jy l jz ka">resources:<br/>- name: dav-bucket<br/>  type: storage.v1.bucket<br/>  properties:<br/>    storageClass: MULTI_REGIONAL<br/>    acl:<br/>    - role: OWNER<br/>      entity: "project-owners-1234567890"<br/>    - role: READER<br/>      entity: "project-viewers-1234567890"<br/>    - role: OWNER<br/>      entity: "project-editors-1234567890"<br/>    - role: OWNER<br/>      entity: "user-dav-svcaccount@myproject.iam.gserviceaccount.com"</span></pre><p id="113c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一次，模板看起来有点不同——我添加了一些逻辑，以允许多个用户添加到所有者、作者和读者角色，以及一些逻辑，以便在配置中不需要这些:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="7ca8" class="jv jw hi jr b fi jx jy l jz ka">resources:<br/>- name: {{ env['name'] }}<br/>  type: storage.v1.bucket<br/>  properties:<br/>    storageClass: {{ properties['storageClass'] }}<br/>    acl:<br/>    - role: OWNER<br/>      entity: "project-owners-1234567890"<br/>    - role: READER<br/>      entity: "project-viewers-1234567890"<br/>    - role: OWNER<br/>      entity: "project-editors-1234567890"<br/>{% if properties['owners'] %}<br/>{% for user in properties['owners'] %}<br/>    - role: OWNER<br/>      entity: "user-{{ user }}"<br/>{% endfor %}<br/>{% endif %}<br/>{% if properties['editors'] %}<br/>{% for user in properties['editors'] %}<br/>    - role: WRITER<br/>      entity: "user-{{ user }}"<br/>{% endfor %}<br/>{% endif %}<br/>{% if properties['readers'] %}<br/>{% for user in properties['readers'] %}<br/>    - role: READER<br/>      entity: "user-{{ user }}"<br/>{% endfor %}<br/>{% endif %}</span></pre><p id="7003" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这进而导致以下配置:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="cc8c" class="jv jw hi jr b fi jx jy l jz ka">imports:<br/>- path: templates/bucket.jinja</span><span id="bfae" class="jv jw hi jr b fi kb jy l jz ka">resources:<br/>- name: dav-bucket<br/>  type: templates/svcaccount.jinja<br/>  properties:<br/>    storageClass: MULTI_REGIONAL<br/>    owners:<br/>    - dav-svcaccount1@myproject.iam.gserviceaccount.com</span></pre><p id="8a75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">很遗憾，此模板有一个问题。它工作得很好，但是需要将项目编号硬编码到模板中。您必须为您处理的每个GCP项目创建单独的模板副本。</p><p id="d33a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在开始这次旅程之前，我对金贾一无所知，为此我做了大量的搜索。您应该记得，从这篇文章的开始，Jinja模板可以使用项目名称，但不能使用项目编号。</p><p id="bf2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">进入模板助手模块。这不是一个非常好的解决方案，但是比维护模板的多个副本要好得多。如果您还记得，前面我说过模板可以是Jinja或Python格式。通过切换到Python，我可以在我的模板中包含助手脚本。对于这种情况，我用字典编写了一个简单的函数，其中包含我使用的项目名称和编号。由于项目名称可用于我的模板，所以我可以将名称传递给助手脚本并取回编号。</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="1e75" class="jv jw hi jr b fi jx jy l jz ka">def GetProjectNumber(projectId):<br/>    project = {'myproject': '1234567890',<br/>            'myproject2': '0987654321',<br/>            'myproject3': '6789012345'<br/>            }<br/>    return project[projectId]</span></pre><p id="8f5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我可以简单地在这个地方维护项目列表，或者有一天可能写一个脚本来更新它。我对助手本身没有太多的了解——默认情况下，可用的库非常有限，您必须为想要导入的任何其他库提供完整的源代码。系统调用是明确禁止的，如果模板进行系统调用，将会失败。</p><p id="4222" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“但是大卫，”你说。"现在我已经有了我的助手函数，我该如何使用它？"</p><p id="0860" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我很高兴你问了。现在我们必须用Python重写我们的Jinja模板，结果是:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="b69c" class="jv jw hi jr b fi jx jy l jz ka">from templates.helpers import projectNumber</span><span id="90d0" class="jv jw hi jr b fi kb jy l jz ka">def GenerateConfig(context):<br/>    PROJECT_NUMBER = projectNumber.GetProjectNumber(context.env['project'])<br/>    resources = [{<br/>        'name': context.env['name'],<br/>        'type': 'storage.v1.bucket',<br/>        'properties': {<br/>            'storageClass': context.properties['storageClass'],<br/>            'acl': [{<br/>                'role': 'OWNER',<br/>                'entity': 'project-owners-' + PROJECT_NUMBER<br/>                },{<br/>                    'role': 'OWNER',<br/>                    'entity': 'project-editors-' + PROJECT_NUMBER<br/>                },{<br/>                    'role': 'READER',<br/>                    'entity': 'project-viewers-' + PROJECT_NUMBER<br/>                }]<br/>            }<br/>        }]</span><span id="e9bd" class="jv jw hi jr b fi kb jy l jz ka">if 'owners' in context.properties:<br/>        for owner in context.properties['owners']:<br/>            resources.properties.acl.append({<br/>                'role': 'OWNER',<br/>                'entity': 'user-' + owner<br/>                })</span><span id="b160" class="jv jw hi jr b fi kb jy l jz ka">if 'editors' in context.properties:<br/>        for editor in context.properties['editors']:<br/>            resources[0]['properties']['acl'].append({<br/>                'role': 'WRITER',<br/>                'entity': 'user-' + editor<br/>                })</span><span id="049c" class="jv jw hi jr b fi kb jy l jz ka">if 'readers' in context.properties:<br/>        for reader in context.properties['readers']:<br/>            resources[0]['properties']['acl'].append({<br/>                'role': 'READER',<br/>                'entity': 'user-' + reader<br/>                })</span><span id="339d" class="jv jw hi jr b fi kb jy l jz ka">return {'resources': resources}</span></pre><p id="ea90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还必须记住在您的YAML文件中包含助手模块，以便一切正常工作:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="88ed" class="jv jw hi jr b fi jx jy l jz ka">imports:<br/>- path: templates/bucket.py<br/>- path: templates/helpers/projectNumber.py</span><span id="e6ab" class="jv jw hi jr b fi kb jy l jz ka">resources:<br/>- name: dav-bucket<br/>  type: templates/svcaccount.jinja<br/>  properties:<br/>    storageClass: MULTI_REGIONAL<br/>    owners:<br/>    - dav-svcaccount@myproject.iam.gserviceaccount.com</span></pre><p id="d6d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您不能组合Python和Jinja模板——部署管理器会抱怨很多，并给出一些关于Python编译错误和Jinja文件的神秘错误。然而，一旦所有的模板都被转换了，它允许开发人员提供一个类似于下面的配置，并且允许运营人员随着情况的变化更新底层的模板。开发人员可以提供如下内容:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="3b76" class="jv jw hi jr b fi jx jy l jz ka">imports:<br/>- path: templates/svcaccount.jinja<br/>- path: templates/pubsub.jinja<br/>- path: templates/bucket.py<br/>- path: templates/helpers/projectNumber.py</span><span id="2560" class="jv jw hi jr b fi kb jy l jz ka">resources:<br/>- name: dav-svcaccount<br/>  type: templates/svcaccount.jinja</span><span id="71d2" class="jv jw hi jr b fi kb jy l jz ka">- name: dav-pubsub<br/>  type: templates/vst-pubsub.jinja<br/>  properties:<br/>    serviceAccountEmail: "dav-svcaccount@myproject.iam.gserviceaccount.com"<br/>                         # deployment still fails if email provided by reference :-(<br/>    ackDeadlineSeconds: 600</span><span id="9e48" class="jv jw hi jr b fi kb jy l jz ka">- name: dav-bucket<br/>  type: templates/svcaccount.jinja<br/>  properties:<br/>    storageClass: MULTI_REGIONAL<br/>    owners:<br/>    - $(ref.dav-svcaccount.email)</span><span id="1871" class="jv jw hi jr b fi kb jy l jz ka">outputs:<br/>- name: serviceAccountEmail<br/>  value: $(ref.dav-svcaccount.email)</span></pre><p id="c313" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们真正开始了部署管理器之旅！我当然希望我的模板会随着我获得更多的经验而改进。我对这方面的了解很少，但是下一次我希望使用模板来简化负载平衡器的构建。</p></div></div>    
</body>
</html>