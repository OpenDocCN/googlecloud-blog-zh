<html>
<head>
<title>Perform real time anomaly detection using Google Cloud’s Timeseries Insights API — Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Cloud的Timeseries Insights API执行实时异常检测—第二部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/perform-real-time-anomaly-detection-using-google-clouds-timeseries-insights-api-part-ii-54520586ad6d?source=collection_archive---------1-----------------------#2022-10-12">https://medium.com/google-cloud/perform-real-time-anomaly-detection-using-google-clouds-timeseries-insights-api-part-ii-54520586ad6d?source=collection_archive---------1-----------------------#2022-10-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="f77c" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">概述了一种易于使用的API，可通过低延迟异常检测和预测来扩展数十亿个时间序列</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/8bbdd747db4b95abb14cc32e37ec98e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JaPaBygNz_STIUji"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">克里斯·利维拉尼在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="73b7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这是执行实时异常检测系列的第二部分。如果你还没有，看看这篇博客的第一部分 的<a class="ae jn" rel="noopener" href="/google-cloud/perform-real-time-anomaly-detection-using-google-clouds-timeseries-insights-api-part-i-f6572021ac0">，了解一下基本设置，熟悉一下用例以及设置细节。</a></p><p id="907f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在本文中，我将重点关注在现有的Timeseries Insights API数据集中接收和追加流数据，并使用现有数据集中新添加的事件来查询异常。我还将介绍如何删除未使用的API数据集，坦白地说，这是一个非常直接的过程，因此本文的主要重点是在相同的附加事件上附加新数据和异常查询。</p><p id="71c8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">正如在本系列的第一部分中所讨论的，Timeseries Insights API对于实时异常检测和预测来说是非常高效的低代码选项。该API还为查询提供了非常低的延迟，这使得它成为在实时业务至关重要的地方使用的好选择。</p><p id="1a22" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">正如您现在所知道的，有四种主要方法可以与Timeseries insights API进行交互。这些是:</p><ul class=""><li id="dc57" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kp kq kr ks bi translated"><strong class="jq hj">创建并加载数据集✔️ </strong></li><li id="dffc" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated"><strong class="jq hj">查询数据集✔️ </strong></li><li id="bf08" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated"><strong class="jq hj">更新数据集(在现有数据集中追加流/新事件)</strong></li><li id="eb5e" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated"><strong class="jq hj">删除数据集</strong></li></ul><p id="7bac" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在第一部分的<a class="ae jn" rel="noopener" href="/p/f6572021ac0">中，我回顾了创建API数据集和查询异常的过程。在本文中，我将从在现有数据集中追加事件开始。在我们开始接收新数据之前，让我们考虑一下这个用例的端到端架构。</a></p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ky"><img src="../Images/d4d439a27fb402bccecebf6e096c5fe0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lt59zWe9fWE9H_WUARFe7A.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图1 —使用传感器数据架构的异常检测</figcaption></figure><p id="90fa" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">该架构中使用的服务包括:</p><ul class=""><li id="654f" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kp kq kr ks bi translated">发布/订阅</li><li id="c09d" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">应用引擎/云运行(不是本教程的重点)</li><li id="e3cc" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">云函数</li><li id="8bbd" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">时间序列洞察API</li><li id="c0b0" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">BigQuery</li><li id="13b9" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">Data Studio/Looker(不是本教程的重点)</li></ul><p id="71d6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">架构流程:</p><ol class=""><li id="fad5" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kz kq kr ks bi translated">首先，来自客户端的传感器或物联网设备记录温度、湿度、光照和氢气值等读数，并将这些数据实时(每隔x秒左右)发送到发布/订阅主题</li><li id="2328" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kz kq kr ks bi translated">发布/订阅接收传入的数据负载，并使用http端点触发云功能来处理事件。</li><li id="b324" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kz kq kr ks bi translated">云功能使用app engine服务验证传入的用户请求。</li><li id="b02a" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kz kq kr ks bi translated">一旦请求被验证，它就执行诸如数据预处理、特征工程</li><li id="95ed" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kz kq kr ks bi translated">云函数调用Timeseries insights api进行异常检测。</li><li id="1c3d" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kz kq kr ks bi translated">Timeseries insight API返回异常结果。</li><li id="1bb3" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kz kq kr ks bi translated">Cloud function还调用BigQuery流API将原始事件和异常结果摄取到一个表中，以便对原始事件进行进一步分析，如使用报告生成、异常结果分析等</li><li id="f8f8" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kz kq kr ks bi translated">最终用户使用data studio或looker等工具访问报告/可视化</li></ol><p id="e7cb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">出于本教程的目的，我将只关注通过调用API进行摄取和异常检测。要获得完整的云函数代码，请查看本教程末尾的参考资料部分。</p><p id="5fbd" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">所以让我们开始吧！</p><h1 id="887f" class="la lb hi bd lc ld le lf lg lh li lj lk io ll ip lm ir ln is lo iu lp iv lq lr bi translated"><strong class="ak"> 3。在现有数据集中追加流/新事件</strong></h1><p id="f848" class="pw-post-body-paragraph jo jp hi jq b jr ls ij jt ju lt im jw jx lu jz ka kb lv kd ke kf lw kh ki kj hb bi translated">这是Timeseries Insights API中我最喜欢的部分，您可以以流的方式将数据添加到现有的数据集中，API会对这些数据进行实时索引。在数据集中追加新事件并完成索引后，可以立即查询异常和预测。这是一个非常常见的物联网用例，其中数据正在流入，我们需要使用该数据流实时做出业务决策。</p><p id="5964" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><code class="du lx ly lz ma b">appendEvents</code> API方法允许你添加新的事件到现有的数据集中。追加新事件的步骤如下:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mb"><img src="../Images/1d75ef2641295fc40efe93fe69503d1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:622/format:webp/1*zmY0Nti1NIPkbmrvII1WxA.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">事件附加时间线</figcaption></figure><p id="3f0f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">此外，在API中添加新事件时，您需要注意一些事情:</p><ol class=""><li id="58b2" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kz kq kr ks bi translated">使用<a class="ae jn" href="https://cloud.google.com/timeseries-insights/docs/reference/rest/v1/projects.datasets/appendEvents" rel="noopener ugc nofollow" target="_blank"> appendEvents </a>方法不能添加很久以前的事件。<code class="du lx ly lz ma b">appendEvents</code>方法不用于回填时间序列中的数据，因此被追加的事件的时间戳需要在当前日期时间左右。使用下面的方法来确定追加数据可以追溯到历史的多远。</li></ol><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mc"><img src="../Images/16c120f376fc82e9d3cb73d4055a4b7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*UFRnc6EFunT4MyYSGADZVA.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">新事件附加年表</figcaption></figure><p id="86c4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">ttl在这里代表生存时间。这是在Timeseries API中创建数据集时设置的可选属性，如果数据集将用于以流方式追加新事件。如果您的数据集不接受新事件，那么您不需要设置它。ttl的值以秒为单位设置，这表明API将接受哪些传入事件。如果传入的时间戳值高于ttl值，则该事件将被添加到数据集，旧事件将被丢弃。</p><p id="784a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">2.当您在现有数据集中追加一个事件时，您只能使用<code class="du lx ly lz ma b">evaluateSlice</code>方法来查看该事件。使用列表数据集的行数不能反映数据集中新的行数，如果用户使用列表方法查找数据集中的总行数，这可能会使用户感到困惑。</p><p id="91a3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了在API中追加一个新事件，我们需要具有所有维度的有效载荷(类似于我们为数据集创建方法创建的有效载荷)并调用API的<a class="ae jn" href="https://cloud.google.com/timeseries-insights/docs/reference/rest/v1/projects.datasets/appendEvents" rel="noopener ugc nofollow" target="_blank"> appendEvents </a>方法。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="4a92" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">一旦添加了事件，就可以使用<code class="du lx ly lz ma b">evaluateSlice</code>方法来评估加载数据集中的数据片。这是一个可以用来查看API构建的时间序列的选项。</p><p id="48e8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">下面是示例json负载，展示了我们想要评估的事件。调用<code class="du lx ly lz ma b">evaluateSlice</code>方法后返回的对象是<a class="ae jn" href="https://cloud.google.com/timeseries-insights/docs/reference/rest/v1/EvaluatedSlice" rel="noopener ugc nofollow" target="_blank"> EvaluatedSlice </a>的一个实例</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="md me l"/></div></figure><blockquote class="mf mg mh"><p id="389a" class="jo jp mi jq b jr js ij jt ju jv im jw mj jy jz ka mk kc kd ke ml kg kh ki kj hb bi translated"><strong class="jq hj">注意</strong>:这里需要特别注意的是，在现有Timeseries Insights API数据集中追加新事件不允许直接访问该事件，也就是说，如果您希望对该数据执行额外的分析，您需要在追加API数据集中的同时将原始事件保存到单独的表中。例如，如果用于创建API数据集的历史数据存储在BigQuery表中，那么您可以根据用例使用传统的<a class="ae jn" href="https://cloud.google.com/bigquery/docs/samples/bigquery-table-insert-rows" rel="noopener ugc nofollow" target="_blank"> Bigquery流插入API </a>或<a class="ae jn" href="https://cloud.google.com/bigquery/docs/write-api" rel="noopener ugc nofollow" target="_blank">存储写入API </a>将传入事件写入Bigquery表中。</p></blockquote><h1 id="1f12" class="la lb hi bd lc ld le lf lg lh li lj lk io ll ip lm ir ln is lo iu lp iv lq lr bi translated"><strong class="ak"> 4。删除数据集</strong></h1><p id="fbef" class="pw-post-body-paragraph jo jp hi jq b jr ls ij jt ju lt im jw jx lu jz ka kb lv kd ke kf lw kh ki kj hb bi translated">在Timeseris Insights API中删除不需要的数据集非常容易。每一个数据集都是被创建和索引的，都是收费的，创建许多数据集用于测试变得很容易，所以有时我们需要从API中删除那些不需要和未使用的数据集。API有<code class="du lx ly lz ma b">delete</code>方法来删除数据集。你只需要我们空体来传入http API端点。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="46d3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">可选:端到端云功能代码</strong></p><p id="a9e3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">下面是创建云函数、发布/订阅主题和发布新事件到发布/订阅以触发云函数的一些可选代码，您可以使用云函数来创建上面图1中架构图所示的端到端流。该云函数执行以下操作:</p><ul class=""><li id="0189" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kp kq kr ks bi translated">解析传入的有效负载(发布到发布/订阅主题)</li><li id="262a" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">为新的传入事件创建适当的json格式</li><li id="44e9" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">向现有API数据集追加新事件</li><li id="f76c" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">对新事件执行异常检测或预测</li><li id="4798" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">将结果插入到BigQuery原始事件表中以供进一步分析</li><li id="819e" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">返回异常检测或预测结果以供下游分析使用</li></ul><ol class=""><li id="d820" class="kk kl hi jq b jr js ju jv jx km kb kn kf ko kj kz kq kr ks bi translated">云函数的requirement.txt</li></ol><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="d579" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">2.云函数的main.py</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="075e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">3.创建发布/订阅主题和云功能，并向发布/订阅主题发布消息以触发云功能</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="md me l"/></div></figure><h1 id="f81a" class="la lb hi bd lc ld le lf lg lh li lj lk io ll ip lm ir ln is lo iu lp iv lq lr bi translated">资源</h1><ul class=""><li id="d264" class="kk kl hi jq b jr ls ju lt jx mm kb mn kf mo kj kp kq kr ks bi translated"><a class="ae jn" href="https://cloud.google.com/timeseries-insights" rel="noopener ugc nofollow" target="_blank"> Timeseries Insights API官方文档</a></li><li id="1fa2" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated"><a class="ae jn" href="https://cloud.google.com/timeseries-insights/docs/overview" rel="noopener ugc nofollow" target="_blank">产品概述页面</a></li><li id="bc80" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated"><a class="ae jn" href="https://cloud.google.com/timeseries-insights/docs/getting-started" rel="noopener ugc nofollow" target="_blank">使用API前的设置说明</a></li><li id="b0e5" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated"><a class="ae jn" href="https://cloud.google.com/timeseries-insights/docs/tutorial" rel="noopener ugc nofollow" target="_blank"> API教程</a></li><li id="76ce" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated"><a class="ae jn" href="https://cloud.google.com/timeseries-insights/docs/query-building-guide" rel="noopener ugc nofollow" target="_blank"> API查询构建指南</a></li><li id="c1d0" class="kk kl hi jq b jr kt ju ku jx kv kb kw kf kx kj kp kq kr ks bi translated">端到端笔记本和<a class="ae jn" href="https://github.com/nishitpatel01/google-cloud/tree/main/AI%20%26%20Machine%20Learning/01%20-%20Pre-built%20ML%20APIs" rel="noopener ugc nofollow" target="_blank"> github </a>上的代码</li></ul></div></div>    
</body>
</html>