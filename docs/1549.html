<html>
<head>
<title>Fine-grained Cloud DNS IAM via Service Directory</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过服务目录的细粒度云DNS IAM</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/fine-grained-cloud-dns-iam-via-service-directory-446058b4362e?source=collection_archive---------0-----------------------#2020-08-06">https://medium.com/google-cloud/fine-grained-cloud-dns-iam-via-service-directory-446058b4362e?source=collection_archive---------0-----------------------#2020-08-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/5d227f184315a824512668694704a9a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u2_mym4kFN5ixfogr2iUKg.jpeg"/></div></div></figure><p id="41f9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">服务目录是对目前处于测试阶段的GCP产品的一个相对较新的补充，它为发现、发布和连接服务及其端点提供了一个托管解决方案。这篇短文和示例展示了如何利用其云DNS集成来解决支持DNS区域和记录的细粒度IAM控制的常见问题。</p><p id="23f6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们深入这个例子之前，让我们快速看一下服务目录<a class="ae jo" href="https://cloud.google.com/service-directory/docs/overview#key_concepts" rel="noopener ugc nofollow" target="_blank">原语</a>:</p><ul class=""><li id="410a" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><strong class="is hj">名称空间</strong>是共享公共属性(环境、团队等)的服务集合。)，它们在项目中被定义为区域资源，可以从任何地方进行查询。</li><li id="4c95" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><strong class="is hj">服务</strong>是在名称空间中定义的实际服务表示，由一个名称(在名称空间中是唯一的)和一组端点来标识。</li><li id="e05a" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><strong class="is hj">端点</strong>代表处理给定服务请求的单个端点，由名称(例如<em class="kd"> vm1 </em>)和相关的唯一IP/端口对标识。</li></ul><p id="bf0b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">服务和端点都可以附加可选的元数据，这些元数据在客户端查询中返回。IAM绑定在名称空间和服务级别都受支持，服务和端点的查找是通过HTTP、gRPC或DNS经由专用的私有区域类型完成的。</p><p id="b039" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云DNS <a class="ae jo" href="https://cloud.google.com/service-directory/docs/configuring-service-directory-zone" rel="noopener ugc nofollow" target="_blank"> <em class="kd">服务目录</em>私有区域类型</a>使用服务目录命名空间作为其权威信息源，允许用户通过DNS请求查找服务目录记录，管理员通过利用服务目录IAM支持对DNS区域和记录实施细粒度控制。</p><p id="99a7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们看看这在实践中是如何工作的，使用一个简单的示例来创建一个服务目录命名空间，将其绑定到一个私有区域，并将<code class="du ke kf kg kh b">roles/servicedirectory.editor</code>角色授予两个独立的服务帐户，以允许编辑命名空间或服务记录，如下图所示。</p><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ki"><img src="../Images/43d7355170bedd6cd36d4e9874a7ec67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ulHBUAAKiiKhquBTYQxU5g.png"/></div></div></figure><p id="6aef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要运行这个示例，首先克隆<a class="ae jo" href="https://github.com/terraform-google-modules/cloud-foundation-fabric" rel="noopener ugc nofollow" target="_blank">存储库</a>并切换到示例文件夹。如果您喜欢使用云Shell，<a class="ae jo" href="https://ssh.cloud.google.com/cloudshell/editor?cloudshell_git_repo=https%3A%2F%2Fgithub.com%2Fterraform-google-modules%2Fcloud-foundation-fabric&amp;cloudshell_print=cloud-shell-readme.txt&amp;cloudshell_working_dir=cloud-operations%2Fdns-fine-grained-iam&amp;cloudshell_open_in_editor=cloudshell_open%2Fcloud-foundation-fabric%2Fexamples%2Fcloud-operations%2Fdns-fine-grained-iam%2Fvariables.tf" rel="noopener ugc nofollow" target="_blank">这个链接</a>将为您运行Git克隆，并切换到正确的文件夹，以便您可以跳过下面的初始步骤。</p><pre class="kj kk kl km fd kn kh ko kp aw kq bi"><span id="4a94" class="kr ks hi kh b fi kt ku l kv kw">git clone <a class="ae jo" href="https://github.com/terraform-google-modules/cloud-foundation-fabric.git" rel="noopener ugc nofollow" target="_blank">https://github.com/terraform-google-modules/cloud-foundation-fabric.git</a><br/>cd examples/cloud-operations/dns-fine-grained-iam</span></pre><p id="ee60" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在正确的文件夹中，运行Terraform，只需提供将创建所需资源的项目id，在云外壳中,<code class="du ke kf kg kh b">$GOOGLE_PROJECT_ID</code>变量被设置为云控制台中的当前项目，如果您不在云外壳中或想要使用不同的项目，请用实际的项目id替换它。</p><pre class="kj kk kl km fd kn kh ko kp aw kq bi"><span id="fa4f" class="kr ks hi kh b fi kt ku l kv kw">terraform init<br/># answer 'yes' when prompted after running apply<br/>terraform apply -var project_id=$GOOGLE_PROJECT_ID</span></pre><p id="805c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在准备测试这个例子:我们将依次登录到两个虚拟机，使用<code class="du ke kf kg kh b">dig</code>命令通过DNS查询服务目录名称空间，然后使用与每个虚拟机相关联的服务帐户的凭证操作它的服务和端点。</p></div><div class="ab cl kx ky gp kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hb hc hd he hf"><p id="beac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Terraform输出生成预设的<code class="du ke kf kg kh b">gcloud compute ssh</code>命令，您可以复制这些命令并在控制台中运行，以连接到每个虚拟机。如果您更改了<code class="du ke kf kg kh b">name</code>、<code class="du ke kf kg kh b">region</code>或<code class="du ke kf kg kh b">zone_domain</code>地形变量的默认值，请记住调整以下测试命令。</p><p id="2c42" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过SSH连接到<code class="du ke kf kg kh b">ns</code> VM，让我们从通过DNS查询服务目录名称空间开始，验证一切正常。</p><pre class="kj kk kl km fd kn kh ko kp aw kq bi"><span id="37d6" class="kr ks hi kh b fi kt ku l kv kw">gcloud compute ssh dns-sd-test-ns-1 \<br/>  --zone europe-west1-b --tunnel-through-iap<br/><br/>dig <strong class="kh hj">app1.svc.example.org</strong> +short<br/><em class="kd"># 127.0.0.2<br/># 127.0.0.3<br/># 127.0.0.7</em><br/>dig <strong class="kh hj">app2.svc.example.org</strong> +short<br/><em class="kd"># 127.0.0.4<br/># 127.0.0.5</em><br/>dig <strong class="kh hj">_app1._tcp.app1.svc.example.org</strong> srv +short<br/><em class="kd"># 10 10 80 vm1.app1.svc.example.org.<br/># 10 10 80 vm2.app1.svc.example.org.<br/># 10 10 80 vm3.app1.svc.example.org.</em></span></pre><p id="e496" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">DNS答案应该与上面代码片段中每个命令后的注释相匹配。注意最后一个命令中用于查询<code class="du ke kf kg kh b">SRV</code>记录的特殊格式。</p><p id="6bf7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果一切正常，那么让我们通过创建一个新服务，然后通过DNS查询其端点，来验证<code class="du ke kf kg kh b">ns</code> VM服务帐户是否拥有对名称空间的编辑权限。</p><pre class="kj kk kl km fd kn kh ko kp aw kq bi"><span id="37dc" class="kr ks hi kh b fi kt ku l kv kw">gcloud beta service-directory services create app3 \<br/>  --location europe-west1 --namespace dns-sd-test<br/><em class="kd"># Created service [app3].</em><br/><br/>gcloud beta service-directory endpoints create vm1 \<br/>  --service app3 \<br/>  --location europe-west1 --namespace dns-sd-test \<br/>  --address 127.0.0.6 --port 80<br/><em class="kd"># Created endpoint [vm1].</em><br/><br/>dig <strong class="kh hj">app3.svc.example.org</strong> +short<br/><em class="kd"># 127.0.0.6</em></span></pre><p id="cd63" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们刚刚演示的是，在名称空间上具有<code class="du ke kf kg kh b">roles/servicedirectory.editor</code>角色的身份能够创建(和编辑/删除)绑定到它的服务和端点。</p><p id="8a84" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们看看如何将权限范围限制到单个服务及其端点。从<code class="du ke kf kg kh b">ns</code>虚拟机注销并登录到<code class="du ke kf kg kh b">svc</code>虚拟机，然后尝试删除我们刚刚创建的服务记录。</p><pre class="kj kk kl km fd kn kh ko kp aw kq bi"><span id="d2db" class="kr ks hi kh b fi kt ku l kv kw">gcloud compute ssh dns-sd-test-svc-1 \<br/>  --zone europe-west1-b --tunnel-through-iap</span><span id="cb08" class="kr ks hi kh b fi le ku l kv kw">gcloud beta service-directory services delete app3 \<br/>  --location europe-west1 --namespace dns-sd-test<br/><em class="kd"># Deleted service [app3].<br/># ERROR: (gcloud.beta.service-directory.services.delete) PERMISSION_DENIED: Permission 'servicedirectory.services.delete' denied on resource 'projects/my-project/locations/europe-west1/namespaces/dns-sd-test/services/app3'.</em></span></pre><p id="217d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">忽略明显是bug的<code class="du ke kf kg kh b">deleted</code>消息(该服务毕竟还是beta版)，关注最后一条错误消息:该身份无权操作<code class="du ke kf kg kh b">app1</code>以外的服务。它能做的是操作我们给它访问权的单一服务。</p><pre class="kj kk kl km fd kn kh ko kp aw kq bi"><span id="e1db" class="kr ks hi kh b fi kt ku l kv kw">gcloud beta service-directory endpoints create vm3 \<br/>  --service app1 \<br/>  --location europe-west1 --namespace dns-sd-test \<br/>  --address 127.0.0.7 --port 80<br/><em class="kd"># Created endpoint [vm3].</em></span><span id="6aa7" class="kr ks hi kh b fi le ku l kv kw">dig <strong class="kh hj">app1.svc.example.org</strong> +short<br/><em class="kd"># 127.0.0.2<br/># 127.0.0.3<br/># 127.0.0.7</em></span></pre><p id="9fb4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您完成测试后，从VM注销并运行下面的命令来删除为这个例子创建的资源。</p><pre class="kj kk kl km fd kn kh ko kp aw kq bi"><span id="fe2a" class="kr ks hi kh b fi kt ku l kv kw">terraform destroy -var project_id=$GOOGLE_PROJECT_ID</span></pre></div><div class="ab cl kx ky gp kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hb hc hd he hf"><p id="d5b4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此处显示的设置当然是最小的，真正的设置将涉及服务目录和对等区域的组合，以跨多个项目和网络分布DNS记录的管理和使用。</p><p id="cefc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它的主要目的是演示这两种服务的集成，并展示如何将两者结合起来以实现对私有DNS区域和记录的细粒度控制。</p></div></div>    
</body>
</html>