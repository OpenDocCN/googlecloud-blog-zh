<html>
<head>
<title>GKE Usage Metering</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GKE使用计量</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gke-usage-metering-507a0edb5e8e?source=collection_archive---------0-----------------------#2021-05-14">https://medium.com/google-cloud/gke-usage-metering-507a0edb5e8e?source=collection_archive---------0-----------------------#2021-05-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="48e7" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="5450" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><a class="ae kb" href="https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-usage-metering" rel="noopener ugc nofollow" target="_blank"> GKE使用计量</a>是一个很棒的特性，它支持GKE分析，捕捉CPU、内存、存储和网络出口的使用和成本(<a class="ae kb" href="https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-usage-metering#enable-network-egress-metering" rel="noopener ugc nofollow" target="_blank">可选</a>)。提供了示例查询和Data Studio仪表板。</p><p id="0a35" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">这篇博文的目的是向您展示一个<em class="kh">替代方案</em>逐小时分析，以及对所用查询的详细解释。</p><h2 id="4d9f" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">限制</h2><p id="9597" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">有许多记录在案的<a class="ae kb" href="https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-usage-metering#limitations" rel="noopener ugc nofollow" target="_blank">限制</a>，但也有其他应该考虑的限制:</p><ul class=""><li id="0771" class="kw kx hi jf b jg kc jk kd jo ky js kz jw la ka lb lc ld le bi translated">有限的对象级指标。有在对象级别报告的指标，但没有对象名称或种类，只有标签。<strong class="jf hj"> <em class="kh">变通方法:</em> </strong> <em class="kh">如果有有意义的标签，可以用那些。</em></li><li id="da4f" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">使用计量数据集与群集是同一个项目，无法将多个项目合并成一个项目。<strong class="jf hj"> <em class="kh">解决方法:</em> </strong> <em class="kh">创建一个视图，将多个项目中的所有GKE使用情况计量结合在一起。</em></li><li id="6b4c" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">使用计量不会捕获所有系统和空闲CPU和内存。<strong class="jf hj"> <em class="kh">解决方法:</em> </strong> <em class="kh">加入计费数据，将指标按比例调整到整个集群。</em></li><li id="7cd6" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">计费数据不包括集群名称。这意味着来自计费的调整不能连接到同一个集群。<strong class="jf hj"> <em class="kh">解决方法:</em> </strong> <em class="kh">标注集群或根据项目中的所有集群进行调整。</em></li></ul><h1 id="b90f" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">标准化GKE使用计量</h1><p id="0cbe" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">GKE使用计量数据具有代表大约一个小时的指标，通常接近一个小时的开始— <em class="kh">但不完全是</em>！这使得不可能加入计费数据。</p><p id="bcb0" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">此外，GKE计量数据有多种来源:</p><ul class=""><li id="e3ba" class="kw kx hi jf b jg kc jk kd jo ky js kz jw la ka lb lc ld le bi translated">可能有一个或多个项目包含数据。</li><li id="ad87" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">有资源使用和资源消耗指标。前者代表实际使用的资源，而后者GKE请求(保留的)CPU和内存。</li></ul><h2 id="2914" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">询问</h2><p id="03b7" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">以下查询执行以下操作:</p><ul class=""><li id="2a8d" class="kw kx hi jf b jg kc jk kd jo ky js kz jw la ka lb lc ld le bi translated">在单一视图中显示底层数据。按字段record_date、project_id、type过滤将导致扫描的表和分区减少。</li><li id="1f2d" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">将窗口规范化为与计费使用的窗口相同(精确到小时)。</li></ul><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="9f90" class="ki ig hi lp b fi lt lu l lv lw">CREATE OR REPLACE VIEW <strong class="lp hj">`gke_usage.gke_resource_normalised`</strong> AS</span><span id="4402" class="ki ig hi lp b fi lx lu l lv lw">-- SourceData is a UNION of all source tables, including the<br/>-- different types and projects.<br/>--<br/>-- Any queries against this view that specifies the project_id,<br/>-- type, or record_date (partition for the source data) will be<br/>-- more efficient as it will scan fewer tables and partitions.<br/>--<br/>WITH SourceData AS (<br/>  SELECT<br/>    _PARTITIONTIME AS record_date,<br/>    '&lt;project-id&gt;' AS project_id,<br/>    'consumed' AS type,<br/>    * EXCEPT (project)<br/>  FROM<br/>    <strong class="lp hj">`gke_usage.gke_cluster_resource_usage`</strong><br/>  UNION ALL<br/>  SELECT<br/>    _PARTITIONTIME AS record_date,<br/>    '&lt;project-id&gt;' AS project_id,<br/>    'request' AS type,<br/>    * EXCEPT (project)<br/>  FROM<br/>    <strong class="lp hj">`gke_usage.gke_cluster_resource_consumption`</strong><br/>)</span><span id="45f5" class="ki ig hi lp b fi lx lu l lv lw">-- Pull out all of the fields we need from the GKE Usage Metering<br/>--<br/>-- The CROSS JOIN with 'win' is the set of precise time windows<br/>-- (on the hour for an hour) that overlap with the metrics. This<br/>-- allows joining with billing later.<br/>--<br/>-- Additionally, you can use the GKE labels at this stage and<br/>-- normalise for analytics.<br/>SELECT<br/>  record_date,<br/>  win AS start_time,<br/>  sku_id,<br/>  project_id,<br/>  resource_name,<br/>  cluster_location,<br/>  cluster_name,<br/>  namespace,<br/>  type,<br/>  usage.unit AS unit,<br/>  -- This formula calculates the size of the new window<br/>  -- against the original window for the new usage amount<br/>  usage.amount *<br/>    IF(<br/>      end_time = start_time,<br/>      1.0,<br/>      TIMESTAMP_DIFF(<br/>        LEAST(TIMESTAMP_ADD(win, INTERVAL 1 HOUR), end_time),<br/>        GREATEST(win, start_time), MICROSECOND) /<br/>      TIMESTAMP_DIFF(end_time, start_time, MICROSECOND)<br/>    ) AS usage<br/>FROM<br/>  SourceData<br/>  -- Array of overlapping periods<br/>  CROSS JOIN UNNEST(GENERATE_TIMESTAMP_ARRAY(<br/>    TIMESTAMP_TRUNC(start_time, hour),<br/>    TIMESTAMP_TRUNC(end_time, hour),<br/>    INTERVAL 1 HOUR)) AS win<br/>WHERE<br/>  usage.amount &gt; 0 AND<br/>  -- Bug -- sometimes start_time is at the epoch<br/>  TIMESTAMP_DIFF(end_time, start_time, DAY) &lt; 1<br/>GROUP BY<br/>  1, 2, 3, 4, 5, 6, 7, 9, 8, 9, 10, 11</span></pre><p id="27d8" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">现在，我们有了一个跨GKE使用计量表的有用视图。</p><h1 id="e29a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">GKE和计费汇总</h1><p id="9441" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">将GKE使用数据与计费汇总是下一个关键步骤，因为它们的时间窗口是一致的。</p><p id="610a" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="kh">下一个挑战:</em>GKE的使用数据不包括GKE GCE节点的所有使用情况。我们需要上调使用量。但是只针对GCE节点，不针对其他任何节点。</p><h2 id="2824" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">计费查询</h2><p id="5f87" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们将从账单中提取使用量和费率。这将用作更大查询的一部分。</p><p id="6d67" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">对于计费，我们只需要常规的成本，其中有一个明确的项目，并积极使用。</p><p id="9ddf" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">我们将这个表称为<strong class="jf hj"> BillingData </strong>。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="e3e8" class="ki ig hi lp b fi lt lu l lv lw">SELECT<br/>  -- Same dimensions as GKE Usage Metering<br/>  usage_start_time AS start_time,<br/>  project.id AS project_id,<br/>  sku.id AS sku_id,<br/>  usage.unit AS unit,</span><span id="a343" class="ki ig hi lp b fi lx lu l lv lw">  -- If this billing entry is for a GCE GKE Node (it has<br/>  -- the label), then we count this as gke_usage and otherwise<br/>  -- it is zero.<br/>  SUM(IF(<br/>    EXISTS (SELECT * FROM x.labels WHERE key='goog-gke-node'),<br/>    usage.amount,<br/>    0.0)) AS gke_usage,</span><span id="40e9" class="ki ig hi lp b fi lx lu l lv lw">  -- The rate is based on total cost / total usage regardless<br/>  -- of GKE or not. All GCE instances for the same sku_id have<br/>  -- the same rate.<br/>  SUM(cost)/SUM(usage.amount) AS rate<br/>FROM<br/>  <strong class="lp hj">`gke_usage.gcp_billing_export_v1_&lt;billingID&gt;`</strong> x<br/>WHERE<br/>  cost_type='regular' AND<br/>  usage.amount &gt; 0.0 AND<br/>  project IS NOT NULL<br/>GROUP BY<br/>  1, 2, 3, 4<br/>HAVING<br/>  -- Aggregations must have a rate (positive cost)<br/>  -- otherwise we can ignore it.<br/>rate &gt; 0.0<br/></span></pre><h2 id="e0b1" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">计算调整</h2><p id="13db" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">将计费数据与“gke _ usage . gke _ resource _ normalized”结合将为我们提供提升指标的调整。</p><p id="ada3" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">我们将这个表称为<strong class="jf hj">调整数据</strong>。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="8a9d" class="ki ig hi lp b fi lt lu l lv lw">SELECT<br/>  n.*,</span><span id="0664" class="ki ig hi lp b fi lx lu l lv lw">  -- If there is a GKE usage to adjust, then safely<br/>  -- divide it over the SUM of GKE Usage over the same<br/>  -- keys as the billing. This is the proportion that this<br/>  -- specific usage needs to be adjusted so that the total<br/>  -- will match the actual billed usage (gke_usage).<br/>  IF(b.gke_usage &gt; 0.0,<br/>    COALESCE(SAFE_DIVIDE(b.gke_usage, SUM(n.usage) OVER (<br/>      PARTITION BY n.start_time, n.project_id,<br/>                   n.sku_id, n.type, n.unit<br/>      )),<br/>      1.0),<br/>    1.0<br/>  ) AS adjustment,</span><span id="848b" class="ki ig hi lp b fi lx lu l lv lw">  // Add the rate. This is used for finding out the cost.<br/>  b.rate</span><span id="e7d3" class="ki ig hi lp b fi lx lu l lv lw">FROM<br/>  <strong class="lp hj">`gke_usage.gke_resource_normalised`</strong> n<br/>  JOIN <strong class="lp hj">BillingData</strong> b ON (<br/>    b.start_time=n.start_time AND<br/>    b.project_id=n.project_id AND<br/>    b.sku_id=n.sku_id AND<br/>    b.unit=n.unit<br/>  )<br/>WHERE<br/>  -- Skip system-overhead. The adjusted values will be the<br/>  -- recharged amounts, while the non-adjusted would allow<br/>  -- optimising.<br/>  namespace != 'kube:system-overhead'</span></pre><h2 id="d5b1" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">在视图中应用调整</h2><p id="7aa0" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">对于仪表板分析，数据仅对特定类型有效。该查询将使类型数量加倍，以包括调整后的指标和未调整的指标以及成本。</p><p id="1bd1" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">这将被构造成如下视图。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="b2ab" class="ki ig hi lp b fi lt lu l lv lw">CREATE OR REPLACE VIEW `gke_usage.gke_usage_dashboard` AS<br/>WITH<br/>  BillingData AS (<br/>    <strong class="lp hj"><em class="kh">Billing Query Here<br/></em></strong>  ),<br/>  AdjustmentData AS (<br/><strong class="lp hj">    <em class="kh">Adjustment Query Here<br/></em></strong>  ),</span><span id="19a7" class="ki ig hi lp b fi lx lu l lv lw">-- The fields need to be ordered the same for UNION ALL,<br/>-- so they also need to have the same EXCEPT() field list.<br/>--<br/>-- This union will allow the queries against the view to<br/>-- 'see through' with the type field. It will only process one<br/>-- side or the other of the UNION depending on the type.<br/>SELECT<br/>  c.* EXCEPT (usage, type, rate),<br/>  type,<br/>  usage,<br/>  -- Add the cost<br/>  usage * rate AS cost,<br/>FROM<br/>  <strong class="lp hj">AdjustmentData</strong> c<br/>UNION ALL<br/>SELECT<br/>  c.* EXCEPT (usage, type, rate),<br/>  -- Add adjusted type, usage, and cost.<br/>  CONCAT(type, '_adj') AS type,<br/>  adjustment * usage AS usage,<br/>  adjustment * usage * rate AS cost,<br/>FROM<br/>  <strong class="lp hj">AdjustmentData</strong> c;</span></pre><h1 id="c3f5" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">仪表板查询</h1><p id="64d4" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这个查询是为Data Studio准备的。可以是直接连接，也可以是另一种视图。为data studio添加了end_time。</p><h2 id="86f7" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">BigQuery连接-查询</h2><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="8234" class="ki ig hi lp b fi lt lu l lv lw">-- end_time is added to help with dashboards.<br/>--<br/>-- For calculating the average mem_gb, average cpu,<br/>-- and average disk_gb you need to divide by<br/>-- max(end_time) - min(start_time).<br/>--<br/>SELECT<br/>  start_time,<br/>  TIMESTAMP_ADD(start_time, INTERVAL 1 HOUR) AS end_time,<br/>  sku_id,<br/>  project_id,<br/>  resource_name,<br/>  cluster_location,<br/>  cluster_name,<br/>  namespace,<br/>  type,<br/>  -- Turn the metrics into something that can be directly used<br/>  -- by a dashboard. Memory into GB, Egress into GB, disk into GB,<br/>  -- and _secs where it is over time.<br/>  SUM(IF(resource_name='cpu',usage,0.0)) AS cpu_secs,<br/>  SUM(IF(resource_name='memory',usage/1e9,0.0)) AS mem_gb_secs,<br/>  SUM(IF(resource_name='networkEgress',usage/1e9,0.0)) AS egress_gb,<br/>  SUM(IF(resource_name='storage',usage/1e9,0.0)) AS disk_gb_secs,  <br/>  SUM(IF(resource_name='cpu',cost,0.0)) AS cpu_cost,<br/>  SUM(IF(resource_name='memory',cost,0.0)) AS mem_cost,<br/>  SUM(IF(resource_name='networkEgress',cost,0.0)) AS egress_cost,<br/>  SUM(IF(resource_name='storage',cost,0.0)) AS disk_cost,<br/>  -- We need the total cost across all resource types<br/>  SUM(cost) AS cost,<br/>FROM<br/>  `gke_usage.gke_usage_dashboard`<br/>GROUP BY<br/>  1, 2, 3, 4, 5, 6, 7, 8, 9;</span></pre><h2 id="6bd7" class="ki ig hi bd ih kj kk kl il km kn ko ip jo kp kq it js kr ks ix jw kt ku jb kv bi translated">公式字段</h2><p id="e2a1" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">为了计算平均CPU、平均磁盘GB和平均内存GB，仪表板中需要计算字段。这是因为它可以在一段时间内聚集。</p><p id="706d" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">经过的时间是<code class="du ly lz ma lp b">DATE_DIFF(MAX(end_time), MIN(start_time))</code>。那么avg_cpu是<code class="du ly lz ma lp b">SUM(cpu_secs) / <strong class="jf hj">&lt;ElapsedTime&gt;</strong></code>，avg_disk_gb是<code class="du ly lz ma lp b">SUM(disk_gb_secs) / <strong class="jf hj">&lt;ElapsedTime&gt;</strong></code>，avg_mem_gb是<code class="du ly lz ma lp b">SUM(mem_gb_secs) / <strong class="jf hj">&lt;ElapsedTime&gt;</strong></code>。</p><h1 id="777f" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">其他考虑</h1><p id="b160" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">还有一些其他功能或方法可以采用。</p><ul class=""><li id="6a0d" class="kw kx hi jf b jg kc jk kd jo ky js kz jw la ka lb lc ld le bi translated">处理计费数据和左加入GKE使用计量数据。这样做的好处是计费数据是主要的(应该等于计费数据<em class="kh">而没有</em>左边的连接),同时仍然在可能的情况下提供集群中的细分。如果获得GKE和其他地方的总成本是最重要的，这是最好的方法。 </li><li id="bcab" class="kw kx hi jf b jg lf jk lg jo lh js li jw lj ka lb lc ld le bi translated">这允许实际使用和请求计量，但是对于成本分配，最大值(实际使用，请求)可能是最好的。这可以作为处理中的额外阶段添加。</li></ul><h1 id="5abd" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">结论</h1><p id="b4b2" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">将GKE使用计量数据与GCP计费结合起来并不简单，但希望这篇博客文章提供了一个分步指南，说明如何在仪表板中展示这些数据并使其变得有用。</p><p id="5e2e" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">下面是使用Data Studio中的查询，按名称空间划分总成本，以及随时间变化的内存(GB)和CPU。</p><figure class="lk ll lm ln fd mc er es paragraph-image"><div class="er es mb"><img src="../Images/02ab569ead2b5ee88d6b2f4ffa37584a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/format:webp/1*2mWqEupEGEmcdY18rOcKXg.png"/></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">一段时间内按命名空间、内存和CPU划分的总成本</figcaption></figure><p id="d1c6" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">任何问题或反馈请告诉我！</p></div></div>    
</body>
</html>