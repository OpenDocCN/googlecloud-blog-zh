<html>
<head>
<title>Export data from AWS S3 to BigQuery using Dataproc Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dataproc无服务器将数据从AWS S3导出到BigQuery</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/export-data-from-aws-s3-to-bigquery-using-dataproc-serverless-6dc7a9952fc4?source=collection_archive---------4-----------------------#2022-12-13">https://medium.com/google-cloud/export-data-from-aws-s3-to-bigquery-using-dataproc-serverless-6dc7a9952fc4?source=collection_archive---------4-----------------------#2022-12-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/cd52efa5addb8fbd180e2647eab22e8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B0-5hGtG08jk1lEp.png"/></div></figure><p id="683e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">data proc Spark无服务器版</strong>无需配置和管理集群即可运行批量工作负载。它可以动态地调整工作负载资源，比如执行器的数量，以便高效地运行您的工作负载。作为数据开发人员，这使我们能够专注于业务逻辑，而不是花时间管理基础设施。</p><p id="0610" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">相比之下，计算引擎上的<strong class="io hj"> Dataproc在GCP上提供托管Hadoop和Spark服务。它非常适合希望调配和管理基础架构，然后在Spark上执行工作负载的用户。</strong></p><p id="d20c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> Dataproc无服务器模板:</strong>现成可用的、开源的、基于data proc Spark无服务器的可定制模板。这些模板帮助数据工程师进一步简化在Dataproc Serverless上的开发过程，根据他们的需求消费和定制现有的模板。</p><p id="3167" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这篇文章中，我们将探讨如何使用Dataproc Serverless for Spark从AWS S3桶向BigQuery批量加载数据。</p><h1 id="a9b1" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">先决条件</h1><ul class=""><li id="19ea" class="ki kj hi io b ip kk it kl ix km jb kn jf ko jj kp kq kr ks bi translated">安装并验证了Google Cloud SDK</li><li id="ae01" class="ki kj hi io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">云壳或预装Java 8、Maven 3和Git的机器</li></ul><h1 id="0533" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">S3到大查询模板</h1><p id="654e" class="pw-post-body-paragraph im in hi io b ip kk ir is it kl iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">该模板将从亚马逊S3桶读取数据，并将其写入BigQuery表。它使用Spark BigQuery连接器和Spark S3连接器。</p><figure class="lc ld le lf fd ij er es paragraph-image"><div class="er es lb"><img src="../Images/fcef396ea441e29e900d1ce1e84adda9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*UVkLmuHeBLMaBB1q2tA9Vw.jpeg"/></div></figure><p id="8296" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">该模板允许通过执行命令配置以下参数:</p><p id="64f0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="lg">S3 . bq . Access . key</em>:S3桶的访问键。<br/> <em class="lg"> s3.bq.secret </em>。密钥:访问S3存储桶所需的密钥。<br/><em class="lg">S3 . bq . input . format</em>:S3桶中的文件格式。示例:avro，parquet，csv，JSON&gt;<br/><em class="lg">S3 . bq . input . location</em>:S3输入位置。s3输入位置必须以<em class="lg">s3a://</em><br/><em class="lg">S3 . bq . Output . dataset . name</em>:表驻留或需要创建的BigQuery的输出数据集<br/><em class="lg">S3 . bq . Output . table . name</em>:big query的输出表名<br/><em class="lg">S3 . bq . LD . temp . bucket . name</em>:预先存在的S3桶名，临时文件存放在这里。示例:<em class="lg">模板-s3tobq </em></p><h1 id="c58e" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">主要优势</h1><ol class=""><li id="528f" class="ki kj hi io b ip kk it kl ix km jb kn jf ko jj lh kq kr ks bi translated">使用<strong class="io hj"> Dataproc无服务器</strong>运行Spark批处理工作负载，无需管理Spark框架。</li><li id="953f" class="ki kj hi io b ip kt it ku ix kv jb kw jf kx jj lh kq kr ks bi translated">S3ToBigquery 模板是开源的，配置驱动的，随时可用。执行代码只需要AWS S3证书。</li><li id="73e1" class="ki kj hi io b ip kt it ku ix kv jb kw jf kx jj lh kq kr ks bi translated">支持的文件格式有Avro、Parquet、CSV和JSON。</li></ol><h1 id="69b8" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">基本用法</h1><ol class=""><li id="a48b" class="ki kj hi io b ip kk it kl ix km jb kn jf ko jj lh kq kr ks bi translated">如果你要使用“默认的”由GCP生成的VPC网络，请确保你已经启用了私有谷歌访问子网。您仍然需要启用如下的私人访问。</li></ol><figure class="lc ld le lf fd ij er es paragraph-image"><div class="er es li"><img src="../Images/4e93fe3f0f9e5dc5cff2137a66870b7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/0*VHU51ATMTrDxkg2B.png"/></div></figure><pre class="lc ld le lf fd lj lk ll bn lm ln bi"><span id="5fb7" class="lo jl hi lk b be lp lq l lr ls">gcloud compute networks subnets update default --region=us-central1 --enable-private-ip-google-access</span></pre><p id="7eca" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">2.Dataproc Servereless需要Cloud NAT来访问GCP以外的地方。要实现这一点，请遵循以下步骤。在步骤(4)中，选择您想要运行Dataproc无服务器作业的VPC。</p><p id="7802" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">3.从AWS S3存储桶获取访问S3存储桶文件夹所需的访问密钥和秘密密钥。</p><p id="9133" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">4.在预装了<a class="ae lt" href="https://cloud.google.com/shell/docs/how-cloud-shell-works" rel="noopener ugc nofollow" target="_blank">各种工具</a>的云壳中克隆git repo。或者使用任何预装JDK 8+，Maven和Git的机器。</p><pre class="lc ld le lf fd lj lk ll bn lm ln bi"><span id="332d" class="lo jl hi lk b be lp lq l lr ls">git clone https://github.com/GoogleCloudPlatform/dataproc-templates.gitcd dataproc-templates/java</span></pre><p id="2d67" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">5.获取身份验证凭据(以提交作业)。</p><pre class="lc ld le lf fd lj lk ll bn lm ln bi"><span id="7ff6" class="lo jl hi lk b be lp lq l lr ls">gcloud auth application-default login</span></pre><p id="34fa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">6.执行AWS S3到BigQuery Dataproc无服务器模板:</p><pre class="lc ld le lf fd lj lk ll bn lm ln bi"><span id="0c0a" class="lo jl hi lk b be lp lq l lr ls">GCP_PROJECT=&lt;gcp-project-id&gt; \<br/>REGION=&lt;region&gt;  \<br/>SUBNET=&lt;subnet&gt;   \<br/>GCS_STAGING_BUCKET=&lt;gcs-staging-bucket-folder&gt; \<br/>HISTORY_SERVER_CLUSTER=&lt;history-server&gt; \<br/>bin/start.sh \<br/>-- --template S3TOBIGQUERY \<br/>--templateProperty s3.bq.access.key=&lt;s3-accesss-key&gt; \<br/>--templateProperty s3.bq.secret.key=&lt;s3-secret-key&gt; \<br/>--templateProperty s3.bq.input.format=&lt;avro,parquet,csv,json&gt; \<br/>--templateProperty s3.bq.input.location=&lt;s3-input-location&gt; \<br/>--templateProperty s3.bq.output.dataset.name=&lt;bq-dataset-name&gt; \<br/>--templateProperty s3.bq.output.table.name=&lt;bq-output-table&gt; \ <br/>--templateProperty s3.bq.ld.temp.bucket.name=&lt;temp-bucket&gt;</span></pre><p id="3a07" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">7.可以选择更新template.properties文件中的以下属性。请注意，在执行命令中作为参数提供的模板属性将优先于在template.properties文件中指定的属性。</p><pre class="lc ld le lf fd lj lk ll bn lm ln bi"><span id="e1f7" class="lo jl hi lk b be lp lq l lr ls">s3.bq.access.key=&lt;s3-accesss-key&gt;<br/>s3.bq.secret.key=&lt;s3-secret-key&gt;<br/>s3.bq.input.format=&lt;avro,parquet,csv,json&gt;<br/>s3.bq.input.location=&lt;s3-input-location&gt;<br/>s3.bq.output.dataset.name=&lt;bq-dataset-name&gt;<br/>s3.bq.output.table.name=&lt;bq-output-table&gt;<br/>s3.bq.ld.temp.bucket.name=&lt;temp-bucket&gt;</span></pre><h1 id="5fc5" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">参考</h1><ul class=""><li id="dbd6" class="ki kj hi io b ip kk it kl ix km jb kn jf ko jj kp kq kr ks bi translated"><a class="ae lt" href="https://cloud.google.com/dataproc-serverless/docs/overview" rel="noopener ugc nofollow" target="_blank"> Dataproc无服务器文档</a></li><li id="d8b5" class="ki kj hi io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated"><a class="ae lt" href="https://github.com/GoogleCloudPlatform/dataproc-templates" rel="noopener ugc nofollow" target="_blank"> Dataproc模板GitHub库</a></li></ul></div></div>    
</body>
</html>