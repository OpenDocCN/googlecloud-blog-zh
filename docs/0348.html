<html>
<head>
<title>A lightweight way to check the IAM permissions granted to your Cloud Platform Cloud Storage buckets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一种检查授予您的云平台云存储桶的IAM权限的轻量级方法</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/a-lightweight-way-to-check-the-iam-permissions-granted-to-your-cloud-platform-cloud-storage-buckets-803dd86ce9ca?source=collection_archive---------0-----------------------#2017-07-30">https://medium.com/google-cloud/a-lightweight-way-to-check-the-iam-permissions-granted-to-your-cloud-platform-cloud-storage-buckets-803dd86ce9ca?source=collection_archive---------0-----------------------#2017-07-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="696e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">了解您授予您的云存储桶的权限非常重要，这样您可以避免无意中授予太广泛的权限，因此请通过阅读<a class="ae jd" href="https://cloud.google.com/storage/docs/access-control/iam#roles" rel="noopener ugc nofollow" target="_blank">此</a>来了解IAM角色，因为它们与云存储有关。</p><p id="d44a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里<a class="ae jd" href="https://cloud.google.com/storage/docs/access-control/iam#best_practices" rel="noopener ugc nofollow" target="_blank">列出了云存储IAM的最佳实践</a>，但是为了验证您在设置权限时没有犯错误，轻量级检查可能是有用的。</p><p id="c180" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是这篇文章的内容。对于框架方法，你可能想要检查可扩展的<a class="ae jd" href="http://forsetisecurity.org/about/" rel="noopener ugc nofollow" target="_blank">凡赛堤安全性</a>(我将在某个时候再次深入讨论)</p><p id="6815" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以利用GCP提供的一个被低估的功能来快速检查一个桶的权限，这个功能允许你在浏览器中测试API。</p><p id="6dc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，您需要使用两个API页面:</p><p id="f98e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你通过了认证，并且至少拥有项目的角色/查看者权限，这将会给你一个项目中所有存储桶的列表</p><p id="824e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在您已经有了一个bucket列表，您可以通过使用<a class="ae jd" href="https://cloud.google.com/storage/docs/json_api/v1/buckets/getIamPolicy" rel="noopener ugc nofollow" target="_blank">bucket:getiampolicy</a>API文档来获得针对所标识的bucket的权限。对于此页面，您至少需要对包含存储桶的项目拥有<a class="ae jd" href="https://cloud.google.com/storage/docs/access-control/iam-permissions" rel="noopener ugc nofollow" target="_blank">storage . buckets . getiampolicy</a>权限</p><p id="4369" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">bucket上的权限作为JSON返回(耶！)对于我的一个桶(适当的匿名输出)来说，它看起来像这样:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="bf65" class="jn jo hi jj b fi jp jq l jr js">{</span><span id="b87d" class="jn jo hi jj b fi jt jq l jr js">“kind”: “storage#policy”,</span><span id="3036" class="jn jo hi jj b fi jt jq l jr js">“resourceId”: “projects/_/buckets/mydemobucket”,</span><span id="6af1" class="jn jo hi jj b fi jt jq l jr js">“bindings”: [</span><span id="8848" class="jn jo hi jj b fi jt jq l jr js">{</span><span id="6471" class="jn jo hi jj b fi jt jq l jr js">“role”: “roles/storage.legacyBucketOwner”,</span><span id="3f09" class="jn jo hi jj b fi jt jq l jr js">“members”: [</span><span id="b0fd" class="jn jo hi jj b fi jt jq l jr js">“projectEditor:my-project-id”,</span><span id="2ac1" class="jn jo hi jj b fi jt jq l jr js">“projectOwner:my-project-id”</span><span id="8996" class="jn jo hi jj b fi jt jq l jr js">]</span><span id="cc7f" class="jn jo hi jj b fi jt jq l jr js">},</span><span id="e39e" class="jn jo hi jj b fi jt jq l jr js">{</span><span id="1c36" class="jn jo hi jj b fi jt jq l jr js">“role”: “roles/storage.legacyBucketReader”,</span><span id="4d29" class="jn jo hi jj b fi jt jq l jr js">“members”: [</span><span id="348a" class="jn jo hi jj b fi jt jq l jr js">“projectViewer:my-project-id”</span><span id="89ac" class="jn jo hi jj b fi jt jq l jr js">]</span><span id="6429" class="jn jo hi jj b fi jt jq l jr js">},</span><span id="2ee5" class="jn jo hi jj b fi jt jq l jr js">{</span><span id="bb64" class="jn jo hi jj b fi jt jq l jr js">“role”: “roles/storage.objectViewer”,</span><span id="1d7c" class="jn jo hi jj b fi jt jq l jr js">“members”: [</span><span id="9d93" class="jn jo hi jj b fi jt jq l jr js">“user:joe@joesworkdomain”</span><span id="8517" class="jn jo hi jj b fi jt jq l jr js">]</span><span id="8237" class="jn jo hi jj b fi jt jq l jr js">}</span><span id="a308" class="jn jo hi jj b fi jt jq l jr js">],</span><span id="ecf2" class="jn jo hi jj b fi jt jq l jr js">“etag”: “CAM=”</span><span id="1ba0" class="jn jo hi jj b fi jt jq l jr js">}</span></pre><p id="3f3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不过这有点乏味(因为每个bucket都有单独的http请求),而且我喜欢自动化工作并使用易于使用的<a class="ae jd" href="https://cloud.google.com/apis/docs/cloud-client-libraries" rel="noopener ugc nofollow" target="_blank">客户端库</a>,我写了一个小python脚本，您可以使用它作为基础来自动检查项目中bucket的权限。它也给你一个你可以访问的项目列表(只是因为真的)。</p><p id="007f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它将每个bucket的权限写入一个文本文件，但是可以很容易地扩展到将值写入CloudSQL表或BigQuery。(我倾向于将list project函数分解到一个单独的脚本中，并使用输出的projectID来设置GOOGLE_CLOUD_PROJECT env变量，然后调用一个脚本为该项目进行存储桶检查)</p><p id="0c23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该脚本针对一个存储桶为每个权限写一行，格式如下:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="e0cc" class="jn jo hi jj b fi jp jq l jr js">&lt;Bucket: BUCKETNAME&gt; : Role: roles/storage.BUCKET-IAM-ROLE, Members: set([u’GROUP or USER:my-project-id’,u’GROUP or USER:my-project-id’,])</span></pre><p id="7cc4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果相同的角色被授予其他组或用户(GCP IAM术语中的成员),则该条目将被包括在内，如上所示分开。</p><p id="06d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的一个桶的示例(适当的匿名输出)如下所示:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="f0c9" class="jn jo hi jj b fi jp jq l jr js">&lt;Bucket: mydemobucket&gt; : Role: roles/storage.legacyBucketOwner, Members: set([u’projectEditor:my-project-id’, u’projectOwner:my-project-id’])</span><span id="2efa" class="jn jo hi jj b fi jt jq l jr js">&lt;Bucket: mydemobucket&gt; : Role: roles/storage.objectViewer, Members: set([u’user:joe@joesworkdomain’])</span><span id="7eb3" class="jn jo hi jj b fi jt jq l jr js">&lt;Bucket:mydemobucket&gt; : Role: roles/storage.legacyBucketReader, Members: set([u’projectViewer:my-project-id’])</span></pre><p id="b67b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，输出是敏感的，因此请确保您采取适当的步骤来注意如何管理数据以及您授予谁访问数据的权限。</p><p id="c945" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在这里找到我的基本python脚本<a class="ae jd" href="https://github.com/grapesfrog/GCPscripts/tree/master/bucketpermissions" rel="noopener ugc nofollow" target="_blank"/>(是的，我知道没有测试，但这是一个非常简单的脚本&amp;我想在我休假一周后回来工作之前扭转这个局面)。</p><p id="c470" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该脚本的灵感来自Ric Harvey( @ric_harvey)，他在github上发布了一个方便的s3权限检查器。谢谢里克。</p><p id="035a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的没有Ric的输出漂亮，虽然它真的是为你设计的，不仅仅是写文本文件</p></div></div>    
</body>
</html>