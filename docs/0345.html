<html>
<head>
<title>Next.js tutorial — Deploy to Docker on Google Cloud Container Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Next.js教程—部署到Google云容器引擎上的Docker</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/next-js-tutorial-deploy-to-docker-on-google-cloud-container-engine-6b0c19dd8ecb?source=collection_archive---------0-----------------------#2017-07-29">https://medium.com/google-cloud/next-js-tutorial-deploy-to-docker-on-google-cloud-container-engine-6b0c19dd8ecb?source=collection_archive---------0-----------------------#2017-07-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0541" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个关于如何将一个用<a class="ae jd" href="https://github.com/zeit/next.js" rel="noopener ugc nofollow" target="_blank"> Next.js </a>构建的app从<a class="ae jd" href="https://zeit.co" rel="noopener ugc nofollow" target="_blank"> ▲ <strong class="ih hj"> ZEIT </strong> </a> <strong class="ih hj"> </strong>部署到运行在谷歌云平台容器<a class="ae jd" href="https://cloud.google.com/container-engine/" rel="noopener ugc nofollow" target="_blank">引擎</a>上的Docker的简要演练。我使用终端在Macbook上执行这些步骤。</p><blockquote class="je jf jg"><p id="5c0e" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">注意—这只是针对开发而言的，对于生产而言，有更多的最佳实践，这些说明会略有不同。</p></blockquote></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><p id="59c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于将node.js应用程序部署到GCP CE的更多信息，一个很好的起点是这个<a class="ae jd" href="https://cloud.google.com/container-engine/docs/tutorials/hello-node" rel="noopener ugc nofollow" target="_blank">教程</a>。</p><ol class=""><li id="3b99" class="js jt hi ih b ii ij im in iq ju iu jv iy jw jc jx jy jz ka bi translated">在GCP上创建一个帐户并启用计费。然后在您的笔记本电脑上安装cli工具。<a class="ae jd" href="https://cloud.google.com/container-engine/docs/tutorials/hello-node#option_b_install_tools_on_your_workstation" rel="noopener ugc nofollow" target="_blank">此处说明</a>。您将需要gcloud cli和kubectl包。你还需要安装<a class="ae jd" href="https://docs.docker.com/engine/installation/" rel="noopener ugc nofollow" target="_blank">对接器</a>。</li><li id="1490" class="js jt hi ih b ii kb im kc iq kd iu ke iy kf jc jx jy jz ka bi translated">验证您的gcloud cli，用您自己的ID替换PROJECT_ID。</li></ol><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="87ec" class="kp kq hi kl b fi kr ks l kt ku">gcloud auth login</span><span id="5975" class="kp kq hi kl b fi kv ks l kt ku">gcloud config set project PROJECT_ID<br/>gcloud config set compute/zone us-central1-b</span></pre><p id="a4a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.从next.js/examples,挑选一个例子<a class="ae jd" href="https://github.com/zeit/next.js/tree/v3-beta/examples/" rel="noopener ugc nofollow" target="_blank">回购</a>我在这里用<a class="ae jd" href="https://github.com/zeit/next.js/tree/v3-beta/examples/with-apollo" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">搭配——阿波罗</strong> </a>。运行下面的命令，然后打开浏览器到http://localhost:3000 以确保一切正常。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="6990" class="kp kq hi kl b fi kr ks l kt ku">curl https://codeload.github.com/zeit/next.js/tar.gz/master | tar -xz --strip=2 next.js-master/examples/with-apollo</span><span id="6ad8" class="kp kq hi kl b fi kv ks l kt ku">cd with-apollo</span><span id="708a" class="kp kq hi kl b fi kv ks l kt ku">npm install</span><span id="4563" class="kp kq hi kl b fi kv ks l kt ku">npm run dev</span></pre><p id="eb9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.在根项目目录中创建3个新文件</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="91db" class="kp kq hi kl b fi kr ks l kt ku">.gitignore <br/>.dockerignore <br/>Dockerfile</span></pre><figure class="kg kh ki kj fd kx er es paragraph-image"><div class="er es kw"><img src="../Images/9d9c74e3060598e3fc835d9043c885df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*f5kbCCcIF0Ye8OGON4_Bcg.png"/></div><figcaption class="la lb et er es lc ld bd b be z dx translated">在项目根目录下创建3个文件</figcaption></figure><p id="b286" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">。gitignore </strong>内容—</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="862a" class="kp kq hi kl b fi kr ks l kt ku">node_modules<br/>.next<br/>.DS_Store</span></pre><p id="4953" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">。目录——</strong></p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="d53e" class="kp kq hi kl b fi kr ks l kt ku">node_modules<br/>npm-debug.log<br/>.next</span></pre><p id="057e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Dockerfile </strong>目录—</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="638f" class="kp kq hi kl b fi kr ks l kt ku">FROM node:alpine</span><span id="8f8e" class="kp kq hi kl b fi kv ks l kt ku"># Create app directory<br/>RUN mkdir -p /usr/src/app<br/>WORKDIR /usr/src/app</span><span id="9914" class="kp kq hi kl b fi kv ks l kt ku"># Install app dependencies<br/>COPY package.json /usr/src/app/<br/>RUN npm install</span><span id="145e" class="kp kq hi kl b fi kv ks l kt ku"># Bundle app source<br/>COPY . /usr/src/app</span><span id="e54a" class="kp kq hi kl b fi kv ks l kt ku">RUN npm run build<br/>EXPOSE 3000</span><span id="c41f" class="kp kq hi kl b fi kv ks l kt ku">CMD [ "npm", "start" ]</span></pre><p id="bf12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.为了确保应用程序正常工作，您可以在笔记本电脑上本地构建并运行docker容器。我们将这个docker应用称为<strong class="ih hj"> nextapollo </strong>。下面命令中的:v1是您设置版本的方式，当您对应用程序进行更改时，它会递增。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="238f" class="kp kq hi kl b fi kr ks l kt ku">docker build -t gcr.io/${PROJECT_ID}/nextapollo:v1 .</span></pre><p id="ae20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.构建好app后，使用docker在本地启动，然后在你的浏览器中访问<a class="ae jd" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>进行测试。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="b9cc" class="kp kq hi kl b fi kr ks l kt ku">docker run --rm -p 3000:3000 gcr.io/${PROJECT_ID}/nextapollo:v1</span></pre><blockquote class="je jf jg"><p id="8d20" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">提示—查看Captain，从macOS工具栏轻松启动/停止本地Docker应用程序。</p></blockquote><figure class="kg kh ki kj fd kx er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es le"><img src="../Images/7a10ae4c4580cfdc0cf1c150951f6d2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S7QE2tOBR6k9rdBindx_6g.png"/></div></div><figcaption class="la lb et er es lc ld bd b be z dx translated"><a class="ae jd" href="https://getcaptain.co/" rel="noopener ugc nofollow" target="_blank">船长</a>，一个免费的应用程序，可以在你的Mac上轻松启动/停止docker应用程序。</figcaption></figure><p id="a3fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.现在你已经准备好设置谷歌云了。首先，将我们构建的docker映像推送到您的Google Cloud Container私有注册表中。您推送的每个版本都将保留在您的注册表中，可供部署。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="3222" class="kp kq hi kl b fi kr ks l kt ku">gcloud docker -- push gcr.io/${PROJECT_ID}/nextapollo:v1</span></pre><p id="afed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">8.您将需要设置一个容器集群。这将运行谷歌管理的Kubernetes。您可以使用GCP控制台，但cli很简单。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="fd7e" class="kp kq hi kl b fi kr ks l kt ku">## This will create a new cluster named 'next-cluster', with 3 Compute instances.</span><span id="ae71" class="kp kq hi kl b fi kv ks l kt ku">gcloud container clusters create next-cluster --num-nodes=3</span><span id="647c" class="kp kq hi kl b fi kv ks l kt ku"><br/>## Wait and verify they were created</span><span id="9a34" class="kp kq hi kl b fi kv ks l kt ku">gcloud container clusters list</span></pre><p id="bdf5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">9.运行上面的list命令后，您会注意到一个IP地址，但这不是您将用于应用程序的地址。一旦集群准备就绪，我们将创建一个<a class="ae jd" href="https://kubernetes.io/docs/concepts/workloads/pods/pod/" rel="noopener ugc nofollow" target="_blank"> pod </a>，它是Next.js应用程序的一个实例。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="fce5" class="kp kq hi kl b fi kr ks l kt ku">## This will create 1 pod using port 3000 within docker. </span><span id="759e" class="kp kq hi kl b fi kv ks l kt ku">kubectl run nextapollo --image=gcr.io/${PROJECT_ID}/nextapollo:v1 --port 3000<br/></span><span id="2ca9" class="kp kq hi kl b fi kv ks l kt ku">## Wait a moment, then verify</span><span id="f14a" class="kp kq hi kl b fi kv ks l kt ku">kubectl get pods</span></pre><p id="d3ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">10.您将需要使用谷歌云负载平衡器向外界公开该应用程序。生成公共ip地址需要一些时间。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="8ab3" class="kp kq hi kl b fi kr ks l kt ku">kubectl expose deployment nextapollo --type=LoadBalancer --port 3000</span><span id="80ff" class="kp kq hi kl b fi kv ks l kt ku">## Wait a moment, then verify</span><span id="b70b" class="kp kq hi kl b fi kv ks l kt ku">kubectl get services </span><span id="6946" class="kp kq hi kl b fi kv ks l kt ku">## refresh this until you see the EXTERNAL-IP address</span></pre><blockquote class="je jf jg"><p id="180d" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">N <!-- -->注意——上面创建了一个简单的TCP负载均衡器，并公开了3000 dev端口，这样你就可以快速访问这个应用程序。您通常会想要配置一个入口https负载平衡器，见这里的<a class="ae jd" href="https://cloud.google.com/container-engine/docs/tutorials/http-balancer" rel="noopener ugc nofollow" target="_blank"/>，并且可能还想要使用nginx。</p></blockquote><p id="acba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">11.该应用程序现在将在一个3实例集群中运行单个pod。在浏览器中访问<a class="ae jd" href="http://EXTERNAL-IP" rel="noopener ugc nofollow" target="_blank">http://</a>External _ IP:3000/</p><p id="43b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">12.您可以轻松扩展应用程序，让我们扩展到6个单元(6个副本)，它们将自动实现负载平衡。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="8a7d" class="kp kq hi kl b fi kr ks l kt ku">kubectl scale deployment nextapollo  --replicas=6</span><span id="9f2f" class="kp kq hi kl b fi kv ks l kt ku">## Verify it worked</span><span id="55a8" class="kp kq hi kl b fi kv ks l kt ku">kubectl get pods </span><span id="bd69" class="kp kq hi kl b fi kv ks l kt ku">## You should see 6 copies running. </span></pre></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><p id="99a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本配置到此结束。你有运行在谷歌云平台上的带有Apollo GraphQL的Next.js。它在Node.js的6个副本上自动实现负载平衡，分布在3个不同的Google Compute实例上。当你推送新版本的应用时，它会自动处理滚动容器更新。以下是更新应用程序和管理部署的一些提示。</p><ol class=""><li id="dc76" class="js jt hi ih b ii ij im in iq ju iu jv iy jw jc jx jy jz ka bi translated">使用-apollo 本地源代码对<strong class="ih hj">进行任何更改。然后保存您的更改并执行以下命令</strong></li></ol><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="fbd2" class="kp kq hi kl b fi kr ks l kt ku">## Notice the v2 increment at the end</span><span id="236c" class="kp kq hi kl b fi kv ks l kt ku">docker build -t gcr.io/${PROJECT_ID}/nextapollo:v2 .<br/></span><span id="7e4d" class="kp kq hi kl b fi kv ks l kt ku">## Optional, if you want to test it locally before deploying</span><span id="fe91" class="kp kq hi kl b fi kv ks l kt ku">docker run --rm -p 3000:3000 gcr.io/${PROJECT_ID}/nextapollo:v2<br/></span><span id="8b2f" class="kp kq hi kl b fi kv ks l kt ku">## Push the new version to your private registry at GCP</span><span id="8a6f" class="kp kq hi kl b fi kv ks l kt ku">gcloud docker -- push gcr.io/${PROJECT_ID}/nextapollo:v2<br/></span><span id="8c1f" class="kp kq hi kl b fi kv ks l kt ku">## Tell Kubernetes to use the new version, this will start the rolling update of your containers (one line)</span><span id="f6f5" class="kp kq hi kl b fi kv ks l kt ku">kubectl set image deployment/nextapollo  nextapollo=gcr.io/${PROJECT_ID}/nextapollo:v2</span><span id="9136" class="kp kq hi kl b fi kv ks l kt ku"><br/>## Check your browser to see the updates<br/>http://public_ip:3000/<br/></span><span id="c3f9" class="kp kq hi kl b fi kv ks l kt ku">## Optional, revert back to v1 if any issue, by running set again with :v1</span><span id="e035" class="kp kq hi kl b fi kv ks l kt ku">kubectl set image deployment/nextapollo  nextapollo=gcr.io/${PROJECT_ID}/nextapollo:v1</span></pre><p id="0b54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实际部署到生产环境中还有更多的问题需要考虑——持续集成、SSL证书、容器/pod资源设置、适当的负载平衡器和代理设置，但这将是您的起步。它运行的是Alpine Linux，这是一个更小的操作系统，适合容器。</p></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><blockquote class="je jf jg"><p id="fa2d" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated"><strong class="ih hj">2018年6月5日更新</strong></p></blockquote><p id="6e29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您厌倦了键入将新代码部署到pods所需的所有命令时，您可以在项目根目录中放置一个<code class="du lj lk ll kl b">deploy.sh</code>文件，它将自动完成所有工作。<a class="ae jd" rel="noopener" href="/google-cloud/easily-deploy-new-versions-of-code-to-kubernetes-on-gcp-with-a-single-command-ff920a367cf1">我在这里写了一下</a>。</p></div></div>    
</body>
</html>