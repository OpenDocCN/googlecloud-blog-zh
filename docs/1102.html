<html>
<head>
<title>Migrating from Kubernetes Deployment to Knative Serving</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Kubernetes部署迁移到Knative服务</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/migrating-from-kubernetes-deployment-to-knative-serving-bdc45ef1bb9e?source=collection_archive---------2-----------------------#2019-07-31">https://medium.com/google-cloud/migrating-from-kubernetes-deployment-to-knative-serving-bdc45ef1bb9e?source=collection_archive---------2-----------------------#2019-07-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2d5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我谈到Knative时，我经常会问如何将一个应用程序从Kubernetes部署(有时使用Istio)迁移到Knative，以及这两种设置之间有什么区别。</p><p id="cb04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，你可以用一个Knative服务做的所有事情，你可以用一个纯粹的Kubernetes + Istio设置和正确的配置来完成。然而，要做对会困难得多。Knative的全部目的是为您简化和抽象Kubernetes和Istio的细节。</p><p id="725f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博文中，我想用一种不同的方式回答这个问题。我想从一个Knative服务开始，并展示如何用Kubernetes + Istio“艰难地”设置相同的服务。</p><h1 id="0ef2" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">免费服务</h1><p id="455b" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">在我之前的<a class="ae kg" href="https://meteatamel.wordpress.com/2019/07/24/serverless-grpc-asp-net-core-with-knative/" rel="noopener ugc nofollow" target="_blank">帖子</a>中，我展示了如何使用Knative部署一个自动扩展的、支持gRPC的ASP.NET核心服务。这是无效服务定义文件<code class="du kh ki kj kk b">yaml</code>:</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="10ee" class="kt je hi kk b fi ku kv l kw kx">apiVersion: serving.knative.dev/v1beta1<br/>kind: Service<br/>metadata:<br/>  name: grpc-greeter<br/>  namespace: default<br/>spec:<br/>  template:<br/>    spec:<br/>      containers:<br/>        - image: docker.io/meteatamel/grpc-greeter:v1<br/>          ports:<br/>          - name: h2c<br/>            containerPort: 8080</span></pre><p id="e049" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意<code class="du kh ki kj kk b">yaml</code>文件的简单性。它有容器图像和端口信息(HTTP2/8080 ),没有其他的了。部署完成后，Knative Serving负责在Kubernetes pod中部署容器的所有细节，通过Istio ingress将pod暴露给外部世界，并设置自动缩放。</p><p id="92b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在没有Knative的情况下，在Kubernetes + Istio集群中部署相同的服务需要什么？让我们来看看。</p><h1 id="8264" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">Kubernetes部署</h1><p id="6bc9" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">首先，我们需要一个Kubernetes部署来将容器封装到一个pod中。这是部署<code class="du kh ki kj kk b">yaml</code>的样子:</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="c111" class="kt je hi kk b fi ku kv l kw kx">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: grpc-greeter<br/>spec:<br/>  selector:<br/>      matchLabels:<br/>        app: grpc-greeter<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: grpc-greeter<br/>    spec:<br/>      containers:<br/>      - name: grpc-greeter<br/>        image: docker.io/meteatamel/grpc-greeter:v1<br/>        ports:<br/>        - name: h2c<br/>          containerPort: 8080</span></pre><p id="7d11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这已经比Knative服务定义更加冗长。一旦部署，我们将有一个吊舱运行集装箱。</p><h1 id="cdbe" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">Kubernetes服务</h1><p id="13d2" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">下一步是公开Kubernetes服务背后的pod:</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="d6c5" class="kt je hi kk b fi ku kv l kw kx">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: grpc-greeter-service<br/>spec:<br/>  ports:<br/>  - name: http2<br/>    port: 80<br/>    targetPort: h2c<br/>  selector:<br/>    app: grpc-greeter</span></pre><p id="b227" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将暴露端口80后面的pod。然而，在我们在Istio中建立网络之前，它还不能公开访问。</p><h1 id="504c" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">Istio网关和虚拟服务</h1><p id="349f" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">在Istio集群中，我们需要首先设置一个网关，以便在一个端口/协议上启用外部流量。在我们的例子中，我们的应用程序需要端口80上的HTTP。这是我们需要的网关定义:</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="ad3d" class="kt je hi kk b fi ku kv l kw kx">apiVersion: networking.istio.io/v1alpha3<br/>kind: Gateway<br/>metadata:<br/>  name: grpc-gateway<br/>spec:<br/>  selector:<br/>    istio: ingressgateway # use istio default controller<br/>  servers:<br/>  - port:<br/>      number: 80<br/>      name: http<br/>      protocol: HTTP<br/>    hosts:<br/>    - "*"</span></pre><p id="ec95" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在在端口80上启用了流量，但是我们需要将流量映射到我们之前创建的Kubernetes服务。这是通过虚拟服务实现的:</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="1388" class="kt je hi kk b fi ku kv l kw kx">apiVersion: networking.istio.io/v1alpha3<br/>kind: VirtualService<br/>metadata:<br/>  name: grpc-virtualservice<br/>spec:<br/>  hosts:<br/>  - "*"<br/>  gateways:<br/>  - grpc-gateway<br/>  http:<br/>  - route:<br/>    - destination:<br/>        host: grpc-greeter-service</span></pre><p id="0b6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的豆荚终于可以公开了。您可以使用我之前博客中的<a class="ae kg" href="https://github.com/meteatamel/knative-tutorial/tree/master/serving/grpc/csharp/GrpcGreeterClient" rel="noopener ugc nofollow" target="_blank"> GrpcGreeterClient </a>指向Istio入口网关IP，您应该会看到我们服务的响应:</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="62e0" class="kt je hi kk b fi ku kv l kw kx">&gt; dotnet run <br/>Greeting: Hello GreeterClient <br/>Press any key to exit...</span></pre></div><div class="ab cl ky kz gp la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="hb hc hd he hf"><p id="ce27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">唷！在没有Knative的情况下部署一个公共可访问的容器需要很多步骤。我们仍然需要设置pod的自动缩放，以获得与Knative Serving相同的效果，但我将把它作为一个练习留给读者。</p><p id="1b7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望现在清楚了，Knative使得用更少的配置来部署自动缩放的容器变得更容易。Knative的高级API允许您更多地关注容器中的代码，而不是容器如何部署以及如何使用Kubernetes和Istio管理其流量的底层细节。</p><p id="d67c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lf">感谢Knative团队的</em> <a class="ae kg" href="https://twitter.com/mattomata" rel="noopener ugc nofollow" target="_blank"> <em class="lf">马特·摩尔</em> </a> <em class="lf">给了我这篇博文的灵感。</em></p></div><div class="ab cl ky kz gp la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="hb hc hd he hf"><p id="a919" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lf">原载于2019年7月31日</em><a class="ae kg" href="https://meteatamel.wordpress.com/2019/07/31/migrating-from-kubernetes-deployment-to-knative-serving/" rel="noopener ugc nofollow" target="_blank"><em class="lf">http://meteatamel.wordpress.com</em></a><em class="lf">。</em></p></div></div>    
</body>
</html>