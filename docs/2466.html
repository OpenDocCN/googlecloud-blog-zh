<html>
<head>
<title>gRPC health probes with Kubernetes 1.24+</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带Kubernetes 1.24+的gRPC健康探头</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/grpc-health-probes-with-kubernetes-1-24-b5bd26253a4c?source=collection_archive---------2-----------------------#2022-10-31">https://medium.com/google-cloud/grpc-health-probes-with-kubernetes-1-24-b5bd26253a4c?source=collection_archive---------2-----------------------#2022-10-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/8987929ac500ccedd6f3aef1c5932821.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hnLm60ufThZ4E_LnpuXukQ.png"/></div></div></figure><p id="e496" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">2022年12月8日更新，通过</em> <a class="ae jp" rel="noopener" href="/google-cloud/246119e46d53"> <em class="jo">掌舵图</em> </a> <em class="jo">部署线上精品。</em></p><p id="027e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jp" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>使用活跃度探测器了解何时重启容器，使用就绪性探测器了解容器何时准备好开始接受流量。</p><p id="38ec" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从Kubernetes 1.24+ 开始，gRPC健康探测器现在在beta <a class="ae jp" href="https://kubernetes.io/blog/2022/05/13/grpc-probes-now-in-beta/" rel="noopener ugc nofollow" target="_blank">中得到原生支持。在此之前，我们需要在每个</a> <code class="du jq jr js jt b"><a class="ae jp" href="https://cloud.google.com/blog/topics/developers-practitioners/health-checking-your-grpc-servers-gke" rel="noopener ugc nofollow" target="_blank">Dockerfile</a></code>中添加<code class="du jq jr js jt b"><a class="ae jp" href="https://cloud.google.com/blog/topics/developers-practitioners/health-checking-your-grpc-servers-gke" rel="noopener ugc nofollow" target="_blank">grpc_health_probe</a></code> <a class="ae jp" href="https://cloud.google.com/blog/topics/developers-practitioners/health-checking-your-grpc-servers-gke" rel="noopener ugc nofollow" target="_blank">二进制。</a></p><p id="7a16" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">自从<a class="ae jp" href="https://github.com/GoogleCloudPlatform/microservices-demo/releases/tag/v0.4.1" rel="noopener ugc nofollow" target="_blank">最近的v0.4.1版本</a>以来，<a class="ae jp" href="https://github.com/GoogleCloudPlatform/microservices-demo" rel="noopener ugc nofollow" target="_blank">在线精品示例</a>提供了一个选项，使其应用程序支持此功能。这允许您利用原生的Kubernetes特性，将容器映像的大小减少4MB(虚拟的)和11MB(在磁盘上),并减少这个<code class="du jq jr js jt b">grpc_health_probe</code>二进制文件增加的维护和攻击面。</p><h1 id="ac84" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">旧方法与新的本机gRPC健康探测器</h1><p id="d729" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">有了Kubernetes新的原生gRPC健康探测器，您不再需要将<code class="du jq jr js jt b">grpc_health_probe</code>二进制文件(像我们以前需要的那样)添加到您的微服务的<code class="du jq jr js jt b">Dockerfile</code>中:</p><pre class="kx ky kz la fd lb jt lc ld aw le bi"><span id="812b" class="lf jv hi jt b fi lg lh l li lj">RUN GRPC_HEALTH_PROBE_VERSION=v0.4.14 &amp;&amp; \<br/>    wget -qO/bin/grpc_health_probe https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/${GRPC_HEALTH_PROBE_VERSION}/grpc_health_probe-linux-amd64 &amp;&amp; \<br/>    chmod +x /bin/grpc_health_probe</span></pre><p id="4d4d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在您的<code class="du jq jr js jt b">Deployments</code>的Kubernetes清单中，这里是<code class="du jq jr js jt b">readinessProbe</code>和<code class="du jq jr js jt b">livenessProbe</code>的相关更新:</p><pre class="kx ky kz la fd lb jt lc ld aw le bi"><span id="5b88" class="lf jv hi jt b fi lg lh l li lj">+           grpc:<br/>+             port: 9555<br/>-           exec:<br/>-             command:<br/>-             - /bin/grpc_health_probe<br/>-             - -addr=:9555</span></pre></div><div class="ab cl lk ll gp lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="hb hc hd he hf"><h1 id="d3cb" class="ju jv hi bd jw jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr bi translated">使用这一新特性部署在线精品示例</h1><p id="6485" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">在版本1.24+中创建一个Google Kubernetes engineer(GKE)集群:</p><pre class="kx ky kz la fd lb jt lc ld aw le bi"><span id="6fc7" class="lf jv hi jt b fi lg lh l li lj">gcloud container clusters create tests \<br/>    --zone=us-east4-a \<br/>    --machine-type=e2-standard-2 \<br/>    --num-nodes=4 \<br/>    --release-channel=rapid</span></pre><p id="911b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">注:截止2022年11月1日，急速频道</em><a class="ae jp" href="https://cloud.google.com/kubernetes-engine/docs/release-notes-rapid" rel="noopener ugc nofollow" target="_blank"><em class="jo">【GKE】默认版本为1.24 </em> </a> <em class="jo">。</em></p><p id="18ed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从这里开始，让我们部署支持gRPC健康探针的在线精品示例。</p><p id="3304" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，我们将使用在线精品店的掌舵图:</p><pre class="kx ky kz la fd lb jt lc ld aw le bi"><span id="fbe7" class="lf jv hi jt b fi lg lh l li lj">helm upgrade onlineboutique oci://us-docker.pkg.dev/online-boutique-ci/charts/onlineboutique \<br/>    --install \<br/>    --create-namespace \<br/>    -n onlineboutique \<br/>    --set nativeGrpcHealthCheck=true</span></pre><p id="593a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">该部署将允许利用专用容器</em> <code class="du jq jr js jt b"><em class="jo">images</em></code> <em class="jo"> : </em></p><pre class="kx ky kz la fd lb jt lc ld aw le bi"><span id="c974" class="lf jv hi jt b fi lg lh l li lj"><em class="jo">-         image: gcr.io/google-samples/microservices-demo/*service:v0.4.1<br/>+         image: gcr.io/google-samples/microservices-demo/*service:v0.4.1-native-grpc-probes</em></span></pre><p id="1684" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你稍微等一等，直到所有的<code class="du jq jr js jt b">Pods</code>都在运行，你应该可以让你的在线精品网站成功运行。</p></div><div class="ab cl lk ll gp lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="hb hc hd he hf"><p id="23b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是我们如何轻松地利用Kubernetes 1.24+ 的新<a class="ae jp" href="https://kubernetes.io/blog/2022/05/13/grpc-probes-now-in-beta/" rel="noopener ugc nofollow" target="_blank">原生gRPC健康探针和在线精品样本。</a></p><p id="af0a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">默认情况下，在线精品示例还不支持原生gRPC健康探测器，因为Kubernetes 1.24+还没有被广泛使用。这就是为什么我们需要使用相关的<a class="ae jp" href="https://github.com/GoogleCloudPlatform/microservices-demo/blob/main/helm-chart/values.yaml#L21" rel="noopener ugc nofollow" target="_blank">头盔图</a>或<a class="ae jp" href="https://github.com/GoogleCloudPlatform/microservices-demo/tree/main/kustomize/components/native-grpc-health-check" rel="noopener ugc nofollow" target="_blank"> Kustomize叠加图</a>。</p></div><div class="ab cl lk ll gp lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="hb hc hd he hf"><p id="dc87" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">原贴于</em><a class="ae jp" href="https://mathieu-benoit.github.io/" rel="noopener ugc nofollow" target="_blank"><em class="jo">Mathieu-Benoit . github . io</em></a><em class="jo">。</em></p></div></div>    
</body>
</html>