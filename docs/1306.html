<html>
<head>
<title>A simple solution for fetching data from a headless CMS in a Dialogflow Chatbot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Dialogflow聊天机器人中的无头CMS获取数据的简单解决方案</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/a-simple-solution-for-fetching-data-from-a-headless-cms-in-a-dialogflow-chatbot-6edfa7c5e4c7?source=collection_archive---------0-----------------------#2020-03-02">https://medium.com/google-cloud/a-simple-solution-for-fetching-data-from-a-headless-cms-in-a-dialogflow-chatbot-6edfa7c5e4c7?source=collection_archive---------0-----------------------#2020-03-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="51c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">经常有人问我，为什么Dialogflow没有CMS？因此，非技术人员可以修改webhook实现答案，而不必训练模型或使用Dialogflow控制台。问题是，Dialogflow可以与您喜欢的任何内容集成。</p><p id="472d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae jd" href="https://github.com/savelee/kube-django-ng/" rel="noopener ugc nofollow" target="_blank">我的Dialogflow，Django，Angular示例</a>中，我使用Django作为CMS来导入用户帐户。事实上，我正在使用Django Rest模块，通过Rest API与Django通信。</p><p id="1107" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我将利用一个无头的CMS<a class="ae jd" href="https://www.sanity.io/" rel="noopener ugc nofollow" target="_blank">神智清醒</a>。</p><p id="9428" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以使用任何CMS，甚至是Wordpress，但是如果有(现成的)REST APIs可以使用，事情会变得更简单。这是一个无头CMS可以做得很好的。它将内容从网页中分离出来，以便在各种环境中重用，如移动应用程序或聊天机器人。</p><h1 id="a342" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated"><strong class="ak">对话流</strong></h1><p id="9954" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">为了准备包含动态内容的Dialogflow，让我们创建一些实体和意图。</p><p id="bb76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此示例创建了一个多语言帮助台聊天机器人。在Dialogflow设置面板中，我启用了以下两种语言:<strong class="ih hj">英语</strong>和<strong class="ih hj">法语</strong>。</p><p id="5d74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在实体屏幕中，我创建了两个实体:<strong class="ih hj">系统</strong>和<strong class="ih hj">用户操作</strong>。</p><p id="bef9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Systems </strong>保存了一串计算机系统名称，它们都映射到一个键。例如<strong class="ih hj"> InsidePayments </strong>属于实体<strong class="ih hj">系统</strong>中的<strong class="ih hj"> ibb </strong>键。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/c405fb0366c16a4524c77ef7c0e9f5a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oiY4oK9y_2upL2lR"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">对话流实体</figcaption></figure><p id="c26e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实体<strong class="ih hj"> useractions </strong>包含用户操作，如<strong class="ih hj">删除、添加、编辑</strong>。</p><p id="2c5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于我的CMS中的每个内容项目，我需要创建一个训练短语的意图。这里有一个意向名称的例子:<strong class="ih hj"> 333 </strong>。它有一堆训练短语，比如:</p><p id="6b13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">“如何在TopMortgage中编辑新账户”。</strong></p><p id="d909" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个意图包含2个必需的参数，需要填充这些参数，以便过滤CMS内容项。<strong class="ih hj">参数用户操作</strong> &amp; <strong class="ih hj">参数系统</strong>。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/a7284d000e3ed8ea82ad48577f4814df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4lt6bqiz6j81uF1X"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">带有必需参数的对话流意图</figcaption></figure><p id="4fc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要确保所有需要从CMS获取信息的意图都启用了<strong class="ih hj"> webhook实现</strong>:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/9ec77638f0a3fdb0643949d81f5cd1c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-Oo3aWlQp7JKiXHj"/></div></div></figure><p id="e30d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对话流部分到此结束。现在让我们转向理智。</p><h1 id="abfe" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">头脑清楚</h1><p id="dcbe" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我正在我的本地主机上安装Sanity，因为我将只使用Sanity Studio来编写内容项。如果您想向您的(非技术)客户交付这个环境，您可以在计算引擎Node.js VM上安装Sanity。</p><ol class=""><li id="1a97" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated">安装健全性</li></ol><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="de77" class="lm jf hi li b fi ln lo l lp lq">sudo npm install -g @sanity/cli</span><span id="1578" class="lm jf hi li b fi lr lo l lp lq">sanity init</span></pre><p id="9e10" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用Google帐户、Github或您自己的电子邮件帐户登录。单击命令行上显示的链接，并接受条款和条件:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es ls"><img src="../Images/5d9337e09a10dd9c89b17b76db1a209a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*acDbZhajXGBi7aPa"/></div></div></figure><p id="cb6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.回到命令行:</p><p id="86c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">提供项目名称</strong>:聊天机器人CMS</p><p id="658c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">默认数据集配置</strong> : Y</p><p id="1b50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">输出路径</strong> : /home/admin/chatbotcms</p><p id="9764" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">模式</strong>:无</p><p id="07bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">添加样品</strong>:否</p><p id="ecf2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.让我们修改健全模式:</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="2057" class="lm jf hi li b fi ln lo l lp lq">cd /home/admin/chatbotcms/schemas</span><span id="c930" class="lm jf hi li b fi lr lo l lp lq">nano schema.js</span></pre><p id="0c4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">粘贴并保存以下内容:</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="lt lu l"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">Schema.js</figcaption></figure><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="450c" class="lm jf hi li b fi ln lo l lp lq">nano simpleresponse.js</span></pre><p id="59d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">粘贴并保存以下内容:</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="lt lu l"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">简单响应. js</figcaption></figure><p id="de51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.开始理智</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="7c40" class="lm jf hi li b fi ln lo l lp lq">cd chatbotcms</span><span id="7c38" class="lm jf hi li b fi lr lo l lp lq">sanity start</span></pre><p id="9c7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.导航到<a class="ae jd" href="http://localhost:3333" rel="noopener ugc nofollow" target="_blank"> http://localhost:3333 </a></p><p id="6d5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击<strong class="ih hj">意向&gt; + </strong></p><p id="2116" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加内容页面:</p><p id="fba8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里，坚持对话流映射很重要。</p><ul class=""><li id="6e0d" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc lv le lf lg bi translated">注意意图名称(id)与对话流中的意图名称<strong class="ih hj"> 333 </strong>相同！</li><li id="ac42" class="ky kz hi ih b ii lw im lx iq ly iu lz iy ma jc lv le lf lg bi translated">系统名(paramSystem)映射到<strong class="ih hj">系统</strong>中的对话流实体键<strong class="ih hj"> ibb </strong></li><li id="4d7e" class="ky kz hi ih b ii lw im lx iq ly iu lz iy ma jc lv le lf lg bi translated">用户动作(paramUserAction)映射到对话框流实体键<strong class="ih hj">在<strong class="ih hj">用户动作</strong>中添加</strong></li></ul><p id="1b16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于其余的这一项需要有一个可读的标题，将在理智可见。和2个聊天机器人响应。一份英文，一份法文:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/6421b909df9d1a627266f0f13983daa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SEKa233K93G83k92"/></div></div></figure><p id="2ada" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以创建多个内容项目。对于每个用户操作和系统组合，都有自己的项目。</p><p id="eb67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们查询我们的数据:</p><p id="b34b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.点击健全菜单中的<strong class="ih hj">视觉</strong></p><p id="f452" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用下面的<a class="ae jd" href="https://www.sanity.io/docs/groq" rel="noopener ugc nofollow" target="_blank"> GROQ </a>查询来获取所有简单的响应项:</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="0a04" class="lm jf hi li b fi ln lo l lp lq">*[_type == ‘simpleresponse’]</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/efbaae6f99148996b61350828033b33e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dLBO3mSyPJ-kMebL"/></div></div></figure><p id="496b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下查询来过滤特定intent name (id)和参数<strong class="ih hj">param system</strong>&amp;<strong class="ih hj">param user action</strong>上的项目。作为输出，我们只显示英语语言的响应:</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="13b1" class="lm jf hi li b fi ln lo l lp lq">*[_type == ‘simpleresponse’ &amp;&amp;</span><span id="ab42" class="lm jf hi li b fi lr lo l lp lq">id == $id</span><span id="f5a7" class="lm jf hi li b fi lr lo l lp lq">&amp;&amp; paramUserAction == $paramUserAction</span><span id="853f" class="lm jf hi li b fi lr lo l lp lq">&amp;&amp; paramSystem == $paramSystem]{</span><span id="e918" class="lm jf hi li b fi lr lo l lp lq">responseEn</span><span id="8e4f" class="lm jf hi li b fi lr lo l lp lq">}</span></pre><p id="f9b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参数:</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="cc43" class="lm jf hi li b fi ln lo l lp lq">{</span><span id="f3b2" class="lm jf hi li b fi lr lo l lp lq">“id”: “333”,</span><span id="e02a" class="lm jf hi li b fi lr lo l lp lq">“paramUserAction”: “add”,</span><span id="f876" class="lm jf hi li b fi lr lo l lp lq">“paramSystem”: “ibb”</span><span id="abc9" class="lm jf hi li b fi lr lo l lp lq">}</span></pre><p id="8b83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意结果:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/f12cb85869eab69c6e1ad913f4329e1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nvvnUYJOEKCqwxHA"/></div></div></figure><p id="e211" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好了，内容已经呈现了。我们可以通过<strong class="ih hj"> GROQ </strong>查询来过滤内容。剩下唯一要做的就是在Dialogflow中实现webhook fulfillment代码，它可以运行这个查询，但是通过slot filling使用Dialogflow提供的参数。</p><h1 id="828c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated"><strong class="ak">对话流</strong></h1><p id="8f57" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在Dialogflow行内编辑器中，我们可以使用以下代码:</p><p id="3ffb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用下面的<strong class="ih hj"> package.json </strong>:</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="lt lu l"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">package.json</figcaption></figure><p id="ab96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以及下面的<strong class="ih hj"> index.js </strong>:</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="lt lu l"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">索引. js</figcaption></figure><p id="0359" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这段代码实现了健全的NPM客户端。您需要指定Sanity项目ID和数据集名称。(如果您丢失了这些，可以在Sanity安装文件夹<strong class="ih hj"> sanity.json </strong>中找到)。这样它就知道查询属于您的项目的内容项。</p><p id="be74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Sanity客户端方法:<strong class="ih hj"> client.fetch() </strong>使用Dialogflow代理提供的参数获取GROQ查询。</p><p id="8588" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Firebase Cloud函数中，它实现了Dialogflow代理，并从Dialogflow代理中检索参数和代理区域设置。正确的意图将由这些代码行来匹配:</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="d59c" class="lm jf hi li b fi ln lo l lp lq">let intentMap = new Map();</span><span id="4092" class="lm jf hi li b fi lr lo l lp lq">intentMap.set(‘333’, responses);</span><span id="d20b" class="lm jf hi li b fi lr lo l lp lq">agent.handleRequest(intentMap);</span></pre><p id="f2e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要记住的唯一重要的事情是，这些行需要在<strong class="ih hj"> client.fetch </strong>的解析承诺内，否则您可能会遇到时间问题，因此Dialogflow返回匹配的意图，而没有CMS结果。</p><p id="765b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以在Dialogflow控制台中测试您的表达式:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mb"><img src="../Images/067865f459d44550a0e6e88e974aaef4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1398/0*bPoId4OOj4MjcSEX"/></div></div></figure><p id="0247" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于代理的语言环境，它将从headless Sanity CMS内部的数据中返回选择的语言项。</p><p id="ae6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好了，这里有一个简单的解决方案，可以从Dialogflow聊天机器人中的headless CMS (Sanity)获取数据！</p></div></div>    
</body>
</html>