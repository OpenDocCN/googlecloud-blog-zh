<html>
<head>
<title>Have budget notifications come to your favorite comms channels</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">您最喜欢的沟通渠道收到预算通知了吗</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/have-budget-notifications-come-to-your-favorite-comms-channels-611f6bb3592b?source=collection_archive---------1-----------------------#2021-04-06">https://medium.com/google-cloud/have-budget-notifications-come-to-your-favorite-comms-channels-611f6bb3592b?source=collection_archive---------1-----------------------#2021-04-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e528" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">TL；DR——您可以使用程序化预算通知将预算更新发送到您最喜欢的通信渠道，如Slack(以及任何您可以编码的东西),而不是等待预算提醒电子邮件。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/f3504282bf672e7989b6b45ac47006bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sKCy8MWz4SC4EHdD"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><em class="jt">更多的预算可见性选项非常适合FinOps生命周期的信息阶段</em></figcaption></figure><p id="0b5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ju" href="https://cloud.google.com/blog/topics/developers-practitioners/costs-meet-code-programmatic-budget-notifications" rel="noopener ugc nofollow" target="_blank">的上一篇文章</a>介绍了程序化的预算通知，我们看到了一个打印一些信息的简单例子。因为我们可以用代码来响应预算通知，所以包括第三方集成在内的所有可能性都是可用的。</p><p id="e63f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ju" href="https://slack.com/" rel="noopener ugc nofollow" target="_blank"> Slack </a>是一个流行的团队交流平台，所以它是发送预算信息和让你的团队了解你的预算状态的理想选择。在本帖中，我们将介绍向Slack发送预算通知的步骤。</p><p id="ac8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">免责声明</strong>:这些说明在写作的时候起作用，但是懈怠可能会改变事情。</p><h1 id="9ae2" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">配置时差</h1><p id="3be5" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">这是我们努力的方向:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ky"><img src="../Images/8b94fbbdb6328889c7131d055451d2c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:866/0*bHEBqyhknZEtG2jP"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">成本和预测阈值未定义，因为此预算尚未达到阈值，所以这些参数不会出现在消息中</figcaption></figure><p id="ce16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一条由bot (gcp_cost_management_bot)发布的消息，它打印出一堆不同的预算通知细节。除了上一篇文章，这里没有太多的事情要做，但首先我们需要设置一个Slack bot。</p><p id="7b16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您还没有Slack帐户和工作区(但不是云监控帐户和工作区),您需要创建一个。我会把这部分的<a class="ae ju" href="https://slack.com/help/articles/206845317-Create-a-Slack-workspace" rel="noopener ugc nofollow" target="_blank">解释留给他们</a>，但是一旦你完成了，就去找<a class="ae ju" href="https://api.slack.com/apps" rel="noopener ugc nofollow" target="_blank">https://api.slack.com/apps</a>。你想做的第一件事是做一个新的应用程序。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kz"><img src="../Images/7b4a440561806b31d8970cb064eadc75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/0*tN4CL_vG-XhXKsHp"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">考虑一个名字，比如“预算警报机器人”，或者甚至是“预算卫士超级英雄”。你想怎么叫都行，我不是你的老板</figcaption></figure><p id="e04b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你创建了你的应用程序，你可以配置很多关于你的机器人的其他东西，但是我们需要两个关键的信息来让它工作，一个<strong class="ih hj"> OAuth令牌</strong>和一个<strong class="ih hj">通道</strong>。</p><p id="0854" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要获得OAuth令牌，请查找标有“OAuth &amp; Permissions”的菜单选项。在那里，找到Bot令牌作用域部分，然后单击“添加OAuth作用域”。发送消息所需的范围称为“聊天:写”,所以输入并添加它。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es la"><img src="../Images/9a98a6dbcb8c77c614c56e9ac0916aad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/0*O5NEuKk5PSWgSPBg"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">你可以用机器人做各种新奇的事情，但我喜欢保持简单</figcaption></figure><p id="c3d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，向上滚动并查找“将应用程序安装到工作区”，这将引导您到一个许可屏幕，在那里您授权机器人发布消息。这样做之后，您将看到一个OAuth访问令牌，您应该复制并记下它，因为我们以后会用到它。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/58b1dd1c390252e2199984ce5193a5e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wYM-0KtT5VRFNSXh"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">你不会以为我会把我的OAuth Token给你吧？</figcaption></figure><p id="af48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安全地存储之后，您唯一需要的就是一个您想要向其发送消息的通道。我使用了一个名为“预算提醒”的频道(不包括#)，但我建议使用一个新的频道，而不是一个现有的频道，至少在开始的时候！</p><p id="8138" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>:你还需要进入你的频道，运行一个命令，邀请机器人进入你希望它发布的频道。您需要根据您提供的名称更新机器人名称。</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="26ca" class="lg jw hi lc b fi lh li l lj lk">/invite @budget_alert_bot</span></pre><h1 id="3760" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">回到云端！</h1><p id="a49d" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">现在我们有了令牌和通道，回到<a class="ae ju" href="https://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank">谷歌云控制台</a>并创建一个新的谷歌云功能。如果您遵循了上一篇文章中的步骤，您可以保留或关闭logger bot，因为Pub/Sub允许多个订阅者订阅一个主题。选择类似“预算-通知-时差”的名称，并确保选择相同的发布/订阅主题。如果你想复习创建一个函数，上一篇文章有更多的信息。</p><p id="becd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同样，我们将使用Python 3.7，但这次我们将更改代码。默认情况下，左边有两个文件，main.py和requirements.txt。我不会在这里详细讨论Python细节，而是单击requirements.txt并添加这行代码:</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="97b2" class="lg jw hi lc b fi lh li l lj lk">slackclient==2.7.2</span></pre><p id="b645" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有一张图，以确保一切都是好的:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ll"><img src="../Images/b31cc91f309861ba1553525215971eb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Zz_JyE_W85Eq6ixN"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Google Cloud Functions会自动处理很多依赖项，但是我们需要手动添加Slack</figcaption></figure><p id="900d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后，点击main.py，使用这个代码(<a class="ae ju" href="https://cloud.google.com/billing/docs/how-to/notify#write-a-cloud-function" rel="noopener ugc nofollow" target="_blank">或者从这里抓取</a>):</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="1522" class="lg jw hi lc b fi lh li l lj lk">import base64<br/>import json<br/>import os<br/>import slack<br/>from slack.errors import SlackApiError<br/># See <a class="ae ju" href="https://api.slack.com/docs/token-types#bot" rel="noopener ugc nofollow" target="_blank">https://api.slack.com/docs/token-types#bot</a> for more info<br/>BOT_ACCESS_TOKEN = 'xxxx-111111111111-abcdefghidklmnopq'<br/>CHANNEL = 'C0XXXXXX'</span><span id="700d" class="lg jw hi lc b fi lm li l lj lk">slack_client = slack.WebClient(token=BOT_ACCESS_TOKEN)</span><span id="86ca" class="lg jw hi lc b fi lm li l lj lk">def notify_slack(data, context):<br/>    pubsub_message = data</span><span id="a005" class="lg jw hi lc b fi lm li l lj lk">try:<br/>        notification_attr = json.dumps(pubsub_message['attributes'])<br/>    except KeyError:<br/>        notification_attr = "No attributes passed in"</span><span id="54e8" class="lg jw hi lc b fi lm li l lj lk">try:<br/>        notification_data = base64.b64decode(data['data']).decode('utf-8')<br/>    except KeyError:<br/>        notification_data = "No data passed in"</span><span id="200b" class="lg jw hi lc b fi lm li l lj lk">budget_notification_text = f'{notification_attr}, {notification_data}'</span><span id="9537" class="lg jw hi lc b fi lm li l lj lk">try:<br/>        slack_client.api_call(<br/>            'chat.postMessage',<br/>            json={<br/>                'channel': CHANNEL,<br/>                'text'   : budget_notification_text<br/>            }<br/>        )<br/>    except SlackApiError:<br/>        print('Error posting to Slack')</span></pre><p id="ee2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这不是太多的代码，但是让我们分解几个重要的部分:</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="3720" class="lg jw hi lc b fi lh li l lj lk">BOT_ACCESS_TOKEN = 'xxxx-111111111111-abcdefghidklmnopq'<br/>CHANNEL = 'C0XXXXXX'</span><span id="49d0" class="lg jw hi lc b fi lm li l lj lk">slack_client = slack.WebClient(token=BOT_ACCESS_TOKEN)</span></pre><p id="6ffc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>:如果不自己更新这部分代码，就不行。</p><p id="1a21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在导入之后，这两行是您需要用之前安全保存的值进行更新的行。这两个都是需要替换的字符串，应该很清楚哪个值放在哪里。请注意，通道变量可以是您的通道的名称(如“预算-警报”)或通道ID(如C0123456789)。我们还用bot访问令牌设置了Slack客户机。</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="cdc8" class="lg jw hi lc b fi lh li l lj lk">def notify_slack(data, context):<br/>    pubsub_message = data</span></pre><p id="03c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是名为“notify_slack”的函数的开始，然后我们获取作为消息发布/订阅从预算中获取的数据。</p><p id="763c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>:您还需要将函数的入口点从“hello_pubsub”更改为“notify_slack ”,因为这是我们想要调用的实际函数。如果不改变切入点，那就不行。</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="b7d9" class="lg jw hi lc b fi lh li l lj lk">try:<br/>        notification_attr = json.dumps(pubsub_message['attributes'])<br/>    except KeyError:<br/>        notification_attr = "No attributes passed in"<br/>try:<br/>        notification_data = base64.b64decode(data['data']).decode('utf-8')<br/>    except KeyError:<br/>        notification_data = "No data passed in"</span></pre><p id="b2d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae ju" href="https://cloud.google.com/blog/topics/developers-practitioners/costs-meet-code-programmatic-budget-notifications" rel="noopener ugc nofollow" target="_blank">的上一篇文章</a>中，我们回顾了Pub/Sub从预算中获得的消息，以及它发送给订户的内容。嗯，比我之前解释的要复杂一点(抱歉)。完整的消息实际上由两部分组成，<strong class="ih hj">属性</strong>和<strong class="ih hj">数据</strong>。你可以在这里阅读<a class="ae ju" href="https://cloud.google.com/billing/docs/how-to/budgets-programmatic-notifications#notification_format" rel="noopener ugc nofollow" target="_blank">的完整规范</a>，但是我们基本上只是获取属性(JSON)和数据(Base64编码)，这样我们就可以使用它们作为有价值的数据。</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="13e7" class="lg jw hi lc b fi lh li l lj lk">budget_notification_text = f'{notification_attr}, {notification_data}'</span></pre><p id="05ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一行只是从属性和数据中获取值，并将它们放入一个字符串中。是的，这会很乱，但这只是我们现在的起点。</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="9a61" class="lg jw hi lc b fi lh li l lj lk">slack_client.api_call(<br/>    'chat.postMessage',<br/>    json={<br/>        'channel': CHANNEL,<br/>        'text'   : budget_notification_text<br/>    }<br/>)</span></pre><p id="eb10" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，在这里我们尝试将消息发送到Slack，指定通道和实际的消息。很简单。</p><p id="196d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以，这就是我们需要的所有代码！确保如上所述替换bot令牌、通道名和函数入口点，并部署该函数！</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ln"><img src="../Images/f8158e321fb166499567340024f77afe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*R_Z4hfSKPL6qSAbd"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">部署功能可能需要一点时间，所以在等待的时候，请随意为自己泡一杯茶</figcaption></figure><p id="8037" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦功能启动并运行，我们就可以继续测试它了！</p><h1 id="5132" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">证据就在通知里</h1><p id="ccbe" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">类似于我们测试logger函数时，我们可以使用Pub/Sub发送测试消息，或者只是等待预算通知。我急得要命，就发个测试消息吧。进入发布/订阅页面，点击你的主题，然后点击发布消息。我们可以使用相同的测试体:</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="c1f5" class="lg jw hi lc b fi lh li l lj lk">{<br/>    "budgetDisplayName": "name-of-budget",<br/>    "alertThresholdExceeded": 1.0,<br/>    "costAmount": 100.01,<br/>    "costIntervalStart": "2019-01-01T00:00:00Z",<br/>    "budgetAmount": 100.00,<br/>    "budgetAmountType": "SPECIFIED_AMOUNT",<br/>    "currencyCode": "USD"<br/>}</span></pre><p id="b20f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是我们也可以添加一些属性来反映真正的通知可能是什么样子。两个重要的属性是记帐帐户的ID和预算的ID，这两个属性都是唯一的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lo"><img src="../Images/6ba04ffb42b2a16c7f04f42423b0d1d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zkltyQm1RZU_biWX"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><em class="jt">正如你能猜到的，那些不是我真正的唯一id</em></figcaption></figure><p id="136b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你发送了消息，检查你的Slack频道，你应该会看到这样的内容:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lp"><img src="../Images/308d95ccb598940a395c97ff67cb2164.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*txg8cXgqoiW-JugS"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">好哇，是我们发的测试数据！</figcaption></figure><h1 id="7db2" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">包装东西</h1><p id="cc1f" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">正如您应该看到的，测试消息通过了，数据被发送到来自机器人的消息中！当然，如果您等待一段时间，您还会看到一条包含真实数据的实际预算通知消息，该消息会被发送到Slack。</p><p id="c906" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能会注意到，bot消息与顶部的第一张图片不匹配(这些博客帖子确实很长)。这是因为您可以更新代码，而不仅仅是转储整个对象，您可以格式化特定于数据的消息和对您最有意义的格式。这篇文章很长，所以我把它留给你做练习！如果你想看更多的例子，<a class="ae ju" href="https://cloud.google.com/billing/docs/how-to/notify" rel="noopener ugc nofollow" target="_blank">查看文档</a>。</p></div></div>    
</body>
</html>