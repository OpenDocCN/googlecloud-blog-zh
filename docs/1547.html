<html>
<head>
<title>Managing payments in your app: Check out the checkout — the code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在你的应用程序中管理支付:查看结账——代码</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/managing-payments-in-your-app-check-out-the-checkout-the-code-b869132170fb?source=collection_archive---------1-----------------------#2020-08-05">https://medium.com/google-cloud/managing-payments-in-your-app-check-out-the-checkout-the-code-b869132170fb?source=collection_archive---------1-----------------------#2020-08-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a7f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">了解如何在云运行中创建条带检出意图，并将会话ID传递给客户端。</em></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/53038cb328dcdf925738a87e8bac85f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*M-G717Lyt6LiQ7xX"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated"><em class="ju">退房时间到了！</em> <a class="ae jv" href="https://unsplash.com/photos/K_P6uDekLKI" rel="noopener ugc nofollow" target="_blank"> <em class="ju">来源</em> </a></figcaption></figure><p id="981b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">你是这个系列的新手吗？查看</em> <a class="ae jv" href="https://bit.ly/33qptv1" rel="noopener ugc nofollow" target="_blank"> <em class="jd">第一篇博客</em> </a> <em class="jd">的介绍和目录！</em></p><h1 id="6847" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">赶上进度</h1><p id="a7dd" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">随着我们的美国袜子市场库存的增加和运行，是时候通过创建支付意图来实现Stripe Checkout的服务器端组件了。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/520358b62cae8594708a0902fd270903.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8qecRXUMzrHf88Yo"/></div></div></figure><p id="1932" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你对这些代码背后的基本原理感兴趣，那么看看这个博客！</p><p id="18b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设您已经了解了我为什么要包含这段代码，我将把重点放在执行上。简而言之，Stripe Checkout API使您能够以安全且符合当前法规的方式实现采购功能。这个过程包括在服务器环境中创建一个购买意向，并将该意向传递给客户机以完成购买。</p><p id="09ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章详细介绍了实现Checkout的服务器端组件的方法。</p><h1 id="92f4" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">建立</h1><p id="2c38" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">记住这一点，让我们来探索一下结帐功能。导航至<strong class="ih hj"> part-2-stripe-checkout </strong>文件夹，查看其中的内容。</p><ul class=""><li id="79b2" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc le lf lg lh bi translated">checkout.js</li><li id="2989" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">package.json</li><li id="53cf" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">Dockerfile文件</li><li id="eb2b" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">README.md</li></ul><p id="e000" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，这告诉你这也是一个Node.js应用程序，感谢<code class="du ln lo lp lq b">package. json</code>。但是，这里还有一个附加文件:<code class="du ln lo lp lq b">Dockerfile</code>。将应用打包到容器中并部署到云运行时，这是必需的。</p><h1 id="761c" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">代码</h1><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/2af584b02aad55b831801aa79ff5d43b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lI_C7Ddvy8bg6x-B"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated"><a class="ae jv" href="https://unsplash.com/photos/q2GNdFmhxx4" rel="noopener ugc nofollow" target="_blank"> <em class="ju">来源</em> </a></figcaption></figure><p id="721e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在部署到Cloud Run之前，让我们看一下<code class="du ln lo lp lq b">checkout.js</code>中的代码。</p><p id="14a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，有一些导入和初始化器。</p><pre class="jf jg jh ji fd lr lq ls lt aw lu bi"><span id="ad66" class="lv jx hi lq b fi lw lx l ly lz">const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);<br/>const admin = require('firebase-admin');<br/>const express = require('express');<br/>const app = express();<br/>admin.initializeApp();<br/>const db = admin.firestore()<br/>const DOMAIN = process.env.DOMAIN;</span></pre><p id="8d7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意这里有几个环境变量。您可以在本地声明值，就像我们在将库存项目添加到Cloud Firestore和Stripe以进行本地测试时所做的那样，但是一旦代码被部署到Cloud Run，您也将在该环境中为它们赋值。有几种方法可以做到这一点，我将在后面的文章中解释。</p><p id="2a84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，是端点定义。该函数使用<code class="du ln lo lp lq b">session</code>扩展，引用当前正在创建的条带检出会话。</p><pre class="jf jg jh ji fd lr lq ls lt aw lu bi"><span id="d8ae" class="lv jx hi lq b fi lw lx l ly lz">app.get('/session', async (req, res) =&gt; {</span></pre><p id="491c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来是一些处理CORS和实现对请求的查询选项的响应的代码。我不打算深入研究这段代码，因为它主要是关于一般的HTTP请求。</p><pre class="jf jg jh ji fd lr lq ls lt aw lu bi"><span id="2472" class="lv jx hi lq b fi lw lx l ly lz">res.set('Access-Control-Allow-Origin', '*');</span><span id="9503" class="lv jx hi lq b fi ma lx l ly lz">if (req.method === 'OPTIONS') {</span><span id="3552" class="lv jx hi lq b fi ma lx l ly lz">// Send response to OPTIONS requests</span><span id="dd00" class="lv jx hi lq b fi ma lx l ly lz">res.set('Access-Control-Allow-Methods', 'GET');</span><span id="0d40" class="lv jx hi lq b fi ma lx l ly lz">res.set('Access-Control-Allow-Headers', 'Content-Type');</span><span id="9b44" class="lv jx hi lq b fi ma lx l ly lz">res.set('Access-Control-Max-Age', '3600');</span><span id="d8e1" class="lv jx hi lq b fi ma lx l ly lz">res.status(204).send('');</span></pre><p id="cf0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获取作为查询参数传递的产品名称，然后用它来引用Firestore中的产品文档。</p><pre class="jf jg jh ji fd lr lq ls lt aw lu bi"><span id="c9f8" class="lv jx hi lq b fi lw lx l ly lz">let product = req.query.product;<br/>let productRef = db.collection('socks').doc(product);<br/>productRef<br/>  .get()<br/>  .then(async doc =&gt; {<br/>    // Get inventory data from Firestore<br/>    const data = doc.data();</span></pre><p id="0c79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检索到文档后，从文档数据中获取产品信息。</p><h1 id="64fd" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">为什么不将所有数据作为查询参数传递？</h1><p id="2574" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">正如标题所示，您可能想知道为什么代码需要从Firestore获取产品数据，而这些数据本可以作为查询参数从客户端传递过来。如果数据是直接从客户端传递过来的，那么用户就有可能自己定价。</p><h1 id="ef35" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">创建条带签出会话</h1><p id="71f1" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">使用Cloud Firestore提供的信息，创建结账会话。您会注意到成功URL和取消URL是使用<code class="du ln lo lp lq b">DOMAIN</code>环境变量提供的。这个变量将是您的web应用程序的URL。因为我们还没有制作那个应用程序，所以我们将使用一个替身。</p><pre class="jf jg jh ji fd lr lq ls lt aw lu bi"><span id="1bee" class="lv jx hi lq b fi lw lx l ly lz">// Create a CheckoutSession on Stripe with the order information<br/>const session = await stripe.checkout.sessions.create({<br/>  payment_method_types: ['card'],<br/>  line_items: [<br/>    {<br/>      name: data.name,<br/>      description: data.description,<br/>      amount: data.price,<br/>      currency: 'usd',<br/>      quantity: 1,<br/>      images: [data.image]<br/>    }<br/>  ],<br/>  success_url: DOMAIN + '/completed.html',<br/>  cancel_url: DOMAIN + '/canceled.html',<br/>  metadata: { file: data.file }<br/>});</span></pre><p id="186f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建后，在响应对象中传递该会话。</p><pre class="jf jg jh ji fd lr lq ls lt aw lu bi"><span id="4e58" class="lv jx hi lq b fi lw lx l ly lz">// Send the session to the client<br/>res.send(session);</span></pre><h1 id="6328" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">部署到云运行</h1><p id="d307" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">现在我们已经研究了代码，让我们开始部署吧！下面的命令在幕后做了很多工作。首先，它使用Cloud Build构建容器映像，然后将映像存储在容器注册表中，最后部署到Cloud Run。将<code class="du ln lo lp lq b">SERVICE</code>更改为您希望为服务指定的名称，将<code class="du ln lo lp lq b">PROJECT-ID</code>更改为您的云项目ID，将<code class="du ln lo lp lq b">REGION</code>更改为您希望部署的地区(例如<code class="du ln lo lp lq b">us-central1</code>)。</p><pre class="jf jg jh ji fd lr lq ls lt aw lu bi"><span id="8d4c" class="lv jx hi lq b fi lw lx l ly lz">gcloud run deploy SERVICE --image gcr.io/PROJECT-ID/checkout-session --platform managed --allow-unauthenticated --region REGION</span></pre><p id="1ff0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行此命令后，终端将显示访问您的应用程序的URL。如果您现在点击这个链接，您会得到一个错误，因为环境变量还没有值。让我们把它修好！</p><h1 id="bd9a" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">在云运行中配置环境变量</h1><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/6ae504d402206e4d0da1d9fad698db55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*575yE7A4RvMiOmq9"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">不，不是那种环境！ <a class="ae jv" href="https://unsplash.com/photos/ihMzQV3lleo" rel="noopener ugc nofollow" target="_blank"> <em class="ju">来源</em> </a></figcaption></figure><p id="08ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于环境变量的云运行文档展示了几种实例化值的方法:通过控制台，通过gcloud，或者通过。yaml文件。所有这些方法都有各自的用处。如果你偏爱其中一个，请随意使用。正如我以前说过的，如果有选择的话，我通常倾向于CLI。然而，在这种情况下，我更喜欢. yaml。当我有一大堆变量要设置时，这感觉更容易。我可以看到它们并检查错误，然后迅速做出更改。虽然我们这里只有两个环境变量，但是您的项目可能会更加复杂，包含更多的组件和变量。在项目成长之前熟悉这个系统是很好的。</p><pre class="jf jg jh ji fd lr lq ls lt aw lu bi"><span id="fa04" class="lv jx hi lq b fi lw lx l ly lz">gcloud run services describe SERVICE --format export &gt; service.yaml</span></pre><p id="da4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以将环境变量添加到文档中。请确保使用您的条带密钥，该密钥可通过条带控制台访问。一旦您的店面web应用程序部署完毕，您将使用您实际的web URL替换<code class="du ln lo lp lq b"><a class="ae jv" href="https://www.google.com/" rel="noopener ugc nofollow" target="_blank">https://www.google.com</a> </code>。</p><pre class="jf jg jh ji fd lr lq ls lt aw lu bi"><span id="07d2" class="lv jx hi lq b fi lw lx l ly lz">apiVersion: serving.knative.dev/v1<br/>  kind: Service<br/>  metadata:<br/>    name: SERVICE-abc<br/>  spec:<br/>    template:<br/>      spec:<br/>        containers:<br/>          - env:<br/>            - name: STRIPE_SECRET_KEY<br/>            value: sk_test_abcd1234<br/>            - name: DOMAIN<br/>              value: https://www.google.com</span></pre><p id="b493" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还有一点需要注意:元数据下面的<code class="du ln lo lp lq b">name</code>是指具体的配置版本。如果你上传这个。同样，您会得到一个错误，因为该名称已经被占用。<strong class="ih hj">删除此</strong> <code class="du ln lo lp lq b"><strong class="ih hj">name</strong></code> <strong class="ih hj">字段以便上传文件。这将分配一个新的随机生成的版本名。</strong></p><p id="313f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">保存该文件，您就可以上传新的配置了。</p><p id="dc29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，这个配置文件将替换所有当前的配置，所以如果您在控制台中设置了变量，并在。yaml或完全删除它们，这将在配置部署后反映在控制台中。</p><p id="8b5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">记住这一点，准备好之后，运行以下命令:</p><pre class="jf jg jh ji fd lr lq ls lt aw lu bi"><span id="106a" class="lv jx hi lq b fi lw lx l ly lz">gcloud run services replace service.yaml</span></pre><h1 id="dc91" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">运行云运行</h1><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mb"><img src="../Images/f088275bfac755117b44bc0d014f5db2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JwVzHahbR396CiWF"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated"><a class="ae jv" href="https://unsplash.com/photos/XnzWWNBqWhM" rel="noopener ugc nofollow" target="_blank"> <em class="ju">来源</em> </a></figcaption></figure><p id="4c13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了新的配置，您现在可以运行应用程序了。您的请求将采用以下格式:</p><pre class="jf jg jh ji fd lr lq ls lt aw lu bi"><span id="091c" class="lv jx hi lq b fi lw lx l ly lz"><a class="ae jv" rel="noopener ugc nofollow" target="_blank" href="/[your-run-app/session?product=[product]">https://[your-run-app/session?product=[product]</a></span></pre><p id="3abd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，为蓝色袜子模式创建结帐会话的请求可能如下所示:</p><pre class="jf jg jh ji fd lr lq ls lt aw lu bi"><span id="350a" class="lv jx hi lq b fi lw lx l ly lz"><a class="ae jv" href="https://checkout-a1bcdef98.a.run.app/session?product=blue" rel="noopener ugc nofollow" target="_blank">https://checkout-a1bcdef98.a.run.app/session?product=blue</a></span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/ce6b9f6e5a8ac16ca798d08f2734d012.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*t8yQ8VpmOELIHKQs"/></div></div></figure><h1 id="a667" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">后续步骤</h1><p id="1edc" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">现在，您拥有了一个创建条带检出会话的无服务器后端！接下来，我们将创建店面，这样我们的顾客就可以最终购买我们令人惊叹的袜子图案了！</p><p id="1fd4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是接下来要采取的一些步骤:</p><ul class=""><li id="92e3" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc le lf lg lh bi translated">在他们的<a class="ae jv" href="https://bit.ly/3fm3dEJ" rel="noopener ugc nofollow" target="_blank"> YouTube频道</a>上的<a class="ae jv" href="https://bit.ly/3fpxpih" rel="noopener ugc nofollow" target="_blank">文档</a>中找到关于Checkout和Stripe的更多组件</li><li id="32ea" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">在<a class="ae jv" href="https://bit.ly/2XnV7We" rel="noopener ugc nofollow" target="_blank">文档</a>和<a class="ae jv" href="https://bit.ly/30qyzGe" rel="noopener ugc nofollow" target="_blank">谷歌云开发者YouTube频道</a>上了解更多关于云运行的信息</li><li id="d4a8" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">查看下一篇博文</li><li id="752b" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">查看<a class="ae jv" href="https://bit.ly/33qptv1" rel="noopener ugc nofollow" target="_blank">第一篇博客</a>中所有帖子的链接</li></ul></div></div>    
</body>
</html>