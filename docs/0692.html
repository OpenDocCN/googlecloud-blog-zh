<html>
<head>
<title>Using gcloud and Python Client Library with Google Compute Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Google计算引擎使用gcloud和Python客户端库</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-gcloud-and-python-client-library-with-google-compute-engine-eaf1b19d8099?source=collection_archive---------0-----------------------#2018-07-16">https://medium.com/google-cloud/using-gcloud-and-python-client-library-with-google-compute-engine-eaf1b19d8099?source=collection_archive---------0-----------------------#2018-07-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a705bee53a3cd5e08edec18ec30a2a25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ivFJZZ1S4GuklgKyy-lGww.png"/></div></div></figure><p id="98bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我之前的帖子(<a class="ae jo" rel="noopener" href="/google-cloud/using-gcloud-to-get-google-cloud-platform-data-you-need-c4985b416278">使用gcloud获取你需要的Google云平台数据</a>)中，我们讨论了如何使用gcloud本身和bash脚本来获取你需要的Google云平台数据。尽管这在你想快速完成工作时很有用，但使用更高级的语言，比如Python，会给你带来更大的灵活性、功能性和开发维护的便利性。在这篇文章中，我以两种方式使用Python。首先是在Python脚本中使用gcloud，其次是使用Google提供的Python客户端库。这篇文章中的所有例子和更多例子都可以在https://github.com/shashyajoshi/code-samples的<a class="ae jo" href="https://github.com/shashyajoshi/code-samples" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"/></a>找到</p><h2 id="488a" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">示例1:使用gcloud &amp; Python获取实例标签和元数据</h2><p id="b942" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">在之前的<a class="ae jo" rel="noopener" href="/google-cloud/using-gcloud-to-get-google-cloud-platform-data-you-need-c4985b416278">文章</a>中，我们看到了如何通过bash脚本使用gcloud来获取实例标签和元数据。以下是使用gcloud和Python来获取实例标签和元数据的方法:</p><ul class=""><li id="3c76" class="kp kq hi is b it iu ix iy jb kr jf ks jj kt jn ku kv kw kx bi translated">使用子进程模块执行gcloud命令(可以使用shlex将gcloud命令转换为子进程模块要求的格式)</li><li id="c5d8" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">在变量中获取gcloud返回的JSON格式的数据</li><li id="9b11" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">如你所愿处理数据</li></ul><p id="f9df" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">流程是这样的:</p><ul class=""><li id="afa5" class="kp kq hi is b it iu ix iy jb kr jf ks jj kt jn ku kv kw kx bi translated">获取所有项目的列表</li><li id="832f" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">使用单个项目id来获取实例列表和其他详细信息</li><li id="eb45" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">使用JSON结构解析必需的字段(例如，<code class="du ld le lf lg b">instance_row[“name”], instance_row[“labels”][“app-name”]</code>等等)。实例元数据是一个嵌套字段，因此需要进一步处理)</li><li id="6ccb" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">在我的例子中，我获取了所有的数据，并将其添加到一个列表中，以便稍后打印到stdout。</li></ul><p id="7252" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">完整的示例脚本如下:<br/><a class="ae jo" href="https://github.com/shashyajoshi/code-samples/blob/master/gcloud-python/get_instance_data_gcloud.py" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">code-samples/g cloud-python/get _ instance _ data _ g cloud . py</strong></a></p><h2 id="dee2" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">示例2:使用Python客户端库获取实例标签和元数据</h2><p id="7c3a" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">与使用gcloud相比，在使用Python客户端库时，您将意识到的关键问题是，gcloud会为您做很多繁重的工作。所以当你使用客户端库时，你有更多的事情要考虑和自己做。以下是我使用Python客户端库的方法:</p><ul class=""><li id="3ee8" class="kp kq hi is b it iu ix iy jb kr jf ks jj kt jn ku kv kw kx bi translated">使用应用程序默认凭据</li><li id="7dc5" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">执行一组API调用来获取数据</li><li id="65b6" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">根据需要处理JSON格式的输出</li></ul><p id="e89c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">流程如下:</p><ul class=""><li id="6c96" class="kp kq hi is b it iu ix iy jb kr jf ks jj kt jn ku kv kw kx bi translated">使用<code class="du ld le lf lg b"><a class="ae jo" href="https://developers.google.com/resources/api-libraries/documentation/cloudbilling/v1/python/latest/cloudbilling_v1.billingAccounts.html#list" rel="noopener ugc nofollow" target="_blank">Cloud Billing API . billingAccounts . list</a></code>获得账单账户(为了使用API获得项目列表，您需要首先获得账单ID)。如果您知道帐单帐户，您可以跳过这一步，将其作为命令行参数传递。</li><li id="072f" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">使用<code class="du ld le lf lg b"><a class="ae jo" href="https://developers.google.com/resources/api-libraries/documentation/cloudbilling/v1/python/latest/cloudbilling_v1.billingAccounts.projects.html#list" rel="noopener ugc nofollow" target="_blank">Cloud Billing API . billingAccounts . projects . list</a></code>获取账单ID的所有项目列表</li><li id="2cc1" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">为了获得每个项目的实例数据，首先需要使用<code class="du ld le lf lg b"><a class="ae jo" href="https://developers.google.com/resources/api-libraries/documentation/compute/v1/python/latest/compute_v1.zones.html#list" rel="noopener ugc nofollow" target="_blank">Compute Engine API . zones . list</a></code>获得<em class="lh">区域</em></li><li id="98b3" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">使用<code class="du ld le lf lg b"><a class="ae jo" href="https://developers.google.com/resources/api-libraries/documentation/compute/v1/python/latest/compute_v1.instances.html#list" rel="noopener ugc nofollow" target="_blank">Compute Engine API . instances . list</a></code>获取每个区域的实例细节</li><li id="1e77" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">对于每个包含实例的区域，使用JSON结构解析必需的字段(例如，<code class="du ld le lf lg b">instance_row[“name”], instance_row[“labels”][“app-name”]</code>等等)。实例元数据是一个嵌套字段，因此需要进一步处理)</li><li id="a232" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">在我的例子中，我获取了所有的数据，并将其添加到一个列表中，以便打印到stdout</li></ul><p id="98ab" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">完整的示例脚本如下:<br/><a class="ae jo" href="https://github.com/shashyajoshi/code-samples/blob/master/python-client-library/get_instance_data_api.py" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">code-samples/python-client-library/get _ instance _ data _ API . py</strong></a>输出与上面的示例1完全相同。</p><h1 id="ed31" class="li jq hi bd jr lj lk ll jv lm ln lo jz lp lq lr kc ls lt lu kf lv lw lx ki ly bi translated">将所学应用到其他用例中</h1><p id="8987" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">现在有了这些知识，您可以自动化不同的操作。您可以采用的方法如下:</p><ul class=""><li id="3733" class="kp kq hi is b it iu ix iy jb kr jf ks jj kt jn ku kv kw kx bi translated">研究您的用例所需的<a class="ae jo" href="https://cloud.google.com/sdk/gcloud/reference/" rel="noopener ugc nofollow" target="_blank"> gcloud文档</a>或<a class="ae jo" href="https://developers.google.com/api-client-library/python/apis/" rel="noopener ugc nofollow" target="_blank"> API文档</a></li><li id="2243" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">首先了解先决条件/必填字段并对其进行研究</li><li id="c140" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">理解输出结构，以便根据需要处理输出</li></ul><p id="7c49" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们再看几个例子:</p><h2 id="27ab" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">示例3:基于标签值的启动/停止实例</h2><p id="5f1a" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">您可能希望基于标签启动和停止一组实例。您可能有一堆开发环境，希望在每个工作日结束时或长周末前关闭。流程类似于前面的示例:</p><ul class=""><li id="e10d" class="kp kq hi is b it iu ix iy jb kr jf ks jj kt jn ku kv kw kx bi translated">获取项目列表</li><li id="6f73" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">获取实例列表，并检查标签键/值是否与所需值匹配</li><li id="84e0" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">如果匹配，对实例执行操作(启动或停止)(实例操作命令也需要实例区域，因此您需要从实例数据输出中捕获它)</li></ul><p id="a8ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">完整的示例脚本可在此处获得:<br/><a class="ae jo" href="https://github.com/shashyajoshi/code-samples/blob/master/gcloud-python/start_stop_instances_labels_gcloud.py" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">code-samples/g cloud-python/start _ stop _ instances _ labels _ g cloud . py</strong></a><br/>下面给出了<code class="du ld le lf lg b">label_key=”env-name”</code>、<code class="du ld le lf lg b">label_value=”non-prod”</code>和<code class="du ld le lf lg b">instance_action= stop</code>的示例脚本输出</p><figure class="lz ma mb mc fd ij"><div class="bz dy l di"><div class="md me l"/></div></figure><h2 id="aadd" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">示例4:根据标签删除未连接的磁盘</h2><p id="2e0d" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">在上一篇文章中，您看到了如何找出孤立或未连接的磁盘。与实例类似，您可以向永久磁盘添加标签。例如，您可以为重要磁盘添加删除保护标签。</p><p id="19b6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该流程类似于前面的示例:</p><ul class=""><li id="f94b" class="kp kq hi is b it iu ix iy jb kr jf ks jj kt jn ku kv kw kx bi translated">获取项目列表</li><li id="bf24" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">获取磁盘列表，并检查它是否连接到任何实例</li><li id="984a" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">如果不匹配，请检查标签键/值是否与所需值匹配</li><li id="5816" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">如果匹配，在磁盘上执行操作(删除)(磁盘操作命令也需要磁盘区域，因此您需要从磁盘数据输出中捕获它)</li></ul><p id="ef59" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">完整的示例脚本如下:<br/><a class="ae jo" href="https://github.com/shashyajoshi/code-samples/blob/master/gcloud-python/delete_unattached_disks_gcloud.py" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">code-samples/g cloud-python/delete _ unattached _ disks _ g cloud . py</strong></a><br/>下面给出了<code class="du ld le lf lg b">label_key=”delete-protect”</code>和<code class="du ld le lf lg b">label_value=”no”</code>的脚本输出示例</p><figure class="lz ma mb mc fd ij"><div class="bz dy l di"><div class="md me l"/></div></figure><h2 id="667c" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">免责声明和其他要点</h2><ul class=""><li id="e37f" class="kp kq hi is b it kk ix kl jb mf jf mg jj mh jn ku kv kw kx bi translated">这里的例子可能无法在您的环境中正常工作。例如，此处使用的标签关键字和值应根据您的标签策略进行更改。我的建议是先阅读和理解代码，然后修改它以适应您的环境。</li><li id="084c" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">完整性—提供示例脚本作为使用gcloud和Python客户端库的示例。它们本身绝不是完整的解决方案。</li><li id="c97f" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">编码最佳实践—在实际部署中，您应该考虑编码最佳实践，例如，错误检查/处理、检查和等待操作完成的功能、记录/打印有意义的消息等。</li></ul><h1 id="c6da" class="li jq hi bd jr lj lk ll jv lm ln lo jz lp lq lr kc ls lt lu kf lv lw lx ki ly bi translated">参考资料和进一步阅读</h1><p id="7607" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">这些只是使用gcloud和Python客户端库从Google云平台获取数据或基于数据执行特定操作的许多可能方式中的几种。我希望这些例子能为你提供一个高层次的想法。有关更多详细信息，请参考以下链接:</p><ul class=""><li id="f6f4" class="kp kq hi is b it iu ix iy jb kr jf ks jj kt jn ku kv kw kx bi translated"><a class="ae jo" href="https://developers.google.com/api-client-library/python/apis/" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/API-client-library/python/API/</a></li><li id="f027" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated">【https://github.com/GoogleCloudPlatform/python-docs-samples T2】号</li><li id="fa99" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated"><a class="ae jo" href="https://cloud.google.com/compute/docs/tutorials/python-guide" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/compute/docs/tutorials/python-guide</a></li><li id="bee6" class="kp kq hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated"><a class="ae jo" href="https://cloud.google.com/sdk/gcloud/reference/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/sdk/gcloud/reference/</a></li></ul><p id="06e8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请告诉我您的想法，以及如何在您的环境中使用gcloud和Python客户端库。</p><p id="9f17" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">(声明:此处表达的观点为本人观点。信息按“原样”提供。)</p></div></div>    
</body>
</html>