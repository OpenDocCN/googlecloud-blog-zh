<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://medium.com/google-cloud/visualize-gcp-billing-using-bigquery-and-data-studio-d3e695f90c08?source=collection_archive---------0-----------------------#2017-06-01">https://medium.com/google-cloud/visualize-gcp-billing-using-bigquery-and-data-studio-d3e695f90c08?source=collection_archive---------0-----------------------#2017-06-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><p id="40b1" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated"><em class="if">合著者</em> <a class="ae ig" rel="noopener" href="/@theryanmcdowell"> <em class="if">瑞安·麦克道尔</em> </a> <em class="if">，谷歌研究员兼数据分析忍者</em></p><h1 id="d65d" class="ih ii hi bd ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je bi translated">使用BigQuery和Data Studio可视化GCP计费</h1><p id="b095" class="pw-post-body-paragraph hg hh hi hj b hk jf hm hn ho jg hq hr hs jh hu hv hw ji hy hz ia jj ic id ie hb bi translated">我们从客户那里收到的最常见的问题之一是“我如何才能看到我随着时间的推移花费了什么”，直到最近，你唯一的选择是谷歌云控制台中的<a class="ae ig" href="https://console.cloud.google.com/billing" rel="noopener ugc nofollow" target="_blank">账单标签</a>。</p><p id="acac" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">但现在，通过将谷歌云的<a class="ae ig" href="https://support.google.com/cloud/answer/7233314?hl=en" rel="noopener ugc nofollow" target="_blank">计费-导出-大查询</a>功能与<a class="ae ig" href="http://datastudio.google.com" rel="noopener ugc nofollow" target="_blank">谷歌数据工作室</a>相结合，你不仅可以获得全天的最新计费图表，还可以根据你如何组织你的业务和/或应用程序，使用标签来分割你的GCP账单。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/9333bbe600776e566624bbbb7d1f925b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FenQMjgTYAFH_89U."/></div></div></figure><p id="5388" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">如果这看起来像是你感兴趣的东西，请务必继续阅读下面的内容，因为我会带你大致了解如何设置这些东西…</p><p id="59a1" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated"><strong class="hj jw">剧透提示:</strong>如果您真的对手工制作这份报告不感兴趣，请直接跳到底部，我们已经有了一份预建的报告，您只需复制一份，指向您的账单数据(您仍需要导出到BQ)，它就会为您开箱即用。很酷，对吧？</p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><h1 id="04aa" class="ih ii hi bd ij ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je bi translated">启用计费导出到BigQuery</h1><p id="45cb" class="pw-post-body-paragraph hg hh hi hj b hk jf hm hn ho jg hq hr hs jh hu hv hw ji hy hz ia jj ic id ie hb bi translated">我们需要做的第一件事是将您的账单数据导出到BigQuery数据集中。这将允许我们使用数据集作为用于构建上述计费报告的图表和查询的基础。</p><p id="21d3" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">不过，在您开始之前，请记住，导出您的账单数据需要GCP的账单管理权限。因此，检查以确保您已经获得了进行这些更改的权限，或者与您组织中拥有权限的人合作。否则，我们不会走得很远…</p><p id="e5de" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">好了，解决了这个问题之后，让我们前往Google Cloud帮助中心，开始这里的设置说明:<a class="ae ig" href="https://support.google.com/cloud/answer/7233314?hl=en" rel="noopener ugc nofollow" target="_blank">将账单数据导出到BigQuery </a></p><p id="68b2" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">完成这些步骤后，大约需要一天时间(但有时会更短)就可以看到数据集开始填充账单数据。GCP服务是分开计费的，所以不要期望所有的东西都在同一时间出现。您可能会首先看到一些网络出口，然后是一些虚拟机费用，然后是PubSub使用等。耐心点，它很快就会进入你的身体！</p><p id="5e4f" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">一旦你的数据集中有了数据，你就可以对它进行有趣的查询，就像这样:</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kj"><img src="../Images/951c13538a47e1e9705e63d582181190.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LKG1Ma4neAec7B2J."/></div></div></figure><p id="73cc" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated"><strong class="hj jw">重要提示:</strong>您的BigQuery数据集将仅反映从您设置计费-导出、转发之日起发生的计费。计费数据不会追溯添加，因此您不应该期望在导出之前看到计费数据。我们强烈建议新客户尽早启用BigQuery计费导出功能，以便他们能够访问尽可能多的计费数据进行分析…</p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><h1 id="3be6" class="ih ii hi bd ij ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je bi translated">开始使用概览视图</h1><p id="c687" class="pw-post-body-paragraph hg hh hi hj b hk jf hm hn ho jg hq hr hs jh hu hv hw ji hy hz ia jj ic id ie hb bi translated">当我打开一个报告时，我通常希望看到的第一件事是事物的高级状态。给我一个系统的当前快照，让我从那里深入挖掘。因此，在我们账单报告的第一页，我们先来回答一些最常见的问题:</p><ul class=""><li id="bbf4" class="kk kl hi hj b hk hl ho hp hs km hw kn ia ko ie kp kq kr ks bi translated">我今天花了多少钱？</li><li id="2362" class="kk kl hi hj b hk kt ho ku hs kv hw kw ia kx ie kp kq kr ks bi translated">这个月到目前为止我花了多少钱？</li><li id="2fec" class="kk kl hi hj b hk kt ho ku hs kv hw kw ia kx ie kp kq kr ks bi translated">我今年迄今的支出情况如何？</li></ul><p id="228d" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">此外，作为额外奖励，让我们按服务细分每日和每月支出。这样，我们可以看到任何特定服务的支出是否超出了预期水平。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/cc51fc47b104e1618a71dd2bee5c8d2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*J4w1MOWa7d3Hdo1k."/></div></div></figure></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><h1 id="2a15" class="ih ii hi bd ij ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je bi translated">按标签切片和切块</h1><p id="3039" class="pw-post-body-paragraph hg hh hi hj b hk jf hm hn ho jg hq hr hs jh hu hv hw ji hy hz ia jj ic id ie hb bi translated">我们从客户那里听到的一个非常常见的问题是“我如何查看我的账单并知道X服务的花费？”或者类似地，“相对于生产环境，我在开发环境上花费了多少？”</p><p id="f86d" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">通过给你的谷歌云资源贴上<a class="ae ig" href="https://cloud.google.com/resource-manager/docs/using-labels" rel="noopener ugc nofollow" target="_blank">标签</a>，回答这些问题会变得容易得多。标签是帮助你在GCP组织和管理事物的键/值对，在计费时它们非常有用。标签的常见用途包括:</p><ul class=""><li id="93e8" class="kk kl hi hj b hk hl ho hp hs km hw kn ia ko ie kp kq kr ks bi translated"><strong class="hj jw">基于团队或成本中心的标签。</strong>添加基于团队或成本中心的标签，以区分不同团队所拥有的项目。这可以用于成本会计或预算。比如<em class="if">团队:营销</em>和<em class="if">团队:调研</em>。</li><li id="b5af" class="kk kl hi hj b hk kt ho ku hs kv hw kw ia kx ie kp kq kr ks bi translated"><strong class="hj jw">基于组件的标签。</strong>比如<em class="if">组件:redis </em>和<em class="if">组件:前端</em>。</li><li id="5b23" class="kk kl hi hj b hk kt ho ku hs kv hw kw ia kx ie kp kq kr ks bi translated"><strong class="hj jw">基于环境或阶段的标签。</strong>比如<em class="if">环境:生产</em>和<em class="if">环境:测试</em>。</li></ul><p id="70e7" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">正如您将在我们的示例报告和数据集中看到的，我们有一个“服务”标签，用于组织不同应用程序的资源(非常类似于上面描述的“组件”标签)。有了这个标签，资源计费页面上的过滤器将允许我们划分任何单个服务、所有服务或它们的任意组合的成本。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ky"><img src="../Images/a5a0c7b5a14f9f6fe05e4347b160219e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NZeUTb6fkJHrEDuC."/></div></div></figure><p id="14e2" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">现在，即使你只是以上述三种方式使用标签，你也有能力回答各种有趣的问题。某项服务每月的费用是多少？GCP的营销支出是多少？研究团队的开发环境成本是多少？所有关于您的企业如何在谷歌云上花钱的非常有用的见解…</p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><h1 id="663e" class="ih ii hi bd ij ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je bi translated">分析您的BigQuery用法</h1><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/dc6d7761e226a2b330e29a5d8997639e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*M_Bte_Ys95TPn5qF."/></div></div></figure><p id="194c" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">无论您是使用BigQuery的灵活按需定价还是统一定价，深入了解高成本查询对于优化成本和工作负载性能至关重要。</p><p id="7cb6" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">要开始对BigQuery数据进行分析，我们首先需要从Stackdriver导出数据访问日志。数据访问日志是对BigQuery中运行的每个查询及其扫描的总字节数的全面审核。这些日志可用于将昂贵的查询追溯到运行它们的用户。要创建导出，请导航到云控制台中的Stackdriver日志。使用resource: BigQuery和logName: data_access过滤器过滤日志。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/d750caddc78c10bc5dd7fe9abbf83eba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bxwsgrTL1X7H5egu."/></div></div></figure><p id="a328" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">将data_access日志导出到BigQuery后，您可以创建一个视图，清除一些冗长的名称，只包含与报告相关的列。<a class="ae ig" href="https://bigquery.cloud.google.com/savedquery/631705076856:f5011ca32fd442e692884f08a5cf73da" rel="noopener ugc nofollow" target="_blank">这个保存的查询</a>是一些示例SQL，它计算每个查询的总成本并为报告创建友好的名称。在BigQuery中创建视图后，您就可以开始搜寻那些昂贵的用户了。只需在DataStudio的视图上创建一个数据源就可以了。</p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><h1 id="350c" class="ih ii hi bd ij ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je bi translated">分析其他GCP服务的使用情况</h1><p id="c3fa" class="pw-post-body-paragraph hg hh hi hj b hk jf hm hn ho jg hq hr hs jh hu hv hw ji hy hz ia jj ic id ie hb bi translated">除了允许您查看特定于BQ的使用和计费条目(以及哪些用户正在运行昂贵的查询)的BigQuery页面，我们还为许多其他受欢迎的GCP服务添加了示例页面。使用这些专门构建的页面，您可以快速回答诸如“我在X服务上花了多少钱？”。</p><p id="23e2" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">请随意按原样使用这些示例页面和查询，或者扩展它们来回答特定于您独特业务的计费问题…</p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><h1 id="3133" class="ih ii hi bd ij ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je bi translated">预测未来</h1><p id="72a1" class="pw-post-body-paragraph hg hh hi hj b hk jf hm hn ho jg hq hr hs jh hu hv hw ji hy hz ia jj ic id ie hb bi translated">现在，您已经了解了跨产品和已标记资源的当前支出，并且可以关注BigQuery支出。这本身就非常强大，但如果你能看到你的谷歌云支出在不久的将来可能会是多少，如果事情继续发展下去，这难道不是一个额外的特别奖励吗？</p><p id="e2c7" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">一旦您将账单数据导出到BigQuery数据集几个月后，您将有足够的历史来回顾、应用一些有趣的统计分析，并使用线性回归来帮助预测未来的账单！</p><p id="1b3b" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">我们的两个同事(维克和伊恩)在2017年的NEXT 给<a class="ae ig" href="https://www.youtube.com/watch?v=qL8kvTb4RbU" rel="noopener ugc nofollow" target="_blank">做了一个精彩的演讲，都是关于计费的，他们把最好的留到了最后。跳到24:40，Ian将带您建立一个定制的数据源，它使用一些漂亮的SQL来做未来的数学计算…</a></p><p id="36c9" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">我们的示例报表内置了这种预测未来的功能，但是一旦您将它复制并指向您的BigQuery数据集，您将需要进行一些修改。大多数情况下，您需要编辑自定义SQL，并用您的名称替换我们的数据集名称…</p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><h1 id="ce69" class="ih ii hi bd ij ik ke im in io kf iq ir is kg iu iv iw kh iy iz ja ki jc jd je bi translated">不要重新发明轮子——使用并扩展我们的样本</h1><p id="8765" class="pw-post-body-paragraph hg hh hi hj b hk jf hm hn ho jg hq hr hs jh hu hv hw ji hy hz ia jj ic id ie hb bi translated">正如所承诺的，你在上面看到和读到的一切都是免费的，你可以复制和使用。全球可读报告最后一页的详细说明如下:</p><p id="569d" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated"><a class="ae ig" href="https://datastudio.google.com/open/0B7GT7ZlyzUmCZHFhNDlKVENHYmc" rel="noopener ugc nofollow" target="_blank">https://data studio . Google . com/open/0b 7 gt 7 zlyzumczhfhnndlkvenhymc</a></p><p id="c274" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated"><strong class="hj jw"> <em class="if">注:</em> </strong> <em class="if">截至2017年10月10日，export-to-BigQuery模式略有改动(beta产品，amiright？！).虽然Data Studio报告和数据源都已针对新模式进行了更新，但过去的数据可能需要一段时间才能融入新的数据集，并且一些页面可能不会像以前那样向后看(我在看您，支出趋势)。</em></p><p id="beca" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">你想在这里贡献另一个很酷的图表/报告吗？在评论中发布一个链接和描述(记得设置权限为全球可见！)，如果适合样品，我们会联系您…</p></div></div>    
</body>
</html>