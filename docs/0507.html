<html>
<head>
<title>Running Neo4j with Hosted Kubernetes in Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google Cloud中使用托管的Kubernetes运行Neo4j</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/running-neo4j-with-hosted-kubernetes-in-google-cloud-b479e87b74c0?source=collection_archive---------1-----------------------#2018-01-30">https://medium.com/google-cloud/running-neo4j-with-hosted-kubernetes-in-google-cloud-b479e87b74c0?source=collection_archive---------1-----------------------#2018-01-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b497" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">更新</strong>:自从这篇文章最初被写出来，Google在GCP市场上发布了Kubernetes应用程序。如果你对点击式方法特别感兴趣，<a class="ae jd" rel="noopener" href="/@david.allen_3172/launching-neo4j-on-googles-kubernetes-marketplace-97c23c94e960">请看看我的另一篇关于如何启动那个</a>的帖子。这篇文章仍然包含准确的信息，但重点是基于头盔的部署。</p><h1 id="eb8b" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">介绍</h1><p id="85aa" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">自从Neo4j发布了<a class="ae jd" href="https://hub.docker.com/_/neo4j/" rel="noopener ugc nofollow" target="_blank"> docker images </a>之后，对于如何部署它有了大量的选择。因为neo4j可以作为集群数据库运行，所以使用容器编排工具是有帮助的，比如docker-compose这样的轻量级工具，或者kubernetes这样更健壮的工具。</p><p id="3a91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Kubernetes是一个开源平台，用于跨主机集群自动部署、扩展和操作容器。所以本质上，它只是那种在维护从docker容器派生的neo4j实例集群时有用的工具。谷歌的GCP提供了一个<a class="ae jd" href="https://cloud.google.com/kubernetes-engine/" rel="noopener ugc nofollow" target="_blank">托管的kubernetes引擎选项</a>，所以建立一个Kubernetes集群并向其部署应用程序是非常容易的，这就是我们今天要做的。</p><h1 id="b257" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">先决条件</h1><p id="1e8e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">gcloud实用程序是一套允许命令行与谷歌云交互的软件。它相当于亚马逊的aws包装实用程序。</p><p id="9a92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你会需要它，<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/" rel="noopener ugc nofollow" target="_blank">所以先去那个页面安装它</a>！</p><p id="4274" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还需要一个名为kubectl的实用程序来控制kubernetes集群，您可以从kubernetes页面获得这个实用程序，它适用于几乎任何操作系统。</p><h1 id="d2c0" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">在GCP上创建托管的Kubernetes集群</h1><p id="8f86" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在google cloud控制台中，转到Kubernetes集群页面，导航方式如下:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/5fcc91335a76d5a04a7c05662687414b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/0*ZGLTKWCJT5UytsnR."/></div></figure><p id="30dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将配置一个kubernetes集群，在本例中只有一个节点(“Size”参数)，因为我们不需要为这个测试实例提供太多额外的容量。请记住，成本与您需要的节点数量和提供给它们的资源成比例。但这是一个关键的设置；在本教程的后面部分，我们将在单个节点上部署3个neo4j pods。显然，这只是出于演示目的，因为这种类型的部署拓扑在生产环境中没有意义，在生产环境中，如果任何一个节点出现故障，您都需要节点中的冗余来保持集群运行。</p><p id="c0c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置新群集有许多选项；出于我们的目的，我采用了大部分默认设置，并点击底部的“创建”,但是当然可以从Google获得完整的文档。</p><p id="26b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">确保您的集群至少有3个节点</strong>。在部署因果集群时，我们将向kubernetes集群部署至少3个不同的容器。(或者更多，如果您最终添加了读取副本)</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es kp"><img src="../Images/47221afac09328053e2204723672605a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dqSklesWHRFN64Aa."/></div></div></figure><p id="5393" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">集群启动后，您应该会看到如下所示的屏幕，这让我们知道一切正常:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es ku"><img src="../Images/c583888bfc40ef4ca49cd504294bb214.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1iSLhqwTIGiNtV7g."/></div></div></figure><h1 id="f260" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">连接到集群</h1><p id="2338" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在，我们只需点击“Connect”按钮，google就会给我们一些命令，我们可以使用这些命令来执行我们的主机操作系统和kubectl程序，以便控制和部署到这个kubernetes集群。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es kv"><img src="../Images/15fa84582cf236420057f959ee43b898.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5oAzrL0eGj-yxcaVLPMO1Q.png"/></div></div></figure><p id="a80f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kw"> kubectl proxy </em>命令设置了一个本地HTTP代理，这样你就可以和你的google集群对话，就像它是本地的一样，运行在你的机器上。</p><p id="0f2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下步骤将假设您执行了这个<em class="kw"> gcloud </em>命令和<em class="kw"> kubectl代理</em>命令。</p><h1 id="cdaa" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">将Neo4j部署到集群</h1><p id="3c9f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">接下来，我们需要将neo4j配置应用到我们的kubernetes集群。Kubernetes在YAML文件中这样做。</p><p id="72ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">幸运的是，通过<a class="ae jd" href="https://github.com/neo4j-contrib/kubernetes-neo4j" rel="noopener ugc nofollow" target="_blank"> kubernetes-neo4j回购</a>，我们有了可以应用的基本默认值。除了这些代码，neo4j的网站上还有一篇文章<a class="ae jd" href="https://neo4j.com/blog/kubernetes-deploy-neo4j-clusters/" rel="noopener ugc nofollow" target="_blank">描述了如何部署到本地运行的kubernetes】。</a></p><p id="c57c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不过，开门见山地说，这些命令是必要的:</p><pre class="ki kj kk kl fd kx ky kz la aw lb bi"><span id="1f8b" class="lc jf hi ky b fi ld le l lf lg">$ git clone <a class="ae jd" href="https://github.com/neo4j-contrib/kubernetes-neo4j.git" rel="noopener ugc nofollow" target="_blank">https://github.com/neo4j-contrib/kubernetes-neo4j.git</a><br/>$ cd kubernetes-neo4j<br/>$ kubectl apply -f cores<br/>service “neo4j” created<br/>statefulset “neo4j-core” created</span></pre><p id="8c60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个git repo提供了一组脚本，其中包含了部署neo4j集群所需的一切。这里的kubectl命令简单地应用了开箱即用的配置，这是一组有状态的3个核心节点，它们可以发现彼此和一个DNS服务。</p><p id="af9f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启动一两分钟后，在您的本地主机上，您应该能够看到您的部署。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es lh"><img src="../Images/ddcdabf7201c09238716ba818f60076e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RtPtGxaIuJ31GG8UZunwgA.png"/></div></div></figure><h1 id="1cb8" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">验证事情看起来不错</h1><p id="989c" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">您可以查看日志以确保各种pod运行正常。</p><pre class="ki kj kk kl fd kx ky kz la aw lb bi"><span id="0f41" class="lc jf hi ky b fi ld le l lf lg">$ kubectl logs -f neo4j-core-0<br/>(lots of output snipped)</span><span id="45f4" class="lc jf hi ky b fi li le l lf lg">2017-12-21 20:46:46.209+0000 INFO  Discovering cluster with initial members: [neo4j.default.svc.cluster.local:5000]<br/>2017-12-21 20:46:46.209+0000 INFO  Attempting to connect to the other cluster members before continuing...<br/>2017-12-21 20:47:48.650+0000 INFO  Started.<br/>2017-12-21 20:47:49.448+0000 INFO  Mounted REST API at: /db/manage<br/>2017-12-21 20:47:51.857+0000 INFO  Remote interface available at http://neo4j-core-0.neo4j.default.svc.cluster.local:7474/</span></pre><p id="d8d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看起来不错！</p><h1 id="0ea6" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">按需扩展</h1><p id="7c5d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">从这里开始，您可以<a class="ae jd" href="https://github.com/neo4j-contrib/kubernetes-neo4j" rel="noopener ugc nofollow" target="_blank">按照github存储库</a>上的说明，通过添加读取副本或添加新节点来扩展您的集群。大部分工作可以通过应用github repo提供的其他模板来完成。</p><h1 id="9bf3" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">这一切是如何运作的？</h1><p id="ce83" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">kubernetes配置只是一组环境变量和一些包装在官方neo4j docker映像周围的shell脚本。您可以在<a class="ae jd" href="https://github.com/neo4j-contrib/kubernetes-neo4j/blob/master/cores/statefulset.yaml" rel="noopener ugc nofollow" target="_blank"> statefulset.yaml </a>文件中看到该配置。特定于kubernetes的位处理节点如何发现彼此的细节，以及默认集群的拓扑是什么(在本例中是3个核心节点)。neo4j docker映像本身已经提供了许多配置项，比如能够通过环境变量将一系列配置选项直接传递给数据库。</p><h1 id="1604" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">用它！</h1><p id="4c61" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">使用kubectl，您已经可以像这样直接对单个pod执行命令。这样做不需要设置任何额外的网络或端口权限。</p><pre class="ki kj kk kl fd kx ky kz la aw lb bi"><span id="1454" class="lc jf hi ky b fi ld le l lf lg">$ kubectl exec neo4j-core-0 -- bin/cypher-shell --format verbose "MATCH (n) RETURN count(n);"</span><span id="b036" class="lc jf hi ky b fi li le l lf lg">+----------+<br/>| count(n) |<br/>+----------+<br/>| 0        |<br/>+----------+</span><span id="6097" class="lc jf hi ky b fi li le l lf lg">1 row available after 374 ms, consumed after another 4 ms</span></pre><h1 id="4fcc" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">从这里去哪里</h1><p id="20cb" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">您需要为位于github repo的cores目录中的neo4j配置和定制部署模板。特别是，在撰写本文时，默认部署指定了一个无集群IP，<a class="ae jd" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">意味着部署是无头的</a>，不能从外部访问。这是一个初始的明智设置，因为为了便于设置，设置还会禁用身份验证。请务必仔细阅读neo4j和kubernetes配置，以确保您知道您将得到什么！</p><p id="038d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些配置选项很重要，对生产性能和安全性有很大影响。请咨询您当地的kubernetes专家，以便做出适合您的部署的选择。</p></div></div>    
</body>
</html>