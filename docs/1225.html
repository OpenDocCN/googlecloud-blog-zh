<html>
<head>
<title>Prevent Key Hotspots in Bigtable After Scale-Up</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">纵向扩展后防止Bigtable中的关键热点</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bigtable-warm-up-after-scale-up-f575ee4deaa2?source=collection_archive---------1-----------------------#2019-12-14">https://medium.com/google-cloud/bigtable-warm-up-after-scale-up-f575ee4deaa2?source=collection_archive---------1-----------------------#2019-12-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="78ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Bigtable是一个稀疏的、分布式的、持久的多维排序映射，由行键、列键和时间戳索引。</p><p id="8ee5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">性能和纵向扩展</strong></p><p id="6006" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在纵向扩展过程中，性能不会线性增加，这是由于多个服务器配置的负载不平衡造成的，而负载不平衡通常是由进程争用CPU和网络造成的。BT再平衡算法需要更多时间来采取行动有两个原因:</p><ul class=""><li id="7235" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">调节再平衡以减少平板电脑*移动的次数</li><li id="70c2" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">随着基准测试的进行，负载会发生变化</li></ul><p id="af4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用这个工具来监控您的<a class="ae jr" href="https://cloud.google.com/bigtable/docs/monitoring-instance" rel="noopener ugc nofollow" target="_blank">集群性能</a>。您还可以使用<a class="ae jr" href="https://cloud.google.com/bigtable/docs/keyvis-getting-started" rel="noopener ugc nofollow" target="_blank">键可视化工具</a>来识别表中可能导致CPU占用率峰值的热点。</p><p id="bb67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更改群集中的节点数量后，可能需要20分钟才能看到群集性能的显著提高，这通常取决于如何扩展群集的大小。</p><ul class=""><li id="a3bb" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">Bigtable通过行键按字典顺序维护数据。表的行范围是动态分区的。每个行范围称为一个<strong class="ih hj">片，是分配和负载平衡的单位</strong>。</li></ul></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><p id="2ad5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Bigtable非常依赖名为Chubby的分布式锁服务，该服务使用Paxos算法在出现故障时保持副本的一致性。Chubby将提供包含目录和小文件的名称空间。每个目录或文件都可以用作锁，这样读写就可以以原子方式执行。Chubby客户端库将提供一致的Chubby文件缓存。</p><p id="bf42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Bigtable使用Chubby执行各种任务:</p><ul class=""><li id="084b" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">确保任何时候最多有一个活动主机；</li><li id="631f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">存储Bigtabledata的引导位置；</li><li id="c066" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">发现平板电脑服务器并最终确定平板电脑服务器死亡；</li><li id="8be4" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">存储Bigtable模式信息(每个表的列族信息)；</li><li id="c483" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">并存储访问控制列表。</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es jz"><img src="../Images/a2530f896cdc491d5825fb9fdf3ef3b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WkZRzwvUkWhIUTvh2uklSw.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated">类似于B+树的平板位置层次结构。</figcaption></figure><p id="0fa1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">平板电脑分配</strong></p><p id="8407" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每台平板电脑一次分配给一台平板电脑服务器。主设备跟踪一组实时平板服务器，以及平板服务器的当前平板分配，包括未分配的平板。当平板电脑未分配，并且平板电脑服务器有足够的空间放置平板电脑时，主设备通过向平板电脑服务器发送平板电脑装载请求来分配平板电脑。Bigtable使用Chubby来跟踪平板电脑服务器。关于平板电脑服务器的每个信息都将作为一个目录存储在Chubby中，包括它的创建时间、it状态等信息。主人会监控这个保存在Chubby里面的目录。</p></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><p id="42ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在纵向扩展集群之后，可以进行一些负载测试，以确保密钥分布在集群中。源代码可以在:<a class="ae jr" href="https://github.com/irvifa/bigtable-load-test" rel="noopener ugc nofollow" target="_blank">https://github.com/irvifa/bigtable-load-test</a>找到。</p><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="4866" class="ku kv hi kq b fi kw kx l ky kz">./main -instance "$BT_INSTANCE" -project "$BT_PROJECT" -scratch_table "$BT_TABLE" -pool_size "$GRPC_POOL" -req_count "$REQ_COUNT" -run_for 0 -key_list "$KEY_LIST_FILE_PATH"</span></pre><p id="dd52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以将行键列表存储在一个文件中，并将其作为参数传递。</p><p id="f460" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想使用部署来负载测试您的Bigtable集群，下面是这样做的示例代码:</p><ul class=""><li id="f1e8" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">建立并推广您的Dockerimage:</li></ul><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="5c3b" class="ku kv hi kq b fi kw kx l ky kz"><strong class="kq hj">➜  bigtable-load-test</strong> <strong class="kq hj">git:(master)</strong> cat Dockerfile</span><span id="54ce" class="ku kv hi kq b fi la kx l ky kz">FROM golang:alpine AS builder</span><span id="c1c2" class="ku kv hi kq b fi la kx l ky kz"># Git is required for fetching the dependencies.</span><span id="5085" class="ku kv hi kq b fi la kx l ky kz">RUN apk update &amp;&amp; apk add --no-cache git bash</span><span id="5cc0" class="ku kv hi kq b fi la kx l ky kz">COPY . .</span><span id="c445" class="ku kv hi kq b fi la kx l ky kz">RUN go get -d -v</span><span id="93c8" class="ku kv hi kq b fi la kx l ky kz">RUN go build -ldflags="-w -s" -o /go/bin/main</span><span id="6ff8" class="ku kv hi kq b fi la kx l ky kz">CMD ["/bin/bash", "-c", "./run.sh"]<br/><strong class="kq hj">➜  bigtable-load-test</strong> <strong class="kq hj">git:(master) </strong>make docker_build \</span><span id="badc" class="ku kv hi kq b fi la kx l ky kz">IMAGE_NAME=&lt;your-image-name&gt; IMAGE_TAG=&lt;your-image-tag&gt;</span><span id="3aa6" class="ku kv hi kq b fi la kx l ky kz"><strong class="kq hj">➜  bigtable-load-test</strong> <strong class="kq hj">git:(master) </strong>make docker_push \</span><span id="21ef" class="ku kv hi kq b fi la kx l ky kz">IMAGE_NAME=&lt;your-image-name&gt; IMAGE_TAG=&lt;your-image-tag&gt;</span></pre><ul class=""><li id="e223" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">配置映射:</li></ul><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="e203" class="ku kv hi kq b fi kw kx l ky kz">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: bt-load-test<br/>  namespace: load-test<br/>data:<br/>  BT_INSTANCE: # your bigtable's instance id<br/>  BT_TABLE: # your bigtable's table name<br/>  BT_PROJECT: # your bigtable's project id<br/>  GRPC_POOL: "10"<br/>  REQ_COUNT: "2000"</span></pre><ul class=""><li id="2841" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">部署:</li></ul><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="e0f1" class="ku kv hi kq b fi kw kx l ky kz">apiVersion: apps/v1<em class="lb"><br/></em>kind: Deployment<br/>metadata:<br/>  name: bt-load-test<br/>  namespace: load-test<br/>  labels:<br/>    name: bt-load-test<br/>    role: worker<br/>spec:<br/>  replicas: 15<br/>  selector:<br/>    matchLabels:<br/>      name: bt-load-test<br/>      role: worker<br/>  template:<br/>    metadata:<br/>      labels:<br/>        name: bt-load-test<br/>        role: worker<br/>    spec:<br/>      containers:<br/>        - name: bt-load-test<br/>          image: # your bt-load-test image<em class="lb"><br/>          </em>env:<br/>            - name: "GOOGLE_APPLICATION_CREDENTIALS"<br/>              value: # where is your service account's path<br/>          envFrom:<br/>            - configMapRef:<br/>                name: bt-load-test<br/>          volumeMounts:<br/>            - name: "service-account"<br/>              mountPath: # where you mount your service account<br/>      volumes:<br/>        - name: "service-account"<br/>          secret:<br/>            secretName: # where you save your service account</span></pre><p id="4a20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一件需要理解的事情是阅读你的钥匙的<a class="ae jr" href="https://cloud.google.com/bigtable/docs/keyvis-patterns" rel="noopener ugc nofollow" target="_blank">热图模式。</a></p><p id="9640" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">参考文献:</strong></p><ol class=""><li id="c6bb" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc lc jj jk jl bi translated">Bigtable:一个用于结构化数据的分布式存储系统。</li><li id="6501" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc lc jj jk jl bi translated"><a class="ae jr" href="https://cloud.google.com/bigtable/docs/monitoring-instance" rel="noopener ugc nofollow" target="_blank">监控云Bigtable实例</a></li><li id="06a3" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc lc jj jk jl bi translated"><a class="ae jr" href="https://cloud.google.com/bigtable/docs/performance" rel="noopener ugc nofollow" target="_blank">了解云Bigtable性能</a></li><li id="deeb" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc lc jj jk jl bi translated"><a class="ae jr" href="https://cloud.google.com/bigtable/docs/keyvis-patterns" rel="noopener ugc nofollow" target="_blank">热图模式</a></li></ol></div></div>    
</body>
</html>