<html>
<head>
<title>How to implement CI/CD Pipeline with Google Cloud Deploy &amp; Gitlab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Google Cloud Deploy &amp; Gitlab实现CI/CD管道</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-implement-ci-cd-pipeline-with-google-cloud-deploy-gitlab-2b751f47c946?source=collection_archive---------0-----------------------#2021-11-13">https://medium.com/google-cloud/how-to-implement-ci-cd-pipeline-with-google-cloud-deploy-gitlab-2b751f47c946?source=collection_archive---------0-----------------------#2021-11-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/04eb89a82a4893577431922bda251e89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*h7K1pG0bbR7Anyw439rfCw.png"/></div></figure><h1 id="bd6b" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated"><strong class="ak">TL；博士</strong></h1><p id="1c93" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">Google Cloud Deploy是GCP CI/CD服务的新成员。现在，我们可以只通过谷歌云的服务建立一个可靠而持久的CI/CD渠道。让我们来了解一下如何用Google Cloud Deploy &amp; GitLab实现CI/CD管道！</p></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><h1 id="9ab7" class="im in hi bd io ip kp ir is it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj bi translated">Google Cloud Deploy？</h1><p id="0db6" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">Google Cloud Deploy是Google Cloud对Google Kubernetes引擎的完全托管CD服务。<br/> Cloud Deploy允许构建可靠、持久的CI/CD管道，可以自动化构建、渲染和部署作业。</p><p id="f0b5" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">此外，Cloud Deploy可以轻松连接到现有的CI/CD工具，如Jenkins、Gitlab CI/CD、Argo CD..很多其他的东西。</p><p id="178f" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">本文的目标是了解如何使用带有GitLab CI/CD的Cloud Deploy实现CI/CD管道，git lab CI/CD是一种流行的CI/CD工具，可以帮助用户设计他们的Devops架构。</p></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><h1 id="c326" class="im in hi bd io ip kp ir is it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj bi translated">首先，制作一些GKE环境</h1><p id="cdf2" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">运行下面的命令创建4个GKE环境，我们将在这四个环境中部署我们的清单，用您的项目ID值替换PROJECT_ID。</p><blockquote class="kz la lb"><p id="fe50" class="jk jl lc jm b jn ku jp jq jr kv jt ju ld kw jx jy le kx kb kc lf ky kf kg kh hb bi translated">gcloud beta container clusters创建cluster-dev-zone us-central 1-c-PROJECT = PROJECT _ ID<br/>g cloud beta container clusters创建cluster-QA-zone us-central 1-c-PROJECT = PROJECT _ ID<br/>g cloud beta container clusters创建cluster-stage-zone us-central 1-c-PROJECT = PROJECT _ ID<br/>g cloud beta container clusters创建cluster-prod-zone us-central 1-c-PROJECT = PROJECT _ ID</p></blockquote><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lg"><img src="../Images/57255d8f5bb6e995d6d5525585c9a92e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i7WPC9g2oS-j8ZWgnoMwAQ.png"/></div></div></figure><h1 id="1e51" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">在你的GitLab库中放一些源代码</h1><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lp"><img src="../Images/862af84bab1b6d36214c708bba13465f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JLwP0tqfWWNtdVqs.png"/></div></div></figure><p id="007e" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">我放了一些webserver源代码(main。go，templates)在我的GitLab仓库里，带云部署，k8s，。gitlab-ci.yml，skaffold.yaml文件。您可以将任何可以构建到容器映像的代码放入您的存储库中。</p><h2 id="e054" class="lq in hi bd io lr ls lt is lu lv lw iw jv lx ly ja jz lz ma je kd mb mc ji md bi translated">k8s</h2><p id="4ec3" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">web.yaml</p><pre class="lh li lj lk fd me mf mg mh aw mi bi"><span id="9b07" class="lq in hi mf b fi mj mk l ml mm">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: web<br/>spec:<br/>  ports:<br/>  - port: 8080<br/>    name: http<br/>  type: LoadBalancer<br/>  selector:<br/>    app: web<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: web<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: web<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: web<br/>    spec:<br/>      containers:<br/>      - name: web<br/>        image: skaffold-buildpacks<br/>        ports:<br/>          - containerPort: 8080</span></pre><p id="dfc6" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">我们将用这个清单将一些Kubernetes资源部署到我们的GKE环境中，这些资源包括一个负载平衡器服务和一个部署。</p><h2 id="f9c5" class="lq in hi bd io lr ls lt is lu lv lw iw jv lx ly ja jz lz ma je kd mb mc ji md bi translated">。gitlab-ci.yml</h2><pre class="lh li lj lk fd me mf mg mh aw mi bi"><span id="d660" class="lq in hi mf b fi mj mk l ml mm">stages:          # List of stages for jobs, and their order of execution<br/>  - deploy<br/><br/><br/>deploy-job:      # This job runs in the deploy stage.<br/>  stage: deploy complete successfully.<br/>  script:<br/>    - skaffold config set default-repo gcr.io/PROJECT_ID<br/>    - skaffold build --interactive=false --file-output=artifacts.json <br/>    - echo "Application successfully built"<br/>    - gcloud beta deploy releases create test-release-rel-$(date +%y%m%d-%s)   --project=PROJECT_ID  --region=us-central1 --delivery-pipeline=cloud-deploy-test --build-artifacts=artifacts.json<br/>    - echo "Application successfully released."</span></pre><p id="c60c" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">我们可以在这个yaml清单中使用GitLab CI/CD的强大功能。清单由一个“部署”阶段组成，运行一些skaffold命令将源代码构建到工件中，并执行“gcloud beta deploy releases create”命令将一个版本注册到Cloud Deploy。<br/>在使用此清单文件之前，您必须在GitLab托管的实例中安装skaffold、GitLab runner和cloud SDK工具。</p><h2 id="afd7" class="lq in hi bd io lr ls lt is lu lv lw iw jv lx ly ja jz lz ma je kd mb mc ji md bi translated">斯卡福德</h2><pre class="lh li lj lk fd me mf mg mh aw mi bi"><span id="5bbe" class="lq in hi mf b fi mj mk l ml mm">apiVersion: skaffold/v2beta15<br/>kind: Config<br/>build:<br/>  googleCloudBuild: <br/>    projectId: PROJECT_ID <br/>  artifacts: <br/>  - image: skaffold-buildpacks <br/>    buildpacks: <br/>      builder: "gcr.io/buildpacks/builder:v1" </span></pre><p id="631e" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">我们使用带有“googleCloudBuild”和“Google Cloud buildpack”技术的远程构建将源代码构建到工件中。使用buildpack，您可以构建容器映像，而无需繁琐的Dockerfile脚本。</p><h2 id="fdfa" class="lq in hi bd io lr ls lt is lu lv lw iw jv lx ly ja jz lz ma je kd mb mc ji md bi translated">云部署</h2><p id="42a0" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">clouddeploy.yaml</p><pre class="lh li lj lk fd me mf mg mh aw mi bi"><span id="90ad" class="lq in hi mf b fi mj mk l ml mm">apiVersion: deploy.cloud.google.com/v1beta1<br/>kind: DeliveryPipeline<br/>metadata:<br/>  name: cloud-deploy-test<br/>description: cloud deploy delivery pipeline<br/>serialPipeline:<br/> stages:<br/> - targetId: dev<br/> - targetId: qa<br/> - targetId: stage<br/> - targetId: prod<br/><br/>---<br/><br/>apiVersion: deploy.cloud.google.com/v1beta1<br/>kind: Target<br/>metadata:<br/>  name: dev<br/>description: dev cluster<br/>requireApproval: true<br/>gke:<br/>  cluster: projects/PROJECT_ID/locations/us-central1-c/clusters/cluster-dev<br/><br/>---<br/><br/>apiVersion: deploy.cloud.google.com/v1beta1<br/>kind: Target<br/>metadata:<br/>  name: prod<br/>description: prod cluster<br/>requireApproval: true<br/>gke:<br/>  cluster: projects/PROJECT_ID/locations/us-central1-c/clusters/cluster-prod<br/><br/>---<br/><br/>apiVersion: deploy.cloud.google.com/v1beta1<br/>kind: Target<br/>metadata:<br/>  name: qa<br/>description: qa cluster<br/>requireApproval: true<br/>gke:<br/>  cluster: projects/PROJECT_ID/locations/us-central1-c/clusters/cluster-qa<br/><br/>---<br/><br/>apiVersion: deploy.cloud.google.com/v1beta1<br/>kind: Target<br/>metadata:<br/>  name: stage<br/>description: stage cluster<br/>requireApproval: true<br/>gke:<br/>  cluster: projects/PROJECT_ID/locations/us-central1-c/clusters/cluster-stage</span></pre><p id="8531" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">Cloud Deploy需要一个包含两种资源的清单文件，即DeliveryPipeline和Target。<br/>“目标”资源是将GKE集群环境映射到阶段名称所必需的。<br/>“delivery pipeline”资源使用目标的阶段名来组成订单中的整个串行管道。<br/>您必须在启动CI/CD管道流程之前运行以下命令，才能将此清单应用到您的云部署。</p><pre class="lh li lj lk fd me mf mg mh aw mi bi"><span id="acfa" class="lq in hi mf b fi mj mk l ml mm">gcloud beta deploy apply --file=clouddeploy.yaml \<br/>                         --region=us-central1<br/>                         --project=PROJECT_ID</span></pre></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><h1 id="eaf5" class="im in hi bd io ip kp ir is it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj bi translated">让我们开始运作吧</h1><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mn"><img src="../Images/5f255f36d83a23a12a4f0a2e12b93409.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HKeJ5-tm-4qLT8wN.png"/></div></div></figure><p id="64ac" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">在管道运行之前，我的web应用程序应该打印一个简单的短语，带有红色的“Hello world！”词。我用绿色的“Hello world！”更改了新的web应用程序源代码word并把它们推送到我的GitLab库。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mo"><img src="../Images/260dd64641b7871b660c3f45cee4d2fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tPX7Xn-UUx7HcXC2.png"/></div></div></figure><p id="d173" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">当我将新代码推送到我的repo中时，GitLab CI/CD就开始运行我的第一个序列化管道阶段，它运行“skaffold build”和“gcloud beta deploy releases create”命令。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mp"><img src="../Images/2c40f22535ab040015af6eb56b6d4943.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UXE1ZJU2RdUaz54z.png"/></div></div></figure><p id="7d76" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">在Cloud deploy的管道可视化页面中，您可以在GUI界面中看到序列化的流程，每个流程代表您的管道阶段。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mq"><img src="../Images/e71173b751bfaf7fc1369ed55800b566.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9PfMR_rcHZwtMiqJ.png"/></div></div></figure><p id="c01c" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">您可以单击“APPROVE”按钮，批准将这个新版本部署到您的第一个GKE环境阶段，即“dev”集群。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mr"><img src="../Images/96458c69a949aaee4c34fe83bf1267c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MfXNzBMJOkl5GiFg.png"/></div></div></figure><p id="c00f" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">在review页面上，您还可以将Kubernetes清单的当前版本与建议的版本进行比较。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es ms"><img src="../Images/41e7b7fb6ab396d33153fc05604eb40d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rcKFpRJCcrHowOj9.png"/></div></div></figure><p id="70f4" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">批准后，您可以在开发GKE集群中看到web应用程序页面的更改版本。<br/>渲染、构建、拉取、部署等所有工作..都是全自动的。开发人员刚刚发布了新版本的代码，运营部门刚刚批准了新版本。这就是我们这条管道所需要的。<br/>剩下的三个阶段(qa、stage、prod)也可以用上面同样的方式进行。</p></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><h1 id="8e86" class="im in hi bd io ip kp ir is it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj bi translated">结论</h1><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mt"><img src="../Images/56acbd232ba69243a827e49423d9a3bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cUyolYgebbixM8U7.png"/></div></div></figure><p id="b27c" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">该图包含了上述所有CI/CD管道阶段。</p><p id="1190" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">如果你想在你的云部署中增加一些高级功能，你可以集成其他的Google云服务，比如Pub/sub用于提醒你的邮件或短信，Operations suite用于日志、监控和审计。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div class="er es mu"><img src="../Images/9e904a3b612e779167982dc069e5c500.png" data-original-src="https://miro.medium.com/v2/resize:fit:1356/0*1Jxd9EHIwlCf46a_"/></div></figure><p id="2ac7" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">Cloud Deploy只是一个“<em class="lc">托管的Skaffold服务</em>，基于OSS，所以你也可以自己集成各种CI/CD工具以及GitLab CI/CD。</p><p id="6ec0" class="pw-post-body-paragraph jk jl hi jm b jn ku jp jq jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh hb bi translated">因此，我们有了一个完整的CI/CD管道，可以自动化我们所有的持续集成和部署工作！</p></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><h1 id="5a57" class="im in hi bd io ip kp ir is it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj bi translated">要了解更多信息，</h1><p id="036d" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">谷歌云平台云部署官方文档:<a class="ae mv" href="https://cloud.google.com/deploy/docs/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/deploy/docs/</a></p><h1 id="ef5c" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">参考</h1><div class="mw mx ez fb my mz"><a href="https://cloud.google.com/deploy/docs/deploying-application" rel="noopener  ugc nofollow" target="_blank"><div class="na ab dw"><div class="nb ab nc cl cj nd"><h2 class="bd hj fi z dy ne ea eb nf ed ef hh bi translated">部署您的应用|谷歌云部署</h2><div class="ng l"><h3 class="bd b fi z dy ne ea eb nf ed ef dx translated">预览此产品包含在Google Cloud服务条款的正式发布前产品条款中。正式上市前的产品…</h3></div><div class="nh l"><p class="bd b fp z dy ne ea eb nf ed ef dx translated">cloud.google.com</p></div></div><div class="ni l"><div class="nj l nk nl nm ni nn ik mz"/></div></div></a></div><div class="mw mx ez fb my mz"><a href="https://cloud.google.com/deploy/docs/architecture" rel="noopener  ugc nofollow" target="_blank"><div class="na ab dw"><div class="nb ab nc cl cj nd"><h2 class="bd hj fi z dy ne ea eb nf ed ef hh bi translated">谷歌云部署服务架构</h2><div class="ng l"><h3 class="bd b fi z dy ne ea eb nf ed ef dx translated">预览此产品包含在Google Cloud服务条款的正式发布前产品条款中。正式上市前的产品…</h3></div><div class="nh l"><p class="bd b fp z dy ne ea eb nf ed ef dx translated">cloud.google.com</p></div></div><div class="ni l"><div class="no l nk nl nm ni nn ik mz"/></div></div></a></div><div class="mw mx ez fb my mz"><a href="https://docs.gitlab.com/ee/ci/" rel="noopener  ugc nofollow" target="_blank"><div class="na ab dw"><div class="nb ab nc cl cj nd"><h2 class="bd hj fi z dy ne ea eb nf ed ef hh bi translated">GitLab CI/CD | GitLab</h2><div class="ng l"><h3 class="bd b fi z dy ne ea eb nf ed ef dx translated">GitLab CI/CD是一个使用连续方法进行软件开发的工具:使用GitLab CI/CD来捕获bug和…</h3></div><div class="nh l"><p class="bd b fp z dy ne ea eb nf ed ef dx translated">docs.gitlab.com</p></div></div><div class="ni l"><div class="np l nk nl nm ni nn ik mz"/></div></div></a></div></div></div>    
</body>
</html>