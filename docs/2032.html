<html>
<head>
<title>Setting Up Multi-Cloud (On-premises) Connectivity with Databricks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Databricks设置多云(内部)连接</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/setting-up-multi-cloud-on-premises-connectivity-with-databricks-19c45f98cb81?source=collection_archive---------1-----------------------#2021-12-15">https://medium.com/google-cloud/setting-up-multi-cloud-on-premises-connectivity-with-databricks-19c45f98cb81?source=collection_archive---------1-----------------------#2021-12-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="d8aa" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="9cba" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这是一个关于如何建立从您在GCP的<a class="ae kb" href="https://databricks.com/product/data-lakehouse" rel="noopener ugc nofollow" target="_blank"> Databricks </a>工作区到您的其他云/本地网络的连接的高级指南。对于这里详述的例子，我们将建立从GCP上的数据块到Azure环境的连接。类似的方法也适用于AWS或内部的连接。</p><p id="264f" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">本指南基于这篇<a class="ae kb" href="https://cloudywithachanceofbigdata.com/creating-a-site-to-site-vpn-connection-between-gcp-and-azure-with-google-private-access/" rel="noopener ugc nofollow" target="_blank">博客文章</a>，进行了修改以支持与数据块的连接。本指南可用于将GCP上的数据块连接到外部环境(Azure、AWS、内部)中托管的各种数据源，通过直接私有IP连接或通过云DNS的主机名查找。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/1eb35caf665cfb1dc200cb3930c74679.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*04t-KXE0MsPHaBT3VK4tsQ.png"/></div></div></figure><h1 id="cc46" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">清单</h1><ul class=""><li id="06f8" class="kt ku hi jf b jg jh jk jl jo kv js kw jw kx ka ky kz la lb bi translated">[Azure]创建以下服务:1个VNET、1个默认子网、1个网关子网、1个NSG、2个公共IPs、1个虚拟网络网关</li><li id="e4a9" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">[GCP]创建Databricks工作区</li><li id="6cd4" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">[GCP]创建以下服务:1个外部IP，1个VPN网关</li><li id="fed3" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">[GCP]定义VPN流量的转发规则</li><li id="acb5" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">[GCP]创建VPN隧道</li><li id="46a3" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">[Azure]创建本地网关</li><li id="8986" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">[Azure]创建VPN连接</li><li id="1e77" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">[GCP]调整数据块网络路由</li><li id="703a" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">[GCP]调整Databricks VPC防火墙规则</li><li id="61fb" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">[Databricks]通过私有IP呼叫测试连接性</li><li id="a635" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">[GCP]设置DNS区域</li><li id="3ed6" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">[数据块]通过主机名测试连接性</li></ul><h1 id="1b65" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">第1部分:确保您有一个满足先决条件的Azure环境</h1><h1 id="b2ab" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">所需天蓝色组件</strong></h1><p id="067b" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">1.<a class="ae kb" href="#8686" rel="noopener ugc nofollow">虚拟网络</a> <br/> 2。<a class="ae kb" href="#11f4" rel="noopener ugc nofollow">服务/虚拟机等的子网。即你要连接的</a>到<br/> 3。<a class="ae kb" href="#d7db" rel="noopener ugc nofollow">网关</a>的子网<br/> 4。<a class="ae kb" href="#8dd6" rel="noopener ugc nofollow">网络安全组</a> <br/> 5。<a class="ae kb" href="#dda2" rel="noopener ugc nofollow">公共IPs(用于虚拟网络网关，用于测试的VM)</a><br/>6 .<a class="ae kb" href="#5c34" rel="noopener ugc nofollow">虚拟网络网关</a></p><p id="9b10" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">对于本例，我们将在名为“<a class="ae kb" href="https://portal.azure.com/#@DataBricksInc.onmicrosoft.com/resource/subscriptions/3f2e4d32-8e8d-46d6-82bc-5bb8d962328b/resourcegroups/multicloud_vpn_rg/overview" rel="noopener ugc nofollow" target="_blank"> multicloud_vpn_rg </a>”的资源组中托管我们的资源。在此RG中，我们定义了一个名为“mc_vnet”的虚拟网络，其IPv4地址空间为10.1.0.0/16。</p><p id="9be7" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">因为我们将在这个例子中使用Azure PowerShell，所以第一步涉及身份验证(我们在这里以交互方式进行)。</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="b404" class="lm ig hi li b fi ln lo l lp lq">Connect-AzAccount -UseDeviceAuthentication -subscription XYZXYZXYZ</span></pre><p id="7490" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">然后，我们创建一个<a class="ae kb" href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview" rel="noopener ugc nofollow" target="_blank"> Azure虚拟网络</a>，连接2个子网——一个“默认”子网，我们将使用它来托管用于ping测试的虚拟机，另一个“网关子网”将托管一个<a class="ae kb" href="https://docs.microsoft.com/en-us/azure/vpn-gateway/" rel="noopener ugc nofollow" target="_blank">虚拟网关网络</a>。</p><h2 id="11f4" class="lm ig hi bd ih lr ls lt il lu lv lw ip jo lx ly it js lz ma ix jw mb mc jb md bi translated">服务/虚拟机等的子网。你想连接到<strong class="ak"> : </strong></h2><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="425f" class="lm ig hi li b fi ln lo l lp lq">$defaultSubnet = New-AzVirtualNetworkSubnetConfig `<br/>-Name “default” `<br/>-AddressPrefix “10.1.1.0/24”</span></pre><h2 id="d7db" class="lm ig hi bd ih lr ls lt il lu lv lw ip jo lx ly it js lz ma ix jw mb mc jb md bi translated">网关<strong class="ak">的子网:</strong></h2><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="9f41" class="lm ig hi li b fi ln lo l lp lq">$gatewaySubnet = New-AzVirtualNetworkSubnetConfig  `<br/>-Name "GatewaySubnet" `<br/>-AddressPrefix "10.1.2.0/24"</span></pre><h2 id="8686" class="lm ig hi bd ih lr ls lt il lu lv lw ip jo lx ly it js lz ma ix jw mb mc jb md bi translated"><strong class="ak">创建虚拟网络和子网:</strong></h2><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="e1c7" class="lm ig hi li b fi ln lo l lp lq">$vnet = New-AzVirtualNetwork  `<br/>  -Name "mc_vnet" `<br/>  -ResourceGroupName "multicloud_vpn_rg" `<br/>  -Location "West Europe" `<br/>  -AddressPrefix "10.1.0.0/16" `<br/>  -Subnet $gatewaySubnet,$defaultSubnetSubnet     </span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es me"><img src="../Images/0d7e2de2644153d5ee8684b60d8832ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-0YAywGE0Ls6l2QqpKMABA.png"/></div></div></figure><p id="9a5e" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">我们已经完成了该部分的<a class="ae kb" href="#8686" rel="noopener ugc nofollow"> #1 </a>、<a class="ae kb" href="#11f4" rel="noopener ugc nofollow"> #2 </a>和<a class="ae kb" href="#d7db" rel="noopener ugc nofollow"> #3 </a>项目的创建。</p><h2 id="8dd6" class="lm ig hi bd ih lr ls lt il lu lv lw ip jo lx ly it js lz ma ix jw mb mc jb md bi translated">NSG</h2><p id="9d87" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">一旦我们有了VNet，我们还会创建一个<a class="ae kb" href="https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview" rel="noopener ugc nofollow" target="_blank">网络安全组</a>，稍后我们将使用它来限制子网中的入站&amp;出站流量。</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="4523" class="lm ig hi li b fi ln lo l lp lq">$nsg = New-AzNetworkSecurityGroup `<br/>-ResourceGroupName “multicloud_vpn_rg” `<br/>-Location “West Europe” `<br/>-Name “nsg-vm”</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/8b1b907a37470d4bd6a3062c79c3f1aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WAONf3Q6-z7sWhdi"/></div></div></figure><p id="613c" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mg">我们已经完成了项目</em> <a class="ae kb" href="#8dd6" rel="noopener ugc nofollow"> <em class="mg"> #4 </em> </a> <em class="mg">的创建，自定义Azure流量限制不在本指南的讨论范围内。</em></p><h1 id="0be8" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">公共知识产权</h1><p id="fbed" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们还需要创建两个公共IP地址，分别用于我们的VPN网关和我们将要创建的虚拟机。</p><p id="dda2" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">为虚拟机创建公共IP地址:</strong></p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="c024" class="lm ig hi li b fi ln lo l lp lq">$vmpip = New-AzPublicIpAddress `<br/>-Name “vm-ip” `<br/>-ResourceGroupName “multicloud_vpn_rg” `<br/>-Location “West Europe” `<br/>-AllocationMethod Dynamic</span></pre><p id="7b84" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">为NW网关创建公共IP地址:</strong></p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="9f28" class="lm ig hi li b fi ln lo l lp lq">$ngwpip = New-AzPublicIpAddress `<br/>-Name “ngw-ip” `<br/>-ResourceGroupName “multicloud_vpn_rg” `<br/>-Location “West Europe” `<br/>-AllocationMethod Dynamic</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/db1fc6216ef02d0fe1ba037af6811602.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g07NxjR_y1Jp52fx"/></div></div></figure><p id="3183" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mg">本节我们已经完成了</em> <a class="ae kb" href="#dda2" rel="noopener ugc nofollow"> <em class="mg"> #5 </em> </a> <em class="mg">项的创建。</em></p><h2 id="5c34" class="lm ig hi bd ih lr ls lt il lu lv lw ip jo lx ly it js lz ma ix jw mb mc jb md bi translated">虚拟网络网关</h2><p id="33ed" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">接下来，我们部署我们的<a class="ae kb" href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways" rel="noopener ugc nofollow" target="_blank">虚拟网络网关</a>，它将用于创建到我们的Google环境的VPN隧道。这将被部署到我们在开始时定义的“网关子网”中，它将利用“ngw-ip”公共ip地址。</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="87b8" class="lm ig hi li b fi ln lo l lp lq">$vnet = Get-AzureRmVirtualNetwork -Name mc_vnet -ResourceGroupName multicloud_vpn_rg</span><span id="76a1" class="lm ig hi li b fi mh lo l lp lq">$gatewaySubnetId = $vnet.Subnets[0].id</span><span id="157d" class="lm ig hi li b fi mh lo l lp lq">$ngwpip = Get-AzPublicIpAddress -Name ngw-ip -ResourceGroupName multicloud_vpn_rg</span></pre><p id="9306" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">创建虚拟网关:</strong></p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="38b9" class="lm ig hi li b fi ln lo l lp lq">$ngwipconfig = New-AzVirtualNetworkGatewayIpConfig `<br/>  -Name "ngw-ipconfig" `<br/>  -SubnetId $gatewaySubnetId `<br/>  -PublicIpAddressId $ngwpip.Id</span></pre><p id="29c1" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">这可能需要相当长的时间:</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="a259" class="lm ig hi li b fi ln lo l lp lq">$job = New-AzVirtualNetworkGateway -Name “vnet-gateway” `<br/>-ResourceGroupName “multicloud_vpn_rg” `<br/>-Location “West Europe” `<br/>-IpConfigurations $ngwipconfig `<br/>-GatewayType “Vpn” `<br/>-VpnType “RouteBased” `<br/>-GatewaySku “VpnGw1” `<br/>-VpnGatewayGeneration “Generation1” `</span><span id="3402" class="lm ig hi li b fi mh lo l lp lq">$vnetgw = Get-AzVirtualNetworkGateway `<br/>  -Name "vnet-gateway" `<br/>  -ResourceGroupName "multicloud_vpn_rg"</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/5393328981d8e5bf62479ee8644a8d30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ThAKcrErL-59hMBe"/></div></div></figure><p id="df4a" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mg">本节我们已经完成了</em> <a class="ae kb" href="#5c34" rel="noopener ugc nofollow"> <em class="mg"> #6 </em> </a> <em class="mg">项的创建。</em></p><h1 id="be4e" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">第2节:在您的GCP环境中设置数据块</h1><p id="8c74" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">如果您在GCP没有现有的Databricks工作区，请按照<a class="ae kb" href="https://docs.gcp.databricks.com/getting-started/try-databricks-gcp.html#prerequisites" rel="noopener ugc nofollow" target="_blank">文档</a>创建一个新的工作区。请确保<a class="ae kb" href="https://docs.gcp.databricks.com/administration-guide/cloud-configurations/gcp/network-sizing.html" rel="noopener ugc nofollow" target="_blank">正确地确定了</a>工作区网络的规模。</p><p id="de7d" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">在本例中，我们将使用专用GKE集群部署，并使用以下子网:</p><ul class=""><li id="29b7" class="kt ku hi jf b jg kc jk kd jo mi js mj jw mk ka ky kz la lb bi translated">GKE节点的主IP范围:10.3.0.0/16</li><li id="a71c" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">GKE节点的辅助IP范围:10.4.0.0/16</li><li id="15e6" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">GKE服务的二级IP范围:10.5.0.0/20</li><li id="07d6" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">GKE主资源的IP范围:10.6.0.0/28</li></ul><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es ml"><img src="../Images/392910f05df72cad3cfe491b69d58dc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_DBbPQ_y2F9_Z91D"/></div></div></figure><p id="9ecb" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">一旦您的工作空间被供应，做一个快速验证测试，启动一个小集群，并确保一切正常。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mm"><img src="../Images/bbe3554e3c6862bd36eb4462f25c2f95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g_mUm2FgVcMavOqs"/></div></div></figure><h1 id="00eb" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">查找数据块管理的VPC /网络</h1><p id="b470" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">通过在管理控制台上查看您的工作区的URL(工作区ID)，并将其与部分VPC ID进行匹配，您可以为您的数据块工作区找到相应的数据块管理的VPC。数据块管理的VPC遵循以下命名格式:<em class="mg">数据块-管理- &lt;工作空间id &gt;。从那里，您还可以查看您的Databricks实例使用的所有子网。</em></p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/1b0487f377a03c1b0133d98e23f301a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ygc9fV_luex60yst"/></div></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/437d89d5aea6f6bcf78751c4a2331a15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-5A3vapMG3V7eFqP"/></div></div></figure><h1 id="bb9b" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">第3部分:安装程序需要GCP组件来确保到Azure的VPN连接</h1><h1 id="aed8" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">所需的GCP组件</h1><ol class=""><li id="8abf" class="kt ku hi jf b jg jh jk jl jo kv js kw jw kx ka mn kz la lb bi translated"><a class="ae kb" href="#4dd7" rel="noopener ugc nofollow">外部IP(用于虚拟网络网关)</a></li><li id="b28c" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka mn kz la lb bi translated"><a class="ae kb" href="#9e2b" rel="noopener ugc nofollow">虚拟网络网关(及相关转发规则)</a></li></ol><h1 id="4dd7" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">外部IP</h1><p id="3706" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们首先在GCP环境中创建一个外部IP，通过VPN网关将Azure资源组连接到GCP。</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="d6eb" class="lm ig hi li b fi ln lo l lp lq">gcloud compute addresses create “ext-gw-ip” \<br/> — region “europe-west2”</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/e63602d9f1cff9cf3b751bbf772febb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4Bb8yyd1ftGpMrhB"/></div></div></figure><p id="2538" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mg">本节我们已经完成了</em> <a class="ae kb" href="#4dd7" rel="noopener ugc nofollow"> <em class="mg"> #1 </em> </a> <em class="mg">项的创建。</em></p><h1 id="9e2b" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">虚拟网络网关</h1><p id="7bfc" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">现在我们需要在两个网络(Azure和GCP)之间建立一个VPN连接。一个连接通常有两个出口。在我们的例子中，一个出口在Azure端(我们在那里创建了Azure虚拟网络网关)，第二个出口在GCP端(因为我们将在后续步骤中创建VPN网关)。</p><p id="a62b" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">为了连接这两个网关，我们需要将Azure中的网关链接到GCP中的网关。每个网关都像其对应网络的入口一样，这就是为什么我们需要定义来自一个网关(分别为Azure虚拟网络网关/VPN网关)的流量规则，通过第二个网关(分别为VPN网关/Azure虚拟网络网关)到达目标网络(分别为VPC/VNET)中的资源。</p><p id="5da9" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">如果您需要提醒自己什么是托管网络，请回顾前面的部分。</p><p id="246a" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">创建云VPN: </strong></p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="5a6d" class="lm ig hi li b fi ln lo l lp lq">gcloud compute target-vpn-gateways create “vpn-gw” \<br/> — network “databricks-managed-4508843396878646” \<br/> — region “europe-west2” \<br/> — project “fe-dev-sandbox”<br/></span></pre><p id="cf96" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">仅仅有VPN网关是不够的。我们还需要考虑到连通性；流量规则是使用GCP端的转发规则定义的。每个转发规则引用一个IP地址和一个或多个VPC接受流量的端口。</p><p id="4bab" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">创建转发规则ESP: </strong></p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="46a2" class="lm ig hi li b fi ln lo l lp lq">gcloud compute forwarding-rules create "fr-gw-name-esp" \<br/> - ip-protocol ESP \<br/> - address "ext-gw-ip" \<br/> - target-vpn-gateway "vpn-gw" \<br/> - region "europe-west2" \<br/> - project "fe-dev-sandbox"</span></pre><p id="e466" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">正在创建转发规则UDP500: </strong></p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="181e" class="lm ig hi li b fi ln lo l lp lq">gcloud compute forwarding-rules create "fr-gw-name-udp500" \<br/> - ip-protocol UDP \<br/> - ports 500 \<br/> - address "ext-gw-ip" \<br/> - target-vpn-gateway "vpn-gw" \<br/> - region "europe-west2" \<br/> - project "fe-dev-sandbox"</span></pre><p id="2ebf" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">创建转发规则UDP4500: </strong></p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="ac48" class="lm ig hi li b fi ln lo l lp lq">gcloud compute forwarding-rules create "fr-gw-name-udp4500" \<br/> - ip-protocol UDP \<br/> - ports 4500 \<br/> - address "ext-gw-ip" \<br/> - target-vpn-gateway "vpn-gw" \<br/> - region "europe-west2" \<br/> - project "fe-dev-sandbox"</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mo"><img src="../Images/1629ffb9b72a0672fbd8133c57d2c522.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rLjA1z1VWHxB0v1Y"/></div></div></figure><p id="266d" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mg">我们已经完成了本节</em> <a class="ae kb" href="#9e2b" rel="noopener ugc nofollow"> <em class="mg"> #2 </em> </a> <em class="mg">项的创建。</em></p><h1 id="1313" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">第4部分:建立VPN连接</h1><p id="488c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们现在需要在两端设置VPN连接:</p><ul class=""><li id="83f6" class="kt ku hi jf b jg kc jk kd jo mi js mj jw mk ka ky kz la lb bi translated"><strong class="jf hj">VPN连接的Azure端</strong> —建立从Azure虚拟网络网关($vnetgw)到Azure本地网关(由于它链接到GCP端的外部IP，因此其作用类似于远程GCP网关)的连接</li><li id="59fb" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated"><strong class="jf hj">VPN连接的GCP端— </strong>建立从GCP VPN网关($vpn-gw)到Azure端公共IP地址($azpubip)的连接</li></ul><h1 id="5c2f" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">必需的步骤</h1><ol class=""><li id="2301" class="kt ku hi jf b jg jh jk jl jo kv js kw jw kx ka mn kz la lb bi translated"><a class="ae kb" href="#41eb" rel="noopener ugc nofollow"> [GCP]从GCP VPN隧道创建连接</a></li><li id="d4af" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka mn kz la lb bi translated"><a class="ae kb" href="#b23a" rel="noopener ugc nofollow">【Azure】创建Azure本地网络网关</a></li><li id="87ba" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka mn kz la lb bi translated"><a class="ae kb" href="#19b9" rel="noopener ugc nofollow">【Azure】创建Azure虚拟本地网络连接</a></li></ol><h1 id="41eb" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">GCP VPN隧道</h1><p id="f6f2" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">首先，我们使用Azure虚拟网络网关的公共IP地址在我们的GCP环境(VPN隧道)中创建一个连接。由于本例使用基于路由的VPN，流量选择器值需要设置为0.0.0.0/0。需要提供一个<a class="ae kb" href="https://cloud.google.com/network-connectivity/docs/vpn/how-to/generating-pre-shared-key" rel="noopener ugc nofollow" target="_blank"> PSK(预共享密钥)</a>，该密钥与我们在隧道的Azure端配置VPN连接时使用的密钥相同。</p><p id="6054" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mg">如果您忘记了您的Azure公共IP，您可以在您的Azure环境中运行以下命令:</em></p><p id="2057" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">获取Azure网关的对等公共IP地址:</strong></p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="fdd6" class="lm ig hi li b fi ln lo l lp lq">$azpubip = Get-AzPublicIpAddress `<br/>-Name "ngw-ip" `<br/>-ResourceGroupName "multicloud_vpn_rg"</span></pre><p id="176b" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">当您准备好开始时，您可以生成您的PSK，然后在您的GCP环境中创建VPN隧道:</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="366f" class="lm ig hi li b fi ln lo l lp lq">openssl rand -base64 24</span></pre><blockquote class="mp mq mr"><p id="20d7" class="jd je mg jf b jg kc ji jj jk kd jm jn ms ke jq jr mt kf ju jv mu kg jy jz ka hb bi translated">保存这个密钥。在这个过程的后面，您将需要它。</p></blockquote><p id="c005" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">创建VPN隧道:</strong></p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="17fb" class="lm ig hi li b fi ln lo l lp lq">gcloud compute vpn-tunnels create "vpn-tunnel-to-azure" \<br/> - peer-address $azpubip.IpAddress \<br/> - local-traffic-selector "0.0.0.0/0" \<br/> - remote-traffic-selector "0.0.0.0/0" \<br/> - ike-version 2 \<br/> - shared-secret &lt;&lt;Pre-Shared Key&gt;&gt; \<br/> - target-vpn-gateway "vpn-gw" \<br/> - region "europe-west2" \<br/> - project "fe-dev-sandbox"</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/6e1578207472c43d2edcf885976e0b4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cspaqc4Q_QYtDUc3"/></div></div></figure><p id="a527" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mg">本节我们已经完成了</em> <a class="ae kb" href="#41eb" rel="noopener ugc nofollow"> <em class="mg"> #1 </em> </a> <em class="mg">项的创建。</em></p><h1 id="b23a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">Azure本地网关</h1><p id="fcf8" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们现在创建一个Azure本地网关，充当GCP的远程网关。为此，我们需要:</p><ul class=""><li id="3e23" class="kt ku hi jf b jg kc jk kd jo mi js mj jw mk ka ky kz la lb bi translated">GCP对外知识产权</li><li id="c1d4" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">您在设置Databricks工作区时输入的GCP VPC IP地址范围</li></ul><p id="8ee7" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">请查看第<a class="ae kb" href="#be4e" rel="noopener ugc nofollow"> 2 </a>部分，以检索有关您的数据管理VPC的信息。</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="7ea7" class="lm ig hi li b fi ln lo l lp lq">$azlocalgw = New-AzLocalNetworkGateway `<br/>-Name "local-gateway" `<br/>-ResourceGroupName "multicloud_vpn_rg" `<br/>-Location "West Europe" `<br/>-GatewayIpAddress $gcp_ipaddr `<br/>-AddressPrefix @("10.3.0.0/16","10.4.0.0/16","10.5.0.0/20")</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/56fbb9c6d7dd45dfd4fc87baf5c8c43e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CXcbTK1HKXw_jnCw"/></div></div></figure><p id="1b97" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mg">本节我们已经完成了</em> <a class="ae kb" href="#b23a" rel="noopener ugc nofollow"> <em class="mg"> #2 </em> </a> <em class="mg">项的创建。</em></p><h1 id="19b9" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">Azure VPN连接</h1><p id="c4a6" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">接下来，我们通过将Azure虚拟网络网关与本地网络网关相关联，在我们的Azure环境中创建一个连接(VPN连接)。需要提供一个PSK(预共享密钥)，它与用于GCP VPN隧道的密钥<strong class="jf hj">相同。</strong></p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="fba0" class="lm ig hi li b fi ln lo l lp lq">$azvpnconn = New-AzVirtualNetworkGatewayConnection `<br/>-Name "vpn-connection" `<br/>-ResourceGroupName "multicloud_vpn_rg" `<br/>-VirtualNetworkGateway1 $vnetgw `<br/>-LocalNetworkGateway2 $azlocalgw `<br/>-Location "West Europe" `<br/>-ConnectionType IPsec `<br/>-SharedKey &lt;&lt; Pre-Shared Key &gt;&gt; `<br/>-ConnectionProtocol "IKEv2"</span></pre><p id="aaf3" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">几分钟后(大约5分钟)，您应该会看到Azure连接状态更改为“已连接”，以及GCP VPN隧道状态更改为“已建立”</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/988f64866f2167ea7d0831791dda8300.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*F6pP3YQncFrugMTv"/></div></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/a70fbc4e439b2bf4314254603e3fa238.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FlElQySCMZCGHFKG"/></div></div></figure><p id="6fa0" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mg">本节我们已经完成了</em> <a class="ae kb" href="#19b9" rel="noopener ugc nofollow"> <em class="mg"> #3 </em> </a> <em class="mg">项的创建。</em></p><h1 id="41c3" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">第5部分:调整数据块环境以利用VPN连接</h1><p id="7bd5" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">您需要定制在部署Databricks workspace时自动创建的Databricks环境(主要是Databricks管理的VPC ),以利用VPN连接。为此，您还需要您的Databricks管理的VPC ID。</p><p id="71eb" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">由于这是一个外部连接，我们需要通过定义流量应该如何流入我们的GCP网络(路由)，然后允许此流量进入我们的GCP网络(防火墙规则)来确保其安全。</p><p id="42e2" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mg">请注意，我们将仅在托管Databricks的GCP环境中处理有限的数据泄露规则。有关使用数据块设置防火墙的更多详细信息，请查阅专用文档。</em></p><h1 id="2ee9" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">必需的步骤</h1><ol class=""><li id="f5ee" class="kt ku hi jf b jg jh jk jl jo kv js kw jw kx ka mn kz la lb bi translated"><a class="ae kb" href="#d23e" rel="noopener ugc nofollow">【GCP】设置静态路由</a></li><li id="8cdb" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka mn kz la lb bi translated"><a class="ae kb" href="#a283" rel="noopener ugc nofollow">【GCP】设置防火墙规则</a></li></ol><h1 id="d23e" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">静态路由</h1><p id="ad68" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">既然我们在两端都有网络资源(Azure中的VNET，以及由GCP的Databricks创建和管理的VPC)，我们需要通过为Azure网络的传出流量设置<a class="ae kb" href="https://cloud.google.com/vpc/docs/routes" rel="noopener ugc nofollow" target="_blank">路由</a>来在GCP端路由流量。</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="b77d" class="lm ig hi li b fi ln lo l lp lq">gcloud compute routes create "route-to-azure" \<br/> - destination-range "10.1.0.0/16" \<br/> - next-hop-vpn-tunnel "vpn-tunnel-to-azure" \<br/> - network "databricks-managed-4508843396878646" \<br/> - next-hop-vpn-tunnel-region "europe-west2" \<br/> - project "fe-dev-sandbox"</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/943af64d02aa88179c5b53d047984fba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hmamJBaLj4bQ3XDq"/></div></div></figure><p id="b59d" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mg">本节我们已经完成了</em> <a class="ae kb" href="#d23e" rel="noopener ugc nofollow"> <em class="mg"> #1 </em> </a> <em class="mg">项的创建。</em></p><h1 id="a283" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">防火墙规则</h1><p id="e709" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">为了加强安全性，现在我们已经定义了流量(GCP → Azure)的路由(即方向)，我们还需要指定<a class="ae kb" href="https://cloud.google.com/vpc/docs/firewalls" rel="noopener ugc nofollow" target="_blank">防火墙规则</a>以允许该流量流出Databricks管理的VPC(即允许VPN流量)。</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="c39e" class="lm ig hi li b fi ln lo l lp lq">gcloud compute firewall-rules create "vpn-rule1" \<br/> - network "databricks-managed-4508843396878646" \<br/> - allow tcp,udp,icmp \<br/> - source-ranges "10.1.0.0/16"​​</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/735f3c36dd45bf39063eca6772880853.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*i_Ecxf9X3BghrF5W"/></div></div></figure><p id="c1de" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mg">本节我们已经完成了</em> <a class="ae kb" href="#a283" rel="noopener ugc nofollow"> <em class="mg"> #2 </em> </a> <em class="mg">项的创建。</em></p><h1 id="73d7" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">第6部分:测试GCP的数据块和Azure VM之间的连通性</h1><p id="207a" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在本节中，我们通过Azure控制台快速创建了一个VM，设置如下。我们验证了我们可以使用我的本地计算机RDP到机器中。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mv"><img src="../Images/40faeb8f9090d3429b8074c1e9a786c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xILlDylXFW4a_aJ3"/></div></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mw"><img src="../Images/433bf0a21a608bd5115a0b6a779c1abf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2nLbMwoUdrZfdNgQ"/></div></div></figure><p id="cfcd" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">一旦我们远程连接到Azure VM，我们就可以启动一个命令提示符并ping互联网，以确保它正常工作。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mx"><img src="../Images/7965983507e7937484f8bfce94b50e37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*V_jpnKGrqYTZe5il"/></div></div></figure><p id="8c57" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">我们现在在GCP的数据块中建立了一个集群。我们从Databricks内部向Azure VMs私有IP地址发出ping命令。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es my"><img src="../Images/98372433fd185a56d2b4a37183d859d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mCksOdzj70lkM7WY"/></div></div></figure><h1 id="b3f4" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">第7部分[可选]:设置专用DNS区域，以便能够使用主机名连接到Azure服务</h1><p id="df2f" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">如果我们想要使用私有DNS，以便通过自定义名称而不是直接IP地址来调用其中的一些服务，我们可以在项目级别创建一个云DNS区域，并将其应用到我们的托管Databricks网络。</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="1a68" class="lm ig hi li b fi ln lo l lp lq">gcloud beta dns - project=fe-dev-sandbox managed-zones create dns-azurevm \<br/> - description="Translation of hostname to Azure VM private IP in multicloud setup" \<br/> - dns-name="azurevm.databricks.com." \<br/> - visibility="private" \<br/> - networks="databricks-managed-4508843396878646"</span></pre><p id="4b6d" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">然后，我们可以为该区域定义记录集。在下面的例子中，我们将vm1.azurevm.databricks.com定义为我们的Azure VM 10.1.1.4的私有IP的名称。</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="c299" class="lm ig hi li b fi ln lo l lp lq">gcloud dns - project=fe-dev-sandbox \<br/>record-sets transaction start - zone=dns-azurevm</span><span id="7cce" class="lm ig hi li b fi mh lo l lp lq">gcloud dns - project=fe-dev-sandbox \<br/>record-sets transaction add "10.1.1.4" \<br/> - name=vm1.azurevm.databricks.com. \<br/> - ttl=300 \<br/> - type=A \<br/> - zone=dns-azurevm</span><span id="b0d1" class="lm ig hi li b fi mh lo l lp lq">gcloud dns - project=fe-dev-sandbox \<br/>record-sets transaction execute \<br/> - zone=dns-azurevm</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/a53bda73ceccab3f10e7fe91ecc84a2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3XZDK9lg_MW2dqGL"/></div></div></figure><p id="7d88" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">一旦我们完成了上面的步骤，我们就可以返回到GCP的Databricks，发出ping命令，这次使用新定义的虚拟机名称。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mz"><img src="../Images/ccdf97553949289e19e5d9334db2379d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jXjc5oWH3fvG-vwN"/></div></div></figure><h1 id="cb9f" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">结尾部分</h1><p id="d006" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们已经成功地在GCP和Azure之间建立了多云VPN连接，并且能够使用私有流量将来自GCP的数据块的请求发送到我们Azure环境中的虚拟机。我们还建立了一个DNS区域，以方便我们在GCP环境的数据库中进行这项工作。</p><p id="1093" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">如果您想了解更多关于<a class="ae kb" href="https://databricks.com/company/contact" rel="noopener ugc nofollow" target="_blank"> Databricks </a>或<a class="ae kb" href="https://cloud.google.com/contact" rel="noopener ugc nofollow" target="_blank"> Google Cloud </a>的信息，请通过链接的联系页面联系。</p></div><div class="ab cl na nb gp nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="hb hc hd he hf"><blockquote class="mp mq mr"><p id="c1a8" class="jd je mg jf b jg kc ji jj jk kd jm jn ms ke jq jr mt kf ju jv mu kg jy jz ka hb bi translated"><strong class="jf hj"> <em class="hi">本文仅代表作者个人观点，不代表谷歌或Databricks </em> </strong>的观点</p></blockquote><p id="bec2" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">如果你喜欢这篇文章，请为它鼓掌。更多google云端数据科学、数据工程、AI/ML关注我<a class="ae kb" href="https://www.linkedin.com/in/lukasz-olejniczak-1a75a613/" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj"><em class="mg">LinkedIn</em></strong></a><strong class="jf hj"><em class="mg">。</em> </strong></p><p id="4044" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><em class="mg">非常感谢来自Databricks的</em> <strong class="jf hj"> <em class="mg">席尔武托凡</em> </strong> <em class="mg">和</em> <strong class="jf hj"> <em class="mg">马尔瓦·克鲁玛</em> </strong> <em class="mg">和</em> <strong class="jf hj"> <em class="mg">克里斯蒂娜·弗洛里亚</em> </strong> <em class="mg">和</em> <strong class="jf hj"> <em class="mg">彼得·格里夫</em> </strong> <em class="mg">来自谷歌云</em> <em class="mg">为本文和Databricks提供支持</em></p></div></div>    
</body>
</html>