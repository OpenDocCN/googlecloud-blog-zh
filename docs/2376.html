<html>
<head>
<title>Automating Google Cloud Storage Management with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python自动化Google云存储管理</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/automating-google-cloud-storage-management-with-python-92ba64ec8ea8?source=collection_archive---------0-----------------------#2022-09-23">https://medium.com/google-cloud/automating-google-cloud-storage-management-with-python-92ba64ec8ea8?source=collection_archive---------0-----------------------#2022-09-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="bfda" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">如何利用Python来自动管理您的云存储对象。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/89fd494987d9c67f028f48fcf37d319f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gOWqvsNKEGNXf-AMh68WSQ.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图片来自<a class="ae jn" href="https://unsplash.com/photos/8EzNkvLQosk" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>。</figcaption></figure><p id="6f20" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云</a>是市场上<a class="ae jn" href="https://www.statista.com/statistics/967365/worldwide-cloud-infrastructure-services-market-share-vendor/#:~:text=In%20the%20first%20quarter%20of,with%20eight%20percent%20market%20share." rel="noopener ugc nofollow" target="_blank">最大的云提供商</a>之一。<strong class="jq hj">谷歌云平台(GCP) </strong>提供各种云解决方案，包括计算服务、存储选项、网络和安全解决方案，以及大数据和人工智能框架。</p><p id="81b9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">不久前，我发表了一篇文章，介绍了如何使用Python 自动化AWS S3文件管理的基础知识。今天，我们将把重点转移到Google Cloud，我将向您展示如何使用Google的云存储解决方案来实现文件管理的自动化。</p><p id="2cca" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">GCP为用户提供了<strong class="jq hj">自由层</strong>，用于<a class="ae jn" href="https://cloud.google.com/free/docs/free-cloud-features#storage" rel="noopener ugc nofollow" target="_blank">云存储</a>其中包括<strong class="jq hj"> 5GB存储</strong>，5000个A类和50000个B类操作。此外，新用户可以获得<a class="ae jn" href="https://cloud.google.com/free" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj"> 300美元的免费积分</strong> </a>用于购买各种云服务。</p><p id="3619" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在下面的小节中，我将介绍设置您的GCP环境的步骤，并向您展示如何使用带有Python 3 到<strong class="jq hj"> </strong>的<strong class="jq hj"> GCP云存储API来自动管理您的存储桶和文件。</strong></p><h1 id="a6ed" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">1 |准备您的GCP环境</h1><p id="92e9" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">在我们开始使用任何API与GCP交互之前，我们需要执行一些准备步骤。</p><h2 id="641a" class="lh kl hi bd km li lj lk kq ll lm ln ku jx lo lp kw kb lq lr ky kf ls lt la lu bi translated">创建服务帐户</h2><p id="9b14" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">首先，我们需要<strong class="jq hj">创建一个服务帐户(SA) </strong>，它将用于通过API与云存储交互。我们可以使用API执行的操作由我们授予SA的权限范围定义<strong class="jq hj">。</strong></p><blockquote class="lv lw lx"><p id="55b6" class="jo jp ly jq b jr js ij jt ju jv im jw lz jy jz ka ma kc kd ke mb kg kh ki kj hb bi translated">服务帐户(SA)为您提供了一种保护和划分对GCP环境的访问权限的简单方法。</p></blockquote><p id="4fe1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">例如，我们可以创建一个SA，它只能<strong class="jq hj">查看我们存储桶中的</strong>文件，但是<strong class="jq hj">不能创建</strong>新存储桶。这有助于我们保护我们的GCP环境，特别是当具有不同角色和目标的多个团队在同一个项目中工作时。对于我们的用例，我们将创建一个对云存储具有<strong class="jq hj">管理权限</strong>的SA，这意味着它将能够执行任何操作。</p><p id="1e83" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">登录到您的<a class="ae jn" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> Google云管理控制台</a>，进入IAM &amp; Admin并选择<a class="ae jn" href="https://console.cloud.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank"> <em class="ly">服务帐户</em> </a>选项卡。在那里，点击<em class="ly">创建服务账户</em>。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mc"><img src="../Images/c1f6fe0e8bb6c6ebb630601bfb158d40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C96yAd1H7xteefsQfcbLjQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图片来自Google云管理控制台— IAM &amp; Admin &gt;服务帐户</figcaption></figure><p id="2e80" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">选择一个服务帐户名，例如“<em class="ly"> cloud-storage-sa </em>”，并可选地添加简短描述。最后，我们需要授予SA访问权限。在我们的例子中，我们将选择<em class="ly">“云存储:存储管理员</em>”的角色。</p><h2 id="2304" class="lh kl hi bd km li lj lk kq ll lm ln ku jx lo lp kw kb lq lr ky kf ls lt la lu bi translated">正在收集API密钥</h2><p id="5545" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">既然我们已经创建了SA，我们需要生成它各自的密钥，这将允许我们在使用API时进行身份验证。</p><p id="3960" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">单击您新创建的SA的电子邮件地址，该地址显示在您的<a class="ae jn" href="https://console.cloud.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank">服务帐户列表</a>中。该电子邮件地址将类似于“<em class="ly">cloud-storage-sa@project-name.gserviceaccount.com</em>”。然后转到<em class="ly">密钥</em>选项卡，点击<em class="ly">添加密钥&gt;创建新密钥</em>并选择<em class="ly"> JSON </em>作为密钥类型。这会将一个JSON文件下载到您的PC上，其中包含向您的GCP控制台进行身份验证所需的密钥。</p><blockquote class="lv lw lx"><p id="b9d3" class="jo jp ly jq b jr js ij jt ju jv im jw lz jy jz ka ma kc kd ke mb kg kh ki kj hb bi translated">确保安全地存储您的JSON密钥文件，因为这是访问您的GCP资源的密钥。</p></blockquote><p id="c874" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">既然我们已经收集了云存储SA的API键，我们可以开始对云存储进行API调用了。</p><h1 id="2f29" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">2 |通过API与GCP交互</h1><p id="54cd" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">google-cloud-storage包是用于与云存储交互的官方Google Python包。您可以通过pip安装程序轻松安装它，如下所示:</p><pre class="iy iz ja jb fd md me mf mg aw mh bi"><span id="c2b0" class="lh kl hi me b fi mi mj l mk ml">pip install google-cloud-storage</span></pre><p id="f0c2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在进行任何API调用之前，我们需要在Python脚本中创建一个环境变量，该变量保存包含API键的JSON文件的路径:</p><pre class="iy iz ja jb fd md me mf mg aw mh bi"><span id="48df" class="lh kl hi me b fi mi mj l mk ml">os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = r"/path/to/credentials/project-name-123456.json"</span></pre><p id="f087" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">太好了——我们都准备好了，让我们动手吧。</p><h2 id="0fde" class="lh kl hi bd km li lj lk kq ll lm ln ku jx lo lp kw kb lq lr ky kf ls lt la lu bi translated">A.创建云存储桶</h2><p id="8721" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">首先，我们可以从创建一个bucket开始。</p><p id="a379" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">云存储Python包允许我们通过将<a class="ae jn" href="https://cloud.google.com/storage/docs/storage-classes" rel="noopener ugc nofollow" target="_blank">存储类</a>和<a class="ae jn" href="https://cloud.google.com/storage/docs/locations" rel="noopener ugc nofollow" target="_blank">存储位置</a>设置为函数<em class="ly"> create_bucket </em>的参数来定义它们。在下面的示例中，我们选择“标准<em class="ly">”</em>作为存储类别，选择“<em class="ly">美国中心1 </em>”作为位置:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mm mn l"/></div></figure><p id="e7a8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">存储类参数的其他选项包括'<em class="ly"> COLDLINE </em>'、<em class="ly"> NEARLINE' </em>或'<em class="ly"> ARCHIVE' </em>。</p><p id="4e67" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">根据您定义位置参数的粒度，存储桶数据将按区域或多区域存储<strong class="jq hj">。如下表所示，通过将'<em class="ly">位置</em>'设置为'<em class="ly">美国</em>'，您的铲斗的位置类型将<strong class="jq hj">自动设置为多区域</strong>——其他位置也是如此。</strong></p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mo"><img src="../Images/f3cd3a77429d1d8ddec7722ff8e9bf54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Zu8kYfT10rpM897j59bKQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">多区域或区域云存储桶，位置类型选项。图片作者。</figcaption></figure><p id="00be" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">要将您的存储桶位置类型设置为<strong class="jq hj">双位置</strong>，请将“data_locations”参数添加到“create_bucket”函数中，并定义您的存储桶应将其数据存储在哪两个位置。</p><h2 id="80c5" class="lh kl hi bd km li lj lk kq ll lm ln ku jx lo lp kw kb lq lr ky kf ls lt la lu bi translated">B.将文件上传到云存储桶</h2><p id="12d1" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">既然我们已经看到了如何创建云存储桶，我们还可以定义一个函数，让我们将文件上传到我们的桶:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mm mn l"/></div></figure><h2 id="541c" class="lh kl hi bd km li lj lk kq ll lm ln ku jx lo lp kw kb lq lr ky kf ls lt la lu bi translated">C.从云存储桶下载文件到</h2><p id="2e62" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">同样，我们也可以将文件从云存储空间下载到本地机器:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mm mn l"/></div></figure><h2 id="0bdc" class="lh kl hi bd km li lj lk kq ll lm ln ku jx lo lp kw kb lq lr ky kf ls lt la lu bi translated">D.列出云存储桶中的文件</h2><p id="e5a1" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">除了向/从我们的云存储桶上传和下载文件，我们可以定义一个函数'<em class="ly"> list_cs_files </em>'，该函数返回桶中所有文件名的列表:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mm mn l"/></div></figure><h2 id="2b1e" class="lh kl hi bd km li lj lk kq ll lm ln ku jx lo lp kw kb lq lr ky kf ls lt la lu bi translated">E.获取云存储桶中文件的公共URL</h2><p id="db13" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">最后，我们还可以利用API来生成一个可公开访问的链接，该链接指向我们的bucket中的一个文件。出于安全原因，我们需要设置一个URL过期的时间。默认情况下，在如下所示的函数中，这被设置为24小时:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mm mn l"/></div></figure><p id="79ad" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这将返回Python字符串形式的URL，然后您可以与组织外部的任何人共享该字符串。</p></div><div class="ab cl mp mq gp mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="hb hc hd he hf"><p id="3745" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我希望这篇文章对您有所帮助，并且可以帮助您在开始使用云存储API和google-cloud-storage Python包时节省几分钟的时间！🎉下面你会发现一些官方云存储API文档的参考链接。</p><p id="6be3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">欢迎在评论中与我分享你的任何反馈！💬</p></div><div class="ab cl mp mq gp mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="hb hc hd he hf"><h1 id="33fe" class="kk kl hi bd km kn mw kp kq kr mx kt ku io my ip kw ir mz is ky iu na iv la lb bi translated">参考资料:</h1><p id="49c8" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">[1]谷歌云，<a class="ae jn" href="https://cloud.google.com/storage/docs/reference/libraries#client-libraries-install-python" rel="noopener ugc nofollow" target="_blank">云存储客户端库文档</a> (2022)</p><p id="3218" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">[2]谷歌云，<a class="ae jn" href="https://github.com/googleapis/python-storage/tree/05e07f248fc010d7a1b24109025e9230cb2a7259/samples" rel="noopener ugc nofollow" target="_blank">，GitHub“python-storage”代码示例</a> (2022)</p><p id="f02e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">[3]谷歌云，<a class="ae jn" href="https://cloud.google.com/storage" rel="noopener ugc nofollow" target="_blank">云存储</a> (2022)</p></div></div>    
</body>
</html>