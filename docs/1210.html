<html>
<head>
<title>Migrating from Compute Engine to Kubernetes Engine with Migrate for Anthos</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Migrate for Anthos从计算引擎迁移到Kubernetes引擎</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/migrating-from-compute-engine-to-kubernetes-engine-with-migrate-for-anthos-b6fcc5ffb2fa?source=collection_archive---------0-----------------------#2019-11-26">https://medium.com/google-cloud/migrating-from-compute-engine-to-kubernetes-engine-with-migrate-for-anthos-b6fcc5ffb2fa?source=collection_archive---------0-----------------------#2019-11-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="292c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">编辑:这里有一个<a class="ae jd" href="https://codelabs.developers.google.com/codelabs/compute-engine-migrate-for-anthos" rel="noopener ugc nofollow" target="_blank">新的codelab </a>涵盖了这个和下一篇博文！</p><p id="6783" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">手动将现有应用程序重写到Kubernetes并不总是可行的。这就是Migrate for Anthos可以提供帮助的地方，它可以使您现有的应用程序现代化，并让它们在Kubernetes中运行。<strong class="ih hj">你甚至不需要运行Anthos，只需谷歌Kubernetes引擎！</strong></p><p id="dc94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看一个例子，将一个计算引擎实例迁移到运行Migrate for Anthos的Kubernetes引擎集群，从基础开始。在此之后，我们将看看更复杂的例子，如从VMWare或其他云迁移到Kubernetes引擎。在这篇文章中，我们将讨论您的环境的准备工作和要求，如何将计算引擎实例迁移到一个容器中并将其部署在Kubernetes引擎上，并验证迁移是否有效。</p><h1 id="106d" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">做好准备</h1><p id="0b50" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">首先，我们需要确保我们已经满足了<a class="ae jd" href="https://cloud.google.com/migrate/anthos/docs/gce-to-gke-prerequisites" rel="noopener ugc nofollow" target="_blank">的先决条件</a>。基本上，我们的计算实例需要运行受<a class="ae jd" href="https://cloud.google.com/migrate/anthos/docs/compatible-os-versions" rel="noopener ugc nofollow" target="_blank">支持的操作系统</a>。对于我们的例子，我们将坚持使用Ubuntu Server 16.04 LTS实例。这是我们准备迁移的实例。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/3268ca44374f57f09075037f9c0c0426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PLTf8ik8cGd6HjHj"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">当你读到这里的时候，谁知道那个IP会指向什么。不要随便输入IP地址！</figcaption></figure><p id="6c45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个非常简单的“Hello world”服务器，默认安装了nginx。您可以按照<a class="ae jd" href="https://cloud.google.com/compute/docs/quickstart-linux" rel="noopener ugc nofollow" target="_blank">快速入门指南</a>快速设置新实例；如果您想在部署时测试服务器，只需确保使用支持的操作系统并允许http流量。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kx"><img src="../Images/301d7174f0ee9924cd78919b957f15b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kF2SDw4pkLF9hZZn"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">你好网络服务器</figcaption></figure><h2 id="fe66" class="ky jf hi bd jg kz la lb jk lc ld le jo iq lf lg js iu lh li jw iy lj lk ka ll bi translated">创建Kubernetes集群</h2><p id="82ca" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我们还需要一个Kubernetes集群来进行迁移。Migrate for Anthos应用程序也可以部署到现有集群中，但这次我们来看看如何快速设置一个集群。我们可以很快创建一个相当默认的集群，但是如果你想了解更多细节，这里有文档<a class="ae jd" href="https://cloud.google.com/migrate/anthos/docs/configuring-a-cluster" rel="noopener ugc nofollow" target="_blank">。为了让事情变得更简单，我们可以使用</a><a class="ae jd" href="https://cloud.google.com/shell/" rel="noopener ugc nofollow" target="_blank">云外壳</a>来运行gcloud命令，而不需要设置自定义环境。下面是我们需要运行的命令的结构。</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="7d99" class="ky jf hi ln b fi lr ls l lt lu">gcloud container --project <strong class="ln hj">&lt;project-id&gt;</strong> \<br/>clusters create <strong class="ln hj">&lt;gke-cluster-name&gt;</strong> --zone <strong class="ln hj">&lt;gcp-zone&gt;</strong> \<br/>--username "admin" \<br/>--machine-type "<strong class="ln hj">&lt;machine-type&gt;</strong>" \<br/>--image-type "UBUNTU" \<br/>--num-nodes <strong class="ln hj">&lt;number-of-nodes&gt;</strong> \<br/>--enable-stackdriver-kubernetes \<br/>--tags <strong class="ln hj">&lt;network-tags&gt;</strong></span></pre><blockquote class="lv lw lx"><p id="a200" class="if ig ly ih b ii ij ik il im in io ip lz ir is it ma iv iw ix mb iz ja jb jc hb bi translated">您可以使用- cluster-version来选择Kubernetes的特定版本，但是1.13之前的版本<a class="ae jd" href="https://cloud.google.com/migrate/anthos/docs/supported-os-versions#supported_kubernetes_node_versions" rel="noopener ugc nofollow" target="_blank">不被支持</a>。</p></blockquote><p id="2541" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个很大的命令，所以让我们逐行分解它:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="0b01" class="ky jf hi ln b fi lr ls l lt lu">gcloud container --project <strong class="ln hj">&lt;project-id&gt;</strong> \<br/>clusters create <strong class="ln hj">&lt;gke-cluster-name&gt;</strong> --zone <strong class="ln hj">&lt;gcp-zone&gt;</strong> \</span></pre><p id="7c9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在容器API内部，我们将指定项目并创建一个具有我们提供的名称的集群，以及我们在其中创建集群的区域。也有可能<a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/concepts/regional-clusters" rel="noopener ugc nofollow" target="_blank">创建一个区域集群</a>，但是在这个例子中我们将保持事情简单。</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="c4a4" class="ky jf hi ln b fi lr ls l lt lu">--username “admin” \</span></pre><p id="16b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我们为集群身份验证指定默认用户名。</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="ab4e" class="ky jf hi ln b fi lr ls l lt lu">--machine-type “<strong class="ln hj">&lt;machine-type&gt;</strong>” \</span></pre><p id="4b38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">指定的机器类型将用于Kubernetes创建的节点。根据应用程序的不同，可能需要不同类型的机器，但我们可以坚持“n1-standard-4 ”,以确保我们有足够的空间来运行我们的工作负载以及Migrate for Anthos附带的附加服务单元。</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="173b" class="ky jf hi ln b fi lr ls l lt lu">--image-type “UBUNTU” \</span></pre><p id="b757" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这让我们可以选择节点的基本操作系统。我们将坚持使用Ubuntu作为我们的节点，因为它是完全兼容的节点操作系统之一。</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="2a93" class="ky jf hi ln b fi lr ls l lt lu">--num-nodes <strong class="ln hj">&lt;number-of-nodes&gt;</strong> \</span></pre><p id="de1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我们希望集群处理的节点数量。我们将保持简单，现在只创建一个节点。</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="5cc4" class="ky jf hi ln b fi lr ls l lt lu">--enable-stackdriver-kubernetes \</span></pre><p id="cc77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个标志支持通过Stackdriver和Kubernetes集成来记录和监控指标。</p><blockquote class="lv lw lx"><p id="1071" class="if ig ly ih b ii ij ik il im in io ip lz ir is it ma iv iw ix mb iz ja jb jc hb bi translated"><em class="hi">在Kubernetes引擎1.14中，这取代了以前的日志和监控选项。你可以在这里阅读更多关于Kubernetes引擎的</em> <a class="ae jd" href="https://cloud.google.com/monitoring/kubernetes-engine/" rel="noopener ugc nofollow" target="_blank"> <em class="hi"> Stackdriver。</em>T9】</a></p></blockquote><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="bb88" class="ky jf hi ln b fi lr ls l lt lu">--tags <strong class="ln hj">&lt;network-tags&gt;</strong></span></pre><p id="a7b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">标签可以作为逗号分隔的标签列表提供，以应用于每个节点。如果我们设置任何防火墙规则，标记我们的节点将让我们锁定它们。</p><p id="e4ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您正在跟进，您可以更改这些值来帮助匹配您的场景。下面是我们将在示例中运行的命令:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="d40a" class="ky jf hi ln b fi lr ls l lt lu">gcloud beta container --project anthos-migrate-257523 \<br/>clusters create webserver-cluster --zone us-central1-a \<br/>--username "admin" --cluster-version 1.13 \<br/>--machine-type "n1-standard-4" \<br/>--image-type "UBUNTU" \<br/>--num-nodes 1 \<br/>--enable-stackdriver-kubernetes<br/>--tags webserver-cluster</span></pre><blockquote class="lv lw lx"><p id="2028" class="if ig ly ih b ii ij ik il im in io ip lz ir is it ma iv iw ix mb iz ja jb jc hb bi translated">如果您在一个新项目中，您可能需要在运行这个命令之前启用Kubernetes API，例如通过访问控制台中的Kubernetes引擎页面。</p></blockquote><p id="f1d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经运行了该命令，我们可以看到我们的集群已经启动并在控制台中运行。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/ba5e283da37652810e79a1d5bf99aac3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z-Zo3xVPd9goBb7s"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">有了这个更大的节点，我们可以运行webserver应用程序的多个实例</figcaption></figure><p id="0d5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们正在使用Migrate for Anthos，所以我们还需要使用Migrate for Anthos应用程序来准备集群。当我们将web服务器转换为容器化的应用程序时，我们将围绕虚拟机的磁盘快照创建一个容器。我们将在以后的博客中对此进行深入探讨，但现在，让我们通过Google Cloud Marketplace安装Migrate for Anthos。</p><h2 id="c1fa" class="ky jf hi bd jg kz la lb jk lc ld le jo iq lf lg js iu lh li jw iy lj lk ka ll bi translated">为Anthos部署迁移</h2><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mc"><img src="../Images/99b819c9433795b4f33c7bde55ddd473.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qIHFxhzjkjHqqBrF"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">这是任何固定项目下方左侧导航的第一个选项</figcaption></figure><p id="2eb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你不熟悉这个市场，它是创建各种解决方案的一站式商店。您可以在这里快速部署Wordpress实例、LAMP stack服务器、Redis数据库等等。虽然marketplace可以部署在任何地方，从单个计算引擎实例到整个基础设施工具群，但这也是向我们的Kubernetes集群添加一些配置的快捷方式。搜索“Migrate for Anthos ”,然后在下一个屏幕上单击“配置”开始。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/a0a193c1ccfef154ce4622d51efb4b4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7hYGQ-QOVlzC8EZd"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">将来，我们会尝试更多这样的领域</figcaption></figure><p id="f73d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，您可以选择一个集群进行部署。因为我们刚刚经历了设置一个的所有麻烦，所以让我们选择我们的webserver-cluster并暂时将其他字段保留为缺省值。完成后，我们可以在集群中看到一些额外的卷和服务。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es md"><img src="../Images/de163e3df35aa7dbd705e6063f1a9601.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XvfEPSfFUlbso_qv"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">我们的webserver应用程序不在这里，但我们将在下一步中这样做</figcaption></figure><h1 id="5043" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">将虚拟机迁移到新容器</h1><p id="4b30" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在我们已经有了Kubernetes集群和计算实例，我们可以开始实际的迁移过程了。简而言之，我们将使用Migrate for Anthos来创建一个Kubernetes部署，该部署使用实例磁盘的克隆。让我们回到我们方便的云Shell，确保我们可以生成部署实例所需的YAML文件。</p><p id="900c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cloud Shell已经包含了pyyaml，但是如果您需要它，只需运行以下命令:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="dcd1" class="ky jf hi ln b fi lr ls l lt lu">pip3 install --user pyyaml</span></pre><p id="6634" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们需要停止实例，因为我们需要克隆磁盘。同样，一个简单的gcloud命令可以为我们解决这个问题:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="7b63" class="ky jf hi ln b fi lr ls l lt lu">gcloud compute instances stop <strong class="ln hj">&lt;instance-id&gt; --</strong>zone <strong class="ln hj">&lt;gcp-zone&gt;</strong></span></pre><p id="4a73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者以我们的例子为例:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="01df" class="ky jf hi ln b fi lr ls l lt lu">gcloud compute instances stop webserver --zone us-central1-a</span></pre><p id="9cff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为这只是一个例子，所以我们很容易停止服务器。根据您环境中运行的内容和您的业务需求，这可能需要进行大量规划和安排维护窗口，以确保正确处理停机时间。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es me"><img src="../Images/1667abb27298c28f27f2eacc8e9fc21d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zBTZmUVMjiA_5UEj"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">这很像第一个截图，但是实例被停止了</figcaption></figure><p id="777d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实例停止后，我们可以使用这个Migrate for Anthos脚本安全地克隆磁盘。下面是我们实现这一点的便捷命令:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="1ce9" class="ky jf hi ln b fi lr ls l lt lu">python3 /google/migrate/anthos/gce-to-gke/clone_vm_disks.py \<br/>-p <strong class="ln hj">&lt;project-id&gt;</strong> \<br/>-z <strong class="ln hj">&lt;instance-gcp-zone&gt;</strong> \<br/>-T <strong class="ln hj">&lt;cluster-gcp-zone&gt;</strong> \<br/>-i <strong class="ln hj">&lt;instance-id&gt;</strong> \<br/>-A <strong class="ln hj">&lt;workload-name&gt;</strong> \<br/>-o <strong class="ln hj">&lt;yaml-filename&gt;</strong></span></pre><p id="0784" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们再分解一下:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="c4c4" class="ky jf hi ln b fi lr ls l lt lu">python3 /google/migrate/anthos/gce-to-gke/clone_vm_disks.py \</span></pre><p id="6d30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是运行Migrate for Anthos clone脚本，我们将使用所需的参数对其进行配置。结果输出将是一个YAML文件，我们可以应用到我们的集群。</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="436b" class="ky jf hi ln b fi lr ls l lt lu">-p <strong class="ln hj">&lt;project-id&gt;</strong> \</span></pre><p id="73d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">指定我们正在进行的项目。</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="e579" class="ky jf hi ln b fi lr ls l lt lu">-z <strong class="ln hj">&lt;instance-gcp-zone&gt;</strong> \</span></pre><p id="7c48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我们停止的计算实例所在的区域。</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="1651" class="ky jf hi ln b fi lr ls l lt lu">-T <strong class="ln hj">&lt;cluster-gcp-zone&gt;</strong> \</span></pre><p id="6b64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我们的Kubernetes引擎集群所在的目标区域。对于我们的示例，我们将计算实例和Kubernetes集群放在同一个区域中。</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="10e6" class="ky jf hi ln b fi lr ls l lt lu">-i <strong class="ln hj">&lt;instance-id&gt;</strong> \</span></pre><p id="4a89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里，我们为停止的计算实例提供标识符；与我们在运行命令停止实例时提供的相同。</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="a186" class="ky jf hi ln b fi lr ls l lt lu">-A <strong class="ln hj">&lt;workload-name&gt;</strong> \</span></pre><p id="6fd2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将指定我们希望应用程序启动时使用的名称。我们将把它命名为“webserver-container ”,这样我们就知道它不同于webserver。</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="073a" class="ky jf hi ln b fi lr ls l lt lu">-o <strong class="ln hj">&lt;yaml-filename&gt;</strong></span></pre><p id="b191" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是将要生成的YAML文件的名称，我们将在下一步中用到它。</p><p id="990b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，对于我们的示例，下面是我们将运行的命令:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="0d75" class="ky jf hi ln b fi lr ls l lt lu">python3 /google/migrate/anthos/gce-to-gke/clone_vm_disks.py \<br/>-p anthos-migrate-257523 \<br/>-z us-central1-a \<br/>-T us-central1-a \<br/>-i webserver \<br/>-A webserver-container \<br/>-o containerized-webserver.yaml</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mf"><img src="../Images/69e84c807b6399ab1f30c39ead5151cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oDyNvHaWpLB9amS6"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">成功的集装箱化</figcaption></figure><p id="9aa3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样，我们现在有了一个从我们的计算实例克隆的新磁盘，以及一个描述Kubernetes的<a class="ae jd" href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" rel="noopener ugc nofollow" target="_blank"> StatefulSet </a>的YAML文件。从这里开始，我们的下一步是将它应用到我们的集群中，这可以很容易地用kubectl来完成。</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="1b9e" class="ky jf hi ln b fi lr ls l lt lu">kubectl apply -f <strong class="ln hj">&lt;yaml-filename&gt;</strong></span></pre><p id="ee44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者以我们的例子为例:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="1d4b" class="ky jf hi ln b fi lr ls l lt lu">kubectl apply -f containerized-webserver.yaml</span></pre><p id="618f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">至此，我们的计算引擎实例在Kubernetes引擎中启动并运行！</p><h1 id="8ffb" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">确保它有效</h1><p id="e2be" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">转到Kubernetes引擎中的workloads页面，webserver-container被列出，其状态为OK！</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mg"><img src="../Images/373ead551a5799350d7abd66118dd8de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gS6f0MEOSB-fXhNC"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">绿色复选标记越多越好</figcaption></figure><p id="62a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，通过实际操作，可能更容易看出app是否真的在运行。因为这只是一个简单的web服务器，所以我们需要做的就是用一个负载平衡器来公开它。这里有一个快速YAML文件，为我们提供一个IP来检查我们的应用程序:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="1d92" class="ky jf hi ln b fi lr ls l lt lu">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: webserver-container<br/>spec:<br/>  type: LoadBalancer<br/>  selector:<br/>    app: webserver-container<br/>  ports:<br/>  - protocol: TCP<br/>    port: 80<br/>    targetPort: 80</span></pre><p id="83a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将上述代码保存为文件，并应用于:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="51a3" class="ky jf hi ln b fi lr ls l lt lu">kubectl apply -f <strong class="ln hj">&lt;yaml-filename&gt;</strong></span></pre><p id="9dc6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建服务后，您可以在Kubernetes引擎页面中找到它和IP，或者通过运行:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="c95b" class="ky jf hi ln b fi lr ls l lt lu">kubectl get services</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/cf3a63eb70f4bdd9d98a07ddbe48d7cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8PhXZC_Um4cp5ih0"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">记住我之前说的，不要去随便点击IP！</figcaption></figure><p id="fe76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们知道了负载平衡器IP，我们可以在浏览器中访问它，并看到web服务器确实启动并运行了。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kx"><img src="../Images/d43b9dabda5e26662e0ab9895bd3ee3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FaD0yXT9Tt9_oxV6"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">它看起来一样，因为它是！</figcaption></figure><h2 id="6178" class="ky jf hi bd jg kz la lb jk lc ld le jo iq lf lg js iu lh li jw iy lj lk ka ll bi translated">访问您的实例</h2><p id="57d0" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">使用虚拟机的一个便利之处是能够SSH到虚拟机中。幸运的是，在使用Migrate for Anthos时，我们没有丢失这一点。为了访问它，我们将使用kubectl exec。首先，我们需要pod的名称。通过键入以下快速命令:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="152a" class="ky jf hi ln b fi lr ls l lt lu">kubectl describe pods | grep Name</span></pre><p id="c030" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以看到我们的豆荚的名字是:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="9f35" class="ky jf hi ln b fi lr ls l lt lu">Name: webserver-container-0</span></pre><p id="dd54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了这个pod名称，我们只需键入以下命令，就可以在我们的云Shell中打开我们的连接:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="e826" class="ky jf hi ln b fi lr ls l lt lu">kubectl exec -it <strong class="ln hj">&lt;pod-name&gt;</strong> — /bin/bash</span></pre><p id="2d19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们的案例中:</p><pre class="ki kj kk kl fd lm ln lo lp aw lq bi"><span id="8ff8" class="ky jf hi ln b fi lr ls l lt lu">kubectl exec -it webserver-container-0 — /bin/bash</span></pre><h1 id="5837" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">包扎</h1><p id="cd84" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">需要注意的一点是，这个应用是我们在一个容器内运行的整个虚拟机。然而，这也是容器中经常不需要的大量VM膨胀的原因。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/1b5fffe53496b4e16d032dfeb69fb66c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nsLgsKxRKBP-HlA_"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">容器中的进程比您预期的要多得多</figcaption></figure><p id="64ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是为什么它可能被称为“系统容器”而不是“应用程序容器”,也是为什么它不能完全取代现代化。Migrate for Anthos是一个很好的方法，可以帮助您整合和现代化一些遗留应用程序，并开始一个更大的现代化计划。根据你的计划，下一步可能是开始将你的应用拆分成微服务或更小的容器。</p><p id="90d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，如果您需要对应用程序进行更新，您会希望使用任何现有的构建过程来修改运行新容器的应用程序。例如，您仍然可以运行apt-get update，就像您的应用程序在虚拟机上运行一样。</p><p id="82b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随着我们的计算引擎应用程序迁移到Kubernetes引擎，我们的下一篇博文将更多地讨论<a class="ae jd" rel="noopener" href="/google-cloud/monitoring-workloads-migrated-with-migrate-for-anthos-4c5542573767">在Kubernetes引擎</a>中监控您的应用程序。敬请期待！</p></div></div>    
</body>
</html>