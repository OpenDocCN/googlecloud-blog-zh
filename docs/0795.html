<html>
<head>
<title>Simplifying Granular Access Control on Kubernetes(GKE) Using IAM and RBAC</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用IAM和RBAC简化Kubernetes(GKE)上的粒度访问控制</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/simplifying-granular-access-control-on-kubernetes-gke-using-iam-and-rbac-19a627e3aa18?source=collection_archive---------0-----------------------#2018-10-19">https://medium.com/google-cloud/simplifying-granular-access-control-on-kubernetes-gke-using-iam-and-rbac-19a627e3aa18?source=collection_archive---------0-----------------------#2018-10-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5061" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Kubernetes Engine(GKE)是由Google Cloud Platform提供的托管Kubernetes引擎，是易于使用的生产级服务，能够立即创建和运行K8s集群。GKE的访问控制与云身份和访问管理(IAM)很好地集成在一起，后者抽象了对Kubernetes集群资源的授权和认证。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/f98af6f19902340281434ae3908e99c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s3SfHFu0tszfPURFr9mOFQ.jpeg"/></div></div></figure><p id="5a33" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">适用于GKE的Cloud IAM上的几个角色是:</p><ul class=""><li id="ecfe" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">GKE管理</li><li id="ca55" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">GKE开发商</li><li id="f1ff" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">GKE观察报</li><li id="1a7e" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">GKE集群管理</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kd"><img src="../Images/e1e67ca1e96e44e2cf58f12b6dde8439.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e-p09dddqivqn9DBt18vdQ.png"/></div></div></figure><p id="cc4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是云IAM仍然不足以进行粒度访问控制，因为IAM工作在项目级，不能管理对名称空间级的访问。例如，如果我们必须授予用户查看pods日志、编辑部署、编辑配置图的权限，则IAM无法控制这一级别。为此，我们需要RBAC(基于角色的访问控制)。但是如果我们结合使用云IAM和RBAC，我们可以配置安全的方式进行认证和授权。</p><p id="33cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我将考虑授予Kubernetes pod日志查看器对google帐户(G Suite或Gmail或服务帐户)的访问权限的情况，该帐户具有集群凭据的Cloud IAM身份验证和对同一帐户(电子邮件)的仅日志查看权限的RBAC。</p><h2 id="b4f8" class="ke kf hi bd kg kh ki kj kk kl km kn ko iq kp kq kr iu ks kt ku iy kv kw kx ky bi translated">创建新的集群</h2><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="2944" class="ke kf hi la b fi le lf l lg lh">gcloud container clusters create mycluster --zone us-central1-b</span></pre><h2 id="f3f4" class="ke kf hi bd kg kh ki kj kk kl km kn ko iq kp kq kr iu ks kt ku iy kv kw kx ky bi translated">Kubernetes认证和IAM</h2><p id="0a49" class="pw-post-body-paragraph if ig hi ih b ii li ik il im lj io ip iq lk is it iu ll iw ix iy lm ja jb jc hb bi translated">目前，GKE有三种Kubernetes认证方式:</p><ul class=""><li id="3ccf" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">使用谷歌账户</li><li id="c7f4" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">使用谷歌云平台(GCP)服务账户</li><li id="a5c8" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">使用Kubernetes服务帐户</li></ul><p id="c458" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我们将讨论前两种方法。</p><p id="46bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们在Cloud IAM中添加一个google帐户，并授予<strong class="ih hj">对Kubernetes引擎资源</strong>的只读访问权限。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ln"><img src="../Images/afe4a1cb4a2a0b763333a58f89238d0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*qToVkeK3A_-2RsiGFPG7Ug.png"/></div></figure><p id="9d70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同样，如果我们需要授权访问服务帐户，我们必须从<a class="ae lo" href="https://console.cloud.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank"> IAM服务帐户</a>页面为项目创建一个服务帐户，并在创建帐户时添加角色。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lp"><img src="../Images/ba89799d7c8c2cad31543820898e273d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YMfZigUIO8MH4uTY3cwHfg.png"/></div></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lq"><img src="../Images/e2decff8caf46fe8f187397d015af7ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*li_jQ9Ol_gkh51k3iZMc_Q.png"/></div></div></figure><h2 id="1b8f" class="ke kf hi bd kg kh ki kj kk kl km kn ko iq kp kq kr iu ks kt ku iy kv kw kx ky bi translated">g云认证</h2><p id="d3e8" class="pw-post-body-paragraph if ig hi ih b ii li ik il im lj io ip iq lk is it iu ll iw ix iy lm ja jb jc hb bi translated">对于一个google帐户，gcloud sdk可以通过简单的命令<code class="du lr ls lt la b">gcloud auth login</code>进行身份验证，该命令通过基于web的授权流获得凭证。</p><p id="4c68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于服务帐户，我们首先激活帐户</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="60ac" class="ke kf hi la b fi le lf l lg lh">gcloud auth activate-service-account [ACCOUNT EMAIL] --key-file=KEY_FILE</span></pre><h2 id="f5ef" class="ke kf hi bd kg kh ki kj kk kl km kn ko iq kp kq kr iu ks kt ku iy kv kw kx ky bi translated">获取集群凭据</h2><p id="a246" class="pw-post-body-paragraph if ig hi ih b ii li ik il im lj io ip iq lk is it iu ll iw ix iy lm ja jb jc hb bi translated">获取正在运行的集群<code class="du lr ls lt la b">mycluster</code>在<code class="du lr ls lt la b">us-central1-b</code>区域的凭证的时间。</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="d6d1" class="ke kf hi la b fi le lf l lg lh">gcloud container clusters get-credentials mycluster --zone us-central1-b</span></pre><p id="b984" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确认集群访问</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="d6f3" class="ke kf hi la b fi le lf l lg lh">kubectl get pods --all-namespaces</span></pre><h2 id="e9d2" class="ke kf hi bd kg kh ki kj kk kl km kn ko iq kp kq kr iu ks kt ku iy kv kw kx ky bi translated">库伯内特RBAC的时间到了</h2><p id="b523" class="pw-post-body-paragraph if ig hi ih b ii li ik il im lj io ip iq lk is it iu ll iw ix iy lm ja jb jc hb bi translated">基于角色的访问控制(RBAC)是一种根据集群中的角色使用适当的权限来管理对Kubernetes资源的访问的方法。为了在名称空间中向用户授予仅日志查看器访问权限，我们需要创建角色和角色绑定。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lu"><img src="../Images/be44b9889d14096eac729e7d5b8c640f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ZwaXQmvDn3mRZchlrrrDA.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx translated"><a class="ae lo" href="https://gist.github.com/dwdraju/60fdffecae03440313922d0eaba56f9d" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/dwdraju/60 fdffecae 03440313922d 0 eaba 56 f 9d</a></figcaption></figure><p id="70aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用google帐户ID或服务帐户更改<code class="du lr ls lt la b">name</code>,并应用清单。</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="39dc" class="ke kf hi la b fi le lf l lg lh">kubectl apply -f k8s-log-viewer-role.yml</span></pre><p id="4f1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，用户只能查看日志和列表窗格。</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="546a" class="ke kf hi la b fi le lf l lg lh">kubectl logs [pod-name]</span></pre><p id="e8b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样，我们可以通过与Google Cloud IAM集成，为用户提供对Kubernetes资源的细粒度访问。</p></div></div>    
</body>
</html>