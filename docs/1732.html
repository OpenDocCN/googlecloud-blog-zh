<html>
<head>
<title>AI Platform Notebooks “headless” Training</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AI平台笔记本“无头”训练</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/ai-platform-notebooks-headless-training-b8efd905dfaf?source=collection_archive---------1-----------------------#2020-12-27">https://medium.com/google-cloud/ai-platform-notebooks-headless-training-b8efd905dfaf?source=collection_archive---------1-----------------------#2020-12-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="3586" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">比谷仓院子里的鸡更不容易引发</h2></div><p id="fe71" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae jt" href="https://cloud.google.com/ai-platform-notebooks" rel="noopener ugc nofollow" target="_blank"> AI平台笔记本</a>提供托管的JupyterLab笔记本实例，这是一个熟悉的工具，用于实验、开发和将模型部署到生产中。</p><p id="f049" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">缺失的部分是生产培训模型；这通常比最初的实验或产量预测要长得多。您进行实验的交互式笔记本可能不适合这样做:浏览器会话超时，连接丢失，图像渲染冻结，实例大小不适合训练。</p><p id="e1dc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本文主要关注以无头方式运行培训的两种方法:</p><ul class=""><li id="09e1" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated"><a class="ae jt" href="https://cloud.google.com/ai-hub" rel="noopener ugc nofollow" target="_blank">AI Hub</a>JupyterLab VM:paper mill</li><li id="8311" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated"><a class="ae jt" href="https://cloud.google.com/ai-platform/training/docs/training-jobs" rel="noopener ugc nofollow" target="_blank"> AI平台培训</a></li></ul><h1 id="5ce2" class="ki kj hi bd kk kl km kn ko kp kq kr ks io kt ip ku ir kv is kw iu kx iv ky kz bi translated">人工智能中心JupyterLab虚拟机:造纸厂</h1><p id="02ad" class="pw-post-body-paragraph ix iy hi iz b ja la ij jc jd lb im jf jg lc ji jj jk ld jm jn jo le jq jr js hb bi translated"><a class="ae jt" href="https://papermill.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> Papermill </a>是一款以多种不同方式<a class="ae jt" href="https://cloud.google.com/blog/products/ai-machine-learning/let-deep-learning-vms-and-jupyter-notebooks-to-burn-the-midnight-oil-for-you-robust-and-automated-training-with-papermill" rel="noopener ugc nofollow" target="_blank">参数化和执行Jupyter笔记本的工具</a>，包括启动虚拟机。</p><p id="79e8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">其中之一是从笔记本虚拟机的命令行提交笔记本:这利用了您已经用AI库配置的自定义虚拟机配置，同时绕过了与在笔记本UI中呈现结果相关联的潜在冻结问题。笔记本电脑虚拟机还预装了Papermill，因此无需额外配置。</p><ul class=""><li id="5ea9" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">如果你想使用Papermill在单独的虚拟机上运行，<a class="ae jt" href="https://cloud.withgoogle.com/next/sf/sessions?session=MLAI212" rel="noopener ugc nofollow" target="_blank">这个位于TPU的Next 2019演讲</a>将带你了解这一场景。</li></ul><p id="3b8a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以从虚拟机的<a class="ae jt" href="http://cloud.google.com/console/compute/instances" rel="noopener ugc nofollow" target="_blank">云控制台- &gt;计算引擎- &gt;虚拟机实例</a> - &gt; SSH选项访问命令行，也可以从笔记本本身访问命令行；前者排除了笔记本用户界面的潜在问题。您可以在浏览器窗口中打开SSH会话，或者在专用客户端中打开SSH会话以获得额外的状态持久性。</p><h2 id="50b1" class="lf kj hi bd kk lg lh li ko lj lk ll ks jg lm ln ku jk lo lp kw jo lq lr ky ls bi translated">参数化</h2><p id="dbd4" class="pw-post-body-paragraph ix iy hi iz b ja la ij jc jd lb im jf jg lc ji jj jk ld jm jn jo le jq jr js hb bi translated">您可以<a class="ae jt" href="https://papermill.readthedocs.io/en/latest/usage-parameterize.html" rel="noopener ugc nofollow" target="_blank">参数化</a>您的笔记本，以便在运行时将可变信息(如纪元数)传递到笔记本中。在标有“参数”关键字的单元格中设置默认参数，并在训练或其他步骤中引用这些参数；无论您在命令行上指定什么，这些都会被覆盖。</p><p id="482b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，带有epochs参数的笔记本的命令行:</p><figure class="lt lu lv lw fd lx"><div class="bz dy l di"><div class="ly lz l"/></div></figure><h2 id="065a" class="lf kj hi bd kk lg lh li ko lj lk ll ks jg lm ln ku jk lo lp kw jo lq lr ky ls bi translated">执行</h2><p id="f5e9" class="pw-post-body-paragraph ix iy hi iz b ja la ij jc jd lb im jf jg lc ji jj jk ld jm jn jo le jq jr js hb bi translated">运行该命令时，指定一个输出笔记本；所有中间结果、记录等。都记录在这里。包括<a class="ae jt" href="https://papermill.readthedocs.io/en/latest/usage-cli.html" rel="noopener ugc nofollow" target="_blank">日志输出标志</a>以将笔记本输出写入stderr(即终端窗口)</p><p id="338f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，如果终端关闭，这会终止SSH会话，默认情况下，会终止在其中运行的任何笔记本，包括无头笔记本。</p><p id="ef68" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">如果终端关闭，继续执行</strong></p><p id="5f49" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要在终端会话关闭时继续执行，请使用如下命令序列之一:</p><figure class="lt lu lv lw fd lx"><div class="bz dy l di"><div class="ly lz l"/></div></figure><figure class="lt lu lv lw fd lx"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="c48c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这些命令显示进程id (pid ),并将stderr和stdout分别重定向到nohup.out或~/output.txt。</p><p id="2d89" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以从output记事本监视正在运行的进程，也可以使用以下命令从新的终端会话监视正在运行的进程:</p><figure class="lt lu lv lw fd lx"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="914a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，重定向stdout和stderr会引发以下错误；这不会影响笔记本执行或日志记录:</p><ul class=""><li id="5013" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated"><em class="ma">属性错误:“NoneType”对象没有属性“send _ multipart”</em></li></ul><p id="977b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更多背景信息请点击此处:</p><ul class=""><li id="a221" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated"><a class="ae jt" href="https://unix.stackexchange.com/questions/4004/how-can-i-run-a-command-which-will-survive-terminal-close#4006" rel="noopener ugc nofollow" target="_blank">终端关闭后继续运行的命令</a></li><li id="2add" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">【nohup、disown和&amp;T11的区别】</li></ul><h1 id="34d3" class="ki kj hi bd kk kl km kn ko kp kq kr ks io kt ip ku ir kv is kw iu kx iv ky kz bi translated">人工智能平台培训</h1><p id="8b27" class="pw-post-body-paragraph ix iy hi iz b ja la ij jc jd lb im jf jg lc ji jj jk ld jm jn jo le jq jr js hb bi translated">这种方法是基于创建一个Docker映像，在基础Tensorflow映像之上分层放置您的库，然后将其部署到<a class="ae jt" href="https://cloud.google.com/ai-platform/training/docs/training-jobs" rel="noopener ugc nofollow" target="_blank"> AI平台培训</a>；您还可以在本地运行映像进行测试。这样做的好处是，能够以不同于笔记本电脑环境的方式调整培训环境的规模，并在不影响作业执行的情况下自然关闭终端会话；您可以在<a class="ae jt" href="http://cloud.google.com/console/ai-platform/jobs" rel="noopener ugc nofollow" target="_blank">云控制台</a>中跟踪作业执行情况；日志被写入Stackdriver。</p><p id="d026" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将模型权重存储在Google云存储中，作为训练和预测步骤之间的链接；注意，你也可以<a class="ae jt" href="https://www.tensorflow.org/beta/guide/keras/saving_and_serializing#whole-model_saving" rel="noopener ugc nofollow" target="_blank">保存整个模型</a>，而不仅仅是<a class="ae jt" href="https://www.tensorflow.org/guide/keras/save_and_serialize#weights-only_saving" rel="noopener ugc nofollow" target="_blank">权重</a>；所选择的方法将取决于您的用例。</p><h2 id="721e" class="lf kj hi bd kk lg lh li ko lj lk ll ks jg lm ln ku jk lo lp kw jo lq lr ky ls bi translated">参数化</h2><p id="fdfe" class="pw-post-body-paragraph ix iy hi iz b ja la ij jc jd lb im jf jg lc ji jj jk ld jm jn jo le jq jr js hb bi translated">如前所述，您可以参数化执行，例如，用历元数。</p><h2 id="78d3" class="lf kj hi bd kk lg lh li ko lj lk ll ks jg lm ln ku jk lo lp kw jo lq lr ky ls bi translated">样本脚本</h2><figure class="lt lu lv lw fd lx"><div class="bz dy l di"><div class="ly lz l"/></div></figure><h2 id="b076" class="lf kj hi bd kk lg lh li ko lj lk ll ks jg lm ln ku jk lo lp kw jo lq lr ky ls bi translated">执行</h2><p id="e857" class="pw-post-body-paragraph ix iy hi iz b ja la ij jc jd lb im jf jg lc ji jj jk ld jm jn jo le jq jr js hb bi translated">在您的虚拟机上逐步完成上面概述的步骤，或者作为bash脚本运行所有步骤。您需要在运行VM的项目中创建自己的GCS bucket如果您适当地配置服务帐户，这个GCS存储桶可以位于不同的虚拟机上。</p><p id="376a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您选择运行可选的本地培训测试步骤，您的虚拟机将需要一个GPU。</p><h2 id="d828" class="lf kj hi bd kk lg lh li ko lj lk ll ks jg lm ln ku jk lo lp kw jo lq lr ky ls bi translated">检查站</h2><p id="0283" class="pw-post-body-paragraph ix iy hi iz b ja la ij jc jd lb im jf jg lc ji jj jk ld jm jn jo le jq jr js hb bi translated">为了在作业期间支持更好的故障恢复，您可以实现<a class="ae jt" href="https://www.tensorflow.org/beta/guide/checkpoints" rel="noopener ugc nofollow" target="_blank">检查点</a>；这个Keras示例演示了对历元的检查点操作。</p></div></div>    
</body>
</html>