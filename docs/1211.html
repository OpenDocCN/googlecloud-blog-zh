<html>
<head>
<title>Building Artifacts on the Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在云上构建工件</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/building-artifacts-on-the-cloud-adb577662b3?source=collection_archive---------0-----------------------#2019-12-01">https://medium.com/google-cloud/building-artifacts-on-the-cloud-adb577662b3?source=collection_archive---------0-----------------------#2019-12-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/220e5290954221dad4610b28c3f840e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vFjgQlJxfgSTefwCEkNUMw.jpeg"/></div></div></figure><p id="0471" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">软件开发人员经常构建工件(Docker容器、WAR文件、APK包等)。)来自代码。</p><p id="7c9b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这通常需要可靠的互联网连接、高处理能力、足够的存储空间、不断升级的构建工具等等。</p><p id="79b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">可以发布构建的工件，例如将容器部署到云或者在Play store上托管APK文件。然而，这也包括手动或在本地机器上完成时可能很困难的步骤。</p><p id="1dfd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本教程中，您将使用下面的例子，利用<a class="ae jo" href="https://cloud.google.com/cloud-build/" rel="noopener ugc nofollow" target="_blank">云构建</a>在云上极其快速地构建工件:</p><ul class=""><li id="121e" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">构建容器工件并存储在容器注册表中。</li><li id="2f33" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">构建非容器工件并存储在云存储上。</li><li id="9b59" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">使用云构建触发器从存储库中自动化构建。</li></ul><h1 id="ab45" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">云构建</h1><p id="727b" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/cloud-build" rel="noopener ugc nofollow" target="_blank">云构建</a>是一项在谷歌云平台基础设施上执行构建的服务。</p><p id="da44" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以编写构建配置来为云构建提供关于要执行哪些任务的说明，并且可以使用<a class="ae jo" href="https://github.com/GoogleCloudPlatform/cloud-builders" rel="noopener ugc nofollow" target="_blank">云构建</a>、<a class="ae jo" href="https://github.com/GoogleCloudPlatform/cloud-builders-community" rel="noopener ugc nofollow" target="_blank">云构建社区</a>提供的构建步骤/构建器，或者编写您自己的<a class="ae jo" href="https://cloud.google.com/cloud-build/docs/create-custom-build-steps" rel="noopener ugc nofollow" target="_blank">自定义构建步骤/构建器</a>。</p><p id="016a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云构建每天免费提供前120分钟的构建时间。<br/>您可以通过<a class="ae jo" href="https://console.cloud.google.com/cloud-build/builds" rel="noopener ugc nofollow" target="_blank">为您的<a class="ae jo" href="https://console.cloud.google.com/project" rel="noopener ugc nofollow" target="_blank"> GCP项目</a>启用云构建</a>来简单地开始。</p><p id="6b45" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">开始之前，请确保您已经安装了Cloud <a class="ae jo" href="https://cloud.google.com/sdk/docs/" rel="noopener ugc nofollow" target="_blank"> SDK </a>或<a class="ae jo" href="https://cloud.google.com/shell" rel="noopener ugc nofollow" target="_blank"> Cloud Shell </a>。</p><h1 id="7f9b" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">将Docker容器构建到容器注册表</h1><p id="eff1" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">Cloud Build允许您构建Docker映像并将构建的映像推送到容器注册表。</p><p id="f58c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以在这里和下面的<em class="lg"> Dockerfile </em>获得我的<em class="lg">集装箱式烧瓶应用</em>的示例源代码:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="5144" class="lq ke hi lm b fi lr ls l lt lu">FROM python:3.7-stretch<br/>RUN apt-get update -y<br/>RUN apt-get install -y python-pip python-dev build-essential<br/>COPY . /app<br/>WORKDIR /app<br/>RUN pip install -r requirements.txt<br/>ENTRYPOINT ["python"]<br/>CMD ["app.py"]<!-- --> </span></pre><p id="6001" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在您的项目根目录下应该有一个<em class="lg"> Dockerfile </em>，然后您可以运行下面的命令在云上构建，这也将您的Docker容器发布到容器注册表。</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="fda1" class="lq ke hi lm b fi lr ls l lt lu">gcloud builds submit --tag gcr.io/[PROJECT_ID]/my-image .</span></pre><p id="f380" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您刚刚使用Docker文件构建了一个名为<strong class="is hj"> my-image </strong>的Docker映像，并将该映像推送到容器注册表中。</p><p id="ec0b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您还可以使用构建配置文件<code class="du lv lw lx lm b">cloudbuild.yaml</code>在云上构建，该文件创建在项目根目录下，内容如下:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="4b34" class="lq ke hi lm b fi lr ls l lt lu">steps:<br/>- name: 'gcr.io/cloud-builders/docker'<br/>  args: [ 'build', '-t', 'gcr.io/[PROJECT_ID]/my-image', '.' ]<br/>images:<br/>- 'gcr.io/[PROJECT_ID]/my-image'</span></pre><p id="4e16" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后使用以下命令触发构建:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="cfda" class="lq ke hi lm b fi lr ls l lt lu">gcloud builds submit --config cloudbuild.yaml .</span></pre><p id="575e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意:</p><ul class=""><li id="6459" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><code class="du lv lw lx lm b">[PROJECT_ID]</code>应替换为您的实际项目ID。</li><li id="3e67" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du lv lw lx lm b">.</code>用于对当前工作目录进行编译时。</li><li id="3296" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">您可以使用<code class="du lv lw lx lm b">:</code>为您的图像指定其他标签，例如<code class="du lv lw lx lm b">my-image:dev</code>，也可以为更大的图像指定更长的超时时间，例如<code class="du lv lw lx lm b">--timeout=600s</code></li></ul><h1 id="cc27" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">将非容器工件构建到云存储</h1><p id="e9b0" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">云构建支持<a class="ae jo" href="https://cloud.google.com/cloud-build/docs/cloud-builders" rel="noopener ugc nofollow" target="_blank">构建器</a>，您可以参考这些构建器来执行特定任务，如<em class="lg"> npm、go、gradle、gradle等</em>。</p><p id="763b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，我会使用一个<a class="ae jo" href="https://gcr.io/fullstackgcp/gradle" rel="noopener ugc nofollow" target="_blank">定制的gradle builder </a>来构建一个Android项目APK，然后启用Cloud Build将工件存储到一个云存储桶中。</p><p id="6e00" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以从这里获得我的Android应用程序<a class="ae jo" href="https://github.com/Timtech4u/gcb-android-tutorial" rel="noopener ugc nofollow" target="_blank">的示例源代码，以及下面的修改后的构建配置文件<code class="du lv lw lx lm b">cloudbuild.yaml</code>:</a></p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="fe0f" class="lq ke hi lm b fi lr ls l lt lu">steps:<br/># Set a persistent volume according to https://cloud.google.com/cloud-build/docs/build-config (search for volumes)<br/>- name: 'ubuntu'<br/>  volumes:<br/>  - name: 'vol1'<br/>    path: '/persistent_volume'<br/>  args: ['cp', '-a', '.', '/persistent_volume']<br/>  <br/># Build APK with Gradle Image from mounted /persistent_volume using name: vol1<br/>- name: 'gcr.io/cloud-builders/docker'<br/>  volumes:<br/>  - name: 'vol1'<br/>    path: '/persistent_volume'<br/>  args: ['run', '-v', 'vol1:/home/app', '--rm', 'gcr.io/fullstackgcp/gradle', '/bin/sh', '-c', 'cd /home/app &amp;&amp; ./gradlew clean assembleDebug']</span><span id="b383" class="lq ke hi lm b fi ly ls l lt lu"># Push the APK file from vol1 to your GCS Bucket.<br/>artifacts:<br/>  objects:<br/>    location: 'gs://[STORAGE_LOCATION]/'<br/>    paths: ['*.apk']<br/></span><span id="d010" class="lq ke hi lm b fi ly ls l lt lu">timeout: 1200s</span></pre><p id="60e6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后使用以下命令触发构建:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="fa1f" class="lq ke hi lm b fi lr ls l lt lu">gcloud builds submit --config cloudbuild.yaml .</span></pre><p id="a589" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意:</p><ul class=""><li id="9b92" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">[存储位置]表示您的云存储桶的路径。</li><li id="acb2" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du lv lw lx lm b">gcr.io/fullstackgcp/gradle</code>是gradle builder</li><li id="0578" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="https://cloud.google.com/cloud-build/docs/securing-builds/configure-access-control" rel="noopener ugc nofollow" target="_blank">云构建服务账号</a>应该有权限写云存储或者那个桶是公开开放的。</li></ul><h1 id="caa6" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">自动化构建</h1><p id="e334" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">Cloud Build可以从Google Cloud Storage、Cloud Source Repositories、GitHub或Bitbucket导入源代码，按照您的规范执行构建，并生成工件。</p><p id="3644" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将继续创建一个触发器，它监听我们的源代码中特定分支上的更改，并在我们的cloudbuild.yaml配置文件中执行操作。</p><ul class=""><li id="2b7d" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">打开<a class="ae jo" href="https://console.cloud.google.com/cloud-build/triggers" rel="noopener ugc nofollow" target="_blank">云构建触发器页面</a></li><li id="ef10" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">点击<strong class="is hj">连接储存库</strong></li><li id="f673" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">选择你的<strong class="is hj">源代码选项</strong>和<strong class="is hj">继续</strong>。</li><li id="82e7" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><strong class="is hj">验证</strong>并创建<strong class="is hj">具有所需输入的按压触发器</strong>。</li></ul><figure class="lh li lj lk fd ij er es paragraph-image"><div class="er es lz"><img src="../Images/fb4839ae64046f5ddf554ff6d586fa6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/0*1yEt-gMa5RKcQBd8.png"/></div></figure><p id="2edd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上面是一个示例云构建触发页面。</p><p id="f32c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以在<a class="ae jo" href="https://console.cloud.google.com/cloud-build/builds" rel="noopener ugc nofollow" target="_blank">历史页面</a>上监控构建触发器</p><p id="8dde" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想了解在哪里部署你的工件，请查看<a class="ae jo" href="https://github.com/Timtech4u/gcp_compute_options_guide" rel="noopener ugc nofollow" target="_blank">谷歌云计算选项指南</a>。</p><p id="c96e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">关于云构建的其他资源</strong></p><ul class=""><li id="bbaa" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><a class="ae jo" href="https://cloud.google.com/cloud-build/docs/" rel="noopener ugc nofollow" target="_blank">云构建文档</a></li><li id="0d3c" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="https://github.com/GoogleCloudPlatform/cloud-builders" rel="noopener ugc nofollow" target="_blank">官方云构建器</a></li><li id="00bf" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="https://github.com/GoogleCloudPlatform/cloud-builders-community" rel="noopener ugc nofollow" target="_blank">社区云建设者</a></li><li id="2689" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="https://github.com/Timtech4u/awesome-cloudbuild" rel="noopener ugc nofollow" target="_blank">牛逼的云建造</a></li><li id="dad3" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="https://github.com/GoogleCloudPlatform/awesome-google-cloud" rel="noopener ugc nofollow" target="_blank">谷歌云平台牛逼榜</a></li></ul></div></div>    
</body>
</html>