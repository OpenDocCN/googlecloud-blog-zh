<html>
<head>
<title>Deploying Battleship to GAE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向GAE部署战舰</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/deploying-battleship-to-gae-e6aeabf4f34?source=collection_archive---------2-----------------------#2017-08-31">https://medium.com/google-cloud/deploying-battleship-to-gae-e6aeabf4f34?source=collection_archive---------2-----------------------#2017-08-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0ffe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是<a class="ae jd" href="http://www.thagomizer.com/blog/series/battleship.html" rel="noopener ugc nofollow" target="_blank">战舰</a>系列的一部分。</p><p id="1e51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上次写完战舰服务器。下一步是将其部署到某个地方。我接近了我的第一个真正的截止日期，下周二晚上，所以我采取了简单的方法，将它部署在谷歌应用引擎上。将来，我计划写一篇关于Kubernetes部署的博文。我还希望最终将逻辑移植到Node.js和Python，因为我认为语言比较会很有趣。</p><h1 id="1c45" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">准备工作</h1><p id="4215" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我已经有了一个GCP账户，并且在我的电脑上安装了GCP SDK。如果你在家学习，在App Engine教程上的<a class="ae jd" href="https://cloud.google.com/ruby/rails/appengine" rel="noopener ugc nofollow" target="_blank"> Rails 5的“开始之前”框中有这些步骤的说明。自从我上次谈到应用引擎，Ruby软件工程团队已经发布了一个</a><a class="ae jd" href="https://github.com/GoogleCloudPlatform/appengine-ruby" rel="noopener ugc nofollow" target="_blank">应用引擎Gem </a>。这给了我一些在生产中运行rake任务的便利特性，并自动引入了GCP的Ruby监控工具。要使用它，我必须将<code class="du kh ki kj kk b">gem "appengine"</code>添加到我的Gemfile，并将<code class="du kh ki kj kk b">require "appengine"</code>添加到我的Rakefile。</p><p id="82a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我在上一篇文章中提到的，我用的是Sinatra。我喜欢它的轻量级，但这意味着我必须做一些配置工作。要在App Engine上运行应用程序，我需要一个<code class="du kh ki kj kk b">config.ru</code>文件。我从Sinatra文档中取出一个通用的，并把它放在我的应用程序的根目录下。</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="1aa2" class="kt jf hi kk b fi ku kv l kw kx">require './server' <br/>run Sinatra::Application</span></pre><h1 id="dba7" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">数据库ˌ资料库</h1><p id="ae99" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我对数据库使用带有ActiveRecord的PostgreSQL。考虑到即将到来的截止日期，我正在使用来自<a class="ae jd" href="https://cloud.google.com/sql/docs/postgres/" rel="noopener ugc nofollow" target="_blank"> CloudSQL </a>的托管PostgreSQL。这样，我就不必担心防火墙规则以及我的web服务器和数据库之间的联网。</p><p id="6536" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我按照云SQL文档<a class="ae jd" href="https://cloud.google.com/sql/docs/postgres/quickstart" rel="noopener ugc nofollow" target="_blank">中的说明</a>创建了一个云SQL。然后，我为我的应用程序创建了一个用户。我把它叫做rails，因为我总是把我的用户叫做rails。当我开始写这篇文章时，我才意识到这是不合适的(我用的是Sinatra)。我还按照<a class="ae jd" href="https://cloud.google.com/sql/docs/postgres/connect-admin-ip" rel="noopener ugc nofollow" target="_blank">使用IP地址连接</a>下的说明创建了一个静态IP。我将以下内容添加到我的database.yml文件中:</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="482b" class="kt jf hi kk b fi ku kv l kw kx">production:<br/>  &lt;&lt;: *default<br/>  database: "battleship_production"<br/>  username: "rails"<br/>  password: [PASSWORD GOES HERE]<br/>  host:   [YOUR DATABASE IP HERE]<br/>  timeout: 5000</span></pre><p id="daeb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用静态IP不是最好的解决方案。有很多安全隐患。我应该使用<a class="ae jd" href="https://cloud.google.com/sql/docs/postgres/connect-admin-proxy" rel="noopener ugc nofollow" target="_blank"> CloudSQL代理</a>，但是我想要一些能够快速证明我的部署的东西。我可以稍后返回并更改应用程序连接到数据库的方式。</p><p id="bc96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要使用appengine gem运行迁移，我需要将以下内容添加到我的Rakefile中。</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="38dd" class="kt jf hi kk b fi ku kv l kw kx">require "appengine"<br/>require "appengine/tasks"</span></pre><h1 id="67bd" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">部署应用程序</h1><p id="4474" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">将应用程序部署到Ruby的App Engine很简单，只需输入<code class="du kh ki kj kk b">gcloud app deploy</code>。gcloud SDK将在第一次运行时分析您的应用并提出一些建议。默认是好的。它将使用默认值编写一个类似于下面的<code class="du kh ki kj kk b">app.yaml</code>文件:</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="be9f" class="kt jf hi kk b fi ku kv l kw kx">entrypoint: bundle exec rackup -p $PORT<br/>env: flex<br/>runtime: ruby</span></pre><p id="f027" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实际部署可能需要一段时间。对我来说，部署大约需要7分钟。我希望他们能更快，我知道团队正在努力，但这是在决定在哪里运行你的应用程序时要记住的事情。</p><p id="f0ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署应用程序后，您可以像这样运行迁移:</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="59b9" class="kt jf hi kk b fi ku kv l kw kx">bundle exec rake appengine:exec -- bundle exec rake db:migrate</span></pre><p id="3cee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，<code class="du kh ki kj kk b">gcloud app deploy</code>会在应用程序启动并运行后立即将所有流量路由到最新版本的应用程序。如果您需要在该版本能够处理流量之前运行迁移，您可以使用<code class="du kh ki kj kk b">--no-promote</code>标志:</p><pre class="kl km kn ko fd kp kk kq kr aw ks bi"><span id="5c81" class="kt jf hi kk b fi ku kv l kw kx">gcloud app deploy --no-promote</span></pre><p id="72a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦运行了迁移，您就可以使用<a class="ae jd" href="https://console.cloud.google.com/appengine/versions" rel="noopener ugc nofollow" target="_blank"> web UI </a>将流量路由到新版本。</p><p id="4a36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的应用引擎部署在https://battleship-176302.appspot.com/<a class="ae jd" href="https://battleship-176302.appspot.com/" rel="noopener ugc nofollow" target="_blank">如果你想自己尝试一下的话。预计在接下来的几周内会有一些不稳定，我会整理出一些细节，让它可以用于下周在西雅图举行的研讨会。</a></p><p id="ada0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">08/31/17</p></div><div class="ab cl ky kz gp la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="hb hc hd he hf"><p id="95a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lf">原载于2017年8月31日www.thagomizer.com</em><a class="ae jd" href="http://www.thagomizer.com/blog/2017/08/31/deploying-battleship-to-gae.html" rel="noopener ugc nofollow" target="_blank"><em class="lf"/></a><em class="lf">。</em></p></div></div>    
</body>
</html>