<html>
<head>
<title>Running Jupyter notebooks on GPU on Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在谷歌云的GPU上运行Jupyter笔记本</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/running-jupyter-notebooks-on-gpu-on-google-cloud-d44f57d22dbd?source=collection_archive---------0-----------------------#2017-03-23">https://medium.com/google-cloud/running-jupyter-notebooks-on-gpu-on-google-cloud-d44f57d22dbd?source=collection_archive---------0-----------------------#2017-03-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c95c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇帖子显然是受到了@fchollet的这条推文的启发。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="176e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">令人惊讶的是，我没有在谷歌云上找到类似的设置说明。他们的云数据实验室产品目前似乎不能直接在支持GPU的机器上运行。希望这种情况能尽快改变。</p><p id="7ab0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是我遵循的步骤。这些步骤假设您已经更新了<code class="du jk jl jm jn b">gcloud</code>工具(或者您可以使用Cloud Shell)。</p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="6116" class="js jt hi jn b fi ju jv l jw jx">$ gcloud components update &amp;&amp; gcloud components install beta</span></pre><p id="482a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第一步:确认你的GPU配额和区域</strong></p><p id="33c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并非所有GCP区域目前都支持GPU。此外，您可能需要请求增加您的GPU限制。</p><p id="5677" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据<a class="ae jy" href="https://cloud.google.com/compute/docs/gpus/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/compute/docs/gpus/</a>，目前这些区域支持GPU — <em class="jz">美国-西方1-b、美国-东方1-d、欧洲-西方1-b、亚洲-东方1-a </em>。</p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="538c" class="js jt hi jn b fi ju jv l jw jx">$ gcloud beta compute regions describe us-east1</span><span id="02ce" class="js jt hi jn b fi ka jv l jw jx">- limit: 1.0<br/>  metric: NVIDIA_K80_GPUS<br/>  usage: 0.0</span></pre><p id="fc2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果<code class="du jk jl jm jn b">limit</code>是&lt; 1.0，那么请在<a class="ae jy" href="https://console.cloud.google.com/compute/quotas" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/compute/quotas</a>请求增加限制。根据我的经验，谷歌会立即批准请求。</p><p id="fe6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤2:创建启用GPU的实例</strong></p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="2c69" class="js jt hi jn b fi ju jv l jw jx">$ gcloud beta compute instances create <strong class="jn hj">gpu-deep-learner</strong> --machine-type n1-standard-2 --zone <strong class="jn hj">us-east1-d</strong> --accelerator type=<strong class="jn hj">nvidia-tesla-k80,count=1</strong> --image-family ubuntu-1604-lts --image-project ubuntu-os-cloud --boot-disk-size 50GB --maintenance-policy TERMINATE --restart-on-failure</span></pre><p id="1d03" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将在<code class="du jk jl jm jn b">us-east1-d</code>区域中创建一个名为<code class="du jk jl jm jn b">gpu-deep-learner</code>的实例，使用1个GPU和Ubuntu 16.04(持久磁盘大小为50GB)。</p><p id="e9d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第三步:安装CUDA </strong></p><p id="bef3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对实例的ssh(例如使用<code class="du jk jl jm jn b">gcloud</code>)</p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="55cb" class="js jt hi jn b fi ju jv l jw jx">$ gcloud compute ssh gpu-deep-learner --zone us-east1-d</span></pre><p id="c899" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装CUDA 8.0驱动程序和工具包:</p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="80e2" class="js jt hi jn b fi ju jv l jw jx">~$ curl -O <a class="ae jy" href="http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1604/x86_64/cuda-repo-ubuntu1604_8.0.61-1_amd64.deb" rel="noopener ugc nofollow" target="_blank">http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1604/x86_64/cuda-repo-ubuntu1604_8.0.61-1_amd64.deb</a></span><span id="03b8" class="js jt hi jn b fi ka jv l jw jx">~$ sudo dpkg -i cuda-repo-ubuntu1604_8.0.61-1_amd64.deb<br/>~$ sudo apt-get update<br/>~$ rm cuda-repo-ubuntu1604_8.0.61-1_amd64.deb</span><span id="587f" class="js jt hi jn b fi ka jv l jw jx">~$ sudo apt-get install cuda -y</span></pre><p id="1dbc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确认:</p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="1047" class="js jt hi jn b fi ju jv l jw jx">~$ nvidia-smi</span></pre><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kb"><img src="../Images/6a425e8d4e7c77f2a6c0fc29bfeba6ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jXYyLM1EcnvKxBvHzmn_HA.png"/></div></div></figure><p id="ee35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置环境变量:</p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="dfd8" class="js jt hi jn b fi ju jv l jw jx">~$ echo 'export CUDA_HOME=/usr/local/cuda' &gt;&gt; ~/.bashrc<br/>~$ echo 'export PATH=$PATH:$CUDA_HOME/bin' &gt;&gt; ~/.bashrc<br/>~$ echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CUDA_HOME/lib64' &gt;&gt; ~/.bashrc</span><span id="492b" class="js jt hi jn b fi ka jv l jw jx">~$ source ~/.bashrc</span></pre><p id="a0f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第四步:安装cuDNN </strong></p><p id="190b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae jy" href="https://developer.nvidia.com/cudnn" rel="noopener ugc nofollow" target="_blank">https://developer.nvidia.com/cudnn</a>注册并下载cuDNN。然后，将文件scp到您的新实例中。例如</p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="ea99" class="js jt hi jn b fi ju jv l jw jx">$ scp -i .ssh/google_compute_engine cudnn-8.0-linux-x64-v5.1.tgz &lt;external-IP-of-GPU-instance&gt;:</span></pre><p id="9cc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，回到远程实例，解压缩并复制这些文件:</p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="f018" class="js jt hi jn b fi ju jv l jw jx">~$ cd<br/>~$ tar xzvf cudnn-8.0-linux-x64-v5.1.tgz<br/>~$ sudo cp cuda/lib64/* /usr/local/cuda/lib64/<br/>~$ sudo cp cuda/include/cudnn.h /usr/local/cuda/include/</span><span id="15c6" class="js jt hi jn b fi ka jv l jw jx">~$ rm -rf ~/cuda<br/>~$ rm cudnn-8.0-linux-x64-v5.1.tgz</span></pre><p id="b641" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">至此，所有的NVIDIA/CUDA设置都已完成。可以选择自己喜欢的方式安装Python和任何使用GPU的深度学习库。蟒蛇是一种流行的方式。</p><p id="d900" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第五步:安装Anaconda和你喜欢的深度学习框架</strong></p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="4e28" class="js jt hi jn b fi ju jv l jw jx">~$ curl -O <a class="ae jy" href="https://repo.continuum.io/archive/Anaconda3-4.3.1-Linux-x86_64.sh" rel="noopener ugc nofollow" target="_blank">https://repo.continuum.io/archive/Anaconda3-4.3.1-Linux-x86_64.sh</a><br/>~$ bash Anaconda3-4.3.1-Linux-x86_64.sh</span></pre><p id="257f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按照提示操作。我也选择了“是”而不是“将anacoda添加到您的路径中”。最好退出并重新登录。</p><p id="b11b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<code class="du jk jl jm jn b">conda</code>或<code class="du jk jl jm jn b">pip</code>安装您的库。(<code class="du jk jl jm jn b">pip</code>对TensorFlow效果更好):</p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="a9e7" class="js jt hi jn b fi ju jv l jw jx">~$ pip install <strong class="jn hj">tensorflow-gpu</strong><br/>~$ pip install keras</span></pre><p id="a00d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第六步:配置Jupyter </strong></p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="0de9" class="js jt hi jn b fi ju jv l jw jx">~$ jupyter notebook --generate-config</span><span id="e4ba" class="js jt hi jn b fi ka jv l jw jx">Writing default config to: /home/ubuntu/.jupyter/jupyter_notebook_config.py</span></pre><p id="9f64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">编辑<code class="du jk jl jm jn b">/home/ubuntu/.jupyter/jupyter_notebook_config.py</code>以在顶部包含以下内容:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ki jj l"/></div><figcaption class="kj kk et er es kl km bd b be z dx translated">~ <code class="du jk jl jm jn b">/.jupyter/jupyter_notebook_config.py</code></figcaption></figure><p id="13e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第七步:SSH隧道转发</strong></p><p id="b691" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从本地机器建立一个隧道，通过ssh访问Jupyter。</p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="0792" class="js jt hi jn b fi ju jv l jw jx">~ ssh -i .ssh/ubuntu_gcp -L <strong class="jn hj">8899</strong>:localhost:8888 ubuntu@<strong class="jn hj">&lt;IP-address-of-your-GPU-instance&gt;</strong></span></pre><p id="e272" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，在服务器上，启动Jupyter。</p><pre class="jd je jf jg fd jo jn jp jq aw jr bi"><span id="0d31" class="js jt hi jn b fi ju jv l jw jx">~$ mkdir notebooks<br/>~$ cd notebooks</span><span id="0819" class="js jt hi jn b fi ka jv l jw jx">~/notebooks$ jupyter notebook</span></pre><p id="9bf5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第八步:在本地浏览器上开始使用Jupyter</strong></p><p id="afbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导航到<a class="ae jy" href="http://localhost:8899/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8899/ </a>并创建一个新笔记本。通过导入keras或tensorflow进行验证。远程日志还将确认您是否正在使用GPU/Cuda库。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kn"><img src="../Images/c941b581f8a770fec8d2ca1ce1a44f3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZUcBZZmewjPChnovT5tKw.png"/></div></div><figcaption class="kj kk et er es kl km bd b be z dx translated">利润！</figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ko"><img src="../Images/3aef9e7f4821e27af919d8cdcdaf255b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qN5LbJx-ynPtJY8K9eSWAw.png"/></div></div><figcaption class="kj kk et er es kl km bd b be z dx translated">GPU所有的东西！</figcaption></figure><p id="e545" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦完成，请<strong class="ih hj"> <em class="jz">记得停止你的实例</em> </strong>以节省成本。这些GPU实例并不便宜。享受吧。</p><p id="1f96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">备注:</strong></p><ol class=""><li id="ddad" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc ku kv kw kx bi translated">会帮你安排PyTorch。</li><li id="c532" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated"><code class="du jk jl jm jn b">pip install keras</code>还装了Theano 0.9。然而，这个版本的Theano可能会对迁移到新的<code class="du jk jl jm jn b">gpuarray</code>后端发出不赞成的警告。你可以安装<em class="jz"> libgpuarray </em>来解决这个问题。</li></ol></div></div>    
</body>
</html>