<html>
<head>
<title>MySQL to Cloud Spanner: Migrate MySQL database to Cloud Spanner using Vertex AI notebooks and GCP Dataproc Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MySQL到云扳手:使用Vertex AI笔记本和GCP Dataproc无服务器将MySQL数据库迁移到云扳手</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/mysql-to-cloud-spanner-migrate-mysql-database-to-cloud-spanner-using-vertex-ai-notebooks-and-gcp-ad7d2ed8a317?source=collection_archive---------5-----------------------#2022-10-21">https://medium.com/google-cloud/mysql-to-cloud-spanner-migrate-mysql-database-to-cloud-spanner-using-vertex-ai-notebooks-and-gcp-ad7d2ed8a317?source=collection_archive---------5-----------------------#2022-10-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/1d515877ea1769f253f9a0e3b92d82ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aVAcqLcWss_zylV976iMTQ.png"/></div></div></figure><p id="cc79" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">寻找将MySQL表并行迁移到Cloud Spanner的预构建解决方案？别再看了。我们开发了一个Vertex AI笔记本(Jupyter notebook)解决方案，它使用dataproc无服务器进行迁移。你只需要提供必要的参数，笔记本会帮你把一个完整的MySQL数据库迁移到Cloud Spanner。</p><p id="f306" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://github.com/GoogleCloudPlatform/dataproc-templates" rel="noopener ugc nofollow" target="_blank"> Dataproc模板</a>使用<a class="ae jo" href="https://cloud.google.com/vertex-ai/docs/tutorials/jupyter-notebooks" rel="noopener ugc nofollow" target="_blank"> VertexAI笔记本</a>和<a class="ae jo" href="https://cloud.google.com/dataproc-serverless/docs" rel="noopener ugc nofollow" target="_blank"> Dataproc无服务器</a>提供一站式解决方案，将数据直接从MySQl迁移到Cloud Spanner。</p><p id="4b00" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1.从<a class="ae jo" href="https://console.developers.google.com/" rel="noopener ugc nofollow" target="_blank"> API控制台</a>启用GCP项目中的以下服务:</p><ul class=""><li id="1567" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">计算引擎API</li><li id="3f11" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">Dataproc API</li><li id="8261" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">顶点人工智能应用编程接口</li><li id="01ec" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">顶点笔记本API</li></ul><p id="a6d8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.在<a class="ae jo" href="https://pantheon.corp.google.com/vertex-ai/workbench/list/instances" rel="noopener ugc nofollow" target="_blank">顶点AI工作台中创建一个<a class="ae jo" href="https://cloud.google.com/vertex-ai/docs/workbench/user-managed/introduction" rel="noopener ugc nofollow" target="_blank">用户管理的</a>笔记本。</a></p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kd"><img src="../Images/0a8fa76d9268f3e3e6e7dcfdaacd3278.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*94XZ9mKMt0zEqxo1"/></div></div></figure><p id="5346" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.使用GIT选项卡克隆Dataproc模板GitHub repo，如下图所示</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ki"><img src="../Images/f0e77d244e283de46973971dc8292220.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dqq90yz4HETCIBRnOuJxQg.png"/></div></div></figure><p id="d0c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者从启动窗口打开一个终端，使用git clone进行克隆。</p><p id="06b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">git clone<a class="ae jo" href="https://github.com/GoogleCloudPlatform/dataproc-templates.git" rel="noopener ugc nofollow" target="_blank"> https://github.com/GoogleCloudPlatform/dataproc-templates.git</a></code></p><p id="a4be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.从文件夹选项卡中，打开路径为data proc-templates/notebooks/MySQL 2 spanner的<a class="ae jo" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/notebooks/mysql2spanner/MySqlToSpanner_notebook.ipynb" rel="noopener ugc nofollow" target="_blank">MySqlToSpanner _ notebook . ipynb</a>笔记本</p><p id="f639" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.笔记本包含一步一步的过程，以帮助从MySQL迁移数据到云扳手。下面是迁移的步骤:</p><p id="6f18" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第一步:安装所需的软件包</strong></p><p id="3a7d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">迁移所需的一些软件包需要单独安装，因为它们在笔记本中不可用，例如pymysql SQLAlchemy、JDK等。</p><p id="01b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤2:导入库:</strong>导入所需的包</p><p id="3afe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第三步:分配参数:</strong>运行笔记本前需要设置以下配置:</p><p id="9397" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤3.1:通用参数</strong></p><ul class=""><li id="b9f0" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><code class="du kj kk kl km b">PROJECT</code> : GCP项目标识</li><li id="94a3" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">REGION</code> : GCP地区</li><li id="6369" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">GCS_STAGING_LOCATION</code> : GCS暂存位置，用于此笔记本存储工件</li><li id="fbde" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">SUBNET</code> : VPC子网</li><li id="6f04" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">JARS</code>:罐子列表。对于这个笔记本，除了dataproc模板jar之外，还需要mysql连接器和avro jar</li><li id="018b" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">MAX_PARALLELISM</code>:并行运行的作业数量参数，默认值为2</li></ul><p id="73c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤3.2: MYSQL到扳手参数</strong></p><ul class=""><li id="8d40" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><code class="du kj kk kl km b">MYSQL_HOST</code> : MYSQL实例ip地址</li><li id="1197" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">MYSQL_PORT</code> : MySQL实例端口</li><li id="12f0" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">MYSQL_USERNAME</code> : MYSQL用户名</li><li id="0cf0" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">MYSQL_PASSWORD</code> : MYSQL密码</li><li id="23a9" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">MYSQL_DATABASE</code>:要迁移的数据库的名称</li><li id="8181" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">MYSQLTABLE_LIST</code>:您要迁移的表的列表，例如:['table1 '，' table2']否则提供一个空列表以迁移整个数据库，例如:[]</li><li id="6a5e" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">MYSQL_OUTPUT_GCS_LOCATION</code>:将mysql输出写入的gcs位置，例如:“gs://bucket/[folder]”</li><li id="02b1" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">MYSQL_OUTPUT_GCS_MODE</code>:MYSQL数据输出模式之一(覆盖|追加)</li><li id="74e5" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">MYSQL_OUTPUT_GCS_FORMAT</code>:MYSQL数据的输出文件格式为(avro|parquet|orc)之一</li><li id="a517" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">SPANNER_INSTANCE</code>:云扳手实例名</li><li id="b234" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">SPANNER_DATABASE</code>:云扳手数据库名称</li><li id="30d7" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">SPANNER_TABLE_PRIMARY_KEYS</code>:为MYSQL中没有主键的表提供格式为{"table_name":"primary_key"}的字典</li></ul><p id="97fe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤3.3:笔记本配置参数</strong></p><p id="2d15" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些参数包含Dataproc作业所需的jar和属性的路径。除非您想要更改jar的位置，否则不需要更改这些参数。</p><p id="abb4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第四步:生成MySQL表列表</strong></p><p id="9699" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这一步生成要迁移的表列表。如果步骤3.2中的<code class="du kj kk kl km b">MYSQLTABLE_LIST</code>参数为空列表，则选择数据库中的所有表格。</p><p id="4b42" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤5:获取SPANNER_TABLE_PRIMARY_KEYS中不存在的表的主键</strong></p><p id="ea47" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该步骤获取出现在<code class="du kj kk kl km b">MYSQLTABLE_LIST</code>参数中的表的主键，如果这些表的主键未在步骤3.2的参数<code class="du kj kk kl km b">SPANNER_TABLE_PRIMARY_KEYS</code>中提供</p><p id="81e3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤6:获取表的行数并识别读分区列</strong></p><p id="4f15" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该步骤使用<code class="du kj kk kl km b">PARTITION_THRESHOLD</code>(默认值为200k)参数，任何行数大于<code class="du kj kk kl km b">PARTITION_THRESHOLD</code>的表都将基于主键进行分区</p><p id="62ff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第七步:计算MySQL到Cloud Spanner的并行作业</strong></p><p id="24c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">基于步骤3.1中设置的<code class="du kj kk kl km b">MAX_PARALLELISM</code>参数，该步骤计算MySQL到GCS迁移和GCS到Cloud Spanner的并行作业。基本上是将并行迁移到Cloud Spanner的MySQL表的数量。</p><p id="301a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤8:创建JAR文件并上传到GCS </strong></p><p id="05a0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该步骤创建所需的JAR文件，并上传到步骤3.1中定义的<code class="du kj kk kl km b">GCS_STAGING_LOCATION</code></p><p id="dc75" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤9:执行管道将表从MySQL迁移到Spanner </strong></p><p id="0378" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这一步启动MySQL表迁移的顶点AI管道执行。为每个作业生成管道链接。我们还可以在Dataproc UI的<a class="ae jo" href="https://console.cloud.google.com/dataproc/batches?_ga=2.256091016.2085864710.1666708114-43261181.1657894175" rel="noopener ugc nofollow" target="_blank">批处理</a>部分看到作业正在运行</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kn"><img src="../Images/a27f962c907000b9e911d43424e02209.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4tJEjVMg-t8DLybs"/></div></div></figure><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kn"><img src="../Images/b62df8e310eb0449a31b1279baa15e7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3z4qdlVR4wD5iv97"/></div></div></figure><p id="1dd6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤10:获取从MySql迁移到Spanner的表的状态</strong></p><p id="cde7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该步骤获取在步骤9中执行的作业的状态</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/cae60f73d669b5d74c2133220ba442ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PhtMPoz9IeYt-CGP"/></div></div></figure><p id="c679" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤11:验证从MySQL迁移到Cloud Spanner的表的行数</strong></p><p id="be13" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些步骤有助于验证从MySQL迁移到Cloud Spanner的每个表的记录数量</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kn"><img src="../Images/a246c52f7389c3dfe7d4247d8ac32682.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0FkoGgU2KCXzzw__"/></div></div></figure><p id="3bcc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如有任何疑问/建议，请联系:dataproc-templates-support-external@googlegroups.com</p></div></div>    
</body>
</html>