<html>
<head>
<title>BigQuery Encryption Functions — Part I: Data deletion/retention with Crypto Shredding</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">大查询加密函数—第一部分:使用加密粉碎的数据删除/保留</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bigquery-encryption-functions-part-i-data-deletion-retention-with-crypto-shredding-7085ecf6e53f?source=collection_archive---------0-----------------------#2019-05-23">https://medium.com/google-cloud/bigquery-encryption-functions-part-i-data-deletion-retention-with-crypto-shredding-7085ecf6e53f?source=collection_archive---------0-----------------------#2019-05-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/1f8e27fc988bad55f900209bb8a9a836.png" data-original-src="https://miro.medium.com/v2/format:webp/0*4dorQigbt7af0Fjm.png"/></div></figure><p id="4064" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">BigQuery与其他数据仓库有许多不同的特性——<a class="ae jk" href="https://cloud.google.com/bigquery/streaming-data-into-bigquery" rel="noopener ugc nofollow" target="_blank">大规模流式摄取</a>、<a class="ae jk" href="https://cloud.google.com/bigquery/pricing#long-term-storage" rel="noopener ugc nofollow" target="_blank">自动数据存档而不影响性能</a>和<a class="ae jk" href="https://cloud.google.com/bigquery/docs/bigqueryml-intro" rel="noopener ugc nofollow" target="_blank">集成机器学习功能</a>只是其中的几个。最近，我们发布了<a class="ae jk" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/aead_encryption_functions" rel="noopener ugc nofollow" target="_blank"> BigQuery加密函数</a>，它支持一系列广泛而重要的功能，包括我们今天将讨论的内容:使用<a class="ae jk" href="https://en.wikipedia.org/wiki/Crypto-shredding" rel="noopener ugc nofollow" target="_blank">加密粉碎</a>删除和保留数据。</p><p id="77ef" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为什么要从BigQuery中删除数据？许多企业在围绕数据保留的法规下运营，例如，GDPR的<a class="ae jk" href="https://en.wikipedia.org/wiki/Right_to_be_forgotten" rel="noopener ugc nofollow" target="_blank">“被遗忘的权利”</a>条款规定，用户的数据应在被请求时删除。更具体地说，我们想要实现的是这个场景:</p><ol class=""><li id="66c8" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">用户数据存储在多个BigQuery表中</li><li id="5eed" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">法规遵从性要求规定，应根据请求从所有表中删除特定用户的数据</li></ol><p id="6260" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">因此，让我们快速回顾一下允许您从BigQuery中删除数据的两种常见模式:</p><p id="f772" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/dml-syntax" rel="noopener ugc nofollow" target="_blank"><strong class="io hj"/></a><strong class="io hj">删除</strong></p><p id="d2bd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">传统上，这个简单且众所周知的模式使您能够删除数据行。下面的删除查询示例来自我的同事在<a class="ae jk" href="https://cloud.google.com/blog/products/gcp/performing-large-scale-mutations-in-bigquery" rel="noopener ugc nofollow" target="_blank">上写的一个非常有用的博客，在BigQuery </a>中执行大规模突变:</p><figure class="ka kb kc kd fd ii er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es jz"><img src="../Images/21cbcf44e118725ee87c013e22899ac3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HNVsGya7imgF8GTm0QUDsA.png"/></div></div></figure><p id="1f0e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这里的想法非常简单:使用delete DML语句删除符合特定条件的一系列行。</p><p id="3d95" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">创建或替换表格</strong></p><p id="66b7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这个模式也非常简单:我们只是从同一个表的结果中重新创建表。在本例中，我们通过过滤需要删除的行来替换表。由于操作是原子性的，我们永远不会遇到替换操作导致不一致结果的情况。</p><figure class="ka kb kc kd fd ii er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es ki"><img src="../Images/6078e6c13b3fad7984111bfc0bae96ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*10cQ0NuuauAcjzppmX-egw.png"/></div></div></figure><p id="adaf" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于大多数用例，上述两种方法应该足够了。然而，在用户数据跨多个表的初始场景中，我们需要将上述删除模式应用于多个表。这可能不方便，容易出错，或者导致安全问题，特别是如果我们的删除操作无法从一些表中删除，但不能从所有表中删除。如果在大型数据集上运行删除操作，也可能会降低成本效益。</p><p id="504e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一种允许我们一次从所有表中删除数据的方法是<a class="ae jk" href="https://en.wikipedia.org/wiki/Crypto-shredding" rel="noopener ugc nofollow" target="_blank">加密粉碎</a>。这种技术有助于我们通过以下步骤从所有表中删除特定数据:</p><ol class=""><li id="6ce2" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">您的加密和解密密钥是使用BigQuery加密函数创建的。</li><li id="4a19" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">您的数据使用该加密密钥进行加密。</li><li id="c4f6" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">您的解密密钥被安全地存储并用于解密。</li><li id="2d2b" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">一旦有问题的数据被删除，其解密密钥也被删除。</li><li id="ee15" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">以下示例演示了使用BigQuery加密函数的上述步骤。</li></ol><p id="2bc8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，我们创建一个表，每个用户有一个惟一的键。</p><figure class="ka kb kc kd fd ii er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es kj"><img src="../Images/ae5ee465828d0957bfec2ee41db02eca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3SYXjDY_3SI4P-45HYwdwA.png"/></div></div></figure><p id="6773" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，我们将使用上一步中创建的密钥来加密和存储用户的电子邮件地址。</p><figure class="ka kb kc kd fd ii er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es kk"><img src="../Images/a66a42410e24daeb8a62302239df8444.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A7ksxyhtHJ-knQsoekLoxA.png"/></div></div></figure><p id="6073" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">关键的一步是确保所有用户数据，无论在哪个表中，都使用用户的个人密钥进行加密。为了查询加密的表，我们将使用AEAD。DECRYPT_STRING()函数。</p><figure class="ka kb kc kd fd ii er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es kl"><img src="../Images/37f650da48d0678d0dc4147dc987f51c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dYznBHUSLsLF4IEGWdiqrA.png"/></div></div></figure><p id="59f9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，如果我们想从系统中删除一个用户，我们只需删除该特定用户的加密密钥。</p><figure class="ka kb kc kd fd ii er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es km"><img src="../Images/10cfeecb6f8867d98fe1637600a10cc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fXjiJ_K0ov8lxDx6vbq-VQ.png"/></div></div></figure><p id="da60" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们总结一下这里发生的事情:</p><figure class="ka kb kc kd fd ii er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es kn"><img src="../Images/e07392d2a66dda6602e9e04037be6cfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L5XSBOlfn_EMp5vlLxSFnQ.png"/></div></div></figure><p id="c27c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="ko">注意:虽然它们超出了本文的讨论范围，但是在应用这种模式时，您需要考虑一些问题:例如，删除密钥后无用加密数据的垃圾收集、密钥轮换以及对读取查询的影响。</em></p><p id="e0d8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在BigQuery中加密数据允许我们通过删除加密密钥来快速删除用户的所有数据(因为没有它我们永远无法解密用户的数据)。但是让我们更进一步:如果您希望确保数据不仅在BigQuery中被删除，而且在数据处理管道中存储数据的任何地方也被删除，该怎么办？</p><p id="297c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在下一篇博文中，我们将带您看一个例子，在这个例子中，您可以通过在BigQuery之外加密数据，在所有数据处理组件中应用加密分解，并且在数据进入BigQuery之后还能够解密数据。目前我很想在Twitter上听到你的消息。我们的开发者倡导者<strong class="io hj"> Felipe Hoffa: </strong> <a class="ae jk" href="https://stackoverflow.com/questions/56122855/how-can-users-prove-a-specific-account-has-access-to-bigquery-aead-encryption" rel="noopener ugc nofollow" target="_blank">我的账户可以访问BigQuery </a>吗</p></div></div>    
</body>
</html>