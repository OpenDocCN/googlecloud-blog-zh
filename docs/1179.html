<html>
<head>
<title>Connecting Cloud SQL - GCE + Private IP and Proxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">连接云SQL - GCE +私有IP和代理</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-sql-private-ip-proxy-83e85456571f?source=collection_archive---------0-----------------------#2019-10-25">https://medium.com/google-cloud/cloud-sql-private-ip-proxy-83e85456571f?source=collection_archive---------0-----------------------#2019-10-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/23ae89e680f61cca63c0c7af884f9bfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*efvnGXZbvpu0ib5qBdUfuQ.png"/></div></div></figure><p id="a947" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">嗨，朋友们！</p><p id="2585" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这篇博客将带您创建一个GCE (Google Compute Engine)虚拟机来运行一个样例应用程序，该应用程序将尽可能安全地连接到一个云SQL实例。通过私有IP(云SQL实例没有可用于减少攻击面的公共IP ),并使用代理来确保为我们处理所有SSL连接。不要把这当成“你应该这样做”的福音，因为现实世界是有要求的。有时这些需求意味着你不能做所有的事情，或者甚至不应该做所有的事情。如果你正在运行一个个人项目的快速数据库，比如研究你的<a class="ae jo" href="https://www.instructables.com/id/Complete-DIY-Raspberry-Pi-Weather-Station-with-Sof/" rel="noopener ugc nofollow" target="_blank">后院的</a> <a class="ae jo" href="https://www.wired.com/2016/04/diy-weather-station/" rel="noopener ugc nofollow" target="_blank">小气候</a>，你可能不需要经历所有这些步骤来超级保护你的数据库到这个级别。但是存储客户的PII呢？绝对的。</p><p id="1a04" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想了解更多关于云SQL连接的背景知识，请查看我的<a class="ae jo" rel="noopener" href="/@GabeWeiss/connecting-google-cloud-sql-94025ba27071">连接介绍</a>博文。这篇文章还链接到更多关于不同用例和方法的分步文章，以及为什么您可能想要选择一种方法而不是另一种方法。所有这些帖子都假设你已经有了自己的谷歌云平台(GCP)项目，并设置了计费。如果没有，点击此处的<a class="ae jo" href="https://console.cloud.google.com/freetrial" rel="noopener ugc nofollow" target="_blank">按钮</a>开始项目，或点击此处的<a class="ae jo" href="https://console.cloud.google.com/billing" rel="noopener ugc nofollow" target="_blank">按钮</a>为项目设置账单。</p><h1 id="d13b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">创建虚拟机</h1><p id="20ce" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">所以第一件事是创建一个虚拟机。有很多方法可以做到这一点，我将在一个微型f1实例上一步一步地介绍。如果您已经这样做了，请随意跳到下一部分。</p><p id="4a10" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">前往<a class="ae jo" href="http://console.cloud.google.com/compute" rel="noopener ugc nofollow" target="_blank">谷歌计算引擎</a></p><p id="1f74" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您已经有虚拟机，那么点击顶部的<code class="du ks kt ku kv b">CREATE INSTANCE</code>按钮。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es kw"><img src="../Images/712c3278b6fc7f61463a89c03b7cb6f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:662/0*IVhcZ_gwPae9GmMi"/></div></figure><p id="8136" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果没有，那么点击对话框中的蓝色<code class="du ks kt ku kv b">Create</code>按钮。</p><p id="5c08" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里有无数的选择。目前，只要确保给它一个唯一的名称，将<code class="du ks kt ku kv b">Machine type</code>改为f1-micro(最便宜的一个)，然后单击页面底部的<code class="du ks kt ku kv b">CREATE</code>按钮。</p><p id="332c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦它上线(不需要很长时间)，最简单的连接方法就是在实例列表中，在<code class="du ks kt ku kv b">Connect</code>列中，点击下拉菜单并选择<code class="du ks kt ku kv b">Open in browser window</code>。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es lb"><img src="../Images/cb14de6857421309526728db974a9879.png" data-original-src="https://miro.medium.com/v2/resize:fit:764/0*f_f9DHfeWxsyocSJ"/></div></figure><p id="f78a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将通过一些初始设置，如将SSL密钥传输到虚拟机进行连接等。通常不到一分钟。</p><p id="3eb0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了测试连接性，我使用了<code class="du ks kt ku kv b">psql</code>或<code class="du ks kt ku kv b">mysql</code> CLI，这取决于所创建的数据库的类型，所以您需要安装其中的一个，这取决于您想要创建的数据库的类型。</p><ul class=""><li id="9faa" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">PostgreSQL: <code class="du ks kt ku kv b">sudo apt-get install postgresql-client</code></li><li id="12f9" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">MySQL: <code class="du ks kt ku kv b">sudo apt-get install mysql-client</code></li><li id="c42c" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">SQL Server:在我写这篇博客的时候，我们刚刚对SQL Server进行了测试，所以如果你熟悉并想使用它，请在这里查看SQL Server的文档。它给出了安装它的信息，我的同事专门写了一篇关于SQL Server的博客<a class="ae jo" rel="noopener" href="/google-cloud/managing-sql-server-instances-in-cloud-sql-ecee1e48aa4e">这里</a>。</li></ul><h1 id="3b96" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">创建云SQL实例</h1><p id="e288" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我会在控制台上演示一下，但是如果你知道如何使用<code class="du ks kt ku kv b">gcloud</code>，那也很酷。</p><p id="bee1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">到这里<a class="ae jo" href="https://console.cloud.google.com/sql/instances" rel="noopener ugc nofollow" target="_blank">去</a>。如果您已经有了实例，那么点击顶部导航栏中的<code class="du ks kt ku kv b">CREATE INSTANCE</code>按钮:</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/58b2efedf6d2d26f4ffc6425817f31bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4olOvbgBg_AH9E0p"/></div></div></figure><p id="fd9c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您还没有，那么点击对话框中的<code class="du ks kt ku kv b">Create instance</code>蓝色按钮。</p><p id="1dff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">选择您的数据库风格，对于本教程来说，选择哪种类型并不重要。</p><p id="6eaa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">设置一个实例ID，一个root密码，然后展开<code class="du ks kt ku kv b">Show configuration options</code></p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es lr"><img src="../Images/8b3adc34b67c452e602fce896b6bb9a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:436/0*o5d2RciYpFem6mDR"/></div></figure><p id="9995" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">展开<code class="du ks kt ku kv b">Connectivity</code>部分</p><ul class=""><li id="4f97" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated"><strong class="is hj">取消</strong>公有IP选项，勾选<strong class="is hj">私有IP选项</strong></li><li id="a3c4" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">点击<code class="du ks kt ku kv b">ENABLE</code>按钮，启用私有连接所需的API。单击后，可能需要一分钟时间才能完成更多操作，因为这将启用更多权限来使用内部网络</li></ul><p id="e9d8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我不会在这里深入探讨VPCs(虚拟私有云),但是我会在这篇博客文章中稍微讨论一下，并且官方文件会详细介绍。现在，我们将GCE实例留在了默认的VPC中(我甚至没有遍历GCE的所有可能选项，它们很复杂，超出了这篇博文的范围)。</p><p id="3a7c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是相关的，因为即使你已经创建了其他网络，在<code class="du ks kt ku kv b">Associated networking</code>下拉列表中，把它留在<code class="du ks kt ku kv b">default</code>选项上。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es ls"><img src="../Images/cca33a8867fd7dcd059dd360c25e1b0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/0*lUezY55gmovpJkJB"/></div></figure><p id="6607" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击<code class="du ks kt ku kv b">Create</code>按钮，你将返回到实例列表，应该会看到你的实例</p><ul class=""><li id="1532" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">您可以点击进入实例，并看到横幅说它还没有准备好。</li></ul><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/edb32579ee11ff7f076cb9f25cc933fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*t8MJ0d9lBl2A1i5d"/></div></div></figure><ul class=""><li id="3cfe" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">这可能需要几分钟的时间，因此在此过程中，我们将继续让代理一切就绪</li></ul><h1 id="0c53" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">设置Google SQL代理</h1><p id="bc36" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">转到<a class="ae jo" href="https://console.cloud.google.com/apis/library/sqladmin.googleapis.com" rel="noopener ugc nofollow" target="_blank">这里</a>启用云SQL管理API(代理连接到您的项目时需要)</p><ul class=""><li id="f25f" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">如果你已经启用了它，你会看到一个<code class="du ks kt ku kv b">MANAGE</code>按钮，如果你没有，你会看到<code class="du ks kt ku kv b">ENABLE</code>按钮</li></ul><p id="4c55" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">回到GCE实例上的SSH窗口，下载代理</p><ul class=""><li id="4958" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">64位Linux:<code class="du ks kt ku kv b">wget <a class="ae jo" href="https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64" rel="noopener ugc nofollow" target="_blank">https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64</a> -O cloud_sql_proxy</code></li><li id="a171" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">运行<code class="du ks kt ku kv b">chmod +x cloud_sql_proxy</code></li></ul><p id="caf1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们需要创建一个<strong class="is hj">服务帐户</strong>来授予对云SQL的代理访问权</p><p id="da0f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">转到<a class="ae jo" href="https://console.cloud.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank">这里</a>，点击页面顶部的<code class="du ks kt ku kv b">CREATE SERVICE ACCOUNT</code>按钮</p><p id="dcfd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为您的服务帐户提供一个唯一的名称和ID，然后单击<code class="du ks kt ku kv b">CREATE</code></p><p id="8f60" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下一页，点击<code class="du ks kt ku kv b">Select a role</code>的下拉菜单</p><ul class=""><li id="073c" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">过滤“云SQL”并选择<code class="du ks kt ku kv b">Cloud SQL Client</code>角色</li></ul><p id="1849" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击<code class="du ks kt ku kv b">CONTINUE</code></p><p id="bb78" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下一页，点击<code class="du ks kt ku kv b">CREATE KEY</code>按钮</p><ul class=""><li id="0e7d" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">保持在<code class="du ks kt ku kv b">JSON</code>上，点击<code class="du ks kt ku kv b">CREATE</code>。这将把密钥下载到您的本地机器上。</li><li id="bcb5" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">点击<code class="du ks kt ku kv b">DONE</code>完成服务账户的创建</li></ul><p id="8244" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">JSON密钥需要放在运行代理的地方。最简单的方法是，如果你已经用<code class="du ks kt ku kv b">Open in browser window</code>连接到你的GCE实例，在那个窗口的右上角的设置菜单有一个<code class="du ks kt ku kv b">Upload file</code>选项，使得你的服务账户密钥到虚拟机上变得容易</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es lu"><img src="../Images/3ba9320406d3d4062b97068b4a4c3967.png" data-original-src="https://miro.medium.com/v2/resize:fit:580/0*mFlUzBPA7adX5hNe"/></div></figure><p id="7409" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">导航到您刚刚创建的服务帐户文件，并将其上传到虚拟机。它将被上传到您的主目录，所以如果您已经创建了一个tmp文件夹，您将需要将服务帐户文件移动到该目录中，或者只需要记住您将它放在哪里。</p><p id="7202" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">运行代理</strong></p><p id="9265" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">回到<a class="ae jo" href="https://console.cloud.google.com/sql/instances" rel="noopener ugc nofollow" target="_blank">这里</a>。一旦您的实例完成了配置(可能还没有完成)，单击它。</p><p id="2c1e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在<code class="du ks kt ku kv b">Connect to this instance</code>部分，复制<code class="du ks kt ku kv b">Instance connection name</code>，它看起来会像<code class="du ks kt ku kv b">myproject:us-central1:myinstance</code></p><p id="1b26" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用以下命令启动代理:</p><ul class=""><li id="5f2c" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated"><code class="du ks kt ku kv b">./cloud_sql_proxy -instances=&lt;INSTANCE_CONNECTION_NAME&gt;=tcp:5432 -credential_file=&lt;PATH_TO_SERVICE_ACCOUNT_FILE&gt; &amp;</code></li><li id="a52b" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">注意这个端口是专门为Postgres准备的，如果你使用的是MySQL，那么它应该是<code class="du ks kt ku kv b">tcp:3306</code></li><li id="a22d" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">更改这些端口是没问题的，特别是如果您已经在端口上运行了某些东西(比如您正在本地运行PostgreSQL)。如果您这样做了，请记住，在下一节中，您需要用您指定的任何内容来指定<code class="du ks kt ku kv b">--port</code>标志，以便验证连通性。</li></ul><p id="7d90" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">验证连通性</strong></p><p id="58e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">验证连通性最简单的方法是使用psql:</p><ul class=""><li id="5cc9" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated"><code class="du ks kt ku kv b">psql “host=127.0.0.1 port=5432 sslmode=disable user=postgres”</code>然后输入您在创建数据库时指定的密码</li><li id="58a6" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">注意，即使设置了<code class="du ks kt ku kv b">sslmode=disable</code>，Google SQL代理也提供了加密的连接</li></ul><p id="3dcb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">总结</strong></p><p id="52f3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了清理这个问题，您需要删除云SQL实例<a class="ae jo" href="https://console.cloud.google.com/sql/instances" rel="noopener ugc nofollow" target="_blank">这里的</a>，并关闭计算引擎实例<a class="ae jo" href="https://console.cloud.google.com/compute" rel="noopener ugc nofollow" target="_blank">这里的</a>。</p><p id="0c29" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">遇到什么问题了吗？请让我知道！请在下面的评论中回复，或者在推特上联系我。我的DMs打开了！</p></div></div>    
</body>
</html>