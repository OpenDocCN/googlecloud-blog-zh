<html>
<head>
<title>Automating and Scheduling a Linux Filesystem Sync with Google Cloud Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动化和安排Linux文件系统与Google云存储的同步</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/automating-and-scheduling-a-linux-filesystem-sync-with-google-cloud-storage-576a07ca2fdb?source=collection_archive---------1-----------------------#2017-07-05">https://medium.com/google-cloud/automating-and-scheduling-a-linux-filesystem-sync-with-google-cloud-storage-576a07ca2fdb?source=collection_archive---------1-----------------------#2017-07-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="29a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">TL；DR: </strong>我学会了如何使用<a class="ae jd" href="https://cloud.google.com/storage/transfer/" rel="noopener ugc nofollow" target="_blank">存储转移服务</a>将我的遗留文件系统数据迁移到<a class="ae jd" href="https://cloud.google.com/storage" rel="noopener ugc nofollow" target="_blank">谷歌云存储</a>。在下面<a class="ae jd" href="https://gist.github.com/allenday/88a63ed80f9b4fda4080704ac034698c" rel="noopener ugc nofollow" target="_blank">找到我写的一个脚本</a>，它将帮助你做同样的事情。</p><p id="4bf9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">动机:</strong>我有一堆分散在各种服务器和托管服务上的内容，因为几十年来我一直在网上放东西——远在云普遍可用之前。设置通常是Linux文件系统，主机已经有一个HTTP服务器，或者我可以设置一个。这些服务器的一些文件系统仍然在添加/删除文件，我希望有一种方法来获得这个过程的结果，即文件系统的内容，转移到Google云存储中。这为应用程序提供了一条向前迁移的路径，因为我最终可以迁移修改文件系统、使用CDN等的服务。</p><p id="2894" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">原来Google Cloud提供了一个存储传输服务，除了支持从AWS S3桶导入之外，还有一种从HTTP服务器加载数据的方法。您可以在这里阅读有关传输服务:<a class="ae jd" href="https://cloud.google.com/storage/transfer/" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/storage/transfer/</a>以及与本文档相关的，使用TsvHttpData格式描述通过HTTP导入的对象的协议:<a class="ae jd" href="https://cloud.google.com/storage/transfer/create-url-list" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/storage/transfer/create-url-list</a></p><p id="ca0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">简言之，TsvHttpData需要一个包含以下内容的3列TSV文件:</p><ol class=""><li id="5dd8" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">对象的URL</li><li id="4ad4" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">对象的大小，以字节为单位</li><li id="5ada" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">对象的MD5校验和</li></ol><p id="f428" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以使用gcloud创建一个计划作业来检索TSV文件并导入任何丢失/更新的对象。</p><p id="afe3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我编写了一个脚本，它可以递归遍历文件的子目录，找到自创建TsvHttpData文件的上一个版本以来修改过的文件，并用新信息更新该TsvHttpData文件(新创建的文件、不再存在的省略文件、修改文件的更新MD5校验和)。它做了正确的事情来减少I/O，不重新计算没有改变的文件的MD5校验和。以下是GitHub要点中的源代码:</p><figure class="js jt ju jv fd jw"><div class="bz dy l di"><div class="jx jy l"/></div></figure><p id="4e23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来要做的是将这个脚本放在cron上，以及删除最后修改的时间戳的后处理步骤，我将这个时间戳作为额外的一列添加到TsvHttpData格式中(以节省I/O)。这两个命令看起来像:</p><pre class="js jt ju jv fd jz ka kb kc aw kd bi"><span id="78c2" class="ke kf hi ka b fi kg kh l ki kj">#create the URL list, sizes, checksums, and last-modified timestamps<br/>make_TsvHttpData.pl http://my.org/ ~/public_html/sync/ ~/THD.pre</span><span id="1eed" class="ke kf hi ka b fi kk kh l ki kj">#write the TsvHttpData file to a location visible over HTTP:<br/>cat ~/THD.pre | cut -f 1,2,3 &gt; ~/public_html/THD.tsv</span></pre><p id="85fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请让我知道❤或评论，如果你觉得这很有用！</p></div></div>    
</body>
</html>