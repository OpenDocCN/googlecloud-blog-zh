<html>
<head>
<title>Cloud Deployment Manager &amp; Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云部署经理和Kubernetes</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-deployment-manager-kubernetes-2dd9b8124223?source=collection_archive---------0-----------------------#2018-06-12">https://medium.com/google-cloud/cloud-deployment-manager-kubernetes-2dd9b8124223?source=collection_archive---------0-----------------------#2018-06-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4f2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是的，你可以:-)</p><p id="4c92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我一直在熟悉<a class="ae jd" href="http://helm.sh" rel="noopener ugc nofollow" target="_blank">头盔</a>。赫尔姆比我想象的要正派和直率。然而，我对Helm最大的不满是它只适用于Kubernetes。我知道赫尔姆不想成为其他人。但这意味着在我可以使用Helm之前，我必须提供一个Kubernetes集群和可能的相关服务(例如，Cloud Spanner，一些服务帐户)。</p><p id="02c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想要一个工具来统治一切。近来，人们对Hashicorp的Terraform非常感兴趣，因为它是一个超级配置器，但即使是Terraform，在部署Kubernetes应用程序时，其适用性也是有限的。</p><p id="6806" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">原来，谷歌自己的<a class="ae jd" href="https://cloud.google.com/deployment-manager" rel="noopener ugc nofollow" target="_blank">云部署管理器</a> (DM)有一个强大的(相对较新，相对较模糊的)功能，称为“<a class="ae jd" href="https://cloud.google.com/deployment-manager/docs/configuration/type-providers/process-adding-api" rel="noopener ugc nofollow" target="_blank">类型提供者</a>”，使DM能够被配置为部署几乎任何东西，包括我们心爱的Kubernetes。Howzat！？</p><p id="70b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">归功于David Schweikert和他的文章“GCP基础设施作为部署管理器的代码”,你可能想先读这篇文章，而不是我的文章。这也要归功于部署管理团队，他们为Kubernetes提供了一个样本，即使它隐藏在GitHub的内部(<a class="ae jd" href="https://github.com/GoogleCloudPlatform/deploymentmanager-samples/tree/master/examples/v2/gke" rel="noopener ugc nofollow" target="_blank"> link </a>)。</p><p id="f85b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在完全公开的情况下，我为DM团队提交了一份<a class="ae jd" href="https://github.com/GoogleCloudPlatform/deploymentmanager-samples/pull/175" rel="noopener ugc nofollow" target="_blank"> PR </a>来更新它的Kubernetes(称为“GKE”)样本，但是我(还)不完全理解它是如何工作的。虽然它确实有效，但这是99%的问题:使用它，我可以将部署和服务应用到Kubernetes集群。</p><h2 id="2164" class="jg jh hi bd ji jj jk jl jm jn jo jp jq iq jr js jt iu ju jv jw iy jx jy jz ka bi translated">设置</h2><p id="ce31" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">有一个谷歌云平台项目。如果尚未启用，请启用部署管理器(DM):</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="3c08" class="jg jh hi kl b fi kp kq l kr ks">PROJECT=[[YOUR-PROJECT]]</span><span id="f80f" class="jg jh hi kl b fi kt kq l kr ks">gcloud services enable deploymentmanager.googleapis.com \<br/>--project=$PROJECT</span></pre><p id="342b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我要假设(！)DM将为我们启用Kubernetes引擎等服务。[确实如此]</p><p id="ad92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我假设你对DM有所了解。很简单(！)是一个接受谷歌云平台API调用集合的服务。这些API调用是Google为其每项服务发布的(权威的)API。</p><p id="a80a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本质上(！)如果有Google Cloud Platform API，那么你可以使用Deployment Manager将其自动化。当然，Kubernetes引擎是这套GCP API<strong class="ih hj">的一部分，但是</strong>提供Kubernetes引擎的GCP API和Kubernetes(引擎)用来提供自身资源的Kubernetes API是有区别的。</p><p id="4922" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">扩展部署管理器以支持Kubernetes API是由部署管理器的类型提供者实现的。</p><h2 id="940e" class="jg jh hi bd ji jj jk jl jm jn jo jp jq iq jr js jt iu ju jv jw iy jx jy jz ka bi translated">库伯内特发动机</h2><p id="0647" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">这里有一个简单的脚本，它将把一个Kubernetes集群部署到您最喜欢的区域。我将为自己设定一个扩展目标，添加这个部署脚本的变体，以提供一个区域集群[参见本文末尾的'<strong class="ih hj">区域集群</strong>]:</p><figure class="kg kh ki kj fd ku"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="cf0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以运行这个程序，并提供它所期望的参数(<code class="du kx ky kz kl b">CLUSTER_NAME</code>、<code class="du kx ky kz kl b">CLUSTER_ZONE</code>、<code class="du kx ky kz kl b">NUM_NODES</code>):</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="cf65" class="jg jh hi kl b fi kp kq l kr ks">NAME=a<br/>ZONE=us-west1-a</span><span id="d4a4" class="jg jh hi kl b fi kt kq l kr ks">gcloud deployment-manager deployments create ${NAME} \<br/>--template=kubernetes_engine.py \<br/>--properties=CLUSTER_NAME:${NAME},CLUSTER_ZONE:${ZONE},NUM_NODES:1 \<br/>--project=$PROJECT</span></pre><p id="cba2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该会收到:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="7a6f" class="jg jh hi kl b fi kp kq l kr ks">The fingerprint of the deployment is 8I1cswAm1ptrCkgKmwvVKA==<br/>Waiting for update [operation-1528751969941-...]...done.                                                                                                                                                                 <br/>Update operation operation-1528751969941-... completed successfully.<br/>NAME  TYPE                  STATE      ERRORS  INTENT<br/>a     container.v1.cluster  COMPLETED  []</span></pre><p id="4c45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">而且，对于一些图片漂亮:</p><figure class="kg kh ki kj fd ku er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es la"><img src="../Images/7687ff34cb2f01cd3e2cbcc65881d41f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MByddiBi_ql9pwZOQOZXKA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">Kubernetes发动机组“a”</figcaption></figure><p id="12a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以及部署管理器报告的内容:</p><figure class="kg kh ki kj fd ku er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ll"><img src="../Images/3ad34ad0954e3d08c4db9b10ef21f96f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hNCo07uNKLoFOYQNzXMk6A.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">部署管理器创建了“container.v1.cluster”</figcaption></figure><p id="dd15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">魔法？不完全是。第11行中的<code class="du kx ky kz kl b">type: container.v1.cluster</code>是指部署管理器的支持资源类型下列出的GCP API调用:</p><p id="6d42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/deployment-manager/docs/configuration/supported-resource-types" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/deployment-manager/docs/configuration/supported-resource-types</a></p><figure class="kg kh ki kj fd ku er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lm"><img src="../Images/25cbba26299a8b811bdf94c552d5abb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_qqrE0jZkVdRU1dYbmMs0g.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">支持的资源类型“container.v1.cluster”</figcaption></figure><p id="fc7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其中链接到Kubernetes引擎的v1(！)REST API文档:</p><p id="8e4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/kubernetes-engine/reference/rest/v1/projects.zones.clusters" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/kubernetes-engine/reference/rest/v1/projects . zones . clusters</a></p><figure class="kg kh ki kj fd ku er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ln"><img src="../Images/3e914b4bf23fc8eebfe8d613aba18d4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QJbuqxBUXi_ahFDk6CTIlw.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">项目.区域.集群</figcaption></figure><p id="7ed3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个对象为我们提供了我们在部署脚本的第12–29行中列举的属性。</p><blockquote class="lo lp lq"><p id="3f5d" class="if ig lr ih b ii ij ik il im in io ip ls ir is it lt iv iw ix lu iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>在第31–34行我们定义了<code class="du kx ky kz kl b">outputs</code>。具体来说，我们创建一个名为endpoint的输出，它引用该集群主服务器的IP地址。当我们试图创建Kubernetes API时，我们将需要使用这个集群来为我们获取这些API，然后我们将使用这个值。</p></blockquote><p id="09eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">题外话已经说够了。</p><p id="1621" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以说，部署管理器在Google云平台中有一个默认的类型提供者。我们不需要定义谷歌云平台API。然而，我们确实需要定义其他人。</p><p id="767b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请删除部署(这会删除群集),因为我们将在下一部分创建类型时重新创建群集:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="d833" class="jg jh hi kl b fi kp kq l kr ks">gcloud deployment-manager deployments delete ${NAME} \<br/>--project=${PROJECT}</span></pre><h2 id="1038" class="jg jh hi bd ji jj jk jl jm jn jo jp jq iq jr js jt iu ju jv jw iy jx jy jz ka bi translated">类型提供程序</h2><p id="2829" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">好了，我将让Google的文档来解释类型提供者是如何工作的以及它们是如何定义的。我不完全清楚。</p><p id="3121" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与上面的部署脚本一样，我们需要生成类型提供者资源，供部署管理器使用。因此，让我们创建另一个脚本，它在结构上应该类似于Kubernetes引擎集群脚本(这几乎完全是Google脚本的副本):</p><figure class="kg kh ki kj fd ku"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="0021" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">脚本的核心是第4-8行。该脚本遍历本节中列出的每一项，并为它们创建类型提供程序(第13–49行)。我将把样板文件留给谷歌来解释。可以说，它从API中推断出使用APIs Swagger文档支持的方法。但是，这些API是什么呢？</p><p id="3948" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们部署我们的脚本。我们将需要组合这些，因为我们想要访问在第一个脚本中创建的Kubernetes集群，以便在第二个脚本中枚举它的类型(针对它的API)。创建配置文件:</p><figure class="kg kh ki kj fd ku"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="9279" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置文件导入我们的两个脚本(第1–3行)并应用它们(第6–11、12–16行):</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="e696" class="jg jh hi kl b fi kp kq l kr ks">gcloud deployment-manager deployments create ${NAME} \<br/>--config=generate_apis.yaml \<br/>--project=$PROJECT</span></pre><p id="b9da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于集群(第6–11行)，我们有效地将命令行转换为配置。请将<code class="du kx ky kz kl b">[[YOUR-CLUSTER-NAME]]</code>替换为您希望为集群命名的名称，将<code class="du kx ky kz kl b">[[YOUR-CLUSTER-ZONE]]</code>替换为您希望创建集群的区域。</p><p id="bb4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于这些类型，我称它们为<code class="du kx ky kz kl b">types</code>，因为我不是原创的(第12-16行)，属性<code class="du kx ky kz kl b">endpoint</code>是我们集群创建的输出。它被赋予集群的主节点IP地址的值。脚本使用它来自省Kubernetes集群的API列表，并为它们构建类型。</p><p id="ddc6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成后，我们将拥有一个集群和一组类型:</p><figure class="kg kh ki kj fd ku er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lv"><img src="../Images/b59aa038a400ca55f22dafa311d778f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8DNbG076qOQNjZPPb20yoA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">类型:kubernetes、kubernetes-应用程序、kubernetes-v1-beta 1-扩展</figcaption></figure><p id="4f4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们访问我们的群集，以便我们可以查看以下内容:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="f13c" class="jg jh hi kl b fi kp kq l kr ks">gcloud container clusters get-credentials [[YOUR-CLUSTER-NAME]] \<br/>--project=${PROJECT}</span></pre><p id="1889" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="9e9b" class="jg jh hi kl b fi kp kq l kr ks">kubectl cluster-info</span><span id="da76" class="jg jh hi kl b fi kt kq l kr ks">Kubernetes master is running at <a class="ae jd" href="https://35.233.144.128" rel="noopener ugc nofollow" target="_blank">https://[</a>[YOUR-MASTER-IP]]</span></pre><blockquote class="lo lp lq"><p id="1006" class="if ig lr ih b ii ij ik il im in io ip ls ir is it lt iv iw ix lu iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>获取Kubernetes主IP地址</p></blockquote><h2 id="0330" class="jg jh hi bd ji jj jk jl jm jn jo jp jq iq jr js jt iu ju jv jw iy jx jy jz ka bi translated">第10行:api/v1/</h2><p id="cd45" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">这是Kubernetes的基础API。Kubernetes(1.10版)文档中列出的所有类型都可以从这个API获得:</p><p id="1389" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.10/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/reference/generated/kubernetes-API/v 1.10/</a></p><p id="f3ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获取<code class="du kx ky kz kl b">[[YOUR-MASTER-IP]]</code>地址，用<code class="du kx ky kz kl b">/api/v1</code>后缀浏览或滚动端点，您将收到所有Kubernetes v1类型的枚举:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="cb0d" class="jg jh hi kl b fi kp kq l kr ks">curl \<br/>--insecure \<br/>--silent \<br/><a class="ae jd" href="https://[[YOUR-MASTER-IP]]/api/v1" rel="noopener ugc nofollow" target="_blank">https://[[YOUR-MASTER-IP]]/api/v1</a>/ \<br/>| jq --raw-output .resources[].name</span></pre><blockquote class="lo lp lq"><p id="4ab5" class="if ig lr ih b ii ij ik il im in io ip ls ir is it lt iv iw ix lu iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>需要那个最后的<code class="du kx ky kz kl b">v1/</code>。</p></blockquote><p id="914b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前，该列表包括(子集)一些家庭收藏:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="213a" class="jg jh hi kl b fi kp kq l kr ks">configmaps<br/>namespaces<br/>nodes<br/>pods<br/>secrets<br/>serviceaccounts<br/>services</span></pre><h2 id="4867" class="jg jh hi bd ji jj jk jl jm jn jo jp jq iq jr js jt iu ju jv jw iy jx jy jz ka bi translated">第11行:API/apps/v1beta 1</h2><p id="9a30" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">取<code class="du kx ky kz kl b">[[YOUR-MASTER-IP]]</code>地址和后缀/API/apps/v1 beta 1:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="3e22" class="jg jh hi kl b fi kp kq l kr ks">curl \<br/>--insecure \<br/>--silent \<br/><a class="ae jd" href="https://[[YOUR-MASTER-IP]]/api/v1" rel="noopener ugc nofollow" target="_blank">https://[[YOUR-MASTER-IP]]/apis/apps/v1</a>beta1 \<br/>| jq --raw-output .resources[].name</span></pre><blockquote class="lo lp lq"><p id="662c" class="if ig lr ih b ii ij ik il im in io ip ls ir is it lt iv iw ix lu iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>又是<code class="du kx ky kz kl b">/apis</code>这次没有<code class="du kx ky kz kl b">/api</code>。</p></blockquote><p id="c22f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前这返回:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="b364" class="jg jh hi kl b fi kp kq l kr ks">controllerrevisions<br/>deployments<br/>deployments/rollback<br/>deployments/scale<br/>deployments/status<br/>statefulsets<br/>statefulsets/scale<br/>statefulsets/status</span></pre><h2 id="7fdb" class="jg jh hi bd ji jj jk jl jm jn jo jp jq iq jr js jt iu ju jv jw iy jx jy jz ka bi translated">其他人</h2><p id="f2e9" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">您的集群支持的API集记录在此:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="6d09" class="jg jh hi kl b fi kp kq l kr ks">curl \<br/>--insecure \<br/>--silent \<br/><a class="ae jd" href="https://35.233.172.79/apis/" rel="noopener ugc nofollow" target="_blank">https://[[YOUR-MASTER-IP]]/apis/</a> \<br/>| jq --raw-output .groups[].name<br/>apiregistration.k8s.io<br/>extensions<br/>apps<br/>authentication.k8s.io<br/>authorization.k8s.io<br/>autoscaling<br/>batch<br/>certificates.k8s.io<br/>networking.k8s.io<br/>policy<br/>rbac.authorization.k8s.io<br/>storage.k8s.io<br/>apiextensions.k8s.io</span></pre><p id="8a69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以将所有这些添加到部署管理器脚本中，以便可以通过部署管理器访问它们。</p><p id="a559" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从部署管理器脚本中，您会记得我们使用了<code class="du kx ky kz kl b">/swaggerapi</code>作为我们的端点，所以也来看看它:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="b71d" class="jg jh hi kl b fi kp kq l kr ks">curl \<br/>--insecure \<br/>--silent \<br/>https://[[YOUR-MASTER-IP]/swaggerapi</span></pre><blockquote class="lo lp lq"><p id="e7fc" class="if ig lr ih b ii ij ik il im in io ip ls ir is it lt iv iw ix lu iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>以前可以通过Kubernetes托管的Swagger UI浏览器浏览Kubernetes的Swagger文档，但这似乎对我不起作用:-(</p></blockquote><p id="3a50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好的，我们可以部署Kubernetes集群并使用类型提供者来定义Kubernetes类型，所以…！？</p><h2 id="8496" class="jg jh hi bd ji jj jk jl jm jn jo jp jq iq jr js jt iu ju jv jw iy jx jy jz ka bi translated">部署Kubernetes资源</h2><p id="ce64" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">[参见'<strong class="ih hj">在帖子末尾添加入口</strong></p><p id="25cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">敦敦敦……让我们切入正题:</p><figure class="kg kh ki kj fd ku"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="e0e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下方式部署它:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="abab" class="jg jh hi kl b fi kp kq l kr ks">gcloud deployment-manager deployments update k \<br/>--template=deployment.py \<br/>--project=$PROJECT \<br/>--properties=name:henry,port:80,image:nginx</span><span id="3cf8" class="jg jh hi kl b fi kt kq l kr ks">The fingerprint of the deployment is Q_zFbcIkVc3UTACp-5Gw1g==<br/>Waiting for update [operation-1528761005721-...]...done.                                                                                                                                                                 <br/>Update operation operation-1528761005721-... completed successfully.<br/>NAME              TYPE                                                                                           STATE      ERRORS<br/>henry-deployment  kubernetes-apps:/apis/.../deployments  COMPLETED<br/>henry-service     kubernetes:/api/.../services           COMPLETED</span></pre><figure class="kg kh ki kj fd ku er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lw"><img src="../Images/4f16fc7a04430a2d71002800711ab4e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ERRdFIXF2io4CAKeorUA8g.png"/></div></div></figure><p id="3f98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最令人兴奋的是</p><figure class="kg kh ki kj fd ku er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lx"><img src="../Images/45334797a5bcb1a960d358cc584da224.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jmrHB_Dv86R3QDNKyaeqJQ.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">Kubernetes引擎控制台:部署</figcaption></figure><p id="dc7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">展示了Nginx在端口80上的部署，并通过Kubernetes上的节点端口通过服务公开。</p><p id="c156" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有这些都是仅使用部署管理器实现的！！</p><p id="060d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于这个Kubernetes部署脚本，有两件事需要了解。</p><p id="519f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们必须反向引用我们使用类型提供程序创建的类型。这些在表格中被唯一引用:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="ec53" class="jg jh hi kl b fi kp kq l kr ks">[[PROJECT]]/[[TYPE]]:[[TYPE-API]]</span></pre><p id="de81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，让我们为部署更完整地解释这一点。您可能还记得，Kubernetes部署是在这里定义的:</p><p id="3fb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.10/#deployment-v1-apps" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/reference/generated/kubernetes-API/v 1.10/# deployment-v1-apps</a></p><p id="6b2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它们需要我们在<code class="du kx ky kz kl b">kubernetes_engine_apis.py</code>的第6行定义的<code class="du kx ky kz kl b">apps/v1beta1</code>:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="cf46" class="jg jh hi kl b fi kp kq l kr ks">'-apps': 'apis/apps/v1beta1',</span></pre><p id="0e11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用<code class="du kx ky kz kl b">kubernetes</code>作为这个项目中所有类型的根名称。因此，当我们在部署管理器中调用这些时，我们必须引用类型<code class="du kx ky kz kl b">[[PROJECT]]/kubernetes-app</code>。这里，它在部署管理器控制台中被突出显示:</p><figure class="kg kh ki kj fd ku er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lv"><img src="../Images/b3c4b2bab501911e16b3b02c4920c651.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UkmSsSPLtv3cfSZcQ-P3nw.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">部署管理器类型:“kubernetes-apps”</figcaption></figure><p id="a47a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们必须告诉部署管理器对该类型进行什么API调用。在这种情况下，如果您搜索部署的端点，您会发现它是:<code class="du kx ky kz kl b">/apis/apps/v1beta1/namespaces/{namespace}/deployment</code>，这就是我们在<code class="du kx ky kz kl b">deployment.py</code>的第41行中所调用的。</p><p id="c6c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其次，我们需要确定向方法提供什么属性(主体)。这是在Kubernetes API中定义的。如果您查看上面提供的链接，您会看到<code class="du kx ky kz kl b">deployment.py</code>第42–68行反映了这个结构。</p><h2 id="b4f4" class="jg jh hi bd ji jj jk jl jm jn jo jp jq iq jr js jt iu ju jv jw iy jx jy jz ka bi translated">警告</h2><p id="3e98" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">当您删除创建Kubernetes资源的部署管理器部署时，并非所有的Kubernetes资源都会被删除。在上面的例子中，Kubernetes服务将(！)被删除，但部署不会(！idspnonenote)被删除。)被删除。我觉得很奇怪。</p><p id="33a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您删除了创建Kubernetes集群的部署管理器部署，那么您当然会破坏所有东西(包括服务和部署)。</p><h2 id="ff25" class="jg jh hi bd ji jj jk jl jm jn jo jp jq iq jr js jt iu ju jv jw iy jx jy jz ka bi translated">结论</h2><p id="39cd" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">部署经理可以供应GCP资源<strong class="ih hj">和</strong> Kubernetes资源。而且，如果您想亲自尝试，也可以让它为您的API提供资源！</p><p id="d882" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是的，你可能想坚持使用Helm或Jsonnet或Terraform。但是，如果您想使用部署管理器，希望这个故事向您展示了它的用途可能比您想象的更多。</p><p id="a2bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随时欢迎反馈。<br/>就这些！</p><h2 id="0150" class="jg jh hi bd ji jj jk jl jm jn jo jp jq iq jr js jt iu ju jv jw iy jx jy jz ka bi translated">更新180611:区域集群</h2><p id="ed05" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">感谢我的同事Adam帮助我完成这项工作，这里有一个简单的部署管理器模板来创建一个Kubernetes引擎区域集群:</p><figure class="kg kh ki kj fd ku"><div class="bz dy l di"><div class="kv kw l"/></div></figure><blockquote class="lo lp lq"><p id="cc0f" class="if ig lr ih b ii ij ik il im in io ip ls ir is it lt iv iw ix lu iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>诀窍是使用v1beta1类型，如第12行所示。</p></blockquote><p id="835c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您更喜欢使用前面示例中的区域集群，只需在<code class="du kx ky kz kl b">generate_apis.yaml</code>中将<code class="du kx ky kz kl b">kubernetes_engine.py</code>替换为<code class="du kx ky kz kl b">kubernetes_engine_regional_cluster.py</code>(出现了两次)并更新您的部署。</p><h2 id="a11b" class="jg jh hi bd ji jj jk jl jm jn jo jp jq iq jr js jt iu ju jv jw iy jx jy jz ka bi translated">更新180611:添加入口</h2><p id="e58e" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">在<code class="du kx ky kz kl b">kubernetes_engine_apis.py</code>脚本中，有一个以前没有使用过的对<code class="du kx ky kz kl b">apis/extensions/v1beta</code>的引用。这个API包括入口资源，允许我们通过GCP HTTP/S负载均衡器公开服务。让我们将该配置添加到我们的Kubernetes部署中:</p><figure class="kg kh ki kj fd ku"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="d1a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第8行，我们为<code class="du kx ky kz kl b">Ingress</code>添加了对<code class="du kx ky kz kl b">apis/extensions/v1beta</code>的引用。第71–88行定义了入口。在第82–85行，我们引用了之前创建的服务，因为它为入口提供了后端。</p><p id="5f0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们部署这个脚本时，我们会看到创建了一个入口:</p><figure class="kg kh ki kj fd ku er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ly"><img src="../Images/7403e289f62ff38b3c388b776af966f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sNsTGj5wCg7sa2hhJtDeiw.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">Kubernetes引擎:入口细节</figcaption></figure><blockquote class="lo lp lq"><p id="4ad3" class="if ig lr ih b ii ij ik il im in io ip ls ir is it lt iv iw ix lu iz ja jb jc hb bi translated">不清楚为什么它会在后端服务上报告警告，因为它看起来一切正常。或许有一些延迟？</p></blockquote><p id="2520" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是部署管理器部署的入口资源:</p><figure class="kg kh ki kj fd ku er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ll"><img src="../Images/ffb9b041be90cd51a68d85b21ea9a333.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mP_2_bT-ierlJBWUTSWxlA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">部署经理:Kubernetes部署，带入口</figcaption></figure><p id="d095" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是云控制台网络服务负载平衡器，显示了Kubernetes (Ingress)为我们提供的HTTP/S负载平衡器:</p><figure class="kg kh ki kj fd ku er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ly"><img src="../Images/5788fb539b327862db740eaf2ae126c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mxvZzn-17ttaf1_3BeAEUA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">由入口提供的HTTP/S负载平衡器</figcaption></figure><p id="5373" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获取IP地址后，我们可以浏览到它的端点并查看我们的Nginx部署:</p><figure class="kg kh ki kj fd ku er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ll"><img src="../Images/d898c51d5ace1c533e4a3a6d5da19c41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BJ2hsBV1eZlIzHt3dzcRVg.png"/></div></div></figure></div></div>    
</body>
</html>