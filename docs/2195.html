<html>
<head>
<title>Connect Oracle to BigQuery using DB Link</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用数据库链接将Oracle连接到BigQuery</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/connect-oracle-to-bigquery-using-db-link-6f2040336a47?source=collection_archive---------0-----------------------#2022-05-25">https://medium.com/google-cloud/connect-oracle-to-bigquery-using-db-link-6f2040336a47?source=collection_archive---------0-----------------------#2022-05-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1ae3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">背景:</strong>我搜索了一个简单的、端到端的、<strong class="ih hj">工作指南</strong>来使用Simba BigQuery ODBC驱动程序配置Oracle数据库网关。然而，我找不到一本<strong class="ih hj">完整指南</strong>，所以我决定写这本。</p><p id="79a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Oracle有一个很酷的特性，叫做异构服务(或Oracle数据库网关),用来连接不同类型的数据库。这样，只需使用Oracle数据库中的数据库链接，您就可以在没有任何ETL工具的情况下直接访问具有ODBC驱动程序的数据库。</p><p id="cc3f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是4步Oracle数据库网关到BigQuery的配置；</p><p id="b980" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1-创建用于从Oracle访问BigQuery的GCP服务帐户</p><p id="3c62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2-在Oracle数据库服务器上配置Simba ODBC驱动程序</p><p id="5515" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3-配置Oracle HS和Oracle监听器</p><p id="6845" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4-创建数据库链接并运行查询</p><p id="bab8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们进入这些点之前，这里是架构的样子；</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/321f4ed4cec38dcaccf89ea06f29bd96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t4JfY_235q_L273erPjE1w.png"/></div></div></figure><h2 id="2800" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">1-创建用于从Oracle访问BigQuery的GCP服务帐户</h2><p id="29bf" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">有两种方法可以进入GCP。您可以使用个人帐户或创建服务帐户。Simba ODBC驱动程序支持这两种选项。在这篇博文中，我将选择服务账户。</p><p id="5156" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请要求您的GCP项目所有者获取服务帐户和密钥，或者如果您是项目所有者，请创建一个服务帐户，生成密钥并授予服务帐户的BigQuery User + BigQuery Editor权限。</p><p id="e6a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(如果你是GCP的新手，你可以按照这个指南创建服务帐户<a class="ae kp" href="https://cloud.google.com/iam/docs/creating-managing-service-accounts" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/iam/docs/creating-managing-service-accounts</a>并按照这个<a class="ae kp" href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/iam/docs/creating-managing-service-account-keys</a>创建密钥。)</p><p id="feed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2-在Oracle数据库服务器上配置Simba ODBC驱动程序</strong></p><p id="a335" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里的所有步骤都是以root用户身份完成的，但它也可以是“oracle”操作系统用户，您只需要设置一个属于oracle的不同路径。</p><p id="e82c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">下载BigQuery的Simba ODBC驱动:</strong></p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="59b0" class="jp jq hi kr b fi kv kw l kx ky">wget <a class="ae kp" href="https://storage.googleapis.com/simba-bq-release/odbc/SimbaODBCDriverforGoogleBigQuery64_2.1.11.1011.tar.gz" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/simba-bq-release/odbc/SimbaODBCDriverforGoogleBigQuery64_2.1.11.1011.tar.gz</a></span></pre><p id="3ce3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在/opt下提取它:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="002e" class="jp jq hi kr b fi kv kw l kx ky">tar — directory=/opt -zxvf SimbaODBCDriverforGoogleBigQuery64_2.1.11.1011.tar.gz</span></pre><p id="bd1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将您在上一步中获得的服务帐户密钥复制到/opt/simba/googlebigqueryodbc(或者复制到任何位置，记住您需要稍后定义路径)</p><p id="2d5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">编辑位于/opt/Simba/googlebigqueryodbc/Setup/odbc.ini中的odbc . ini文件:</strong></p><p id="610f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要64位配置，odbc.ini文件中已经有一个示例[Google BigQuery 64位]配置定义。我不喜欢空白，因此我用[bq]改变了[Google BigQuery 64位]。Oracle HS配置中需要此定义。</p><p id="c091" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想把[Google BigQuery 64位]也换成[bq]；</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="28ac" class="jp jq hi kr b fi kv kw l kx ky">Under [ODBC Data Sources] (line 10ish):<br/>Replace;<br/>Google BigQuery 64-bit=Simba ODBC Driver for Google BigQuery 64-bit<br/>with; <br/>bq=Simba ODBC Driver for Google BigQuery 64-bit<br/>----<br/>And at line 68ish Replace [Google BigQuery 64-bit] with [bq]</span></pre><p id="e527" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更改/设置以下属性:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="52bc" class="jp jq hi kr b fi kv kw l kx ky"><strong class="kr hj">Driver</strong>=/opt/simba/googlebigqueryodbc/lib/64/libgooglebigqueryodbc_sb64.so<br/><strong class="kr hj">Catalog</strong>=your-gcp-project-id<br/><strong class="kr hj">SQLDialect</strong>=1<br/><strong class="kr hj">OAuthMechanism</strong>=0<br/><strong class="kr hj">Email</strong>=<a class="ae kp" href="mailto:Email=bq-user@nokia-bms-poc.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">your-gcp-service-account@your-gcp-project-id.iam.gserviceaccount.com</a><br/><strong class="kr hj">KeyFilePath</strong>=/opt/simba/googlebigqueryodbc/sa_key.json</span></pre><p id="19e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(可选)如果需要打开调试日志记录，请设置以下附加属性:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="8930" class="jp jq hi kr b fi kv kw l kx ky"><strong class="kr hj">LogLevel</strong>=5<br/><strong class="kr hj">LogPath</strong>=/opt/simba/googlebigqueryodbc/logs</span></pre><p id="169b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(请参阅附录末尾这些更改后的完整odbc.ini文件)</p><p id="e0ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">编辑位于/opt/Simba/googlebigqueryodbc/Setup/odbc . ini中的odbcinst.ini文件:</strong></p><p id="9bea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将$(INSTALLDIR)替换为“/opt/Simba/googlebigqueryodbc ”, odbc焦油球被提取到此处。</p><p id="a619" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更改后的odbcinst.ini:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="dd2f" class="jp jq hi kr b fi kv kw l kx ky"># To use this INI file, replace $(INSTALLDIR) with the<br/># directory the tarball was extracted to.</span><span id="d13a" class="jp jq hi kr b fi kz kw l kx ky">[ODBC Drivers]<br/>Simba ODBC Driver for Google BigQuery 32-bit=Installed<br/>Simba ODBC Driver for Google BigQuery 64-bit=Installed</span><span id="3d99" class="jp jq hi kr b fi kz kw l kx ky">[Simba ODBC Driver for Google BigQuery 32-bit]<br/>Description=Simba ODBC Driver for Google BigQuery(32-bit)<br/>Driver=$(INSTALLDIR)/lib/libgooglebigqueryodbc_sb32.so</span><span id="2a17" class="jp jq hi kr b fi kz kw l kx ky">[Simba ODBC Driver for Google BigQuery 64-bit]<br/>Description=Simba ODBC Driver for Google BigQuery(64-bit)<br/>#Driver=$(INSTALLDIR)/lib/libgooglebigqueryodbc_sb64.so<br/>Driver=/opt/simba/googlebigqueryodbc/lib/64/libgooglebigqueryodbc_sb64.so</span><span id="4528" class="jp jq hi kr b fi kz kw l kx ky">## The option below is for using unixODBC when compiled with -DSQL_WCHART_CONVERT.<br/>## Execute 'odbc_config --cflags' to determine if you need to uncomment it.<br/># IconvEncoding=UCS-4LE</span></pre><p id="3522" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">编辑位于/opt/Simba/googlebigqueryodbc/lib/64/中的Simba . googlebigqueryodbc . ini</strong></p><p id="691d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在此定义编码；</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="aeea" class="jp jq hi kr b fi kv kw l kx ky">DriverManagerEncoding=UTF-8</span></pre><p id="a201" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，您可以通过设置来启用调试日志记录:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="ee0a" class="jp jq hi kr b fi kv kw l kx ky">LogLevel=5<br/>LogPath=/opt/simba/googlebigqueryodbc/logs</span></pre><p id="0a7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">经过这些更改后，simba.googlebigqueryodbc.ini文件应该如下所示:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="0585" class="jp jq hi kr b fi kv kw l kx ky"># To use this INI file, replace $(INSTALLDIR) with the<br/># directory the tarball was extracted to.</span><span id="61cc" class="jp jq hi kr b fi kz kw l kx ky">[Driver]<br/>DriverManagerEncoding=UTF-8<br/>ErrorMessagesPath=/opt/simba/googlebigqueryodbc/ErrorMessages<br/>LogLevel=5<br/>LogPath=/opt/simba/googlebigqueryodbc/logs<br/>IgnoreTransactions=1</span><span id="613b" class="jp jq hi kr b fi kz kw l kx ky">## — Note that the path to your ODBC Driver Manager must be specified in LD_LIBRARY_PATH.</span></pre><p id="619b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用isql测试您的配置:</strong></p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="39b7" class="jp jq hi kr b fi kv kw l kx ky"><em class="la">#Set your environment variables first:</em></span><span id="b001" class="jp jq hi kr b fi kz kw l kx ky">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib<br/>export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/simba/googlebigqueryodbc/lib/<br/>export ODBCINI=/opt/simba/googlebigqueryodbc/Setup/odbc.ini<br/>export SIMBAGOOGLEBIGQUERYODBCINI=/opt/simba/googlebigqueryodbc/lib/64/simba.googlebigqueryodbc.ini</span></pre><p id="2a44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从cmd行调用isql:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="02bd" class="jp jq hi kr b fi kv kw l kx ky">isql bq</span><span id="9195" class="jp jq hi kr b fi kz kw l kx ky">#run a sample query on BQ:<br/>SQL&gt; select * from `your-project-id.dataset.table_name`;</span></pre><p id="ad70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您看到了您的查询结果，那么恭喜您，您已经完成了第一个棘手的部分！现在我们需要配置Oracle HS。</p><h2 id="0ca2" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated"><strong class="ak"> 3-配置Oracle HS和Oracle监听器</strong></h2><p id="1ca7" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">第二个棘手的问题来了，切换到oracle user并转到$ORACLE_HOME。在ORACLE _ HOME下有hs文件夹，在该文件夹下有admin文件夹，我们需要在其中<strong class="ih hj">创建一个新的initbq.ora </strong>文件来定义我们的HS配置。</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="0725" class="jp jq hi kr b fi kv kw l kx ky"><strong class="kr hj">cd $ORACLE_HOME/hs/admin</strong><br/>vi initbq.ora</span></pre><p id="13c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">定义以下参数:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="0c26" class="jp jq hi kr b fi kv kw l kx ky">HS_FDS_CONNECT_INFO = "bq"<br/>HS_FDS_SHAREABLE_NAME = /usr/lib64/libodbc.so <br/><strong class="kr hj"># Note that above path is not the ODBC lib path that we downloaded and extracted but the ODBC Driver Manager's path!<br/></strong>HS_LANGUAGE=AMERICAN_AMERICA.WE8ISO8859P1</span><span id="94d0" class="jp jq hi kr b fi kz kw l kx ky">set ODBCINI=/opt/simba/googlebigqueryodbc/Setup/odbc.ini<br/>set SIMBAGOOGLEBIGQUERYODBCINI=/opt/simba/googlebigqueryodbc/lib/64/simba.googlebigqueryodbc.ini<br/>set LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib:/opt/simba/googlebigqueryodbc/lib/64</span></pre><p id="7a1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是initbq.ora文件示例:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="3b43" class="jp jq hi kr b fi kv kw l kx ky">#<br/># HS init parameters<br/>#</span><span id="de50" class="jp jq hi kr b fi kz kw l kx ky">HS_FDS_CONNECT_INFO = "bq" <br/>#HS_FDS_TRACE_LEVEL = DEBUG <br/>HS_FDS_SHAREABLE_NAME = /usr/lib64/libodbc.so<br/>HS_LANGUAGE=AMERICAN_AMERICA.WE8ISO8859P1<br/><br/>#<br/># ODBC specific environment variables<br/>#<br/>set ODBCINI=/opt/simba/googlebigqueryodbc/Setup/odbc.ini<br/>set SIMBAGOOGLEBIGQUERYODBCINI=/opt/simba/googlebigqueryodbc/lib/64/simba.googlebigqueryodbc.ini<br/>set LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib:/opt/simba/googlebigqueryodbc/lib/64</span></pre><p id="6c28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">配置您的listener.ora文件，以便您的监听器可以监听hs (bq)实例。</strong>如果您没有listener.ora文件，您需要创建一个。</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="5bf4" class="jp jq hi kr b fi kv kw l kx ky">cd $ORACLE_HOME/network/admin<br/>vi listener.ora</span></pre><p id="7cf0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要为bq HS配置定义SID_DESC。将以下内容添加到SID_LIST_LISTENER中:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="7aa5" class="jp jq hi kr b fi kv kw l kx ky">     (SID_DESC=<br/>         (SID_NAME=bq)<br/>         (ORACLE_HOME=/u01/app/oracle/product/19c/dbhome_1)<br/>         (PROGRAM=dg4odbc)<br/>      )</span></pre><p id="3039" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更改后的样本listener.ora文件:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="816a" class="jp jq hi kr b fi kv kw l kx ky">LISTENER =<br/>    (DESCRIPTION_LIST =<br/>        (DESCRIPTION =<br/>          (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1521))<br/>        )<br/>    )</span><span id="52d4" class="jp jq hi kr b fi kz kw l kx ky">SID_LIST_LISTENER=<br/>   (SID_LIST=<br/>      (SID_DESC=<br/>        (SID_NAME=orclsid)<br/>        (ORACLE_HOME=/u01/app/oracle/product/19c/dbhome_1)<br/>      )<br/>      (SID_DESC=<br/>        (SID_NAME=orclsidXDB)<br/>        (ORACLE_HOME=/u01/app/oracle/product/19c/dbhome_1)<br/>      )<br/>      (SID_DESC=<br/>         (SID_NAME=bq)<br/>         (ORACLE_HOME=/u01/app/oracle/product/19c/dbhome_1)<br/>         (PROGRAM=dg4odbc)<br/>      )<br/>   )</span></pre><p id="7ed6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在tnsnames.ora 文件中为bq hs实例添加一个<strong class="ih hj"> TNS条目。</strong></p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="6901" class="jp jq hi kr b fi kv kw l kx ky">bq  =<br/>  (DESCRIPTION =<br/>    (ADDRESS = (PROTOCOL = tcp)(HOST = localhost)(PORT = 1521))<br/>    (CONNECT_DATA =<br/>      (SID = bq)<br/>    )<br/>    (HS = OK)<br/>  )</span></pre><p id="6a9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(如果$ORACLE_HOME/network/admin下没有tnsnames.ora文件，则需要创建一个来启用HS。)</p><p id="2635" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">重新启动您的Oracle监听器:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="d7ff" class="jp jq hi kr b fi kv kw l kx ky">lsnrctl stop<br/>lsnrctl start</span></pre><p id="54c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在此阶段，我们完成了HS配置。</p><h2 id="aadd" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">4-创建数据库链接并运行查询</h2><p id="5475" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">使用sqlplus或任何客户端，使用您的数据库用户登录到您的数据库；</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="e933" class="jp jq hi kr b fi kv kw l kx ky">sqlplus db_user/password@db_sid</span></pre><p id="fcea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建数据库链接；</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="9893" class="jp jq hi kr b fi kv kw l kx ky">CREATE DATABASE LINK bq CONNECT TO “dataset_name” IDENTIFIED BY “password” USING ‘bq’;</span></pre><p id="46a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里我使用了“dataset_name ”,这是BigQuery中实际的数据集名称。然而，您不需要实际的dataset_name或密码，您只需要为“Connect to”和“password”提供一些东西(任何东西)来创建数据库链接。</p><p id="4ec1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，最后，我们到了你到目前为止所做的一切都有了结果或者你评论你的问题的时候了。</p><p id="0c3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用数据库链接对BigQuery运行select查询:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="6ec9" class="jp jq hi kr b fi kv kw l kx ky">select * from "dataset"."table_name"@bq;</span></pre><p id="a10c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，默认情况下，Oracle不区分大小写，如果您不将数据集和表的名称用双引号括起来，它会自动转换为大写。</p><p id="d8da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你看到你的查询结果，恭喜你！</p><p id="d1f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您也可以使用数据库链接插入到BigQuery:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="719a" class="jp jq hi kr b fi kv kw l kx ky">insert into "dataset"."table_name"@bq(COLUMN_NAME) values ('some value here')</span></pre><p id="5965" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于Oracle的一个缺陷，运行更新和删除有点棘手:</p><p id="5036" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，如果您运行下面的update或delete语句；</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="d943" class="jp jq hi kr b fi kv kw l kx ky">update “dataset”.”table_name”@bq set NAME=’sam’ where NAME=’some value’</span><span id="3467" class="jp jq hi kr b fi kz kw l kx ky">delete “dataset”.”table_name”@bq where ”intfield”=1 ;</span></pre><p id="13fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将得到如下错误:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="48b3" class="jp jq hi kr b fi kv kw l kx ky">ERROR at line 1:</span><span id="8744" class="jp jq hi kr b fi kz kw l kx ky">ORA-28500: connection from ORACLE to a non-Oracle system returned this message:</span><span id="25bd" class="jp jq hi kr b fi kz kw l kx ky">[Simba][BigQuery] (70) Invalid query: Unrecognized name: dataset_name; Did you mean</span><span id="b5cd" class="jp jq hi kr b fi kz kw l kx ky">table_name? at [1:48] {42000,NativeErr = 70}</span><span id="5d58" class="jp jq hi kr b fi kz kw l kx ky">ORA-02063: preceding 2 lines from BQ</span></pre><p id="19c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有一个Oracle错误，它会自动将update/delete语句中的列名转换为完全限定的(dataset.table.column)格式，这是BigQuery的错误格式。</p><p id="5b5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在ODBC日志中清楚地看到这一点:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="7e39" class="jp jq hi kr b fi kv kw l kx ky">May 24 13:53:02.301 INFO  2205617216 StatementState::InternalPrepare: Preparing query: UPDATE `test`.`test3` SET `intfield` = 2 WHERE <strong class="kr hj">`test`.`test3`.`intfield`</strong>=1</span><span id="2b8f" class="jp jq hi kr b fi kz kw l kx ky">May 24 13:53:02.301 DEBUG 2205617216 GStatement::CreateDataEngine: Check Driver Locking.</span><span id="9c01" class="jp jq hi kr b fi kz kw l kx ky">May 24 13:53:02.301 INFO  2205617216 GDataEngine::Prepare: UPDATE `test`.`test3` SET `intfield` = 2 WHERE <strong class="kr hj">`test`.`test3`.`intfield`</strong>=1</span><span id="a060" class="jp jq hi kr b fi kz kw l kx ky">May 24 13:53:02.301 INFO  2205617216 GDataEngine::Prepare: Query after escape: UPDATE `test`.`test3` SET `intfield` = 2 WHERE <strong class="kr hj">`test`.`test3`.`intfield`</strong>=1</span></pre><p id="1322" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不知道Oracle为什么这样做，但它可能是在解决另一个bug时引入的。(请参见Oracle错误10432873)</p><p id="a00b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果确实想从BigQuery中更新/删除BQ表，可以使用DBMS_HS_PASSTHROUGH:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="0f6c" class="jp jq hi kr b fi kv kw l kx ky">DECLARE<br/>ret_num INTEGER;<br/>BEGIN<br/>ret_num := DBMS_HS_PASSTHROUGH.EXECUTE_IMMEDIATE@bq<br/>('delete test.test3  where intfield=2');<br/>END;<br/>/</span></pre><p id="d66a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你走了这么远，这是最后的祝贺！你完了！享受您的直接连接。</p><p id="3d71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请让我知道，它是如何在评论中进行的。</p><blockquote class="lb lc ld"><p id="d7b1" class="if ig la ih b ii ij ik il im in io ip le ir is it lf iv iw ix lg iz ja jb jc hb bi translated">如果我有可能将Oracle数据库直接连接到BigQuery，为什么我还需要其他工具将数据从Oracle传到BQ？</p></blockquote><p id="274b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请评论你的想法！</p><h2 id="7db9" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">附录</h2><p id="e98e" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">步骤2之后的完整odbc.ini文件:</p><pre class="je jf jg jh fd kq kr ks kt aw ku bi"><span id="3df3" class="jp jq hi kr b fi kv kw l kx ky"># To use this INI file, replace $(INSTALLDIR) with the<br/># directory the tarball was extracted to.</span><span id="cdc7" class="jp jq hi kr b fi kz kw l kx ky">[ODBC]<br/>Trace=no</span><span id="1658" class="jp jq hi kr b fi kz kw l kx ky">[ODBC Data Sources]<br/>Google BigQuery 32-bit=Simba ODBC Driver for Google BigQuery 32-bit<br/>bq=Simba ODBC Driver for Google BigQuery 64-bit</span><span id="af21" class="jp jq hi kr b fi kz kw l kx ky">[Google BigQuery 32-bit]</span><span id="eb9b" class="jp jq hi kr b fi kz kw l kx ky"># Description: DSN Description.<br/># This key is not necessary and is only to give a description of the data source.<br/>Description=Simba ODBC Driver for Google BigQuery (32-bit) DSN</span><span id="98dc" class="jp jq hi kr b fi kz kw l kx ky"># Driver: The location where the ODBC driver is installed to.<br/>Driver=$(INSTALLDIR)/lib/32/libgooglebigqueryodbc_sb32.so</span><span id="7a98" class="jp jq hi kr b fi kz kw l kx ky"># These values can be set here, or on the connection string.<br/># Catalog: The catalog to connect to. This is a required setting.<br/>#Catalog=</span><span id="9b84" class="jp jq hi kr b fi kz kw l kx ky"># SQLDialect: The SQL Dialect to use.  There are two SQL dialects:<br/># 0 = BigQuery Legacy SQL<br/># 1 = BigQuery Standard SQL (SQL 11)<br/>SQLDialect=1</span><span id="c630" class="jp jq hi kr b fi kz kw l kx ky"># OAuth Mechanism: The OAuth mechanism to use.  There are two choices:<br/># 0 = Service Authentication<br/># 1 = User Authentication<br/>#<br/># This is a required setting.<br/>OAuthMechanism=1</span><span id="8018" class="jp jq hi kr b fi kz kw l kx ky"># RefreshToken: The Refresh Token used. This can be generated from the Windows connection dialog.<br/># It can also be generated by executing the following steps:<br/># 1. Get an Authentication by logging into Google from the following URL:<br/># <a class="ae kp" href="https://accounts.google.com/o/oauth2/auth?scope=https://www.googleapis.com/auth/bigquery&amp;response_type=code&amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob&amp;client_id=977385342095.apps.googleusercontent.com&amp;hl=en&amp;from_login=1&amp;as=76356ac9e8ce640b&amp;pli=1&amp;authuser=0" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com/o/oauth2/auth?scope=https://www.googleapis.com/auth/bigquery&amp;response_type=code&amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob&amp;client_id=977385342095.apps.googleusercontent.com&amp;hl=en&amp;from_login=1&amp;as=76356ac9e8ce640b&amp;pli=1&amp;authuser=0</a><br/># 2. Run the get_refresh_token.sh shell script and pass in the Authentication Token received in step 1.<br/># 3. Copy the Refresh Token (the text on the right-side of the colon, without the trailing or leading spaces) from the output of the script.<br/># This is a required setting.<br/>#RefreshToken=</span><span id="66bd" class="jp jq hi kr b fi kz kw l kx ky"># Email: For Service Authentication, this is a required setting. It is your GENERATED service account email (not a typical Gmail account).<br/># It is unique and associated with at least one public/private key pair.<br/># Email=</span><span id="eb55" class="jp jq hi kr b fi kz kw l kx ky"># KeyFile Path: For Service Authentication, this is a required setting.  This is the path to the stored keyfile (.p12).<br/># KeyFilePath=</span><span id="81b8" class="jp jq hi kr b fi kz kw l kx ky"># Used to specify the full path of the PEM formatted file containing trusted SSL CA certificates.<br/># If an empty string is passed in for the configuration, the driver expects the trusted SSL CA<br/># certificates can be found in the file named cacerts.pem located in the same directory as the<br/># driver's shared library.<br/>#TrustedCerts=</span><span id="30aa" class="jp jq hi kr b fi kz kw l kx ky"># AllowLargeResults: When set to 1, the driver allows for result sets in responses to be larger than 128 MB.<br/>AllowLargeResults=0</span><span id="224c" class="jp jq hi kr b fi kz kw l kx ky"># LargeResultsDataSetId: DatasetId to store temporary tables created.  This is a required setting if AllowLargeResults is set to 1.<br/>LargeResultsDataSetId=_bqodbc_temp_tables</span><span id="4cdf" class="jp jq hi kr b fi kz kw l kx ky"># LargeResultsTempTableExpirationTime: Time in milliseconds before the temporary tables created expire.  This is a required setting if AllowLargeResults is set to 1.<br/>LargeResultsTempTableExpirationTime=3600000</span><span id="06e7" class="jp jq hi kr b fi kz kw l kx ky">[bq]</span><span id="7a00" class="jp jq hi kr b fi kz kw l kx ky"># Description: DSN Description.<br/># This key is not necessary and is only to give a description of the data source.<br/>Description=Simba ODBC Driver for Google BigQuery (64-bit) DSN</span><span id="2cac" class="jp jq hi kr b fi kz kw l kx ky"># Driver: The location where the ODBC driver is installed to.<br/>Driver=/opt/simba/googlebigqueryodbc/lib/64/libgooglebigqueryodbc_sb64.so</span><span id="6fc6" class="jp jq hi kr b fi kz kw l kx ky"># These values can be set here, or on the connection string.<br/># Catalog: The catalog to connect to. This is a required setting.<br/>Catalog=your-gcp-project-id</span><span id="c7c5" class="jp jq hi kr b fi kz kw l kx ky"># SQLDialect: The SQL Dialect to use.  There are two SQL dialects:<br/># 0 = BigQuery Legacy SQL<br/># 1 = BigQuery Standard SQL (SQL 11)<br/>SQLDialect=1</span><span id="e444" class="jp jq hi kr b fi kz kw l kx ky"># OAuth Mechanism: The OAuth mechanism to use.  There are two choices:<br/># 0 = Service Authentication<br/># 1 = User Authentication<br/>#<br/># This is a required setting.<br/>OAuthMechanism=0</span><span id="3dc0" class="jp jq hi kr b fi kz kw l kx ky"># RefreshToken: The Refresh Token used. This can be generated from the Windows connection dialog.<br/># It can also be generated by executing the following steps:<br/># 1. Get an Authentication by logging into Google from the following URL:<br/># <a class="ae kp" href="https://accounts.google.com/o/oauth2/auth?scope=https://www.googleapis.com/auth/bigquery&amp;response_type=code&amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob&amp;client_id=977385342095.apps.googleusercontent.com&amp;hl=en&amp;from_login=1&amp;as=76356ac9e8ce640b&amp;pli=1&amp;authuser=0" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com/o/oauth2/auth?scope=https://www.googleapis.com/auth/bigquery&amp;response_type=code&amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob&amp;client_id=977385342095.apps.googleusercontent.com&amp;hl=en&amp;from_login=1&amp;as=76356ac9e8ce640b&amp;pli=1&amp;authuser=0</a><br/># 2. Run the get_refresh_token.sh shell script and pass in the Authentication Token received in step 1.<br/># 3. Copy the Refresh Token (the text on the right-side of the colon, without the trailing or leading spaces) from the output of the script.<br/># This is a required setting.<br/>#RefreshToken=<br/>IgnoreTransactions=1<br/># Email: For Service Authentication, this is a required setting. It is your GENERATED service account email (not a typical Gmail account).<br/># It is unique and associated with at least one public/private key pair.<br/><a class="ae kp" href="mailto:Email=bq-user@nokia-bms-poc.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">Email=your-gcp-service-account@your-gcp-project-id.iam.gserviceaccount.com</a></span><span id="2893" class="jp jq hi kr b fi kz kw l kx ky"># KeyFile Path: For Service Authentication, this is a required setting.  This is the path to the stored keyfile (.p12).<br/>KeyFilePath=/opt/simba/googlebigqueryodbc/sa_key.json</span><span id="a3fb" class="jp jq hi kr b fi kz kw l kx ky"># Used to specify the full path of the PEM formatted file containing trusted SSL CA certificates.<br/># If an empty string is passed in for the configuration, the driver expects the trusted SSL CA<br/># certificates can be found in the file named cacerts.pem located in the same directory as the<br/># driver's shared library.<br/>#TrustedCerts=</span><span id="d381" class="jp jq hi kr b fi kz kw l kx ky"># AllowLargeResults: When set to 1, the driver allows for result sets in responses to be larger than 128 MB.<br/>AllowLargeResults=0</span><span id="4dcf" class="jp jq hi kr b fi kz kw l kx ky"># LargeResultsDataSetId: DatasetId to store temporary tables created.  This is a required setting if AllowLargeResults is set to 1.<br/>LargeResultsDataSetId=_bqodbc_temp_tables<br/>LogLevel=5<br/>LogPath=/opt/simba/googlebigqueryodbc/logs<br/># LargeResultsTempTableExpirationTime: Time in milliseconds before the temporary tables created expire.  This is a required setting if AllowLargeResults is set to 1.<br/>LargeResultsTempTableExpirationTime=3600000</span></pre></div></div>    
</body>
</html>