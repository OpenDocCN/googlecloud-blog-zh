<html>
<head>
<title>Exploring Google Cloud API Gateway with Google Cloud Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用谷歌云功能探索谷歌云API网关</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/exploring-google-cloud-api-gateway-with-google-cloud-functions-ff56c1c96cc9?source=collection_archive---------0-----------------------#2021-09-17">https://medium.com/google-cloud/exploring-google-cloud-api-gateway-with-google-cloud-functions-ff56c1c96cc9?source=collection_archive---------0-----------------------#2021-09-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="0cf9" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">创建一个安全的API网关，可以处理参数和表单数据(文件上传),并将它们转发给适当的云功能</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/029e0b00a0811a0744e6d85c14ae9140.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r1JIQpCfWHPO2xYbslLkfw.jpeg"/></div></div></figure><p id="b29d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们都爱API。你需要或想从互联网上得到的任何东西，要么有一个API，要么你可以创建一个。这就是我们所做的。在我们的组织中，我们为几乎所有可以卸载到服务器的任务构建了API。但是，我们有太多的API。因此，我们需要一些服务来执行我们的API的两个关键任务:</p><ol class=""><li id="3d71" class="kf kg hi jl b jm jn jp jq js kh jw ki ka kj ke kk kl km kn bi translated">为所有相关的API创建一个公共网关，以保持API触发器结构化、通用且易于管理。</li><li id="9c72" class="kf kg hi jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn bi translated">让公开开放的API更加安全。</li></ol><p id="8859" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">因为我们所有的API都托管在GCP，所以我们选择Google API Gateway是很自然的。现在让我们看看Google Cloud API Gateway是如何解决我们的问题的。</p><h1 id="4567" class="kt ku hi bd kv kw kx ky kz la lb lc ld io le ip lf ir lg is lh iu li iv lj lk bi translated">先决条件</h1><p id="4b91" class="pw-post-body-paragraph jj jk hi jl b jm ll ij jo jp lm im jr js ln ju jv jw lo jy jz ka lp kc kd ke hb bi translated">我假设您已经准备好了以下资源。如果没有，下面的链接将帮助您入门:</p><ol class=""><li id="cc21" class="kf kg hi jl b jm jn jp jq js kh jw ki ka kj ke kk kl km kn bi translated">已激活计费的GCP帐户。如果您还没有，您可以使用$300 的<a class="ae lq" href="https://cloud.google.com/free" rel="noopener ugc nofollow" target="_blank">免费层创建一个新的。</a></li><li id="f187" class="kf kg hi jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn bi translated"><a class="ae lq" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" rel="noopener ugc nofollow" target="_blank">一个GCP项目</a></li><li id="fdd0" class="kf kg hi jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn bi translated"><a class="ae lq" href="https://codelabs.developers.google.com/codelabs/cloud-starting-cloudfunctions#0" rel="noopener ugc nofollow" target="_blank">谷歌云功能</a>(我正在使用谷歌云功能，但你也可以使用应用引擎和云运行)。</li></ol><p id="af24" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">API网关可以使用OpenAPI spec 2.0进行配置。在我们开始编写实际的API配置文件之前，我们需要启用以下服务，以便我们可以部署网关。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lr"><img src="../Images/b657cad78c628a741c69d7b02aa6aaa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*54JXiLu9ix01fGQr-9NNag.png"/></div></div></figure><p id="bb7d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们还可以通过GCloud控制台使用以下命令来启用这些服务:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ls lt l"/></div></figure><p id="5016" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">API网关由两个组件组成:</p><ol class=""><li id="24b3" class="kf kg hi jl b jm jn jp jq js kh jw ki ka kj ke kk kl km kn bi translated"><strong class="jl hj"> API配置:</strong>上传API定义时创建的API配置。我们将创建API定义作为OpenAPI规范。每次我们上传一个API定义，API Gateway都会创建一个新的API配置。也就是说，我们可以创建一个API配置，但不能在以后修改它。如果我们稍后在OpenAPI规范中编辑API定义，然后上传编辑后的API定义，我们将创建一个新的API配置。</li><li id="8221" class="kf kg hi jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn bi translated"><strong class="jl hj">网关:</strong>一个基于Envoy的、高性能的、可伸缩的代理，托管已部署的API配置。当我们将API配置部署到网关时，它会创建面向外部的URL，我们的API客户端使用该URL来访问API。<br/>网关部署到特定的GCP地区(地区是我们可以部署资源的特定地理区域)。<br/>网关还必须拥有一个API配置。我们不能创建空网关，即所有网关都需要一个API配置，但是每个网关只能支持一个API配置。然而，在创建网关之后，我们可以更新网关，用一个API配置替换另一个API配置。</li></ol></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><h1 id="7941" class="kt ku hi bd kv kw mb ky kz la mc lc ld io md ip lf ir me is lh iu mf iv lj lk bi translated">创建网关和API配置:</h1><p id="1997" class="pw-post-body-paragraph jj jk hi jl b jm ll ij jo jp lm im jr js ln ju jv jw lo jy jz ka lp kc kd ke hb bi translated">既然我们已经完成了理论，让我们进入最激动人心的部分:为API网关编写实际的OpenAPI规范文件。这只是为了创建API配置。如果你想知道如何设置保存这个配置文件的网关，<a class="ae lq" href="https://cloud.google.com/api-gateway/docs/quickstart-console#creating_a_gateway" rel="noopener ugc nofollow" target="_blank">只需遵循这里给出的步骤</a>。</p><p id="b08c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">因此，让我们首先创建一个基本的spec文件，它只根据路径转发请求:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ls lt l"/></div></figure><p id="94f2" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">既然我们已经完成了。下面是我纠结的部分。现在我有了一个云函数，我需要传递1个路径参数、查询参数和1个表单数据(一个图像)。所以让我们先处理参数的传递。在下面的要点中，我创建了一个通过我们的参数的新路径:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ls lt l"/></div></figure><p id="8553" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在是通过表单数据上传图像文件的最后一部分。这是令人惊讶的最简单的部分，因为API网关会自动完成这项工作。任何附加的数据都会自动转发。</p><h1 id="13da" class="kt ku hi bd kv kw kx ky kz la lb lc ld io le ip lf ir lg is lh iu li iv lj lk bi translated">保护API:</h1><p id="2be6" class="pw-post-body-paragraph jj jk hi jl b jm ll ij jo jp lm im jr js ln ju jv jw lo jy jz ka lp kc kd ke hb bi translated">这是另一个对我们非常重要的方面。我们的大多数API都是公开的。当然，我们可以将它们设为私有，并使用谷歌的JWT令牌进行认证，但JWT令牌是短暂的，我们不希望每隔几个小时就为大量使用我们API的设备和应用程序生成一个新令牌。</p><p id="6ced" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">输入API密钥，这些密钥是手动生成的，可以在网关上使用单个密钥来验证网关中链接的所有API。还有其他方法来验证(<a class="ae lq" href="https://cloud.google.com/api-gateway/docs/authenticating-users-jwt" rel="noopener ugc nofollow" target="_blank"> JWT </a>、<a class="ae lq" href="https://cloud.google.com/api-gateway/docs/authenticating-users-firebase" rel="noopener ugc nofollow" target="_blank"> Firebase </a>、<a class="ae lq" href="https://cloud.google.com/api-gateway/docs/authenticating-users-auth0" rel="noopener ugc nofollow" target="_blank"> Auth0 </a>、<a class="ae lq" href="https://cloud.google.com/api-gateway/docs/authenticating-users-okta" rel="noopener ugc nofollow" target="_blank"> Okta </a>、<a class="ae lq" href="https://cloud.google.com/api-gateway/docs/authenticating-users-googleid" rel="noopener ugc nofollow" target="_blank"> Google Id令牌</a>)，但这就是我们要做的。<br/>现在，如果您想知道如何生成API密钥，<a class="ae lq" href="https://cloud.google.com/docs/authentication/api-keys" rel="noopener ugc nofollow" target="_blank">只需遵循这里给出的文档即可。</a></p><p id="7a01" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">一旦我们生成了API密钥，我们就可以使用它们作为查询参数或头参数来进行身份验证。</p><blockquote class="mg mh mi"><p id="c1e5" class="jj jk mj jl b jm jn ij jo jp jq im jr mk jt ju jv ml jx jy jz mm kb kc kd ke hb bi translated">在我们的应用程序中使用API key，对于查询参数使用key=API_KEY参数，对于头参数使用x-api-key=API_KEY参数。</p></blockquote><p id="c6dd" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这将需要我们更改API配置文件。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ls lt l"/></div></figure><p id="6ffb" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这是最终的API配置。此外，请记住在我们的云函数中阻止未经验证的调用，否则保护API将毫无意义。</p><p id="247a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在，如果我们点击我们的API，得到一个类似“PERMISSION_DENIED: API没有为项目启用”的错误。，我们需要做的是:</p><ol class=""><li id="14a3" class="kf kg hi jl b jm jn jp jq js kh jw ki ka kj ke kk kl km kn bi translated">转到API和服务。</li><li id="80ac" class="kf kg hi jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn bi translated">单击屏幕顶部的启用API和服务</li><li id="ac4d" class="kf kg hi jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn bi translated">搜索我们网关的名称。</li><li id="272e" class="kf kg hi jl b jm ko jp kp js kq jw kr ka ks ke kk kl km kn bi translated">启用API</li></ol><p id="0cdf" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们已经完成了网关的设置。</p><p id="721c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当我开始从事API网关的工作时，我发现这是一个有趣的、潜在的非常强大的服务。尽管如此，还是缺少详细的文档，因此才有了这篇文章。我希望你们能享受这项服务。</p><p id="e952" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">感谢阅读！如果你觉得这篇文章有用，请分享。请鼓掌👏来表示点爱:)</strong></p><p id="6a55" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">让我们在</strong><a class="ae lq" href="https://www.linkedin.com/in/sudipta-dey-667548179/" rel="noopener ugc nofollow" target="_blank"><strong class="jl hj">LinkedIn</strong></a><strong class="jl hj">和</strong><a class="ae lq" href="https://github.com/doomSDey" rel="noopener ugc nofollow" target="_blank"><strong class="jl hj">GitHub</strong></a><strong class="jl hj">上成为朋友。</strong></p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mn"><img src="../Images/0221255e0d0e8a48431c5a0151cba0b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CCS_VdGP82HzKNn6IaTa5A.png"/></div></div></figure></div></div>    
</body>
</html>