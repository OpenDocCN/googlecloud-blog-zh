<html>
<head>
<title>Connecting Cloud Functions with Compute Engine using Serverless VPC Access</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用无服务器VPC访问将云功能与计算引擎连接起来</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/connecting-cloud-functions-with-compute-engine-using-serverless-vpc-access-79c5cd7420c7?source=collection_archive---------2-----------------------#2019-06-21">https://medium.com/google-cloud/connecting-cloud-functions-with-compute-engine-using-serverless-vpc-access-79c5cd7420c7?source=collection_archive---------2-----------------------#2019-06-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="da3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌云平台(GCP)上的无服务器产品，如云功能和应用引擎，由于其无服务器的性质(隐藏的服务器基础设施)，只能通过其公共IP地址连接到一些GCP产品(计算引擎、内存存储、云SQL ),这当然增加了安全风险，因为它们暴露于整个互联网，并增加了延迟，因为流量通过公共互联网而不是通过快速的谷歌网络。在大多数情况下，产品可以选择只有内部IP地址，但不能从互联网访问，只能从GCP网络内访问，但到目前为止，由于网络问题，无服务器产品无法通过这种方式进行连接。</p><p id="84ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最近GCP推出了<a class="ae jd" href="https://cloud.google.com/vpc/docs/configure-serverless-vpc-access" rel="noopener ugc nofollow" target="_blank">无服务器VPC接入</a>，它就像是VPC网络中无服务器产品和其他产品之间的粘合剂。基本上，随着无服务器VPC接入连接器的创建，处理连接和传输的f1-micro实例被创建。仅支持从无服务器实例到其他服务器的请求，不可能通过内部网络从其他产品向无服务器实例发出请求，只能通过HTTP请求通过公共互联网。</p><p id="cf80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前，无服务器VPC访问可用于云功能和应用程序引擎(尚未用于托管云运行)，并且需要在无服务器服务所在的同一地区。目前的定价是“为连接器自动提供的每100 Mbps吞吐量的as 1 <code class="du je jf jg jh b"><a class="ae jd" href="https://cloud.google.com/compute/pricing#sharedcore" rel="noopener ugc nofollow" target="_blank">f1-micro</a></code>实例”,大约每月5美元，尽管由于服务目前处于测试状态，价格可能会上涨。</p><p id="ace1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了演示功能，我将使用用Python编写的云函数，它连接到Redis(部署为计算引擎上的容器), Redis用作简单的缓存服务。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ji"><img src="../Images/70172cf8b4e9598be44325a1797a2a2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/0*TgkUSZJ9phzaZiF2.png"/></div></div></figure><p id="071f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当HTTP请求到达云函数时，在代码中，向Redis服务器发出请求，该请求通过无服务器VPC访问连接器到达具有内部IP地址的计算引擎，然后返回，如上图所示。这可以用作一个简单的缓存服务，尽管Cloud Memorystore是一个类似的托管产品，具有更多功能。</p><p id="0a1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">包含脚本和代码的存储库位于<a class="ae jd" href="https://github.com/zdenulo/cf_serverless_vpc" rel="noopener ugc nofollow" target="_blank"> Github </a>上。要做到这一点，需要完成几个步骤:</p><h1 id="d66f" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">1.正在创建计算引擎实例</h1><p id="b7ca" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们需要创建一个允许访问Redis(默认端口6379)的防火墙规则。</p><pre class="jj jk jl jm fd kx jh ky kz aw la bi"><span id="81b3" class="lb jv hi jh b fi lc ld l le lf">gcloud compute firewall-rules create allow-redis --network default --allow tcp:6379</span></pre><p id="0dc8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后创建实例</p><pre class="jj jk jl jm fd kx jh ky kz aw la bi"><span id="fadf" class="lb jv hi jh b fi lc ld l le lf">gcloud compute instances create-with-container redis-cache \<br/>--machine-type=f1-micro \<br/>--container-image=registry.hub.docker.com/library/redis \<br/>--tags=allow-redis \<br/>--zone=us-central1-a \<br/>--private-network-ip=10.128.0.2 \<br/>--network default<br/><br/>gcloud compute instances delete-access-config redis-cache</span></pre><p id="12d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我之前提到的，我正在创建一个基于Redis Docker容器映像的实例，该容器映像托管在Docker注册表上并自动部署在计算引擎实例上，我正在应用防火墙标记，明确分配内部IP地址(基于区域)和一些强制性内容，如机器类型(f1-micro用于演示目的，而非实际使用案例)、区域。现在这个实例也有了公共IP，但是在下一个命令中，我将删除它。原因是当我创建一个没有公共IP连接的实例时，它不起作用。当我用公共IP创建一个实例，然后马上删除它时，它工作正常。也许这是一些暂时的小故障，或者也许我做错了什么，但这就是我工作的方式。最后一种状态是实例只有内部IP地址。</p><h1 id="1ed2" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">2.创建无服务器VPC访问连接器</h1><p id="10bc" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">激活无服务器VPC访问API的一次性命令:</p><pre class="jj jk jl jm fd kx jh ky kz aw la bi"><span id="6f2b" class="lb jv hi jh b fi lc ld l le lf">gcloud services enable vpcaccess.googleapis.com</span></pre><p id="dca1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建连接器的命令没有太多选项:</p><pre class="jj jk jl jm fd kx jh ky kz aw la bi"><span id="fe11" class="lb jv hi jh b fi lc ld l le lf">gcloud beta compute networks vpc-access connectors create cache-connector \<br/>--network default \<br/>--region us-central1 \<br/>--range 10.8.0.0/28 \<br/>--min-throughput 200 \<br/>--max-throughput 400</span></pre><p id="f3bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">重要的是将连接器放在无服务器部署所在的同一区域。我不知道IP范围有多重要，但是在创建Web UI时推荐的10.8.0.0/28起作用了。创建后有许多选项，即只有删除连接器或查看基本数据的选项。在云控制台，无服务器VPC访问在VPC网络部分。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div class="er es lg"><img src="../Images/867b762238046a0b20f7161a5001a418.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*R9o6SJksdt7Fx-AV.png"/></div></figure><h1 id="84ef" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">3.部署云功能</h1><p id="220b" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">云函数中使用的示例代码如下所示:</p><pre class="jj jk jl jm fd kx jh ky kz aw la bi"><span id="b334" class="lb jv hi jh b fi lc ld l le lf">import os<br/>import datetime<br/>import random<br/><br/>import redis<br/><br/>r = redis.StrictRedis(host=os.environ['REDIS_HOST'], decode_responses=True)<br/><br/><br/>def main(request=None):<br/>    cache_key = datetime.datetime.now().minute<br/>    val = r.get(cache_key)<br/>    if not val:<br/>        val = random.random()<br/>        out = f'set value: {val}'<br/>        r.set(cache_key, val)<br/>    else:<br/>        out = f'value from cache: {val}'<br/>        r.delete(cache_key)<br/>    return out</span></pre><p id="ea74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我通过环境变量传递Redis实例的IP，该变量是在部署期间设置的，对应于计算引擎实例的内部IP地址。除此之外，我还获取、设置和删除缓存键，以便与Redis数据库进行交互。</p><p id="aee4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了部署云功能并与Connector配合使用，需要为云功能服务代理帐户设置额外的IAM角色，即项目/查看者和计算/网络用户。云功能服务代理账号一般有邮箱:Service-<project-number>@ GCF-admin-robot . iam . gserviceaccount . com</project-number></p><p id="4606" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">命令包括:</p><pre class="jj jk jl jm fd kx jh ky kz aw la bi"><span id="8b9f" class="lb jv hi jh b fi lc ld l le lf">gcloud projects add-iam-policy-binding $PROJECT_ID \<br/>--member=serviceAccount:service-$PROJECT_NUMBER@gcf-admin-robot.iam.gserviceaccount.com \<br/>--role=roles/viewer<br/><br/>gcloud projects add-iam-policy-binding $PROJECT_ID \<br/>--member=serviceAccount:service-$PROJECT_NUMBER@gcf-admin-robot.iam.gserviceaccount.com \<br/>--role=roles/compute.networkUser</span></pre><p id="6444" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要部署云功能，VPC连接器需要按以下格式定义:项目/<project_id>/位置/<region>/连接器/连接器名称</region></project_id></p><pre class="jj jk jl jm fd kx jh ky kz aw la bi"><span id="cc57" class="lb jv hi jh b fi lc ld l le lf">VPC_CONNECTOR=projects/adventures-on-gcp/locations/us-central1/connectors/cache-connector<br/><br/>gcloud beta functions deploy random-cache --entry-point main \<br/>--runtime python37 \<br/>--trigger-http \<br/>--region us-central1 \<br/>--vpc-connector $VPC_CONNECTOR \<br/>--set-env-vars REDIS_HOST=10.128.0.2</span></pre><p id="4110" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，当你点击云函数URL时，你应该会得到Redis的响应。</p><p id="4ab2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，无服务器VPC访问应该可以与第一代和第二代标准App Engine运行时一起工作，对于第一代和第二代标准App Engine运行时，配置是将连接器“路径”添加到yaml配置文件中，就像云函数的情况一样。</p></div><div class="ab cl lh li gp lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="hb hc hd he hf"><p id="233c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每周一我都会出版<a class="ae jd" href="https://www.gcpweekly.com" rel="noopener ugc nofollow" target="_blank"> GCP周刊</a>，这是一份关于谷歌云平台和相关技术的时事通讯，如果你有兴趣可以在网站上订阅。</p></div></div>    
</body>
</html>