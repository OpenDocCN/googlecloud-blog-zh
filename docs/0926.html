<html>
<head>
<title>Hands on Knative — Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">动手实践—第三部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/hands-on-knative-part-3-d8731ad2f23d?source=collection_archive---------3-----------------------#2019-02-19">https://medium.com/google-cloud/hands-on-knative-part-3-d8731ad2f23d?source=collection_archive---------3-----------------------#2019-02-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a391" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第1部分的<a class="ae jd" rel="noopener" href="/google-cloud/hands-on-knative-part-1-f2d5ce89944e">中，我谈到了无服务器容器的快速部署和自动伸缩的Knative服务。在</a><a class="ae jd" rel="noopener" href="/google-cloud/hands-on-knative-part-2-a27729f4d756">第2部分</a>中，我谈到了如何通过Knative Eventing以松散耦合的方式连接服务。</p><p id="8aec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个系列的第三部分也是最后一部分，我想谈谈<a class="ae jd" href="https://github.com/knative/docs/tree/master/build" rel="noopener ugc nofollow" target="_blank">的Knative Build </a>，并展示我的<a class="ae jd" href="https://github.com/meteatamel/knative-tutorial" rel="noopener ugc nofollow" target="_blank"> Knative教程</a>中的几个例子。</p><h1 id="b47c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">什么是Knative Build？</h1><p id="8e0c" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">Knative Build基本上允许你从源代码到注册表中的容器映像。例如，您可以编写一个构建来从存储库中获取源代码，构建一个容器映像，将该映像推送到注册中心，然后运行该映像，所有这些都在Kubernetes集群中完成。</p><h1 id="e2d9" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">Knative构建原语</h1><p id="62fb" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">Knative Build有4个主要原语:</p><ol class=""><li id="a5f9" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae jd" href="https://github.com/knative/docs/blob/master/build/builds.md" rel="noopener ugc nofollow" target="_blank">构建</a>:表示包含一个或多个步骤的集群内构建作业。</li><li id="0493" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://github.com/knative/docs/blob/master/build/build-templates.md" rel="noopener ugc nofollow" target="_blank"> BuildTemplate </a>:一组有序的、参数化的构建步骤。</li><li id="ab50" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://github.com/knative/docs/blob/master/build/builder-contract.md" rel="noopener ugc nofollow" target="_blank">构建器</a>:构建步骤中的一个容器，它执行一个动作(例如构建一个图像)</li><li id="25b1" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://github.com/knative/docs/blob/master/build/auth.md" rel="noopener ugc nofollow" target="_blank"> ServiceAccount </a>:用于DockerHub等的认证。</li></ol><p id="ba66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们来看一个具体的例子。</p><h1 id="845f" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">Hello World Build</h1><p id="a9fa" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在我的Knative教程的<a class="ae jd" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/09-helloworldbuild.md#hello-world-build" rel="noopener ugc nofollow" target="_blank"> Hello World Build </a>中，我们用Kaniko设计了一个Build来构建并推送一个容器到Google Cloud <a class="ae jd" href="https://cloud.google.com/container-registry/docs/" rel="noopener ugc nofollow" target="_blank">容器注册表</a> (GCR)。</p><p id="c52a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Kaniko是一个从Dockerfile文件构建容器映像的工具，位于Kubernetes集群的容器内部。Kaniko的优势在于它不依赖于Docker守护进程。</p><p id="d1e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个<code class="du kv kw kx ky b">build-helloworld-csharp-gcr.yaml</code>构建文件。它使用Knative Build下载“工作区”目录中的源代码，然后使用Kaniko作为构建器来构建映像并将其推送到GCR:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="a9b7" class="lh jf hi ky b fi li lj l lk ll">apiVersion: build.knative.dev/v1alpha1<br/>kind: Build<br/>metadata:<br/>  name: build-helloworld-csharp-gcr<br/>spec:<br/>  source:<br/>    git:<br/>      url: "https://github.com/knative/docs.git"<br/>      revision: "v0.1.x"<br/>    subPath: "serving/samples/helloworld-csharp/"<br/>  steps:<br/>  - name: build-and-push<br/>    image: "gcr.io/kaniko-project/executor:v0.6.0"<br/>    args:<br/>    - "--dockerfile=/workspace/Dockerfile"<br/>    # MY_GCP_PROJECT: Replace with the GCP Project's ID.<br/>    - "--destination=gcr.io/MY_GCP_PROJECT/helloworld-csharp:knativebuild"</span></pre><p id="c721" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过简单地应用yaml文件来终止构建(并查看进度<a class="ae jd" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/09-helloworldbuild.md#run-and-watch-the-build" rel="noopener ugc nofollow" target="_blank">，如教程中的</a>所述):</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="7f38" class="lh jf hi ky b fi li lj l lk ll">kubectl apply -f build-helloworld-csharp-gcr.yaml</span></pre><p id="9dea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在构建结束时，您应该会看到一个推送到GCR的图像:</p><figure class="kz la lb lc fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lm"><img src="../Images/d5fb161a35e9a831e9f0bb3a97337c7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/format:webp/1*oUkVZf53NR7vNMslI1MwEA.png"/></div></div></figure><h1 id="c631" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">服务帐户的秘密</h1><p id="7093" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">前面的例子不需要认证。如果您想推送至DockerHub，而身份验证不是可选的，该怎么办？我的<a class="ae jd" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/10-dockerbuild.md" rel="noopener ugc nofollow" target="_blank"> Docker Hub构建教程</a>详细解释了这些步骤，但是在这里回顾一下，你需要:</p><ol class=""><li id="f31a" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">用Base64编码的用户名和密码在Kubernetes中为DockerHub创建一个秘密。</li><li id="c539" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">在Kubernetes中创建一个使用该密码的ServiceAccount。</li><li id="90a0" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">在Knative中创建一个使用该ServiceAccount的构建。</li></ol><p id="130a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">构建定义将与之前非常相似，除了它有一个用于身份验证的额外的ServiceAccount部分:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="320d" class="lh jf hi ky b fi li lj l lk ll">apiVersion: build.knative.dev/v1alpha1<br/>kind: Build<br/>metadata:<br/>  name: build-helloworld-csharp-docker<br/>spec:<br/>  <strong class="ky hj">serviceAccountName: build-bot </strong><br/>  source:<br/>    git:<br/>      url: "https://github.com/knative/docs.git"<br/>      revision: "v0.1.x"<br/>    subPath: "serving/samples/helloworld-csharp/"<br/>  steps:<br/>  - name: build-and-push<br/>    image: "gcr.io/kaniko-project/executor:v0.6.0"<br/>    args:<br/>    - "--dockerfile=/workspace/Dockerfile"<br/>    # Replace {username} with your actual DockerHub<br/>    - "--destination=docker.io/{username}/helloworld-csharp:knativebuild"</span></pre><h1 id="748a" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">BuildTemplates和Kaniko</h1><p id="b236" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">到目前为止，我们手工定义了构建中需要的所有步骤。BuildTemplate允许您将构建步骤创建为模板，并在不同的构建中重用这些步骤。<a class="ae jd" href="https://codelabs.developers.google.com/codelabs/knative-intro/#12" rel="noopener ugc nofollow" target="_blank">使用Knative将无服务器应用程序部署到Kubernetes codelab </a>展示了如何创建自己的定制模板。</p><p id="c31f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Knative还附带了许多<a class="ae jd" href="https://github.com/knative/build-templates" rel="noopener ugc nofollow" target="_blank">构建模板</a>，您可以在构建中重用它们。其中一个模板是给Kaniko的。让我们安装该模板，以便在我们的构建中更容易使用Kaniko:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="1cc9" class="lh jf hi ky b fi li lj l lk ll">kubectl apply -f https://raw.githubusercontent.com/knative/build-templates/master/kaniko/kaniko.yaml</span></pre><p id="2af4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查模板是否已安装:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="a601" class="lh jf hi ky b fi li lj l lk ll">kubectl get buildtemplate<br/>NAME      AGE<br/>kaniko    24m</span></pre><p id="b856" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在下一节中，我们将使用这个模板来运行自动构建。</p><h1 id="dd34" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">自动构建</h1><p id="adf3" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在Knative中，您可以使用构建步骤配置Knative服务。这允许Knative在服务发生变化时构建和推送容器映像。我个人不把服务和构建混为一谈，特别是对于生产，但是对于测试来说这可能是一个好的选择。</p><p id="eeaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在我的教程的<a class="ae jd" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/11-autobuild.md" rel="noopener ugc nofollow" target="_blank">自动构建</a>部分有关于如何设置的详细说明，但是你基本上需要一个服务定义文件，如下所示:</p><pre class="kz la lb lc fd ld ky le lf aw lg bi"><span id="0409" class="lh jf hi ky b fi li lj l lk ll">apiVersion: serving.knative.dev/v1alpha1<br/>kind: Service<br/>metadata:<br/>  name: helloworld-csharp-from-source<br/>  namespace: default<br/>spec:<br/>  runLatest:<br/>    configuration:<br/>      <strong class="ky hj">build</strong>:<br/>        apiVersion: build.knative.dev/v1alpha1<br/>        kind: Build<br/>        spec:<br/>          serviceAccountName: build-bot<br/>          source:<br/>            git:<br/>              url: https://github.com/meteatamel/knative-tutorial.git<br/>              revision: master<br/>            subPath: "serving/helloworld-csharp/"<br/>          <strong class="ky hj">template</strong>:<br/>            name: kaniko<br/>            arguments:<br/>              - name: IMAGE<br/>                # Replace {username} with your actual DockerHub<br/>                value: docker.io/{username}/helloworld-csharp:from-source<br/>      revisionTemplate:<br/>        spec:<br/>          container:<br/>            # Replace {username} with your actual DockerHub<br/>            image: docker.io/{username}/helloworld-csharp:from-source<br/>            imagePullPolicy: Always<br/>            env:<br/>              - name: TARGET<br/>                value: "C# Sample from-source"</span></pre><p id="776c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意配置的内联构建部分，以及它如何使用我们之前安装的Kaniko模板。</p><p id="928d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦您应用了这个服务，您应该会看到创建了一个构建来构建和推送映像，不久之后，您应该会看到一个Knative服务启动并运行。</p></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><p id="7323" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就结束了我在Knative上的3部分系列。希望你喜欢它，并让我知道你还想读什么有意思的话题。</p></div></div>    
</body>
</html>