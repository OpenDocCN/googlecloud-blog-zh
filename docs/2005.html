<html>
<head>
<title>Google Cloud DevOps Series: Continuous Integration / Continuous Deployment Workflow (CICD)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Cloud DevOps系列:持续集成/持续部署工作流(CICD)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/part-4-google-devops-continuous-development-workflow-3feb1ea2227e?source=collection_archive---------0-----------------------#2021-11-12">https://medium.com/google-cloud/part-4-google-devops-continuous-development-workflow-3feb1ea2227e?source=collection_archive---------0-----------------------#2021-11-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="5400" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">Google Cloud DevOps系列:第4部分</h2></div><p id="3136" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">欢迎来到Google Cloud DevOps系列的第4部分..你可以在这里找到完整系列</strong><a class="ae jt" rel="noopener" href="/google-cloud/google-cloud-devops-part-1-introduction-to-google-native-devops-process-bfb55be9e3f3"><strong class="iz hj"/></a></p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ju"><img src="../Images/e3ea3165f40b4f0c8e23df1b9a6b2d3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kgsR0tG7z5uip0_HZrGkVg.png"/></div></div></figure><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es kg"><img src="../Images/9aa693227cef70ac6f635d3a7eb14bf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EsbbQg4Qmo0aw3-qaRBDhw.png"/></div></div></figure><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es kh"><img src="../Images/ae630e24f66a94af73463271844ba5d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n4tYgvvMN1cjDWmlLif0oQ.png"/></div></div></figure><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ki"><img src="../Images/f7313698a83766b8e6e3f77cdd712cb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KX5KB7Ko3PXPGjWDXKsGJQ.png"/></div></div></figure><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es kj"><img src="../Images/5111ce2bc55f76546b6d28a25d39a1fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hNT25t9vwYkKGSvu9dUyPw.png"/></div></div></figure><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ki"><img src="../Images/9da51ab214650b26e00db19ff447c9f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4nkLRVFa25eyw54sj9rOzQ.png"/></div></div></figure><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ki"><img src="../Images/b963986fc9d0da05e3772a63abe8db5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HgotytR4gXeFZdEU0gj8iw.png"/></div></div></figure><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es kk"><img src="../Images/b77798bf458f07c579e744fcfdc22b9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RX9FWnVBWwv4mmdKiFtLDw.png"/></div></div></figure><p id="9a20" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">持续集成和持续部署:动手演示</strong></p><p id="0a85" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们已经在<a class="ae jt" rel="noopener" href="/google-cloud/google-cloud-devops-series-4013adab603b">之前的博客</a>中克隆了在线精品应用。在本演示中，我们将持续集成和持续部署到QA、试运行和生产环境中。</p><p id="5e50" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">启用Google云部署、云构建、GKE和云存储API</strong></p><p id="ec62" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">创建一个Google云仓库，并将应用程序推送到仓库。</strong></p><pre class="jv jw jx jy fd kl km kn ko aw kp bi"><span id="42d3" class="kq kr hi km b fi ks kt l ku kv">PROJECT_ID=&lt;your project ID&gt;<br/>SOURCE_REPO_NAME=&lt;name of repository&gt;</span><span id="0a3c" class="kq kr hi km b fi kw kt l ku kv">gcloud source repos create $SOURCE_REPO_NAME</span></pre><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es kx"><img src="../Images/459f6b9289751d2dd60d7b33e951a075.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bGSFYZR7BHxWLYfUNmBbeQ.png"/></div></div></figure><p id="7243" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">将在线精品应用程序推送到新创建的存储库。</strong></p><p id="2065" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">为QA、试运行和生产创建3个不同的GKE环境。</strong></p><pre class="jv jw jx jy fd kl km kn ko aw kp bi"><span id="95d0" class="kq kr hi km b fi ks kt l ku kv">REGION=&lt;region name eg. us-central1&gt;</span><span id="f5a8" class="kq kr hi km b fi kw kt l ku kv">gcloud container clusters create qa-cluster --region=$REGION --scopes=cloud-platform --workload-pool=${PROJECT_ID}.svc.id.goog</span><span id="e24e" class="kq kr hi km b fi kw kt l ku kv">gcloud container clusters create staging-cluster --region=$REGION --scopes=cloud-platform --workload-pool=${PROJECT_ID}.svc.id.goog</span><span id="37d1" class="kq kr hi km b fi kw kt l ku kv">gcloud container clusters create production-cluster --region=$REGION --scopes=cloud-platform --workload-pool=${PROJECT_ID}.svc.id.goog</span></pre><p id="56f4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">创建一个谷歌云工件注册表</strong></p><pre class="jv jw jx jy fd kl km kn ko aw kp bi"><span id="6fbf" class="kq kr hi km b fi ks kt l ku kv">ARTIFACT_REPO_NAME=&lt;name of artifact repository&gt;</span><span id="7518" class="kq kr hi km b fi kw kt l ku kv">gcloud artifacts repositories create $ARTIFACT_REPO_NAME --repository-format=docker --location=$REGION</span></pre><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ky"><img src="../Images/995e85ee94225a4674abaef231d7b106.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tcVlsYX6ueg6d0ykj6rF4w.png"/></div></div></figure><p id="36c8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">创建一个构建触发器</strong></p><pre class="jv jw jx jy fd kl km kn ko aw kp bi"><span id="cfbd" class="kq kr hi km b fi ks kt l ku kv">gcloud beta builds triggers create cloud-source-repositories  --repo=$SOURCE_REPO_NAME --branch-pattern=”^master$” --build-config=cloudbuild.yaml</span></pre><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es kz"><img src="../Images/ed8b68ac7331c462a63228a369d1cd89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R_RBN99CGKuAF_l07f-ncg.png"/></div></div></figure><p id="0140" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">授予云构建服务帐户操作云部署的权限。</strong></p><ol class=""><li id="183a" class="la lb hi iz b ja jb jd je jg lc jk ld jo le js lf lg lh li bi translated"><em class="lj">打开IAM页面:</em></li><li id="6c6c" class="la lb hi iz b ja lk jd ll jg lm jk ln jo lo js lf lg lh li bi translated">选择您的云项目。</li><li id="af44" class="la lb hi iz b ja lk jd ll jg lm jk ln jo lo js lf lg lh li bi translated"><em class="lj">在权限表中，找到电子邮件地址以</em> <code class="du lp lq lr km b"><em class="lj">@cloudbuild.gserviceaccount.com</em></code> <em class="lj">结尾的行。这是您的云构建服务帐户。</em></li><li id="5105" class="la lb hi iz b ja lk jd ll jg lm jk ln jo lo js lf lg lh li bi translated"><em class="lj">点击铅笔图标。</em></li><li id="b783" class="la lb hi iz b ja lk jd ll jg lm jk ln jo lo js lf lg lh li bi translated"><em class="lj">选择</em> <strong class="iz hj"> <em class="lj">云部署操作员</em> </strong> <em class="lj">角色，授予云构建服务账户。</em></li><li id="d73e" class="la lb hi iz b ja lk jd ll jg lm jk ln jo lo js lf lg lh li bi translated"><em class="lj">点击</em> <strong class="iz hj"> <em class="lj">保存</em> </strong> <em class="lj">。</em></li></ol><p id="023a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">向您的帐户添加Google Kubernetes引擎开发人员角色:</strong></p><ol class=""><li id="897b" class="la lb hi iz b ja jb jd je jg lc jk ld jo le js lf lg lh li bi translated"><em class="lj">打开云构建设置页面，你会看到</em> <strong class="iz hj"> <em class="lj">服务账号权限</em> </strong> <em class="lj">页面</em></li><li id="3131" class="la lb hi iz b ja lk jd ll jg lm jk ln jo lo js lf lg lh li bi translated"><em class="lj">将</em> <strong class="iz hj"> <em class="lj"> Kubernetes引擎开发者</em> </strong> <em class="lj">角色的状态设置为</em> <strong class="iz hj"> <em class="lj">启用</em> </strong> <em class="lj">。</em></li></ol><p id="e799" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">在代码库的根目录下创建clouddeploy.yaml文件，如下:</strong></p><pre class="jv jw jx jy fd kl km kn ko aw kp bi"><span id="787f" class="kq kr hi km b fi ks kt l ku kv">apiVersion: deploy.cloud.google.com/v1<br/>kind: DeliveryPipeline<br/>metadata:<br/> name: boutique<br/>description: main application pipeline<br/>serialPipeline:<br/> stages:<br/> - targetId: qa<br/>   profiles: []<br/> - targetId: staging<br/>   profiles: []<br/> - targetId: prod<br/>   profiles: []<br/>---</span><span id="f7d4" class="kq kr hi km b fi kw kt l ku kv">apiVersion: deploy.cloud.google.com/v1<br/>kind: Target<br/>metadata:<br/> name: qa<br/>description: development cluster<br/>gke:<br/> cluster: projects/<strong class="km hj">&lt;project-id&gt;</strong>/locations/<strong class="km hj">&lt;region&gt;</strong>/clusters/qa-cluster<br/>---</span><span id="825c" class="kq kr hi km b fi kw kt l ku kv">apiVersion: deploy.cloud.google.com/v1<br/>kind: Target<br/>metadata:<br/> name: staging<br/>description: production cluster<br/>gke:<br/> cluster: projects/<strong class="km hj">&lt;project-id&gt;</strong>/locations/<strong class="km hj">&lt;region&gt;</strong>/clusters/staging-cluster</span><span id="2a27" class="kq kr hi km b fi kw kt l ku kv">---</span><span id="b858" class="kq kr hi km b fi kw kt l ku kv">apiVersion: deploy.cloud.google.com/v1<br/>kind: Target<br/>metadata:<br/> name: prod<br/>description: production cluster<br/>gke:<br/> cluster: projects/<strong class="km hj">&lt;project-id&gt;</strong>/locations/<strong class="km hj">&lt;region&gt;</strong>/clusters/production-cluster</span></pre><p id="6cdb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">修改Cloudbuild.yaml以包含工件注册表并触发云部署，如下:</strong></p><pre class="jv jw jx jy fd kl km kn ko aw kp bi"><span id="ba29" class="kq kr hi km b fi ks kt l ku kv">steps:<br/> - id: 'prepare build and run skaffold'<br/>   name: 'gcr.io/k8s-skaffold/skaffold:v0.20.0'<br/>   entrypoint: 'bash'<br/>   args:<br/>   - '-c'<br/>   - &gt;<br/>     gcloud auth configure-docker <strong class="km hj">&lt;region&gt;</strong>-docker.pkg.dev;<br/>     skaffold build -f=skaffold.yaml \<br/>                    --build-concurrency=0 \<br/>                    --default-repo=<strong class="km hj">&lt;artifact registry endpoint&gt;</strong> \<br/>                    --file-output /workspace/artifacts.json;<br/> - id: 'Deploy to cluster'<br/>   name: 'google/cloud-sdk:latest'<br/>   entrypoint: 'bash'<br/>   args:<br/>   - '-c'<br/>   - &gt;<br/>     gcloud deploy apply --file clouddeploy.yaml --region=<strong class="km hj">&lt;region&gt;</strong> --project=<strong class="km hj">&lt;project-id&gt;</strong>;<br/>     gcloud deploy releases create boutique-$SHORT_SHA \<br/>                         --delivery-pipeline boutique \<br/>                         --description "$(git log -1  --pretty='%s')" \<br/>                         --region=<strong class="km hj">&lt;region&gt;</strong> \<br/>                         --build-artifacts /workspace/artifacts.json</span><span id="4f4a" class="kq kr hi km b fi kw kt l ku kv"># Add more power, and more time, for heavy Skaffold build<br/> timeout: '3600s'<br/> options:<br/>   machineType: 'N1_HIGHCPU_8'</span></pre><p id="e2cc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用git命令将代码推送到存储库。</p><p id="2b2d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">您可以跟踪云部署控制台，并将部署推进到下一阶段。</strong></p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ls"><img src="../Images/88cf7bf35d917096cf49d180702153b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2bQUa4eKfnm9lxZk"/></div></div></figure><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es lt"><img src="../Images/e759fb0f4dfcdac73785e8842f773614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Kf1Ua4R_UUjSCP-Z"/></div></div></figure><p id="55ad" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">现在，您可以对应用程序进行任何更改，并将更新的代码推送到存储库，云构建将被自动触发，云部署管道将被执行。</strong></p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es lu"><img src="../Images/f62a018824f10af8dfdf9e522526b056.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0MC7Vg4xLwmC-pB6bwrAkg.png"/></div></div></figure><h1 id="7e5f" class="lv kr hi bd lw lx ly lz ma mb mc md me io mf ip mg ir mh is mi iu mj iv mk ml bi translated">接下来…</h1><p id="65a3" class="pw-post-body-paragraph ix iy hi iz b ja mm ij jc jd mn im jf jg mo ji jj jk mp jm jn jo mq jq jr js hb bi translated">在这篇博客中，我们学习了如何在Google cloud上为Samajik的集装箱化工作负载实现端到端CI/CD工作流。在下一次对话中，我们将了解如何在Google Cloud中执行日志记录和监控操作。请继续收听拉姆和古汉的对话，了解更多相关信息。</p><p id="7fc8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">供稿人:<a class="mr ms ge" href="https://medium.com/u/c79cc28e2999?source=post_page-----3feb1ea2227e--------------------------------" rel="noopener" target="_blank">普什卡·科塔瓦德</a>，<a class="mr ms ge" href="https://medium.com/u/41b475b881ff?source=post_page-----3feb1ea2227e--------------------------------" rel="noopener" target="_blank">施吉木尔·阿·克</a>，<a class="mr ms ge" href="https://medium.com/u/71d9487165c6?source=post_page-----3feb1ea2227e--------------------------------" rel="noopener" target="_blank">丹杜斯</a>，<a class="mr ms ge" href="https://medium.com/u/ee905ea343d?source=post_page-----3feb1ea2227e--------------------------------" rel="noopener" target="_blank">图沙尔·古普塔</a></p><p id="73ae" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更新:你可以在这里阅读Part-5 <a class="ae jt" rel="noopener" href="/google-cloud/part-5-google-devops-observability-with-sre-principles-33446da05c16">。</a></p></div></div>    
</body>
</html>