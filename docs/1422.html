<html>
<head>
<title>Flutter AAR: Deploy to Maven and GCP Artifact Registry</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">颤振AAR:部署到Maven和GCP工件注册</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/flutter-aar-deploy-to-maven-and-gcp-artifact-registry-d107adebec4d?source=collection_archive---------1-----------------------#2020-05-12">https://medium.com/google-cloud/flutter-aar-deploy-to-maven-and-gcp-artifact-registry-d107adebec4d?source=collection_archive---------1-----------------------#2020-05-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d8478039129690fc7a5f6e77c004d146.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x9beJZ2aSLo9wBrQoHWoyw.png"/></div></div></figure><p id="536a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi jo translated">随着Flutter团队的官方支持，将Flutter添加到现有应用程序中的做法越来越多。</p><p id="d451" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，管理版本和轻松集成目前并不容易，尤其是如果您与一个团队或多个工作站一起工作。</p><p id="9ed6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在Android上，您可以添加本地构建的Maven存储库，也可以直接添加源代码，这两种方式都不容易分发给您的团队。因此，每个Android开发者都必须安装你的Flutter库，并为他/她自己构建AAR或源代码，这也需要到处安装Flutter SDK。</p><p id="4b6b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本教程中，我将向您展示如何为您的CI/CD流程实现一个简单的工作流，将Flutter AAR发布到您的Maven资源库或GCP工件注册中心，这使得实现您的Flutter模块的工作流更加简化。</p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><h1 id="c749" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">先决条件</h1><p id="5cdf" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">我已经假设你知道如何<a class="ae lh" href="https://flutter.dev/docs/development/add-to-app" rel="noopener ugc nofollow" target="_blank">将Flutter添加到现有应用</a>中，并安装最新版本的M <a class="ae lh" href="https://maven.apache.org/download.cgi" rel="noopener ugc nofollow" target="_blank"> aven </a>。<br/>所需的最低版本是<code class="du li lj lk ll b">3.3.1</code>，因为这增加了对扩展的支持。使用<code class="du li lj lk ll b">mvn --version</code>检查您的版本</p><p id="6b4c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想使用GCP工件注册中心，你还必须安装最新版本的<a class="ae lh" href="https://cloud.google.com/sdk/install" rel="noopener ugc nofollow" target="_blank"> Google Cloud SDK </a>，已经在这里申请访问封闭的alpha <a class="ae lh" href="https://cloud.google.com/artifact-registry/docs/java/quickstart" rel="noopener ugc nofollow" target="_blank">，并使用<code class="du li lj lk ll b">gcloud auth login</code>或服务帐户登录。所需的范围是“工件注册管理”</a></p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><h1 id="b59c" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">构建本地Maven存储库</h1><p id="2b19" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">您可以像往常一样构建AAR，只有一点例外:</p><p id="ca84" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正常情况下，使用的版本号总是<code class="du li lj lk ll b">1.0</code>，但是最近在<code class="du li lj lk ll b">stable</code>频道中实现了对添加构建号的支持。您希望像这样构建您的AAR:</p><pre class="lm ln lo lp fd lq ll lr ls aw lt bi"><span id="1249" class="lu kf hi ll b fi lv lw l lx ly">flutter build aar --build-number <strong class="ll hj">x.x.x</strong></span></pre><p id="f494" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个内部版本号随后在Maven中被用来跟踪版本历史，例如<code class="du li lj lk ll b">1.7.5</code>。每当你更新你的代码库的时候增加它。</p><p id="0743" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该命令在<code class="du li lj lk ll b">path_to_your_app/build</code>中创建了一个本地Maven存储库。我们的目标是将它上传到我们的远程Maven仓库，但是这并不像抓取<code class="du li lj lk ll b">.aar</code>并上传那么简单。</p><p id="4cad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你使用<em class="lz">任何</em>插件，Flutter将为上面定义的构建号的插件创建一个单独的AAR，它们之间唯一的链接是<code class="du li lj lk ll b">.pom</code>文件。我们必须将每个AAR分别上传到Maven。</p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><h1 id="200b" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">上传到我们的远程Maven仓库</h1><h2 id="22be" class="lu kf hi bd kg ma mb mc kk md me mf ko jb mg mh ks jf mi mj kw jj mk ml la mm bi translated">与GCP神器登记处:</h2><p id="dc0c" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">如果您想使用您的Maven资源库而不是GCP工件注册中心，您可以跳到“使用任何Maven资源库”这一步。</p><p id="7d59" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">配置gcloud </strong></p><p id="ec68" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你必须在你的GCP项目中创建一个M <strong class="is hj"> aven </strong>库:<a class="ae lh" href="https://console.cloud.google.com/artifacts/create-repo" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/artifacts/create-repo</a><br/>你可以选择适合你的位置。</p><p id="ff26" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们必须配置<code class="du li lj lk ll b">gcloud</code>来使用您创建的存储库:</p><pre class="lm ln lo lp fd lq ll lr ls aw lt bi"><span id="aeaf" class="lu kf hi ll b fi lv lw l lx ly">gcloud beta artifacts print-settings mvn --project=PROJECT-ID --repository=REPOSITORY-NAME --location=YOUR-REGION</span></pre><p id="9223" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">启用GCP工件注册表Maven扩展</strong></p><p id="94e5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要在Maven中使用GCP工件注册中心，我们必须添加一个处理定制存储库链接的扩展:</p><p id="8a80" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在你的工作目录<code class="du li lj lk ll b">path_to_your_app/build</code>中添加一个子目录<code class="du li lj lk ll b">.mvn</code></p><pre class="lm ln lo lp fd lq ll lr ls aw lt bi"><span id="da1d" class="lu kf hi ll b fi lv lw l lx ly">mkdir .mvn</span></pre><p id="483e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这个子目录中添加一个名为<code class="du li lj lk ll b">extensions.xml</code>的文件:</p><pre class="lm ln lo lp fd lq ll lr ls aw lt bi"><span id="59aa" class="lu kf hi ll b fi lv lw l lx ly">&lt;extensions ae lh" href="http://maven.apache.org/EXTENSIONS/1.0.0\" rel="noopener ugc nofollow" target="_blank"&gt;http://maven.apache.org/EXTENSIONS/1.0.0" xmlns:xsi="<a class="ae lh" href="http://www.w3.org/2001/XMLSchema-instance\" rel="noopener ugc nofollow" target="_blank">http://www.w3.org/2001/XMLSchema-instance</a>"<br/>  xsi:schemaLocation="<a class="ae lh" href="http://maven.apache.org/EXTENSIONS/1.0.0" rel="noopener ugc nofollow" target="_blank">http://maven.apache.org/EXTENSIONS/1.0.0</a> <a class="ae lh" href="http://maven.apache.org/xsd/core-extensions-1.0.0.xsd\" rel="noopener ugc nofollow" target="_blank">http://maven.apache.org/xsd/core-extensions-1.0.0.xsd</a>"&gt;<br/>      &lt;extension&gt;<br/>        &lt;groupId&gt;com.google.cloud.artifactregistry&lt;/groupId&gt;<br/>        &lt;artifactId&gt;artifactregistry-maven-wagon&lt;/artifactId&gt;<br/>        &lt;version&gt;2.0.1&lt;/version&gt;<br/>      &lt;/extension&gt;<br/>&lt;/extensions&gt;</span></pre><p id="cebf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">使用这些Maven配置设置</strong></p><p id="ef83" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是GCP工件注册设置。现在，您可以使用这些设置(替换占位符)继续常规实现:</p><ul class=""><li id="238a" class="mn mo hi is b it iu ix iy jb mp jf mq jj mr jn ms mt mu mv bi translated"><code class="du li lj lk ll b">-DrepositoryId="cloud-artifacts"</code></li><li id="5574" class="mn mo hi is b it mw ix mx jb my jf mz jj na jn ms mt mu mv bi translated"><code class="du li lj lk ll b">-Durl="artifactregistry://<strong class="is hj">REGION</strong>-maven.pkg.dev/<strong class="is hj">PROJECT-ID</strong>/<strong class="is hj">REPOSITORY-NAME</strong></code></li></ul><h2 id="3cd3" class="lu kf hi bd kg ma mb mc kk md me mf ko jb mg mh ks jf mi mj kw jj mk ml la mm bi translated">对于任何Maven存储库:</h2><p id="9cc4" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">现在我们必须获取工作目录<code class="du li lj lk ll b">path_to_your_app/build</code>中的每个<code class="du li lj lk ll b">.pom</code>文件，并推送它，包括链接的AAR，我们的远程Maven库。</p><p id="04d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">找到并列出我们运行的所有<code class="du li lj lk ll b">.pom</code>文件</p><pre class="lm ln lo lp fd lq ll lr ls aw lt bi"><span id="499c" class="lu kf hi ll b fi lv lw l lx ly">find . -name "*.pom" -type f</span></pre><p id="d38e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们必须对每个pom文件执行一个Maven命令，同样用以<code class="du li lj lk ll b">.aar</code>结尾的<code class="du li lj lk ll b">.pom</code>文件替换要上传的文件。</p><p id="fb5d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">部署命令如下所示:</p><pre class="lm ln lo lp fd lq ll lr ls aw lt bi"><span id="7a25" class="lu kf hi ll b fi lv lw l lx ly">find . -name "*.pom" -type f -exec sh -c 'mvn deploy:deploy-file -DrepositoryId="<strong class="ll hj">REPOSITORY-ID</strong>" -Durl="<strong class="ll hj">REPOSITORY-URL</strong>" -DpomFile="$0" -Dfile="${0%.pom}.aar"' '{}' \;</span></pre><p id="a68b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">确保用您的配置替换<code class="du li lj lk ll b">REPOSITORY-ID</code>和<code class="du li lj lk ll b">REPOSITORY-URL</code>。</p><p id="849d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">就是这样！现在，您的整个Flutter AAR Maven存储库都可以在您的Maven远程主机上获得了！</strong></p></div><div class="ab cl jx jy gp jz" role="separator"><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc kd"/><span class="ka bw bk kb kc"/></div><div class="hb hc hd he hf"><h1 id="3f7c" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">将GCP工件注册表Maven库添加到Gradle</h1><p id="7387" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">现在，将Maven存储库添加到我们现有的Android应用程序中，并解决我们新的依赖关系是非常简单的！</p><p id="7f62" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lz">注意:要使用此步骤，必须安装Google Cloud SDK，并且用户必须通过验证，拥有前提条件中提到的正确访问权限。</em></p><p id="780e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将以下代码片段添加到您的<strong class="is hj">项目</strong> <code class="du li lj lk ll b">build.gradle</code>:</p><pre class="lm ln lo lp fd lq ll lr ls aw lt bi"><span id="f2ad" class="lu kf hi ll b fi lv lw l lx ly">plugins <strong class="ll hj">{<br/>   </strong>id "com.google.cloud.artifactregistry.gradle-plugin" version "2.0.1"<strong class="ll hj"><br/>}</strong></span></pre><p id="c61c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在您可以在您的<strong class="is hj">应用程序</strong> <code class="du li lj lk ll b">build.gradle</code>中使用GCP工件注册表:</p><pre class="lm ln lo lp fd lq ll lr ls aw lt bi"><span id="bdbc" class="lu kf hi ll b fi lv lw l lx ly">apply plugin: 'com.google.cloud.artifactregistry.gradle-plugin'</span><span id="6c9d" class="lu kf hi ll b fi nb lw l lx ly">[...]</span><span id="5db7" class="lu kf hi ll b fi nb lw l lx ly">repositories {<br/>    [...]<br/>    maven {<br/>        url "<!-- -->artifactregistry://<strong class="ll hj">REGION</strong>-maven.pkg.dev/<strong class="ll hj">PROJECT-ID</strong>/<strong class="ll hj">REPOSITORY-NAME</strong>"<br/>    }<br/>}</span><span id="e03b" class="lu kf hi ll b fi nb lw l lx ly">dependencies {<em class="lz"><br/>    </em>debugImplementation '<strong class="ll hj">com.your.package</strong>:flutter_debug:+'<em class="lz"><br/>    </em>releaseImplementation '<strong class="ll hj">com.your.package</strong>:flutter_release:+'<strong class="ll hj"><br/>    </strong>profileImplementation '<strong class="ll hj">com.your.package</strong>:flutter_profile:+'<br/>    [...]<br/>}</span></pre><p id="82b0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想使用您的maven存储库，只需用您的URL替换即可。</p><p id="9f92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你不想总是使用你的最新版本，你也可以使用你的版本号来代替<code class="du li lj lk ll b">+</code>。</p><figure class="lm ln lo lp fd ij"><div class="bz dy l di"><div class="nc nd l"/></div></figure><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ne"><img src="../Images/0cea1b7e982f2cab089f622c55864265.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sNF881JyGeoyaT02N8v7AA.png"/></div></div></figure></div></div>    
</body>
</html>