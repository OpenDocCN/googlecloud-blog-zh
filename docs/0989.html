<html>
<head>
<title>Using Cloud Run service as async worker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将云运行服务用作异步工作器</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-cloud-run-service-as-async-worker-cf5b1b3fd226?source=collection_archive---------1-----------------------#2019-05-02">https://medium.com/google-cloud/using-cloud-run-service-as-async-worker-cf5b1b3fd226?source=collection_archive---------1-----------------------#2019-05-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4d40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的<a class="ae jd" rel="noopener" href="/google-cloud/making-requests-to-cloud-run-with-the-service-account-620014dc1486">上一篇文章</a>中，我描述了部署私有云运行服务，然后使用服务帐户向它发出请求的过程。有了这些属性，就可以很好地将Cloud Run用作异步任务工作器，我将在本文中对其进行描述。</p><p id="6526" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将使用上一篇文章中的一个服务示例，使用Libreoffice将Microsoft Word Docx转换为PDF，但不是直接向service发出请求，而是由PubSub触发service。例如，假设您有一个云存储桶，您将MS Word docx文件上传到其中，并且您希望每次docx文件上传到桶时自动转换为PDF。</p><p id="d707" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要自动做到这一点，需要以下步骤:</p><ul class=""><li id="8b07" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">需要设置输入桶，以便在上传(创建)某个文件时向PubSub主题发出通知</li><li id="b89a" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">PubSub订阅是在前面的raw中使用HTTP目标为主题创建的，在我们的例子中是云运行服务的URL</li><li id="3ce0" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">云运行服务将文件从Docx转换为PDF，并将结果文件保存到输出桶</li></ul><p id="6a11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是这个过程的示意图。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es js"><img src="../Images/18aaf66169527312f01f5e47de5cbe44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*z-C7twpG9GlZWE_z.png"/></div></figure><p id="35f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个细节是，云服务将是私有的(不对互联网开放)，因此PubSub订阅将需要在一个服务帐户下运行。</p><h2 id="d885" class="ka kb hi bd kc kd ke kf kg kh ki kj kk iq kl km kn iu ko kp kq iy kr ks kt ku bi translated">设置管道</h2><p id="caae" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">让我们来看看如何建立这样的管道的实际步骤。</p><h2 id="b13c" class="ka kb hi bd kc kd ke kf kg kh ki kj kk iq kl km kn iu ko kp kq iy kr ks kt ku bi translated">云存储发布订阅通知</h2><p id="2ff0" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">第一步是在云存储桶上设置一个通知。(目前)唯一的方法是使用谷歌云SDK的<strong class="ih hj"> gsutil </strong>工具:</p><pre class="jt ju jv jw fd la lb lc ld aw le bi"><span id="40b0" class="ka kb hi lb b fi lf lg l lh li">&gt;gsutil notification create -t projects/&lt;PROJECT-ID&gt;/topics/gcs-cloud-run -f json -e OBJECT_FINALIZE gs://&lt;BUCKET-NAME&gt;<br/>Created notification config projects/_/buckets/adventures-on-gcp.appspot.com/notificationConfigs/3</span></pre><p id="05f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选项OBJECT_FINALIZE意味着当在桶中创建了一个新对象(或覆盖了一个新对象)时将触发通知，-f json标志意味着通知将以json格式发送，gcs-cloud-run是PubSub主题的名称，因此在执行该命令后，应该创建PubSub主题<em class="lj"> gcs-cloud-run </em>。</p><p id="f94d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是此类PubSub消息的外观:</p><pre class="jt ju jv jw fd la lb lc ld aw le bi"><span id="a55c" class="ka kb hi lb b fi lf lg l lh li">{u'message': {u'attributes': {u'bucketId': u'adventures-on-gcp.appspot.com',<br/>                              u'eventTime': u'2019-04-23T20:34:34.333805Z',<br/>                              u'eventType': u'OBJECT_FINALIZE',<br/>                              u'notificationConfig': u'projects/_/buckets/adventures-on-gcp.appspot.com/notificationConfigs/3',<br/>                              u'objectGeneration': u'1556051674333936',<br/>                              u'objectId': u'demo.docx',<br/>                              u'overwroteGeneration': u'1556050819479767',<br/>                              u'payloadFormat': u'JSON_API_V1'},<br/>              u'data': u'ewogICJraW5kIjogIn==',<br/>              u'messageId': u'526259585534714',<br/>              u'message_id': u'526259585534714',<br/>              u'publishTime': u'2019-04-23T20:34:34.678Z',<br/>              u'publish_time': u'2019-04-23T20:34:34.678Z'},<br/> u'subscription': u'projects/adventures-on-gcp/subscriptions/cloud-run-ps-gcs'}</span></pre><p id="75e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于示例中的情况，我们需要字段<strong class="ih hj"> bucketId </strong>和<strong class="ih hj"> objectId </strong>，它们对应于创建的bucket名称和文件名(路径)。</p><h2 id="f64c" class="ka kb hi bd kc kd ke kf kg kh ki kj kk iq kl km kn iu ko kp kq iy kr ks kt ku bi translated">网络应用</h2><p id="093f" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">示例云运行服务是用Python编写的，完整代码可以在Github<a class="ae jd" href="https://github.com/zdenulo/gcp-docx2pdf/tree/master/cloud_run_pubsub" rel="noopener ugc nofollow" target="_blank">https://Github . com/zde nulo/GCP-docx 2 pdf/tree/master/Cloud _ Run _ pubsub</a>上找到。</p><p id="8b62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如上所述，Web应用程序接受HTTP POST JSON消息，将文件从bucket下载到服务环境，然后进行转换，创建PDF文件并将PDF文件上传到输出bucket并删除本地文件(Docx和PDF ),因为在云运行服务中存储数据会影响RAM内存容量，也就是说，如果服务实例会一直运行，并且文件不会被删除，它最终会崩溃，因为它不会有更多的可用内存。</p><p id="a553" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">web应用程序本身包含在文件夹应用程序中，我使用Cloud Build来构建Docker映像并将其部署在Cloud Run上。云构建配置在文件<a class="ae jd" href="https://github.com/zdenulo/gcp-docx2pdf/blob/master/cloud_run_pubsub/cloudbuild.yaml" rel="noopener ugc nofollow" target="_blank"> cloudbuild.yaml </a>中定义，可以通过以下命令执行:</p><pre class="jt ju jv jw fd la lb lc ld aw le bi"><span id="bb8a" class="ka kb hi lb b fi lf lg l lh li">&gt;gcloud builds submit --config=cloudbuild.yaml --substitutions=_SERVICE_NAME="ps-run",TAG_NAME="v0.1",_ENV_VARIABLES="OUTPUT_BUCKET=gcs-upload-test"</span></pre><p id="00f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">服务名称是云运行服务的名称</p><p id="f139" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">TAG_NAME是图像标签</p><p id="4407" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">OUTPUT_BUCKET是输出桶(输出文件将保存在这里),它将作为环境变量传递给Docker image。</p><p id="e7b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在部署期间的构建日志中，将打印服务的URL，或者我们可以使用以下命令获取它:</p><pre class="jt ju jv jw fd la lb lc ld aw le bi"><span id="890d" class="ka kb hi lb b fi lf lg l lh li">&gt;gcloud beta run services describe &lt;SERVICE-NAME&gt; --format="json(status[address])"<br/>{<br/>  "status": <br/>    "address": {<br/>      "hostname": "https://ps-run-sxl5nibnhq-uc.a.run.app"<br/>    }<br/>  }<br/>}</span></pre><h2 id="faaf" class="ka kb hi bd kc kd ke kf kg kh ki kj kk iq kl km kn iu ko kp kq iy kr ks kt ku bi translated">发布订阅设置</h2><p id="97ea" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">下一步是创建服务帐户。正如我在开始时所写的，我们希望这个云运行服务是私有的，为了访问它，我们需要为这个服务帐户设置适当的IAM角色。此服务帐户将绑定到PubSub订阅，它将作为一个身份，以便云运行可以允许访问私有服务。向服务发出请求的角色是<strong class="ih hj"> roles/run.invoker </strong>。</p><p id="0326" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<strong class="ih hj"> gcloud </strong>命令，可以创建服务帐户:</p><pre class="jt ju jv jw fd la lb lc ld aw le bi"><span id="f4b0" class="ka kb hi lb b fi lf lg l lh li">&gt;gcloud iam service-accounts create cr-ps-test --display-name="Cloud Run PubSub"<br/>Created service account [cr-ps-test].</span></pre><p id="5926" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并允许此服务帐户访问云运行服务:</p><pre class="jt ju jv jw fd la lb lc ld aw le bi"><span id="57ad" class="ka kb hi lb b fi lf lg l lh li">&gt;gcloud beta run services add-iam-policy-binding ps-run --member=serviceAccount:cr-ps-test@adventures-on-gcp.iam.gserviceaccount.com --role=roles/run.invoker<br/>Updated IAM policy for service [ps-run].<br/>bindings:<br/>- members:<br/>  - serviceAccount:cr-ps-test@adventures-on-gcp.iam.gserviceaccount.com<br/>  role: roles/run.invoker<br/>etag: BwWHghIlfxk=</span></pre><p id="d388" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后一步是创建PubSub主题的PubSub订阅，该订阅将使用创建的服务帐户进行标识，并设置HTTP目标，该目标将是云运行服务URL。</p><pre class="jt ju jv jw fd la lb lc ld aw le bi"><span id="9573" class="ka kb hi lb b fi lf lg l lh li">gcloud beta pubsub subscriptions create &lt;SUBSCRIPTION-NAME&gt; --push-endpoint=&lt;SERVICE-URL&gt; --push-auth-service-account=&lt;SERVICE-ACCOUNT&gt;@&lt;PROJECT-ID&gt;.iam.gserviceaccount.com --topic projects/&lt;PROJECT-ID&gt;/topics/gcs-cloud-run</span></pre><p id="e574" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想要测试流程，您可以使用<strong class="ih hj"> gsutil </strong>命令将demo.docx文件从存储库中复制到您的输入桶中:</p><pre class="jt ju jv jw fd la lb lc ld aw le bi"><span id="ecb6" class="ka kb hi lb b fi lf lg l lh li">&gt;gsutil cp demo.docx gs://&lt;INPUT-BUCKET&gt;</span></pre><p id="3193" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过这个过程，您可以创建一个接收PubSub消息并进行进一步处理的私有云运行服务。</p></div></div>    
</body>
</html>