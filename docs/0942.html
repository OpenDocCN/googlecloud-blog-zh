<html>
<head>
<title>Stackdriver Monitoring Automation Part 5: Alerting Policies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">堆栈驱动程序监控自动化第5部分:警报策略</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/stackdriver-monitoring-automation-part-5-alerting-policies-ff77b19b4b97?source=collection_archive---------0-----------------------#2019-03-05">https://medium.com/google-cloud/stackdriver-monitoring-automation-part-5-alerting-policies-ff77b19b4b97?source=collection_archive---------0-----------------------#2019-03-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f6d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章是Stackdriver自动化系列的第5部分。在这篇文章中，我将介绍使用Terraform自动管理Stackdriver监控警报策略的步骤。</p><h1 id="c455" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">SLI预警指标</h1><p id="d049" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">请阅读<a class="ae kg" rel="noopener" href="/google-cloud/stackdriver-monitoring-automation-part-2-alerting-policies-9f42068603c4">第2部分</a>，了解这些警报策略所实施的警报场景的详细信息。概括地说，我选择的主要堆栈驱动程序警报条件、通知和文档如下:</p><p id="c766" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">条件</strong></p><p id="8b5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kh">供货情况&amp;质量:</em></p><ul class=""><li id="a8b0" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated">L7负载平衡器错误请求计数= 0/秒</li></ul><p id="a93b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kh">等待时间:</em></p><ul class=""><li id="9ab3" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated">L7负载平衡器总延迟&gt; 100毫秒</li><li id="243e" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated">L7负载平衡器前端RTT延迟&gt; 50毫秒</li><li id="345a" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated">L7负载平衡器后端RTT延迟&gt; 50毫秒</li></ul><p id="e69b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kh">对于体积:</em></p><ul class=""><li id="2c60" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated">L7负载平衡器请求计数&gt; 100/秒</li></ul><p id="f6b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">通知渠道</strong></p><ul class=""><li id="0c26" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated">电子邮件:<a class="ae kg" href="mailto:apache-website-oncall@example.com" rel="noopener ugc nofollow" target="_blank">website-oncall@example.com</a></li><li id="1c14" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated">电子邮件:support-website@example.com</li></ul><p id="5879" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">文档</strong></p><ul class=""><li id="151d" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated">描述每个警报策略的特定文本</li></ul><h1 id="c47d" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">通知通道配置</h1><p id="8b2b" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">上述5个警报条件转化为5个警报策略和2个单独的通知渠道。首先，我创建了通知通道配置。如果您在自己的项目中运行，不要忘记更改项目值。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="d445" class="lf je hi lb b fi lg lh l li lj">provider "google" {<br/>  project = "abab-cdcd-023991"<br/>  region  = "us-central1"<br/>  zone    = "us-central1-c"<br/>}</span><span id="f885" class="lf je hi lb b fi lk lh l li lj">resource "google_monitoring_notification_channel" "email0" {<br/>  display_name = "Website Oncall"<br/>  type = "email"<br/>  labels = {<br/>    email_address = "<a class="ae kg" href="mailto:website-oncall@example.com" rel="noopener ugc nofollow" target="_blank">website-oncall@example.com</a>"<br/>  }<br/>}</span><span id="96f3" class="lf je hi lb b fi lk lh l li lj">resource "google_monitoring_notification_channel" "email1" {<br/>  display_name = "Website Support"<br/>  type = "email"<br/>  labels = {<br/>    email_address = "<a class="ae kg" href="mailto:support-website@example.com" rel="noopener ugc nofollow" target="_blank">support-website@example.com</a>"<br/>  }<br/>}</span><span id="4714" class="lf je hi lb b fi lk lh l li lj">output "email0_id" {<br/>  value = "${google_monitoring_notification_channel.email0.name}"<br/>}</span><span id="caf6" class="lf je hi lb b fi lk lh l li lj">output "email1_id" {<br/>  value = "${google_monitoring_notification_channel.email1.name}"<br/>}</span></pre><h1 id="cc8f" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">创建通知渠道</h1><p id="27f3" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">创建通知通道需要两个简单的步骤。首先，初始化Terraform。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="11d1" class="lf je hi lb b fi lg lh l li lj">$ terraform init</span><span id="4e36" class="lf je hi lb b fi lk lh l li lj">Initializing provider plugins...</span><span id="34f7" class="lf je hi lb b fi lk lh l li lj">The following providers do not have any version constraints in configuration,<br/>so the latest version was installed.</span><span id="df09" class="lf je hi lb b fi lk lh l li lj">To prevent automatic upgrades to new major versions that may contain breaking<br/>changes, it is recommended to add version = "..." constraints to the<br/>corresponding provider blocks in configuration, with the constraint strings<br/>suggested below.</span><span id="efcc" class="lf je hi lb b fi lk lh l li lj">* provider.google: version = "~&gt; 2.1"</span><span id="e842" class="lf je hi lb b fi lk lh l li lj">Terraform has been successfully initialized!</span></pre><p id="96b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，标准的Terraform apply完成所有工作。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="b202" class="lf je hi lb b fi lg lh l li lj">$ terraform apply</span><span id="7570" class="lf je hi lb b fi lk lh l li lj">google_monitoring_notification_channel.email1: Refreshing state... (ID: projects/abab-cdcd-023991/notificationChannels/12532464389112270325)<br/>google_monitoring_notification_channel.email0: Refreshing state... (ID: abab-cdcd-023991/notificationChannels/11497409249297891355)</span><span id="19ef" class="lf je hi lb b fi lk lh l li lj">An execution plan has been generated and is shown below.<br/>Resource actions are indicated with the following symbols:<br/>  ~ update in-place</span><span id="7df4" class="lf je hi lb b fi lk lh l li lj">Terraform will perform the following actions:</span><span id="a24a" class="lf je hi lb b fi lk lh l li lj">~ google_monitoring_notification_channel.email0<br/>      labels.email_address: "<a class="ae kg" href="mailto:website-oncall@example.com" rel="noopener ugc nofollow" target="_blank">website-oncall@example.com</a>" =&gt; "<a class="ae kg" href="mailto:website-oncall-a@example.com" rel="noopener ugc nofollow" target="_blank">website-oncall-a@example.com</a>"</span><span id="9357" class="lf je hi lb b fi lk lh l li lj">~ google_monitoring_notification_channel.email1<br/>      labels.email_address: "<a class="ae kg" href="mailto:support-website@example.com" rel="noopener ugc nofollow" target="_blank">support-website@example.com</a>" =&gt; "<a class="ae kg" href="mailto:support-website-a@example.com" rel="noopener ugc nofollow" target="_blank">support-website-a@example.com</a>"</span><span id="5bc1" class="lf je hi lb b fi lk lh l li lj">Plan: 0 to add, 2 to change, 0 to destroy.</span><span id="20fc" class="lf je hi lb b fi lk lh l li lj">Do you want to perform these actions?<br/>  Terraform will perform the actions described above.<br/>  Only 'yes' will be accepted to approve.</span><span id="2db4" class="lf je hi lb b fi lk lh l li lj">Enter a value: yes</span><span id="0a74" class="lf je hi lb b fi lk lh l li lj">google_monitoring_notification_channel.email1: Modifying... (ID: projects/abab-cdcd-023991/notificationChannels/12532464389112270325)<br/>  labels.email_address: "<a class="ae kg" href="mailto:support-website@example.com" rel="noopener ugc nofollow" target="_blank">support-website@example.com</a>" =&gt; "<a class="ae kg" href="mailto:support-website-a@example.com" rel="noopener ugc nofollow" target="_blank">support-website-a@example.com</a>"<br/>google_monitoring_notification_channel.email0: Modifying... (ID: projects/abab-cdcd-023991/notificationChannels/11497409249297891355)<br/>  labels.email_address: "<a class="ae kg" href="mailto:website-oncall@example.com" rel="noopener ugc nofollow" target="_blank">website-oncall@example.com</a>" =&gt; "<a class="ae kg" href="mailto:website-oncall-a@example.com" rel="noopener ugc nofollow" target="_blank">website-oncall-a@example.com</a>"<br/>google_monitoring_notification_channel.email1: Modifications complete after 1s (ID: projects/abab-cdcd-023991/notificationChannels/12532464389112270325)<br/>google_monitoring_notification_channel.email0: Modifications complete after 2s (ID: projects/abab-cdcd-023991/notificationChannels/11497409249297891355)</span><span id="bcfc" class="lf je hi lb b fi lk lh l li lj">Apply complete! Resources: 0 added, 2 changed, 0 destroyed.</span><span id="2a6c" class="lf je hi lb b fi lk lh l li lj">Outputs:</span><span id="fb3d" class="lf je hi lb b fi lk lh l li lj">email0_id = projects/abab-cdcd-023991/notificationChannels/11497409249297891355<br/>email1_id = projects/abab-cdcd-023991/notificationChannels/12532464389112270325</span></pre><h1 id="85e5" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">警报策略配置</h1><p id="0adf" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我从通知通道(上面的email0_id和email1_id)获取输出，并将它们作为本地变量添加到警报策略配置中。上述5种警报条件转化为5种警报策略。请注意，为了便于阅读，我在这里只包括了两个警报策略。你可以在<a class="ae kg" href="https://github.com/charlesbaer/stackdriver-automation" rel="noopener ugc nofollow" target="_blank"> github repo </a>上找到完整的配置文件。</p><figure class="kw kx ky kz fd ll"><div class="bz dy l di"><div class="lm ln l"/></div></figure><p id="b938" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在标准初始化之后，terraform apply完成所有工作并创建警报策略。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="c400" class="lf je hi lb b fi lg lh l li lj">$ terraform apply</span><span id="6317" class="lf je hi lb b fi lk lh l li lj">google_monitoring_notification_channel.email0: Refreshing state... (ID: projects/abab-cdcd-023991/notificationChannels/6314605697446264142)<br/>google_monitoring_alert_policy.alert_policy0: Refreshing state... (ID: projects/abab-cdcd-023991/alertPolicies/48947729567500594)<br/>google_monitoring_alert_policy.alert_policy4: Refreshing state... (ID: projects/abab-cdcd-023991/alertPolicies/16071394893024794286)<br/>google_monitoring_alert_policy.alert_policy2: Refreshing state... (ID: projects/abab-cdcd-023991/alertPolicies/5670542644520942633)<br/>google_monitoring_alert_policy.alert_policy3: Refreshing state... (ID: projects/abab-cdcd-023991/alertPolicies/6104269770159121403)<br/>google_monitoring_notification_channel.email1: Refreshing state... (ID: projects/abab-cdcd-023991/notificationChannels/10463049156064412054)<br/>google_monitoring_alert_policy.alert_policy1: Refreshing state... (ID: projects/abab-cdcd-023991/alertPolicies/5985603450478517474)</span></pre><p id="17ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建警报策略后，我使用Stackdriver监控控制台来验证警报策略是否已成功创建。</p><figure class="kw kx ky kz fd ll er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es lo"><img src="../Images/13482c448e8e10a4391c97582344bb92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_TDEqejUcKN9VIOvDoe80A.png"/></div></div></figure><p id="0112" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本系列的第5部分到此结束。在本系列的其他文章和下面的参考资料中阅读更多关于使用Terraform的Stackdriver监控自动化的内容。</p><ul class=""><li id="5bf8" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated"><a class="ae kg" rel="noopener" href="/google-cloud/stackdriver-monitoring-automation-part-4-stackdriver-groups-with-terraform-910289d16d08">堆栈驱动监控自动化第4部分:具有地形的堆栈驱动组</a></li><li id="6cce" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae kg" rel="noopener" href="/google-cloud/stackdriver-monitoring-automation-part-6-uptime-checks-with-terraform-76cb25b996a4"> Stackdriver监控自动化第6部分:使用Terraform检查Stackdriver正常运行时间</a></li></ul><p id="9e2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考资料:</p><ul class=""><li id="b097" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated"><a class="ae kg" href="https://cloud.google.com/monitoring/docs/" rel="noopener ugc nofollow" target="_blank">堆栈驱动监控文件</a></li><li id="713d" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae kg" href="https://cloud.google.com/monitoring/api/ref_v3/rest/" rel="noopener ugc nofollow" target="_blank">栈驱动监控API文档</a></li><li id="3666" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae kg" href="https://cloud.google.com/monitoring/api/v3/filters" rel="noopener ugc nofollow" target="_blank">堆栈驱动监控过滤器</a></li><li id="9222" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae kg" href="https://cloud.google.com/monitoring/api/metrics_gcp" rel="noopener ugc nofollow" target="_blank">堆栈驱动程序监控指标</a></li><li id="4f2e" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae kg" href="https://www.terraform.io/docs/providers/google/provider_reference.html" rel="noopener ugc nofollow" target="_blank"> Terraform谷歌提供商</a></li></ul></div></div>    
</body>
</html>