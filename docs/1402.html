<html>
<head>
<title>Effectively specifying environment variables for Cloud Run</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有效地指定云运行的环境变量</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/effectively-specifying-environment-variables-for-cloud-run-1a64c52ea7f5?source=collection_archive---------3-----------------------#2020-04-27">https://medium.com/google-cloud/effectively-specifying-environment-variables-for-cloud-run-1a64c52ea7f5?source=collection_archive---------3-----------------------#2020-04-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6dae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">(为了更好的阅读体验，</em> <a class="ae je" href="https://ahmet.im/blog/mastering-cloud-run-environment-variables/" rel="noopener ugc nofollow" target="_blank"> <em class="jd">阅读我博客上的这篇文章</em> </a> <em class="jd">)。)</em></p><p id="9c43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如今，许多微服务应用主要通过环境变量进行配置。如果您正在部署云运行，使用CLI指定许多环境变量可能看起来相当痛苦:</p><p id="4377" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jf jg jh ji b">--set-env-vars="<strong class="ih hj">LOG_LEVEL=</strong>verbose,<strong class="ih hj">EXPERIMENTS=</strong>ShowInactiveUsers,CountIncorrectLoginAttempts,"Test 1",<strong class="ih hj">DB_CONN=</strong>sqlserver://username@host/instance?param1=value&amp;param2=value,<strong class="ih hj">DB_PASS=</strong>berglas://my-bucket/path/to/my-secret?destination=tempfile,<strong class="ih hj">GODEBUG=</strong>schedtrace=9000"</code></p><p id="aa0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不要害怕！有更好的方法。我已经在云运行文档中解释了所有这些<a class="ae je" href="https://cloud.google.com/run/docs/configuring/environment-variables#command-line" rel="noopener ugc nofollow" target="_blank">，但是这篇文章将会有一些讨论。</a></p><p id="93b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">敏锐的读者可能会立即注意到上面的例子行不通:</p><ul class=""><li id="63a4" class="jj jk hi ih b ii ij im in iq jl iu jm iy jn jc jo jp jq jr bi translated"><code class="du jf jg jh ji b">gcloud</code>希望使用逗号来拆分<code class="du jf jg jh ji b">K=V</code>对，尽管有些值中包含逗号</li><li id="e27a" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">由<code class="du jf jg jh ji b">"</code>分隔的参数中有未转义的<code class="du jf jg jh ji b">"</code>字符，将导致bash解析失败</li><li id="8a06" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">如果您在bash中运行它，它将在把它传递给<code class="du jf jg jh ji b">gcloud</code>命令之前去掉像<code class="du jf jg jh ji b">"..."</code>这样的部分。</li></ul><p id="df04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以在这篇文章中，我会给你一些建议来避免这种想法:</p><ol class=""><li id="17d7" class="jj jk hi ih b ii ij im in iq jl iu jm iy jn jc jx jp jq jr bi translated">不要将所有环境变量都塞进一个选项中。</li><li id="4859" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jx jp jq jr bi translated">尽可能地防止您的shell(例如bash)解释参数。</li><li id="3484" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jx jp jq jr bi translated">如果事情失去控制，用YAML切换到声明性资源模型。</li></ol><h1 id="2b23" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">1.环境变量太多？分开他们</h1><p id="57af" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">当您第二次运行<code class="du jf jg jh ji b">gcloud run deploy</code>命令时，您有两种方法来指定环境变量:</p><ol class=""><li id="3481" class="jj jk hi ih b ii ij im in iq jl iu jm iy jn jc jx jp jq jr bi translated">用<code class="du jf jg jh ji b">--set-env-vars</code>再次指定所有需要的环境变量。</li><li id="595e" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jx jp jq jr bi translated">仅指定<strong class="ih hj">要更新<code class="du jf jg jh ji b">--update-env-vars</code>的</strong>环境变量，并使用<code class="du jf jg jh ji b">--remove-env-vars</code>取消设置您想要的环境变量。</li></ol><p id="df83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我个人更喜欢第一个选项，因为我用完全部署命令为我的应用程序编写了一个<code class="du jf jg jh ji b">deploy.sh</code>。那么如何应对太多的环境变量呢？</p><p id="5c9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云运行实际上允许您多次指定这些<code class="du jf jg jh ji b">--set-env-vars</code>或<code class="du jf jg jh ji b">--update-env-vars</code>选项<strong class="ih hj"/>，因此您可以将上述声明拆分为多个参数，如下所示:</p><pre class="lb lc ld le fd lf ji lg lh aw li bi"><span id="e630" class="lj jz hi ji b fi lk ll l lm ln">$ gcloud run deploy \<br/>    --set-env-vars LOG_LEVEL=verbose \<br/>    --set-env-vars "EXPERIMENTS=IncorrectLoginAttempts,\"Test 1\"" \<br/>    --set-env-vars GODEBUG=schedtrace=9000<br/>    [...]</span></pre><p id="4163" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那更好，但是它是傻瓜证明吗？不。正如你可能看到的，我们开始做一些丑陋的事情，如转义引用，还有更多隐藏的角落情况。</p><h1 id="7a27" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">2.防止对环境变量的误解</h1><p id="0abb" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">如果您将它传递给<code class="du jf jg jh ji b">gcloud</code>，它会将逗号(<code class="du jf jg jh ji b">,</code>)字符视为另一个环境变量声明，并尝试将该值拆分成多个环境变量:</p><pre class="lb lc ld le fd lf ji lg lh aw li bi"><span id="1f8e" class="lj jz hi ji b fi lk ll l lm ln">[...]<br/>--set-env-var "A=B,C,D"</span></pre><p id="1f60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是由设计决定的，在此有<a class="ae je" href="https://cloud.google.com/sdk/gcloud/reference/topic/escaping" rel="noopener ugc nofollow" target="_blank">的解释。</a></p><p id="2b68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了防止用逗号分割，您需要指定一个不同的自定义分隔符，您确信它不会出现在您的值字符串中，例如<code class="du jf jg jh ji b">##</code>:</p><pre class="lb lc ld le fd lf ji lg lh aw li bi"><span id="1cd6" class="lj jz hi ji b fi lk ll l lm ln">[...]<br/>--set-env-vars "^##^A=B,C,D"</span></pre><p id="4988" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是的，这不是最好的解决办法，但会有用的。以下是在shell中运行时可能会给您带来麻烦的另外两个示例:</p><ul class=""><li id="0bd2" class="jj jk hi ih b ii ij im in iq jl iu jm iy jn jc jo jp jq jr bi translated"><code class="du jf jg jh ji b">--set-env-vars A="B C D"</code>:这不会保留引号，但是可以确保值中的空格不会被shell分割。</li><li id="4219" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated">单引号通常是保存列表中内容的简单方法(但是如果你的值实际上只有一个单引号呢？-正确地逃避这些可能会很痛苦！)</li><li id="7c67" class="jj jk hi ih b ii js im jt iq ju iu jv iy jw jc jo jp jq jr bi translated"><code class="du jf jg jh ji b">--set-env-vars 'A="B C D"'</code>:这将保留值中的双引号。</li></ul><h1 id="38c2" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">3.从文件中读取环境变量</h1><p id="38f6" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated"><code class="du jf jg jh ji b">gcloud run deploy</code>不支持<code class="du jf jg jh ji b">--env-vars-file</code>不像谷歌云功能或谷歌应用引擎部署命令。</p><p id="5248" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，你实际上可以从YAML编写的清单文件中部署你的整个云运行服务。这是因为云运行服务实际上是可调用的API对象<a class="ae je" href="https://ahmet.im/blog/cloud-run-is-a-knative/" rel="noopener ugc nofollow" target="_blank">，正如我在之前的文章</a>中解释的。</p><p id="e24f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是用<code class="du jf jg jh ji b">gcloud beta run services replace</code>命令完成的(希望它能很快升级到beta → GA！)在这个yaml文件中，看一下<code class="du jf jg jh ji b">env</code>部分</p><pre class="lb lc ld le fd lf ji lg lh aw li bi"><span id="09bc" class="lj jz hi ji b fi lk ll l lm ln">apiVersion: serving.knative.dev/v1<br/>kind: Service<br/>metadata:<br/>  name: hello<br/>spec:<br/>  template:<br/>    spec:<br/>      containers:<br/>      - image: gcr.io/google-samples/hello-app:1.0<br/>        <strong class="ji hj">env:</strong><br/>        - name: LOG_LEVEL<br/>          value: verbose<br/>        # we can break strings over multiple lines<br/>        # see: https://yaml-multiline.info/<br/>        - name: EXPERIMENTS<br/>          value: 'ShowInactiveUsers,<br/>          CountIncorrectLoginAttempts,<br/>          "Test 1"'<br/>        - name: DB_CONN<br/>          value: sqlserver://username@host/instance?param1=value&amp;param2=value<br/>        # [...]</span></pre><p id="4220" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以在每次想要更新服务时运行此命令:</p><pre class="lb lc ld le fd lf ji lg lh aw li bi"><span id="1576" class="lj jz hi ji b fi lk ll l lm ln"><strong class="ji hj">gcloud beta run services replace</strong> FILE.yaml</span></pre><p id="5f89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种方法有什么注意事项吗？是的，现在我们被YAML语法的规则所束缚。如果你有类似<code class="du jf jg jh ji b">value: 5</code>或<code class="du jf jg jh ji b">value: true</code>的东西，这些不会被当作<code class="du jf jg jh ji b">string</code> s，所以你需要明确地引用它们:</p><pre class="lb lc ld le fd lf ji lg lh aw li bi"><span id="04c1" class="lj jz hi ji b fi lk ll l lm ln">value: "5"<br/>value: "true"</span></pre><p id="f874" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">未能对这些进行转义将导致API出错。</p></div><div class="ab cl lo lp gp lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="hb hc hd he hf"><p id="d780" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">原载于2020年4月27日</em><a class="ae je" href="https://ahmet.im/blog/mastering-cloud-run-environment-variables/" rel="noopener ugc nofollow" target="_blank"><em class="jd">https://Ahmet . im</em></a><em class="jd">。</em></p></div></div>    
</body>
</html>