<html>
<head>
<title>Stackdriver Push to Splunk</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Stackdriver推送至Splunk</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/stackdriver-push-to-splunk-f825b3183c40?source=collection_archive---------0-----------------------#2020-02-21">https://medium.com/google-cloud/stackdriver-push-to-splunk-f825b3183c40?source=collection_archive---------0-----------------------#2020-02-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6dc4" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">在我的职业生涯中(在技术领域)，我与许多客户打过交道，安全性是他们最关心的问题之一。</p><p id="aeed" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">因此，总有改进的空间，但毫无疑问，通信方向和有状态防火墙是首先要考虑的因素。</p><p id="afb4" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">说到日志和审计信息，根据经验，最好将日志聚合器存储在云提供商范围之外。一个很好的对数相关性是<strong class="ii hj"><em class="je"/></strong>。它拥有尖端人工智能驱动的规则引擎所需的所有功能。它允许你拥有<em class="je">自愈</em>以及<em class="je">事件关联</em>。</p><p id="e90d" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">一方面是系统日志，另一方面是虚拟机管理程序日志。谈到云环境，每个参与者都有自己的定制解决方案。在<strong class="ii hj">谷歌云平台</strong> ( <em class="je"> gcp </em>)的情况下，游戏的名字是<strong class="ii hj"> <em class="je"> Stackdriver </em> </strong>。</p><p id="fb19" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated"><strong class="ii hj"> <em class="je"> Stackdriver </em> </strong>存储日志并从/向不同平台发送日志。为了实现从<strong class="ii hj"> <em class="je"> gcp </em> </strong>(具体是从<strong class="ii hj"> <em class="je"> Stackdriver </em> </strong>)到<strong class="ii hj"> <em class="je"> Splunk </em> </strong>的推送通信，发起方必须是<strong class="ii hj"> <em class="je"> Stackdriver </em> </strong>。</p><p id="65bb" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated"><strong class="ii hj"> <em class="je"> Stackdriver </em> </strong>有几种方法可以将日志导出到不同的平台，其中，能够满足在推送的基础上连接到<strong class="ii hj"> <em class="je"> Splunk </em> </strong>的所有要求的一种方法是<strong class="ii hj"> <em class="je"> PubSub </em> </strong>。</p><p id="65c7" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated"><strong class="ii hj"> <em class="je"> PubSub </em> </strong>是提供消息队列通信的托管服务。这意味着，每次消息到达时，都会触发一个事件。此类事件将消息排队到<strong class="ii hj"> <em class="je"> Splunk </em> </strong>上。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/ee8cffb1569be066bb73505401034a52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iKgHwj_dh-jsuye70rkcdQ.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">所需的事件捕获并导出到<strong class="bd jv"> <em class="if"> Splunk </em> </strong></figcaption></figure><p id="b46c" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">按照架构图，我们必须配置<strong class="ii hj"> <em class="je"> PubSub </em> </strong>才能到达<strong class="ii hj"> <em class="je"> Splunk </em> </strong>服务。</p><p id="55cf" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated"><strong class="ii hj">披露者:</strong></p><ul class=""><li id="f6b6" class="jw jx hi ii b ij ik in io ir jy iv jz iz ka jd kb kc kd ke bi translated"><strong class="ii hj"> <em class="je"> PubSub </em> </strong>只向<strong class="ii hj"> <em class="je"> gcp </em> </strong>上预先验证的域发送消息。</li><li id="5a0a" class="jw jx hi ii b ij kf in kg ir kh iv ki iz kj jd kb kc kd ke bi translated"><strong class="ii hj"> <em class="je"> PubSub的</em> </strong>认证机制是预定义的，运行时不能修改。</li><li id="c901" class="jw jx hi ii b ij kf in kg ir kh iv ki iz kj jd kb kc kd ke bi translated"><strong class="ii hj"> <em class="je"> PubSub的</em> </strong> url端点必须使用预定义的第三方证书颁发机构颁发的有效证书来支持SSL。</li></ul><p id="c62e" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">因此，在<strong class="ii hj"> <em class="je"> Splunk </em> </strong>(云或其他)中需要进行一些修改，以便我们让这些部分协同工作。</p><p id="fb72" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">首先，我们需要一个可以在<strong class="ii hj"> <em class="je"> gcp </em> </strong>中验证的自定义域名。通常你可以使用<strong class="ii hj"> <em class="je"> CloudDNS </em> </strong>来完成这个任务。</p><p id="962e" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">其次，我们需要生成一个方法，通过url请求参数来验证<strong class="ii hj"> <em class="je"> Splunk的</em></strong><strong class="ii hj"><em class="je">HEC</em></strong>(记住，我们不能修改<strong class="ii hj"> <em class="je"> PubSub的</em> </strong> auth机制)。</p><p id="5915" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">最后，我们需要在<strong class="ii hj"> <em class="je"> Splunk </em> </strong>上有一个由第三方验证的有效SSL终端(对于这一部分，我们建议只使用<strong class="ii hj"> <em class="je">让我们加密</em> </strong>，它是<strong class="ii hj"> <em class="je"> PubSub </em> </strong>的一个有效且可信的证书颁发机构)。</p><p id="6268" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated"><strong class="ii hj">在<em class="je"> Splunk </em>侧:</strong></p><ul class=""><li id="32e8" class="jw jx hi ii b ij ik in io ir jy iv jz iz ka jd kb kc kd ke bi translated">生成一个SSL证书(使用<strong class="ii hj"> <em class="je">让我们加密</em> </strong>)并将其添加为<strong class="ii hj"><em class="je">【Splunk】</em></strong>(包括HEC请求)的前端。</li></ul><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es ca"><img src="../Images/ee46c7888ca1414cf06bfa31e3c4d917.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MM7fVmj52xQM4twOMfjGUw.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">将<strong class="bd jv"> <em class="if"> Splunk </em> </strong>实例配置为使用加密证书链</figcaption></figure><ul class=""><li id="f4fc" class="jw jx hi ii b ij ik in io ir jy iv jz iz ka jd kb kc kd ke bi translated">从<em class="je"/><a class="ae kk" href="https://splunkbase.splunk.com/app/1922/" rel="noopener ugc nofollow" target="_blank"><strong class="ii hj"><em class="je">Splunkbase</em></strong></a><em class="je">安装Base64二进制。</em></li></ul><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kl"><img src="../Images/21d50fda97faa99ceb21538ac38cd676.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M2JvHY6Y8TIs7KTYBEljag.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">将下载的base64 app上传到<strong class="bd jv"> <em class="if"> Splunk </em> </strong>实例。</figcaption></figure><ul class=""><li id="dcc2" class="jw jx hi ii b ij ik in io ir jy iv jz iz ka jd kb kc kd ke bi translated">配置HEC，使令牌可以作为URL的一部分作为参数传递(<a class="ae kk" href="http://dev.splunk.com/view/event-collector/SP-CAAAE6P#auth" rel="noopener ugc nofollow" target="_blank">允许查询字符串</a>)。</li></ul><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es km"><img src="../Images/a52553a96c9438b4ffefce4655da3f0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I5c66kdR-v-3sckLKjQAcA.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">创建一个HEC，将数据馈送到<strong class="bd jv"> <em class="if"> Splunk </em> </strong>实例</figcaption></figure><ul class=""><li id="327c" class="jw jx hi ii b ij ik in io ir jy iv jz iz ka jd kb kc kd ke bi translated">允许基于SSL的HEC。</li></ul><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kn"><img src="../Images/888cdd3f4389e63e08c10b25197e112b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0WMPBxS0xjs8eim-xrcL0Q.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">通过启用“常规”部分中的所有令牌来允许基于SSL的HEC</figcaption></figure><ul class=""><li id="85a5" class="jw jx hi ii b ij ik in io ir jy iv jz iz ka jd kb kc kd ke bi translated">最后，指定HEC要使用的SSL证书(priv_key应该包含带有加密私钥的完整链)</li></ul><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es ko"><img src="../Images/5078dc141dda4eb5e4e5317e753e0453.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gZf-NN3sWB5EpF74AAK9HA.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">server.conf使用SSL加密证书链</figcaption></figure><p id="dd4c" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated"><strong class="ii hj">在<em class="je"> gcp </em>侧:</strong></p><ul class=""><li id="7414" class="jw jx hi ii b ij ik in io ir jy iv jz iz ka jd kb kc kd ke bi translated">在<strong class="ii hj"> <em class="je"> gcp </em> </strong>上验证<strong class="ii hj"> <em class="je"> Splunk </em> </strong>域。</li></ul><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kp"><img src="../Images/53b807a12520d9ffc984d120ca29dd73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EMc8Up7zzgLSzvEWhMhxCw.png"/></div></div></figure><ul class=""><li id="9fc2" class="jw jx hi ii b ij ik in io ir jy iv jz iz ka jd kb kc kd ke bi translated">使用正确的格式构建一个<strong class="ii hj"> <em class="je"> PubSub </em> </strong>主题，其中包含<strong class="ii hj"><em class="je">Splunk</em></strong><strong class="ii hj"><em class="je">HEC</em></strong>端点(enpoind的格式必须为<em class="je">https://</em><strong class="ii hj"><em class="je">Splunk _ URL</em></strong><em class="je">:8088/services/collector/raw？TOKEN =</em><strong class="ii hj"><em class="je">TOKEN _ ID</em></strong>)。</li></ul><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kq"><img src="../Images/5cbbf9aca5f90d40df4da201ee4d91ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5moB2JH1QDSQDA3hVLIMfQ.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated"><strong class="bd jv"> <em class="if"> PubSub </em> </strong>使用推送订阅向<strong class="bd jv"> <em class="if"> Splunk </em> </strong>发送消息</figcaption></figure><ul class=""><li id="65e7" class="jw jx hi ii b ij ik in io ir jy iv jz iz ka jd kb kc kd ke bi translated">为<strong class="ii hj"> <em class="je"> Stackdriver </em> </strong>生成一个sink，将日志推送到<strong class="ii hj"> <em class="je"> PubSub </em> </strong>上。</li></ul><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kr"><img src="../Images/5f1dd051740300ccc191e3693bd7c056.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UcO0mAbJYFmFyemOqzx2rw.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">创建一个<strong class="bd jv"> <em class="if"> StackDriver </em> </strong>日志接收器，并将消息发送到先前创建的<strong class="bd jv"> <em class="if"> PubSub </em> </strong>主题</figcaption></figure><p id="bf58" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">一旦每个部分都就位并相互对话，这就是从<strong class="ii hj"> <em class="je"> PubSub </em> </strong>发送的消息从<strong class="ii hj"> <em class="je"> Splunk </em> </strong>的角度看起来的样子:</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es ks"><img src="../Images/c279d89963d95013ef9d185f6a312d96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fqNpDu1NekWMuRyIFiMdfA.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">来自<strong class="bd jv"> <em class="if"> PubSub </em> </strong>的原始消息</figcaption></figure><p id="bb0e" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">或通过WebUI的等效功能:</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kt"><img src="../Images/57f61fab995827249d8c588f151877b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Chp8u0AtCCXNFX0f2YTppw.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated"><strong class="bd jv"> <em class="if"> Splunk </em> </strong>展示通过<strong class="bd jv"> <em class="if"> PubSub </em> </strong>接收的消息</figcaption></figure><p id="4821" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">请注意，默认情况下，该消息由<strong class="ii hj"> <em class="je"> PubSub </em> </strong>进行base64编码。通过使用以下查询，可以在运行时在<strong class="ii hj"> <em class="je"> Splunk </em> </strong>内对消息进行解码。</p><pre class="jg jh ji jj fd ku kv kw kx aw ky bi"><span id="ee43" class="kz la hi kv b fi lb lc l ld le">message.data="*" | fields message.data,subscription,message.messageId,message.publishTime | rex field=message.data "(?&lt;data&gt;.*)" | base64 field=data mode=append action=decode | table message.messageId, message.publishTime, subscription, base64</span></pre><p id="0b5a" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">通过<strong class="ii hj"><em class="je">Splunk</em></strong><strong class="ii hj"><em class="je">WebUI</em></strong>获得的样本结果的图形表示:</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es lf"><img src="../Images/ac959346b4425b4352f3944b1f1934b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tt5suKTmVVVCa2njdlYpyQ.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated"><strong class="bd jv"> <em class="if"> Splunk </em> </strong>使用base64模块对<strong class="bd jv"> <em class="if"> PubSub </em> </strong>提供的内容进行解码</figcaption></figure><p id="c7d2" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated"><strong class="ii hj">结论:</strong></p><p id="7d87" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">已经证明，至少有一种方法可以通过push将<strong class="ii hj"> <em class="je"> Stackdriver </em> </strong>连接到<strong class="ii hj"> <em class="je"> Splunk </em> </strong>，而不需要第三方甚至自定义或自制代码的介入。</p><p id="d867" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">我知道这种方法在大量突发事件发生时缺乏消息确认和流量控制。</p><p id="4b31" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">为了从当前提案中构建解决方案，还有很多改进的空间。</p><p id="49d8" class="pw-post-body-paragraph ig ih hi ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hb bi translated">我的理解是，无论Splunk上的消息推送的官方提议是什么，它都应该以云原生计划的形式出现。无论何时解决方案发布，我都准备好去尝试它。与此同时，这就足够了。</p></div></div>    
</body>
</html>