<html>
<head>
<title>Gitlab Continuous Deployment Pipeline to GKE with Helm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Gitlab通过Helm持续部署到GKE</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gitlab-continuous-deployment-pipeline-to-gke-with-helm-69d8a15ed910?source=collection_archive---------0-----------------------#2019-03-30">https://medium.com/google-cloud/gitlab-continuous-deployment-pipeline-to-gke-with-helm-69d8a15ed910?source=collection_archive---------0-----------------------#2019-03-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="eb43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我分享了关于使用shell runner使用Gitlab Community Edition(CE)的Google Cloud Build服务。你可以从<a class="ae jd" rel="noopener" href="/google-cloud/using-google-container-builder-service-from-gitlab-ce-93d96dea06bb">这篇文章</a>中获得关于构建docker图像并将其存储在谷歌容器注册中心(GCR)的想法。</p><p id="17a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我们的目标是熟悉从docker构建到部署到GKE(Google Kubernetes引擎)的管道，这适用于Gitlab的CE和EE(企业版)。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/f9e42672d7cc5a3951b6632535a8b707.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XvFIqBsB5mtMpTQ5G6wEtw.jpeg"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图片来源:blog.pactosystems.com</figcaption></figure><p id="6cdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，流程应该是:</p><ol class=""><li id="1c8f" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">在GKE创建一个Kubernetes集群</li><li id="7495" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">配置用于访问群集和使用云构建服务的服务帐户凭据</li><li id="103d" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">创建gitlab项目，添加gitlab-ci pipline以及cloudbuild &amp; dockerfile</li><li id="4934" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">安装舵图以方便部署</li><li id="ac8f" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">启动并运行持续部署</li><li id="474c" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">保护GKE集群</li></ol><p id="abfc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从<strong class="ih hj">创建GKE集群</strong>开始。前往<a class="ae jd" href="https://console.cloud.google.com/kubernetes/add" rel="noopener ugc nofollow" target="_blank"> Google Cloud Project </a>上的集群创建页面，选择favorite zone，添加节点(如果用于测试，您可能更喜欢自动扩展和可抢占的节点)，更好地启用VPC本地集群，根据需要调整其余设置，然后点击create。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ki"><img src="../Images/778e5f6486aaa9c556809cba97a15979.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*0Gpltiix58TckYUjfvXfoA.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">创建GKE集群</figcaption></figure><p id="ba89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几分钟后，集群将准备就绪。</p><p id="6884" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，是时候<strong class="ih hj">创建一个服务帐户来从Gitlab访问GKE资源</strong>并触发代码构建了。转到IAM (身份和访问管理)的<a class="ae jd" href="https://console.cloud.google.com/iam-admin/serviceaccounts/create" rel="noopener ugc nofollow" target="_blank">服务帐户添加页面，添加新的服务帐户。给它起一个合适的名字，附加权限，创建一个json密钥，然后点击done。</a></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kj"><img src="../Images/309953a6e4180e6a400abea49e6ea603.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Muv9anxB_xblIhA9uECFaw.png"/></div></div></figure><p id="04fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="kk">更新:</em> </strong></p><p id="b4c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以创建一个单独的GCS存储桶来存储云构建日志，并通过以下步骤向服务帐户授予<code class="du kl km kn ko b">objectCreator</code>权限，而不是授予存储管理员和项目查看者权限:</p><pre class="jf jg jh ji fd kp ko kq kr aw ks bi"><span id="1eeb" class="kt ku hi ko b fi kv kw l kx ky">gsutil mb gs://[BUCKET-NAME]/</span><span id="b4c3" class="kt ku hi ko b fi kz kw l kx ky">gsutil iam ch serviceAccount:[SERVICE-ACCOUNT-ID]:objectCreator gs://[BUCKET-NAME]</span><span id="6099" class="kt ku hi ko b fi kz kw l kx ky">eg.<br/>gsutil mb gs://gitlab-gke-cloudbuild-logs/</span><span id="3f20" class="kt ku hi ko b fi kz kw l kx ky">gsutil iam ch serviceAccount:gitlab-gke@pv-lb-test.iam.gserviceaccount.com:objectCreator gs://gitlab-gke-cloudbuild-logs</span></pre><p id="9e83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以利用<a class="ae jd" href="https://cloud.google.com/shell/" rel="noopener ugc nofollow" target="_blank">云外壳</a>来执行上述命令，或者通过控制台添加权限。</p><p id="a331" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">是时候去Gitlab了！！</strong></p><p id="2382" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们在<a class="ae jd" href="https://gitlab.com" rel="noopener ugc nofollow" target="_blank">gitlab.com</a>上创建一个新项目，并在上面添加几个文件:Dockerfile，cloudbuild.yaml，。gitlab-ci.yml和项目资源文件。此外，我们将把服务帐户凭证文件保存为Gitlab环境变量。由于不支持多行，我们对文件进行base64加密，并在环境变量上使用编码值，我们将在触发Gcloud资源时解码该值。对文件进行编码:</p><pre class="jf jg jh ji fd kp ko kq kr aw ks bi"><span id="37fe" class="kt ku hi ko b fi kv kw l kx ky">base64 /path/to/credential.json | tr -d \\n</span></pre><p id="d775" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加变量</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es la"><img src="../Images/756d26c920f93f7c7208ed3c98f36249.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6bNwGeGFx88ul9O_a_YjxA.png"/></div></div></figure><p id="2550" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是我们简单的docker文件:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lb"><img src="../Images/8a9a23ec710ea8f7cd429404568727a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/1*SX4BHlku3pdhjlSWO6blEA.png"/></div></figure><p id="ed71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用多阶段构建，工件在<a class="ae jd" href="https://github.com/GoogleContainerTools/distroless" rel="noopener ugc nofollow" target="_blank">发行版</a>基础映像上运行，它是轻量级的，只包含应用程序和运行时依赖。</p><blockquote class="lc ld le"><p id="da0c" class="if ig kk ih b ii ij ik il im in io ip lf ir is it lg iv iw ix lh iz ja jb jc hb bi translated">专注于语言的docker图像，不包括操作系统</p></blockquote><p id="8528" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云构建构建配置文件，包含触发Google云构建服务的任务。我们正在推动docker图像到谷歌容器注册(GCR)。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es li"><img src="../Images/cf4c8d545e46ba08163eaf75aebc6c00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WJxARSHeJ1S8Yi0R5ubpBg.png"/></div></div></figure><p id="073c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和一个简单的go http服务器main.go:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lj"><img src="../Images/6f90272c847e24c0ea1675d92fd7899f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q2mxzHNkvUtfPt5JuhK_7Q.png"/></div></div></figure><p id="08d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以从本地通过构建和运行对docker文件进行测试:</p><pre class="jf jg jh ji fd kp ko kq kr aw ks bi"><span id="ee2f" class="kt ku hi ko b fi kv kw l kx ky">$ docker build -t gitlab-gke .<br/>$ docker run -d -p 8080:8080 --name gitlab-gke gitlab-gke</span></pre><p id="351d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从浏览器向服务器发送几个请求:<a class="ae jd" href="http://localhost:8080/raju" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/raju</a></p><pre class="jf jg jh ji fd kp ko kq kr aw ks bi"><span id="fac4" class="kt ku hi ko b fi kv kw l kx ky">Response: Hello, raju!</span></pre><p id="00d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">配置Gitlab CI </strong></p><p id="ca32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要对gitlab-ci.yml 执行两个主要步骤，这是使用gitlab管道服务的实际文件:</p><ol class=""><li id="7013" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">发布:这一步使用cloudbuild spec文件在云构建环境上执行构建，云构建环境使用Dockerfile构建映像，然后推送到gcr。</li><li id="3ab1" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">部署:为了将新构建的映像部署到GKE集群，我们将其配置为在主分支上有新的提交时运行。你可以根据你的需要创建一个触发器，比如创建标签后，手动触发等。</li></ol><p id="9e85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下阶段发布图像:</p><pre class="jf jg jh ji fd kp ko kq kr aw ks bi"><span id="da67" class="kt ku hi ko b fi kv kw l kx ky">publish-image:<br/>  stage: publish<br/>  image: dwdraju/alpine-gcloud<br/>  script:<br/>    - echo $GCLOUD_SERVICE_KEY | base64 -d &gt; ${HOME}/gcloud-service-key.json<br/>    - gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json<br/>    - gcloud config set project $GCP_PROJECT_ID<br/>    - gcloud builds submit . --config=cloudbuild.yaml --substitutions BRANCH_NAME=$CI_COMMIT_REF_NAME<br/>  only:<br/>    - master</span></pre><p id="c9f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里，我们使用一个简单的基于alpine linux的<a class="ae jd" href="https://github.com/dwdraju/alpine-gcloud" rel="noopener ugc nofollow" target="_blank"><em class="kk">dwdraju/alpine-gcloud</em></a>，它拥有Google cloud sdk，可以通过添加凭证文件来访问g cloud资源。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lk"><img src="../Images/20c409c78d0a34aa46b95a5ed58f10b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BOJHGACsvWB5HGAaYGLp0g.png"/></div></div></figure><p id="ac83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果一切都很好，合并了主分支上的所有代码，它应该会触发一个新的工作，并在谷歌容器注册表上发布新的图像。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ll"><img src="../Images/ebab5344a1a94d9fa89e8a1b9e63b1ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AlYa0tXpYz64wZPixcRdnw.png"/></div></div></figure><h2 id="5efe" class="kt ku hi bd lm ln lo lp lq lr ls lt lu iq lv lw lx iu ly lz ma iy mb mc md me bi translated"><strong class="ak">创建舵图</strong></h2><p id="902e" class="pw-post-body-paragraph if ig hi ih b ii mf ik il im mg io ip iq mh is it iu mi iw ix iy mj ja jb jc hb bi translated">Helm是Kubernetes的一个包管理器，它简化了k8s资源的创建、版本控制和管理。从几个月前开始，它就属于CNCF了。</p><p id="10ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，为我们的应用程序创建一个新图表。我们正在使用最新的Helm版本3，它更像是不需要舵柄代理的二进制文件。</p><pre class="jf jg jh ji fd kp ko kq kr aw ks bi"><span id="99dd" class="kt ku hi ko b fi kv kw l kx ky">$ helm create gitlabgke</span></pre><p id="1067" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它添加了一些Kubernetes <a class="ae jd" href="https://gitlab.com/dwdraju/gitlab-gke/commit/5df168fba930996d28c29fc4bf841ec3c2540ef9" rel="noopener ugc nofollow" target="_blank">清单文件</a>。</p><h2 id="2c52" class="kt ku hi bd lm ln lo lp lq lr ls lt lu iq lv lw lx iu ly lz ma iy mb mc md me bi translated">获取Kubernetes集群凭据以访问GKE和安装舵图</h2><pre class="jf jg jh ji fd kp ko kq kr aw ks bi"><span id="1eac" class="kt ku hi ko b fi kv kw l kx ky">$ gcloud container clusters get-credentials [cluster-name] --zone [cluster-zone] --project [project-name]</span></pre><p id="6de1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回应:</p><pre class="jf jg jh ji fd kp ko kq kr aw ks bi"><span id="10f4" class="kt ku hi ko b fi kv kw l kx ky">Fetching cluster endpoint and auth data.<br/>kubeconfig entry generated for gitlab-cluster.</span></pre><p id="5c51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们需要调整默认舵图上的一些配置:</p><ol class=""><li id="d27f" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">服务类型:节点端口</li><li id="41f7" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">InternalPort: 8080(或根据您的应用程序端口)</li><li id="7033" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">如果您没有域名，并且必须使用全局负载平衡器的IP地址访问服务，请添加默认路由</li><li id="5739" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">图像存储库和标签(我们现在使用gcr . io/[project-name]/git lab-gke:master)</li></ol><p id="28e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是修改的提交:<a class="ae jd" href="https://gitlab.com/dwdraju/gitlab-gke/commit/9f02cf83f39be71b62a8ed07589bfc538bc43349" rel="noopener ugc nofollow" target="_blank">https://git lab . com/dwdraju/git lab-gke/commit/9 f 02 cf 83 f 39 be 71 b 62 A8 ed 07589 bfc 538 BC 43349</a></p><h2 id="cf70" class="kt ku hi bd lm ln lo lp lq lr ls lt lu iq lv lw lx iu ly lz ma iy mb mc md me bi translated">安装舵图的时间到了</h2><pre class="jf jg jh ji fd kp ko kq kr aw ks bi"><span id="ace7" class="kt ku hi ko b fi kv kw l kx ky">helm install gitlabgke .</span></pre><p id="1a78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在几分钟内，它将使pod运行，健康检查通过，新的入口ip可由<code class="du kl km kn ko b">kubectl get ing</code>获得。您现在可以访问ip来获得hello:)</p><p id="e2fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://[ingress-ip]/myname" rel="noopener ugc nofollow" target="_blank">http://[ingress-IP]/my name</a></p><h2 id="4f4a" class="kt ku hi bd lm ln lo lp lq lr ls lt lu iq lv lw lx iu ly lz ma iy mb mc md me bi translated">返回Gitlab CI进行持续部署</h2><p id="7bb9" class="pw-post-body-paragraph if ig hi ih b ii mf ik il im mg io ip iq mh is it iu mi iw ix iy mj ja jb jc hb bi translated">我们需要添加一个新的阶段<strong class="ih hj"> deploy </strong>，因为我们已经有了<strong class="ih hj"> publish </strong>阶段，它会将新的图像发送到容器注册表。</p><pre class="jf jg jh ji fd kp ko kq kr aw ks bi"><span id="2214" class="kt ku hi ko b fi kv kw l kx ky">deploy-image:<br/>  stage: deploy<br/>  image: dwdraju/gke-kubectl-docker<br/>  script:<br/>    - echo $GCLOUD_SERVICE_KEY | base64 -d &gt; ${HOME}/gcloud-service-key.json<br/>    - gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json<br/>    - gcloud config set project $GCP_PROJECT_ID<br/>    - gcloud container clusters get-credentials $CLUSTER_NAME --zone $CLUSTER_ZONE --project $GCP_PROJECT_ID<br/>    - kubectl set env deployment/$K8S_DEPLOYMENT CI_COMMIT_SHA=$CI_COMMIT_SHA<br/>    - kubectl set image deployment/$K8S_DEPLOYMENT $K8S_IMAGE=gcr.io/$GCP_PROJECT_ID/$IMAGE_NAME:$CI_COMMIT_REF_NAME<br/>  only:<br/>    - master</span></pre><p id="eb10" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我们最终的gitlab-ci.yml文件如下所示:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mk"><img src="../Images/b36f4f23e0c87d511bb1891f41e34060.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-VidZERRQz7DMreATwciFg.png"/></div></div></figure><p id="bb0e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果一切都设置正确，我们将获得gitlab工作的成功。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ml"><img src="../Images/d6882b3c5265883b2223c300e76659be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TJSiZ4aZq_c54WZ9Ix3eVw.png"/></div></div></figure><p id="2e4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在设置环境变量<strong class="ih hj"> CI_COMMIT_SHA </strong>之后，我们简单地更改了这里的图像，但是我们可以使用helm通过更改图表的values.yml文件上的标记值来升级版本。</p><pre class="jf jg jh ji fd kp ko kq kr aw ks bi"><span id="8228" class="kt ku hi ko b fi kv kw l kx ky">$ helm upgrade gitlabgke .</span></pre><p id="dc6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以尝试升级头盔。为此，您可以使用我的helm-docker图像，该图像可通过此<a class="ae jd" href="https://github.com/dwdraju/helm-docker" rel="noopener ugc nofollow" target="_blank"> github repo </a>获取使用示例。</p><h2 id="9601" class="kt ku hi bd lm ln lo lp lq lr ls lt lu iq lv lw lx iu ly lz ma iy mb mc md me bi translated">保护集群</h2><ul class=""><li id="000d" class="ju jv hi ih b ii mf im mg iq mm iu mn iy mo jc mp ka kb kc bi translated">如果您使用自托管CE gitlab，请在GKE集群上启用<strong class="ih hj">主授权网络</strong>，并将Gitlab ip地址列入白名单。</li><li id="ab39" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc mp ka kb kc bi translated">要访问pod，最好创建一个特定的服务帐户。这是用于配置的<a class="ae jd" href="https://gitlab.com/dwdraju/gitlab-gke/commit/295d367c3180328639820ca66fe225f6bcc0e2da" rel="noopener ugc nofollow" target="_blank">提交</a>。</li><li id="fab3" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc mp ka kb kc bi translated">我们在这个例子中使用distroless基本映像，这可能不适合所有情况，但最好使用最小的docker映像，如alpine，以减少攻击的机会并最小化docker映像大小。</li><li id="ea68" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc mp ka kb kc bi translated">GKE已经开始提供支持istio的集群，该集群提供具有强身份、强大策略、透明TLS加密以及认证、授权和审计(AAA)的安全特性。试试看，你会爱上istio的。</li></ul><p id="8557" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前就这些，如果你有更好的方法来增强健壮性，请随意发表评论。你可以在<a class="ae jd" href="https://www.linkedin.com/in/dwdraju/" rel="noopener ugc nofollow" target="_blank"> linkedin </a>和<a class="ae jd" href="https://twitter.com/dwdRAJU" rel="noopener ugc nofollow" target="_blank"> twitter </a>上找到我。</p></div></div>    
</body>
</html>