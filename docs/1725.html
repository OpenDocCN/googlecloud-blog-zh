<html>
<head>
<title>How to create CloudSQL Mysql instance with terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用terraform创建CloudSQL Mysql实例</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-create-cloudsql-mysql-instance-with-terraform-e87a396b2b58?source=collection_archive---------0-----------------------#2020-12-23">https://medium.com/google-cloud/how-to-create-cloudsql-mysql-instance-with-terraform-e87a396b2b58?source=collection_archive---------0-----------------------#2020-12-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9609" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">先决条件:</p><p id="f405" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你需要地形</p><p id="e3e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参见<a class="ae jd" href="https://learn.hashicorp.com/tutorials/terraform/install-cli" rel="noopener ugc nofollow" target="_blank">https://learn.hashicorp.com/tutorials/terraform/install-cli</a>安装平台。</p><p id="1f2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1-创建tfvar文件:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="a8ac" class="jn jo hi jj b fi jp jq l jr js">#cat terraform.tfvars</span><span id="1758" class="jn jo hi jj b fi jt jq l jr js">project = "project-id"</span><span id="90e9" class="jn jo hi jj b fi jt jq l jr js">region = "europe-west4"</span></pre><p id="cd44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2-创建tf文件，并将mysql数据库相关信息放入其中，例如实例、数据库名称和root密码:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="da84" class="jn jo hi jj b fi jp jq l jr js">#cat main.tf</span><span id="b919" class="jn jo hi jj b fi jt jq l jr js">variable "project" {}</span><span id="1913" class="jn jo hi jj b fi jt jq l jr js">variable "region" {}</span><span id="b3f4" class="jn jo hi jj b fi jt jq l jr js">provider "google" {</span><span id="64cd" class="jn jo hi jj b fi jt jq l jr js">project = "${var.project}"</span><span id="65e4" class="jn jo hi jj b fi jt jq l jr js">region = "${var.region}"</span><span id="879b" class="jn jo hi jj b fi jt jq l jr js">}</span><span id="ad53" class="jn jo hi jj b fi jt jq l jr js">resource “google_sql_database_instance” “master” {</span><span id="c5dd" class="jn jo hi jj b fi jt jq l jr js">name = "instance_name"</span><span id="8163" class="jn jo hi jj b fi jt jq l jr js">database_version = "MYSQL_5_7"</span><span id="d66f" class="jn jo hi jj b fi jt jq l jr js">region = "${var.region}"</span><span id="961d" class="jn jo hi jj b fi jt jq l jr js">settings {</span><span id="51a5" class="jn jo hi jj b fi jt jq l jr js">tier = "db-n1-standard-2"</span><span id="39ac" class="jn jo hi jj b fi jt jq l jr js">}</span><span id="affe" class="jn jo hi jj b fi jt jq l jr js">}</span><span id="369d" class="jn jo hi jj b fi jt jq l jr js">resource "google_sql_database" “database” {</span><span id="95db" class="jn jo hi jj b fi jt jq l jr js">name = "database_name"</span><span id="8809" class="jn jo hi jj b fi jt jq l jr js">instance = "${google_sql_database_instance.master.name}"</span><span id="e829" class="jn jo hi jj b fi jt jq l jr js">charset = "utf8"</span><span id="849c" class="jn jo hi jj b fi jt jq l jr js">collation = "utf8_general_ci"</span><span id="8a27" class="jn jo hi jj b fi jt jq l jr js">}</span><span id="5c00" class="jn jo hi jj b fi jt jq l jr js">resource "google_sql_user" "users" {</span><span id="8a64" class="jn jo hi jj b fi jt jq l jr js">name = "root"</span><span id="dfdb" class="jn jo hi jj b fi jt jq l jr js">instance = "${google_sql_database_instance.master.name}"</span><span id="6a3d" class="jn jo hi jj b fi jt jq l jr js">host = "%"</span><span id="34ef" class="jn jo hi jj b fi jt jq l jr js">password = "XXXXXXXXX"</span><span id="7524" class="jn jo hi jj b fi jt jq l jr js">}</span></pre><p id="c13b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3-在gcp上创建服务帐户，该帐户具有创建CloudSQL实例的必要权限:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="6c47" class="jn jo hi jj b fi jp jq l jr js">gcloud iam service-accounts create sa-terraform — display-name "Terraform service account"</span></pre><p id="0c55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将CloudSQL Admin角色分配给服务帐户:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="8c8b" class="jn jo hi jj b fi jp jq l jr js">gcloud projects add-iam-policy-binding PROJECT_ID — member="serviceAccount:sa-terraform@PROJECT_ID.iam.gserviceaccount.com" — role="roles/cloudsql.admin"</span></pre><p id="a8b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建terraform将使用的服务帐户密钥:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="12b8" class="jn jo hi jj b fi jp jq l jr js">gcloud iam service-accounts keys create ./key.json \</span><span id="e7a4" class="jn jo hi jj b fi jt jq l jr js">— iam-account sa-terraform<a class="ae jd" href="mailto:terraform-sa@project-id.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">@</a>PROJECT_ID<a class="ae jd" href="mailto:terraform-sa@project-id.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">.iam.gserviceaccount.com</a></span></pre><p id="c84b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导出GOOGLE _应用程序_凭据:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="0f66" class="jn jo hi jj b fi jp jq l jr js">export GOOGLE_APPLICATION_CREDENTIALS=./key.json</span></pre><p id="9b53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4-初始化地形:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="0372" class="jn jo hi jj b fi jp jq l jr js">terraform init</span></pre><p id="8169" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5-获取地形图</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="5655" class="jn jo hi jj b fi jp jq l jr js">terraform plan</span></pre><p id="81cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6-应用地形</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="b9a0" class="jn jo hi jj b fi jp jq l jr js">terraform apply</span></pre><p id="28e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果这是一个全新的项目，或者如果您之前没有在项目中创建CloudSQL，您可能会得到如下错误:</p><h2 id="c457" class="jn jo hi bd ju jv jw jx jy jz ka kb kc iq kd ke kf iu kg kh ki iy kj kk kl km bi translated">错误:错误，未能创建实例emlak: googleapi:错误403:云SQL Admin API以前未在项目XXXXXXXXX中使用过，或者已被禁用。通过访问<a class="ae jd" href="https://console.developers.google.com/apis/api/sqladmin.googleapis.com/overview?project=XXXXXXXXX" rel="noopener ugc nofollow" target="_blank">https://console . developers . Google . com/APIs/API/sqladmin . Google APIs . com/overview启用？project=XXXXXXXXX </a>然后重试。如果您最近启用了此API，请等待几分钟，让操作传播到我们的系统，然后重试。，访问未配置</h2><blockquote class="kn ko kp"><p id="fd49" class="if ig kq ih b ii ij ik il im in io ip kr ir is it ks iv iw ix kt iz ja jb jc hb bi translated">您可以在GCP控制台中启用Cloudsql api，或者只需将错误消息中的url复制/粘贴到您的浏览器中，然后启用该api。</p></blockquote><p id="487c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后再次尝试terraform应用。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="d5ba" class="jn jo hi jj b fi jp jq l jr js">Do you want to perform these actions?<br/> Terraform will perform the actions described above.<br/> Only ‘yes’ will be accepted to approve.</span><span id="96a8" class="jn jo hi jj b fi jt jq l jr js">Enter a value: yes</span><span id="ea88" class="jn jo hi jj b fi jt jq l jr js">google_sql_database_instance.master: Creating…<br/>google_sql_database_instance.master: Still creating… [10s elapsed]<br/>google_sql_database_instance.master: Still creating… [20s elapsed]<br/>google_sql_database_instance.master: Still creating… [30s elapsed]<br/>google_sql_database_instance.master: Still creating… [40s elapsed]<br/>google_sql_database_instance.master: Still creating… [50s elapsed]<br/>google_sql_database_instance.master: Still creating… [1m0s elapsed]<br/>google_sql_database_instance.master: Still creating… [1m10s elapsed]<br/>google_sql_database_instance.master: Still creating… [1m20s elapsed]<br/>google_sql_database_instance.master: Still creating… [1m30s elapsed]<br/>google_sql_database_instance.master: Still creating… [1m40s elapsed]<br/>google_sql_database_instance.master: Still creating… [1m50s elapsed]<br/>google_sql_database_instance.master: Still creating… [2m0s elapsed]<br/>google_sql_database_instance.master: Still creating… [2m10s elapsed]<br/>google_sql_database_instance.master: Still creating… [2m20s elapsed]<br/>google_sql_database_instance.master: Still creating… [2m30s elapsed]<br/>google_sql_database_instance.master: Still creating… [2m40s elapsed]<br/>google_sql_database_instance.master: Still creating… [2m50s elapsed]<br/>google_sql_database_instance.master: Creation complete after 2m55s [id=instanceid]<br/>google_sql_database.database: Creating…<br/>google_sql_user.users: Creating…<br/>google_sql_user.users: Still creating… [22s elapsed]<br/>google_sql_database.database: Still creating… [22s elapsed]<br/>google_sql_database.database: Creation complete after 24s [id=projects/projectid/instances/instanceid/databases/dbid]<br/>google_sql_user.users: Creation complete after 28s [id=root/%/instanceid]</span></pre><p id="044e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样，你用terraform创建了你的Cloudsql Mysql实例。</p></div></div>    
</body>
</html>