<html>
<head>
<title>Node-RED on Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云平台上的Node-RED</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/running-node-red-on-google-cloud-platform-under-docker-3d4185e97f28?source=collection_archive---------0-----------------------#2016-08-22">https://medium.com/google-cloud/running-node-red-on-google-cloud-platform-under-docker-3d4185e97f28?source=collection_archive---------0-----------------------#2016-08-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1641" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://nodered.org/" rel="noopener ugc nofollow" target="_blank"> Node-RED </a>很有意思。Node-RED <a class="ae jd" href="http://nodered.org/docs/" rel="noopener ugc nofollow" target="_blank">文档</a>不包含在<a class="ae jd" href="https://cloud.google.com" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a> (GCP)上运行Node-RED的说明。如果你没有用过GCP，还有免费的选项。</p><h2 id="14ad" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">更新时间:18–05–20</h2><p id="d501" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">自从我两年前写这篇文章以来，GCP发生了(许多)变化。作为对<a class="ke kf ge" href="https://medium.com/u/41619cbdee8d?source=post_page-----3d4185e97f28--------------------------------" rel="noopener" target="_blank"> Shiv Kodam </a>的回应，这里有一个更新，它将帮助你让Node-RED在(a) <a class="ae jd" href="https://cloud.google.com/container-optimized-os/" rel="noopener ugc nofollow" target="_blank">容器优化的OS </a>镜像上运行(<code class="du kg kh ki kj b">container-vm</code>已被否决)；(b) <a class="ae jd" href="https://cloud.google.com/kubernetes-engine/" rel="noopener ugc nofollow" target="_blank"> Kubernetes发动机</a>。</p><h2 id="f999" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">容器优化的操作系统</h2><p id="a5e8" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">容器优化的操作系统使用<a class="ae jd" href="https://cloudinit.readthedocs.org/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> cloud-init </a>进行配置。下面是一个经过调整的cloud-init文件，它运行一个节点红色的容器:</p><figure class="kk kl km kn fd ko"><div class="bz dy l di"><div class="kp kq l"/></div></figure><p id="9f5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用上面的<code class="du kg kh ki kj b">cloud-init</code>文件创建容器优化的OS VM:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="7657" class="je jf hi kj b fi kv kw l kx ky">gcloud compute instances create ${NODE} \<br/>--image-family=cos-stable \<br/>--image-project=cos-cloud \<br/>--metadata-from-file=user-data=./cloud-init.yaml \<br/>--machine-type=f1-micro \<br/>--zone=${ZONE} \<br/>--preemptible \<br/>--project=${PROJECT}</span></pre><blockquote class="kz la lb"><p id="c68b" class="if ig lc ih b ii ij ik il im in io ip ld ir is it le iv iw ix lf iz ja jb jc hb bi translated">这是一个廉价的虚拟机<code class="du kg kh ki kj b"><a class="ae jd" href="https://cloud.google.com/compute/docs/machine-types#f1-micro" rel="noopener ugc nofollow" target="_blank">f1-micro</a></code>，它是<code class="du kg kh ki kj b"><a class="ae jd" href="https://cloud.google.com/compute/docs/instances/preemptible" rel="noopener ugc nofollow" target="_blank">preemptible</a></code>。如果你想要更大的马力，选择一个更强大的虚拟机。</p></blockquote><p id="d823" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">给映像一点时间来稳定，下载Node-RED并运行容器。您可以通过ssh进入虚拟机，然后运行<code class="du kg kh ki kj b"> — command</code>，或者像这里一样，一起运行它们:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="11cc" class="je jf hi kj b fi kv kw l kx ky">gcloud compute ssh ${NODE} \<br/>--project=${PROJECT} \<br/>--command="sudo journalctl --unit=node-red --follow"</span></pre><p id="b0dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于成功启动的<code class="du kg kh ki kj b">node-red-docker</code>容器，您希望看到类似如下的内容:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="89d8" class="je jf hi kj b fi kv kw l kx ky">20 May 19:54:31 - [info] Server now running at <a class="ae jd" href="http://127.0.0.1:1880/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:1880/</a><br/>20 May 19:54:31 - [info] Starting flows<br/>20 May 19:54:31 - [info] Started flows</span></pre><p id="56cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦容器开始运行，您就可以远程<code class="du kg kh ki kj b">curl</code>Node-RED端点:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="9462" class="je jf hi kj b fi kv kw l kx ky">gcloud compute ssh ${NODE} \<br/>--project=${PROJECT} \<br/>--command="curl localhost:1880"</span></pre><p id="a3ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该会看到以下形式的输出:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="aa91" class="je jf hi kj b fi kv kw l kx ky">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>...<br/>&lt;head&gt;<br/>&lt;title&gt;Node-RED&lt;/title&gt;<br/>...<br/>&lt;/head&gt;<br/>...</span></pre><p id="701c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您不想创建防火墙规则，您可以使用<code class="du kg kh ki kj b">gcloud</code>创建一个从VM的端口<code class="du kg kh ki kj b">1880</code>到本地机器的端口<code class="du kg kh ki kj b">1880</code>的ssh端口转发:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="b18f" class="je jf hi kj b fi kv kw l kx ky">gcloud compute ssh ${NODE} \<br/>--ssh-flag="-L 1880:localhost:1880" \<br/>--project=${PROJECT}</span></pre><p id="c69e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，从您的浏览器中:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="7650" class="je jf hi kj b fi kv kw l kx ky">google-chrome http://localhost:1880</span></pre><figure class="kk kl km kn fd ko er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lg"><img src="../Images/987f0704f0def149cb6ae1110f349822.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q3eS7Uwy8ogH0DH4gQcZrQ.png"/></div></div></figure><p id="3226" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成后，不要忘记清除虚拟机:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="ca50" class="je jf hi kj b fi kv kw l kx ky">gcloud compute instances delete ${NODE} \<br/>--project=${PROJECT}</span></pre><h2 id="9d51" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">库伯内特发动机</h2><p id="9470" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">将Node-RED作为单个Pod |服务部署到Kubernetes(引擎)非常简单。假设您有一个通过身份验证的集群:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="8834" class="je jf hi kj b fi kv kw l kx ky">NAMESPACE=node-red</span><span id="75ff" class="je jf hi kj b fi ln kw l kx ky">kubectl create namespace ${NAMESPACE}<br/>kubectl apply --filename=node-red.yaml --namespace=${NAMESPACE}<br/>deployment.extensions "node-red" created<br/>service "node-red" created</span></pre><figure class="kk kl km kn fd ko er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lo"><img src="../Images/df463b6694b77f40ef852bbdda371ea4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xm9nHtrL9iaNxro2M4qdQA.png"/></div></div></figure><p id="a714" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以使用此快捷方式获取Kubernetes的一个节点，确定Node-Red服务的NodePort(在上面的控制台截图中，您可以看到在我的例子中这是<code class="du kg kh ki kj b">31156</code>),然后使用gcloud将端口转发到该节点上的这个NodePort:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="e48c" class="je jf hi kj b fi kv kw l kx ky">NODE=$(\<br/>  kubectl get nodes \<br/>  --output=jsonpath="{.items[0].metadata.name}")</span><span id="3a36" class="je jf hi kj b fi ln kw l kx ky">PORT=$(\<br/>  kubectl get services/node-red \<br/>  --namespace=${NAMESPACE} \<br/>  --output=jsonpath="{.spec.ports[0].nodePort}")</span><span id="ae56" class="je jf hi kj b fi ln kw l kx ky">echo ${PORT}</span><span id="c6b0" class="je jf hi kj b fi ln kw l kx ky">gcloud compute ssh ${HOST} \<br/>--ssh-flag="-L ${PORT}:localhost:${PORT}" \<br/>--project=${PROJECT}</span></pre><p id="1f77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以像以前一样评估Node-RED，但是使用NodePort ( <code class="du kg kh ki kj b">${PORT}</code>而不是<code class="du kg kh ki kj b">1880</code>):</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="2f1c" class="je jf hi kj b fi kv kw l kx ky">google-chrome http://${HOST}:${PORT}</span></pre><h2 id="14a7" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">旁白:Chromebook</h2><p id="16c8" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">昨天我在用Chromebook修改这个帖子。由于出色的<a class="ae jd" href="https://cloud.google.com/shell/" rel="noopener ugc nofollow" target="_blank">云外壳</a>，使用Chromebook时仍然可以运行port-forward。</p><p id="a738" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用Cloud Shell，您可以运行上面的命令。唯一的区别是Cloud Shell有一组受约束的端口(<code class="du kg kh ki kj b">8080–8084</code>)。因此，当涉及到<code class="du kg kh ki kj b">gcloud</code>端口转发时，请使用这些值中的一个来代替<code class="du kg kh ki kj b">1880</code>，为了便于讨论，我们使用<code class="du kg kh ki kj b">8083</code>:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="127c" class="je jf hi kj b fi kv kw l kx ky">gcloud compute ${NODE} \<br/>--ssh-flag="-L 8083:localhost:1880"</span></pre><p id="96f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，如果尚未更改，请单击“更改端口”:</p><figure class="kk kl km kn fd ko er es paragraph-image"><div class="er es lp"><img src="../Images/043fbfe7103ebd741911118e2d94d95c.png" data-original-src="https://miro.medium.com/v2/resize:fit:696/format:webp/1*0yhSnHSFAGQsrMWZUeSGGg.png"/></div></figure><p id="2127" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并将其设置为<code class="du kg kh ki kj b">8083</code>:</p><figure class="kk kl km kn fd ko er es paragraph-image"><div class="er es lq"><img src="../Images/905c03f02de68bfd4b8f7ac7c43c3c24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/format:webp/1*UdsAVUNQZJQ2xhG8kb5gSA.png"/></div></figure><p id="8970" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并且，您应该像以前一样看到红色的节点控制台。</p><p id="cfd8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仅此而已！</p><h2 id="a59c" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">原创内容</h2><p id="09bc" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">在GCP上运行Node-RED非常容易。</p><p id="4998" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你之前没有用过谷歌云平台，从这里的开始<a class="ae jd" href="https://cloud.google.com/free-trial/" rel="noopener ugc nofollow" target="_blank">。否则，假设您有一个项目[[PROJECT-ID]]，并且安装了</a><a class="ae jd" href="https://cloud.google.com/sdk/" rel="noopener ugc nofollow" target="_blank"> Cloud SDK </a>，让我们从定义一些环境变量开始:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="2d3e" class="je jf hi kj b fi kv kw l kx ky">PROJECT=[[PROJECT-ID]]<br/>NODE=[[NODE-NAME]]                     # e.g. "node-red"<br/>ZONE=[[ZONE]]                          # e.g. "us-east1-d"<br/>CONTAINER_FILE=[[CONTAINER-FILENAME]]  # e.g. "node_red.yaml"</span></pre><p id="801a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了简单起见，我们将在虚拟机上的Docker中运行Node-RED。我们向GCP提供了一个配置文件和创建虚拟机的命令。</p><p id="2615" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个名为[CONTAINER_FILE]]的文件，并使用以下文本作为其内容。这告诉GCP在哪里可以找到Node-RED的Docker映像，并在端口1880上运行它:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="7537" class="je jf hi kj b fi kv kw l kx ky">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: node-red<br/>spec:<br/>  containers:<br/>    - name: node-red<br/>      image: nodered/node-red-docker:latest<br/>      imagePullPolicy: Always<br/>      ports:<br/>        - containerPort: 1880<br/>          hostPort: 1880</span></pre><p id="b6f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，要创建一个运行Docker的虚拟机，并使用[[CONTAINER_FILE]]安装和配置Node-RED，请使用以下命令:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="1dcb" class="je jf hi kj b fi kv kw l kx ky">gcloud compute instances create $NODE \<br/>--image=container-vm \<br/>--metadata-from-file=google-container-manifest=$CONTAINER_FILE \<br/>--machine-type=custom-1-2048 \<br/>--zone=$ZONE \<br/>--project=$PROJECT \<br/>--tags=node-red</span></pre><p id="5b7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该命令完成并创建虚拟机后，它将总结虚拟机的详细信息，包括EXTERNAL_IP地址。记录下这个EXTERNAL_IP地址，因为它是您将用来浏览Node-RED的IP地址。您还可以使用以下命令找到您的节点的EXTERNAL_IP:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="f714" class="je jf hi kj b fi kv kw l kx ky">gcloud compute instances list \<br/>--filter=NAME=$NODE \<br/>--format='table[no-heading](EXTERNAL_IP)' \<br/>--project=$PROJECT</span></pre><p id="97cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了从其他机器访问节点红色虚拟机，您必须打开端口1880的防火墙。使用此命令:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="8f01" class="je jf hi kj b fi kv kw l kx ky">gcloud compute firewall-rules create allow-node-red \<br/>--project=$PROJECT \<br/>--allow tcp:1880 \<br/>--network=default \<br/>--source-ranges=0.0.0.0/0 \<br/>--target-tags=node-red</span></pre><p id="3029" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！</p><p id="5a0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您应该能够使用以下URL访问Node-RED。用您之前确定的IP地址替换EXTERNAL_IP:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="d6a4" class="je jf hi kj b fi kv kw l kx ky">http://[[EXTERNAL_IP]]:1880</span></pre><figure class="kk kl km kn fd ko er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lr"><img src="../Images/d8c967f3c3fb5eef8236d4f734270f1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eKXtVFt-sRSa0xr7wGQsbQ.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">节点红色—随时可用！</figcaption></figure><p id="dc47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，使用“<a class="ae jd" href="http://nodered.org/docs/getting-started/first-flow" rel="noopener ugc nofollow" target="_blank">第一个流</a>展开:</p><figure class="kk kl km kn fd ko er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lw"><img src="../Images/001e0cc8292aa472d6a60b815b9f9fc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RxqJvxeHUL5WykxGN8T_8g.png"/></div></div></figure><h1 id="c7eb" class="lx jf hi bd jg ly lz ma jk mb mc md jo me mf mg jr mh mi mj ju mk ml mm jx mn bi translated">拆毁</h1><p id="0776" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">要删除虚拟机和防火墙，请使用以下命令:</p><pre class="kk kl km kn fd kr kj ks kt aw ku bi"><span id="713e" class="je jf hi kj b fi kv kw l kx ky">gcloud compute instances delete $NODE \<br/>--project=$PROJECT \<br/>--quiet</span><span id="52af" class="je jf hi kj b fi ln kw l kx ky">gcloud compute firewall-rules delete allow-node-red \<br/>--project=$PROJECT \<br/>--quiet</span></pre><h1 id="7660" class="lx jf hi bd jg ly lz ma jk mb mc md jo me mf mg jr mh mi mj ju mk ml mm jx mn bi translated">结论</h1><p id="8241" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">在Google云平台的VM上的容器中运行Node-RED非常容易。玩得开心！</p></div></div>    
</body>
</html>