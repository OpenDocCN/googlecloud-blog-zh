<html>
<head>
<title>How to Create Remote Functions in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在BigQuery中创建远程函数</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-create-remote-functions-in-bigquery-8a2319038308?source=collection_archive---------0-----------------------#2022-09-15">https://medium.com/google-cloud/how-to-create-remote-functions-in-bigquery-8a2319038308?source=collection_archive---------0-----------------------#2022-09-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="5558" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用远程函数以无限的方式处理和扩充BigQuery数据</h2></div><h1 id="1e7e" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">介绍</h1><p id="7e24" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">Google BigQuery是一个针对分析工作负载优化的无服务器数据仓库。BigQuery使用Google标准SQL命令，并支持多种内置函数。但是，也有内置功能不够用的情况。<a class="ae kl" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/remote-functions" rel="noopener ugc nofollow" target="_blank"> BigQuery远程函数</a>允许BigQuery用户通过对云函数的自定义函数调用来处理他们的数据。</p><p id="2280" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">例如，BigQuery远程函数可以用于以下用途:</p><ol class=""><li id="8c8c" class="kr ks hi jr b js km jv kn jy kt kc ku kg kv kk kw kx ky kz bi translated">定制哈希和加密/解密工作负载</li><li id="2826" class="kr ks hi jr b js la jv lb jy lc kc ld kg le kk kw kx ky kz bi translated">机器学习推理</li><li id="2839" class="kr ks hi jr b js la jv lb jy lc kc ld kg le kk kw kx ky kz bi translated">反向地理编码</li><li id="3056" class="kr ks hi jr b js la jv lb jy lc kc ld kg le kk kw kx ky kz bi translated">数据扩充</li></ol><p id="ff80" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">本操作指南将举例说明创建和使用BigQuery远程函数的分步示例。这个函数将使用SHA-384散列函数，它不是BigQuery中固有的函数。</p><h2 id="bfe6" class="lf iy hi bd iz lg lh li jd lj lk ll jh jy lm ln jj kc lo lp jl kg lq lr jn ls bi translated"><strong class="ak">名称和参考文献</strong></h2><p id="9275" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">我在本指南中使用的名称是:</p><p id="7272" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated"><strong class="jr hj">项目ID </strong> : <code class="du lt lu lv lw b">bq-remote-functions</code> <br/> <strong class="jr hj">云函数名称</strong> : <code class="du lt lu lv lw b">remote_hash</code> <br/> <strong class="jr hj">云函数入口点</strong> : <code class="du lt lu lv lw b">remote_hash</code> <br/> <strong class="jr hj"> BigQuery数据集</strong> : <code class="du lt lu lv lw b">remote_functions_dataset</code> <br/> <strong class="jr hj"> BigQuery表</strong> : <code class="du lt lu lv lw b">remote_functions_table_native</code> <br/> <strong class="jr hj"> BigQuery远程函数连接</strong> : <code class="du lt lu lv lw b">remote-function-connection</code></p><h1 id="d6d4" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated"><strong class="ak">第一步:启用所需的API</strong></h1><p id="e2d2" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">打开<a class="ae kl" href="http://shell.cloud.google.com" rel="noopener ugc nofollow" target="_blank">云壳</a>，如果需要，用<code class="du lt lu lv lw b">gcloud config set project [PROJECT ID]</code>设置你的项目。</p><p id="576d" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">启用必要的API:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="bbee" class="lf iy hi lw b fi mf mg l mh mi">gcloud services enable cloudfunctions.googleapis.com --async<br/>gcloud services enable cloudbuild.googleapis.com --async<br/>gcloud services enable bigqueryconnection.googleapis.com --async</span></pre><h1 id="4311" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated"><strong class="ak">第二步:编写功能代码</strong></h1><p id="676b" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">创建名为<code class="du lt lu lv lw b">function/</code>的文件夹。</p><p id="7900" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">在该文件夹中，使用您选择的编辑器，将以下云函数代码保存为<code class="du lt lu lv lw b">main.py</code>:</p><figure class="lx ly lz ma fd mj"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="276b" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">同样在这个文件夹中，用下面的命令添加一个需求文件:<code class="du lt lu lv lw b">echo functions-framework==3.2.0 &gt;&gt; requirements.txt</code></p><h1 id="4241" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated"><strong class="ak">第三步:将代码部署到云功能</strong></h1><p id="3dc4" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">使用以下命令部署云功能:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="c765" class="lf iy hi lw b fi mf mg l mh mi">gcloud functions deploy remote_hash \<br/>--runtime python310 \<br/>--trigger-http \<br/>--ingress-settings all \<br/>--source ./function/</span></pre><p id="e090" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">如果询问"<strong class="jr hj">允许新函数[remote_hash]的未认证调用吗？(是/否)？</strong>"，选择<strong class="jr hj"> N </strong></p><p id="739e" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">注意,<code class="du lt lu lv lw b">--ingress-settings</code>需要是<code class="du lt lu lv lw b">all</code>,因为否则来自BigQuery的远程函数调用将被阻塞。</p><h1 id="823e" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated"><strong class="ak">步骤4:创建示例BigQuery数据集和表</strong></h1><p id="eb61" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">在BigQuery中创建数据集和表:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="a9d4" class="lf iy hi lw b fi mf mg l mh mi">bq mk remote_functions_dataset<br/>bq mk --table remote_functions_dataset.remote_functions_table_native id:INTEGER,name:STRING</span></pre><p id="5b6f" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">填充表格:</p><figure class="lx ly lz ma fd mj"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="8da2" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">该表应该如下所示:</p><figure class="lx ly lz ma fd mj er es paragraph-image"><div class="er es mm"><img src="../Images/7a0ac388e6085beba96001eb904ed0f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:880/format:webp/1*4_DI3wvzlMNmM6UYzDx24A.png"/></div><figcaption class="mp mq et er es mr ms bd b be z dx translated">远程_函数_表_本机</figcaption></figure><h1 id="0967" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated"><strong class="ak">步骤5:创建BigQuery远程连接</strong></h1><p id="5ffd" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">创建BigQuery远程连接:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="f88a" class="lf iy hi lw b fi mf mg l mh mi">bq mk --connection \<br/>--display_name=’Connection to remote Cloud Function’ \<br/>--connection_type=CLOUD_RESOURCE \<br/>--project_id=bq-remote-functions \<br/>--location=US \<br/>remote-function-connection</span></pre><p id="136e" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">使用以下命令显示新创建的连接的详细信息:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="8374" class="lf iy hi lw b fi mf mg l mh mi">bq show --location=US --connection remote-function-connection</span></pre><p id="c44a" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">注意<code class="du lt lu lv lw b">properties</code>下的<code class="du lt lu lv lw b">serviceAccountID</code>。它应该是这样的:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="2ab4" class="lf iy hi lw b fi mf mg l mh mi">{“serviceAccountId”: “bqcx-012345678901-drct@gcp-sa-bigquery-condel.iam.gserviceaccount.com”}</span></pre><h1 id="4d69" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated"><strong class="ak">步骤6:向服务帐户添加角色</strong></h1><p id="f152" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">将invoker角色添加到上面显示在<code class="du lt lu lv lw b">serviceAccountID</code>下的服务协议中:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="e2f4" class="lf iy hi lw b fi mf mg l mh mi">gcloud projects add-iam-policy-binding bq-remote-functions \<br/>--member="serviceAccount:bqcx-012345678901-drct@gcp-sa-bigquery-condel.iam.gserviceaccount.com" \<br/>--role='roles/cloudfunctions.invoker'</span></pre><h1 id="cf32" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated"><strong class="ak">第七步:创建BigQuery远程函数</strong></h1><p id="5a29" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">使用<code class="du lt lu lv lw b">gcloud functions describe remote_hash</code>找到并记下云功能端点URL</p><p id="c573" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">在BQ中运行这个命令来创建远程函数:</p><figure class="lx ly lz ma fd mj"><div class="bz dy l di"><div class="mk ml l"/></div></figure><h1 id="2993" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated"><strong class="ak">步骤8:测试功能</strong></h1><p id="aed5" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">使用以下查询测试函数:</p><figure class="lx ly lz ma fd mj"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="a671" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">结果应该是这样的:</p><figure class="lx ly lz ma fd mj er es paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="er es mt"><img src="../Images/4153145ff940e2e832628bb7b0172e1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rkMmdqMuHVz4VBCcXsBGNQ.png"/></div></div><figcaption class="mp mq et er es mr ms bd b be z dx translated">带哈希的远程函数表本机</figcaption></figure><h1 id="c048" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated"><strong class="ak">结论</strong></h1><p id="d6b8" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">这是一个关于BigQuery远程函数的简单操作方法。远程函数是一种强大的方式，可以启用BigQuery固有功能之外的功能。</p><h2 id="00cb" class="lf iy hi bd iz lg lh li jd lj lk ll jh jy lm ln jj kc lo lp jl kg lq lr jn ls bi translated"><strong class="ak">参考资料和进一步阅读</strong></h2><p id="88cf" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">1.<a class="ae kl" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/remote-functions" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/reference/standard-SQL/remote-functions</a><br/>2 .<a class="ae kl" href="https://cloud.google.com/blog/products/data-analytics/extending-bigquery-functions" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/blog/products/data-analytics/extending-big query-functions</a></p><h2 id="f969" class="lf iy hi bd iz lg lh li jd lj lk ll jh jy lm ln jj kc lo lp jl kg lq lr jn ls bi translated"><strong class="ak">附录:请求/响应模式和结构</strong></h2><p id="95f5" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">对于此表:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="a6b8" class="lf iy hi lw b fi mf mg l mh mi">+------+-----+------+<br/>|  Row |  id | name |<br/>+------+-----+------+<br/>|    1 |  10 | John |<br/>|    2 | 333 | Luke |<br/>|    3 | 400 | Mike |<br/>+------+-----+------+</span></pre><p id="c431" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">在远程函数调用期间，发送到云函数的请求对象将如下所示，调用是一系列列表:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="0979" class="lf iy hi lw b fi mf mg l mh mi">{'requestId': '3b7456fd-22ed-4241-b444-00f98756cbe3',<br/>'caller': '//bigquery.googleapis.com/projects/bq-remote-functions/jobs/bquxjob_5ca2b63f_182cc1a93f8',<br/>'sessionUser': 'user@XXXXXXXXXXXXXX.com',<br/>'calls': [["John"], ["Luke"], ["Mike"]]}</span></pre><p id="e80e" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">响应对象的结构需要像这样，返回的数据是一个列表:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="be30" class="lf iy hi lw b fi mf mg l mh mi">{"replies": ["9db044f2b3b06c6f83e78b491cd6d65b38fa10d9fbb47abca9954ec9524b69fd47dfc327f6c73ef4ea8f53007e66d024",</span><span id="d985" class="lf iy hi lw b fi my mg l mh mi">"bec067cb433d75794150b9e52aef3ec2b59be0e8229e8d6c5aebdec05a1a628813790a206f4614a2ed281cd552aaab6c",</span><span id="6f17" class="lf iy hi lw b fi my mg l mh mi">"1b5621919d40b106be695c51d268aa4f168f1237edea9e8dba1bd63111f23236130661c173c925942ee2e5d5ff23f26d"]}</span></pre><p id="7941" class="pw-post-body-paragraph jp jq hi jr b js km ij ju jv kn im jx jy ko ka kb kc kp ke kf kg kq ki kj kk hb bi translated">注意，像这样构造的响应对象(列表的列表)将在BQ端导致一个<code class="du lt lu lv lw b">Failed to decode JSON to SQL type.</code>错误；您不能将列表列表作为函数的响应:</p><pre class="lx ly lz ma fd mb lw mc md aw me bi"><span id="4e01" class="lf iy hi lw b fi mf mg l mh mi">{"replies": [["9db044f2b3b06c6f83e78b491cd6d65b38fa10d9fbb47abca9954ec9524b69fd47dfc327f6c73ef4ea8f53007e66d024"],</span><span id="f7df" class="lf iy hi lw b fi my mg l mh mi">["bec067cb433d75794150b9e52aef3ec2b59be0e8229e8d6c5aebdec05a1a628813790a206f4614a2ed281cd552aaab6c"],</span><span id="3afe" class="lf iy hi lw b fi my mg l mh mi">["1b5621919d40b106be695c51d268aa4f168f1237edea9e8dba1bd63111f23236130661c173c925942ee2e5d5ff23f26d"]]}</span></pre></div></div>    
</body>
</html>