<html>
<head>
<title>Google Cloud Spanner with Entity Framework Core</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有实体框架核心的谷歌云扳手</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-spanner-with-entity-framework-core-2ddd16d2b252?source=collection_archive---------5-----------------------#2021-05-04">https://medium.com/google-cloud/google-cloud-spanner-with-entity-framework-core-2ddd16d2b252?source=collection_archive---------5-----------------------#2021-05-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0c48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/spanner" rel="noopener ugc nofollow" target="_blank"> Google Cloud Spanner </a>是一个全面管理、可扩展的关系数据库服务，用于区域和全球应用数据。它是第一个可扩展的、企业级的、全球分布的、高度一致的数据库服务，专为云构建，将关系数据库结构的优势与非关系水平扩展相结合。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/5ea3e6661905a239ecd25ee94bea5a27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*iNlSTFEy1xpftvwji_PIXA.png"/></div></figure><p id="7245" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://docs.microsoft.com/en-us/ef/core/" rel="noopener ugc nofollow" target="_blank">实体框架(EF)核心</a>是流行的实体框架数据访问技术的轻量级、可扩展、<a class="ae jd" href="https://github.com/dotnet/efcore" rel="noopener ugc nofollow" target="_blank">开源和跨平台版本。EF Core现在可以使用其</a><a class="ae jd" href="https://github.com/cloudspannerecosystem/dotnet-spanner-entity-framework" rel="noopener ugc nofollow" target="_blank">开源提供者</a>作为Google Cloud Spanner的对象关系映射器(O/RM)。本文将通过创建一个简单的控制台应用程序来帮助您开始使用用于Spanner的实体框架核心，该应用程序使用带有EF核心的Spanner。</p><h1 id="066f" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">创建项目并添加提供程序</h1><p id="19fb" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">本教程使用的示例项目的源代码可以在这里找到。</p><p id="4c5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先在Visual Studio中创建一个空的ConsoleApp。然后按照<a class="ae jd" href="https://github.com/cloudspannerecosystem/dotnet-spanner-entity-framework#create-and-publish-a-nuget-package-locally-using-visual-studio" rel="noopener ugc nofollow" target="_blank">自述文件</a>中的说明将Google Cloud Spanner的实体框架核心提供者添加到项目中。</p><h2 id="6366" class="kp jn hi bd jo kq kr ks js kt ku kv jw iq kw kx ka iu ky kz ke iy la lb ki lc bi translated">创建本地NuGet包</h2><p id="aed9" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">Google Cloud Spanner的实体框架核心提供者目前有<a class="ae jd" href="https://github.com/cloudspannerecosystem/dotnet-spanner-entity-framework#googlecloudentityframeworkcorespanner" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">预览版</strong> </a>发布状态，不具备生产级支持。</p><p id="44fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">提示:您也可以跳过下面的步骤，从GitHub中</strong> <a class="ae jd" href="https://github.com/cloudspannerecosystem/dotnet-spanner-entity-framework" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">克隆仓库</strong> </a> <strong class="ih hj">，并将实体框架核心项目作为项目引用添加到您的ConsoleApp中。</strong></p><ol class=""><li id="be6b" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated">将<a class="ae jd" href="https://github.com/cloudspannerecosystem/dotnet-spanner-entity-framework" rel="noopener ugc nofollow" target="_blank">dot net-spanner-entity-framework存储库</a>克隆到您的本地系统。</li><li id="0a0c" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">在Visual Studio中打开解决方案，右键单击Google。cloud . entityframeworkcore . spanner项目，然后单击Pack。这将生成一个项目的nuget本地包，您可以在ConsoleApp中使用它。</li><li id="8868" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated"><a class="ae jd" href="https://www.nuget.org/downloads" rel="noopener ugc nofollow" target="_blank">下载NuGet可执行文件</a>并复制到您的本地提要中(例如C:\local-nuget-feed)。</li><li id="3739" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">打开命令提示符并转到您的本地提要路径(例如C:\local-nuget-feed)。</li><li id="22de" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">运行下面的命令将包添加到您的本地nuget提要:<br/> <code class="du lr ls lt lu b">nuget add path\to\source\Google.Cloud.EntityFrameworkCore.Spanner\bin\Debug|Release\Google.Cloud.EntityFrameworkCore.Spanner.1.0.0-beta.nupkg -Source C:\local-nuget-feed</code></li><li id="2c00" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">返回Visual Studio，将您的本地提要添加为nuget的包源。为此，请单击“工具”|“获取包管理器”|“包管理器设置”(具体的菜单项可能会因您的Visual Studio版本而异)。选择包源，然后单击添加。选择您的本地nuget提要(例如C:\local-nuget-feed)并给它一个合理的名称。</li><li id="d394" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">通过单击工具| NuGet包管理器|管理解决方案的NuGet包，将包添加到ConsoleApp项目中。确保选择您的本地nuget feed作为包源，并启用<strong class="ih hj">包含预发布</strong>选项。选择谷歌。列表中的cloud . entityframeworkcore . spanner。</li></ol><h1 id="a6de" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">创建模型</h1><p id="2a1e" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">在实体框架中，使用模型访问数据。模型由实体类、实体的附加配置和表示数据库会话的上下文对象组成。本教程使用以下模型。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lv lw l"/></div><figcaption class="lx ly et er es lz ma bd b be z dx translated">实体框架核心的示例模型</figcaption></figure><p id="7620" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的示例模型包含三个实体；歌手，专辑和曲目。该模型还显示了在Spanner中创建彼此相关的实体时的两种可能性:</p><ul class=""><li id="53a6" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc mb lj lk ll bi translated">专辑引用歌手使用普通<a class="ae jd" href="https://cloud.google.com/spanner/docs/foreign-keys/overview" rel="noopener ugc nofollow" target="_blank">外键约束</a>。这将确保每个专辑引用一个现有的歌手记录，并且在没有删除该歌手的所有专辑的情况下，不能删除该歌手。</li><li id="92b1" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc mb lj lk ll bi translated">轨道通过在父实体专辑中<a class="ae jd" href="https://cloud.google.com/spanner/docs/schema-and-data-model#creating-interleaved-tables" rel="noopener ugc nofollow" target="_blank">交错引用专辑。这将确保所有曲目记录与父专辑一起物理存储。</a></li></ul><p id="bcf4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，对于两个特定实体之间的关系，您应该只从两个<strong class="ih hj">中选择一个</strong>，而不是两个。</p><h1 id="7bdb" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">数据模型</h1><p id="3e9d" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">下面列出了与该模型一起使用的相应数据模型。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lv lw l"/></div><figcaption class="lx ly et er es lz ma bd b be z dx translated">数据模型</figcaption></figure><p id="2ae6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以让Entity Framework使用迁移为您生成数据模型，或者让Entity Framework从现有数据库生成代码。参见<a class="ae jd" href="https://docs.microsoft.com/en-us/ef/core/managing-schemas/" rel="noopener ugc nofollow" target="_blank">管理模式</a>了解更多信息。为了使事情尽可能简单，本教程手动创建两者。</p><h1 id="366a" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">插入数据</h1><p id="3e6e" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">我们在模型中定义的context类为我们定义的每个实体包含一个<code class="du lr ls lt lu b">DbSet</code>。将数据插入数据库非常简单:</p><ol class=""><li id="8e8d" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated">创建将连接到数据库的上下文。</li><li id="d984" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">向集合中添加新实体。</li><li id="bbfc" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">对上下文调用SaveChanges。</li></ol><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lv lw l"/></div><figcaption class="lx ly et er es lz ma bd b be z dx translated">使用实体框架核心插入数据</figcaption></figure><h1 id="6a0c" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">查询数据</h1><p id="6a95" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">我们还使用<code class="du lr ls lt lu b">DbSet</code>从数据库中查询数据。您可以通过指定实体的键从集合中获取单个实体，也可以使用LINQ查询实体集合。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lv lw l"/></div><figcaption class="lx ly et er es lz ma bd b be z dx translated">使用实体框架核心查询数据</figcaption></figure><h1 id="ba06" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">更多样本</h1><p id="56b2" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">Cloud Spanner实体框架核心提供者库<a class="ae jd" href="https://github.com/cloudspannerecosystem/dotnet-spanner-entity-framework/tree/master/Google.Cloud.EntityFrameworkCore.Spanner.Samples" rel="noopener ugc nofollow" target="_blank">包含几个额外的示例</a>，用于结合Cloud Spanner的实体框架的特定特性。其中包括:</p><ul class=""><li id="70cb" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc mb lj lk ll bi translated"><a class="ae jd" href="https://github.com/cloudspannerecosystem/dotnet-spanner-entity-framework/blob/master/Google.Cloud.EntityFrameworkCore.Spanner.Samples/Snippets/TransactionSample.cs" rel="noopener ugc nofollow" target="_blank">手动读/写交易</a></li><li id="41af" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc mb lj lk ll bi translated"><a class="ae jd" href="https://github.com/cloudspannerecosystem/dotnet-spanner-entity-framework/blob/master/Google.Cloud.EntityFrameworkCore.Spanner.Samples/Snippets/ReadOnlyTransactionSample.cs" rel="noopener ugc nofollow" target="_blank">只读交易</a></li><li id="5188" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc mb lj lk ll bi translated"><a class="ae jd" href="https://github.com/cloudspannerecosystem/dotnet-spanner-entity-framework/blob/master/Google.Cloud.EntityFrameworkCore.Spanner.Samples/Snippets/ConcurrencyTokenSample.cs" rel="noopener ugc nofollow" target="_blank">使用云扳手在实体框架核心中使用并发令牌</a></li><li id="a071" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc mb lj lk ll bi translated"><a class="ae jd" href="https://github.com/cloudspannerecosystem/dotnet-spanner-entity-framework/blob/master/Google.Cloud.EntityFrameworkCore.Spanner.Samples/Snippets/CommitTimestampSample.cs" rel="noopener ugc nofollow" target="_blank">保存实体时自动写入提交时间戳</a></li><li id="c52c" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc mb lj lk ll bi translated"><a class="ae jd" href="https://github.com/cloudspannerecosystem/dotnet-spanner-entity-framework/blob/master/Google.Cloud.EntityFrameworkCore.Spanner.Samples/Snippets/ArraysSample.cs" rel="noopener ugc nofollow" target="_blank">使用数组数据类型</a></li></ul><p id="b3ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请查看存储库中的完整列表。</p><h1 id="85b8" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">可运行代码</h1><p id="decf" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">基于本教程的完整示例项目可以在这里找到。这是一个可运行的应用程序，不需要谷歌云扳手数据库，因为它使用云扳手模拟器。可以在这里找到:<a class="ae jd" href="https://github.com/olavloite/spanner-efcore-tutorial" rel="noopener ugc nofollow" target="_blank">https://github.com/olavloite/spanner-efcore-tutorial</a></p></div></div>    
</body>
</html>