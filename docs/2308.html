<html>
<head>
<title>Building and Deploying Containerized Application to Kubernetes using Jib and Skaffold</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Jib和Skaffold在Kubernetes上构建和部署容器化的应用程序</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/building-and-deploying-containerized-application-to-kubernetes-using-jib-and-skaffold-80305363a8fd?source=collection_archive---------0-----------------------#2022-08-18">https://medium.com/google-cloud/building-and-deploying-containerized-application-to-kubernetes-using-jib-and-skaffold-80305363a8fd?source=collection_archive---------0-----------------------#2022-08-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="ea76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Jib允许Java/Kotlin开发人员通过在构建脚本上添加插件，使用他们选择的工具(如Maven或Gradle)来集成容器化步骤。Jib基本上处理将应用程序打包到Dockerimage中的所有步骤，而不使用Dockerfile🎉。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/7e03889dd0d8e2bb8f32a22481b541a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3yBJbDkCPwzdZz-G.png"/></div></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jp"><img src="../Images/48b91809003fddca2ee8c990578765ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HSg9VmfYq1UJTDMW.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">上图:Docker工作流程。下图:Jib工作流程[1]</figcaption></figure><p id="e3f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么Jib到底是怎么做的呢？</p><p id="e8d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Jib创建了一组文件系统层，其中包含Java运行时、应用程序及其所有依赖项，以及容器引擎用来了解如何启动Java虚拟机(JVM)的元数据。当使用Jib构建容器时，我们可以看到下面的层:</p><ul class=""><li id="2f1a" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">构建脚本中定义的库依赖项(mvn或gradle)。该层包含将所有的<code class="du kd ke kf kg b">.jar</code>文件添加到<code class="du kd ke kf kg b">/app/libs</code>文件夹。</li><li id="73c7" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">资源文件。我们可以从资源文件夹中看到<code class="du kd ke kf kg b">/app/resources</code>和所有相关的文件。</li><li id="bb72" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">编译后的应用程序代码中的类文件。来自编译阶段的<code class="du kd ke kf kg b">.class</code>文件位于<code class="du kd ke kf kg b">/app/classes</code>下的这一层。</li><li id="b1e2" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">Java JVM参数文件。</li></ul><p id="3483" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">取决于你如何定制你的构建文件，Jib生成的库也可以有其他层，见<a class="ae km" href="https://github.com/GoogleContainerTools/jib/blob/master/docs/faq.md#how-are-jib-applications-layered" rel="noopener ugc nofollow" target="_blank"> Jib常见问题</a>。</p><p id="6e6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我想分享我们如何使用Dropwizard、Gradle、Jib和Skaffold创建Java应用程序。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kn"><img src="../Images/6339fa34ecbc43b22bc5b779cbd37f75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HkgcBCxB4qv8UyA1TWEmPA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">项目的目录设置。</figcaption></figure><p id="0361" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于这个项目，我们将在工件部分定义构建图像所需的所有配置。除此之外，skaffold还支持许多您可以使用标记机制，例如我们将在示例中使用的INPUT_DIGEST。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ko"><img src="../Images/0725b092ff71ffd6ab046e59e593f09a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CqepOQRXNP_tosYmNT0lAQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">部署的Skaffold配置。</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kp"><img src="../Images/e9da75c6c6b458723dd775b6f8f24b01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GMaSwZcO8kUYOxbJF5wqAA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">build.gradle脚本的内容。当我们仔细查看它时，我们会注意到它实际上与docker文件中需要编写的所有内容非常相似。</figcaption></figure><p id="4b2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，为了能够将图像推送到注册表，我们可以使用一个助手方法，如<a class="ae km" href="https://github.com/GoogleContainerTools/jib/blob/master/docs/faq.md" rel="noopener ugc nofollow" target="_blank"> Jib常见问题解答中所述。</a>默认情况下，Jib会查看以下位置，以在将映像推入容器注册表之前查看可用的凭据:</p><ul class=""><li id="2d19" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">Docker凭证文件(由docker登录或podman登录生成),位于:</li></ul><pre class="je jf jg jh fd kq kg kr ks aw kt bi"><span id="c935" class="ku kv hi kg b fi kw kx l ky kz">$XDG_RUNTIME_DIR/containers/auth.json, $XDG_CONFIG_HOME/containers/auth.json or $HOME/.config/containers/auth.json</span><span id="bcd1" class="ku kv hi kg b fi la kx l ky kz">$DOCKER_CONFIG/config.json</span><span id="ab56" class="ku kv hi kg b fi la kx l ky kz">$HOME/.docker/config.json.</span></pre><p id="290c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是docker或podman命令行工具的配置文件之一。有关如何配置auth，请参见配置文件文档、凭据存储和凭据帮助器部分。例如，您可以进行docker登录以在config.json中保存auth，但是通常建议配置一个凭据帮助器(也可以在config.json中配置)。</p><p id="7605" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果Jib能够从Docker凭证文件中检索auth信息，您应该会看到类似于使用Docker配置中的凭证(/home/myuser/)的日志消息。docker/config.json)，您可以在这里验证Jib选择了哪个凭证文件。</p><ul class=""><li id="112a" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">悬臂配置</li></ul><pre class="je jf jg jh fd kq kg kr ks aw kt bi"><span id="ad42" class="ku kv hi kg b fi kw kx l ky kz">Configuring credential helpers: &lt;from/to&gt;&lt;credHelper&gt; (Maven) / from/to.credHelper (Gradle)<br/> Specific credentials (not recommend): &lt;from/to&gt;&lt;auth&gt;&lt;username&gt;/&lt;password&gt; or in settings.xml (Maven) / from/to.auth.username/password (Gradle)<br/> These parameters can also be set through properties: Maven / Gradle</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lb"><img src="../Images/d4c0d87c8e9c0215bde4fbdd9bed5d1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K2s7ZVHYnhL5KTmnSXILCg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">在skaffold.yaml上定义我们想要部署清单的k8s上下文</figcaption></figure><p id="92a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在开发我们的应用程序时，我们也可以运行下面的命令来测试是否使用Skaffold正确地进行了更改</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lc"><img src="../Images/50758a00eaf02674eac52ea3bafe5877.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EaAGrl9P_OzU1LyLr8jr6Q.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">使用端口转发运行清单</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ld"><img src="../Images/50a87becb18e1025fccbd7ed8f05d4ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iTJF0p1kLkMGBCOzkuftRA.png"/></div></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es le"><img src="../Images/fe1a89809079dd4b3650a05697a24294.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_02UwtSkOsX0v7uHJWsdiA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">斯卡福德建筑</figcaption></figure><p id="b449" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用skaffold，我们还可以为我们拥有的每个环境定义不同的构建步骤。例如，对于开发和生产环境，我们有不同的清单，我们可以将其定义如下:</p><pre class="je jf jg jh fd kq kg kr ks aw kt bi"><span id="21ad" class="ku kv hi kg b fi kw kx l ky kz">deploy:<br/>  kubeContext: kind-kubernetes-days-id-demo<br/>  kustomize:<br/>    paths: [ "kubernetes/dev" ]<br/>profiles:<br/>  - name: prod<br/>    deploy:<br/>      kustomize:<br/>        paths: [ "kubernetes/prod" ]<br/>    patches:<br/>      - op: replace<br/>        path: /build/tagPolicy<br/>        value:<br/>          inputDigest: { }<br/>      - op: remove<br/>        path: /build/artifacts/0/hooks</span></pre><p id="e786" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考资料:</p><p id="5975" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[1]谷歌。(未注明)。<em class="lf">用jib | google cloud </em>构建java容器。谷歌。检索于2022年8月18日，发自https://cloud.google.com/java/getting-started/jib<a class="ae km" href="https://cloud.google.com/java/getting-started/jib" rel="noopener ugc nofollow" target="_blank"/></p><p id="fcbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[2] <em class="lf">建筑与设计</em>。斯卡福德。(未注明)。于2022年8月18日从<a class="ae km" href="https://skaffold.dev/docs/design/" rel="noopener ugc nofollow" target="_blank">https://skaffold.dev/docs/design/</a>检索</p><p id="93be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[3]谷歌。(未注明)。<em class="lf">介绍jib —更好地构建Java Docker映像|谷歌云博客</em>。谷歌。2022年8月18日检索，来自<a class="ae km" href="https://cloud.google.com/blog/products/application-development/introducing-jib-build-java-docker-images-better" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/blog/products/application-development/introducing-jib-build-Java-docker-images-better</a></p></div></div>    
</body>
</html>