<html>
<head>
<title>A way to generate sample dataset in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一种在BigQuery中生成样本数据集的方法</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/a-way-to-generate-sample-test-dataset-in-bigquery-6e28fff9625c?source=collection_archive---------1-----------------------#2022-01-10">https://medium.com/google-cloud/a-way-to-generate-sample-test-dataset-in-bigquery-6e28fff9625c?source=collection_archive---------1-----------------------#2022-01-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="9142" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">你需要用一组随机的数字、日期来填充BigQuery表吗？酷继续..</p></blockquote><p id="2131" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">BigQuery有一个很酷的Generate_Array函数，它获取范围边界作为输入，并生成一个数组(嵌套字段)。Generate_date_array相当于生成日期数组。</p><p id="3aaf" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">Unnest函数可用于将数组项分解成单独行。在这篇博文中，我们将依靠这些函数来生成int和date值。</p><p id="73f4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">为了获得一些随机的字符串值，我们将受益于散列函数，如MD5()和RAND()函数。</p><h1 id="4d73" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">首先是生成int或date值的一些基础知识</h1><p id="3d8f" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it jh kk iw ix ji kl ja jb jj km je jf jg hb bi translated">获取连续的1000个整数:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="4efa" class="kw jl hi ks b fi kx ky l kz la">SELECT id FROM UNNEST(GENERATE_ARRAY(1, 1000)) id;</span><span id="5ab7" class="kw jl hi ks b fi lb ky l kz la">--You can fill a table with one int column using insert/select statements like;</span><span id="f3b5" class="kw jl hi ks b fi lb ky l kz la">insert into `project_id`.dataset_name.table_name <br/>SELECT id FROM UNNEST(GENERATE_ARRAY(1, 1000)) id;</span></pre><p id="6f11" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">获取有间隔的连续日期。ex；开始日期为2021年1月1日，结束日期为2022年1月8日，两个值之间相差10天:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="01fe" class="kw jl hi ks b fi kx ky l kz la">SELECT date FROM UNNEST(GENERATE_DATE_ARRAY(‘2021–01–01’, ‘2022–01–08’, INTERVAL 10 DAY)) date</span><span id="4dc4" class="kw jl hi ks b fi lb ky l kz la">--You can fill a table with only one date column using insert/select statements like;</span><span id="d1ae" class="kw jl hi ks b fi lb ky l kz la">insert into `project_id`.dataset_name.table_name <br/>SELECT date FROM UNNEST(GENERATE_DATE_ARRAY(‘2021–01–01’, ‘2022–01–08’, INTERVAL 10 DAY)) date;</span></pre><h1 id="e94b" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">生成具有唯一id和随机日期的多个值</h1><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="5fdb" class="kw jl hi ks b fi kx ky l kz la">WITH parameters AS (<br/>SELECT 10000 customer_id, DATE ‘2010–01–01’ start_date, DATE ‘2020–12–31’ finish_date<br/>)</span><span id="1d7d" class="kw jl hi ks b fi lb ky l kz la">SELECT <br/>  customer_id, <br/>  DATE_FROM_UNIX_DATE(CAST(start + (finish — start) * RAND() AS INT64)) random_date<br/>FROM parameters,<br/>UNNEST(GENERATE_ARRAY(1, customer_id)) customer_id,<br/>UNNEST([STRUCT(UNIX_DATE(start_date) AS start, UNIX_DATE(finish_date) AS finish)])</span></pre><figure class="kn ko kp kq fd ld er es paragraph-image"><div class="er es lc"><img src="../Images/faf6d50073ac147949cc02b850755c6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:780/format:webp/1*eQejCu0Utnd_UhiEW4JBkg.png"/></div></figure><h1 id="5afb" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">还可以放一些附加栏目吗？</h1><p id="8084" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it jh kk iw ix ji kl ja jb jj km je jf jg hb bi translated">添加一个额外的整数列，例如价格:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="f6a9" class="kw jl hi ks b fi kx ky l kz la">WITH parameters AS (</span><span id="2ce0" class="kw jl hi ks b fi lb ky l kz la">SELECT 10000 customer_id, DATE ‘2010-01–01’ start_date, DATE ‘2020–12–31’ finish_date</span><span id="463e" class="kw jl hi ks b fi lb ky l kz la">)</span><span id="9dfa" class="kw jl hi ks b fi lb ky l kz la">SELECT customer_id, DATE_FROM_UNIX_DATE(CAST(start + (finish — start) * RAND() AS INT64)) random_date, <strong class="ks hj">CAST(10000*RAND() AS INT64) price</strong></span><span id="2e94" class="kw jl hi ks b fi lb ky l kz la">FROM parameters,</span><span id="12c0" class="kw jl hi ks b fi lb ky l kz la">UNNEST(GENERATE_ARRAY(1, customer_id)) customer_id,</span><span id="ef75" class="kw jl hi ks b fi lb ky l kz la">UNNEST([STRUCT(UNIX_DATE(start_date) AS start, UNIX_DATE(finish_date) AS finish)])</span><span id="e159" class="kw jl hi ks b fi lb ky l kz la">--Note Medium blog converts '-' characters into a different ascii char. If you copy paste this please replace '-' with minus char in the date values manually.</span></pre><figure class="kn ko kp kq fd ld er es paragraph-image"><div class="er es lg"><img src="../Images/51c85e64e77906a80f1ec66a025959ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:912/format:webp/1*1WzE_eqZ_60wo2Tqlhbp3A.png"/></div></figure><p id="80ff" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">添加一个额外的字符串列，例如customer_id:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="1402" class="kw jl hi ks b fi kx ky l kz la">-- inserting into table which has 2 columns; an int and a string column;</span><span id="cb9f" class="kw jl hi ks b fi lb ky l kz la">insert into `project_id`.dataset_name.table_name SELECT id, TO_BASE64 (MD5(cast (RAND() as string))) FROM UNNEST(GENERATE_ARRAY(1, 1000)) id</span></pre><h2 id="06ad" class="kw jl hi bd jm lh li lj jq lk ll lm ju jh ln lo jy ji lp lq kc jj lr ls kg lt bi translated">为每个唯一id生成多行</h2><p id="d58b" class="pw-post-body-paragraph ii ij hi il b im ki io ip iq kj is it jh kk iw ix ji kl ja jb jj km je jf jg hb bi translated">假设这是一个订单表，每个客户都有多个订单。需要每个客户有不同的订单计数。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="de36" class="kw jl hi ks b fi kx ky l kz la">WITH parameters AS (</span><span id="ccb1" class="kw jl hi ks b fi lb ky l kz la">SELECT <strong class="ks hj">1000</strong> row_count,DATE ‘2010–01–01’ start_date, DATE ‘2020–12–31’ finish_date</span><span id="9122" class="kw jl hi ks b fi lb ky l kz la">)</span><span id="e6ea" class="kw jl hi ks b fi lb ky l kz la">select CAST(<strong class="ks hj">500</strong>*RAND() AS INT64) customer_id, DATE_FROM_UNIX_DATE(CAST(start + (finish — start) * RAND() AS INT64)) order_date, CAST(10000*RAND() AS INT64) price from parameters,</span><span id="8ba7" class="kw jl hi ks b fi lb ky l kz la">UNNEST(GENERATE_ARRAY(1, row_count)) row_count,</span><span id="3a79" class="kw jl hi ks b fi lb ky l kz la">UNNEST([STRUCT(UNIX_DATE(start_date) AS start, UNIX_DATE(finish_date) AS finish)])</span></pre><p id="8e0a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">这里，只需将行数除以期望的客户数，即可得到平均订单数:</p><figure class="kn ko kp kq fd ld er es paragraph-image"><div class="er es lu"><img src="../Images/2a34404da34fb6031d24b72c9344d1fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/format:webp/1*GODhI2Mh0mieVYwltAFobQ.png"/></div></figure><p id="dcec" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">你需要不同价值观的组合吗？</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="f163" class="kw jl hi ks b fi kx ky l kz la">select order_id, date, price from</span><span id="7e50" class="kw jl hi ks b fi lb ky l kz la">(SELECT order_id FROM UNNEST(GENERATE_ARRAY(1, 3)) order_id) order_id,</span><span id="9b05" class="kw jl hi ks b fi lb ky l kz la">(SELECT date FROM UNNEST(GENERATE_DATE_ARRAY(‘2021–01–01’, ‘2022–01–08’, INTERVAL 100 DAY)) date) date,</span><span id="a6bf" class="kw jl hi ks b fi lb ky l kz la">(SELECT price FROM UNNEST(GENERATE_ARRAY(100, 103)) price) price</span></pre><p id="38c8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">好吧，这些都很酷，但我需要一些每行的逻辑。</p><p id="9b3d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">脚本/存储过程？</p><p id="1dd9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">好的，在这里，记住BigQuery是分析查询引擎，它喜欢处理集合中的数据，而不是行中的数据。所以，如果你想用一个循环产生10秒或100秒的记录，这可能是可以的，但这远远不是最佳的，但以防万一，如果你需要一个存储过程/脚本来生成一些行，这里放入:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="7c9c" class="kw jl hi ks b fi kx ky l kz la">DECLARE id STRING;<br/>DECLARE d DATE DEFAULT CURRENT_DATE();<br/>DECLARE x INT64 DEFAULT 0;<br/>DECLARE datesub INT64 DEFAULT 0;</span><span id="f104" class="kw jl hi ks b fi lb ky l kz la">LOOP<br/>SET x = x +1;<br/>IF x&gt;=100 THEN<br/>LEAVE;<br/>END IF;</span><span id="f6b8" class="kw jl hi ks b fi lb ky l kz la">SET id = CAST(CAST(10000*RAND() AS INT64) AS STRING);<br/>SET datesub = CAST(10000*RAND() AS INT64);</span><span id="6628" class="kw jl hi ks b fi lb ky l kz la">INSERT INTO xxx.orders (customer_id, order_date, price) VALUES(id, DATE_SUB(D, INTERVAL datesub DAY), datesub);</span><span id="c9fe" class="kw jl hi ks b fi lb ky l kz la">SELECT FORMAT(“Created customer %s”, id);</span><span id="10cf" class="kw jl hi ks b fi lb ky l kz la">END LOOP;</span></pre><p id="19dc" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">这些选项看起来怎么样？你有更好的选择吗？请在下面评论一下👇</p></div></div>    
</body>
</html>