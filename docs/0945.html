<html>
<head>
<title>Kubernetes autoscaling with Istio metrics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes使用Istio指标自动缩放</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/kubernetes-autoscaling-with-istio-metrics-76442253a45a?source=collection_archive---------0-----------------------#2019-03-06">https://medium.com/google-cloud/kubernetes-autoscaling-with-istio-metrics-76442253a45a?source=collection_archive---------0-----------------------#2019-03-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c938" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">自动扩展是一种根据资源使用情况自动扩大或缩小工作负载的方法。Kubernetes中的自动缩放有两个维度:处理节点缩放操作的集群自动缩放器和自动缩放部署中单元数量的水平单元自动缩放器。</p><p id="1c58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，水平窗格自动缩放器(HPA)可以根据观察到的CPU利用率和内存使用情况来缩放窗格。从Kubernetes 1.7开始，引入了一个聚合层，允许第三方应用程序通过将自己注册为API附加组件来扩展Kubernetes API。这种附加组件可以实现自定义指标API，并支持HPA访问任意指标。</p><p id="61a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用像Istio这样的服务网格的优势之一是内置的监控功能。您不必为了监控L7流量而使用您的web应用程序。Istio遥测服务从与您的应用程序一起运行的Envoy sidecars中收集统计数据，如HTTP请求率、响应状态代码和响应持续时间。除了监控，这些指标还可用于推动自动扩展和<a class="ae jd" href="https://github.com/stefanprodan/flagger" rel="noopener ugc nofollow" target="_blank">金丝雀部署</a>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/74b7d0f4dc5f45548fff55c065727577.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k4HAIs-KaGkjkZeXv0H2dQ.png"/></div></div></figure><p id="551a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是使用Istio Mixer提供的指标配置HPA v2的分步指南。安装Istio时，确保遥测服务和Prometheus已启用。如果你使用的是GKE Istio插件，你必须按照这里描述的<a class="ae jd" href="https://docs.flagger.app/install/flagger-install-on-google-cloud#install-prometheus" rel="noopener ugc nofollow" target="_blank">部署Prometheus</a>。</p><p id="2baf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了将Istio metrics与水平Pod自动缩放器一起使用，您需要一个可以运行Prometheus查询的适配器。Zalando为Kubernetes制作了一个通用指标适配器，名为<a class="ae jd" href="https://github.com/zalando-incubator/kube-metrics-adapter" rel="noopener ugc nofollow" target="_blank"> kube-metrics-adapter </a>。Zalando适配器扫描HPA对象，执行promql查询(用注释指定)并将指标存储在内存中。</p><h1 id="5f51" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">安装自定义指标适配器</h1><p id="3035" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">克隆<a class="ae jd" href="https://github.com/stefanprodan/istio-hpa" rel="noopener ugc nofollow" target="_blank"> istio-hpa </a>存储库:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="be14" class="ky jr hi ku b fi kz la l lb lc">git clone <a class="ae jd" href="https://github.com/stefanprodan/istio-hpa" rel="noopener ugc nofollow" target="_blank">https://github.com/stefanprodan/istio-hpa</a><br/>cd istio-hpa</span></pre><p id="cd2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du ld le lf ku b">kube-system</code>名称空间中部署度量适配器:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="3497" class="ky jr hi ku b fi kz la l lb lc">kubectl apply -f ./kube-metrics-adapter/</span></pre><p id="02eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当适配器启动时，它将生成一个自签名证书，并将自己注册到<code class="du ld le lf ku b">custom.metrics.k8s.io</code>组下。</p><p id="da8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该适配器被配置为查询在<code class="du ld le lf ku b">istio-system</code>名称空间中运行的Prometheus实例。</p><p id="cf58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过检查适配器日志来验证安装:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="b7d7" class="ky jr hi ku b fi kz la l lb lc">kubectl -n kube-system logs deployment/kube-metrics-adapter</span></pre><h1 id="b766" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">安装演示应用程序</h1><p id="d69c" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">您将使用一个基于Golang的小型web应用程序<a class="ae jd" href="https://github.com/stefanprodan/k8s-podinfo" rel="noopener ugc nofollow" target="_blank"> podinfo </a>来测试水平吊舱自动缩放器。</p><p id="838e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先创建一个启用了Istio sidecar注入的<code class="du ld le lf ku b">test</code>名称空间:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="a882" class="ky jr hi ku b fi kz la l lb lc">kubectl apply -f ./namespaces/</span></pre><p id="6b28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du ld le lf ku b">test</code>名称空间中创建podinfo部署和ClusterIP服务:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="e737" class="ky jr hi ku b fi kz la l lb lc">kubectl apply -f ./podinfo/deployment.yaml,./podinfo/service.yaml</span></pre><p id="83a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了触发自动缩放，您需要一个工具来生成流量。在<code class="du ld le lf ku b">test</code>名称空间中部署负载测试服务:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="770f" class="ky jr hi ku b fi kz la l lb lc">kubectl apply -f ./loadtester/</span></pre><p id="f725" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过调用podinfo API来验证安装。Exec进入负载测试器pod，并使用<code class="du ld le lf ku b">hey</code>生成几秒钟的负载:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="4d2c" class="ky jr hi ku b fi kz la l lb lc">export loadtester=$(kubectl -n test get pod -l "app=loadtester" -o jsonpath='{.items[0].metadata.name}')</span><span id="9a76" class="ky jr hi ku b fi lg la l lb lc">kubectl -n test exec -it ${loadtester} -- sh</span><span id="b12e" class="ky jr hi ku b fi lg la l lb lc">~ $ hey -z 5s -c 10 -q 2 <a class="ae jd" href="http://podinfo.test:9898" rel="noopener ugc nofollow" target="_blank">http://podinfo.test:9898</a></span><span id="0b43" class="ky jr hi ku b fi lg la l lb lc">Summary:<br/>  Total:	5.0138 secs<br/>  Requests/sec:	19.9451</span><span id="4c75" class="ky jr hi ku b fi lg la l lb lc">Status code distribution:<br/>  [200]	100 responses</span></pre><p id="7523" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">podinfo <a class="ae jd" href="https://github.com/stefanprodan/istio-hpa/blob/master/podinfo/service.yaml" rel="noopener ugc nofollow" target="_blank"> ClusterIP服务</a>在<code class="du ld le lf ku b">http</code>名称下公开端口9898。当使用http前缀时，特使边车将切换到L7路由，遥测服务将收集HTTP度量。</p><h1 id="83a0" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">查询Istio指标</h1><p id="ef54" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">Istio遥测服务从网格中收集指标，并将其存储在Prometheus中。一个这样的指标是<code class="du ld le lf ku b">istio_requests_total</code>，使用它您可以确定工作负载每秒接收的请求率。</p><p id="2fb4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过这种方式向Prometheus查询podinfo在最后一分钟收到的请求/秒速率，不包括404秒:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="231a" class="ky jr hi ku b fi kz la l lb lc">sum(<br/>    rate(<br/>      istio_requests_total{<br/>        destination_workload="podinfo",<br/>        destination_workload_namespace="test",<br/>        reporter="destination",<br/>        response_code!="404"<br/>      }[1m]<br/>    )<br/>  )</span></pre><p id="0546" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">HPA需要知道每个pod接收的请求/秒。您可以使用kubelet中的容器内存使用度量来计算pod的数量，并计算每个pod的Istio请求率:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="a7a7" class="ky jr hi ku b fi kz la l lb lc">sum(<br/>    rate(<br/>      istio_requests_total{<br/>        destination_workload="podinfo",<br/>        destination_workload_namespace="test"<br/>      }[1m]<br/>    )<br/>  ) /<br/>  count(<br/>    count(<br/>      container_memory_usage_bytes{<br/>        namespace="test",<br/>        pod_name=~"podinfo.*"<br/>      }<br/>    ) by (pod_name)<br/>  )</span></pre><h1 id="0500" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">使用Istio指标配置HPA</h1><p id="bca3" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">使用req/sec查询，您可以定义一个HPA，它将根据每个实例每秒接收的请求数来扩展podinfo工作负载:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="d01a" class="ky jr hi ku b fi kz la l lb lc"><strong class="ku hj">apiVersion</strong>: autoscaling/v2beta1<br/><strong class="ku hj">kind</strong>: HorizontalPodAutoscaler<br/><strong class="ku hj">metadata</strong>:<br/>  <strong class="ku hj">name</strong>: podinfo<br/>  <strong class="ku hj">namespace</strong>: test<br/>  <strong class="ku hj">annotations</strong>:<br/>    <strong class="ku hj">metric-config.object.istio-requests-total.prometheus/per-replica</strong>: "true"<br/>    <strong class="ku hj">metric-config.object.istio-requests-total.prometheus/query</strong>: |<br/>      sum(<br/>        rate(<br/>          istio_requests_total{<br/>            destination_workload="podinfo",<br/>            destination_workload_namespace="test"<br/>          }[1m]<br/>        )<br/>      ) /<br/>      count(<br/>        count(<br/>          container_memory_usage_bytes{<br/>            namespace="test",<br/>            pod_name=~"podinfo.*"<br/>          }<br/>        ) by (pod_name)<br/>      )<br/><strong class="ku hj">spec</strong>:<br/>  <strong class="ku hj">maxReplicas</strong>: 10<br/>  <strong class="ku hj">minReplicas</strong>: 1<br/>  <strong class="ku hj">scaleTargetRef</strong>:<br/>    <strong class="ku hj">apiVersion</strong>: apps/v1<br/>    <strong class="ku hj">kind</strong>: Deployment<br/>    <strong class="ku hj">name</strong>: podinfo<br/>  <strong class="ku hj">metrics</strong>:<br/>    - <strong class="ku hj">type</strong>: Object<br/>      <strong class="ku hj">object</strong>:<br/>        <strong class="ku hj">metricName</strong>: istio-requests-total<br/>        <strong class="ku hj">target</strong>:<br/>          <strong class="ku hj">apiVersion</strong>: v1<br/>          <strong class="ku hj">kind</strong>: Pod<br/>          <strong class="ku hj">name</strong>: podinfo<br/>        <strong class="ku hj">targetValue</strong>: 10</span></pre><p id="a6d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当每个副本的平均流量负载超过10 req/sec时，上述配置将指示水平Pod自动缩放器扩展部署。</p><p id="4bd0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下内容创建HPA:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="529a" class="ky jr hi ku b fi kz la l lb lc">kubectl apply -f ./podinfo/hpa.yaml</span></pre><p id="92f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启动负载测试，并验证适配器是否计算了指标:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="1156" class="ky jr hi ku b fi kz la l lb lc">kubectl -n kube-system logs deployment/kube-metrics-adapter -f</span><span id="a160" class="ky jr hi ku b fi lg la l lb lc">Collected 1 new metric(s)<br/>Collected new custom metric 'istio-requests-total' (44m) for Pod test/podinfo</span></pre><p id="c942" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">列出自定义指标资源:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="e82d" class="ky jr hi ku b fi kz la l lb lc">kubectl get --raw "/apis/custom.metrics.k8s.io/v1beta1" | jq .</span></pre><p id="4935" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Kubernetes API应该返回一个包含Istio指标的资源列表:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="04fe" class="ky jr hi ku b fi kz la l lb lc">{<br/>  "kind": "APIResourceList",<br/>  "apiVersion": "v1",<br/>  "groupVersion": "custom.metrics.k8s.io/v1beta1",<br/>  "resources": [<br/>    {<br/>      "name": "<strong class="ku hj">pods/istio-requests-total</strong>",<br/>      "singularName": "",<br/>      "namespaced": true,<br/>      "kind": "MetricValueList",<br/>      "verbs": [<br/>        "get"<br/>      ]<br/>    }<br/>  ]<br/>}</span></pre><p id="2d32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几秒钟后，HPA将从适配器获取指标:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="7357" class="ky jr hi ku b fi kz la l lb lc">kubectl -n test get hpa/podinfo</span><span id="a19f" class="ky jr hi ku b fi lg la l lb lc">REFERENCE            TARGETS   MINPODS   MAXPODS   REPLICAS<br/>Deployment/podinfo   44m/10    1         10        1</span></pre><h1 id="82f1" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">基于HTTP流量的自动缩放</h1><p id="d4e3" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">为了测试HPA，您可以使用负载测试器来触发一个向上扩展事件。</p><p id="5eaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">进入测试舱，使用<code class="du ld le lf ku b">hey</code>产生几分钟的负载:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="03f6" class="ky jr hi ku b fi kz la l lb lc">kubectl -n test exec -it ${loadtester} -- sh</span><span id="9281" class="ky jr hi ku b fi lg la l lb lc">~ $ hey -z 5m -c 10 -q 2 <a class="ae jd" href="http://podinfo.test:9898" rel="noopener ugc nofollow" target="_blank">http://podinfo.test:9898</a></span></pre><p id="ff41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一分钟后，HPA将开始扩大工作负载，直到每个pod的请求/秒降至目标值以下:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="7e56" class="ky jr hi ku b fi kz la l lb lc">watch kubectl -n test get hpa/podinfo</span><span id="2e83" class="ky jr hi ku b fi lg la l lb lc">REFERENCE            TARGETS     MINPODS   MAXPODS   REPLICAS<br/>Deployment/podinfo   25272m/10   1         10        3</span></pre><p id="1ca9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当负载测试完成时，每秒的请求数将降至零，HPA将开始缩减工作负载。请注意，HPA有一个回退机制，可防止快速扩大/缩小事件，几分钟后复制副本的数量将恢复为一个。</p><p id="9b0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，指标同步每30秒发生一次，只有在过去3-5分钟内没有重新缩放的情况下，才会发生放大/缩小。通过这种方式，HPA可以防止冲突决策的快速执行，并为集群自动伸缩提供时间。</p><h1 id="2cf7" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">包扎</h1><p id="6eee" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">基于流量的扩展对Kubernetes来说并不新鲜，NGINX等入口控制器可以公开HPA的Prometheus指标。使用Istio的不同之处在于，您还可以自动扩展后端服务，即只能从网格内部访问的应用程序。我不太喜欢在Kubernetes yaml中嵌入代码，但是Zalando metrics适配器足够灵活，允许这种定制的自动伸缩。</p><p id="fdeb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您对改进本指南有任何建议，请在GitHub上提交问题或PR，地址为<a class="ae jd" href="https://github.com/stefanprodan/istio-hpa" rel="noopener ugc nofollow" target="_blank"> stefanprodan/istio-hpa </a>。非常欢迎投稿！</p></div></div>    
</body>
</html>