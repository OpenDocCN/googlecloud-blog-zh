<html>
<head>
<title>Migrate GCS to GCS using Dataproc Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dataproc无服务器将GC迁移到GC</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/migrate-gcs-to-gcs-using-dataproc-serverless-3b7b0f6ad6b9?source=collection_archive---------3-----------------------#2022-11-17">https://medium.com/google-cloud/migrate-gcs-to-gcs-using-dataproc-serverless-3b7b0f6ad6b9?source=collection_archive---------3-----------------------#2022-11-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d242" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jd translated"><span class="l je jf jg bm jh ji jj jk jl di"> D </span></p><blockquote class="jn jo jp"><p id="939b" class="if ig jq ih b ii ij ik il im in io ip jr ir is it js iv iw ix jt iz ja jb jc hb bi translated">此外，<a class="ae jm" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/README.md" rel="noopener ugc nofollow" target="_blank"> Dataproc模板</a>提供了预定义的作业，可以按原样使用，也可以根据您的需求进行定制。因此，总而言之，这减少了管理基础设施和构建spark代码的总时间。</p></blockquote><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es ju"><img src="../Images/50ddbcafc308b3c038e017459a5dbf01.png" data-original-src="https://miro.medium.com/v2/resize:fit:494/format:webp/1*z7vJcTsQynEtgI3Qs3QhPQ.jpeg"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">使用Dataproc的GCStoGCS迁移</figcaption></figure></div><div class="ab cl kg kh gp ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="hb hc hd he hf"><h1 id="00b9" class="kn ko hi bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated"><strong class="ak">目标</strong></h1><p id="8bd7" class="pw-post-body-paragraph if ig hi ih b ii ll ik il im lm io ip iq ln is it iu lo iw ix iy lp ja jb jc hb bi translated">这篇博文讲述了如何利用<a class="ae jm" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/src/main/java/com/google/cloud/dataproc/templates/gcs/README.md#4-gcs-to-gcs" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">GCSToGCS</strong></a>data proc无服务器模板进行数据迁移。此外，这篇文章涵盖了两种主要编码语言(即<strong class="ih hj"> Python </strong>和<strong class="ih hj"> Java。</strong></p><h2 id="58ac" class="lq ko hi bd kp lr ls lt kt lu lv lw kx iq lx ly lb iu lz ma lf iy mb mc lj md bi translated">设置您的GCP项目和基础设施</h2><ol class=""><li id="cb36" class="me mf hi ih b ii ll im lm iq mg iu mh iy mi jc mj mk ml mm bi translated">登录到您的GCP项目并启用Dataproc API，如果禁用的话</li><li id="d9d4" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc mj mk ml mm bi translated">如果你要使用GCP生成的“默认”VPC网络，请确保该子网启用了私人谷歌访问。您仍然需要启用如下的私人访问</li></ol><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es ms"><img src="../Images/a46e23ea1c26661b8108c5579470ce13.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/1*Sxak421nKINSYUXlJ3VwIA.png"/></div></figure><pre class="jv jw jx jy fd mt mu mv bn mw mx bi"><span id="9612" class="my ko hi mu b be mz na l nb nc">gcloud compute networks subnets update default --region=us-central1 --enable-private-ip-google-access</span></pre><p id="e944" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.为jar文件创建一个GCS存储桶和暂存位置。</p><pre class="jv jw jx jy fd mt mu mv bn mw mx bi"><span id="e0e1" class="my ko hi mu b be mz na l nb nc">export GCS_STAGING_BUCKET=”my-gcs-staging-bucket”<br/>gsutil mb gs://$GCS_STAGING_BUCKET</span></pre></div><div class="ab cl kg kh gp ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="hb hc hd he hf"><h2 id="3e55" class="lq ko hi bd kp lr ls lt kt lu lv lw kx iq lx ly lb iu lz ma lf iy mb mc lj md bi translated">执行Dataproc模板的步骤</h2><ol class=""><li id="319b" class="me mf hi ih b ii ll im lm iq mg iu mh iy mi jc mj mk ml mm bi translated">克隆Dataproc模板库并导航到Java模板文件夹。</li></ol><pre class="jv jw jx jy fd mt mu mv bn mw mx bi"><span id="9ca3" class="my ko hi mu b be mz na l nb nc">git clone https://github.com/GoogleCloudPlatform/dataproc-templates.git<br/>cd dataproc-templates/java</span></pre><p id="7b02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要导航到Python模板文件夹，请执行以下命令:</p><pre class="jv jw jx jy fd mt mu mv bn mw mx bi"><span id="3b78" class="my ko hi mu b be mz na l nb nc">git clone https://github.com/GoogleCloudPlatform/dataproc-templates.git<br/>cd dataproc-templates/python</span></pre><p id="897b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.获取身份验证凭据(以提交作业)。</p><pre class="jv jw jx jy fd mt mu mv bn mw mx bi"><span id="fa60" class="my ko hi mu b be mz na l nb nc">gcloud auth application-default login</span></pre><p id="ee9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.通过导出提交所需的变量来配置Dataproc无服务器作业—</p><p id="34fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du nd ne nf mu b">GCP_PROJECT</code>:运行Dataproc无服务器的GCP项目id。</p><p id="077d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du nd ne nf mu b">REGION</code>:运行Dataproc无服务器的区域。</p><p id="d400" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du nd ne nf mu b">GCS_STAGING_LOCATION</code> : GCS暂存区位置，Dataproc将在此存储暂存资产(参见GCP项目设置部分中的步骤3)。</p><p id="2956" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.<strong class="ih hj">【Python模板】</strong>收集以下可选参数的值</p><ul class=""><li id="23ce" class="me mf hi ih b ii ij im in iq ng iu nh iy ni jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.INPUT.FORMAT</code> : GCS输入文件格式(avro、parquet、csv、json中的一种)</li><li id="0c0b" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.INPUT.LOCATION</code>:输入文件的GCS位置</li><li id="0490" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.OUTPUT.FORMAT</code> : GCS输入文件格式(avro、parquet、csv、json中的一种)</li><li id="b11d" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.OUTPUT.LOCATION</code>:目标文件的GCS位置</li><li id="e383" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.OUTPUT.MODE</code>:输出写入模式(追加、覆盖、忽略、错误存在中的一种)(默认为追加)</li><li id="541d" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.TEMP.VIEW.NAME</code>:在源数据上创建spark sql视图的临时视图名。</li><li id="7e33" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.SQL.QUERY:</code>:数据转换的SQL查询。</li></ul><blockquote class="jn jo jp"><p id="6db1" class="if ig jq ih b ii ij ik il im in io ip jr ir is it js iv iw ix jt iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi">注意:</em> </strong> <em class="hi">当使用转换属性时，Spark临时视图的名称和查询中视图的名称应该完全匹配，以避免“找不到表/视图”的错误。</em></p></blockquote><p id="21e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用强制环境变量执行提供的<code class="du nd ne nf mu b">bin/start.sh</code>脚本，将作业提交给dataproc无服务器——下面是Python模板的一个示例执行命令:</p><pre class="jv jw jx jy fd mt mu mv bn mw mx bi"><span id="c350" class="my ko hi mu b be mz na l nb nc">./bin/start.sh \<br/>-- --template=GCSTOGCS \ <br/>    --gcs.to.gcs.input.location="&lt;gs://bucket/path&gt;" \<br/>    --gcs.to.gcs.input.format="&lt;json|csv|parquet|avro&gt;" \<br/>    --gcs.to.gcs.output.location="&lt;gs://bucket/path&gt;"<br/>    --gcs.to.gcs.output.format="&lt;json|csv|parquet|avro&gt;" \<br/>    --gcs.to.gcs.output.mode="&lt;append|overwrite|ignore|errorifexists&gt;" \<br/>    --gcs.to.gcs.temp.view.name="temp" \<br/>    --gcs.to.gcs.sql.query="select *, 1 as col from temp" \</span></pre><p id="c762" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.<strong class="ih hj">【Java模板】</strong>收集以下可选参数的值</p><ul class=""><li id="23c2" class="me mf hi ih b ii ij im in iq ng iu nh iy ni jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.INPUT.FORMAT</code> : GCS输入文件格式(avro、parquet、csv、json中的一种)</li><li id="6a9d" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.INPUT.LOCATION</code>:输入文件的GCS位置</li><li id="b62b" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.OUTPUT.FORMAT</code> : GCS输入文件格式(avro、parquet、csv、json中的一种)</li><li id="2220" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.OUTPUT.LOCATION</code>:目标文件的GCS位置</li><li id="e256" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.OUTPUT.MODE</code>:输出写入模式(追加、覆盖、忽略、错误存在中的一种)(默认为追加)</li><li id="a2f1" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.TEMP.TABLE</code>:在源数据上创建spark sql视图的临时表名。</li><li id="ac6f" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc nj mk ml mm bi translated"><code class="du nd ne nf mu b">GCS.TO.GCS.TEMP.QUERY:</code>:数据转换的SQL查询。</li></ul><blockquote class="jn jo jp"><p id="b636" class="if ig jq ih b ii ij ik il im in io ip jr ir is it js iv iw ix jt iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi">注意:</em> </strong> <em class="hi">当使用转换属性时，Spark临时表的名称和查询中的表的名称应该完全匹配，以避免“找不到表/视图”的错误。</em></p></blockquote><p id="00a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用强制环境变量执行提供的<code class="du nd ne nf mu b">bin/start.sh</code>脚本，将作业提交给dataproc无服务器——下面是Java模板的一个示例执行命令:</p><pre class="jv jw jx jy fd mt mu mv bn mw mx bi"><span id="903b" class="my ko hi mu b be mz na l nb nc">bin/start.sh \<br/>-- --template GCSTOJDBC \<br/>--templateProperty project.id=my-gcp-project \<br/>--templateProperty gcs.gcs.input.location=gs://my-gcp-project-input-bucket/filename.avro \<br/>--templateProperty gcs.gcs.input.format=avro \<br/>--templateProperty gcs.gcs.output.location=gs://my-gcp-project-output-bucket \<br/>--templateProperty gcs.gcs.output.format=csv \<br/>--templateProperty gcs.jdbc.output.saveMode=Overwrite <br/>--templateProperty gcs.gcs.temp.table=temp \<br/>--templateProperty gcs.gcs.temp.query='select *, 1 as col from temp'</span></pre><p id="5128" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">提供火花特性</strong></p><p id="e4f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您需要<a class="ae jm" href="https://cloud.google.com/dataproc-serverless/docs/concepts/properties" rel="noopener ugc nofollow" target="_blank">指定Dataproc无服务器支持的spark属性</a>，例如调整驱动程序、内核、执行器等的数量，您可以编辑start.sh文件中的<a class="ae jm" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/bin/start.sh#L50" rel="noopener ugc nofollow" target="_blank"> OPT_PROPERTIES </a>值。</p><p id="555d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.监控Spark批处理作业</p><p id="e962" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提交作业后，我们将能够在<a class="ae jm" href="https://console.cloud.google.com/dataproc/batches" rel="noopener ugc nofollow" target="_blank"> Dataproc Batches UI </a>中看到。从那里，我们可以查看作业的指标和日志。</p><h2 id="91a1" class="lq ko hi bd kp lr ls lt kt lu lv lw kx iq lx ly lb iu lz ma lf iy mb mc lj md bi translated">参考</h2><ul class=""><li id="b3d2" class="me mf hi ih b ii ll im lm iq mg iu mh iy mi jc nj mk ml mm bi translated"><a class="ae jm" href="https://cloud.google.com/dataproc-serverless/docs/overview" rel="noopener ugc nofollow" target="_blank"> Dataproc无服务</a></li><li id="bf5f" class="me mf hi ih b ii mn im mo iq mp iu mq iy mr jc nj mk ml mm bi translated"><a class="ae jm" href="https://github.com/GoogleCloudPlatform/dataproc-templates" rel="noopener ugc nofollow" target="_blank"> Dataproc模板库</a></li></ul><p id="142d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如有任何疑问/建议，请联系:dataproc-templates-support-external@googlegroups.com</p></div></div>    
</body>
</html>