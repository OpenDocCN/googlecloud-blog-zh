<html>
<head>
<title>SAP on Google Cloud: HANA HDI containers and CI/CD pipelines pt .2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Cloud上的SAP:HANA HDI容器和CI/CD管道第2部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/sap-on-google-cloud-hana-hdi-containers-and-ci-cd-pipelines-60cedaddfbc8?source=collection_archive---------2-----------------------#2020-07-13">https://medium.com/google-cloud/sap-on-google-cloud-hana-hdi-containers-and-ci-cd-pipelines-60cedaddfbc8?source=collection_archive---------2-----------------------#2020-07-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9426" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用Node.js和Golang为前端和后端模块以及SAP HANA上的HDI容器构建了一个具有托管容器的应用程序。我们定义了一个CI/CD管道来保持它们的一致性。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/6e694d6140c3bb0653a454985f1fa72f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*0RM7onjgLWBbLzz1dC4DAQ.png"/></div></figure><p id="14b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博文中，我们将解释CI/CD管道是什么样子，以及它是如何结合HDI容器的概念的。接下来是第一部分。</p><h1 id="a5f0" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">应用程序</h1><p id="637b" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">正如您在上面的方框中看到的，我们的应用程序有三个微服务:</p><ul class=""><li id="896f" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc ku kv kw kx bi translated">一个前端，用Node.js写的web应用</li><li id="c306" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">一个后端应用程序，用Golang编写，也可以与翻译API对话</li><li id="8012" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">数据库访问层，负责使用面向SAP HANA的Node.js客户端与SAP HANA对话</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es ld"><img src="../Images/2a0d2adda7979d5e559a4ddca264cb82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*el3pYCuWSr75fkZe"/></div></div></figure><p id="929e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以自己创建这个应用程序，希望是免费的，并且不需要刷信用卡<strong class="ih hj">。我们<a class="ae jl" href="https://google.qwiklabs.com/catalog_lab/2583" rel="noopener ugc nofollow" target="_blank">发布了这个Qwiklab </a>，它将在你完成实验的同时，在谷歌云上为你安装一台HANA Express机器。最初的免费Qwiklab信用应该足够运行这个实验。我建议你把这个应用程序克隆到你自己的GitHub中，这样你以后就可以用它了。</strong></p><h1 id="c8e0" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">管道</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es li"><img src="../Images/de51dbcc9c30356ddf821260b8f08e04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*F-xhwSJPYDA_vD8l"/></div></div></figure><p id="ec86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我认为管道在运行时更容易理解。因此，假设我们是一组开发人员，他们在组成我们应用程序的不同微服务上工作。</p><p id="754f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是工具霸主将如何治理我们的日子(或者我们如何治理他们，我们会看到…)</p><h1 id="0904" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">共享Git存储库</h1><p id="63a9" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">我们选择Google Cloud Source作为私有的git存储库。这个回购和它的主分支是与应用程序一起“诞生”的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lj"><img src="../Images/c63a0a74b6e2decd42a3693db9c4c961.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tIY5pgpPHI5DE-4n"/></div></div></figure><p id="afb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你知道第一次部署还带来了什么吗？一个HDI容器！</p><h1 id="0972" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">创建HDI容器</h1><p id="3579" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">就像我们有一个充当主分支的分支一样，我们将有一个HDI容器，它将充当所有分支的引用，并将加载测试数据。</p><p id="3999" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有一个使用<a class="ae jl" href="https://github.com/SAP-samples/hana-developer-cli-tool-example" rel="noopener ugc nofollow" target="_blank"> hana-cli </a>创建第一个容器的例子。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lk"><img src="../Images/01cbaabf4ed3b9165491970688bb7329.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*-9SGt2Ccpnxo0jYXiAvSJw.gif"/></div></div></figure><p id="a2fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想跟随/复制和粘贴，这里有一个脚本。</p><p id="6202" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认的-env.json文件现在包含该容器的凭证。Node.js库hdi-deploy将查找具有此名称或环境变量VCAP服务的文件，以连接到SAP HANA并将我们的新表和其他工件部署到hdi容器中。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es ll"><img src="../Images/03670df7b1fae5ea09c34fcf3a445b24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z3NB8MofHnWk_0Njl_p4NQ.png"/></div></div></figure><p id="8f87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">稍后，我们将使用该文件中的内容创建一个名为VCAP服务的环境变量。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lm"><img src="../Images/13481fcaac16fd32012693645addacd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GvbLe6AUYqyH7MNfbt4XRw.png"/></div></div></figure><h1 id="6dbe" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">开始改变</h1><p id="14f1" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">为了简单起见，假设我们需要在HDI容器中的现有表中添加一个额外的列。</p><p id="431b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我会确保从主分支中取出所有的更改。这将把已经部署到主HDI容器中的最新工件也带进来。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es ln"><img src="../Images/fd4559be1378c70f98e693220af737cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TtQDUIvuVncDlL-7"/></div></div></figure><p id="5241" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我将创建自己的分支:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lo"><img src="../Images/e29d8c28bb9fc91d10bf5f8618af471e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VuQxG7WmaAApVCQ6"/></div></div></figure><p id="e3af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就像我已经创建了自己的分支一样，我将使用刚刚从主分支中提取的部署文件来创建自己版本的HDI容器。</p><p id="9d8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一次，我将在我的容器名后面添加一个标记(<em class="lp"> _LS </em>)，这样它就不会与主容器名冲突(Web IDE会自动执行这个操作)。</p><pre class="je jf jg jh fd lq lr ls lt aw lu bi"><span id="6d4d" class="lv jn hi lr b fi lw lx l ly lz">hana-cli connect -s</span><span id="7733" class="lv jn hi lr b fi ma lx l ly lz">hana-cli createContainer -c RUN_LS -e -s</span></pre><p id="5957" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我有了这个容器的新的<strong class="ih hj">凭证。json文件。我将继续对我拉出的表进行更改:</strong></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es mb"><img src="../Images/7362110d3ccd041452e90bae73dcbbc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Aeb8KKEVh_OaG38q"/></div></div></figure><p id="fdca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用default-env.json文件中新的<strong class="ih hj"> </strong>凭证，我将部署这个更改。缺省的-env.json文件应该在/db文件夹中，我们从这里运行这些命令:</p><pre class="je jf jg jh fd lq lr ls lt aw lu bi"><span id="d267" class="lv jn hi lr b fi lw lx l ly lz">npm install<br/>npm start</span></pre><p id="b28a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这调用了hdi-deploy模块，因此它可以创建一个hdi容器，并用我的表创建一个模式。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es mc"><img src="../Images/f57214a2b4ca53d2656818af877a8651.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*NN7GRXhZjNbzLOIyCjRMUQ.gif"/></div></div></figure><p id="043f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们的凭证并不意味着离开我们的本地环境，所以让我们确保。gitignore文件包括这些default.env*。json文件。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es md"><img src="../Images/1e4abdf84761ff38aaf64e551ecb7520.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/1*mvpbXugSkbbq5qLk93PKpA.png"/></div></figure><p id="1c31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们在每次喝咖啡休息前提交+推送:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es me"><img src="../Images/a7816629a31825a5597da7503e756f06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_WRWw95ttBVYcRvN"/></div></div></figure><p id="0384" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在应该在Google Cloud Source中看到我的Git分支的变化:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es mf"><img src="../Images/ac19595a4952cbc4baa5404b1d7b7c72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MXefcXz03-ypIyWO"/></div></div></figure><h1 id="ca83" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">合并变更</h1><p id="b685" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">我们已经完成了一些修改，并在我们自己的容器上做了一些快速测试。我们已经将那些变更(多次)提交到我们自己的分支中。现在是时候将它们提交到主分支中了。</p><p id="d1b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以防其他开发人员也在做改变，我也再次拉这个分支。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mg"><img src="../Images/84d377c756fc3177555041674d37d6e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*nQd4W5zLxXQX2OtiOmQaNw.png"/></div></figure><p id="144e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jl" href="https://asciinema.org/a/xBwl5ryz8fi94XivKmXnAXcnT" rel="noopener ugc nofollow" target="_blank">此处Asciinema】。</a></p><p id="c745" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们合并变更后，主分支现在显示它们…如预期的那样:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es mh"><img src="../Images/62bc3bf7a7d0c2ead5b83e884d149c5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ytrx507Lb2oum3d8"/></div></div></figure><h1 id="5b56" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">自动化部署和测试</h1><p id="5be0" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">我们“经常部署，快速失败”的关键要素之一是自动化。我们什么时候想要它？一旦我们进入主干道。是的，就像我们刚刚做的那样。</p><p id="5fa2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们希望确保以前可以工作的一切仍然可以工作，但是我们需要首先将更改部署到主容器中。</p><p id="1e00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还想确保我们的新表和工件在别人部署时得到测试。这意味着我们的新表也需要合并到自动化测试中，所以我们也将把它们构建到管道中。</p><p id="e528" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们想做一些测试，比如本文<a class="ae jl" href="https://github.com/SAP-samples/hana-xsa-opensap-hana7/tree/hana2_sps04/srv/tests" rel="noopener ugc nofollow" target="_blank">中记录的测试，我们需要一些SAP HANA专用工具:hana-cli、hdbsql和Node.js的HANA客户端。</a></p><p id="1e5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以在Docker容器中预装所有这些组件，并让该容器进行部署和测试。我们将在以后的博客文章中讨论这个问题，但这里有一个大概的介绍:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es mi"><img src="../Images/f0afe1892f1f6ccaada68eb024c28cde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5Pi2ZPokA0cmyrE6"/></div></div></figure><p id="5908" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用的协调工具是云构建。我们使用一个触发器来启动构建和测试过程，每当有一个进入主分支:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es mb"><img src="../Images/a11bae18f27093f5b441acc7c6d53b00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8XBY2Yi2IIdshMYh"/></div></div></figure><p id="60af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用docker容器并将VCAP _服务作为环境变量注入，以便Node.js部署人员可以使用主HDI容器施展魔法，运行:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es mj"><img src="../Images/660fa073ca203660c538909408200ab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*q5ibz0kriGP722lx"/></div></div></figure><p id="d226" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有一种更好的方法来传递这些凭证，使用秘密。但是我们会把这个留到以后的博客文章中。</p><p id="976c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于如何为其余的微服务构建管道的细节以及在生产环境中使用管道的一些调整，<a class="ae jl" rel="noopener" href="/google-cloud/sap-on-google-cloud-creating-the-ci-cd-pipeline-pt-3-22aa6c64123">这里是第3部分</a>。</p><p id="9f9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jl" href="https://twitter.com/LuciaBlick" rel="noopener ugc nofollow" target="_blank">露西娅·苏巴丁</a>和<a class="ae jl" href="https://www.linkedin.com/in/fatimasilv/" rel="noopener ugc nofollow" target="_blank">法蒂玛·西尔维拉</a>。</p></div></div>    
</body>
</html>