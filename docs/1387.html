<html>
<head>
<title>Using BigQuery (and BigQuery ML) from Kubeflow Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kubeflow管道中的BigQuery(和BigQuery ML)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-bigquery-and-bigquery-ml-from-kubeflow-pipelines-991a2fa4bea8?source=collection_archive---------0-----------------------#2020-04-21">https://medium.com/google-cloud/using-bigquery-and-bigquery-ml-from-kubeflow-pipelines-991a2fa4bea8?source=collection_archive---------0-----------------------#2020-04-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="5771" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用Python函数来组合功能</h2></div><p id="ba61" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这些天，当有人问我建立机器学习开发到操作化工作流的最佳方式时，我会告诉他们<a class="ae jt" href="https://www.kubeflow.org/docs/pipelines/overview/pipelines-overview/" rel="noopener ugc nofollow" target="_blank"> Kubeflow Pipelines </a> (KFP)。在谷歌云上，<a class="ae jt" href="https://cloud.google.com/ai-platform/pipelines/docs" rel="noopener ugc nofollow" target="_blank">云人工智能平台管道</a>为KFP提供了托管体验，这样你就不必在Kubernetes集群上瞎折腾了。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ju"><img src="../Images/b32d7f4d457864022962ba944501de2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DnhObQAonwShmRfISVJQ9Q.jpeg"/></div></div></figure><h2 id="ea9c" class="kg kh hi bd ki kj kk kl km kn ko kp kq jg kr ks kt jk ku kv kw jo kx ky kz la bi translated">调用BigQuery的Python代码</h2><p id="b6f7" class="pw-post-body-paragraph ix iy hi iz b ja lb ij jc jd lc im jf jg ld ji jj jk le jm jn jo lf jq jr js hb bi translated">我们首先编写一个函数，该函数使用BigQuery Python客户端运行BigQuery查询，该查询创建一个表并返回表或模型名称:</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="444e" class="kg kh hi lh b fi ll lm l ln lo">from typing import NamedTuple</span><span id="e125" class="kg kh hi lh b fi lp lm l ln lo">def run_bigquery_ddl(project_id: str, query_string: str, <br/>    location: str) -&gt; NamedTuple(<br/>    'DDLOutput', [('created_table', str), ('query', str)]):<br/>    """<br/>    Runs BigQuery query and returns a table/model name<br/>    """<br/>    print(query_string)<br/>        <br/>    from google.cloud import bigquery<br/>    from google.api_core.future import polling<br/>    from google.cloud import bigquery<br/>    from google.cloud.bigquery import retry as bq_retry<br/>    <br/>    bqclient = bigquery.Client(project=project_id, location=location)<br/>    <strong class="lh hj">job = bqclient.query(query_string, retry=bq_retry.DEFAULT_RETRY)</strong><br/>    job._retry = polling.DEFAULT_RETRY<br/>    <br/>    while job.running():<br/>        from time import sleep<br/>        sleep(0.1)<br/>        print('Running ...')<br/>        <br/>    <strong class="lh hj">tblname = job.ddl_target_table</strong><br/>    tblname = '{}.{}'.format(tblname.dataset_id, tblname.table_id)<br/>    print('{} created in {}'.format(tblname, job.ended - job.started))<br/>    <br/>    from collections import namedtuple<br/>    result_tuple = namedtuple('DDLOutput', ['created_table', 'query'])<br/>    <strong class="lh hj">return result_tuple(tblname, query_string)</strong></span></pre><h2 id="c503" class="kg kh hi bd ki kj kk kl km kn ko kp kq jg kr ks kt jk ku kv kw jo kx ky kz la bi translated">使用容器函数创建容器</h2><p id="7914" class="pw-post-body-paragraph ix iy hi iz b ja lb ij jc jd lc im jf jg ld ji jj jk le jm jn jo lf jq jr js hb bi translated">在Kubeflow管道中，每个步骤(或“操作”)都需要是一个容器。幸运的是，使用上面的Python函数并使其成为一个容器非常简单:</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="1322" class="kg kh hi lh b fi ll lm l ln lo">ddlop = comp.func_to_container_op(run_bigquery_ddl,<br/>                    packages_to_install=['google-cloud-bigquery'])</span></pre><p id="bfa3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意，我指定了函数所依赖的Python包。还要仔细观察Python函数本身——任何非标准的包都被导入到函数定义中的<em class="lq">。</em></p><h2 id="ed77" class="kg kh hi bd ki kj kk kl km kn ko kp kq jg kr ks kt jk ku kv kw jo kx ky kz la bi translated">使用容器</h2><p id="03c2" class="pw-post-body-paragraph ix iy hi iz b ja lb ij jc jd lc im jf jg ld ji jj jk le jm jn jo lf jq jr js hb bi translated">给定上面的容器(ddlop ),我们可以使用它来执行我们想要的任何表或模型创建查询。例如，下面是一个训练模型的查询，作为管道的一部分调用:</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="41ea" class="kg kh hi lh b fi ll lm l ln lo">def train_classification_model(ddlop, project_id):<br/>    query = """<br/>        CREATE OR REPLACE MODEL mlpatterns.classify_trips<br/>        TRANSFORM(<br/>          trip_type,<br/>          EXTRACT (HOUR FROM start_date) AS start_hour,<br/>          EXTRACT (DAYOFWEEK FROM start_date) AS day_of_week,<br/>          start_station_name,<br/>          subscriber_type,<br/>          ML.QUANTILE_BUCKETIZE(member_birth_year, 10) OVER() AS bucketized_age,<br/>          member_gender<br/>        )<br/>        OPTIONS(model_type='logistic_reg', <br/>                auto_class_weights=True,<br/>                input_label_cols=['trip_type']) AS</span><span id="feb4" class="kg kh hi lh b fi lp lm l ln lo">SELECT<br/>          start_date, start_station_name, subscriber_type, member_birth_year, member_gender,<br/>          IF(duration_sec &gt; 3600*4, 'Long', 'Typical') AS trip_type<br/>        FROM `bigquery-public-data.san_francisco_bikeshare.bikeshare_trips`<br/>    """<br/>    print(query)<br/>    return ddlop(project_id, query, 'US')</span></pre><h2 id="8903" class="kg kh hi bd ki kj kk kl km kn ko kp kq jg kr ks kt jk ku kv kw jo kx ky kz la bi translated">编写管道</h2><p id="fe99" class="pw-post-body-paragraph ix iy hi iz b ja lb ij jc jd lc im jf jg ld ji jj jk le jm jn jo lf jq jr js hb bi translated">我们可以将这样的查询串成一个ML管道:</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="5749" class="kg kh hi lh b fi ll lm l ln lo"><a class="ae jt" href="http://twitter.com/dsl" rel="noopener ugc nofollow" target="_blank">@dsl</a>.pipeline(<br/>    name='Cascade pipeline on SF bikeshare',<br/>    description='Cascade pipeline on SF bikeshare'<br/>)<br/>def cascade_pipeline(<br/>    project_id = PROJECT_ID<br/>):<br/>    ddlop = comp.func_to_container_op(run_bigquery_ddl, packages_to_install=['google-cloud-bigquery'])<br/>        <br/>    c1 = train_classification_model(ddlop, PROJECT_ID)<br/>    c1_model_name = c1.outputs['created_table']<br/>    <br/>    c2a_input = create_training_data(ddlop, PROJECT_ID, c1_model_name, 'Typical')<br/>    c2b_input = create_training_data(ddlop, PROJECT_ID, c1_model_name, 'Long')<br/>    <br/>    c3a_model = train_distance_model(ddlop, PROJECT_ID, c2a_input.outputs['created_table'], 'Typical')<br/>    c3b_model = train_distance_model(ddlop, PROJECT_ID, c2b_input.outputs['created_table'], 'Long')<br/>    <br/>    evalop = comp.func_to_container_op(evaluate, packages_to_install=['google-cloud-bigquery', 'pandas'])<br/>    error = evalop(PROJECT_ID, c1_model_name, c3a_model.outputs['created_table'], c3b_model.outputs['created_table'])<br/>    print(error.output)</span></pre><p id="9cdf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您可以创建这个管道的zip文件，并将其提交给ML Pipelines集群，以调用新的实验运行。</p><h2 id="a453" class="kg kh hi bd ki kj kk kl km kn ko kp kq jg kr ks kt jk ku kv kw jo kx ky kz la bi translated">试试吧！</h2><p id="d4ef" class="pw-post-body-paragraph ix iy hi iz b ja lb ij jc jd lc im jf jg ld ji jj jk le jm jn jo lf jq jr js hb bi translated">本文的<a class="ae jt" href="https://github.com/GoogleCloudPlatform/ml-design-patterns/blob/master/03_problem_representation/cascade.ipynb" rel="noopener ugc nofollow" target="_blank">完整代码在GitHub上。要试用笔记本电脑:</a></p><ul class=""><li id="77a0" class="lr ls hi iz b ja jb jd je jg lt jk lu jo lv js lw lx ly lz bi translated">按照<a class="ae jt" href="https://cloud.google.com/ai-platform/pipelines/docs/setting-up" rel="noopener ugc nofollow" target="_blank">设置AI平台管道</a>操作指南创建AI平台管道实例。创建GKE集群时，确保启用对<a class="ae jt" href="https://www.googleapis.com/auth/cloud-platform" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/cloud-platform</a>的访问。</li><li id="5ab0" class="lr ls hi iz b ja ma jd mb jg mc jk md jo me js lw lx ly lz bi translated">在GCP控制台的AI平台/笔记本中创建一个笔记本实例(任何版本)。</li><li id="7fc3" class="lr ls hi iz b ja ma jd mb jg mc jk md jo me js lw lx ly lz bi translated">克隆我的笔记本(上图)</li><li id="9548" class="lr ls hi iz b ja ma jd mb jg mc jk md jo me js lw lx ly lz bi translated">更改第一个单元格，以反映您的KFP集群的主机名。</li></ul><p id="3485" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">尽情享受吧！</p></div></div>    
</body>
</html>