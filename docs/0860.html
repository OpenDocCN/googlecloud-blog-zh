<html>
<head>
<title>Cloud IoT step-by-step: Connecting Raspberry PI + Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云物联网循序渐进:连接树莓PI + Python</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-iot-step-by-step-connecting-raspberry-pi-python-2f27a2893ab5?source=collection_archive---------0-----------------------#2018-12-18">https://medium.com/google-cloud/cloud-iot-step-by-step-connecting-raspberry-pi-python-2f27a2893ab5?source=collection_archive---------0-----------------------#2018-12-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/959bea8634a3066fb5636c48a2f1675d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qOX-cSj9U_Ab93xLff5jMA.png"/></div></div></figure><p id="6294" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">嗨，朋友们！</p><p id="fb87" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以你有了一个很棒的主意，把一个树莓派连接到你后院的气象站，这样你就可以在下雨的时候自动开关窗户。哦，当你这样做的时候，你要连接一个像ESP32这样的微控制器，当外面太热的时候，它可以打开和关闭你的洒水器。永远不要忘记关掉你的烤箱怎么样！</p><p id="9ddb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">那现在怎么办？有很多关于建立气象站的教程<a class="ae jo" href="https://makezine.com/2015/11/20/build-your-own-arduino-weather-station/" rel="noopener ugc nofollow" target="_blank"/><a class="ae jo" href="https://weather.com/news/news/how-make-weather-station-pro-20130731/" rel="noopener ugc nofollow" target="_blank">。很好的组件列表，其中一些在物理连接方面非常好，另一些稍微有点掩盖，你必须四处搜索才能将所有东西拼凑在一起。有些人更进一步，告诉你如何连接到云！找到了。现在我们在谈话。但是很多这样的书都很长，没有目录，所以你必须在所有的书中寻找你需要的东西。它们很少能填补特定用例的所有空白。</a></p><p id="c18e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个博客的目标是从小处着手，集中精力(尽管感觉还是有点长)。我希望你，在这结束的时候，有一个一步一步的指南，把你的树莓Pi连接到谷歌的云平台。除此之外还有很多事情要做，但是就像我说的，从小处着手。我不打算深入探讨我们的物联网平台必须提供的全部功能。甚至关于与设备的通信。我只介绍一种方式，即设备到云的通信。但是我想让你能够把你的项目带到云上。迈出第一步就是要能够看到你的设备与云对话。</p><p id="b249" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我完成这些之后，我将开始构建类似的教程。你可以用设备做更多的事情，比如双向通信。如何在云平台内部移动数据，如何以及在哪里存储不同用例的数据。如何运行基本分析？如何用你的数据在云端训练一个机器学习模型。</p><p id="28d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本教程中，请注意，对于一些人来说，我所讲述的细节将远远超出你的需要。例如，在Pi setup basics中，我讲述了很多细节，比如改变终端的字体以使其更容易阅读。我已经设置了逻辑标题，所以很容易跳到你需要启动和运行的教程部分。</p><p id="7376" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我在教程中使用了Pi 3+,但从库依赖设置部分开始，这也可以用于Raspberry Pi Zero W。如果你想为此设置Pi Zero，但以前没有设置过，我强烈推荐本指南<a class="ae jo" href="https://learn.adafruit.com/raspberry-pi-zero-creation/overview" rel="noopener ugc nofollow" target="_blank">。然后跳到本文的依赖部分。</a></p><h1 id="6349" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">目录:</h1><ul class=""><li id="f345" class="kn ko hi is b it kp ix kq jb kr jf ks jj kt jn ku kv kw kx bi translated"><a class="ae jo" href="#c01b" rel="noopener ugc nofollow"> Pi设置基础知识</a></li><li id="3ee1" class="kn ko hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated"><a class="ae jo" href="#50cb" rel="noopener ugc nofollow">库依赖设置</a></li><li id="7ef3" class="kn ko hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated"><a class="ae jo" href="#7f07" rel="noopener ugc nofollow">准备谷歌云平台</a></li><li id="c3d2" class="kn ko hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated"><a class="ae jo" href="#ed16" rel="noopener ugc nofollow">代码</a></li></ul><h2 id="c01b" class="ld jq hi bd jr le lf lg jv lh li lj jz jb lk ll kd jf lm ln kh jj lo lp kl lq bi translated">Pi设置基础</h2><p id="eedc" class="pw-post-body-paragraph iq ir hi is b it kp iv iw ix kq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">其中一些步骤对你来说可能略有不同，我喜欢对我的Pi做一些事情，只是为了生活质量。如果你已经知道如何设置WiFi，并根据自己的喜好调整Pi，那么你可以安全地跳过这一步，直接进入库依赖设置。</p><p id="3ac2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">直接连接到您的Pi，并钩HDMI。</p><p id="fae5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">根据你使用的显示器，或者你的年龄，我将终端中的字体改为等宽14。使它更容易阅读。我还在首选项中将我的键盘布局更改为美国-&gt;英语。默认为UK-&gt;English，在我意想不到的地方有符号。</p><p id="82c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你使用WiFi，有一件事你一定要做，那就是确保在Pi上的设置中，你的WiFi国家设置为你所在的任何地方。如果设置为德国，而你在美国，很可能就不行了。有时不同的国家组合也能工作，但这是相当随机的，最好直接设置。</p><p id="e6bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下一步是确保您的Pi可以连接到互联网。插入以太网电缆，或者如果您使用WiFi，扫描您的Pi可以看到的网络。从Pi上的终端运行以下命令:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="355a" class="ld jq hi lz b fi md me l mf mg">sudo iwlist wlan0 scan</span></pre><p id="21f1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">选择你想用的，记住SSID。</p><p id="3021" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，这将覆盖您现有的任何WiFi设置，因此如果您想要保留当前设置，请将该文件移动为备份。这可以通过以下方式实现:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="c3c7" class="ld jq hi lz b fi md me l mf mg">mv /etc/wpa_supplicant/wpa_supplicant.conf /etc/wpa_supplicant/wpa_supplicant.conf.bak</span></pre><p id="737d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后运行:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="2276" class="ld jq hi lz b fi md me l mf mg">sudo vi /etc/wpa_supplicant/wpa_supplicant.conf</span></pre><p id="fcfd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果文件中有任何内容，您可以用以下两种方法之一替换它。如果您的WiFi有密码，请使用:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="afff" class="ld jq hi lz b fi md me l mf mg">ctrl_interface=/var/run/wpa_supplicant<br/>network={<br/>    ssid=”&lt;ssid&gt;”<br/>    psk=”&lt;password for network&gt;”<br/>}</span></pre><p id="de5d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果没有密码:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="712b" class="ld jq hi lz b fi md me l mf mg">ctrl_interface=/var/run/wpa_supplicant<br/>network={<br/>    ssid=”&lt;ssid&gt;”<br/>    key_mgmt=NONE<br/>}</span></pre><p id="80d1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在您已经有了WiFi的配置，您需要重新启动该服务来使用WiFi:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="badf" class="ld jq hi lz b fi md me l mf mg">sudo wpa_cli reconfigure</span></pre><p id="b4fa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您应该能够通过运行以下命令来验证您是否拥有WiFi:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="7b10" class="ld jq hi lz b fi md me l mf mg">ifconfig wlan0 | grep inet</span></pre><p id="6951" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你应该有一个IP地址。根据您的WiFi配置，它可能是以168.1或127.1开头的东西(只要不是127.1.1.1，这不是正确的)。</p><p id="651e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果失败了，而你又没有IP地址。你可以试试:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="a718" class="ld jq hi lz b fi md me l mf mg">wpa_supplicant -iwlan0 -c /etc/wpa_supplicant.conf &amp; dhcpcd wlan0</span></pre><p id="6825" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个硬重置WiFi。如果仍然不起作用，请尝试使用以下命令完全重启Pi:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="5208" class="ld jq hi lz b fi md me l mf mg">sudo reboot</span></pre><p id="1bc6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">既然您是Pi，就可以与互联网交流了，让我们来设置一下，让它拥有我们需要的所有Python依赖项。</p><h2 id="50cb" class="ld jq hi bd jr le lf lg jv lh li lj jz jb lk ll kd jf lm ln kh jj lo lp kl lq bi translated">库相关性设置</h2><p id="0b90" class="pw-post-body-paragraph iq ir hi is b it kp iv iw ix kq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">如果您是Linux、Pi和所有apt-get的新手，这些步骤中的每一步都会产生一些变化，抛出一串关于您所要求的内容以及它所依赖的依赖项的文本，告诉您它将在您的Pi上安装什么。如果你想知道这一切意味着什么，每个图书馆的网页都很好地解释了图书馆是怎么回事。我会TL；每一个都只是为了介绍特定库的用途。</p><p id="23fe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，确保我们是最新的:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="449d" class="ld jq hi lz b fi md me l mf mg">sudo apt-get update</span></pre><p id="efdf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这确保了您的Pi将从其中获取库的位置列表是最新的。有时这些库会移动，被废弃，等等，所以在开始一个项目时运行它总是好的。请注意，如果您使用的是Raspbian，他们也会不断更新它，所以其中一些依赖项可能会说它们已经存在了。完全没问题，这只是，为了完整起见，你需要的所有东西。</p><p id="280d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来是获取我们处理与物联网核心的安全连接所需的部件。认证是通过<a class="ae jo" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JWT </a>完成的，而不是用户/密码，因为这样更安全。为了解决这个问题，库是pyjwt，它依赖于一个叫做cryptography的Python库。我为什么要告诉你这些？因为要安装这些组件，你需要特定的基础库。要获取它们，请运行以下命令:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="ff91" class="ld jq hi lz b fi md me l mf mg">sudo apt-get install build-essential<br/>sudo apt-get install libssl-dev<br/>sudo apt-get install python-dev<br/>sudo apt-get install libffi-dev</span></pre><p id="f3b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，根据您的Python版本，能够安装其中一个库<code class="du mh mi mj lz b">cryptography</code>，可能需要3.x。继续尝试使用您拥有的任何版本的Python来完成所有工作，但是如果您在到达<code class="du mh mi mj lz b">sudo pip install cryptography</code>时遇到编译错误，那么您将需要使用<code class="du mh mi mj lz b">pip3</code>运行所有这些pip安装，而不仅仅是<code class="du mh mi mj lz b">pip</code>，所以您使用的是Python 3.x。我最近使用Python 2.7.13运行了它，看起来它们已经清理了一堆，所以您将会得到一个为了完整起见，我只是包括了所有手动添加的库。</p><p id="bf50" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于这个演示，我们使用MQTT，所以我们需要允许我们使用那个协议的库，<a class="ae jo" href="http://www.steves-internet-guide.com/into-mqtt-python-client/" rel="noopener ugc nofollow" target="_blank"> paho-mqtt </a>。运行:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="ad4a" class="ld jq hi lz b fi md me l mf mg">sudo pip install paho-mqtt</span></pre><p id="1b10" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于我们的加密，我们使用pyjwt。运行:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="fd3e" class="ld jq hi lz b fi md me l mf mg">sudo pip install <a class="ae jo" href="https://pyjwt.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">pyjwt</a></span></pre><p id="3aaf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于crypto来说，<a class="ae jo" href="https://cryptography.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> cryptography </a>库是我们的JWT库的依赖。运行:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="feda" class="ld jq hi lz b fi md me l mf mg">sudo pip install cryptography</span></pre><p id="1dbb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我用一个<a class="ae jo" href="https://www.adafruit.com/product/2738" rel="noopener ugc nofollow" target="_blank">传感帽</a>来接收我的遥测数据。因为它提供了遥测传感器，有一个很好的API，并且该库预装在Pi model 3上，所以它变得很好很容易。如果您没有使用安装了它的Pi，只需运行:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="da76" class="ld jq hi lz b fi md me l mf mg">sudo apt-get install sense-hat</span></pre><p id="d556" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在你的设备应该都设置好了(负代码，后面来)。</p><h2 id="7f07" class="ld jq hi bd jr le lf lg jv lh li lj jz jb lk ll kd jf lm ln kh jj lo lp kl lq bi translated">准备谷歌云平台</h2><p id="b4a0" class="pw-post-body-paragraph iq ir hi is b it kp iv iw ix kq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">如果你以前从未这样做过，那么去谷歌的云平台<a class="ae jo" href="https://cloud.google.com" rel="noopener ugc nofollow" target="_blank">登陆页面</a>，点击“立即尝试”按钮。如果你有一个gmail地址，这是最无缝的，但如果你没有，你仍然可以这样做。你可以点击<a class="ae jo" href="https://accounts.google.com/signup/v2/webcreateaccount?flowName=GlifWebSignIn&amp;flowEntry=SignUp&amp;nogm=true" rel="noopener ugc nofollow" target="_blank">这里</a>使用任何电子邮件地址创建一个谷歌账户。</p><p id="4b48" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦账户设置完毕，前往<a class="ae jo" href="https://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank">控制台</a>。第一步是设置<a class="ae jo" href="https://console.cloud.google.com/billing" rel="noopener ugc nofollow" target="_blank">计费</a>。请记住，如果你是第一次做云项目，建立云项目会给你300美元的云积分，并且有一个慷慨的免费层，所以当你尝试时，你不太可能遇到任何付费墙。</p><p id="8f2b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一步是实现云物联网。到达目的地的方法有:</p><figure class="lu lv lw lx fd ij er es paragraph-image"><div class="er es mk"><img src="../Images/b324ff9f857e32d4ed3a231179830cb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*D7UdAAmetJPKwZMywOoQFQ.png"/></div><figcaption class="ml mm et er es mn mo bd b be z dx translated">搜索栏</figcaption></figure><p id="e4f6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1)将<code class="du mh mi mj lz b">IoT Core</code>放入控制台中的搜索栏<br/> 2)从左上角的汉堡菜单中选择它。物联网核心已接近底部。<br/> 3)点击<a class="ae jo" href="https://console.cloud.google.com/iot" rel="noopener ugc nofollow" target="_blank">该</a>链接。</p><p id="32a5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">单击启用按钮将授予默认安全规则的适当权限，以允许您的用户使用物联网核心。如果您想要手动完成，请确保您将用于物联网工作的用户拥有发布到发布/订阅的权限。物联网核心为您将设备消息桥接到发布/订阅，这意味着您需要拥有写权限。这些权限在控制台的IAM部分处理。有龙。如果你真的对谷歌云平台感到舒服，我只会建议你这么做。</p><p id="4c04" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们将创建您希望物联网设备驻留的注册表。注册表是设备的逻辑分组。因此，如果你正在做智能建筑基础设施，每个注册表可能代表一个建筑物的设备价值。</p><figure class="lu lv lw lx fd ij er es paragraph-image"><div class="er es mp"><img src="../Images/794e5d8fa14964adf646d88f78c746ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:544/format:webp/1*abNFOKDjHx9_VBKOKGO16g.png"/></div></figure><p id="c8df" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最简单的方法是从物联网核心控制台页面创建一个设备注册表，作为该过程的一部分，在它要求<code class="du mh mi mj lz b">Default telemetry topic</code>的下拉列表中，您可以选择内联创建一个发布/订阅主题。选择离你最近的地区，默认情况下它启用MQTT和HTTP协议。最简单的方法就是不去管它，除非你知道你只会使用其中一个。这篇博客中的示例代码使用了MQTT。</p><p id="4256" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们需要在物联网核心中创建设备表示。在创建注册表时打开的页面中，单击<code class="du mh mi mj lz b">Create Device</code>按钮。</p><p id="0dd6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">给它一个id，把所有选项都留下。对于SSL证书，我们将在这里用x509包装器创建一个RSA，但是如果您想查看其他选项，您可以在这里<a class="ae jo" href="https://cloud.google.com/iot/docs/how-tos/credentials/keys" rel="noopener ugc nofollow" target="_blank">看到如何创建它们</a>。确保为您创建的证书类型选择适当的单选按钮。默认情况下，选择RS256单选按钮，因此如果您只是使用下面的代码片段创建证书，请为<code class="du mh mi mj lz b">Public key format</code>选择RS256_X509单选按钮。</p><p id="97c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Raspbian的默认安装已经安装了openssl。如果您在Pi上运行一个定制的操作系统，而它没有安装openssl，那么您应该能够在Pi上运行这个操作系统，并在以后将私钥放在它上面。要创建密钥，请运行以下命令:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="9d78" class="ld jq hi lz b fi md me l mf mg">openssl req -x509 -newkey rsa:2048 -keyout demo_private.pem -nodes -out demo.pub -subj “/CN=unused”</span></pre><p id="c28d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以直接上传密钥，也可以复制/粘贴密钥的内容。设备页面上有两个单选按钮，可以选择您想要的方式。</p><p id="4278" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想上传，点击<code class="du mh mi mj lz b">Upload</code>的创建设备页面上的单选按钮。浏览并选择<code class="du mh mi mj lz b">demo.pub</code>键。向下滚动并点击<code class="du mh mi mj lz b">Create</code>按钮。然后，您应该会在注册表详细信息页面的列表中看到新创建的设备。</p><p id="265c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您在无法运行网页的设备上运行了openssl命令，请将单选按钮保持为手动，并在您的设备上运行:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="604f" class="ld jq hi lz b fi md me l mf mg">cat demo.pub</span></pre><p id="8bf4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并复制以下内容之间的所有内容(包括标签):</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="09f3" class="ld jq hi lz b fi md me l mf mg">-----BEGIN PUBLIC KEY-----</span><span id="4bf6" class="ld jq hi lz b fi mq me l mf mg">-----END PUBLIC KEY-----</span></pre><p id="bf16" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并将其粘贴到公钥值的文本框中。</p><p id="2048" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将处理来自谷歌方面的认证，确认你的设备可以与谷歌对话。最后一项安全措施是获取Google roots.pem文件，这样你的设备就知道它正在与Google对话。同样，如果可能，在Pi上，关闭Pi并将其转移过来，否则，运行:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="c0dc" class="ld jq hi lz b fi md me l mf mg">wget <a class="ae jo" href="https://pki.google.com/roots.pem" rel="noopener ugc nofollow" target="_blank">https://pki.google.com/roots.pem</a></span></pre><p id="bcd3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后一件要设置的事情。Pub/Sub是有效的，因为如果没有任何东西在监听Pub/Sub主题，任何发送到该主题的消息都不会被存储。由于订阅不会回到过去去获取信息，如果没有人在听，就没有理由存储它们。所以在云平台控制台的搜索栏中输入<code class="du mh mi mj lz b">Pub/Sub</code>，或者从汉堡菜单中选择Pub/Sub打开Pub/Sub页面。您应该至少会看到您在上面创建的主题列在这里。</p><figure class="lu lv lw lx fd ij er es paragraph-image"><div class="er es mr"><img src="../Images/9c0aacf158952ab474cbb0c6cbf20cec.png" data-original-src="https://miro.medium.com/v2/resize:fit:956/format:webp/1*Cy2QcpBW-0VinybMWuae4A.png"/></div></figure><p id="15fd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击右边的3点菜单，并选择<code class="du mh mi mj lz b">New subscription</code>。给它一个id。</p><p id="07d9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您已经完成了让您的设备与谷歌云平台对话的所有步骤。代码本身的最后几个比特。我们快到了！</p><h2 id="ed16" class="ld jq hi bd jr le lf lg jv lh li lj jz jb lk ll kd jf lm ln kh jj lo lp kl lq bi translated">密码</h2><p id="66bd" class="pw-post-body-paragraph iq ir hi is b it kp iv iw ix kq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">代码可以在我的<a class="ae jo" href="https://github.com/GabeWeiss/IoT_Core_Quick_Starts" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。01_guide.html是这篇博文的缩略版。如果你以后需要找东西，不需要在这里详细讨论，直接访问指南并挑选你需要的东西可能会更快。01_basics.py是您想要获取并运行的基本代码。正如我上面提到的，它使用Sense HAT来收集遥测数据。因此，如果你有一个，你应该能够修改代码中的变量块，指向你已经设置好的各个部分，然后运行它。</p><figure class="lu lv lw lx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/b5eee61daa28f284c67086513b826967.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*bdEoRjxL0Pxf52Y5Yjrmsg.gif"/></div></div></figure><p id="e994" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du mh mi mj lz b">ssl_private_key_filepath</code>是我们创建的密钥私有部分的完整路径:<code class="du mh mi mj lz b">demo_private.pem</code>。<code class="du mh mi mj lz b">root_cert_filepath</code>是我们使用上面的<code class="du mh mi mj lz b">wget</code>抓取的<code class="du mh mi mj lz b">roots.pem</code>的完整路径。<code class="du mh mi mj lz b">project_id</code>是您的设备注册到的Google云平台项目id。<code class="du mh mi mj lz b">gcp_location</code>是您在创建注册表时选择的区域。<code class="du mh mi mj lz b">registry_id</code>和<code class="du mh mi mj lz b">device_id</code>是你在创建这些作品时给出的id。</p><p id="dd46" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想使用Sense HAT之外的东西，那么注释掉任何对<code class="du mh mi mj lz b">sense</code>的引用，用你想用的替换。</p><p id="a545" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后一点，我已经注释掉了实际的发布代码行，所以在你开始向云中发送垃圾消息之前，你可以进行测试以确保其他一切都正常。这大约是第100行(截至发表这篇博客时)。我建议先运行，然后取消注释该行。</p><p id="8ea8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您应该可以运行了:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="4916" class="ld jq hi lz b fi md me l mf mg">python3 01_basics.py</span></pre><p id="97e9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果工作正常，您应该会在控制台上看到如下消息:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="2bd1" class="ld jq hi lz b fi md me l mf mg">on_connect: no error</span></pre><p id="d8e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="ee3b" class="ld jq hi lz b fi md me l mf mg">on_publish<br/>&lt;a json blob with temperature, pressure and humidity if using the Sense HAT&gt;</span></pre><p id="aafa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果一切正常，那么继续并取消代码中的publish行的注释，重新运行它，然后过一会儿(在Pub/Sub使用命令行SDK返回值之前有一段延迟，但实际的发布时间比这要快)您可以通过在安装了gcloud SDK的任何地方运行该命令来验证(如果没有，请转到<a class="ae jo" href="https://cloud.google.com/sdk/install" rel="noopener ugc nofollow" target="_blank">此处</a>获取安装它的说明):</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="7444" class="ld jq hi lz b fi md me l mf mg">gcloud beta pubsub subscriptions pull --auto-ack &lt;subscription id from Preparing the Google Cloud Platform section&gt;</span></pre><p id="d7e6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果一切顺利，您应该会看到您的消息出现在那里！</p><p id="926c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢您的阅读，现在将您的设备连接到云吧！想到一个项目，告诉我你的想法。</p><p id="6c67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你有任何问题，关于一个项目想法，云或物联网，或任何事情，请不要犹豫，在下面的评论中提出，或在<a class="ae jo" href="https://twitter.com/GabeWeiss_" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上联系我！</p><p id="97c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" rel="noopener" href="/@GabeWeiss/cloud-iot-step-by-step-cloud-to-device-communication-655a92d548ca">下一步:将通信从云端发送回你的设备</a>。</p></div></div>    
</body>
</html>