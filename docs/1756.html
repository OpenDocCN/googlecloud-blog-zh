<html>
<head>
<title>Cloud Run and Load balancing: go beyond your own project!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云运行和负载平衡:超越您自己的项目！</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-run-and-load-balancing-go-beyond-your-own-project-adfa1c8b001d?source=collection_archive---------0-----------------------#2021-01-15">https://medium.com/google-cloud/cloud-run-and-load-balancing-go-beyond-your-own-project-adfa1c8b001d?source=collection_archive---------0-----------------------#2021-01-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/7775ccab93bea01946555b56f30249bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VUoIGyGYAYOgzbp06i7QYg.png"/></div></div></figure><p id="7107" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">路由和负载平衡是互联网及其可扩展性的<strong class="is hj">支柱。在谷歌云上，由于部署在全球HTTPS负载平衡器上的<strong class="is hj">全球网络和选播IP </strong>，这些方面都很棒。<br/>像其他云服务一样，<strong class="is hj">无服务器计算产品</strong>(应用引擎、云功能和云运行)在几个月前已经获得了<strong class="is hj">负载平衡能力</strong>。</strong></p><p id="6a53" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最有趣的负载均衡特性之一是<strong class="is hj">将流量</strong>从负载均衡器路由到离用户位置最近的部署服务<strong class="is hj">的能力。从而无论用户在哪里，都具有最佳的等待时间。</strong></p><h1 id="4792" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">用于无服务器负载平衡的无服务器NEG</h1><p id="b6c9" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">为此，如<a class="ae kr" href="https://cloud.google.com/load-balancing/docs/https/setting-up-https-serverless" rel="noopener ugc nofollow" target="_blank">文档</a>、<a class="ae kr" href="https://cloud.google.com/blog/products/networking/better-load-balancing-for-app-engine-cloud-run-and-functions" rel="noopener ugc nofollow" target="_blank">博客</a>和<a class="ae kr" href="https://ahmet.im/blog/cloud-run-multi-region/" rel="noopener ugc nofollow" target="_blank">文章</a>中所述，您必须使用<strong class="is hj">无服务器NEG </strong>(网络端点组)并将部署在不同地区的服务添加到其中。</p><p id="4b2d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用无服务器NEG作为负载平衡器后端，享受！</p></div><div class="ab cl ks kt gp ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="hb hc hd he hf"><p id="5b19" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当所有的服务和<strong class="is hj">负载均衡器被部署在同一个项目</strong>中时，这种情况是完美的。并且<a class="ae kr" href="https://cloud.google.com/load-balancing/docs/negs/serverless-neg-concepts#limitations" rel="noopener ugc nofollow" target="_blank">无服务器负仅符合这种情况</a></p><blockquote class="kz la lb"><p id="c010" class="iq ir lc is b it iu iv iw ix iy iz ja ld jc jd je le jg jh ji lf jk jl jm jn hb bi translated">使用无服务器NEG后端的负载平衡器必须在与NEG指向的云运行(完全受管)、App Engine或云功能服务相同的项目中创建。</p></blockquote><p id="eebd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，<strong class="is hj">现实往往不同</strong>。有时，出于不同的原因，您需要<strong class="is hj">重用其他项目的服务</strong>:</p><ul class=""><li id="232e" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated"><strong class="is hj">账单约束</strong>:每个项目都需要有自己的账单，因为在某些用例中标签是不够的。</li><li id="b894" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated"><strong class="is hj">团队组织和部署速度</strong>:通常是一个数据科学家团队，为一个或几个web团队可用的模型服务</li><li id="9857" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated"><strong class="is hj">安全隔离:</strong>具有IAM策略的最小特权原则</li></ul><p id="1af0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云运行尤其如此，因为我们开发的越来越多的服务都托管在云上。</p><blockquote class="lu"><p id="b447" class="lv lw hi bd lx ly lz ma mb mc md jn dx translated">如何将负载平衡器与部署在其他项目中的云运行服务结合使用？</p></blockquote><h1 id="ca5f" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz me kb kc kd mf kf kg kh mg kj kk kl bi translated">互联网负面解决方案</h1><p id="6edc" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">最近又推出了一种新型NEG:<a class="ae kr" href="https://cloud.google.com/load-balancing/docs/negs/internet-neg-concepts" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">互联网NEG </strong> </a>。它的目的是将来自全局HTTPs负载平衡器的请求<strong class="is hj">路由到一个互联网端点</strong>，该端点由它的IP或完全限定的域名定义。</p><p id="d439" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，这符合我的使用案例！我们可以使用互联网NEG对外调用它，而不是用无服务器NEG在内部调用云运行服务。</p><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mh"><img src="../Images/39b133284148a4fdfca3c8d077743577.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h1A9zATGKzKZPgM0P1bxUQ.png"/></div></div></figure><p id="554f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们走吧！</p><h2 id="8ff9" class="mm jp hi bd jq mn mo mp ju mq mr ms jy jb mt mu kc jf mv mw kg jj mx my kk mz bi translated">创建hello world云运行</h2><ul class=""><li id="bb11" class="lg lh hi is b it km ix kn jb na jf nb jj nc jn ll lm ln lo bi translated">在菜单中，转到云运行</li><li id="6217" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">点击<code class="du nd ne nf ng b">CREATE SERVICE</code></li><li id="1cd1" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">说出它的名字，选择你的地区。在步骤2中，使用示例容器</li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nh"><img src="../Images/e6ca64141f8ad29ba2736cf3888ab070.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4z_yzfB8-g09svdDGrtQ-A.png"/></div></div></figure><ul class=""><li id="3b42" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">最后，允许未经验证的连接，以便于测试</li></ul><p id="7f33" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以，现在，<strong class="is hj">获取服务URL </strong>，如果你想测试的话。请保留这个网址，我们以后会用到它。</p><h2 id="9235" class="mm jp hi bd jq mn mo mp ju mq mr ms jy jb mt mu kc jf mv mw kg jj mx my kk mz bi translated">创建一个互联网负</h2><ul class=""><li id="36e7" class="lg lh hi is b it km ix kn jb na jf nb jj nc jn ll lm ln lo bi translated">在菜单中，进入<code class="du nd ne nf ng b">Compute Engine</code> - &gt; <code class="du nd ne nf ng b">Network endpoint groups</code></li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div class="er es ni"><img src="../Images/0aeedccafcc890fcf7281d8df83d4542.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*49d1S7-IqUaHgjahp-XSrg.png"/></div></figure><ul class=""><li id="a450" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">点击<code class="du nd ne nf ng b">CREATE NETWORK ENDPOINT GROUP</code></li><li id="dfc9" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">说出它的名字，并选择一个<code class="du nd ne nf ng b">Network Endpoint Group (Internet)</code>类型</li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nj"><img src="../Images/9013666f8924ea1e2ffb7f007bc39d29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6nYF4YKtcYb58DFY_IXtJA.png"/></div></div></figure><ul class=""><li id="c3f1" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">然后，默认设置端口443，并在<code class="du nd ne nf ng b">Add through</code>部分选择<code class="du nd ne nf ng b">Fully qualified domain name</code>。</li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nk"><img src="../Images/ca44a3c2470b002834b67f36b14f44e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G-5iB9tMj0PVNAU3M2CFVg.png"/></div></div></figure><ul class=""><li id="eb18" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">填写您的云运行服务URL(不带<code class="du nd ne nf ng b"><a class="ae kr" href="https://)" rel="noopener ugc nofollow" target="_blank">https://</a></code> <a class="ae kr" href="https://)" rel="noopener ugc nofollow" target="_blank"> ) </a>，然后点击create</li></ul><p id="55bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">完美，现在最新，也是最大的一块，<strong class="is hj">让我们配置一个HTTPs负载均衡器</strong>。</p><h2 id="0947" class="mm jp hi bd jq mn mo mp ju mq mr ms jy jb mt mu kc jf mv mw kg jj mx my kk mz bi translated">创建全局HTTPS负载平衡器</h2><ul class=""><li id="8ee0" class="lg lh hi is b it km ix kn jb na jf nb jj nc jn ll lm ln lo bi translated">在菜单中，点击<code class="du nd ne nf ng b">Network services</code></li><li id="c209" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">点击<code class="du nd ne nf ng b">Create a load balancer</code></li><li id="6d32" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">点击<code class="du nd ne nf ng b">Start configuration</code>进行HTTPS负载平衡</li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nl"><img src="../Images/d5c0eab16255c0e82bb9a5e70df8427c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OuBiVuhm6u_eH_86FPRzEA.png"/></div></div></figure><ul class=""><li id="0c41" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">从互联网上曝光，点击以下屏幕中的<code class="du nd ne nf ng b">continue</code></li><li id="2453" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">在<code class="du nd ne nf ng b">Backend configuration</code>中，选择一个<code class="du nd ne nf ng b">Backend service</code>和<code class="du nd ne nf ng b">Create a backend service</code></li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nm"><img src="../Images/1affe17de17c70dbc6d9b54dd58f0c64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U8q_k2QORGHkVBeh6oVLpw.png"/></div></div></figure><ul class=""><li id="4341" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">在新的屏幕上，命名你的后端，选择<code class="du nd ne nf ng b">Internet network endpoint group</code></li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div class="er es nn"><img src="../Images/0ee0e22d270a26f5e79afe67f66e310b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*Zgpet3QFlKqgg1UvN6VlLw.png"/></div></figure><ul class=""><li id="4f47" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">选择HTTPS协议来调用您的云运行服务以及您之前创建的互联网网络端点组的名称</li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es no"><img src="../Images/67a502a296a52a821ff5b0cefd4aef69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SNfoCaVzDEio578r3NGM1g.png"/></div></div></figure><ul class=""><li id="4af1" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">点击底部的<code class="du nd ne nf ng b">Create</code></li></ul><p id="369f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">后端到此结束！</strong>让我们继续配置<br/> <em class="lc">让主机和路径规则保持原样，转到前端配置</em></p><ul class=""><li id="e87e" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">命名并选择您的协议。<em class="lc">您可以选择HTTPS，但是HTTP也可以工作，而且配置更容易(无需管理证书和DNS)。</em></li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es np"><img src="../Images/ade9086bc82fd126af6c603cc7d60d4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Q0wGSJ-wXdYydXE1P6GJQ.png"/></div></div></figure><ul class=""><li id="07ba" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">使用最简单的配置，然后单击create。</li></ul><p id="f079" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在负载平衡器正在创建；等待几分钟以完成并<strong class="is hj">在全球范围内分发配置</strong>。</p></div><div class="ab cl ks kt gp ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="hb hc hd he hf"><p id="c3dd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">考验的时候到了！回到您的负载平衡器并复制IPv4。</p><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nq"><img src="../Images/ea62164c1cc1bf2565a87182a2fd6232.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fFaGWik7cK8rsInJ22CRLQ.png"/></div></div></figure><p id="be70" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将其粘贴到您的浏览器中..<strong class="is hj">失败！！！是失败，这个解决方案行不通！<br/> </strong>你应该有一个404，这个不会变。</p><h1 id="146d" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">云运行路由</h1><p id="6e49" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">问题来自<strong class="is hj">云运行路由模式</strong>。云运行服务提供的URL没有绑定到IP或CNAME，<strong class="is hj">路由基于请求头</strong>的 <code class="du nd ne nf ng b"><strong class="is hj">host</strong></code> <strong class="is hj">值。</strong></p><p id="2031" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">令人惊讶的是，<strong class="is hj">让我们验证一下这个</strong>，并直接在云运行的根域<code class="du nd ne nf ng b">run.app</code>上用<code class="du nd ne nf ng b">curl</code>试试。我们将只在<code class="du nd ne nf ng b">host</code>头中添加云运行服务完全限定名(URL不带<code class="du nd ne nf ng b"><a class="ae kr" href="https://)" rel="noopener ugc nofollow" target="_blank">https://</a></code> <a class="ae kr" href="https://)" rel="noopener ugc nofollow" target="_blank"> ) </a></p><pre class="mi mj mk ml fd nr ng ns nt aw nu bi"><span id="8457" class="mm jp hi ng b fi nv nw l nx ny">curl -H "host: &lt;Cloud Run fully qualified name&gt;" https://run.app</span></pre><p id="945c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">管用！！</strong>是的，通过该解决方案，您可以访问任何云运行服务，您只需知道服务的确切URL名称。事实上，这并不奇怪，因为Kubernetes和Knative的工作原理是一样的。</p></div><div class="ab cl ks kt gp ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="hb hc hd he hf"><p id="08c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在<strong class="is hj">我们知道了路由模式</strong>，我们可以回到之前的配置，重新审视这个问题:</p><blockquote class="lu"><p id="d4b0" class="lv lw hi bd lx ly lz ma mb mc md jn dx translated">请求头中的<code class="du nd ne nf ng b">host</code>是负载平衡器的IP地址(或者您自己的域名，如果您设置了它的话)。</p></blockquote><p id="598c" class="pw-post-body-paragraph iq ir hi is b it nz iv iw ix oa iz ja jb ob jd je jf oc jh ji jj od jl jm jn hb bi translated">因此，为了解决这个问题，我们必须用后端自定义头文件覆盖<a class="ae kr" href="https://cloud.google.com/load-balancing/docs/custom-headers" rel="noopener ugc nofollow" target="_blank">负载平衡器的后端配置中的<strong class="is hj">头文件</strong> <code class="du nd ne nf ng b"><strong class="is hj">host</strong></code> <strong class="is hj">。</strong></a></p><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es oe"><img src="../Images/16e2e1e2858c5ea0065931ed6a1c9b57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RoJd__Hv7kkWVuu1FU70zQ.png"/></div></div></figure><h2 id="ee13" class="mm jp hi bd jq mn mo mp ju mq mr ms jy jb mt mu kc jf mv mw kg jj mx my kk mz bi translated">后端自定义标题</h2><ul class=""><li id="f949" class="lg lh hi is b it km ix kn jb na jf nb jj nc jn ll lm ln lo bi translated">回到负载均衡器，编辑它，然后回到你的后端。</li><li id="1ee8" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">在底部，点击<code class="du nd ne nf ng b">Advanced configuration</code></li><li id="3c2a" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">然后点击<code class="du nd ne nf ng b">Add header</code></li><li id="b0e2" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">并添加<code class="du nd ne nf ng b">host</code>作为键，以及云运行服务的全限定名作为值</li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div class="er es of"><img src="../Images/177b452ff15844737edf48c335486ec5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/1*2H3VpxupoEmTJ6IX-IZKCw.png"/></div></figure><ul class=""><li id="1d77" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">并点击<code class="du nd ne nf ng b">Update</code></li><li id="06f5" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">在负载平衡器编辑页面的<code class="du nd ne nf ng b">Update</code>上再次点击</li></ul><p id="b24b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里，再次等待几分钟，等待配置广告。并再次测试您的IP。</p><p id="0395" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">嘣！这下有用了。！</strong></p><blockquote class="lu"><p id="2185" class="lv lw hi bd lx ly lz ma mb mc md jn dx translated">这对于1个服务来说很好，但对于几个云运行服务来说怎么办呢？</p></blockquote><h1 id="17c7" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz me kb kc kd mf kf kg kh mg kj kk kl bi translated">多云运行服务路由</h1><p id="44d5" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">当您有几个云运行服务需要调用负载均衡器时，在相同的其他项目或不同的项目中，<strong class="is hj">直接的想法是为每个服务重复相同的模式</strong></p><ul class=""><li id="e0b2" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">创建一个互联网负</li><li id="914f" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">创建后端</li><li id="be89" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">自定义主机和路径规则</li></ul><p id="2ee9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">实际上，你不需要为每项服务创建一个网络负数，你可以作弊！</p><p id="0880" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">事实上，因为<strong class="is hj">所有的云运行服务请求都位于</strong> <code class="du nd ne nf ng b"><strong class="is hj">https://run.app</strong></code> <strong class="is hj"> URL </strong>上，所以您可以只创建<strong class="is hj">一个互联网NEG </strong>，并在多个后端定义中使用它，其中您只<strong class="is hj">定制</strong> <code class="du nd ne nf ng b"><strong class="is hj">host</strong></code> <strong class="is hj">请求的头部，以将流量路由到正确的云运行服务</strong>。</p><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es oe"><img src="../Images/79f82801540b0d48f858d854a671f80f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8rW5BZopmrZBCIw78_op6Q.png"/></div></div></figure><p id="341c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们部署这个！</p><h2 id="fdec" class="mm jp hi bd jq mn mo mp ju mq mr ms jy jb mt mu kc jf mv mw kg jj mx my kk mz bi translated">创建新服务</h2><p id="a3a0" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">像前面一样，首先创建一个新的云运行服务。您可以使用相同的示例容器图像。</p><p id="13ba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">获取URL，我们稍后会用到它</p><h2 id="bfca" class="mm jp hi bd jq mn mo mp ju mq mr ms jy jb mt mu kc jf mv mw kg jj mx my kk mz bi translated">更新您的"<em class="og"> generic" </em> Internet NEG</h2><ul class=""><li id="f3c5" class="lg lh hi is b it km ix kn jb na jf nb jj nc jn ll lm ln lo bi translated">回去你的网络否定</li><li id="d10e" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">您不能更新当前端点。所以，选中它，点击<code class="du nd ne nf ng b">Remove endpoint</code>；确认删除</li><li id="afac" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">并点击<code class="du nd ne nf ng b">Add network endpoint</code>。</li><li id="cc93" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">简单地添加值:<code class="du nd ne nf ng b">run.app</code></li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es oh"><img src="../Images/0cf134d2bad0d9b0589193d1287755a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mnZ8qP61-ScTUq7EuyiwuQ.png"/></div></div></figure><ul class=""><li id="f8e3" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">并点击<code class="du nd ne nf ng b">Create</code></li></ul><p id="9f34" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lc">什么也没有出现。等待几秒钟，创建结束，您的端点出现！这是一个用户界面故障。</em></p><h2 id="fa06" class="mm jp hi bd jq mn mo mp ju mq mr ms jy jb mt mu kc jf mv mw kg jj mx my kk mz bi translated">添加第二个后端</h2><ul class=""><li id="b066" class="lg lh hi is b it km ix kn jb na jf nb jj nc jn ll lm ln lo bi translated">回到你的负载平衡器，点击<code class="du nd ne nf ng b">Edit</code>并转到后端部分。</li><li id="6a94" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated"><code class="du nd ne nf ng b">Create a backend service</code>和前面一样，选择Internet NEG类型、<code class="du nd ne nf ng b">HTTPS</code>协议，选择您的<em class="lc">通用</em> Internet NEG，然后转到<code class="du nd ne nf ng b">Advanced option</code>用您的第二个服务的云运行服务全限定名称覆盖<code class="du nd ne nf ng b">host</code>标头。</li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div class="er es oi"><img src="../Images/a8a6c01818c2cd3135f5511d143b58b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*5N3L9RsHZZWWfjP_rkyT3g.png"/></div></figure><ul class=""><li id="5dbf" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">并点击<code class="du nd ne nf ng b">Create</code></li></ul><h2 id="b373" class="mm jp hi bd jq mn mo mp ju mq mr ms jy jb mt mu kc jf mv mw kg jj mx my kk mz bi translated">自定义主机和路径规则</h2><p id="3c28" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">这种定制可能很复杂。但是我的要求是:</p><ul class=""><li id="0813" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">我想到达路径<code class="du nd ne nf ng b">/hello2</code>上的第二个云运行服务</li><li id="9d3a" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">第二个云运行服务没有路径<code class="du nd ne nf ng b">/hello2</code>。所以我需要重写<code class="du nd ne nf ng b">/</code>的路径</li></ul><p id="b61b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们来配置这个吧！</p><ul class=""><li id="1cb1" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">选择<code class="du nd ne nf ng b">Advanced host and path rule</code>单选按钮并点击<code class="du nd ne nf ng b">Add host and path rule</code></li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es oj"><img src="../Images/4e467423f41f19b0e11bbfc5ba95b8e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JunguWR2rjpRkX9YV0RV-w.png"/></div></div></figure><ul class=""><li id="0c9b" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">首先，定义主机名过滤。就我而言，我不在乎。我设定<code class="du nd ne nf ng b">*</code></li><li id="a996" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">然后，点击默认路径的铅笔，默认选择后端。<em class="lc">这一条哪答上</em> <code class="du nd ne nf ng b"><em class="lc">/</em></code> <em class="lc">路径上的负载均衡器</em></li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div class="er es ok"><img src="../Images/a1462efabfb93419b99f0697feaf68f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/1*33Sg-voHzJAVVu74ON8uCQ.png"/></div></figure><ul class=""><li id="53e8" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">还有<code class="du nd ne nf ng b">Save</code></li><li id="4eb2" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">然后，点击<code class="du nd ne nf ng b">Add path rule</code>配置第二个服务</li><li id="a448" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">添加路径，在我的例子中是<code class="du nd ne nf ng b">/hello2</code>，并选择我的第二个后端。</li><li id="dfaa" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">但是，我需要重写路径。为此，点击<code class="du nd ne nf ng b">Add-on action</code>，并在<code class="du nd ne nf ng b">Path prefix rewrite</code>上设置<code class="du nd ne nf ng b">/</code></li></ul><figure class="mi mj mk ml fd ij er es paragraph-image"><div class="er es of"><img src="../Images/492c2dc98f86738c6e0727238309435d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/1*NAKz5713Xy9rcNMBoW4oIw.png"/></div></figure><ul class=""><li id="0096" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated">并点击<code class="du nd ne nf ng b">Save</code></li><li id="7810" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">点击<code class="du nd ne nf ng b">Update</code>保存负载均衡器的新配置</li></ul></div><div class="ab cl ks kt gp ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="hb hc hd he hf"><p id="568e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">再次等待几分钟，并在<code class="du nd ne nf ng b">/</code>路径和<code class="du nd ne nf ng b">/hello2</code>路径上测试您的IP。</p><p id="8cc4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">恭喜恭喜！！！</strong>您有一个负载均衡器，在不同的项目中部署了几个云运行服务！！</p><h1 id="db5f" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">路由到最近的位置</h1><p id="34f9" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">这种配置很好，但是您失去了全局HTTPS负载平衡器的一个主要优势:将请求路由到最近位置的能力。</p><p id="ebd8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这种情况下，你必须结合</p><ul class=""><li id="5d88" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated"><strong class="is hj">无服务器NEG </strong>:用于多区域服务，作为HTTPS负载均衡器的后端，全部在同一个项目中</li><li id="a5dd" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated"><strong class="is hj">Internet NEG</strong>:外部访问多区域云运行服务的负载均衡器。</li></ul><p id="3233" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于无服务器NEG的限制，该解决方案只有在多区域云运行服务部署在同一项目上时才有效。<br/> <em class="lc">换句话说，</em> <strong class="is hj"> <em class="lc">你不能按区域</em> </strong> <em class="lc">配置一个项目。</em></p><p id="28a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，有两个主要步骤:</p><ol class=""><li id="a958" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ol lm ln lo bi translated">首先，在多区域项目中创建一个HTTPS负载平衡器。使用标准无服务器NEG。这里，使用HTTPS协议进行前端配置很重要。<br/>  <em class="lc">它的</em> <a class="ae kr" href="https://cloud.google.com/load-balancing/docs/https/setting-up-https-serverless#console_1" rel="noopener ugc nofollow" target="_blank"> <em class="lc">记载了配置</em> </a> <em class="lc">。</em></li><li id="77ba" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ol lm ln lo bi translated">然后，在另一个项目中创建另一个HTTPS负载均衡器，使用多区域HTTPS负载均衡器的IP或域名的<strong class="is hj"> Internet NEG。<br/> <em class="lc">这一次，不需要覆盖</em> <code class="du nd ne nf ng b"><em class="lc">host</em></code> <em class="lc">请求的头值，因为您不直接访问云运行服务，而只是另一个负载平衡器，它将通过无服务器NEG自动执行此操作。</em></strong></li></ol><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es om"><img src="../Images/eaad127513972334dd88ec8f14a52375.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AYWrXqLaeARxDtmidE7vkg.png"/></div></div></figure><p id="d37a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为因特网NEG和多区域HTTPS负载平衡器之间的通信是通过因特网进行的，所以在文档中强烈建议使用<a class="ae kr" href="https://cloud.google.com/load-balancing/docs/negs/internet-neg-concepts#backend_service" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">【HTTPS】</strong></a><strong class="is hj"/></p><blockquote class="kz la lb"><p id="1653" class="iq ir lc is b it iu iv iw ix iy iz ja ld jc jd je le jg jh ji lf jk jl jm jn hb bi translated">我们强烈建议您在使用互联网NEG配置后端服务时使用<strong class="is hj"> HTTPS </strong>或<strong class="is hj"> HTTP/2 </strong>作为协议，以便在通过公共互联网时，外部HTTP(S)负载平衡器和您的后端之间的通信得到加密和认证。</p></blockquote><h1 id="5348" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">超越极限！</h1><p id="a036" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">即使这些解决方案看起来很容易实现和使用，重要的是要记住每一跳(通过负载均衡器)意味着:</p><ul class=""><li id="4f1c" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated"><strong class="is hj">潜伏期</strong>，甚至几毫秒。</li><li id="5242" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated">您的架构中新的可能的<strong class="is hj">故障点</strong></li><li id="9275" class="lg lh hi is b it lp ix lq jb lr jf ls jj lt jn ll lm ln lo bi translated"><strong class="is hj">负载平衡器的额外成本</strong></li></ul><p id="85f2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最终，由于互联网NEG的能力，无服务器NEG的仅限于项目的限制不再是限制。通过负载平衡器、请求头和URL映射的组合，<strong class="is hj">有可能解决所有用例</strong>！</p></div></div>    
</body>
</html>