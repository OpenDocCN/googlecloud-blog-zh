<html>
<head>
<title>Kubernetes Engine (GKE) multi-cluster life cycle management series</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes发动机(GKE)多集群生命周期管理系列</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/kubernetes-engine-gke-multi-cluster-life-cycle-management-series-ee0f583d9b10?source=collection_archive---------2-----------------------#2020-04-22">https://medium.com/google-cloud/kubernetes-engine-gke-multi-cluster-life-cycle-management-series-ee0f583d9b10?source=collection_archive---------2-----------------------#2020-04-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="4ff1" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">第五部分:使用Ingress for Anthos的GKE多集群升级分步教程</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/7b5154b4b1b907ff3cd9594b6229f76a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2nN1m2qz6tLu_xk4fsKy0g.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">使用Ingress for Anthos进行GKE生命周期管理</figcaption></figure><p id="7d40" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">本教程描述了如何使用滚动升级策略(在之前的博客中讨论过)和Anthos 的<a class="ae kj" href="https://cloud.google.com/kubernetes-engine/docs/concepts/ingress-for-anthos" rel="noopener ugc nofollow" target="_blank"> ingress提供的多集群Ingress特性来升级多集群GKE环境。本教程是本博客系列所涵盖的概念的高潮。</a></p><p id="13ec" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">GCP推荐使用<a class="ae kj" href="https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-upgrades#upgrading_automatically" rel="noopener ugc nofollow" target="_blank"> GKE自动升级</a>功能来升级你的GKE集群。自动升级是一种无操作的方式，可以让您的集群(主集群和节点集群)按照GCP确定的发布计划自动更新。这不需要操作员的干预。但是，在某些情况下，运营商可能希望对升级集群的方式和时间有更多的控制。本教程介绍了一种升级多个集群的方法，其中您的应用程序在所有集群上运行。然后，它利用Anthos的入口(多集群入口)功能在升级前一次清空一个集群。</p><h1 id="518c" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">先决条件</h1><ol class=""><li id="3b57" class="lc ld hi jp b jq le jt lf jw lg ka lh ke li ki lj lk ll lm bi translated">本教程要求多个集群(两个或更多)在所有集群上运行相同的应用程序(名称空间、部署、服务等)。</li><li id="d583" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lj lk ll lm bi translated">本教程假设要升级的集群的自动升级功能已关闭。</li><li id="4ab3" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lj lk ll lm bi translated">本教程使用Anthos的入口。Anthos的入口要求:</li></ol><ul class=""><li id="d83b" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">gke静态版本1.14.10-gke.17+或GKE集群在快速或常规<a class="ae kj" href="https://cloud.google.com/kubernetes-engine/docs/concepts/release-channels" rel="noopener ugc nofollow" target="_blank">发布渠道</a>。</li><li id="513c" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">VPC本地(别名IP)模式下的集群。有关更多信息，请参见<a class="ae kj" href="https://cloud.google.com/kubernetes-engine/docs/how-to/alias-ips" rel="noopener ugc nofollow" target="_blank">创建VPC本地集群</a>。</li><li id="d749" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">启用HTTP负载平衡(默认情况下启用)。</li><li id="50f5" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">gcloud —版本必须是281或更高版本。GKE集群注册步骤取决于此版本或更高版本。</li></ul><h1 id="8dc6" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">拓扑学</h1><p id="6063" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">本教程使用以下拓扑。总共有三个集群。两个集群(蓝色和绿色)充当部署了相同应用程序的相同集群。一个群集(入口配置)充当控制平面群集，为Anthos配置入口。在本教程中，您将在两个应用程序集群(蓝色和绿色集群)上部署一个名为Hipster Shop应用程序的示例应用程序。<a class="ae kj" href="https://github.com/GoogleCloudPlatform/microservices-demo" rel="noopener ugc nofollow" target="_blank"> Hipster Shop </a> app是一个示例微服务应用程序，由十个模拟电子商务应用程序的微服务组成。它由一个web前端(客户端可以访问)和一些后端服务组成，例如购物车、产品目录和推荐服务，模拟了一个云原生电子零售商。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/7b5154b4b1b907ff3cd9594b6229f76a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2nN1m2qz6tLu_xk4fsKy0g.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">使用Ingress for Anthos进行GKE生命周期管理</figcaption></figure><h1 id="cce2" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">目标</h1><ul class=""><li id="57be" class="lc ld hi jp b jq le jt lf jw lg ka lh ke li ki lv lk ll lm bi translated">创建三个GKE集群。</li><li id="bfe3" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">将集群注册到GKE中心。</li><li id="2f64" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">将一个GKE集群(入口配置)配置为中央配置集群。该集群充当多集群入口的控制平面。它为Anthos创建和管理入口资源。</li><li id="9a3c" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">将一个示例应用程序部署到其他GKE集群。使用<a class="ae kj" href="https://github.com/GoogleCloudPlatform/microservices-demo" rel="noopener ugc nofollow" target="_blank">潮人店</a> app作为示例应用。</li><li id="4868" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">为Anthos配置入口，将客户端流量发送到运行在两个应用程序集群上的Hipster Shop。</li><li id="5d89" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">设置一个负载生成器到Hipster Shop app，用云监控配置监控。</li><li id="7e6f" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">从多集群入口移除(排出)一个应用集群。</li><li id="dd5f" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">升级耗尽的集群。</li><li id="bc4a" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">使用Anthos的Ingress将流量溢出回新升级的集群。</li></ul><h1 id="d119" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">费用</h1><p id="c048" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">本教程使用谷歌云平台的以下收费组件:</p><ul class=""><li id="0292" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">GKE</li><li id="2f57" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">建立工作关系网</li><li id="a6a7" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">负载平衡</li><li id="8173" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">云监控</li></ul><p id="8529" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">使用<a class="ae kj" href="https://cloud.google.com/products/calculator" rel="noopener ugc nofollow" target="_blank">定价计算器</a>根据您的预计使用量生成成本估算。</p><h1 id="441b" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">开始之前</h1><ul class=""><li id="7f04" class="lc ld hi jp b jq le jt lf jw lg ka lh ke li ki lv lk ll lm bi translated">选择或创建一个GCP项目。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="ff31" class="me kl hi ma b fi mf mg l mh mi"><a class="ae kj" href="https://console.cloud.google.com/cloud-resource-manager" rel="noopener ugc nofollow" target="_blank">GO TO THE MANAGE RESOURCES PAGE</a></span></pre><ul class=""><li id="913b" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">为您的项目启用计费。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="4e28" class="me kl hi ma b fi mf mg l mh mi"><a class="ae kj" href="https://support.google.com/cloud/answer/6293499#enable-billing" rel="noopener ugc nofollow" target="_blank">ENABLE BILLING</a></span></pre><ul class=""><li id="133e" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">您可以从Cloud Shell运行本教程中的所有终端命令。打开云壳:</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="33ce" class="me kl hi ma b fi mf mg l mh mi"><a class="ae kj" href="https://console.cloud.google.com/?cloudshell=true" rel="noopener ugc nofollow" target="_blank">OPEN CLOUD SHELL</a></span></pre><ul class=""><li id="306f" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">设置您的默认项目。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="8d2b" class="me kl hi ma b fi mf mg l mh mi">export PROJECT=$(gcloud info --format='value(config.project)')<br/>gcloud config set project ${PROJECT}</span></pre><ul class=""><li id="1b98" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">在项目中启用GKE、GKE中心和multiclusteringress APIs。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="62b1" class="me kl hi ma b fi mf mg l mh mi">gcloud services enable container.googleapis.com gkehub.googleapis.com multiclusteringress.googleapis.com</span></pre><p id="f6c1" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">完成本教程后，您可以通过删除您创建的资源来避免继续计费。详见<a class="ae kj" href="https://docs.google.com/document/d/1vaelwoytZYoZ5WvyzwdksRTysig0bncoThU9I-T0In0/edit#heading=h.mlrdlgcohh7k" rel="noopener ugc nofollow" target="_blank">清理</a>。</p><h1 id="204c" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">设置环境</h1><p id="f33a" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">您可以从Cloud Shell运行本教程中的所有终端命令。</p><ul class=""><li id="8ec0" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">打开云壳:</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="3d3f" class="me kl hi ma b fi mf mg l mh mi"><a class="ae kj" href="https://console.cloud.google.com/?cloudshell=true" rel="noopener ugc nofollow" target="_blank">OPEN CLOUD SHELL</a></span></pre><ul class=""><li id="9766" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">克隆repo以获得本教程的文件。创建工作目录。这样，您可以在本教程结束时删除工作目录。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="047a" class="me kl hi ma b fi mf mg l mh mi">cd ${HOME}<br/>git clone <a class="ae kj" href="https://github.com/ameer00/gke-multicluster-upgrades.git" rel="noopener ugc nofollow" target="_blank">https://github.com/ameer00/gke-multicluster-upgrades.git</a></span><span id="941d" class="me kl hi ma b fi mj mg l mh mi">cd gke-multicluster-upgrades<br/>export WORKDIR=`pwd`</span></pre><h1 id="2f4e" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">创建GKE集群并将其注册到GKE中心</h1><h2 id="6d49" class="me kl hi bd km mk ml mm kq mn mo mp ku jw mq mr kw ka ms mt ky ke mu mv la mw bi translated">创建GKE集群</h2><ul class=""><li id="066a" class="lc ld hi jp b jq le jt lf jw lg ka lh ke li ki lv lk ll lm bi translated">创建三个GKE集群。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="51dd" class="me kl hi ma b fi mf mg l mh mi">gcloud container clusters create ingress-config --zone us-west1-a --num-nodes=3 --enable-ip-alias --async</span><span id="55fc" class="me kl hi ma b fi mj mg l mh mi">gcloud container clusters create blue --zone us-west1-b --num-nodes=4 --enable-ip-alias --async</span><span id="175d" class="me kl hi ma b fi mj mg l mh mi">gcloud container clusters create green --zone us-west1-c --num-nodes=4 --enable-ip-alias</span></pre><ul class=""><li id="95ef" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">等待几分钟，直到成功创建所有集群。确保集群正在运行:</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="2e54" class="me kl hi ma b fi mf mg l mh mi">gcloud container clusters list</span><span id="e545" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)</em></span><span id="49ca" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">NAME LOCATION MASTER_VERSION MASTER_IP MACHINE_TYPE NODE_VERSION NUM_NODES STATUS</em></span><span id="7eac" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">ingress-config us-west1-a 1.14.10-gke.24 35.203.165.186 n1-standard-1 1.14.10-gke.24 3 </em><strong class="ma hj"><em class="mx">RUNNING</em></strong></span><span id="9e09" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">blue us-west1-b 1.14.10-gke.24 34.82.76.141 n1-standard-1 1.14.10-gke.24 4 </em><strong class="ma hj"><em class="mx">RUNNING</em></strong></span><span id="a2bb" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">green us-west1-c 1.14.10-gke.17 35.197.46.200 n1-standard-1 1.14.10-gke.17 4 </em><strong class="ma hj"><em class="mx">RUNNING</em></strong></span></pre><blockquote class="my mz na"><p id="6991" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">主/节点版本和IP地址可能不同。</p></blockquote><ul class=""><li id="061a" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">创建一个新的<a class="ae kj" href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/" rel="noopener ugc nofollow" target="_blank"> kubeconfig </a>文件，并连接到所有集群以在kubeconfig文件中生成条目:</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="618b" class="me kl hi ma b fi mf mg l mh mi">touch gke-upgrade-kubeconfig<br/>export KUBECONFIG=gke-upgrade-kubeconfig</span><span id="7508" class="me kl hi ma b fi mj mg l mh mi">gcloud container clusters get-credentials ingress-config --zone us-west1-a --project ${PROJECT}</span><span id="e471" class="me kl hi ma b fi mj mg l mh mi">gcloud container clusters get-credentials blue --zone us-west1-b --project ${PROJECT}<br/>gcloud container clusters get-credentials green --zone us-west1-c --project ${PROJECT}</span></pre><p id="7053" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">您可以使用kubeconfig文件通过为每个集群创建一个用户和上下文来创建集群的身份验证。创建kubeconfig文件后，可以在集群之间快速切换上下文。</p><ul class=""><li id="e308" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">验证kubeconfig文件中有三个集群:</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="2f60" class="me kl hi ma b fi mf mg l mh mi">kubectl config view -ojson | jq -r '.clusters[].name'</span><span id="2bd5" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>gke_gke-multicluster-upgrades_us-west1-a_</em><strong class="ma hj"><em class="mx">ingress-config</em></strong></span><span id="91f0" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">gke_gke-multicluster-upgrades_us-west1-b_</em><strong class="ma hj"><em class="mx">blue</em></strong></span><span id="88f2" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">gke_gke-multicluster-upgrades_us-west1-c_</em><strong class="ma hj"><em class="mx">green</em></strong></span></pre><ul class=""><li id="2345" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">获取三个集群的上下文以备后用。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="968a" class="me kl hi ma b fi mf mg l mh mi">export INGRESS_CONFIG_CLUSTER=$(kubectl config view -ojson | jq -r '.clusters[].name' | grep ingress-config)<br/>export BLUE_CLUSTER=$(kubectl config view -ojson | jq -r '.clusters[].name' | grep blue)<br/>export GREEN_CLUSTER=$(kubectl config view -ojson | jq -r '.clusters[].name' | grep green)<br/>echo -e "${INGRESS_CONFIG_CLUSTER}\n${BLUE_CLUSTER}\n${GREEN_CLUSTER}"</span><span id="a6de" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>gke_gke-multicluster-upgrades_us-west1-a_ingress-config</em></span><span id="d6d8" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">gke_gke-multicluster-upgrades_us-west1-b_blue</em></span><span id="e081" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">gke_gke-multicluster-upgrades_us-west1-c_green</em></span></pre><h2 id="cd04" class="me kl hi bd km mk ml mm kq mn mo mp ku jw mq mr kw ka ms mt ky ke mu mv la mw bi translated">将GKE集群注册到GKE中心</h2><p id="312b" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">GKE中心使您能够在混合环境中运行您的Kubernetes集群。GKE中心还支持已注册的集群使用高级GKE功能，例如Anthos的入口。您需要一个GCP服务帐户(SA)来将GKE集群注册到GKE中心。请允许我向GCP SA注册到GKE中心。</p><ul class=""><li id="5fb5" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">创建GCP服务帐户并下载其凭据以用于注册群集。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="2398" class="me kl hi ma b fi mf mg l mh mi">gcloud iam service-accounts create ingress-svc-acct</span><span id="5f2b" class="me kl hi ma b fi mj mg l mh mi">gcloud projects add-iam-policy-binding ${PROJECT} \</span><span id="438d" class="me kl hi ma b fi mj mg l mh mi">--member="serviceAccount:ingress-svc-acct@${PROJECT}.iam.gserviceaccount.com" \</span><span id="6089" class="me kl hi ma b fi mj mg l mh mi">--role="roles/gkehub.connect"<br/></span><span id="686c" class="me kl hi ma b fi mj mg l mh mi">gcloud iam service-accounts keys \</span><span id="9058" class="me kl hi ma b fi mj mg l mh mi">create ${WORKDIR}/ingress-svc-acct.json \</span><span id="0e5b" class="me kl hi ma b fi mj mg l mh mi">--iam-account=ingress-svc-acct@${PROJECT}.iam.gserviceaccount.com</span></pre><ul class=""><li id="8510" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">从GKE星团中获取URIs。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="9668" class="me kl hi ma b fi mf mg l mh mi">export INGRESS_CONFIG_URI=$(gcloud container clusters list --uri | grep ingress-config)<br/>export BLUE_URI=$(gcloud container clusters list --uri | grep blue)<br/>export GREEN_URI=$(gcloud container clusters list --uri | grep green)<br/>echo -e "${INGRESS_CONFIG_URI}\n${BLUE_URI}\n${GREEN_URI}"</span><span id="1be9" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>https://container.googleapis.com/v1/projects/gke-multicluster-upgrades/zones/us-west1-a/clusters/ingress-config</em></span><span id="7e1d" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">https://container.googleapis.com/v1/projects/gke-multicluster-upgrades/zones/us-west1-b/clusters/blue</em></span><span id="eab1" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">https://container.googleapis.com/v1/projects/gke-multicluster-upgrades/zones/us-west1-c/clusters/green</em></span></pre><ul class=""><li id="0cad" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">将三个集群注册到GKE中心。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="d2ee" class="me kl hi ma b fi mf mg l mh mi">gcloud container hub memberships register ingress-config \</span><span id="1017" class="me kl hi ma b fi mj mg l mh mi"> --project=${PROJECT} \</span><span id="a916" class="me kl hi ma b fi mj mg l mh mi"> --gke-uri=${INGRESS_CONFIG_URI} \</span><span id="1924" class="me kl hi ma b fi mj mg l mh mi"> --service-account-key-file=${WORKDIR}/ingress-svc-acct.json</span><span id="69f6" class="me kl hi ma b fi mj mg l mh mi">gcloud container hub memberships register blue \</span><span id="4b8c" class="me kl hi ma b fi mj mg l mh mi"> --project=${PROJECT} \</span><span id="aae6" class="me kl hi ma b fi mj mg l mh mi"> --gke-uri=${BLUE_URI} \</span><span id="4395" class="me kl hi ma b fi mj mg l mh mi"> --service-account-key-file=${WORKDIR}/ingress-svc-acct.json</span><span id="6dd0" class="me kl hi ma b fi mj mg l mh mi">gcloud container hub memberships register green \</span><span id="9fe9" class="me kl hi ma b fi mj mg l mh mi"> --project=${PROJECT} \</span><span id="1635" class="me kl hi ma b fi mj mg l mh mi"> --gke-uri=${GREEN_URI} \</span><span id="142b" class="me kl hi ma b fi mj mg l mh mi"> --service-account-key-file=${WORKDIR}/ingress-svc-acct.json</span></pre><ul class=""><li id="b104" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">验证集群是否已注册。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="153f" class="me kl hi ma b fi mf mg l mh mi">gcloud container hub memberships list</span><span id="e607" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>NAME EXTERNAL_ID</em></span><span id="ab8c" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">blue d40521d9–693f-11ea-a26c-42010a8a0010</em></span><span id="ce3e" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">green d3027ecd-693f-11ea-ad5f-42010a8a00a9</em></span><span id="d32c" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">ingress-config bb778338–693f-11ea-a053–42010a8a016a</em></span></pre><ul class=""><li id="ba5a" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">将ingress-config集群配置为Anthos的ingress配置集群。您可以通过GKE中心启用multiclusteringress功能来实现这一点。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="2962" class="me kl hi ma b fi mf mg l mh mi">gcloud alpha container hub features multiclusteringress enable \</span><span id="a8d7" class="me kl hi ma b fi mj mg l mh mi"> --config-membership=projects/${PROJECT}/locations/global/memberships/ingress-config</span></pre><p id="dbfc" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">运行上面的命令会将MulticlusterIngress和MulticlusterService CRDs添加到配置集群中。</p><ul class=""><li id="9e61" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">前面的命令需要几分钟才能完成。运行以下命令，验证是否已为Anthos的入口成功配置了入口群集。稍等片刻，直到看到入口配置集群的<code class="du ne nf ng ma b">code: OK</code>(如下所示)。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="7898" class="me kl hi ma b fi mf mg l mh mi">watch gcloud alpha container hub features multiclusteringress describe</span><span id="6d2f" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Wait until the output is as shown below (do not copy)<br/>createTime: ‘2020–03–18T18:13:46.530713607Z’</em></span><span id="d34c" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">featureState:</em></span><span id="a87c" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">details:</em></span><span id="cbb2" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">code: OK</em></span><span id="3fb8" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">description: Multicluster Ingress requires Anthos license enablement. Unlicensed</em></span><span id="41be" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">usage is unrestricted for the MCI Beta API. Note that licensing will be enforced</em></span><span id="c452" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">for use of the Generally Available MCI API.</em></span><span id="42df" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">detailsByMembership:</em></span><span id="8663" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">projects/960583074711/locations/global/memberships/blue:</em></span><span id="a3f3" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">code: OK</em></span><span id="7ef8" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">projects/960583074711/locations/global/memberships/green:</em></span><span id="79c6" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">code: OK</em></span><span id="cde4" class="me kl hi ma b fi mj mg l mh mi"><strong class="ma hj"><em class="mx">projects/960583074711/locations/global/memberships/ingress-config:</em></strong></span><span id="aa90" class="me kl hi ma b fi mj mg l mh mi"><strong class="ma hj"><em class="mx">code: OK</em></strong></span><span id="4f6c" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">lifecycleState: ENABLED</em></span><span id="984f" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">multiclusteringressFeatureSpec:</em></span><span id="f075" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">configMembership: projects/gke-multicluster-upgrades/locations/global/memberships/ingress-config</em></span><span id="ac13" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">name: projects/gke-multicluster-upgrades/locations/global/features/multiclusteringress</em></span></pre><blockquote class="my mz na"><p id="4899" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">当lifecycleState被标记为启用时，在您的配置群集处于正常状态之前，此功能无法使用。如果几分钟后没有看到代码:OK，请转到<a class="ae kj" href="https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-for-anthos#troubleshooting" rel="noopener ugc nofollow" target="_blank">故障排除部分</a>。当特性没有准备好时，您应该会看到下面的输出。</p></blockquote><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="7c38" class="me kl hi ma b fi mf mg l mh mi"><em class="mx">featureState:</em></span><span id="6968" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">details:</em></span><span id="830d" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">code: OK</em></span><span id="8bac" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">description: Multicluster Ingress requires Anthos license enablement. Unlicensed</em></span><span id="8373" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">usage is unrestricted for the MCI Beta API. Note that licensing will be enforced</em></span><span id="91be" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">for use of the Generally Available MCI API.</em></span><span id="592d" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">lifecycleState: ENABLED</em></span><span id="cc1f" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">multiclusteringressFeatureSpec:</em></span><span id="550f" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">configMembership: projects/qwiklabs-gcp-6dbb2ce9d43a8ef1/locations/global/memberships/ingress-config</em></span><span id="db68" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">name: projects/qwiklabs-gcp-6dbb2ce9d43a8ef1/locations/global/features/multiclusteringress</em></span><span id="3f6f" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">updateTime: ‘2020–03–23T15:55:36.087585371Z’</em></span></pre><p id="65fa" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在Macbook上按下<strong class="jp hj"> CTRL-C </strong>或<strong class="jp hj"> CMD-C </strong>退出手表命令。</p><h1 id="08b2" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">将潮人商店应用部署到蓝色和绿色集群</h1><ul class=""><li id="1b93" class="lc ld hi jp b jq le jt lf jw lg ka lh ke li ki lv lk ll lm bi translated">将Hipster Shop应用程序部署到蓝色和绿色集群。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="64b2" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${BLUE_CLUSTER} apply -f ${WORKDIR}/hipster-shop<br/>kubectl --context ${GREEN_CLUSTER} apply -f ${WORKDIR}/hipster-shop</span></pre><ul class=""><li id="345e" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">等待几分钟，确保所有pod都在蓝色和绿色集群中运行。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="e274" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${BLUE_CLUSTER} get pods<br/>kubectl --context ${GREEN_CLUSTER} get pods</span><span id="3a6f" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>NAME READY STATUS RESTARTS AGE</em></span><span id="8518" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">adservice-86f5dfb995-nlm5w 1/1 Running 0 10m</em></span><span id="8248" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">cartservice-76cf9686b6-rxf7b 1/1 Running 0 10m</em></span><span id="0cca" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">checkoutservice-7766b946f5-qszvc 1/1 Running 0 10m</em></span><span id="13ba" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">currencyservice-76975c7847-vmwn7 1/1 Running 0 10m</em></span><span id="afe2" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">emailservice-c55cd96f-74rxs 1/1 Running 0 10m</em></span><span id="5872" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">frontend-f4b7cd95-lk4k8 1/1 Running 0 10m</em></span><span id="4c84" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">loadgenerator-6784bc5f77-bkx4c 1/1 Running 0 10m</em></span><span id="e428" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">paymentservice-696f796545–8sjp5 1/1 Running 0 10m</em></span><span id="1fc9" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">productcatalogservice-7975f8588c-blrbq 1/1 Running 0 10m</em></span><span id="ff74" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">recommendationservice-6d44459d79-xxb8w 1/1 Running 0 10m</em></span><span id="1d7a" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">redis-cart-6448dcbdcc-8qcb4 1/1 Running 0 10m</em></span><span id="d367" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">shippingservice-767f84b88c-8f26h 1/1 Running 0 10m</em></span></pre><h1 id="7163" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">配置多集群入口</h1><p id="9952" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">在本节中，您将创建一个多集群入口，它将流量发送到蓝色和绿色集群的Hipster Shop前端。一个<a class="ae kj" href="https://cloud.google.com/load-balancing/docs/load-balancing-overview" rel="noopener ugc nofollow" target="_blank">谷歌云负载平衡器</a> (GCLB)被创建，它使用蓝色和绿色集群中的前端服务作为后端。要创建GCLB，您需要两个资源:一个MultiClusterIngress和一个或多个MultiClusterServices。MultiClusterIngress和MultiClusterService对象是多集群的类似物，类似于单个集群上下文中使用的现有Kubernetes入口和服务资源。</p><ul class=""><li id="1a7d" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">将MulticlusterIngress资源部署到ingress-config群集。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="8469" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${INGRESS_CONFIG_CLUSTER} apply -f mci.yaml</span><span id="b317" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>multiclusteringress.networking.gke.io/frontend-multicluster-ingress created</em></span></pre><ul class=""><li id="42b2" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">将MulticlusterService资源部署到ingress-config群集。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="12ab" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${INGRESS_CONFIG_CLUSTER} apply -f mcs-blue-green.yaml</span><span id="6f30" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>multiclusterservice.networking.gke.io/frontend-multicluster-svc created</em></span></pre><ul class=""><li id="a854" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">检查MulticlusterIngress资源。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="4ea2" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${INGRESS_CONFIG_CLUSTER} get multiclusteringress -o yaml</span><span id="7c7e" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output excerpt (do not copy)<br/>spec:</em></span><span id="3b6c" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">template:</em></span><span id="c0ae" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">spec:</em></span><span id="5baf" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">backend:</em></span><span id="e34b" class="me kl hi ma b fi mj mg l mh mi"><strong class="ma hj"><em class="mx">serviceName: frontend-multicluster-svc</em></strong></span><span id="da49" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">servicePort: 80</em></span></pre><p id="a97a" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">MulticlusterIngress资源看起来非常像Kubernetes Ingress资源，只是serviceName规范指向一个MulticlusterService。</p><ul class=""><li id="9641" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">检查MulticlusterService资源。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="78ec" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${INGRESS_CONFIG_CLUSTER} get multiclusterservice -o yaml</span><span id="c6a2" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output excerpt (do not copy)<br/>spec:</em></span><span id="a96d" class="me kl hi ma b fi mj mg l mh mi"><strong class="ma hj"><em class="mx">clusters:</em></strong></span><span id="d32e" class="me kl hi ma b fi mj mg l mh mi"><strong class="ma hj"><em class="mx">- link: us-west1-b/blue</em></strong></span><span id="b161" class="me kl hi ma b fi mj mg l mh mi"><strong class="ma hj"><em class="mx">- link: us-west1-c/green</em></strong></span><span id="11c6" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">template:</em></span><span id="8686" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">spec:</em></span><span id="d752" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">ports:</em></span><span id="252a" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">- name: web</em></span><span id="5e47" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">port: 80</em></span><span id="ed8a" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">protocol: TCP</em></span><span id="3f3c" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">targetPort: 8080</em></span><span id="8b23" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">selector:</em></span><span id="dea6" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">app: frontend</em></span></pre><p id="2a53" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">MulticlusterService看起来像一个Kubernetes服务资源，只是它有一个clusters规范。clusters值是在其中创建MulticlusterService的已注册集群的列表。</p><ul class=""><li id="b3d8" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">MulticlusterIngress在项目中创建一个GCLB，并带有一个指向MulticlusterService的后端服务。等到你看到GCLB的公众人物。运行以下命令，直到看到状态为的GCLB VIP。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="e1f5" class="me kl hi ma b fi mf mg l mh mi">watch kubectl --context ${INGRESS_CONFIG_CLUSTER} get multiclusteringress -o jsonpath=”{.items[].status.VIP}” </span><span id="a8f5" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>EXTERNAL IP ADDRESS</em></span></pre><blockquote class="my mz na"><p id="10c9" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">这一步需要几分钟。不要继续，直到您看到在MulticlusterIngress状态下分配的VIP。在创建GCLB VIP之前，您将看到上面命令的输出为null。</p></blockquote><ul class=""><li id="5d4b" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">在Macbook上按下<strong class="jp hj"> CTRL-C </strong>或<strong class="jp hj"> CMD-C </strong>退出手表命令。</li><li id="ae8d" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">通过导航到上一步中GCLB VIP上的IP地址，访问潮人商店应用程序。</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nh"><img src="../Images/a5c413868545d70c498fe11be374fab6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2Stj_aM8WlmvFM_l"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">潮人商店前台</figcaption></figure><blockquote class="my mz na"><p id="6703" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">如果你看到一个404错误信息，等待一段时间，刷新页面，直到你看到潮人商店前端。</p></blockquote><p id="41ee" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">浏览应用程序并购买一些东西。此时，Hipster Shop应用程序被部署到蓝色和绿色集群，并且MulticlusterIngress被设置为向这两个集群发送流量。</p><h1 id="1af0" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">设置负载生成器</h1><p id="87eb" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">在本节中，您将设置一个loadgenerator来生成到GCLB VIP的客户端流量。最初，这会向蓝色和绿色集群发送流量，因为MulticlusterService设置为向这两个集群发送流量。稍后，您将配置MulticlusterService向单个群集发送流量。</p><ul class=""><li id="a2ef" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">去找GCLB的贵宾。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="6bfa" class="me kl hi ma b fi mf mg l mh mi">export GCLB_VIP=$(kubectl --context ${INGRESS_CONFIG_CLUSTER} get multiclusteringress -o json | jq -r ‘.items[].status.VIP’)<br/>echo ${GCLB_VIP}</span><span id="8bcb" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>EXTERNAL IP ADDRES</em></span></pre><ul class=""><li id="be2d" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">配置loadgenerator，将客户端流量发送到GCLB VIP。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="8706" class="me kl hi ma b fi mf mg l mh mi">sed -i 's/GCLB_VIP/'${GCLB_VIP}'/g' ${WORKDIR}/load-generator/loadgenerator.yaml</span></pre><ul class=""><li id="c3f8" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">在ingress-config集群中部署负载生成器。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="5dc8" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${INGRESS_CONFIG_CLUSTER} apply -f ${WORKDIR}/load-generator</span></pre><ul class=""><li id="3c8a" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">验证loadgenerator Pod正在ingress-config群集中运行。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="527b" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${INGRESS_CONFIG_CLUSTER} get pods</span><span id="2da8" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>NAME READY STATUS RESTARTS AGE</em></span><span id="fab7" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">loadgenerator-5498cbcb86-hqscp 1/1 </em><strong class="ma hj"><em class="mx">Running</em></strong><em class="mx"> 0 53s</em></span><span id="9c4a" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">loadgenerator-5498cbcb86-m2z2z 1/1 </em><strong class="ma hj"><em class="mx">Running</em></strong><em class="mx"> 0 53s</em></span><span id="0eeb" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">loadgenerator-5498cbcb86-p56qb 1/1 </em><strong class="ma hj"><em class="mx">Running</em></strong><em class="mx"> 0 53s</em></span></pre><h1 id="3882" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">通过云监控进行监控</h1><p id="078c" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">在本节中，您将使用云监控和云控制台来监控Hipster Shop应用的流量。</p><h2 id="51e7" class="me kl hi bd km mk ml mm kq mn mo mp ku jw mq mr kw ka ms mt ky ke mu mv la mw bi translated">使用云控制台监控GCLB指标</h2><p id="fe3a" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">在上一节中，您设置了一个loadgenerator部署，通过GCLB VIP访问来模拟Hipster Shop客户端流量。您可以通过云控制台监控GCLB指标。</p><ul class=""><li id="daff" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">获取前端多集群入口的转发规则的名称。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="d1fc" class="me kl hi ma b fi mf mg l mh mi">export INGRESS_LB_RULE=$(gcloud compute forwarding-rules list | grep frontend-multicluster-ingress | awk '{print $4}')</span><span id="4bc7" class="me kl hi ma b fi mj mg l mh mi">echo ${INGRESS_LB_RULE}</span><span id="70a5" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>mci-h8zu63-default-frontend-multicluster-ingress</em></span></pre><ul class=""><li id="3283" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">从下面的命令输出导航到链接。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="90c6" class="me kl hi ma b fi mf mg l mh mi">echo "https://console.cloud.google.com/net-services/loadbalancing/details/http/${INGRESS_LB_RULE}?project=${PROJECT}&amp;tab=monitoring&amp;duration=PT1H"</span><span id="e1dd" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>https://console.cloud.google.com/net-services/loadbalancing/details/http/mci-h8zu63-default-frontend-multicluster-ingress?project=gke-multicluster-upgrades&amp;tab=monitoring&amp;duration=PT1H</em></span></pre><p id="a1af" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">您也可以通过云控制台导航到<strong class="jp hj">网络服务&gt;负载平衡</strong>页面来访问此页面。点击以“mci”开头的转发规则，然后点击<strong class="jp hj">监控</strong>选项卡。</p><ul class=""><li id="6ba7" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">在<strong class="jp hj">负载平衡器细节监控</strong>页面中，从<strong class="jp hj">后端</strong>下拉菜单中选择以<strong class="jp hj"> mci </strong>开头的后端。</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ni"><img src="../Images/8b24f286b8096534c233b8682fdf8979.png" data-original-src="https://miro.medium.com/v2/resize:fit:942/0*rDL3PaZ-5XHYjF7I"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">谷歌云负载平衡器监控</figcaption></figure><ul class=""><li id="9ae2" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">您可以看到，Hipster Shop应用的流量流向蓝色和绿色集群(由集群所在的两个区域表示)。您还可以看到时间表指标图表，显示流向两个后端的流量。</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nj"><img src="../Images/259bbc9b8c7fc38444d271b65bfd40bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mkDrXdndKvRKvBXE"/></div></div></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nj"><img src="../Images/60ccedfe5ed648f2910d0ba3b9bd2aae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SCmi_tK1XnYli5T-"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">谷歌云负载平衡器监控</figcaption></figure><blockquote class="my mz na"><p id="b2a3" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">负载平衡器指标的填充需要几分钟时间。如果需要，几分钟后刷新页面。</p></blockquote><p id="a772" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">您可以看到在蓝色和绿色集群中运行的两个前端多集群服务的neg(在以k8s1-开始的后端标签下)。</p><h2 id="07c0" class="me kl hi bd km mk ml mm kq mn mo mp ku jw mq mr kw ka ms mt ky ke mu mv la mw bi translated">使用云监控进行监控</h2><p id="6c3a" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">您可以通过云监控来监控应用的指标。</p><ul class=""><li id="401d" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">导航到下面命令输出中的链接，以访问云监控指标浏览器。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="1a11" class="me kl hi ma b fi mf mg l mh mi">echo "https://console.cloud.google.com/monitoring/metrics-explorer?project=${PROJECT}&amp;pageState=%7B%22xyChart%22:%7B%22dataSets%22:%5B%7B%22timeSeriesFilter%22:%7B%22filter%22:%22metric.type%3D%5C%22loadbalancing.googleapis.com%2Fhttps%2Frequest_count%5C%22%20resource.type%3D%5C%22https_lb_rule%5C%22%22,%22minAlignmentPeriod%22:%2260s%22,%22unitOverride%22:%221%22,%22aggregations%22:%5B%7B%22perSeriesAligner%22:%22ALIGN_RATE%22,%22crossSeriesReducer%22:%22REDUCE_SUM%22,%22groupByFields%22:%5B%22resource.label.%5C%22backend_scope%5C%22%22%5D%7D,%7B%22crossSeriesReducer%22:%22REDUCE_NONE%22%7D%5D%7D,%22targetAxis%22:%22Y1%22,%22plotType%22:%22LINE%22%7D%5D,%22options%22:%7B%22mode%22:%22COLOR%22%7D,%22constantLines%22:%5B%5D,%22timeshiftDuration%22:%220s%22,%22y1Axis%22:%7B%22label%22:%22y1Axis%22,%22scale%22:%22LINEAR%22%7D%7D,%22isAutoRefresh%22:true,%22timeSelection%22:%7B%22timeRange%22:%221h%22%7D%7D"</span></pre><p id="248b" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">您也可以通过云控制台访问同一页面。点击<strong class="jp hj">监控&gt;指标浏览器</strong>。在<strong class="jp hj">查找资源类型和指标</strong>搜索栏中，输入并选择“https_lb_rule”。对于<strong class="jp hj">,选择一个指标</strong>,搜索并选择“请求计数”。在<strong class="jp hj">分组依据</strong>搜索栏中，搜索并选择“后端范围”。</p><ul class=""><li id="3993" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">首次访问该链接时，云监控会为您设置一个新的工作区。</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nk"><img src="../Images/7c43a9d4c18025de5999e016218bf15d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NuHHbT1y9YVKZxk3"/></div></div></figure><ul class=""><li id="29b4" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">创建工作区后，该图表显示了按后端分组的GCLB请求计数度量。</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nj"><img src="../Images/0e6555c26cf298d0c604bbea0a467ab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c7TjbGh_k1UypRj-"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">云监控指标浏览器</figcaption></figure><p id="3b1a" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">您会看到流量流向两个后端(蓝色和绿色集群)。后端由两个集群中运行的两个前端多集群服务的区域表示。</p><blockquote class="my mz na"><p id="bf32" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">您可能会在短时间内看到第三个后端(名为INVALID_BACKEND)。这是云监控中的UI异常，可以忽略。</p></blockquote><h1 id="e905" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">排空并升级绿色集群</h1><p id="a260" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">在本节中，您将“排空”绿色集群。清空集群意味着从负载平衡池中删除集群。在清空绿色集群后，所有发往潮人商店应用的客户端流量都将流向蓝色集群。您可以按照上一节中的描述来监控这个过程。清空集群后，您可以升级清空的集群。升级后，您可以将其放回负载平衡池中。您可以按照相同的步骤升级另一个集群(本教程中未显示)。</p><p id="cfe7" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">要耗尽绿色集群，您需要更新入口集群中的MulticlusterService资源，并从集群规范中删除绿色集群。</p><h2 id="dc1c" class="me kl hi bd km mk ml mm kq mn mo mp ku jw mq mr kw ka ms mt ky ke mu mv la mw bi translated">排干绿色的簇</h2><ul class=""><li id="eefc" class="lc ld hi jp b jq le jt lf jw lg ka lh ke li ki lv lk ll lm bi translated">更新ingress-config群集中的MulticlusterService资源。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="f262" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${INGRESS_CONFIG_CLUSTER} apply -f mcs-blue.yaml</span></pre><ul class=""><li id="7c46" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">验证集群规范中只有蓝色集群。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="33cd" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${INGRESS_CONFIG_CLUSTER} get multiclusterservice -o json | jq '.items[].spec.clusters'</span><span id="9a36" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>{</em></span><span id="a6cd" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">   “link”: “us-west1-b/blue”</em></span><span id="d578" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">}</em></span></pre><p id="dd25" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在群集规范中，您只能看到蓝色群集。这意味着只有蓝色集群在GCLB负载平衡池中。</p><h2 id="2ca2" class="me kl hi bd km mk ml mm kq mn mo mp ku jw mq mr kw ka ms mt ky ke mu mv la mw bi translated">监控入口指标</h2><ul class=""><li id="076a" class="lc ld hi jp b jq le jt lf jw lg ka lh ke li ki lv lk ll lm bi translated">导航到云监控指标图表页面，或者通过单击以下命令的输出。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="eba0" class="me kl hi ma b fi mf mg l mh mi">echo "https://console.cloud.google.com/monitoring/metrics-explorer?project=${PROJECT}&amp;pageState=%7B%22xyChart%22:%7B%22dataSets%22:%5B%7B%22timeSeriesFilter%22:%7B%22filter%22:%22metric.type%3D%5C%22loadbalancing.googleapis.com%2Fhttps%2Frequest_count%5C%22%20resource.type%3D%5C%22https_lb_rule%5C%22%22,%22minAlignmentPeriod%22:%2260s%22,%22unitOverride%22:%221%22,%22aggregations%22:%5B%7B%22perSeriesAligner%22:%22ALIGN_RATE%22,%22crossSeriesReducer%22:%22REDUCE_SUM%22,%22groupByFields%22:%5B%22resource.label.%5C%22backend_scope%5C%22%22%5D%7D,%7B%22crossSeriesReducer%22:%22REDUCE_NONE%22%7D%5D%7D,%22targetAxis%22:%22Y1%22,%22plotType%22:%22LINE%22%7D%5D,%22options%22:%7B%22mode%22:%22COLOR%22%7D,%22constantLines%22:%5B%5D,%22timeshiftDuration%22:%220s%22,%22y1Axis%22:%7B%22label%22:%22y1Axis%22,%22scale%22:%22LINEAR%22%7D%7D,%22isAutoRefresh%22:true,%22timeSelection%22:%7B%22timeRange%22:%221h%22%7D%7D"</span></pre><ul class=""><li id="bcb0" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">输出显示只有蓝色集群在接收流量。</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nl"><img src="../Images/1e3ea472ec795ef4290411d635b2b7b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:868/0*BcL4BfJvXY4yVn6y"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">云监控</figcaption></figure><blockquote class="my mz na"><p id="4f88" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">云监控指标刷新可能需要几分钟时间。</p></blockquote><ul class=""><li id="48c1" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">您还可以在云控制台中看到类似的GCLB指标。导航到云控制台中的GCLB监视指标页面，或单击以下命令的输出。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="0b3b" class="me kl hi ma b fi mf mg l mh mi">echo "https://console.cloud.google.com/net-services/loadbalancing/details/http/${INGRESS_LB_RULE}?project=${PROJECT}&amp;tab=monitoring&amp;duration=PT1H"</span></pre><ul class=""><li id="a68a" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">该图表还显示，只有蓝色集群正在接收潮人商店的流量。</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nj"><img src="../Images/05c93f57741b73bbc168bb047a65dd32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*N6ei9Wbt9u9WcOcW"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">谷歌云负载平衡器监控</figcaption></figure><blockquote class="my mz na"><p id="1ac7" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">负载平衡器指标刷新可能需要几分钟时间。</p></blockquote><h2 id="1bd3" class="me kl hi bd km mk ml mm kq mn mo mp ku jw mq mr kw ka ms mt ky ke mu mv la mw bi translated">升级绿色集群</h2><p id="a0cf" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">现在，绿色集群不再接收任何客户端流量，您可以升级集群(主集群和节点集群)。获取主节点和节点的当前集群版本。然后，您可以找到可用的版本(在区域中)。最后，您可以将集群升级到较新的版本。</p><ul class=""><li id="a21f" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">获取集群的当前版本。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="04d4" class="me kl hi ma b fi mf mg l mh mi">gcloud container clusters list</span><span id="e9b0" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>NAME LOCATION MASTER_VERSION MASTER_IP MACHINE_TYPE NODE_VERSION NUM_NODES STATUS</em></span><span id="aaa8" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">ingress-config us-west1-a 1.14.10-gke.24 35.203.165.186 n1-standard-1 1.14.10-gke.24 3 RUNNING</em></span><span id="9063" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">blue us-west1-b 1.14.10-gke.24 34.82.76.141 n1-standard-1 1.14.10-gke.24 4 RUNNING</em></span><span id="80dd" class="me kl hi ma b fi mj mg l mh mi"><strong class="ma hj"><em class="mx">green us-west1-c 1.14.10-gke.24 35.197.46.200 n1-standard-1 1.14.10-gke.24 4 RUNNING</em></strong></span></pre><blockquote class="my mz na"><p id="aa8f" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">根据您学习本教程的时间，您的集群版本可能会有所不同。</p></blockquote><ul class=""><li id="1723" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">获取区域中可用主版本的列表。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="d727" class="me kl hi ma b fi mf mg l mh mi">gcloud container get-server-config --zone us-west1-c --format=json | jq '.validMasterVersions'</span><span id="13c5" class="me kl hi ma b fi mj mg l mh mi">Output (do not copy)<br/>[</span><span id="ab94" class="me kl hi ma b fi mj mg l mh mi">“1.15.9-gke.22”,</span><span id="e212" class="me kl hi ma b fi mj mg l mh mi">“1.15.9-gke.12”,</span><span id="d7ef" class="me kl hi ma b fi mj mg l mh mi">“1.15.9-gke.9”,</span><span id="958f" class="me kl hi ma b fi mj mg l mh mi">“1.15.9-gke.8”,</span><span id="659a" class="me kl hi ma b fi mj mg l mh mi">“1.15.8-gke.3”,</span><span id="41cb" class="me kl hi ma b fi mj mg l mh mi">“1.14.10-gke.27”,</span><span id="2eab" class="me kl hi ma b fi mj mg l mh mi">“1.14.10-gke.24”,</span><span id="c28a" class="me kl hi ma b fi mj mg l mh mi">“1.14.10-gke.22”,</span><span id="e7e7" class="me kl hi ma b fi mj mg l mh mi">“1.14.10-gke.21”,</span><span id="bd1e" class="me kl hi ma b fi mj mg l mh mi">“1.14.10-gke.17”,</span><span id="49fa" class="me kl hi ma b fi mj mg l mh mi">“1.13.12-gke.30”</span><span id="e541" class="me kl hi ma b fi mj mg l mh mi">]</span></pre><ul class=""><li id="a7a6" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">获取区域中可用节点版本的列表。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="31e3" class="me kl hi ma b fi mf mg l mh mi">gcloud container get-server-config --zone us-west1-c --format=json | jq '.validNodeVersions[0:20]'</span><span id="1a59" class="me kl hi ma b fi mj mg l mh mi">Output (do not copy)<br/>[</span><span id="a6eb" class="me kl hi ma b fi mj mg l mh mi">“1.15.9-gke.22”,</span><span id="4aff" class="me kl hi ma b fi mj mg l mh mi">“1.15.9-gke.12”,</span><span id="55e2" class="me kl hi ma b fi mj mg l mh mi">“1.15.9-gke.9”,</span><span id="914d" class="me kl hi ma b fi mj mg l mh mi">“1.15.9-gke.8”,</span><span id="f307" class="me kl hi ma b fi mj mg l mh mi">“1.15.8-gke.3”,</span><span id="deb7" class="me kl hi ma b fi mj mg l mh mi">“1.15.8-gke.2”,</span><span id="c8e5" class="me kl hi ma b fi mj mg l mh mi">“1.15.7-gke.23”,</span><span id="eb03" class="me kl hi ma b fi mj mg l mh mi">“1.15.7-gke.2”,</span><span id="17de" class="me kl hi ma b fi mj mg l mh mi">“1.15.4-gke.22”,</span><span id="1942" class="me kl hi ma b fi mj mg l mh mi">“1.14.10-gke.27”,</span><span id="72ed" class="me kl hi ma b fi mj mg l mh mi">“1.14.10-gke.24”,</span><span id="1aed" class="me kl hi ma b fi mj mg l mh mi">“1.14.10-gke.22”,</span><span id="f96c" class="me kl hi ma b fi mj mg l mh mi">“1.14.10-gke.21”,</span><span id="bd2a" class="me kl hi ma b fi mj mg l mh mi">“1.14.10-gke.17”,</span><span id="7f7c" class="me kl hi ma b fi mj mg l mh mi">“1.14.10-gke.0”,</span><span id="f39e" class="me kl hi ma b fi mj mg l mh mi">“1.14.9-gke.23”,</span><span id="def7" class="me kl hi ma b fi mj mg l mh mi">“1.14.9-gke.2”,</span><span id="40f8" class="me kl hi ma b fi mj mg l mh mi">“1.14.9-gke.0”,</span><span id="b054" class="me kl hi ma b fi mj mg l mh mi">“1.14.8-gke.33”,</span><span id="78e3" class="me kl hi ma b fi mj mg l mh mi">“1.14.8-gke.21”</span><span id="0ec5" class="me kl hi ma b fi mj mg l mh mi">]</span></pre><ul class=""><li id="04e6" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">为绿色集群选择所需的主版本和节点版本(高于当前主版本和节点版本)。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="79af" class="me kl hi ma b fi mf mg l mh mi">export UPGRADE_VERSION="1.15.9-gke.26"</span></pre><blockquote class="my mz na"><p id="87c0" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">根据您学习本教程的时间，您的集群版本可能会有所不同。为了确定选择哪个版本，请参考<a class="ae kj" href="https://cloud.google.com/kubernetes-engine/docs/how-to/upgrading-a-cluster#upgrading_the_cluster" rel="noopener ugc nofollow" target="_blank">升级集群和节点池文档</a>。通常，最佳实践是为主节点和节点选择相同的版本。从列表中为主节点和节点选择一个可用版本。</p></blockquote><ul class=""><li id="af5a" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">升级绿色集群的主服务器。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="f804" class="me kl hi ma b fi mf mg l mh mi">gcloud container clusters upgrade green \<br/> --zone us-west1-c --master --cluster-version ${UPGRADE_VERSION}</span></pre><ul class=""><li id="dbcf" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">键入“<strong class="jp hj"> Y </strong>确认升级。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="34ec" class="me kl hi ma b fi mf mg l mh mi"><em class="mx">Do you want to continue (Y/n)?</em> <strong class="ma hj">Y</strong></span><span id="6d89" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Upgrading green…⠧</em></span></pre><blockquote class="my mz na"><p id="7cf1" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">这个过程需要几分钟才能完成。请等到主升级完成后再继续。更新完成后，您应该会看到以下消息。</p><p id="8c4f" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">已更新[https://container . Google APIs . com/v1/projects/gke-multi cluster-upgrades/zones/us-west 1-c/clusters/green]。</p></blockquote><ul class=""><li id="64d0" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">主升级完成后，您可以通过运行以下命令来升级绿色集群中的节点。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="4221" class="me kl hi ma b fi mf mg l mh mi">gcloud container clusters upgrade green \</span><span id="cbcc" class="me kl hi ma b fi mj mg l mh mi"> --zone=us-west1-c --node-pool=default-pool \</span><span id="bb85" class="me kl hi ma b fi mj mg l mh mi"> --cluster-version ${UPGRADE_VERSION}</span></pre><ul class=""><li id="4aa3" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">键入"<strong class="jp hj"> Y </strong>"确认升级。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="4c30" class="me kl hi ma b fi mf mg l mh mi"><em class="mx">Do you want to continue (Y/n)?</em> <strong class="ma hj">Y</strong></span><span id="68e0" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Upgrading green… Done with 0 out of 4 nodes (0.0%): 1 being processed…⠶</em></span></pre><blockquote class="my mz na"><p id="1b43" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">这个过程需要几分钟才能完成。请等到节点升级完成后再继续。升级完成后，您应该会看到以下消息。</p><p id="fe68" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">升级绿色…完成4个节点中的4个(100.0%): 4个成功…完成。</p><p id="cc42" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">已更新[https://container . Google APIs . com/v1/projects/gke-multi cluster-upgrades/zones/us-west 1-c/clusters/green]。</p></blockquote><ul class=""><li id="74cf" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">验证绿色集群(主集群和节点集群)是否已升级。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="6d10" class="me kl hi ma b fi mf mg l mh mi">gcloud container clusters list</span><span id="bf85" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>NAME LOCATION MASTER_VERSION MASTER_IP MACHINE_TYPE NODE_VERSION NUM_NODES STATUS</em></span><span id="3455" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">ingress-config us-west1-a 1.14.10-gke.24 35.203.165.186 n1-standard-1 1.14.10-gke.24 3 RUNNING</em></span><span id="e5ba" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">blue us-west1-b 1.14.10-gke.24 34.82.76.141 n1-standard-1 1.14.10-gke.24 4 RUNNING</em></span><span id="9570" class="me kl hi ma b fi mj mg l mh mi"><strong class="ma hj"><em class="mx">green us-west1-c 1.15.8-gke.3 35.197.46.200 n1-standard-1 1.15.8-gke.3 4 RUNNING</em></strong></span></pre><blockquote class="my mz na"><p id="1b1b" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">根据您学习本教程的时间，您的集群版本可能会有所不同。</p></blockquote><h1 id="689e" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">将绿色集群添加到负载平衡池</h1><p id="bd61" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">在本节中，您将绿色集群添加回负载平衡池中。</p><ul class=""><li id="4d6c" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">在将绿色集群添加回负载平衡池之前，请验证所有Hipster Shop应用部署是否正在绿色集群上运行。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="bf6a" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${GREEN_CLUSTER} get pods</span><span id="d5e5" class="me kl hi ma b fi mj mg l mh mi">Output (do not copy)<br/>NAME READY STATUS RESTARTS AGE</span><span id="0984" class="me kl hi ma b fi mj mg l mh mi">adservice-86f5dfb995–2b25h 1/1 Running 0 16m</span><span id="05ae" class="me kl hi ma b fi mj mg l mh mi">cartservice-76cf9686b6-ws7b7 1/1 Running 1 13m</span><span id="05a5" class="me kl hi ma b fi mj mg l mh mi">checkoutservice-7766b946f5–6fhjh 1/1 Running 0 9m50s</span><span id="8d3f" class="me kl hi ma b fi mj mg l mh mi">currencyservice-76975c7847-rf8r7 1/1 Running 0 13m</span><span id="85bd" class="me kl hi ma b fi mj mg l mh mi">emailservice-c55cd96f-pht8h 1/1 Running 0 13m</span><span id="346b" class="me kl hi ma b fi mj mg l mh mi">frontend-f4b7cd95-wxdsh 1/1 Running 0 13m</span><span id="b2e4" class="me kl hi ma b fi mj mg l mh mi">loadgenerator-6784bc5f77–6b4cd 1/1 Running 6 6m34s</span><span id="24a9" class="me kl hi ma b fi mj mg l mh mi">paymentservice-696f796545–9wrl7 1/1 Running 0 9m49s</span><span id="02e8" class="me kl hi ma b fi mj mg l mh mi">productcatalogservice-7975f8588c-kbm5k 1/1 Running 0 6m33s</span><span id="67ce" class="me kl hi ma b fi mj mg l mh mi">recommendationservice-6d44459d79-km8vm 1/1 Running 0 9m49s</span><span id="76fc" class="me kl hi ma b fi mj mg l mh mi">redis-cart-6448dcbdcc-sjg69 1/1 Running 0 13m</span><span id="8736" class="me kl hi ma b fi mj mg l mh mi">shippingservice-767f84b88c-gh9m4 1/1 Running 0 9m49s</span></pre><ul class=""><li id="2ea6" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">更新MutliclusterService以将绿色集群添加回负载平衡池中。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="897a" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${INGRESS_CONFIG_CLUSTER} apply -f mcs-blue-green.yaml</span></pre><ul class=""><li id="a956" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">验证集群规范中是否有蓝色和绿色集群。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="5bf8" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${INGRESS_CONFIG_CLUSTER} get multiclusterservice -o json | jq '.items[].spec.clusters'</span><span id="682d" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>{</em></span><span id="2882" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">   “link”: “us-west1-b/blue”</em></span><span id="80a8" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">},</em></span><span id="5212" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">{</em></span><span id="5a94" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">   “link”: “us-west1-c/green”</em></span><span id="1d6a" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">}</em></span></pre><p id="f928" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">您可以在群集规范中看到蓝色和绿色群集。</p><h2 id="37c2" class="me kl hi bd km mk ml mm kq mn mo mp ku jw mq mr kw ka ms mt ky ke mu mv la mw bi translated">监控入口指标</h2><ul class=""><li id="299f" class="lc ld hi jp b jq le jt lf jw lg ka lh ke li ki lv lk ll lm bi translated">导航到云监控指标图表页面，或者通过单击以下命令的输出。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="8b37" class="me kl hi ma b fi mf mg l mh mi">echo "https://console.cloud.google.com/monitoring/metrics-explorer?project=${PROJECT}&amp;pageState=%7B%22xyChart%22:%7B%22dataSets%22:%5B%7B%22timeSeriesFilter%22:%7B%22filter%22:%22metric.type%3D%5C%22loadbalancing.googleapis.com%2Fhttps%2Frequest_count%5C%22%20resource.type%3D%5C%22https_lb_rule%5C%22%22,%22minAlignmentPeriod%22:%2260s%22,%22unitOverride%22:%221%22,%22aggregations%22:%5B%7B%22perSeriesAligner%22:%22ALIGN_RATE%22,%22crossSeriesReducer%22:%22REDUCE_SUM%22,%22groupByFields%22:%5B%22resource.label.%5C%22backend_scope%5C%22%22%5D%7D,%7B%22crossSeriesReducer%22:%22REDUCE_NONE%22%7D%5D%7D,%22targetAxis%22:%22Y1%22,%22plotType%22:%22LINE%22%7D%5D,%22options%22:%7B%22mode%22:%22COLOR%22%7D,%22constantLines%22:%5B%5D,%22timeshiftDuration%22:%220s%22,%22y1Axis%22:%7B%22label%22:%22y1Axis%22,%22scale%22:%22LINEAR%22%7D%7D,%22isAutoRefresh%22:true,%22timeSelection%22:%7B%22timeRange%22:%221h%22%7D%7D"</span></pre><ul class=""><li id="0dce" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">输出显示蓝色和绿色集群都在接收流量。</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nj"><img src="../Images/ad060220d66a930bf1798e80ec7cda5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6PtdMPPeONmAV1XB"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">云监控</figcaption></figure><blockquote class="my mz na"><p id="7697" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">监控指标刷新可能需要几分钟时间。</p></blockquote><ul class=""><li id="4dd8" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">您还可以在云控制台中看到类似的GCLB指标。导航到云控制台中的GCLB监视指标页面，或单击以下命令的输出。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="a254" class="me kl hi ma b fi mf mg l mh mi">echo "https://console.cloud.google.com/net-services/loadbalancing/details/http/${INGRESS_LB_RULE}?project=${PROJECT}&amp;tab=monitoring&amp;duration=PT1H"</span></pre><p id="02a7" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">图表还显示，蓝色和绿色集群都在接收潮人商店的流量。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nj"><img src="../Images/da34ca3183a16cc8ec3ca3a800bf5a9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WzhpIOgyAwEdW7pF"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">谷歌云负载平衡器监控</figcaption></figure><blockquote class="my mz na"><p id="3528" class="jn jo mx jp b jq jr ij js jt ju im jv nb jx jy jz nc kb kc kd nd kf kg kh ki hb bi translated">负载平衡器指标刷新可能需要几分钟时间。</p></blockquote><blockquote class="nm"><p id="c169" class="nn no hi bd np nq nr ns nt nu nv ki dx translated">恭喜你。您使用Ingress for Anthos成功升级了多集群体系结构中的GKE集群。您可以使用相同的过程升级蓝色集群。</p></blockquote><h1 id="ccf5" class="kk kl hi bd km kn ko kp kq kr ks kt ku io nw ip kw ir nx is ky iu ny iv la lb bi translated">清理</h1><p id="149a" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">为了避免本教程中使用的资源对您的Google云平台帐户产生费用:</p><h2 id="a0c7" class="me kl hi bd km mk ml mm kq mn mo mp ku jw mq mr kw ka ms mt ky ke mu mv la mw bi translated">删除集群</h2><ul class=""><li id="73e0" class="lc ld hi jp b jq le jt lf jw lg ka lh ke li ki lv lk ll lm bi translated">注销并删除蓝色和绿色集群。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="02be" class="me kl hi ma b fi mf mg l mh mi">gcloud container hub memberships unregister green \</span><span id="f46b" class="me kl hi ma b fi mj mg l mh mi"> --project=${PROJECT} \</span><span id="cab4" class="me kl hi ma b fi mj mg l mh mi"> --gke-uri=${GREEN_URI}</span><span id="1376" class="me kl hi ma b fi mj mg l mh mi">gcloud container clusters delete green --zone us-west1-c --quiet</span><span id="db50" class="me kl hi ma b fi mj mg l mh mi">gcloud container hub memberships unregister blue \</span><span id="b62a" class="me kl hi ma b fi mj mg l mh mi"> --project=${PROJECT} \</span><span id="65f0" class="me kl hi ma b fi mj mg l mh mi"> --gke-uri=${BLUE_URI}</span><span id="1f92" class="me kl hi ma b fi mj mg l mh mi">gcloud container clusters delete blue --zone us-west1-b --quiet</span></pre><ul class=""><li id="9e71" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">从ingress-config群集中删除MuticlusterIngress。这将从项目中删除GCLB资源。注销并删除入口配置集群。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="87f0" class="me kl hi ma b fi mf mg l mh mi">kubectl --context ${INGRESS_CONFIG_CLUSTER} delete -f mci.yaml<br/></span><span id="e03f" class="me kl hi ma b fi mj mg l mh mi">gcloud container hub memberships unregister ingress-config \</span><span id="7ac9" class="me kl hi ma b fi mj mg l mh mi"> --project=${PROJECT} \</span><span id="1760" class="me kl hi ma b fi mj mg l mh mi"> --gke-uri=${INGRESS_CONFIG_URI}</span><span id="66c2" class="me kl hi ma b fi mj mg l mh mi">gcloud container clusters delete ingress-config --zone us-west1-a --quiet</span></pre><ul class=""><li id="d5ee" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">验证是否删除了所有集群。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="86fd" class="me kl hi ma b fi mf mg l mh mi">gcloud container clusters list</span><span id="3371" class="me kl hi ma b fi mj mg l mh mi"><em class="mx">Output (do not copy)<br/>&lt;null&gt;</em></span></pre><ul class=""><li id="5660" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">取消设置kubeconfig文件。这将重置为默认的kubeconfig文件。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="dc29" class="me kl hi ma b fi mf mg l mh mi">unset KUBECONFIG</span></pre><ul class=""><li id="7685" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">删除工作目录文件夹。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="800d" class="me kl hi ma b fi mf mg l mh mi">cd ${HOME}<br/>rm -rf ${WORKDIR}</span></pre><h2 id="d5d0" class="me kl hi bd km mk ml mm kq mn mo mp ku jw mq mr kw ka ms mt ky ke mu mv la mw bi translated">删除项目</h2><p id="7448" class="pw-post-body-paragraph jn jo hi jp b jq le ij js jt lf im jv jw lw jy jz ka lx kc kd ke ly kg kh ki hb bi translated">消除计费的最简单方法是删除您为教程创建的项目。</p><p id="089a" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">要删除项目:</p><ul class=""><li id="da8a" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">在云平台控制台中，转到项目页面。</li></ul><pre class="iy iz ja jb fd lz ma mb mc aw md bi"><span id="e407" class="me kl hi ma b fi mf mg l mh mi"><a class="ae kj" href="https://console.cloud.google.com/iam-admin/projects" rel="noopener ugc nofollow" target="_blank">GO TO THE PROJECTS PAGE</a></span></pre><ul class=""><li id="dd21" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">在项目列表中，选择要删除的项目，点击<strong class="jp hj">删除</strong>。</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nz"><img src="../Images/c87870f72dda0bba0e88d30599d4267c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5LNtYYIuATvutSBm"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">谷歌云控制台</figcaption></figure><ul class=""><li id="bc7e" class="lc ld hi jp b jq jr jt ju jw ls ka lt ke lu ki lv lk ll lm bi translated">在对话框中，键入项目ID，然后点击<strong class="jp hj">关闭</strong>删除该项目。</li></ul><h1 id="1f02" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">下一步是什么</h1><ul class=""><li id="88ba" class="lc ld hi jp b jq le jt lf jw lg ka lh ke li ki lv lk ll lm bi translated">了解更多关于Anthos的<a class="ae kj" href="https://cloud.google.com/kubernetes-engine/docs/concepts/ingress-for-anthos" rel="noopener ugc nofollow" target="_blank">入口</a></li><li id="6341" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">了解如何部署Anthos的入口— <a class="ae kj" href="https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-for-anthos" rel="noopener ugc nofollow" target="_blank">跨集群部署Anthos的入口</a></li><li id="99c3" class="lc ld hi jp b jq ln jt lo jw lp ka lq ke lr ki lv lk ll lm bi translated">亲自尝试谷歌云平台的其他功能。看看我们的<a class="ae kj" href="https://cloud.google.com/docs/tutorials" rel="noopener ugc nofollow" target="_blank">教程</a>。</li></ul></div></div>    
</body>
</html>