<html>
<head>
<title>Workflows tip #19: Using Workflows’ Secret Manager connector to call an authenticated service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">工作流提示#19:使用工作流的Secret Manager连接器调用经过身份验证的服务</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/workflows-tip-19-using-workflows-secret-manager-connector-to-call-an-authenticated-service-64ea9f4c6060?source=collection_archive---------3-----------------------#2022-02-04">https://medium.com/google-cloud/workflows-tip-19-using-workflows-secret-manager-connector-to-call-an-authenticated-service-64ea9f4c6060?source=collection_archive---------3-----------------------#2022-02-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8082" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Workflows允许您调用API，无论是来自Google Cloud还是托管在Google Cloud上，或者任何外部API。例如，几天前，我们在<a class="ae jd" href="https://glaforge.appspot.com/article/sending-an-email-with-sendgrid-from-workflows" rel="noopener ugc nofollow" target="_blank">上看到了一个如何使用SendGrid API从工作流</a>发送电子邮件的例子。然而，在那篇文章中，我将API键硬编码到我的工作流中，这是一个糟糕的做法。相反，我们可以在<a class="ae jd" href="https://cloud.google.com/secret-manager" rel="noopener ugc nofollow" target="_blank">秘密管理器</a>中存储秘密。Workflows为Secret Manager 提供了一个特定的<a class="ae jd" href="https://cloud.google.com/workflows/docs/reference/googleapis/secretmanager/Overview" rel="noopener ugc nofollow" target="_blank">连接器，以及一个访问机密的有用方法。</a></p><p id="8c02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将了解两件事:</p><ul class=""><li id="5e1e" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">如何使用工作流连接器访问存储在Secret Manager中的机密</li><li id="8ebb" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">如何调用需要基本认证的API</li></ul><p id="0c3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们访问我对我需要调用的API进行基本授权调用所需的秘密:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="e448" class="kb kc hi jx b fi kd ke l kf kg">- get_secret_user:<br/>    call: googleapis.secretmanager.v1.projects.secrets.versions.accessString<br/>    args:<br/>      secret_id: basicAuthUser<br/>    result: secret_user</span><span id="08d5" class="kb kc hi jx b fi kh ke l kf kg">- get_secret_password:<br/>    call: googleapis.secretmanager.v1.projects.secrets.versions.accessString<br/>    args:<br/>      secret_id: basicAuthPassword<br/>    result: secret_password</span></pre><p id="890d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用户登录名和密码现在存储在变量中，我可以在工作流中重用这些变量。我将创建Base64编码的user:password字符串，该字符串需要传入授权头:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="6eda" class="kb kc hi jx b fi kd ke l kf kg">- assign_user_password:<br/>    assign:<br/>    - encodedUserPassword: ${base64.encode(text.encode(secret_user + ":" + secret_password))}</span></pre><p id="30fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了我编码的user:password字符串，我现在可以通过添加带有基本身份验证的授权头来调用我的API(这里是一个云函数)(并返回函数的输出):</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="593f" class="kb kc hi jx b fi kd ke l kf kg">- call_function:<br/>    call: http.get<br/>    args:<br/>        url: <a class="ae jd" href="https://europe-west1-workflows-days.cloudfunctions.net/basicAuthFn" rel="noopener ugc nofollow" target="_blank">https://example.com/api</a><br/>        headers:<br/>            Authorization: ${"Basic " + encodedUserPassword}<br/>    result: fn_output</span><span id="1558" class="kb kc hi jx b fi kh ke l kf kg">- return_result:<br/>    return: ${fn_output.body}</span></pre><p id="9a88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Workflows具有内置的<a class="ae jd" href="https://cloud.google.com/workflows/docs/authentication#making_authenticated_requests" rel="noopener ugc nofollow" target="_blank"> OAuth2和OIDC支持，用于对Google托管的API、函数和云运行服务进行身份验证</a>，但了解如何调用其他经过身份验证的服务也很有用，比如那些需要基本身份验证或其他无记名令牌的服务。</p></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><p id="6fea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp">最初发表于</em><a class="ae jd" href="https://glaforge.appspot.com/article/using-the-secret-manager-connector-for-workflows-to-call-an-authenticated-service" rel="noopener ugc nofollow" target="_blank"><em class="kp">https://glaforge.appspot.com</em></a><em class="kp">。</em></p></div></div>    
</body>
</html>