<html>
<head>
<title>Cluster Federation and Global Load Balancing on Kubernetes and Google Cloud — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes和Google Cloud上的集群联合和全局负载平衡—第1部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/planet-scale-microservices-with-cluster-federation-and-global-load-balancing-on-kubernetes-and-a8e7ef5efa5e?source=collection_archive---------2-----------------------#2017-03-23">https://medium.com/google-cloud/planet-scale-microservices-with-cluster-federation-and-global-load-balancing-on-kubernetes-and-a8e7ef5efa5e?source=collection_archive---------2-----------------------#2017-03-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="0316" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">警告:在这篇文章中描述的Kubernetes联盟将不再被支持。正在开发新的工具来取代它，当这些工具准备好的时候，我会写一篇新的博文。下面的理论上应该还是行得通的，但是我不再推荐了。</h2></div><p id="97db" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我最近在Google Cloud Next做了一个关于使用Kubernetes在世界各地部署和管理微服务的演讲。</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="jy jz l"/></div><figcaption class="ka kb et er es kc kd bd b be z dx translated">https://www.youtube.com/watch?v=kmPBm-TQBSE<a class="ae ke" href="https://www.youtube.com/watch?v=kmPBm-TQBSE" rel="noopener ugc nofollow" target="_blank"/></figcaption></figure><p id="63c1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我已经在博客中讲述了如何<a class="ae ke" href="http://blog.kubernetes.io/2017/01/running-mongodb-on-kubernetes-with-statefulsets.html" rel="noopener ugc nofollow" target="_blank">在StatefulSet </a>中设置MongoDB，所以现在我将深入探讨如何设置集群联盟并在全球范围内部署服务！</p><p id="6534" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我假设你知道在谷歌云中创建项目的基本知识，并且已经安装和设置了<a class="ae ke" href="https://cloud.google.com/sdk/" rel="noopener ugc nofollow" target="_blank">谷歌云SDK </a>。如果没有，请查看我以前的博客帖子。</p></div><div class="ab cl kf kg gp kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hb hc hd he hf"><p id="a55f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将特别关注三个方面，集群联合、联合入口和跨集群服务发现。我将把这些话题分成三篇博文，期待下一篇吧！</p><h2 id="79dc" class="km kn hi bd ko kp kq kr ks kt ku kv kw jg kx ky kz jk la lb lc jo ld le lf lg bi translated">第1部分:集群联合</h2><p id="b46c" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated"><a class="ae ke" href="https://cloud.google.com/container-engine/docs/cluster-federation" rel="noopener ugc nofollow" target="_blank">集群联合</a>可以用来管理多个Kubernetes集群，就像它们是一个集群一样。这意味着您可以在多个数据中心(和多个云)中创建集群，并使用联合来一次性控制它们！</p><h2 id="d7b6" class="km kn hi bd ko kp kq kr ks kt ku kv kw jg kx ky kz jk la lb lc jo ld le lf lg bi translated"><a class="ae ke" rel="noopener" href="/@SandeepDinesh/planet-scale-microservices-with-cluster-federation-and-global-load-balancing-on-kubernetes-and-cd182f981653">第2部分:联合入口</a></h2><p id="eac8" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated"><a class="ae ke" href="https://kubernetes.io/docs/tasks/administer-federation/ingress/" rel="noopener ugc nofollow" target="_blank">联邦入口</a>超级甜，目前只支持Google Cloud。这允许您使用单个全局IP地址启动单个负载平衡器，它将自动向最近的集群动态发送流量！</p><h2 id="7d99" class="km kn hi bd ko kp kq kr ks kt ku kv kw jg kx ky kz jk la lb lc jo ld le lf lg bi translated">第3部分:跨集群通信</h2><p id="80a1" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated"><a class="ae ke" href="http://kubernetes.io/docs/user-guide/federation/federated-services/" rel="noopener ugc nofollow" target="_blank">跨集群服务发现</a>是一个概念，让一个Kubernetes集群中的服务自动发现其他集群中的服务。我们还会看看<a class="ae ke" href="https://cloud.google.com/pubsub/" rel="noopener ugc nofollow" target="_blank"> Google Cloud Pub/Sub </a>启用异步微服务！</p></div><div class="ab cl kf kg gp kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hb hc hd he hf"><h1 id="b5c0" class="lm kn hi bd ko ln lo lp ks lq lr ls kw io lt ip kz ir lu is lc iu lv iv lf lw bi translated">第1部分:集群联合</h1><h1 id="8aaf" class="lm kn hi bd ko ln lx lp ks lq ly ls kw io lz ip kz ir ma is lc iu mb iv lf lw bi translated">步骤1:设置DNS</h1><p id="ec93" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">DNS是Kubernetes的核心，因为它用于集群中的服务发现。虽然在群集内部运行本地DNS服务器，但您需要有一个中央DNS服务来进行跨群集服务发现。你可以使用任何可编程的DNS服务来做到这一点，我们将使用<a class="ae ke" href="https://cloud.google.com/dns/" rel="noopener ugc nofollow" target="_blank"> Google Cloud DNS </a>。</p><p id="e2f0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第一步是购买域名(或者使用你已经有的域名)。在我的例子中，我用<a class="ae ke" href="https://domains.google/" rel="noopener ugc nofollow" target="_blank">谷歌域名</a>购买了一个便宜的域名。对于这个例子，我将假设我购买的域名是“mycompany.com”</p><p id="2d4c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您需要创建一个<a class="ae ke" href="https://cloud.google.com/dns/zones/" rel="noopener ugc nofollow" target="_blank">管理的DNS区域</a>。让我们使用“infra”子域来处理Kubernetes服务，这意味着该域将是“infra.mycompany.com”。我也将该域称为“kfed”，但您可以随意称呼它。</p><pre class="jt ju jv jw fd mc md me mf aw mg bi"><span id="af55" class="km kn hi md b fi mh mi l mj mk">gcloud dns managed-zones create kfed \<br/>  --description “Kubernetes Federation Zone” \<br/>  --dns-name infra.mycompany.com</span></pre><p id="64b6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您转到<a class="ae ke" href="http://console.cloud.google.com/networking/dns/zones" rel="noopener ugc nofollow" target="_blank">云DNS控制台</a>，您应该会看到这个新区域被创建。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="er es ml"><img src="../Images/acc8195347878ed5f7ac91ba49384a62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vLIcqupQ1RIALS3u."/></div></div></figure><p id="86dc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">单击区域名称，您将看到更多详细信息，包括名称服务器:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="er es ms"><img src="../Images/ac4b2edd78ed89fc656fb3a0539df1d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WF9TTkvGrqv_bsMH."/></div></div></figure><p id="8b9c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此时，请转到您的域名注册机构，使用新管理区域中的DNS服务器。以下是它在谷歌域名中的样子:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="er es mt"><img src="../Images/62f2bdba879f090b94a28aee9cb8f26c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_Jl-H0yS_UPPHzk0."/></div></div></figure><h1 id="2754" class="lm kn hi bd ko ln lx lp ks lq ly ls kw io lz ip kz ir ma is lc iu mb iv lf lw bi translated">步骤2:创建集群</h1><p id="afb0" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">轻松有趣的一步。让我们将两个小型Kubernetes集群联合起来。</p><p id="5cd3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建第一个群集(让我们使用us-west1数据中心):</p><pre class="jt ju jv jw fd mc md me mf aw mg bi"><span id="c2ab" class="km kn hi md b fi mh mi l mj mk">gcloud container clusters create west-cluster \<br/>  --zone us-west1-a --scopes cloud-platform</span></pre><p id="66ba" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在是第二个(让我们使用us-east1数据中心):</p><pre class="jt ju jv jw fd mc md me mf aw mg bi"><span id="da06" class="km kn hi md b fi mh mi l mj mk">gcloud container clusters create east-cluster \<br/>  --zone us-east1-b --scopes cloud-platform</span></pre><p id="9b15" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">几分钟后，两个集群都应该启动并运行。</p><h1 id="714c" class="lm kn hi bd ko ln lx lp ks lq ly ls kw io lz ip kz ir ma is lc iu mb iv lf lw bi translated">步骤3:创建联合控制平面</h1><p id="e48e" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">联合控制平面管理所有联合集群的全局状态。有趣的是，控制平面可以自托管在您的Kubernetes集群中，因此您甚至不需要设置任何额外的东西！</p><blockquote class="mu mv mw"><p id="eef9" class="ix iy mx iz b ja jb ij jc jd je im jf my jh ji jj mz jl jm jn na jp jq jr js hb bi translated">N <!-- -->注意:即使控制平面群集关闭，其他群集本身也是独立的，因此它们将继续运行，直到控制平面恢复运行。您仍然可以单独控制各个集群！这意味着您不必担心一个单一的故障会使您的所有集群瘫痪！</p></blockquote><p id="a653" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先需要找到Kubernetes集群的上下文名称。运行以下命令:</p><pre class="jt ju jv jw fd mc md me mf aw mg bi"><span id="2037" class="km kn hi md b fi mh mi l mj mk">kubectl config get-contexts</span></pre><p id="edf9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您应该会看到如下输出:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="er es nb"><img src="../Images/4d90f77f0a34b2061565216bbd514837.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vDLeSIPknn9aGk6D."/></div></div></figure><p id="edb4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以看到每个集群都有自己的上下文，小星星表示当前哪个上下文是活动的。</p><p id="418d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里还需要做一个额外的步骤。Kubernetes联邦使用上下文名称来设置联邦秘密，但是它需要符合<a class="ae ke" href="https://kubernetes.io/docs/tasks/federation/set-up-cluster-federation-kubefed/#secret-name" rel="noopener ugc nofollow" target="_blank"> RFC1123规范</a>。这意味着您需要重命名上下文。您可以使用以下命令来完成此操作:</p><pre class="jt ju jv jw fd mc md me mf aw mg bi"><span id="048d" class="km kn hi md b fi mh mi l mj mk">#East Cluster </span><span id="9665" class="km kn hi md b fi nc mi l mj mk">kubectl config set-context east-coast \<br/>   --cluster gke_$(PROJECT_ID)_$(CLUSTER_ZONE)_east_cluster \<br/>   --user gke_$(PROJECT_ID)_$(CLUSTER_ZONE)_east_cluster</span><span id="d247" class="km kn hi md b fi nc mi l mj mk">kubectl config delete-context \<br/>    gke_$(PROJECT_ID)_$(CLUSTER_ZONE)_east_cluster</span><span id="5f9c" class="km kn hi md b fi nc mi l mj mk">#West Cluster</span><span id="f6bd" class="km kn hi md b fi nc mi l mj mk">kubectl config set-context west-coast \<br/>   --cluster gke_$(PROJECT_ID)_$(CLUSTER_ZONE)_west_cluster \<br/>   --user gke_$(PROJECT_ID)_$(CLUSTER_ZONE)_west_cluster</span><span id="33f1" class="km kn hi md b fi nc mi l mj mk">kubectl config delete-context \<br/>    gke_$(PROJECT_ID)_$(CLUSTER_ZONE)_west_cluster</span></pre><p id="7914" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">根据需要替换$(CLUSTER_ZONE)和$(PROJECT_ID)。</p><p id="7f24" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了使部署联邦的过程更容易，我们将使用<a class="ae ke" href="https://kubernetes.io/docs/tutorials/federation/set-up-cluster-federation-kubefed/#getting-kubefed" rel="noopener ugc nofollow" target="_blank"> kubefed </a>工具。让我们使用西海岸集群来托管控制平面(因为西海岸=最佳海岸)。</p><pre class="jt ju jv jw fd mc md me mf aw mg bi"><span id="adaf" class="km kn hi md b fi mh mi l mj mk">kubefed init kfed \<br/>  --host-cluster-context=west-coast \<br/>  --dns-zone-name="infra.mycompany.com.<br/>  --dns-provider="google-clouddns"</span></pre><p id="122f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="mx">注意dns区域名称末尾的尾随句点。这一点很重要！</em></p><p id="14e9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此时，将部署联合控制平面。给它一两分钟来完全展开。这个命令将创建一个名为“kfed”的“虚拟”上下文当您使用“kfed”上下文时，您正在处理所有的联合集群。</p><h1 id="94a8" class="lm kn hi bd ko ln lx lp ks lq ly ls kw io lz ip kz ir ma is lc iu mb iv lf lw bi translated">步骤4:联合集群</h1><p id="dc8c" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">下一步是将两个集群都添加到联合控制平面。您也可以使用kubefed工具来完成这项工作。</p><pre class="jt ju jv jw fd mc md me mf aw mg bi"><span id="9f67" class="km kn hi md b fi mh mi l mj mk">kubefed --context=kfed join west-cluster \<br/>  --cluster-context=west-coast \<br/>  --host-cluster-context=west-coast</span><span id="647a" class="km kn hi md b fi nc mi l mj mk">kubefed --context=kfed join east-cluster \<br/>  --cluster-context=east-coast \<br/>  --host-cluster-context=west-coast</span></pre><p id="f6ca" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用这两个命令，两个集群现在都联合起来了！您可以使用以下命令检查所有联合集群的状态:</p><pre class="jt ju jv jw fd mc md me mf aw mg bi"><span id="7b45" class="km kn hi md b fi mh mi l mj mk">kubectl --context=kfed get clusters</span><span id="80da" class="km kn hi md b fi nc mi l mj mk">NAME          STATUS  AGE<br/>east-cluster  Ready   15s<br/>west-cluster  Ready   42s</span></pre><p id="4a11" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">kubefed 目前有一个问题，阻止它创建默认名称空间。运行以下命令来修复它:</p><pre class="jt ju jv jw fd mc md me mf aw mg bi"><span id="5251" class="km kn hi md b fi mh mi l mj mk">kubectl --context=kfed create ns default</span></pre><h1 id="b110" class="lm kn hi bd ko ln lx lp ks lq ly ls kw io lz ip kz ir ma is lc iu mb iv lf lw bi translated">步骤5:设置集群DNS</h1><p id="67af" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">现在已经设置了联合，您必须确保每个集群中的DNS服务器知道使用您创建的DNS区域来执行跨集群服务发现。</p><p id="4c11" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第一步是创建一个配置映射，Kubernetes DNS控制器将自动使用它来连接到DNS区域</p><pre class="jt ju jv jw fd mc md me mf aw mg bi"><span id="687a" class="km kn hi md b fi mh mi l mj mk">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: kube-dns<br/>  namespace: kube-system<br/>data:<br/>  federations: kfed=infra.mycompany.com</span></pre><p id="e39a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将域名替换为您的域名，并将文件保存为<em class="mx"> kubedns-config.yaml </em></p><p id="684a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在创建配置图:</p><pre class="jt ju jv jw fd mc md me mf aw mg bi"><span id="5020" class="km kn hi md b fi mh mi l mj mk">kubectl --context=kfed apply -f kubedns-config.yaml</span></pre><p id="7ebb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">需要记住的一件重要事情是，在运行kubectl命令时要使用正确的上下文。如果在联合上下文上运行命令，这些命令通常会传播到底层集群。如果您在单个集群上运行命令，这些命令将保留在该集群中。</p><p id="4979" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">就是这样！您已经成功地创建了一组联合kubernetes集群！</p><p id="438f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">阅读</strong> <a class="ae ke" rel="noopener" href="/@SandeepDinesh/planet-scale-microservices-with-cluster-federation-and-global-load-balancing-on-kubernetes-and-cd182f981653"> <strong class="iz hj">第2部分</strong> </a> <strong class="iz hj">我们在那里设置联邦入口！</strong></p></div></div>    
</body>
</html>