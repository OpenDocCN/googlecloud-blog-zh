<html>
<head>
<title>Import JSON into BigQuery with Google Cloud Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Google Cloud函数将JSON导入BigQuery</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/import-json-into-bigquery-with-google-cloud-functions-31facea134bf?source=collection_archive---------0-----------------------#2018-11-30">https://medium.com/google-cloud/import-json-into-bigquery-with-google-cloud-functions-31facea134bf?source=collection_archive---------0-----------------------#2018-11-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a682" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/bigquery/what-is-bigquery" rel="noopener ugc nofollow" target="_blank"> BigQuery </a>是构建<a class="ae jd" href="https://cloud.google.com/solutions/bigquery-data-warehouse" rel="noopener ugc nofollow" target="_blank">数据仓库</a>的强大工具，允许你存储海量数据并执行超快SQL查询，而无需构建或管理任何基础设施。</p><p id="f11b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">典型的<a class="ae jd" href="https://en.wikipedia.org/wiki/Extract,_transform,_load" rel="noopener ugc nofollow" target="_blank"> ETL </a>过程包括三个步骤:</p><ol class=""><li id="44e2" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated"><strong class="ih hj">提取:</strong>从一个数据源中提取数据，比如一个数据库(LDAP、MySQL、MongoDB等。)或者一个API (GitHub，Google，Workday等。)</li><li id="c816" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><strong class="ih hj">转换:</strong>为目的地准备源数据(如有必要)。</li><li id="f599" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><strong class="ih hj">加载:</strong>将准备好的数据导入目的地。</li></ol><p id="4613" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不管您的数据源和准备数据需要采取的步骤是什么，都有几个将数据加载到BigQuery 的选项。对于这个例子，我们将<a class="ae jd" href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage" rel="noopener ugc nofollow" target="_blank">从云存储</a>加载数据，特别是<a class="ae jd" href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-json" rel="noopener ugc nofollow" target="_blank"> JSON </a>。</p><p id="dffa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你的换行符分隔的JSON文件准备好加载，你就可以<a class="ae jd" href="https://cloud.google.com/storage/docs/uploading-objects" rel="noopener ugc nofollow" target="_blank">将它上传</a>到一个<a class="ae jd" href="https://cloud.google.com/storage/" rel="noopener ugc nofollow" target="_blank">云存储</a>桶，然后有几个如何将它放入BigQuery的选项。</p><ul class=""><li id="c08f" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc js jk jl jm bi translated"><a class="ae jd" href="https://cloud.google.com/bigquery/docs/cloud-storage-transfer" rel="noopener ugc nofollow" target="_blank"> BigQuery数据传输服务</a>(安排GCS的重复数据加载。)</li><li id="087c" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc js jk jl jm bi translated">创建一个新的<a class="ae jd" href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-json#loading_json_data_into_a_table" rel="noopener ugc nofollow" target="_blank">装载任务</a>。</li></ul><p id="1de9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们希望能够随时加载新数据，而不是等待下一个计划的作业运行。因此，我们不使用数据传输服务，而是希望在文件上传后立即创建一个<a class="ae jd" href="https://cloud.google.com/bigquery/docs/reference/rest/v2/jobs#configuration.load" rel="noopener ugc nofollow" target="_blank">加载作业</a>。为了使事情尽可能简单，我们还想启用<a class="ae jd" href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-json#loading_json_data_with_schema_auto-detection" rel="noopener ugc nofollow" target="_blank">模式自动检测</a>。</p><p id="7e0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于我们希望在每次有新文件上传到GCS时创建一个加载作业，所以我们可以简单地创建一个<a class="ae jd" href="https://cloud.google.com/functions/" rel="noopener ugc nofollow" target="_blank">云函数</a>来响应<a class="ae jd" href="https://cloud.google.com/functions/docs/calling/storage" rel="noopener ugc nofollow" target="_blank"> Google云存储触发器</a>。</p><h1 id="de9a" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">体系结构</h1><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es kr"><img src="../Images/56a6a8ca382c5ceae9eaf758aeff552f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Uz5L09CruXbpj2rWPu35eg.png"/></div></div></figure><p id="7c3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用这种设计，将数据放入BigQuery的过程非常简单:</p><ol class=""><li id="1a62" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">从数据源提取数据。</li><li id="17f9" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">将数据传输到换行符分隔的JSON中。</li><li id="b788" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">将JSON文件上传到GCS bucket。</li></ol><p id="1e98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当一个新文件被上传到正确的GCS bucket时，Cloud函数被启动并创建一个新的带有模式自动检测的加载作业，它将数据加载到一个BigQuery表中。</p><h1 id="d66b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">来源</h1><p id="be5f" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">GitHub上提供了云函数的源代码:</p><div class="li lj ez fb lk ll"><a href="https://github.com/lukwam/gcs-bigquery-import" rel="noopener  ugc nofollow" target="_blank"><div class="lm ab dw"><div class="ln ab lo cl cj lp"><h2 class="bd hj fi z dy lq ea eb lr ed ef hh bi translated">lukwam/gcs-bigquery-import</h2><div class="ls l"><h3 class="bd b fi z dy lq ea eb lr ed ef dx translated">将JSON文件从GCS导入big query-luk wam/GCS-big query-Import的云函数</h3></div><div class="lt l"><p class="bd b fp z dy lq ea eb lr ed ef dx translated">github.com</p></div></div><div class="lu l"><div class="lv l lw lx ly lu lz lb ll"/></div></div></a></div><h1 id="55f4" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">装置</h1><p id="c9a8" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">目前，这一切都假设您使用单个项目来托管BigQuery数据集、云函数和云存储桶，因此计算服务帐户上的默认IAM权限应该足够了。如果您的BigQuery数据位于不同于Bucket和Cloud函数的项目中，您将需要授予BigQuery IAM对计算服务帐户的访问权限。</p><ol class=""><li id="2498" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">如果您还没有GCP项目，请创建一个。</li><li id="6fe4" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">在项目中创建一个GCS Bucket。</li><li id="3610" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">更新<code class="du ma mb mc md b">deploy.sh</code>脚本以反映你的<code class="du ma mb mc md b">BUCKET</code>和<code class="du ma mb mc md b">PROJECT</code>。</li><li id="8693" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">运行<code class="du ma mb mc md b">deploy.sh</code>将云功能部署到您的项目中。</li></ol><h1 id="d0b2" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">使用</h1><ol class=""><li id="d064" class="je jf hi ih b ii ld im le iq me iu mf iy mg jc jj jk jl jm bi translated">用您的数据创建换行符分隔的JSON文件。</li><li id="b785" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">将JSON文件作为<code class="du ma mb mc md b">DATASET/TABLE.json</code>上传到GCS bucket，其中<code class="du ma mb mc md b">DATASET</code>和<code class="du ma mb mc md b">TABLE</code>反映了您想要存储数据的BigQuery数据集和表的名称。</li></ol><p id="b59c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦JSON文件被上传到GCS Bucket，Cloud函数就会运行，确定数据集和表的名称(基于文件名)，然后创建一个启用了模式自动检测的新加载作业。</p><p id="bde3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果一切顺利，您可以为您的项目加载<a class="ae jd" href="https://console.cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank"> BigQuery控制台</a>，您将看到新创建的数据集和包含您的数据的表。</p><p id="b2dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，开始编写一些SQL查询，尽情享受吧！</p></div></div>    
</body>
</html>