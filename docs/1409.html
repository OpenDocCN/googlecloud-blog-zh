<html>
<head>
<title>Migrating Data Processing Hadoop Workloads to GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将数据处理Hadoop工作负载迁移到GCP</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/migrating-hadoop-to-dataproc-43e8da80ba98?source=collection_archive---------1-----------------------#2020-04-30">https://medium.com/google-cloud/migrating-hadoop-to-dataproc-43e8da80ba98?source=collection_archive---------1-----------------------#2020-04-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="573a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由<a class="jd je ge" href="https://medium.com/u/a6b6f3f74b22?source=post_page-----43e8da80ba98--------------------------------" rel="noopener" target="_blank">阿南特·达姆勒</a>和<a class="jd je ge" href="https://medium.com/u/928d430b6859?source=post_page-----43e8da80ba98--------------------------------" rel="noopener" target="_blank">瓦伦·杜莎</a>撰写</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/fae0cd4f55126a41ec6e08a04a109cb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v1YJ9EU7qajT_pnADruKdQ.png"/></div></div></figure><p id="e85e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">花一个不眠之夜让管道在Hadoop集群上工作听起来很熟悉，不是吗？数据工程师的角色包括从开发到开发运维的一系列活动。与不断增长的Hadoop生态系统一起工作是一项具有挑战性的工作。当你花更多的时间让大象动起来的时候，开发一个管道似乎是比较容易的部分！</p><p id="321b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您正在考虑将您的基础设施迁移到Google Cloud，您遇到了Google Cloud的托管开源数据和分析处理平台<a class="ae jr" href="https://cloud.google.com/dataproc" rel="noopener ugc nofollow" target="_blank"> Dataproc </a>。Dataproc允许您在云中无缝地运行Apache Spark和Hadoop作业。这听起来不错，而且你很感兴趣，但是迁移可能是乏味和可怕的…让我们打破它并简化它！</p><h1 id="5d26" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">创建和配置集群</h1><p id="de3f" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">使用Dataproc创建Hadoop集群就像发出一个命令一样简单。集群可以使用Dataproc提供的<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/versioning/dataproc-versions" rel="noopener ugc nofollow" target="_blank">映像版本</a>之一，或者基于提供的映像版本之一的<a class="ae jr" href="https://cloud.google.com/dataproc/docs/guides/dataproc-images" rel="noopener ugc nofollow" target="_blank">自定义映像</a>。一个<em class="kv">镜像版本</em>是操作系统、大数据组件和谷歌云连接器的一个稳定且受支持的包。</p><p id="fbbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用最新的映像版本(这是默认版本)，或者<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/versioning/overview#selecting_versions" rel="noopener ugc nofollow" target="_blank">选择一个与您现有平台匹配的映像</a>。你也可以选择额外的<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/components/overview" rel="noopener ugc nofollow" target="_blank">支持的组件</a>比如德鲁伊和Presto。如果您正在使用诸如<a class="ae jr" href="https://livy.apache.org/" rel="noopener ugc nofollow" target="_blank"> Livy </a>之类还不可用的组件，您可以利用<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/init-actions" rel="noopener ugc nofollow" target="_blank">初始化操作</a>，它会在集群设置完成后立即在集群的每个节点上运行可执行文件或脚本。</p><p id="b691" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以选择创建一个带有一个主节点的标准集群，或者创建一个带有三个主节点的<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/high-availability" rel="noopener ugc nofollow" target="_blank">高可用性</a>集群。高可用性选项非常适合始终在线的长时间运行的集群。如果你想马上开始，启动你的<a class="ae jr" href="https://console.cloud.google.com/home/dashboard?cloudshell=true" rel="noopener ugc nofollow" target="_blank">云外壳</a>并运行下面的命令:</p><pre class="jg jh ji jj fd kw kx ky kz aw la bi"><span id="4cca" class="lb jt hi kx b fi lc ld l le lf"># create a cluster in us-central1<br/>gcloud dataproc clusters create <strong class="kx hj">my-first-cluster</strong> \<br/>--region=<strong class="kx hj">us-central1</strong></span></pre><h1 id="0adb" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">储存；储备</h1><p id="2d8e" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">在您创建了一个集群并向其中添加了任何可选组件之后，您需要解决这个问题。你有很多数据，而且每天都在增加。你如何把它转移到谷歌云？这些<a class="ae jr" href="https://cloud.google.com/solutions/migration-to-google-cloud-transferring-your-large-datasets#what_is_data_transfer" rel="noopener ugc nofollow" target="_blank">数据传输选项</a>中的一些可以在旅途中指引你。</p><p id="7a18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过将<a class="ae jr" href="https://cloud.google.com/persistent-disk/" rel="noopener ugc nofollow" target="_blank">持久性磁盘(PD) </a>附加到集群中的节点来创建传统的HDFS设置。</p><p id="d966" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个流行和推荐的替代方案是使用<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/connectors/cloud-storage" rel="noopener ugc nofollow" target="_blank"> Google云存储</a>作为持久层。因为云存储是一个高度可扩展和持久的存储系统，它提供了非常一致的操作，它减少了HDFS中涉及的管理开销。要从HDFS切换到云存储，只需将文件路径前缀从hdfs://更改为gs://。您还可以使用<a class="ae jr" href="https://cloud.google.com/blog/products/data-analytics/getting-started-with-new-table-formats-on-dataproc" rel="noopener ugc nofollow" target="_blank">表格式</a>，例如<a class="ae jr" href="https://delta.io/" rel="noopener ugc nofollow" target="_blank"> Delta Lake </a>和<a class="ae jr" href="https://iceberg.apache.org/" rel="noopener ugc nofollow" target="_blank"> Iceberg </a>用于模式支持、ACID事务和数据版本控制。<a class="ae jr" href="https://cloud.google.com/blog/products/storage-data-transfer/hdfs-vs-cloud-storage-pros-cons-and-migration-tips" rel="noopener ugc nofollow" target="_blank">为集群选择合适的存储技术</a>，因为没有一种解决方案适用于所有使用情形。</p><p id="d946" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不管您选择什么样的存储，您都应该通过使用CloudSQL 上的<a class="ae jr" href="https://cloud.google.com/sql/docs/mysql" rel="noopener ugc nofollow" target="_blank"> MySQL作为您的数据库，为您的Dataproc集群使用</a><a class="ae jr" href="https://cloud.google.com/solutions/using-apache-hive-on-cloud-dataproc" rel="noopener ugc nofollow" target="_blank"> central Hive Metastore </a>。</p><p id="785d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到时候，考虑迁移到<a class="ae jr" href="https://cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank"> BigQuery </a>，一个无服务器的Pb级数据仓库。为了简化这种迁移，Dataproc附带了<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/connectors/bigquery" rel="noopener ugc nofollow" target="_blank"> BigQuery连接器</a>和<a class="ae jr" href="https://github.com/GoogleCloudDataproc/spark-bigquery-connector" rel="noopener ugc nofollow" target="_blank"> BigQuery Spark连接器</a>。</p><h1 id="c88b" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">数据处理</h1><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es lg"><img src="../Images/512aef1a6d9cd351a2714a5754eb3933.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cUhvN4zoQiDIQy4YN0Y-9w.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">在Dataproc上运行作业的典型架构</figcaption></figure><p id="356c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在集群准备就绪且数据可访问后，您需要处理和分析数据。您需要运行复杂的管道来连接来自多个来源的数据以生成报告。您可能还需要支持数据分析师，他们使用Hive、SparkSQL或Presto等组件对数据运行特定的SQL查询。</p><p id="71db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Dataproc使得使用<a class="ae jr" href="https://cloud.google.com/dataproc/docs/guides/submit-job" rel="noopener ugc nofollow" target="_blank"> Dataproc API，</a>的<a class="ae jr" href="https://cloud.google.com/dataproc/docs/reference/rest/v1/projects.regions.jobs/submit" rel="noopener ugc nofollow" target="_blank"> jobs.submit </a>方法向集群提交作业变得非常简单，而不需要设置perimeter实例。它使用中央<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/iam/iam" rel="noopener ugc nofollow" target="_blank">身份和访问管理层</a>来验证和授权请求，允许您在私有集群上尽可能安全地运行作业。尝试Cloud Shell上的命令，在您之前创建的集群上运行一个计算Pi值的程序。</p><pre class="jg jh ji jj fd kw kx ky kz aw la bi"><span id="84f7" class="lb jt hi kx b fi lc ld l le lf"># Submit a Spark job using Dataproc API<br/># Outputs: Pi is roughly 3.1419864714198646<br/>gcloud dataproc jobs submit spark \<br/>--cluster <strong class="kx hj">my-first-cluster </strong>--region <strong class="kx hj">us-central1</strong> \<br/>--class org.apache.spark.examples.SparkPi \<br/>--jars file:///usr/lib/spark/examples/jars/spark-examples.jar \<br/>-- 1000</span></pre><p id="f5ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于涉及形成有向无环图(DAG)的多个相互依赖的作业的更复杂的工作负载，您可以使用<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/workflows/overview" rel="noopener ugc nofollow" target="_blank"> Dataproc工作流模板</a>。您可以将Dataproc API与<a class="ae jr" href="https://cloud.google.com/composer" rel="noopener ugc nofollow" target="_blank"> Cloud Composer </a>、Google Cloud的托管版<a class="ae jr" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Airflow </a>一起使用。</p><p id="b271" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Hive、Presto和SparkSQL引擎通常用于数据分析师的即席查询和提供报告仪表板。<a class="ae jr" rel="noopener" href="/@david.cueva/connecting-your-visualization-software-to-hadoop-on-google-cloud-64b55f536fab">阅读更多关于在您的Dataproc集群中使用它们的</a>。</p><h1 id="15cc" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">监控和安全</h1><p id="e4e9" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">中央<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/iam/iam" rel="noopener ugc nofollow" target="_blank">身份和访问管理层</a>支持使用云日志轻松访问作业输出或审计跟踪<a class="ae jr" href="https://cloud.google.com/dataproc/docs/guides/logging" rel="noopener ugc nofollow" target="_blank">。为了管理和监控集群的资源和应用，</a><a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/accessing/dataproc-gateways" rel="noopener ugc nofollow" target="_blank">启用Dataproc组件网关</a>来帮助安全地访问Hadoop web界面。使用<a class="ae jr" href="https://cloud.google.com/dataproc/docs/guides/monitoring" rel="noopener ugc nofollow" target="_blank">云监控</a>或<a class="ae jr" href="https://cloud.google.com/dataproc/docs/guides/profiling" rel="noopener ugc nofollow" target="_blank">云分析</a>用于您的高级用例，如健康和性能监控、生成见解或仪表盘。</p><h1 id="2403" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">最佳化</h1><p id="412e" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">既然您已经迁移了数据平台，您希望对其进行优化以降低运营开销和成本。通过使用云存储作为您的存储和外部Hive Metastore，您已经分离了存储和计算。这使您可以专注于工作负载，而不是集群。再加上Dataproc、central IAM和logging的90秒集群创建时间，您可以按需创建临时集群，一旦您的管道执行完成，这些集群就会被删除。</p><p id="944f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了帮助确保安全性和隔离，使用单独的<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/service-accounts" rel="noopener ugc nofollow" target="_blank">服务帐户</a>运行每个集群，并且只能访问作业所需的资源。此服务帐户在监控、审核和调试时也很有帮助。由于工作流之间没有相互依赖关系，因此您可以轻松测试和部署不同版本的Hadoop组件和您的服务。由于集群并不总是开启，因此可以节省成本。通过使用<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/compute/preemptible-vms#how_preemptibles_work_with" rel="noopener ugc nofollow" target="_blank">可抢占的实例</a>来运行您的任务，您可以进一步降低成本，因为它们的价格更低。请记住，不要在与HDFS相关的任务中使用它们，因为它们随时可能被抢占。</p><p id="5eb4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行集群时的一个常见开销是调整大小，以处理突发负载，如流处理或即席数据分析查询。Dataproc提供了<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/scaling-clusters" rel="noopener ugc nofollow" target="_blank">手动缩放</a>和<a class="ae jr" href="https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/autoscaling" rel="noopener ugc nofollow" target="_blank">自动缩放</a>，使用纱线度量来控制节点的数量。</p><p id="a5d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">说够了，我让你自己尝试一下<a class="ae jr" href="https://cloud.google.com/dataproc/docs/quickstarts" rel="noopener ugc nofollow" target="_blank">快速入门</a></p></div></div>    
</body>
</html>