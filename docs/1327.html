<html>
<head>
<title>A Hitchhiker’s Guide to GCP Service Account Impersonation in Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform中GCP服务帐户模拟的搭便车指南</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/a-hitchhikers-guide-to-gcp-service-account-impersonation-in-terraform-af98853ebd37?source=collection_archive---------0-----------------------#2020-03-17">https://medium.com/google-cloud/a-hitchhikers-guide-to-gcp-service-account-impersonation-in-terraform-af98853ebd37?source=collection_archive---------0-----------------------#2020-03-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8488" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">围绕机密管理，我不断听到的最常见的GCP问题之一是在使用服务帐户密钥时最大限度地降低风险和减少总体攻击面。如果您使用过Google Cloud Platform，很有可能您已经生成了至少一个(如果不是很多)服务帐户密钥，并将文件存储在本地、存储桶或保险库中(这里存储它们需要+1)。我想讨论的一个主题是通过讨论服务帐户模拟的引入和操作的最佳实践，最大限度地减少潜在的服务帐户密钥暴露。</p><p id="63be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GCP服务帐户密钥使用的一个主要用例恰好是大量的Terraform示例，建议您使用下面引用的credentials属性初始化提供者。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="7c81" class="jm jn hi ji b fi jo jp l jq jr">provider “google” {<br/> credentials = file(“account.json”)<br/> project = “my-project-id”<br/> region = “us-central1”<br/>}</span></pre><p id="6468" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这表明生成用户管理的服务帐户密钥文件和在用户设备上本地存储该密钥文件的必要性。</p><h1 id="7825" class="js jn hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">自管理密钥会带来一些潜在风险:</h1><ul class=""><li id="983d" class="kp kq hi ih b ii kr im ks iq kt iu ku iy kv jc kw kx ky kz bi translated">服务帐户密钥提交到Github或相关VCS的可能性</li><li id="881f" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">用户笔记本电脑上到处都是服务帐户密钥文件</li><li id="8870" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">围绕服务客户密钥管理的适当治理标准的潜在忽视</li><li id="97ec" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">如果没有适当的服务帐户密钥清理，可能会为同一组服务帐户生成多个密钥</li></ul><p id="214b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是嘿。作为代码的基础设施是推荐的方法，如果我必须运行Terraform，我需要利用本地存储的服务帐户密钥。对吗？不，不完全是。</p><p id="dc63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为一种直接的替代方法，我们将把服务帐户模拟引入其中。可以利用它来消除拥有服务帐户密钥文件的需要。在这篇博客中，我们将访问专门围绕运行Terraform的场景。只要授予了适当的角色，就可以通过用户或服务帐户进行服务帐户模拟。</p><h1 id="5822" class="js jn hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">让我们看看利用服务帐户模拟的一些好处:</h1><ul class=""><li id="7946" class="kp kq hi ih b ii kr im ks iq kt iu ku iy kv jc kw kx ky kz bi translated">通过消除服务帐户密钥来减少攻击面(针对Terraform)</li><li id="7c33" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">清楚地确定谁(组、用户、服务帐户)应该能够模拟更高特权的帐户</li><li id="6acf" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">依靠用户身份验证的安全性，而不是密钥文件(通常涉及多因素身份验证)</li><li id="798c" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">依靠谷歌托管服务账户密钥</li><li id="3573" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">与短期凭据一起使用，允许对服务帐户拥有的角色进行有时间限制的访问。</li></ul><h1 id="9a7d" class="js jn hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">因此，我们今天使用服务帐户密钥来运行Terraform…我们如何过渡？</h1><p id="f42b" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">我将重点介绍三个步骤。</p><p id="db74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第一步。设置注意事项</strong></p><p id="6245" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们今天在GCP项目中有一个基础设施部署(通过Terraform)的服务帐户。该帐户通常拥有更高的特权集。</p><ol class=""><li id="8fb3" class="kp kq hi ih b ii ij im in iq li iu lj iy lk jc ll kx ky kz bi translated">移除GCP项目中特定于Terraform服务帐户的现有用户管理密钥</li><li id="29e8" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc ll kx ky kz bi translated">接下来，删除在GCP项目中生成服务帐户密钥的功能</li><li id="0704" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc ll kx ky kz bi translated">我们希望删除角色，如<strong class="ih hj">角色/所有者</strong>、<strong class="ih hj">角色/编辑</strong>或<strong class="ih hj">角色/iam.serviceAccountKeyAdmin </strong></li><li id="f3a1" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc ll kx ky kz bi translated">确定应该有权模拟的<strong class="ih hj">用户、组或服务帐户</strong>，并在<strong class="ih hj"> Terraform服务帐户的iam策略</strong>上授予其角色<strong class="ih hj">roles/IAM . serviceaccountokencreator</strong>。<br/> <strong class="ih hj">注意:</strong>这不是一个项目IAM绑定；这是一个<strong class="ih hj">服务帐户</strong> IAM绑定。</li><li id="d3a8" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc ll kx ky kz bi translated">假设我们已经有一个定义了“足够权限”来部署基础设施的terraform服务帐户，我们将把该帐户指定为我们将模拟的帐户。</li></ol><figure class="jd je jf jg fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lm"><img src="../Images/e92204cefb35e903b03996f072854db2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iScBxaKPuLk9f_7U"/></div></div></figure><ul class=""><li id="0867" class="kp kq hi ih b ii ij im in iq li iu lj iy lk jc kw kx ky kz bi translated">点击“添加成员”(在页面右侧的信息面板上)</li></ul><figure class="jd je jf jg fd ln er es paragraph-image"><div class="er es lu"><img src="../Images/ce1666569e875983c2eb502b0cdabf0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/0*JWBs0r05OwoSWsrh"/></div></figure><ul class=""><li id="9539" class="kp kq hi ih b ii ij im in iq li iu lj iy lk jc kw kx ky kz bi translated">将关联的组、用户或服务帐户添加为成员，并添加两个角色:<strong class="ih hj">roles/iam . serviceaccountokencreator</strong>。</li></ul><figure class="jd je jf jg fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lv"><img src="../Images/7f2e8dd782633925603d9596d11ee866.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3768LDL1FnqpHXjWwkndLw.png"/></div></div></figure><p id="c3ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤二。更新并运行你的地形代码</strong></p><p id="fcbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们已经完成了上述步骤，让我们更新我们的Terraform代码。我们的示例文件<strong class="ih hj"> main.tf </strong>的一组简单步骤将使我们开始利用模拟。</p><ol class=""><li id="78ed" class="kp kq hi ih b ii ij im in iq li iu lj iy lk jc ll kx ky kz bi translated">使用<a class="ae lw" href="https://cloud.google.com/docs/authentication/production" rel="noopener ugc nofollow" target="_blank">应用默认凭证</a> (ADC)</li></ol><ul class=""><li id="7e85" class="kp kq hi ih b ii ij im in iq li iu lj iy lk jc kw kx ky kz bi translated">您需要作为有权模拟Terraform服务帐户的用户或服务帐户进行身份验证。使用<code class="du lx ly lz ji b">gcloud auth application-default login</code>登录后，Terraform将作为您的ADC执行。</li></ul><p id="c763" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.在有限的时间内模拟服务帐户</p><ul class=""><li id="4d9c" class="kp kq hi ih b ii ij im in iq li iu lj iy lk jc kw kx ky kz bi translated">需要更新一些cookie cutter提供程序定义来引用google.tokengen提供程序。此外，在第12行的“Google _ service _ account _ access _ token”块中，有一个“lifetime”属性，它允许我们指定在模拟期间请求的访问令牌将持续的时间长度。根据基础设施部署的规模，我们可能需要相应地修改生命周期。对于大多数情况，用访问令牌模拟服务帐户600秒或10分钟就足够了。</li></ul><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="a1ac" class="jm jn hi ji b fi jo jp l jq jr">provider "google" {<br/>  version = "~&gt; 2.0, &gt;= 2.5.1"<br/>  alias   = "tokengen"<br/>}</span><span id="221b" class="jm jn hi ji b fi ma jp l jq jr">data "google_client_config" "default" {<br/>  provider = "google.tokengen"<br/>}</span><span id="3af9" class="jm jn hi ji b fi ma jp l jq jr">data "google_service_account_access_token" "sa" {<br/>  provider               = "google.tokengen"<br/>  target_service_account = "<a class="ae lw" href="mailto:terraform@my-project-id.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">terraform@my-project-id.iam.gserviceaccount.com</a>"<br/>  lifetime               = "600s"</span><span id="a4f9" class="jm jn hi ji b fi ma jp l jq jr">scopes = [<br/>    "<a class="ae lw" href="https://www.googleapis.com/auth/cloud-platform" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/cloud-platform</a>",<br/>  ]<br/>}</span><span id="e636" class="jm jn hi ji b fi ma jp l jq jr">/******************************************<br/>  GA Provider configuration<br/> *****************************************/<br/>provider "google" {<br/>  version      = "~&gt; 2.0, &gt;= 2.5.1"<br/>  access_token = data.google_service_account_access_token.sa.access_token<br/>  project      = "my-project-id"<br/>}</span><span id="18fd" class="jm jn hi ji b fi ma jp l jq jr">/******************************************<br/>  Beta Provider configuration<br/> *****************************************/<br/>provider "google-beta" {<br/>  version      = "~&gt; 2.0, &gt;= 2.5.1"<br/>  access_token = data.google_service_account_access_token.sa.access_token<br/>  project      = "my-project-id"<br/>}</span><span id="1363" class="jm jn hi ji b fi ma jp l jq jr">resource "google_storage_bucket" "test" {<br/>  name     = "my-project-id-test-bucket"<br/>  location = "us-west1"<br/>}</span></pre><ul class=""><li id="e334" class="kp kq hi ih b ii ij im in iq li iu lj iy lk jc kw kx ky kz bi translated">作为安慰，我们将部署一个简单的GCS测试桶。</li></ul><p id="2b0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.现在，您已经准备好运行您的Terraform代码了。</p><ul class=""><li id="3b5c" class="kp kq hi ih b ii ij im in iq li iu lj iy lk jc kw kx ky kz bi translated">`地形初始化'</li><li id="60bf" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">`地形图'</li><li id="8243" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">`应用地形'</li></ul><p id="d6bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你现在应该有一个GCS桶了！</p><p id="7caf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第三步。审计</strong></p><p id="51d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们不要忘记，当用户开始模拟服务帐户(生成访问令牌)时，我们要确保能够验证适当的审计跟踪。</p><ul class=""><li id="4cd2" class="kp kq hi ih b ii ij im in iq li iu lj iy lk jc kw kx ky kz bi translated">首先，我们应该确认为我们的项目启用了<a class="ae lw" href="https://cloud.google.com/logging/docs/audit/configure-data-access" rel="noopener ugc nofollow" target="_blank">数据访问日志</a>。</li><li id="693a" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">其次，只需导航到Stackdriver &gt; Logging并运行查询，如下所示:</li></ul><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="e5cc" class="jm jn hi ji b fi jo jp l jq jr">terraform@[MY-PROJECT-ID].iam.gserviceaccount.com AND logName=”projects/[MY-PROJECT-ID]/logs/cloudaudit.googleapis.com%2Fdata_access” AND protoPayload.methodName = “GenerateAccessToken”</span></pre><ul class=""><li id="d62f" class="kp kq hi ih b ii ij im in iq li iu lj iy lk jc kw kx ky kz bi translated">接下来，我们将得到一个包含一组日志的响应，这些日志包含IAM服务帐户凭据API何时被触发以及临时访问令牌何时生成的详细信息。</li></ul><figure class="jd je jf jg fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es mb"><img src="../Images/ec00cfbf490fc417665ec111eb25ce03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vCWLRMOmwZmsdZD1"/></div></div></figure><p id="bf2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">总之</strong></p><p id="f79a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我想强调一下在您的GCP环境中实施服务帐户模拟的好处和高级概述。服务帐户模拟使我们能够依靠Google托管密钥来利用用于Terraform基础设施部署目的的服务帐户。</p><p id="af08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一个主要好处是，它消除了用户围绕密钥轮换、创建和删除实施密钥管理过程的负担。服务帐户模拟的配置也迫使我们考虑哪些帐户应该能够在我们的项目中利用更多特权的服务帐户，并更好地让我们考虑在我们的项目中实现最少特权。实现服务帐户模拟还有许多其他好处，并且开销相当低，所以我建议您试一试。</p></div></div>    
</body>
</html>