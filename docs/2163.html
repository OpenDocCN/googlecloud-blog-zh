<html>
<head>
<title>How to start Jupyter in Google Cloud — the Python way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Google Cloud中启动Jupyter——Python方式</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-start-jupyter-in-google-cloud-the-python-way-7a70adb7b4b1?source=collection_archive---------0-----------------------#2022-04-18">https://medium.com/google-cloud/how-to-start-jupyter-in-google-cloud-the-python-way-7a70adb7b4b1?source=collection_archive---------0-----------------------#2022-04-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="47cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你知道你可以用Python SDK在谷歌云中轻松启动Jupyter笔记本吗？还有自动挂载GCS桶，加GPU还是用自己的容器？</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/dc7dfdf4739b4497a696c33b0cc9e9b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IeTjRslE-WG-or-U"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">照片由<a class="ae jt" href="https://unsplash.com/@blackodc?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">苏三·李</a>在<a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="0ea9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ju">这是用Python SDK操作GCP顶点人工智能系列的第一篇文章。订阅获取下一篇博文。</em></p><p id="f55f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌于2021年5月推出了新的机器学习平台Vertex AI，接替了之前的人工智能平台。他们还发布了多种语言的SDK。让我们把重点放在Python上，因为这将是许多数据科学家的首选。</p><h1 id="5f24" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">安装Python SDK</h1><p id="e23f" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">Google目前为Vertex AI服务维护了两个Python库:</p><ul class=""><li id="109c" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated"><em class="ju">Google-cloud-notebooks</em>——用于操作顶点人工智能工作台(又名GCP的Jupyter笔记本)</li><li id="d4e3" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated"><em class="ju">谷歌云平台</em>——用于操控其他一切</li></ul><p id="5acd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以现在，我们只安装笔记本库:</p><pre class="je jf jg jh fd lm ln lo lp aw lq bi"><span id="7d16" class="lr jw hi ln b fi ls lt l lu lv">pip install google-cloud-notebooks</span></pre><p id="d0cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于GCP Python库的文档有时很难找到，笔记本SDK在https://googleapis.dev/python/notebooks/latest/index.html<a class="ae jt" href="https://googleapis.dev/python/notebooks/latest/index.html" rel="noopener ugc nofollow" target="_blank">有描述。</a></p><h1 id="5a0e" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">使用谷歌云授权</h1><p id="cf0e" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">我将假设你已经创建了GCP项目和顶点人工智能是启用的。如果没有，请遵循<a class="ae jt" href="https://cloud.google.com/vertex-ai/docs/start/cloud-environment" rel="noopener ugc nofollow" target="_blank">官方文件</a>。</p><p id="4a86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有多种方法可以验证Google Cloud。出于我们的目的，我们将利用gcloud CLI工具。我们将在终端中登录，然后Python中的笔记本服务将能够自动获取凭证。</p><ol class=""><li id="1d3e" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc lw le lf lg bi translated"><a class="ae jt" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank">安装gcloud CLI工具</a></li><li id="f4fd" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc lw le lf lg bi translated"><a class="ae jt" href="https://cloud.google.com/sdk/gcloud/reference/auth/login" rel="noopener ugc nofollow" target="_blank">使用您的用户帐户登录g cloud</a></li></ol><pre class="je jf jg jh fd lm ln lo lp aw lq bi"><span id="bf10" class="lr jw hi ln b fi ls lt l lu lv">gcloud auth login</span></pre><p id="c75d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，您可以使用服务帐户:</p><pre class="je jf jg jh fd lm ln lo lp aw lq bi"><span id="c2a8" class="lr jw hi ln b fi ls lt l lu lv">gcloud auth activate-service-account --key-file=$KEY_FILE</span></pre><h1 id="8702" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">GCP权限</h1><p id="0711" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">为了能够启动和删除笔记本，您需要<strong class="ih hj"> roles/notebooks.runner </strong>。但是，删除笔记本需要<strong class="ih hj">角色/笔记本.管理</strong>。</p><h1 id="4196" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">Python笔记本服务</h1><p id="6db6" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">谷歌提供了两种操作笔记本的方式——异步客户端和同步客户端。选择哪一个完全由你决定。为了简单起见，我将在本教程的剩余部分使用同步客户端。两者都记载了<a class="ae jt" href="https://googleapis.dev/python/notebooks/latest/notebooks_v1/notebook_service.html" rel="noopener ugc nofollow" target="_blank">这里的</a>。</p><p id="6dd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以启动笔记本电脑服务客户端:</p><pre class="je jf jg jh fd lm ln lo lp aw lq bi"><span id="bdcb" class="lr jw hi ln b fi ls lt l lu lv">from google.cloud import notebooks_v1</span><span id="b35a" class="lr jw hi ln b fi lx lt l lu lv">client = notebooks_v1.NotebookServiceClient()</span></pre><h1 id="6814" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">定义笔记本</h1><p id="dd37" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">有趣的是。在定义您的笔记本电脑环境和在预算允许的情况下增加尽可能多的计算能力方面，您有许多可能性。</p><h2 id="01d0" class="lr jw hi bd jx ly lz ma kb mb mc md kf iq me mf kj iu mg mh kn iy mi mj kr mk bi translated">选择环境和机器类型</h2><p id="8d1c" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">你可以基于谷歌为你提供的虚拟机镜像来创建你的笔记本，也可以使用你的docker镜像。我将在接下来的一些文章中讨论为笔记本构建映像，所以让我们首先关注Google提供的虚拟机映像。</p><p id="7cd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GCP有多个深度学习虚拟机映像可供使用，为了方便起见，其中许多还附带了预安装的Jupyter和已配置的端口设置。他们有Tensorflow、Pytorch、R和其他框架的图片。完整的名单可以在<a class="ae jt" href="https://cloud.google.com/vertex-ai/docs/workbench/user-managed/images" rel="noopener ugc nofollow" target="_blank">这里</a>找到。在下一篇文章中，我将介绍如何轻松地建立一个Julia笔记本。</p><p id="c0bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们要用Tensorflow 2.8加GPU支持，我会选择VM镜像族<code class="du ml mm mn ln b">tf-ent-2-8-cu113-notebooks</code>。</p><p id="b5ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Vertex AI Workbench只是一个运行Jupyter的计算引擎实例。您可以在<a class="ae jt" href="https://cloud.google.com/compute/docs/machine-types" rel="noopener ugc nofollow" target="_blank">文档</a>中找到关于可用计算引擎机器类型的更多信息。出于我们的教程目的，我将选择<code class="du ml mm mn ln b">n1-standard-8</code>——具有8个vCPUs和32 GB内存的标准机器类型。然而，你可以随心所欲地疯狂。</p><h2 id="b486" class="lr jw hi bd jx ly lz ma kb mb mc md kf iq me mf kj iu mg mh kn iy mi mj kr mk bi translated">GPU和磁盘</h2><p id="0815" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">关于机器类型和位置，GPU的使用有许多<a class="ae jt" href="https://cloud.google.com/compute/docs/gpus" rel="noopener ugc nofollow" target="_blank">限制</a>。我会选择英伟达特斯拉P100。在GPU上选择阅读<a class="ae jt" href="https://cloud.google.com/compute/docs/gpus" rel="noopener ugc nofollow" target="_blank">谷歌页面。也有可能附加更多的GPU(通常是1，2，4或8)，但我只会用一个。</a></p><p id="314f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当你在GCP创建一个笔记本时，谷歌会为你创建两个磁盘。</p><ol class=""><li id="e977" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc lw le lf lg bi translated">引导磁盘—操作系统/库/初始化脚本所在的位置</li><li id="e229" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc lw le lf lg bi translated">数据磁盘—映射到/home/jupyter文件夹</li></ol><p id="85db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于每一种，您可以在标准/平衡/ SSD持久磁盘之间进行选择。每个大小从100GB到64 TB不等。为了简单起见，我们可以为这两个选项选择200GB的平衡磁盘。</p><h2 id="c078" class="lr jw hi bd jx ly lz ma kb mb mc md kf iq me mf kj iu mg mh kn iy mi mj kr mk bi translated">创建笔记本请求</h2><p id="c8ee" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">根据我们已有的信息，我们可以像这样创建笔记本请求:</p><pre class="je jf jg jh fd lm ln lo lp aw lq bi"><span id="a12f" class="lr jw hi ln b fi ls lt l lu lv">from google.cloud.notebooks_v1.types import Instance, VmImage<br/><br/>notebook_instance = Instance(<br/>    vm_image=VmImage(<br/>        project="deeplearning-platform-release",<br/>        image_family="tf-ent-2-8-cu113-notebooks",<br/>    ),<br/>    machine_type="n1-standard-8",<br/>    accelerator_config=Instance.AcceleratorConfig(<br/>        type_=Instance.AcceleratorType.NVIDIA_TESLA_P100, core_count=1<br/>    ),<br/>    install_gpu_driver=True,<br/>    boot_disk_type=Instance.DiskType.PD_BALANCED,<br/>    boot_disk_size_gb=200,<br/>    data_disk_type=Instance.DiskType.PD_BALANCED,<br/>    data_disk_size_gb=200,<br/>)</span></pre><p id="826b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是最基本的东西。您可以添加更多参数，如标签、标记、元数据或实例所有者。进入<a class="ae jt" href="https://googleapis.dev/python/notebooks/latest/notebooks_v1/types.html#google.cloud.notebooks_v1.types.Instance" rel="noopener ugc nofollow" target="_blank">此处</a>读取所有参数。</p><h2 id="bc29" class="lr jw hi bd jx ly lz ma kb mb mc md kf iq me mf kj iu mg mh kn iy mi mj kr mk bi translated">向GCP发送请求</h2><p id="c947" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">Python SDK经常使用一种叫做<strong class="ih hj"> parent </strong>的东西。Parent只是一个字符串，包含关于您的GCP项目和您想要使用的位置的信息。</p><p id="ba34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们准备将请求发送到GCP端点。</p><pre class="je jf jg jh fd lm ln lo lp aw lq bi"><span id="39b5" class="lr jw hi ln b fi ls lt l lu lv">project_id = "PROJECT_ID" # Put your own project id here<br/>location = "europe-west1-a" # Put your own location here<br/>parent = f"projects/{project_id}/locations/{location}"</span><span id="5f12" class="lr jw hi ln b fi lx lt l lu lv">request = notebooks_v1.CreateInstanceRequest(<br/>        parent=parent,<br/>        instance_id="my-first-notebook",<br/>        instance=instance,<br/>    )<br/>op = client.create_instance(request=request)<br/>op.result()</span></pre><p id="cb6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">来自<code class="du ml mm mn ln b">client.create_instance</code>的结果是Google的长期运行操作——<a class="ae jt" href="https://googleapis.dev/python/google-api-core/latest/operation.html#google.api_core.operation.Operation" rel="noopener ugc nofollow" target="_blank">读取文档</a>。等待操作完成的最简单的方法是方法<code class="du ml mm mn ln b">op.result()</code>，它也提供关于创建的笔记本或创建过程中的错误的信息。</p><p id="4100" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是完整的代码:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="mo mp l"/></div></figure><h1 id="92ff" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">技巧1:使用启动脚本挂载GCS存储桶</h1><p id="ad3d" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">正如我们之前所说，GCP上的Jupyter只是一个配置的计算引擎(CE)虚拟机。每个CE虚拟机都可以有一个<a class="ae jt" href="https://cloud.google.com/compute/docs/instances/startup-scripts/linux" rel="noopener ugc nofollow" target="_blank">启动脚本</a>——在机器启动过程中执行的bash或非bash文件。这给了你无限的可能性来提升你的Jupyter笔记本电脑。我将只向您展示如何自动安装带有<a class="ae jt" href="https://github.com/GoogleCloudPlatform/gcsfuse" rel="noopener ugc nofollow" target="_blank"> gcsfuse </a>的GCS铲斗。</p><p id="4d2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，启动脚本是作为<code class="du ml mm mn ln b">root</code>用户运行的。但是当你连接到Jupyter时，你将成为<code class="du ml mm mn ln b">jupyter</code>用户。</p><p id="3738" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">gcsfuse已经预装在谷歌提供的图片中。在其他映像中，您必须自己安装它。</p><pre class="je jf jg jh fd lm ln lo lp aw lq bi"><span id="bff3" class="lr jw hi ln b fi ls lt l lu lv">#!/bin/bash</span><span id="3788" class="lr jw hi ln b fi lx lt l lu lv">LOCAL_PATH=/home/jupyter/mounted/gcs<br/>BUCKET_NAME=my-super-bucket # Change this to your bucket<br/>BUCKET_DIR=notebook_data<br/><br/>sudo su -c "mkdir -p $LOCAL_PATH"<br/>sudo su -c "gcsfuse --implicit-dirs --only-dir=$BUCKET_DIR $BUCKET_NAME $LOCAL_PATH"</span></pre><p id="4b78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在这里使用了两个技巧。</p><ul class=""><li id="a370" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated"><code class="du ml mm mn ln b">—-implicit-dirs</code>对于目录的隐式存在，这允许你看到桶中的所有对象，但是它有几个缺点，主要是成本更高</li><li id="3e0c" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated"><code class="du ml mm mn ln b">—-only-dir</code>只挂载一个“目录”的桶</li></ul><p id="9760" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该脚本必须保存在GCS中或公共可用的URL上(如Github)。我将向您展示如何将一个字符串直接上传到GCS，并保存为文本，而不保存在本地。</p><pre class="je jf jg jh fd lm ln lo lp aw lq bi"><span id="cc2f" class="lr jw hi ln b fi ls lt l lu lv">pip install google-cloud-storage</span></pre><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="mo mp l"/></div></figure><p id="5383" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在发送到GCP之前，只需在<code class="du ml mm mn ln b">notebook_instance</code>中添加一个参数:</p><pre class="je jf jg jh fd lm ln lo lp aw lq bi"><span id="22cd" class="lr jw hi ln b fi ls lt l lu lv">notebook_instance.post_startup_script = f"gs://{blob.bucket.name}/{blob.name}"</span><span id="8e18" class="lr jw hi ln b fi lx lt l lu lv">request = notebooks_v1.CreateInstanceRequest(<br/>    parent=parent,<br/>    instance_id="my-first-notebook",<br/>    instance=notebook_instance,<br/>)<br/>op = client.create_instance(request=request)<br/>op.result()</span></pre><h1 id="0316" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">技巧#2:托管笔记本</h1><p id="d95f" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">谷歌为Jupyter笔记本提供了两种解决方案。到目前为止，我们使用的是<strong class="ih hj">用户管理的笔记本</strong>，它允许大量定制。第二个选项是<a class="ae jt" href="https://cloud.google.com/vertex-ai/docs/workbench/notebook-solution#managed" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">托管笔记本</strong> </a>，在这里你可以先写代码，然后再选择硬件。API非常相似，你可以在这里找到文档<a class="ae jt" href="https://googleapis.dev/python/notebooks/latest/notebooks_v1/managed_notebook_service.html#google.cloud.notebooks_v1.services.managed_notebook_service.ManagedNotebookServiceClient" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="4918" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">提示3:阅读Lak Lakshmanan的文章</h1><p id="01af" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated"><a class="ae jt" href="https://towardsdatascience.com/how-to-use-jupyter-on-a-google-cloud-vm-5ba1b473f4c2" rel="noopener" target="_blank">如何在Google Cloud VM上使用Jupyter</a>是Lak Lakshmanan(前Google)关于在GCP上使用gcloud CLI工具启动Jupyter的一篇优秀文章。它有点旧，但包含一些很棒的技巧。</p></div><div class="ab cl mq mr gp ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="hb hc hd he hf"><p id="8d7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ju">请订阅我的频道获取下一篇关于如何使用Vertex AI Python SDK的博文。除了展示其他Vertex AI服务之外，我将很快发布一个帖子，展示如何通过Vertex AI Workbench和云构建轻松启动Jupyter和Julia。</em></p></div></div>    
</body>
</html>