<html>
<head>
<title>Trigger gsutil with Watchman</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Watchman触发gsutil</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/trigger-gsutil-with-watchman-18ad2c9d9789?source=collection_archive---------2-----------------------#2022-07-03">https://medium.com/google-cloud/trigger-gsutil-with-watchman-18ad2c9d9789?source=collection_archive---------2-----------------------#2022-07-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a968" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/storage/docs/gsutil" rel="noopener ugc nofollow" target="_blank">‘gsutil</a>’是一个将文件从本地传输到GCS的工具，反之亦然。它提供了很大的功能，如易于使用的界面，并行文件传输，多部分上传等。它是一个命令行工具，这意味着它需要手动触发或从cron等其他进程来调度文件传输。</p><p id="e455" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在某些用例中，用户希望在将文件写入给定目录后，立即将文件上传到给定的GCS bucket。为了处理这种情况，我们可以用<a class="ae jd" href="https://github.com/facebook/watchman" rel="noopener ugc nofollow" target="_blank"> watchman </a> inotify循环运行great‘gsutil’。Watchman将确保在文件上传到watchman监控的给定目录后立即触发gsutil命令。</p><h1 id="b1f4" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated"><strong class="ak">安装守夜人</strong></h1><p id="8149" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">使用以下步骤下载并安装watchman。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="c6c4" class="kq jf hi km b fi kr ks l kt ku"># Download Watchman</span><span id="b4cd" class="kq jf hi km b fi kv ks l kt ku">wget <a class="ae jd" href="https://github.com/facebook/watchman/releases/download/v2022.06.06.00/watchman-v2022.06.06.00-linux.zip" rel="noopener ugc nofollow" target="_blank">https://github.com/facebook/watchman/releases/download/v2022.06.06.00/watchman-v2022.06.06.00-linux.zip</a></span><span id="e714" class="kq jf hi km b fi kv ks l kt ku"># Install Binary</span><span id="e6f7" class="kq jf hi km b fi kv ks l kt ku">unzip watchman-*-linux.zip</span><span id="1f11" class="kq jf hi km b fi kv ks l kt ku">cd watchman-<a class="ae jd" href="https://github.com/facebook/watchman/releases/download/v2022.06.06.00/watchman-v2022.06.06.00-linux.zip" rel="noopener ugc nofollow" target="_blank">v2022.06.06.00</a>-linux</span><span id="901d" class="kq jf hi km b fi kv ks l kt ku">sudo mkdir -p /usr/local/var/run/watchman</span><span id="7631" class="kq jf hi km b fi kv ks l kt ku">sudo cp bin/* /usr/local/bin</span><span id="bdde" class="kq jf hi km b fi kv ks l kt ku">sudo cp lib/* /usr/local/lib</span><span id="7933" class="kq jf hi km b fi kv ks l kt ku">sudo chmod 755 /usr/local/bin/watchman</span><span id="0dd7" class="kq jf hi km b fi kv ks l kt ku">sudo chmod 2777 /usr/local/var/run/watchman</span></pre><h1 id="017b" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">配置Watchman</h1><ol class=""><li id="5ee6" class="kw kx hi ih b ii kc im kd iq ky iu kz iy la jc lb lc ld le bi translated">创建一个自定义配置文件/etc/watchman.json</li></ol><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="f206" class="kq jf hi km b fi kr ks l kt ku">touch /etc/watchman.json</span></pre><p id="b0ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.创建一个由watchman监控的目录</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="b09f" class="kq jf hi km b fi kr ks l kt ku">mkdir ~/upload</span></pre><p id="0ad7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.配置watchman来监控上传目录</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="9f2b" class="kq jf hi km b fi kr ks l kt ku"># Run below command</span><span id="b677" class="kq jf hi km b fi kv ks l kt ku">/usr/local/bin/watchman watch ~/upload/</span><span id="86c7" class="kq jf hi km b fi kv ks l kt ku"><br/># It will generate output similar to below one</span><span id="7d21" class="kq jf hi km b fi kv ks l kt ku"><strong class="km hj"># Output</strong></span><span id="714e" class="kq jf hi km b fi kv ks l kt ku">{</span><span id="587c" class="kq jf hi km b fi kv ks l kt ku">"version": "20220605.192726.0",</span><span id="0e04" class="kq jf hi km b fi kv ks l kt ku">"watch": "/home/singhpradeepk/upload",</span><span id="9438" class="kq jf hi km b fi kv ks l kt ku">"watcher": "inotify"</span><span id="0659" class="kq jf hi km b fi kv ks l kt ku">}</span></pre><p id="90f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.确认目录正由看守人监控</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="c17f" class="kq jf hi km b fi kr ks l kt ku"># Run below command</span><span id="eeb5" class="kq jf hi km b fi kv ks l kt ku">/usr/local/bin/watchman watch-list</span><span id="95a5" class="kq jf hi km b fi kv ks l kt ku"><br/># It will generate output similar to below one</span><span id="c9b6" class="kq jf hi km b fi kv ks l kt ku"><strong class="km hj"># Output</strong></span><span id="1251" class="kq jf hi km b fi kv ks l kt ku">{</span><span id="d7dd" class="kq jf hi km b fi kv ks l kt ku">"version": "20220605.192726.0",</span><span id="fe35" class="kq jf hi km b fi kv ks l kt ku">"roots": [</span><span id="5fd3" class="kq jf hi km b fi kv ks l kt ku">"/home/singhpradeepk/upload"</span><span id="71eb" class="kq jf hi km b fi kv ks l kt ku">]}</span></pre><p id="228a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.用下面的内容写一个脚本gsutil_rsync.sh。这个脚本将由watchman执行，将“上传”目录与GCS bucket同步。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="0ff8" class="kq jf hi km b fi kr ks l kt ku">#!/usr/bin/env bash</span><span id="900d" class="kq jf hi km b fi kv ks l kt ku"># Change bucket name with desired value from your environment.</span><span id="d0b3" class="kq jf hi km b fi kv ks l kt ku">/usr/bin/gsutil rsync -rdc /home/singhpradeepk/upload gs://sample-bucket</span></pre><p id="cce1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.使gsutil_rsync.sh可执行</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="d240" class="kq jf hi km b fi kr ks l kt ku">chmod +x gsutil_rsync.sh</span></pre><p id="05e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.创建一个watchman触发器来运行该脚本，以便将任何更改上传到受监控的目录</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="7945" class="kq jf hi km b fi kr ks l kt ku"># Run below command</span><span id="88e2" class="kq jf hi km b fi kv ks l kt ku">/usr/local/bin/watchman -j &lt;&lt;-EOT</span><span id="e623" class="kq jf hi km b fi kv ks l kt ku">&gt; ["trigger", "/home/singhpradeepk/upload", { "name": "gcs", "command": ["/home/singhpradeepk/gsutil_rsync.sh"]}]</span><span id="bfc2" class="kq jf hi km b fi kv ks l kt ku">&gt; EOT</span><span id="81ec" class="kq jf hi km b fi kv ks l kt ku"><br/># It will generate output similar to below one</span><span id="6373" class="kq jf hi km b fi kv ks l kt ku"># Output</span><span id="74e9" class="kq jf hi km b fi kv ks l kt ku">{</span><span id="698d" class="kq jf hi km b fi kv ks l kt ku">"version": "20220605.192726.0",</span><span id="fa05" class="kq jf hi km b fi kv ks l kt ku">"triggerid": "gcs",</span><span id="fbed" class="kq jf hi km b fi kv ks l kt ku">"disposition": "created"</span><span id="b10e" class="kq jf hi km b fi kv ks l kt ku">}</span></pre><p id="965d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.测试看守人</p><p id="8abd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在“upload”目录中创建一个文件，并检查您的环境的日志文件，该文件应该位于与我的文件类似的位置，即传输日志的<strong class="ih hj">'/usr/local/var/run/watchman/singhpradeepk-state/log '</strong>。检查GCS存储桶以确认成功转移。</p><p id="3ab7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望您将在您的环境中使用它来传输文件。</p><p id="e93d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">欢迎评论和建议！！</p></div></div>    
</body>
</html>