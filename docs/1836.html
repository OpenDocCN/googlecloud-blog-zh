<html>
<head>
<title>Cloud Composer/Apache Airflow, Dataform &amp; BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Cloud Composer/Apache Airflow、数据表单和BigQuery</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-composer-apache-airflow-dataform-bigquery-de6e3eaabeb3?source=collection_archive---------0-----------------------#2021-03-28">https://medium.com/google-cloud/cloud-composer-apache-airflow-dataform-bigquery-de6e3eaabeb3?source=collection_archive---------0-----------------------#2021-03-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="69fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">如何一起使用Cloud Composer和data form</em></p><blockquote class="je jf jg"><p id="baed" class="if ig jd ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><em class="hi">免责声明:观点是我自己的，不是我雇主的观点</em></p></blockquote><p id="751e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jk" href="https://cloud.google.com/composer" rel="noopener ugc nofollow" target="_blank"> Cloud Composer </a>是谷歌的完全管理版本<a class="ae jk" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Airflow </a>，非常适合编写、调度和监控工作流。Google最近收购了<a class="ae jk" href="https://dataform.co/" rel="noopener ugc nofollow" target="_blank"> Dataform </a>，这是ELT中关于Transform(提取加载转换)的所有内容。这对<a class="ae jk" href="https://cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank"> BigQuery </a>爱好者来说是一个好消息，因为Dataform可以帮助管理脚本、创建依赖关系、添加数据质量检查(也称为断言)、记录、维护版本，并通过<a class="ae jk" href="https://docs.dataform.co/dataform-web/version-control" rel="noopener ugc nofollow" target="_blank">本机git集成</a>将更改推送到不同的环境中。它提供了UI、CLI和API来完成这一切，简而言之，太棒了！</p><p id="fadb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，如果您正在使用或计划使用BigQuery作为您的DWH，Cloud Composer作为您的主要编排工具，并且喜欢ELT，那么您来对地方了。我将基于以下典型用例展示这些产品如何相互通信:</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es jl"><img src="../Images/92803b1adc0b3a4844462e46d374418e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yeHnXjpgRATD5tKUPlppDg.png"/></div></div></figure><p id="af93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如上所示，Composer是所有这些+使用gcs_to_bq操作符简单加载到BigQuery(也可以由任何其他EL(T)解决方案替换)的主要编排者。转换以数据形式保存在SQLX中。Dataform上已经有很多好文章了，所以我使用Lak 创建的其中一篇<a class="ae jk" rel="noopener" href="/google-cloud/building-sql-pipelines-in-bigquery-with-dataform-part-1-9e96f14ec664">，它正在使用Dataform解决BigQuery ML用例，如下所示:</a></p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es jx"><img src="../Images/38600f6535f12c733146cd9ae1494619.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CIWCW9Hu43PhGcnfwsr_0w.png"/></div></div></figure><p id="f79f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Dataform也有自己的调度程序，但通常情况下，您会希望在加载完成后运行转换，对于跨不同应用程序的依赖链，Composer再次提供了帮助。</p><p id="678e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，让我们停止追逐，直接进入代码:</p><p id="3c51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">等待GCS中的文件</strong></p><p id="c6ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的转换需要将输入数据加载到BigQuery中。假设这些数据将通过外部作业到达GCS，我们需要等待。为此，我们可以使用GoogleCloudStorageObjectSensor运算符，如下所示:</p><pre class="jm jn jo jp fd jy jz ka kb aw kc bi"><span id="259b" class="kd ke hi jz b fi kf kg l kh ki">from airflow.contrib.sensors.gcs_sensor import GoogleCloudStorageObjectSensor</span><span id="66b6" class="kd ke hi jz b fi kj kg l kh ki">gcs_sensor_task = GoogleCloudStorageObjectSensor(<br/> task_id=”gcs_object_sensor”,<br/> bucket=’gcs-bucket’,<br/> object=’test-files/census_adult_income.csv’,<br/> dag=dag<br/>)</span></pre><p id="058b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">从GCS加载到BigQuery </strong></p><p id="ebdc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦数据到达GCS，我们可以使用下面的代码使用GoogleCloudStorageToBigQueryOperator操作符加载到BigQuery。您也可以在JSON中指定schema，更多细节<a class="ae jk" href="https://airflow.apache.org/docs/apache-airflow/1.10.12/_api/airflow/contrib/operators/gcs_to_bq/index.html" rel="noopener ugc nofollow" target="_blank">在这里</a>。</p><pre class="jm jn jo jp fd jy jz ka kb aw kc bi"><span id="067a" class="kd ke hi jz b fi kf kg l kh ki">from airflow.contrib.operators import gcs_to_bq</span><span id="1059" class="kd ke hi jz b fi kj kg l kh ki">load_gcs_csv = gcs_to_bq.GoogleCloudStorageToBigQueryOperator(<br/> task_id=’gcs_to_bq_load’,<br/> bucket=’gcs-bucket’,<br/> source_objects=[‘test-files/census_adult_income.csv’],<br/> destination_project_dataset_table=’gcs-bucket.ds.census_adult_income’,<br/> schema_fields=[<br/> {‘name’: ‘age’, ‘type’: ‘INTEGER’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘workclass’, ‘type’: ‘STRING’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘functional_weight’, ‘type’: ‘INTEGER’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘education’, ‘type’: ‘STRING’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘education_num’, ‘type’: ‘INTEGER’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘marital_status’, ‘type’: ‘STRING’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘occupation’, ‘type’: ‘STRING’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘relationship’, ‘type’: ‘STRING’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘race’, ‘type’: ‘STRING’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘sex’, ‘type’: ‘STRING’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘capital_gain’, ‘type’: ‘INTEGER’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘capital_loss’, ‘type’: ‘INTEGER’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘hours_per_week’, ‘type’: ‘INTEGER’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘native_country’, ‘type’: ‘STRING’, ‘mode’: ‘NULLABLE’},<br/> {‘name’: ‘income_bracket’, ‘type’: ‘STRING’, ‘mode’: ‘NULLABLE’},<br/> ],<br/> skip_leading_rows=1,<br/> write_disposition=’WRITE_TRUNCATE’,<br/> dag=dag)</span></pre><p id="5b56" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">调用数据表单进行转换</strong></p><p id="a626" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的代码加载到BigQuery表“census_adult_income”中的数据是数据表单转换的输入，所以是时候运行数据表单作业了。到目前为止，Composer中没有任何Dataform操作符，但是我们可以通过PythonOperator使用REST API调用来调用和轮询作业以迭代完成。更多关于数据表单API<a class="ae jk" href="https://docs.dataform.co/dataform-web/api" rel="noopener ugc nofollow" target="_blank">的细节请点击这里</a>。</p><p id="e13d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽管您将使用Composer进行编排，但仍需要以数据形式为REST API调用创建一个调度。您可以禁用它，如下所示:</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es kk"><img src="../Images/575015d71e8f0de6a067a36f7196869c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JtY5jZ6pDC_iHBbNH0rVeA.png"/></div></div></figure><p id="31ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Rest API也需要一个项目Id(不要与GCP项目Id混淆)，我在Dataform UI中找不到明确提到它的地方，但是它在URL中是可见的，如下所示，所以从那里复制它(如果我找到更好的方法，我会在这里更新！).</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div class="er es kl"><img src="../Images/0ec4622517d3ca59dcfb788c6a3f48e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*CIn-0bpVtyXs04WCzaH1IA.png"/></div></figure><p id="fb14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以创建数据表单API键，如下所示:</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es km"><img src="../Images/81fb5f846e3ac16791ed997bad4c9df0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_2kM6aRuTvc52yizUYUDrw.png"/></div></div></figure><p id="7e22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打电话:</p><pre class="jm jn jo jp fd jy jz ka kb aw kc bi"><span id="be52" class="kd ke hi jz b fi kf kg l kh ki">from airflow.operators.python_operator import PythonOperator<br/>import requests<br/>import json<br/>import time</span><span id="426a" class="kd ke hi jz b fi kj kg l kh ki">def dataform_def():<br/> base_url=’<a class="ae jk" href="https://api.dataform.co/v1/project/5685548636176384/run'" rel="noopener ugc nofollow" target="_blank">https://api.dataform.co/v1/project/<strong class="jz hj">&lt;Project Id here&gt;</strong>/run'</a><br/> headers={‘Authorization’: ‘Bearer &lt;<strong class="jz hj">Dataform Key&gt;</strong>’}<br/> run_create_request={“environmentName”: “&lt;<strong class="jz hj">environment name here&gt;</strong>”, “scheduleName”: “&lt;<strong class="jz hj">schedule name from dataform here&gt;</strong>”}</span><span id="dbf3" class="kd ke hi jz b fi kj kg l kh ki">response = requests.post(base_url, data=json.dumps(run_create_request), headers=headers)</span><span id="815f" class="kd ke hi jz b fi kj kg l kh ki">run_url = base_url + ‘/’ + response.json()[‘id’]<br/> response = requests.get(run_url, headers=headers)</span><span id="6cfb" class="kd ke hi jz b fi kj kg l kh ki">while response.json()[‘status’] == ‘RUNNING’:<br/> time.sleep(10)<br/> print(‘Dataform job running’)<br/> response = requests.get(run_url, headers=headers)<br/> print(response.json())</span><span id="cd5c" class="kd ke hi jz b fi kj kg l kh ki">return ‘Dataform job finished’</span><span id="ed0e" class="kd ke hi jz b fi kj kg l kh ki">run_dataform = PythonOperator(<br/> task_id=’dataform_transform’,<br/> python_callable=dataform_def,<br/> dag=dag,<br/>)</span></pre><p id="cc3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">缝合在一起</strong></p><p id="b458" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后一部分是将它们链接到一个Composer DAG中:</p><pre class="jm jn jo jp fd jy jz ka kb aw kc bi"><span id="ecbf" class="kd ke hi jz b fi kf kg l kh ki">gcs_sensor_task &gt;&gt; load_gcs_csv &gt;&gt; run_dataform</span></pre><p id="c1bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Composer存储桶中移动DAG:</p><pre class="jm jn jo jp fd jy jz ka kb aw kc bi"><span id="0914" class="kd ke hi jz b fi kf kg l kh ki">gsutil cp census_elt_dag.py gs://composer-bucket</span></pre><p id="50bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Composer将自动选取这个新的DAG:</p><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es kn"><img src="../Images/262f181effbaac09cff0982077a16207.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zGRQmmrqCCCtsqeatSsDAg.png"/></div></div></figure><p id="b658" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以直接从Composer计划和监控它。</p><p id="1294" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！如有任何问题或改进建议，请联系我。</p></div></div>    
</body>
</html>