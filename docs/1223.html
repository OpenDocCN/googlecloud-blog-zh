<html>
<head>
<title>Monitoring Workloads Migrated with Migrate for Anthos</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Migrate for Anthos监控迁移的工作负载</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/monitoring-workloads-migrated-with-migrate-for-anthos-4c5542573767?source=collection_archive---------0-----------------------#2019-12-13">https://medium.com/google-cloud/monitoring-workloads-migrated-with-migrate-for-anthos-4c5542573767?source=collection_archive---------0-----------------------#2019-12-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e5d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是前一篇文章的后续文章，前一篇文章介绍了如何使用Migrate for Anthos将计算引擎实例迁移到Kubernetes引擎。我想特别关注一下在云上的Kubernetes中工作负载发生了什么，以帮助您适当地维护和监控它。</p><p id="ca63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为一个受管理的Kubernetes服务，Kubernetes引擎会自动使用Stackdriver进行日志记录和监控。如果您正在混合云环境中运行，<a class="ae jd" href="https://cloud.google.com/solutions/hybrid-and-multi-cloud-monitoring-and-logging-patterns" rel="noopener ugc nofollow" target="_blank">请查看这个解决方案</a>，它将介绍使用哪些日志记录和监控工具的一些注意事项，并提供基本的架构指导。</p><p id="5ce6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于我们的web服务器示例，让我们看看如何设置一些基本的监控和日志记录。</p><h1 id="2f9e" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">监控基础设施</h1><p id="c585" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/kubernetes-engine-monitoring/" rel="noopener ugc nofollow" target="_blank"> Stackdriver Kubernetes引擎监控</a>提供了现成的仪表盘，允许我们选择所需的视图，我们可以专注于基础架构、工作负载或服务。首先，我们需要在项目中设置Stackdriver。我们可以从<a class="ae jd" href="https://app.google.stackdriver.com/kubernetes" rel="noopener ugc nofollow" target="_blank">转到仪表盘</a>开始，或者转到谷歌云控制台，点击产品菜单中的监控链接。这将把我们直接带到监控概述，我们可以从资源菜单中选择Kubernetes引擎。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/b55076795b94881d72ea6b20c9f3f271.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0RUKcI_lNmcZdopG"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">Kubernetes发动机仪表板</figcaption></figure><p id="f344" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">生成的仪表板中的每一行都是可选择的，并显示有关该特定条目的更多详细信息。我们可以单击我们的容器来查看CPU和内存使用等指标，并查看该容器生成的日志。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/e83f3dc25b79ec6dd0298687c637ec64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fjZLJCbVu59G24-O"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">容器详细信息和指标</figcaption></figure><p id="1577" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">自动创建这种“开箱即用”的基础设施监控固然很好，但更重要的是监控我们的应用程序以确保其正常工作。确保我们的容器启动并运行的一个简单方法是在Kubernetes指标上使用<strong class="ih hj"> count </strong>聚合器，比如过滤到我们的容器名称的容器正常运行时间:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/f3f657f9053ef19b1c807c30bd19eeb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JnUCv8OBikD8FZqE"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">图表中的正常运行时间指标</figcaption></figure><p id="ec8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以将此图表添加到控制面板中，并保存在那里，以便随时可以轻松访问，还可以为我们想要衡量的指标添加任何其他图表！</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/ed7d3909a248f2d0e91f725c372cd178.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NruZy18h2WvtGsO9"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">仪表板中的容器数量</figcaption></figure><p id="cb5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于使用Stackdriver监控Kubernetes引擎基础设施和工作负载的更多信息，您可以阅读这篇<a class="ae jd" rel="noopener" href="/google-cloud/new-stackdriver-monitoring-for-kubernetes-part-1-a296fa164694">博客文章</a>，其中有更多的细节。</p><h1 id="93e2" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">监控应用程序</h1><p id="353a" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">虽然监控容器本身是有价值的，但它并没有真正告诉我们应用程序是否真正在为用户流量服务。为了验证这一点，我们将创建一个<a class="ae jd" href="https://cloud.google.com/monitoring/uptime-checks/" rel="noopener ugc nofollow" target="_blank">运行时间检查</a>，它将通过我们在将应用程序迁移到GKE后创建的负载平衡器来访问应用程序的前端。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kx"><img src="../Images/b0eea02d06fe5ac76a81924ea13bae2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BVH6Y7Z339qFUzCA"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">设置正常运行时间检查</figcaption></figure><p id="5adb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在那里，我们可以创建一个警报策略，以便在正常运行时间检查失败时通知我们:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/41203f1190918746aa83cef3afcd8067.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WMMfao7F2gO4En0z"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">正常运行时间检查的警报策略</figcaption></figure><p id="97cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们可以创建一个<a class="ae jd" href="https://cloud.google.com/monitoring/support/notification-options" rel="noopener ugc nofollow" target="_blank">通知通道</a>，如果正常运行时间检查检测到我们的应用程序没有响应请求，警报策略将使用这个通道:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es ky"><img src="../Images/9e558c81e2e30694b65ac7b7f2ccd975.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lswbxudMH0m6ElVq"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">添加通知渠道</figcaption></figure><p id="1c9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以确定我们正在监控应用程序本身及其运行的基础架构。</p><h1 id="f7ef" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">为您的应用程序记录</h1><p id="4063" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">日志记录用于表示特定事件的详细信息，如果我们收到应用程序没有响应的警报，它可能会特别有用。首先，我们可以直接连接到我们的集群，并使用kubectl命令查看日志:</p><pre class="ki kj kk kl fd kz la lb lc aw ld bi"><span id="7713" class="le jf hi la b fi lf lg l lh li">kubectl logs [POD NAME]</span></pre><p id="058a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在Kubernetes <a class="ae jd" href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/#interacting-with-running-pods" rel="noopener ugc nofollow" target="_blank">文档</a>中读到更多关于如何做到这一点的信息。f标志允许我们在需要时连续地流式传输日志。</p><p id="1c16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Kubernetes引擎中，由我们的容器写入stdout或stderr的日志消息会被集群中运行的fluentd daemonset自动接收到Stackdriver日志中。要查看这些日志，我们可以在日志查看器中选择我们的集群、运行我们的应用程序的名称空间(默认)和容器名称(webserver-container ):</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/692773a6aa0f8683b5c340e93d69df73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_qc7Hp0fxOCsCTVa"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">集装箱日志</figcaption></figure><blockquote class="lj lk ll"><p id="138e" class="if ig lm ih b ii ij ik il im in io ip ln ir is it lo iv iw ix lp iz ja jb jc hb bi translated"><em class="hi">我们也可以通过点击Kubernetes引擎下特定工作负载页面上的Stackdriver日志链接来访问这些日志。</em></p></blockquote><p id="b76c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">日志查看器还使我们能够在收到日志时对其进行流式处理，因此我们不需要使用启动流式日志功能来刷新页面:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/dce658f98557cb37e2587606e88da14e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NQVnJU1YoxXIp0Yu"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">流式日志</figcaption></figure><p id="2984" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们需要从Stackdriver中导出日志，比如基于事件的处理管道或分析，我们可以使用本<a class="ae jd" href="https://cloud.google.com/solutions/design-patterns-for-exporting-stackdriver-logging" rel="noopener ugc nofollow" target="_blank">指南</a>进行设置。这涉及到</p><ul class=""><li id="cded" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc lv lw lx ly bi translated">将日志过滤为您需要导出的条目</li><li id="e8e4" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">创建到您选择的目的地的导出</li><li id="aaef" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">(可选)如果需要规范化日志，例如在使用之前，设置处理管道</li></ul><p id="8d40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能希望基于作为日志条目发出的特定消息发出警报——如果是这种情况，请阅读这篇关于在Stackdriver中使用基于日志的指标的博客文章。</p><h1 id="ac49" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">后续步骤</h1><p id="939e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">随着我们的应用程序迁移到Kubernetes并使用Stackdriver，我们拥有了确保工作负载健康所需的监控和日志记录！如果你想了解更多关于修改日志获取方式的信息，比如过滤掉潜在的PII，看看这篇关于定制日志的<a class="ae jd" rel="noopener" href="/google-cloud/customizing-kubernetes-logging-part-1-a1e5791dcda8?source=---------8------------------">帖子</a>。</p><p id="1552" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">稍后，我们将对迁移后的web服务器采取下一步措施，并为其提供一个专用的持久卷。现在——在外面保持健康！</p></div></div>    
</body>
</html>