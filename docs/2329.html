<html>
<head>
<title>Dialogflow CX Cloud Function Webhook with VPC-SC</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Dialogflow CX云函数Webhook与VPC-SC</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/dialogflow-cx-cloud-function-webhook-with-vpc-sc-6eaef97cb908?source=collection_archive---------0-----------------------#2022-08-26">https://medium.com/google-cloud/dialogflow-cx-cloud-function-webhook-with-vpc-sc-6eaef97cb908?source=collection_archive---------0-----------------------#2022-08-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="15d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Dialogflow CX是一个很棒的服务，可以让你创建文本和语音代理。如果您在生产环境中运行您的代理，您可能希望在组件之间使用<a class="ae jd" href="https://en.wikipedia.org/wiki/Private_network" rel="noopener ugc nofollow" target="_blank">私有</a>通信来运行它，而不通过互联网进行通信。</p><p id="a304" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Dialogflow CX支持与Webhooks的私人通信。它与<a class="ae jd" href="https://cloud.google.com/service-directory/docs/private-network-access-overview" rel="noopener ugc nofollow" target="_blank">服务目录私有网络访问</a>集成，因此它可以连接到您的VPC网络内部的webhook目标。这将流量保持在谷歌云网络内，并实施<a class="ae jd" href="https://cloud.google.com/iam/docs/overview" rel="noopener ugc nofollow" target="_blank"> IAM </a>和<a class="ae jd" href="https://cloud.google.com/vpc-service-controls/docs/overview" rel="noopener ugc nofollow" target="_blank"> VPC服务控制</a>。</p><p id="fce9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">截至今天，当VPC服务控制边界或在服务目录中使用时，当前不支持使用Dialogflow webhooks的云功能。你需要一个更清晰的架构来让它工作。</p><p id="1390" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在下面的架构中，您可以找到让您的Dialogflow CX代理无需通过互联网即可与云功能Webhook通信所需的目标架构。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/b1e5bfaeb396e2dda6afee998dc0d2e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HYoV5iyi0z1a07RdjkFDlQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">对话流CX实现的架构。</figcaption></figure><p id="2303" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了设计解决方案，我们必须考虑到目前服务目录专用网络访问仅支持GCE实例、TCP内部负载平衡器(ILB)和GKE端点。</p><p id="4cb9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以实施不同的解决方案，我们决定采用上述架构，依靠Dialogflow CX和云功能之间的自动身份验证，避免创建自签名证书。</p><p id="d748" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们将要实现的体系结构中，请求如下:</p><ul class=""><li id="9649" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">Dialogflow从服务目录中检索要使用的内部负载平衡和VPC网络的IP地址</li><li id="e4f4" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">Dialogflow将连接到VPC网络并到达TCP ILB</li><li id="f58f" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">ILB将请求转发到后端:我们将实现的架构中的GCE实例</li><li id="583f" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">在GCE实例中，我们将配置一个NGINX TCP反向代理，将所有请求转发给云功能</li><li id="b43c" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">云函数将对Dialogflow服务帐户进行身份验证，并完成请求</li></ul><p id="3be1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们开始配置所有需要的资源。</p><h1 id="a5b8" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">先决条件</h1><p id="9cad" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">与开单关联的GCP项目，您在该项目中具有责任人职责。<br/>打开云外壳，准备创建您的基础设施！</p><h1 id="0749" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">设置环境变量</h1><p id="a1cb" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">让我们开始创建一些变量，以便更容易地使用该命令。请更新变量以匹配您的配置。</p><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="3228" class="lq kj hi lm b fi lr ls l lt lu">export BACKEND_PORT=443<br/>export GCE_INSTANCE=webhook<br/>export ILB_IP=10.10.20.99<br/>export INSTANCE_GROUP=webhook<br/>export NETWORK=net<br/>export PROJECT_ID=$(gcloud info --format='value(config.project)')<strong class="lm hj"><br/></strong>export PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format=json | jq -r '.projectNumber')<br/>export REGION=europe-west1<br/>export SUBNET_LB=lb-subnet<br/>export SUBNET=europe-subnet<br/>export SD_URL=projects/$PROJECT_ID/locations/$REGION/namespaces/df-namespace/services/df-service<br/>export ZONE=$REGION-b<br/>export FUNCTIONS_URL=$REGION-$PROJECT_ID.cloudfunctions.net</span></pre><h1 id="1850" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">启用服务和服务身份服务帐户和角色</h1><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="db94" class="lq kj hi lm b fi lr ls l lt lu">gcloud services enable \<br/>  compute.googleapis.com \<br/>  cloudbuild.googleapis.com \<br/>  cloudfunctions.googleapis.com \<br/>  dialogflow.googleapis.com \<br/>  logging.googleapis.com \<br/>  pubsub.googleapis.com \<br/>  servicedirectory.googleapis.com</span><span id="22f8" class="lq kj hi lm b fi lv ls l lt lu">gcloud beta services identity create --service=dialogflow.googleapis.com</span><span id="20de" class="lq kj hi lm b fi lv ls l lt lu">gcloud projects add-iam-policy-binding $PROJECT_ID \<br/>--member=serviceAccount:<a class="ae jd" href="mailto:service-$PROJECT_NUMBER@gcp-sa-dialogflow.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">service-$PROJECT_NUMBER@gcp-sa-dialogflow.iam.gserviceaccount.com</a> \<br/>--role=roles/servicedirectory.viewer</span><span id="67fb" class="lq kj hi lm b fi lv ls l lt lu">gcloud projects add-iam-policy-binding $PROJECT_ID \<br/>--member=serviceAccount:<a class="ae jd" href="mailto:service-$PROJECT_NUMBER@gcp-sa-dialogflow.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">service-$PROJECT_NUMBER@gcp-sa-dialogflow.iam.gserviceaccount.com</a> \<br/>--role=roles/servicedirectory.pscAuthorizedService</span></pre><h1 id="3c93" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">配置网络</h1><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="eb51" class="lq kj hi lm b fi lr ls l lt lu">gcloud compute networks create $NETWORK \<br/>  --project=${PROJECT_ID} \<br/>  --subnet-mode=custom</span><span id="de0a" class="lq kj hi lm b fi lv ls l lt lu">gcloud compute networks subnets create $SUBNET_LB \<br/>  --project=${PROJECT_ID} \<br/>  --range=10.10.10.0/24 \<br/>  --network=$NETWORK \<br/>  --region=$REGION \<br/>  --enable-private-ip-google-access</span><span id="78cd" class="lq kj hi lm b fi lv ls l lt lu">gcloud compute networks subnets create $SUBNET \<br/>  --project=${PROJECT_ID} \<br/>  --network=$NETWORK \<br/>  --region=$REGION \<br/>  --enable-private-ip-google-access \<br/>  --range=10.10.20.0/24</span><span id="e24a" class="lq kj hi lm b fi lv ls l lt lu">gcloud compute firewall-rules create allow \<br/>  --network $NETWORK \<br/>  --allow tcp:22,tcp:3389,icmp</span><span id="5501" class="lq kj hi lm b fi lv ls l lt lu">gcloud compute firewall-rules create allow-ssh-ingress-from-iap \<br/>  --network=$NETWORK \<br/>  --direction=INGRESS \<br/>  --action=allow \<br/>  --rules=tcp:22 \<br/>  --source-ranges=35.235.240.0/20</span><span id="3de0" class="lq kj hi lm b fi lv ls l lt lu">gcloud compute firewall-rules create allow-lb-access \<br/>  --project=${PROJECT_ID} \<br/>  --direction=INGRESS \<br/>  --priority=1000 \<br/>  --network=$NETWORK \<br/>  --action=ALLOW \<br/>  --rules=tcp,udp,icmp \<br/>  --source-ranges=10.10.10.0/24,10.10.20.0/24</span><span id="442b" class="lq kj hi lm b fi lv ls l lt lu">gcloud compute firewall-rules create allow-health-check \<br/>  --direction=INGRESS \<br/>  --priority=1000 \<br/>  --network=$NETWORK \<br/>  --action=ALLOW \<br/>  --rules=tcp,udp,icmp \<br/>  --source-ranges=130.211.0.0/22,35.191.0.0/16 \<br/>  --target-tags=lb-backend</span><span id="a5c1" class="lq kj hi lm b fi lv ls l lt lu">gcloud compute firewall-rules create allow-hope \<br/>  --direction=INGRESS \<br/>  --priority=1000 \<br/>  --network=$NETWORK \<br/>  --action=ALLOW \<br/>  --rules=tcp:80,tcp:443 \<br/>  --source-ranges=35.199.192.0/19</span><span id="8d23" class="lq kj hi lm b fi lv ls l lt lu">gcloud compute routers create nat-router \<br/>  --network=$NETWORK \<br/>  --region=$REGION</span><span id="f3cb" class="lq kj hi lm b fi lv ls l lt lu">gcloud compute routers nats create nat-config \<br/>  --router=nat-router \<br/>  --auto-allocate-nat-external-ips \<br/>  --nat-all-subnet-ip-ranges \<br/>  --enable-logging \<br/>  --router-region=$REGION</span></pre><h1 id="bfad" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">创建GCE实例</h1><p id="9bf7" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">让我们创建一个没有公共IP的GCE实例。在启动脚本中，我们将安装Docker和运行应用程序所需的其他组件。</p><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="b2b6" class="lq kj hi lm b fi lr ls l lt lu">gcloud compute instances create $GCE_INSTANCE \<br/>  --project=$PROJECT_ID \<br/>  --zone=$ZONE \<br/>  --machine-type=e2-medium \<br/>  --network-interface=subnet=$SUBNET_LB,no-address \<br/>  --maintenance-policy=MIGRATE \<br/>  --tags=lb-backend \<br/>--create-disk=auto-delete=yes,boot=yes,device-name=instance-1,image=projects/debian-cloud/global/images/debian-10-buster-v20220519,mode=rw,size=10,type=projects/$PROJECT_ID/zones/$ZONE/diskTypes/pd-balanced \<br/>  --no-shielded-secure-boot \<br/>  --shielded-vtpm \<br/>  --shielded-integrity-monitoring \<br/>  --reservation-affinity=any \<br/>  --metadata=startup-script='#! /bin/bash<br/>sudo apt-get update<br/>sudo apt-get install -y \<br/>    ca-certificates \<br/>    curl \<br/>    gnupg \<br/>    lsb-release \<br/>    nginx<br/>curl -fsSL <a class="ae jd" href="https://download.docker.com/linux/debian/gpg" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/debian/gpg</a> | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg<br/>echo \<br/>  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] <a class="ae jd" href="https://download.docker.com/linux/debian" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/debian</a> \<br/>  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null<br/>sudo apt-get update<br/>sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin'</span><span id="69cc" class="lq kj hi lm b fi lv ls l lt lu"># For the purpose of the demo, we will create an Unmanaged Instance group. <strong class="lm hj">For a production ready env, we would suggest a MIG.</strong><br/>gcloud compute instance-groups unmanaged create webhook \<br/>    --zone=$ZONE</span><span id="0732" class="lq kj hi lm b fi lv ls l lt lu">gcloud compute instance-groups unmanaged add-instances webhook \<br/>    --zone=$ZONE \<br/>    --instances=$GCE_INSTANCE</span></pre><h1 id="067f" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">配置GCE实例</h1><p id="809e" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">让我们配置NGINX TCP反向代理</p><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="03c9" class="lq kj hi lm b fi lr ls l lt lu">gcloud compute ssh $GCE_INSTANCE \<br/> --zone=$ZONE</span><span id="b6a4" class="lq kj hi lm b fi lv ls l lt lu">export FUNCTIONS_URL=<strong class="lm hj">YOU_REGION</strong>-<strong class="lm hj">YOUR_PROJECT_ID</strong>.cloudfunctions.net</span><span id="dccd" class="lq kj hi lm b fi lv ls l lt lu">mkdir nginx_conf</span><span id="224e" class="lq kj hi lm b fi lv ls l lt lu">cat &gt; nginx_conf/nginx.conf &lt;&lt; EOL<br/>events {}<br/>stream {<br/>    server {<br/>        listen     443;<br/>        proxy_pass $FUNCTIONS_URL:443;<br/>    }<br/>}<br/>EOL</span><span id="9204" class="lq kj hi lm b fi lv ls l lt lu">sudo docker run -v ~/nginx_conf/:/etc/nginx/ -p 443:443 -d nginx</span></pre><h1 id="7a0e" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">创建云函数Webhook</h1><p id="4e1f" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">在同一项目和区域中手动创建云函数。云功能只需要允许内部流量。在这里你可以找到一个详细的一步一步的指南和一个工作实例。</p><h1 id="3519" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">配置ILB TCP(第4级)</h1><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="a68b" class="lq kj hi lm b fi lr ls l lt lu">gcloud compute health-checks create tcp hc-tcp \<br/>    --region=$REGION \<br/>    --port=443<br/>gcloud compute backend-services create be-ilb \<br/>    --load-balancing-scheme=internal \<br/>    --protocol=tcp \<br/>    --region=$REGION \<br/>    --health-checks=hc-tcp \<br/>    --health-checks-region=$REGION<br/>gcloud compute backend-services add-backend be-ilb \<br/>    --region=$REGION \<br/>    --instance-group=webhook \<br/>    --instance-group-zone=$ZONE<br/>gcloud compute forwarding-rules create fr-ilb \<br/>    --region=$REGION \<br/>    --load-balancing-scheme=internal \<br/>    --network=$NETWORK \<br/>    --subnet=$SUBNET \<br/>    --address=10.10.20.99 \<br/>    --ip-protocol=TCP \<br/>    --ports=443 \<br/>    --backend-service=be-ilb \<br/>    --backend-service-region=$REGION</span></pre><h1 id="e5af" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">配置服务目录</h1><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="f04a" class="lq kj hi lm b fi lr ls l lt lu">gcloud service-directory namespaces create df-namespace \<br/>   --location $REGION</span><span id="010b" class="lq kj hi lm b fi lv ls l lt lu">gcloud service-directory services create df-service \<br/>   --namespace df-namespace \<br/>   --location $REGION</span><span id="443a" class="lq kj hi lm b fi lv ls l lt lu">gcloud service-directory endpoints create df-endpoint \<br/>  --service=df-service \<br/>  --namespace=df-namespace \<br/>  --location=$REGION \<br/>  --address=10.10.20.99 \<br/>  --port=443 \<br/>  --network=projects/$PROJECT_NUMBER/locations/global/networks/$NETWORK</span><span id="cc00" class="lq kj hi lm b fi lv ls l lt lu">gcloud service-directory services describe df-service \<br/>  --location $REGION\<br/>  --namespace df-namespace</span></pre><h1 id="1700" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">配置对话流CX</h1><p id="93d2" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">我们快完成了！让我们在同一个区域手动创建一个代理，它将使用作为webhook创建的云功能。<a class="ae jd" href="https://cloud.google.com/dialogflow/cx/docs/quick/webhook" rel="noopener ugc nofollow" target="_blank">在这里</a>你可以找到一个详细的分步指南和一个工作实例。</p><p id="e953" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下配置来配置webhook:</p><ul class=""><li id="89d8" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated"><a class="ae jd" href="https://cloud.google.com/dialogflow/cx/docs/quick/build-agent" rel="noopener ugc nofollow" target="_blank">在云功能的同一个$区域创建一个代理</a></li><li id="f13e" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><a class="ae jd" href="https://cloud.google.com/dialogflow/cx/docs/concept/webhook#sd" rel="noopener ugc nofollow" target="_blank">配置一个webhook </a> : <br/> *服务目录链接:$SD <br/> *主机:云函数URL</li><li id="4ada" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><a class="ae jd" href="https://cloud.google.com/dialogflow/cx/docs/quick/webhook#use_the_webhook" rel="noopener ugc nofollow" target="_blank">配置一个页面调用webhook </a>。可以用<code class="du lw lx ly lm b">message</code>标签来测试一下。消息标签将使用静态消息和时间戳参数进行响应</li><li id="607e" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">使用<a class="ae jd" href="https://cloud.google.com/dialogflow/cx/docs/quick/webhook#test_the_agent_in_the_simulator" rel="noopener ugc nofollow" target="_blank">测试代理</a>来测试您的代理- webhook集成</li></ul><h1 id="006c" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">后续步骤</h1><p id="4e61" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">一旦你的基础设施投入使用，你就可以开始定制你的代理和webhook来满足你的业务需求。</p></div></div>    
</body>
</html>