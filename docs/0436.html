<html>
<head>
<title>Google Cloud Storage “exploder”</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云存储“爆炸者”</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-storage-exploder-221c5b4d219c?source=collection_archive---------0-----------------------#2017-11-17">https://medium.com/google-cloud/google-cloud-storage-exploder-221c5b4d219c?source=collection_archive---------0-----------------------#2017-11-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="9629" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">仅概念验证—使用风险自担</h2></div><p id="ec87" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一个同事问云功能能不能给云存储提供解压功能。另一位同事向我推荐了一个解决方案——原则上类似Firebase函数提供了<a class="ae jt" href="https://firebase.google.com/docs/storage/extend-with-functions#example_image_transformation" rel="noopener ugc nofollow" target="_blank">图像转换</a>；他还建议用“爆炸者”作为一个更能引起共鸣的标题；-)</p><p id="1638" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我的兴趣被激起了，我开发了以下内容作为概念验证(它有效)，但是我<strong class="iz hj">敦促你不要在生产中使用它</strong>。</p><p id="dcd6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">客户提出的一个很好也很普遍的要求是<a class="ae jt" href="https://cloud.google.com/storage/" rel="noopener ugc nofollow" target="_blank">谷歌云存储</a> (GCS)应该包含通用的文件处理工具。目标是这些转换发生在服务端，以减少从GCS下载对象、处理它并将结果返回给GCS的复杂性。对于那些不熟悉GCS的人来说，这是谷歌云平台<a class="ae jt" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">(GCP)中的一项服务，它有效地提供了无限的“对象”即“BLOB”即“非结构化”文件存储。</a></p><p id="983f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可能会开始免费使用谷歌云平台，但我怀疑，如果你正在阅读这篇文章，你可能已经是一个深受喜爱的GCP客户，并可能正在为这个问题寻求一个模板解决方案。亲爱的顾客，请继续阅读。</p><h2 id="3d24" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">设置</h2><p id="bf72" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">您需要一个GCP项目，至少2个GCS桶，并启用云功能:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="cfc4" class="ju jv hi kz b fi ld le l lf lg">ROOT=$(whoami)-$(date +%y%m%d)<br/>BILLING=[[YOUR-BILLING-ID]]<br/>PROJECT=[[YOUR-PROJECT-ID]] // ${ROOT}-gcs-exploder<br/>REGION=[[YOUR-PREFERED-REGION]]</span><span id="9059" class="ju jv hi kz b fi lh le l lf lg">gcloud alpha projects create $PROJECT</span><span id="7452" class="ju jv hi kz b fi lh le l lf lg">gcloud alpha billing projects link $PROJECT --account-id=$BILLING</span><span id="d595" class="ju jv hi kz b fi lh le l lf lg">gcloud services enable cloudfunctions.googleapis.com \<br/>--project=$PROJECT</span><span id="8c3f" class="ju jv hi kz b fi lh le l lf lg">for BUCKET in receive explode staging<br/>do<br/>  gsutil mb \<br/>  -c regional \<br/>  -l ${REGION} \<br/>  -p ${PROJECT} \<br/>  gs://${ROOT}-${BUCKET}<br/>done</span></pre><h2 id="75c2" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">云函数</h2><p id="5eee" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">通常，我都是命令行，但我发现云功能的控制台体验非常好，我发现自己更喜欢它。让我们从控制台开始，通过两种方式来实现这一点:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="066f" class="ju jv hi kz b fi ld le l lf lg"><a class="ae jt" href="https://pantheon.corp.google.com/functions/list?project=dazwilkin-171024-blockchain" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/functions/list?project=$</a>{PROJECT}</span></pre><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es li"><img src="../Images/549312360ceb76264e198d7c03d50029.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e7GV1oUIe8eu9hUO9tg32A.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">云函数:创建函数</figcaption></figure><p id="9c0c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">点击“创建功能”并</p><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es lu"><img src="../Images/67a0b9464f69a65218e8e47971c3e1d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0DFDkMcJ4nlATepu6hJgnA.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">云函数:编辑器</figcaption></figure><ul class=""><li id="fdc4" class="lv lw hi iz b ja jb jd je jg lx jk ly jo lz js ma mb mc md bi translated">你可以选择自己的“名字”</li><li id="83b4" class="lv lw hi iz b ja me jd mf jg mg jk mh jo mi js ma mb mc md bi translated">您可以取消“内存分配”(但可能不需要超过256MB)</li><li id="36c5" class="lv lw hi iz b ja me jd mf jg mg jk mh jo mi js ma mb mc md bi translated">对于“触发器”,选择“云存储桶”</li><li id="5026" class="lv lw hi iz b ja me jd mf jg mg jk mh jo mi js ma mb mc md bi translated">浏览并选择要接收压缩文件的存储桶。如果你遵循所有这些指示，它将被称为<code class="du mj mk ml kz b">${ROOT}-receive</code>。</li></ul><p id="f61b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了方便起见，我将使用行内编辑器。</p><p id="c907" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将<code class="du mj mk ml kz b">index.js</code>替换为:</p><figure class="ku kv kw kx fd lj"><div class="bz dy l di"><div class="mm mn l"/></div></figure><blockquote class="mo mp mq"><p id="fafd" class="ix iy mr iz b ja jb ij jc jd je im jf ms jh ji jj mt jl jm jn mu jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong>用<code class="du mj mk ml kz b">${ROOT}</code>的值替换第13+14行的<code class="du mj mk ml kz b">[[YOUR-ROOT]]</code>。或者您用来创建存储桶的任何名称。</p></blockquote><p id="fe55" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并将<code class="du mj mk ml kz b">package.json</code>替换为:</p><figure class="ku kv kw kx fd lj"><div class="bz dy l di"><div class="mm mn l"/></div></figure><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es mv"><img src="../Images/5fecd556da3d435a861fd708677a6c6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f0kppfcINXwoMu5Sza6dxw.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">云函数:函数-1</figcaption></figure><ul class=""><li id="b67c" class="lv lw hi iz b ja jb jd je jg lx jk ly jo lz js ma mb mc md bi translated">选择“阶段桶”。如果你遵循所有这些指示，它将被称为<code class="du mj mk ml kz b">${ROOT}-staging</code>。</li><li id="f4e7" class="lv lw hi iz b ja me jd mf jg mg jk mh jo mi js ma mb mc md bi translated">因为我将导出的函数重命名为<code class="du mj mk ml kz b">processZip</code>，所以请确保将“要执行的函数”属性更改为该值。</li><li id="aef0" class="lv lw hi iz b ja me jd mf jg mg jk mh jo mi js ma mb mc md bi translated">在“高级选项”下，您可能希望增加默认“60”(秒)的“超时”值。如果在此超时值内没有完成，函数调用将被终止。对于大型zip文件，60秒的时间可能不足以分解它们。</li></ul><p id="6ec1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">单击“创建”将云功能部署到GCP。</p><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es mw"><img src="../Images/13880338a221b63fccd485a68b624792.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jqz8Cl17Fo-PL4Es8hgefg.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">云功能:部署…</figcaption></figure><p id="cbfe" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一切都好:</p><figure class="ku kv kw kx fd lj er es paragraph-image"><div class="er es mx"><img src="../Images/0be7affaed7e6afa2de2b8efd144c6ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:272/format:webp/1*PgYr8MJxISvaQId1S9g5nA.png"/></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">成功！</figcaption></figure><h2 id="4fce" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">测试</h2><p id="947b" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">我们的云函数应该在对GCS“接收”桶的*所有*对象更改时触发。你可以在这里阅读更多关于所谓的<a class="ae jt" href="https://cloud.google.com/storage/docs/object-change-notification" rel="noopener ugc nofollow" target="_blank">对象变更通知</a> (OCN)的信息。在实践中，我们的函数应该更加谨慎地过滤那些用于我们的爆炸装置的ocn。</p><p id="f3aa" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我建议您创建一个相当小的zip文件(<code class="du mj mk ml kz b">${TESTZIP}</code>)来进行测试。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="8edf" class="ju jv hi kz b fi ld le l lf lg">gsutil cp /path/to/${TESTZIP} gs://${ROOT}-receive</span></pre><p id="481f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了确认，您可以运行以下命令，尽管cp命令应该提供足够的成功或失败确认。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="cf24" class="ju jv hi kz b fi ld le l lf lg">gsutil ls gs://${ROOT}-receive</span></pre><p id="941d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">控制台的浏览器有助于浏览GCS存储桶和对象:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="6d41" class="ju jv hi kz b fi ld le l lf lg"><a class="ae jt" href="https://pantheon.corp.google.com/storage/browser?project=dazwilkin-171117-gcs-exploder&amp;organizationId=433637338589" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/storage/browser?project=$</a>{PROJECT}</span></pre><p id="4bf1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它应该显示类似于以下内容的内容:</p><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es mw"><img src="../Images/561c1ca2b184377ddf4ae2e3a3d5054e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Da5jpLuQ9OcaLG4TaXUyAw.png"/></div></div></figure><p id="82d7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您进入“接收”桶，您应该看到您上传的<code class="du mj mk ml kz b">${TESTZIP}</code>文件:</p><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es my"><img src="../Images/1395c195568e699563000a260978fb21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xrbjxcPz-9OsSC9O2l0rCA.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">浏览器:上传的zip文件</figcaption></figure><p id="41db" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您等待几秒钟并导航到“explode”桶，您应该会看到:</p><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es my"><img src="../Images/c40036a0f3b6a720f165dabaab529f49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LCXwbw5Gv64a8hAlo3ofkQ.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">浏览器:“文件夹”</figcaption></figure><p id="accb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">GCS将对象存储在一个平面名称空间中(每个存储桶一个对象)。为了方便起见，GCS显示对象名中包含<code class="du mj mk ml kz b">/</code>的对象，就好像这些对象形成了一个传统的目录层次结构。在代码中，您会看到我在解压后的文件前添加了一个Linux epoch值(在这里是<code class="du mj mk ml kz b">1510952315489</code>)和一个<code class="du mj mk ml kz b">/</code>。浏览器显示bucket的内容，就好像有一个名为<code class="du mj mk ml kz b">1510952315489</code>的目录一样(您的值会有所不同，但它将是唯一的，并且对应于纪元值)，但实现是所有这些图像文件<code class="du mj mk ml kz b">image-1.jpg</code>、<code class="du mj mk ml kz b">image-2.jpg</code>实际上都被命名为:<code class="du mj mk ml kz b">1510952315489/image-1.jpg</code>、<code class="du mj mk ml kz b">1510952315489/image-2.jpg</code> …</p><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es mz"><img src="../Images/ed1b96f358cbf94a06cee90eb9520023.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q38wIqoZvmX3upZyT2o2EA.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">浏览器:解压缩的文件</figcaption></figure><p id="eec5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">那起作用了…我在“接收”桶中的test.zip现在在“分解”桶中被分解。</p><p id="f3d5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且，您应该在云日志中看到我们的<code class="du mj mk ml kz b">console.log</code>输出:</p><figure class="ku kv kw kx fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es na"><img src="../Images/0ec5b85f4534477b99e44a7ad71d86ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dx2IGVz-KIBA_F6APJt-eQ.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">云日志记录</figcaption></figure><p id="bac3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以使用gsutil CLI枚举这个bucket:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="47f8" class="ju jv hi kz b fi ld le l lf lg">gsutil ls -r gs://${ROOT}-explode<br/>gs://dazwilkin-171117-explode/1510952315489/:<br/>gs://dazwilkin-171117-explode/1510952315489/image-1.jpg<br/>gs://dazwilkin-171117-explode/1510952315489/image-2.jpg<br/>gs://dazwilkin-171117-explode/1510952315489/image-3.jpg<br/>gs://dazwilkin-171117-explode/1510952315489/image-3.jpg<br/>gs://dazwilkin-171117-explode/1510952315489/image-4.jpg<br/>gs://dazwilkin-171117-explode/1510952315489/image-5.jpg<br/>gs://dazwilkin-171117-explode/1510952315489/image-6.jpg<br/>gs://dazwilkin-171117-explode/1510952315489/image-7.jpg</span></pre><h2 id="d8a6" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">命令行</h2><p id="8ff7" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">云SDK(“g Cloud”)完全支持云功能。假设你在当前目录下有<code class="du mj mk ml kz b">index.js</code>和<code class="du mj mk ml kz b">package.json</code>。您*不*需要npm安装包。只有两个文件:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="5334" class="ju jv hi kz b fi ld le l lf lg">gcloud beta functions deploy function-1 \<br/>--entry-point=processZip \<br/>--stage-bucket=${ROOT}-staging \<br/>--trigger-bucket=${ROOT}-receive \<br/>--project=${PROJECT}</span></pre><h2 id="77dd" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">结论</h2><p id="1d20" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">希望这将引发一些关于云功能其他用途的想法。再说一次，这只是一个概念验证，在它可以用于任何其他用途之前，还需要做一些工作。</p><h2 id="b44a" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">整理</h2><p id="d540" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">您可以单独删除云函数:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="5306" class="ju jv hi kz b fi ld le l lf lg">gcloud beta functions delete function-1 \<br/>--project=${PROJECT} \<br/>--quiet</span></pre><p id="27de" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可以在递归删除所有对象后删除桶——请<strong class="iz hj">非常</strong>小心使用这个命令:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="af94" class="ju jv hi kz b fi ld le l lf lg">gsutil rm -r gs://${ROOT}-receive<br/>gsutil rm -r gs://${ROOT}-explode</span></pre><p id="31f7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">或者，您可以简单地删除项目，这样也会删除其中的所有内容:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="fa56" class="ju jv hi kz b fi ld le l lf lg">gcloud projects delete ${PROJECT} --quiet</span></pre><p id="6806" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">谢谢！</p></div></div>    
</body>
</html>