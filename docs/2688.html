<html>
<head>
<title>Compromising a vulnerable GCP, INE-Labs GCPGoat walkthrough. Part-1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">危及易受攻击的INE GCP实验室GCPGoat演练。第一部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/compromising-a-vulnerable-gcp-ine-labs-gcpgoat-walkthrough-part-1-90090ed0448b?source=collection_archive---------6-----------------------#2022-12-27">https://medium.com/google-cloud/compromising-a-vulnerable-gcp-ine-labs-gcpgoat-walkthrough-part-1-90090ed0448b?source=collection_archive---------6-----------------------#2022-12-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7e64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大家好，</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="d1cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随着新的一年的开始，我们必须记住网络安全不断发展的本质，以及不断了解最新威胁和最佳实践的必要性。</p><h2 id="81c8" class="jk jl hi bd jm jn jo jp jq jr js jt ju iq jv jw jx iu jy jz ka iy kb kc kd ke bi translated">这篇文章是关于什么的？</h2><p id="3e38" class="pw-post-body-paragraph if ig hi ih b ii kf ik il im kg io ip iq kh is it iu ki iw ix iy kj ja jb jc hb bi translated">今天我们将讨论GCPGoat:一个由#INE实验室开发的易受攻击的GCP基础设施，该基础设施挑战如何破坏应用程序并获得应用程序所在的GCP的管理员访问权限。https://github.com/ine-labs/GCPGoat<br/>T3</p><h2 id="bcd9" class="jk jl hi bd jm jn jo jp jq jr js jt ju iq jv jw jx iu jy jz ka iy kb kc kd ke bi translated">我们将从中学到什么？</h2><p id="23bd" class="pw-post-body-paragraph if ig hi ih b ii kf ik il im kg io ip iq kh is it iu ki iw ix iy kj ja jb jc hb bi translated">在我们应对挑战并了解环境后，我们将尝试总结如何缓解这种情况，以及可以实施哪些保护GCP环境的最佳实践。</p><p id="f2de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GCPGoat提供了各种挑战，包括应用程序攻击和云错误配置，这将导致对Web-app的管理权限和对GCP项目的特权访问。我们将只关注分解步骤，这些步骤将导致访问托管应用程序的GCP项目。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kl"><img src="../Images/25170e73b59bc30fdb102f8e982c5d1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jmkhwvC1MImg0doBlqdbNw.png"/></div></div></figure><p id="d650" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你需要关于如何在你的个人GCP账户上设置GCPGoat应用程序的指导，你可以在这篇文章的末尾找到它们；如果您只是在寻找一个演练，那么让我们开始吧。<br/>如果安装成功，最后会提供一个Web-app的云功能URL，如下图所示。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es ks"><img src="../Images/a2cba0ac63b75dab017b214a197219fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7hAYRsKjsf5ukJXUTAVN9Q.png"/></div></div></figure><p id="977b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们来看看web app和门户网站。最初的挑战是在同一个上通过配置不正确的存储桶(开发存储),我们搜索门户上的所有博客并收集所有正在进行的调用，捕获访问门户时进行的调用显示在存储桶上对存储对象访问进行了多次调用Google api。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kt"><img src="../Images/e379948bd42dbfb6c1a2aff820b1cb8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m6uJPOuZ9kvJxn1Uy8iMjQ.png"/></div></div></figure><p id="2859" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面捕获的数据显示，这个存储桶的名称是prod让我们看看是否能得到这个桶的所有对象。<br/>访问bucket以获取所有对象被拒绝，但可以访问单个对象，这表明bucket具有细粒度的ACL。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es ku"><img src="../Images/4adf8109959bb2c91172829180e9c50c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C4Q1Bjmm1hYchH25jU_ZsQ.png"/></div></div></figure><p id="a56d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">经过一些阅读和帮助，找到了一个用于测试bucket权限的存储API文档<a class="ae kk" href="https://cloud.google.com/storage/docs/json_api/v1/buckets/testIamPermissions" rel="noopener ugc nofollow" target="_blank">这里</a>。这将使您能够在执行未经身份验证或经过身份验证的查询时，确定相关的权限是否与bucket相关联。<br/>我们将使用一个未经验证的API调用来检查bucket IAM权限(<a class="ae kk" href="https://cloud.google.com/storage/docs/access-control/iam-permissions" rel="noopener ugc nofollow" target="_blank"> ref </a>)是否映射到同一个上的“<a class="ae kk" href="https://cloud.google.com/iam/docs/overview#all-users" rel="noopener ugc nofollow" target="_blank"> allUsers </a>”。</p><pre class="jd je jf jg fd kv kw kx bn ky kz bi"><span id="d705" class="la jl hi kw b be lb lc l ld le"> curl \<br/>  'https://storage.googleapis.com/storage/v1/b/prod-blogapp-4b96f7070b93b339/iam/testPermissions?permissions=storage.objects.create&amp;permissions=storage.objects.delete&amp;permissions=storage.objects.get&amp;permissions=storage.objects.getIamPolicy&amp;permissions=storage.objects.list&amp;permissions=storage.objects.setIamPolicy&amp;permissions=storage.objects.update&amp;permissions=storage.buckets.delete&amp;permissions=storage.buckets.get&amp;permissions=storage.buckets.getIamPolicy&amp;permissions=storage.buckets.setIamPolicy&amp;permissions=storage.buckets.update' </span></pre><pre class="lf kv kw kx bn ky kz bi"><span id="5b8d" class="la jl hi kw b be lb lc l ld le">{<br/>  "kind": "storage#testIamPermissionsResponse",<br/>  "permissions": [<br/>    "storage.objects.get"<br/>  ]<br/>}</span></pre><p id="609d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，对于bucket“prod-blogapp-4b 96f 7070 b 93b 339 ”,我们只有“storage.objects.get ”,这对我们的进一步开发没有帮助；相反，让我们通过简单地将上面的bucket名称中的单词“prod”改为“dev”来确定我们是否有一个dev bucket。</p><p id="4bf1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是的，我们可以在相同的上访问dev bucket并运行testIamPermissions未经身份验证的调用，并获得bucket的权限。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es lg"><img src="../Images/db973cfc03d38775da6072fdac9d7ba4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*94LRZwV_6PCz3AarwmG6Yw.png"/></div></div></figure><p id="5609" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽管我们无法检索dev bucket中的所有对象，但上面突出显示了一个有趣的权限集“all users ”( storage . buckets . setiampolicy)。似乎我们可以在同一个上为bucket设置IAM权限，所以让我们使用gsuitl命令来这样做，如下所示。<br/>为了保证在本地设置中没有已经存在的权限/帐户重叠，当利用权限进行未经验证的调用时，最好使用带有<a class="ae kk" href="https://hub.docker.com/r/google/cloud-sdk/" rel="noopener ugc nofollow" target="_blank"> gcloud-sdk </a>的新docker实例。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es lh"><img src="../Images/f87ec13ae2977c9bb4c7af2503fa4119.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I6EBODP34D96aT38KnwJaw.png"/></div></div></figure><pre class="jd je jf jg fd kv kw kx bn ky kz bi"><span id="7585" class="la jl hi kw b be lb lc l ld le">gsutil iam ch allUsers:objectViewer gs://dev-blogapp-4b96f7070b93b339</span></pre><p id="c3de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述命令会将“存储对象查看器”角色设置为“allusers ”,这也会设置“storage.objects.lists ”,这样我们就可以在同一个上获取存储桶中的所有对象。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es li"><img src="../Images/46376aefc6976f499bdcf28f53ef5f2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/1*VnHCFGfH8yPWR3w04xhaRw.png"/></div></figure><p id="3e9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们把所有的东西都列在桶上，看看我们是否有什么有趣的东西。如果您查看共享目录，您会在/shared/files/找到一些有趣的文件，它们的名称是config.txt和ssh keys目录。ssh/ <br/>让我们使用命令<br/>将它们转储到本地:“gsutil CP-r GS://dev-blogapp-4b 96 f 7070 b 93b 339/shared/files/*/tmp/”</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es lj"><img src="../Images/e03c1829aaee22fc534d232d92d6d1e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*BUxeXSJHJYz-PQKzHZuRpQ.png"/></div></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es lk"><img src="../Images/08d177527aed827f560125a4c992817c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*FAqgLLRxoI6fFoVrfeCn7w.png"/></div></figure><p id="505a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看config.txt文件后，我们可以看到host的公共IP地址、用户名和ssh密钥文件的路径。似乎我们也可以连接到实例的端口22。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es ll"><img src="../Images/36d2e398ecb805fc2ed80547aef06bf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:726/format:webp/1*WqOzKqY2j8ALj-nw6NMFmQ.png"/></div></figure><p id="81e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是ssh失败，并出现如下拒绝权限错误</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es lm"><img src="../Images/a4ad407ef91d3d9ce2cb3e2aa997c468.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/1*Z-kGvI713bNgSz6OmK-ebA.png"/></div></figure><p id="cd25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ssh密钥文件拥有过高的权限，如上面的错误所示。ssh密钥私有文件的权限应该仅限于所有者，而不是其他任何人。因此，更新文件的权限并重试ssh确实成功了，并且我能够连接到机器。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es ln"><img src="../Images/b7f4ef79033c6a69f18576919502942e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/1*L8bBtOfyIGWcTkOFTectOg.png"/></div></figure><p id="f822" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获得对实例的访问权限后，无法运行任何sudo命令，但可以在实例上执行gcloud CLI。<br/>发现该实例与默认的计算引擎服务帐户绑定，该帐户默认带有编辑角色，这允许通过“gcloud计算实例列表”获得项目上正在运行的实例。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es lo"><img src="../Images/2ba899504d011917b1e510f20542292b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*LBPMl8X6QoUfV3wWvaFEfg.png"/></div></figure><p id="1482" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我们在同一个项目中有另一个名为“admin-vm”的实例，我们目前在“developer-vm”上，让我们尝试进入“admin-vm”</p><p id="9e94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一篇文章继续…</p><h1 id="d0dc" class="lp jl hi bd jm lq lr ls jq lt lu lv ju lw lx ly jx lz ma mb ka mc md me kd mf bi translated"><strong class="ak">应用程序设置提示</strong></h1><p id="4b0f" class="pw-post-body-paragraph if ig hi ih b ii kf ik il im kg io ip iq kh is it iu ki iw ix iy kj ja jb jc hb bi translated">按照给出的说明在<a class="ae kk" href="https://github.com/ine-labs/GCPGoat" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上安装应用程序。最好的方法是在云shell终端上运行这些步骤，在本地运行会面临多重挑战。</p><p id="e9e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">-如果在本地运行，请确保在相同的和gcloud SDK上安装了terraform。<br/>此外，如果您已经在本地设置了多个帐户，请确保将配置设置为需要托管应用程序的相应项目和帐户ID，并确认运行“gcloud config配置列表”。<br/> -一旦你有了创建新项目的权限，按照这里提到的<a class="ae kk" href="http://Run terraform plan before apply to confirm the changes that going to be deployed, though the list is huge but would be good to grab to a file via command terraform plan -no-color &gt; output.txt. After terraform apply is completed successfully you would be given with a cloud function URL for web app which is vulnerable to attack for explotation." rel="noopener ugc nofollow" target="_blank">的默认安装步骤</a>进行操作。<br/> -在应用前运行“terraform plan”以确认将要部署的更改，虽然列表很大，但最好通过命令terraform plan-no-color&gt;output . txt .<br/>-在terra form应用成功完成后，您将获得一个web应用的云函数URL，该URL容易受到攻击。</p><p id="86da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想在你的GCP上运行探索应用程序，希望现在一切都准备好了，如果你遇到任何问题，欢迎在下面分享评论。</p></div></div>    
</body>
</html>