<html>
<head>
<title>Kubernetes HPA Autoscaling with Kafka metrics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes HPA使用Kafka指标进行自动缩放</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/kubernetes-hpa-autoscaling-with-kafka-metrics-88a671497f07?source=collection_archive---------0-----------------------#2018-12-26">https://medium.com/google-cloud/kubernetes-hpa-autoscaling-with-kafka-metrics-88a671497f07?source=collection_archive---------0-----------------------#2018-12-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/9562654499f8ac651579fdb42771bf30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*POTo0rgHZ746YItPa8medw.png"/></div></figure><p id="250f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Kubernetes本身支持自动缩放。从1.7版本开始，Kubernetes添加了一个基于自定义指标来扩展工作负载的特性。之前的版本只支持根据CPU和内存来扩展应用。</p><p id="263c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Kubernetes 1.7引入了“聚合器层”，它允许Kubernetes在核心的Kubernetes APIs之外扩展更多的API。这使您能够启用自己的定制API。</p><p id="ad1f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在本指南中，我们将了解HPAs、自定义外部指标API的基础知识，以及如何根据从Kafka集群中收集的外部指标来工作和扩展工作负载。</p><p id="ccc0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">以下是您将在本指南中完成的步骤:</p><ul class=""><li id="6868" class="jk jl hi io b ip iq it iu ix jm jb jn jf jo jj jp jq jr js bi translated">步骤1:为Stackdriver启用集群监控。</li><li id="a010" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated">步骤2:部署一个定制的API服务器，并将其注册到聚合器层。</li><li id="3dd4" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated">步骤3:部署度量导出器并写入Stackdriver。</li><li id="8a85" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated">步骤4:部署一个用Golang编写的样例应用程序来测试自动缩放。</li><li id="316c" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated">步骤5:编写基于自定义指标的HPA来扩展应用程序。</li></ul><p id="ccd6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在继续演示之前，我们需要了解一些有用的概念。</p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><h1 id="be8e" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">Kubernetes HPA如何工作？</h1><p id="e1e5" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">水平Pod自动缩放器被实现为Kubernetes API资源和控制器。资源决定了控制器的行为。控制器定期调整复制控制器或部署中的副本数量。</p><p id="0300" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">HorizontalPodAutoscaler通常从一系列聚合的API(<code class="du li lj lk ll b">metrics.k8s.io</code>、<code class="du li lj lk ll b">custom.metrics.k8s.io</code>和<code class="du li lj lk ll b">external.metrics.k8s.io</code>)中获取指标。<code class="du li lj lk ll b">metrics.k8s.io</code> API通常由<strong class="io hj"> metrics-server </strong>提供，需要单独启动。HorizontalPodAutoscaler也可以直接从Heapster获取指标。</p><p id="5e3d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在本指南中，我们将部署来自<code class="du li lj lk ll b">external.metrics.k8s.io</code>的HPA读数，因为我们的Kafka指标将暴露于该API。</p><h1 id="069e" class="kf kg hi bd kh ki lm kk kl km ln ko kp kq lo ks kt ku lp kw kx ky lq la lb lc bi translated">什么是自定义指标？</h1><p id="64b8" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">Kubernetes允许我们部署您自己的指标解决方案。默认情况下，<strong class="io hj">指标服务器</strong>和<strong class="io hj">堆服务器</strong>充当核心指标后端。</p><p id="463a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Kubernetes已经扩展了支持，允许自定义API公开其他指标提供者。很少有适配器是由第三方编写来实现自定义API的，这些API可用于向Kubernetes资源(如HPA)公开这些指标。</p><p id="13fe" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当前实施:<a class="ae lr" href="https://github.com/Kubernetes/metrics/blob/master/IMPLEMENTATIONS.md" rel="noopener ugc nofollow" target="_blank">github.com/Kubernetes/IMPLEMENTATIONS.md</a></p><h1 id="3652" class="kf kg hi bd kh ki lm kk kl km ln ko kp kq lo ks kt ku lp kw kx ky lq la lb lc bi translated">自定义API服务器和HPA是如何联系在一起的？</h1><p id="d011" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">我们部署的定制API服务器向Kubernetes注册了一个API，并允许HPA控制器从中查询定制指标。我们将在这里部署的API服务器是Stackdriver适配器，它可以从Stackdriver收集指标，并通过REST查询将它们发送到HPA控制器。</p><p id="971b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们的定制API服务器将向Kubernetes注册两个API:<code class="du li lj lk ll b">custom.metrics.k8s.io</code>和<code class="du li lj lk ll b">external.metrics.k8s.io</code>。</p><p id="6e52" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们还将部署一个应用程序来将指标(在本例中是Kafka指标)写入google stackdriver。我们将要写入Stackdriver的度量类型将在<code class="du li lj lk ll b">external.metrics.k8s.io</code>下公开，而不是在custom.metrics.k8s.io下</p><h1 id="a89d" class="kf kg hi bd kh ki lm kk kl km ln ko kp kq lo ks kt ku lp kw kx ky lq la lb lc bi translated">先决条件</h1><p id="c66a" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">确保已经满足以下依赖关系:</p><ol class=""><li id="dc22" class="jk jl hi io b ip iq it iu ix jm jb jn jf jo jj ls jq jr js bi translated">你有一个码头运行。你知道这个游戏的规则。；)</li><li id="32ab" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj ls jq jr js bi translated">你有一个Kubernetes集群(GKE)运行在GCP。</li><li id="e92b" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj ls jq jr js bi translated">您已经为您的GKE集群安装并配置了kubectl CLI。</li></ol></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><p id="57e6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们开始演示吧。</p><h1 id="ba5e" class="kf kg hi bd kh ki lm kk kl km ln ko kp kq lo ks kt ku lp kw kx ky lq la lb lc bi translated">1.为Stackdriver启用集群监控</h1><p id="7ad2" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">GCP助手文档:<a class="ae lr" href="https://cloud.google.com/kubernetes-engine/docs/how-to/monitoring#enabling_monitoring_for_an_existing_cluster" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/kubernetes-engine/docs/how-to/monitoring # enabling _ monitoring _ for _ an _ existing _ cluster</a></p><p id="0f64" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">应该在群集节点上启用监视范围。默认启用，<a class="ae lr" href="https://cloud.google.com/kubernetes-engine/docs/how-to/monitoring#enabling_monitoring_for_an_existing_cluster" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/kubernetes-engine/docs/how-to/monitoring # enabling _ monitoring _ for _ an _ existing _ cluster</a>所以你什么都不用做。如果您有旧版本，请将其升级到最新版本，然后也更新您的节点版本。范围将启用对stackdriver的写权限，这对于写度量很重要。</p><pre class="lt lu lv lw fd lx ll ly lz aw ma bi"><span id="52cb" class="mb kg hi ll b fi mc md l me mf">$ gcloud container clusters list<br/>NAME                 LOCATION       MASTER_VERSION  MASTER_IP       MACHINE_TYPE   NODE_VERSION   NUM_NODES  STATUS<br/>my-kube-cluster  us-central1-b  1.10.7-gke.11   xxx.xxx.xxx.xxx  n1-standard-1    1.10.7-gke.11    2          RUNNING</span><span id="e7b6" class="mb kg hi ll b fi mg md l me mf">$ gcloud container clusters describe my-kube-cluster<br/>............<br/>..&lt;output&gt;..<br/>............<br/>oauthScopes:<br/>    - <a class="ae lr" href="https://www.googleapis.com/auth/compute" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/compute</a><br/>    - <a class="ae lr" href="https://www.googleapis.com/auth/devstorage.read_only" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/devstorage.read_only</a><br/>    - <a class="ae lr" href="https://www.googleapis.com/auth/service.management" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/service.management</a><br/>    - <a class="ae lr" href="https://www.googleapis.com/auth/servicecontrol" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/servicecontrol</a><br/>    - <a class="ae lr" href="https://www.googleapis.com/auth/logging.write" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/logging.write</a><br/>    - <a class="ae lr" href="https://www.googleapis.com/auth/monitoring" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/monitoring</a>   <em class="mh"># enabled</em><br/>............<br/>..&lt;output&gt;..<br/>............</span></pre></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><h1 id="8dfe" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">2.部署一个定制的API服务器，并将其注册到聚合器层。</h1><p id="8c6d" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">在部署我们的定制服务器之前，让我们看看k8s中有哪些可用的API。</p><pre class="lt lu lv lw fd lx ll ly lz aw ma bi"><span id="cad7" class="mb kg hi ll b fi mc md l me mf">## Type commands to see existing available APIs<br/>$ kubectl api-versions</span><span id="0864" class="mb kg hi ll b fi mg md l me mf">admissionregistration.k8s.io/v1beta1<br/>apiextensions.k8s.io/v1beta1<br/>apiregistration.k8s.io/v1<br/>apiregistration.k8s.io/v1beta1<br/>............<br/>..&lt;other-APIs&gt;..<br/>............<br/>metrics.k8s.io/v1beta1    # this is our core metrics APIs<br/>............<br/>..&lt;other-APIs&gt;..<br/>............</span></pre><p id="2b51" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这里，您可以看到我们有<code class="du li lj lk ll b">metrics.k8s.io</code>可用，但我们需要<code class="du li lj lk ll b">external.metrics.k8s.io</code>来公开我们的stackdriver指标，并允许HPA通读它。</p><p id="bcf8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将使用定制的metrics stackdriver适配器来注册我们的API。</p><pre class="lt lu lv lw fd lx ll ly lz aw ma bi"><span id="ab18" class="mb kg hi ll b fi mc md l me mf"># Use one of google user account to create a cluster role<br/>$ kubectl create clusterrolebinding cluster-admin-binding \<br/>    --clusterrole cluster-admin --user "$(gcloud config get-value account)"</span><span id="5c90" class="mb kg hi ll b fi mg md l me mf"># We will deploy new resource model based APIs</span><span id="cbfd" class="mb kg hi ll b fi mg md l me mf">$ kubectl apply -f <a class="ae lr" href="https://raw.githubusercontent.com/GoogleCloudPlatform/k8s-stackdriver/master/custom-metrics-stackdriver-adapter/deploy/production/adapter_new_resource_model.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/GoogleCloudPlatform/k8s-stackdriver/master/custom-metrics-stackdriver-adapter/deploy/production/adapter_new_resource_model.yaml</a></span><span id="88d1" class="mb kg hi ll b fi mg md l me mf">namespace "custom-metrics" created<br/>serviceaccount "custom-metrics-stackdriver-adapter" created<br/>clusterrolebinding.rbac.authorization.k8s.io "custom-metrics:system:auth-delegator" created<br/>rolebinding.rbac.authorization.k8s.io "custom-metrics-auth-reader" created<br/>clusterrolebinding.rbac.authorization.k8s.io "custom-metrics-resource-reader" created<br/>deployment.extensions "custom-metrics-stackdriver-adapter" created<br/>service "custom-metrics-stackdriver-adapter" created<br/>apiservice.apiregistration.k8s.io "v1beta1.custom.metrics.k8s.io" created<br/>apiservice.apiregistration.k8s.io "v1beta1.external.metrics.k8s.io" created<br/>clusterrole.rbac.authorization.k8s.io "external-metrics-reader" created<br/>clusterrolebinding.rbac.authorization.k8s.io "external-metrics-reader" created</span></pre><p id="4e6f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，我们已经将自定义服务器和注册的API部署到聚合器层。</p><pre class="lt lu lv lw fd lx ll ly lz aw ma bi"><span id="72b5" class="mb kg hi ll b fi mc md l me mf"># Custom Metrics APIs verification</span><span id="58df" class="mb kg hi ll b fi mg md l me mf">$  kubectl get all -n custom-metrics<br/>NAME                                                 READY     STATUS    RESTARTS   AGE<br/>custom-metrics-stackdriver-adapter-6c9bd9679-m2cnh   1/1       Running   0          2m</span><span id="900f" class="mb kg hi ll b fi mg md l me mf"># Type again to get available APIs<br/>$ kubectl api-versions<br/>............<br/>..&lt;other-APIs&gt;..<br/>............<br/>metrics.k8s.io/v1beta1<br/>.....<br/>custom.metrics.k8s.io/v1beta1   # for custom Kubernetes metrics<br/>external.metrics.k8s.io/v1beta1 # for external metrics<br/>............<br/>..&lt;other-APIs&gt;..<br/>............</span></pre><p id="5be7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，查询我们刚刚上线的新API。</p><pre class="lt lu lv lw fd lx ll ly lz aw ma bi"><span id="2ca5" class="mb kg hi ll b fi mc md l me mf">$ kubectl get --raw "/apis/external.metrics.k8s.io/v1beta1" | jq<br/>$ kubectl get --raw "/apis/custom.metrics.k8s.io/v1beta1" | jq</span></pre><p id="430e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，您可以看到，这两个API都是在线的，有许多自定义指标可供查询。接下来，我们将向stackdriver写入Kafka指标，这些API将帮助我们从中读取。</p><p id="2259" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">详细资源:<a class="ae lr" href="https://github.com/GoogleCloudPlatform/k8s-stackdriver/tree/master/custom-metrics-stackdriver-adapter" rel="noopener ugc nofollow" target="_blank">k8s-stack driver/custom-metrics-stack driver-adapter</a></p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><h1 id="f2eb" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">3.部署指标导出器并写入stackdriver。</h1><p id="242e" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">我们正在使用<a class="ae lr" href="https://github.com/danielqsj/kafka_exporter" rel="noopener ugc nofollow" target="_blank"> Kafka exporter </a>，它将读取我的Kafka集群并以<a class="ae lr" href="https://prometheus.io/docs/instrumenting/exposition_formats/" rel="noopener ugc nofollow" target="_blank"> prometheus格式</a>公开指标，我们将我们的部署与这个<a class="ae lr" href="https://github.com/GoogleCloudPlatform/k8s-stackdriver/tree/master/prometheus-to-sd" rel="noopener ugc nofollow" target="_blank">k8s-stack driver/Prometheus-to-SD</a>sidecar容器结合起来。Kafka-exporter将读取Kafka集群，并在特定的web-URL上公开指标，我们的sidecar容器将读取这些指标并写入stackdriver。很简单，我们开始吧。</p><pre class="lt lu lv lw fd lx ll ly lz aw ma bi"><span id="7107" class="mb kg hi ll b fi mc md l me mf"><em class="mh"># prometheus-to-sd-custom-metrics-kafka-exporter.yaml</em><br/>apiVersion: extensions/v1beta1<br/>kind: Deployment<br/>metadata:<br/>  name: custom-metrics-kafka-exporter<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      custom: metrics<br/>  template:<br/>    metadata:<br/>      labels:<br/>        custom: metrics<br/>    spec:<br/>      hostNetwork: true<br/>      containers:<br/>      - name: kafka-exporter<br/>        image: danielqsj/kafka-exporter<br/>        command:<br/>        - kafka_exporter<br/>        - "--kafka.server=my-kafka-broker-1:9092"<br/>        - "--kafka.server=my-kafka-broker-2:9092"<br/>        ports:<br/>          - name: http-metrics<br/>            containerPort: 9308<br/>        readinessProbe:<br/>          httpGet:<br/>            path: /<br/>            port: 9308<br/>          initialDelaySeconds: 5<br/>          timeoutSeconds: 5<br/>      - name: prometheus-to-sd<br/>        image: gcr.io/google-containers/prometheus-to-sd:v0.3.2<br/>        ports:<br/>          - name: profiler<br/>            containerPort: 6060<br/>        command:<br/>          - /monitor<br/>          - --stackdriver-prefix=custom.googleapis.com<br/>          - --source=kafka-exporter:http://localhost:9308?whitelisted=kafka_brokers,kafka_topic_partitions,kafka_consumergroup_current_offset_sum,kafka_consumergroup_lag_sum<br/>          - --pod-id=<strong class="ll hj">$(</strong>POD_NAME<strong class="ll hj">)</strong><br/>          - --namespace-id=<strong class="ll hj">$(</strong>POD_NAMESPACE<strong class="ll hj">)</strong><br/>        env:<br/>          - name: POD_NAME<br/>            valueFrom:<br/>              fieldRef:<br/>                fieldPath: metadata.name<br/>          - name: POD_NAMESPACE<br/>            valueFrom:<br/>              fieldRef:<br/>                fieldPath: metadata.namespace</span></pre><p id="4a4c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">部署它以将您的指标发送到stackdriver。</p><pre class="lt lu lv lw fd lx ll ly lz aw ma bi"><span id="0ef1" class="mb kg hi ll b fi mc md l me mf">kubectl apply -f prometheus-to-sd-custom-metrics-kafka-exporter.yaml</span></pre><p id="633a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下一步是探索stackdriver并过滤您的外部指标。可用指标:<a class="ae lr" href="https://github.com/danielqsj/kafka_exporter#metrics" rel="noopener ugc nofollow" target="_blank">https://github.com/danielqsj/kafka_exporter#metrics</a></p><blockquote class="mi mj mk"><p id="6a12" class="im in mh io b ip iq ir is it iu iv iw ml iy iz ja mm jc jd je mn jg jh ji jj hb bi translated">比如搜索:卡夫卡_经纪人</p></blockquote><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="er es mo"><img src="../Images/287fda41109f5eded9b835e9bce58984.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vwiOn5-ph1c1G1Ln.png"/></div></div><figcaption class="mt mu et er es mv mw bd b be z dx translated">堆栈驱动度量浏览器</figcaption></figure><p id="559d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您还可以查询已注册的API来读取这些外部值。</p><pre class="lt lu lv lw fd lx ll ly lz aw ma bi"><span id="b7dd" class="mb kg hi ll b fi mc md l me mf">$ kubectl get --raw "/apis/external.metrics.k8s.io/v1beta1/namespaces/default/custom.googleapis.com|kafka-exporter|kafka_brokers" | jq</span><span id="2e22" class="mb kg hi ll b fi mg md l me mf">{<br/>  "kind": "ExternalMetricValueList",<br/>  "apiVersion": "external.metrics.k8s.io/v1beta1",<br/>  "metadata": {<br/>    "selfLink": "/apis/external.metrics.k8s.io/v1beta1/namespaces/default/custom.googleapis.com%7Ckafka-exporter%7Ckafka_brokers"<br/>  },<br/>  "items": [<br/>    {<br/>      "metricName": "custom.googleapis.com|kafka-exporter|kafka_brokers",<br/>      "metricLabels": {<br/>        "resource.labels.cluster_name": "my-kube-cluster",<br/>        "resource.labels.container_name": "",<br/>        "resource.labels.instance_id": "gke-my-kube-cluster-69201eb2-dvdg",<br/>        "resource.labels.namespace_id": "default",<br/>        "resource.labels.pod_id": "custom-metrics-kafka-exporter-56764bbbc9-p5xqb",<br/>        "resource.labels.zone": "us-central1-b",<br/>        "resource.type": "gke_container"<br/>      },<br/>      "timestamp": "2018-12-25T12:56:46Z",<br/>      "value": "2"<br/>    }<br/>  ]<br/>}</span></pre></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><h1 id="4bce" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">4.部署一个用golang编写的示例应用程序来测试自动缩放。</h1><p id="b187" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">到目前为止，我们已经检查了所有有助于向HPA展示我们的指标的复杂部分。从现在开始，我们将运行一些我们通常在Kubernetes中执行的基本操作。</p><p id="be3a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了模拟自动缩放，我部署了一个用golang编写的示例应用程序，它将作为Kafka主题的Kafka客户端(生产者和消费者)。</p><blockquote class="mi mj mk"><p id="142a" class="im in mh io b ip iq ir is it iu iv iw ml iy iz ja mm jc jd je mn jg jh ji jj hb bi translated">参考代码:<a class="ae lr" href="https://github.com/sunnykrGupta/k8s-hpa-custom-autoscaling-kafka-metrics/tree/master/go-kafka" rel="noopener ugc nofollow" target="_blank">k8s-HPA-自定义-自动缩放-kafka-metrics/go-kafka </a></p></blockquote><pre class="lt lu lv lw fd lx ll ly lz aw ma bi"><span id="084e" class="mb kg hi ll b fi mc md l me mf">$ kubectl get deploy -llang=golang<br/>NAME                       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br/>consumer-kafka-go-client   1         1         1            1           25m<br/>producer-kafka-go-client   1         1         1            1           30m</span><span id="88b8" class="mb kg hi ll b fi mg md l me mf"><em class="mh"># scaling the producer app to build a consumer lag on kafka topic</em><br/>$ kubectl scale --replicas=2 deployment/producer-kafka-go-client</span></pre><p id="5548" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我已经调整了我的生成器，这样它就可以推送足够的消息来为我的消费者客户端建立延迟，我们将在消费者部署上测试我们的HPA。</p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><h1 id="aeb6" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">5.编写基于自定义指标的HPA来扩展应用程序。</h1><p id="dd0d" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">既然我已经扩展了我的Kafka producer，那么在Kafka主题中应该会有一个消费者滞后。我们已经准备好HPA，通过我们新注册的API读取来自stackdriver的外部指标。以上所有的辛苦都是为了这一刻。</p><p id="bee9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下面是我的HPA清单文件，它将帮助扩展我们的Kafka消费者:</p><pre class="lt lu lv lw fd lx ll ly lz aw ma bi"><span id="3e55" class="mb kg hi ll b fi mc md l me mf"># kafka-custom-metrics-hpa.yaml<br/>apiVersion: autoscaling/v2beta1<br/>kind: HorizontalPodAutoscaler<br/>metadata:<br/>  name: consumer-kafka-go-client<br/>spec:<br/>  minReplicas: 1<br/>  maxReplicas: 5<br/>  metrics:<br/>  - type: External<br/>    external:<br/>      # which metrics to read from stackdriver<br/>      metricName: custom.googleapis.com|kafka-exporter|kafka_consumergroup_lag_sum<br/>      metricSelector:<br/>        matchLabels:<br/>          # define labels to target<br/>          metric.labels.consumergroup: golang-consumer<br/>      # scale +1 whenever it crosses multiples of mentioned value<br/>      targetAverageValue: "1000"<br/>  # define deployment to control<br/>  scaleTargetRef:<br/>    apiVersion: extensions/v1beta1<br/>    kind: Deployment<br/>    name: consumer-kafka-go-client</span><span id="f000" class="mb kg hi ll b fi mg md l me mf">$ kubectl apply -f kafka-custom-metrics-hpa.yaml<br/>horizontalpodautoscaler.autoscaling "consumer-kafka-go-client" configured</span></pre><p id="fa8f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们查询我们的kafka_consumer_lag，看看当前的统计数据是什么。</p><pre class="lt lu lv lw fd lx ll ly lz aw ma bi"><span id="bbf9" class="mb kg hi ll b fi mc md l me mf">kubectl get --raw "/apis/external.metrics.k8s.io/v1beta1/namespaces/default/custom.googleapis.com|kafka-exporter|kafka_consumergroup_lag_sum" | jq</span><span id="dce4" class="mb kg hi ll b fi mg md l me mf">{<br/>  "kind": "ExternalMetricValueList",<br/>  "apiVersion": "external.metrics.k8s.io/v1beta1",<br/>  "metadata": {<br/>    "selfLink": "/apis/external.metrics.k8s.io/v1beta1/namespaces/default/custom.googleapis.com%7Ckafka-exporter%7Ckafka_consumergroup_lag_sum"<br/>  },<br/>  "items": [<br/>    {<br/>      "metricName": "custom.googleapis.com|kafka-exporter|kafka_consumergroup_lag_sum",<br/>      "metricLabels": {<br/>        "metric.labels.consumergroup": "golang-consumer",<br/>        "metric.labels.topic": "custom-topic",<br/>        "resource.labels.container_name": "",<br/>        "resource.labels.namespace_id": "default",<br/>        "resource.labels.pod_id": "custom-metrics-kafka-exporter-547c7f4d5c-tqtw8",<br/>        "resource.labels.zone": "us-central1-b",<br/>        "resource.type": "gke_container"<br/>      },<br/>      "timestamp": "2018-12-25T18:46:54Z",<br/>      "value": "732"<br/>    }<br/>  ]<br/>}</span></pre><p id="33f3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在轮询一些统计数据一段时间后，我看到自动缩放在一段时间后触发。耶！！在这种情况下，它根据在stackdriver上找到的数字将应用程序扩展到4个副本。</p><pre class="lt lu lv lw fd lx ll ly lz aw ma bi"><span id="0096" class="mb kg hi ll b fi mc md l me mf">$ kubectl get hpa<br/>NAME                       REFERENCE                             TARGETS        MINPODS   MAXPODS   REPLICAS   AGE<br/>consumer-kafka-go-client   Deployment/consumer-kafka-go-client   732/1k (avg)   1         5         1          4m</span><span id="20d7" class="mb kg hi ll b fi mg md l me mf">$ kubectl get hpa<br/>NAME                       REFERENCE                             TARGETS         MINPODS   MAXPODS   REPLICAS   AGE<br/>consumer-kafka-go-client   Deployment/consumer-kafka-go-client   4032/1k (avg)   1         5         1          12m</span><span id="027d" class="mb kg hi ll b fi mg md l me mf">$ kubectl get hpa<br/>NAME                       REFERENCE                             TARGETS         MINPODS   MAXPODS   REPLICAS   AGE<br/>consumer-kafka-go-client   Deployment/consumer-kafka-go-client   1008/1k (avg)   1         5         4          13m</span></pre><figure class="lt lu lv lw fd ij er es paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="er es mx"><img src="../Images/6d603ea932688098e53d93bdb9fbcd19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*js1y0U5R2cSgX4EI.png"/></div></div><figcaption class="mt mu et er es mv mw bd b be z dx translated">Kafka消费者滞后指标</figcaption></figure></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><p id="693f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当您希望根据生产中部署的工作的复杂性来扩展工作负载时，自定义自动扩展是一个非常有用的功能。可能是磁盘大小、网络、负载平衡器连接等。</p><p id="330f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">希望你喜欢这个指南。竖起大拇指，在评论中提问。</p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><p id="4db4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">Github:</strong><a class="ae lr" href="https://github.com/sunnykrGupta/k8s-hpa-custom-autoscaling-kafka-metrics" rel="noopener ugc nofollow" target="_blank"><strong class="io hj">https://Github . com/sunnykrGupta/k8s-HPA-custom-autoscaling-Kafka-metrics</strong></a></p><p id="d7e9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">感谢<a class="my mz ge" href="https://medium.com/u/be723eddb0e6?source=post_page-----88a671497f07--------------------------------" rel="noopener" target="_blank"> Arvind Jha </a>的编辑和建议。</p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><h2 id="9089" class="mb kg hi bd kh na nb nc kl nd ne nf kp ix ng nh kt jb ni nj kx jf nk nl lb nm bi translated">资源:</h2><ul class=""><li id="6637" class="jk jl hi io b ip ld it le ix nn jb no jf np jj jp jq jr js bi translated"><a class="ae lr" href="https://github.com/GoogleCloudPlatform/k8s-stackdriver/tree/master/prometheus-to-sd" rel="noopener ugc nofollow" target="_blank">普罗米修斯到sd </a></li><li id="6e63" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated"><a class="ae lr" href="https://github.com/danielqsj/kafka_exporter" rel="noopener ugc nofollow" target="_blank">卡夫卡_出口商</a></li><li id="25f1" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated"><a class="ae lr" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale" rel="noopener ugc nofollow" target="_blank">运行-应用/水平-pod-自动缩放</a></li><li id="2e52" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated"><a class="ae lr" href="https://github.com/GoogleCloudPlatform/k8s-stackdriver/tree/master/custom-metrics-stackdriver-adapter" rel="noopener ugc nofollow" target="_blank">自定义指标堆栈驱动程序适配器</a></li><li id="68f2" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated"><a class="ae lr" href="https://cloud.google.com/kubernetes-engine/docs/tutorials/external-metrics-autoscaling" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/kubernetes-engine/docs/tutorials/external-metrics-auto scaling</a></li><li id="fda1" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated"><a class="ae lr" href="https://kubernetes.io/docs/concepts/extend-Kubernetes/api-extension/apiserver-aggregation/" rel="noopener ugc nofollow" target="_blank">https://Kubernetes . io/docs/concepts/extend-Kubernetes/API-extension/API server-aggregation/</a></li><li id="37a7" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated"><a class="ae lr" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-metrics-not-related-to-Kubernetes-objects" rel="noopener ugc nofollow" target="_blank">在与Kubernetes对象无关的度量上自动缩放</a></li></ul></div></div>    
</body>
</html>