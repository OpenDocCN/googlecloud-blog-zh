<html>
<head>
<title>Cromwell “Hello GCP”</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">克伦威尔《你好，GCP》</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cromwell-hello-gcp-833c18df3caf?source=collection_archive---------0-----------------------#2021-10-03">https://medium.com/google-cloud/cromwell-hello-gcp-833c18df3caf?source=collection_archive---------0-----------------------#2021-10-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="8af0" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">背景</h1><p id="c075" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">克伦威尔是生物信息学领域最受欢迎的工作流引擎之一。本教程试图帮助研究人员和IT团队按照最佳实践进行基本部署，并为生产做好准备。它还讨论了选择运行工作流的位置和使用生命科学API的位置的一些最佳实践。</p><p id="5ab0" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">本教程还将包括一些有用的技巧，如如何使用IAP以更安全的方式访问Cromwell API服务器，而不使用公共IP地址，以及启用私有Google访问和创建NAT网关以支持工作虚拟机使用私有IP地址。</p><h1 id="d44c" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">体系结构</h1><p id="3067" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">本指南遵循<a class="ae kb" href="https://cloud.google.com/architecture/genomic-data-processing-reference-architecture" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/architecture/genomic-data-processing-reference-architecture</a>中概述的相同架构</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/1392b59e68e7ab4e0025f169f76c6e2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_gyn_fbqIf8Amlx7"/></div></div></figure><h1 id="3e9e" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">关键变量和决策</h1><p id="67cb" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在开始部署之前，您需要决定一些事情，比如Cromwell服务器在哪里，以及您将使用的SQL实例的类型。这是我们将在部署和配置文件中使用的变量和值的列表。您需要仔细考虑在哪里创建这些资源，因为这可能会影响性能。</p><ol class=""><li id="5c08" class="kt ku hi jf b jg kc jk kd jo kv js kw jw kx ka ky kz la lb bi translated">项目id <project-id/></li><li id="ddf0" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated"><a class="ae kb" href="https://cloud.google.com/life-sciences/docs/concepts/locations" rel="noopener ugc nofollow" target="_blank">生命科学API位置</a> &lt;位置&gt;</li><li id="7cb9" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">创建数据库、克伦威尔服务器等<zone/></li><li id="103e" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">工作虚拟机的区域<zones/></li><li id="f529" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">克伦威尔服务器使用的虚拟机<cromwell-vm/></li><li id="af2d" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">MySQL实例<cromwell-db/></li><li id="fe85" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">MySQL用户名<db-username>和密码<db-password/></db-username></li><li id="4101" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">GCS存储桶<gcs-bucket/></li></ol><h1 id="3d9c" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">供应MySQL</h1><p id="e9cc" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">用MySQL运行克伦威尔有很多优点，比如能够以服务器模式运行并提交多个作业、共享输出、能够查看时序图、恢复失败的管道等。</p><p id="28b7" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">实例类型和磁盘大小取决于预期运行的并行管道的数量。在本教程中，我从n1-standard-1实例类型和20GB SSD磁盘开始，我发现这对于运行几个并行管道来说绰绰有余。您可以随时更改，但需要重新启动。</p><ol class=""><li id="2a67" class="kt ku hi jf b jg kc jk kd jo kv js kw jw kx ka ky kz la lb bi translated">浏览到云SQL并创建实例</li></ol><p id="4b9c" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">2.选择MySQL，你可能需要启用API</p><p id="2aad" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">3.除非需要高可用性，否则更改为单区域可用性</p><p id="16f2" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">4.更新地区/区域以匹配克伦威尔服务器的位置</p><p id="0e20" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">5.点击显示配置选项</p><p id="ce6d" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">6.更新机器类型</p><p id="743d" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">7.如果需要，更新存储并调整大小</p><p id="09a8" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">8.展开连接，取消选中公共IP并选择专用IP</p><p id="b8c8" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">9.选择运行服务器的网络，通常是默认网络</p><p id="e40a" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">10.您可能需要设置专用服务访问连接，如果您以前没有为此VPC设置过，请单击“启用API”并选择“使用自动分配的IP范围”。单击继续，然后创建连接</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es lh"><img src="../Images/98747e87330d8538b2ff6f78d3132caf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/0*HJUdIiCFCZ0tVUmN"/></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es li"><img src="../Images/1a65f39d2cce37232c7f9ac8577c8ab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/0*N6O1qRWcKarhbCf5"/></div></figure><p id="04d3" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">11.单击创建实例</p><p id="8311" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">12.创建数据库后，单击实例，然后单击数据库，并创建一个新的数据库“cromwell”</p><p id="7efe" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">13.注意私有ip地址<db-ipaddress>,因为稍后将在配置文件中使用它</db-ipaddress></p><h1 id="55d1" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">创建NAT和配置私有Google访问和防火墙</h1><h1 id="9ab9" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">私人谷歌访问</h1><ol class=""><li id="e51b" class="kt ku hi jf b jg jh jk jl jo lj js lk jw ll ka ky kz la lb bi translated">在VPC网络中，选择<region>的子网，克伦威尔服务器和工作节点将在该子网中进行配置</region></li></ol><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lm"><img src="../Images/ed6b946c7e819b269b6888f00a5d4a7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xsfWwiWAnNCpP7RZ"/></div></div></figure><p id="fad4" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">2.点击“编辑”</p><p id="ddb5" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">3.将“私人谷歌访问”更改为“开启”</p><p id="c7c8" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">4.单击保存</p><h1 id="b0c4" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">添加防火墙规则以允许来自IAP IP范围的访问</h1><p id="6137" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">稍后将使用此防火墙来允许流量流向身份识别代理服务，以实现安全访问。</p><ol class=""><li id="ba50" class="kt ku hi jf b jg kc jk kd jo kv js kw jw kx ka ky kz la lb bi translated">点击防火墙</li><li id="7d87" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">单击“创建防火墙规则”</li><li id="3bda" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">添加适当的名称，例如allow-cromwell-iap-access</li><li id="b8a9" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">确保选择了正确的网络</li><li id="3256" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">在目标标签中添加“克伦威尔-iap”</li><li id="7298" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">在源过滤器中添加苹果酒范围“35.235.240.0/20”</li><li id="61a8" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">选择TCP并添加8000</li><li id="83d0" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">单击创建</li></ol><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es ln"><img src="../Images/348fbdcf5f819331a3a3476ca3fe51da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1138/0*lJJvYadbwiGpKKij"/></div></figure><h1 id="e5af" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">创建云NAT</h1><ol class=""><li id="7a55" class="kt ku hi jf b jg jh jk jl jo lj js lk jw ll ka ky kz la lb bi translated">点击网络服务→云NAT</li><li id="e329" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">单击“创建NAT网关”</li><li id="bd74" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">添加名称，如克伦威尔-纳特</li><li id="6fbb" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">选择网络(通常默认)和地区<region/></li><li id="2b68" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">点击云路由器，然后创建新的路由器</li></ol><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es lo"><img src="../Images/89d3e437ce6ef23d27cf12a58a267755.png" data-original-src="https://miro.medium.com/v2/resize:fit:1066/format:webp/1*rAtl_e2viCUB_-cKg25Yfg.png"/></div></figure><p id="b882" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">6.添加路由器名称，例如Cromwell-NAT-路由器</p><p id="a73a" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">7.单击创建，然后单击创建</p><h1 id="9e4d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">创建服务帐户</h1><ol class=""><li id="c11c" class="kt ku hi jf b jg jh jk jl jo lj js lk jw ll ka ky kz la lb bi translated">单击IAM &amp; Admin→服务帐户</li><li id="f575" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">单击“创建服务帐户”</li><li id="5027" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">输入服务帐户名称，例如“cromwell-sa”</li><li id="2415" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">添加适当的描述</li><li id="c32c" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">单击“创建并继续”</li><li id="0437" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">添加以下角色</li><li id="adbc" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">云SQL管理</li><li id="978f" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">云生命科学工作流运行器</li><li id="fcce" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">服务使用消费者</li><li id="4c79" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">存储对象管理</li><li id="37ac" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">单击完成</li><li id="8962" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">单击服务帐户，然后选择“密钥”选项卡</li><li id="f7a0" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">单击添加密钥→创建新密钥</li><li id="83d5" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">单击Create，将密钥下载到一个安全的位置，并重命名为credentials.json</li></ol><h1 id="e8e0" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">创建存储桶</h1><p id="7c29" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">创建一个区域标准云存储桶，它应该和worker节点放在同一个区域。如果员工将在多个区域工作，您也可以考虑使用双区域或多区域。</p><h1 id="b223" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">启用生命科学API</h1><p id="8685" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在顶部搜索生命科学API的搜索框中，选择API，然后单击启用按钮</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lp"><img src="../Images/8b8b01dece981c50e889d1549d167623.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Knov2A72GnVq3IWiBUqSA.png"/></div></div></figure><h1 id="d8c6" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">设置克伦威尔服务器</h1><p id="bf8d" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我通常从e2-standard-4实例开始，然后根据控制台上的建议调整大小。较小的实例仍然可以工作。</p><ol class=""><li id="7116" class="kt ku hi jf b jg kc jk kd jo kv js kw jw kx ka ky kz la lb bi translated">创建新的虚拟机克伦威尔服务器</li><li id="886c" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">将区域设置为<zone/></li><li id="c6d5" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">根据预期的工作流数量选择合适的规模，您可以从e2-standard-4开始</li><li id="0aa6" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">更新访问范围以允许对所有云API的完全访问</li><li id="87b6" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">展开网络并添加网络标签“cromwell-iap”</li><li id="e105" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">展开网络接口，并将外部IP地址更改为“无”</li><li id="d290" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">单击创建</li></ol><h1 id="7ba0" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">部署和配置克伦威尔</h1><h1 id="d9fb" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">下载克伦威尔，jdk和其他工具</h1><ol class=""><li id="7bcd" class="kt ku hi jf b jg jh jk jl jo lj js lk jw ll ka ky kz la lb bi translated">从控制台或使用gcloud通过SSH连接到克伦威尔服务器</li><li id="0c26" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">运行以下命令</li></ol><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="01fa" class="lv ig hi lr b fi lw lx l ly lz">sudo apt update</span><span id="9a88" class="lv ig hi lr b fi ma lx l ly lz">sudo apt install -y git wget openjdk-11-jdk</span></pre><p id="15a0" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">3.检查最新的<a class="ae kb" href="https://github.com/broadinstitute/cromwell/releases" rel="noopener ugc nofollow" target="_blank">克伦威尔版本</a>并下载jar文件</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="502b" class="lv ig hi lr b fi lw lx l ly lz">wget <a class="ae kb" href="https://github.com/broadinstitute/cromwell/releases/download/69/womtool-69.jar" rel="noopener ugc nofollow" target="_blank">https://github.com/broadinstitute/cromwell/releases/download/69/womtool-69.jar</a></span><span id="6573" class="lv ig hi lr b fi ma lx l ly lz">wget <a class="ae kb" href="https://github.com/broadinstitute/cromwell/releases/download/69/cromwell-69.jar" rel="noopener ugc nofollow" target="_blank">https://github.com/broadinstitute/cromwell/releases/download/69/cromwell-69.jar</a></span></pre><p id="44c2" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">4.重命名下载的文件</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="34a4" class="lv ig hi lr b fi lw lx l ly lz">mv cromwell-69.jar cromwell.jar</span></pre><h1 id="9b46" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">正在创建配置文件</h1><p id="d00c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我创建了一个示例conf文件，它解决了许多可能没有很好记录的问题。</p><ol class=""><li id="d4c5" class="kt ku hi jf b jg kc jk kd jo kv js kw jw kx ka ky kz la lb bi translated">下载<a class="ae kb" href="https://raw.githubusercontent.com/hnawar/cromwell-hello/main/PAPIv2.conf" rel="noopener ugc nofollow" target="_blank">样本会议文件</a></li><li id="ff86" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">编辑以下值</li><li id="0ee4" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">项目id</li><li id="1d16" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">服务帐户电子邮件</li><li id="81d9" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">存储桶</li><li id="c89f" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">位置和端点url(如果不使用us-central1)</li><li id="4740" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">区域</li><li id="217f" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">数据库IP和密码</li><li id="6d35" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka ky kz la lb bi translated">将之前创建的conf文件和credentials.json上传到VM，关于将文件传输到VM的更多信息，请查看这个<a class="ae kb" href="https://cloud.google.com/compute/docs/instances/transfer-files" rel="noopener ugc nofollow" target="_blank">指南</a>。</li></ol><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mb"><img src="../Images/2011e18107768c940f4e0ee67bb4421f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cgdfe_tyhmzb0DL5HCHrlA.png"/></div></div></figure><h1 id="e4d6" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">测试配置并运行hello.wdl</h1><p id="933e" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这将在独立模式下运行克伦威尔。这有助于检测配置中的任何问题，并在以服务器模式运行之前进行调试。</p><ol class=""><li id="2336" class="kt ku hi jf b jg kc jk kd jo kv js kw jw kx ka ky kz la lb bi translated">用以下内容创建一个hello.wdl文件</li></ol><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="c000" class="lv ig hi lr b fi lw lx l ly lz">workflow myWorkflow {<br/>  call myTask<br/>}<br/>task myTask {<br/>  command {<br/>    echo “hello GCP”<br/>  }<br/>  runtime {<br/>    docker: “ubuntu:latest”<br/>  }<br/>  output {<br/>    String out = read_string(stdout())<br/>  }<br/>}</span></pre><p id="d824" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">2.运行工作流，您还可以检查控制台，观察创建工作虚拟机来运行任务的过程。您应该在输出中看到“你好，GCP”。</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="a89a" class="lv ig hi lr b fi lw lx l ly lz">java -Dconfig.file=PAPIv2.conf -jar cromwell.jar run hello.wdl</span></pre><h1 id="7692" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">创建和启动克伦威尔服务</h1><ol class=""><li id="cb44" class="kt ku hi jf b jg jh jk jl jo lj js lk jw ll ka ky kz la lb bi translated">使用您最喜欢的文本编辑器作为root创建一个文件/etc/systemd/system/Cromwell . service，例如</li></ol><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="d937" class="lv ig hi lr b fi lw lx l ly lz">sudo vi /etc/systemd/system/cromwell.service</span></pre><p id="a257" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">2.复制并粘贴下面的示例，根据虚拟机的形状调整堆内存的大小(Xmx**G)</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="6354" class="lv ig hi lr b fi lw lx l ly lz">[Unit]<br/>Description=Cromwell Server<br/>After=network.target</span><span id="dad7" class="lv ig hi lr b fi ma lx l ly lz">[Service]<br/>User=root<br/>Group=root<br/>Restart=always<br/>TimeoutStopSec=10<br/>RestartSec=5<br/>WorkingDirectory=/home/&lt;linux_user&gt;<br/>ExecStart=/usr/bin/java -Xmx10G -Dconfig.file=PAPIv2.conf -jar cromwell.jar server</span><span id="c8c7" class="lv ig hi lr b fi ma lx l ly lz">[Install]<br/>WantedBy=multi-user.target</span></pre><p id="2240" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">3.退出并保存</p><p id="d955" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">4.重新加载linux守护进程并启动服务</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="5c53" class="lv ig hi lr b fi lw lx l ly lz">sudo systemctl daemon-reload</span><span id="61a7" class="lv ig hi lr b fi ma lx l ly lz">sudo systemctl start cromwell.service</span></pre><p id="bda5" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">5.使其在服务器重启时自动启动</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="2d6f" class="lv ig hi lr b fi lw lx l ly lz">sudo systemctl enable cromwell.service</span></pre><p id="efde" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">6.您可以通过运行以下命令来检查服务状态</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="4338" class="lv ig hi lr b fi lw lx l ly lz">sudo systemctl status cromwell.service</span></pre><p id="3ec9" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">键入“q”退出</p><h1 id="c34a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">提交您的hello.wdl</h1><p id="8300" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">现在我们有了一个正在运行的服务器，我们将再次运行hello.wdl，但是这次使用submit而不是run。这将把wdl提交给已经作为服务运行的服务器，而不是启动一个新的cromwell实例</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="af18" class="lv ig hi lr b fi lw lx l ly lz">java -Dconfig.file=PAPIv2.conf -jar cromwell.jar submit hello.wdl</span></pre><h1 id="0589" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">使用IAP连接到克伦威尔服务器</h1><p id="3bb7" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">以下要求您的设备上安装了Google Cloud SDK。如果你使用的是Chromebook，你可以在Linux Shell (Crostini)上这样做，注意ChromeOS会自动将端口8080转发给Linux VM</p><p id="9f60" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">从配置了gcloud的终端到正确的项目运行</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="c6a8" class="lv ig hi lr b fi lw lx l ly lz">gcloud compute start-iap-tunnel &lt;cromwell-vm&gt; 8000 --local-host-port=localhost:8080 --zone=&lt;zone&gt;</span></pre><p id="a58e" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">现在，打开您的web浏览器并浏览到localhost:8080，这应该会打开您的克伦威尔服务器的swagger页面，现在让我们也尝试从CLI访问它，尝试运行</p><pre class="ki kj kk kl fd lq lr ls lt aw lu bi"><span id="b132" class="lv ig hi lr b fi lw lx l ly lz">curl -X GET “http://localhost:8080/api/workflows/v1/query" -H “accept: application/json”</span></pre><p id="5daa" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">这将返回已经运行的工作流列表，包括我们之前运行的hello.wdl。您可以检查其他可用的API，例如工作流计时，这在调试或优化工作流时非常有用</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mc"><img src="../Images/8773d21457cd6c9a38ee8890674fbf56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LGHIZlwYLpUCoqBk"/></div></div></figure><h1 id="d6a1" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">其他最佳实践</h1><h1 id="f0f8" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">在欧洲跑步</h1><ul class=""><li id="c050" class="kt ku hi jf b jg jh jk jl jo lj js lk jw ll ka md kz la lb bi translated">确保您的资源和端点都在欧盟或所需区域，包括克伦威尔虚拟机、云SQL、存储桶、位置等，这有助于提高性能和减少延迟。</li><li id="577a" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka md kz la lb bi translated">许多参考文件托管在美国，这可能会增加本地化时间的开销，并可能会增加由请求者付费托管的文件的成本，因为您将支付从美国到欧盟的费用</li><li id="570e" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka md kz la lb bi translated">确保端点url配置正确，与位置匹配</li></ul><h1 id="3922" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">使用容器注册表</h1><ul class=""><li id="615f" class="kt ku hi jf b jg jh jk jl jo lj js lk jw ll ka md kz la lb bi translated">使用Docker HUB或其他公共注册中心可能会增加开销，特别是当对同一个容器发出多个pull请求时，其中一些服务会应用节流。因此，将容器推送到<a class="ae kb" href="https://cloud.google.com/container-registry/docs/pushing-and-pulling" rel="noopener ugc nofollow" target="_blank">容器注册中心</a>，将容器推送到最近的区域注册中心可以提高工作流的性能</li><li id="8ad6" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka md kz la lb bi translated">另外请注意，如果从外部注册中心拉容器或者如果没有配置私有Google访问，通过云NAT拉容器会产生NAT入侵费用</li><li id="46bc" class="kt ku hi jf b jg lc jk ld jo le js lf jw lg ka md kz la lb bi translated">与参考文件类似，从偏远地区拉集装箱可能会产生额外的成本</li></ul><h1 id="de29" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">正在清理执行目录</h1><p id="5582" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">执行目录会很快变大，请确保将输出复制到单独的位置，并在不再需要时清理中间文件。</p><p id="bb0e" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">您还可以将配置文件中的delete _ intermediate _ output _ files标志设置为true，这将删除工作流最终输出中未提及的任何文件。查看克伦威尔<a class="ae kb" href="https://cromwell.readthedocs.io/en/stable/wf_options/Google/" rel="noopener ugc nofollow" target="_blank">文档</a>，了解更多关于这个和其他谷歌特定选项的信息</p></div></div>    
</body>
</html>