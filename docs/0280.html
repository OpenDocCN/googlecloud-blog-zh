<html>
<head>
<title>Stackdriver Monitoring And Ruby</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">堆栈驱动程序监控和Ruby</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/stackdriver-monitoring-and-ruby-b073b8b0af5c?source=collection_archive---------2-----------------------#2017-05-11">https://medium.com/google-cloud/stackdriver-monitoring-and-ruby-b073b8b0af5c?source=collection_archive---------2-----------------------#2017-05-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/ba63a75ad5f97790325a1f1e667665e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9b-doT2U1NXvs8dGI01VWg.png"/></div></div></figure><div class=""/><p id="3447" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本周，我一直在学习如何使用<a class="ae jo" href="https://github.com/GoogleCloudPlatform/google-cloud-ruby/tree/master/google-cloud-monitoring" rel="noopener ugc nofollow" target="_blank">谷歌云监控</a> gem访问Stackdriver监控。虽然Stackdriver Monitoring是一个完全发布的产品，但是用于监控的Ruby客户端库仍然处于alpha级别的质量。凭良心说，我不建议您将alpha质量库用于像监控这样重要的事情。然而，我知道你们中的一些人无论如何都会这样做，所以这里有一些入门的技巧。</p><h2 id="f7e3" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">安装和认证</h2><p id="27a2" class="pw-post-body-paragraph iq ir ht is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">不出所料，你用<code class="du kp kq kr ks b">gem install google-cloud-monitoring</code>安装宝石。监控gem依赖于需要C扩展的<code class="du kp kq kr ks b">grpc</code>。在某些版本的Linux和JRuby上安装这个gem还有一些未解决的问题。</p><p id="2176" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于下面的例子，我通过我用<code class="du kp kq kr ks b">gcloud</code> SDK设置的凭证进行认证。还有其他几种身份验证方法。关于认证的官方文档是这里的<a class="ae jo" href="https://googlecloudplatform.github.io/google-cloud-ruby/#/docs/google-cloud/master/guides/authentication" rel="noopener ugc nofollow" target="_blank"/>。我的关于认证的博文<a class="ae jo" href="http://www.thagomizer.com/blog/2017/01/11/authenticating-google-cloud-ruby-gems.html" rel="noopener ugc nofollow" target="_blank">更详细地介绍了不同认证方法的方式和原因。</a></p><p id="b9bc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在使用监控库的任何脚本的开始，您都需要做一些样板设置。</p><figure class="kt ku kv kw fd hk"><div class="bz dy l di"><div class="kx ky l"/></div></figure><p id="6920" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">设置项目变量的行只是确保项目按照监控API期望的方式格式化。</p><h2 id="bbfd" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">阅读指标</h2><p id="2190" class="pw-post-body-paragraph iq ir ht is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">Stackdriver Monitoring将指标数据称为时间序列。要通过Ruby gem读取度量数据，可以使用<code class="du kp kq kr ks b">MetricServiceClient#list_time_series</code>方法。这个方法有四个必需的参数:name、filter、interval和view。</p><p id="5201" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Name是我在上面的样板文件中显示的格式化的项目名称。视图指定应该返回哪些数据。有两个可能的值:<code class="du kp kq kr ks b">FULL</code>和<code class="du kp kq kr ks b">HEADERS</code>。因为我想要实际的数据，所以我使用了<code class="du kp kq kr ks b">TimeSeriesView::FULL</code>。filter参数允许您控制返回什么数据。有许多<a class="ae jo" href="https://cloud.google.com/monitoring/api/v3/filters" rel="noopener ugc nofollow" target="_blank">支持的过滤器</a>，包括项目、组和资源类型。在这篇文章中，我将查看运行<a class="ae jo" href="http://www.thagomizer.com/blog/2017/03/09/rails-on-app-engine.html" rel="noopener ugc nofollow" target="_blank">“Tind-Purr”</a>的应用引擎集群的内存使用情况。您可以使用<a class="ae jo" href="https://app.google.stackdriver.com/metrics-explorer" rel="noopener ugc nofollow" target="_blank">指标浏览器</a>查找可能的指标。使用metric explorer，我发现我想要看到的指标是“appengine/system/memory/usage”。当在监控API中使用这个指标时，我需要通过添加<code class="du kp kq kr ks b">.googleapis.com</code>来指定指标的全名，这给了我"appengine.googleapis.com/system/memory/usage"。</p><p id="26ef" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后一个参数是时间间隔。指定时间间隔有点困难。您需要知道自Unix纪元以来的开始和结束时间，以秒为单位。在Ruby中，最快的方法是在时间对象上调用<code class="du kp kq kr ks b">to_i</code>。下面的代码创建了一个当前时间戳的结束时间和一个结束时间前10分钟的开始时间。</p><pre class="kt ku kv kw fd kz ks la lb aw lc bi"><span id="b949" class="jp jq ht ks b fi ld le l lf lg">end_time = Time.now.to_i<br/>start_time = end_time - (60 * 10) # 10 minutes</span></pre><p id="2f5c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦我有了开始和结束时间，我就创建一个新的TimeInterval对象，然后为开始和结束时间创建一个<code class="du kp kq kr ks b">Google::Protobuf::Timestamp</code>对象。</p><figure class="kt ku kv kw fd hk"><div class="bz dy l di"><div class="kx ky l"/></div></figure><p id="ef1c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">把所有这些放在一起，我得到这个代码来读取一个度量时间序列。</p><figure class="kt ku kv kw fd hk"><div class="bz dy l di"><div class="kx ky l"/></div></figure><p id="61aa" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个调用返回一个<code class="du kp kq kr ks b"><a class="ae jo" href="https://googlecloudplatform.github.io/google-cloud-ruby/#/docs/google-cloud-monitoring/v0.24.0/google/monitoring/v3/timeseries" rel="noopener ugc nofollow" target="_blank">Google::Monitoring::V3::TimeSeries</a></code>对象。这个对象有一些元数据和一个点数组。每个点都是<code class="du kp kq kr ks b"><a class="ae jo" href="https://googlecloudplatform.github.io/google-cloud-ruby/#/docs/google-cloud-monitoring/v0.24.0/google/monitoring/v3/point" rel="noopener ugc nofollow" target="_blank">Google::Monitoring::V3::Point</a></code>的一个实例，它有时间信息和值对象。要提取值，您需要知道类型并调用适当的方法。下面的代码为时间序列创建一个包含所有整数值的数组。</p><pre class="kt ku kv kw fd kz ks la lb aw lc bi"><span id="1ddd" class="jp jq ht ks b fi ld le l lf lg">points = time_series.first.points.map { |p| p.value.int64_value }</span></pre><p id="0b6e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是从Stackdriver Monitoring中读取指标所需的代码。在以后的博文中，我将向您展示如何从Ruby为Stackdriver Monitoring编写自定义指标。</p><p id="097f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lh">原载于</em> <a class="ae jo" href="http://thagomizer.com/blog/2017/05/11/stackdriver-monitoring-and-ruby.html" rel="noopener ugc nofollow" target="_blank"> <em class="lh">【致命伤】</em> </a></p></div></div>    
</body>
</html>