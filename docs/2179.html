<html>
<head>
<title>Setting up secure Pub/Sub flow with Go and Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Go和Terraform设置安全发布/订阅流</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/setting-up-secure-pub-sub-flow-with-go-and-terraform-6b779026a3e1?source=collection_archive---------1-----------------------#2022-05-05">https://medium.com/google-cloud/setting-up-secure-pub-sub-flow-with-go-and-terraform-6b779026a3e1?source=collection_archive---------1-----------------------#2022-05-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div class="er es hg"><img src="../Images/d2fda749e575fa06e24b3903f75d1fb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*lcp0mwzzuUyh8Rq3dIh62A.png"/></div></figure><div class=""/><p id="e805" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">本文涵盖了处理错误和通知的完全托管的消息处理管道。代码库实现了最小特权原则，把重试和死锁逻辑留给了GCP。</p><p id="c971" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">假设我有一个用例，我的零售公司希望接收更新产品信息的事件。在这种情况下，我将设置一个API端点，将其公开给信息提供者，以确保身份验证和授权。对于每次更新，我都希望将这些信息处理到我公司的数据库中。如果出现故障，我会将每条消息保存到数据库中，以便通过适当的渠道通知我们的开发团队进行调试。</p><p id="0d0e" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">可以使用云运行(API层和消息处理)、处理消息流的发布/订阅(确保调用定义的云运行实例)和充当数据库的云存储的组合来解决上述场景。要发送通知，我们将使用Mailgun。Mailgun API密钥将存储在Google Secret Manager中，只能由通知API的服务帐户访问。</p><figure class="jl jm jn jo fd hk er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es jk"><img src="../Images/37eaf8cea74044f2f6ad2574c3152bc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U9IMPD9vV2xqNBSSyZCeWw.png"/></div></div><figcaption class="jt ju et er es jv jw bd b be z dx translated">流程图</figcaption></figure><p id="4362" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们简单地浏览一下流程:</p><ul class=""><li id="3e11" class="jx jy hp io b ip iq it iu ix jz jb ka jf kb jj kc kd ke kf bi translated"><strong class="io hq"> <em class="kg">消息生成器</em> </strong>接收HTTP请求生成10条消息。那些消息都是发布到<strong class="io hq"> <em class="kg">普通</em> </strong> Pub/Sub主题</li><li id="9e37" class="jx jy hp io b ip kh it ki ix kj jb kk jf kl jj kc kd ke kf bi translated">在这10条消息中，有一条被硬编码为失败，在<strong class="io hq"> <em class="kg">消息处理器</em> </strong> api中返回406状态代码。剩余的消息将存储在<strong class="io hq"> <em class="kg"> pubsub-ok </em> </strong>桶中。</li><li id="daab" class="jx jy hp io b ip kh it ki ix kj jb kk jf kl jj kc kd ke kf bi translated"><strong class="io hq">失败</strong>的消息在发布到<strong class="io hq"> <em class="kg">死信</em> </strong>主题之前，会进行五次指数退避处理</li><li id="24fa" class="jx jy hp io b ip kh it ki ix kj jb kk jf kl jj kc kd ke kf bi translated"><strong class="io hq"><em class="kg">deadletter-GS-saver</em></strong>订阅的处理器将消息存储在<strong class="io hq"> <em class="kg"> pubsub-error </em> </strong>桶中。通过在错误桶内创建一个文件，另一个消息将被GCS触发并发布到<strong class="io hq"> <em class="kg">通知</em> </strong>主题。</li><li id="93f3" class="jx jy hp io b ip kh it ki ix kj jb kk jf kl jj kc kd ke kf bi translated">GCS触发的消息将由<strong class="io hq"> <em class="kg">通知</em> </strong>服务处理，并发送带有文件链接的电子邮件。</li></ul><p id="ca4e" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">解决方案的所有部分都以确保职责分离和最小特权原则的方式编码。发布者的服务帐户仅具有允许应用程序将消息发布到一个特定主题的权限。处理器有权将文件写入各自的存储桶。当查看Google Cloud Console中的IAM页面时，您不会看到分配给任何服务帐户的任何项目范围的权限，因为每个必要的权限都应用在资源级别，这极大地限制了攻击面:</p><figure class="jl jm jn jo fd hk er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es km"><img src="../Images/a405e49b68593bd5a2ebe3f9808846cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6C5rvXHNDltt9CVvKpLtsQ.png"/></div></div></figure></div><div class="ab cl kn ko gp kp" role="separator"><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks"/></div><div class="hb hc hd he hf"><h1 id="a95d" class="ku kv hp bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">好玩！关于解决方案的部分</h1><p id="c8fc" class="pw-post-body-paragraph im in hp io b ip ls ir is it lt iv iw ix lu iz ja jb lv jd je jf lw jh ji jj hb bi translated">该解决方案实现了Google推荐的几个巧妙的技巧:</p><ul class=""><li id="bf29" class="jx jy hp io b ip iq it iu ix jz jb ka jf kb jj kc kd ke kf bi translated">每个云运行实例使用单独的服务帐户运行，该帐户被分配了资源级别(主题、订阅、存储桶)的最小权限集。例如，普通处理器的服务帐户没有IAM角色来写入<strong class="io hq"> pubsub-error </strong> bucket，反之亦然。</li><li id="0f0d" class="jx jy hp io b ip kh it ki ix kj jb kk jf kl jj kc kd ke kf bi translated">处理处理和通知的云运行实例仅限于内部入口。</li><li id="c23b" class="jx jy hp io b ip kh it ki ix kj jb kk jf kl jj kc kd ke kf bi translated">云运行通知程序实例正在从Secret Manager获取Mailgun令牌，并自动将其作为环境变量注入。</li><li id="ec3a" class="jx jy hp io b ip kh it ki ix kj jb kk jf kl jj kc kd ke kf bi translated">通过利用docker文件中的多阶段构建，我们的映像大小只有大约12Mb，因此云运行几乎不需要时间。</li></ul><h1 id="fadf" class="ku kv hp bd kw kx lx kz la lb ly ld le lf lz lh li lj ma ll lm ln mb lp lq lr bi translated"><strong class="ak">自己部署！</strong></h1><p id="de3a" class="pw-post-body-paragraph im in hp io b ip ls ir is it lt iv iw ix lu iz ja jb lv jd je jf lw jh ji jj hb bi translated">随意克隆<a class="ae mc" href="https://github.com/adriantr/pubsub-push-flow" rel="noopener ugc nofollow" target="_blank">这个</a> repo，使用docker-compose构建映像，将它们推送到GCR，并在运行Terraform命令时通过提供必要的变量来应用Terraform配置。</p></div><div class="ab cl kn ko gp kp" role="separator"><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks"/></div><div class="hb hc hd he hf"><p id="d409" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有兴趣了解更多关于我们Strise.ai如何从谷歌云平台中获得乐趣以及我们的环境看起来如何？停下来喝杯咖啡或者在LinkedIn上联系我们！</p><p id="ac17" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">是的——我们正在<a class="ae mc" href="https://www.strise.ai/about-us/careers" rel="noopener ugc nofollow" target="_blank">招聘</a>。</p></div></div>    
</body>
</html>