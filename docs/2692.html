<html>
<head>
<title>Load data from GCS to Bigtable — using GCP Dataproc Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将数据从GCS加载到Bigtable —使用GCP Dataproc无服务器</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/load-data-from-gcs-to-bigtable-using-gcp-dataproc-serverless-5c43d773e615?source=collection_archive---------10-----------------------#2022-12-27">https://medium.com/google-cloud/load-data-from-gcs-to-bigtable-using-gcp-dataproc-serverless-5c43d773e615?source=collection_archive---------10-----------------------#2022-12-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="86d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud Dataproc平台的最新功能之一，<a class="ae jd" href="https://cloud.google.com/dataproc-serverless/docs/overview" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Dataproc无服务器</strong> </a>，使客户无需创建或维护集群即可运行Spark工作负载。一旦Spark工作负载参数被指定并且任务被提交给服务，Dataproc Serverless将在后台处理所有必要的基础设施。它使开发人员能够专注于应用程序的基本逻辑，而不是花时间管理框架</p><p id="6da9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于有了<a class="ae jd" href="https://github.com/GoogleCloudPlatform/dataproc-templates" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Dataproc模板</strong> </a>，我们无需从头开始创建它们，就可以使用Java和Python在Dataproc无服务器上运行典型用例。借助这些模板，我们可以轻松定制和运行常见的Spark工作负载。</p><p id="f05e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您正在寻找一个使用Dataproc Serverless  将数据从GCS移动到Bigtable的<strong class="ih hj"> <em class="je"> Spark-Java模板，这篇博客文章可能会很有用。</em></strong></p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/3a9e58c505d76250f34011117af2350f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ewcx6W3bl6-ubx0A.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">GCS到Bigtable</figcaption></figure><h2 id="0641" class="jv jw hi bd jx jy jz ka kb kc kd ke kf iq kg kh ki iu kj kk kl iy km kn ko kp bi translated"><strong class="ak">主要优势</strong></h2><ul class=""><li id="9922" class="kq kr hi ih b ii ks im kt iq ku iu kv iy kw jc kx ky kz la bi translated"><a class="ae jd" href="https://github.com/GoogleCloudPlatform/dataproc-templates/tree/main/java/src/main/java/com/google/cloud/dataproc/templates/gcs" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">GCSToBigTable</strong></a>模板开源，配置驱动，随时可用。</li><li id="d664" class="kq kr hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">支持的文件格式有CSV、Parquet和Avro。</li><li id="d885" class="kq kr hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">通过简单地改变连接参数，这些模板可以相对快速地用于具有相同需求的用例。</li></ul><h2 id="1020" class="jv jw hi bd jx jy jz ka kb kc kd ke kf iq kg kh ki iu kj kk kl iy km kn ko kp bi translated"><strong class="ak">基本用法</strong></h2><p id="b2a6" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq lg is it iu lh iw ix iy li ja jb jc hb bi translated">1) <a class="ae jd" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank">谷歌云SDK </a>安装并认证。您可以使用Google Cloud控制台中的Cloud Shell，通过这个<a class="ae jd" href="https://console.cloud.google.com/cloudshell/editor" rel="noopener ugc nofollow" target="_blank">链接</a>来配置一个环境。</p><p id="21a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2)如果您要使用由GCP生成的“默认”VPC网络，请确保您已经启用了带有专用Google访问的子网。您仍然需要启用如下的私人访问。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es lj"><img src="../Images/f8da266a3240098d367f1ae1ac501548.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/0*ikwIn6JeicqWmxkW.png"/></div></figure><pre class="jg jh ji jj fd lk ll lm bn ln lo bi"><span id="790c" class="lp jw hi ll b be lq lr l ls lt">gcloud compute networks subnets update default - region=us-central1 - enable-private-ip-google-access</span></pre><p id="5895" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3)在预装了<a class="ae jd" href="https://cloud.google.com/shell/docs/how-cloud-shell-works" rel="noopener ugc nofollow" target="_blank">各种工具</a>的云壳中克隆git repo。或者，你可以使用任何预装了JDK 8+，Maven和Git的机器。</p><pre class="jg jh ji jj fd lk ll lm bn ln lo bi"><span id="89c8" class="lp jw hi ll b be lq lr l ls lt">git clone https://github.com/GoogleCloudPlatform/dataproc-templates.git <br/>cd dataproc-templates/java</span></pre><p id="b10e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4)创建GCS存储桶和暂存文件夹。这个存储桶将用于存储运行无服务器集群所需的依赖项/ Jar文件</p><p id="89ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5)创建一个GCS桶和一个输入文件夹。所需的文件(csv/avro/parquet)需要上传到该文件夹中，并在执行时提供位置</p><p id="aa45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6)在集群的实例中创建一个具有所需列族的BigTable表。(如果实例不存在，则创建实例)</p><p id="96f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7)获取认证凭证(提交Dataproc作业)。</p><pre class="jg jh ji jj fd lk ll lm bn ln lo bi"><span id="9e0b" class="lp jw hi ll b be lq lr l ls lt">gcloud auth application-default login</span></pre><p id="6e81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">8)配置Dataproc无服务器作业:</p><p id="ac04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要执行dataproc作业，需要设置以下配置。</p><ul class=""><li id="21c5" class="kq kr hi ih b ii ij im in iq lu iu lv iy lw jc kx ky kz la bi translated"><code class="du lx ly lz ll b">GCP_PROJECT</code>:无服务器运行Dataproc的GCP项目。</li><li id="8a40" class="kq kr hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated"><code class="du lx ly lz ll b">REGION</code>:运行Dataproc无服务器的区域。</li><li id="f8fb" class="kq kr hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated"><code class="du lx ly lz ll b">GCS_STAGING_LOCATION</code>:一个GCS位置，Dataproc将在此存储登台资产。应该在之前创建的存储桶内。</li></ul><pre class="jg jh ji jj fd lk ll lm bn ln lo bi"><span id="6e54" class="lp jw hi ll b be lq lr l ls lt">export GCP_PROJECT=&lt;project_id&gt;<br/>export REGION=&lt;region&gt;<br/>export GCS_STAGING_LOCATION=&lt;gcs-staging-bucket-folder&gt;</span></pre><p id="8b0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">9)执行GCS到BigTable模板，为执行指定模板和以下参数值</p><ul class=""><li id="c1a1" class="kq kr hi ih b ii ij im in iq lu iu lv iy lw jc kx ky kz la bi translated"><code class="du lx ly lz ll b">project.id</code>:发布/订阅的项目id</li><li id="2c2b" class="kq kr hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated"><code class="du lx ly lz ll b">gcs.bigtable.input.location</code>:输入文件的位置</li><li id="c222" class="kq kr hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated"><code class="du lx ly lz ll b">gcs.bigtable.input.format</code>:输入文件的格式(csv/avro/parquet)</li><li id="5f90" class="kq kr hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated"><code class="du lx ly lz ll b">gcs.bigtable.output.instance.id</code>:Bigtable的实例Id</li><li id="c62d" class="kq kr hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated"><code class="du lx ly lz ll b">gcs.bigtable.output.project.id</code>:Bigtable的项目Id</li><li id="acf3" class="kq kr hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated"><code class="du lx ly lz ll b">gcs.bigtable.table.name</code> : Bigtable表名</li><li id="89fe" class="kq kr hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated"><code class="du lx ly lz ll b">gcs.bigtable.column.family</code>:bigtable表的列族。</li></ul><pre class="jg jh ji jj fd lk ll lm bn ln lo bi"><span id="659b" class="lp jw hi ll b be lq lr l ls lt">bin/start.sh \<br/>-- --template GCSTOBIGTABLE \<br/>--templateProperty project.id=&lt;gcp-project-id&gt; \<br/>--templateProperty gcs.bigtable.input.location=&lt;gcs file location&gt; \<br/>--templateProperty gcs.bigtable.input.format=&lt;csv|parquet|avro&gt; \<br/>--templateProperty gcs.bigtable.output.instance.id=&lt;bigtable instance Id&gt; \<br/>--templateProperty gcs.bigtable.output.project.id=&lt;bigtable project Id&gt; \<br/>--templateProperty gcs.bigtable.table.name=&lt;bigtable tableName&gt; \<br/>--templateProperty gcs.bigtable.column.family=&lt;bigtable column family&gt;<br/><br/><br/>Here is an example submission:<br/>export GCP_PROJECT=your-project-id<br/>export REGION=your-region <br/>export GCS_STAGING_LOCATION=gs://your-bucket/temp <br/><br/>bin/start.sh -- --template GCSTOBIGTABLE --templateProperty project.id=your-project-id --templateProperty gcs.bigtable.input.location=gs://your-bucket/test/file.csv --templateProperty gcs.bigtable.input.format=csv --templateProperty gcs.bigtable.output.instance.id=your-bt-instance-id --templateProperty gcs.bigtable.output.project.id=your-project-id --templateProperty gcs.bigtable.table.name=your-bt-table --templateProperty gcs.bigtable.column.family=cf</span></pre><p id="12a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>:如果尚未启用，它会要求您启用Dataproc Api。</p><p id="e907" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是GCS中的输入文件和BigTable中的输出行的示例</p><pre class="jg jh ji jj fd lk ll lm bn ln lo bi"><span id="63cf" class="lp jw hi ll b be lq lr l ls lt">Sample CSV file (Us-cities.csv)<br/><br/>name,post_abbr,zip,phonecode<br/>Alabama,AL,94519,925<br/>Alaska,AK,94520,408<br/><br/>Sample Row in BigTable:<br/>Alabama<br/>  cf:name                                  @ 2022/12/20-06:22:34.057000<br/>    "Alabama"<br/>  cf:phonecode                             @ 2022/12/20-06:22:34.057000<br/>    "925"<br/>  cf:post_abbr                             @ 2022/12/20-06:22:34.057000<br/>    "AL"<br/>  cf:zip                                   @ 2022/12/20-06:22:34.057000<br/>    "94519"<br/><br/>Alaska<br/>  cf:name                                  @ 2022/12/20-06:22:34.602000<br/>    "Alaska"<br/>  cf:phonecode                             @ 2022/12/20-06:22:34.602000<br/>    "408"<br/>  cf:post_abbr                             @ 2022/12/20-06:22:34.602000<br/>    "AK"<br/>  cf:zip                                   @ 2022/12/20-06:22:34.602000<br/>    "94520"</span></pre><p id="f452" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">10)监视火花批量作业</p><p id="087e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提交作业后，我们将能够在<a class="ae jd" href="https://console.cloud.google.com/dataproc/batches" rel="noopener ugc nofollow" target="_blank"> Dataproc批处理UI </a>中看到。从那里，我们可以查看作业的指标和日志。</p><p id="ec83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">参考文献</strong><br/><a class="ae jd" href="https://cloud.google.com/bigtable/docs/overview" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/bigtable/docs/overview</a><br/><a class="ae jd" href="https://github.com/GoogleCloudPlatform/dataproc-templates" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/dataproc-templates</a></p><p id="041c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如有任何疑问/建议，请联系:<strong class="ih hj">data proc-templates-support-external</strong>@ Google groups . com</p></div></div>    
</body>
</html>