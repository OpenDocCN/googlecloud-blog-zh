<html>
<head>
<title>BigQuery: Tell me your region, I will tell you your speed!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">告诉我你的地区，我会告诉你你的速度！</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bigquery-tell-me-your-region-i-will-tell-you-your-speed-41dcf42b8cc?source=collection_archive---------0-----------------------#2021-09-21">https://medium.com/google-cloud/bigquery-tell-me-your-region-i-will-tell-you-your-speed-41dcf42b8cc?source=collection_archive---------0-----------------------#2021-09-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/994280817302858e2ea86f869b44ecc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sOdWgAmdA2gkAv1FhCfw-Q.png"/></div></div></figure><p id="7800" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Google Cloud作为任何云提供商，<strong class="is hj">都需要拓展</strong>，<strong class="is hj">开辟新区域</strong>(查看维基百科上的<a class="ae jo" href="https://en.wikipedia.org/wiki/Google_Cloud_Platform#Regions_and_zones" rel="noopener ugc nofollow" target="_blank">历史)。今天，28个地区已经启动并运行，任何6个地区都将启动。</a></p><p id="95b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">新的数据中心<strong class="is hj">意味着新的硬件安装</strong>和配置。然后，<strong class="is hj">硬件继续存在一段时间</strong>，直到它被替换(过时)。<br/>我的疑惑来了:</p><blockquote class="jp"><p id="9209" class="jq jr hi bd js jt ju jv jw jx jy jn dx translated">新区域部署了最新的硬件，旧区域部署了旧硬件。</p><p id="616b" class="jq jr hi bd js jt ju jv jw jx jy jn dx translated">那么，所有地区的表现都一样吗？</p></blockquote><p id="f87d" class="pw-post-body-paragraph iq ir hi is b it jz iv iw ix ka iz ja jb kb jd je jf kc jh ji jj kd jl jm jn hb bi translated">尤其是当您不选择底层硬件时，例如无服务器产品。<strong class="is hj">用BigQuery测试一下吧！</strong></p><h1 id="5ab4" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">存储和处理分离</h1><p id="13ae" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">BigQuery设计<strong class="is hj">将存储与处理</strong>分开。处理单元叫做<strong class="is hj">“插槽”，是CPU和内存的一个切片。</strong></p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lh"><img src="../Images/1b10fa6a2a3128563d79c2634e326f85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kgzkHCenFaxlPht9.jpg"/></div></div></figure><p id="4d75" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里的目标是<strong class="is hj">测试插槽性能，而不是存储</strong>吞吐量。</p><h1 id="c817" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">特性试验</h1><p id="b44a" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">为此，我选择<strong class="is hj">查询不到10 Mb的</strong>(100万个只有数字的行)，并选择<strong class="is hj">对每行的每个数字执行计算密集型数学运算</strong> (cos、sin、tan、log、square、exp……)。</p><p id="ce2d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个测试将在不同的数据集中部署相同的数据，每个区域一个，并运行相同的查询。最后，获取每个区域的查询持续时间并记录下来。</p><p id="ddf4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lm">你可以在我的</em> <a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-perf-test/tree/main/bigquery" rel="noopener ugc nofollow" target="_blank"> <em class="lm"> GitHub资源库</em> </a>中用代码自己找到并复制板凳</p><h1 id="c82b" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">绩效结果</h1><p id="ddaa" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">我在相同的数据上运行了3次查询，得到了如下所示的结果。<br/>我在最新一列中添加了<strong class="is hj">平均加工时间，我将结果从最快到最慢的区域排序。<em class="lm">(持续时间单位为毫秒)</em></strong></p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/1817b712e0ad5be43ca66cb503d7e498.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iCFk54WFDFeuq-RhmczmmQ.png"/></div></div></figure><p id="2478" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如你所见，<strong class="is hj">有些地区比最快的地区慢80%！</strong></p><h1 id="1176" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">性能和地区年龄</h1><p id="151b" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">我的假设是<strong class="is hj">较老的地区有较老的硬件</strong>(比最近的几代CPU落后几代)。让我们<strong class="is hj">添加区域开放信息。</strong> <br/> <em class="lm">此表提到了开馆日期，已知时间，以及从现在开始的年龄(2021年第三季度)。按年龄排序</em></p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/4189ba4a9d32a496290f76571facad64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fBqZxoDOIoervICEmWWrAA.png"/></div></div></figure><p id="62b8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lm">我注意到了</em> <code class="du lp lq lr ls b"><em class="lm">Legacy</em></code> <em class="lm">我没有找到发布日期的地区。</em></p><p id="91c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">显然，数据中心的年龄和查询性能之间存在<strong class="is hj">相关性。</strong></p><blockquote class="jp"><p id="e8c0" class="jq jr hi bd js jt ju jv jw jx jy jn dx translated">越老越慢！</p></blockquote><p id="0fca" class="pw-post-body-paragraph iq ir hi is b it jz iv iw ix ka iz ja jb kb jd je jf kc jh ji jj kd jl jm jn hb bi translated">这个“规则”有两个例外<strong class="is hj"/>:</p><ul class=""><li id="be9c" class="lt lu hi is b it iu ix iy jb lv jf lw jj lx jn ly lz ma mb bi translated">欧洲西部2(伦敦)，于2017年在Q2开幕，并获得性能测试的最高成绩。<br/> <em class="lm">这样好的表现可以解释是因为</em><a class="ae jo" href="https://cloud.google.com/bigquery/docs/release-notes#October_10_2018" rel="noopener ugc nofollow" target="_blank"><em class="lm"/><strong class="is hj"><em class="lm">2018年Q4</em></strong></a>在这个地区增加了BigQuery</li><li id="4a64" class="lt lu hi is b it mc ix md jb me jf mf jj mg jn ly lz ma mb bi translated">欧洲-西欧4(荷兰)，不算太老(3年半)，成绩排名前3。<br/> <em class="lm">我还没找到任何可能的原因。</em> <strong class="is hj"> <em class="lm">请建议！</em> </strong></li></ul><h1 id="2d4f" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">明智选择的额外洞察力</h1><p id="b77b" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">当然，性能是最重要的，但是每个地区的<a class="ae jo" href="https://cloud.google.com/bigquery/pricing#on_demand_pricing" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">成本</strong>(按需分析成本)</a>和<a class="ae jo" href="https://cloud.google.com/bigquery/docs/locations#regional-locations" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> CO2影响</strong> </a> <strong class="is hj"> </strong>会对你的决策产生影响。</p><p id="c318" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lm">我根据每Gb处理成本(按需分析)和每个地理区域对信息进行了分类</em></p><figure class="li lj lk ll fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mh"><img src="../Images/272e386bc305ba6a9d6bfef2b809382f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Awkl7XYG1veBB0E1PxL_w.png"/></div></div></figure><p id="c04c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不存在<strong class="is hj">高成本导致性能缓慢的情况</strong>。性能或多或少与成本相关。</p><p id="41a0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，使用这个新表，可以做出一些有价值选择:</p><ul class=""><li id="77c8" class="lt lu hi is b it iu ix iy jb lv jf lw jj lx jn ly lz ma mb bi translated">在美国，us-west4(拉斯维加斯)显然是最快和最便宜的。如果你对最绿色的感兴趣，北美-东北1(蒙特利尔)最适合你，即使它要贵5%。</li><li id="84b6" class="lt lu hi is b it mc ix md jb me jf mf jj mg jn ly lz ma mb bi translated">在亚洲，没有绿色区域。<br/>对于北方来说，东北地区都提供了不错的性价比。对于南方来说，东南亚2号(雅加达)很有意思。</li><li id="88d1" class="lt lu hi is b it mc ix md jb me jf mf jj mg jn ly lz ma mb bi translated">在欧洲，europe-north1(芬兰)显然是成本、性能和二氧化碳影响之间的最佳平衡。</li></ul><h1 id="a62d" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">做出正确的选择</h1><p id="8912" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">做出正确的选择总是困难的。必须考虑许多不同的参数:</p><ul class=""><li id="6bab" class="lt lu hi is b it iu ix iy jb lv jf lw jj lx jn ly lz ma mb bi translated">可用性(和多区域要求)</li><li id="a004" class="lt lu hi is b it mc ix md jb me jf mf jj mg jn ly lz ma mb bi translated">数据驻留</li><li id="520c" class="lt lu hi is b it mc ix md jb me jf mf jj mg jn ly lz ma mb bi translated">服务延迟(最接近用户)和跨区域流量，以便在最快的区域内移动数据进行分析</li><li id="6f48" class="lt lu hi is b it mc ix md jb me jf mf jj mg jn ly lz ma mb bi translated">成本(地区间流量，以及为获得更好的性能而产生的地区超额成本)</li><li id="7cc7" class="lt lu hi is b it mc ix md jb me jf mf jj mg jn ly lz ma mb bi translated">低二氧化碳排放(绿色IT)</li><li id="f947" class="lt lu hi is b it mc ix md jb me jf mf jj mg jn ly lz ma mb bi translated">性能和时间敏感的查询。</li></ul><p id="246d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，<strong class="is hj">时间就是金钱</strong>，在某些情况下，如果您的查询在一个“慢”区域运行了1个小时，那么<strong class="is hj">通过简单地切换区域来节省20分钟是很有趣的！</strong></p><p id="ef2a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正确的选择<strong class="is hj">取决于你和你的背景</strong>，但是这是你可以利用的额外的洞察力。</p></div><div class="ab cl mi mj gp mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hb hc hd he hf"><h2 id="fe34" class="mp kf hi bd kg mq mr ms kk mt mu mv ko jb mw mx ks jf my mz kw jj na nb la nc bi translated"><em class="nd">分析的极限</em></h2><p id="0c13" class="pw-post-body-paragraph iq ir hi is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated"><em class="lm">我不敢说</em> <strong class="is hj"> <em class="lm">这个分析绝对正确</em> </strong> <em class="lm">。我是用我的</em> <strong class="is hj"> <em class="lm">个人账户</em> </strong> <em class="lm">执行的，也许</em> <strong class="is hj"> <em class="lm">公司账户有不同的资源配置。</em> </strong></p><p id="3735" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lm">另外，我只进行了一次</em> <strong class="is hj"> <em class="lm">【按需分析】测试</em> </strong> <em class="lm">。我还没有</em> <strong class="is hj"> <em class="lm">预留槽，还是用BigQuery ML </em> </strong> <em class="lm">来执行类似的分析。</em></p><p id="f118" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lm">无论如何，如果你的查询是性能敏感的，这种方法是很有趣的</em></p></div></div>    
</body>
</html>