<html>
<head>
<title>DataProc — Spark Cluster on GCP in minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">data proc——GCP星火星团在几分钟内</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/dataproc-spark-cluster-on-gcp-in-minutes-3843b8d8c5f8?source=collection_archive---------0-----------------------#2016-01-05">https://medium.com/google-cloud/dataproc-spark-cluster-on-gcp-in-minutes-3843b8d8c5f8?source=collection_archive---------0-----------------------#2016-01-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="52a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我已经决定在<a class="ae jd" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">谷歌云平台</strong> </a>上以各种方式尝试运行<strong class="ih hj"> Apache Spark </strong>，</p><p id="c928" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我会告诉你一点我的经验和执行所有需要的行动的方法。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/d848a73b700fce1afe670da29d2fe87f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Sq1p4OIuTE4qFPm8."/></div></div></figure><p id="8c55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于第一种方式，<strong class="ih hj">我先从最简单的方式</strong>开始，使用Google的<a class="ae jd" href="https://cloud.google.com/dataproc/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> DataProc服务</strong> </a> <strong class="ih hj"> </strong>(目前在测试版)。如果你们中的一些人正在使用亚马逊的AWS，它相当于他们的EMR(弹性MapReduce)服务，你可以在谷歌云控制台中使用GUI工具、REST API或通过命令行工具启动Spark集群(接下来我将展示所有的可能性)。</p><p id="65d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，你需要创建一个谷歌云帐户，你可以在<a class="ae jd" href="https://cloud.google.com/free-trial/" rel="noopener ugc nofollow" target="_blank">下一个链接</a>中这样做，你可以获得300美元信用的免费试用，这对你所有的测试来说绰绰有余。一旦您创建了帐户，我们就可以开始使用web控制台来启动群集。</p><p id="ca8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">您可能需要提前准备两件事情</strong>(如果没有，您将获得默认设置，这也很好):</p><ol class=""><li id="8ab3" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc jv jw jx jy bi translated">创建一个<strong class="ih hj">“云存储暂存桶”</strong>来在客户机和集群之间暂存文件，如Hadoop jars。如果未指定，则使用默认存储桶。</li><li id="ad89" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc jv jw jx jy bi translated"><strong class="ih hj">为Spark集群创建网络</strong>集群使用的计算引擎网络。如果未指定，将为您选择默认网络。<br/>我添加了一个我创建的网络截图，名为<strong class="ih hj">“spark-cluster-network”</strong>，并且只打开了相关的防火墙规则(既用于连接到集群，也用于查看Spark集群的UI特性)。</li></ol><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/eeba851aa0f155d2c7441e58684842b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YMnhYyEhsgIkJqpm."/></div></div></figure><p id="fe62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">下一步是用DataProc启动集群，有3种方法可以做到:</strong></p><h1 id="4ed3" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated"><strong class="ak">云控制台上DataProc的GUI工具:<br/> </strong>要进入DataProc菜单，我们需要遵循以下步骤:</h1><p id="707b" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">在主控制台菜单上找到<strong class="ih hj"> DataProc </strong>服务:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lh"><img src="../Images/3dd5a68301b3c0eaac51cbfe51cb65c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/0*eCb3gMq3hbwj_Wfx."/></div></div></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/019ddf7b6cc1d6c1838fc52988563cac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wG4RVh6KkX9xH5Aw."/></div></div></figure><p id="caed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以使用我们之前讨论过的所有参数创建一个新的集群，在我们的示例中，它被称为<strong class="ih hj">“cluster-1”</strong>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/458e951269864bac8a0c386b66f5c667.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dp568kA0ZQBImTqF."/></div></div></figure><p id="c042" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">发出启动命令后，群集在大约45秒后启动并运行，我能够通过SSH连接到它:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es li"><img src="../Images/983a2933ffc5eb9c899c105991fae9c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nQjSOqzNcQdNvqpG."/></div></div></figure><p id="cfde" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">而且你可以看到Apache Spark已经预装在<strong class="ih hj"> "/var/lib/spark" </strong>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lj"><img src="../Images/9db76d6d48aa829b00d2b350c49d69c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ah7Kg2yxy3q7M-Zr."/></div></div></figure><p id="6080" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了检查一切是否正常，我运行了spark-shell:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/165b80d0c7aea7b25fa747343c123826.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jvPmdGTRvOob5Kh3."/></div></div></figure><p id="7800" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是请注意一件非常重要的事情，您需要用config参数启动每个应用程序(包括spark-shell ),以覆盖YARN的动态分配特性。</p><p id="6288" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我在没有这个配置的情况下启动作业时，我遇到了这个问题，在spark-shell运行期间，我会突然失去执行器:(你可以在spark master UI中看到执行器被删除了)</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/fe2d6a8430f49c838e3192f788aa94df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*C4DUWo53A4DQmC3h."/></div></div></figure><p id="b7ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">感谢</strong><a class="ae jd" href="https://www.linkedin.com/in/vadimska" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">Vadim solo vey</strong></a><strong class="ih hj">，</strong>动态分配导致spark放弃闲置的执行人回纱，不幸的是此时Spark打印出那条垃圾但无害的“失去执行人”消息。这是纱线上的火花的经典问题，spark最初瘫痪了它运行的集群，因为它会抓取它认为需要的最大数量的容器，然后永远不会放弃它们。</p><p id="5332" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用动态分配，当您开始一个长作业时，spark会快速分配新的容器(类似于指数级上升，可以在几分钟内快速填满一个完整的纱线簇)，当空闲时，会以大约60秒的间隔释放具有相同下降速度的执行器(如果空闲60秒，释放一些执行器)。</p><p id="454e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果要禁用动态分配，可以运行:<strong class="ih hj">" spark-shell-conf spark . dynamic allocation . enabled = false "</strong></p><p id="a9b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，</p><p id="9e42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> "gcloud beta dataproc作业提交spark-properties spark . dynamic allocation . enabled = false-cluster&lt;your-cluster&gt;application . jar "</strong></p><p id="1920" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，如果指定固定数量的执行者，它也应该自动禁用动态分配:<br/><strong class="ih hj">" spark-shell—conf spark . executor . instances = 123 "</strong></p><p id="c87b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，</p><p id="f1c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> "gcloud beta dataproc作业提交spark—properties spark . executor . instances = 123—cluster&lt;your-cluster&gt;application . jar "</strong></p><p id="7355" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能希望运行其他一些有用的配置有:</p><p id="64f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">"—conf spark . logconf = true—conf spark . logconf = true—conf spark . ui . kill enabled = true "</strong></p><h1 id="a8eb" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated"><strong class="ak">命令行工具</strong></h1><p id="5c15" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">你需要在你的管理机器上安装cloud SDK。<br/>例如:(您也可以从GUI工具生成命令)</p><p id="398c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> gcloud beta dataproc集群创建cluster-1-zone us-central 1-a-master-machine-type n1-standard-4-master-boot-disk-size 500-num-worker 2-worker-machine-type n1-standard-4-worker-boot-disk-size 500-num-preemptive-workers 2-image-version 0.2-project GCP-tools-01</strong></p><h1 id="9703" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">REST API</h1><p id="3762" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">您也可以从启动集群。</p><blockquote class="lk ll lm"><p id="dd6c" class="if ig ln ih b ii ij ik il im in io ip lo ir is it lp iv iw ix lq iz ja jb jc hb bi translated">POST/v1beta 1/projects/GCP-tools-01/clusters/<br/>{<br/>" cluster name ":" cluster-1 "，<br/> "projectId": "gcp-tools-01 "，<br/>" configuration ":{<br/>" configuration bucket ":"，<br/>" gceClusterConfiguration ":{<br/>" network uri ":" https://www . Google APIs . com/compute/v1/projects/GCP-tools-01/global/networks/default "，</p></blockquote><p id="e321" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以创建一个初始化脚本，即在集群初始化期间要执行的脚本列表。<strong class="ih hj">每个都必须是带有gs://前缀的GCS文件。</strong></p><p id="f79a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">要进行的具体网络配置调整:</strong></p><p id="dafc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们已经创建了自己的网络，现在对外部世界开放，我们需要打开一些重要的端口来暴露一些Spark服务的Web UI，<strong class="ih hj">允许TCP端口:</strong> 4040、18080、8088、19888将允许您使用下一个服务。<br/>(注意:如果您选择运行下列框架之外的其他框架，您可能需要为外部世界打开其他端口:</p><p id="587b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">星火主控UI: </strong> <a class="ae jd" href="http://&lt;Master" rel="noopener ugc nofollow" target="_blank"> http:// &lt;主控</a> IP地址&gt; :4040</p><p id="329e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">星火历史服务器:</strong> <a class="ae jd" href="http://&lt;Master" rel="noopener ugc nofollow" target="_blank"> http:// &lt;主</a> IP地址&gt; :18080</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/7b44fd48d8c1bc0e510df5eac543478b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zqG87paL9zTUTvUF."/></div></div></figure><p id="76f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">纱线应用主控:</strong> <a class="ae jd" href="http://&lt;Master" rel="noopener ugc nofollow" target="_blank"> http:// &lt;主控</a> IP地址&gt; :8088/cluster</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/034dbe3857b009011f5034231b2b6a9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*558HxmWhWYqHq8sa."/></div></div></figure><p id="73b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Hadoop作业历史服务器:</strong> http:// &lt;主IP地址&gt; :19888/jobhistory</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/f8f17b1564e92850d4a7f3eb93eacf0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PiqPKaMopfZyEj4n."/></div></div></figure><h1 id="28b0" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">结论:</h1><p id="268f" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">在几分钟内，你就有了它，甚至在不知道任何关于<strong class="ih hj"> DataProc / Spark cluster启动</strong>的情况下，你将在Google云平台上拥有一个运行环境。</p><p id="d484" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个过程中，你还可以选择一定数量的<a class="ae jd" href="https://cloud.google.com/preemptible-vms/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">可抢占虚拟机</strong> </a>作为更多的执行者，这将比<strong class="ih hj">计算引擎虚拟机</strong>更便宜，它们将作为你的集群的一部分启动。</p><p id="7354" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">综上所述，这是一项付费服务，您需要考虑到这一点，<strong class="ih hj">我认为大多数情况下，您希望运行DataProc是为了一段预先定义的时间作业，您需要启动一个集群，执行计算负载，然后销毁集群，而不是为了一个永远运行的Spark集群，您可能希望在其上进行调整并安装额外的工具。</strong></p><p id="9fe7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">那么，在GCP上运行Apache Spark还有其他选择吗？</strong> <br/>接下来我们将展示Google的<a class="ae jd" href="https://cloud.google.com/hadoop/bdutil" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">BD util</strong></a><strong class="ih hj"/>，这是一个命令行工具，它提供API来管理GCP上的Hadoop和Spark工具，以及另一种方式<strong class="ih hj">在GCP </strong>之上启动Mesos集群 <strong class="ih hj">，然后在其上运行Apache Spark，</strong></p><p id="c35c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">但那会在以后的博客文章中。</strong></p><p id="7337" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你有任何进一步的问题，请留下评论，希望这能帮助你进入GCP的火花世界。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="4ef4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ln">原载于2016年1月5日progexc.blogspot.co.il</em><a class="ae jd" href="http://progexc.blogspot.co.il/2015/12/dataproc-spark-cluster-on-gcp-in-minutes.html" rel="noopener ugc nofollow" target="_blank"><em class="ln"/></a><em class="ln">。</em></p></div></div>    
</body>
</html>