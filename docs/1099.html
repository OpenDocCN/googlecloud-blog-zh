<html>
<head>
<title>Develop your Cloud Tasks pipeline locally with ngrok!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用ngrok在本地开发您的云任务管道！</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/develop-your-cloud-tasks-pipeline-locally-with-ngrok-5bee3693600f?source=collection_archive---------0-----------------------#2019-07-30">https://medium.com/google-cloud/develop-your-cloud-tasks-pipeline-locally-with-ngrok-5bee3693600f?source=collection_archive---------0-----------------------#2019-07-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c232" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">任务队列允许您通过将请求添加到队列中以便将来执行，来减轻服务的后台工作负担。使用像云任务这样的托管服务有很多优点，但是在开发工作者服务时，很难模拟来自队列的最终任务请求。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/220eb809a25d7a19862c4efc157a7466.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pn0-adkRaQekpQZVf0G3FA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">示例云任务管道</figcaption></figure><p id="78e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ngrok是一个向公共互联网公开本地web服务器的工具，它有一个方便的UI来检查发送到服务器的请求和服务器的响应。在本教程中，我们将学习如何使用ngrok在本地测试将任务添加到云任务队列的管道，以及如何使用worker服务处理任务请求。</p><p id="dee7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ju"> **这种方法存在将您的网络暴露在外的内在风险。在本教程中，我们将使用Google Cloud Shell的沙盒环境来最小化这些风险。这个过程可以在您的本地机器上复制，通过不暴露您的公共URL和最小化您的隧道暴露的时间来降低风险。* *</em>T5】</strong></p><p id="0bb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ngrok并不是SSH隧道的唯一选项，还有其他类似的工具如<a class="ae jt" href="https://localtunnel.github.io/www/" rel="noopener ugc nofollow" target="_blank"> localtunnel.me </a>、<a class="ae jt" href="https://burrow.io/" rel="noopener ugc nofollow" target="_blank"> burrow.io </a>、<a class="ae jt" href="https://serveo.net/" rel="noopener ugc nofollow" target="_blank"> serveo </a>，或者您可以设置自托管远程端口转发。</p><ol class=""><li id="3c2f" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ka kb kc kd bi translated"><a class="ae jt" href="#b50e" rel="noopener ugc nofollow">开始之前</a></li><li id="4291" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated"><a class="ae jt" href="#a003" rel="noopener ugc nofollow">创建队列</a></li><li id="c09d" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated"><a class="ae jt" href="#8497" rel="noopener ugc nofollow">启动你的服务器</a></li><li id="45a7" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated"><a class="ae jt" href="#5c84" rel="noopener ugc nofollow">启动ngrok </a></li><li id="00d5" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated"><a class="ae jt" href="#af73" rel="noopener ugc nofollow">创建任务</a></li><li id="f16b" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated"><a class="ae jt" href="#2009" rel="noopener ugc nofollow">清理</a></li><li id="811c" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated"><a class="ae jt" href="#83ad" rel="noopener ugc nofollow">接下来的步骤</a></li></ol><h1 id="b50e" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">开始之前</h1><ol class=""><li id="ca9c" class="jv jw hi ih b ii lh im li iq lj iu lk iy ll jc ka kb kc kd bi translated"><a class="ae jt" href="https://console.cloud.google.com/projectselector/appengine/create" rel="noopener ugc nofollow" target="_blank">创建或选择谷歌云平台项目</a>。</li><li id="cd17" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">将一个<a class="ae jt" href="https://console.cloud.google.com/appengine" rel="noopener ugc nofollow" target="_blank"> Google App Engine应用</a>添加到您的项目中。</li><li id="9b5a" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">启用<a class="ae jt" href="https://console.cloud.google.com/apis/library/cloudtasks.googleapis.com/?q=cloud%20tasks" rel="noopener ugc nofollow" target="_blank">云任务API </a>和<a class="ae jt" href="https://console.cloud.google.com/apis/library/datastore.googleapis.com?q=datastore" rel="noopener ugc nofollow" target="_blank">数据存储API </a>。</li><li id="9887" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">打开<a class="ae jt" href="https://ssh.cloud.google.com/cloudshell/editor" rel="noopener ugc nofollow" target="_blank">云壳编辑器</a>。云壳为访问托管的项目和资源提供内置授权。如果您使用本地机器，通过<a class="ae jt" href="https://cloud.google.com/docs/authentication/getting-started#creating_a_service_account" rel="noopener ugc nofollow" target="_blank">创建服务帐户</a>和<a class="ae jt" href="https://cloud.google.com/docs/authentication/getting-started#setting_the_environment_variable" rel="noopener ugc nofollow" target="_blank">将密钥设置为环境变量</a>来设置API的认证。</li><li id="79cb" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">在云壳终端中:</li></ol><ul class=""><li id="6dfc" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc lm kb kc kd bi translated"><a class="ae jt" href="https://ngrok.com/download" rel="noopener ugc nofollow" target="_blank">下载</a>并解压ngrok:</li></ul><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="f24c" class="ls kk hi lo b fi lt lu l lv lw">wget <a class="ae jt" href="https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip" rel="noopener ugc nofollow" target="_blank">https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip</a></span><span id="d347" class="ls kk hi lo b fi lx lu l lv lw">unzip ngrok-stable-linux-amd64.zip</span></pre><ul class=""><li id="cab2" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc lm kb kc kd bi translated">安装Python依赖项:</li></ul><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="1371" class="ls kk hi lo b fi lt lu l lv lw">pip install --user flask google-cloud-datastore google-cloud-tasks</span></pre><h1 id="a003" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">创建队列</h1><p id="1770" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">首先，让我们创建一个队列来保存和发送您的任务请求。云壳已经预装了<a class="ae jt" href="https://cloud.google.com/sdk/docs/initializing" rel="noopener ugc nofollow" target="_blank">云SDK </a>，让你可以访问<code class="du mb mc md lo b">gcloud</code>命令行工具。</p><ol class=""><li id="068b" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ka kb kc kd bi translated">使用以下命令创建一个名为“my-queue”的队列:</li></ol><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="519b" class="ls kk hi lo b fi lt lu l lv lw">gcloud tasks queues create my-queue</span></pre><p id="9de7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.记下关于队列的一些信息:项目、位置和名称。使用<code class="du mb mc md lo b">gcloud</code> CLI确定这些值:</p><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="8b8e" class="ls kk hi lo b fi lt lu l lv lw">gcloud tasks queues describe my-queue</span><span id="806d" class="ls kk hi lo b fi lx lu l lv lw"># Output<br/>name: projects/<strong class="lo hj">my-project-id</strong>/locations/<strong class="lo hj">us-central1</strong>/queues/<strong class="lo hj">my-queue<br/>...</strong></span></pre><h1 id="8497" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">启动您的服务器</h1><p id="1994" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">其次，我们将运行一个端点为<code class="du mb mc md lo b">/update_counter</code>的Python Flask应用程序，它将接收云任务请求并更新存储在云数据存储中的值。</p><ol class=""><li id="978d" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ka kb kc kd bi translated">创建一个名为<code class="du mb mc md lo b">main.py</code>的文件，并复制以下代码:</li></ol><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="544f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.在云Shell终端中，使用以下命令启动应用服务器:</p><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="227b" class="ls kk hi lo b fi lt lu l lv lw">python main.py</span></pre><p id="78ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Flask应用程序被设置为在端口8080上运行。我们还将设置ngrok来监听这个端口。</p><h1 id="5c84" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">启动ngrok</h1><p id="b076" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">在创建第一个任务之前，我们需要启动ngrok。</p><ol class=""><li id="b8ed" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ka kb kc kd bi translated">在您的云Shell终端(➕)中打开另一个选项卡，并使用以下命令启动ngrok:</li></ol><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="ccc2" class="ls kk hi lo b fi lt lu l lv lw">./ngrok http 8080</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mg"><img src="../Images/d43aba36d947bfd6ed2bb432aba62975.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1AAocXiV4MvXu03H"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">ngrok控制台用户界面</figcaption></figure><p id="7c9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.记下转发URL。在本例中，URL是https://2da88316.ngrok.io。</p><p id="b243" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.ngrok在端口4040上提供了一个实时的web UI，您可以在这里检查通过您的隧道运行的所有HTTP流量。要打开检查UI，请单击右上角的Web预览按钮，然后选择“更改端口”。输入4040，点击“更改并预览”。这将从云外壳在您的浏览器中打开<a class="ae jt" href="http://localhost:4040/" rel="noopener ugc nofollow" target="_blank"> http://localhost:4040 </a>。</p><div class="je jf jg jh fd ab cb"><figure class="mh ji mi mj mk ml mm paragraph-image"><img src="../Images/8668882ec7f1dd80014b3d61cc72e4f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:550/format:webp/1*DEvC_IFPXluU_aSZSHPDTg.png"/></figure><figure class="mh ji mn mj mk ml mm paragraph-image"><img src="../Images/93d6d32b994410da99c2f9a195e5ea7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*qdEuwCVHsQdtkN8VbvYo9Q.png"/></figure></div><h1 id="af73" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">创建任务</h1><p id="206c" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">现在，让我们创建一个任务并将其添加到您的队列中。</p><ol class=""><li id="9696" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ka kb kc kd bi translated">创建一个名为<code class="du mb mc md lo b">create_http_task.py</code>的文件，并复制以下代码:</li></ol><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="ffb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.用上述值更新变量project、queue、location和url:</p><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="92f6" class="ls kk hi lo b fi lt lu l lv lw">project = ‘my-project-id’<br/>queue = ‘my-queue’<br/>location = ‘us-central1’<br/>url = ‘https://<strong class="lo hj">2da88316</strong>.ngrok.io/update_counter'</span></pre><p id="939f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保您的URL保留了“https”和端点“/update_counter”，以便请求可以正确地路由到处理程序。</p><p id="184a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.现在发送一个以ngrok公共URL为目标的创建任务请求:</p><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="77f7" class="ls kk hi lo b fi lt lu l lv lw">python create_http_task.py</span></pre><p id="6ed7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.看<a class="ae jt" href="http://localhost:4040" rel="noopener ugc nofollow" target="_blank">检验UI </a>。如果设置正确，您将看到200 OK响应</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mo"><img src="../Images/164608c25e01c0630b049ceafab840d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*72XAKCjQd9r7AuIy24kcXQ.png"/></div></figure><p id="71cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以查看请求和响应的详细信息，包括时间、持续时间、头、查询参数和请求负载以及网络上的原始字节。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mp"><img src="../Images/228ebeb2174c3205df6de8ad916f53a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*AQXXyYj8lSx_nxtq"/></div></figure><p id="6847" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在检查UI中重放请求，以减少API调用。</p><h1 id="afe4" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">自定义请求正文和标题</h1><p id="7f58" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">云任务API强制将任务请求主体编码为字节数组。请求体被添加到<code class="du mb mc md lo b">task['http_request']['body']</code>下的任务字典中。在<code class="du mb mc md lo b">create_http_task.py</code>中，字符串变量<code class="du mb mc md lo b">payload</code>已经用<code class="du mb mc md lo b">.encodes()</code>方法编码成一个字节数组。</p><p id="3799" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过将<a class="ae jt" href="https://googleapis.github.io/google-cloud-python/latest/tasks/gapic/v2beta3/types.html#google.cloud.tasks_v2beta3.types.HttpRequest.headers" rel="noopener ugc nofollow" target="_blank">报头</a>字段添加到<code class="du mb mc md lo b">http_request</code>字典，尝试改变请求的内容类型，从默认的“应用程序/八位字节流”。Flask route可以根据这个内容类型解析请求体。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="3b6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用您选择的语言了解更多关于任务对象的信息:<a class="ae jt" href="https://googleapis.github.io/google-cloud-python/latest/tasks/gapic/v2/types.html#google.cloud.tasks_v2.types.Task" rel="noopener ugc nofollow" target="_blank"> Python </a>、<a class="ae jt" href="https://googleapis.dev/nodejs/tasks/latest/google.cloud.tasks.v2.html#.Task" rel="noopener ugc nofollow" target="_blank"> Node.js </a>、<a class="ae jt" href="https://googleapis.github.io/google-cloud-dotnet/docs/Google.Cloud.Tasks.V2/api/Google.Cloud.Tasks.V2.Task.html" rel="noopener ugc nofollow" target="_blank">。NET </a>，<a class="ae jt" href="https://godoc.org/google.golang.org/genproto/googleapis/cloud/tasks/v2#Task" rel="noopener ugc nofollow" target="_blank"> Go </a>，<a class="ae jt" href="https://googleapis.dev/java/google-api-grpc/latest/com/google/cloud/tasks/v2/Task.html" rel="noopener ugc nofollow" target="_blank"> Java </a>，<a class="ae jt" href="https://googleapis.github.io/google-cloud-php/#/docs/google-cloud/v0.105.0/tasks/v2/task" rel="noopener ugc nofollow" target="_blank"> PHP </a>，<a class="ae jt" href="http://googleapis.github.io/google-cloud-ruby/docs/google-cloud-tasks/latest/Google/Cloud/Tasks/V2/Task.html" rel="noopener ugc nofollow" target="_blank"> Ruby </a>。</p><h1 id="cb5d" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">使用谷歌应用引擎目标</h1><p id="1eae" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">为了使用ngrok的公共URL，您必须使用HTTP目标。尽管您可以轻松地将<code class="du mb mc md lo b">http_request</code>更改为<code class="du mb mc md lo b">appengine_http_request</code>并将<code class="du mb mc md lo b">url</code>更改为<code class="du mb mc md lo b">relative_uri</code>来定位应用引擎端点。</p><p id="9af9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用App Engine目标将提供额外的功能，如<a class="ae jt" href="https://googleapis.github.io/google-cloud-python/latest/tasks/gapic/v2beta3/types.html#google.cloud.tasks_v2beta3.types.AppEngineHttpRequest.app_engine_routing" rel="noopener ugc nofollow" target="_blank"> App Engine Routing </a>字段，以将您的请求定制到您的应用的特定服务、版本和实例以及<a class="ae jt" href="https://cloud.google.com/tasks/docs/creating-appengine-handlers#reading_request_headers" rel="noopener ugc nofollow" target="_blank">特殊头</a>。</p><h1 id="2009" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">打扫</h1><ul class=""><li id="3354" class="jv jw hi ih b ii lh im li iq lj iu lk iy ll jc lm kb kc kd bi translated">在终端中使用<code class="du mb mc md lo b">CTRL+C</code>关闭ngrok实例。</li><li id="744f" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc lm kb kc kd bi translated">在终端中使用<code class="du mb mc md lo b">CTRL+C</code>关闭本地Python服务器。</li><li id="2b80" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc lm kb kc kd bi translated">为了避免因使用资源而向您的Google云平台帐户收取费用，请转到控制台并删除您的项目。</li></ul><h1 id="83ad" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">后续步骤</h1><p id="0108" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">在<a class="ae jt" href="https://cloud.google.com/tasks/docs/dual-overview" rel="noopener ugc nofollow" target="_blank">云任务概述</a>中了解更多关于云任务服务的信息。</p></div></div>    
</body>
</html>