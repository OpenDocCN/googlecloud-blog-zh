<html>
<head>
<title>My Mac’s battery🔋 on Google Cloud Monitoring — send SMS if low 🪫</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我的Mac的电池🔋在谷歌云监控上——如果🪫低，发送短信</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/my-macs-battery-on-google-cloud-monitoring-with-sms-if-its-low-a1ccd70485fe?source=collection_archive---------1-----------------------#2022-11-09">https://medium.com/google-cloud/my-macs-battery-on-google-cloud-monitoring-with-sms-if-its-low-a1ccd70485fe?source=collection_archive---------1-----------------------#2022-11-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="9835" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><em class="hi">这篇文章展示了如何轻松地将一个通用键/值注入到Google云监控中，并在其上设置警报。我用它来提醒磁盘空间，现在也低电池！</em></p></blockquote><p id="d8bb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">今天早上我在伦敦，我把充电器忘在家里了。不过🪫没什么电池，时间充裕，我心想:<em class="ik">嘿！我需要一种方法来预测我的电池何时会没电！我需要用一种完全矫枉过正的方式去做！</em></p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/786de46cd05423b6647edd8d3816378c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Yk6qFPAm6Y3Hwo5t"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">赶早班火车从圣潘克拉斯到斯特拉特福德国际机场，然后到伦敦城市机场。</figcaption></figure><p id="cc5a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">我的电池电量为42%<strong class="il hj"/>，这似乎是一个微妙的迹象，表明我的想法值得写博客。四处搜索，我找到了<a class="ae ka" href="https://www.iphonetricks.org/check-battery-health-on-mac-using-terminal/" rel="noopener ugc nofollow" target="_blank">一篇文章</a>，它给了我如何编写Mac电池脚本的提示(注意这只适用于<strong class="il hj"> Macbook </strong>)。</p><p id="02ef" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">丑码<a class="ae ka" href="https://github.com/palladius/sakura/blob/master/bin/macbook-battery#L107-L150" rel="noopener ugc nofollow" target="_blank">这里</a>(哎！我在一个没有充电器的机场，你也想要单元测试吗？！？)</p><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="93f8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">我知道，我调用相同的命令10次，我可以缓存它。这是为了下一次迭代！</p><p id="5ce6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">最棒的是，它不仅延长了我的电池寿命，还提高了我的电池耐用性——所以当我需要更换电池时。呜哇！</p><p id="6e32" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">好了，让我们试一试，让我把线拔掉，这样你就不会100%无聊了。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kd"><img src="../Images/040ac3eddcc7fcd2182398e77ac95d4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VVFX7-q7pyNbZaFayRGLmg.png"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">电池电量为98%。不幸的是，我14%的电池电量似乎没有了😢</figcaption></figure><p id="5026" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">电池是98%，耶！不幸的是，我的电池好像只剩14%了。幸好我不支付它的修理费:)</p><h2 id="2609" class="ke kf hi bd kg kh ki kj kk kl km kn ko jh kp kq kr ji ks kt ku jj kv kw kx ky bi translated">步骤2:将此指标推送到☁ ️(GCP)</h2><p id="e702" class="pw-post-body-paragraph ii ij hi il b im kz io ip iq la is it jh lb iw ix ji lc ja jb jj ld je jf jg hb bi translated">现在，我想要一个从CLI发出我的指标的脚本。所以我可以说类似<code class="du le lf lg lh b">push-to-gcp &lt;METRIC_NAME&gt; &lt;METRIC_VALUE&gt;</code>的话。</p><p id="3385" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">一个月前我已经对我的磁盘空间进行了编码，让我把它抽象成一些更可重用的代码(总是Ruby):<a class="ae ka" href="https://github.com/palladius/sakura/blob/master/bin/gcp-write-metric" rel="noopener ugc nofollow" target="_blank">palladius/sakura/GCP-write-metric</a>。</p><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="a445" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">好吧！现在让我们试一试。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es li"><img src="../Images/9df7ab346e4c3aa6befac5c61046651d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fFPP3gWU1mMpCUXLAyeBrQ.png"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">创建了时间序列'<strong class="bd kg"> prova </strong>'(意大利语测试)和有意义的数字<strong class="bd kg"> 123 </strong>！哇！</figcaption></figure><p id="7e66" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">注意，您需要通过ENV var指定project_id(即将推出的<code class="du le lf lg lh b">— project</code>选项，或者更好的是从<code class="du le lf lg lh b">gcloud</code>配置中自动推断出project_id)。</p><p id="5843" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">现在，让我们将两个脚本粘在一起，上传两个Macbook信息，并在开发控制台上看到:</p><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="0748" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">这个脚本需要ARGV中的project_id，然后它会为您完成工作，知道<code class="du le lf lg lh b">macbook-battery</code>中有用的字段来自值3和5(是的，JSON编码/解析不容易出错！).姑且称之为:</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es lj"><img src="../Images/cd3b3faeb338cdb57b6b984a7c49ffa2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CTX7IrQJgpI8qoFRDyA6Ug.png"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">与此同时，我回到家，在我的另一台M1 Mac电脑上启动了这个程序。总是，无聊地，附在水流上。注定了99%到100%之间的无限生命。等等——这台Mac虽然已经充电，但电量一直保持到80%。也许细胞优化？我印象深刻。</figcaption></figure><p id="0c9f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">一旦一切正常，您需要“生产化它”，这意味着建立一个Cron作业(实际上，<code class="du le lf lg lh b"><a class="ae ka" href="https://www.launchd.info/" rel="noopener ugc nofollow" target="_blank">launchd</a></code>)。我用。<code class="du le lf lg lh b">bash -lc</code>利用我的<code class="du le lf lg lh b">.bashrc</code>中的PATH和其他好东西，但我希望你是一个更好的脚本编写人员，可以在没有繁琐的导入的情况下工作。还要确保正确地添加路径(我通常要失败几次才能做对)。</p><pre class="jl jm jn jo fd lk lh ll lm aw ln bi"><span id="0b02" class="ke kf hi lh b fi lo lp l lq lr">$ crontab -e </span><span id="4258" class="ke kf hi lh b fi ls lp l lq lr">[…]<br/>PATH=/sbin:/bin:/usr/sbin:/usr/bin:~/git/sakura/bin/</span><span id="a7d5" class="ke kf hi lh b fi ls lp l lq lr">3/5 * * * * bash -lc '/Users/ricc/path-to/sakura/bin/gcp-write-mac-battery-values-on-project your-project-id'<br/>[…]</span></pre><h1 id="2bd2" class="lt kf hi bd kg lu lv lw kk lx ly lz ko ma mb mc kr md me mf ku mg mh mi kx mj bi translated">步骤3:查看指标并创建仪表板</h1><p id="d133" class="pw-post-body-paragraph ii ij hi il b im kz io ip iq la is it jh lb iw ix ji lc ja jb jj ld je jf jg hb bi translated">现在让我们转到这里的指标浏览器，检查一个假的GCE指标:</p><ul class=""><li id="2c5c" class="mk ml hi il b im in iq ir jh mm ji mn jj mo jg mp mq mr ms bi translated">前往<a class="ae ka" href="https://console.cloud.google.com/monitoring/metrics-explorer?project=ric-cccwiki" rel="noopener ugc nofollow" target="_blank">https://console . cloud . Google . com/monitoring/metrics-explorer</a></li><li id="d22b" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated">在“Select a metric”&gt;中，键入“Battery ”,您会看到选项从多个减少到两个:</li></ul><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es my"><img src="../Images/0f7f0b83625e41a9096ef04851263b6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DlxGuBX4SYzrmN8EMIa38Q.png"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">这是我的两个度量标准，也是驼峰式的！</figcaption></figure><ul class=""><li id="1c1e" class="mk ml hi il b im in iq ir jh mm ji mn jj mo jg mp mq mr ms bi translated">选择<strong class="il hj">电池寿命</strong>。这将把您带到一个漂亮的仪表板(如果您刚刚创建它，可能是空的，请耐心等待)。使用时间控件返回时间或缩放，直到获得所需的视图。</li><li id="71d9" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated">由于这个信号来自(可能)多台MAC，所以选择“分组依据”-&gt; <strong class="il hj">主机名</strong>。你会看到这样的东西:</li></ul><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es mz"><img src="../Images/32bf2a02b286e9eb46a122458bb5c979.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yeP5TnvyAr-9uXYhOUvr4w.png"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">查看最后一天的电池。我家里的Mac电脑(3)总是插着电源，工作时的Mac电脑(42)经常去会议室。老实说，我拔了两次插头只是为了得到一个漂亮的截图——骗子！</figcaption></figure><ul class=""><li id="cc6f" class="mk ml hi il b im in iq ir jh mm ji mn jj mo jg mp mq mr ms bi translated">现在点击<strong class="il hj">保存图表</strong>开始享受吧。</li></ul><p id="d9b7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">答对了。你可以在仪表盘上看到并排的电池寿命和电池健康。</p><h2 id="dd65" class="ke kf hi bd kg kh ki kj kk kl km kn ko jh kp kq kr ji ks kt ku jj kv kw kx ky bi translated">第四步。设置电池电量低时的提醒</h2><p id="c8ae" class="pw-post-body-paragraph ii ij hi il b im kz io ip iq la is it jh lb iw ix ji lc ja jb jj ld je jf jg hb bi translated">现在，当电池电量低于14% (42除以π)时，我们会收到警报。</p><ul class=""><li id="5ee3" class="mk ml hi il b im in iq ir jh mm ji mn jj mo jg mp mq mr ms bi translated">打开<a class="ae ka" href="https://console.cloud.google.com/monitoring/alerting?project=ric-cccwiki" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/monitoring/alerting</a></li><li id="32a6" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated">点击“<strong class="il hj"> +创建策略</strong>”(参见<a class="ae ka" href="https://gist.github.com/palladius/5c109015324fc6bffbfce2f58525760f" rel="noopener ugc nofollow" target="_blank">示例JSON输出</a>)</li><li id="e7a5" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated"><strong class="il hj">如上选择公制</strong>(型号<em class="ik">电池寿命</em>)</li><li id="3312" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated"><em class="ik">【可选】您可以在您关心的电脑上添加过滤器:hostname = "my-favorite-mac" </em></li><li id="a69e" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated"><em class="ik">如果需要，调整TransformData参数。</em></li><li id="431f" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated">点击<strong class="il hj">创建策略</strong>-&gt;配置预警触发</li><li id="bedb" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated"><strong class="il hj">条件类型</strong>:阈值</li><li id="5948" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated"><strong class="il hj">位置</strong>:低于阈值</li><li id="cd4a" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated"><strong class="il hj">阈值</strong> : 14(或者你选择的值，比如20)。</li><li id="bae6" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated">点击<strong class="il hj">创建策略</strong></li><li id="bb43" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated">最后，配置您的<strong class="il hj">通知渠道</strong> ( <a class="ae ka" href="https://cloud.google.com/monitoring/support/notification-options" rel="noopener ugc nofollow" target="_blank">文档</a>)，我之前已经在这里设置了我的电子邮件和瑞士电话:</li></ul><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es na"><img src="../Images/1a182ccdaeed0db4415e059dda3554b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:616/format:webp/1*GaEH0EttI6W24HeWAVLisw.png"/></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">没有表情符号的生活会是什么样？</figcaption></figure><ul class=""><li id="207d" class="mk ml hi il b im in iq ir jh mm ji mn jj mo jg mp mq mr ms bi translated">[可选]您可以添加一些<strong class="il hj">策略用户标签</strong>。我喜欢一直使用标签(例如env=prod，scope=personal，..).</li><li id="5600" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated">[可选]您可以像填写剧本一样填写<strong class="il hj">文档</strong>。我总是试着写一些有意义的东西，作为SRE方法论的一部分。这里的操作是将您的Mac连接到电源。</li><li id="458e" class="mk ml hi il b im mt iq mu jh mv ji mw jj mx jg mp mq mr ms bi translated">最后查看数值并点击<strong class="il hj">查看警报</strong>:</li></ul><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es nb"><img src="../Images/14545d99abd228dbddfd25d0555a8387.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fge8BQf73ReYJoUb5mdOMw.png"/></div></div></figure><h2 id="cb05" class="ke kf hi bd kg kh ki kj kk kl km kn ko jh kp kq kr ji ks kt ku jj kv kw kx ky bi translated">结论</h2><p id="780e" class="pw-post-body-paragraph ii ij hi il b im kz io ip iq la is it jh lb iw ix ji lc ja jb jj ld je jf jg hb bi translated">在这篇简短的文章中，我们看到了如何从您的机器上编写一个有意义的指标，并从命令行将其注入到云监控中。</p><p id="b84b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">很容易对这些值进行分割(在本例中是通过<code class="du le lf lg lh b">hostname</code>进行聚合)，然后对它们进行显示和警告。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es nc"><img src="../Images/bf6cdb82740e572626e4aa5258856413.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*clxCCRXccCBpxfET"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">插上它就有电池了还是拔下它就能看到好看的图形了？</figcaption></figure><p id="2708" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">天空才是现在的极限。你可以做一些愚蠢的事情，比如数你的Chrome标签，当它们超过42个时，用一些愚蠢的消息发出警告，比如“<em class="ik">来自银河系的消息:重启Chrome！</em>”</p><pre class="jl jm jn jo fd lk lh nd bn ne nf bi"><span id="c3ce" class="ng kf hi lh b be nh ni l nj lr">brew install chrome-cli # only-once install<br/>PROJECT_ID=my-project-123 gcp-write-metric mac-chrome-cli-ntabs $(chrome-cli list tabs | wc -l)</span></pre><p id="e755" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><em class="ik">注意:在代码中我使用了“gce_instance”，而实际上我应该使用“全局”指标(</em><a class="ae ka" href="https://cloud.google.com/monitoring/api/resources" rel="noopener ugc nofollow" target="_blank"><em class="ik">docs</em></a><em class="ik">)。我喜欢GCE实例，因为它已经包含了主机名和GCP区域，但这是不正确的(我告诉GCP那是云中的虚拟机，而不是)。支持这一点的新代码正在这个惊人的脚本中开发:</em>🌸<em class="ik"/><a class="ae ka" href="https://github.com/palladius/sakura/blob/master/bin/gcp-write-metric-done-well" rel="noopener ugc nofollow" target="_blank">GCP-写-度量-做-好</a></p></div></div>    
</body>
</html>