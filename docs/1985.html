<html>
<head>
<title>Google Cloud Workload Identity Federation with Okta</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Okta的Google云工作负载身份联盟</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-workload-identity-federation-with-okta-90c05b985b17?source=collection_archive---------0-----------------------#2021-10-16">https://medium.com/google-cloud/google-cloud-workload-identity-federation-with-okta-90c05b985b17?source=collection_archive---------0-----------------------#2021-10-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="50b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你是Workload Identity Federation的新手，可以看看Scalesec的<a class="ae jd" rel="noopener" href="/google-cloud/keyless-api-authentication-launching-gcp-workloads-from-aws-b715b4e6c99a">这篇</a>中型文章和<a class="ae jd" href="https://blog.scalesec.com/access-gcp-from-aws-using-workload-identity-federation-829113ef0b69" rel="noopener ugc nofollow" target="_blank">这篇</a>博客。基本上，Workload Identity Federation将允许您连接到Google Cloud APIs，而无需使用来自Google Cloud外部的服务帐户密钥。这降低了密钥泄漏或误用的风险，并消除了混合云或多云集成中的最大障碍之一。</p><p id="c4d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">工作负载身份联合并不适合所有场景。下面是一个简单的流程图，描述了为您的应用程序选择工作负载身份联合的过程。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/4758d3d60fa45816d198f91f3c835b33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QGBT8NZk9ED91re3Ovln2g.png"/></div></div></figure><p id="8d21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将假设:</p><ul class=""><li id="02c3" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc jv jw jx jy bi translated">您有需要查询Google Cloud APIs的应用程序的源代码</li><li id="d2c3" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc jv jw jx jy bi translated">你用Okta作为你的OIDC供应商</li><li id="3480" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc jv jw jx jy bi translated">您正在使用一种受<a class="ae jd" href="https://cloud.google.com/iam/docs/using-workload-identity-federation#generate-automatic" rel="noopener ugc nofollow" target="_blank">支持的</a>编程语言用于google-auth库</li></ul><h1 id="642c" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">OAuth流</h1><p id="7893" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">我们将使用客户端凭证流(在<a class="ae jd" href="https://tools.ietf.org/html/rfc6749#section-4.4" rel="noopener ugc nofollow" target="_blank"> OAuth 2.0 RFC 6749第4.4节</a>中定义)，其中您的应用程序将传递客户端ID和客户端密码来验证应用程序本身并获得令牌。为什么？对于在后端运行的机器对机器(M2M)应用程序，如CLI、守护程序或服务，系统会对应用程序而不是用户进行身份验证和授权。对于这种情况，用户名+密码或社交登录等典型的身份验证方案没有意义。相反，M2M应用程序使用OAuth客户端凭证流。</p><p id="323b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是在这种情况下会发生的数据流</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lh"><img src="../Images/d4c1ae05782b3bb200cdbc8cf7733352.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nVbgIZgsPMOefvz5TE2CmQ.png"/></div></div></figure><h1 id="467c" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">准备Okta以发布客户端凭据的步骤</h1><p id="cc34" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">Okta有一个授权服务器的概念，需要它来发布客户机凭证。在我的测试实例中，我必须创建一个新的授权服务器，这样我就可以获得一个访问令牌。</p><ol class=""><li id="4183" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc li jw jx jy bi translated">登录Okta管理控制台</li><li id="2dfb" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc li jw jx jy bi translated">转到安全性-&gt;API</li><li id="c391" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc li jw jx jy bi translated">授权服务器</li><li id="44c3" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc li jw jx jy bi translated">定义一个新的授权服务器，记下发行者URL——您将需要它来配置Google Cloud中的OIDC提供者</li><li id="6d8a" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc li jw jx jy bi translated">设置受众(可以是任何可以相互验证的东西，最好是唯一的)，记录受众——您将需要这些来配置Google Cloud中的OIDC提供商</li><li id="d934" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc li jw jx jy bi translated">定义一个新范围，将此范围设置为默认范围</li><li id="9c79" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc li jw jx jy bi translated">定义新的索赔。根据您对Google Cloud中的<a class="ae jd" href="https://cloud.google.com/iam/docs/configuring-workload-identity-federation#mappings-and-conditions" rel="noopener ugc nofollow" target="_blank">属性验证</a>的需求定制此声明</li><li id="d527" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc li jw jx jy bi translated">转到访问策略，确保它被分配到“所有客户端”</li></ol><h1 id="4429" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">Google云设置</h1><p id="ca33" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">为Okta创建一个工作负载身份池和一个新的提供者。由于谷歌云OIDC提供商不允许设置aud值，您需要通过gcloud执行第3步。其他步骤可以使用控制台执行。</p><ol class=""><li id="7c34" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc li jw jx jy bi translated">g cloud iam workload-identity-pools create workload-id-pool 1-location = " global "--description = " Testing workload identity Federation with Okta "--display-name = " workload-id-pool 1 "</li><li id="e570" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc li jw jx jy bi translated">g cloud iam workload-identity-pools providers create-oidc okta-provider-workload-identity-pool = " workload-id-pool 1 "-issuer-uri = "<okta-issuer-url>"-location = " global "-attribute-mapping = " Google . subject = assertion . sub "-allowed-accessories = "<enter client_id="">"</enter></okta-issuer-url></li><li id="09d9" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc li jw jx jy bi translated">g cloud iam service-accounts add-iam-policy-binding oktagcpsvacct @ PS-test-project-259122 . iam . gserviceaccount . com-role = roles/iam . workloadidentityuser-member = " principal://iam . Google APIs . com/projects/731056981369/locations/global/workloadIdentityPools/workload-id-pool-1/subject/<strong class="ih hj">&lt;authz-server-sub&gt;</strong></li><li id="5147" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc li jw jx jy bi translated">g cloud beta iam workload-identity-pools providers update-oidc vz-SSO-oid C2-allowed-accessories = " API://24 WDS 23 "-workload-identity-pool = " workload-id-pool 1 "-location = " global "</li></ol><p id="049f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用此gcloud命令验证aud和sub设置是否正确</p><p id="69f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">g cloud iam workload-identity-pools providers描述okta-provider-workload-identity-pool = " workload-id-pool 1 "-location = " global "</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lj"><img src="../Images/cf0c004c4463137f7dee115a399b230c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*gOJlj8wciaKLOVfoGJ4NEQ.png"/></div></div></figure><p id="da0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.下载JSON配置文件并存储在应用程序存储库中。这个文件可以与应用程序一起存在，因为它没有像私钥这样的机密数据。</p><p id="2551" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">JSON配置文件如下所示:</p><pre class="jf jg jh ji fd lk ll lm ln aw lo bi"><span id="811d" class="lp kf hi ll b fi lq lr l ls lt">{<br/>  "type": "external_account",<br/>  "audience": "//iam.googleapis.com/projects/794301636481/locations/global/workloadIdentityPools/okta-pool-1/providers/google-sec-okta",<br/>  "subject_token_type": "urn:ietf:params:oauth:token-type:jwt",<br/>  "token_url": "<a class="ae jd" href="https://sts.googleapis.com/v1/token" rel="noopener ugc nofollow" target="_blank">https://sts.googleapis.com/v1/token</a>",<br/>  "service_account_impersonation_url": "<a class="ae jd" href="https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/oktagcpsvacct@ps-test-project-259122.iam.gserviceaccount.com:generateAccessToken" rel="noopener ugc nofollow" target="_blank">https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/oktagcpsvacct@ps-test-project-259122.iam.gserviceaccount.com:generateAccessToken</a>",<br/>  "credential_source": {<br/>    "file": "/tmp/okta-token.json",<br/>    "format": {<br/>      "type": "json",<br/>      "subject_token_field_name": "access_token"<br/>    }<br/>  }<br/>}</span></pre><p id="c7ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如您所看到的，这个新的json文件看起来与原始的密钥JSON文件非常不同。这个json文件指示google-auth库对STS和服务帐户使用什么端点，以及如何查找工作负载标识池。json文件中的受众值不需要在Okta内匹配。只要受众在Okta授权服务器中配置了，提供者和JWT令牌匹配，我们就好了。</p><p id="e94a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个json文件还指示google-auth库在哪里可以找到Okta access toke jsons，所以要确保“file”参数包括json文件的路径和文件名，如上所示。</p><p id="7c6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个示例客户机代码，它查询Okta以获得一个访问令牌，存储在文件系统中，并在客户机程序运行完毕后删除它。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lu lv l"/></div></figure></div></div>    
</body>
</html>