<html>
<head>
<title>Data migration from MongoDB Atlas to BigQuery using Airbyte and handling the Raw Data(JSON) using Custom Queries</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Airbyte将数据从MongoDB Atlas迁移到BigQuery，并使用自定义查询处理原始数据(JSON)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/data-migration-from-mongodb-atlas-to-bigquery-using-airbyte-and-handling-the-raw-data-json-using-28ec90d71236?source=collection_archive---------0-----------------------#2022-08-05">https://medium.com/google-cloud/data-migration-from-mongodb-atlas-to-bigquery-using-airbyte-and-handling-the-raw-data-json-using-28ec90d71236?source=collection_archive---------0-----------------------#2022-08-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e48ed39844eda5200df6d1f9f00375f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*m2WpwOCmRz_KC5Qs"/></div></div></figure><p id="cc5b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据迁移是将数据从一个位置移动到另一个位置，从一种格式移动到另一种格式，或者从一个应用程序移动到另一个应用程序的过程。在这个博客中，我们将看到如何将数据从MongoDB(一个NoSQL数据库)迁移到BigQuery。</p><p id="1131" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">BigQuery提供了机器学习、地理静态分析和商业智能等功能来帮助您管理和分析数据。BigQuery提供了一种无服务器的体系结构，允许您使用SQL查询来回答组织的问题。</p><p id="253a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">我们将使用Airbyte将我们的数据从MongoDB迁移到BigQuery。</strong></p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jo"><img src="../Images/fe79477306de37ed3599db01b89b6818.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bwFeci6EFyPd_A7O"/></div></div></figure><h1 id="98e9" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">Airbyte简介:</h1><p id="e374" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated"><strong class="is hj"> Airbyte </strong>是一个开源数据管道平台，可以替代<em class="kw">stick Data</em>和<em class="kw"> Fivetran </em>。尽管这些现有的数据管道平台提供了大量与诸如<em class="kw"> Stripe </em>和<em class="kw"> Salesforce </em>之类的知名来源的集成，但当前模型中存在一个遗漏了小型服务集成的缺口。</p><p id="2c6d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">为什么要选择空气细胞？</strong></p><ul class=""><li id="0f24" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">提供免费社区版的轻松部署。</li><li id="0e34" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">拥有150多个数据源，所有数据仓库、湖泊和数据库均为目的地。</li><li id="e99d" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">Airbyte上的连接器在<strong class="is hj"> Docker容器</strong>中运行，允许独立操作。您只需监控每个连接器，根据需要刷新它们，并安排更新。</li><li id="e525" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">Airbyte为您提供了一个功能<strong class="is hj"> </strong>来监控您的每一个连接器，根据需要刷新它们，并安排更新。</li></ul><h1 id="8f08" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">同步模式</h1><ol class=""><li id="8168" class="kx ky hi is b it kr ix ks jb ll jf lm jj ln jn lo ld le lf bi translated">完全刷新覆盖:同步整个流，并通过覆盖来替换目标中的数据。</li><li id="d5e8" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lo ld le lf bi translated">完全刷新附加:同步整个流并将数据附加到目标。</li><li id="d6d2" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lo ld le lf bi translated">增量追加:同步流中的新记录，并将数据追加到目标。</li><li id="b05f" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lo ld le lf bi translated">增量重复数据消除历史记录:同步流中的新记录并在目标中追加数据，还提供了反映源中流状态的重复数据消除视图。</li></ol><h1 id="cc7b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">归一化和变换</h1><ol class=""><li id="76d8" class="kx ky hi is b it kr ix ks jb ll jf lm jj ln jn lo ld le lf bi translated">原始数据(JSON): Airbyte只将数据推入“JSON格式”的原始表中。</li><li id="e9cd" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lo ld le lf bi translated">标准化表格数据:Airbyte将数据推入原始表中，然后使用自己的查询将数据先推入临时表中(采用标准化表格格式)，然后使用合并脚本将数据推入最终表中。</li></ol><h1 id="9545" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">业务用例:</h1><p id="d187" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated"><strong class="is hj"> MongoDB </strong>是一个著名的NoSQL数据库，它要求数据以“JSON格式”建模。如果应用程序的数据模型自然适合MongoDB推荐的数据模型，那么它可以为事务性工作负载提供良好的性能、灵活性和可扩展性。</p><p id="91e6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，当涉及到分析知识时，MongoDB不是一个好的解决方案——它缺乏适当的连接，从其他系统向MongoDB传输数据很困难，并且它缺乏原生SQL支持。在MongoDB的聚合框架中编写复杂的分析逻辑不像在SQL中那么容易。</p><p id="2e84" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，有很多用例将数据从MongoDB传输到BigQuery，然后将BigQuery用于其他分析和ML场景..</p><h1 id="5a54" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">当Airbyte本身可以处理所有事情时，我们为什么要使用自定义查询呢？</h1><p id="2a49" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">对于大多数业务用例来说，<strong class="is hj">增量追加/增量重复数据删除模式</strong>通常被选为同步方法，并且通常使用来自规范化的<strong class="is hj">规范化表格数据选项</strong>将数据直接推送到主表。</p><p id="b964" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">与许多ETL/ELT工具类似，我们无法控制Airbyte在后端构建的合并查询，所以如果我们使用相同的查询，我们最终可能会为BigQuery付出很多。</p><p id="16d1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇博客中，我们将看看如何在选择<strong class="is hj">原始数据(JSON) </strong>作为使用<strong class="is hj"> Airbyte的增量追加/增量重复数据删除模式</strong>的<strong class="is hj">规范化</strong>选项时，只推送原始数据。自定义查询将用于处理一切，这将降低BigQuery的成本。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/d7c3c74adc7cda8b99f6f1c39203a920.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CYzzGDiISlJAbdGm"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图一。原始数据(JSON)样本</em></figcaption></figure><p id="0166" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">补充一下，当使用规范化特性时，Airbyte为单个最终表生成大约七个表，其中只有三个是必需的。其余的是由Airbyte为内部目的创建的。Airbyte将所有的staging、raw和final表保存在一个数据库中，当我们有大量的表时，这会造成很多混乱。</p><h1 id="7912" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">步骤:</h1><ol class=""><li id="eb35" class="kx ky hi is b it kr ix ks jb ll jf lm jj ln jn lo ld le lf bi translated">在GCP计算引擎上安装<strong class="is hj"> Airbyte </strong>。</li></ol><p id="93d1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">参考链接:<a class="ae lv" href="https://docs.airbyte.com/deploying-airbyte/on-gcp-compute-engine/" rel="noopener ugc nofollow" target="_blank">https://docs . airbyte . com/deploying-airbyte/on-GCP-compute-engine/</a></p><h2 id="445d" class="lw ju hi bd jv lx ly lz jz ma mb mc kd jb md me kh jf mf mg kl jj mh mi kp mj bi translated">Airbyte用户界面</h2><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/0fd4c2ac6cfe95173db1a8f4e0e623c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JUOdNcy7YbE6irMy"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图二。Airbyte用户界面</em></figcaption></figure><p id="d45c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.设置信号源</p><ul class=""><li id="cdc0" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">点击左侧窗格中的<strong class="is hj">信号源</strong>，然后点击<strong class="is hj">新信号源。</strong></li></ul><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ml"><img src="../Images/8073a3f92915c87dbfe06b44cd0003e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YWnUwK06yxRVEJL7"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图三。设置信号源</em></figcaption></figure><ul class=""><li id="45a3" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">填写所有详细信息并点击<strong class="is hj">设置源</strong>。</li></ul><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/59fa5dc16e7fbbba9a92eca1a12a92e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3IM2RmAMBApw0dsd"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图4。设置信号源</em></figcaption></figure><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es mn"><img src="../Images/bf000fe2f0fd622e3453ecdbc95ace9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/0*MfoCdchKhORQ5KCJ"/></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图5。设置信号源</em></figcaption></figure><p id="df73" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.设置目的地</p><ul class=""><li id="fc0b" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">设置目的地时，只需点击左侧窗格中的<strong class="is hj">目的地</strong>，然后选择右上角的<strong class="is hj">新目的地</strong>。</li></ul><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/e2cd7c28ce30c9034da2855b709fb0cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WTSHa0ZSNAFX64ex"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图六。设置目的地</em></figcaption></figure><ul class=""><li id="bb11" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">填写所有细节。</li></ul><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/ebe4d0b0eba23fb9010b3a26d1840be2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eK7bG_5nYHU52ToM"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图7。设置目的地</em></figcaption></figure><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/544cad12c23f89542f76502345dc3481.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sEUWuQGaW7TA_AnM"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图8。设置目的地</em></figcaption></figure><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mq"><img src="../Images/76f445d049d520ed5d5fe266c66faecd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5Kb6oNupEgbqjE-W"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图九。设置目的地</em></figcaption></figure><p id="b238" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.设置连接。</p><ul class=""><li id="f6bb" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">点击左窗格<strong class="is hj">中的<strong class="is hj">连接</strong>然后点击右上角的<strong class="is hj">新连接</strong>。</strong></li></ul><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/2ea4a20c0b612028cceedf1ba8409b20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*exzRzkhOg-jtoey9"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图10。设置连接</em></figcaption></figure><ul class=""><li id="a913" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">选择您的<strong class="is hj">源</strong>，并点击使用现有的源作为<strong class="is hj">目的地</strong>。</li></ul><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/a2d6e5242e86b067de96c0a03523d062.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dRR_OwSNXyx6rHQ9"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图11。设置连接</em></figcaption></figure><ul class=""><li id="93b2" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">选择同步模式、光标字段和主键。</li></ul><p id="43b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">游标字段</strong>:游标字段是用于从MongoDB atlas服务器获取增量数据的字段。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es mt"><img src="../Images/20b24f0067d4ddfc3d8bee74a381b4cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/0*Jfnjqm7I5Nz270we"/></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图12。设置连接</em></figcaption></figure><ul class=""><li id="9922" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">最后在标准化和转换部分:我们使用<strong class="is hj">原始数据(JSON) </strong>模式作为我们的用例。</li></ul><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/a0e6124cacfeabedb655ef7e235c32fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4GYWgdes2ELTQWbL"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图13。建立连接(标准化方法)。</em></figcaption></figure><p id="9371" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.点击<strong class="is hj">设置连接</strong>。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jo"><img src="../Images/22942f3f75ea934fe062fd5130b9405e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vUHtotZDLa-93jez"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图14。设置连接</em></figcaption></figure><ul class=""><li id="ad30" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated">现在BigQuery中有了原始数据:</li></ul><p id="b593" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">_ <strong class="is hj"> airbyte_ab_id，_airbyte_emitted_at </strong>是airbyte在将我们的数据推送到BigQuery时添加的列，_airbyte_data是我们实际需要的数据。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jo"><img src="../Images/ec47b498ef19e3b6626d72463035c822.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WnsAIjoQSLSoEDji"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图15。原始表</em></figcaption></figure><h1 id="4188" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">自定义标准化和转换:</h1><p id="b4de" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">由于Airbyte可能会将数据推送到一个原始表中，我们将编写自己的<strong class="is hj">脚本，首先将原始数据</strong>推送到一个规范化的表中，然后在稍后阶段，推送到一个包含所有合并数据的主表中。为了<strong class="is hj">最小化查询扫描</strong>和<strong class="is hj">降低BigQuery端的成本</strong>，我们将在staging和final表中维护<strong class="is hj">分区</strong>。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mv"><img src="../Images/419c8ab82b90e3306d6a98f9f54c602b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BqIJw3k4LWNTaWMV"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图十六。标准化和转换</em></figcaption></figure><ul class=""><li id="0429" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated"><strong class="is hj">规范化数据查询:</strong></li></ul><p id="7522" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">规范化后，下面的查询将从原始表中提取数据，并将其推送到临时表中。对于这一步，我们将使用<strong class="is hj"> json extract() </strong>函数。</p><pre class="jp jq jr js fd mw mx my mz aw na bi"><span id="f71a" class="lw ju hi mx b fi nb nc l nd ne">INSERT INTO <em class="kw">`</em>Demo.test.A_temp`<br/>SELECT<br/>json_extract(_airbyte_data, "$['_id']") as _id,<br/>json_extract(_airbyte_data, "$['Address']") as Address,<br/>json_extract(_airbyte_data, "$['created_at']") as created_at,<br/>json_extract(_airbyte_data, "$['updated_date']") as updated_date,<br/>json_extract(_airbyte_data, "$['user_id']") as user_id,<br/>FROM<br/>`Demo.test._airbyte_raw_A`</span></pre><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jo"><img src="../Images/f2dd9126dd8b35b559ca9c3dace112ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*D6yvXgPtOH6nAPII"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图17。暂存表</em></figcaption></figure><ul class=""><li id="4416" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lc ld le lf bi translated"><strong class="is hj">样本合并查询</strong></li></ul><p id="9f36" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后一步是运行合并查询，并将整个数据推送到最终的表中。在推送数据之前，我们可以检查重复的行，如果有，我们可以使用<strong class="is hj"> row_number() </strong>函数进行重复数据删除。此外，为了限制数据扫描，我们可以从staging表中获取最小和最大时间戳列值，并在合并查询中使用<strong class="is hj"> ON </strong>条件推送相同的值。这将有助于我们降低扫描成本，因为我们将只扫描最终表中所需的部分。</p><pre class="jp jq jr js fd mw mx my mz aw na bi"><span id="fead" class="lw ju hi mx b fi nb nc l nd ne">MERGE &lt;target_table&gt; [AS TARGET]<br/>USING &lt;table_source&gt; [AS SOURCE]<br/>ON &lt;search_condition&gt;<br/>[WHEN MATCHED <br/>   THEN &lt;merge_matched&gt; ]<br/>[WHEN NOT MATCHED [BY TARGET]<br/>   THEN &lt;merge_not_matched&gt; ]<br/>[WHEN NOT MATCHED BY SOURCE<br/>   THEN &lt;merge_matched&gt; ];</span></pre><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jo"><img src="../Images/17cc31060c51f91d8bb50e794469d7df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CUbPHph-qYkrddNQ"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图18。最终表格</em></figcaption></figure><h1 id="de2a" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">设置增量管道:</h1><ul class=""><li id="127e" class="kx ky hi is b it kr ix ks jb ll jf lm jj ln jn lc ld le lf bi translated">这个方法分为两部分。</li></ul><ol class=""><li id="d6e6" class="kx ky hi is b it iu ix iy jb kz jf la jj lb jn lo ld le lf bi translated"><strong class="is hj">将数据从MongoDB同步到BigQuery: <br/> </strong>这由Airbyte处理。Airbyte只根据在Airbyte的UI中定义的光标字段检索新数据。</li><li id="3476" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lo ld le lf bi translated"><strong class="is hj">编写自己的查询将数据从原始表同步到最终表:<br/> </strong>如前所述，我们可以编写自己的查询并在BigQuery中使用scheduled queries选项对它们进行调度，以将所有数据从原始表同步到最终表。</li></ol><p id="c167" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在BigQuery中，我们可以使用<strong class="is hj">元表</strong>概念来设置<strong class="is hj">增量负载</strong>。</p><p id="01fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一个<strong class="is hj">元表</strong>只是一个保存其他表的元数据的表。我们使用元表来存储最终表的最大值“updated_at”。此元数据信息由<strong class="is hj">规范化查询</strong>使用，以仅返回“<strong class="is hj"> updated_at </strong>”值<strong class="is hj">大于元表中存储的<strong class="is hj">信息</strong>的值。</strong></p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nf"><img src="../Images/ef44107f6240c3cdfe8f2986992f3a1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dDrXK9II7zbCD-j0"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图19。正常化和转变</em></figcaption></figure><h1 id="7f95" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">元表更新查询示例:</h1><pre class="jp jq jr js fd mw mx my mz aw na bi"><span id="9045" class="lw ju hi mx b fi nb nc l nd ne">UPDATE `test.metatable` SET max_updated_at = ( SELECT MAX(updated_date) FROM `Demo.test.final_A`) WHERE table_name='final_A'</span></pre><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ng"><img src="../Images/d4538f24181851acecd1fe999a0a1593.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Un5U6vmr_YtLUBk6"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated"><em class="lu">图20。元表</em></figcaption></figure><h1 id="9db7" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">使用Airbyte时发现的挑战:</h1><ul class=""><li id="77c8" class="kx ky hi is b it kr ix ks jb ll jf lm jj ln jn lc ld le lf bi translated">添加新的列或表时，必须重新同步整个数据集。</li><li id="8a0d" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">Airbyte不支持删除。</li><li id="a742" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">Airbyte无法处理记录形式的复杂数据，例如，如果您有一个格式为:<strong class="is hj"> {"Name":"jack "，" phno":xxxxxxx，" Address ":{ " full Name ":" jack Mathew "，" address line 1":"northern street "，" pincode":123432}} </strong>的地址列，在这种情况下，Airbyte会使地址列<strong class="is hj">为空</strong></li><li id="86b1" class="kx ky hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">无法跳过历史加载，只能运行增量加载。</li></ul><p id="63be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">结论:</strong> <br/>在这篇博客中，我们探讨了如何使用Airbyte将数据从MongoDB Atlas迁移到BigQuery，并使用定制查询处理Airbyte原始表数据</p><p id="a900" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">非常感谢你阅读这个博客，快乐的deployments☁️😄。</p><p id="e3e8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我要特别感谢<a class="nh ni ge" href="https://medium.com/u/55ed6b8ddc44?source=post_page-----28ec90d71236--------------------------------" rel="noopener" target="_blank"> Priyanka Raikwar </a>、<a class="nh ni ge" href="https://medium.com/u/7dcf7c11e818?source=post_page-----28ec90d71236--------------------------------" rel="noopener" target="_blank"> Parth Gangrade </a>、<a class="nh ni ge" href="https://medium.com/u/b35ae0f531c8?source=post_page-----28ec90d71236--------------------------------" rel="noopener" target="_blank"> Tanmay Sakpal </a>、<a class="nh ni ge" href="https://medium.com/u/e59a962731f6?source=post_page-----28ec90d71236--------------------------------" rel="noopener" target="_blank"> Shreya Goel </a>对我的贡献和激励我写这篇博客:)</p></div></div>    
</body>
</html>