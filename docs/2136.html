<html>
<head>
<title>Distributed Locust Testing on Google Kubernetes Engine (GKE)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Kubernetes引擎(GKE)上的分布式蝗虫测试</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/running-distributed-locust-tests-on-kubernetes-9b981797930?source=collection_archive---------0-----------------------#2022-03-20">https://medium.com/google-cloud/running-distributed-locust-tests-on-kubernetes-9b981797930?source=collection_archive---------0-----------------------#2022-03-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="494b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Google Kubernetes引擎(GKE)上运行分布式蝗虫测试的完整指南。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/f8a861420a04e68f70b75c4b24b495eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lvlMoM-aQ28_zlAYgBn7sw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">谷歌云平台+蝗虫</figcaption></figure><h2 id="39a3" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">介绍</h2><p id="b684" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">Locust.io是一个开源工具，可以让你对应用程序进行性能测试。Locust的优势之一是，它使您能够将性能测试分布在多台机器上，这样您就可以在应用程序上生成更大的负载。</p><p id="7b84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我们将看看如何将Locust部署到Google Kubernetes引擎(GKE ),以便使用主配置和工作配置来分配负载生成。</p><h2 id="67dc" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">要求</h2><ul class=""><li id="a6a0" class="ku kv hi ih b ii ko im kp iq kw iu kx iy ky jc kz la lb lc bi translated">你所需要做的就是进入谷歌云平台(GCP)账户。我们将使用谷歌Kubernetes引擎和其他一些GCP服务作为本指南的一部分。</li></ul></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><h2 id="ce2e" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">创建您的Kubernetes集群</h2><p id="eb4b" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">首先，我们需要设置一个Kubernetes集群。您需要登录您的Google云平台帐户，并导航到控制台的Kubernetes引擎部分，如下所示。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lk"><img src="../Images/18053c935926e30e6972f01c253f2065.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cjkXsFrwaZS0e2J96YBktA.png"/></div></div></figure><p id="672a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">进入此页面后，您需要:</p><ul class=""><li id="0c4a" class="ku kv hi ih b ii ij im in iq ll iu lm iy ln jc kz la lb lc bi translated">选择<strong class="ih hj">“创建”按钮</strong>。</li><li id="18f5" class="ku kv hi ih b ii lo im lp iq lq iu lr iy ls jc kz la lb lc bi translated">点击“GKE标准”选项旁边的<strong class="ih hj">“配置”按钮</strong>。</li><li id="fc5c" class="ku kv hi ih b ii lo im lp iq lq iu lr iy ls jc kz la lb lc bi translated"><strong class="ih hj">为您的集群选择一个名称</strong>，例如“分布式蝗虫测试”。</li><li id="9c28" class="ku kv hi ih b ii lo im lp iq lq iu lr iy ls jc kz la lb lc bi translated"><strong class="ih hj">为您的集群选择最合适的区域</strong>，例如“欧洲-西方1-c”。</li><li id="4929" class="ku kv hi ih b ii lo im lp iq lq iu lr iy ls jc kz la lb lc bi translated">点击屏幕底部的<strong class="ih hj">“创建”按钮</strong>。</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lk"><img src="../Images/bc8f54df2d468b9cebb146e679a7ed29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9RnDR8Nf4F2BnLluk_M_HA.png"/></div></div></figure><p id="3992" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您不需要配置任何其他设置，如自动化、网络、安全等。几分钟后，您的Kubernetes集群应该已经完成构建，并将在您的控制台中可见。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lk"><img src="../Images/e9a1d4f24a20712a2122cd0098687763.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JUZvU3aHDg_oVxh2qgFOOw.png"/></div></div></figure><p id="c5f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您需要:</p><ul class=""><li id="06f4" class="ku kv hi ih b ii ij im in iq ll iu lm iy ln jc kz la lb lc bi translated"><strong class="ih hj">点击“名称”栏下的集群名称</strong>。</li><li id="0c29" class="ku kv hi ih b ii lo im lp iq lq iu lr iy ls jc kz la lb lc bi translated">在此页面上选择<strong class="ih hj">连接按钮</strong>。</li><li id="cf0e" class="ku kv hi ih b ii lo im lp iq lq iu lr iy ls jc kz la lb lc bi translated">然后点击<strong class="ih hj">“在云壳中运行”按钮</strong>。</li></ul><p id="00d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您将在窗口中使用类似以下的命令打开云Shell:</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="fb9f" class="jt ju hi lu b fi ly lz l ma mb">$ <!-- -->gcloud container clusters get-credentials distributed-locust-testing --zone europe-west1-c --project infra-agent-999999</span></pre><p id="5244" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击“Enter”后，您将连接到您的Kubernetes集群。</p></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><h2 id="2eba" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">将Locust部署到集群</h2><p id="1195" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">现在，我建议您设置一些环境变量，我们将需要这些变量来运行这些命令。</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="8bc8" class="jt ju hi lu b fi ly lz l ma mb">$ PROJECT=$(gcloud config get-value project)<br/>$ REGION=europe-west1<br/>$ ZONE=${REGION}-c<br/>$ CLUSTER=distributed-locust-testing<br/>$ TARGET=${PROJECT}.appspot.com<br/>$ gcloud config set compute/region $REGION <br/>$ gcloud config set compute/zone $ZONE</span></pre><p id="18f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还应该启用所有必需的API，使用:</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="66f9" class="jt ju hi lu b fi ly lz l ma mb">$ gcloud services enable \<br/>    cloudbuild.googleapis.com \<br/>    compute.googleapis.com \<br/>    container.googleapis.com \<br/>    containeranalysis.googleapis.com \<br/>    containerregistry.googleapis.com</span></pre><p id="8ba6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，您需要运行以下命令来克隆后续步骤所需的文件。</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="0796" class="jt ju hi lu b fi ly lz l ma mb">$ <!-- -->git clone <a class="ae kt" href="https://github.com/GoogleCloudPlatform/distributed-load-testing-using-kubernetes" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/distributed-load-testing-using-kubernetes</a></span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lk"><img src="../Images/b617f7a2a512d50e4f1583b8d7ffa3e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*awowF-G8Z2VkkhuhTskzTQ.png"/></div></div></figure><p id="a6f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你列出你的目录中的文件，你会看到你现在有一些新的。现在我们需要构建一个Docker映像，并将其推送到Google容器注册中心。我们可以通过运行以下命令来实现这一点:</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="c8f8" class="jt ju hi lu b fi ly lz l ma mb">$ <!-- -->pushd distributed-load-testing-using-kubernetes/</span><span id="82d6" class="jt ju hi lu b fi mc lz l ma mb"><br/>$ <!-- -->gcloud builds submit --tag gcr.io/$PROJECT/locust-tasks:latest docker-image/.</span></pre><p id="c9a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成order文件中的每个步骤大约需要一分钟。如果成功完成，您应该会收到如下所示的消息:</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="56ae" class="jt ju hi lu b fi ly lz l ma mb">CREATE_TIME: 2022–03–20T18:56:13+00:00<br/>DURATION: 1M3S<br/>SOURCE: gs://infra-agent-999999_cloudbuild/source/1647802572.889189–59f5e6f8582a45978bef34343012cbc4.tgz<br/>IMAGES: gcr.io/infra-agent-999999/locust-tasks (+1 more)<br/>STATUS: SUCCESS</span></pre><p id="c647" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以通过运行以下命令将示例web应用程序部署到集群中:</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="40ab" class="jt ju hi lu b fi ly lz l ma mb">$ gcloud app deploy sample-webapp/app.yaml --project=$PROJECT</span></pre><p id="5f88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将部署一个从GitHub存储库克隆到App Engine的示例web应用程序。这可能需要几分钟时间。</p><p id="b73d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们需要替换Kubernetes配置中的[TARGET_HOST]和[PROJECT_ID]。我们将用之前设置的环境变量替换它们。这是通过运行以下命令完成的:</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="2093" class="jt ju hi lu b fi ly lz l ma mb">$ sed -i -e “s/\[TARGET_HOST\]/$TARGET/g” kubernetes-config/locust-master-controller.yaml</span><span id="a547" class="jt ju hi lu b fi mc lz l ma mb">$ sed -i -e “s/\[TARGET_HOST\]/$TARGET/g” kubernetes-config/locust-worker-controller.yaml</span><span id="0cc4" class="jt ju hi lu b fi mc lz l ma mb">$ sed -i -e “s/\[PROJECT_ID\]/$PROJECT/g” kubernetes-config/locust-master-controller.yaml</span><span id="1ecc" class="jt ju hi lu b fi mc lz l ma mb">$ sed -i -e “s/\[PROJECT_ID\]/$PROJECT/g” kubernetes-config/locust-worker-controller.yaml</span></pre><p id="0e56" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">替换这些组件后，我们现在可以将每个组件部署到集群中。这包括主部署、工作部署和服务。这是通过运行以下命令完成的:</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="4eca" class="jt ju hi lu b fi ly lz l ma mb">$ kubectl apply -f kubernetes-config/locust-master-controller.yaml</span><span id="cc48" class="jt ju hi lu b fi mc lz l ma mb"><br/>$ kubectl apply -f kubernetes-config/locust-master-service.yaml</span><span id="f736" class="jt ju hi lu b fi mc lz l ma mb"><br/>$ kubectl apply -f kubernetes-config/locust-worker-controller.yaml</span></pre><p id="af37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果您看一下您的pod，您会看到在您的集群中有一个主节点和五个工作节点在运行。您可以通过输入以下命令来查看:</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="a0ff" class="jt ju hi lu b fi ly lz l ma mb">$ kubectl get pods</span><span id="3560" class="jt ju hi lu b fi mc lz l ma mb">NAME                             READY   STATUS    RESTARTS   AGE<br/>locust-master-67bd6b669b-wlbc6   1/1     Running   0          20m<br/>locust-worker-656b94465c-5s8cj   1/1     Running   0          20m<br/>locust-worker-656b94465c-mc92z   1/1     Running   0          20m<br/>locust-worker-656b94465c-qw6v6   1/1     Running   0          20m<br/>locust-worker-656b94465c-thgjv   1/1     Running   0          20m<br/>locust-worker-656b94465c-zxbsb   1/1     Running   0          20m</span></pre><p id="e390" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">恭喜，您已经成功地将蝗虫部署到您的集群！</p><h2 id="5cf8" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">执行分布式负载测试</h2><p id="13e7" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">现在，我们想开始对之前部署到集群中的示例web应用程序运行一些分布式负载/性能测试。首先，我们需要获取Locust主机的外部IP地址，并通过运行以下命令将其设置为环境变量:</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="d3a9" class="jt ju hi lu b fi ly lz l ma mb">$ EXTERNAL_IP=$(kubectl get svc locust-master -o yaml | grep ip | awk -F”:” ‘{print $NF}’)</span><span id="447e" class="jt ju hi lu b fi mc lz l ma mb">$ echo $EXTERNAL_IP</span></pre><p id="c6e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将把外部IP打印到云壳。现在，您应该能够通过在Web浏览器中打开以下地址来访问Locust Web UI:</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="76a2" class="jt ju hi lu b fi ly lz l ma mb">http://$EXTERNAL_IP:8089</span><span id="47cf" class="jt ju hi lu b fi mc lz l ma mb">For example: <a class="ae kt" href="http://34.140.153.84:8089" rel="noopener ugc nofollow" target="_blank">http://34.140.153.84:8089</a></span></pre><p id="a7c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将使您能够访问Locust Web UI，如下图所示。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es md"><img src="../Images/5b399835de0e35f1fdfa6589dba85b79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UnOPdqP0o-FFA80TFk__xw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">蝗虫网络用户界面</figcaption></figure><p id="4cae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来你需要做的就是输入你想要模拟的用户数量，输入你想要使用的孵化率，你就可以开始了！如果您需要增加工作人员的数量来模拟更多的用户，您可以通过扩大您的工作人员部署来实现，例如:</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="ee8d" class="jt ju hi lu b fi ly lz l ma mb">$ kubectl scale deployment/locust-worker --replicas=20</span></pre></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><h2 id="1d73" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">重要注意事项</h2><p id="1063" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">请记住，向外部系统生成大量流量可能会被视为分布式拒绝服务(DDoS)攻击。请务必阅读谷歌云平台的可接受使用政策和服务条款，以确保您没有违反它！</p><p id="776c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同样重要的是要知道，如果你长时间持续运行你的Google Kubernetes引擎(GKE)集群，你很快就会欠下一大笔账单。记住终止作为本教程一部分使用的所有资源，以避免产生任何意外成本。完成此操作的步骤如下。</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="5962" class="jt ju hi lu b fi ly lz l ma mb">Delete your Google Kubernetes Engine (GKE) cluster</span><span id="0e79" class="jt ju hi lu b fi mc lz l ma mb">$ gcloud container clusters delete $CLUSTER --zone $ZONE</span></pre><p id="5b6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您还应该在控制台中转到Google Container Registry，删除带有我们之前创建的图像的locust-tasks文件夹。那应该包括一切！</p></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><h2 id="194b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">参考</h2><p id="0498" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated"><a class="ae kt" href="https://github.com/GoogleCloudPlatform/distributed-load-testing-using-kubernetes" rel="noopener ugc nofollow" target="_blank">使用GKE的分布式负载测试</a>:这是Google Cloud的GitHub库，用于运行这些分布式负载测试。本指南中的一些步骤和信息摘自该存储库，因此如果您遇到问题，也请以此为基础。我尽了最大努力，使用这个库中的步骤创建了一个更详细的指南，以便更容易遵循。</p><p id="7042" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您有任何问题，欢迎在这里评论或在LinkedIn上给我发消息，我会尽力帮助您！</p></div></div>    
</body>
</html>