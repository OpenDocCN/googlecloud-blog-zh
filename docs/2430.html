<html>
<head>
<title>Executing commands (gcloud, kubectl) from Workflows</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从工作流执行命令(gcloud、kubectl)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/executing-commands-gcloud-kubectl-from-workflows-ad6b85eaf39c?source=collection_archive---------2-----------------------#2022-10-17">https://medium.com/google-cloud/executing-commands-gcloud-kubectl-from-workflows-ad6b85eaf39c?source=collection_archive---------2-----------------------#2022-10-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="ffee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在之前的<a class="ae jd" href="https://cloud.google.com/blog/topics/developers-practitioners/introducing-new-connectors-workflows" rel="noopener ugc nofollow" target="_blank">帖子</a>中，我展示了如何使用工作流和计算引擎连接器管理虚拟机的生命周期。当您试图管理的资源有一个连接器时，这种方法非常有效。当没有连接器时，您可以尝试使用来自工作流的资源的API，如果有的话。或者，你也可以使用我最喜欢的命令行工具来管理资源:<code class="du je jf jg jh b">gcloud</code>。或者，如果您正在管理一个Kubernetes集群，也许您想调用<code class="du je jf jg jh b">kubectl</code>来代替。</p><p id="981c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，你可能会问:<strong class="ih hj">如何从工作流中执行一个命令行工具，比如</strong> <code class="du je jf jg jh b"><strong class="ih hj">gcloud</strong></code> <strong class="ih hj">或者</strong> <code class="du je jf jg jh b"><strong class="ih hj">kubectl</strong></code> <strong class="ih hj">？</strong></p><p id="3721" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你的直觉是对的。从工作流中没有直接调用<code class="du je jf jg jh b">gcloud</code>或<code class="du je jf jg jh b">kubectl</code>的方法。然而，Cloud Build提供了一些包含了<code class="du je jf jg jh b">gcloud</code>和<code class="du je jf jg jh b">kubectl</code>的容器映像。您可以从云构建步骤中运行这些容器中的<code class="du je jf jg jh b">gcloud</code>和<code class="du je jf jg jh b">kubectl</code>命令。您还可以使用云构建连接器从工作流步骤创建云构建步骤。</p><p id="7a13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你明白我的意思了吗？我们来看看细节。</p><h1 id="fa03" class="ji jj hi bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">为gcloud创建工作流程</h1><p id="e1ee" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">让我们首先创建一个工作流来运行<code class="du je jf jg jh b">gcloud</code>命令，例如<code class="du je jf jg jh b">gcloud workflows list</code>。</p><p id="b569" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个带有<code class="du je jf jg jh b">execute_command</code>步骤的<a class="ae jd" href="https://github.com/GoogleCloudPlatform/workflows-demos/blob/master/workflows-executes-commands/workflow-gcloud.yaml" rel="noopener ugc nofollow" target="_blank">工作流-gcloud.yaml </a>文件:</p><pre class="kl km kn ko fd kp jh kq kr aw ks bi"><span id="4ea0" class="kt jj hi jh b fi ku kv l kw kx">main:<br/>  steps:<br/>  - execute_command:<br/>      call: gcloud<br/>      args:<br/>          args: "workflows list"<br/>      result: result<br/>  - return_result:<br/>      return: ${result}</span></pre><p id="92af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du je jf jg jh b">execute_command</code>步骤调用一个名为<code class="du je jf jg jh b">gcloud</code>的子工作流，使用您想要运行的命令<code class="du je jf jg jh b">workflows list</code>作为参数。子工作流定义如下:</p><pre class="kl km kn ko fd kp jh kq kr aw ks bi"><span id="1129" class="kt jj hi jh b fi ku kv l kw kx">gcloud:<br/>  params: [args]<br/>  steps:<br/>  - create_build:<br/>      call: googleapis.cloudbuild.v1.projects.builds.create<br/>      args:<br/>        projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}<br/>        parent: ${"projects/" + sys.get_env("GOOGLE_CLOUD_PROJECT_ID") + "/locations/global"}<br/>        body:<br/>          serviceAccount: ${sys.get_env("GOOGLE_CLOUD_SERVICE_ACCOUNT_NAME")}<br/>          options:<br/>            logging: CLOUD_LOGGING_ONLY<br/>          steps:<br/>          - name: gcr.io/google.com/cloudsdktool/cloud-sdk<br/>            entrypoint: /bin/bash<br/>            args: ${["-c", "gcloud " + args + " &gt; $$BUILDER_OUTPUT/output"]}<br/>      result: result_builds_create<br/>  - return_gcloud_result:<br/>      return: ${text.split(text.decode(base64.decode(result_builds_create.metadata.build.results.buildStepOutputs[0])), "\n")}</span></pre><p id="dd60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">子工作流使用云构建连接器通过一个步骤创建一个构建。在该步骤中，您使用<code class="du je jf jg jh b">gcr.io/google.com/cloudsdktool/cloud-sdk</code>图像运行带有所提供参数的<code class="du je jf jg jh b">gcloud</code>命令。您还可以捕获输出，这是一个base64编码的多行字符串。在最后一步中，您将访问输出，对其进行解码，并通过新行进行分割以返回一个行数组。</p><p id="0758" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们基本上是在云构建的帮助下调用<code class="du je jf jg jh b">gcloud</code>命令，捕获输出并将输出作为多行数组返回！</p><h1 id="4845" class="ji jj hi bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">为kubectl创建工作流</h1><p id="e764" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">让我们看看如何用<code class="du je jf jg jh b">kubectl</code>命令做同样的事情。</p><p id="ede6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有一个<a class="ae jd" href="https://github.com/GoogleCloudPlatform/workflows-demos/blob/master/workflows-executes-commands/workflow-kubectl.yaml" rel="noopener ugc nofollow" target="_blank">工作流-kubectl.yaml </a>文件，它通过调用<code class="du je jf jg jh b">execute_command</code>子工作流来执行<code class="du je jf jg jh b">kubectl --help</code>命令:</p><pre class="kl km kn ko fd kp jh kq kr aw ks bi"><span id="6201" class="kt jj hi jh b fi ku kv l kw kx">main:<br/>  steps:<br/>  - execute_command:<br/>      call: kubectl<br/>      args:<br/>          args: "--help"<br/>      result: result<br/>  - return_result:<br/>      return: ${result}</span></pre><p id="f5a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du je jf jg jh b">kubectl</code>子工作流定义如下:</p><pre class="kl km kn ko fd kp jh kq kr aw ks bi"><span id="c186" class="kt jj hi jh b fi ku kv l kw kx">kubectl:<br/>  params: [args]<br/>  steps:<br/>  - create_build:<br/>      call: googleapis.cloudbuild.v1.projects.builds.create<br/>      args:<br/>        projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}<br/>        parent: ${"projects/" + sys.get_env("GOOGLE_CLOUD_PROJECT_ID") + "/locations/global"}<br/>        body:<br/>          serviceAccount: ${sys.get_env("GOOGLE_CLOUD_SERVICE_ACCOUNT_NAME")}<br/>          options:<br/>            logging: CLOUD_LOGGING_ONLY<br/>          steps:<br/>          - name: gcr.io/cloud-builders/kubectl<br/>            entrypoint: /bin/bash<br/>            args: ${["-c", "kubectl " + args + " &gt; $$BUILDER_OUTPUT/output"]}<br/>      result: result_builds_create<br/>  - return_build_result:<br/>      return: ${text.split(text.decode(base64.decode(result_builds_create.metadata.build.results.buildStepOutputs[0])), "\n")}</span></pre><p id="fddf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，子工作流与前一个非常相似，除了它依赖于<code class="du je jf jg jh b">gcr.io/cloud-builders/kubectl</code>图像来运行<code class="du je jf jg jh b">kubectl</code>命令。</p><p id="7fac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不可否认，这是一个非常简单的例子，因为<code class="du je jf jg jh b">kubectl --help</code>并不与真正的集群接口。您需要弄清楚如何用一个真实的集群来认证<code class="du je jf jg jh b">kubectl</code>，但这不是这篇博文的重点。</p><h1 id="875e" class="ji jj hi bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">部署工作流</h1><p id="dcdb" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">确保您有一个Google Cloud项目，并且在<code class="du je jf jg jh b">gcloud</code>中设置了项目id:</p><pre class="kl km kn ko fd kp jh kq kr aw ks bi"><span id="807c" class="kt jj hi jh b fi ku kv l kw kx">PROJECT_ID=your-project-id<br/>gcloud config set project $PROJECT_ID</span></pre><p id="88de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行<a class="ae jd" href="https://github.com/GoogleCloudPlatform/workflows-demos/blob/master/workflows-executes-commands/setup.sh" rel="noopener ugc nofollow" target="_blank"> setup.sh </a>来启用所需的服务，分配必要的角色，并部署两个工作流。</p><h1 id="8f98" class="ji jj hi bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">运行gcloud的工作流</h1><p id="1d5e" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">从Google Cloud控制台或gcloud运行工作流:</p><pre class="kl km kn ko fd kp jh kq kr aw ks bi"><span id="20d8" class="kt jj hi jh b fi ku kv l kw kx">gcloud workflows run workflow-gcloud</span></pre><p id="caa5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该会看到一个新的构建成功地在云构建中运行gcloud:</p><figure class="kl km kn ko fd kz er es paragraph-image"><div class="er es ky"><img src="../Images/5603e96a6289c51f662f1ebf69c029ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/0*TDueaqSMEoJCPIW-.png"/></div></figure><p id="e3b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当工作流成功时，您还应该看到gcloud命令的输出:</p><pre class="kl km kn ko fd kp jh kq kr aw ks bi"><span id="8f9c" class="kt jj hi jh b fi ku kv l kw kx">result: '["NAME                                                                                        STATE   REVISION_ID  UPDATE_TIME",<br/>"projects/atamel-workflows-gcloud/locations/us-central1/workflows/workflow-gcloud            ACTIVE  000001-7fa   2022-10-07T09:26:27.470230358Z",<br/>"projects/atamel-workflows-gcloud/locations/us-central1/workflows/workflow-kubectl           ACTIVE  000001-215   2022-10-07T09:26:32.511757767Z",<br/>""]'</span></pre><h1 id="b5e1" class="ji jj hi bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">运行kubectl的工作流</h1><p id="74ab" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">从谷歌云控制台或<code class="du je jf jg jh b">gcloud</code>运行工作流:</p><pre class="kl km kn ko fd kp jh kq kr aw ks bi"><span id="2ecc" class="kt jj hi jh b fi ku kv l kw kx">gcloud workflows run workflow-kubectl</span></pre><p id="7bd3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该会看到一个新的构建成功地在云构建中运行了kubectl:</p><figure class="kl km kn ko fd kz er es paragraph-image"><div class="er es lc"><img src="../Images/26b8ae6a1d48d96d9373f9a6dfcd9709.png" data-original-src="https://miro.medium.com/v2/resize:fit:1036/format:webp/0*qBNB71WJdDNqkHxK.png"/></div></figure><p id="31b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当工作流成功时，您还应该看到kubectl命令的输出:</p><pre class="kl km kn ko fd kp jh kq kr aw ks bi"><span id="30e2" class="kt jj hi jh b fi ku kv l kw kx">result: '["kubectl controls the Kubernetes cluster manager.",""," Find more information at: https://kubernetes.io/docs/reference/kubectl/overview/","","Basic Commands (Beginner):"," create Create a resource from a file or from stdin"," expose Take a replication controller, service, deployment or pod and expose it as a new Kubernetes service"," run Run a particular image on the cluster"," set Set specific features on objects","","Basic Commands (Intermediate):"," explain Get documentation for a resource"," get Display one or many resources"," edit Edit a resource on the server"," delete Delete resources by file names, stdin, resources and names, or by resources and label selector","","Deploy Commands:"," rollout Manage the rollout of a resource"," scale Set a new size for a deployment, replica set, or replication controller"," autoscale Auto-scale a deployment, replica set, stateful set, or replication controller","","Cluster Management Commands:"," certificate Modify certificate resources."," cluster-info Display cluster information"," top Display resource (CPU/memory) usage"," cordon Mark node as unschedulable"," uncordon Mark node as schedulable"," drain Drain node in preparation for maintenance"," taint Update the taints on one or more nodes","","Troubleshooting and Debugging Commands:"," describe Show details of a specific resource or group of resources"," logs Print the logs for a container in a pod"," attach Attach to a running container"," exec Execute a command in a container"," port-forward Forward one or more local ports to a pod"," proxy Run a proxy to the Kubernetes API server"," cp Copy files and directories to and from containers"," auth Inspect authorization"," debug Create debugging sessions for troubleshooting workloads and nodes","","Advanced Commands:"," diff Diff the live version against a would-be applied version"," apply Apply a configuration to a resource by file name or stdin"," patch Update fields of a resource"," replace Replace a resource by file name or stdin"," wait Experimental: Wait for a specific condition on one or many resources"," kustomize Build a kustomization target from a directory or URL.","","Settings Commands:"," label Update the labels on a resource"," annotate Update the annotations on a resource"," completion Output shell completion code for the specified shell (bash or zsh)","","Other Commands:"," api-resources Print the supported API resources on the server"," api-versions Print the supported API versions on the server, in the form of \"group/version\""," config Modify kubeconfig files"," plugin Provides utilities for interacting with plugins"," version Print the client and server version information","","Usage:"," kubectl [flags] [options]","","Use \"kubectl \u003ccommand\u003e --help\" for more information about a given command.","Use \"kubectl options\" for a list of global command-line options (applies to all commands).",""]'</span></pre></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><p id="3c71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是如何从工作流程中运行<code class="du je jf jg jh b">gcloud</code>和<code class="du je jf jg jh b">kubectl</code>命令的示例。然而，这里有一个更大的模式。任何可以在容器中运行的工具都有可能通过云构建步骤从工作流中调用。<strong class="ih hj">这是一个巨大的商机，带来了很多机会！</strong></p><p id="c8ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢我们的工作流程产品经理<a class="ae jd" href="https://twitter.com/KrisABraun" rel="noopener ugc nofollow" target="_blank"> Kris Braun </a>，感谢他的创意和样品的初始原型。如有问题或反馈，请随时在Twitter上联系我<a class="ae jd" href="https://twitter.com/meteatamel" rel="noopener ugc nofollow" target="_blank"> @meteatamel </a>。</p></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><p id="b6ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lk">最初发布于</em><a class="ae jd" href="https://atamel.dev/posts/2022/10-17_executing_commands_from_workflows/" rel="noopener ugc nofollow" target="_blank"><em class="lk">https://atamel . dev</em></a><em class="lk">。</em></p></div></div>    
</body>
</html>