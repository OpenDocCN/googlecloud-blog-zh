<html>
<head>
<title>Importing data from GCS to MongoDB using Dataproc Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dataproc Serverless将数据从GCS导入MongoDB</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/importing-data-from-gcs-to-mongodb-using-dataproc-serverless-fed58904633a?source=collection_archive---------0-----------------------#2022-07-27">https://medium.com/google-cloud/importing-data-from-gcs-to-mongodb-using-dataproc-serverless-fed58904633a?source=collection_archive---------0-----------------------#2022-07-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ca2fee85d2e0c3497782245367c8aae3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*M3kTjIfV3cyv0vYf.png"/></div></div></figure><p id="e341" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在运行Spark作业的同时管理服务器始终是一项挑战。对Spark作业使用完全托管的按需服务器是当今时代的需要。它帮助开发人员专注于核心应用程序逻辑，而不是花时间管理框架。Dataproc Serverless就是Google云平台提供的一个这样的产品。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es jo"><img src="../Images/ff2c6315f7b242982c906ab3f0dafad5.png" data-original-src="https://miro.medium.com/v2/resize:fit:916/format:webp/0*BEqcuOwmVT_n4Hf1.png"/></div></figure><p id="ae92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当今世界正在转向基于云的存储服务来存储数据。它引发了谷歌云存储桶的使用。不管数据的文件格式如何，都可以很容易地将数据存储在GCS桶中。这是一种非常经济高效的存储大型数据文件的方式，尤其是当数据以TB为单位时。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es jt"><img src="../Images/1f1ba9a95d9cba0f74138890e0e5ab58.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/format:webp/0*WOZpzTGfykNqxEun.png"/></div></figure><p id="6634" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">NoSQL数据库目前需求量很大。其中MongoDB非常有名。MongoDB基本上是一个面向文档的数据库，以BSON(二进制JSON)的形式写数据。</p><p id="e2d1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用MongoDB的一个主要原因是为了处理大规模的非结构化数据。因此，从基于云的技术向MongoDB导入数据是一个非常常见的用例。但是，如果，输入格式和JSON结构不一样。在这种情况下，本文将帮助您通过Dataproc Serverless将数据从GCS Buckets导入MongoDB集合，而不管它们的文件格式。</p><h1 id="e995" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">主要优势</h1><ol class=""><li id="e10b" class="ks kt hi is b it ku ix kv jb kw jf kx jj ky jn kz la lb lc bi translated">使用<strong class="is hj"> Dataproc无服务器</strong>运行Spark批处理工作负载，无需管理Spark框架。批量大小也可以在该模板中配置。</li><li id="225e" class="ks kt hi is b it ld ix le jb lf jf lg jj lh jn kz la lb lc bi translated"><a class="ae li" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/python/dataproc_templates/gcs/README.md" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> GCSToMONGO </strong> </a>模板是开源的，配置驱动的，随时可以使用。执行代码只需要MongoDB和GCS凭证。</li><li id="61f7" class="ks kt hi is b it ld ix le jb lf jf lg jj lh jn kz la lb lc bi translated">支持的文件格式有JSON、Avro、Parquet和CSV。</li></ol><h1 id="a223" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">使用</h1><p id="051a" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">1.为jar文件创建一个GCS存储桶和暂存位置。</p><p id="58d9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.在预装了<a class="ae li" href="https://cloud.google.com/shell/docs/how-cloud-shell-works" rel="noopener ugc nofollow" target="_blank">各种工具</a>的云壳中克隆git repo。或者使用任何预装JDK 8+，Maven和Git的机器。</p><pre class="jp jq jr js fd lm ln lo lp aw lq bi"><span id="9071" class="lr jv hi ln b fi ls lt l lu lv">git clone <a class="ae li" href="https://github.com/GoogleCloudPlatform/dataproc-templates.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/dataproc-templates.git</a><br/>cd dataproc-templates/python</span></pre><p id="e9cf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.获取身份验证凭据(以提交作业)。</p><pre class="jp jq jr js fd lm ln lo lp aw lq bi"><span id="5779" class="lr jv hi ln b fi ls lt l lu lv">gcloud auth application-default login</span></pre><p id="de74" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.执行GCSToJDBC模板。<br/>例如:</p><pre class="jp jq jr js fd lm ln lo lp aw lq bi"><span id="67ce" class="lr jv hi ln b fi ls lt l lu lv">export GCP_PROJECT=my-gcp-project<br/>export REGION=us-central1<br/>export GCS_STAGING_LOCATION=gs://staging-bucket<br/>export JARS="gs://jar_location/mongo-java-driver-3.9.1.jar,gs://jar_location/mongo-spark-connector_2.12-2.4.0.jar"</span><span id="6837" class="lr jv hi ln b fi lw lt l lu lv">./bin/start.sh \<br/>-- --template=GCSTOMONGO \<br/>--gcs.mongo.input.format="avro" \<br/>--gcs.mongo.input.location="gs://GCS_Bucket_Name/empavro" \<br/>--gcs.mongo.output.uri="mongodb://1.2.3.45:27017" \<br/>--gcs.mongo.output.database="demo" \<br/>--gcs.mongo.output.collection="analysis" \<br/>--gcs.mongo.output.mode="overwrite"</span></pre><p id="22c3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意</strong>:如果尚未启用，它会要求您启用Dataproc Api。</p><h1 id="a198" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">计划批处理作业</h1><p id="cac6" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">GCP原生提供云调度器+云功能，可用于提交spark批处理作业。或者自我管理的软件，如linux cron tab，Jenkins等。也可以使用。</p><h1 id="02e5" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">利用大规模数据优化性能</h1><p id="135f" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">对于数据工程师来说，处理大规模数据(以TB为单位)无疑是一个挑战。但是，这个编码模板也提供了解决方案。有一个可选参数“批处理大小”，可以根据数据大小进行调整。批处理大小是驱动程序一次从服务器请求的文档数量。默认情况下，MongoDB提供的批量大小是512。</p><pre class="jp jq jr js fd lm ln lo lp aw lq bi"><span id="76e7" class="lr jv hi ln b fi ls lt l lu lv">--gcs.mongo.batch.size=512</span></pre><h1 id="979d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">设置附加火花属性</h1><p id="232e" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">如果您需要<a class="ae li" href="https://cloud.google.com/dataproc-serverless/docs/concepts/properties" rel="noopener ugc nofollow" target="_blank">指定Dataproc无服务器支持的spark属性</a>,比如调整驱动程序、内核、执行器等的数量。</p><p id="267f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以编辑start.sh文件中的<a class="ae li" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/bin/start.sh#L50" rel="noopener ugc nofollow" target="_blank"> OPT_PROPERTIES </a>值。</p><p id="5026" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">参考资料</strong><br/><a class="ae li" rel="noopener" href="/google-cloud/importing-data-from-gcs-to-databases-via-jdbc-using-dataproc-serverless-7ed75eab93ba">https://medium . com/Google-cloud/importing-data-from-GCS-to-databases-via-JDBC-using-data proc-server less-7ed 75 eab 93 ba</a><br/><a class="ae li" href="https://github.com/GoogleCloudPlatform/dataproc-templates" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/dataproc-templates</a></p></div></div>    
</body>
</html>