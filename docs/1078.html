<html>
<head>
<title>How to load GeoJSON files into BigQuery GIS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将GeoJSON文件加载到BigQuery GIS中</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-load-geojson-files-into-bigquery-gis-9dc009802fb4?source=collection_archive---------0-----------------------#2019-07-17">https://medium.com/google-cloud/how-to-load-geojson-files-into-bigquery-gis-9dc009802fb4?source=collection_archive---------0-----------------------#2019-07-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="60bb" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">GeoJSON到BigQuery的ETL管道</h2></div><p id="f9ec" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">虽然本教程专门针对欧洲行政区域的GeoJSON文件，但我希望您能够将其用作其他数据源的指南。在<a class="ae jt" href="https://console.cloud.google.com/cloudshell" rel="noopener ugc nofollow" target="_blank"> CloudShell </a>或任何安装了Google Cloud SDK和Python3的机器上做这件事。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ju"><img src="../Images/4f39d761919614b4c6808aa7e9b706ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rGpJnxrKq7wo65ayECNHbg.png"/></div></div><figcaption class="kg kh et er es ki kj bd b be z dx translated">要查询多边形边界，请将欧洲行政区域的GeoJSON加载到BigQuery中</figcaption></figure><p id="dab3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先从<a class="ae jt" href="https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statistical-units/nuts#nuts16" rel="noopener ugc nofollow" target="_blank">欧盟统计局网站</a>下载你感兴趣的文件:</p><pre class="jv jw jx jy fd kk kl km kn aw ko bi"><span id="3082" class="kp kq hi kl b fi kr ks l kt ku">wget https://ec.europa.eu/eurostat/cache/GISCO/distribution/v2/nuts/download/ref-nuts-2016-01m.geojson.zip</span></pre><p id="c6aa" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，将其解压缩以获得感兴趣的GeoJSON文件。</p><pre class="jv jw jx jy fd kk kl km kn aw ko bi"><span id="75b2" class="kp kq hi kl b fi kr ks l kt ku">mkdir tmp<br/>cd tmp<br/>unzip ../ref-nuts-2016-01m.geojson.zip</span></pre><p id="9e9c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">GeoJSON文件包含一个几何要素列表和每个几何的一些属性。BigQuery需要换行符分隔的JSON文件，其中几何列是单个字符串。</p><p id="5d53" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是一个将进行必要转换的Python程序(注意，文件名对应于EPSG::4326版本—这些是用经度/纬度坐标表示的版本):</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="07af" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是JSON文件中的一行代码:</p><pre class="jv jw jx jy fd kk kl km kn aw ko bi"><span id="7d4f" class="kp kq hi kl b fi kr ks l kt ku">{"geometry": "{\"type\": \"LineString\", \"coordinates\": [[25.4907, 35.29833], [25.49187, 35.28897], [25.50206, 35.28633], [25.50528, 35.273], [25.49648, 35.2621], [25.49437, 35.24823], [25.49879, 35.24146], [25.51013, 35.23245], [25.51199, 35.22759], [25.49429, 35.22849], [25.47941, 35.22515], [25.47122, 35.21485], [25.46806, 35.21088], [25.4512, 35.20152], [25.43949, 35.20199], [25.42395, 35.21019], [25.41463, 35.20585], [25.41267, 35.20494], [25.41331, 35.19424], [25.41463, 35.19189], [25.41792, 35.18603], [25.41463, 35.18273], [25.39944, 35.16751], [25.40761, 35.15651], [25.41199, 35.15531], [25.40992, 35.13521], [25.41463, 35.13308], [25.42063, 35.13035], [25.42306, 35.12754], [25.42105, 35.11549], [25.4345, 35.11028], [25.44723, 35.11027], [25.46348, 35.09302], [25.47211, 35.08832], [25.50064, 35.08005], [25.5182, 35.0656], [25.50834, 35.05567], [25.49872, 35.05048], [25.49786, 35.0427], [25.50702, 35.03823], [25.52577, 35.03663], [25.52902, 35.02909], [25.53016, 35.02644], [25.54641, 35.01885], [25.54925, 35.00995], [25.54713, 34.99973], [25.55057, 34.99076]]}", "EU_FLAG": "T", "CC_FLAG": "F", "OTHR_CNTR_FLAG": "F", "LEVL_CODE": 3, "FID": 102, "EFTA_FLAG": "F", "COAS_FLAG": "F", "NUTS_BN_ID": 102}</span></pre><p id="3cfb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">程序打印的结果模式是:</p><pre class="jv jw jx jy fd kk kl km kn aw ko bi"><span id="10ef" class="kp kq hi kl b fi kr ks l kt ku">geometry:GEOGRAPHY,EU_FLAG,CC_FLAG,OTHR_CNTR_FLAG,LEVL_CODE:int64,FID:int64,EFTA_FLAG,COAS_FLAG,NUTS_BN_ID:int64</span></pre><p id="4a9b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，将新行分隔的JSON加载到BigQuery中(适当地更改数据集和表名):</p><pre class="jv jw jx jy fd kk kl km kn aw ko bi"><span id="ba5b" class="kp kq hi kl b fi kr ks l kt ku">bq load --source_format NEWLINE_DELIMITED_JSON advdata.eurostat to_load.json geometry:GEOGRAPHY,EU_FLAG,CC_FLAG,OTHR_CNTR_FLAG,LEVL_CODE:int64,FID:int64,EFTA_FLAG,COAS_FLAG,NUTS_BN_ID:int64</span></pre><p id="e704" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">就是这样！尝试一个查询，根据多边形与德国法兰克福的距离对其进行排序:</p><pre class="jv jw jx jy fd kk kl km kn aw ko bi"><span id="e884" class="kp kq hi kl b fi kr ks l kt ku">SELECT <br/>  * EXCEPT(geometry)<br/>  , ST_Centroid(geometry) AS center<br/>  , ST_Distance(geometry, ST_GeogPoint(8.68, 50.11))/1000 AS dist<br/>FROM advdata.eurostat<br/>ORDER by dist ASC<br/>LIMIT 5</span></pre><p id="d5f8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将返回:</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es kx"><img src="../Images/37932856a521479ae473932d5680fe4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XcvWyrNM0FLPUL3oKDyJlw.png"/></div></div></figure><p id="f915" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">尽情享受吧！</p></div></div>    
</body>
</html>