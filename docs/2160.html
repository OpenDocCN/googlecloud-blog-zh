<html>
<head>
<title>GCP BigLake introduction</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP大湖游戏攻略</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-biglake-introduction-570fb88be132?source=collection_archive---------0-----------------------#2022-04-15">https://medium.com/google-cloud/gcp-biglake-introduction-570fb88be132?source=collection_archive---------0-----------------------#2022-04-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/24a8ef97a83a5ccd81bfb561d7793780.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F-_hHomhWbzEckAFjSEdRg.png"/></div></div></figure><p id="2b27" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">BigLake是Google给一个底层数据访问引擎起的名字，该引擎用于访问以BigQuery或结构化格式存储在Google Cloud Storage (GCS)上的数据。其概念是数据所有者将他们的数据存储在数据仓库(例如BigQuery)或数据湖(例如GCS)中。由于数据存储在不同的位置，这些数据的访问模式和属性也不同。例如，人们可以对存储在数据仓库中的数据做一些事情，而不能对存储在数据湖中的数据做一些事情。BigLake提供了一个平台，通过提供单个接口和语义来访问数据，而不管数据物理上位于何处或使用什么格式来存储数据，从而实现统一性和通用性。</p><p id="5f45" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谷歌在2022年4月发布了BigLake功能的初始版本。您应该不断地检查文档，看看添加或更改了什么。</p><p id="4b3d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是我对大湖的看法。它从存储在BigQuery和GCS中的数据开始。在GCS中，数据应该采用结构化格式，如CSV、JSON、Parquet、ORC和Avro。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jo"><img src="../Images/582fe1ac8003ddfd1733cc571fc3f45b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VB-6MG_qaovvvmLk"/></div></div></figure><p id="937c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们可以定义到底层数据的映射，以通过BigLake公开它。访问映射将通过BigQuery进行。让我们解开这个概念。假设您有属于BigQuery的表。在这种情况下，不需要做什么，因为您已经可以立即访问表中的数据。现在想象另一种情况，在GCS中将数据存储为对象。我们现在要做的是创建一个看起来像BigQuery的表，但是将该表的数据源指向底层的GCS存储。一旦完成，我们就能够从这个BigQuery表中查询或检索数据，BigLake负责检索和提供数据。在这里暂停一下，我们现在看到我们可以使用BigQuery接口访问数据，而不再需要立即知道数据实际驻留在哪里。对于我们这些消费者来说，数据是在原生BigQuery表中还是作为对象存储在云存储中是隐藏的。</p><p id="eab2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Apache Spark等各种数据处理系统都有针对BigQuery 的<a class="ae jt" href="https://cloud.google.com/dataproc/docs/tutorials/bigquery-connector-spark-example" rel="noopener ugc nofollow" target="_blank">连接器。这意味着我们可以将BigLake前端数据呈现给任何可以从BigQuery接口消费的东西。</a></p><p id="c00b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你精通BigQuery，你现在可能正在挠头。您可能会说“BigQuery不是已经以<a class="ae jt" href="https://cloud.google.com/bigquery/docs/external-tables" rel="noopener ugc nofollow" target="_blank">外部表</a>的形式拥有这个概念了吗？”你是绝对正确的。外部表的想法伴随BigQuery已经有一段时间了。就像BigLake一样，外部表为存储在BigQuery之外的底层数据提供了BigQuery接口，包括GC、Drive、Google Sheets等等。BigLake <em class="ju">目前</em>提供的是一个替代接口，旨在提供一个统一的数据仓库/数据湖接口。在最初的一组BigLake函数中，我们得到了BigQuery外部表不可能得到的直接好处…我们有机会在行和列级别执行更细粒度的安全性。为了让这个概念变得清晰，我们现在可以将结构化数据存储在GCS中，这样对特定行或列的访问就可以被限制在授权的请求上。这个功能以前只适用于以本机格式存储的数据和由BigQuery专门管理的存储。</p><p id="b84f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">与外部表的另一个区别是，要查询映射到外部源的BigQuery表，提交查询的身份通常需要对底层数据源具有读取权限。例如，映射到GCS对象的外部表将要求执行查询的身份需要表权限<strong class="is hj">和</strong>对应的GCS对象权限。通过使用BigLake，我们授权BigLake拥有GCS对象权限，然后运行查询的身份就可以根据BigQuery权限被排他地允许或拒绝。</p><p id="7207" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们浏览一下BigLake的一些用法，看看这个故事的实际应用。</p><ol class=""><li id="7cb8" class="jv jw hi is b it iu ix iy jb jx jf jy jj jz jn ka kb kc kd bi translated">创建一个GCP项目，并记下其项目编号。我们将使用它作为GCS存储桶的唯一id。</li><li id="1558" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn ka kb kc kd bi translated">启用以下GCP API(如果尚未启用)</li></ol><ul class=""><li id="b858" class="jv jw hi is b it iu ix iy jb jx jf jy jj jz jn kj kb kc kd bi translated">BigQuery连接API</li></ul><p id="948a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.创建一个名为<code class="du kk kl km kn b">[PROJECT_NUMBER]-biglake</code>的GCS bucket，并在<code class="du kk kl km kn b">us-east1</code>中创建。</p><p id="fbd5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.创建包含CSV数据的本地文件。在这个例子中，我们称我们的文件为<code class="du kk kl km kn b">data.csv</code>，它包含:</p><pre class="jp jq jr js fd ko kn kp kq aw kr bi"><span id="01e6" class="ks kt hi kn b fi ku kv l kw kx">country,product,price<br/>US,phone,100<br/>JP,tablet,300<br/>UK,laptop,200</span></pre><p id="158b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将此文件上传到GCS存储桶:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ky"><img src="../Images/464d48b3b839792e6896cc143f116dcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1qpNvphqA7-iFLvP"/></div></div></figure><p id="f650" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.在GCP控制台中打开BigQuery工作台</p><p id="cfc4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.点击<code class="du kk kl km kn b">+ ADD DATA</code>，然后点击<code class="du kk kl km kn b">External data source</code></p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es kz"><img src="../Images/c7a6d6f4317d7ff6498f56e5328b6a1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:562/0*dILc6EWm-sO6vIzB"/></div></figure><p id="1ecc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将在右侧弹出一个面板。</p><p id="8e98" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">7.填写外部数据源面板</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es la"><img src="../Images/c2927eaf59f54bd8ebd6293f83d3c872.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yYX6csaqsRKfXrOP"/></div></div></figure><p id="f0f6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">8.打开新添加的外部连接的连接详细信息</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lb"><img src="../Images/3b6f5ca61658b102b88b0f0877e35958.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vVvRiEMCYbPbeHM_"/></div></div></figure><p id="cbc5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">记下生成的服务帐户(服务帐户ID)。</p><p id="98cf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">9.授予服务帐户读取GCS存储桶的权限。通过授予它<code class="du kk kl km kn b">Storage Object Viewer</code>角色。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lc"><img src="../Images/478596c5f6c06b3cf5d6fef9c922afc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IfOmDQoBOi6ayykb"/></div></div></figure><p id="2a96" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">10.创建大查询数据集:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ld"><img src="../Images/183db5f2c10ea6db3a30e6fdf9e73f52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ormzim_9PzmQREBT"/></div></div></figure><p id="79f6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">11.在新数据集中创建一个BigLake表:</p><p id="7d2f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们选择数据集，然后从其菜单中选择<code class="du kk kl km kn b">Create table</code>:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es le"><img src="../Images/3e624e2d2639821f412aaa2413980e1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/0*XHXI5p99x4GtfpQR"/></div></figure><p id="8548" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在出现的面板中，我们选择:</p><ul class=""><li id="1b53" class="jv jw hi is b it iu ix iy jb jx jf jy jj jz jn kj kb kc kd bi translated">数据的来源应该是谷歌云存储</li><li id="7e22" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kj kb kc kd bi translated">应该从中检索数据的GCS对象</li><li id="e4bf" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kj kb kc kd bi translated">文件格式为CSV</li><li id="2704" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kj kb kc kd bi translated">我们希望创建的BigQuery表的名称。在这个例子中，我们称之为<code class="du kk kl km kn b">biglake</code></li><li id="2087" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kj kb kc kd bi translated">用于创建基于BigLake的表并使用连接id的复选框。这就是<strong class="is hj">核心</strong>概念。</li></ul><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lf"><img src="../Images/fa428b15145972ef2f946a35e244a295.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*d1IYk-E_LjNK3lvj"/></div></div></figure><p id="b6c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建表后，我们可以看到它的定义。注意，它被标记为<code class="du kk kl km kn b">BigLake</code>。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lg"><img src="../Images/fec155d8ad360a6dad711fa29f87c515.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1_jqKBa15_HHnhSB"/></div></div></figure><p id="3509" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">12.运行简单的查询</p><p id="5a2b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们现在从BigQuery工作台中运行一个查询，我们会看到有数据返回。如果我们要更改GCS中的CSV文件，我们会发现后续的查询会返回最新的数据。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lh"><img src="../Images/b9c34c6c5abbb76aa84ff32f28ce5712.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ja_3ecvQxcjYXVq3"/></div></div></figure><p id="f954" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">13.应用行级安全策略。</p><p id="ad1b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们想测试行级安全性。为此，我们运行以下SQL语句:</p><pre class="jp jq jr js fd ko kn kp kq aw kr bi"><span id="8ae5" class="ks kt hi kn b fi ku kv l kw kx">CREATE OR REPLACE ROW ACCESS POLICY mypolicy ON biglake.datatable<br/>GRANT TO (“user:[YOUR IDENTITY]”)<br/>FILTER USING (country = “US”);</span></pre><p id="2073" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你必须在<code class="du kk kl km kn b">GRANT TO</code>部分改变你自己的身份。</p><p id="17b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">14.重新运行数据访问</p><p id="1eda" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这一次，我们看到我们只能看到我们有权看到的行。这表明行级安全性现在已经生效。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es li"><img src="../Images/260067865a8b06ef8c5bd21bbe2a32d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fRWkFKjyyXxJVQbK"/></div></div></figure><p id="c171" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于BigQuery外部表，这不是我们可以使用的选项；我们只能用大湖技术来实现。</p><p id="0c2f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们要在GCS中的CSV文件中添加一个新行，允许我们查询它，那么它确实会被返回:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es lj"><img src="../Images/85b119319382656ff9b37c8915ddb16b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/0*IqQeARO0IVSWAbOL"/></div></figure><p id="3b67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">到目前为止，我们已经展示了通过BigQuery查询来访问BigLake表，但是我们也可以通过Spark等其他技术来访问BigLake表。例如，下面是一个Spark片段，它查询一个BigLake表:</p><pre class="jp jq jr js fd ko kn kp kq aw kr bi"><span id="1194" class="ks kt hi kn b fi ku kv l kw kx">from pyspark.sql import SparkSession<br/>spark = SparkSession.builder \<br/> .appName(‘BigLake Query’) \<br/> .config(‘spark.jars’, ‘gs://spark-lib/bigquery/spark-bigquery-with-dependencies_2.12–0.24.2.jar’) \<br/> .getOrCreate()<br/>df = spark.read \<br/> .format(‘bigquery’) \<br/> .load(‘biglake.datatable’)<br/>df.show()</span></pre><p id="6058" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后……一段视频带我们浏览了本文中讨论的一些项目。</p><figure class="jp jq jr js fd ij"><div class="bz dy l di"><div class="lk ll l"/></div></figure><h1 id="71b8" class="lm kt hi bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">参考</h1><ul class=""><li id="4123" class="jv jw hi is b it mj ix mk jb ml jf mm jj mn jn kj kb kc kd bi translated"><a class="ae jt" href="https://cloud.google.com/blog/products/data-analytics/unifying-data-lakes-and-data-warehouses-across-clouds-with-biglake" rel="noopener ugc nofollow" target="_blank">使用BigLake统一跨云的数据湖和数据仓库|谷歌云博客</a>—2022–04</li><li id="e544" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kj kb kc kd bi translated"><a class="ae jt" href="https://cloud.google.com/bigquery/docs/biglake-intro" rel="noopener ugc nofollow" target="_blank">big lake表介绍| BigQuery | Google Cloud </a></li><li id="1517" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kj kb kc kd bi translated"><a class="ae jt" href="https://cloud.google.com/bigquery/docs/external-tables" rel="noopener ugc nofollow" target="_blank">外部表| BigQuery |谷歌云</a></li><li id="5ad1" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kj kb kc kd bi translated">搅拌机图片:<a class="ae jt" href="https://www.blendswap.com/profile/152246" rel="noopener ugc nofollow" target="_blank"> shontoloyo </a></li></ul></div></div>    
</body>
</html>