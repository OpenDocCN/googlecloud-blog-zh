<html>
<head>
<title>Google Cloud IoT Core &amp; Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云物联网核心&amp; Golang</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-iot-core-golang-b130f65951ba?source=collection_archive---------0-----------------------#2018-04-18">https://medium.com/google-cloud/google-cloud-iot-core-golang-b130f65951ba?source=collection_archive---------0-----------------------#2018-04-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="3392" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">更新2018–04–19:</strong>mosquito现正在Omegas2上工作。更新见本文末尾。</p></blockquote><p id="b47c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">我有2x洋葱Omega2s三个，如果我能说服我的朋友埃里克把他那只快要落灰的捐出去。</p><blockquote class="if ig ih"><p id="5381" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">更新2018–04–18</strong>:谢谢Eric…我有3个洋葱Omega2s…</p></blockquote><p id="f539" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">昨天回顾欧米茄的开发者网站，我注意到<a class="ae jk" href="https://cloud.google.com" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a>不在为这些设备记录的<a class="ae jk" href="https://docs.onion.io/omega2-docs/connecting-to-cloud-platforms.html" rel="noopener ugc nofollow" target="_blank">云平台</a>列表中(当然它们都工作)。</p><p id="d046" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">这篇文章试图通过提供将Omega running <a class="ae jk" href="http://mqtt.org/" rel="noopener ugc nofollow" target="_blank"> MQTT </a>连接到谷歌云平台<a class="ae jk" href="https://cloud.google.com/iot-core/" rel="noopener ugc nofollow" target="_blank">物联网核心</a>的简单过程来解决这一缺点。毕竟，一致和安全地使用像MQTT这样的平台的一个优点是，所有好的云都集成了它(<a class="ae jk" href="https://cloud.google.com/iot/docs/how-tos/mqtt-bridge" rel="noopener ugc nofollow" target="_blank">链接</a>)。</p><h2 id="591b" class="jl jm hi bd jn jo jp jq jr js jt ju jv jh jw jx jy ji jz ka kb jj kc kd ke kf bi translated">设置</h2><p id="6cc6" class="pw-post-body-paragraph ii ij hi il b im kg io ip iq kh is it jh ki iw ix ji kj ja jb jj kk je jf jg hb bi translated">请遵循谷歌在<a class="ae jk" href="https://cloud.google.com/iot/docs/how-tos/devices" rel="noopener ugc nofollow" target="_blank">创建注册表和设备</a>下的指导。我的Omegas保留了它们最初的名称形式<code class="du kl km kn ko b">omega-XXXX</code>，因此我将它们用作云IoT设备id。</p><p id="d621" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">假设:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="9e0b" class="jl jm hi ko b fi kx ky l kz la">PROJECT=[[YOUR-PROJECT-ID]]<br/>REGION=[[YOUR-REGION]]             # us-central1<br/>REGISTRY=[[YOUR-REGISTRY-ID]]      # This is the short-from<br/>DEVICE=[[YOUR-DEVICE-ID]]          # mine are omega-XXXX<br/>TELEMETRY=[[YOUR-TELEMETRY-TOPIC]]<br/>STATE=[[YOUR-STATE-TOPIC]]</span><span id="952a" class="jl jm hi ko b fi lb ky l kz la">WORK_DIR=[[YOUR-WORKING-DIRECTORY]]</span></pre><p id="dc05" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">我为我的每台设备创建了一个自签名证书，并以设备命名。在这个过程中，我不清楚谷歌的文档，但是对于RS256，你会想要这个变体(<a class="ae jk" href="https://cloud.google.com/iot/docs/how-tos/credentials/keys#generating_an_rs256_key" rel="noopener ugc nofollow" target="_blank">链接</a>):</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="5643" class="jl jm hi ko b fi kx ky l kz la">mkdir ${WORK_DIR}/certs</span><span id="ca59" class="jl jm hi ko b fi lb ky l kz la">openssl req -x509 -nodes -newkey rsa:2048 \<br/>-keyout ${WORK_DIR}/certs/${DEVICE}.key.pem \<br/>-out ${DEVICE}.crt.pem \<br/>-days 365 \<br/>-subj "/CN=unused"</span></pre><p id="714b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">当您在云物联网核心中创建设备时，您应该选择<code class="du kl km kn ko b">RS256_X509</code>密钥格式:</p><figure class="kp kq kr ks fd ld er es paragraph-image"><div class="er es lc"><img src="../Images/01bcfffaa994c9a4e29dc7f1619b4cca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1042/format:webp/1*2sUiIoQRGjcX6xxtgQvzlg.png"/></div><figcaption class="lg lh et er es li lj bd b be z dx translated">选择“RS256_X509”</figcaption></figure><blockquote class="if ig ih"><p id="b00f" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj"> NB </strong>当你运行MQTT客户端代码时，如果你收到一个错误<code class="du kl km kn ko b">Unacceptable protocol version</code>很可能你的错误就在这一步。</p></blockquote><p id="b383" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">云物联网核心用<a class="ae jk" href="https://cloud.google.com/pubsub" rel="noopener ugc nofollow" target="_blank">云发布/订阅</a>支持MQTT。作为设置的一部分，您应该已经创建了<code class="du kl km kn ko b">telemetry</code>(数据)和<code class="du kl km kn ko b">config</code>(云发布/订阅)主题。</p><p id="ca1a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">发送到没有订阅的Pub/Sub主题的消息——就像没有人听到的森林中倒下的树——不会被听到，因为它们被丢弃了。因此，请为<code class="du kl km kn ko b">telemetry</code>主题创建一个订阅，以便当我们向MQTT发布消息时，这些消息在发送到Cloud Pub/Sub时不会被简单地丢弃:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="d812" class="jl jm hi ko b fi kx ky l kz la">SUB=[[YOUR-SUB-NAME]]<br/>gcloud pubsub subscriptions create ${SUB} \<br/>--topic=${TELEMETRY} \<br/>--project=${PROJECT}</span></pre><h2 id="17d5" class="jl jm hi bd jn jo jp jq jr js jt ju jv jh jw jx jy ji jz ka kb jj kc kd ke kf bi translated">戈朗</h2><p id="3ee6" class="pw-post-body-paragraph ii ij hi il b im kg io ip iq kh is it jh ki iw ix ji kj ja jb jj kk je jf jg hb bi translated">谷歌的云物联网文档不包括Golang样本:-(</p><p id="d726" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">这对我来说很重要，但是通过使用来自优秀的Golang <a class="ae jk" href="https://github.com/eclipse/paho.mqtt.golang" rel="noopener ugc nofollow" target="_blank">实现</a>的例子，来自<a class="ae jk" href="https://www.eclipse.org/paho/" rel="noopener ugc nofollow" target="_blank"> Eclipse Paho项目</a>的例子，观察Google的Python和Java是如何工作的，以及——不可否认的——一些试错，我让我的代码工作了。</p><p id="5e7b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">…然后才发现这个问题(<a class="ae jk" href="https://github.com/GoogleCloudPlatform/golang-samples/issues/267" rel="noopener ugc nofollow" target="_blank"> #267 </a>)和<code class="du kl km kn ko b">take-cheeze</code>的代码。我没有试过这个开发者的代码，所以不能证明它。</p><p id="93cc" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">这是我的:</p><figure class="kp kq kr ks fd ld"><div class="bz dy l di"><div class="lk ll l"/></div></figure><p id="bd08" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">这将受益于一系列的重构，但是出于演示的目的，我希望你能接受我的懒惰。这个代码是有效的。我最初包含了泛美卫生组织TLS样本中的一个部分，看起来是多余的，我删除了，但是…授权代码…只是唉。</p><p id="727a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">对我来说，真正的挑战是让MQTT auth工作。云物联网使用JWT作为密码值，而不是使用设备的私钥进行身份验证，JWT需要声明并由私钥签名。感谢<a class="ae jk" href="https://gist.github.com/troyk" rel="noopener ugc nofollow" target="_blank"> troyk </a>提供的这个样本，它给了我很大的帮助:</p><p id="7509" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><a class="ae jk" href="https://gist.github.com/troyk/3dcf2c39b38a4c21a0e63d8c8aa34123" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/troyk/3d cf 2c 39 b 38 a4 c21 a0e 63 D8 c8 aa 34123</a></p><p id="6c49" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">好了，注册表和设备创建完毕，证书添加完毕，样本代码在手。在我们继续之前，我们需要获取Google的CA根证书，请确保这些证书在<code class="du kl km kn ko b">${WORK_DIR}</code>中生效，或者在下一步运行<code class="du kl km kn ko b">main.go</code>时修改参考:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="fc90" class="jl jm hi ko b fi kx ky l kz la">wget <a class="ae jk" href="https://pki.google.com/roots.pem" rel="noopener ugc nofollow" target="_blank">https://pki.google.com/roots.pem</a></span></pre><p id="9122" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">然后:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="059b" class="jl jm hi ko b fi kx ky l kz la">PROJECT=[[YOUR-PROJECT-ID]]<br/>REGION=[[YOUR-REGION]]<br/>REGISTRY=[[YOUR-REGISTRY-ID]]<br/>DEVICE=[[YOUR-DEVICE-ID]]</span><span id="aad7" class="jl jm hi ko b fi lb ky l kz la">go run main.go \<br/>--device=${DEVICE} \<br/>--project=${PROJECT} \<br/>--registry=${REGISTRY} \<br/>--region=${REGION} \<br/>--ca_certs=./roots.pem \<br/>--private_key=${WORK_DIR}/certs/${DEVICE}.key.pem</span></pre><p id="b391" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">一切都好…</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="39fc" class="jl jm hi ko b fi kx ky l kz la">2018/04/17 16:41:24 [main] Entered<br/>2018/04/17 16:41:24 [main] Flags<br/>2018/04/17 16:41:24 [main] Loading Google's roots<br/>2018/04/17 16:41:24 [main] Creating TLS Config<br/>2018/04/17 16:41:24 [main] Creating MQTT Client Options<br/>2018/04/17 16:41:24 [main] Broker 'ssl://mqtt.googleapis.com:8883'<br/>2018/04/17 16:41:24 [main] Load Private Key<br/>2018/04/17 16:41:24 [main] Parse Private Key<br/>2018/04/17 16:41:24 [main] Sign String<br/>2018/04/17 16:41:24 [main] MQTT Client Connecting<br/>2018/04/17 16:41:24 [main] Creating Subscription<br/>2018/04/17 16:41:24 [main] Publishing Messages<br/>2018/04/17 16:41:24 [main] Publishing Message #0<br/>2018/04/17 16:41:24 [main] Publishing Message #1<br/>2018/04/17 16:41:24 [main] Publishing Message #2<br/>2018/04/17 16:41:24 [main] Publishing Message #3<br/>2018/04/17 16:41:24 [main] Publishing Message #4<br/>2018/04/17 16:41:24 [main] Publishing Message #5<br/>2018/04/17 16:41:24 [main] Publishing Message #6<br/>2018/04/17 16:41:24 [main] Publishing Message #7<br/>2018/04/17 16:41:24 [main] Publishing Message #8<br/>2018/04/17 16:41:24 [main] Publishing Message #9<br/>2018/04/17 16:41:24 [main] MQTT Client Disconnecting<br/>2018/04/17 16:41:24 [main] Exited</span></pre><p id="00cc" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">并且，因为您创建了云发布/订阅<code class="du kl km kn ko b">telemetry</code>主题的订阅。)收到这些消息后，让我们查询我们的订阅:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="9ed7" class="jl jm hi ko b fi kx ky l kz la">SUB_FULLNAME=projects/${PROJECT}/subscriptions/${SUB}</span><span id="9746" class="jl jm hi ko b fi lb ky l kz la">gcloud alpha pubsub subscriptions pull ${SUB_FULLNAME} \<br/>--project=${PROJECT} \<br/>--limit=100 \<br/>--format=json \<br/>| jq '.[].message | {message: .messageId, published: .publishTime}'<br/>{<br/>  "message": "75227281854397",<br/>  "published": "2018-04-17T23:41:24.861Z"<br/>}<br/>{<br/>  "message": "75223205524150",<br/>  "published": "2018-04-17T23:41:24.861Z"<br/>}<br/>{<br/>  "message": "75213539702562",<br/>  "published": "2018-04-17T23:25:10.488Z"<br/>}<br/>{<br/>  "message": "75213538986457",<br/>  "published": "2018-04-17T23:19:49.043Z"<br/>}<br/>{<br/>  "message": "75207087277457",<br/>  "published": "2018-04-17T23:11:33.648Z"<br/>}<br/>{<br/>  "message": "75207142600447",<br/>  "published": "2018-04-17T23:11:27.685Z"<br/>}</span></pre><p id="a87d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><strong class="il hj">注意</strong>您的数据会有所不同，但是您应该会收到一些(如果您多次拉取，不一定是10个)消息，这些消息具有与您运行代码时相对应的唯一的<code class="du kl km kn ko b">message</code>id和<code class="du kl km kn ko b">published</code>时间(UTC)。</p><p id="4ec6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">下一步是为Omega2编译Golang:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="c123" class="jl jm hi ko b fi kx ky l kz la">GOOS=linux \<br/>GOARCH=mipsle \<br/>go build -a -installsuffix cgo -o cloudiot-golang-mqtt</span></pre><p id="46ce" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">使用设备的(！)ssh密钥或您的首选用户名|密码:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="f2be" class="jl jm hi ko b fi kx ky l kz la">BIN=./cloudiot-golang-mqtt<br/>GOO=./roots.pem<br/>KEY=${WORK_DIR}/certs/${DEVICE}.key.pem</span><span id="4728" class="jl jm hi ko b fi lb ky l kz la">for FILE in ${BIN} ${GOO} ${KEY}<br/>do<br/>  scp -i ~/.ssh/[[DEVICE-SSH-KEY]] \<br/>    ${FILE} \<br/>    root@${DEVICE}.local:/<br/>done</span></pre><p id="49f3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">然后，在进入机器并对新位置和二进制文件名称做了一些小的改动之后:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="ec07" class="jl jm hi ko b fi kx ky l kz la">PROJECT=[[YOUR-PROJECT-ID]]<br/>REGION=[[YOUR-REGION]]<br/>REGISTRY=[[YOUR-REGISTRY-ID]]<br/>DEVICE=[[YOUR-DEVICE-ID]]</span><span id="1fa8" class="jl jm hi ko b fi lb ky l kz la">./cloudiot-golang-mqtt \<br/>--device=${DEVICE} \<br/>--project=${PROJECT} \<br/>--registry=${REGISTRY} \<br/>--region=${REGION} \<br/>--ca_certs=./roots.pem \<br/>--private_key=./${DEVICE}.key.pem</span></pre><p id="83e4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">应该(！)工作……你的作者承认还没有尝试过这个…明天我在欧米茄上尝试过之后会更新这个。</p><p id="b891" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><strong class="il hj">更新</strong>:有效。太好了！</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="c27d" class="jl jm hi ko b fi kx ky l kz la">2018/04/18 04:08:23 [main] Entered<br/>2018/04/18 04:08:23 [main] Flags<br/>2018/04/18 04:08:23 [main] Loading Google's roots<br/>2018/04/18 04:08:23 [main] Creating TLS Config<br/>2018/04/18 04:08:23 [main] Creating MQTT Client Options<br/>2018/04/18 04:08:23 [main] Broker 'ssl://mqtt.googleapis.com:8883'<br/>2018/04/18 04:08:23 [main] Load Private Key<br/>2018/04/18 04:08:23 [main] Parse Private Key<br/>2018/04/18 04:08:23 [main] Sign String<br/>2018/04/18 04:08:24 [main] MQTT Client Connecting<br/>2018/04/18 04:08:25 [main] Creating Subscription<br/>2018/04/18 04:08:25 [main] Publishing Messages<br/>2018/04/18 04:08:25 [main] Publishing Message #0<br/>2018/04/18 04:08:25 [main] Publishing Message #1<br/>2018/04/18 04:08:25 [main] Publishing Message #2<br/>2018/04/18 04:08:25 [main] Publishing Message #3<br/>2018/04/18 04:08:25 [main] Publishing Message #4<br/>2018/04/18 04:08:25 [main] Publishing Message #5<br/>2018/04/18 04:08:25 [main] Publishing Message #6<br/>2018/04/18 04:08:25 [main] Publishing Message #7<br/>2018/04/18 04:08:25 [main] Publishing Message #8<br/>2018/04/18 04:08:25 [main] Publishing Message #9<br/>2018/04/18 04:08:25 [main] MQTT Client Disconnecting<br/>2018/04/18 04:08:25 [main] Done</span></pre><h2 id="d740" class="jl jm hi bd jn jo jp jq jr js jt ju jv jh jw jx jy ji jz ka kb jj kc kd ke kf bi translated">洋葱的awsiot_setup.sh</h2><blockquote class="if ig ih"><p id="d647" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">更新2018–04–19:</strong>更新解决方案见帖子末尾。我尝试使用MQTT代理就是一个缺陷，解决方案只使用了<code class="du kl km kn ko b">mosquitto_pub</code>和<code class="du kl km kn ko b">mosquitto_sub</code>。请忽略这里的bash脚本，但我们将继续使用Golang <code class="du kl km kn ko b">makejwt</code>。</p></blockquote><p id="b97a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><a class="ae jk" href="https://raw.githubusercontent.com/OnionIoT/Onion-Scripts/master/awsiot_setup.sh" rel="noopener ugc nofollow" target="_blank"> O </a> nion提供了一个“单命令AWS物联网设置”<a class="ae jk" href="https://raw.githubusercontent.com/OnionIoT/Onion-Scripts/master/awsiot_setup.sh" rel="noopener ugc nofollow" target="_blank">脚本</a>，它将有助于转换到GCP。该脚本将我们之前在Golang代码中使用的值作为参数，安装各种Mosquitto组件，并生成一个包含主题引用的<code class="du kl km kn ko b">mosquitto.conf</code>文件。</p><p id="f430" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">这个脚本给我们带来的挑战是，AWS使用X509证书认证，而GCP要求用户名|密码使用从设备的私钥和时间戳声明导出的JWT作为密码。</p><p id="8d8b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">因为我们在Golang中已经有了这个功能，所以将它重新用于bash脚本是有意义的。</p><p id="a187" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">一项正在进行的工作！</p><p id="7344" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">gcpiot_setup.sh:</p><figure class="kp kq kr ks fd ld"><div class="bz dy l di"><div class="lk ll l"/></div></figure><p id="6ea9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">好吧，这可能真的有效！:-)我尝试使用OpenWRT容器在我的Debian工作站上运行，但是遇到了挑战(我做错了什么？)安装<code class="du kl km kn ko b">mosquitto-ssl</code>。我切换到一个Ubuntu容器，它看起来工作正常，所以我有理由相信脚本工作正常。</p><p id="f98d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">我重新设计了生成jwt的Golang代码，以便在bash脚本中使用这一功能。所以，你需要:</p><figure class="kp kq kr ks fd ld"><div class="bz dy l di"><div class="lk ll l"/></div></figure><p id="5bfb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">像前面一样为Omega2设备构建这个:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="19fc" class="jl jm hi ko b fi kx ky l kz la">GOOS=linux \<br/>GOARCH=mipsle \<br/>go build -a -installsuffix cgo -o makejwt</span></pre><p id="be7a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">并像复制其他文件一样将其复制到设备:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="10c6" class="jl jm hi ko b fi kx ky l kz la">BIN=./makejwt<br/>KEY=${WORK_DIR}/certs/${DEVICE}.key.pem</span><span id="a385" class="jl jm hi ko b fi lb ky l kz la">for FILE in ${BIN} ${GOO} ${KEY}<br/>do<br/>  scp -i ~/.ssh/[[DEVICE-SSH-KEY]] \<br/>    ${FILE} \<br/>    root@${DEVICE}.local:/<br/>done</span></pre><blockquote class="if ig ih"><p id="765c" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">NB</strong>bash脚本获取Google的CA根证书，这样你就不需要把它们复制到设备上了。</p><p id="8de0" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj">NB</strong>bash脚本会为您执行<code class="du kl km kn ko b">makejwt</code>命令，因此您不需要运行这个命令，但是如果您想要确认它是否工作:</p></blockquote><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="a6bd" class="jl jm hi ko b fi kx ky l kz la">./makejwt \<br/>--duration=24 \<br/>--project=[[YOUR-PROJECT-ID]] \<br/>--private_key=/${DEVICE}.key.pem</span></pre><p id="9c13" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">在设备上创建脚本，从你的工作站复制或者从上面的要点复制。您将需要<code class="du kl km kn ko b">chmod +x gcpiot_setup.sh</code>以便可以执行它。执行它并响应提示。您应该会看到类似于以下内容的输出:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="27e1" class="jl jm hi ko b fi kx ky l kz la">Getting Google's CA Root Certificate<br/>--2018-04-18 16:50:53--  <a class="ae jk" href="https://pki.google.com/roots.pem" rel="noopener ugc nofollow" target="_blank">https://pki.google.com/roots.pem</a><br/>Backing up existing mosquitto.conf⟶moquitto.conf.180418165053.bak<br/>Creating JWT<br/>2018/04/18 16:50:53 [main] Entered<br/>2018/04/18 16:50:53 [main] Parse Flags<br/>2018/04/18 16:50:53 [main] Load Private Key<br/>2018/04/18 16:50:53 [main] Parse Private Key<br/>2018/04/18 16:50:53 [main] Sign String<br/>2018/04/18 16:50:53 [main] Exited<br/>Generating Mosquitto new config for Cloud IoT MQTT Bridge<br/>Restarting Mosquitto<br/> * Restarting network daemon: mosquitto</span></pre><p id="d983" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">如果一切顺利，您应该能够:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="63ac" class="jl jm hi ko b fi kx ky l kz la">service mosquitto status<br/> * mosquitto is running</span></pre><p id="9f32" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">而且，您应该能够:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="5617" class="jl jm hi ko b fi kx ky l kz la">DEVICE=[[YOUR-DEVICE-ID]]</span><span id="ca65" class="jl jm hi ko b fi lb ky l kz la">mosquitto_pub \<br/>--topic \/devices/${DEVICE}/events \<br/>--message '{"test": "Hello Henry!"}' \<br/>--qos 1</span></pre><p id="18cb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">这个不行:-(</p><p id="98ad" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">我会感谢一些MQTT大师。(本地)MQTT桥报告套接字错误。<code class="du kl km kn ko b">projects/...</code>云发布/订阅主题名称显示正确。</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="7e8f" class="jl jm hi ko b fi kx ky l kz la">mosquitto version 1.4.8 (build date Thu, 01 Mar 2018 09:34:49 -0500) starting<br/>Config loaded from /etc/mosquitto/mosquitto.conf.<br/>Opening ipv4 listen socket on port 1883.<br/>Opening ipv6 listen socket on port 1883.<br/>Bridge local.projects/$PROJECT/locations/$REGION/registries/$REGISTRY/devices/$DEVICE doing local SUBSCRIBE on topic \/devices/$DEVICE/events<br/>1524082272: Connecting bridge bridge-to-gcp (mqtt.googleapis.com:8883)<br/>1524082272: Bridge projects/$PROJECT/locations/$REGION/registries/$REGISTRY/devices/$DEVICE sending CONNECT<br/>1524082273: Socket error on client local.projects/$PROJECT/locations/$REGION/registries/$REGISTRY/devices/$DEVICE, disconnecting.<br/>1524082287: New connection from 127.0.0.1 on port 1883.</span></pre><p id="368a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">我做错了什么？</p><p id="9b6e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">我很有信心<code class="du kl km kn ko b">makejwt</code>能够工作，因为它与我在运行Golang客户端时能够显示的代码是相同的。错误出现在我对本地桥和远程桥之间的主题映射的配置中。</p><p id="87f4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">这肯定是在<code class="du kl km kn ko b">mosquitto.conf</code>中的东西，因为，如果我从新的Ubuntu容器开始，下面的工作:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="19fe" class="jl jm hi ko b fi kx ky l kz la">mosquitto_pub \<br/>--host mqtt.googleapis.com \<br/>--port 8883 \<br/>--id ${LONG_REGISTRY}/devices/${DEVICE} \<br/>--username unused \<br/>--pw ${PASSWORD} \<br/>--cafile /roots.pem \<br/>--tls-version tlsv1.2 \<br/>--protocol-version mqttv311 \<br/>--debug \<br/>--topic ${LONG_REGISTRY}/devices/${DEVICE}/events \<br/>--message "$(date +"%y%m%d%H%M%S") Hello Henry!"</span></pre><h2 id="f205" class="jl jm hi bd jn jo jp jq jr js jt ju jv jh jw jx jy ji jz ka kb jj kc kd ke kf bi translated">结论</h2><p id="49a9" class="pw-post-body-paragraph ii ij hi il b im kg io ip iq kh is it jh ki iw ix ji kj ja jb jj kk je jf jg hb bi translated">JWT和编写代码，munges证书和密钥… booh！</p><p id="d561" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">Golang，MQTT，Google Cloud IoT，Omegas …耶！希望如此！！</p><p id="5dff" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated"><strong class="il hj">更新:正在工作！！</strong></p><p id="8b6d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">感谢我的同事Calum让我走上了工作道路。Google Cloud IoT不支持分经纪人模式。因此，在Omega2s上，我们不需要MQTT代理服务。相反，我们将使用<code class="du kl km kn ko b">mosquitto_pub</code>和<code class="du kl km kn ko b">mosquitto_sub</code>。</p><p id="c5e5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">和以前一样，我们需要:</p><ul class=""><li id="a279" class="lm ln hi il b im in iq ir jh lo ji lp jj lq jg lr ls lt lu bi translated">Golang <code class="du kl km kn ko b">makejwt</code>双星</li><li id="0123" class="lm ln hi il b im lv iq lw jh lx ji ly jj lz jg lr ls lt lu bi translated"><code class="du kl km kn ko b">roots.pem</code></li><li id="9889" class="lm ln hi il b im lv iq lw jh lx ji ly jj lz jg lr ls lt lu bi translated">私人密钥</li></ul><p id="79fc" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">从您的主机上，将这些文件复制到Omega2:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="71ad" class="jl jm hi ko b fi kx ky l kz la">BIN=./makejwt<br/>GOO=./roots.pem<br/>KEY=${WORK_DIR}/certs/${DEVICE}.key.pem<br/>for FILE in ${BIN} ${GOO} ${KEY}<br/>do<br/>  scp -i ~/.ssh/[[DEVICE-SSH-KEY]] \<br/>    ${FILE} \<br/>    root@${DEVICE}.local:/<br/>done</span></pre><p id="8f00" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">然后，在Omega2上运行以下脚本来配置环境:</p><figure class="kp kq kr ks fd ld"><div class="bz dy l di"><div class="lk ll l"/></div></figure><p id="af44" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">这应该会向Google Cloud IoT发布一条消息(如果您愿意，可以重复<code class="du kl km kn ko b">mosquitto_pub</code>)。您可以通过使用以下命令检查遥测云发布/订阅主题上的订阅来确认这一点:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="f253" class="jl jm hi ko b fi kx ky l kz la">LONG_SUB=projects/${PROJECT}/subscriptions/${SUB}</span><span id="498d" class="jl jm hi ko b fi lb ky l kz la">gcloud alpha pubsub subscriptions pull ${LONG_SUB} \<br/>--project=${PROJECT} \<br/>--limit=100 \<br/>--format=json<br/>[<br/>  {<br/>    "ackId": "QV5AEkw-...",<br/>    "message": {<br/>      "attributes": {<br/>        "deviceId": "${DEVICE}",<br/>        "deviceNumId": "1234567890123456",<br/>        "deviceRegistryId": "${REGISTRY}",<br/>        "deviceRegistryLocation": "${REGION}",<br/>        "projectId": "${PROJECT}",<br/>        "subFolder": ""<br/>      },<br/>      "data": "SGVsbG8gSGVucnkh",<br/>      "messageId": "76695601755269",<br/>      "publishTime": "2018-04-20T03:30:27.780Z"<br/>    }<br/>  }<br/>]</span></pre><p id="cf94" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">并且，您可以尝试使用<code class="du kl km kn ko b">mosquitto_sub</code>阻塞订阅调用，并订阅<code class="du kl km kn ko b">/devices/${DEVICE}/config</code>上的MQTT主题:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="76b3" class="jl jm hi ko b fi kx ky l kz la">mosquitto_sub \<br/>--host mqtt.googleapis.com \<br/>--port 8883 \<br/>--id ${LONG_REGISTRY}/devices/${DEVICE} \<br/>--username unused \<br/>--pw ${PASSWORD} \<br/>--cafile /roots.pem \<br/>--tls-version tlsv1.2 \<br/>--protocol-version mqttv311 \<br/>--debug \<br/>--qos 1 \<br/>--topic /devices/${DEVICE}/config</span></pre><p id="bb3b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">在此命令等待期间，返回Google Cloud控制台，从“设备详细信息”中选择“更新配置”，然后向您的设备发送一些文本。或者:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="4928" class="jl jm hi ko b fi kx ky l kz la">gcloud iot devices configs update \<br/>--project=${PROJECT} \<br/>--region=${REGION} \<br/>--registry=${REGISTRY} \<br/>--device=${DEVICE} \<br/>--config-data="Testing Henry!"</span></pre><p id="a8bc" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">如果一切顺利，您应该会在Omega2的外壳上看到类似的内容:</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="9f71" class="jl jm hi ko b fi kx ky l kz la">Client projects/${PROJECT}/locations/${REGION}/registries/${REGISTRY}/devices/${DEVICE} sending PUBACK (Mid: 4)<br/>Testing Henry!</span></pre></div></div>    
</body>
</html>