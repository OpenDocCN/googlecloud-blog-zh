<html>
<head>
<title>How to Automate a Cloud Dataprep Pipeline When a File Arrives</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">当文件到达时，如何自动化云数据准备管道</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-automate-a-cloud-dataprep-pipeline-when-a-file-arrives-9b85f2745a09?source=collection_archive---------1-----------------------#2020-06-04">https://medium.com/google-cloud/how-to-automate-a-cloud-dataprep-pipeline-when-a-file-arrives-9b85f2745a09?source=collection_archive---------1-----------------------#2020-06-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a555" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">随着对云函数的更好掌握，当文件进入云存储桶时，您可以通过API触发Dataprep作业</em></p><p id="e7c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">曾经梦想过自动化整个数据管道来加载数据仓库吗？如果没有自动化，每个用户都需要手动上传数据，然后手动启动转换作业，或者等待预定任务在特定时间执行。这是非常繁琐和资源密集的。</p><p id="6376" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">阅读完本文后，您将能够在文件夹中拖放文件，在数据仓库中执行和加载整个数据管道，并且只需简单地点击几下，就可以在报告和仪表板中获得最新数据。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/98701b4145903a891f70f8043ef44ffe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yolrCtXAJ18gelNP.png"/></div></div></figure><p id="2a46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了说明这个概念，我们将以一家零售店为例，这家零售店希望每天用新客户的联系信息和客户职业更新其数据库。通过在每天结束时手动将新的客户文件上传到一个文件夹中，我们的目标是从在区域级别维护的Google表单中自动更新数据。</p><p id="e2fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文是一个循序渐进的指南，它将带您了解当一个新文件出现在<a class="ae jq" href="https://cloud.google.com/storage" rel="noopener ugc nofollow" target="_blank">云存储</a>文件夹中时，触发<a class="ae jq" href="https://cloud.google.com/dataprep" rel="noopener ugc nofollow" target="_blank">云数据准备</a>任务的过程。这是通过<a class="ae jq" href="https://cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">云函数</a>监控文件到达并调用云Dataprep API从Dataprep流中启动特定作业来实现的。</p><h2 id="faad" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated"><strong class="ak"> 1。入门</strong></h2><p id="0535" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">为了帮助您应用下面描述的过程，我们已经为您提供了尝试该过程所需的所有资源。<a class="ae jq" href="https://github.com/victorcouste/demo-trigger-dataprep-job-from-gcs" rel="noopener ugc nofollow" target="_blank">在Github </a>上，你会发现以下内容:</p><ul class=""><li id="fe75" class="kr ks hi ih b ii ij im in iq kt iu ku iy kv jc kw kx ky kz bi translated">源文件:Customers.csv和包含丰富数据的Google表单</li><li id="9161" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">您可以作为新流程导入的云数据准备方案</li><li id="eb1b" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">云函数的Python代码</li></ul><p id="d867" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你所需要的只是一个有效的Google账户和对Cloud Dataprep、Cloud Functions和BigQuery的访问。</p><h2 id="5d7d" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated"><strong class="ak"> 2。使用数据集作为参数创建云数据准备流</strong></h2><p id="ccea" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">首先，您需要创建一个Cloud Dataprep流，它接受定义为参数的源数据集。源数据集名称(定义为变量)将在运行时通过云函数的应用程序编程接口(API)调用作为参数进行解析。当创建源数据集或替换现有Dataprep流中的源时，可以将源数据集定义为变量/参数。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/3bb1b6c4093e6e852e2a3a00e7e410e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Mmw-3yus_Ip9G1hE.png"/></div></div></figure><p id="0d4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个现有的数据流中，我们的目标是将Google Sheet与CSV文件结合起来，我们希望将CSV源文件替换为变量。</p><p id="a3cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在流视图中，必须选择要监控的特定文件夹，并将文件名定义为变量。当您导入一个新数据集并点击“<strong class="ih hj">用参数</strong>创建数据集”按钮时，您将进入该页面。通过选择源数据集和菜单“<strong class="ih hj">用带参数</strong>的数据集替换”，您同样可以在流程视图中找到它。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/6411e069391f543ecccb3b318e696549.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*v_kli-OaV88KMP2P.png"/></div></div></figure><p id="55dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要单击数据集名称，并为源数据集选择“添加变量”。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lf"><img src="../Images/33cfecffc2f5347fe52e9d7300f2f442.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/format:webp/0*UnQrv49nc_i0AZ1n.png"/></div></figure><p id="0493" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个例子中，云存储文件夹是<strong class="ih hj"> /landingzone </strong>。该变量被命名为<strong class="ih hj">文件名</strong>；这也是将通过API调用的参数。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/2a2927c903b60aa52166291b0ff2b5e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6ua66wlN1tXS4bs5.png"/></div></div></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/ca1254616dd96d3aa64309372f2ba688.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ydmN1VGNduJ9dcWP.png"/></div></div></figure><p id="09e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个例子中，Dataprep流只包含一个参数。但是，您可以有多个输入、输出参数，甚至可以用一个数据转换配方来定义。</p><p id="4eb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在流程视图中选择<strong class="ih hj">参数</strong>选项卡，查看和编辑所有流程参数。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/d934f60ce7831b436a921d661daa3efc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Jzx6wpKQ3aCGsTpB.png"/></div></div></figure><h2 id="787a" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated"><strong class="ak"> 3。配置通过API调用的云数据准备方法</strong></h2><p id="18b6" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">我们想在每次将文件上传到<strong class="ih hj"> landingzone </strong>文件夹时触发“<strong class="ih hj">客户例外</strong>”配方。因此，我们需要为这个特定的配方启用Cloud Dataprep REST API。</p><p id="ce74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，您必须选择相应的配方，并记下配方URL中提供的配方ID。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/0a22efc9244efcb90cd02632d057d2f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8vX5SoGtE7Eh9Ny2.png"/></div></div></figure><p id="a8fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云数据准备API文档可以在<a class="ae jq" href="https://cloud.google.com/dataprep/docs/html/API-Overview_145281442" rel="noopener ugc nofollow" target="_blank">这里</a>找到。这就是我们需要使用POST请求类型的<strong class="ih hj"> /v4/jobgroups </strong>端点的地方。</p><p id="2ee9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们的例子中，配方ID是<strong class="ih hj"> 1427932 </strong>。我们的API调用的请求体将如下所示:</p><pre class="jf jg jh ji fd lg lh li lj aw lk bi"><span id="11c7" class="jr js hi lh b fi ll lm l ln lo">{<br/>   "wrangledDataset": {<br/>   "id": <strong class="lh hj">1427932</strong> <br/>   },<br/>   "runParameters": {<br/>       "overrides": {<br/>          "data": [{<br/>               "key": "<strong class="lh hj">FileName</strong>",<br/>               "value": <strong class="lh hj">override value (string)</strong><br/>          }]<br/>        }<br/>   }<br/>}</span></pre><p id="32a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要的下一件事是为将进行API调用的Dataprep用户提供一个访问令牌。这将确保用户被授权和认证来进行API调用。为此，请转到Cloud Dataprep的用户设置并生成一个新令牌(如果还没有这样做的话)。</p><p id="1182" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>:你需要成为Google项目的所有者才能生成访问令牌。试用时，您可以使用项目所有者的帐户或个人gmail帐户。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/542fc0f7fd2c567c43de0a0a11df7c8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ToXCabqHbprYDB3T.png"/></div></div></figure><h2 id="efa7" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated">4.创建云函数来监控文件到达，并调用云Dataprep API</h2><p id="713f" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">我们现在可以创建云功能，当云存储文件夹中出现新文件时将触发该功能。</p><p id="4d06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要从Google Cloud控制台创建云功能，请单击此处的<a class="ae jq" href="https://console.cloud.google.com/functions/" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="ce5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">触发类型必须为“<strong class="ih hj">云存储</strong>”，触发该功能的对象事件类型为“<strong class="ih hj">完成/创建”。</strong></p><p id="c3cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还需要指定想要从中触发该函数的云存储空间。在我们的例子中，我们将使用Python作为运行时。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/cb878aeeca250c401d5e6bcd147ebdbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LeMGnTSchwsBU9sF.png"/></div></div></figure><p id="22a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云函数代码遵循以下逻辑:</p><ol class=""><li id="4337" class="kr ks hi ih b ii ij im in iq kt iu ku iy kv jc lp kx ky kz bi translated">从事件对象中检索文件名。</li><li id="b23d" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc lp kx ky kz bi translated">检查文件路径是否是要监控的文件夹(在我们的例子中是<strong class="ih hj"> landingzone </strong>)。</li><li id="a8ef" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc lp kx ky kz bi translated">使用配方ID和文件名作为file name参数的值，调用Cloud Dataprep REST API端点。</li><li id="bf0c" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc lp kx ky kz bi translated">在API调用中利用Dataprep用户访问令牌进行云Dataprep认证。</li></ol><p id="5fcc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想探索更多关于云功能和云存储管理的知识，我推荐你去看看这篇<a class="ae jq" href="https://cloud.google.com/functions/docs/tutorials/storage" rel="noopener ugc nofollow" target="_blank">教程</a>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/bc12ab0fa710d9119578ef14b5a1eba3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4R4fgK6MVAn9wsEy.png"/></div></div></figure><p id="8561" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在这里提供了Python代码<a class="ae jq" href="https://github.com/victorcouste/google-cloudfunctions-dataprep/blob/master/gcs_trigger_dataprep_job.py" rel="noopener ugc nofollow" target="_blank">。您需要相应地编辑它，将突出显示的值替换为您在Cloud Dataprep项目中检索到的值(博客的第2和第3部分):</a></p><pre class="jf jg jh ji fd lg lh li lj aw lk bi"><span id="d5d8" class="jr js hi lh b fi ll lm l ln lo">datataprep_auth_token = ‘<strong class="lh hj">xxxxxxxxxxxxxxx</strong>‘</span><span id="f40b" class="jr js hi lh b fi lq lm l ln lo">dataprep_jobid = <strong class="lh hj">99999999</strong></span><span id="3bac" class="jr js hi lh b fi lq lm l ln lo">if context.event_type == ‘google.storage.object.finalize’ and newfilepath == ‘<strong class="lh hj">landingzone</strong>‘:</span></pre><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lr ls l"/></div></figure><p id="7aec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您需要部署云功能。它将运行并等待文件被上传以触发Cloud Dataprep作业。你可以在这里了解更多关于部署和执行云功能<a class="ae jq" href="https://cloud.google.com/functions/docs/deploying/console" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><h2 id="6596" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated">5.测试端到端流程</h2><p id="01d4" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">现在，您已经准备好测试端到端数据管道了，方法是在Google Cloud bucket中添加一个新文件，并监控它以确保Cloud Dataprep作业得到执行。</p><p id="d763" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Google控制台中，导航到“存储”、“浏览器”,然后转到适当的Google云存储空间以上传customer.csv文件。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/84106a4dd22cdd0b11a5f174b3a8b9ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*p7ks9Ajvj_W-0PCC.png"/></div></div></figure><p id="7146" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Cloud Dataprep Jobs窗口中，等待(刷新)启动并执行“客户异常”作业，以加载BigQuery表。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/a229099fca22c54ab44b06467428b34a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9VEwfomo21EfL_Gb.png"/></div></div></figure><p id="9ed1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过此窗口验证作业正在处理正确的文件。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/d86e548189e5848465225b061cb55dbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rP6QKA6wQK44zVEl.png"/></div></div></figure><p id="d558" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，您可以通过查看位于<a class="ae jq" href="https://console.cloud.google.com/logs/viewer?resource=cloud_function" rel="noopener ugc nofollow" target="_blank">此处</a>的Google Cloud Functions日志来确认正确的执行细节(带参数的API调用和Cloud Dataprep作业状态)。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/06e724da125e31719ac4d9efe54e38a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PmVCDIEuZmVwxa--.png"/></div></div></figure><h2 id="7b53" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated"><strong class="ak">结论</strong></h2><p id="78e2" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">遵循这个逐步指南后，您现在已经掌握了在特定文件夹中上传文件时自动触发端到端数据管道所需的基本原则。</p><p id="1f9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您已经了解了:</p><ul class=""><li id="bfee" class="kr ks hi ih b ii ij im in iq kt iu ku iy kv jc kw kx ky kz bi translated">云数据准备参数</li><li id="79d0" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">云数据准备API</li><li id="04a5" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">具有存储监控和调用API的云功能</li><li id="7d3b" class="kr ks hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">使用API调用和参数监控云功能和云数据准备执行</li></ul><p id="bff1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您现在已经准备好基于一个事件来自动化您的流程。如果您希望从更广的角度将Cloud Dataprep作为特定计划的企业数据逻辑的一部分，那么您也可以利用外部调度器来自动化Cloud Dataprep。看看这篇<a class="ae jq" rel="noopener" href="/google-cloud/automation-of-data-wrangling-and-machine-learning-on-google-cloud-7de6a80fde91">博客文章</a>，了解如何利用Cloud Composer(Google Cloud scheduler)来调度云数据准备作业。</p><p id="7997" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">原载于</em>【www.trifacta.com】<em class="jd"/></p></div></div>    
</body>
</html>