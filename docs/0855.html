<html>
<head>
<title>Web Metrics with OpenCensus and Stackdriver</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用OpenCensus和Stackdriver的Web度量</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/web-metrics-with-opencenus-and-stackdriver-525af8069ce6?source=collection_archive---------0-----------------------#2018-12-16">https://medium.com/google-cloud/web-metrics-with-opencenus-and-stackdriver-525af8069ce6?source=collection_archive---------0-----------------------#2018-12-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="54c0" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="7559" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这篇文章描述了一种接近实时地测量和理解web应用程序的用户所体验的应用程序健康的方法。它讨论了OpenCensus Node.js项目中使用OpenCensus和Stackdriver 监控web指标的示例<a class="ae kb" href="https://github.com/census-instrumentation/opencensus-node/tree/master/examples/stats/web_client_monitoring" rel="noopener ugc nofollow" target="_blank">，以及如何将其扩展到更复杂的Web应用程序。除了</a><a class="ae kb" href="https://opencensus.io/" rel="noopener ugc nofollow" target="_blank"> OpenCensus </a>项目库，示例解决方案还通过利用新的JavaScript功能来实现，这些功能是最近标准的一部分，包括ES6和W3C在2017年发布的<a class="ae kb" href="https://www.w3.org/TR/resource-timing/" rel="noopener ugc nofollow" target="_blank">资源定时级别1 </a>候选推荐标准。该解决方案还展示了在<a class="ae kb" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> Google云平台</a>上使用Stackdriver存储和可视化指标。同样的方法也适用于通过灵活的OpenCensus <a class="ae kb" href="https://opencensus.io/exporters/" rel="noopener ugc nofollow" target="_blank">导出接口</a>监控来自其他云和开源系统的产品。</p><h1 id="6af2" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">用例</strong></h1><p id="23df" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">收集web应用程序的指标是web应用程序所有者了解性能、用户体验和用户参与度所必需的一项重要任务。有三种主要的用例以及三种相应的度量标准:</p><ol class=""><li id="edf8" class="kc kd hi jf b jg ke jk kf jo kg js kh jw ki ka kj kk kl km bi translated">业务的健康状况——由业务和用户参与度指标表示，如每日或每月的活跃用户数和“转化率”，可能是新注册或在线销售</li><li id="22de" class="kc kd hi jf b jg kn jk ko jo kp js kq jw kr ka kj kk kl km bi translated">开发人员体验到的性能——在代码发布之前，开发人员从自己作为应用程序用户的角度出发，对延迟和资源使用数据的详细观察</li><li id="b24e" class="kc kd hi jf b jg kn jk ko jo kp js kq jw kr ka kj kk kl km bi translated">应用程序的运行状况—用户群经历的实时延迟，例如，不同地理位置的用户的资源加载时间，以及每分钟的错误和用户驱动事件的总数</li></ol><p id="b97f" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">第三个用例是本文的重点。</p><p id="22e2" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">第一个用例的现有完全托管解决方案的例子包括<a class="ae kb" href="https://analytics.google.com" rel="noopener ugc nofollow" target="_blank"> Google Analytics </a>和<a class="ae kb" href="https://marketingplatform.google.com/about/" rel="noopener ugc nofollow" target="_blank"> Google Marketing Platform </a>，它们包括非常强大的业务指标分析功能。第二个用例由Chrome开发者工具等工具解决。此处描述的第三种使用情形的方法能够近乎实时地完全控制用户群体的指标数据的收集、存储、呈现和分析。例如，当检测到客户端错误增加或延迟增加时，您可以通过<a class="ae kb" href="https://cloud.google.com/monitoring/alerts/" rel="noopener ugc nofollow" target="_blank">stack driver Alerts</a>向SRE系统可靠性工程人员发出警报。</p><p id="9466" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">OpenCensus ，一个多语言跟踪和监控指标收集框架，是这里描述的解决方案的核心。该解决方案在客户机和服务器上都使用现代JavaScript ( <a class="ae kb" href="http://www.ecma-international.org/ecma-262/6.0/index.html" rel="noopener ugc nofollow" target="_blank"> ES6 </a>)来检测、收集和保存Stackdrvier中的web指标，在stack drvier中可以查看持续更新的仪表板。选择JavaScript是因为Node.js在web应用程序开发人员中很受欢迎。除了作为服务器使用之外，Node.js已经成为部署客户端应用程序框架(如Angular和React)和用户界面组件库(如<a class="ae kb" href="https://material.io/develop/web/" rel="noopener ugc nofollow" target="_blank"> Material Web </a>)的核心。</p><p id="9d8f" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">如果这一切看起来对你的应用程序来说是多余的，你可能想要尝试一个正常运行时间服务，比如<a class="ae kb" href="https://cloud.google.com/monitoring/uptime-checks/" rel="noopener ugc nofollow" target="_blank">stack driver uptime alerts</a>。</p><h1 id="1347" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">体系结构</h1><p id="8995" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在示例中，服务器运行<a class="ae kb" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express </a>，并且可以部署到<a class="ae kb" href="https://cloud.google.com/appengine/docs/flexible/" rel="noopener ugc nofollow" target="_blank"> App Engine Flex </a>或任何其他支持Express的地方。OpenCensus APIs还可以用于其他计算环境，包括其他云，以及Stackdriver之外的监控后端。示例代码使用了<a class="ae kb" href="https://www.npmjs.com/package/@opencensus/core" rel="noopener ugc nofollow" target="_blank"> @opencensus/core </a>和<a class="ae kb" href="https://www.npmjs.com/package/@opencensus/exporter-stackdriver" rel="noopener ugc nofollow" target="_blank">@ open census/exporter-stack driver</a>node . js模块。</p><p id="4e7e" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">本例中采用的另一种方法是直接从web浏览器调用OpenCensus，跳过后端，这是一个需要管理的额外资源。您确实可以在web客户端中从JavaScript进行GCP API调用，就像这个针对BigQuery 的<a class="ae kb" href="https://developers.google.com/api-client-library/javascript/samples/samples" rel="noopener ugc nofollow" target="_blank">示例一样。然而，为了做到这一点，您将需要使用一个API密钥和用户凭证来通过</a><a class="ae kb" href="https://developers.google.com/api-client-library/javascript/features/authentication" rel="noopener ugc nofollow" target="_blank"> OAuth 2.0流程</a>。这是一种破坏性的用户体验，如果将数据保存到Stackdriver，对于没有谷歌账户的用户来说根本不可能。因此，这种方法被排除了。</p><p id="e5df" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">web应用程序健康状况的另一个衡量标准是HTTP响应代码计数和服务器延迟的服务器端图表，例如App Engine提供的现成图表。但是，如果出现网络问题，您的用户可能无法访问您的服务器，尽管事实上它是健康的。因此，衡量用户群体的体验非常重要。</p><p id="b85c" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">收集HTML相关的性能指标是另一个受益于JavaScript新发展的领域，特别是2017年发布的W3C的<a class="ae kb" href="https://www.w3.org/TR/resource-timing/" rel="noopener ugc nofollow" target="_blank">资源定时</a>候选建议和2018年发布的<a class="ae kb" href="https://www.w3.org/TR/resource-timing/" rel="noopener ugc nofollow" target="_blank">导航定时级别2 </a>。资源计时接口显示了DNS查找时间、TLS协商和总页面下载时间等指标，这些指标在以前的JavaScript中很难或不可能测量。</p><p id="1ea5" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">该解决方案的主要组件示意图如下所示。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/b5bbab0749218e68d5f326bd0b1de58c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-XrA6Hw6uNsKyodfvn2n4A.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated"><strong class="bd ih">架构示意图</strong></figcaption></figure><h1 id="b630" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">运行示例</strong></h1><p id="41cf" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">运行该示例的代码和详细说明在<a class="ae kb" href="https://github.com/census-instrumentation/opencensus-node/tree/master/examples/stats/web_client_monitoring" rel="noopener ugc nofollow" target="_blank"> GitHub README.md </a>中。部署后，应用程序显示如下所示的非常简单的web页面。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ll"><img src="../Images/4b174342bf86f1106b117784cb9cd400.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YO9QPirIf4U-52S8rY_pjA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated"><strong class="bd ih">示例网页截图</strong></figcaption></figure><p id="2275" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">当用户点击“刷新”按钮时，加载页面的计时语句和“点击我”按钮的点击次数被记录并发送给服务器。重新加载页面会刷新加载指标，并将点击计数清零。</p><p id="d780" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">部署应用程序后，尝试单击计数器按钮并保存指标几次。然后转到Stackdriver控制台并创建图表。传播指标数据可能需要几分钟时间。在Stackdriver菜单中，单击仪表板|创建仪表板。然后在新仪表板中单击添加图表。选择下面截图中显示的选项。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es lm"><img src="../Images/5a749545a0dc18b849cb27a63c52f69e.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*fGdlpuV8H2JM3jgdoW6C4w.png"/></div><figcaption class="lh li et er es lj lk bd b be z dx translated"><strong class="bd ih">在Stackdriver中向仪表板添加图表</strong></figcaption></figure><p id="34bf" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">如果您键入指标名称的一部分，那么Stackdriver将帮助您提前键入。选择资源类型:全局，度量:网络度量/延迟，分组依据:阶段，客户端。为webmetrics/click_count创建另一个图表。创建仪表板后，您应该会看到类似下面的截图。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ln"><img src="../Images/446f997adb864c47461fa434a6a078b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pOQK1gmltiOgLDQP"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated"><strong class="bd ih">stack driver仪表盘截图</strong></figcaption></figure><p id="db80" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">请注意，DNS查找时间和TLS连接时间的值大多为零。这本身就是一条重要的信息。当浏览器使用与域名匹配的缓存IP地址时，DNS查找时间为零。如果浏览器已经与服务器建立了连接，或者使用的协议是<a class="ae kb" href="https://en.wikipedia.org/wiki/QUIC" rel="noopener ugc nofollow" target="_blank"> QUIC </a>，则TLS连接时间可能为零。App Engine和其他Google服务支持QUIC，这是一种基于UDP的协议，数据通常可以立即发送到客户端。如果您尝试使用各种设备和浏览器，您应该会得到几个非零的DNS查找和TLS连接时间值。</p><h1 id="2b6d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">按类别分解网络指标</h1><p id="f780" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">该示例使用OpenCensus <a class="ae kb" href="https://opencensus.io/tag/" rel="noopener ugc nofollow" target="_blank">标签</a>来提供上下文信息和组相关指标。延迟指标使用“阶段”标签，代表HTTPS请求的不同阶段:DNS查找、TLS连接建立和有效负载传输。“client”标记是发送信息的客户端类型的占位符。例如，移动客户端与web客户端。或者，我们可以为客户机使用浏览器用户代理，它可以用<a class="ae kb" href="https://expressjs.com/en/api.html#req.get" rel="noopener ugc nofollow" target="_blank"> Express Request </a>对象来检索。例如，更换线路</p><pre class="kw kx ky kz fd lo lp lq lr aw ls bi"><span id="1bc8" class="lt ig hi lp b fi lu lv l lw lx">const valueWeb = "web";</span></pre><p id="daf1" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">在app.js中</p><pre class="kw kx ky kz fd lo lp lq lr aw ls bi"><span id="4d5d" class="lt ig hi lp b fi lu lv l lw lx">const valueWeb = req.header("User-Agent");</span></pre><p id="a895" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">修改代码后，仪表板看起来像下面的屏幕截图。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ly"><img src="../Images/df0dd6c64282e3d3411e92698a3a835a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*77koHwZoBx9mYR-C"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated"><strong class="bd ih">按用户代理细分的屏幕截图</strong></figcaption></figure><p id="b8a6" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">我们现在看到的一个小问题是，不同的浏览器有复杂的用户代理字符串。以更简单的形式查看不同的浏览器类型和操作系统会更令人愉快。用一些字符串解析代码提取不同的浏览器类型和操作系统，这不会太难。</p><p id="bea7" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">由于互联网服务水平因地区而异，我们可能还希望按地理位置细分性能和用户参与度指标。此外，这将有助于识别本地网络中断的区域，例如数据包丢失。App Engine和Google Cloud Load Balancer (GCLB)提供了<a class="ae kb" href="https://cloud.google.com/appengine/docs/standard/nodejs/reference/request-response-headers#app_engine-specific_headers" rel="noopener ugc nofollow" target="_blank">额外的HTTP头</a>，允许你根据国家、地区和城市找到用户的地理位置。可以使用OpenCensus标记在Stackdriver中添加分组信息。</p><p id="5535" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">您可能还想研究其他属性，例如有效负载大小、协议(HTTP、HTTPS、HTTP/2或QUIC)和网络类型，其中每一项都会对延迟产生很大影响。可以从浏览器JavaScript属性performance resource timing . transfer size中找到有效负载大小。如果使用带有<a class="ae kb" href="https://cloud.google.com/load-balancing/docs/backend-service#user-defined-request-headers" rel="noopener ugc nofollow" target="_blank">用户定义头</a>的谷歌云负载平衡器，可以找到协议信息。tls_version头包括tls版本或QUIC(如果使用的话)。实验浏览器JavaScript<a class="ae kb" href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator/connection" rel="noopener ugc nofollow" target="_blank">navigator . connection</a>属性返回一个<a class="ae kb" href="https://developer.mozilla.org/en-US/docs/Web/API/NetworkInformation" rel="noopener ugc nofollow" target="_blank"> NetworkInformation </a>对象，该对象给出网络类型，如“蜂窝”、“wifi”和“以太网”</p><p id="a86f" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">错误计数是另一个需要记录的重要指标。具体来说，在检索XMLHTTPRequests的资源时出现HTTP错误，在浏览器JavaScript执行时出现错误。错误计数的突然增加表明应用程序健康问题需要立即关注。</p><h1 id="fba3" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">扩展到更复杂的Web应用程序</h1><p id="bcfc" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">示例web页面类似于用普通HTML或服务器端框架编写的网站，这些框架生成HTML页面，如Java Server Pages、Python with Django或Go HTML模板。在这些常规(多页面)web应用程序中获取更多用户指标的一种方法是使用一个将返回多个DOM元素的DOM选择器。</p><p id="6c72" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">示例代码使用Fetch API在HTTP POST中发回分析数据。然而，使用<a class="ae kb" href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator/sendBeacon" rel="noopener ugc nofollow" target="_blank">navigator . send beacon()</a>API可能更合适，它专门用于向服务器发送少量的分析数据。这可以避免文件卸载中的潜在问题。请注意，并非所有浏览器都支持sendBeacon。</p><p id="20c7" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">由于生成的DOM的动态特性，使用像<a class="ae kb" href="https://angular.io/" rel="noopener ugc nofollow" target="_blank"> AngularJS </a>、React或Vue.js这样的框架的单页面应用程序(spa)可能需要稍微不同的方法。对于SPA，单个HTML页面将只加载一次。在SPAs中，通过XMLHttpRequest (AJAX)与服务器之间传输的数据可以改变显示给用户的视图。在这种情况下，应该记录的相关指标是XMLHttpRequest调用的延迟。XMLHttpRequest延迟也是在资源计时API中捕获的，因此相同的基本方法仍然适用。您可能希望定期将数据刷新到服务器，以便一旦出现问题就可以触发警报。</p><p id="b629" class="pw-post-body-paragraph jd je hi jf b jg ke ji jj jk kf jm jn jo ks jq jr js kt ju jv jw ku jy jz ka hb bi translated">Web Fundamentals文章<a class="ae kb" href="https://developers.google.com/web/fundamentals/performance/user-centric-performance-metrics" rel="noopener ugc nofollow" target="_blank">以用户为中心的性能指标</a>和<a class="ae kb" href="https://developers.google.com/web/fundamentals/performance/navigation-and-resource-timing/" rel="noopener ugc nofollow" target="_blank">使用导航和资源计时评估现实生活中的加载性能</a>以及Mozilla Developer Connection文章<a class="ae kb" href="https://developer.mozilla.org/en-US/docs/Web/API/Resource_Timing_API/Using_the_Resource_Timing_API" rel="noopener ugc nofollow" target="_blank">使用资源计时API </a>给出了浏览器JavaScript编码这些方面的更多细节。</p></div></div>    
</body>
</html>