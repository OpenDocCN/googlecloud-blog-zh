<html>
<head>
<title>Google Cloud Run on Rails: a real life example (Part 2: running locally)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Cloud Run on Rails:一个真实的例子(第2部分:本地运行)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-run-on-rails-a-real-life-example-part-2-running-locally-5734a1a7532f?source=collection_archive---------5-----------------------#2019-05-21">https://medium.com/google-cloud/google-cloud-run-on-rails-a-real-life-example-part-2-running-locally-5734a1a7532f?source=collection_archive---------5-----------------------#2019-05-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="35a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第1部分是关于建立你的GCP项目以及你的工作环境。现在让我们关注相册应用程序本身，并在投入生产之前在本地运行它。</p><p id="feed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong> <em class="je">在您的本地环境中运行相册应用程序是可选的。你可以放心地跳过这一部分(或者只是略读一下)，进入</em> <a class="ae jd" rel="noopener" href="/@laurent_90293/google-cloud-run-on-rails-a-real-life-example-part-3-production-environment-and-security-e109063ef745"> <em class="je">第3部分</em> </a> <em class="je">。</em></p><h1 id="39db" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">介绍相册应用程序</h1><p id="9ce0" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">我们在本教程中使用的Rails应用程序是一个相册。它足够简单，可以安装在一个Rails控制器中，但又足够丰富，可以执行一些专业应用程序在现实生活中通常需要的GCP服务。</p><p id="5785" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这包括:</p><ul class=""><li id="ed3c" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated"><strong class="ih hj">云构建</strong>构建应用程序的容器映像，并将其部署到云运行</li><li id="4e8f" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><strong class="ih hj">容器注册表</strong>用于存储和唯一标识容器映像的版本，并检查其漏洞</li><li id="4ac9" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><strong class="ih hj">云SQL </strong>大规模管理您的生产MySQL数据库</li><li id="8d4c" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><strong class="ih hj"> Google云存储</strong>作为Rails主动存储后端来存储图片文件</li><li id="65b9" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><strong class="ih hj">谷歌云密钥管理服务</strong> (KMS)保护你的应用秘密和凭证</li></ul><p id="7ceb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Github提供了该应用程序的源代码。要在本地克隆它，请运行以下命令:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="2209" class="lf jg hi lb b fi lg lh l li lj">$ git clone <a class="ae jd" href="https://github.com/ljulliar/photo_album.git" rel="noopener ugc nofollow" target="_blank">https://github.com/ljulliar/photo_album.git</a></span></pre><p id="3dea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想了解其中的内容，您可以在以下文件中找到该应用程序的精华:</p><ul class=""><li id="be02" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated"><a class="ae jd" href="https://github.com/ljulliar/photo_album/blob/master/app/controllers/pictures_controller.rb" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">图片控制器</strong> </a>:这里你会发现一个典型的Rails控制器，带有创建、显示和删除照片的动作。</li><li id="2626" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae jd" href="https://github.com/ljulliar/photo_album/blob/master/app/models/picture.rb" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">图片模型</strong> </a>:这是声明图片模型的地方，也是我们声明Rails ActiveStorage管理与创建的每个图片实例相关联的图像文件的地方。</li><li id="4050" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae jd" href="https://github.com/ljulliar/photo_album/tree/master/db/migrate" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">定义数据库模式的两个数据库迁移文件</strong> </a> <strong class="ih hj"> </strong>:一个由ActiveStorage自动生成，另一个用于图片数据。</li><li id="a63e" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae jd" href="https://github.com/ljulliar/photo_album/tree/master/app/views" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">视图</strong> </a>和partials文件用于呈现应用HTML页面。该应用程序的外观基于<a class="ae jd" href="https://rubygems.org/gems/materialize-sass/" rel="noopener ugc nofollow" target="_blank">materialize-sass</a>Ruby gem，这是Materialize的Sass支持版本，是一个基于<a class="ae jd" href="https://material.io/" rel="noopener ugc nofollow" target="_blank">材料设计</a>的现代响应前端框架。</li></ul><h1 id="b6d2" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">安装Ruby和gems</h1><p id="d68d" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">如果Ruby尚未安装在您的工作环境中，您可以按如下方式快速安装它:</p><p id="9a28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先<a class="ae jd" href="https://rvm.io/rvm/install" rel="noopener ugc nofollow" target="_blank">安装RVM </a>，Ruby版本管理器。尽管安装RVM是可选的，我还是强烈推荐使用它(或者你选择的任何其他Ruby版本管理器),因为它让Ruby版本的安装变得如此简单。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="80c3" class="lf jg hi lb b fi lg lh l li lj"># install rvm signature key<br/>$ gpg --keyserver hkp://pool.sks-keyservers.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB</span><span id="3885" class="lf jg hi lb b fi lk lh l li lj"># install rvm<br/>$ curl -sSL <a class="ae jd" href="https://get.rvm.io" rel="noopener ugc nofollow" target="_blank">https://get.rvm.io</a> | bash</span><span id="adca" class="lf jg hi lb b fi lk lh l li lj"># load rvm environment variables<br/>$ source ~/.rvm/scripts/rvm        </span></pre><p id="780f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">rvm启动并运行后，安装本教程所需的Ruby版本(2.6.3或您阅读本文时最新的稳定的2.6.x版本):</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="8b64" class="lf jg hi lb b fi lg lh l li lj">$ rvm install ruby-2.6.3       # Install ruby 2.6.3<br/>$ rvm --default use ruby-2.6.3 # Make it the default version<br/>$ ruby -v                      # check that it’s working fine</span></pre><p id="bdbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们按照<code class="du ll lm ln lb b">Gemfile </code>文件中的说明，安装相册应用程序所需的Ruby gems。您会注意到Rails应用程序依赖于<code class="du ll lm ln lb b">google-cloud-storage</code> gem，因为Rails ActiveStorage需要它来访问存储图像文件的GCS桶。</p><p id="8a09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能已经注意到，云SQL没有特定的精华。由于我们使用的是云SQL MySQL实例，传统的<code class="du ll lm ln lb b">mysql</code> Ruby gem是我们与本地或生产MySQL数据库接口所需的全部。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="b041" class="lf jg hi lb b fi lg lh l li lj">$ cd ./photo_album<br/>$ bundle install</span></pre><p id="8776" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样，我们的Ruby环境就准备好了。现在让我们来探索和设置MySQL。</p><h1 id="6a44" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">设置MySQL</h1><p id="fd1e" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">对于本教程，我们需要安装MySQL 5.6或更高版本。在您的工作环境中，键入以下命令:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="1163" class="lf jg hi lb b fi lg lh l li lj">$ sudo apt install mysql-server libmysqlclient-dev  # install...<br/>$ sudo service mysql start   # and start the database server</span></pre><p id="1c4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong> : <em class="je">如果您使用Cloud Shell作为您的工作环境，那么您在Cloud Shell的主目录中所做的所有更改都会在工作会话中保持不变，但是系统范围的修改(比如安装新的Debian包)则不会。所以如果你决定关闭你的会话或者暂停你的工作一段时间，你将不得不重新安装并启动mysql。</em></p><p id="3444" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在为本地MySQL开发数据库创建用户名(用您喜欢的密码替换下面的<code class="du ll lm ln lb b">xxx</code>，并确保相应地更新<code class="du ll lm ln lb b">config/database.yml</code>文件的开发和测试部分，以反映您选择的密码):</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="5850" class="lf jg hi lb b fi lg lh l li lj">$ mysql -u root</span><span id="a3cb" class="lf jg hi lb b fi lk lh l li lj">CREATE USER ‘dev_db_user’@’localhost’ IDENTIFIED BY ‘xxx’;<br/>GRANT ALL ON *.* TO ‘dev_db_user’@’localhost’ WITH GRANT OPTION;</span><span id="2421" class="lf jg hi lb b fi lk lh l li lj">CREATE USER ‘test_db_user’@’localhost’ IDENTIFIED BY ‘xxx’;<br/>GRANT ALL ON *.* TO ‘test_db_user’@’localhost’ WITH GRANT OPTION;</span><span id="30b2" class="lf jg hi lb b fi lk lh l li lj">FLUSH PRIVILEGES;</span><span id="776f" class="lf jg hi lb b fi lk lh l li lj">exit</span></pre><h1 id="e8da" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">在本地运行相册</h1><p id="6e7f" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">然后，让我们创建并填充本地MySQL开发数据库…</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="75b5" class="lf jg hi lb b fi lg lh l li lj">$ bundle exec rake db:setup</span></pre><p id="02f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">…并在我们的本地环境中启动相册应用程序。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="b03e" class="lf jg hi lb b fi lg lh l li lj">$ bundle exec rails server</span></pre><p id="adb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用你最喜欢的浏览器访问http://localhost:3000/ ,你会看到一个主页，邀请你在空相册中加载一张新照片。</p><p id="8e36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong> : <em class="je">如果你使用的是云shell，点击Shell窗口正上方的Web预览图标(寻找&lt; &gt;符号)，将预览端口改为3000。然后点击“在端口3000上预览”,瞧！</em></p><figure class="kw kx ky kz fd lp er es paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="er es lo"><img src="../Images/cde6b1baf4d1442853424331306f6d1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jMM1bdL0LqV11dWr"/></div></div><figcaption class="lw lx et er es ly lz bd b be z dx translated">你的原始相册</figcaption></figure><p id="61e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以玩你的相册:上传两张图片及其说明，点击其中一张查看细节，也可以删除一张照片。您应该会看到类似这样的内容:</p><figure class="kw kx ky kz fd lp er es paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="er es ma"><img src="../Images/f7e73253f4a22311d0552c514ea653f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bQ0apzJcXoslyEO6"/></div></div><figcaption class="lw lx et er es ly lz bd b be z dx translated">你的相册里有几张漂亮的照片</figcaption></figure><p id="8c30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切都好吗？现在让我们转到<a class="ae jd" rel="noopener" href="/@laurent_90293/google-cloud-run-on-rails-a-real-life-example-part-3-production-environment-and-security-e109063ef745">第3部分</a>，为在生产中部署打下基础。</p></div></div>    
</body>
</html>