<html>
<head>
<title>Search on Google Cloud Platform — Spanner</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云平台搜索—扳手</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/search-on-google-cloud-platform-spanner-1583dba9f54?source=collection_archive---------2-----------------------#2018-08-27">https://medium.com/google-cloud/search-on-google-cloud-platform-spanner-1583dba9f54?source=collection_archive---------2-----------------------#2018-08-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="61e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第四篇关于Google Cloud主题搜索的文章是关于<a class="ae jd" href="https://cloud.google.com/spanner/" rel="noopener ugc nofollow" target="_blank"> Cloud Spanner。</a>想法是在谷歌云平台上探索各种不同的产品，以及如何使用它们来实现虚拟商店的搜索功能。到目前为止，系列文章致力于:</p><ul class=""><li id="4a6e" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/search-on-google-cloud-platform-app-engine-and-search-api-31cda6917bbf">应用引擎和搜索API </a>(包含大部分信息和细节，其他文章不再赘述)</li><li id="742a" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/search-on-google-cloud-platform-cloud-datastore-615c14cb1bb">云数据存储</a></li><li id="16e5" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/search-on-google-cloud-platform-cloud-sql-65a0f75b3af8">云SQL </a></li></ul><p id="ee92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个(和上一个)例子的所有代码都在Github库<a class="ae jd" href="https://github.com/zdenulo/gcp-search/tree/master/spanner/webapp" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="21f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">重复最重要的信息(在第一篇文章中有详细描述)。目标是创建搜索(自动完成)功能使用类似网站的电子商店谷歌云平台。我使用谷歌应用引擎灵活的网络服务器与烧瓶框架渲染主页和处理搜索请求，这种情况下云扳手作为数据库，我将存储产品信息以及执行查询。我省略了几个步骤的描述，因为在以前的文章中已经详细描述过了。</p><h1 id="85eb" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">云扳手</h1><p id="f64a" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">云扳手是托管SQL数据库。与其他SQL数据库不同，Spanner是直接在Google中开发的，它有一些非常独特的属性，这使得它非常特别:</p><ul class=""><li id="8a77" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">水平可伸缩</li><li id="592c" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">强一致性</li><li id="dfe5" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">处理</li><li id="5216" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">高可用性</li><li id="776e" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">一个节点最多可提供10，000 QPS的读取或2，000 QPS的写入。</li><li id="2987" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">价格约为每小时每节点1美元，每月每GB 0.3美元，这意味着每个节点的起始价格为每月720美元</li><li id="2aa1" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">对于生产使用和SLA涵盖的情况，建议至少使用3个节点。</li><li id="e15e" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">有针对特定编程语言的客户端库来使用Spanner</li></ul><p id="a76d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不会详细介绍所有这些属性，很少有有趣的技术论文更深入地解释Spanner是如何设计和如何工作的:<a class="ae jd" href="https://ai.google/research/pubs/pub39966" rel="noopener ugc nofollow" target="_blank">谷歌的全球分布式数据库</a>，<a class="ae jd" href="https://ai.google/research/pubs/pub45855" rel="noopener ugc nofollow" target="_blank"> Spanner，TrueTime和CAP定理</a>。</p><h1 id="ddd7" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">数据库模型</h1><p id="9b81" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">所有与数据库相关的都在文件spanner_search.py中，内容在这里:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="f667" class="le jt hi la b fi lf lg l lh li">from google.cloud import spanner<br/><br/>from db_settings import SPANNER_INSTANCE_ID<br/><br/>DATABASE_ID = 'eshop'<br/><br/><br/>class SpannerSearch():<br/><br/>    def __init__(self):<br/>        client = spanner.Client()<br/>        self.instance = client.instance(SPANNER_INSTANCE_ID)<br/>        database = self.instance.database(DATABASE_ID)<br/>        self.client = database<br/><br/>    def init_schema(self):<br/>        """Creates database for instance and table for products"""<br/>        database = self.instance.database(DATABASE_ID, ddl_statements=[<br/>            """CREATE TABLE Products (<br/>            Sku INT64 NOT NULL,<br/>            ProductName STRING(1024) NOT NULL,<br/>            ProductNameCase STRING(1024) NOT NULL,<br/>            Price FLOAT64,<br/>            SalePrice FLOAT64,            <br/>            Available STRING(64),<br/>            Url STRING(1024)            <br/>            ) PRIMARY KEY (Sku)<br/>            """<br/>        ])<br/>        operation = database.create()<br/>        operation.result()<br/><br/>    def insert_bulk(self, input_data):<br/>        """input is list of dictionaries. fields are sensitive to position in list"""<br/>        values = []<br/>        for item in input_data:<br/>            values.append((int(item['sku']), item['name'], item['name'].upper(), float(item['price']), float(item['sale_price']), item['available'], item['url']),)<br/><br/>        with self.client.batch() as batch:<br/>            batch.insert(<br/>                table='products',<br/>                columns=('Sku', 'ProductName', 'ProductNameCase', 'Price', 'SalePrice', 'Available', 'Url'),<br/>                values=values<br/>            )<br/><br/>    def search(self, query):<br/>        """does search on table with LIKE operator. Number of returned results is set with LIMIT"""<br/>        db_query = """SELECT * FROM products WHERE ProductNameCase LIKE '%{}%' LIMIT 20""".format(query.upper())<br/>        output = []<br/>        with self.client.snapshot() as snapshot:<br/>            results = snapshot.execute_sql(db_query)<br/>            for row in results:<br/>                out = {<br/>                    'value': row[1],<br/>                    'label': row[1]<br/>                }<br/>                output.append(out)<br/>        return output<br/><br/>    def delete_all(self):<br/>        """deletes database (and table)"""<br/>        self.client.drop()</span></pre><p id="dad5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我用的是Python官方的Spanner客户端库。表的创建是通过DDL语句完成的。Spanner目前没有全文功能，例如PostgreSQL，所以我尝试使用当前的可能性。一个是使用REGEX like匹配，第二个是使用like操作符。</p><h1 id="0d0a" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">数据库设置</h1><p id="ba59" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">我使用来自<a class="ae jd" href="https://cloud.google.com/sdk/" rel="noopener ugc nofollow" target="_blank"> Google Cloud SDK </a>的gcloud CLI来执行命令。首先，我将创建一个带有1个节点的扳手实例，并选择区域。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="7ef6" class="le jt hi la b fi lf lg l lh li">gcloud spanner instances create myspanner --config=regional-us-central1 --nodes=1 --description="Test instance"<br/>Creating instance...done.</span></pre><p id="5775" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过执行脚本upload_products.py，数据将从csv文件上传到Spanner数据库。从我的本地计算机上传120万行花了6分钟，这是非常好的时间。我在分批上传，每次插入包含2000个项目。</p><h1 id="8312" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">负载测试</h1><p id="7654" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">我像在以前的文章中一样，使用运行在Google Kubernetes集群上的<a class="ae jd" href="https://locust.io/" rel="noopener ugc nofollow" target="_blank">蝗虫</a>框架进行常规负载测试。如何在<a class="ae jd" href="https://github.com/zdenulo/gcp-search/tree/master/load-testing" rel="noopener ugc nofollow" target="_blank"> Github库</a>中设置集群和部署的分步过程。出于负载测试的目的，我将GAE Flex实例的最小数量设置为10(带自动缩放)，因为它们需要时间加速。我以每秒5个用户的孵化率运行了2000个用户。以下是蝗虫用户界面的截图:</p><figure class="kv kw kx ky fd lk er es paragraph-image"><div class="er es lj"><img src="../Images/57ab4102be5fcd286deecfedd22c9a4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*6L5dSDP5D9IUpAXu.png"/></div></figure><figure class="kv kw kx ky fd lk er es paragraph-image"><div class="er es lj"><img src="../Images/71c855e63b06740c67d6c09f9a13abfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*lGGKOM09R_D1w8H3.png"/></div></figure><figure class="kv kw kx ky fd lk er es paragraph-image"><div class="er es lj"><img src="../Images/b2e9db882bb722052ecaf7fd88d5f982.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*dnLJzHcUgQWY65S1.png"/></div></figure><p id="6be5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从表中可以看出，它总共发出了大约236000个请求，平均响应时间为46毫秒，平均响应时间为194毫秒。</p><p id="f0cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Spanner还提供了一些监控图表。</p><figure class="kv kw kx ky fd lk er es paragraph-image"><div class="er es lj"><img src="../Images/a6e3f07525123b2e857390b6b8b80e76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*d4tLgxwIwIexM2Ou.png"/></div></figure><figure class="kv kw kx ky fd lk er es paragraph-image"><div class="er es lj"><img src="../Images/fedb4d669a76472e71a106e3df9b19cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*xyvd89sIwTqnoXlQ.png"/></div></figure><p id="c4d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以看到，在每秒大约550个请求的最大负载下(对应于Spanner的读取操作图)，这个节点实例的CPU利用率大约为20%(图表右侧)。</p><p id="f55b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是来自GAE的原木样品。</p><figure class="kv kw kx ky fd lk er es paragraph-image"><div class="er es lj"><img src="../Images/de2cabb061d21c0e003a5f3be628b182.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*8AmIJpTlsTBCoFFR.png"/></div></figure><h1 id="4479" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">结论</h1><p id="52c4" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">Cloud Spanner绝不是pet项目的数据库，而是一个严肃的业务，这反映在价格以及多区域支持和水平扩展等功能上。目前Spanner不支持全文搜索，所以根据具体情况，使用LIKE运算符就足够了。</p></div></div>    
</body>
</html>