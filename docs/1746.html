<html>
<head>
<title>Boost Istio Service Mesh by upgrading to HTTP 2 — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过升级到HTTP 2-第2部分来增强Istio服务网格</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/boost-istio-service-mesh-by-upgrading-to-http-2-part-2-810dd42e74aa?source=collection_archive---------1-----------------------#2021-01-07">https://medium.com/google-cloud/boost-istio-service-mesh-by-upgrading-to-http-2-part-2-810dd42e74aa?source=collection_archive---------1-----------------------#2021-01-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f358" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你正在寻找提高服务网络效率的方法，那么这篇文章是2部分系列文章的第2部分。前一篇文章讨论了如何将服务网格中的所有连接从HTTP 1.1升级到HTTP/2。</p><p id="75b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章将讨论选项2:一次升级目的地规则1服务。</p><h1 id="c1ee" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">履行</h1><h2 id="68f9" class="kc jf hi bd jg kd ke kf jk kg kh ki jo iq kj kk js iu kl km jw iy kn ko ka kp bi translated">选项2</h2><p id="39a4" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">安装Istio，然后安装图书信息应用程序。</p><div class="kv kw ez fb kx ky"><a href="https://istio.io/latest/docs/examples/bookinfo/" rel="noopener  ugc nofollow" target="_blank"><div class="kz ab dw"><div class="la ab lb cl cj lc"><h2 class="bd hj fi z dy ld ea eb le ed ef hh bi translated">Bookinfo应用程序</h2><div class="lf l"><h3 class="bd b fi z dy ld ea eb le ed ef dx translated">该示例部署了一个由四个独立的微服务组成的示例应用程序，用于演示各种组织结构</h3></div><div class="lg l"><p class="bd b fp z dy ld ea eb le ed ef dx translated">istio.io</p></div></div></div></a></div><p id="c510" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">产品应用程序(升级前)</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="8bf2" class="kc jf hi lm b fi lq lr l ls lt">kubectl logs -f productpage-v1–64794f5db4-fqpgp -c istio-proxy</span><span id="e5a4" class="kc jf hi lm b fi lu lr l ls lt">[2021-01-07T10:24:37.568Z] "GET /details/0 <strong class="lm hj">HTTP/1.1</strong>" 200 - "-" 0 178 5 4 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "ee2a4bcb-ed3a-923e-8dc7-663f861ef2c6" "details:9080" "10.1.1.64:9080" <strong class="lm hj">outbound</strong>|9080||details.default.svc.cluster.local 10.1.1.71:43828 10.99.56.191:9080 10.1.1.71:34782 - default</span><span id="656d" class="kc jf hi lm b fi lu lr l ls lt">[2021-01-07T10:24:37.577Z] "GET /reviews/0 HTTP/1.1" 200 - "-" 0 375 26 26 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "ee2a4bcb-ed3a-923e-8dc7-663f861ef2c6" "reviews:9080" "10.1.1.69:9080" outbound|9080||reviews.default.svc.cluster.local 10.1.1.71:60474 10.101.5.33:9080 10.1.1.71:43712 - default</span><span id="d025" class="kc jf hi lm b fi lu lr l ls lt">[2021-01-07T10:24:37.564Z] "GET /productpage <strong class="lm hj">HTTP/1.1</strong>" 200 - "-" 0 5179 41 41 "192.168.65.3" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "ee2a4bcb-ed3a-923e-8dc7-663f861ef2c6" "localhost" "127.0.0.1:9080" <strong class="lm hj">inbound</strong>|9080|| 127.0.0.1:40024 10.1.1.71:9080 192.168.65.3:0 outbound_.9080_._.productpage.default.svc.cluster.local default</span></pre><p id="adc0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">详细信息应用程序(升级前)</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="f22a" class="kc jf hi lm b fi lq lr l ls lt">kubectl logs -f details-v1-5974b67c8-rcnr9 -c istio-proxy</span><span id="38c8" class="kc jf hi lm b fi lu lr l ls lt">[2021-01-07T10:24:37.571Z] "GET /details/0 HTTP/1.1" 200 - "-" 0 178 1 1 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "ee2a4bcb-ed3a-923e-8dc7-663f861ef2c6" "details:9080" "127.0.0.1:9080" inbound|9080|| 127.0.0.1:40030 10.1.1.64:9080 10.1.1.71:43828 outbound_.9080_._.details.default.svc.cluster.local default</span></pre><p id="a7ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意所有的连接(入站和出站)都在HTTP 1.1上。</p><p id="734d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们修改Details应用程序的目标规则，将所有传入连接升级到HTTP/2。</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="4500" class="kc jf hi lm b fi lq lr l ls lt">details-destinationrules-upgrade.yaml</span><span id="113e" class="kc jf hi lm b fi lu lr l ls lt">apiVersion: networking.istio.io/v1alpha3<br/>kind: DestinationRule<br/>metadata:<br/>  name: details<br/>spec:<br/>  host: details<br/>  subsets:<br/>  - name: v1<br/>    labels:<br/>      version: v1<br/>  - name: v2<br/>    labels:<br/>      version: v2<br/><strong class="lm hj">  trafficPolicy:<br/>    tls:<br/>      mode: ISTIO_MUTUAL<br/>    connectionPool:<br/>      http:<br/>        h2UpgradePolicy: UPGRADE</strong></span></pre><p id="7231" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这指示Istio升级所有针对细节的连接</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="914a" class="kc jf hi lm b fi lq lr l ls lt">kubectl apply -f /details-destinationrules-upgrade.yaml</span></pre><p id="477b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">产品应用程序(升级后)</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="ff2d" class="kc jf hi lm b fi lq lr l ls lt">kubectl logs -f productpage-v1–64794f5db4-fqpgp -c istio-proxy</span><span id="0f70" class="kc jf hi lm b fi lu lr l ls lt">[2021-01-07T10:35:01.692Z] "GET /details/0 <strong class="lm hj">HTTP/1.1</strong>" 200 - "-" 0 178 16 16 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "1817e0a2-2fa2-9689-9f97-60d989011c98" "details:9080" "10.1.1.64:9080" <strong class="lm hj">outbound</strong>|9080||<strong class="lm hj">details.default.svc.cluster.local</strong> 10.1.1.71:52792 10.99.56.191:9080 10.1.1.71:43746 - default</span><span id="39ce" class="kc jf hi lm b fi lu lr l ls lt">[2021-01-07T10:35:01.712Z] "GET /reviews/0 HTTP/1.1" 200 - "-" 0 375 52 51 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "1817e0a2-2fa2-9689-9f97-60d989011c98" "reviews:9080" "10.1.1.69:9080" outbound|9080||reviews.default.svc.cluster.local 10.1.1.71:41206 10.101.5.33:9080 10.1.1.71:52676 - default</span><span id="9ee8" class="kc jf hi lm b fi lu lr l ls lt">[2021-01-07T10:35:01.688Z] "GET /productpage HTTP/1.1" 200 - "-" 0 5179 78 78 "192.168.65.3" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "1817e0a2-2fa2-9689-9f97-60d989011c98" "localhost" "127.0.0.1:9080" inbound|9080|| 127.0.0.1:48988 10.1.1.71:9080 192.168.65.3:0 outbound_.9080_._.productpage.default.svc.cluster.local default</span></pre><p id="9718" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为产品应用程序使用的是HTTP 1.1上的HTTP/ReST客户端库，所以出站从HTTP 1.1开始，但是Istio应该将连接升级到HTTP/2。让我们检查详细的应用程序日志来验证。</p><p id="7465" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">详细信息应用程序(升级后)</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="2ead" class="kc jf hi lm b fi lq lr l ls lt">kubectl logs -f details-v1-5974b67c8-rcnr9 -c istio-proxy</span><span id="923e" class="kc jf hi lm b fi lu lr l ls lt">[2021-01-07T10:35:01.696Z] "GET /details/0 <strong class="lm hj">HTTP/2</strong>" 200 - "-" 0 178 13 12 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Safari/605.1.15" "1817e0a2-2fa2-9689-9f97-60d989011c98" "details:9080" "127.0.0.1:9080" <strong class="lm hj">inbound</strong>|9080|| 127.0.0.1:48994 10.1.1.64:9080 10.1.1.71:52792 outbound_.9080_._.details.default.svc.cluster.local default</span></pre><p id="db6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Istio已经将调用升级到HTTP/2！</p><h1 id="fd0e" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">结论</h1><p id="495c" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">当您不能在全局级别更新配置时，选项2是可行的。然而，就像前一篇文章中提到的，我们也应该通过使用使用HTTP/2的库来避免升级。</p></div></div>    
</body>
</html>