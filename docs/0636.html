<html>
<head>
<title>Istio 101 (0.8.0) on GKE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GKE的Istio 101 (0.8.0)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/istio-101-0-8-0-on-gke-c860115c4d42?source=collection_archive---------0-----------------------#2018-06-07">https://medium.com/google-cloud/istio-101-0-8-0-on-gke-c860115c4d42?source=collection_archive---------0-----------------------#2018-06-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2537" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我之前的一篇<a class="ae jd" href="https://meteatamel.wordpress.com/2018/04/24/istio-101-with-minikube/" rel="noopener ugc nofollow" target="_blank">帖子</a>中，我展示了如何在minikube上安装Istio并部署示例BookInfo应用程序。一个新的Istio版本出来了(0.8.0) <a class="ae jd" href="https://istio.io/about/notes/0.8/" rel="noopener ugc nofollow" target="_blank">有很多变化</a>，尤其是在<a class="ae jd" href="https://istio.io/blog/2018/v1alpha3-routing/" rel="noopener ugc nofollow" target="_blank">交通管理上的变化</a>，这让我之前帖子的步骤有点过时。</p><p id="8f20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我想展示如何在谷歌Kubernetes引擎(GKE)上安装Istio 0.8.0，部署样例BookInfo应用程序，并展示一些附加组件和流量路由。</p><h1 id="4179" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">创建Kubernetes集群</h1><p id="5a40" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">首先，我们需要一个Kubernetes集群来安装Istio。在GKE，这是一个简单的命令:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="87cb" class="kq jf hi km b fi kr ks l kt ku">gcloud container clusters create hello-istio \ --cluster-version=1.9.7-gke.1 \ --zone europe-west1-b \ --num-nodes 4</span></pre><p id="1109" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有几件事需要注意。首先，我没有在GKE (1.10)上使用最新的集群版本，因为Istio 0.8.0还不能与之抗衡。第二，我使用了4个工作节点。这是BookInfo示例的推荐节点数。</p><p id="b778" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦创建了集群，我们还需要为Istio创建一个<em class="kv"> clusterrolebinding </em>来管理集群:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="022d" class="kq jf hi km b fi kr ks l kt ku">kubectl create clusterrolebinding cluster-admin-binding \ --clusterrole=cluster-admin \ --user=$(gcloud config get-value core/account)</span></pre><h1 id="2061" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">下载和设置Istio</h1><p id="8f92" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在我们有了一个集群，让我们下载最新的Istio(从今天起是0.8.0):</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="1647" class="kq jf hi km b fi kr ks l kt ku">curl -L <a class="ae jd" href="https://git.io/getLatestIstio" rel="noopener ugc nofollow" target="_blank">https://git.io/getLatestIstio</a> | ISTIO_VERSION=0.8.0 sh -</span></pre><p id="15b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将Istio的命令行工具<em class="kv"> istioctl </em>添加到您的路径中。我们以后会用到它:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="06d9" class="kq jf hi km b fi kr ks l kt ku">export PATH="$PATH:./istio-0.8.0/bin"</span></pre><h1 id="f3b8" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">安装Istio</h1><p id="f67f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">是时候在边车之间安装带相互认证的Istio了:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="bd19" class="kq jf hi km b fi kr ks l kt ku">kubectl apply -f install/kubernetes/istio-demo-auth.yaml</span></pre><p id="11db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成后，您可以检查pods是否在istio-system名称空间下运行:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="452d" class="kq jf hi km b fi kr ks l kt ku">kubectl get pods -n istio-system</span></pre><p id="4cbe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你会发现，除了Istio基本组件(例如，导频、混音器、入口、出口)，还安装了许多附加组件(例如，prometheus、servicegraph、grafana)。这与之前的Istio版本不同。</p><h1 id="16a3" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">部署BookInfo应用程序</h1><p id="9fd1" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在让我们部署BookInfo示例应用程序:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="adb9" class="kq jf hi km b fi kr ks l kt ku">kubectl apply -f &lt;(istioctl kube-inject --debug -f samples/bookinfo/kube/bookinfo.yaml)</span></pre><p id="e220" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保所有的吊舱都在运行:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="1934" class="kq jf hi km b fi kr ks l kt ku">kubectl get pods</span></pre><h1 id="4c05" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">部署BookInfo网关</h1><p id="e771" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在Istio 0.8.0中，流量管理完全改变了，其中一项改变是您需要为入口流量创建一个网关。让我们继续为BookInfo应用程序创建一个网关:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="5869" class="kq jf hi km b fi kr ks l kt ku">istioctl create -f samples/bookinfo/routing/bookinfo-gateway.yaml</span></pre><h1 id="0f9b" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">使用BookInfo应用程序</h1><p id="3edf" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我们终于可以看看这个应用了。我们需要找到入口网关IP和端口:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="ec0d" class="kq jf hi km b fi kr ks l kt ku">kubectl get svc istio-ingressgateway -n istio-system</span></pre><p id="abfb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了方便起见，让我们定义一个<em class="kv"> GATEWAY_URL </em>变量:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="8400" class="kq jf hi km b fi kr ks l kt ku">export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}') export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http")].port}') export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT</span></pre><p id="0c0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看这个应用程序是否有效。用curl你应该得到200:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="791f" class="kq jf hi km b fi kr ks l kt ku">curl -o /dev/null -s -w "%{http_code}\n" <a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/${GATEWAY_URL}/productpage">http://${GATEWAY_URL}/productpage</a></span></pre><p id="54a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您也可以打开浏览器，查看产品页面的web前端。此时，我们已经通过Istio的基本安装部署和管理了应用程序。</p><p id="ed16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将看看一些附加组件。与以前的版本不同，附加组件已经自动安装。让我们先开始发送一些流量:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="e058" class="kq jf hi km b fi kr ks l kt ku">for i in {1..100}; do curl -o /dev/null -s -w "%{http_code}\n" <a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/${GATEWAY_URL}/productpage;">http://${GATEWAY_URL}/productpage;</a> done</span></pre><h1 id="45e6" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">Grafana仪表板</h1><p id="15e8" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这是格拉法纳的仪表板。让我们先设置端口转发:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="f182" class="kq jf hi km b fi kr ks l kt ku">kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=grafana -o jsonpath='{.items[0].metadata.name}') 8080:3000</span></pre><p id="e02e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导航到<a class="ae jd" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>查看仪表板:</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/db143727f6a23fad40bce28510a7819d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uyUvi6w71fECQgPa"/></div></div></figure><h1 id="1061" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">普罗米修斯矩阵</h1><p id="0bc9" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">接下来，让我们看看普罗米修斯的度量标准。设置端口转发:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="9c1c" class="kq jf hi km b fi kr ks l kt ku">kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=prometheus -o jsonpath='{.items[0].metadata.name}') 8083:9090</span></pre><p id="cd9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导航到<a class="ae jd" href="http://localhost:8083/graph" rel="noopener ugc nofollow" target="_blank">http://localhost:8083/graph</a>看普罗米修斯:</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/199e0909c57032cbb087c4d70e17d018.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1gagVJbThBh4UcHC"/></div></div></figure><h1 id="d66e" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">服务图表</h1><p id="a253" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">对于依赖关系的可视化，我们可以看看ServiceGraph:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="9d45" class="kq jf hi km b fi kr ks l kt ku">kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=servicegraph -o jsonpath='{.items[0].metadata.name}') 8082:8088</span></pre><p id="46cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导航到<a class="ae jd" href="http://localhost:8082/dotviz" rel="noopener ugc nofollow" target="_blank">http://localhost:8082/dot viz</a>:</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/cc6b48dc33d337e92bbb82b5d0fc1b55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eAZnhR9uRJIUzDVa"/></div></div></figure><h1 id="7f69" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">描摹</h1><p id="9f98" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">对于HTTP追踪，有Jaegar和Zipkin。让我们来看看耶格。照常设置端口转发:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="2100" class="kq jf hi km b fi kr ks l kt ku">kubectl port-forward -n istio-system $(kubectl get pod -n istio-system -l app=jaeger -o jsonpath='{.items[0].metadata.name}') 8084:16686</span></pre><p id="716e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导航到<a class="ae jd" href="http://localhost:8084/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8084 </a></p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/ccd49baf7e1573dab26be07c1dbd27f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZN2jWD2_YEo6vj9V"/></div></div></figure><h1 id="7e60" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">交通管理</h1><p id="0f86" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">流量管理在0.8.0中发生了巨大变化。你可以在这里<a class="ae jd" href="https://istio.io/blog/2018/v1alpha3-routing/" rel="noopener ugc nofollow" target="_blank">了解更多信息</a>但基本上，我们现在有了虚拟服务和目的地规则，而不是路由规则。</p><p id="9857" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以看到现有的虚拟服务和目标规则，如下所示:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="f6f7" class="kq jf hi km b fi kr ks l kt ku">istioctl get virtualservices -o yaml istioctl get destinationrules -o yaml</span></pre><p id="687a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当你进入BookInfo应用的产品页面，做几次浏览器刷新，你会看到右边的评论部分一直在变(星星变颜色)。这是因为有3个不同的审查微服务，每次都调用不同的微服务。让我们将所有微服务绑定到版本1:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="de05" class="kq jf hi km b fi kr ks l kt ku">istioctl create -f samples/bookinfo/routing/route-rule-all-v1-mtls.yaml</span></pre><p id="4651" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将创建将所有微服务固定到版本1所需的虚拟服务和目标规则。现在，如果您返回到产品页面并刷新浏览器，什么都不会改变，因为评论微服务现在被固定到版本1。</p><p id="ed61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要将特定用户(例如Jason)固定到特定版本(v2)，我们可以执行以下操作:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="208b" class="kq jf hi km b fi kr ks l kt ku">istioctl replace -f samples/bookinfo/routing/route-rule-reviews-test-v2.yaml</span></pre><p id="ec3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据此规则，如果您使用用户名“Jason”登录产品页面，您应该会看到评论微服务的v2版本。</p><p id="79a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要清理所有目的地规则，请运行以下命令，现在我们从3个不同版本的微服务开始:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="0ba4" class="kq jf hi km b fi kr ks l kt ku">istioctl delete -f samples/bookinfo/routing/route-rule-all-v1.yaml</span></pre><h1 id="9124" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">清除</h1><p id="9b8e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这包含了我想在GKE上展示的Istio 0.8.0的所有基本功能。为了清理，我们先删除BookInfo应用程序:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="94eb" class="kq jf hi km b fi kr ks l kt ku">samples/bookinfo/kube/cleanup.sh</span></pre><p id="b905" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确认BookInfo应用程序已删除:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a94a" class="kq jf hi km b fi kr ks l kt ku">istioctl get gateway istioctl get virtualservices kubectl get pods</span></pre><p id="f4aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，清理Istio:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="2f1d" class="kq jf hi km b fi kr ks l kt ku">kubectl delete -f install/kubernetes/istio-demo.yaml</span></pre><p id="b32b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确认Istio已离开:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="172d" class="kq jf hi km b fi kr ks l kt ku">kubectl get pods -n istio-system</span></pre><p id="1151" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kv">原载于2018年6月7日meteatamel.wordpress.com</em><a class="ae jd" href="https://meteatamel.wordpress.com/2018/06/07/istio-101-0-8-0-on-gke/" rel="noopener ugc nofollow" target="_blank"><em class="kv"/></a><em class="kv">。</em></p></div></div>    
</body>
</html>