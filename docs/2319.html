<html>
<head>
<title>Migrate users with credentials to AlloyDB or another CloudSQL instance.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将具有凭证的用户迁移到AlloyDB或另一个CloudSQL实例。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/migrate-users-with-credentials-from-cloudsql-to-another-instance-or-alloydb-for-postgresql-e377a222d3f8?source=collection_archive---------1-----------------------#2022-08-21">https://medium.com/google-cloud/migrate-users-with-credentials-from-cloudsql-to-another-instance-or-alloydb-for-postgresql-e377a222d3f8?source=collection_archive---------1-----------------------#2022-08-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1c1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据库用户和角色是数据库的组成部分，需要作为整个数据库对象的一部分进行迁移。我们可能会遇到这样的情况:将用户从具有相同密码和权限的PostgreSQL托管实例迁移到另一个实例。随着AlloyDB在preview中可用，我们可能会有一个用例将用户从CloudSQL迁移到AlloyDB，并提供数据来验证概念。</p><p id="fcc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PostgreSQL提供pg_dumpall命令行来迁移包含用户和角色的多个数据库的完整实例。下面是从PostgreSQL导出用户或角色的示例命令。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="b2b8" class="jm jn hi ji b fi jo jp l jq jr">pg_dumpall -h &lt;&lt;CLOUD_SQL_INSTANCE_IP&gt;&gt; -U postgres <strong class="ji hj">-r</strong> — if-exists -c</span></pre><p id="469c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们假设一个源云SQL实例具有以下用户和角色。突出显示的是用户创建的，我们将使用pg_dumpall迁移它。</p><figure class="jd je jf jg fd jt er es paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="er es js"><img src="../Images/59e3a50f4a5a4363113807ea2a8f88a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5jaT7Rjuj9CJUNN0xTI1vA.png"/></div></div></figure><h2 id="9c39" class="jm jn hi bd ka kb kc kd ke kf kg kh ki iq kj kk kl iu km kn ko iy kp kq kr ks bi translated">不使用密码导出用户和角色</h2><p id="6b69" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">现在让我们运行pg_dumpall命令并检查和输出。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="e22b" class="jm jn hi ji b fi jo jp l jq jr">deepakmahto@db-benchmark:~$ pg_dumpall -h &lt;&lt;CLOUD_SQL_INSTANCE_IP&gt;&gt; -U postgres -r --if-exists -c<br/>Password: <br/> — <br/> — PostgreSQL database cluster dump<br/> —</span><span id="8f76" class="jm jn hi ji b fi ky jp l jq jr">SET default_transaction_read_only = off;</span><span id="f1e0" class="jm jn hi ji b fi ky jp l jq jr">SET client_encoding = ‘UTF8’;<br/>SET standard_conforming_strings = on;</span><span id="84dc" class="jm jn hi ji b fi ky jp l jq jr">pg_dumpall: error: query failed: <strong class="ji hj"><em class="kz">ERROR: permission denied for table pg_authid</em></strong><br/>pg_dumpall: error: query was: <strong class="ji hj">SELECT rolname FROM pg_authid WHERE rolname !~ ‘^pg_’ ORDER BY 1</strong></span></pre><p id="6a7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">只有超级用户有权访问pg_authid表，它不能作为托管实例一部分从主用户(postgres)访问。一种方法是导出没有密码的用户和角色，并带有“—无角色密码”选项。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="5199" class="jm jn hi ji b fi jo jp l jq jr">deepakmahto@db-benchmark:~$ pg_dumpall -h &lt;&lt;CLOUD_SQL_INSTANCE_IP&gt;&gt; -U postgres -r <strong class="ji hj"><em class="kz">--no-role-passwords</em></strong> --if-exists -c<br/>Password:</span><span id="8f17" class="jm jn hi ji b fi ky jp l jq jr">..<br/>CREATE ROLE cloudsqlsuperuser;<br/>ALTER ROLE cloudsqlsuperuser WITH NOSUPERUSER INHERIT CREATEROLE CREATEDB LOGIN NOREPLICATION NOBYPASSRLS;<br/>CREATE ROLE postgres;<br/>ALTER ROLE postgres WITH NOSUPERUSER INHERIT CREATEROLE CREATEDB LOGIN REPLICATION NOBYPASSRLS;<br/>CREATE ROLE readuser;<br/>ALTER ROLE readuser WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB LOGIN NOREPLICATION NOBYPASSRLS;<br/>..<br/>GRANT pg_read_all_data TO readuser GRANTED BY postgres;<br/>..</span></pre><p id="11aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它将导出所有用户和角色，包括由CloudSQL内部维护的托管用户，如cloudsqlsuperuser、cloudsqladmin等。</p><p id="d750" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以应用操作系统级命令，删除CloudSQL实例本地的用户和角色，并且只删除除托管用户之外的角色\用户。作为ALTER ROLE的一部分，我们添加了一个额外的命令来替换NOSUPERUSER，以避免超级用户权限问题。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="1d3a" class="jm jn hi ji b fi jo jp l jq jr">PGPASSWORD=******* pg_dumpall -h &lt;&lt;CLOUD_SQL_INSTANCE_IP&gt;&gt; -U postgres -r --no-role-passwords --if-exists -c <strong class="ji hj"><em class="kz">| sed '/cloudsqladmin/d;/cloudsqlagent/d;/cloudsqliamserviceaccount/d;/cloudsqliamuser/d;/cloudsqlimportexport/d;/cloudsqlreplica/d;/cloudsqlsuperuser/d;s/NOSUPERUSER//g'</em></strong></span><span id="a4ed" class="jm jn hi ji b fi ky jp l jq jr">...<br/>DROP ROLE IF EXISTS readuser;<br/>DROP ROLE IF EXISTS readwrite;<br/>DROP ROLE IF EXISTS replication_user;<br/>...</span><span id="447c" class="jm jn hi ji b fi ky jp l jq jr">CREATE ROLE postgres;<br/>ALTER ROLE postgres WITH  INHERIT CREATEROLE CREATEDB LOGIN REPLICATION NOBYPASSRLS;<br/>CREATE ROLE readuser;<br/>ALTER ROLE readuser WITH  INHERIT NOCREATEROLE NOCREATEDB LOGIN NOREPLICATION NOBYPASSRLS;<br/>CREATE ROLE readwrite;<br/>ALTER ROLE readwrite WITH  INHERIT NOCREATEROLE NOCREATEDB LOGIN NOREPLICATION NOBYPASSRLS;<br/>CREATE ROLE replication_user;<br/>ALTER ROLE replication_user WITH  INHERIT NOCREATEROLE NOCREATEDB LOGIN REPLICATION NOBYPASSRLS;</span></pre><p id="98af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，虽然我们已经导出了用户和角色，但是密码呢，如何将其从一个托管实例导出到另一个托管实例呢？</p><h2 id="6e35" class="jm jn hi bd ka kb kc kd ke kf kg kh ki iq kj kk kl iu km kn ko iy kp kq kr ks bi translated">使用pg_shadow导出密码</h2><p id="09ca" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">CloudSQL提供了一个数据库标志“cloudsql.pg_shadow_select_role”，可以在pg_shadow视图中为指定用户选择角色。<a class="ae la" href="https://www.postgresql.org/docs/current/view-pg-shadow.html" rel="noopener ugc nofollow" target="_blank"> pg_shadow </a>视图提供从pg_authid查询有登录权限的用户的属性。</p><p id="b532" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第一步中，我们将在postgres master user.pg_authid的cloudsql实例上启用“cloudsql.pg_shadow_select_role”。更改数据库标志不需要重启实例。</p><figure class="jd je jf jg fd jt er es paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="er es lb"><img src="../Images/c5d23ad6f4682b6e7094c46f097bdb0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bzZbLMbh-nVDAbl0VhPhoQ.png"/></div></div></figure><p id="276f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们使用psql连接并验证访问。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="38fb" class="jm jn hi ji b fi jo jp l jq jr">postgres=&gt; show cloudsql.pg_shadow_select_role ;<br/> cloudsql.pg_shadow_select_role <br/> — — — — — — — — — — — — — — — — <br/> <strong class="ji hj"><em class="kz">postgres</em></strong><br/>(1 row)</span><span id="dc22" class="jm jn hi ji b fi ky jp l jq jr">postgres=&gt; select usename from <strong class="ji hj"><em class="kz">pg_shadow</em></strong> where usename not like 'cloudsql%';<br/>     usename      <br/>------------------<br/> readuser<br/> readwrite<br/> replication_user<br/> postgres<br/>(4 rows)</span></pre><p id="3674" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以通过创建alter语句导出密码，作为查询pg_shadow视图的一部分。pg_shadow视图显示基于密码加密设置的密码。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="26cf" class="jm jn hi ji b fi jo jp l jq jr">postgres=&gt; show password_encryption;<br/> password_encryption <br/>---------------------<br/><strong class="ji hj"><em class="kz"> scram-sha-256</em></strong><br/>(1 row)</span><span id="95ac" class="jm jn hi ji b fi ky jp l jq jr">postgres=&gt; select 'alter user '|| usename || ' with encrypted password '|| '''' || passwd || ''''||';' from pg_shadow where usename not like 'cloudsql%';</span></pre><p id="e4b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">pg_dumpall命令行可用于根据需要导出所有用户和角色，并在查询pg_shadow时发布启用数据库标志，我们可以应用alter password命令。</p><h2 id="cd44" class="jm jn hi bd ka kb kc kd ke kf kg kh ki iq kj kk kl iu km kn ko iy kp kq kr ks bi translated">结论</h2><p id="0f16" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">现在我们了解了将用户及其权限从一个CloudSQL实例导出到另一个实例的总体方法。我们将结合整体命令并使用管道方法来移动用户和密码，而不使用暂存文件或存储。假设我们有到源和目标实例的必要连接。</p><h2 id="93f9" class="jm jn hi bd ka kb kc kd ke kf kg kh ki iq kj kk kl iu km kn ko iy kp kq kr ks bi translated">步骤1 :-导出没有密码的用户和角色</h2><p id="7268" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">管道pgdumpall和psql，用于导出没有密码的用户和角色。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="285c" class="jm jn hi ji b fi jo jp l jq jr">PGPASSWORD=******* <strong class="ji hj"><em class="kz">pg_dumpall</em></strong> -h &lt;&lt;<strong class="ji hj">CLOUD_SQL_INSTANCE_SOURCE_IP</strong>&gt;&gt; -U postgres -r — no-role-passwords | sed '/cloudsqladmin/d;/cloudsqlagent/d;/cloudsqliamserviceaccount/d;/cloudsqliamuser/d;/cloudsqlimportexport/d;/cloudsqlreplica/d;/cloudsqlsuperuser/d;s/NOSUPERUSER//g' <strong class="ji hj">|</strong> PGPASSWORD=********* <strong class="ji hj"><em class="kz">psql</em></strong> -h &lt;&lt;<strong class="ji hj">TARGET_CLOUDSQL_OR_ALLOYDB</strong>&gt;&gt; -U postgres</span></pre><h2 id="cc2e" class="jm jn hi bd ka kb kc kd ke kf kg kh ki iq kj kk kl iu km kn ko iy kp kq kr ks bi translated"><strong class="ak">步骤2:- </strong>生成更改密码并应用于目标</h2><p id="5b5d" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">使用sql从源生成alter命令的管道psql在pg_shadow视图上为SELECT启用必要的标志，并使用psql和目标实例的连接详细信息应用它。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="27a5" class="jm jn hi ji b fi jo jp l jq jr">deepakmahto@db-benchmark:~$ PGPASSWORD=******* <strong class="ji hj">psql</strong> -h &lt;&lt;<strong class="ji hj">CLOUD_SQL_INSTANCE_SOURCE_IP</strong>&gt;&gt; -U postgres -t <strong class="ji hj">-c "select 'alter user '|| usename || ' with encrypted password '|| ''''|| passwd || ''''||';' from pg_shadow where usename not like 'cloudsql%'" | </strong>PGPASSWORD=******* <strong class="ji hj">psql</strong> -h &lt;&lt;<strong class="ji hj">TARGET_CLOUDSQL_OR_ALLOYDB</strong>&gt;&gt; -U postgres<br/>ALTER ROLE<br/>ALTER ROLE<br/>ALTER ROLE<br/>ALTER ROLE</span></pre></div></div>    
</body>
</html>