<html>
<head>
<title>Cloud SQL with private IP only: the Good, the Bad and the Ugly</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">只有私有IP的云SQL:好的、坏的和丑陋的</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-sql-with-private-ip-only-the-good-the-bad-and-the-ugly-de4ac23ce98a?source=collection_archive---------0-----------------------#2021-01-05">https://medium.com/google-cloud/cloud-sql-with-private-ip-only-the-good-the-bad-and-the-ugly-de4ac23ce98a?source=collection_archive---------0-----------------------#2021-01-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/473bf757c7df6d2eb9758155a3828655.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W_-c7VJbmQjK3Pj5xahMew.png"/></div></div></figure><p id="3a1c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">数据是所有公司的新金矿</strong>，这个<strong class="is hj">宝藏必须得到安全保护</strong>。这就是为什么多年来，任何数据库管理员的一个常见的良好做法是<strong class="is hj">删除所有对数据库的公共访问</strong>，尤其是公共IP，并且<strong class="is hj">只授予来自私有IP的访问。</strong> <br/>这一“黄金”规则由所有安全团队强制执行，他们要求<strong class="is hj">任何云部署都采用相同的模式。</strong></p><p id="d687" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/sql" rel="noopener ugc nofollow" target="_blank">云SQL服务</a>，Google Cloud上的托管数据库服务，允许您:</p><ul class=""><li id="a945" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">在您的实例上设置一个<a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/private-ip" rel="noopener ugc nofollow" target="_blank">私有IP，并将其直接连接到您选择的VPC</a></li><li id="d036" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">从您的实例中删除<a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/configure-ip#disable-public" rel="noopener ugc nofollow" target="_blank">公共IP</a></li></ul><p id="02d2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">得益于这些特性，<strong class="is hj">您可以强制执行安全团队需求</strong>。</p><blockquote class="kd"><p id="151a" class="ke kf hi bd kg kh ki kj kk kl km jn dx translated">但是，在我们的日常工作中，云SQL实例上没有公共IP会是一个问题吗？</p></blockquote><p id="8abd" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">让我们通过3个用例来验证这一点:</p><ol class=""><li id="d6a6" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ks jv jw jx bi translated"><strong class="is hj">计算引擎</strong>连接性</li><li id="8e09" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ks jv jw jx bi translated"><strong class="is hj">无服务器服务</strong>连接性</li><li id="6642" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ks jv jw jx bi translated"><strong class="is hj">本地环境</strong>连通性</li></ol></div><div class="ab cl kt ku gp kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hb hc hd he hf"><h2 id="ca2c" class="la lb hi bd lc ld le lf lg lh li lj lk jb ll lm ln jf lo lp lq jj lr ls lt lu bi translated">云SQL代理二进制文件</h2><p id="c455" class="pw-post-body-paragraph iq ir hi is b it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj lz jl jm jn hb bi translated">在深入讨论用例之前，我想快速聚焦一下<a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/sql-proxy" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">云SQL代理</strong> </a>的主要特性</p><ul class=""><li id="550b" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">这个二进制打开一个<strong class="is hj">安全的端到端加密隧道</strong>。总之，即使你的数据库没有SSL证书，数据在传输过程中也会被加密。</li><li id="6a8a" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">在打开隧道之前，二进制代码<strong class="is hj">会对照IAM服务API检查当前凭证是否被授权访问云SQL实例</strong>。除了通过用户/密码进行的标准数据库认证之外，这是一个额外的安全层。</li><li id="771e" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">该隧道可以在本地端口(TCP连接模式)或Unix套接字上开放(在Windows环境下不可能)</li></ul></div><div class="ab cl kt ku gp kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hb hc hd he hf"><h1 id="30dd" class="ma lb hi bd lc mb mc md lg me mf mg lk mh mi mj ln mk ml mm lq mn mo mp lt mq bi translated">好处:计算引擎连接</h1><p id="3a95" class="pw-post-body-paragraph iq ir hi is b it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj lz jl jm jn hb bi translated">因为这种“私有IP安全模式”是为传统架构(即本地虚拟机和私有网络)构建的<strong class="is hj">，所以约束<strong class="is hj">完全符合IaaS世界</strong>(即计算引擎+ VPC)。<br/> <em class="mr">我提到了计算引擎，但它也适用于所有使用计算引擎实例的服务:数据流、数据块、GKE……</em></strong></p><ul class=""><li id="8ca8" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">将您的虚拟机部署在与云SQL实例私有IP相同的VPC中。</li><li id="74b1" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">使用云SQL实例私有IP从部署在计算引擎上的应用程序访问它。</li><li id="ef0f" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">如果需要，打开所需的防火墙规则。</li></ul><p id="7b32" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">那是<strong class="is hj"> <em class="mr">【好】</em> </strong>！！</p><p id="a320" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mr">注:云SQL代理在这种情况下的用法可以讨论。它通过检查IAM服务和加密通信的授权来增加额外的安全层，但也增加了额外的延迟和潜在的故障点。这是权衡的问题。</em></p><h1 id="83f1" class="ma lb hi bd lc mb ms md lg me mt mg lk mh mu mj ln mk mv mm lq mn mw mp lt mq bi translated">坏处:无服务器服务连接</h1><p id="b4fc" class="pw-post-body-paragraph iq ir hi is b it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj lz jl jm jn hb bi translated">当我们使用云的<strong class="is hj">“新世界”</strong>，无服务器模式<a class="ae jo" href="https://cloud.google.com/run" rel="noopener ugc nofollow" target="_blank">，云运行</a>、<a class="ae jo" href="https://cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">云功能</a>和<a class="ae jo" href="https://cloud.google.com/appengine" rel="noopener ugc nofollow" target="_blank">应用引擎</a>时，情况就不那么好了。</p><p id="8c5d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">事实上，根据定义，当您在无服务器平台上部署时，您<strong class="is hj">不必管理服务器</strong>，因此<strong class="is hj">服务器不在您的VPC </strong>中。因此，<strong class="is hj">不可能开箱即用地访问连接到项目VPC的云SQL私有IP </strong>。</p><p id="08cd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你深入研究<a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/connect-run" rel="noopener ugc nofollow" target="_blank">云运行</a>、<a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/connect-functions#public-ip-default" rel="noopener ugc nofollow" target="_blank">云功能</a>和<a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/connect-app-engine-standard#public-ip-default" rel="noopener ugc nofollow" target="_blank">应用引擎</a>，你会发现<strong class="is hj">如何将你的云SQL实例连接到你的无服务器服务</strong>，这得益于一个内置特性:</p><blockquote class="mx my mz"><p id="61d1" class="iq ir mr is b it iu iv iw ix iy iz ja na jc jd je nb jg jh ji nc jk jl jm jn hb bi translated">将云SQL实例连接名称添加到您的配置中，实例启动时会自动创建一个隧道。</p></blockquote><p id="6af6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">实际上是<a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/sql-proxy" rel="noopener ugc nofollow" target="_blank">云SQL代理</a>二进制在<a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/sql-proxy#unix_sockets" rel="noopener ugc nofollow" target="_blank"> Unix socket模式</a>下打开的连接。但是<strong class="is hj">这个解决方案只有在云SQL实例有一个公共IP </strong>的情况下才有效。<br/>在<strong class="is hj">私有IP only </strong>的情况下，即使<a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/sql-proxy#private-ip" rel="noopener ugc nofollow" target="_blank">私有IP连接模式与云SQL代理</a>存在，它<strong class="is hj">也不起作用！</strong></p><h2 id="7ca1" class="la lb hi bd lc ld le lf lg lh li lj lk jb ll lm ln jf lo lp lq jj lr ls lt lu bi translated">将无服务器服务连接到云SQL私有IP</h2><p id="9601" class="pw-post-body-paragraph iq ir hi is b it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj lz jl jm jn hb bi translated">希望有一个解决方案。你可以<strong class="is hj">点击云SQL连接教程</strong>中的 <code class="du nd ne nf ng b"><strong class="is hj">private IP</strong></code> <strong class="is hj">标签来做这个(云函数的<a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/connect-functions#configuring" rel="noopener ugc nofollow" target="_blank">例子)。</a></strong></p><p id="82d8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">总之，您需要:</p><ul class=""><li id="17a1" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><strong class="is hj">创建一个</strong> <a class="ae jo" href="https://cloud.google.com/vpc/docs/configure-serverless-vpc-access" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">无服务器VPC连接器</strong> </a>，与您的无服务器服务在同一区域。当然，连接到与云SQL实例相同的VPC。<br/> <em class="mr">请注意，今天，所有地区都支持无服务器VPC连接器，但有一段时间并非如此。</em></li><li id="e4f2" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><strong class="is hj">使用这个VPC连接器</strong>部署您的无服务器服务，由<a class="ae jo" href="https://cloud.google.com/run/docs/configuring/connecting-vpc" rel="noopener ugc nofollow" target="_blank">云运行</a>、<a class="ae jo" href="https://cloud.google.com/functions/docs/networking/connecting-vpc" rel="noopener ugc nofollow" target="_blank">云功能</a>和<a class="ae jo" href="https://cloud.google.com/appengine/docs/standard/go/connecting-vpc" rel="noopener ugc nofollow" target="_blank">应用引擎</a>支持</li><li id="7ae0" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">在您的应用中，<strong class="is hj">使用云SQL私有IP </strong>(而不是Unix套接字连接)</li></ul><p id="3d24" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个解决方案是可行的，但是在连接链中引入了一个<strong class="is hj">新的网络元件</strong>、一个<strong class="is hj">附加成本</strong>和一个<strong class="is hj">可能的新故障点</strong>。</p><p id="6c37" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">那就是<strong class="is hj"><em class="mr"/></strong>！！</p><h1 id="7b7d" class="ma lb hi bd lc mb ms md lg me mt mg lk mh mu mj ln mk mv mm lq mn mw mp lt mq bi translated">丑陋的:当地环境的连通性</h1><p id="e56c" class="pw-post-body-paragraph iq ir hi is b it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj lz jl jm jn hb bi translated">当您<strong class="is hj">想要通过安装在您计算机</strong>上的首选数据库IDE<strong class="is hj">查询您的数据库</strong>时，您需要将您的本地环境连接到云SQL实例，从而通过私有IP。</p><p id="db2b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为云SQL实例没有公共IP，你<strong class="is hj">无法从互联网</strong>(你的电脑)直接到达，<strong class="is hj">云SQL代理也无法</strong>。这里的解决方案是<strong class="is hj">创建一个</strong> <a class="ae jo" href="https://en.wikipedia.org/wiki/Bastion_host" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">堡垒主机</strong> </a>:一个连接外部世界(公有IP)和内部世界(私有IP)的桥梁VM。</p><p id="1777" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，<a class="ae jo" href="https://cloud.google.com/compute/docs/instances/create-start-instance" rel="noopener ugc nofollow" target="_blank">创建了一个小型计算引擎实例</a>，例如一个<a class="ae jo" href="https://cloud.google.com/compute/docs/machine-types#machine_types" rel="noopener ugc nofollow" target="_blank">f1-micro</a>(非常便宜，每月不到5美元)，来实现这一点。</p><blockquote class="mx my mz"><p id="6264" class="iq ir mr is b it iu iv iw ix iy iz ja na jc jd je nb jg jh ji nc jk jl jm jn hb bi translated"><strong class="is hj">安全团队要求</strong>:所有虚拟机不能有公共IP。当然，0.0.0.0/0防火墙规则是不允许的，尤其是在端口22 (ssh)上</p></blockquote><h2 id="f303" class="la lb hi bd lc ld le lf lg lh li lj lk jb ll lm ln jf lo lp lq jj lr ls lt lu bi translated">没有公共IP的堡垒主机</h2><p id="5907" class="pw-post-body-paragraph iq ir hi is b it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj lz jl jm jn hb bi translated">新的约束要处理！但这是一致的:<em class="mr">如果你关上门，那是为了让窗户开着！！</em> <br/>所以没问题，Google Cloud为此提供了一个很棒很简单的解决方案:<a class="ae jo" href="https://cloud.google.com/iap" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">身份感知代理(IAP) </strong> </a></p><p id="92fe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用IAP，您只需授予<a class="ae jo" href="https://cloud.google.com/iap/docs/using-tcp-forwarding#create-firewall-rule" rel="noopener ugc nofollow" target="_blank"> Google Cloud IAP IP范围</a> <code class="du nd ne nf ng b"><a class="ae jo" href="https://cloud.google.com/iap/docs/using-tcp-forwarding#create-firewall-rule" rel="noopener ugc nofollow" target="_blank">35.235.240.0</a>/20</code> <a class="ae jo" href="https://cloud.google.com/iap/docs/using-tcp-forwarding#create-firewall-rule" rel="noopener ugc nofollow" target="_blank">即可在防火墙规则</a>中的端口22上访问您的计算引擎。因此，<strong class="is hj">不需要打开</strong> <code class="du nd ne nf ng b"><strong class="is hj">0.0.0.0/0</strong></code>(整个互联网)就可以到达计算引擎<code class="du nd ne nf ng b">ssh</code>端口！</p><p id="bf1e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，使用<a class="ae jo" href="https://cloud.google.com/sdk/gcloud/reference/compute/ssh" rel="noopener ugc nofollow" target="_blank"> gcloud SDK连接到您的bastion主机计算引擎实例</a> <br/> <code class="du nd ne nf ng b">gcloud compute ssh &lt;Instance Name&gt; --zone=&lt;Your Zone&gt;</code> <br/>和<strong class="is hj">神奇的事情发生了！</strong>g cloud SDK<strong class="is hj">自动检测到缺少计算引擎实例的公共IP </strong>并且<strong class="is hj">自动打开IAP隧道以SSH连接实例</strong>。对用户来说是隐形的！</p><p id="0637" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mr">凭证(这里是用户帐户，但也可能是服务帐户)</em> <strong class="is hj"> <em class="mr">需要有足够的权限来创建IAP隧道</em> </strong> <em class="mr">。角色有</em><a class="ae jo" href="https://cloud.google.com/iap/docs/using-tcp-forwarding#grant-permission" rel="noopener ugc nofollow" target="_blank"><em class="mr">roles/IAP . tunnelresourceactor创建隧道</em> </a> <em class="mr">和</em><a class="ae jo" href="https://cloud.google.com/compute/docs/access/iam#connectinginstanceadmin" rel="noopener ugc nofollow" target="_blank"><em class="mr">roles/compute . instance admin . v1访问虚拟机</em> </a></p><p id="9844" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您已经<strong class="is hj">连接到bastion主机，但是您还没有连接到云SQL实例</strong> …</p><h2 id="eab5" class="la lb hi bd lc ld le lf lg lh li lj lk jb ll lm ln jf lo lp lq jj lr ls lt lu bi translated">IAP隧道、SSL端口转发和云SQL代理</h2><p id="ef9c" class="pw-post-body-paragraph iq ir hi is b it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj lz jl jm jn hb bi translated">而在那里，<strong class="is hj"><em class="mr"/></strong>的“丑陋”部分开始了。我们有两件事要完成</p><ol class=""><li id="4f45" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ks jv jw jx bi translated">通过私有IP将堡垒主机连接到云SQL实例</li><li id="a71a" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ks jv jw jx bi translated"><strong class="is hj">将本地环境数据库连接请求</strong>转发给堡垒主机<strong class="is hj">通过云SQL代理隧道到达云SQL实例</strong></li></ol></div><div class="ab cl kt ku gp kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hb hc hd he hf"><p id="c900" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> 1。来自堡垒主机<br/> </strong>的云SQL实例连接为此，我们需要云SQL代理在堡垒主机和云SQL实例之间打开一个隧道。</p><p id="fe34" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="mr">第一期:</em> </strong>因为你<strong class="is hj">还没有公共IP，所以无法上网！</strong> <br/>您可以选择<a class="ae jo" href="https://cloud.google.com/nat/docs/using-nat" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">创建一个云NAT </strong> </a> <strong class="is hj"> </strong>在您的bastion主机上计算实例IP范围。但是，最简单的方法是<strong class="is hj">将它下载到您的本地环境</strong>中，然后<strong class="is hj">将它复制到bastion主机</strong>上。为此，您可以使用以下命令。<br/> <code class="du nd ne nf ng b">gcloud compute scp /local/path/to/cloud_sql_proxy &lt;instanceName&gt;:/tmp</code> <br/> <em class="mr">因为可以通过IAP打开SSH连接，所以也可以通过IAP使用</em> <code class="du nd ne nf ng b"><em class="mr">scp</em></code> <em class="mr">协议(ssh copy)来</em> <strong class="is hj"> <em class="mr">复制文件！神奇！！</em> </strong></p><p id="4547" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">很好，现在您已经有了bastion主机计算引擎实例上的二进制文件，您<strong class="is hj">想要测试连接是否工作</strong>。您可以运行这些命令</p><pre class="nh ni nj nk fd nl ng nm nn aw no bi"><span id="fc92" class="la lb hi ng b fi np nq l nr ns">#Connect to bastion host<br/>gcloud compute ssh &lt;instance Name&gt; --zone=&lt;Your zone&gt;<br/>#Change the permission of the Cloud SQL proxy binary (do it only once)<br/>chmod +x /tmp/cloud_sql_proxy<br/>#Connect to your Cloud SQL instance<br/>/tmp/cloud_sql_proxy --<!-- -->instances=&lt;connection_name&gt;=tcp:3306</span></pre><p id="12b8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mr">你可以在你的云SQL实例</em>的页面中找到 <code class="du nd ne nf ng b"><em class="mr">connection_name</em></code> <em class="mr"/></p><figure class="nh ni nj nk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nt"><img src="../Images/e6d8f2a4347e68550d34e84cc2843d05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BY-osvdBAKqWB5BxTGe_lg.png"/></div></div></figure><p id="00d1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="mr">第二期:</em> </strong>不管用！而且原因很多！</p><ul class=""><li id="0586" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">如果您使用默认参数创建了bastion主机<strong class="is hj">计算引擎，尤其是API作用域部分，那么您没有足够的作用域来访问云SQL APIs。<br/>要解决这个问题，你需要<strong class="is hj">停止你的计算引擎</strong>，编辑它并<strong class="is hj">定制作用域</strong></strong></li></ul><figure class="nh ni nj nk fd ij er es paragraph-image"><div class="er es nu"><img src="../Images/16fa342ae638138284dd430373c5e4ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/format:webp/1*yMBBX8rueuXP0zB2LZfAFA.png"/></div></figure><ul class=""><li id="033d" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">创建云SQL隧道时，检查当前凭证(这里是<a class="ae jo" href="https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances" rel="noopener ugc nofollow" target="_blank">计算引擎凭证</a> ) <strong class="is hj">的<strong class="is hj"> IAM权限</strong>。计算引擎服务帐户没有足够的权限。<br/>要解决这个问题，请确保在服务帐户上授予最少的<a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/sql-proxy#permissions" rel="noopener ugc nofollow" target="_blank">角色:<code class="du nd ne nf ng b">Cloud SQL client</code>、<code class="du nd ne nf ng b">Cloud SQL editor</code>或<code class="du nd ne nf ng b">Cloud SQL admin</code> <br/>、<em class="mr">计算引擎默认服务帐户具有角色/编辑角色。对我们的用例来说太宽泛了，但是足够了。</em></a></strong></li><li id="1a4d" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">最后，默认情况下，当<strong class="is hj">您请求Google Cloud API时，会请求公共DNS</strong>。当云SQL代理在创建隧道时请求云SQL API或IAM服务时，就会出现这种情况。并且，因为bastion主机计算引擎<strong class="is hj">没有公共IP，它可以到达互联网和</strong> <code class="du nd ne nf ng b"><strong class="is hj">googleapis.com</strong></code> <strong class="is hj">公共DNS。</strong> <br/>要解决这个，你有2个方案。要么<strong class="is hj">像之前提议的那样设置一个云NAT </strong>，要么使用Google Cloud VPC的一个狡猾的功能:<strong class="is hj">允许bastion主机计算引擎当前的</strong> <a class="ae jo" href="https://cloud.google.com/vpc/docs/configure-private-google-access#config-pga" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">子网调用私有的</strong></a><code class="du nd ne nf ng b"><a class="ae jo" href="https://cloud.google.com/vpc/docs/configure-private-google-access#config-pga" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">googleapis.com</strong></a></code><a class="ae jo" href="https://cloud.google.com/vpc/docs/configure-private-google-access#config-pga" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">DNS</strong></a>。为此，请转到您的VPC，选择正确的子网并进行编辑。然后选择私有Google Access单选按钮的<code class="du nd ne nf ng b">On</code>，并保存。</li></ul><figure class="nh ni nj nk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nv"><img src="../Images/d01b8106ece6b744740ebd7d4c39c7b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/1*DLsmYgZaZgAChZntT5i-aA.png"/></div></div></figure><p id="1f18" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">太好了！！现在<strong class="is hj"> bastion主机计算引擎可以使用云SQL代理</strong>打开从本地端口3306到云SQL实例的隧道，通过私有IP。</p></div><div class="ab cl kt ku gp kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hb hc hd he hf"><p id="4a06" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> 2。将本地环境流量转发到云SQL实例<br/> </strong>为了实现这一点，<strong class="is hj">我们不会使用</strong> <code class="du nd ne nf ng b"><strong class="is hj">gcloud ssh</strong></code> <strong class="is hj">内置特性，而是使用另一种解决方案</strong>。除了与<code class="du nd ne nf ng b">ssh</code>直接连接计算实例之外，<strong class="is hj"> gcloud SDK还允许在任何端口上创建隧道</strong>。</p><p id="4c3c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，让我们<strong class="is hj">在bastion主机</strong>计算引擎实例的端口22上创建一个隧道，并定义一个任意的本地端口(这里是<code class="du nd ne nf ng b">4226</code></p><pre class="nh ni nj nk fd nl ng nm nn aw no bi"><span id="ca9f" class="la lb hi ng b fi np nq l nr ns">gcloud compute start-iap-tunnel &lt;instance Name&gt; 22 \<br/>  --zone=&lt;Your zone&gt; --local-host-port=localhost:4226</span></pre><p id="5bfd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">太好了，隧道打开了，我们可以用它来连接<code class="du nd ne nf ng b">ssh</code>中的bastion主机计算引擎实例。</p><blockquote class="mx my mz"><p id="5b95" class="iq ir mr is b it iu iv iw ix iy iz ja na jc jd je nb jg jh ji nc jk jl jm jn hb bi translated">让隧道打开，在一个终端运行，并打开一个新的。</p></blockquote><p id="25cd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，<strong class="is hj">让我们把</strong> <code class="du nd ne nf ng b"><strong class="is hj">ssh</strong></code> <strong class="is hj">连接到它的</strong>。在一个命令中，您将<strong class="is hj">实现几个强制性的事情来建立连接</strong>:</p><ul class=""><li id="090e" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><strong class="is hj">创建一个从您的本地环境转发到堡垒主机的端口</strong>计算引擎<br/> <code class="du nd ne nf ng b">-L 3306:localhost:3306</code> <br/> <em class="mr">“我的本地端口</em> <code class="du nd ne nf ng b"><em class="mr">3306</em></code> <em class="mr">在目标虚拟机(此处为堡垒主机)上转发到</em> <code class="du nd ne nf ng b"><em class="mr">3306</em></code> <em class="mr">在</em> <code class="du nd ne nf ng b"><em class="mr">localhost</em></code> <em class="mr">(即目标虚拟机)上打开的端口</em></li><li id="7875" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><strong class="is hj">重用在第一次<code class="du nd ne nf ng b">ssh</code>连接到bastion主机计算引擎(或<code class="du nd ne nf ng b">scp</code>)时由Google自动创建的ssh密钥</strong>。该私钥存储在当前用户<code class="du nd ne nf ng b">~/.ssh</code> <br/> <code class="du nd ne nf ng b">-i ~/.ssh/google_compute_engine</code>的<code class="du nd ne nf ng b">home</code>目录中</li><li id="3ff9" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><strong class="is hj">在<code class="du nd ne nf ng b">localhost</code>环境下，通过现有的IAP隧道</strong>打开一个 <code class="du nd ne nf ng b"><strong class="is hj">ssh</strong></code> <strong class="is hj">连接，从本地端口<code class="du nd ne nf ng b">4226<br/>-p 4226 localhost</code>转发<code class="du nd ne nf ng b">ssh</code>流量</strong></li><li id="4e8f" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">当连接到bastion主机计算引擎时，<strong class="is hj">您希望运行云SQL代理，在端口<code class="du nd ne nf ng b">3306</code>上创建到云SQL实例</strong>的隧道。为此，在一个<code class="du nd ne nf ng b">--</code> <br/> <code class="du nd ne nf ng b">-- /tmp/cloud_sql_proxy instances=&lt;connection_name&gt;=tcp:3306</code>之后，在远程(堡垒主机)上运行您想要的命令</li></ul><p id="5949" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">把所有这些放在一起</p><pre class="nh ni nj nk fd nl ng nm nn aw no bi"><span id="ca98" class="la lb hi ng b fi np nq l nr ns">ssh <!-- -->-L 3306:localhost:3306 \<br/>  -i ~/.ssh/google_compute_engine \<br/>  -p 4226 localhost \<br/>  -- /tmp/cloud_sql_proxy instances=&lt;connection_name&gt;=tcp:3306</span></pre><p id="4dc7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">现在，你拥有它了！</strong>使用您最喜欢的数据库IDE，在<code class="du nd ne nf ng b">localhost:3306</code>上连接并使用用户名/密码登录您的数据库。</p></div><div class="ab cl kt ku gp kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hb hc hd he hf"><p id="e8d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">哇！！<strong class="is hj">这一切都能够符合一个安全模式</strong>！这是我们已经建立的架构</p><figure class="nh ni nj nk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nw"><img src="../Images/45113109a2a3edb7c83db099ede98d4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TFLt-mq1g2kFPAXGMiNCKw.png"/></div></div></figure><p id="07da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">那就是<strong class="is hj">【丑】</strong>！！</p><h1 id="2bfe" class="ma lb hi bd lc mb ms md lg me mt mg lk mh mu mj ln mk mv mm lq mn mw mp lt mq bi translated">附加副作用</h1><p id="c248" class="pw-post-body-paragraph iq ir hi is b it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj lz jl jm jn hb bi translated">使用带有私有IP的<strong class="is hj">云SQL只会增加警告</strong>。事实上，在项目的VPC和云SQL网络(由Google Cloud管理)之间创建了一个<strong class="is hj">对等关系。<br/>和<strong class="is hj">对等有两个限制:</strong></strong></p><ul class=""><li id="6da0" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">你被限制在每个VPC25个对等点</li><li id="3af9" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">对等之间的<a class="ae jo" href="https://cloud.google.com/vpc/docs/vpc-peering#restrictions" rel="noopener ugc nofollow" target="_blank">传递是不可能的</a></li></ul><p id="a6ba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这一点非常重要，如果你想从另一个项目访问数据库实例的话，<strong class="is hj">可能会成为一个障碍。实际上，从另一个项目的VPC，您希望通过私有IP创建一个与该项目的对等关系，该项目具有要访问的云SQL实例。</strong></p><p id="a503" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，由于传递性的限制，你不能:<strong class="is hj">从另一个项目的VPC看不到云SQL私有IP。</strong> <br/>这里的解决方法是<strong class="is hj">创建一个VPN来对等2个VPC</strong>。<br/>那是euh… <strong class="is hj">“最丑”？？</strong></p><p id="986c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mr">另一个副作用是，如果没有定义公共IP，应用程序脚本应用程序将无法使用云SQL实例。</em></p><h1 id="dfb3" class="ma lb hi bd lc mb ms md lg me mt mg lk mh mu mj ln mk mv mm lq mn mw mp lt mq bi translated">“智能”安全模式至关重要</h1><p id="60f8" class="pw-post-body-paragraph iq ir hi is b it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj lz jl jm jn hb bi translated">在传统世界中，安全问题和数据库的现有模式非常有效。<br/>现在，有了云SQL和云SQL代理，<strong class="is hj">额外的安全层存在，使旧模式无效。</strong></p><blockquote class="mx my mz"><p id="402b" class="iq ir mr is b it iu iv iw ix iy iz ja na jc jd je nb jg jh ji nc jk jl jm jn hb bi translated">如果不允许任何IP范围连接到公共IP，那么<strong class="is hj">有什么问题？</strong></p></blockquote><p id="6b5d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是传统世界中防火墙规则的<strong class="is hj">定义，不是吗？<em class="mr">拒绝所有IP访问我的数据库所在的范围/IP</em></strong></p><blockquote class="mx my mz"><p id="fe1f" class="iq ir mr is b it iu iv iw ix iy iz ja na jc jd je nb jg jh ji nc jk jl jm jn hb bi translated"><strong class="is hj">安全团队关注点</strong>:如何确定不允许IP范围？</p></blockquote><p id="14d8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个问题是合理的，这就是为什么你可以<strong class="is hj">强制执行一个组织政策</strong> ( <a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/connection-org-policy#connection-constraints" rel="noopener ugc nofollow" target="_blank"> <em class="mr">限制</em> </a> <a class="ae jo" href="https://cloud.google.com/sql/docs/mysql/connection-org-policy" rel="noopener ugc nofollow" target="_blank"> <em class="mr">云SQL实例上的授权网络</em> </a>)到<strong class="is hj">阻止在云SQL实例上添加公共IP范围</strong>，这是公司范围内的。</p></div><div class="ab cl kt ku gp kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hb hc hd he hf"><p id="a278" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最终，<strong class="is hj">在云SQL实例上允许一个公共IP避免了许多需要处理的变通方法和奇怪的设计</strong>，并且<strong class="is hj">没有降低安全级别。</strong> <br/>此外，创建的隧道是加密的，保证了高度的安全性和保密性。</p><p id="d953" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云改变了范例(参见<a class="ae jo" href="https://cloud.google.com/beyondcorp" rel="noopener ugc nofollow" target="_blank"> Beyond Corp </a>)，安全模式需要更新以符合这些范例。<br/> <strong class="is hj"> <em class="mr">智能安全模式优于传统安全模式！</em> </strong></p></div></div>    
</body>
</html>