<html>
<head>
<title>How I Found the Best Pizza Restaurant 🍕 in 13,000 Cities using Cloud Tasks, Cloud Functions, and Google Maps 🗺️</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我是如何找到最好的披萨店的🍕在13，000个城市使用云任务、云功能和谷歌地图🗺️</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-i-found-the-best-pizza-restaurant-in-13-000-cities-using-cloud-tasks-cloud-functions-and-db888675db71?source=collection_archive---------2-----------------------#2019-11-04">https://medium.com/google-cloud/how-i-found-the-best-pizza-restaurant-in-13-000-cities-using-cloud-tasks-cloud-functions-and-db888675db71?source=collection_archive---------2-----------------------#2019-11-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/69e386621d5c0b14418c3f247b04a1e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LeRb_wzq6_jbzDQB33MrmA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">每个别针都标志着那个城市/镇上最好的比萨饼餐馆。是的，甚至那些看起来在水里的(岛屿)。</figcaption></figure><p id="888c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi js translated">你有没有想过，在一个新城市，哪里可以找到最好的披萨？谁不喜欢辣香肠披萨？(或者一块罗马番茄无麸香蒜比萨？)</p><p id="f604" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">谷歌云</strong>为<em class="kb">分布式计算</em>提供了一些令人难以置信的弹性伸缩技术。最棒的是，你不必考虑技术基础设施是如何工作的。</p><blockquote class="kc"><p id="4e64" class="kd ke hi bd kf kg kh ki kj kk kl jr dx translated">关注你的代码，而不是你的基础设施。</p></blockquote><h1 id="2aee" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">它始于两个问题</h1><ul class=""><li id="65d5" class="lk ll hi iw b ix lm jb ln jf lo jj lp jn lq jr lr ls lt lu bi translated">如何显示谷歌云任务的规模？</li><li id="f3c1" class="lk ll hi iw b ix lv jb lw jf lx jj ly jn lz jr lr ls lt lu bi translated">我如何通过编程找到世界上最好的比萨饼切片？</li></ul><p id="cad4" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在这一节中，我们将编写一个脚本来创建多个针对Google Cloud功能的<em class="kb">任务</em>。为了让事情变得有趣，<strong class="iw hj">我们将使用谷歌地图API，在全球<em class="kb"> 13，000个城市</em>搜索最好的披萨。我们会将结果存储在Firestore中。为了可视化我们的数据，一个嵌入了Google地图的简单网页显示了每家披萨店的pin。</strong></p><h2 id="d1ec" class="ma kn hi bd ko mb mc md ks me mf mg kw jf mh mi la jj mj mk le jn ml mm li mn bi translated">我们的应用程序如何工作</h2><p id="45de" class="pw-post-body-paragraph iu iv hi iw b ix lm iz ja jb ln jd je jf mo jh ji jj mp jl jm jn mq jp jq jr hb bi translated">这是我们应用程序的架构图:</p><figure class="ms mt mu mv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/efbb31a81f9d59eaa5b9385b66742f25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ukcOm8sB_UnNEagm.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">云任务|云功能|地图APIs |云Firestore</figcaption></figure><p id="3c35" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在左边的<strong class="iw hj">和</strong>中，我们有排队13，000个HTTP请求的云任务。</p><blockquote class="mw mx my"><p id="1a60" class="iu iv kb iw b ix iy iz ja jb jc jd je mz jg jh ji na jk jl jm nb jo jp jq jr hb bi translated"><em class="hi">为什么我们要在这里使用云任务？也许我们想要</em>限制<em class="hi">对我们API的调用，或者能够</em>暂停对我们API的请求<em class="hi">，或者对于</em>重复请求<em class="hi">不调用API。在这里，</em>预装<em class="hi">我们的13000个URL目标是很方便的。</em></p><p id="09e6" class="iu iv kb iw b ix iy iz ja jb jc jd je mz jg jh ji na jk jl jm nb jo jp jq jr hb bi translated"><em class="hi">这个用例非常适合云任务。</em></p></blockquote><p id="29e7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在图的<strong class="iw hj">中心</strong>，我们有一个Google Cloud函数(用Node编写)。这种云功能是我们实现以下目标的中心切入点:</p><ul class=""><li id="6d7f" class="lk ll hi iw b ix iy jb jc jf nc jj nd jn ne jr lr ls lt lu bi translated">呈现Google地图Web用户界面的Web浏览器请求</li><li id="0b4d" class="lk ll hi iw b ix lv jb lw jf lx jj ly jn lz jr lr ls lt lu bi translated">获取Google Maps API的API请求将数据存储在Firestore中</li></ul><blockquote class="mw mx my"><p id="d816" class="iu iv kb iw b ix iy iz ja jb jc jd je mz jg jh ji na jk jl jm nb jo jp jq jr hb bi translated">该应用程序由<a class="ae nf" href="https://github.com/GoogleCloudPlatform/functions-framework-nodejs" rel="noopener ugc nofollow" target="_blank">节点功能框架</a>提供支持，该框架支持谷歌云功能的本地开发。</p></blockquote><p id="6b83" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在<strong class="iw hj">右侧</strong>中，我们使用<a class="ae nf" href="https://developers.google.com/maps/documentation/geocoding/intro" rel="noopener ugc nofollow" target="_blank">地图地理编码API </a>来查找我们查询的纬度/液化天然气，使用<a class="ae nf" href="https://developers.google.com/places/web-service/search" rel="noopener ugc nofollow" target="_blank">地图地点搜索API </a>来查找纬度/液化天然气附近最好的比萨饼餐馆。结果存储在Firestore中(在<strong class="iw hj">底部</strong>)。</p><h1 id="1ea5" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ng kz la lb nh ld le lf ni lh li lj bi translated">设置我们的应用程序</h1><p id="5bf7" class="pw-post-body-paragraph iu iv hi iw b ix lm iz ja jb ln jd je jf mo jh ji jj mp jl jm jn mq jp jq jr hb bi translated">首先，一些设置。我们的演示展示了一个端到端的<em class="kb"/><em class="kb">应用</em>，它从谷歌地图收集数据，存储在Firestore中，并使用具有云功能的公共URL显示数据。我们需要设置存储和计算。这相当简单，但需要几分钟。</p><h2 id="fc9f" class="ma kn hi bd ko mb mc md ks me mf mg kw jf mh mi la jj mj mk le jn ml mm li mn bi translated">下载应用程序的代码</h2><p id="4c86" class="pw-post-body-paragraph iu iv hi iw b ix lm iz ja jb ln jd je jf mo jh ji jj mp jl jm jn mq jp jq jr hb bi translated">克隆回购【github.com/GoogleCloudPlatform/cloud-tasks-pizza-map T21】:</p><p id="225a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><code class="du nj nk nl nm b">git clone <a class="ae nf" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:GoogleCloudPlatform/cloud-tasks-pizza-map.git</code></p><h2 id="3eab" class="ma kn hi bd ko mb mc md ks me mf mg kw jf mh mi la jj mj mk le jn ml mm li mn bi translated">启用Google APIs</h2><p id="5565" class="pw-post-body-paragraph iu iv hi iw b ix lm iz ja jb ln jd je jf mo jh ji jj mp jl jm jn mq jp jq jr hb bi translated">我们可以使用<a class="ae nf" href="https://console.cloud.google.com/flows/enableapi?apiid=cloudtasks.googleapis.com,firestore.googleapis.com,places-backend.googleapis.com,static-maps-backend.googleapis.com,geocoding-backend.googleapis.com" rel="noopener ugc nofollow" target="_blank">这个特殊链接</a>来启用我们项目的所有API:</p><ul class=""><li id="be9a" class="lk ll hi iw b ix iy jb jc jf nc jj nd jn ne jr lr ls lt lu bi translated"><code class="du nj nk nl nm b">Cloud Tasks API</code>:具有重复数据删除、播放/暂停、重试等配置的队列</li><li id="e842" class="lk ll hi iw b ix lv jb lw jf lx jj ly jn lz jr lr ls lt lu bi translated"><code class="du nj nk nl nm b">Maps Places API</code>:寻找披萨店</li><li id="3e60" class="lk ll hi iw b ix lv jb lw jf lx jj ly jn lz jr lr ls lt lu bi translated"><code class="du nj nk nl nm b">Maps Geocoding API</code>:查找给定“地点id”的餐馆的lat/lng</li><li id="f873" class="lk ll hi iw b ix lv jb lw jf lx jj ly jn lz jr lr ls lt lu bi translated"><code class="du nj nk nl nm b">Firestore API</code>:存储数据</li></ul><h2 id="08e9" class="ma kn hi bd ko mb mc md ks me mf mg kw jf mh mi la jj mj mk le jn ml mm li mn bi translated"><strong class="ak">建立数据库</strong></h2><p id="172f" class="pw-post-body-paragraph iu iv hi iw b ix lm iz ja jb ln jd je jf mo jh ji jj mp jl jm jn mq jp jq jr hb bi translated"><a class="ae nf" href="https://firebase.google.com/docs/firestore/quickstart#create" rel="noopener ugc nofollow" target="_blank">建立一个Firestore数据库</a>，用于存储我们的Google Maps API数据，配置如下:</p><ul class=""><li id="7dfe" class="lk ll hi iw b ix iy jb jc jf nc jj nd jn ne jr lr ls lt lu bi translated">模式:<code class="du nj nk nl nm b">Test mode</code></li><li id="fef6" class="lk ll hi iw b ix lv jb lw jf lx jj ly jn lz jr lr ls lt lu bi translated">收藏:<code class="du nj nk nl nm b">tasks-pizza</code></li></ul><h2 id="95b0" class="ma kn hi bd ko mb mc md ks me mf mg kw jf mh mi la jj mj mk le jn ml mm li mn bi translated">创建一个谷歌地图API密钥</h2><p id="093a" class="pw-post-body-paragraph iu iv hi iw b ix lm iz ja jb ln jd je jf mo jh ji jj mp jl jm jn mq jp jq jr hb bi translated">在此处为地图创建API密钥:</p><figure class="ms mt mu mv fd ij er es paragraph-image"><a href="https://cloud.google.com/maps-platform/#get-started"><div class="er es nn"><img src="../Images/fd40eab143637306e6cccacd7936c65c.png" data-original-src="https://miro.medium.com/v2/resize:fit:520/format:webp/1*iziV1S7vSHv0duE0Mxm5NQ.png"/></div></a><figcaption class="iq ir et er es is it bd b be z dx translated">点击此按钮创建API密钥。(<a class="ae nf" href="https://developers.google.com/maps/documentation/geocoding/start#auth" rel="noopener ugc nofollow" target="_blank">链接</a>)</figcaption></figure><p id="3c73" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">将密钥保存在如下所示的<code class="du nj nk nl nm b">.env</code>文件中:</p><pre class="ms mt mu mv fd no nm np nq aw nr bi"><span id="325a" class="ma kn hi nm b fi ns nt l nu nv">KEY=AIzaSyDh7gKIvLzFA0q_ICfkO8ryvEMm3Nrde-c</span></pre><h1 id="daad" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ng kz la lb nh ld le lf ni lh li lj bi translated">本地运行我们的应用程序</h1><p id="6491" class="pw-post-body-paragraph iu iv hi iw b ix lm iz ja jb ln jd je jf mo jh ji jj mp jl jm jn mq jp jq jr hb bi translated">要在本地测试我们的服务器，请使用上一步中的<code class="du nj nk nl nm b">KEY</code>遵循这些说明:</p><pre class="ms mt mu mv fd no nm np nq aw nr bi"><span id="054d" class="ma kn hi nm b fi ns nt l nu nv">npm i<br/>KEY=... npm start</span></pre><p id="7e5c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们将看到CLI输出关于我们应用程序的有用信息:</p><pre class="ms mt mu mv fd no nm np nq aw nr bi"><span id="b770" class="ma kn hi nm b fi ns nt l nu nv">&gt; tasks-pizza@1.0.0 start /github/GoogleCloudPlatform/cloud-tasks-pizza-map<br/>&gt; FUNCTION_SOURCE=src npx <a class="ae nf" href="http://twitter.com/google" rel="noopener ugc nofollow" target="_blank">@google</a>-cloud/functions-framework</span><span id="98e5" class="ma kn hi nm b fi nw nt l nu nv">Serving function...<br/>Function: function<br/>URL: <a class="ae nf" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/</a></span></pre><p id="3af2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在<code class="du nj nk nl nm b">localhost:8080</code>，我们将看到我们的应用程序的路线(我在这里做了注释):</p><pre class="ms mt mu mv fd no nm np nq aw nr bi"><span id="1309" class="ma kn hi nm b fi ns nt l nu nv">[<br/>  "/tasks/start", // starts creating all Cloud Tasks<br/>  "/tasks/listnames", // lists Tasks names<br/>  "/maps/add", // adds restaurant data to the database<br/>  "/maps/get", // gets restaurant data<br/>  "/maps/listnames", // lists names of cities from a gist<br/>  "/maps/key", // prints the GMP API key for the front-end<br/>  "/target", // our Cloud Tasks target (same as /maps/add)<br/>  "/web" // our web UI for displaying our map<br/>]</span></pre><p id="ced7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">你在本地运行谷歌云功能！太好了！现在我们如何让这些大头针出现在地图上？🤔</p></div><div class="ab cl nx ny gp nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="hb hc hd he hf"><p id="7419" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这里有一些运行演示的操作顺序:</p><ul class=""><li id="958c" class="lk ll hi iw b ix iy jb jc jf nc jj nd jn ne jr lr ls lt lu bi translated"><strong class="iw hj">通过运行<code class="du nj nk nl nm b">/tasks/start</code>加载云任务队列</strong>。这将需要几分钟的时间，因为它会为世界上的每个城市创建大约13，000个独特的任务。</li><li id="fd31" class="lk ll hi iw b ix lv jb lw jf lx jj ly jn lz jr lr ls lt lu bi translated">通过转到<a class="ae nf" href="https://console.cloud.google.com/cloudtasks" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/cloudtasks</a>，确保云任务<strong class="iw hj">队列未挂起</strong>。取消排队将填充我们的Firestore数据库。</li><li id="a6d7" class="lk ll hi iw b ix lv jb lw jf lx jj ly jn lz jr lr ls lt lu bi translated"><strong class="iw hj">在<code class="du nj nk nl nm b">localhost:8080/web</code>打开我们的前端</strong>来可视化我们数据库中的数据。</li></ul><h2 id="3015" class="ma kn hi bd ko mb mc md ks me mf mg kw jf mh mi la jj mj mk le jn ml mm li mn bi translated">测试我们的应用</h2><p id="dfb1" class="pw-post-body-paragraph iu iv hi iw b ix lm iz ja jb ln jd je jf mo jh ji jj mp jl jm jn mq jp jq jr hb bi translated">在<code class="du nj nk nl nm b">/web</code>，当前端UI读取我们的数据库记录时，我们将看到引脚下降。</p><figure class="ms mt mu mv fd ij er es paragraph-image"><div class="er es oe"><img src="../Images/f39503e427a49fe5008e5ff255d67b31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*Qo-cszR4I836wogdwS6ubw.gif"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">当我们的前端加载我们的结果时，引脚掉落。每根针都是真实的🍕餐厅。</figcaption></figure><blockquote class="mw mx my"><p id="41ec" class="iu iv kb iw b ix iy iz ja jb jc jd je mz jg jh ji na jk jl jm nb jo jp jq jr hb bi translated">注意:我们故意降低前端速度来制作这个动画，它需要20分钟来加载所有的13k管脚。</p></blockquote><p id="9b50" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">例如，在曼哈顿中城，我们有一个到乔氏比萨店的链接，大约有7k个评分，平均为4.5 ⭐s.</p><figure class="ms mt mu mv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es of"><img src="../Images/1e9d869be00faa81f620cc5ca8d9fbe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*P8ntQyiqpZ-P4dnllYYqHQ.gif"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">纽约曼哈顿中城的乔氏披萨店。</figcaption></figure><p id="8236" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">那些看起来在海洋里的大头针不是错误。世界上有很多吃披萨的岛屿:</p><figure class="ms mt mu mv fd ij er es paragraph-image"><div class="er es oe"><img src="../Images/3bd3ccf7e4dc5f7df338a68f739d8fc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*P52yt9Rq05MfC5JOE3bpVg.gif"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">佛得角(4.3 ⭐s)的Boa Pizza披萨店会根据要求送到海滩。也是“对孩子好”。</figcaption></figure><p id="d7bb" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我已经用这个应用程序在谷歌地图上探索了几个小时的比萨饼世界，并且可以在一整篇文章中谈论最独特的比萨饼餐馆。但是让我们回到开发我们的应用程序。</p><h1 id="9ef9" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ng kz la lb nh ld le lf ni lh li lj bi translated">部署我们的应用程序</h1><p id="2703" class="pw-post-body-paragraph iu iv hi iw b ix lm iz ja jb ln jd je jf mo jh ji jj mp jl jm jn mq jp jq jr hb bi translated">关于我们的演示，很棒的一点是，将我们的应用程序部署到生产环境中不需要特殊的配置。</p><p id="724a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">很容易改变我们的演示，使我们不使用<code class="du nj nk nl nm b">localhost</code>，而是在谷歌云上使用一个真正的<code class="du nj nk nl nm b">https</code> URL。</p><p id="6db3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们可以简单地运行<code class="du nj nk nl nm b">npm run deploy</code>，它实际上运行这个命令:</p><pre class="ms mt mu mv fd no nm np nq aw nr bi"><span id="bcc7" class="ma kn hi nm b fi ns nt l nu nv">gcloud functions deploy tasks-pizza<br/>  \ --trigger-http<br/>  \ --runtime=nodejs10<br/>  \ --env-vars-file=.env.yaml</span></pre><p id="d774" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">大约30秒后，您将会看到一个如下所示的公共URL:</p><pre class="ms mt mu mv fd no nm np nq aw nr bi"><span id="a982" class="ma kn hi nm b fi ns nt l nu nv">https://us-central1-my-project.cloudfunctions.net/tasks-pizza</span></pre><blockquote class="mw mx my"><p id="ede7" class="iu iv kb iw b ix iy iz ja jb jc jd je mz jg jh ji na jk jl jm nb jo jp jq jr hb bi translated">注意:那不是一个真实的URL。</p></blockquote><h2 id="8bd2" class="ma kn hi bd ko mb mc md ks me mf mg kw jf mh mi la jj mj mk le jn ml mm li mn bi translated">感谢阅读</h2><p id="ad19" class="pw-post-body-paragraph iu iv hi iw b ix lm iz ja jb ln jd je jf mo jh ji jj mp jl jm jn mq jp jq jr hb bi translated">如果你喜欢这篇博客，看看这些资源:</p><ul class=""><li id="46b9" class="lk ll hi iw b ix iy jb jc jf nc jj nd jn ne jr lr ls lt lu bi translated">💻来源:github.com/GoogleCloudPlatform/cloud-tasks-pizza-map</li><li id="8136" class="lk ll hi iw b ix lv jb lw jf lx jj ly jn lz jr lr ls lt lu bi translated">🌎世界城市数据:【simplemaps.com/data/world-cities T2】</li><li id="10ca" class="lk ll hi iw b ix lv jb lw jf lx jj ly jn lz jr lr ls lt lu bi translated">🔧职能框架:【github.com/GoogleCloudPlatform/functions-framework-nodejs T4】</li></ul><p id="80ae" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">多亏了这个应用程序，我才不会挨饿😋🍕</p></div></div>    
</body>
</html>