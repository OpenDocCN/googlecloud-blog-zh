<html>
<head>
<title>Stackdriver Error Reporting: part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">堆栈驱动程序错误报告:第2部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/stackdriver-error-reporting-part-2-826f40e00886?source=collection_archive---------0-----------------------#2018-03-10">https://medium.com/google-cloud/stackdriver-error-reporting-part-2-826f40e00886?source=collection_archive---------0-----------------------#2018-03-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="da03" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">带Golang和Kubernetes发动机的进一步探险</h2></div><p id="5eba" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">** <strong class="iz hj">更新19–04–02</strong>—这篇文章已经过时，一些关键部分不再正常工作。请查看谷歌的文档(<a class="ae jt" href="https://cloud.google.com/debugger/docs/setup/go" rel="noopener ugc nofollow" target="_blank">链接</a>)以获得明确的指导。为了理解如何将Stackdriver错误报告与Kubernetes引擎一起使用，这篇文章仍然会有所帮助。我将鼓励我的同行扩充Google文档，以更全面地解释Kubernetes引擎场景。</p><p id="f5ad" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">* *更新18–03–12</strong>—我认为使用Golang的Stackdriver调试器只适用于使用Go版本≤1.9.x构建的代码。我已经将我的大多数机器升级到1.10.y，但这似乎不起作用。但是，使用Go 1.9.4创建二进制文件是可行的，并且我能够设置和捕获调试器快照。</p><p id="fcc4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我<a class="ae jt" rel="noopener" href="/@DazWilkin/stackdriver-error-reporting-8e86be630533">写过</a>关于在Golang和Kubernetes中使用<a class="ae jt" href="https://cloud.google.com/error-reporting/" rel="noopener ugc nofollow" target="_blank"> Stackdriver错误报告</a>。我仍然无法让<a class="ae jt" href="https://cloud.google.com/debugger/" rel="noopener ugc nofollow" target="_blank"> Stackdriver调试器</a>处理结果。我将在这里写下我的尝试，然后当我的同事帮我找到解决方案时，我会更新这篇文章。</p><p id="4038" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这篇文章中，我添加了Google <a class="ae jt" href="https://cloud.google.com/source-repositories/" rel="noopener ugc nofollow" target="_blank">云资源仓库</a>和<a class="ae jt" href="https://cloud.google.com/container-builder/" rel="noopener ugc nofollow" target="_blank">容器构建器</a>来自动化:</p><ul class=""><li id="7a28" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">创建服务帐户|密钥和Kubernetes秘密</li><li id="1f19" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">构建Golang、Docker映像并部署到Kubernetes</li></ul><h2 id="ae3d" class="ki kj hi bd kk kl km kn ko kp kq kr ks jg kt ku kv jk kw kx ky jo kz la lb lc bi translated">启用GCP服务</h2><p id="5087" class="pw-post-body-paragraph ix iy hi iz b ja ld ij jc jd le im jf jg lf ji jj jk lg jm jn jo lh jq jr js hb bi translated">除了云资源仓库、容器构建器和Kubernetes引擎之外，我们还需要<a class="ae jt" href="https://cloud.google.com/iam/" rel="noopener ugc nofollow" target="_blank"> Google IAM </a>来提供服务帐户及其密钥，以及Google <a class="ae jt" href="https://cloud.google.com/resource-manager/" rel="noopener ugc nofollow" target="_blank">云资源管理器</a>来更改项目的策略(主要是增强云构建器自己的服务帐户，以便它可以创建其他服务帐户并部署到Kubernetes引擎)。</p><p id="2e95" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们来启用服务:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="ecee" class="ki kj hi ln b fi lr ls l lt lu">for SERVICE in \<br/>  cloudbuild \<br/>  cloudresourcemanager \<br/>  container \<br/>  iam \<br/>  sourcerepo<br/>do<br/>  gcloud services enable ${SERVICE}.googleapis.com \<br/>  --async \<br/>  --project=${PROJECT}<br/>done</span></pre><blockquote class="lv lw lx"><p id="3e84" class="ix iy ly iz b ja jb ij jc jd je im jf lz jh ji jj ma jl jm jn mb jp jq jr js hb bi translated">如果你更喜欢同步运行它们以确保你知道它们什么时候被启用，那么放下<code class="du mc md me ln b">--async</code>。</p></blockquote><h2 id="9793" class="ki kj hi bd kk kl km kn ko kp kq kr ks jg kt ku kv jk kw kx ky jo kz la lb lc bi translated">集装箱建造商和Kubernetes发动机区域集群</h2><p id="c68a" class="pw-post-body-paragraph ix iy hi iz b ja ld ij jc jd le im jf jg lf ji jj jk lg jm jn jo lh jq jr js hb bi translated">用于<code class="du mc md me ln b">kubectl</code> ( <a class="ae jt" href="https://github.com/GoogleCloudPlatform/cloud-builders/tree/master/kubectl" rel="noopener ugc nofollow" target="_blank">链接</a>)的容器生成器无法管理<a class="ae jt" href="https://cloud.google.com/kubernetes-engine/docs/concepts/multi-zone-and-regional-clusters#regional" rel="noopener ugc nofollow" target="_blank">区域集群</a>。但是，如果您遵循本期GitHub的说明(<a class="ae jt" href="https://github.com/GoogleCloudPlatform/cloud-builders/issues/176" rel="noopener ugc nofollow" target="_blank">链接</a>)，您将能够创建一个支持区域集群的定制<code class="du mc md me ln b">kubectl</code>构建器。</p><blockquote class="lv lw lx"><p id="2e20" class="ix iy ly iz b ja jb ij jc jd je im jf lz jh ji jj ma jl jm jn mb jp jq jr js hb bi translated"><strong class="iz hj">注意</strong>在下面的文档中，我假设您已经完成了这一步，并且正在使用Kubernetes引擎区域集群。</p></blockquote><h2 id="6764" class="ki kj hi bd kk kl km kn ko kp kq kr ks jg kt ku kv jk kw kx ky jo kz la lb lc bi translated">容器构建服务帐户、密钥和机密</h2><p id="2adc" class="pw-post-body-paragraph ix iy hi iz b ja ld ij jc jd le im jf jg lf ji jj jk lg jm jn jo lh jq jr js hb bi translated">您可能认为这一部分是题外话，但是我决定自动创建一个服务帐户、一个相关的密钥和一个代表服务帐户的Kubernetes秘密，以便部署到Kubernetes引擎的Pods可以使用该服务帐户。</p><p id="0130" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因为以下脚本假设容器构建器服务可以创建服务帐户和服务帐户密钥并部署到Kubernetes引擎，所以我们必须在运行脚本之前向容器构建器服务帐户添加IAM角色来完成此任务:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="949f" class="ki kj hi ln b fi lr ls l lt lu">NUM=$(gcloud projects describe ${PROJECT} \<br/>--format='value(projectNumber)')</span><span id="358c" class="ki kj hi ln b fi mf ls l lt lu">for ROLE in \<br/>  roles/container.developer \<br/>  roles/iam.serviceAccountAdmin \<br/>  roles/iam.serviceAccountKeyAdmin \<br/>  roles/resourcemanager.projectIamAdmin<br/>do<br/>  gcloud projects add-iam-policy-binding ${PROJECT} \<br/>  --member=serviceAccount:${NUM}<a class="ae jt" href="http://twitter.com/cloudbuild" rel="noopener ugc nofollow" target="_blank">@</a>cloudbuild.gserviceaccount.com \<br/>  --role=${ROLE}<br/>done</span></pre><p id="6dbd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以下是一个容器构建器脚本:</p><figure class="li lj lk ll fd mg"><div class="bz dy l di"><div class="mh mi l"/></div></figure><blockquote class="lv lw lx"><p id="f7eb" class="ix iy ly iz b ja jb ij jc jd je im jf lz jh ji jj ma jl jm jn mb jp jq jr js hb bi translated"><strong class="iz hj">注意</strong>如前所述，我假设您正在对一个区域集群使用<code class="du mc md me ln b">kubectl</code>。如果没有，您可以删除上面的第6步，并将第7步的名称修改为<code class="du mc md me ln b">gcr.io/cloud-builders/kubectl</code>。</p></blockquote><p id="7122" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以使用以下命令从命令行运行该脚本:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="0ab7" class="ki kj hi ln b fi lr ls l lt lu">gcloud container builds submit . \<br/>--config cloudbuild.robot.yaml \<br/>--substitutions=\<br/>_CLUSTER=${CLUSTER},\<br/>_REGION=${REGION},\<br/>_ROBOT=robot-$(date +"%H%M") \<br/>--project=$PROJECT</span></pre><p id="d41c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果一切顺利，这应该会产生一个在默认名称空间中称为<code class="du mc md me ln b">error-reporting-key</code>的秘密:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="a08c" class="ki kj hi ln b fi lr ls l lt lu">kubectl get secrets<br/>NAME                  TYPE      DATA      AGE<br/>error-reporting-key   Opaque    1         1h</span></pre><p id="7ed3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Kubernetes部署脚本引用了这个秘密；如果您决定重命名<code class="du mc md me ln b">error-reporting-key</code>，请确保您也在部署脚本中反映了这一变化。</p><h2 id="4e75" class="ki kj hi bd kk kl km kn ko kp kq kr ks jg kt ku kv jk kw kx ky jo kz la lb lc bi translated">容器生成堆栈驱动程序调试器部署</h2><p id="7e69" class="pw-post-body-paragraph ix iy hi iz b ja ld ij jc jd le im jf jg lf ji jj jk lg jm jn jo lh jq jr js hb bi translated">不幸的是，这一步是我的问题开始。虽然能够使用Go Builder构建Golang，但是当部署到Kubernetes时，生成的图像会产生错误。</p><p id="030c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，与其包括这些<code class="du mc md me ln b">go build</code>步骤:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="5278" class="ki kj hi ln b fi lr ls l lt lu">steps:<br/>- name: "gcr.io/cloud-builders/go"<br/>  args: [<br/>    "get",<br/>    "cloud.google.com/go/errorreporting",<br/>  ]<br/>  env : [<br/>    "GOPATH=/workspace",<br/>  ]<br/>- name: "gcr.io/cloud-builders/go"<br/>  args: [<br/>    "build",<br/>    "-gcflags=-N",<br/>    "-gcflags=-l",<br/>    "-a",<br/>    "-o","main",<br/>  ]<br/>  env: [<br/>    "GOOS=linux",<br/>    "GOPATH=/workspace",<br/>  ]</span></pre><p id="a1d1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我很不情愿地在本地构建Go文件(<code class="du mc md me ln b">go version go1.10 linux/amd64</code>)，并假设生成的二进制文件存在于Cloud Builder脚本中。所以，假设你也在用Go 1.10:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="19d2" class="ki kj hi ln b fi lr ls l lt lu">CGO_ENABLED=0 go build -gcflags='-N -l'</span></pre><p id="e475" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">其中应该生成<code class="du mc md me ln b">go-errrep</code>然后，生成<a class="ae jt" href="https://cloud.google.com/debugger/docs/source-context#gke_go" rel="noopener ugc nofollow" target="_blank">源上下文文件</a>:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="ce24" class="ki kj hi ln b fi lr ls l lt lu">gcloud debug source gen-repo-info-file --output-directory .</span></pre><p id="03e4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将生成<code class="du mc md me ln b">source-context.json</code>，然后:</p><p id="dcd2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里是<code class="du mc md me ln b">Dockerfile.debugger</code>:</p><figure class="li lj lk ll fd mg"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="6c83" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">和<code class="du mc md me ln b">deployment.debugger.yaml</code>:</p><figure class="li lj lk ll fd mg"><div class="bz dy l di"><div class="mh mi l"/></div></figure><blockquote class="lv lw lx"><p id="dca0" class="ix iy ly iz b ja jb ij jc jd je im jf lz jh ji jj ma jl jm jn mb jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong>你必须在第19行和第27行用<code class="du mc md me ln b">${PROJECT}</code>的值替换<code class="du mc md me ln b">[[YOUR-PROJECT-ID]]</code>。</p></blockquote><p id="83d1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后是缩减的<code class="du mc md me ln b">cloudbuild.yaml</code>:</p><figure class="li lj lk ll fd mg"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="a485" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以通过以下方式申请:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="d761" class="ki kj hi ln b fi lr ls l lt lu">gcloud container builds submit . \<br/>--config cloudbuild.debugger.yaml \<br/>--substitutions=\<br/>_CLUSTER=${CLUSTER},\<br/>_REGION=${REGION} \<br/>--project=$PROJECT</span></pre><p id="02aa" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一切都好:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="ef7d" class="ki kj hi ln b fi lr ls l lt lu">kubectl get deployments<br/>NAME                    DESIRED   CURRENT   UP-TO-DATE   AVAILABLE<br/>error-reporting-debug   1         1         1            1</span></pre><p id="2598" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且:</p><figure class="li lj lk ll fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mj"><img src="../Images/2b069c108963945de7e28be3030ec7a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qK03XaYRBFFKzI2VOfuSGw.png"/></div></div><figcaption class="mq mr et er es ms mt bd b be z dx translated">堆栈驱动程序错误报告</figcaption></figure><p id="c51b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是:</p><figure class="li lj lk ll fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mu"><img src="../Images/bc018c2f5f813eebc0cd62caaf64462a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Njkhtk9jat9DAuSe8iaRQ.png"/></div></div><figcaption class="mq mr et er es ms mt bd b be z dx translated">展开单个错误报告</figcaption></figure><p id="f77e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">点击进入Stackdriver Debugger，快照永远不会被触发:</p><figure class="li lj lk ll fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mv"><img src="../Images/0e080bb0a4ac0e71c3a1b6437ca7bec9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ybyHzrTy4nwFz5kvoWfIA.png"/></div></div><figcaption class="mq mr et er es ms mt bd b be z dx translated">等待戈多</figcaption></figure><h2 id="73dd" class="ki kj hi bd kk kl km kn ko kp kq kr ks jg kt ku kv jk kw kx ky jo kz la lb lc bi translated">整理</h2><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="1785" class="ki kj hi ln b fi lr ls l lt lu">kubectl delete deployment/error-reporting-debug<br/>kubectl delete secret/error-reporting-key</span></pre><h2 id="62e4" class="ki kj hi bd kk kl km kn ko kp kq kr ks jg kt ku kv jk kw kx ky jo kz la lb lc bi translated">GCE虚拟机和错误报告</h2><p id="aee9" class="pw-post-body-paragraph ix iy hi iz b ja ld ij jc jd le im jf jg lf ji jj jk lg jm jn jo lh jq jr js hb bi translated">奇怪的是，该行为似乎与纯GCE虚拟机一致(即不起作用):</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="986c" class="ki kj hi ln b fi lr ls l lt lu">INSTANCE=instance-errrep<br/>gcloud beta compute instances create ${INSTANCE} \<br/>--project=${PROJECT} \<br/>--zone=us-west1-c \<br/>--machine-type=custom-2-8192 \<br/>--scopes=<a class="ae jt" href="https://www.googleapis.com/auth/cloud-platform" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/cloud-platform</a> \<br/>--image=ubuntu-1604-xenial-v20180306 \<br/>--image-project=ubuntu-os-cloud \<br/>--boot-disk-size=50</span></pre><p id="ee20" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从我们的工作目录中，复制我们需要的内容:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="8d10" class="ki kj hi ln b fi lr ls l lt lu">for FILE in go-errrep source-context.json ${ROBOT}.key.json<br/>do<br/>  gcloud compute scp \<br/>    ./${FILE} \<br/>    ${INSTANCE}: \<br/>  --project=$PROJECT<br/>done</span></pre><p id="78e8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="3168" class="ki kj hi ln b fi lr ls l lt lu">gcloud compute ssh ${INSTANCE} --project=${PROJECT}</span></pre><p id="665e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，您需要在VM上为<code class="du mc md me ln b">ROBOT</code>提供一个值，但是剩余的值可以从元数据服务中提取。根据另一篇帖子对Kubernetes Downward API的引用，如果我在这个VM上的一个容器中运行，那么等值将从元数据服务中提取。</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="fb66" class="ki kj hi ln b fi lr ls l lt lu">METADATA="<a class="ae jt" href="http://metadata.google.internal/computeMetadata/v1/project/project-id" rel="noopener ugc nofollow" target="_blank">http://metadata.google.internal/computeMetadata/v1</a>"<br/>ROBOT=[[YOUR-ROBOT-NAME]]</span><span id="db0f" class="ki kj hi ln b fi mf ls l lt lu">wget -O go-cloud-debug <a class="ae jt" href="https://storage.googleapis.com/cloud-debugger/compute-go/go-cloud-debug" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/cloud-debugger/compute-go/go-cloud-debug</a></span><span id="ee7f" class="ki kj hi ln b fi mf ls l lt lu">chmod 0755 go-cloud-debug</span><span id="5b12" class="ki kj hi ln b fi mf ls l lt lu">export GOOGLE_APPLICATION_CREDENTIALS=./${ROBOT}.key.json</span><span id="db81" class="ki kj hi ln b fi mf ls l lt lu">export GOOGLE_PROJECT_ID=$(\<br/>  curl \<br/>  --silent \<br/>  --header "Metadata-Flavor: Google" \<br/>  ${METADATA}<a class="ae jt" href="http://metadata.google.internal/computeMetadata/v1/project/project-id" rel="noopener ugc nofollow" target="_blank">/project/project-id</a>)</span><span id="ce6d" class="ki kj hi ln b fi mf ls l lt lu">export POD_NAME=ubuntu</span><span id="8a36" class="ki kj hi ln b fi mf ls l lt lu">export POD_NODE=$(\<br/>  curl \<br/>  --silent \<br/>  --header "Metadata-Flavor: Google" \<br/>  <a class="ae jt" href="http://metadata.google.internal/computeMetadata/v1/instance/name" rel="noopener ugc nofollow" target="_blank">${METADATA}/instance/name</a>)</span><span id="9fa4" class="ki kj hi ln b fi mf ls l lt lu">export POD_IP=$(\<br/>  curl \<br/>  --silent \<br/>  --header "Metadata-Flavor: Google" \<br/>  ${METADATA}/instance/network-interfaces/0/ip)</span><span id="4635" class="ki kj hi ln b fi mf ls l lt lu">./go-cloud-debug \<br/>-sourcecontext=./source-context.json \<br/>-appmodule=go-errrep \<br/>-appversion=1 \<br/>-- ./go-errrep</span></pre><p id="99cb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这会产生:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="8123" class="ki kj hi ln b fi lr ls l lt lu">pod: [ubuntu]; node: [instance-errrep]; ip: [10.138.0.5]<br/>pod: [ubuntu]; node: [instance-errrep]; ip: [10.138.0.5]<br/>pod: [ubuntu]; node: [instance-errrep]; ip: [10.138.0.5]<br/>pod: [ubuntu]; node: [instance-errrep]; ip: [10.138.0.5]<br/>pod: [ubuntu]; node: [instance-errrep]; ip: [10.138.0.5]<br/>error setting breakpoint at main.go:39: couldn't find file "main.go"<br/>pod: [ubuntu]; node: [instance-errrep]; ip: [10.138.0.5]<br/>error setting breakpoint at main.go:37: couldn't find file "main.go"</span></pre><p id="3ef1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以，我显然在某个地方做错了:-(</p><p id="8817" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">又试了一次(昨晚晚些时候),成功了:</p><figure class="li lj lk ll fd mg er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mw"><img src="../Images/489599c03ed1fab84a3cfbe9afb6e00d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OowAcUJnyzGP2Qj6ej4VGw.png"/></div></div></figure><p id="3da9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">(今天早上)又试了一次，还是不行:-(</p><h2 id="9db2" class="ki kj hi bd kk kl km kn ko kp kq kr ks jg kt ku kv jk kw kx ky jo kz la lb lc bi translated">哑初始化</h2><p id="b134" class="pw-post-body-paragraph ix iy hi iz b ja ld ij jc jd le im jf jg lf ji jj jk lg jm jn jo lh jq jr js hb bi translated">将Yelp的<code class="du mc md me ln b">dumb-init</code> ( <a class="ae jt" href="https://github.com/Yelp/dumb-init" rel="noopener ugc nofollow" target="_blank">链接</a>)整合到我的构建中，没有别的原因，只是因为我认为我应该这样做，而且我有一些时间。因为<code class="du mc md me ln b">Scratch</code>不包括<code class="du mc md me ln b">wget</code>，所以我将<code class="du mc md me ln b">dumb-init</code>作为组二进制文件的一部分(现在包括<code class="du mc md me ln b">go-errrep</code>和<code class="du mc md me ln b">go-cloud-debug</code>)。</p><p id="5027" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，按照Yelp的指示，但调整到存储在当前目录:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="5b22" class="ki kj hi ln b fi lr ls l lt lu">wget --output-document ./dumb-init <a class="ae jt" href="https://github.com/Yelp/dumb-init/releases/download/v1.2.1/dumb-init_1.2.1_amd64" rel="noopener ugc nofollow" target="_blank">https://github.com/Yelp/dumb-init/releases/download/v1.2.1/dumb-init_1.2.1_amd64</a><br/>chmod +x ./dumb-init</span></pre><p id="f982" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后稍微修改了一下<code class="du mc md me ln b">Dockerfile.debugger</code>:</p><figure class="li lj lk ll fd mg"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="37ac" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">其他一切保持不变。当您下一次构建和部署时，映像将包含作为PID 1的<code class="du mc md me ln b">dumb-init</code>。</p><h2 id="db52" class="ki kj hi bd kk kl km kn ko kp kq kr ks jg kt ku kv jk kw kx ky jo kz la lb lc bi translated">日志</h2><p id="70ee" class="pw-post-body-paragraph ix iy hi iz b ja ld ij jc jd le im jf jg lf ji jj jk lg jm jn jo lh jq jr js hb bi translated">您可以使用Kubernetes仪表板、云控制台工作负载或从命令行跟踪容器的日志:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="d9f8" class="ki kj hi ln b fi lr ls l lt lu">POD=$(\<br/>  kubectl get pods \<br/>  --selector=app=error-reporting-debug \<br/>  --output=jsonpath="{.items[0].metadata.name}"\<br/>)<br/>kubectl logs pod/${POD} --follow</span></pre><p id="5720" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">就是这样！</p></div></div>    
</body>
</html>