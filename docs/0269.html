<html>
<head>
<title>Debugging Demos</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">调试演示</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/debugging-demos-79121c7515ea?source=collection_archive---------0-----------------------#2017-04-28">https://medium.com/google-cloud/debugging-demos-79121c7515ea?source=collection_archive---------0-----------------------#2017-04-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/59205b0e1c063dead696937ee0261484.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*tdGYcOHwvVYB9iiVDwR0IA.png"/></div></figure><p id="bf6b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这星期我一直在火车站。我在机器学习赛道用Ruby 做了一个关于<a class="ae jk" href="http://www.thagomizer.com/blog/2017/04/13/the-google-nlp-api-meets-ruby.html" rel="noopener ugc nofollow" target="_blank">自然语言处理的演讲。作为我演讲的一部分，我想重复我在RubyConf 2015上做的一个演示，在那里我使用了一个分布式系统来进行基于表情符号的情感分析。当时我觉得我使用了一些最热门的技术。我对管道的每个不同部分都使用了Docker容器，然后使用Kubernetes来协调整个过程。随着对Kubernetes演示的需求增加，这似乎是一种合理的方式来部署我希望能够定期上下旋转的东西。上周，我深入研究了代码，试图在中断12个月后让演示再次运行。在那段时间里，你所忘记的东西是令人惊奇的。我在这篇博文中分享了一些我学到的东西，希望其他人不要经历和我一样的战斗。</a></p><h2 id="d00d" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">舍邦之战</h2><p id="e6b2" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">当我构建这个演示时，Kubernetes甚至还不到1.0；现在我们达到了1.5。所以毫不奇怪，<code class="du kl km kn ko b">kubectl</code>和<code class="du kl km kn ko b">gcloud</code> shell命令中的一些略有变化。快速浏览了一下文档，我又回到了业务中，但是当我运行<code class="du kl km kn ko b">kubectl get pods</code>时，我所有的pod都出现了状态CrashLoopBackoff。所以我做了合乎逻辑的事情:删除它们，并尝试再次部署。这次我在创建控制器后立即运行了<code class="du kl km kn ko b">kubectl get pods</code>，状态是<code class="du kl km kn ko b">RunContainerError</code>。所以我重新构建了容器，并再次尝试，却得到了同样的错误。</p><p id="f708" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">虽然我知道执行到一个正在运行的容器中通常不是一个好主意，但这似乎是调试我当前问题的唯一方法。于是我用<code class="du kl km kn ko b">docker run</code>启动了容器。这次我得到了一个新的错误。</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="0bd4" class="jl jm hi ko b fi kx ky l kz la">standard_init_linux.go:178: exec user process caused "exec format error"</span></pre><p id="642a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我仍然不知道这意味着什么，但我猜想我的入口点有问题，并花了一个多小时在网上搜索解决方案，尝试不同的东西，看看问题是什么。最后，出于绝望，我尝试使用Dockerfile文件，因为它出现在我的幻灯片上。成功了。我比较了这两个版本，唯一的不同是不工作的版本在文件开头有一个Apache V2许可头作为注释。有效的版本在文件的顶部有shebang。我将shebang移到Apache license头的上方，重新构建容器，当我尝试用Docker运行它时，它工作了。</p><p id="3441" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">作为准备发布到GitHub的代码的一部分，我添加了许可证头。但是我从来没有用那个版本的文件做过演示。我总是用没有许可证头的不同版本来做。结果，我分享了一些不工作的开源代码。</p><h2 id="19b2" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">ruby:latest和ruby:onbuild的区别</h2><p id="88c9" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">我遇到的下一个障碍更容易解决。之前的演示只使用了Ruby的标准库。新版本的演示需要<code class="du kl km kn ko b">google-cloud-ruby</code>宝石。当我尝试部署进行情感分析的代码时，它会出错，因为Ruby找不到所需的库。我想知道使用Ruby 2.4是否是一个问题，但我相当肯定这不是问题。我用Ruby 2.3在本地运行了Docker的代码，运行得很好。</p><p id="ab1d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">所以我去看了文档。我通读了我正在使用的Ruby映像的Docker Hub页面，并意识到如果我有gem依赖项，我需要使用ruby:onbuild并为Bundler提供一个<code class="du kl km kn ko b">Gemfile.lock</code>。进行必要的修改修复了我的代码，唯一痛苦的部分是通过慢速wifi下载ruby:onbuild映像。</p><h2 id="fd61" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">遮蔽</h2><p id="2c67" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">此时，我的演示已经启动并运行了，但是当我查看pod时，我注意到其中一些已经重启了几次。查看来自我的集群的日志，我看到这些豆荚正在死去，因为在谷歌云语言宝石深处有一个异常。当我更仔细地查看错误时，我发现gem不知何故通过了作为演示主干的Rinda服务器的URI。最后，我发现了一个错误，它解释了我做错了什么</p><pre class="kp kq kr ks fd kt ko ku kv aw kw bi"><span id="8ac6" class="jl jm hi ko b fi kx ky l kz la">/usr/local/lib/ruby/2.4.0/uri.rb:97: warning: previous definition of URI was here</span></pre><p id="eda6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我很懒，没有为我的代码使用任何类或名称空间。因此，当我声明一个名为URI的常量并用它作为Rinda服务器的地址时，我是在隐藏标准库中的URI模块。修正我的命名修正了这个问题，我的演示是稳定的。此外，我还学到了关于适当命名空间的宝贵一课。现在演示已经启动并正常运行，我将很快在GitHub上发布工作版本。我的演讲进行得很顺利，在这个过程中，我学习和重新学习了一些东西。有人提醒我，命名空间很重要。</p><p id="5ce1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="lb">原载于</em><a class="ae jk" href="http://thagomizer.com/blog/2017/04/27/debugging-demos.html" rel="noopener ugc nofollow" target="_blank"><em class="lb">——命运之刺</em> </a></p></div></div>    
</body>
</html>