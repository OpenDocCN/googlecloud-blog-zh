<html>
<head>
<title>A CI/CD solution in under 10 minutes, using Terraform &amp; Ansible on GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GCP的Terraform &amp; Ansible在10分钟内完成CI/CD解决方案</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/a-ci-cd-solution-in-under-10-minutes-featuring-terraform-ansible-and-drone-ci-on-gcp-16bba497c655?source=collection_archive---------0-----------------------#2019-11-07">https://medium.com/google-cloud/a-ci-cd-solution-in-under-10-minutes-featuring-terraform-ansible-and-drone-ci-on-gcp-16bba497c655?source=collection_archive---------0-----------------------#2019-11-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/c650ef0ad6a017a4fc5dc5f171d9c032.png" data-original-src="https://miro.medium.com/v2/format:webp/1*VwcyIZ3x7tlrtME9QSjv1A.jpeg"/></div></figure><p id="84b9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">随着项目的成熟和复杂性的增加，集成CI/CD解决方案是非常有意义的。</p><p id="ee5a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然而，建立和运行这样一个系统可能是一个惊人的技术和耗时的过程。</p><p id="73b4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来是部署Drone CI的实践指南，这是一个轻量级、以容器为中心的CI/CD解决方案，只需几分钟，而不是几天。</p><p id="b6bc" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了实现这一点，我们将利用Terraform和Ansible的强大功能，这是一个用于自动化基础设施资源的创建和供应的强大组合。</p><p id="a69f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们不会深究任何特定的技术或低级的概念，因为已经有大量的资源可以解决这些问题。</p><p id="ffb3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">相反，我们将采取更务实的方法，关注真实世界的场景，旨在强调自动化的好处，并提供对“基础设施即代码”世界的深刻见解。</p><p id="bf22" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然而，如果您喜欢更直接的方法，请前往<a class="ae jk" href="https://github.com/jadechip/infrastructure-as-code" rel="noopener ugc nofollow" target="_blank"> Github </a>并遵循附带的说明。整个过程不会超过10分钟。</p><figure class="jm jn jo jp fd ii er es paragraph-image"><div class="er es jl"><img src="../Images/44cc196afb0f8912fb206ede10b47bba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*0x2I8DIFfIEXXdQs1Q1F4g.gif"/></div></figure><p id="8aea" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">无论如何，如果你觉得内容有用，一定要给我几个掌声，或者在Github上打个星🤩</p></div><div class="ab cl jq jr gp js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hb hc hd he hf"><h1 id="63dc" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">先决条件</h1><p id="4bbb" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">我们将使用谷歌云提供商(GCP)，但是，下面的说明可以很容易地修改为其他云提供商。如果你还没有账户，GCP为新用户提供价值300美元的信用。</p><p id="6b72" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们还需要<a class="ae jk" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>和<a class="ae jk" href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html" rel="noopener ugc nofollow" target="_blank"> Ansible </a>来满足我们的编排和供应需求，所以在继续之前请确保安装好这些。</p><p id="423a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最后，我选择使用Github，但是Drone CI也支持其他版本控制解决方案，包括Bitbucket、GitLab、Gitea和Gogs。查看<a class="ae jk" href="https://docs.drone.io/installation/overview/" rel="noopener ugc nofollow" target="_blank">文档</a>了解更多信息。</p><h1 id="e46f" class="jx jy hi bd jz ka la kc kd ke lb kg kh ki lc kk kl km ld ko kp kq le ks kt ku bi translated">周密计划的行动方案</h1><p id="97d8" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">我们现在准备开始，这是我们的游戏计划:</p><ol class=""><li id="4907" class="lf lg hi io b ip iq it iu ix lh jb li jf lj jj lk ll lm ln bi translated">使用<strong class="io hj"> Terraform </strong>生成所需的基础架构:单个虚拟机，或GCP方言中的计算实例。</li><li id="f782" class="lf lg hi io b ip lo it lp ix lq jb lr jf ls jj lk ll lm ln bi translated">给我们的机器添加一个静态IP并配置基本的防火墙设置。</li><li id="1a31" class="lf lg hi io b ip lo it lp ix lq jb lr jf ls jj lk ll lm ln bi translated">在Github上设置OAuth应用程序。</li><li id="d22e" class="lf lg hi io b ip lo it lp ix lq jb lr jf ls jj lk ll lm ln bi translated">安装任何必要的依赖项，并使用<strong class="io hj"> Ansible </strong>行动手册运行Docker。</li><li id="ea9b" class="lf lg hi io b ip lo it lp ix lq jb lr jf ls jj lk ll lm ln bi translated">从Docker Hub下载并运行<strong class="io hj">无人机</strong>代理和服务器映像。</li><li id="6232" class="lf lg hi io b ip lo it lp ix lq jb lr jf ls jj lk ll lm ln bi translated">庆祝🎉(可选)。</li></ol><h1 id="6a97" class="jx jy hi bd jz ka la kc kd ke lb kg kh ki lc kk kl km ld ko kp kq le ks kt ku bi translated">证明</h1><p id="70c8" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">为了让Terraform安全地与GCP互动，我们首先需要设置一个<strong class="io hj">服务帐户。</strong></p><h2 id="50be" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated">服务帐户</h2><blockquote class="mh mi mj"><p id="3fca" class="im in mk io b ip iq ir is it iu iv iw ml iy iz ja mm jc jd je mn jg jh ji jj hb bi translated">使用Terraform配置资源的首选方法是使用GCP服务帐户，这是一个“机器人帐户”，可以被授予有限的IAM权限集。</p></blockquote><p id="ea5b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">前往<a class="ae jk" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云控制台</a>，创建一个新项目或选择一个现有项目。</p><p id="79cb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在主菜单的<em class="mk">API&amp;服务</em>部分下，点击<em class="mk">凭证</em>。从<em class="mk">创建凭证</em>下拉菜单中选择<em class="mk">服务账户密钥</em>，并填写所需的详细信息。最后，点击<em class="mk"> create </em>下载生成的JSON文件。</p><figure class="jm jn jo jp fd ii er es paragraph-image"><div class="er es jl"><img src="../Images/344d6bf71044a15e8e79d5ac9f702dca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*SIcpKNV-XOZlxwW7TDYihA.gif"/></div></figure><p id="78c3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有关在GCP上设置身份验证的更多信息，请查看下面的链接。</p><div class="mo mp ez fb mq mr"><a href="https://cloud.google.com/docs/authentication/getting-started" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab dw"><div class="mt ab mu cl cj mv"><h2 class="bd hj fi z dy mw ea eb mx ed ef hh bi translated">认证入门|认证|谷歌云</h2><div class="my l"><h3 class="bd b fi z dy mw ea eb mx ed ef dx translated">本文展示了认证云API的推荐方法。认证是指…的过程</h3></div><div class="mz l"><p class="bd b fp z dy mw ea eb mx ed ef dx translated">cloud.google.com</p></div></div></div></a></div><h2 id="ff48" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated">嘘</h2><p id="2a70" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">我们还需要通过向Terraform元数据添加一个<strong class="io hj">公共SSH </strong>键来授予对我们的VM的可编程访问权。</p><p id="8bac" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们可以通过运行以下命令并在提示时输入密码来轻松生成一对密钥。</p><pre class="jm jn jo jp fd na nb nc nd aw ne bi"><span id="c085" class="lt jy hi nb b fi nf ng l nh ni">ssh-keygen -t rsa -f ~/.ssh/<!-- -->[KEY_FILENAME]<!-- --> -C `whoami`</span></pre><p id="8622" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们也限制对我们的私钥的访问，以防止其他人修改它。</p><pre class="jm jn jo jp fd na nb nc nd aw ne bi"><span id="ef06" class="lt jy hi nb b fi nf ng l nh ni">chmod 400 ~/.ssh/[KEY_FILENAME]</span></pre><p id="d546" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有关为GCP上的资源创建SSH密钥的更多细节，请查看下面的链接。</p><div class="mo mp ez fb mq mr"><a href="https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab dw"><div class="mt ab mu cl cj mv"><h2 class="bd hj fi z dy mw ea eb mx ed ef hh bi translated">管理元数据中的SSH密钥|计算引擎文档|谷歌云</h2><div class="my l"><h3 class="bd b fi z dy mw ea eb mx ed ef dx translated">编辑描述</h3></div><div class="mz l"><p class="bd b fp z dy mw ea eb mx ed ef dx translated">cloud.google.com</p></div></div></div></a></div></div><div class="ab cl jq jr gp js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hb hc hd he hf"><h1 id="ae6c" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">将（行星）地球化（以适合人类居住）</h1><p id="f655" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">Terraform使用机器可读的定义文件来定义、创建、管理和更新基础设施资源，如物理硬件、虚拟机、容器等。这使我们能够创建可复制的环境，与其他开发人员共享配置，并使我们的基础设施受到版本控制。</p><h2 id="743c" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated">基础设施作为代码</h2><p id="ba79" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">让我们首先创建一个名为<code class="du nj nk nl nb b">terraform</code>的目录，并添加以下文件。</p><h2 id="9971" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated"><strong class="ak"> terraform/main.tf </strong></h2><p id="c96b" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">这里，我们简单地声明几个<a class="ae jk" href="https://www.terraform.io/docs/configuration/variables.html" rel="noopener ugc nofollow" target="_blank">输入变量</a>，并指定我们选择的提供者。</p><blockquote class="mh mi mj"><p id="b914" class="im in mk io b ip iq ir is it iu iv iw ml iy iz ja mm jc jd je mn jg jh ji jj hb bi translated">提供者负责理解API交互和公开资源。提供商一般是IaaS(如阿里云、AWS、GCP、微软Azure、OpenStack)、PaaS(如Heroku)、或SaaS服务(如Terraform Cloud、DNSimple、CloudFlare)。</p></blockquote><p id="e471" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请注意，我们引用的是之前生成的凭证文件。</p><figure class="jm jn jo jp fd ii"><div class="bz dy l di"><div class="nm nn l"/></div></figure><h2 id="67a4" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated"><strong class="ak"> terraform/vm.tf </strong></h2><p id="34ba" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">现在，我们可以继续配置基础架构的主要资源。首先，我们为计算实例指定引导磁盘和机器类型。然后，我们设置一些基本的防火墙设置，并暴露必要的端口。我们还需要附加前面的公共SSH密钥。最后，我们指定一个静态IP地址，并将其绑定到我们的机器上。</p><figure class="jm jn jo jp fd ii"><div class="bz dy l di"><div class="nm nn l"/></div></figure><h2 id="2479" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated"><strong class="ak">terra form/terra form . TF vars</strong></h2><p id="9398" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">我们还需要声明<strong class="io hj"> main.tf </strong>中变量的实际值。继续用您自己的值替换占位符文本。确保包含您的服务帐户的凭证文件和公共SSH密钥。</p><p id="fb99" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请注意，<em class="mk">项目名称</em>需要与您在GCP 中选择的<strong class="io hj">项目名称相匹配，否则我们的凭证文件将不会有任何效果。</strong></p><figure class="jm jn jo jp fd ii"><div class="bz dy l di"><div class="nm nn l"/></div></figure><p id="f907" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要查看完整的地区和区域列表，请查看https://cloud.google.com/compute/docs/regions-zones/<a class="ae jk" href="https://cloud.google.com/compute/docs/regions-zones/" rel="noopener ugc nofollow" target="_blank"/></p><h2 id="cb47" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated">管弦乐编曲</h2><p id="2df3" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">要初始化Terraform，跳转到terraform目录并运行以下命令:</p><pre class="jm jn jo jp fd na nb nc nd aw ne bi"><span id="dede" class="lt jy hi nb b fi nf ng l nh ni">terraform init</span></pre><p id="c03d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了测试我们目前所拥有的，我们可以使用<code class="du nj nk nl nb b">terraform plan</code>命令来预览Terraform最终将创建和/或修改哪些资源。如果一切正常，我们可以继续应用更改:</p><pre class="jm jn jo jp fd na nb nc nd aw ne bi"><span id="a77e" class="lt jy hi nb b fi nf ng l nh ni">terraform apply</span></pre><p id="2afe" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果操作成功，产生的输出应该如下所示:</p><figure class="jm jn jo jp fd ii er es paragraph-image"><div class="er es no"><img src="../Images/d99aa528487c986af81f8778551ba767.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/1*ltGLflM9SpJ6lzT8CooIVg.png"/></div></figure><p id="5b55" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">请务必记下我们新的计算实例</strong>的IP地址，因为我们很快就会用到它。为了方便起见，我们可以将它存储在一个变量中:</p><pre class="jm jn jo jp fd na nb nc nd aw ne bi"><span id="e11e" class="lt jy hi nb b fi nf ng l nh ni">export VM_IP=$(terraform output ip)</span></pre></div><div class="ab cl jq jr gp js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hb hc hd he hf"><h1 id="a04e" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">OAuth</h1><p id="1573" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">为了让Drone最终能够访问我们在Github上的源代码，我们需要快速绕道并注册一个OAuth应用程序。前往Github的设置页面，点击<em class="mk">开发者设置</em>。</p><figure class="jm jn jo jp fd ii er es paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="er es jl"><img src="../Images/8336527105c966e15f9b0424c3ece943.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*2zDBnGe0PXtFDEQ0LLVTbQ.gif"/></div></div></figure><p id="f353" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">选择<em class="mk"> OAuth应用</em>选项卡，点击<em class="mk">新建OAuth应用，</em>填写所需的详细信息。</p><figure class="jm jn jo jp fd ii er es paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="er es nt"><img src="../Images/0fe225a7cfb0c6263448a76238595898.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KvrnRRCt9XtM8xRhAoGiyQ.png"/></div></div></figure><p id="041e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请注意，授权回调URL必须与上述格式和路径匹配，并且必须使用您的确切服务器方案和主机。</p><p id="e7c7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">如果您没有自定义域，请继续使用我们计算实例的IP地址。</strong></p><pre class="jm jn jo jp fd na nb nc nd aw ne bi"><span id="9d6a" class="lt jy hi nb b fi nf ng l nh ni">echo $VM_IP</span></pre></div><div class="ab cl jq jr gp js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hb hc hd he hf"><h1 id="b9cf" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">Ansible</h1><p id="01a2" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">借助Ansible，我们可以轻松地自动化各种各样的任务，从应用程序部署到多节点编排，而无需在远程系统上安装任何代理或附加软件。</p><p id="e60d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了实现这一点，Ansible将现有的SSH守护程序与<a class="ae jk" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks.html" rel="noopener ugc nofollow" target="_blank">剧本</a>结合使用，剧本是帮助我们轻松管理配置和定义编排流程的指令文件。</p><h2 id="ddc3" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated">配置为代码</h2><p id="82b3" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">我们首先需要在所谓的<a class="ae jk" href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html" rel="noopener ugc nofollow" target="_blank">库存文件</a>中添加一个对我们虚拟机的引用。您可以编辑默认的清单，通常可以在<code class="du nj nk nl nb b">/etc/ansible/hosts</code>找到，或者创建您自己的清单文件并用<code class="du nj nk nl nb b">-i &lt;path&gt;</code>标志引用它。</p><p id="956e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">继续添加下面一行。</p><pre class="jm jn jo jp fd na nb nc nd aw ne bi"><span id="58a5" class="lt jy hi nb b fi nf ng l nh ni">droneci ansible_host=[IP]ansible_ssh_private_key_file=[SSH_KEY_PATH]</span></pre><p id="c61b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了测试连接，我们可以使用Ansible的内置ping命令。</p><pre class="jm jn jo jp fd na nb nc nd aw ne bi"><span id="c624" class="lt jy hi nb b fi nf ng l nh ni">ansible droneci -m ping</span></pre><p id="d3ca" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这应该会产生如下所示的输出。</p><figure class="jm jn jo jp fd ii er es paragraph-image"><div class="er es nu"><img src="../Images/45929221951815ec32ec4dc06b2a2525.png" data-original-src="https://miro.medium.com/v2/resize:fit:858/format:webp/1*lAgifFN5jnGAm0VacDZFLw.png"/></div></figure><h2 id="682a" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated">环境变量</h2><p id="0da3" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">在我们开始编写行动手册之前，我们需要添加一些环境变量，以便正确配置Drone CI。</p><figure class="jm jn jo jp fd ii"><div class="bz dy l di"><div class="nm nn l"/></div></figure><p id="071c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">注意，<em class="mk"> DRONE_SERVER_HOST </em>变量需要匹配我们在Github上的OAuth应用程序中指定的域，尽管我们不需要指定协议。</p><p id="4bf4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">通过运行<code class="du nj nk nl nb b">chmod +x env.sh</code>然后运行<code class="du nj nk nl nb b">source env.sh</code>来执行bash脚本。</p><p id="5b30" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有关配置无人机所需变量的更多信息，请查看<a class="ae jk" href="https://docs.drone.io/installation/reference/" rel="noopener ugc nofollow" target="_blank">https://docs.drone.io/installation/reference/</a>。</p><h2 id="b680" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated">剧本</h2><p id="2ae8" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">我们需要一个专门的文件夹来存放行动手册。让我们将它嵌套在另一个名为<code class="du nj nk nl nb b">ansible,</code>的目录中，如下所示:</p><pre class="jm jn jo jp fd na nb nc nd aw ne bi"><span id="2abb" class="lt jy hi nb b fi nf ng l nh ni">.<br/>├── ansible<br/>│   └── playbooks<br/>├── env.sh<br/>└── terraform<br/>    ├── main.tf<br/>    ├── terraform.tfvars<br/>    └── vm.tf</span></pre><p id="17c1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们终于可以开始添加行动手册了。</p><h2 id="eefa" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated"><strong class="ak">ansi ble/playbooks/install-docker . YAML</strong></h2><p id="9e9b" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">我们的第一本剧本将简单地安装Docker和Docker Compose。我们还指定一个Python解释器并安装所需的系统包。</p><figure class="jm jn jo jp fd ii"><div class="bz dy l di"><div class="nm nn l"/></div></figure><h2 id="9a5e" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated">ansi ble/playbooks/<strong class="ak">start-drone . YAML</strong></h2><p id="3ec8" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">安装好一切后，剩下的唯一一步就是运行无人机图像。为此，我们可以使用Ansible内置的Docker Compose模块。注意我们是如何引用我们之前添加的环境变量的。</p><figure class="jm jn jo jp fd ii"><div class="bz dy l di"><div class="nm nn l"/></div></figure><h2 id="f9d9" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated">ansi ble/剧本/main.yaml</h2><p id="83f0" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">最后，我们简单地在<strong class="io hj"> main.yaml </strong>中添加一个对每个文件的引用，它将作为执行我们剧本的主要入口点。</p><figure class="jm jn jo jp fd ii"><div class="bz dy l di"><div class="nm nn l"/></div></figure><h2 id="7869" class="lt jy hi bd jz lu lv lw kd lx ly lz kh ix ma mb kl jb mc md kp jf me mf kt mg bi translated">准备金提取</h2><p id="5899" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">要开始资源调配，请运行以下命令:</p><pre class="jm jn jo jp fd na nb nc nd aw ne bi"><span id="55d9" class="lt jy hi nb b fi nf ng l nh ni">ansible-playbook playbooks/main.yaml</span></pre><p id="8ca5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您选择使用自定义清单文件，相同的命令可能如下所示:</p><pre class="jm jn jo jp fd na nb nc nd aw ne bi"><span id="8944" class="lt jy hi nb b fi nf ng l nh ni">ansible-playbook -i inventory.tpl playbooks/main.yaml -u jimericskogman — private-key ~/.ssh/drone-ci</span></pre><p id="f889" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这可能需要几分钟时间。与此同时，为什么不看一眼你的加密组合，绝望地喘息一下呢😱。</p><p id="4b78" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了验证我们最近的努力是否成功，打开浏览器，前往我们之前指定的域/ip。应该会出现以下屏幕提示。</p><figure class="jm jn jo jp fd ii er es paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="er es nv"><img src="../Images/a3b58d07c3c4a07940911b9584182b70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pvAQm_p4PW2yHHg-XiG0sA.png"/></div></div></figure><p id="be18" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦你登录到Github，你将被重定向到主仪表板，并被要求同步你的存储库。万岁。🎉</p><figure class="jm jn jo jp fd ii er es paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="er es nw"><img src="../Images/bc2e70015f6f60045643ae6d6a20f87e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cevmc4apIa0X524z1Q-d4A.png"/></div></div></figure><h1 id="c64e" class="jx jy hi bd jz ka la kc kd ke lb kg kh ki lc kk kl km ld ko kp kq le ks kt ku bi translated">结论</h1><p id="fe62" class="pw-post-body-paragraph im in hi io b ip kv ir is it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj hb bi translated">我们已经完成了一次充满希望的、相对轻松的旅程。我们的CI/CD都设置好了，我们就可以开始构建、测试和部署我们的代码了。我们将在以后的文章中讨论这个话题。在此之前，我感谢你的时间，并向你告别！</p><div class="mo mp ez fb mq mr"><a href="https://github.com/jadechip/infrastructure-as-code" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab dw"><div class="mt ab mu cl cj mv"><h2 class="bd hj fi z dy mw ea eb mx ed ef hh bi translated">jade chip/基础设施即代码</h2><div class="my l"><h3 class="bd b fi z dy mw ea eb mx ed ef dx translated">在GCP Ansible和Terraform上使用Terraform &amp; Ansible，10分钟内完成CI/CD解决方案的配套代码…</h3></div><div class="mz l"><p class="bd b fp z dy mw ea eb mx ed ef dx translated">github.co</p></div></div><div class="nx l"><div class="ny l nz oa ob nx oc ik mr"/></div></div></a></div></div></div>    
</body>
</html>