<html>
<head>
<title>Easily deploy new versions of code to Kubernetes on GCP with a single command.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">只需一个命令，就可以轻松地将新版本的代码部署到GCP的Kubernetes上。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/easily-deploy-new-versions-of-code-to-kubernetes-on-gcp-with-a-single-command-ff920a367cf1?source=collection_archive---------0-----------------------#2018-05-29">https://medium.com/google-cloud/easily-deploy-new-versions-of-code-to-kubernetes-on-gcp-with-a-single-command-ff920a367cf1?source=collection_archive---------0-----------------------#2018-05-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="ae55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文将介绍如何创建一个基本的工作流程，让您可以使用一个命令来推送应用程序的新版本。</p><p id="e79d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我把它称为穷人在GCP(谷歌云平台)上为Kubernetes编写的持续集成脚本。</p><p id="e8a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置完成后，您只需输入以下命令即可更新您的应用程序(node.js):</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="42bd" class="jm jn hi ji b fi jo jp l jq jr">yarn gcp</span></pre></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><p id="e68a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">部署流程概述:</strong></p><ol class=""><li id="9e2b" class="jz ka hi ih b ii ij im in iq kb iu kc iy kd jc ke kf kg kh bi translated">您的应用程序在Kubernetes上作为服务运行</li><li id="591d" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">您在开发机器上更新本地repo中的代码</li><li id="51a2" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">您将这些更改提交给git，并推送到Github上的主分支</li><li id="8549" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">GCP将看到提交并更新GCP源存储库中的镜像回购。</li><li id="1584" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">GCP构建触发器将看到更新的主repo并构建docker容器。</li><li id="1e42" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">除非你要求，否则GCP不会用新的docker版本更新kubernetes服务。</li><li id="2f0d" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">您在开发机器上输入<code class="du kn ko kp ji b">yarn gcp</code>,这个脚本将监控构建触发器，并自动用新的构建更新kubernetes上的服务。</li></ol><p id="beb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">本文假设如下:</strong></p><ol class=""><li id="5169" class="jz ka hi ih b ii ij im in iq kb iu kc iy kd jc ke kf kg kh bi translated">您的应用程序代码已下载到您的机器上，并且您已安装了kubectl/gcloud cli。您的PROJECT_ID在gcloud中设置正确。</li><li id="47ab" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">您的应用程序是一个git repo，可以在Github上获得，并且正确设置了远程url，您可以提交和推送对主分支的更改。您可以根据需要对Bitbucket等进行调整。</li><li id="befc" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">您已经成功地在kubernetes中将应用程序作为服务运行。</li><li id="5a4a" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">如果您还没有将Github repo链接到GCP的容器注册中心构建触发器，那么您可以接受。</li><li id="6d57" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">我们将部署Node.js应用程序，但您可以根据需要对任何基于Docker的应用程序进行调整。</li></ol></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><p id="1a4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我们将要使用的完整的构建脚本。将其复制到项目根目录下的文件<code class="du kn ko kp ji b">deploy.sh</code>中。这个文件中没有任何秘密，所以你可以把它提交给source。</p><figure class="jd je jf jg fd kq"><div class="bz dy l di"><div class="kr ks l"/></div></figure><ol class=""><li id="648a" class="jz ka hi ih b ii ij im in iq kb iu kc iy kd jc ke kf kg kh bi translated">保存上述文件后，编辑<code class="du kn ko kp ji b">package.json</code>，添加以下脚本:</li></ol><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="e428" class="jm jn hi ji b fi jo jp l jq jr"># package.json</span><span id="a52e" class="jm jn hi ji b fi kt jp l jq jr">{<br/>  scripts: {<br/>    "gcp": "./deploy.sh"<br/>  }<br/>}</span></pre><p id="910c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.如果以后不能运行的话，你需要让<code class="du kn ko kp ji b">deploy.sh</code>脚本在你的开发机器上可执行。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="505a" class="jm jn hi ji b fi jo jp l jq jr">$ chmod +x deploy.sh</span></pre><p id="6676" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.在谷歌云控制台上，访问容器注册表-&gt;构建触发器。为应用的回购设置构建触发器。假设使用Github，您将需要使用GCP上的向导来验证和添加您的repo。</p><p id="b565" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.对于触发器设置，请提供任意名称。您只需要设置分支名称。如果这是你唯一想要的分支，你可以输入master。对于图像名称，保留默认值或使用以下名称:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="9a92" class="jm jn hi ji b fi jo jp l jq jr">gcr.io/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA</span></pre><p id="4839" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.对于构建触发器来说，这就差不多了，定制您可能需要的任何其他设置。</p><p id="cd73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.在您的开发机器上，根据需要定制deploy.sh文件。阅读行内注释了解更多信息。</p><ul class=""><li id="bbd1" class="jz ka hi ih b ii ij im in iq kb iu kc iy kd jc ku kf kg kh bi translated">根据您的应用程序设置名称、徽标和URL。</li><li id="0d30" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ku kf kg kh bi translated">确保您的PROJECT_ID已在gcloud cli中设置</li></ul></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><p id="15bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">测试完毕</strong></p><p id="e091" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们可以更新源代码并验证构建触发器正在工作。</p><ol class=""><li id="e6ea" class="jz ka hi ih b ii ij im in iq kb iu kc iy kd jc ke kf kg kh bi translated">在您的开发机器上对本地源代码进行任何更改。</li><li id="9ee9" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">提交更改并推送到您的远程源(推送到github等)。</li><li id="323a" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">登录谷歌云控制台，进入容器注册-&gt;构建历史。</li><li id="375e" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">您应该会看到一个新的构建被触发并运行。检查细节并确认容器名称看起来不错。</li><li id="5327" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">在您的开发机器上，键入<code class="du kn ko kp ji b">yarn gcp</code>。您将看到deploy.sh脚本开始运行并检查远程构建状态。根据构建需要的时间，脚本将每45秒检查一次。</li><li id="684f" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">一旦检测到构建成功完成，它将使用新的docker映像更新Kubernetes服务。</li><li id="84d6" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">您可以运行<code class="du kn ko kp ji b">kubectl get pods</code>来监控更新。</li><li id="f124" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">就是这样，检查公共网址，看看你的新版本是否运行。</li></ol></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><p id="0db4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">成交记录</strong></p><p id="4dbc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本上，任何时候你需要在Kubernetes上更新你的应用程序，把一些代码推送到Github，然后运行<code class="du kn ko kp ji b">yarn gcp</code>，等几分钟。你的应用应该会自动更新。</p><p id="ca47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以修改<code class="du kn ko kp ji b">deploy.sh</code>来更频繁地检查，或者以更短的时间间隔等，这取决于您的构建过程通常需要多长时间。目前它检查9次，超时前每45秒检查一次。</p><p id="5a29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你也可以使用不同于“GCP”<code class="du kn ko kp ji b">yarn gcp</code>等的脚本名。相应更新<code class="du kn ko kp ji b">package.json</code>中的名称即可。</p></div></div>    
</body>
</html>