<html>
<head>
<title>GKE cluster config params — how to rule them all?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GKE集群配置参数—如何管理它们？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gke-cluster-config-params-how-to-rule-them-all-240c0b10cdf2?source=collection_archive---------7-----------------------#2022-12-16">https://medium.com/google-cloud/gke-cluster-config-params-how-to-rule-them-all-240c0b10cdf2?source=collection_archive---------7-----------------------#2022-12-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9f0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建GKE集群似乎是一件容易的事情。只需在UI控制台或一个terraform-或gcloud-命令中点击几下，就可以创建一个集群。</p><p id="2b89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，深入下去，你会发现很多详细的设置和参数，事情开始变得有点复杂。如何找出合适的配置？默认值总是最好的选择吗？如何确保您的集群安全可靠、可扩展并满足高可用性要求？</p><p id="a1c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以浏览Google提供的一些文档和最佳实践。这是知识的伟大源泉。然而，将这些知识付诸实践，这意味着在您的所有集群上手动检查所有这些知识…这并不令人兴奋，这很无聊，这是一件苦差事！</p><p id="a45f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好消息是，您不必手动执行此操作。您可以使用<a class="ae jd" href="https://github.com/google/gke-policy-automation" rel="noopener ugc nofollow" target="_blank"> GKE策略自动化</a>——自动化、免费使用的<a class="ae jd" href="https://github.com/google/gke-policy-automation/" rel="noopener ugc nofollow" target="_blank">开源工具</a>来发现并对照最佳实践集检查您的GKE集群。</p><h2 id="853a" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">让我们从这里开始，检查简单集群</h2><p id="cca3" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">我们需要在集群项目上使用roles/container . cluster viewer IAM角色登录到云shell。让我们来看看:</p><pre class="ke kf kg kh fd ki kj kk bn kl km bi"><span id="6bad" class="kn jf hi kj b be ko kp l kq kr">gcloud auth application-default login</span></pre><p id="4233" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获取应用程序默认凭据的命令。</p><p id="a5d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一步是创建配置文件，其中包含我们想要检查的集群的详细信息。然后，让我们创建专用目录，(例如gpa-config/)并将文件config.yaml放在那里。最简单的配置可能是:</p><pre class="ke kf kg kh fd ki kj kk bn kl km bi"><span id="5c75" class="kn jf hi kj b be ko kp l kq kr">clusters:<br/>  - name: cluster1<br/>    project: project-1<br/>    location: europe-west3<br/>  - name: cluster2<br/>    project: project-1<br/>    location: us-central1<br/>  - name: cluster3<br/>    project: project-2<br/>    location: europe-central1</span></pre><p id="9bfa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，通过多一个IAM角色(roles/cloudasset.viewer ),我们可以进一步简化配置，并在组织、文件夹或项目级别运行具有自动集群发现功能的工具。在这种情况下，我们的配置文件如下所示:</p><pre class="ke kf kg kh fd ki kj kk bn kl km bi"><span id="fdbe" class="kn jf hi kj b be ko kp l kq kr">clusterDiscovery:<br/>  enabled: true<br/>  organization: "123456789012"</span></pre><p id="0419" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要执行的最后一件事是运行工具。为此，我们可以使用docker容器:</p><pre class="ke kf kg kh fd ki kj kk bn kl km bi"><span id="f51e" class="kn jf hi kj b be ko kp l kq kr">docker run --rm -v ~/gpa-config/config.yaml:/temp/config.yaml \<br/>    ghcr.io/google/gke-policy-automation check --config /temp/config.yaml</span></pre><p id="1a2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还有tadaaam…</p><figure class="ke kf kg kh fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ks"><img src="../Images/335b1b801c4eeb3fce71db2d258a9942.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XTD36lbV1aUfyZa22QsKbg.png"/></div></div><figcaption class="la lb et er es lc ld bd b be z dx translated">GKE策略自动化输出示例</figcaption></figure><p id="543b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在控制台输出中，可以看到针对一组最佳实践策略的集群验证结果。</p><h2 id="5255" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">检查了什么？</h2><p id="4513" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">在GKE策略自动化项目中维护了最初的三十多个策略集。嵌入策略中的规则来自GKE产品的官方文档，以及谷歌专业服务团队的经验。它们分为几类:</p><ul class=""><li id="de06" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated">安全性</li><li id="621c" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">维护</li><li id="5843" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">管理</li><li id="e535" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">有效性</li><li id="c92e" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">可量测性</li></ul><p id="19ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仅举几个我们刚刚检查过的例子:</p><ul class=""><li id="88d0" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated">为了安全起见，除了别的以外，还检查集群控制平面暴露、如何授权对控制平面的访问、如何管理秘密以及是否有适当的服务范围账户许可。</li><li id="b581" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">通过使用区域控制平面和区域节点池、节点自动修复配置来检查可用性。</li><li id="2c45" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">集群管理和维护类别包括检查网络配置、版本和更新设置。</li><li id="034a" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">可扩展性策略检查自动扩展选项、节点自动配置的正确使用以及本地DNS缓存的使用。</li></ul><p id="0e78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以指定您自己组织的最佳实践，并将其附加到GKE策略自动化工具。</p><h2 id="8d5b" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">太好了，但是结果如何呢？</h2><p id="eee0" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">到目前为止，一切顺利！我们现在知道要修复什么了！现在难道不是卷起袖子开始修复集群配置的大好时机吗？没那么快…我们还可以用这个工具做一件事，以确保我们的集群配置不会再次漂移。</p><p id="2f47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面，我只描述了最简单的用例以及运行该工具的最简单的配置。但是，想象一下，您可以让该工具在后台运行，并每天/每周检查您的所有集群配置。并在安全指挥中心控制台向您显示结果。其实…已经有了！有更详细的<a class="ae jd" href="https://cloud.google.com/blog/topics/developers-practitioners/auditing-gke-clusters-across-entire-organization" rel="noopener ugc nofollow" target="_blank">博文</a>描述了这个用例:)</p><p id="c1d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">快乐阅读，配置和修复！</p><p id="1150" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ls">本文仅代表作者个人观点，不代表谷歌</em> <strong class="ih hj">的观点。</strong></p></div></div>    
</body>
</html>