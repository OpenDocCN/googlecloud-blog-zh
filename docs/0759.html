<html>
<head>
<title>Building, Testing, and Optimizing Code on Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google Cloud上构建、测试和优化代码</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/building-testing-and-optimizing-code-on-google-cloud-e0d7ea74f1f5?source=collection_archive---------0-----------------------#2018-09-08">https://medium.com/google-cloud/building-testing-and-optimizing-code-on-google-cloud-e0d7ea74f1f5?source=collection_archive---------0-----------------------#2018-09-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="6406" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">摘要</h1><p id="fb6b" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这篇文章解释了如何使用Google云平台工具，通过一个可以在本地运行的应用程序，在单元测试中，一个普通的Docker容器中，以及在带有自定义容器的App Engine Flex中，构建和测试Go代码。代码的构建、测试和部署由云构建驱动。示例代码是一个基本但重要的应用程序，名为<a class="ae kb" href="https://github.com/GoogleCloudPlatform/golang-samples/tree/master/getting-started/devflowapp" rel="noopener ugc nofollow" target="_blank"> devflowapp </a>，在结构上类似于现实世界的web应用程序，可以作为您项目的模板。该应用展示了代码优化工具Cloud Trace、OpenCensus和Cloud Profiler。</p><h1 id="2ada" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">背景</h1><p id="c500" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">谷歌<a class="ae kb" href="https://cloud.google.com/cloud-build/docs/" rel="noopener ugc nofollow" target="_blank">云构建</a>是一个多语言集成工具，用于在<a class="ae kb" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a>上运行构建和测试。我经常发现自己收集命令来测试、构建、打包和部署日常开发工作的代码。云构建的好处在于，你可以将这些命令格式化成<a class="ae kb" href="https://cloud.google.com/cloud-build/docs/build-config" rel="noopener ugc nofollow" target="_blank">构建配置文件</a>，这些文件比一长串命令更容易重新运行，更好地与他人共享。这个简单但不平凡的应用程序提供了一个方便的跟踪和分析平台，这对于任何优化成本和提供良好用户体验的应用程序来说都是必不可少的。</p><p id="760f" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">关于<a class="ae kb" href="https://cloud.google.com/appengine/docs/flexible/" rel="noopener ugc nofollow" target="_blank"> App Engine Flex </a>的一个好处是，它允许您运行常规代码，而没有任何将您与App Engine联系在一起的导入。App Engine Standard一直在减少依赖性，但在撰写本文时还没有完全摆脱依赖性。Flex中的最小依赖性使您能够利用App Engine在统一环境中方便地运行，然后在需要时将代码移动到其他地方。</p><h1 id="69d8" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">云项目设置</h1><p id="030e" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">GitHub示例<a class="ae kb" href="https://github.com/GoogleCloudPlatform/golang-samples/tree/master/getting-started/devflowapp" rel="noopener ugc nofollow" target="_blank"> README </a>文件中描述了运行该应用程序的先决条件。要执行分析和跟踪，您还需要启用Stackdriver分析API和Stackdriver跟踪API。</p><h1 id="f027" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">项目目录布局</h1><p id="25ca" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">项目目录布局是开始一个新项目时首先要考虑的因素之一。一个可能的选择是围棋项目<a class="ae kb" href="https://github.com/golang-standards/project-layout" rel="noopener ugc nofollow" target="_blank">的布局建议</a>的建议。请注意，这不是一个标准，也不一定有围绕它的社区。本例中的项目布局如下</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="f817" class="kq ig hi km b fi kr ks l kt ku">/build</span></pre><p id="0939" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">云构建配置文件</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="3857" class="kq ig hi km b fi kr ks l kt ku">/data</span></pre><p id="8eb3" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">数据库配置文件</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a85b" class="kq ig hi km b fi kr ks l kt ku">/deployment</span></pre><p id="dd2d" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">部署工件</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="e921" class="kq ig hi km b fi kr ks l kt ku">/services</span></pre><p id="dcfb" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">Go软件包目录</p><p id="c2e6" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">如果您在自己的工作空间中尝试这样做，您可以使用git clone命令获得代码，并将目录更改为<code class="du kv kw kx km b">devflowapp</code>。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="d838" class="kq ig hi km b fi kr ks l kt ku">git clone <a class="ae kb" href="https://github.com/GoogleCloudPlatform/golang-samples.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/golang-samples.git</a> cd go/src/github.com/GoogleCloudPlatform/golang-samples/getting-started/devflowapp</span></pre><h1 id="6ee5" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">当地发展环境</h1><p id="d2cd" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">按照<a class="ae kb" href="https://github.com/GoogleCloudPlatform/golang-samples/tree/master/getting-started/devflowapp" rel="noopener ugc nofollow" target="_blank">自述文件</a>中的步骤，在本地开发环境中运行和单元测试应用程序。其中的说明包括使用云SQL为应用程序建立一个MySQL数据库。如果您使用的不是SQL数据库，您可以编写自己的<a class="ae kb" href="https://github.com/GoogleCloudPlatform/golang-samples/blob/master/getting-started/devflowapp/services/services.go#L17" rel="noopener ugc nofollow" target="_blank"> MessageService </a>接口实现。一个真正的消息应用程序需要一个存储系统和一个通知服务。通知服务可能是用于web和移动应用程序通知的<a class="ae kb" href="https://firebase.google.com/docs/cloud-messaging/" rel="noopener ugc nofollow" target="_blank"> Firebase Cloud Messaging </a>。</p><h1 id="b812" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">包装在码头集装箱中</h1><p id="b7a3" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">自述文件还描述了将应用程序打包到Docker容器中。此活动可以在开发环境之外部署您的应用程序。一种选择是部署到App Engine Flex，这在GitHub示例中有所描述。对于许多应用程序来说，App Engine是在互联网上提供web应用程序的最简单、最具成本效益的方式。但是，使用示例中的自定义包含方法，您可以将相同的代码打包到Kubernetes。</p><h1 id="0709" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">测试和性能优化</h1><p id="c908" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">一旦您的应用程序在至少一个环境中启动并运行，接下来的步骤就是自动化端到端测试、应用一些负载并优化性能。优化性能可以分为侧重于资源使用的分析和侧重于延迟的跟踪。</p><h1 id="c92a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">集成和负载测试</h1><p id="2ee7" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">GitHub示例提供了一个使用curl和<a class="ae kb" href="https://github.com/GoogleCloudPlatform/golang-samples/blob/master/getting-started/devflowapp/build/cb-e2etest.yaml" rel="noopener ugc nofollow" target="_blank"> cb-e2etest.yaml </a>进行集成测试的例子。有了在App Engine Flex上运行的应用程序版本，我们就可以很好地使用命令来运行它。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="83a1" class="kq ig hi km b fi kr ks l kt ku">gcloud builds submit — config build/cb-e2etest.yaml .</span></pre><p id="84eb" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">Curl是一个很好的工具，它可以处理复杂的HTTP请求，适合自动化用户对网站的访问。示例构建文件使用<a class="ae kb" href="https://ec.haxx.se/cmdline-globbing.html" rel="noopener ugc nofollow" target="_blank"> curl globbing </a>多次调用请求，以便生成足够的数据来分析应用程序。一种更复杂的集成测试方法是使用Selenium <a class="ae kb" href="https://www.seleniumhq.org/docs/03_webdriver.jsp" rel="noopener ugc nofollow" target="_blank"> WebDriver </a>这样的工具。</p><h1 id="ceed" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">压型</h1><p id="df97" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">现在，我们已经在应用程序上生成了一些负载，我们可以看看性能配置文件。您可以使用<a class="ae kb" href="https://cloud.google.com/profiler/docs/" rel="noopener ugc nofollow" target="_blank"> Stackdriver Profiler </a>来分析代码，以确定可以优化的区域。这里的步骤改编自页面<a class="ae kb" href="https://cloud.google.com/profiler/docs/profiling-go" rel="noopener ugc nofollow" target="_blank">仿形Go代码</a>。</p><p id="9047" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">如果尚未启用Stackdriver Profiler API，可以使用以下命令:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="089b" class="kq ig hi km b fi kr ks l kt ku">gcloud services enable cloudprofiler.googleapis.com</span></pre><p id="54ec" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">要启用Stackdriver Profiler，您需要向<a class="ae kb" href="https://github.com/GoogleCloudPlatform/golang-samples/blob/master/getting-started/devflowapp/devflowapp.go" rel="noopener ugc nofollow" target="_blank"> devflowapp.go </a>示例中添加一些代码。该代码在<a class="ae kb" href="https://gist.github.com/alexamies/b6fd7e236d0fb45c8854ac444b0f4fed" rel="noopener ugc nofollow" target="_blank">本要点</a>中提供。您可能需要在docker文件中使用Go 1.10来构建它，因为依赖关系发生了一些变化。然后使用以下命令重新部署到App Engine Flex</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="bb47" class="kq ig hi km b fi kr ks l kt ku">DB_PASSWORD=[user db password]<br/>gcloud builds submit \<br/>  --substitutions=_DB_PASSWORD=$DB_PASSWORD \<br/>  --config build/cb-deploy.yaml .</span></pre><p id="9be5" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">如上所述，运行集成测试，我们可以在云控制台中查看profline。截图如下。</p><figure class="kh ki kj kk fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ky"><img src="../Images/711fde1d56dbfe755273a0b3eb93e53c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XwdKtgiFsC-y0-UP"/></div></div></figure><p id="171b" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">basic app的CPU配置文件截图</strong></p><p id="4f04" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">在从<code class="du kv kw kx km b">main()</code>向下钻取到<code class="du kv kw kx km b">ServeHTTP</code>之后，可以看到<code class="du kv kw kx km b">handleCheckMessages</code>方法消耗了相当多的时间。这是因为对检索的消息数量没有限制。如果您运行端到端测试，manny消息将被插入数据库足够多的次数，导致用于检索消息的资源大幅增长。</p><h1 id="296e" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">描摹</h1><p id="506b" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><a class="ae kb" href="https://cloud.google.com/trace/docs/" rel="noopener ugc nofollow" target="_blank"> Stackdriver Cloud Trace </a>是一个分布式的跟踪系统，包括跟踪数据的管理和展现。您的应用程序可以使用<a class="ae kb" href="https://opencensus.io/" rel="noopener ugc nofollow" target="_blank"> OpenCensus </a>进行跟踪数据收集，这是一个用于监控和跟踪指标收集的开源框架。除了Stackdriver之外，OpenCensus收集的跟踪数据可以通过其他后端进行管理和查看。<a class="ae kb" href="https://gist.github.com/alexamies/b6fd7e236d0fb45c8854ac444b0f4fed" rel="noopener ugc nofollow" target="_blank">要点</a>中的代码，包括追踪所需的代码变更，改编自<a class="ae kb" href="https://opencensus.io/codelabs/stackdriver/" rel="noopener ugc nofollow" target="_blank">open census stack driver Codelab</a>。</p><p id="6aeb" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">确保Stackdriver Trace API已启用，并且<a class="ae kb" href="https://cloud.google.com/docs/authentication/production#auth-cloud-implicit-go" rel="noopener ugc nofollow" target="_blank">启用应用程序默认凭证</a>进行身份验证。如果你在App Engine或GKE上运行，那么这个已经被启用了，但是你需要它用于本地开发和GCE。</p><p id="f4bc" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">Stackdriver跟踪的屏幕截图如下所示。</p><figure class="kh ki kj kk fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ky"><img src="../Images/b110bc031fd522b25e5b228c2dd8d187.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YZvc_axUo4TdZLns"/></div></div></figure><h1 id="76f9" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">更大的</h1><p id="cd7c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">关于Google云构建的更多信息，请参见<a class="ae kb" href="https://cloud.google.com/cloud-build/" rel="noopener ugc nofollow" target="_blank">云构建</a>文档页面的记录。另请参见<a class="ae kb" href="https://github.com/GoogleCloudPlatform/golang-samples/tree/master/getting-started/bookshelf" rel="noopener ugc nofollow" target="_blank"> Go Bookshelf </a>示例应用程序，了解使用Go的许多存储选项；以及<a class="ae kb" href="https://cloud.google.com/appengine/docs/standard/go/building-app/" rel="noopener ugc nofollow" target="_blank">使用Go构建应用程序</a>，了解使用Go on App Engine Standard进行web开发的示例。</p><p id="f0c4" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">您可能想探索的其他开发工具包括:</p><ol class=""><li id="f45e" class="lg lh hi jf b jg kc jk kd jo li js lj jw lk ka ll lm ln lo bi translated"><a class="ae kb" href="https://cloud.google.com/debugger/docs/" rel="noopener ugc nofollow" target="_blank">栈驱动云调试器</a> —用于检查正在运行的应用程序的状态</li><li id="3139" class="lg lh hi jf b jg lp jk lq jo lr js ls jw lt ka ll lm ln lo bi translated"><a class="ae kb" href="https://golang.org/pkg/testing/#hdr-Benchmarks" rel="noopener ugc nofollow" target="_blank">执行测试基准测试</a> —了解性能基准测试的详细信息</li><li id="4ff2" class="lg lh hi jf b jg lp jk lq jo lr js ls jw lt ka ll lm ln lo bi translated">Gometalinter——一种静态代码分析的方法</li><li id="05b6" class="lg lh hi jf b jg lp jk lq jo lr js ls jw lt ka ll lm ln lo bi translated"><a class="ae kb" href="https://opensource.googleblog.com/2018/08/openmetrics-project-accepted-into-cncf.html" rel="noopener ugc nofollow" target="_blank"> OpenMetrics </a> —度量收集标准的标准提案</li><li id="c2c9" class="lg lh hi jf b jg lp jk lq jo lr js ls jw lt ka ll lm ln lo bi translated"><a class="ae kb" href="https://github.com/GoogleCloudPlatform/cloud-builders-community" rel="noopener ugc nofollow" target="_blank">谷歌云构建社区图像</a> —社区贡献的构建者</li></ol></div></div>    
</body>
</html>