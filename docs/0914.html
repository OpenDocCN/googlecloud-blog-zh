<html>
<head>
<title>Increasing PostgreSQL Cloud SQL Connections w/ PgBouncer &amp; Kubernetes Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用PgBouncer和Kubernetes引擎增加PostgreSQL云SQL连接</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/increasing-cloud-sql-postgresql-max-connections-w-pgbouncer-kubernetes-engine-49b0b2894820?source=collection_archive---------0-----------------------#2019-02-10">https://medium.com/google-cloud/increasing-cloud-sql-postgresql-max-connections-w-pgbouncer-kubernetes-engine-49b0b2894820?source=collection_archive---------0-----------------------#2019-02-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/51b5869f4320d40a598e98aa8a3e6ae9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8zKPl8oWM1bjTzm4"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Denys Nevozhai 在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="a31d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我最近读了一篇来自<a class="ae iu" href="https://medium.com/futuretech-industries" rel="noopener"> FutureTech Industries </a>的精彩的3部分文章，内容是关于使用Helm、Kubernetes、PgBouncer和CloudSQL来大幅增加Postgresql DB可以处理的连接。虽然它提供了很多信息，但作为一个对Helm和Kubernetes不是很精通的人，我需要一个更全面的教程来安装Helm、Tiller和设置env。我认为基于我所学的一步一步的教程将有助于下一个“我”蹒跚而行。</p><p id="f6b4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">PostgreSQL是一个非常棒的数据库，为初创公司和大公司提供了巨大的价值。可惜；它不能很好地处理大量连接，这在部署支持多线程的大型REST API时经常发生。Google Cloud SQL现在提供了高可用性的Postgresql数据库，性能非常好，但它们的<a class="ae iu" href="https://cloud.google.com/sql/docs/quotas" rel="noopener ugc nofollow" target="_blank">连接限制</a>有时太低，无法让您充分利用实例。如果没有连接池，廉价的CloudSQL实例很快就会因连接而达到极限，并停止扩展，除非您在更大的实例上花了一大笔钱。</p><p id="87e8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就是PgBouncer的用武之地，它是一个简单的PostgreSQL连接池，一次允许几千个连接。基于来自<a class="ae iu" rel="noopener" href="/futuretech-industries/gracefully-scaling-to-10k-postgresql-connections-for-35-mo-part-three-3a780eed72cf"> futuretech-industries </a>的精彩文章，使用Kubernetes引擎运行Helm Chart w/ PgBouncer，我们能够建立一个易于部署的系统，以便在不倾家荡产的情况下充分利用我们的CloudSQL数据库。</p><h1 id="b608" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">设置云SQL</h1><p id="81c1" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">您需要一个启用了private-ip的云SQL实例。这是有据可查的，可以完全通过云控制台完成，无需CLI。请点击下面的链接获取详细说明！</p><ol class=""><li id="111d" class="kw kx hi ix b iy iz jc jd jg ky jk kz jo la js lb lc ld le bi translated"><a class="ae iu" href="https://cloud.google.com/sql/docs/postgres/create-instance" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">创建云SQL实例</strong> </a> <strong class="ix hj"> ( </strong> <em class="lf">确保将它放在与您的Kubernetes集群相同的区域中！)</em></li><li id="5f8c" class="kw kx hi ix b iy lg jc lh jg li jk lj jo lk js lb lc ld le bi translated"><a class="ae iu" href="https://cloud.google.com/sql/docs/postgres/configure-private-ip" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">启用私有IP </strong> </a></li><li id="41c2" class="kw kx hi ix b iy lg jc lh jg li jk lj jo lk js lb lc ld le bi translated"><a class="ae iu" href="https://cloud.google.com/sql/docs/postgres/create-manage-users" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">为PgBouncer </strong> </a>创建一个DB用户</li></ol><h1 id="b801" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">创建Kubernetes集群</h1><p id="ec3b" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">这一步也很简单，不需要CLI也可以完成。在节点池下，关闭<strong class="ix hj">如果启用了</strong>自动扩展，添加标签<code class="du ll lm ln lo b">role: pgbouncer</code>并创建您的集群</p><ol class=""><li id="9a7a" class="kw kx hi ix b iy iz jc jd jg ky jk kz jo la js lb lc ld le bi translated"><a class="ae iu" href="https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">创建集群</strong> </a></li><li id="f511" class="kw kx hi ix b iy lg jc lh jg li jk lj jo lk js lb lc ld le bi translated"><strong class="ix hj">为私有IP启用VPC-native</strong>:<br/><em class="lf">这将允许您的集群使用私有IP与您的云SQL数据库进行通信，而无需通过公共互联网进行通信(更安全！).</em></li></ol><figure class="lq lr ls lt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/fe97f97834e61f1a8384888cbff57b0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WvmFPq4r5eJfnTRfDviNTA.png"/></div></div></figure><h1 id="7b4c" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">设置和验证GCloud SDK命令行</h1><p id="bb0e" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">您将需要它来检索凭证以部署到您的kubernetes集群。</p><ol class=""><li id="effd" class="kw kx hi ix b iy iz jc jd jg ky jk kz jo la js lb lc ld le bi translated"><a class="ae iu" href="https://cloud.google.com/sdk/docs/quickstarts" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">安装并认证云SDK </strong> </a></li></ol><h1 id="398f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">本地安装舵</h1><p id="d40e" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">Helm是Kubernetes的一个包管理器，它拥有名为“图表”的包，其中包含将工作负载部署到Kubernetes平台上的模板。Helm使用通常安装在集群上的名为“Tiller”的服务。如果你做任何研究，你一定会读到Tiller的安全问题，如果没有在生产中安全安装的话。我将向你展示如何在你的本地计算机上安装Tiller来完全避免这个安全问题。以下是基于<a class="ae iu" href="https://rimusz.net/author/rimusz/" rel="noopener ugc nofollow" target="_blank">里马斯·莫克维丘斯</a>关于如何安装<a class="ae iu" href="https://rimusz.net/tillerless-helm/" rel="noopener ugc nofollow" target="_blank">“无舵舵舵”</a>的这篇很棒的教程。这样你就可以从tiller获得所有的好处，而不会有安全问题。</p><p id="01c7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Helm的安装非常简单，有很多安装方式。我更喜欢安装如下脚本的头盔:</p><pre class="lq lr ls lt fd lu lo lv lw aw lx bi"><span id="def9" class="ly ju hi lo b fi lz ma l mb mc">$ curl https://raw.githubusercontent.com/helm/helm/master/scripts/get &gt; get_helm.sh<br/>$ chmod 700 get_helm.sh<br/>$ ./get_helm.sh</span></pre><p id="f5f7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">其他操作系统请看这里</p><h2 id="904a" class="ly ju hi bd jv md me mf jz mg mh mi kd jg mj mk kh jk ml mm kl jo mn mo kp mp bi translated">舵柄插件本地安装</h2><p id="30ef" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">安装后，您需要在本地初始化helm。<code class="du ll lm ln lo b">--client-only</code>标志确保Tiller没有安装在您集群上</p><pre class="lq lr ls lt fd lu lo lv lw aw lx bi"><span id="ee7c" class="ly ju hi lo b fi lz ma l mb mc">helm init --client-only</span></pre><p id="886d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后你需要从谷歌云平台获取你的Kubernetes集群证书。这告诉Tiller要连接到哪个集群并对其进行身份验证:</p><pre class="lq lr ls lt fd lu lo lv lw aw lx bi"><span id="ca97" class="ly ju hi lo b fi lz ma l mb mc">gcloud beta container clusters get-credentials &lt;cluster-name&gt; --region &lt;cluster-region&gt; --project &lt;project-id&gt;</span></pre><p id="0bcd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">…并安装Tiller插件以在本地运行Tiller:</p><pre class="lq lr ls lt fd lu lo lv lw aw lx bi"><span id="c8a6" class="ly ju hi lo b fi lz ma l mb mc">$ helm plugin install https://github.com/rimusz/helm-tiller<br/>Installed plugin: tiller</span></pre><h2 id="fe08" class="ly ju hi bd jv md me mf jz mg mh mi kd jg mj mk kh jk ml mm kl jo mn mo kp mp bi translated">本地启动Tiller服务器:</h2><p id="0b44" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">您可以包含任何您想要的名称空间，或者留空，它将默认为<code class="du ll lm ln lo b">kube-system</code></p><pre class="lq lr ls lt fd lu lo lv lw aw lx bi"><span id="d95a" class="ly ju hi lo b fi lz ma l mb mc">$ helm tiller start &lt;namespace&gt;</span></pre><p id="a576" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果它不起作用，尝试这个命令告诉helm Tiller正在哪个端口上运行:</p><pre class="lq lr ls lt fd lu lo lv lw aw lx bi"><span id="c7b5" class="ly ju hi lo b fi lz ma l mb mc">export HELM_HOST=localhost:44134</span></pre><p id="e012" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">完成后停止耕作:</p><pre class="lq lr ls lt fd lu lo lv lw aw lx bi"><span id="cb6c" class="ly ju hi lo b fi lz ma l mb mc">helm tiller stop</span></pre><h2 id="263c" class="ly ju hi bd jv md me mf jz mg mh mi kd jg mj mk kh jk ml mm kl jo mn mo kp mp bi translated">为安装设置图表</h2><p id="b5b2" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">您现在可以在集群上安装图表了，但是首先您需要一个图表！我修改了一张来自<a class="ae iu" rel="noopener" href="/futuretech-industries/gracefully-scaling-to-10k-postgresql-connections-for-35-mo-part-three-3a780eed72cf"> futuretech-industries </a>的图表，它将允许您使用内部负载平衡器在本地公开您的集群。谷歌的内部负载均衡器将允许你使用私有ip与VPC中的其他资源共享你的集群，而不用公开它。除了修改之外，它与原始图表<a class="ae iu" href="https://github.com/futuretechindustriesllc/charts/" rel="noopener ugc nofollow" target="_blank">相同。</a></p><pre class="lq lr ls lt fd lu lo lv lw aw lx bi"><span id="015d" class="ly ju hi lo b fi lz ma l mb mc">$ <!-- -->helm repo add pgb '<a class="ae iu" href="https://raw.githubusercontent.com/fopark/charts/master/'" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/fopark/charts/master/'</a><br/>$ helm repo update</span></pre><h2 id="ae7a" class="ly ju hi bd jv md me mf jz mg mh mi kd jg mj mk kh jk ml mm kl jo mn mo kp mp bi translated">图表配置</h2><p id="736b" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">接下来，您需要配置图表的值，以连接并验证数据库。在本地机器上创建一个新目录</p><p id="60bd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du ll lm ln lo b">mkdir helm_chart_values</code></p><p id="a060" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建一个名为<code class="du ll lm ln lo b">pgbouncer-values.yaml</code>的文件，并将其保存在上面的目录中，以启动您的图表配置，这样您可以在以后进行调整和重新部署。将以下内容粘贴并编辑到yaml文件中:</p><pre class="lq lr ls lt fd lu lo lv lw aw lx bi"><span id="a31a" class="ly ju hi lo b fi lz ma l mb mc"># The database credentials</span><span id="a3e4" class="ly ju hi lo b fi mq ma l mb mc">username: ""</span><span id="a0fc" class="ly ju hi lo b fi mq ma l mb mc">password: ""</span><span id="2e75" class="ly ju hi lo b fi mq ma l mb mc">host: x.x.x.x</span><span id="6bfd" class="ly ju hi lo b fi mq ma l mb mc"># The number of instances to run.</span><span id="3c6e" class="ly ju hi lo b fi mq ma l mb mc">replicasCount: 2</span><span id="f0cf" class="ly ju hi lo b fi mq ma l mb mc"># The maximum number of incoming client requests per instance.</span><span id="7b74" class="ly ju hi lo b fi mq ma l mb mc">maxClientConnections: 5000</span><span id="13b4" class="ly ju hi lo b fi mq ma l mb mc"># The maximum number of upstream requests per instance.</span><span id="ea7f" class="ly ju hi lo b fi mq ma l mb mc">poolSize: 20</span><span id="2943" class="ly ju hi lo b fi mq ma l mb mc"># Resources for the pods. For PgBouncer it's critical that these match to provide guaranteed QoS.</span><span id="8abb" class="ly ju hi lo b fi mq ma l mb mc"># The chart therefore doesn't allow setting requests and limits separately.</span><span id="1b7c" class="ly ju hi lo b fi mq ma l mb mc">cpu: 150m</span><span id="5019" class="ly ju hi lo b fi mq ma l mb mc">memory: 200Mi</span><span id="5d00" class="ly ju hi lo b fi mq ma l mb mc"># The custom node selector. Allows you to pick a specific Node Pools to deploy your workload onto. </span><span id="869c" class="ly ju hi lo b fi mq ma l mb mc"># By default this is off; see below.</span><span id="1d2a" class="ly ju hi lo b fi mq ma l mb mc">nodeSelector:</span><span id="41ae" class="ly ju hi lo b fi mq ma l mb mc">role: pgbouncer</span><span id="179d" class="ly ju hi lo b fi mq ma l mb mc"># Set this to LoadBalancer to make PgBouncer available outside the cluster or CluserIP for only local access.</span><span id="ee22" class="ly ju hi lo b fi mq ma l mb mc">serviceType: LoadBalancer</span><span id="64e7" class="ly ju hi lo b fi mq ma l mb mc"># If you want access to your cluster but only in your internal VPC network leave the below setting.  Otherwise just delete it.</span><span id="1dad" class="ly ju hi lo b fi mq ma l mb mc">loadBalancerType: "Internal"</span><span id="4fe6" class="ly ju hi lo b fi mq ma l mb mc"># If you use RazorSQL or another tool for DB inspection you might have to place this config into pgbouncer.ini with the below parameter. </span><span id="2cd1" class="ly ju hi lo b fi mq ma l mb mc">injectConfig: { ignore_startup_parameters: extra_float_digits }</span></pre><p id="daf1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">未来科技产业的伟大人物们树立了更多的价值观，我也树立了一些。要查看所有可用选项，请输入以下命令:</p><pre class="lq lr ls lt fd lu lo lv lw aw lx bi"><span id="5daf" class="ly ju hi lo b fi lz ma l mb mc">helm inspect values pgb/pgbouncer</span></pre><p id="b1e1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">保存文件并部署集群:</p><pre class="lq lr ls lt fd lu lo lv lw aw lx bi"><span id="28a9" class="ly ju hi lo b fi lz ma l mb mc">$ helm install --name my-pgbouncer --namespace my-pgbouncer-namespace pgb/pgbouncer -f /path/to/pgbouncer-values.yaml</span></pre><p id="f223" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">f标志将用pgbouncer-values.yaml文件中的值覆盖默认值</p><p id="2757" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">查看您在云控制台上的值是否已更新:</p><figure class="lq lr ls lt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/28769121ef9adead3d4027f8d636ac9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yGbbUCDrILf1bGI72ScxGA.png"/></div></div></figure><p id="d776" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您更新了pgbouncer-values.yaml并希望重新部署，请使用以下命令:</p><pre class="lq lr ls lt fd lu lo lv lw aw lx bi"><span id="1d83" class="ly ju hi lo b fi lz ma l mb mc">helm upgrade &lt;workload-name&gt; pgb/pgbouncer -f helm_chart_values/pgbouncer-values.yaml</span></pre><p id="4332" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你有它！您应该有一个运行w/ CloudSQL的pgbouncer集群！请继续关注我的下一篇文章，我将使用pgbouncer和Cloud SQL在Google App Engine灵活环境上部署Python Flask API。</p><blockquote class="ms mt mu"><p id="a9a9" class="iv iw lf ix b iy iz ja jb jc jd je jf mv jh ji jj mw jl jm jn mx jp jq jr js hb bi translated">我想指出的是，我只是主要从几个来源把这些放在一起，并没有声称自己是我上面讨论的大多数主题的内容创建者。我刚刚度过了一个非常漫长的夜晚，按照我想要的方式设置了它，我想我会像那些把我列出的文章放在下面的了不起的人一样做出贡献。请看看这些文章，因为它们对各自的主题进行了更详细的介绍！</p><p id="322f" class="iv iw lf ix b iy iz ja jb jc jd je jf mv jh ji jj mw jl jm jn mx jp jq jr js hb bi translated">来源:</p></blockquote><div class="my mz ez fb na nb"><a rel="noopener follow" target="_blank" href="/futuretech-industries/gracefully-scaling-to-10k-postgresql-connections-for-35-mo-part-three-3a780eed72cf"><div class="nc ab dw"><div class="nd ab ne cl cj nf"><h2 class="bd hj fi z dy ng ea eb nh ed ef hh bi translated">以每月35美元的价格轻松扩展到10k PostgreSQL连接，第三部分</h2><div class="ni l"><h3 class="bd b fi z dy ng ea eb nh ed ef dx translated">除了更明显的优势，它还提供了轻松的节点和流程扩展、健康检查、可配置…</h3></div><div class="nj l"><p class="bd b fp z dy ng ea eb nh ed ef dx translated">medium.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np io nb"/></div></div></a></div><div class="my mz ez fb na nb"><a href="https://rimusz.net/tillerless-helm/" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab dw"><div class="nd ab ne cl cj nf"><h2 class="bd hj fi z dy ng ea eb nh ed ef hh bi translated">无舵舵舵v2</h2><div class="ni l"><h3 class="bd b fi z dy ng ea eb nh ed ef dx translated">Helm真的成为了事实上的Kubernetes包经理。Helm是查找、共享和使用软件的最佳方式…</h3></div><div class="nj l"><p class="bd b fp z dy ng ea eb nh ed ef dx translated">rimusz.net</p></div></div></div></a></div></div></div>    
</body>
</html>