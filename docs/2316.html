<html>
<head>
<title>Running Eclipse HONO and Ditto on Google Cloud (4)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在谷歌云上运行Eclipse HONO和Ditto)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/running-eclipse-hono-and-ditto-on-google-cloud-4-308c61735d47?source=collection_archive---------5-----------------------#2022-08-20">https://medium.com/google-cloud/running-eclipse-hono-and-ditto-on-google-cloud-4-308c61735d47?source=collection_archive---------5-----------------------#2022-08-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e577" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是演示在Google Cloud上运行Eclipse HONO和Eclipse Ditto的博客系列的第4部分。</p><p id="cbdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这一集中，我将把Eclipse Ditto与Google Cloud函数连接起来，并创建一个通过MQTT协议发布遥测数据的设备模拟器。当一切都正确配置后，从设备模拟器发送的遥测数据将被转发到谷歌云功能。</p><h1 id="a61b" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">创建云函数</h1><p id="6579" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">为了简化测试，Cloud函数只是为了验证Google Cloud接收到Eclipse Ditto转发的遥测数据。稍后我们将增强它来模拟更真实的用例，但是现在它已经足够好来回应它接收到的任何东西。</p><p id="2908" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到谷歌云控制台，用下面的代码创建一个新的云函数。这个云函数什么也不做，只是记录来自Eclipse Ditto的请求。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="94e9" class="kp je hi kl b fi kq kr l ks kt">exports.process = (req, res) =&gt; {<br/>   console.log(`process invoked`);<br/>   console.log(`req.query=${JSON.stringify(req.query)}`);<br/>   let message = req.query.message || req.body.message || 'ok!';<br/>   console.log(`received message: ${message}`);<br/>   res.status(200).send(message);<br/>};</span></pre><p id="6019" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署云功能别忘了把入口点改成<code class="du ku kv kw kl b">process</code></p><p id="da33" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经准备好了代码，当设备向Eclipse HONO发布遥测数据时，它将通过我们在前一篇文章中配置的连接转发给Eclipse Ditto。然后，Eclipse Ditto Connectivity service将调用HTTP端点(云函数)并将遥测数据发送到云函数。</p><p id="4355" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于我们不希望云函数被其他任何人调用，通常我们应该配置云函数权限，以允许特定用户作为云函数调用方。</p><p id="d2e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Eclipse Ditto确实支持OAuth 2.0 client_credentials授权，但是在撰写本文时，Google Cloud目前还不支持这种授权。为了保护我们的云功能，我们必须实现自己的认证机制。但是现在，我们只想验证Eclipse Ditto和Google Cloud之间的联系，我们只是授予<code class="du ku kv kw kl b">allUsers</code>作为云函数Invoker以允许匿名调用。将您的云功能暴露给互联网是不安全的，但现在我们只想验证连接性，所以让我们暂时离开它，我们稍后将回到这一点。</p><h1 id="ceeb" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">为Eclipse和云功能创建连接</h1><p id="6c9a" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我们有一个云函数，它提供了一个接受遥测数据的HTTP端点，现在我们想在Eclipse和云函数之间创建一个连接，这样每当遥测数据流向Eclipse HONO时，它将被Eclipse Ditto拾取，然后转发给云函数。</p><p id="b10c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用相同的REST API创建另一个连接，其中</p><ul class=""><li id="2b88" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated"><your functions="" url="">是云功能的HTTP网址</your></li><li id="8436" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated"><your entry="" point="">是云函数路径</your></li></ul><p id="2f3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，如果您的云函数端点是<a class="ae ll" href="https://myfunctions.cloudfunctions.net/receiveTelemetry," rel="noopener ugc nofollow" target="_blank">https://myfunctions.cloudfunctions.net/receiveTelemetry,</a>，那么&lt;函数URL &gt;应该是<a class="ae ll" href="https://myfunctions.cloudfunctions.net/receiveTelemetry," rel="noopener ugc nofollow" target="_blank">https://myfunctions.cloudfunctions.net</a>，而&lt;入口点&gt;应该是<a class="ae ll" href="https://myfunctions.cloudfunctions.net/receiveTelemetry," rel="noopener ugc nofollow" target="_blank">/接收遥测</a></p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="43d8" class="kp je hi kl b fi kq kr l ks kt">curl -X POST -i -u devops:devopsPw1! -H 'Content-Type: application/json' -d '{<br/>"targetActorSelection": "/system/sharding/connection",<br/>"headers": {},<br/>"piggybackCommand": {<br/>"type": "connectivity.commands:createConnection",<br/>"connection": {<br/>"id": "gcp-connection-org-eclipse-ditto",<br/>"connectionType": "http-push",<br/>"connectionStatus": "open",<br/>"failoverEnabled": true,<br/>"specificConfig": {<br/>"parallelism": "2"<br/>},<br/>"uri": "https://&lt;YOUR FUNCTIONS URL&gt;:443",<br/>"sources": [],<br/>"targets": [<br/>{<br/>"address": "POST:/&lt;YOUR ENTRY POINT&gt;",<br/>"topics": ["_/_/things/twin/events", "_/_/things/live/messages",<br/>"_/_/things/live/events", "_/_/things/live/commands",<br/>"_/_/policies/announcements", "_/_/connections/announcements"],<br/>"authorizationContext": ["nginx:ditto"],<br/>"headerMapping": {<br/>"content-type": "application/json"<br/>}<br/>}<br/>]<br/>}<br/>}<br/>}' http://${DITTO_API_IP}:${DITTO_API_PORT_http}/devops/piggyback/connectivity?timeout=8s</span></pre><h1 id="3aae" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">验证连通性</h1><p id="352a" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">做一个HTTP post发布遥测，验证云功能调用是否正确。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="6220" class="kp je hi kl b fi kq kr l ks kt">curl -X POST -i -u ${DEVICE_ID}-auth@${TENANT_NAME}:my-password -H 'Content-Type: application/json' -d '{"temp": 11114.51, "hum":10}' http://${HTTP_ADAPTER_IP}:${HTTP_ADAPTER_PORT_http}/telemetry</span></pre><p id="1fc4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">等待几秒钟，您应该会在云日志中看到日志条目。</p><figure class="kg kh ki kj fd ln er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lm"><img src="../Images/405a925c4c86ae0e95e8e8f6af892862.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cuOi_uACOMozFCAtrj2bqA.png"/></div></div></figure><p id="644f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">至此，我们已经验证了从设备到Eclipse HONO和Eclipse Ditto以及Google Cloud的连接性。</p><p id="cdf8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ll" rel="noopener" href="/google-cloud/running-eclipse-hono-and-ditto-on-google-cloud-5-8c4ad80a8c6e">第五部分</a></p></div></div>    
</body>
</html>