<html>
<head>
<title>Save money by scheduling Cloud SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过计划云SQL节省资金</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/save-money-by-scheduling-cloud-sql-7981e1b65ea3?source=collection_archive---------1-----------------------#2021-01-15">https://medium.com/google-cloud/save-money-by-scheduling-cloud-sql-7981e1b65ea3?source=collection_archive---------1-----------------------#2021-01-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/79bf5d8c304c368b94b7b4e7eae21b79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gvt3YJ3INcGGqBmtyPQUnQ.png"/></div></div></figure><p id="640b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2020年是艰难的一年，公司更加关注他们的支出，因为公司的云每年都在变得越来越大，T2的云计费越来越受关注。<br/>对于所有的公司来说，<strong class="is hj">理想的模式是只为他们使用的东西付费</strong>；不会更多。<strong class="is hj">无服务器产品完全符合这一期望</strong>。</p><p id="7d14" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，有些<strong class="is hj">服务不能采用这种模式</strong>，尤其是技术原因。例如，关系数据库因其低延迟而受欢迎，这至少归功于两个因素</p><ul class=""><li id="c4bb" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><strong class="is hj">实例总是运行</strong>以避免冷启动</li><li id="3b5a" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj">索引保存在内存中</strong>，并定期重建以确保最佳性能</li></ul><p id="8d5c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些技术限制阻止了按使用付费的模式。当然，像这样的<strong class="is hj">托管解决方案已经节省了资金</strong>并避免了限制，例如让技术熟练的团队来部署、优化、执行备份、设置副本……而且是全天候的！</p><p id="94e8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对这些公司来说，问题不在于是否真的要付钱，而是不花钱。由于<strong class="is hj">每个项目有多个环境</strong>(至少是开发、试运行和生产)，在所有环境中拥有一个<strong class="is hj">生产就绪数据库是没有用的</strong>。只有生产需要这样做，其他<strong class="is hj">环境中的数据库可以在晚上和周末关闭以节省资金</strong>。</p><p id="cd4c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有了<a class="ae kc" href="https://cloud.google.com/sql" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">云SQL </strong> </a> <strong class="is hj"> </strong>和<a class="ae kc" href="https://cloud.google.com/scheduler/docs/quickstart" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">云调度器</strong> </a>，部署起来还是挺轻松的。我们开始吧！</p><h1 id="1022" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">云SQL API</h1><p id="6fa8" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">云SQL服务有<a class="ae kc" href="https://cloud.google.com/sql/docs/mysql/admin-api" rel="noopener ugc nofollow" target="_blank">管理API</a>与之交互。在我们的例子<strong class="is hj">中，我们想要更新现有的实例</strong>并启动或关闭它。为此</p><ul class=""><li id="ce69" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">我们将使用API的<a class="ae kc" href="https://cloud.google.com/sql/docs/mysql/admin-api/rest/v1beta4/instances/patch" rel="noopener ugc nofollow" target="_blank">实例补丁端点</a></li><li id="5e88" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">我们将更新<a class="ae kc" href="https://cloud.google.com/sql/docs/mysql/admin-api/rest/v1beta4/instances#SqlActivationPolicy" rel="noopener ugc nofollow" target="_blank">设置</a> <code class="du lg lh li lj b"><a class="ae kc" href="https://cloud.google.com/sql/docs/mysql/admin-api/rest/v1beta4/instances#SqlActivationPolicy" rel="noopener ugc nofollow" target="_blank">activationPolicy</a></code>，并将其设置为<code class="du lg lh li lj b">NEVER</code>以停止数据库，设置为<code class="du lg lh li lj b">ALWAYS</code>以启动数据库。</li></ul><p id="b040" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一个非常简短的JSON主体描述了这些设置</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="f7bc" class="ls ke hi lj b fi lt lu l lv lw">{<br/>  "settings": {<br/>    "activationPolicy": "NEVER"<br/>  }<br/>}</span></pre><p id="3985" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了调用<strong class="is hj">补丁API url，我们需要</strong> <code class="du lg lh li lj b"><strong class="is hj">projectID</strong></code> <strong class="is hj">和</strong> <code class="du lg lh li lj b"><strong class="is hj">instanceName</strong></code>。然后我们可以把它们放在一起，用CURL试一试</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="485a" class="ls ke hi lj b fi lt lu l lv lw">curl -X PATCH -d '{"settings":{"activationPolicy": "NEVER"}}' \<br/>  -H "content-type: application/json" \<br/>  -H "Authorization: Bearer $(gcloud auth print-access-token)" \<br/>https://sqladmin.googleapis.com/sql/v1beta4/projects/&lt;PROJECT_ID&gt;/instances/&lt;INSTANCE_NAME&gt;</span></pre><h1 id="ccb1" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">云调度程序配置</h1><p id="a97f" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated"><strong class="is hj">云调度器是一个无服务器产品</strong>，允许<strong class="is hj">调度API调用</strong>。调度模式基于Linux CRON表达式。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div class="er es lx"><img src="../Images/cd94c9c0d899acafe60067d827d75129.png" data-original-src="https://miro.medium.com/v2/resize:fit:568/format:webp/0*Ta5c5EHuOoTsvE4O.png"/></div></figure><p id="b2bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了自动启动和停止云SQL数据库，我们需要两个时间表:</p><ul class=""><li id="7fec" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><strong class="is hj">每天晚上8点关闭数据库</strong>。我们可以认为在晚上8点以后，所有的开发人员都结束了工作。如果一个人选择在星期六工作，他将手动启动云SQL实例。调度程序在这里是为了防止在周末出现未停止的实例。 <br/>这里的CRON表达式将是<code class="du lg lh li lj b">0 20 * * *</code></li><li id="d75b" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">仅在周一至周五早上8点启动。为了更好的体验和更高的效率，我们可能希望在开发人员开始工作时有一个启动的数据库。<br/>这里的CRON表达式将<code class="du lg lh li lj b">0 8 * * 1-5</code> <br/> <em class="ly">表示为</em> <code class="du lg lh li lj b"><em class="ly">1–5</em></code> <em class="ly">，是星期几。0是星期日，</em> <code class="du lg lh li lj b"><em class="ly">-</em></code> <em class="ly">是设置一个间隔。</em></li></ul><h2 id="41e7" class="ls ke hi bd kf lz ma mb kj mc md me kn jb mf mg kr jf mh mi kv jj mj mk kz ml bi translated">云调度程序授权</h2><p id="782c" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">正如我们在CURL命令中看到的，<strong class="is hj">API调用需要被认证</strong>。云调度程序也是如此。<br/>要实现这一点，我们必须<strong class="is hj">使用一个服务帐户</strong>——一个现有的帐户，或者我们可以创建一个新的帐户——<strong class="is hj">，至少拥有</strong> <code class="du lg lh li lj b"><strong class="is hj">roles/cloudsql.editor</strong></code> <strong class="is hj">授予的角色</strong>。<em class="ly">该角色拥有更新云SQL实例的权限。</em></p><p id="4dd3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在设置云调度程序认证的过程中，我们必须<strong class="is hj">在两种类型的令牌</strong>之间进行选择</p><ul class=""><li id="2377" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><strong class="is hj"> OAuth: </strong>旨在<strong class="is hj">提供权限</strong>范围，完美调用Google Cloud API</li><li id="117c" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj"> OIDC: </strong>旨在<strong class="is hj">提供请求者的身份</strong>，这是安全云运行、云功能和应用引擎所必需的。</li></ul><p id="5a05" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="ly">在我们的例子中，</em> <strong class="is hj"> <em class="ly">我们将使用OAuth令牌。</em>T15】</strong></p><h1 id="df47" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">设置最终配置</h1><p id="241a" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">最后，我们可以创建包含所有部分的云调度程序作业</p><ul class=""><li id="948b" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><strong class="is hj">API URL</strong>，带有路径参数和<code class="du lg lh li lj b">PATCH</code> HTTP动词</li><li id="02d0" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj">正文内容</strong></li><li id="07f0" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">调度程序<strong class="is hj"> CRON表情</strong></li><li id="f4bb" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj">安全定义</strong></li></ul><p id="7fb2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们用控制台来做这件事(来启动实例)</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/0d055c9b0e029fe59a762490ea8ee040.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JNBw6aSjBuJAA4dYfCKicA.png"/></div></div></figure><p id="81db" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者使用命令行执行此操作(停止实例)</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="e4a5" class="ls ke hi lj b fi lt lu l lv lw">gcloud beta scheduler jobs create http stop-instance \<br/>  --<a class="ae kc" href="mailto:oauth-service-account-email=cloudsql-scheduler@gdglyon-cloudrun.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">oauth-service-account-email=&lt;</a>SERVICE_ACCOUNT_EMAIL&gt; \<br/>  --message-body='{"settings":{"activationPolicy": "NEVER"}}' \<br/>  --schedule="0 20 * * *" --time-zone=Europe/Paris \<br/>  --http-method=PATCH \<br/>  --uri=https://sqladmin.googleapis.com/sql/v1beta4/projects/&lt;PROJECT_ID&gt;/instances/&lt;INSTANCE_NAME&gt;</span></pre></div><div class="ab cl mn mo gp mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="hb hc hd he hf"><p id="bb89" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了测试，我们可以通过点击<code class="du lg lh li lj b">Run now</code>按钮<strong class="is hj">手动启动云调度程序作业</strong>。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/b92496704d57646fb317c60d252072ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T3SJdAWTf0F2cveiKi8RHA.png"/></div></div></figure><p id="1080" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这也是一个很好的解决方案，允许任何开发者在他们想的时候启动和停止实例。</p><h1 id="a7e1" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">智能托管服务可节省资金，等等！</h1><p id="2479" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">现在，我们有了。我们能够启动和停止实例，以最小化它们无用的运行时间。像这样，我们能够省钱，但不仅仅是。<br/>如果我们节约资源，我们就能防止能源浪费，并与其他Google Cloud客户共享未使用的CPU/内存。因此，消耗的物理“碳”资源更少，对地球更好！</p><p id="5891" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过明智地考虑托管服务的使用，<strong class="is hj">我们为所有人实现了更好的目标</strong>！</p></div></div>    
</body>
</html>