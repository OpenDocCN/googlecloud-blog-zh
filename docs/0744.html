<html>
<head>
<title>Cloud Build, Golang &amp; App Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云构建、Golang和应用引擎</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-build-golang-app-engine-36e27ba976cd?source=collection_archive---------1-----------------------#2018-08-31">https://medium.com/google-cloud/cloud-build-golang-app-engine-36e27ba976cd?source=collection_archive---------1-----------------------#2018-08-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d4fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Stackoverflow上的一名开发人员寻求一种使用云构建部署App Engine应用的方法。这是个有趣的问题。需要注意的是，App Engine标准部署包括一个构建步骤。让我们探索一下…</p><h2 id="aa1b" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">设置</h2><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="6d2a" class="jd je hi kd b fi kh ki l kj kk">PROJECT=[[YOUR-PROJECT]]<br/>BILLING=[[YOUR-BILLING]]<br/>REGION=[[YOUR-REGION]]<br/>BUCKET=[[YOUR-BUCKET]]</span><span id="e758" class="jd je hi kd b fi kl ki l kj kk">gcloud projects create ${PROJECT}</span><span id="e2dc" class="jd je hi kd b fi kl ki l kj kk">gcloud beta billing projects link ${PROJECT} \<br/>--billing-account=${BILLING}</span><span id="5cff" class="jd je hi kd b fi kl ki l kj kk"># Enable App Engine (Admin) and Cloud Build services<br/>for SERVICE in appengine cloudbuild<br/>do<br/>  gcloud services enable ${SERVICE}.googleapis.com \<br/>  --project=${PROJECT}<br/>done</span><span id="04be" class="jd je hi kd b fi kl ki l kj kk"># Create App Engine (Standard) <br/>gcloud app create \<br/>--region=${REGION} \<br/>--project=${PROJECT}</span><span id="586c" class="jd je hi kd b fi kl ki l kj kk"># Create a GCS Bucket for Artifacts<br/>gsutil mb \<br/>-c regional \<br/>-l ${REGION} \<br/>-p ${PROJECT} \<br/>gs://${BUCKET}</span></pre><h2 id="06b1" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">戈朗</h2><p id="eeb3" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">我发现Golang builder的工作空间选项令人困惑。因此，假设我的本地目录结构看起来总是这样:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="24eb" class="jd je hi kd b fi kh ki l kj kk">echo ${GOPATH}<strong class="kd hj">/..</strong></span><span id="0f36" class="jd je hi kd b fi kl ki l kj kk">├── cloudbuild.yaml<br/>└── go<br/>    ├── bin<br/>    ├── pkg<br/>    └── src<br/>        └── github.com<br/>            └── DazWilkin<br/>                └── hellohenry<br/>                    ├── app.yaml<br/>                    └── hellohenry.go</span></pre><blockquote class="kr ks kt"><p id="199c" class="if ig ku ih b ii ij ik il im in io ip kv ir is it kw iv iw ix kx iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>将<code class="du ky kz la kd b">cloudbuild.yaml</code>文件包含在这个工作目录的根目录下。</p></blockquote><p id="0607" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我要让建筑商模仿这个结构。</p><p id="0f13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用了类似于Google的示例<code class="du ky kz la kd b">helloworld</code>应用程序的东西。在我的例子中，Golang源代码和<code class="du ky kz la kd b">app.yaml</code>都在<code class="du ky kz la kd b">go/src</code>的子目录<code class="du ky kz la kd b">${APP}</code>中。(== <code class="du ky kz la kd b">github.com/DazWilkin/hellohenry</code>)。当我们回顾<code class="du ky kz la kd b">cloudbuild.yaml</code>时，这一点会变得更加清楚:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="eb76" class="jd je hi kd b fi kh ki l kj kk">tree ${GOPATH}/src/${APP}</span><span id="f8b7" class="jd je hi kd b fi kl ki l kj kk">├── app.yaml<br/>└── hellohenry.go</span></pre><h2 id="eec5" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">云构建</h2><p id="3e9d" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">最终，云构建将需要部署应用引擎应用的许可。让我们获取云构建服务帐户并授予它<code class="du ky kz la kd b">appengine.deployer</code>和<code class="du ky kz la kd b">appengine.serviceAdmin</code>:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="8f3f" class="jd je hi kd b fi kh ki l kj kk">NUM=$(gcloud projects describe $PROJECT \<br/>--format="value(projectNumber)") &amp;&amp; echo ${NUM}</span><span id="e18e" class="jd je hi kd b fi kl ki l kj kk">FOR role in appengine.deployer appengine.serviceAdmin<br/>do<br/>  gcloud projects add-iam-policy-binding ${PROJECT} \<br/>  --member=serviceAccount:${NUM}<a class="ae lb" href="http://twitter.com/cloudbuild" rel="noopener ugc nofollow" target="_blank">@cloudbuild</a>.gserviceaccount.com \<br/>  --role=roles/${ROLE}<br/>done</span></pre><p id="0441" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们可以定义<code class="du ky kz la kd b">cloudbuild.yaml</code>:</p><figure class="jy jz ka kb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><blockquote class="kr ks kt"><p id="9dd4" class="if ig ku ih b ii ij ik il im in io ip kv ir is it kw iv iw ix kx iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>为了清楚起见，我特意在这个cloudbuild.yaml中包含了<code class="du ky kz la kd b">SUBSTITUTIONS</code>以及我的配置的值。您需要删除它们，然后将它们包含在<code class="du ky kz la kd b">gcloud build</code>命令中，并用您自己的值替换它们。</p></blockquote><p id="f895" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是为什么我发现在云构建容器上复制文件结构更容易。从工作目录运行，<code class="du ky kz la kd b">go</code>目录被复制到容器的<code class="du ky kz la kd b">/workspace</code>目录。然后，我们可以通过配置构建器使用<code class="du ky kz la kd b">GOPATH=go</code> (== <code class="du ky kz la kd b">/workspace/go</code>)来镜像我们的本地配置，这避免了包导入等问题。</p><p id="2a41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行完<code class="du ky kz la kd b">go get</code>步骤后，我们运行<code class="du ky kz la kd b">gcloud app deploy</code>。你可能想知道为什么我们错过了<code class="du ky kz la kd b">go build</code>。这是不需要的，因为<code class="du ky kz la kd b">gcloud app deploy</code>在部署之前为我们获取工件并构建解决方案。您可以添加一个<code class="du ky kz la kd b">go build</code>步骤，但这是多余的，并且部署到App Engine的二进制文件不会相同。</p><p id="899e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要运行构建，从您的工作目录:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="004d" class="jd je hi kd b fi kh ki l kj kk">gcloud builds submit . \<br/>--config=cloudbuild.yaml \<br/>--project=${PROJECT} \<br/>--substitutions=_APP=${APP},_BUCKET=${BUCKET}</span></pre><blockquote class="kr ks kt"><p id="5df6" class="if ig ku ih b ii ij ik il im in io ip kv ir is it kw iv iw ix kx iz ja jb jc hb bi translated">如果你在cloudbuild.yaml中定义了替换，你不需要在这里重复它们。非此即彼。</p></blockquote><figure class="jy jz ka kb fd lc er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lf"><img src="../Images/f8cfe7b393029f2171fbb19cce02fb17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1cEvdElVNWgiAvwqMTcscg.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">云构建:构建历史</figcaption></figure><p id="74f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后:</p><figure class="jy jz ka kb fd lc er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lq"><img src="../Images/5c69dd5e077666dcc46cb72391cb0845.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qIvrwl4KFORahpQVxXpGxw.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">应用引擎控制台</figcaption></figure><p id="f6fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并且:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="93b6" class="jd je hi kd b fi kh ki l kj kk">curl https://${PROJECT}.appspot.com/</span><span id="4167" class="jd je hi kd b fi kl ki l kj kk">Hello Henry!</span></pre><p id="6a9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并检查工件:</p><figure class="jy jz ka kb fd lc er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lr"><img src="../Images/7617fffd07f2ce638297a02c8531c765.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WeOH6c4ANwPud9e4kQa_9A.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">谷歌云存储:[桶]浏览器</figcaption></figure><h2 id="233f" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">结论</h2><p id="bf24" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">帮助描述如何使用云构建到Google App Engine来构建和部署Golang应用程序的快速链接。</p><p id="8f3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仅此而已！</p></div></div>    
</body>
</html>