<html>
<head>
<title>Apigee X Network Connectivity using Private Service Connect (PSC)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用专用服务连接(PSC)的Apigee X网络连接</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/apigee-x-network-connectivity-using-private-service-connect-psc-ac7eaa645900?source=collection_archive---------0-----------------------#2022-11-24">https://medium.com/google-cloud/apigee-x-network-connectivity-using-private-service-connect-psc-ac7eaa645900?source=collection_archive---------0-----------------------#2022-11-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="7887" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">概观</h1><p id="9f85" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><a class="ae kb" href="https://cloud.google.com/apigee" rel="noopener ugc nofollow" target="_blank"> Apigee </a>是Google Cloud的差异化API管理解决方案。有了Apigee，开发人员可以更专注于产品/应用功能开发，而不是担心如何实现安全、流量管理等常见流程。，可以委托给Apigee API管理层，并在API gee API管理层进行配置。<em class="kc">客户端和API端点之间的API流量称为北向流量，API端点和目标后端之间的API流量称为南向流量。</em> Apigee有两种风格，Apigee X(谷歌管理的解决方案)和Apigee Hybrid(客户管理Apigee运行时平面，谷歌管理Apigee控制平面)。</p><p id="384e" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">私有服务连接(PSC)是Google Cloud的安全的面向服务的网络结构，允许访问Google APIs和服务，以及其他VPC网络中的托管服务。用户甚至可以使用IP地址，通过属于不同组、团队、项目或组织的VPC网络，对服务进行私人消费。更多信息请参考<a class="ae kb" href="https://cloud.google.com/vpc/docs/private-service-connect#benefits-services" rel="noopener ugc nofollow" target="_blank">官方文档</a>。</p><p id="b6d8" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">本文讨论了一些使用私有服务连接的常见Apigee X网络模式。</p><h1 id="8193" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">背景</h1><p id="9b16" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">当创建Apigee X实例时，Apigee实例的入口通过与L4内部负载平衡器(ILB)相关联的私有IP地址公开。对于多区域设置，Apigee X实例可以部署在所需的区域中；<strong class="jf hj">注意:</strong>一个区域最多只能包含一个Apigee X实例。在PSC启动之前，需要一个全局外部负载平衡器(GXLB)以及区域托管实例组(具有iptables定义)将外部流量转发到相应的区域Apigee L4 ILBs。</p><p id="5720" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">让我们考虑一种情况，其中GXLB + MIG被用于北向连接。Apigee X使用<a class="ae kb" href="https://cloud.google.com/service-infrastructure/docs/service-networking/getting-started" rel="noopener ugc nofollow" target="_blank">服务网络</a>在服务网络主机项目和客户VPC之间创建对等关系，其中GXLB和MIG同时存在。由于这种对等关系，Apigee X只能到达一跳之外的目标后端，即托管在对等的VPC中；VPC对等是不可传递的。这带来了挑战，因为并非所有的目标后端都驻留在对等的VPC中。查看图1，它应该是不可传递的VPC对等设置。尽管可以创建额外的对等点、负载平衡器和托管实例组来实现跨VPC链的私有连接，但这需要复杂的配置和大量的维护工作。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ki"><img src="../Images/041c21e313ce79ab17aa25a0fe610ba8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2D1utCOH2plz-XQYsF0i0A.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated"><em class="ky">图1:非传递性VPC对等</em></figcaption></figure><p id="365b" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">PSC通过提供Apigee X和托管在不同VPC(甚至可能属于不同的GCP项目或GCP组织)中的客户端/后端之间的简单连接来帮助解决这些问题。在进入网络模式之前，让我们先了解一些PSC概念。</p><h2 id="af03" class="kz ig hi bd ih la lb lc il ld le lf ip jo lg lh it js li lj ix jw lk ll jb lm bi translated">生产者和消费者网络</h2><p id="b981" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">生产者网络(VPC)定义服务并将其公开以供消费，而消费者网络(与生产者网络VPC不同的VPC)消费由生产者网络公开的服务。图2显示了消费者和生产者网络的互动。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ln"><img src="../Images/7731401e3e1ae7c9ff95b6e93b0eb8e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sdwa1uBQVWXpPoSd_0a39A.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated"><em class="ky">图2:生产者&amp;消费者模型</em></figcaption></figure><h2 id="0131" class="kz ig hi bd ih la lb lc il ld le lf ip jo lg lh it js li lj ix jw lk ll jb lm bi translated">端点和服务附件</h2><p id="810b" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">生产者网络使用名为<strong class="jf hj"> PSC服务附件(SA) </strong>的结构通过唯一的URI公开其服务(每个服务一个服务附件)；SA引用服务的负载平衡器转发规则。每个负载平衡器只能由一个SA引用；不能配置使用同一负载平衡器的多个sa。在Apigee X的情况下，用于连接Apigee实例的服务附件URI在Apigee实例创建过程中自动创建。</p><p id="72e6" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">PSC支持服务消费者使用一个名为<strong class="jf hj"> PSC端点连接(EA) </strong>的结构连接到服务生产者。消费者需要创建一个带有IP地址的转发规则，用于将所有流量定向到生产者服务。转发规则的目标是生产者公开的SA。在Apigee的情况下，需要为每个服务附件显式地创建一个端点附件；在EA和s a之间存在一对一的映射。图3展示了消费者如何利用EA通过SA到达生产者中的特定目标服务。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lo"><img src="../Images/092f0ddc8c9e37cb6d3af0461debe052.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VXve4_dKX3T9_3783-lZIA.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated"><em class="ky">图3:专用服务连接</em></figcaption></figure><h2 id="87dc" class="kz ig hi bd ih la lb lc il ld le lf ip jo lg lh it js li lj ix jw lk ll jb lm bi translated">PSC网络端点组(NEG)</h2><p id="6532" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">一个<strong class="jf hj"> PSC网络端点组(NEG) </strong>指定一组跨网络和项目运行的服务作为Google负载平衡器的后端。它是一个端点，可以解析为Google管理的区域API端点之一，或者解析为使用PSC发布的托管服务。</p><p id="d858" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">在Apigee X北向网络的上下文中，Apigee X运行时所在的网络充当生产者，向外部客户端公开API的GXLB所在的网络或内部客户端所在的网络充当消费者网络。而在Apigee X南行联网的上下文中，Apigee X运行时所在的网络充当消费者，目标应用程序所在的网络充当生产者网络。</p><h1 id="f3f5" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">使用案例</h1><p id="9f96" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jf hj">下面列出了一些可以利用PSC的常见北向网络使用案例。</strong></p><ul class=""><li id="3b0c" class="lp lq hi jf b jg kd jk ke jo lr js ls jw lt ka lu lv lw lx bi translated">通过不同GCP项目/组织中的全球或区域负载平衡器向GCP以外的外部客户公开API。</li><li id="13b6" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated">向多个GCP项目/组织中的内部客户端应用程序公开API(托管在与Apigee X对等的不同VPC网络中)。</li><li id="cc65" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated">替代托管实例组(MIG ),将流量从全局负载平衡器代理到Apigee X。</li><li id="e4a6" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated">不允许VPC对等的合规性要求。</li></ul><p id="48bd" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated"><strong class="jf hj">下面列出了一些可以利用PSC的常见南向网络使用案例。</strong></p><ul class=""><li id="5897" class="lp lq hi jf b jg kd jk ke jo lr js ls jw lt ka lu lv lw lx bi translated">在相同或不同的GCP项目/组织的不同VPC上的目标应用。</li><li id="14c3" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated">将Apigee X私有地连接到在VPC网络上运行的目标服务。</li><li id="86c0" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated">避免设置复杂的基础架构，使用虚拟机等自我管理的组件来访问目标应用程序。</li></ul><h1 id="574d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">网络架构示例</h1><p id="44ea" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">图4显示了Apigee X的端到端网络架构，使用PSC用于北向和南向流。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es md"><img src="../Images/64f5e4be9abf284ea7b17482468f36d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Xq5Eu4wGUXvQeFEP2SWiA.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated"><em class="ky">图4:顶点X带PSC的北行和南行</em></figcaption></figure><h1 id="d6cf" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">启动并运行PSC for Apigee X:端到端样品自动化</h1><p id="b88c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jf hj">下面列出了使用PSC北行和GXLB所需的高级步骤。</strong></p><ol class=""><li id="5e68" class="lp lq hi jf b jg kd jk ke jo lr js ls jw lt ka me lv lw lx bi translated">创建Apigee X实例。服务附件作为Apigee实例创建的一部分被创建，在同一区域，在Apigee托管的Google管理的空间中。</li><li id="b570" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka me lv lw lx bi translated">创建一个全局外部负载平衡器(GXLB)。</li><li id="5d2c" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka me lv lw lx bi translated">创建用于连接到服务附件的PSC网络端点组(NEG)。如果存在多区域设置，则每个区域都需要PSC NEG，并将指向相应的区域服务附件。</li><li id="3619" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka me lv lw lx bi translated">将PSC NEG作为后端连接到GXLB。</li><li id="7f5a" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka me lv lw lx bi translated">Apigee API代理可以通过GXLB访问。</li></ol><p id="cfdd" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated"><strong class="jf hj">使用PSC南行连接到不同VPC中托管的目标后端所需的高级步骤如下所述。</strong></p><ol class=""><li id="4d0f" class="lp lq hi jf b jg kd jk ke jo lr js ls jw lt ka me lv lw lx bi translated">在部署目标服务的VPC网络中创建PSC服务附件(需要创建NAT子网)。</li><li id="a81a" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka me lv lw lx bi translated">为每个PSC服务附件在VPC的Apigee X创建一个PSC端点附件；请注意，EA和SA是区域性资源。</li><li id="dccc" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka me lv lw lx bi translated">Apigee X现在可以通过端点连接访问目标服务；API代理需要定义带有端点附件的HTTP目标连接。</li></ol><p id="bd6f" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">在<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/samples" rel="noopener ugc nofollow" target="_blank"> Apigee DevRel GitHub存储库</a>中可以找到有用的参考脚本，以便开始使用Terraform。</p><p id="1d12" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated"><strong class="jf hj"> <em class="kc">注意:</em> </strong> <em class="kc">这些脚本提供了一个很好的参考点，但是需要根据用例</em>进行修改。</p><p id="d05f" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">让我们从上述存储库中理解<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/samples/x-nb-psc-xlb" rel="noopener ugc nofollow" target="_blank">北向</a>和<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/samples/x-sb-psc" rel="noopener ugc nofollow" target="_blank">南向</a>示例脚本。</p><p id="5091" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">1.我们将需要至少两个GCP项目来尝试这种模式。<a class="ae kb" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric/tree/master/modules/project" rel="noopener ugc nofollow" target="_blank">项目</a>模块可用于根据我们的要求创建GCP项目。通过将<em class="kc"> project_create </em>参数设置为<em class="kc"> false </em>，也可以使用现有的GCP项目。对于付费版本，Apigee订阅权限需要与GCP项目(客户GCP项目— 1，如图4所示)相关联。</p><pre class="kj kk kl km fd mf mg mh bn mi mj bi"><span id="8c4e" class="mk ig hi mg b be ml mm l mn mo">module "project" {<br/> source          = "github.com/terraform-google-modules/cloud-foundation-fabric//modules/project?ref=v16.0.0"<br/> name            = &lt;Project ID&gt;<br/> parent          = &lt;Parent Folder/Organization ID&gt;<br/> billing_account = &lt;Billing Account ID&gt;<br/> project_create  = &lt;true/false&gt;<br/> services = [<br/>   "apigee.googleapis.com",<br/>   "cloudkms.googleapis.com",<br/>   "compute.googleapis.com",<br/>   "servicenetworking.googleapis.com"<br/> ]<br/>}</span></pre><p id="0935" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">2.<a class="ae kb" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric/tree/master/modules/net-vpc" rel="noopener ugc nofollow" target="_blank"> vpc </a>模块将创建一个vpc，并根据输入添加必要的顶点范围。也可以通过在源模块中将附加参数<em class="kc"> vpc_create </em>设置为<em class="kc"> false </em>来使用现有的VPC。</p><pre class="kj kk kl km fd mf mg mh bn mi mj bi"><span id="a8e6" class="mk ig hi mg b be ml mm l mn mo">module "vpc" {<br/> source     = "github.com/terraform-google-modules/cloud-foundation-fabric//modules/net-vpc?ref=v16.0.0"<br/> project_id = &lt;Project ID&gt;<br/> name       = &lt;VPC Network Name&gt;<br/> psa_config = {<br/>   ranges = {<br/>     apigee-range         = &lt;Peering Range&gt;<br/>     apigee-support-range = &lt;Support Range&gt;<br/>   }<br/>   routes = null<br/> }<br/>}</span></pre><p id="9835" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">3.如果设置是出于测试目的，那么<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/samples/x-nb-psc-xlb" rel="noopener ugc nofollow" target="_blank">北向</a>脚本下的<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/modules/nip-development-hostname" rel="noopener ugc nofollow" target="_blank">nip-development-hostname</a>模块可用于生成<em class="kc"> nip.io </em>下的Google托管证书和主机名。如果要使用一些自定义域，可以创建以下Terraform资源。</p><pre class="kj kk kl km fd mf mg mh bn mi mj bi"><span id="22e2" class="mk ig hi mg b be ml mm l mn mo">resource "google_compute_global_address" "external_address" {<br/> name         = &lt;External Address Name&gt;<br/> project      = &lt;Project ID&gt;<br/> address_type = "EXTERNAL"<br/>}<br/> <br/>resource "google_compute_managed_ssl_certificate" "google_cert" {<br/> project = &lt;Project ID&gt;<br/> name    = &lt;Certificate Name&gt;<br/> managed {<br/>   domains = &lt;List of domains&gt;<br/> }<br/>}</span></pre><p id="2071" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">4.<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/samples/x-nb-psc-xlb" rel="noopener ugc nofollow" target="_blank">北向</a>脚本下的<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/modules/apigee-x-core" rel="noopener ugc nofollow" target="_blank"> apigee-x-core </a>模块可用于创建apigee组织、Apigee实例、Apigee环境、Apigee环境组、密匙环、服务账户以及所有需要的Apigee附件。</p><pre class="kj kk kl km fd mf mg mh bn mi mj bi"><span id="b717" class="mk ig hi mg b be ml mm l mn mo">module "apigee-x-core" {<br/> source              = "../../modules/apigee-x-core"<br/> project_id          = &lt;Project ID&gt;<br/> ax_region           = &lt;Analytics Region&gt;<br/> apigee_instances    = &lt;Map of Apigee Instances&gt;<br/> apigee_environments = &lt;List of Environments&gt;<br/> apigee_envgroups    = &lt;Map of Environment Groups with Environments &amp; Hostnames&gt;<br/> network = &lt;VPC Network ID&gt;<br/>}</span></pre><p id="9d14" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">5.<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/samples/x-nb-psc-xlb" rel="noopener ugc nofollow" target="_blank">北向</a>脚本下的模块<em class="kc"> psc-ingress-vpc </em>可用于创建将托管全局负载平衡器和PSC NEG的vpc。</p><pre class="kj kk kl km fd mf mg mh bn mi mj bi"><span id="d08c" class="mk ig hi mg b be ml mm l mn mo">module "psc-ingress-vpc" {<br/> source                  = "github.com/terraform-google-modules/cloud-foundation-fabric//modules/net-vpc?ref=v16.0.0"<br/> project_id              = &lt;Project ID&gt;<br/> name                    = &lt;PSC Ingress VPC Name&gt;<br/> auto_create_subnetworks = false<br/> subnets                 = &lt;List of subnets for exposing Apigee via PSC&gt;<br/>}</span></pre><p id="e842" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">6.下一步是使用来自<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/samples/x-nb-psc-xlb" rel="noopener ugc nofollow" target="_blank">北向</a>脚本的<em class="kc">Google _ compute _ region _ network _ endpoint _ group</em>资源创建PSC NEG。</p><pre class="kj kk kl km fd mf mg mh bn mi mj bi"><span id="15a6" class="mk ig hi mg b be ml mm l mn mo">resource "google_compute_region_network_endpoint_group" "psc_neg" {<br/> project               = &lt;Project ID&gt;<br/> for_each              = &lt;Map of Apigee Instances&gt;<br/> name                  = "psc-neg-${each.value.region}"<br/> region                = each.value.region<br/> network               = &lt;PSC Ingress VPC ID&gt;<br/> subnetwork            = &lt;Subnet URL to which all network endpoints belong&gt;<br/> network_endpoint_type = "PRIVATE_SERVICE_CONNECT"<br/> psc_target_service    = &lt;Target Service URL of PSC producer Service Attachment&gt;<br/> lifecycle {<br/>   create_before_destroy = true<br/> }<br/>}</span></pre><p id="a6e7" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">7.使用来自<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/samples/x-nb-psc-xlb" rel="noopener ugc nofollow" target="_blank">北向</a>脚本的<em class="kc"> nb-psc-l7xlb </em>模块创建L7全局外部负载平衡器。</p><pre class="kj kk kl km fd mf mg mh bn mi mj bi"><span id="e808" class="mk ig hi mg b be ml mm l mn mo">module "nb-psc-l7xlb" {<br/> source                  = "../../modules/nb-psc-l7xlb"<br/> project_id              = &lt;Project ID&gt;<br/> name                    = &lt;PSC XLB Name&gt;<br/> network                 = &lt;PSC Ingress VPC ID&gt;<br/> psc_service_attachments = &lt;Map of region to service attachment ID&gt;<br/> ssl_certificate         = &lt;SSL certificate ID created in previous steps&gt;<br/> external_ip             = &lt;External Address created in previous steps&gt;<br/> psc_negs                = &lt;List of PSC NEG IDs to be used as backends&gt;<br/>}</span></pre><p id="2864" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">8.下一步是使用来自<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/samples/x-sb-psc" rel="noopener ugc nofollow" target="_blank">南行</a>脚本的<em class="kc"> backend-vpc </em>模块为目标后端应用程序创建VPC。也可以通过在源模块中将附加参数<em class="kc"> vpc_create </em>设置为<em class="kc"> false </em>来使用现有的VPC。</p><pre class="kj kk kl km fd mf mg mh bn mi mj bi"><span id="423b" class="mk ig hi mg b be ml mm l mn mo">module "backend-vpc" {<br/>   source     = "github.com/terraform-google-modules/cloud-foundation-fabric//modules/net-vpc?ref=v16.0.0"<br/>   project_id = &lt;Project ID&gt;<br/>   name       = &lt;Target Application VPC Name&gt;<br/>   subnets = &lt;List of subnets for Target Applications&gt;<br/> }</span></pre><p id="2966" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">9.使用<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/samples/x-sb-psc" rel="noopener ugc nofollow" target="_blank">南行</a>脚本中的<em class="kc">后端示例</em>模块创建一个示例目标后端应用程序。如果已经存在应用程序，则可以忽略此步骤。</p><pre class="kj kk kl km fd mf mg mh bn mi mj bi"><span id="9ef6" class="mk ig hi mg b be ml mm l mn mo">module "backend-example" {<br/>   source     = "../../modules/development-backend"<br/>   project_id = &lt;Target Application Project ID&gt;<br/>   name       = &lt;Target Application Name&gt;<br/>   network    = &lt;Target Application VPC ID&gt;<br/>   subnet     = &lt;Target Application VPC subnets&gt;<br/>   region     = &lt;Target Application Region&gt;<br/>}</span></pre><p id="82ac" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">10.使用<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/samples/x-sb-psc" rel="noopener ugc nofollow" target="_blank">南行</a>脚本中的资源<em class="kc">Google _ compute _ subnet</em>为PSC SA创建一个子网(NAT子网)。</p><pre class="kj kk kl km fd mf mg mh bn mi mj bi"><span id="a24e" class="mk ig hi mg b be ml mm l mn mo"> resource "google_compute_subnetwork" "psc_nat_subnet" {<br/>   name          = &lt;PSC Subnet Name&gt;<br/>   project       = &lt;Target Application Project ID&gt;<br/>   region        = &lt;Region&gt;<br/>   network       = &lt;Target Application VPC ID&gt;<br/>   ip_cidr_range = &lt;PSC Subnet IP CIDR&gt;<br/>   purpose       = "PRIVATE_SERVICE_CONNECT"<br/> }</span></pre><p id="6c75" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">11.下一步是使用<em class="kc"> southbound-psc </em>模块从<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/samples/x-sb-psc" rel="noopener ugc nofollow" target="_blank"> Southbound </a>脚本创建SA和EA。</p><pre class="kj kk kl km fd mf mg mh bn mi mj bi"><span id="4748" class="mk ig hi mg b be ml mm l mn mo"> module "southbound-psc" {<br/>   source              = "../../modules/sb-psc-attachment"<br/>   project_id          = &lt;Target Application Project ID&gt;<br/>   name                = &lt;PSC Name&gt;<br/>   region              = &lt;Region&gt;<br/>   apigee_organization = &lt;Apigee Organization ID&gt;<br/>   nat_subnets         = &lt;PSC NAT Subnet ID create from previous step&gt;<br/>   target_service      = &lt;Target Service for service attachment i.e. forwarding rule&gt;<br/>   depends_on = [<br/>     module.apigee-x-core.instance_endpoints<br/>   ]<br/> }</span></pre><p id="538a" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">12.使用资源<em class="kc">Google _ compute _ firewall</em>从<a class="ae kb" href="https://github.com/apigee/terraform-modules/tree/main/samples/x-sb-psc" rel="noopener ugc nofollow" target="_blank">南行</a>脚本创建防火墙规则。</p><pre class="kj kk kl km fd mf mg mh bn mi mj bi"><span id="dc0c" class="mk ig hi mg b be ml mm l mn mo"> resource "google_compute_firewall" "allow_psc_nat_to_backend" {<br/>   name          = &lt;Firewall Rule Name&gt;<br/>   project       = &lt;Target Application Project ID&gt;<br/>   network       = &lt;Target Application VPC ID&gt;<br/>   source_ranges = &lt;List of PSC Subnet IP CIDR Ranges&gt;<br/>   target_tags   = &lt;List of Target Application Tags&gt;<br/>   allow {<br/>     protocol = "tcp"<br/>     ports    = ["80", "443"]<br/>   }<br/> }</span></pre><p id="4b57" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">一旦创建了所有的Terraform资源，您就获得了一个端到端的自动化Apigee X北向和南向PSC设置。</p><h1 id="85d6" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">限制</h1><p id="976d" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">本节描述了将PSC与Apigee一起使用时的一些限制。</p><p id="17aa" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated"><strong class="jf hj">北行PSC限制</strong></p><ul class=""><li id="2ee4" class="lp lq hi jf b jg kd jk ke jo lr js ls jw lt ka lu lv lw lx bi translated">资源调配向导中不支持PSC，只能通过CLI或Terraform安装。</li><li id="07bf" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated"><a class="ae kb" href="https://cloud.google.com/load-balancing/docs/https" rel="noopener ugc nofollow" target="_blank">不支持全局外部HTTP(S)负载平衡器(经典)</a>。</li><li id="da22" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated">对于每个Apigee实例，可以通过PSC NEGs连接的客户项目数量是15个。</li><li id="7386" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated">对于每个Apigee实例，客户可以在同一个项目中创建连接到Apigee的PSC NEGs的数量是10。</li></ul><p id="013d" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">参考<a class="ae kb" href="https://cloud.google.com/apigee/docs/api-platform/system-administration/northbound-networking-psc#restrictions" rel="noopener ugc nofollow" target="_blank">北行限制</a>了解更多关于限制的最新信息。</p><p id="d982" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated"><strong class="jf hj">南行PSC限制</strong></p><ul class=""><li id="7cd1" class="lp lq hi jf b jg kd jk ke jo lr js ls jw lt ka lu lv lw lx bi translated">在Apigee组织中，对于给定的服务连接，允许有一个端点连接。</li><li id="7606" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated">服务附件和端点附件必须位于同一区域。</li></ul><p id="e667" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">有关限制的更多最新信息，请参考<a class="ae kb" href="https://cloud.google.com/apigee/docs/api-platform/architecture/southbound-networking-patterns-endpoints#limitations" rel="noopener ugc nofollow" target="_blank">南行限制</a></p><h1 id="b529" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">参考</h1><ul class=""><li id="b514" class="lp lq hi jf b jg jh jk jl jo mp js mq jw mr ka lu lv lw lx bi translated"><a class="ae kb" href="https://cloud.google.com/vpc/docs/private-service-connect" rel="noopener ugc nofollow" target="_blank">专用服务连接概述</a></li><li id="2f21" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated"><a class="ae kb" href="https://cloud.google.com/apigee/docs/api-platform/system-administration/northbound-networking-psc" rel="noopener ugc nofollow" target="_blank">与PSC的Apigee北向联网</a></li><li id="dc20" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated"><a class="ae kb" href="https://cloud.google.com/apigee/docs/api-platform/architecture/southbound-networking-patterns-endpoints" rel="noopener ugc nofollow" target="_blank">顶点南行与PSC联网</a></li><li id="042e" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated"><a class="ae kb" href="https://cloud.google.com/vpc/docs/private-service-connect#subnet-capacity" rel="noopener ugc nofollow" target="_blank"> PSC子网规模</a></li><li id="592b" class="lp lq hi jf b jg ly jk lz jo ma js mb jw mc ka lu lv lw lx bi translated"><a class="ae kb" href="https://cloud.google.com/apigee/docs/api-platform/reference/limits#private-service-connect-psc" rel="noopener ugc nofollow" target="_blank">PSC的最高产品限额</a></li></ul><h1 id="0904" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">作者</h1><p id="0141" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">萨米乌拉·沙伊克</p><p id="243f" class="pw-post-body-paragraph jd je hi jf b jg kd ji jj jk ke jm jn jo kf jq jr js kg ju jv jw kh jy jz ka hb bi translated">安摩尔·克里尚·萨赫德瓦</p><h1 id="f2a9" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">承认</h1><p id="f049" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">特别感谢<a class="ms mt ge" href="https://medium.com/u/df08c2eecd10?source=post_page-----ac7eaa645900--------------------------------" rel="noopener" target="_blank">丹尼尔·斯特雷贝尔</a>创作了Terraform模块。</p></div></div>    
</body>
</html>