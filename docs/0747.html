<html>
<head>
<title>Impersonate Users With Google Cloud Service Accounts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Google云服务帐户模拟用户</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/impersonating-users-with-google-cloud-platform-service-accounts-ba762db09092?source=collection_archive---------0-----------------------#2018-09-02">https://medium.com/google-cloud/impersonating-users-with-google-cloud-platform-service-accounts-ba762db09092?source=collection_archive---------0-----------------------#2018-09-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="3586" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">能力越大，责任越大</h2></div><p id="a496" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如Sal Rashid在他的文章中描述的那样，IAM <a class="ae jt" href="https://cloud.google.com/iam/docs/service-accounts#the_service_account_actor_role" rel="noopener ugc nofollow" target="_blank"> serviceAccountActor角色</a>使另一个用户或服务帐户能够模拟一个服务帐户(这个角色现在已经被<a class="ae jt" href="https://cloud.google.com/iam/docs/service-accounts#the_service_account_user_role" rel="noopener ugc nofollow" target="_blank"> serviceAccountUser角色</a>取代)。</p><p id="8da4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但如果你想做相反的事情，即。用服务帐户模拟用户？这是基于服务的架构中的一个常见用例:服务将代表用户执行操作(例如，存储记录、检索blob)。</p><p id="4e9c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，简单介绍一下为什么您可能想要模拟用户，而不是仅仅使用服务帐户进行授权。后者很简单，但是违反了最小特权(就像构建一个只使用<a class="ae jt" href="https://cloud.google.com/docs/authentication/api-keys" rel="noopener ugc nofollow" target="_blank"> API键</a>的移动应用程序),并且如果用户也可以直接访问(例如，从Google云存储上传/下载对象，或者在BigQuery上运行查询)服务与之交互的Google云平台管理的资源，那么它就会崩溃:显然，基于服务帐户的权限和直接用户访问之间存在不匹配。</p><p id="4adc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以通过显式设置基于用户的权限来解决这种不匹配(Google Cloud Storage object ACLs除外，它在一定程度上基于上传对象的用户)，但这会增加处理和管理开销。这就把我们带到了用户模拟。</p><h1 id="46e2" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">用户模拟</h1><p id="12af" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">您可以让服务帐户模拟托管用户，即。通过<a class="ae jt" href="https://developers.google.com/admin-sdk/directory/v1/guides/delegation" rel="noopener ugc nofollow" target="_blank">全域授权</a>代表云身份行事(忽略传统G套件品牌；这也适用于云身份API)。这是我们将在本文中重点讨论的方法。</p><p id="5ba7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这解决了上面提到的基于服务帐户的授权的几个问题:</p><ul class=""><li id="f81a" class="kr ks hi iz b ja jb jd je jg kt jk ku jo kv js kw kx ky kz bi translated">您的应用程序创建的资产需要向最终用户授予ACL。您可以通过IAM APIs手动管理它，但是用户模拟会自动处理它。</li><li id="c420" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated">Google云存储对象ACL部分基于上传对象的用户；用户模拟确保这些ACL反映的是用户而不是服务帐户。</li><li id="5196" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated">您的应用程序需要根据客户的用户的身份向他们公开适当的资产。手动管理将需要您在应用程序中构建一个ACL层；用户模拟使它自动发生。</li></ul><h2 id="d933" class="lf jv hi bd jw lg lh li ka lj lk ll ke jg lm ln kg jk lo lp ki jo lq lr kk ls bi translated">限制</h2><p id="7d13" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">那么，既然空气中弥漫着这种魔力，你为什么不这样做，祝贺你自己出色地完成了工作，然后回家呢？有几个原因:</p><p id="7705" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">最低特权</strong></p><p id="b4c5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如您可能已经从“域范围”的命名中猜到的那样，用户模拟的范围可以缩小到GCP API方法，但不能缩小到域内的用户或资源。这意味着服务帐户可以访问其方法范围内的所有资源(例如，读取Google云存储)，因此最小特权问题仍然存在。</p><ul class=""><li id="438e" class="kr ks hi iz b ja jb jd je jg kt jk ku jo kv js kw kx ky kz bi translated">如果你在管理自己的用户和数据，这还不错，虽然不是很好。</li><li id="694e" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated">如果您正在构建需要访问客户拥有的资源的SaaS应用程序，情况会更糟，因为它们的许多用户资产对客户来说是机密的。不应与您的应用程序共享。</li></ul><p id="c5ec" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">审核</strong></p><p id="596f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">就Google云平台而言，一旦建立了身份验证，实际用户就在创建/访问资源。这意味着审计跟踪、计费、配额等。都链接到用户，而不是您的应用程序或其服务帐户。</p><p id="e6bd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这值得特别注意，因为大范围的用户模拟需要强大的补偿控制；强大的治理流程和自动化会有所帮助。</p><h2 id="ba75" class="lf jv hi bd jw lg lh li ka lj lk ll ke jg lm ln kg jk lo lp ki jo lq lr kk ls bi translated">减轻</h2><p id="64af" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated"><a class="ae jt" href="https://cloud.google.com/vpc-service-controls/" rel="noopener ugc nofollow" target="_blank"> VPC服务控制</a>(私下测试版)可以帮助减轻最小特权问题，尽管它们确实会招致管理间接税。</p><p id="4f88" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它们使您能够围绕Google云平台资源(如云存储桶)定义基于网络的安全边界，以将数据限制在虚拟私有云(VPC)内，并帮助降低数据泄露风险。</p><p id="9ad3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您和您的客户可以将资源放在安全区域，并建立基于IP的访问限制，这样机密信息就不会与您的应用程序共享。</p><p id="fb9a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有一个关键的警告:VPC服务控制是失效开放的，而不是失效关闭的，所以没有明确在VPC安全区的数据将可以跨越VPC的边界。强大的治理流程和自动化有助于降低这种风险。</p></div><div class="ab cl lt lu gp lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="hb hc hd he hf"><h1 id="a54b" class="ju jv hi bd jw jx ma jz ka kb mb kd ke io mc ip kg ir md is ki iu me iv kk kl bi translated">代码示例</h1><p id="b303" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">这里有几个Python示例可以帮助您入门…</p><figure class="mf mg mh mi fd mj"><div class="bz dy l di"><div class="mk ml l"/></div><figcaption class="mm mn et er es mo mp bd b be z dx translated">创建具有任意用户所有权的GCS存储桶</figcaption></figure></div><div class="ab cl lt lu gp lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="hb hc hd he hf"><figure class="mf mg mh mi fd mj"><div class="bz dy l di"><div class="mk ml l"/></div><figcaption class="mm mn et er es mo mp bd b be z dx translated">上传具有任意用户所有权的GCS对象</figcaption></figure></div><div class="ab cl lt lu gp lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="hb hc hd he hf"><figure class="mf mg mh mi fd mj er es paragraph-image"><div class="er es mq"><img src="../Images/5e95b5ce6591be38aacef9d9bc113a2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:450/format:webp/1*Hui1VQlonQyXGIA4hhahmw.jpeg"/></div><figcaption class="mm mn et er es mo mp bd b be z dx translated">该作品已经被作者发布到公共领域</figcaption></figure><h1 id="0152" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">下一步是什么</h1><p id="6a85" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">阅读下面的内容，了解更多关于本文的基本概念:</p><ul class=""><li id="2b14" class="kr ks hi iz b ja jb jd je jg kt jk ku jo kv js kw kx ky kz bi translated"><a class="ae jt" href="https://developers.google.com/admin-sdk/directory/v1/guides/delegation" rel="noopener ugc nofollow" target="_blank">全域授权</a>。</li><li id="02cd" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated"><a class="ae jt" href="https://cloud.google.com/vpc-service-controls/" rel="noopener ugc nofollow" target="_blank"> VPC服务控制</a>。</li></ul><p id="9f6e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">阅读以下指南，了解如何实施:</p><ul class=""><li id="73aa" class="kr ks hi iz b ja jb jd je jg kt jk ku jo kv js kw kx ky kz bi translated"><a class="ae jt" rel="noopener" href="/google-cloud/faster-serviceaccount-authentication-for-google-cloud-platform-apis-f1355abc14b2">谷歌云平台API</a>更快的服务账户认证。</li><li id="a708" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated"><a class="ae jt" rel="noopener" href="/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed">服务帐户模拟</a>(注意IAM serviceAccountActor角色已被serviceAccountUser角色取代)。</li><li id="5e5e" class="kr ks hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated"><a class="ae jt" rel="noopener" href="/@fargyle/multi-tenant-google-cloud-platform-saas-applications-how-to-fbd16c8a9766">多租户B2B SaaS认证和授权</a>。</li></ul></div></div>    
</body>
</html>