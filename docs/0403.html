<html>
<head>
<title>Deploying Mantis Bug Tracker on Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在谷歌云平台上部署螳螂错误跟踪器</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/deploying-mantis-bug-tracker-on-google-cloud-platform-c1810dcc0c71?source=collection_archive---------1-----------------------#2017-10-11">https://medium.com/google-cloud/deploying-mantis-bug-tracker-on-google-cloud-platform-c1810dcc0c71?source=collection_archive---------1-----------------------#2017-10-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="044c" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated"><em class="ix">利用CentOS 7、Caddy、云SQL和gcloud CLI </em></h2></div><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es iy"><img src="../Images/0bb4547a01bd6d9a09ab832420ae4ab9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WVBi_eoLLjFZtFeHDiUUUg.png"/></div></div></figure><h1 id="55dd" class="jk jl hi bd jm jn jo jp jq jr js jt ju io jv ip jw ir jx is jy iu jz iv ka kb bi translated">概观</h1><h2 id="1673" class="kc jl hi bd jm kd ke kf jq kg kh ki ju kj kk kl jw km kn ko jy kp kq kr ka ks bi translated">用例</h2><p id="eb92" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kj lc ld le km lf lg lh kp li lj lk ll hb bi translated">目前，作为一名独立的安全研究员，我需要一个解决方案来记录和跟踪发现的漏洞。在前一家公司，这是通过定制的内部软件实现的。或者，安全行业的人可能熟悉<a class="ae lm" href="https://bugs.chromium.org/p/project-zero/issues/list" rel="noopener ugc nofollow" target="_blank"> Project Zero的问题跟踪器</a>，在那里利用了bug跟踪软件<a class="ae lm" href="https://groups.google.com/a/chromium.org/forum/#!msg/infra-dev/OotYpVzgnBw/fAfheRp9BQAJ" rel="noopener ugc nofollow" target="_blank"> Monorail </a>。</p><p id="6fa0" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated"><strong class="kv hj"/></p><p id="5def" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">当然，还有许多其他开源的bug跟踪软件解决方案。我发现Mantis Bug Tracker在用户界面和配置之间提供了恰当的平衡，并提供了一个自动化的API。诚然，我没有愤怒地使用它，但我渴望得到它的设置，并了解更多关于谷歌云平台。</p><p id="6efd" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">不要跑题到漏洞披露，追踪器上列出的错误将是那些通过自动化(因此需要分类)或人工调查发现的错误的结果。我没有预见到信息会通过这种方式公开，考虑到负载和成本较低，我选择在谷歌云平台上使用小型(f1-micro)实例。</p><p id="2fe2" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">使用<a class="ae lm" href="https://cloud.google.com/products/calculator/" rel="noopener ugc nofollow" target="_blank">定价计算器</a>，1个月的持续使用折扣预计约为16美元(撰写本文时为美元)。当然，这可能会根据您部署应用程序的地区和您需要的实例大小而有所不同。</p><h2 id="04ed" class="kc jl hi bd jm kd ke kf jq kg kh ki ju kj kk kl jw km kn ko jy kp kq kr ka ks bi translated">流行语摘要</h2><p id="53fd" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kj lc ld le km lf lg lh kp li lj lk ll hb bi translated">本文介绍了在<a class="ae lm" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a> (GCP)上部署<a class="ae lm" href="https://mantisbt.org/" rel="noopener ugc nofollow" target="_blank">螳螂错误追踪器</a> (MantisBT)的过程。MantisBT将安装在<a class="ae lm" href="https://cloud.google.com/compute/docs/" rel="noopener ugc nofollow" target="_blank">谷歌计算引擎</a>上，在这个场景中是一个<a class="ae lm" href="https://www.centos.org/" rel="noopener ugc nofollow" target="_blank"> CentOS </a> 7虚拟机，使用<a class="ae lm" href="https://caddyserver.com/" rel="noopener ugc nofollow" target="_blank"> Caddy </a>作为web服务器，并使用FastCGI代理对PHP-FPM的请求，以便为应用程序提供服务。<a class="ae lm" href="https://cloud.google.com/sql/docs/" rel="noopener ugc nofollow" target="_blank"> Google Cloud SQL </a>将被用作MantisBT的数据库后端。</p><p id="5a25" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">这篇文章分为两部分:第1部分侧重于创建计算和SQL实例，而第2部分介绍了应用程序的安装过程。</p><h1 id="e1a4" class="jk jl hi bd jm jn jo jp jq jr js jt ju io jv ip jw ir jx is jy iu jz iv ka kb bi translated">第1部分:实例设置</h1><h2 id="09e1" class="kc jl hi bd jm kd ke kf jq kg kh ki ju kj kk kl jw km kn ko jy kp kq kr ka ks bi translated">谷歌云SDK</h2><p id="16b4" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kj lc ld le km lf lg lh kp li lj lk ll hb bi translated">Google Cloud上使用的所有服务和实例都可以通过<a class="ae lm" href="https://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank"> web控制台</a>进行实例化。然而，我对更加熟悉用于快速部署和重新部署服务的<code class="du lt lu lv lw b">gcloud</code>命令行实用程序很感兴趣。谷歌已经提供了一个<a class="ae lm" href="https://cloud.google.com/sdk/docs/quickstarts" rel="noopener ugc nofollow" target="_blank">快速启动</a>来安装和初始化云SDK。如果你还没有这样做，我鼓励你这样做。</p><p id="dd03" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">您可以创建一个新项目或使用命令下列出的当前配置的项目；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="5b2a" class="kc jl hi lw b fi mb mc l md me">gcloud config list</span></pre><p id="a6bb" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">要创建和切换，请在以下命令中用<code class="du lt lu lv lw b">PROJECT_ID</code>代替唯一名称；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="84e0" class="kc jl hi lw b fi mb mc l md me">gcloud projects create PROJECT_ID<br/>gcloud config set core/project PROJECT_ID</span></pre><p id="7eae" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">计算实例和云SQL的进一步设置将在此项目中进行。您可能会发现，如果在进行给定的项目时还没有启用API，那么您将被要求启用API。</p><h2 id="3ab7" class="kc jl hi bd jm kd ke kf jq kg kh ki ju kj kk kl jw km kn ko jy kp kq kr ka ks bi translated">计算实例</h2><p id="139f" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kj lc ld le km lf lg lh kp li lj lk ll hb bi translated">compute实例将充当web服务器，运行使用Caddy提供的MantisBT应用程序。</p><p id="b172" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">根据您使用的是新项目还是现有项目，允许HTTP(S)流量通过防火墙的默认规则可能不存在。您可以使用以下命令查看当前的防火墙规则列表。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="ff3e" class="kc jl hi lw b fi mb mc l md me">gcloud compute firewall-rules list</span></pre><p id="f935" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">如果输出中没有允许<code class="du lt lu lv lw b">tcp:80</code>和<code class="du lt lu lv lw b">tcp:443</code>的规则，执行以下两个命令来添加这些规则。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="f8a1" class="kc jl hi lw b fi mb mc l md me">gcloud compute firewall-rules create default-allow-http \ <br/>    --allow=tcp:80 --target-tags http-server</span><span id="f46c" class="kc jl hi lw b fi mf mc l md me">gcloud compute firewall-rules create default-allow-https \<br/>    --allow=tcp:443 --target-tags https-server</span></pre><p id="7a30" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">如果您希望为您的MantisBT实例分配一个静态IP地址，使用下面的命令创建一个，用<code class="du lt lu lv lw b">ADDRESS_NAME</code>替换主机名。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="9d0c" class="kc jl hi lw b fi mb mc l md me">gcloud compute addresses create ADDRESS_NAME</span></pre><p id="ab91" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">该地址可以在的输出中看到；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="e09b" class="kc jl hi lw b fi mb mc l md me">gcloud compute addresses list</span></pre><p id="e832" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">创建一个A记录，让您的DNS提供商将一个域指向此IP地址。如果您希望稍后使用Caddy自动获得一个带有Let's Encrypt的证书，这是必需的。这将提供对您的MantisBT应用程序的安全访问。</p><p id="6d82" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">现在用下面的命令创建计算实例，替换<code class="du lt lu lv lw b">INSTANCE_NAME</code>为创建的虚拟机命名，例如<code class="du lt lu lv lw b">mantisbt</code>。同样，将<code class="du lt lu lv lw b">ADDRESS_NAME</code>改为之前使用的。注意，使用的标签反映了为创建的防火墙规则指定的<code class="du lt lu lv lw b">--target-tags</code>。作用域的使用允许VM连接并使用云SQL数据库。创建实例的更多选项可在<a class="ae lm" href="https://cloud.google.com/sdk/gcloud/reference/compute/instances/create" rel="noopener ugc nofollow" target="_blank">参考文档</a>中找到。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="0ff7" class="kc jl hi lw b fi mb mc l md me">gcloud compute instances create INSTANCE_NAME               \<br/>    --image-family centos-7 --image-project centos-cloud    \<br/>    --machine-type=f1-micro --tags=http-server,https-server \<br/>    --address=ADDRESS_NAME                                  \<br/>    --scopes=default,cloud-platform,sql-admin</span></pre><p id="11bf" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">一旦命令返回状态<code class="du lt lu lv lw b">RUNNING</code>，您就可以用以下命令测试SSH访问；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="007d" class="kc jl hi lw b fi mb mc l md me">gcloud compute ssh INSTANCE_NAME</span></pre><p id="526d" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">这将为Google Compute Engine创建一个密钥对(如果在<code class="du lt lu lv lw b">~/.ssh/google_compute_engine</code>还没有的话),并更新项目的元数据以允许使用这个密钥。</p><p id="a503" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">在SSH会话中键入<code class="du lt lu lv lw b">exit</code>返回到您的本地提示符，我们将继续设置Google Cloud SQL。</p><h2 id="ff23" class="kc jl hi bd jm kd ke kf jq kg kh ki ju kj kk kl jw km kn ko jy kp kq kr ka ks bi translated">谷歌云SQL</h2><p id="fac6" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kj lc ld le km lf lg lh kp li lj lk ll hb bi translated">目前有两个为云SQL提供的数据库引擎，MySQL和PostgreSQL，后者仍处于测试阶段。云SQL上的PostgreSQL目前不支持高可用性和复制。在我的用例中，这不是特别需要的，但是根据您的部署，这是值得考虑的。Google的文档提供了关于<a class="ae lm" href="https://cloud.google.com/sql/docs/mysql/configure-ha" rel="noopener ugc nofollow" target="_blank">配置高可用性实例的说明</a>。我将继续使用PostgreSQL。</p><p id="cefb" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">使用下面的命令，替换<code class="du lt lu lv lw b">SQL_INSTANCE_NAME</code>为云SQL实例命名，<code class="du lt lu lv lw b">GCE_ZONE</code>和<code class="du lt lu lv lw b">REGION</code>为计算实例的位置，这可以用<code class="du lt lu lv lw b">gcloud compute instances list</code>检查。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="dcad" class="kc jl hi lw b fi mb mc l md me">gcloud sql instances create SQL_INSTANCE_NAME --tier=db-f1-micro  \<br/>    --database-version=POSTGRES_9_6 --storage-type=HDD            \<br/>    --storage-size=10 --storage-auto-increase                     \<br/>    --activation-policy=ALWAYS --backup --backup-start-time=00:00 \<br/>    --maintenance-release-channel=production                      \<br/>    --maintenance-window-day=FRI --maintenance-window-hour=12     \<br/>    --gce-zone=GCE_ZONE --region=REGION</span></pre><p id="eeae" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">这在硬盘驱动器上创建了一个具有0.6GB RAM和10GB存储空间的共享核心实例，硬盘驱动器将在必要时增加(而不是减少)。每日午夜备份，维护窗口在星期五中午。</p><p id="a336" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">最后，使用以下命令设置默认的<code class="du lt lu lv lw b">postgres</code>用户帐户密码，用上面创建命令中使用的名称替换<code class="du lt lu lv lw b">SQL_INSTANCE_NAME</code>。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="4ffe" class="kc jl hi lw b fi mb mc l md me">gcloud sql users set-password postgres no-host \<br/>    --instance=SQL_INSTANCE_NAME --prompt-for-password</span></pre><h2 id="dab1" class="kc jl hi bd jm kd ke kf jq kg kh ki ju kj kk kl jw km kn ko jy kp kq kr ka ks bi translated">部分摘要</h2><p id="ec38" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kj lc ld le km lf lg lh kp li lj lk ll hb bi translated">在本节中，您已经创建了安装和运行MantisBT的基础设施和平台。这包括:</p><ul class=""><li id="4342" class="mg mh hi kv b kw ln kz lo kj mi km mj kp mk ll ml mm mn mo bi translated">安装和初始化云SDK以及配置项目</li><li id="9c1f" class="mg mh hi kv b kw mp kz mq kj mr km ms kp mt ll ml mm mn mo bi translated">创建防火墙规则</li><li id="f426" class="mg mh hi kv b kw mp kz mq kj mr km ms kp mt ll ml mm mn mo bi translated">保留静态IP地址</li><li id="95bd" class="mg mh hi kv b kw mp kz mq kj mr km ms kp mt ll ml mm mn mo bi translated">创建一个计算实例，分配上述规则和IP地址</li><li id="8a8f" class="mg mh hi kv b kw mp kz mq kj mr km ms kp mt ll ml mm mn mo bi translated">使用SSH连接到实例</li><li id="3367" class="mg mh hi kv b kw mp kz mq kj mr km ms kp mt ll ml mm mn mo bi translated">创建具有备份和维护计划的托管云SQL实例。</li></ul><p id="ae78" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">至此，本文的剩余部分将集中于安装MantisBT和Caddy，以及云SQL代理来安全地连接到数据库后端。</p><h1 id="8f94" class="jk jl hi bd jm jn jo jp jq jr js jt ju io jv ip jw ir jx is jy iu jz iv ka kb bi translated">第2部分:应用程序安装过程</h1><h2 id="b3a3" class="kc jl hi bd jm kd ke kf jq kg kh ki ju kj kk kl jw km kn ko jy kp kq kr ka ks bi translated">连接到实例</h2><p id="2ef2" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kj lc ld le km lf lg lh kp li lj lk ll hb bi translated">以下用于安装和配置软件的命令都发生在您之前创建的计算实例上。您可以使用安全地连接到实例；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="548c" class="kc jl hi lw b fi mb mc l md me">gcloud compute ssh INSTANCE_NAME</span></pre><h2 id="35bc" class="kc jl hi bd jm kd ke kf jq kg kh ki ju kj kk kl jw km kn ko jy kp kq kr ka ks bi translated">云SQL代理</h2><p id="5272" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kj lc ld le km lf lg lh kp li lj lk ll hb bi translated">云SQL实例在创建时是不公开的。希望通信的客户端及其相关IP地址必须被添加到<a class="ae lm" href="https://cloud.google.com/sql/docs/postgres/configure-ip" rel="noopener ugc nofollow" target="_blank">白名单</a>。此外，强烈建议您使用安全套接字层(SSL)协议连接到数据库。这确保了在客户端和云SQL数据库之间传输的数据是安全的。</p><p id="e2e3" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">使用云SQL代理时，需要将IP地址列入白名单，配置和管理服务器/客户端证书以实现安全通信。有关云SQL代理如何工作的更多信息，请参见参考文档<a class="ae lm" href="https://cloud.google.com/sql/docs/postgres/sql-proxy" rel="noopener ugc nofollow" target="_blank">关于云SQL代理</a>。总之，它自动加密流量并处理对数据库的访问。</p><p id="695e" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">您可能会发现，您需要启用云SQL API来让代理工作。可以通过<a class="ae lm" href="https://console.cloud.google.com/apis/library/sqladmin.googleapis.com" rel="noopener ugc nofollow" target="_blank"> API库</a>启用。此外，当创建计算实例时，我们添加了<code class="du lt lu lv lw b">cloud-platform</code>和<code class="du lt lu lv lw b">sql-admin</code>范围。这意味着默认服务帐户可以管理云SQL实例。或者，您可以创建一个特定的<a class="ae lm" href="https://cloud.google.com/sql/docs/postgres/sql-proxy#create-service-account" rel="noopener ugc nofollow" target="_blank">服务帐户</a>，并在启动云SQL代理时传递凭证文件。</p><p id="f462" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">首先下载云SQL代理；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="e327" class="kc jl hi lw b fi mb mc l md me">curl https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 \<br/>  -o cloud_sql_proxy</span></pre><p id="bbef" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">使应用程序可执行，并转移到<code class="du lt lu lv lw b">/usr/local/bin</code>。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="496b" class="kc jl hi lw b fi mb mc l md me">chmod +x cloud_sql_proxy<br/>sudo mv cloud_sql_proxy /usr/local/bin</span></pre><p id="6cb5" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">为了在引导时启动该过程，我们将基于<a class="ae lm" href="https://github.com/GoogleCloudPlatform/cloudsql-proxy/issues/4#issuecomment-246962809" rel="noopener ugc nofollow" target="_blank">该注释</a>和<a class="ae lm" href="https://stackoverflow.com/a/44459517" rel="noopener ugc nofollow" target="_blank">堆栈溢出答案</a>创建一个systemd服务单元配置文件。将<code class="du lt lu lv lw b">CONNECTION_NAME</code>替换为<a class="ae lm" href="https://console.cloud.google.com/sql/instances" rel="noopener ugc nofollow" target="_blank">云SQL仪表板</a>上给出的实例连接名称。这就是形式上的<code class="du lt lu lv lw b">PROJECT_ID:REGION:SQL_INSTANCE_NAME</code>。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="2958" class="kc jl hi lw b fi mb mc l md me">[Unit]<br/>Description=Google Cloud Compute Engine SQL Proxy<br/>After=networking.service<br/>Before=google-shutdown-scripts.service</span><span id="40f5" class="kc jl hi lw b fi mf mc l md me">[Service]<br/>Type=simple<br/>WorkingDirectory=/run/cloudsql<br/>ExecStart=/usr/local/bin/cloud_sql_proxy -dir=/run/cloudsql -instances=CONNECTION_NAME=tcp:127.0.0.1:5432<br/>Restart=always<br/>StandardOutput=journal<br/>User=root</span><span id="1896" class="kc jl hi lw b fi mf mc l md me">[Install]<br/>WantedBy=multi-user.target</span></pre><p id="cb9d" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">将此文件另存为<code class="du lt lu lv lw b">/etc/systemd/system/cloud-sql-proxy.service</code>，并设置适当的权限；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="9cda" class="kc jl hi lw b fi mb mc l md me">sudo chmod 0644 /etc/systemd/system/cloud-sql-proxy.service</span></pre><p id="429a" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">创建工作目录；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="3a0b" class="kc jl hi lw b fi mb mc l md me">sudo mkdir /run/cloudsql</span></pre><p id="be3f" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">最后，启用并启动代理；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="c4b2" class="kc jl hi lw b fi mb mc l md me">sudo systemctl daemon-reload<br/>sudo systemctl enable cloud-sql-proxy<br/>sudo systemctl start cloud-sql-proxy</span></pre><p id="7317" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">您可以使用<code class="du lt lu lv lw b">journalctl</code>检查日志输出，看看代理是否启动并运行，或者是否有任何错误；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="e55a" class="kc jl hi lw b fi mb mc l md me">journalctl -u cloud-sql-proxy</span></pre><h2 id="0cd4" class="kc jl hi bd jm kd ke kf jq kg kh ki ju kj kk kl jw km kn ko jy kp kq kr ka ks bi translated">MantisBT和PHP-FPM</h2><p id="74a9" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kj lc ld le km lf lg lh kp li lj lk ll hb bi translated">我们首先安装PHP和MantisBT所需的附加模块。如果您之前使用了MySQL数据库，那么在下面的命令中用<code class="du lt lu lv lw b">php-pgsql</code>代替<code class="du lt lu lv lw b">php-mysql</code>;</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="ec01" class="kc jl hi lw b fi mb mc l md me">sudo yum install php php-pgsql php-mbstring php-fpm php-soap \ <br/>    policycoreutils-python</span></pre><p id="8cbb" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">CentOS默认使用<code class="du lt lu lv lw b">apache</code>用户和组来运行Apache Web服务器。在这个实例中，我们使用Caddy，与PHP-FPM相关的默认配置文件使用<code class="du lt lu lv lw b">apache</code>用户和组。为了清楚起见，我们将创建一个新用户并相应地更新配置文件，因为我们没有使用Apache。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="d26c" class="kc jl hi lw b fi mb mc l md me">sudo mkdir /srv/www<br/>sudo groupadd -g 33 www-data<br/>sudo useradd -g www-data --no-user-group --home-dir /srv/www \<br/>    --no-create-home --shell /usr/sbin/nologin --system      \<br/>    --uid 33 www-data<br/>sudo chown www-data:www-data /srv/www</span></pre><p id="b77a" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">修改<code class="du lt lu lv lw b">/etc/php-fpm.d/www.conf</code>替换线条；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="d3e5" class="kc jl hi lw b fi mb mc l md me">user = apache<br/>group = apache</span></pre><p id="b0bc" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">分别以<code class="du lt lu lv lw b">www-data</code>为用户和组；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="baba" class="kc jl hi lw b fi mb mc l md me">user = www-data<br/>group = www-data</span></pre><p id="d07e" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">另外更新PHP会话存储的所有权；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="8c41" class="kc jl hi lw b fi mb mc l md me">sudo chown root:www-data /var/lib/php/session</span></pre><p id="126e" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">就像云SQL代理服务一样，我们可以让PHP-FPM在引导时启动并开始执行；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="41a7" class="kc jl hi lw b fi mb mc l md me">sudo systemctl enable php-fpm<br/>sudo systemctl start php-fpm</span></pre><p id="440c" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">我们还在<code class="du lt lu lv lw b">/srv/www</code>中为<code class="du lt lu lv lw b">www-data</code>用户创建了一个主目录。为了提供文件服务，必须设置适当的文件上下文，否则SELinux将阻止进程为MantisBT应用程序提供服务。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="bd9b" class="kc jl hi lw b fi mb mc l md me">sudo semanage fcontext -a -t httpd_sys_content_t "/srv/www(/.*)?"</span></pre><p id="ebe3" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">安装MantisBT只需要下载并解压源代码即可。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="b761" class="kc jl hi lw b fi mb mc l md me">cd /srv/www</span><span id="670a" class="kc jl hi lw b fi mf mc l md me">sudo -u www-data curl -O "https://kent.dl.sourceforge.net/project/mantisbt/mantis-stable/2.6.0/mantisbt-2.6.0.tar.gz"</span><span id="7a04" class="kc jl hi lw b fi mf mc l md me">sudo -u www-data tar xf mantisbt-2.6.0.tar.gz<br/>sudo -u www-data mv mantisbt-2.6.0 mantisbt<br/>sudo -u www-data rm -rf .pki mantisbt-2.6.0.tar.gz</span></pre><h2 id="7b1c" class="kc jl hi bd jm kd ke kf jq kg kh ki ju kj kk kl jw km kn ko jy kp kq kr ka ks bi translated">小盒子</h2><p id="23d8" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kj lc ld le km lf lg lh kp li lj lk ll hb bi translated">Caddy为现代web服务器提供了一系列的<a class="ae lm" href="https://caddyserver.com/features" rel="noopener ugc nofollow" target="_blank">功能</a>，其中简单的配置、安全的默认设置和自动证书设置以及使用Let's Encrypt进行的更新脱颖而出。</p><p id="a543" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">考虑到我的实例将接收的低流量，Caddy或者任何web服务器都足以满足请求。然而，正如本文中所做的其他决定一样，如果这不能满足您的需求，您可能希望寻找一个替代方案。</p><p id="043c" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">有几种方法可以获得Caddy，或者通过<a class="ae lm" href="https://caddyserver.com/download" rel="noopener ugc nofollow" target="_blank">下载</a>或者<a class="ae lm" href="https://github.com/mholt/caddy/releases/latest" rel="noopener ugc nofollow" target="_blank">发布</a>页面。如果您选择这种方法，请在使用官方Caddy二进制文件时遵守<a class="ae lm" href="https://caddyserver.com/products/licenses" rel="noopener ugc nofollow" target="_blank">许可</a>细节。或者，您可以从源代码构建Caddy，如下所示；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="a911" class="kc jl hi lw b fi mb mc l md me">sudo yum install golang git<br/>go get github.com/mholt/caddy/caddy<br/>sudo cp `go env GOPATH`/bin/caddy /usr/local/bin</span></pre><p id="0185" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">我们需要在Caddy二进制文件上设置一些额外的属性，以允许它绑定到端口80和443，而不需要成为root用户，另外还要为SELinux设置一些属性；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="4c48" class="kc jl hi lw b fi mb mc l md me">sudo setcap cap_net_bind_service=+ep /usr/local/bin/caddy<br/>sudo semanage fcontext -a -t httpd_exec_t /usr/local/bin/caddy<br/>sudo restorecon /usr/local/bin/caddy<br/>sudo setsebool -P httpd_can_network_connect_db on</span></pre><p id="47ac" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">这个<a class="ae lm" href="https://gist.github.com/TomHetmer/cba23c3e0e36227d7a13e8a5d742e510" rel="noopener ugc nofollow" target="_blank">要点</a>为Caddy设置SELinux属性提供了有用的指导。</p><p id="c8ea" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">像安装的其他服务一样，我们将按照本例的指导设置一个systemd服务单元。首先，创建必要的目录；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="471d" class="kc jl hi lw b fi mb mc l md me">sudo mkdir /etc/caddy<br/>sudo chown -R root:www-data /etc/caddy<br/>sudo mkdir /etc/ssl/caddy<br/>sudo chown -R www-data:root /etc/ssl/caddy<br/>sudo chmod 0770 /etc/ssl/caddy</span></pre><p id="5ac8" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">Caddy将使用<code class="du lt lu lv lw b">/etc/ssl/caddy</code>目录来加密证书。SELinux处于强制模式时，尽管有用户权限，Caddy将无法写入该目录。我们必须进一步设置文件上下文，就像安装MantisBT一样。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="493c" class="kc jl hi lw b fi mb mc l md me">sudo semanage fcontext -a -t httpd_sys_rw_content_t /etc/ssl/caddy<br/>sudo restorecon /etc/ssl/caddy</span></pre><p id="6e99" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">接下来我们将创建所谓的<code class="du lt lu lv lw b">Caddyfile</code>，Caddy的配置文件。将以下内容放入<code class="du lt lu lv lw b">/etc/caddy/Caddyfile</code>文件中。在为实例创建地址时，将<code class="du lt lu lv lw b">DOMAIN_NAME</code>替换为之前为其配置了A记录的域。或者，您可以在此处使用IP地址，但是不会向您颁发证书，也不会安全地连接到MantisBT实例。另外，将<code class="du lt lu lv lw b">EMAIL_ADDRESS</code>替换为您的电子邮件地址，以同意<a class="ae lm" href="https://letsencrypt.org/repository/" rel="noopener ugc nofollow" target="_blank">订户协议</a>。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="9ffd" class="kc jl hi lw b fi mb mc l md me">DOMAIN_NAME<br/>tls EMAIL_ADDRESS<br/>root /srv/www/mantisbt<br/>gzip<br/>status 404 {<br/>        /composer<br/>        /config<br/>        /core<br/>        /doc<br/>        /lang<br/>        /library<br/>        /plugins<br/>        /scripts<br/>        /vendor<br/>}<br/>fastcgi / 127.0.0.1:9000 php<br/>log stdout<br/>errors stderr</span></pre><p id="0e5b" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">和更新权限；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="896d" class="kc jl hi lw b fi mb mc l md me">sudo chown www-data:www-data /etc/caddy/Caddyfile<br/>sudo chmod 444 /etc/caddy/Caddyfile</span></pre><p id="4c01" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">从向导中取出<code class="du lt lu lv lw b">caddy.service</code> systemd单元文件；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="8b36" class="kc jl hi lw b fi mb mc l md me">cd ~/<br/>curl -O <a class="ae lm" href="https://raw.githubusercontent.com/mholt/caddy/master/dist/init/linux-systemd/caddy.service" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/mholt/caddy/master/dist/init/linux-systemd/caddy.service</a></span></pre><p id="838d" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">并将服务设置为启用并启动Caddy</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="6790" class="kc jl hi lw b fi mb mc l md me">sudo mv caddy.service /etc/systemd/system/<br/>sudo chown root:root /etc/systemd/system/caddy.service<br/>sudo chmod 644 /etc/systemd/system/caddy.service<br/>sudo systemctl daemon-reload<br/>sudo systemctl enable caddy.service<br/>sudo systemctl start caddy.service</span></pre><p id="9358" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">查看Caddy的<code class="du lt lu lv lw b">journalctl</code>输出，您应该看到关于证书成功发布并写入磁盘的日志记录。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="96a0" class="kc jl hi lw b fi mb mc l md me">journalctl -u caddy</span></pre><p id="00e8" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">通过访问您的域，您现在应该看到通过安全连接设置和配置数据库的页面。</p><h2 id="62f7" class="kc jl hi bd jm kd ke kf jq kg kh ki ju kj kk kl jw km kn ko jy kp kq kr ka ks bi translated">MantisBT配置</h2><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es mu"><img src="../Images/362a0213f8e9e2d43fb5620d2829b7a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*68hxOcCLU269K31rdITJnA.png"/></div></div><figcaption class="mv mw et er es mx my bd b be z dx translated">MantisBT预安装清单</figcaption></figure><p id="187b" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">当访问您的域时，您将被自动重定向到MantisBT安装程序。您应该会看到上面的清单，每个相应的项目都标有“良好”字样。</p><p id="b75c" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">再往下是供您填写的安装选项。主要是数据库类型(postgres)、数据库服务器(127.0.0.1，因为我们使用的是本地代理)、用户名(postgres)和前面设置的密码。最后是数据库名(mantisbt)。你可以在下面的截图中看到这些选项。</p><figure class="iz ja jb jc fd jd er es paragraph-image"><div role="button" tabindex="0" class="je jf di jg bf jh"><div class="er es mz"><img src="../Images/04a0fcea488fd0d50889afb67ba38031.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Tbg0DzIPw8aaE9se6NuzA.png"/></div></div><figcaption class="mv mw et er es mx my bd b be z dx translated">MantisBT安装选项</figcaption></figure><p id="f46b" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">单击“安装/升级数据库”。</p><p id="2a96" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">在接下来的页面中，安装程序试图写入<code class="du lt lu lv lw b">/srv/www/mantisbt/config/config_inc.php</code>，但由于SELinux而失败。这样就可以了，按照说明将它生成的配置复制到文件中；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="ddb1" class="kc jl hi lw b fi mb mc l md me">sudo -u www-data vim /srv/www/mantisbt/config/config_inc.php</span></pre><p id="4435" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">同时，还有很多<a class="ae lm" href="https://mantisbt.org/docs/master/en-US/Admin_Guide/html/admin.config.html" rel="noopener ugc nofollow" target="_blank">配置选项</a>你也不妨设置一下。将此作为个人实例，我选择了禁用注册，例如通过将以下内容添加到<code class="du lt lu lv lw b">config_inc.php</code>文件中。</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="8faf" class="kc jl hi lw b fi mb mc l md me">$g_allow_signup = OFF;</span></pre><p id="ff8a" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">你可能也注意到了移除<code class="du lt lu lv lw b">admin</code>目录以及修改管理员密码的指令。出于安全原因，这一点至关重要。您可以使用删除<code class="du lt lu lv lw b">admin</code>目录；</p><pre class="iz ja jb jc fd lx lw ly lz aw ma bi"><span id="ee25" class="kc jl hi lw b fi mb mc l md me">sudo -u www-data rm -rf /srv/www/mantisbt/admin</span></pre><p id="e39c" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">要更改管理员密码，请先使用默认凭据登录。用户名是“administrator”，密码是“root”，两者都没有引号。然后会提示您更改密码。</p><h2 id="7d43" class="kc jl hi bd jm kd ke kf jq kg kh ki ju kj kk kl jw km kn ko jy kp kq kr ka ks bi translated">部分摘要</h2><p id="7a82" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kj lc ld le km lf lg lh kp li lj lk ll hb bi translated">在本节中，您已经为MantisBT部署安装并配置了必要的应用程序和服务。这包括:</p><ul class=""><li id="13f8" class="mg mh hi kv b kw ln kz lo kj mi km mj kp mk ll ml mm mn mo bi translated">将云SQL代理设置为服务</li><li id="99e9" class="mg mh hi kv b kw mp kz mq kj mr km ms kp mt ll ml mm mn mo bi translated">安装了PHP-FPM并重新配置为使用<code class="du lt lu lv lw b">www-data</code>用户</li><li id="02f2" class="mg mh hi kv b kw mp kz mq kj mr km ms kp mt ll ml mm mn mo bi translated">获取了尾数源代码</li><li id="4e66" class="mg mh hi kv b kw mp kz mq kj mr km ms kp mt ll ml mm mn mo bi translated">将Caddy部署为服务</li><li id="a874" class="mg mh hi kv b kw mp kz mq kj mr km ms kp mt ll ml mm mn mo bi translated">为SELinux设置适当的权限、功能和文件上下文。</li><li id="567d" class="mg mh hi kv b kw mp kz mq kj mr km ms kp mt ll ml mm mn mo bi translated">创建了一个简单的Caddyfile</li><li id="da27" class="mg mh hi kv b kw mp kz mq kj mr km ms kp mt ll ml mm mn mo bi translated">通过web界面安装和配置了MantisBT。</li></ul><h1 id="8488" class="jk jl hi bd jm jn jo jp jq jr js jt ju io jv ip jw ir jx is jy iu jz iv ka kb bi translated">结束语</h1><p id="1c26" class="pw-post-body-paragraph kt ku hi kv b kw kx ij ky kz la im lb kj lc ld le km lf lg lh kp li lj lk ll hb bi translated">恭喜你，你现在已经有一个运行在Google云平台上的MantisBT实例了。<a class="ae lm" href="https://mantisbt.org/docs/master/en-US/Admin_Guide/html/index.html" rel="noopener ugc nofollow" target="_blank">管理指南</a>提供了对MantisBT进一步设置的更多见解，可能对您有所帮助。</p><p id="33f5" class="pw-post-body-paragraph kt ku hi kv b kw ln ij ky kz lo im lb kj lp ld le km lq lg lh kp lr lj lk ll hb bi translated">我相信你会同意我们已经讨论了大量的材料。我希望这对你有用，并在这一过程中学到了一些东西。我感谢任何反馈或回应，所以请随意评论！</p></div></div>    
</body>
</html>