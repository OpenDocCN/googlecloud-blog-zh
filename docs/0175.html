<html>
<head>
<title>Infrastructure as Code on Google Cloud Platform: Storage Buckets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云平台上的基础设施代码:存储桶</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/infrastructure-as-code-on-google-cloud-platform-storage-buckets-40f09bfa4328?source=collection_archive---------5-----------------------#2016-12-11">https://medium.com/google-cloud/infrastructure-as-code-on-google-cloud-platform-storage-buckets-40f09bfa4328?source=collection_archive---------5-----------------------#2016-12-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6eea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于我使用Google的部署管理器所学到的东西的系列文章的第2部分</p><p id="6649" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的上一篇文章中，我介绍了Google的部署管理器，并演示了如何设置基本的发布/订阅主题和订阅。现在来看看更复杂的东西:存储桶。在我体验了pub/sub之后，我并不认为它们会有多难，在这种情况下，我是对的。</p><p id="8c27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止，我的方法是在谷歌云控制台上手动设置我想要的东西，确保它能工作，然后尝试用GDM (gcloud deployment-manager)重新创建它。为了确定我的配置文件中需要什么设置，我使用了Google API文档和<em class="jd"> gcloud * describe </em>命令的组合。</p><p id="50a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">存储桶配置可能比发布/订阅稍微复杂一些。您至少需要以下YAML节点:</p><ul class=""><li id="ea12" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated"><code class="du jn jo jp jq b">name</code>:在这种情况下，资源块的名称也将是资源的名称。即<code class="du jn jo jp jq b">name: my-storage-bucket</code>将创建一个名为my-storage-bucket的存储桶</li><li id="f758" class="je jf hi ih b ii jr im js iq jt iu ju iy jv jc jj jk jl jm bi translated"><code class="du jn jo jp jq b">type</code>:资源类型，本例中为<code class="du jn jo jp jq b">storage.v1.bucket</code></li><li id="653a" class="je jf hi ih b ii jr im js iq jt iu ju iy jv jc jj jk jl jm bi translated"><code class="du jn jo jp jq b">storageClass</code>:谷歌最近更新了他们的存储类。截至目前，您可以指定<code class="du jn jo jp jq b">MULTI-REGIONAL</code>、<code class="du jn jo jp jq b">REGIONAL</code>、<code class="du jn jo jp jq b">NEARLINE</code>或<code class="du jn jo jp jq b">COLDLINE</code>。自2016年11月1日起，<code class="du jn jo jp jq b">STANDARD</code>的默认值根据位置设置自动转换为<code class="du jn jo jp jq b">MULTI-REGIONAL</code>或<code class="du jn jo jp jq b">REGIONAL</code>。</li></ul><p id="e076" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除此之外，您还可以指定<code class="du jn jo jp jq b">location</code>、<code class="du jn jo jp jq b">versioning</code>、<code class="du jn jo jp jq b">lifecycle</code>、<code class="du jn jo jp jq b">acl</code>等设置。请记住，有些设置是不兼容的。例如，您可能没有指定<code class="du jn jo jp jq b">location</code>和<code class="du jn jo jp jq b">storageClass: MULTI-REGIONAL</code>。关于可用选项的完整列表，可以在<a class="ae jw" href="https://cloud.google.com/storage/docs/json_api/v1/buckets" rel="noopener ugc nofollow" target="_blank">这里</a>找到API文档。</p><p id="26e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为一个小小的题外话，我们来谈谈创建服务帐户。这只是一点小小的偏离。真的。服务帐户需要很少的配置:</p><pre class="jx jy jz ka fd kb jq kc kd aw ke bi"><span id="d9ad" class="kf kg hi jq b fi kh ki l kj kk">- name: dav-test-serviceaccount<br/>  type: iam.v1.serviceAccount<br/>  properties:<br/>    accountId: dav-test-svc<br/>    displayName: dav-test-svc</span></pre><p id="be0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">没有密钥，服务帐户就没什么用了，所以就有了这个:</p><pre class="jx jy jz ka fd kb jq kc kd aw ke bi"><span id="d540" class="kf kg hi jq b fi kh ki l kj kk">- name: dav-test-svc-key<br/>  type: iam.v1.serviceAccounts.key<br/>  properties:<br/>    parent: projects/my-project/serviceAccounts/dav-test-svc@my-project.iam.gserviceaccount.com</span></pre><p id="c00f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可能会对自己说，“自我，知道<code class="du jn jo jp jq b">parent:</code>价值似乎是一种非常糟糕的做事方式。”你是对的。您可以通过引用为部署文件中包含的任何资源指定值。所以把它们放在一起:</p><pre class="jx jy jz ka fd kb jq kc kd aw ke bi"><span id="4f8f" class="kf kg hi jq b fi kh ki l kj kk">- name: dav-test-serviceaccount<br/>  type: iam.v1.serviceAccount<br/>  properties:<br/>    accountId: dav-test-svc<br/>    displayName: dav-test-svc<br/>- name: dav-test-svc-key<br/>  type: iam.v1.serviceAccounts.key<br/>  properties:<br/>    parent: $(ref.dav-test-serviceaccount.name)</span></pre><p id="7101" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了与存储桶主题联系起来，我们现在可以将存储桶的权限授予新的服务帐户。在存储桶上设置ACL时要记住一个问题—当您在deployment-manager中设置ACL时，它会替换默认或现有的ACL，因此请指定您想要设置的所有权限。</p><p id="ac86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最终的配置文件将所有这些放在一起:</p><pre class="jx jy jz ka fd kb jq kc kd aw ke bi"><span id="9c5e" class="kf kg hi jq b fi kh ki l kj kk">resources:<br/>- name: dav-test-serviceaccount<br/>  type: iam.v1.serviceAccount<br/>  properties:<br/>    accountId: dav-test-svc<br/>    displayName: dav-test-svc<br/>- name: dav-test-svc-key<br/>  type: iam.v1.serviceAccounts.key<br/>  properties:<br/>    parent: $(ref.dav-test-serviceaccount.name)</span><span id="884d" class="kf kg hi jq b fi kl ki l kj kk">- name: dav-storagebucket-test-01<br/>  type: storage.v1.bucket<br/>  properties:<br/>    storageClass: MULTI_REGIONAL<br/>    versioning:<br/>      enabled: false<br/>    lifecycle:<br/>      rule:<br/>      - action:<br/>          type: Delete<br/>        condition:<br/>          age: 365<br/>    acl:<br/>    - role: OWNER<br/>      entity: "project-owners-123456789012"<br/>    - role: OWNER<br/>      entity: "project-editors-123456789012"<br/>    - role: READER<br/>      entity: "project-viewers-123456789012"<br/>    - role: WRITER<br/>      entity: "user-$(ref.dav-test-serviceaccount.email)"<br/># TODO: figure out how to get project-owners et.al. by reference<br/>outputs:<br/>- name: bucket<br/>  value: $(ref.dav-storagebucket-test-01.selfLink)<br/>- name: svcacct<br/>  value: $(ref.dav-test-serviceaccount.email)<br/>- name: svcacct-key<br/>  value: $(ref.dav-test-svc-key.privateKeyData) <br/>         # this will be base64 encoded</span></pre><p id="396f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我之前没有提到的一件事是<code class="du jn jo jp jq b">outputs</code>块。这允许您在运行结束时检索有关部署的信息:</p><pre class="jx jy jz ka fd kb jq kc kd aw ke bi"><span id="c8ca" class="kf kg hi jq b fi kh ki l kj kk">[dbayer@LVML201033: ~/tmp]$ gcloud deployment-manager deployments create --config=buckets.yaml dav-test-bucket<br/>Waiting for create operation-1481485797164-543674aae03e1-60b947ad-bcac11a1...done.<br/>Create operation operation-1481485797164-543674aae03e1-60b947ad-bcac11a1 completed successfully.<br/>NAME                       TYPE                        STATE      ERRORS  INTENT<br/>dav-storagebucket-test-01  storage.v1.bucket           COMPLETED  []<br/>dav-test-serviceaccount    iam.v1.serviceAccount       COMPLETED  []<br/>dav-test-svc-key           iam.v1.serviceAccounts.key  COMPLETED  []<br/>OUTPUTS  VALUE<br/>bucket       https://www.googleapis.com/storage/v1/b/dav-storagebucket-test-01<br/>svcacct      dav-test-svc@my-project.iam.gserviceaccount.com<br/>svcacct-key ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsC...<br/>            # svcacct-key will be a long base64 encoded string</span><span id="0376" class="kf kg hi jq b fi kl ki l kj kk">[dbayer@LVML201033: ~/tmp]$</span></pre><p id="9d04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，我还没有想出如何检索服务帐户的私钥，这限制了创建密钥的有用性。我还想通过引用检索ACL的项目编号和/或实体。</p><p id="f96f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">更新:Marc Vieira-Cardinal在评论中展示了如何检索私钥。我已经在上面的代码块中加入了他的信息。我还开发了一种在使用模板时检索项目编号的方法，我在这里详细介绍了</strong><a class="ae jw" rel="noopener" href="/google-cloud/infrastructure-as-code-on-google-cloud-platform-beginning-templates-68882e68d666"><strong class="ih hj"/></a><strong class="ih hj">。</strong></p><p id="6807" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于存储桶来说差不多就是这样。接下来(假设我没有被闪亮的东西分散注意力):负载平衡器。</p></div></div>    
</body>
</html>