<html>
<head>
<title>CI/CD with Jenkins-x on your existing (GKE) cluster — ruby on rails application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在您现有的(GKE)集群上使用Jenkins-x的CI/CD—ruby on rails应用程序</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/ci-cd-with-jenkins-x-on-your-existing-gke-cluster-ruby-on-rails-application-785d8390a857?source=collection_archive---------0-----------------------#2018-05-20">https://medium.com/google-cloud/ci-cd-with-jenkins-x-on-your-existing-gke-cluster-ruby-on-rails-application-785d8390a857?source=collection_archive---------0-----------------------#2018-05-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/519629111de9ed4f238ba40bb0500adf.png" data-original-src="https://miro.medium.com/v2/resize:fit:480/format:webp/1*WVxa_X5LGswVKg43finTAQ.png"/></div></figure><h1 id="1ff6" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">介绍</h1><p id="eb03" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">Jenkins X是Kubernetes的CI/CD平台。这篇文章是让Jenkins-X在现有的Google Kubernetes引擎集群上工作的实用方法。</p><p id="9c70" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">詹金斯-X基于<a class="ae kn" href="https://github.com/kubernetes/helm" rel="noopener ugc nofollow" target="_blank">头盔</a>。最好确保<code class="du ko kp kq kr b">helm</code>和<code class="du ko kp kq kr b">jx</code>在您的shell中工作。如果你没有的话，就从各自的github页面发布部分安装它们。另外，在设置 Jenkins-x之前，确保<code class="du ko kp kq kr b">helm</code> <a class="ae kn" rel="noopener" href="/@maniankara/helm-on-gke-cluster-quick-hands-on-guide-ecffad94b0">在您的集群上工作</a></p><p id="3847" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">本文假设您有一个正在运行的GKE集群，并不包括创建一个新的Jenkins-X kubernetes集群。如果您没有，只需点击几下鼠标，就可以在免费层帐户上创建一个。</p><h1 id="ac7a" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">在您的集群上安装Jenkins-X(<em class="ks">JX安装</em>)</h1><p id="b2ee" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">如果您已经在GKE上安装了Jenkins-X集群，请确保您至少有3个节点(6个vCPUs ),并跳过本节。</p><p id="96ae" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated"><strong class="jm hj"> <em class="kt">注意:您的GKE集群中应该至少有3个节点(6个vCPUs)。</em> </strong></p><p id="279a" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">运行<code class="du ko kp kq kr b">jx install</code>并选择相关选项，在kubernetes集群上初始化Jenkins-X。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es ku"><img src="../Images/02a00948fbe4146cf593c53304738e8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*G48x6FwfV77HoTqUCnJbJw.png"/></div></figure><p id="57df" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">该步骤执行以下操作:</p><ol class=""><li id="b48c" class="kz la hi jm b jn ki jr kj jv lb jz lc kd ld kh le lf lg lh bi translated">部署<code class="du ko kp kq kr b">tiller</code>，一个带有外部负载平衡器的入口控制器。</li><li id="cd26" class="kz la hi jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">将<code class="du ko kp kq kr b">jenkins-x-platform</code>安装到您的kubernetes集群helm repo中，这将带来大量资源<code class="du ko kp kq kr b">configMaps</code>、<code class="du ko kp kq kr b">deployments</code>、<code class="du ko kp kq kr b">services</code>等。</li><li id="4b9e" class="kz la hi jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">在git中为<code class="du ko kp kq kr b">staging</code>和<code class="du ko kp kq kr b">production</code>分别创建两个存储库，并在jenkins中为每个存储库创建管道。</li></ol><p id="72b8" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在，我们已经准备好使用我们的<code class="du ko kp kq kr b">jenkins-x</code>集群为任何项目执行CI/CD。</p><h1 id="5f0e" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">准备rails项目</h1><p id="655c" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">获取要执行CI/CD的rails应用程序。这甚至不一定是rails，可以是任何web应用程序。您既可以克隆您现有的应用程序，也可以使用<code class="du ko kp kq kr b">rails new &lt;app&gt;</code>从头开始生成一个新的应用程序。为了简单起见，我将创建一个新的应用程序。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es ln"><img src="../Images/15dbdc6fd82c927a9e8989063d08b695.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/1*axlzcme6cqD_YPEWx0UM_g.png"/></div></div></figure><h1 id="7085" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">将您的项目导入Jenkins-X</h1><p id="489e" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">运行<code class="du ko kp kq kr b">jx import &lt;path to app&gt;</code>命令导入您的项目。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es ku"><img src="../Images/aba3c738c2377ff047ec57936d5bd8d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*z8Bc_90X-yGjyb2ujTzzGw.png"/></div></figure><p id="3c0b" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">该步骤执行以下操作:</p><ol class=""><li id="6cf3" class="kz la hi jm b jn ki jr kj jv lb jz lc kd ld kh le lf lg lh bi translated">如果存储库中不存在所需的舵图、Jenkinsfile、Dockerfile，则从模板中复制它们。</li><li id="1702" class="kz la hi jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">为master branch创建jenkins项目和管道，并创建触发Jenkins作业的web-hook。</li><li id="d846" class="kz la hi jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">创建一个拉式请求PR-1，运行检查，合并并创建第一个发布<code class="du ko kp kq kr b">0.0.1</code>给master。</li><li id="92a5" class="kz la hi jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">然后，这将升级为转移，您可以查看转移环境的外观。</li></ol><p id="34d4" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">该命令存在，让事情在后台运行。人们可以跟踪活动、日志等。从上面的命令。例如<code class="du ko kp kq kr b">jx get activity</code>看起来是这样的:</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es ln"><img src="../Images/c2dd16625a383ff37a87ad780e8012f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/1*Pa-70s1FGIazJa0AIm9HHQ.png"/></div></figure><p id="9669" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">使用<code class="du ko kp kq kr b">jx get app</code>检查应用程序的状态。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es ls"><img src="../Images/5f26b7e8f6ae7ba932256907f3699234.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*pGYimU4ltgIPCZjOumohfQ.png"/></div></figure><p id="57e7" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">抓取暂存环境的url，看一看。我的看起来像这样:</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es lt"><img src="../Images/059e88f6d94516a264a135612ac58e9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*ExBXC_9Pr-CGL7CO5inLXQ.png"/></div></figure><p id="82d9" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">看起来不错，现在是时候推广生产了，用<code class="du ko kp kq kr b">jx promote &lt;app&gt;</code>做吧。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es lu"><img src="../Images/016409288999fd77267a25b4d0da8ec1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*F893LzWwluh6PO5TgKmIXw.png"/></div></figure><p id="7854" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">重复<code class="du ko kp kq kr b">jx get app</code>并检查生产url是否有效。太好了！现在是做出改变的时候了，看看如何适应我们的GitOps工作流程。</p><h1 id="17c5" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">更新并发布我们的欢迎页面</h1><p id="13d2" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">让我们进入应用程序，创建一个<code class="du ko kp kq kr b">welcome</code>分支，并创建一个欢迎控制器</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es ku"><img src="../Images/42c5a4c401069b78256c326c8ee6aea1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*OAwUaenDktsx3Jr_X0CRUw.png"/></div></figure><p id="a09f" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">让我们制作一个带有用户名的欢迎信息，并将其作为默认页面。修改控制器、视图和路线。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es lv"><img src="../Images/18d346a605d39e2f6f89ea1c78681adf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*sOPMISCCXfFf3gnT8CpanQ.png"/></div></figure><p id="d31e" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">在您的shell上使用<code class="du ko kp kq kr b">rails server</code>命令进行本地测试。如果看起来不错，那就<code class="du ko kp kq kr b">git push</code>分支<code class="du ko kp kq kr b">welcome</code>分支。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es lw"><img src="../Images/e7ecdc7476099b15710e89a0f786220c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1294/format:webp/1*Dam22nGxfu0324L65IbbJA.png"/></div></figure><p id="17fe" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">然后从<code class="du ko kp kq kr b">ui</code>创建一个拉取请求。我的是github，所以我会点击这个按钮。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lx"><img src="../Images/5341168c8cfc66f7a74f98702fc5c3be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iuoq0s4jxMAFV_lEd95Ckw.png"/></div></div></figure><p id="3215" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在，一个新的<code class="du ko kp kq kr b">PR</code>管道开始生效并验证更改，并创建一个预览环境，您可以从来自<code class="du ko kp kq kr b">ui</code>的pull请求中看到该环境。从拉取请求中，可以看出这一点。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es ly"><img src="../Images/1231e9559c17b1095b20ab8fec47fd91.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/format:webp/1*GXyyvreaT3ZAl6VY8Uv9xQ.png"/></div></figure><p id="a833" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">单击该链接时，</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es lz"><img src="../Images/d14540f759c37ace0a103c20d6d08dae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dpuyaMUc2dydJif57pgU8g.png"/></div></div></figure><p id="a4bc" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">好的，看起来不错，我想合并这个<code class="du ko kp kq kr b">PR</code>，它把这个带到<code class="du ko kp kq kr b">staging</code>。通过<code class="du ko kp kq kr b">jx get build logs</code>和<code class="du ko kp kq kr b">jx get activity</code>可以随时跟踪活动和日志。日志和活动成功结束后，再次检查应用程序状态。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es ma"><img src="../Images/d8651837f30a0a6099cf75ccc1ad7fce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jBJ70mdmBN3otc0oxzxgjw.png"/></div></div></figure><p id="ced4" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">检查暂存环境，然后像之前一样使用<code class="du ko kp kq kr b">jx promote</code>将其升级到生产环境，如果看起来没问题，刷新生产url，瞧！</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="er es mb"><img src="../Images/66b46d5a5142bb6bb3305ee070828b05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s3QvN4IJQOixEpLTCwkxYw.png"/></div></div></figure><p id="4f79" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在，我们用几个命令就完成了从桌面到生产的转变。以及保存在版本控制中的所有配置。那是给你的！</p><h1 id="95ff" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">快速回顾</h1><ol class=""><li id="13de" class="kz la hi jm b jn jo jr js jv mc jz md kd me kh le lf lg lh bi translated">使用<code class="du ko kp kq kr b">jx install</code>将jenkins-x安装到现有的GKE集群</li><li id="b243" class="kz la hi jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">使用<code class="du ko kp kq kr b">jx import</code>将项目导入我们的jenkins-x集群</li><li id="f302" class="kz la hi jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">用<code class="du ko kp kq kr b">jx promote</code>将项目推向生产</li><li id="5879" class="kz la hi jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">做了更改，在本地测试，将更改作为分支推送，创建拉取请求，Jenkins-X自动创建<code class="du ko kp kq kr b">preview</code>环境进行预览。</li><li id="53aa" class="kz la hi jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">接受了<code class="du ko kp kq kr b">PR</code>以自动进行测试。</li><li id="d8f2" class="kz la hi jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">跑了一趟<code class="du ko kp kq kr b">jx promote</code>把我们的新版本从试播推广到生产。</li></ol><h1 id="7bb4" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">常见错误</h1><figure class="kv kw kx ky fd ij"><div class="bz dy l di"><div class="mf mg l"/></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">点击访问要点查看分辨率(嵌入限制)</figcaption></figure><h1 id="9347" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">平台版本</h1><figure class="kv kw kx ky fd ij"><div class="bz dy l di"><div class="mf mg l"/></div></figure><h1 id="255c" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">承认</h1><p id="1d4d" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">来自<code class="du ko kp kq kr b">James Strachen</code>、<code class="du ko kp kq kr b">James Rawlings</code>和其他<code class="du ko kp kq kr b">jx</code>社区成员的大力支持。我在<a class="ae kn" href="http://kubernetes.slack.com" rel="noopener ugc nofollow" target="_blank"> Slack </a> <code class="du ko kp kq kr b">#jenkins-x-user</code>和<code class="du ko kp kq kr b">#jenkins-x-dev</code>渠道得到了这些专家的全天候支持。向那些家伙脱帽致敬！</p><h1 id="d209" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">参考</h1><ol class=""><li id="fe58" class="kz la hi jm b jn jo jr js jv mc jz md kd me kh le lf lg lh bi translated">在GKE集群上安装helm，快速动手—<a class="ae kn" rel="noopener" href="/@maniankara/helm-on-gke-cluster-quick-hands-on-guide-ecffad94b0">https://medium . com/@ manian Kara/helm-on-gke-cluster-quick-hands-on-guide-ecffad 94 b 0</a></li><li id="caa1" class="kz la hi jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">詹金斯文档—<a class="ae kn" href="https://jenkins-x.io/documentation/" rel="noopener ugc nofollow" target="_blank">https://jenkins-x.io/documentation/</a></li><li id="11a9" class="kz la hi jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated"><a class="ae kn" href="https://jenkins-x.io/articles/" rel="noopener ugc nofollow" target="_blank">https://jenkins-x.io/articles/</a></li></ol></div></div>    
</body>
</html>