<html>
<head>
<title>MySQL Major Version upgrade with Google’s Database Migration Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MySQL的主要版本升级与谷歌的数据库迁移服务</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/mysql-major-version-upgrade-with-googles-database-migration-service-744cf8478e26?source=collection_archive---------1-----------------------#2021-08-06">https://medium.com/google-cloud/mysql-major-version-upgrade-with-googles-database-migration-service-744cf8478e26?source=collection_archive---------1-----------------------#2021-08-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="75d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望你们现在都知道，去年11月，当谷歌的数据库迁移服务面向MySQL正式发布时，<a class="ae jd" href="https://cloud.google.com/blog/products/databases/database-migration-service-now-available-for-cloud-sql-and-more" rel="noopener ugc nofollow" target="_blank">迁移SQL数据库</a>变得更加容易。如果您不知道，将您的SQL数据库迁移到云SQL现在更容易了！您可能已经注意到了，或者如果您没有注意到，我会很高兴地指出，数据库迁移服务允许您从许多不同的来源获取数据，包括内部资源、AWS，甚至用于MySQL的云SQL。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/cf3e23218e4ed8768c876d14a9873244.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/0*Z4wV7StPmZXHLWNt"/></div></figure><p id="c9d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">侧面插件——我们刚刚宣布<a class="ae jd" href="https://cloud.google.com/architecture/postgresql-migration-with-database-migration-service" rel="noopener ugc nofollow" target="_blank"> DMS支持云SQL for PostgreSQL </a>作为源，因此您也可以使用DMS进行PostgreSQL主版本升级。但是这个帖子是关于MySQL的…</p><p id="ca1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我还想说点别的……请注意，它出现在DMS流程的“创建目的地”页面上:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es jm"><img src="../Images/bb0883f8c6ca1461558a7445255d5e5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/0*bd4f7JukJCKixfRZ"/></div></figure><p id="4d48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以，如果你一直在这里，我告诉你，你也可以使用DMS来做你的MySQL数据库的主要版本升级。当然，我们仍然会屏住呼吸等待就地升级，但是当我们等待的时候，这是一个很好的选择。</p><p id="c837" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里面有猫腻，因为当然有。这里的关键是，因为我们使用迁移工具来升级，所以有两个方面的复杂性需要处理。我们有迁移部分和升级部分。DMS有助于管理大量此类问题，但仍有一些事情需要考虑。在这篇文章中，我将把你需要考虑的所有问题集中在一起，并链接到你需要使用数据库迁移服务对MySQL进行主要版本升级的所有内容。</p><h1 id="d4f7" class="jn jo hi bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">我们为什么在这里？</h1><p id="f3e7" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">只是为了解释为什么你可能想首先升级MySQL。在性能升级和功能更新之间，有很多理由这样做。如果你需要说服力，这里有一个MySQL 8.0 中<a class="ae jd" href="https://dev.mysql.com/doc/refman/8.0/en/mysql-nutshell.html" rel="noopener ugc nofollow" target="_blank">增强的好列表。房间里还有一只大象:今年二月，官方宣布5.6已经过时了。您可能在过去的8年里一直使用5.6，今年看到它正式停止使用，并有点恐慌。这里的好消息是，云SQL将在更长时间内支持5.6，但这并不意味着现在不是升级的好时机。</a></p><h1 id="7556" class="jn jo hi bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">版本兼容性</h1><p id="3afa" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">首先要看的是你要在哪个版本之间升级。所以5.6到5.7或者5.7到8.0。5.6到8.0就出来了。MySQL在主要版本之间有很大的变化，这些变化可能会破坏兼容性，因此您需要对数据库进行三重检查，以发现一些不兼容的变化。</p><p id="84c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，在5.6和5.7之间，您需要留意5.6数据库中“INFORMATION_SCHEMA”表中的任何系统或状态变量。这些都被5.7.6中的性能模式表所取代。还有很多小问题，比如如果您有一个数据类型为YEAR(2)的列，您需要将所有这些值更新为一个4位数的YEAR列，然后才能再次使用这些列。如果你要从5.6升级到5.7，你可以在这里查看完整的变化列表。</p><p id="0205" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在5.7和8.0之间，当然还会有更多的变化需要关注。对我来说，最大的问题是默认标志在两者之间改变了很多。虽然它们中的许多可能不会因为分段错误而导致问题，但是它们可能会在您的应用程序中导致一些意外的行为。此外，您可能想要查看一下AUTO_INCREMENT列。对于FLOAT和DOUBLE类型，不赞成使用它。要查看这两个版本之间变化的完整列表，请点击这里查看<a class="ae jd" href="https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="62b0" class="jn jo hi bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">将这些点连接起来</h1><p id="6f8d" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">如果您计划从一个云SQL实例到另一个云SQL实例进行主要版本升级，您可以跳过这一部分，因为您已经完成了我将要谈到的内容。但是，如果您正在从内部数据库，或者在一些小的边缘情况下，从GCE(虚拟机)实例转换到云SQL，那么需要注意一些额外的事情。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kq"><img src="../Images/e4c320d2991bef60082942d252b0309f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cqPzmEFiTXPfJ5sK"/></div></div></figure><p id="877a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一件事是延迟。如果您已经习惯了从数据库获得近乎即时的响应，因为它就在您的应用程序旁边，那么请做好被唤醒的准备。除非您的应用程序也位于云中，否则现在会有一些额外的时间在您的应用程序和数据库之间传递。这可能完全没问题！或者，它可能会在应用程序中引入一些很难调试的重入错误。我的一个同事写了一篇很棒的帖子，涵盖了当你将数据库迁移到另一个来源的云SQL时需要注意的所有事情和潜在的变化<a class="ae jd" href="https://cloud.google.com/blog/topics/developers-practitioners/preparing-your-mysql-database-migration-database-migration-service" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="1de3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第二个问题是，我现在如何访问我的数据库？！网络连接可能非常困难。防火墙、路由和DNS都可能会带来麻烦。在此之前，您已经很好地连接了所有的东西，而现在，突然之间，您的数据库(可能)位于互联网上完全不同的地方，有着不同的连接需求。这个特别的兔子洞我已经挖得很深了。我在这里写了一篇关于使用数据库迁移服务<a class="ae jd" href="https://cloud.google.com/blog/topics/developers-practitioners/database-migration-service-connectivity-technical-introspective" rel="noopener ugc nofollow" target="_blank">将源实例连接到目标实例的深度博文。如果你遇到了连接问题，这篇文章应该涵盖了大多数情况。</a></p><h1 id="f5d7" class="jn jo hi bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">更多迁徙！</h1><p id="1161" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">DMS使移动过程中的数据变得容易，但是由于我们依赖于数据库引擎的本机迁移机制，我们也受到它的限制。这意味着一旦您完成了数据库的迁移，无论它来自哪里，都有一些步骤需要完成。比如你知道，你的IP地址会变。因为我们使用迁移方法来升级我们的版本，所以我们实例化了一个新的实例。一旦我们进行了就地升级，这就不是问题了，但同时我们必须记住更新任何应用程序、负载平衡器等指向旧IP地址的应用程序。</p><p id="1632" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一件事是，不要忘记，您的用户存储在系统表中，也不会被迁移。一旦DMS部分完成，就需要将它们带过来。还有一些零碎的东西，这里有一个完整的帖子<a class="ae jd" href="https://cloud.google.com/blog/topics/developers-practitioners/closing-gap-migration-completeness-when-using-database-migration-service" rel="noopener ugc nofollow" target="_blank"/>，列出了在你的新实例可以使用之前你需要完成的事情。</p><h1 id="9cdc" class="jn jo hi bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">下一步是什么？</h1><p id="3b6b" class="pw-post-body-paragraph if ig hi ih b ii kl ik il im km io ip iq kn is it iu ko iw ix iy kp ja jb jc hb bi translated">现在您已经设置好了新升级的实例，是时候为生产做准备了。在云SQL实例完全上线之前，您可能需要设置一些东西。</p><p id="5be7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，默认情况下，仅SSL连接是关闭的，我们知道许多组织都强制使用仅SSL连接。这需要在服务器上启用，并且需要设置证书。这可以在数据迁移之后、DMS目标实例升级之前完成。</p><p id="da46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">灾难恢复是生产实例的另一个必备组件。这也是我们保证正常运行时间的SLA的要求。绝对需要设置这个。如果您编辑您的实例，它将出现在主概览页面上:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es kv"><img src="../Images/a35fcf6fe559a4598fad0ff989dc0afe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/0*kzvTFWDI_SionAeO"/></div></figure><p id="a595" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置为“多个区域”可启用此功能。</p><p id="88ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">读取副本也属于这一类别。优化您的数据基础架构以支持您的应用至关重要，这是其中不可或缺的一部分。如果您有一个读取量很大的应用程序，那么您也需要在游戏的这个阶段设置读取副本。</p><p id="af6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">只有在DMS流程结束时提升实例后，才能设置高可用性和读取副本。</p><p id="7d3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我离开你之前还有最后一点。您已经完成了将实例升级到下一版本的所有工作。您已经设置了所有需要的额外部分。您已经连接了您的应用程序，它完全可以与您的数据库对话。现在不是按下按钮的时候。这对于许多阅读这篇文章的人来说可能是显而易见的。但我还是要说。测试！测试所有的东西。测试所有你能想到的边缘案例。测试任意增加系统的延迟，以确保您可以处理应用程序和数据库之间的随机互联网延迟峰值。高可用性特性一旦启用，您就可以<a class="ae jd" href="https://cloud.google.com/blog/topics/developers-practitioners/testing-cloud-sql-failover-where-begin" rel="noopener ugc nofollow" target="_blank">测试自动故障转移</a>来模拟您的主实例停止运行，回退实例接管。所以测试一下。测试所有这些场景，以确保您可以顺利启动新的主要版本SQL实例。</p><p id="f0bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这些都有助于指导您成功地使用数据库迁移服务将您的MySQL实例升级到新版本！如果您有问题或意见，请随时在下面评论或在<a class="ae jd" href="https://www.twitter.com/GabeWeiss_" rel="noopener ugc nofollow" target="_blank">推特</a>上联系我，我的DMs是开放的！感谢阅读。</p></div></div>    
</body>
</html>