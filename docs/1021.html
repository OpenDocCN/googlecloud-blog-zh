<html>
<head>
<title>Using Cloud Scheduler and Cloud Functions to Deploy a Periodic Compute Engine VM Worker.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用云调度程序和云功能部署定期计算引擎虚拟机工作程序。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-cloud-scheduler-and-cloud-functions-to-deploy-a-periodic-compute-engine-vm-worker-2b897ef68dc5?source=collection_archive---------0-----------------------#2019-06-06">https://medium.com/google-cloud/using-cloud-scheduler-and-cloud-functions-to-deploy-a-periodic-compute-engine-vm-worker-2b897ef68dc5?source=collection_archive---------0-----------------------#2019-06-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/ccbed195965a1bbed4475f850e822fe6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VyjCwffRgNKL5D7dzTw9Iw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">文章的架构图</figcaption></figure><div class=""/><p id="dc80" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在本文中，我们使用云调度器来定期启动和关闭计算引擎(GCE)工作器。云调度程序将定期轮询云功能，该云功能将实例化一个工作计算引擎虚拟机，该虚拟机将执行一些工作，直到调度程序通知云功能将其关闭。对于我们的例子，我们将让云调度程序每10分钟运行一次，轮询云函数来执行它的任务。</p><h1 id="3674" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">体系结构</h1><p id="984a" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated"><strong class="iw hy">Cloud Scheduler:</strong>Google Cloud Scheduler是一个基于cron的解决方案，面向寻求在任何GCP服务中设置某种形式的cron功能的工程师。<strong class="iw hy"> </strong>我们将手动创建一个cron，它点击触发整个构建过程的云函数HTTP端点。<br/> <strong class="iw hy">云函数:</strong>创建GCE实例的大部分逻辑将保存在云函数中。我们将使用Golang GCP API来执行这些调用；但是如果你不熟悉围棋，不要担心，我会对我的代码进行大量注释。这是我在文章结尾提供的。<br/> <strong class="iw hy">计算引擎实例:</strong>云函数将创建一个执行一些工作的GCE实例。在我们这个简单的例子中，我们将把启动和关闭脚本附加到VM上，这样每当VM启动或停止时，它将写入根文件夹中的一个<code class="du kw kx ky kz b"><strong class="iw hy">work.txt</strong></code>文件。这将让我们知道虚拟机实际上已经启动并做了一些工作。在您的情况下，它可以运行一些分析，或者您想要完成的任何批处理作业。我们的实例将被抢占以节省成本。</p><p id="7b77" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们开始吧。</p><h1 id="a882" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">1.创建服务帐户</h1><p id="e11b" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">我们需要一个服务帐户(SA)，云功能使用它来代表我们<em class="la">(用户)</em>管理虚拟机的创建、启动和停止。没有它，云功能将不会被授权这样做。在我的例子中，我称SA为<code class="du kw kx ky kz b"><strong class="iw hy">compute-admin-sa</strong></code>，我给它一个描述以更好地识别它的角色<em class="la">(图1) </em>。</p><figure class="lc ld le lf fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lb"><img src="../Images/f3afec73b36d3d073bdaae2c711ac9eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xB0YKHz1qO9ndHm_nYzcUQ.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><strong class="bd ju">图1: </strong>创建服务帐户</figcaption></figure><h2 id="4096" class="lg jt hx bd ju lh li lj jy lk ll lm kc jf ln lo kg jj lp lq kk jn lr ls ko lt bi translated">1.2应用服务帐户权限。</h2><p id="c9f9" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">在这一步中，我们定义服务帐户将拥有的权限。我给了它计算管理员角色，授予它对计算引擎的完全控制权。在您的情况下，您可以更加细化范围。在这一步之后，我们创建了云函数。</p><figure class="lc ld le lf fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lu"><img src="../Images/e6ce03bce69eb67948531425cecd900a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uGNyWiZfDVj3rzrPV3dcig.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><strong class="bd ju">图2: </strong>将角色应用到服务帐户</figcaption></figure><h1 id="8c5e" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">2.创建云函数</h1><p id="73ea" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">导航到云函数页面。单击创建函数。</p><figure class="lc ld le lf fd hk er es paragraph-image"><div class="er es lv"><img src="../Images/f09bf50d52e73814268b5ef172fa3480.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/format:webp/1*ziXbTeOr0oUesuJ1GU2o8g.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><strong class="bd ju">图3: </strong>创建云函数(名称、描述和触发器)</figcaption></figure><p id="02d5" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">创建一个函数，我们给它一个描述性的名字。<code class="du kw kx ky kz b"><strong class="iw hy">worker-instance-cloud-function</strong></code>。让我们确保触发器是HTTP，因为我们将使用Cloud Scheduler调用这个HTTP URL。<br/>接下来复制提供的URL。这将是云调度程序调用该函数的方式。</p><p id="fa19" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">接下来，我们选择运行时。我喜欢我的函数逻辑，所以围棋1.11是合适的。</p><figure class="lc ld le lf fd hk er es paragraph-image"><div class="er es lw"><img src="../Images/a34ead2cc9b61b681400f44d07bf8f4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*9tUxr2SA0PKQC6h5ddg6GA.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><strong class="bd ju">图4: </strong>创建云函数(区域和环境变量)</figcaption></figure><p id="b9e7" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">接下来，我们选择要执行的函数。在我的例子中，它叫做<code class="du kw kx ky kz b"><strong class="iw hy">DeployInstance</strong></code> <strong class="iw hy"> </strong> <em class="la">(见页面底部的代码)</em></p><p id="a3b7" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们选择一个区域，通常我们应该选择一个靠近我们的云调度程序和计算引擎实例的区域，在我们的例子中，us-central1起作用。</p><p id="829a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后，让我们选择服务帐户。我们使用之前创建的那个。</p><p id="2c77" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在环境变量部分，我的代码使用了4个核心变量。<code class="du kw kx ky kz b"><strong class="iw hy">PROJECT_ID</strong></code>、<code class="du kw kx ky kz b"><strong class="iw hy">REGION</strong></code>、<code class="du kw kx ky kz b"><strong class="iw hy">ZONE</strong></code>、<code class="du kw kx ky kz b"><strong class="iw hy">INSTANCE_NAME</strong></code>、<strong class="iw hy">、</strong>用你想要的变量填充这些。确保它们是正确的。</p><p id="db25" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">最后<strong class="iw hy">点击创建</strong></p><p id="1bb3" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">部署后，您应该有一个类似的UI，如下面的图5所示</p><figure class="lc ld le lf fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lx"><img src="../Images/eab970a768a1d71161928109066f81ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dJ_HVsS18tq3KTf41gD_iw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><strong class="bd ju">图5: </strong>云调度器在您创建了调度之后</figcaption></figure><h1 id="fe70" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">创建云调度程序</h1><p id="5965" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">是时候创建我们的调度器了<em class="la">(图6) </em>。</p><figure class="lc ld le lf fd hk er es paragraph-image"><div class="er es ly"><img src="../Images/8f4b58f953fc814583e5b4df6b3732ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*LplfhHM_eL6a6uwzNCzlrw.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><strong class="bd ju">图6: </strong>创建云计划</figcaption></figure><p id="f962" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们提供一个独特的描述性名称以及令人信服的描述。我把它命名为<code class="du kw kx ky kz b"><strong class="iw hy">worker-instance-batchwork-scheduler</strong></code> <strong class="iw hy">。</strong></p><p id="bcb4" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">接下来，让我们将调度程序设置为每10分钟一次。云调度程序使用熟悉的Linux Cron语法。在我们的例子中，它是<code class="du kw kx ky kz b"><strong class="iw hy">*/10 * * * *</strong></code></p><p id="21d7" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">接下来，为了统一，将时区设置为与云函数区域相似的时区。</p><p id="87a0" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">接下来，将目标设置为HTTP，并粘贴到创建云函数时获得的云函数URL中。然后选择<code class="du kw kx ky kz b"><strong class="iw hy">GET</strong></code>作为HTTP方法，因为我们只想调用函数，不传入任何数据。</p><h1 id="c436" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">运行时间表</h1><p id="52fa" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">我们可以运行该计划以查看它是否有效，在云计划程序页面上，单击立即运行<em class="la">(图7) </em>，如果它尚未运行<em class="la">(或者您可以等待10分钟)</em></p><figure class="lc ld le lf fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lz"><img src="../Images/0392f966292e9b4c305ea21a8c5097ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6KeMTGXNfPywcHDdJVQvTw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><strong class="bd ju">图7: </strong>云调度器当您创建了调度之后</figcaption></figure><p id="ca5f" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果调用成功，您应该看到右边的结果列显示成功<em class="la">(图8) </em></p><figure class="lc ld le lf fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ma"><img src="../Images/638a3c2b284b1108430bcd318c31a1dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U-SUhQE23JUCGCWW342Cww.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><strong class="bd ju">图8: </strong>对云函数的成功调用</figcaption></figure><p id="ba3a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们导航到计算引擎页面。最初，您应该会在图9 中看到以下内容</p><figure class="lc ld le lf fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mb"><img src="../Images/c6651d468dc3f130497918ebfe5e8034.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pp8lroNBnmhDK-sz9lExcw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><strong class="bd ju">图9: </strong>最初没有计算引擎虚拟机</figcaption></figure><p id="2b01" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">过了一会儿，我们应该看到我们的虚拟机出现了<em class="la">(图10) </em>！</p><figure class="lc ld le lf fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mc"><img src="../Images/3ede07b0bf5aa9f0417781b4363098fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mhl2vkLN2TYgmYAlNnSmNg.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><strong class="bd ju">图10: </strong>片刻之后，worker-instance-01正在创建</figcaption></figure><p id="8fc8" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">启动和关闭脚本会写入一个文件，并显示虚拟机处于<code class="du kw kx ky kz b"><strong class="iw hy">STARTED </strong></code>或<code class="du kw kx ky kz b"><strong class="iw hy">STOPPED</strong></code>的时间。这一点我们可以借鉴。</p><p id="0226" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我让时间表整夜运行，这是我们在查看云函数时得到的结果。我们可以看到每10分钟利用率的周期性峰值，显示我们的功能正在执行<em class="la">(见图11) </em></p><figure class="lc ld le lf fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es md"><img src="../Images/82ea32da00ec89fd661ddb9932004a0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gwr4Qn0VsFPotq6EDVdu6Q.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><strong class="bd ju">图11: </strong>云功能周期性利用</figcaption></figure><p id="bd16" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这里是<code class="du kw kx ky kz b"><strong class="iw hy">work.txt.</strong></code>的输出</p><figure class="lc ld le lf fd hk er es paragraph-image"><div class="er es me"><img src="../Images/b85a1b5c0b221defe9fa22268d667dee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*xamVNqJdE7igI02EVV1R0g.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><strong class="bd ju">图12:</strong>work . txt文件以及从开始到结束的所有日志以及时间</figcaption></figure><h1 id="a506" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">结论</h1><p id="dd0d" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">我们已经有了，我们已经将云调度程序、云功能和计算引擎整合在一起。</p><h2 id="f68f" class="lg jt hx bd ju lh li lj jy lk ll lm kc jf ln lo kg jj lp lq kk jn lr ls ko lt bi translated">密码</h2><p id="8e55" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated"><a class="ae kv" href="https://github.com/martinomburajr/medium/blob/master/gcp/architecture/scheduler-functions-compute-startupscript/cloudfunctions/cloudfunctions.go" rel="noopener ugc nofollow" target="_blank"> GitHub链接</a>(太长，无法粘贴到本文档中)</p><h1 id="2c95" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">附加链接</h1><p id="8a23" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated"><strong class="iw hy">启动脚本</strong></p><figure class="lc ld le lf fd hk"><div class="bz dy l di"><div class="mf mg l"/></div></figure><p id="d517" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">可抢占的虚拟机</strong></p><figure class="lc ld le lf fd hk"><div class="bz dy l di"><div class="mf mg l"/></div></figure></div></div>    
</body>
</html>