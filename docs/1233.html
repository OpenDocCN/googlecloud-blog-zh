<html>
<head>
<title>Building a Dashboard for a data processing pipeline using the Stackdriver Dashboard API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Stackdriver Dashboard API为数据处理管道构建仪表板</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/part-1-building-a-dashboard-for-a-data-processing-pipeline-with-the-stackdriver-dashboard-api-3cb14a27cd59?source=collection_archive---------0-----------------------#2019-12-26">https://medium.com/google-cloud/part-1-building-a-dashboard-for-a-data-processing-pipeline-with-the-stackdriver-dashboard-api-3cb14a27cd59?source=collection_archive---------0-----------------------#2019-12-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4ccd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是2部分系列的第1部分。</p><ul class=""><li id="89b5" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">第1部分:介绍了如何确定推荐用于数据处理管道的Stackdriver监控指标</li><li id="1fa5" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><a class="ae jr" rel="noopener" href="/@charles.baer/part-2-building-a-dashboard-for-a-data-processing-pipeline-with-the-stackdriver-dashboard-api-69e3260b5ec3">第2部分</a>:介绍如何使用Stackdriver Dashboards API 从JSON模板中实现第1部分中描述的图表和仪表板。</li></ul><h1 id="ae61" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">仪表板中应该显示什么</h1><p id="44d0" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">我花了很多时间与正在使用或正在考虑如何使用Stackdriver的DevOps和SRE团队交谈。我收到的一个一致的问题是应该监控哪些指标。</p><p id="5199" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我所见过的关于这个主题的最好的全面指导来自于《网站可靠性工程》一书，在<a class="ae jr" href="https://landing.google.com/sre/sre-book/chapters/monitoring-distributed-systems/" rel="noopener ugc nofollow" target="_blank">第6章——监控分布式系统</a>下。在本章中，他们讨论了您应该考虑在系统中监控的“四个黄金信号”。</p><p id="e8a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">四个黄金信号是:</p><ol class=""><li id="c753" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc kv jj jk jl bi translated"><strong class="ih hj">延迟</strong> —服务完成一个请求所需的时间</li><li id="404c" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kv jj jk jl bi translated"><strong class="ih hj">流量</strong> —有多少需求是针对你的服务的</li><li id="473d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kv jj jk jl bi translated"><strong class="ih hj">错误</strong> —您的服务失败的比率</li><li id="d7b7" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kv jj jk jl bi translated"><strong class="ih hj">饱和度</strong> —衡量服务资源接近完全利用的程度</li></ol><p id="9dd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当考虑要在系统甚至数据处理管道中监控的重要指标时，可以使用这些监控类别。出于监控的目的，您可以将管道视为要监控的“服务”。这意味着您可以考虑每个产品组件中的指标，以及如何将这些指标应用于“四个黄金信号”。在本文的剩余部分，我将介绍如何将度量映射到图表，例如部署在GCP的数据处理管道。</p><h1 id="5b7e" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">样本数据处理管道</h1><p id="b5f2" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">我基于本<a class="ae jr" href="https://github.com/GoogleCloudPlatform/gcf-gce-usage-monitoring" rel="noopener ugc nofollow" target="_blank">参考指南</a><em class="kw">使用云函数和Stackdriver </em>监控计算引擎足迹，为BigQuery 的<a class="ae jr" href="https://cloud.google.com/dataflow/docs/guides/templates/provided-streaming#pubsub-topic-to-bigquery" rel="noopener ugc nofollow" target="_blank"> PubSub主题添加一个简单的云数据流模板，扩展了一个示例数据处理管道。《参考指南》中描述的体系结构构建了一个计算引擎实例清单，然后将结果写入Stackdriver Monitoring。</a></p><p id="4414" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，云函数只是我们的发布/订阅、云数据流和BigQuery数据处理管道的一个数据源。该架构由一系列通过发布/订阅连接的云函数组成，这些云函数将结果写入Stackdriver Monitoring。添加云数据流组件允许我将结果写入BigQuery，除了Stackdriver监控之外，还可以用于这个管道示例。</p><p id="0cb6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出于本例的目的，我将重点放在监控Pub/Sub入口点、云数据流和BigQuery组件的指标上，它们在下图的红框中突出显示。</p><figure class="ky kz la lb fd lc er es paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="er es kx"><img src="../Images/939b6223bf1d77fafc2ab6717d6f5f90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n8TdKtK3zY5Ka0eWAs2uIg.png"/></div></div></figure><p id="24f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以将此管道归纳为以下步骤:</p><ol class=""><li id="4440" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc kv jj jk jl bi translated">将度量数据发送到发布/订阅主题</li><li id="6e34" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kv jj jk jl bi translated">从云数据流中的发布/订阅订阅接收数据</li><li id="8560" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kv jj jk jl bi translated">将结果写入BigQuery</li></ol><p id="1ddb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了“四个黄金信号”监控框架和简单的数据处理管道，我可以在接下来的部分中就具体的指标以及应该监控哪些监控信号提出建议。</p><p id="9276" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的屏幕截图显示了仪表板上的6个不同图表，涵盖了数据处理流程。</p><figure class="ky kz la lb fd lc er es paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="er es lj"><img src="../Images/2734ca2c9bccabca5a0f1559d53cc15b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0eCfrdWzJi8fumDJkFW9zQ.png"/></div></div></figure><h1 id="726f" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">交通</h1><p id="bb00" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">流量表示在给定时间内有多少请求得到服务。衡量流量的常用方法是每秒请求数。我选择为数据处理管道架构(Pub/Sub、Cloud Dataflow和BigQuery)中的3种技术构建3个不同的图表，以使其更容易阅读，因为y轴刻度对于每个指标来说是不同的数量级。为了简单起见，您可以选择将它们包含在一个图表中。</p><h1 id="b8ce" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">数据流交通图</h1><p id="c6f0" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">Stackdriver Monitoring为云数据流提供了许多不同的指标，您可以在指标<a class="ae jr" href="https://cloud.google.com/monitoring/api/metrics_gcp#gcp-dataflow" rel="noopener ugc nofollow" target="_blank">文档</a>中找到。大体上，它们被分为总体工作指标，如<code class="du lk ll lm ln b">job/status</code>或<code class="du lk ll lm ln b">job/total_vcpu_time</code>，以及处理指标，如<code class="du lk ll lm ln b">job/element_count</code>和<code class="du lk ll lm ln b">job/estimated_byte_count</code>。</p><p id="aeb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们希望监控通过云数据流的流量，所以代表“<em class="kw">到目前为止添加到pcollection的元素数量</em>”的<code class="du lk ll lm ln b">job/element_count</code>非常适合测量流量。重要的是，度量将随着流量的增加而增加。因此，这是一个用于理解进入管道的流量的合理指标。</p><p id="ba30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的屏幕截图显示了仪表盘中的云数据流流量图表。</p><figure class="ky kz la lb fd lc er es paragraph-image"><div class="er es lo"><img src="../Images/efd3af32f7a79b209e9ef58406700899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*RmAWLUbMbteUcgC_SR0EJw.png"/></div></figure><h1 id="4cad" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">发布/订阅交通图</h1><p id="6876" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">发布/订阅的堆栈驱动程序监视指标分为主题、订阅和快照指标。订阅和主题度量都可以用于绘制流量图表，因为它们表示发布到发布/订阅的消息的两端。</p><p id="fd4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我想查看传入流量，所以查看接收数据的入站主题的指标是一个合理的选择。具体来说，<code class="du lk ll lm ln b">topic/send_request_count</code>表示“<em class="kw">发布请求的累积计数，按结果分组”</em>与测量流量非常一致。</p><p id="ee31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的屏幕截图显示了仪表板中的发布/订阅流量图表。</p><figure class="ky kz la lb fd lc er es paragraph-image"><div class="er es lp"><img src="../Images/b6cde528db95ee80e110c3ad3350a903.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*YlSefRYoDpbOF2T-UaOuDg.png"/></div></figure><h1 id="3fdd" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">BigQuery流量图表</h1><p id="ac78" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">BigQuery的Stackdriver监控指标分为bigquery_project、bigquery_dataset和查询指标。</p><p id="f546" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我希望看到传入流量，所以查看与上传数据相关的指标是一个合理的选择。具体来说，<code class="du lk ll lm ln b">storage/uploaded_bytes</code>非常适合测量BigQuery的传入流量。</p><p id="ac7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的屏幕截图捕获了仪表板中的BigQuery流量图表。</p><figure class="ky kz la lb fd lc er es paragraph-image"><div class="er es lq"><img src="../Images/5ce2baf90308a6a9fdf946a5e5a8b3c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/1*354Gr-B29N9S7yuaReQ5Qg.png"/></div></figure><h1 id="f52b" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">潜伏</h1><p id="e2ff" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">延迟表示在给定时间内处理一个请求需要多长时间。衡量延迟的一种常用方法是以秒为单位计算服务一个请求所需的时间。在这个具有发布/订阅、大查询和云数据流的示例架构中，可能有助于理解延迟的指标可以指示通过云数据流或云数据流中的步骤需要多长时间，消息在发布/订阅中未被确认需要多长时间，以及将记录插入大查询需要多长时间。</p><h1 id="3f0f" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">系统滞后图表</h1><p id="5b40" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">因为我想看看服务请求所需的时间，所以查看与处理时间和滞后区域相关的指标是合理的选择。具体而言，表示由管道完全处理的最近数据项的年龄(自事件时间戳起的时间)的<code class="du lk ll lm ln b">job/data_watermark_age</code>和表示以秒为单位的数据项等待处理的当前最大持续时间<em class="kw">的<code class="du lk ll lm ln b">job/system_lag</code>与测量通过云数据流管道处理所花费的时间一致。</em></p><p id="c415" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的屏幕截图捕捉了仪表板中的云数据流系统滞后图表。</p><figure class="ky kz la lb fd lc er es paragraph-image"><div class="er es lr"><img src="../Images/63f4803e5319f3dbd97b5b4ff3ee887f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/1*0E8NxzM7C6fIzzNTZbT3aQ.png"/></div></figure><h1 id="b6a4" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">浸透</h1><p id="ca52" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">饱和度表示运行服务的资源的利用率。饱和度是指监控一个指标，该指标显示系统何时可能开始受限。在这个具有发布/订阅、大查询和云数据流的示例架构中，可能有助于理解饱和度的指标是最早的未确认消息(如果处理速度变慢，则消息将在发布/订阅中保留更长时间)，在云数据流中，是数据的水印年龄(如果处理速度变慢，则消息将需要更长时间才能通过管道)。</p><h1 id="9c7c" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">饱和度图表</h1><p id="b47a" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">因为我想知道服务何时接近所提供的容量，所以我可以做的一个假设是，当系统接近完全利用其资源时，处理给定消息的时间将会变慢。一般来说，数据处理流水线的情况可能并不总是如此。因为我是用发布/订阅和云数据流异步处理的，所以这个假设是合理的。</p><p id="35c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">具体来说，我们上面使用的<code class="du lk ll lm ln b">job/data_watermark_age</code>和代表主题中最早未确认消息的<em class="kw">年龄(以秒计)的<code class="du lk ll lm ln b">topic/oldest_unacked_message_age_by_region</code>与测量云数据流处理时间和管道从发布/订阅接收/确认输入消息的时间的增加非常一致。</em></p><p id="ff7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的屏幕截图显示了仪表板中发布/订阅和云数据流的饱和度图表。</p><figure class="ky kz la lb fd lc er es paragraph-image"><div class="er es lp"><img src="../Images/3ae3a16503d2faf012226a454536574d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*4uV8SV75Hbapbnl9fyYiXg.png"/></div></figure><h1 id="51af" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">错误</h1><p id="3895" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">错误表示应用程序错误、基础设施错误或故障率。这里的要点是监控一个指标，当遇到错误时，该指标显示错误率增加。在这个具有发布/订阅、大查询和云数据流的示例架构中，可能有助于理解饱和度的指标是发布/订阅、云数据流和大查询的日志中报告的错误。</p><h1 id="d11f" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">数据处理管道错误图表</h1><p id="34ee" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">因为我希望看到服务的错误率，所以我可以查看体系结构中包含的服务的日志中报告的错误。</p><p id="88d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">具体来说，代表特定于3个服务中的每一个的“<em class="kw">数量的日志条目</em>”的<code class="du lk ll lm ln b">log_entry_count</code>与测量错误数量的增加非常一致。</p><p id="6016" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的屏幕截图捕获了仪表板中发布/订阅、云数据流和BigQuery的错误图表。</p><figure class="ky kz la lb fd lc er es paragraph-image"><div class="er es ls"><img src="../Images/c8bfed63fc61f14cef1432051bad4796.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/1*IKgL96LJXeaC9m8J9yF-TA.png"/></div></figure><h1 id="b5b9" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">使用仪表板</h1><p id="b610" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">在本文中，我描述了一种基于“四个黄金信号”为数据处理管道选择指标的方法。您可以在Stackdriver监控控制台的Dashboards部分中轻松地手工构建这个仪表板。然而，更好的方法是使用仪表板模板。阅读本系列的第2部分，了解如何从JSON模板部署这个仪表板。</p></div></div>    
</body>
</html>