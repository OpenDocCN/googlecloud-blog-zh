<html>
<head>
<title>Nuts and bolts of NEGs(Network Endpoint groups) in GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP neg(网络端点组)的基本情况</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/nuts-and-bolts-of-negs-network-endpoint-groups-in-gcp-35b0d06f4691?source=collection_archive---------0-----------------------#2022-09-20">https://medium.com/google-cloud/nuts-and-bolts-of-negs-network-endpoint-groups-in-gcp-35b0d06f4691?source=collection_archive---------0-----------------------#2022-09-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b6b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">网络端点组将部署在多个环境中的后端服务聚合在谷歌云负载平衡器下，以利用谷歌提供的卓越网络性能和安全性。它们支持多种用例，并且对NEGs的良好理解对于构建您的服务部署非常重要。</p><h1 id="2623" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">介绍</h1><p id="148e" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">传统上，负载平衡器跨实例分发和平衡请求。通常，负载平衡器会将一组运行在不同物理机或虚拟机上的类似服务置于前端，根据负载分配算法分配流量。这些负载平衡器假定每个实例有一个服务，直到容器时代都是如此。容器和基于容器的工作负载改变了应用服务的运行方式。整个应用程序服务可以打包成一个映像，并通过监听特定端口在任何地方运行。基于容器的服务的多个实例也可以扩展到在同一个实例上运行。随着基于容器的工作负载多年来越来越受欢迎和采用，支持可伸缩应用程序服务监听端口的概念变得至关重要，无论它们在哪个实例中运行。因此引入了网络端点组(也称为NEGs)来代表一组监听端口的可伸缩服务。简而言之，NEG使我们能够从基于实例的负载平衡跨越到基于服务的负载平衡器。</p><p id="faca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些neg通常被配置为一组可扩展的服务，位于GCP的负载平衡器之后，以便可以通过单个端点到达它们。此外，这些neg支持在GCP之外运行的服务(内部或不同的云提供商)利用Google前端和CDN网络的卓越功能。GCP支持不同类型的neg，以支持不同的工作负载。</p><h1 id="8a12" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">GCP的否定类型</h1><p id="1aae" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">让我们看看GCP不同类型的网络端点组。</p><p id="2323" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">区域否定</strong>:区域内虚拟机中运行的服务以及GKE pod的否定。</p><p id="2895" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">无服务器否定</strong>:启用云运行、云功能、API网关等无服务器服务作为谷歌负载均衡器的后端。</p><p id="e68f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">互联网NEG </strong> : NEG从谷歌负载均衡器访问GCP以外的后端</p><p id="f26d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">混合否定:将部署在内部的服务配置为Google负载均衡器的后端。</p><p id="1b22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PSC NEG :将跨网络和项目运行的服务配置为Google负载平衡器的后端。</p><h1 id="d288" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">NEGs支持GCP负载平衡器</h1><p id="22c8" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">下表列出了每个GCP负载平衡器支持的neg。有关负载平衡器支持的最新信息，请参考GCP文档。</p><div class="kg kh ez fb ki kj"><a href="https://cloud.google.com/load-balancing/docs/negs" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">网络端点组概述|负载平衡| Google云</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">网络端点组(NEG)是指定一组后端端点或服务的配置对象。一个…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">cloud.google.com</p></div></div><div class="ks l"><div class="kt l ku kv kw ks kx ky kj"/></div></div></a></div><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es kz"><img src="../Images/962202bd428c40b44608a823997ffac5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rQvgmiyGY5rVgQotrPxsdA.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">各种GCP负载平衡器支持NEGs</figcaption></figure><h1 id="e2ba" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">细节</h1><p id="9cd8" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">让我们通过讨论这些neg支持的目的和使用案例来深入了解网络端点组的细节。</p><p id="1b58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">用例1:直接连接到多个GKE pod(GKE的区域NEG)</strong></p><p id="b472" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Kubernetes中，服务公开了一组在特定内部pod-ip和端口上提供特定功能的pod。这些属于一个服务的pod可以扩大或缩小，它们通常在GKE集群节点中运行。这些服务本质上就像一个网络负载平衡器，并以一种特定的方式(循环、基于权重)将请求路由到与其连接的多个pods。典型的kubernetes服务将入站请求分两步路由到pod。请求最初被发送到GKE集群中的底层VM节点，该集群再次使用kube-proxy将请求路由到运行服务的特定pod。因此，要连接到公开应用程序功能的特定pod，需要两个跃点(服务-&gt;虚拟机-&gt; pod)。</p><p id="9732" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在下图中，来自客户端的请求到达Kubernetes服务，然后被发送到GKE集群中的一个后端实例(节点池)。每个节点中运行的“kube-proxy”服务通过ip表规则将请求重定向到正确的pod。</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lo"><img src="../Images/6bcf14ab16e4b3365c95eedf4bef37a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i99dxRGhYCe21QL16bN1EQ.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">基于Kubernetes服务的负载平衡</figcaption></figure><p id="6606" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于NEGs，pod通过“pod-ip:port”直接暴露。在这种情况下，客户端直接与pods通信，而无需在每个实例中联系kube-proxy。这导致更低的延迟和更好的性能。此外，当您放大/缩小底层pod时，GKE会自动管理负端点。因此，在放大过程中，新的端点被添加到NEG，而在缩小过程中，现有的端点被移除</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lp"><img src="../Images/727b2eb19540a4476549d1e34d1193fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jni9ftOmcHVRx7dp8TKIOg.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">基于NEG的kubernetes服务负载均衡</figcaption></figure><p id="bf7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“Kubernetes服务”可以通过一个简单的注释在GKE公开为NEG</p><pre class="la lb lc ld fd lq lr ls lt aw lu bi"><span id="d282" class="lv je hi lr b fi lw lx l ly lz">annotations:<br/>    cloud.google.com/neg: '{"exposed_ports": {"80":{"name": "NEG_NAME"}}}'</span></pre><p id="693f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考GKE文件:</p><p id="3071" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ma" href="https://cloud.google.com/kubernetes-engine/docs/how-to/standalone-neg#create_a_service" rel="noopener ugc nofollow" target="_blank"> <em class="mb">单机NEGs </em> </a> <em class="mb">，</em> <a class="ae ma" href="https://cloud.google.com/kubernetes-engine/docs/how-to/container-native-load-balancing" rel="noopener ugc nofollow" target="_blank"> <em class="mb">集装箱本地负载均衡</em> </a></p><p id="0af3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">用例2:相同服务的基于容器和虚拟机的后端(区域否定)</strong></p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es mc"><img src="../Images/5e73b7237ec02cf4328e772db5293b79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2UOkmn38QAsmcJ7lhvhdOg.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">作为容器和虚拟机后端的区域负</figcaption></figure><p id="d64c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">区域neg支持在虚拟机中运行的一组应用程序作为负载平衡器后面的一组端点公开。让我们考虑一下从虚拟机过渡到容器的情况。在这种情况下，您的一些应用程序将被容器化，而一些应用程序可能会继续在虚拟机中运行。您可以使用基于分区虚拟机的neg来添加虚拟机，并使用基于GKE容器的neg作为kubernetes pods的后端。这样，一个负载均衡器就可以同时服务于基于虚拟机的工作负载和容器化的工作负载，如上图所示。</p><p id="3ac8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">用例3:通过负载均衡器(无服务器NEG)公开无服务器应用</strong></p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es md"><img src="../Images/915bd2c70b6abf5bebe57c29e11d300e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZoZFKxmRv1Nkr-ZiO_BKGg.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">通过无服务器NEG连接到负载平衡器的无服务器应用程序</figcaption></figure><p id="caa9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们考虑这样一种情况，您的应用程序部署在云运行、云功能或App Engine无服务器托管环境中。虽然无服务器端点可以直接暴露给外部世界供公众访问，但对于广泛使用的服务来说，安全性和性能可能是一个问题。这些服务可以附加为无服务器的NEG后端服务，并通过GCP的全局负载平衡器对外公开。全局负载平衡器通过GFEs接受更靠近用户的请求来提高性能，并通过高速google网络路由所有流量。此外，负载平衡器可以连接到云CDN来缓存静态图像/文件，并为来自缓存的请求提供服务，从而大幅提高性能。从安全角度来看，通过在负载平衡器上配置的“<a class="ae ma" href="https://cloud.google.com/armor/docs/cloud-armor-overview" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">【云甲】</strong> </a>”策略，可以保护全局负载平衡器免受各种DDOS和WAF攻击。因此，“无服务器NEG”将GCP全球负载平衡器的性能和安全性带到了无服务器世界。</p><p id="6cd3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">用例4:为GCP以外的应用利用谷歌网络、CDN和DDOS保护(互联网阴性)</strong></p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es me"><img src="../Images/be06ddab3d386b9d46facb403323f7e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oXWU4NAaNse8mTlwKQcbKQ.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">GCP负载均衡器在互联网中的应用</figcaption></figure><p id="90cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然无服务器NEG为无服务器世界带来了GCP负载平衡器的能力和力量，但Internet NEG允许通过负载平衡器暴露在GCP之外运行的后端。这些后端主要是在内部或不同的云提供商环境中运行的服务，并通过公共IP 公开<strong class="ih hj">。可以将多个端点添加到一个Internet NEG，但是ip地址应该可以从GCP通过Internet公开到达。通常，互联网neg作为后端添加到GCP的全球负载平衡器，以利用GCP网络、CDN的高性能，并通过云装甲防范DDOS和WAF攻击。因此，Internet NEGs将GCP全球负载平衡器的性能和安全特性引入本地应用和非GCP云提供商(AWS/Azure)应用。</strong></p><p id="996a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">用例5:在本地服务和GCP服务之间分流流量。(混合阴性)</strong></p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es mf"><img src="../Images/5dde519efa1352b9176be09717f3b873.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4guT2xctUo4oZiAvN0_7Bw.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">金丝雀发布本地迁移至GCP的策略</figcaption></figure><p id="4daf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们考虑这样一种情况:当您将应用服务从内部(在组织中运行的传统内部数据中心)迁移到GCP时。迁移后，您希望在生产环境中采用Canary版本的Devops最佳实践。不用将所有用户和请求暴露给云中新迁移的服务，一小部分流量可以被定向到GCP的后端服务，而大部分流量被路由到本地。分配给迁移的GCP后端服务的请求流量部分可以逐渐增加。这确保了向GCP的迁移遵循故障安全金丝雀释放策略。</p><p id="1836" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在GCP，可以创建混合neg来实现这一战略。负载平衡器后端服务可以指向驻留在内部的端点(私有端点)。这样做的先决条件是，对于内部部署的私有端点，可以从GCP访问(互连连接)。后端服务可以将其中一个后端作为基于GCP的服务(实例组、节点等)，将另一个后端作为指向本地私有ip端点的混合NEG。可以配置路由规则来实现后端之间流量的加权分配</p><p id="14e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">用例6:通过负载均衡器公开运行在不同/网络中的服务。(PSC阴性)</strong></p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es mg"><img src="../Images/f456584e4e0418136190e40bfc717f7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iknp96aj5t4aLuO2vCsNLA.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">跨网络边界的应用程序通过PSC NEG连接到负载平衡器</figcaption></figure><p id="579f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">私有服务连接(又称PSC)的一个重要特性是跨网络和项目边界消费服务，而无需VPC对等。PSC允许您通过“PSC发布服务”功能发布负载平衡器背后的服务。在生产者方面，任何Https服务都可以附加到内部负载平衡器，并作为服务发布。在消费者网络上(跨组织的相同或不同项目中)，您可以通过指定在不同网络/项目中运行的已发布服务的服务url，创建PSC服务附件作为支持的负载平衡器上的后端服务(参见上表)。</p><p id="39e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这使得外部负载平衡器可以在不同于生产者服务的网络和项目中进行管理。注意:负载平衡器上的PSC后端服务目前仅支持Https协议(截至日期)。</p><h1 id="16a6" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="cf1d" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">正如本文所讨论的，网络端点组是一个重要的概念，它支持GCP的各种用例。记住NEG的主要功能之一是公开一组服务。这些服务位于何处以及它们是如何公开的，决定了必须创建的NEG的类型。此外，请务必参考最新的GCP文档，了解不同负载平衡器对NEGs的最新支持，因为目前PSC中正在进行大量工作。</p><h1 id="ae95" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">参考</h1><p id="f057" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated"><a class="ae ma" href="https://cloud.google.com/load-balancing/docs/negs" rel="noopener ugc nofollow" target="_blank">NEGs概述</a></p><p id="197a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ma" href="https://cloud.google.com/load-balancing/docs/negs/zonal-neg-concepts" rel="noopener ugc nofollow" target="_blank">带状阴性</a></p><p id="3540" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ma" href="https://cloud.google.com/load-balancing/docs/negs/internet-neg-concepts" rel="noopener ugc nofollow" target="_blank">网络负面</a></p><p id="3302" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ma" href="https://cloud.google.com/load-balancing/docs/negs/serverless-neg-concepts" rel="noopener ugc nofollow" target="_blank">无服务器负号</a></p><p id="3b12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ma" href="https://cloud.google.com/load-balancing/docs/negs/hybrid-neg-concepts" rel="noopener ugc nofollow" target="_blank">混合阴性</a></p><p id="3fd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ma" href="https://cloud.google.com/vpc/docs/private-service-connect" rel="noopener ugc nofollow" target="_blank"> PSC概述</a></p><p id="2cbc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ma" href="https://cloud.google.com/vpc/docs/configure-private-service-connect-controls#create-neg" rel="noopener ugc nofollow" target="_blank"> PSC阴性</a></p><p id="b39e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ma" href="https://cloud.google.com/armor/docs/cloud-armor-overview" rel="noopener ugc nofollow" target="_blank">云甲</a></p></div></div>    
</body>
</html>