<html>
<head>
<title>Stream data from Pub/Sub to Cloud Storage using Dataproc Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dataproc无服务器将数据从发布/订阅流式传输到云存储</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/stream-data-from-pub-sub-to-cloud-storage-using-dataproc-serverless-7a1e4823926e?source=collection_archive---------0-----------------------#2022-05-05">https://medium.com/google-cloud/stream-data-from-pub-sub-to-cloud-storage-using-dataproc-serverless-7a1e4823926e?source=collection_archive---------0-----------------------#2022-05-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e6da9d1ffb6506f52120e2a7dc4db5de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LrkR7R2wzUchd5NYBBlEpg.png"/></div></div></figure><p id="16c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Google Cloud Pub/Sub用于流分析和数据集成管道，以接收和分发数据。在这篇文章中，我们将探索如何使用<strong class="is hj"> Dataproc无服务器</strong>将数据从<strong class="is hj">发布/订阅</strong>主题传输到<strong class="is hj">谷歌云存储</strong>。</p><h1 id="6a85" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">主要优势</h1><ol class=""><li id="c5ed" class="km kn hi is b it ko ix kp jb kq jf kr jj ks jn kt ku kv kw bi translated">使用<strong class="is hj"> Dataproc Serverless </strong>运行Spark batch工作负载，无需配置和管理您自己的集群。</li><li id="6a5a" class="km kn hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated"><a class="ae lc" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/src/main/java/com/google/cloud/dataproc/templates/pubsub/README.md#2-pubsub-to-gcs" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> PubSubToGCS </strong> </a>模板是开源的，完全可定制，可用于简单的工作。</li><li id="0f76" class="km kn hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">您可以将数据从发布/订阅以<strong class="is hj"> AVRO和JSON </strong>格式传输到GCS。</li></ol><h1 id="8b72" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">基本用法</h1><ol class=""><li id="71b6" class="km kn hi is b it ko ix kp jb kq jf kr jj ks jn kt ku kv kw bi translated">如果你要使用“默认的”由GCP生成的VPC网络，请确保你已经启用了私有谷歌访问子网。您仍然需要启用如下的私人访问。</li></ol><figure class="le lf lg lh fd ij er es paragraph-image"><div class="er es ld"><img src="../Images/a46e23ea1c26661b8108c5579470ce13.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/1*Sxak421nKINSYUXlJ3VwIA.png"/></div></figure><p id="9890" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du li lj lk ll b">gcloud compute networks subnets update default — region=us-central1 — enable-private-ip-google-access</code></p><p id="4632" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.为jar文件创建一个GCS存储桶和一个暂存文件夹。</p><p id="aec4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.创建一个带有模式的发布/订阅主题(对AVRO数据流使用二进制序列化)。还要为此发布/订阅主题创建订阅。</p><p id="058b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.在预装了<a class="ae lc" href="https://cloud.google.com/shell/docs/how-cloud-shell-works" rel="noopener ugc nofollow" target="_blank">各种工具</a>的云壳中克隆git repo。或者，你可以使用任何预装了JDK 8+，Maven和Git的机器。</p><p id="a651" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du li lj lk ll b">git clone <a class="ae lc" href="https://github.com/GoogleCloudPlatform/dataproc-templates.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/dataproc-templates.git</a> cd dataproc-templates/java</code></p><p id="7989" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.获取认证凭证(以提交Dataproc作业)。</p><p id="1dea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du li lj lk ll b">gcloud auth application-default login</code></p><p id="1482" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.对GCS Dataproc无服务器模板执行发布/订阅:</p><pre class="le lf lg lh fd lm ll ln lo aw lp bi"><span id="d015" class="lq jp hi ll b fi lr ls l lt lu">export GCP_PROJECT=my-gcp-project-id<br/>export REGION=project-region<br/>export GCS_BUCKET=gcs-bucket-name<br/>export GCS_STAGING_LOCATION=gs://gcs-bucket-name/tempexport SUBNET=<!-- -->projects/$<!-- -->GCP_PROJECT<!-- -->/regions/$<!-- -->REGION<!-- -->/subnetworks/NAME<br/>export SUBSCRIPTION=pubsub-subscription-name<br/># DATA_FORMAT can be either JSON or AVRO<br/>export DATA_FORMAT=JSON<br/>export BATCH_SIZE=50</span><span id="e38d" class="lq jp hi ll b fi lv ls l lt lu">bin/start.sh \<br/>-- \<br/>--template PUBSUBTOGCS \<br/>--templateProperty pubsubtogcs.input.project.id=$GCP_PROJECT \<br/>--templateProperty pubsubtogcs.input.subscription=$<!-- -->SUBSCRIPTION<!-- --> \<br/>--templateProperty pubsubtogcs.gcs.output.project.id=$GCP_PROJECT \<br/>--templateProperty pubsubtogcs.gcs.bucket.name=$GCS_BUCKET \<br/>--templateProperty pubsubtogcs.gcs.output.data.format=$DATA_FORMAT \<br/>--templateProperty pubsubtogcs.batch.size=$BATCH_SIZE \</span></pre><p id="75d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意</strong>:如果尚未启用，它会要求您启用Dataproc Api。</p><h2 id="d859" class="lq jp hi bd jq lw lx ly ju lz ma mb jy jb mc md kc jf me mf kg jj mg mh kk mi bi translated">设置附加火花属性</h2><p id="8900" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb mj jd je jf mk jh ji jj ml jl jm jn hb bi translated">如果您需要<a class="ae lc" href="https://cloud.google.com/dataproc-serverless/docs/concepts/properties" rel="noopener ugc nofollow" target="_blank">指定Dataproc无服务器支持的spark属性</a>，比如调整驱动程序、内核、执行器等的数量。您可以编辑start.sh文件中的<a class="ae lc" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/bin/start.sh#L50" rel="noopener ugc nofollow" target="_blank"> OPT_PROPERTIES </a>值。</p><p id="2b04" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">参考文献</strong><br/><a class="ae lc" rel="noopener" href="/google-cloud/cloud-spanner-export-query-results-using-dataproc-serverless-6f2f65b583a4">https://medium . com/Google-cloud/cloud-spanner-export-query-results-using-data proc-server less-6 F2 f 65 b 583 a4</a><br/><a class="ae lc" href="https://cloud.google.com/pubsub/docs/overview" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/pubsub/docs/overview</a><br/><a class="ae lc" href="https://github.com/GoogleCloudPlatform/dataproc-templates" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/dataproc-templates</a></p></div></div>    
</body>
</html>