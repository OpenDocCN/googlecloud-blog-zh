<html>
<head>
<title>GCP Cloud Asset Inventory Feed : Get real time notifications on Resource Changes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP云资产清单馈送:获得关于资源变化的实时通知</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-cloud-asset-inventory-feed-get-real-time-notifications-on-resource-changes-63fe3687d3c?source=collection_archive---------0-----------------------#2022-11-23">https://medium.com/google-cloud/gcp-cloud-asset-inventory-feed-get-real-time-notifications-on-resource-changes-63fe3687d3c?source=collection_archive---------0-----------------------#2022-11-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8a6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在拥有许多云资产的组织中，跟踪整个资源清单是一项挑战。可以分别为组织中的每个项目列出所有资源的列表，但是这很费时间，容易出错，而且很乏味。即使您能够获得组织中所有项目的所有资源列表，维护这些资源如何变化也将是一场噩梦。在任何给定的时间获取资源的状态几乎是不可能的。保持对每个资源是否遵守企业的安全性和法规遵从性标准的检查变得更加具有挑战性。</p><p id="5f0e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是GCP <a class="ae jd" href="https://cloud.google.com/asset-inventory/docs/overview" rel="noopener ugc nofollow" target="_blank">云资产清单</a>可以提供帮助的地方。云资产清单会随时跟踪您的GCP资源。该数据库保存了库存中每项资产5周的元数据历史记录，并允许您随时查询库存。</p><p id="02cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是云资产清单的一些显著特征:</p><ol class=""><li id="8678" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">搜索资产元数据</li><li id="e6b0" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">在任何给定的时间戳导出清单，或导出特定时间范围内的更改历史。</li><li id="ed06" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">使用资产源订阅资产变更的实时通知。</li><li id="0a68" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">IAM策略分析器检查谁可以访问什么。</li></ol><p id="4f1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将了解如何订阅资产变化的实时通知，并在创建了具有公共IP的Google计算引擎实例时收到警报。</p><h1 id="13d2" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">目录</h1><ol class=""><li id="c24a" class="je jf hi ih b ii kq im kr iq ks iu kt iy ku jc jj jk jl jm bi translated">体系结构</li><li id="d29b" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">先决条件</li><li id="df02" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">创建资产馈送</li><li id="6681" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">设置警报</li><li id="6a7a" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">测试和验证</li><li id="8e49" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">打扫</li><li id="3ecb" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">结论</li></ol><h1 id="e2df" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">1.体系结构</h1><p id="5ab5" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">下图显示了该解决方案的高级架构。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es ky"><img src="../Images/802521eebead116783725fb30cbaabb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*032iG09uEzju9Rd4BR6bpQ.png"/></div></div></figure><p id="dbd8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用云资产清单、发布/订阅和云功能来生成实时通知。</p><p id="fb97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当使用公共IP创建计算引擎实例时，资产清单会实时捕获这种变化。通过资产馈送，该信息被发布到发布/订阅主题。一个云功能，订阅发布/订阅主题，并向一个已配置的松弛通道发送通知。</p><h1 id="528a" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">2.先决条件</h1><p id="70d5" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">首先，在您的项目中启用云资产、发布/订阅、资源管理器和云函数API。</p><pre class="kz la lb lc fd lk ll lm bn ln lo bi"><span id="7002" class="lp jt hi ll b be lq lr l ls lt">gcloud services enable cloudasset.googleapis.com pubsub.googleapis.com cloudfunctions.googleapis.com cloudresourcemanager.googleapis.com</span></pre><p id="41be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们创建一个PubSub主题，它将成为资产提要的目标。</p><pre class="kz la lb lc fd lk ll lm bn ln lo bi"><span id="8daf" class="lp jt hi ll b be lq lr l lu lt">gcloud pubsub topics create gce-public-ip-feed-topic --project=<strong class="ll hj">PROJECT_ID</strong></span></pre><h1 id="82c0" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">3.创建资产馈送</h1><p id="be0a" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">现在让我们创建一个资产提要。摘要是您可以订阅的更改流。每个级别(项目、文件夹、组织)最多可以有200个提要。</p><p id="d774" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，让我们创建一个feed，它将获得计算实例创建的实时更改。</p><pre class="kz la lb lc fd lk ll lm bn ln lo bi"><span id="49cd" class="lp jt hi ll b be lq lr l lu lt">gcloud asset feeds create gce-public-ip-feed --project=<strong class="ll hj">PROJECT_ID</strong> \<br/>--content-type=resource \<br/>--asset-types="compute.googleapis.com/Instance" \<br/>--pubsub-topic="projects/<strong class="ll hj">PROJECT_ID</strong>/topics/gce-public-ip-feed-topic" \ <br/>--condition-expression="temporal_asset.prior_asset_state == google.cloud.asset.v1.TemporalAsset.PriorAssetState.DOES_NOT_EXIST"</span></pre><blockquote class="lv lw lx"><p id="9b6c" class="if ig ly ih b ii ij ik il im in io ip lz ir is it ma iv iw ix mb iz ja jb jc hb bi translated"><em class="hi">注意:资产馈送只能通过CLI和API创建。通过云控制台创建它的选项不可用。</em></p></blockquote><p id="c57c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有关参数参考，请查阅<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/asset/feeds/create" rel="noopener ugc nofollow" target="_blank">g云资产源</a>的文档。</p><p id="d49c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有关支持的资产类型列表，请参考此处的文档<a class="ae jd" href="https://cloud.google.com/asset-inventory/docs/supported-asset-types" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="e215" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，对资源的任何更改(如创建/更新/删除)都会导致消息发布到发布/订阅主题。我们可以使用<code class="du mc md me ll b">--condition-expression </code>标志来过滤对底层资产类型的任何特定更改。在上面的例子中，我只过滤了新实例的创建。这里可以参考使用<code class="du mc md me ll b">--condition-expression</code> <a class="ae jd" href="https://cloud.google.com/asset-inventory/docs/monitoring-asset-changes-with-condition" rel="noopener ugc nofollow" target="_blank">的文档。</a></p><p id="16a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以使用<code class="du mc md me ll b">--asset-name</code>标志为提要指定特定资源的名称。</p><p id="dc87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du mc md me ll b">--pubsub-topic</code>是我们之前创建的主题。它将成为此源的目标。</p><p id="f343" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下命令检索创建的提要:</p><pre class="kz la lb lc fd lk ll lm bn ln lo bi"><span id="ba13" class="lp jt hi ll b be lq lr l ls lt">gcloud asset feeds describe gce-public-ip-feed --project=PROJECT_ID</span></pre><p id="7beb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们已经准备好使用变更并发送通知了。</p><blockquote class="lv lw lx"><p id="569e" class="if ig ly ih b ii ij ik il im in io ip lz ir is it ma iv iw ix mb iz ja jb jc hb bi translated"><em class="hi">注意:创建后可能需要10分钟，提要才会开始向发布/订阅主题发送消息。</em></p></blockquote><h1 id="e288" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">4.设置警报</h1><p id="8d26" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">要向松弛通道发送通知，请执行以下操作:</p><ol class=""><li id="d70f" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">创建一个新的Slack应用程序，该应用程序有足够的权限将消息发布到公共Slack频道。使用此处的说明<a class="ae jd" href="https://api.slack.com/authentication/basics" rel="noopener ugc nofollow" target="_blank">创建一个app，并生成一个<code class="du mc md me ll b">TOKEN</code>用于云端功能，将消息发布到频道。</a></li><li id="f945" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">创建并部署一个云功能，当收到来自Pub/Sub的通知时，该功能会将聊天消息发布到Slack。</li></ol><p id="34bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这一节中，我们将设置一个云函数，它从我们的PubSub主题中读取消息，并在使用Public IP创建实例时发出一条slack消息。</p><p id="601f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们为云函数代码创建一个目录:</p><pre class="kz la lb lc fd lk ll lm bn ln lo bi"><span id="2ce9" class="lp jt hi ll b be lq lr l ls lt">mkdir -p alert_function &amp;&amp; cd alert_function</span></pre><p id="ce3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在创建两个文件<code class="du mc md me ll b">requirements.txt</code>和<code class="du mc md me ll b">main.py</code></p><p id="828b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> requirements.txt </strong></p><pre class="kz la lb lc fd lk ll lm bn ln lo bi"><span id="55e1" class="lp jt hi ll b be lq lr l ls lt">requests==2.26.0</span></pre><p id="69da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> main.py </strong></p><pre class="kz la lb lc fd lk ll lm bn ln lo bi"><span id="ad92" class="lp jt hi ll b be lq lr l ls lt">import base64<br/>import json<br/>import requests<br/><br/># Triggered from a message on a Cloud Pub/Sub topic.<br/>def filter_rule(event, context):<br/>    """Triggered from a message on a Cloud Pub/Sub topic.<br/>    Args:<br/>         event (dict): Event payload.<br/>         context (google.cloud.functions.Context): Metadata for the event.<br/>    """<br/>    TOKEN = "xoxb-XXXXXXXXXXX-YYYYYYYY-ZZZZZZZ"<br/>    URL = "https://slack.com/api/chat.postMessage"<br/>    <br/>    pubsub_message = base64.b64decode(event['data']).decode('utf-8')<br/>    message_json = json.loads(pubsub_message)<br/>    natIP = json_extract(message_json,"type")<br/>   <br/>    if 'ONE_TO_ONE_NAT' in natIP:<br/>        payload = get_data(message_json)<br/>        name = payload["name"]<br/>        requests.post(URL, data={<br/>            "token": TOKEN,<br/>            "channel": "#general",<br/>            "text": f"Instance *{name}* was created with external IP!"<br/>        })<br/><br/>def get_data(message_json):<br/>    try:<br/>        return message_json["asset"]["resource"]["data"]<br/>    except:<br/>        return message_json["priorAsset"]["resource"]["data"]<br/><br/>def json_extract(obj, key):<br/>    """Recursively fetch values from nested JSON."""<br/>    arr = []<br/>    def extract(obj, arr, key):<br/>        """Recursively search for values of key in JSON tree."""<br/>        if isinstance(obj, dict):<br/>            for k, v in obj.items():<br/>                if isinstance(v, (dict, list)):<br/>                    extract(v, arr, key)<br/>                elif k == key:<br/>                    arr.append(v)<br/>        elif isinstance(obj, list):<br/>            for item in obj:<br/>                extract(item, arr, key)<br/>        return arr<br/>    values = extract(obj, arr, key)<br/>    return values<br/><br/></span></pre><p id="ce53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将变量<code class="du mc md me ll b">TOKEN</code>替换为您自己的Slack App Bot身份验证令牌，如上面步骤1中所创建的。</p><p id="b716" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在部署这个云功能。</p><pre class="kz la lb lc fd lk ll lm bn ln lo bi"><span id="6733" class="lp jt hi ll b be lq lr l ls lt">gcloud functions deploy gce-public-ip-alert --region=us-central1 --entry-point=filter_rule --runtime=python39 --trigger-topic=gce-public-ip-feed-topic</span></pre><blockquote class="lv lw lx"><p id="141b" class="if ig ly ih b ii ij ik il im in io ip lz ir is it ma iv iw ix mb iz ja jb jc hb bi translated"><em class="hi">注意:如果尚未启用云构建服务，系统会提示您启用该服务。</em></p></blockquote><p id="a712" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你的功能处于<code class="du mc md me ll b">Active</code>状态。我们准备测试和验证我们的设置。</p><h1 id="142a" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">5.测试和验证</h1><p id="e202" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">让我们在项目中创建一个带有public-ip的计算引擎实例，用于测试目的</p><pre class="kz la lb lc fd lk ll lm bn ln lo bi"><span id="0ba4" class="lp jt hi ll b be lq lr l ls lt">gcloud compute instances create test-instance --project=PROJECT_ID --network=NETORK_ID --subnet=SUBNET_ID --zone=us-central1-a</span></pre><p id="fd18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果一切都设置正确，你会在你的松弛频道看到一条消息。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div class="er es mf"><img src="../Images/ce8e7a7d1eca376939f822ac7a2cb91d.png" data-original-src="https://miro.medium.com/v2/resize:fit:854/format:webp/1*7PZvHdtaOtKd53pICMqqSw.png"/></div></figure><p id="2dd8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于时差的通知</p><h1 id="561a" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">6.打扫</h1><p id="5b8a" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">如果您在本演示中使用了一个新项目，那么您可以删除该项目来清理资源。否则，按照以下步骤删除创建的资源-</p><p id="c685" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除实例</p><pre class="kz la lb lc fd lk ll lm bn ln lo bi"><span id="8c6a" class="lp jt hi ll b be lq lr l ls lt">gcloud compute instances delete test-instance --project=PROJECT_ID</span></pre><p id="c9bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除云功能</p><pre class="kz la lb lc fd lk ll lm bn ln lo bi"><span id="ba90" class="lp jt hi ll b be lq lr l ls lt">gcloud functions delete gce-public-ip-alert --project=PROJECT_ID</span></pre><p id="1040" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除资产馈送</p><pre class="kz la lb lc fd lk ll lm bn ln lo bi"><span id="b53c" class="lp jt hi ll b be lq lr l ls lt">gcloud asset feeds delete gce-public-ip-feed --project=PROJECT_ID</span></pre><p id="97fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除发布/订阅主题</p><pre class="kz la lb lc fd lk ll lm bn ln lo bi"><span id="ffe6" class="lp jt hi ll b be lq lr l ls lt">gcloud pubsub topics delete gce-public-ip-feed-topic</span></pre><h1 id="fbb8" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">7.结论</h1><p id="56fb" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">Google Cloud Asset inventory是一个强大的工具，可以帮助组织跟踪云中的所有资源。通过资产馈送，他们可以获得关于其环境中发生的变化的实时警报，并使用云功能采取适当的措施。</p><p id="0fee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">脚注:</strong></p><p id="a4d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有几个选项可以实现类似的功能:</p><ol class=""><li id="b49f" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">在云日志中创建基于日志的指标，并在其上创建警报。</li><li id="6d9d" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">默认情况下，使用组织策略约束在GCE虚拟机实例上禁用公共IP，仅在特定虚拟机上允许。更多细节可以在<a class="ae jd" href="https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address#disableexternalip" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</li></ol></div></div>    
</body>
</html>