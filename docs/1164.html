<html>
<head>
<title>Scaling Web Apps on Google Compute Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在谷歌计算引擎上扩展网络应用</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/scaling-web-app-on-google-compute-engine-d21d6ce3e837?source=collection_archive---------0-----------------------#2019-10-08">https://medium.com/google-cloud/scaling-web-app-on-google-compute-engine-d21d6ce3e837?source=collection_archive---------0-----------------------#2019-10-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="faeb" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">在云中烹饪</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/ab653d573ba92e44aa12b8c5073760e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*A_PlPDmVTn7osT5c.png"/></div></div></figure><h1 id="28ff" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">介绍</h1><p id="a61c" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">在这个迷你系列中，我们将介绍如何在谷歌云上创建网站。这是该系列的第五篇文章。</p><ol class=""><li id="ddb0" class="kx ky hi kd b ke kz kh la kk lb ko lc ks ld kw le lf lg lh bi translated"><a class="ae li" rel="noopener" href="/@pvergadia/hosting-web-applications-on-google-cloud-an-overview-46f5605eb3a6">在谷歌云上托管网络应用:概述</a></li><li id="fdc9" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw le lf lg lh bi translated"><a class="ae li" rel="noopener" href="/google-cloud/hosting-a-static-website-on-google-cloud-using-google-cloud-storage-ddebcdcc8d5b">使用谷歌云存储在谷歌云上托管网络应用</a></li><li id="c307" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw le lf lg lh bi translated"><a class="ae li" rel="noopener" href="/google-cloud/hosting-a-website-on-google-cloud-using-cloud-run-a65343a98fce">使用Cloud Run在Google Cloud上托管web应用</a></li><li id="2a39" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw le lf lg lh bi translated"><a class="ae li" rel="noopener" href="/@pvergadia/hosting-a-website-on-google-cloud-using-google-compute-engine-c6fe84d76f51">使用谷歌计算引擎部署网站的5个步骤</a></li><li id="437d" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw le lf lg lh bi translated">在Google计算引擎上扩展Web应用程序(本文)</li><li id="d816" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw le lf lg lh bi translated"><a class="ae li" rel="noopener" href="/faun/case-study-hosting-scalable-web-apps-on-google-cloud-c0bb675812c8">案例研究</a></li></ol><p id="58c2" class="pw-post-body-paragraph kb kc hi kd b ke kz ij kg kh la im kj kk lo km kn ko lp kq kr ks lq ku kv kw hb bi translated">在上一篇文章中，我们看到了一个使用Google计算引擎在Google Cloud上部署web应用程序和web服务器的示例架构。当您的网站变得受欢迎，用户从一百万增长到一百万时，这些实例通过使用实例模板随着请求的增加或减少而自动缩放。在本文中，让我们更深入地了解伸缩，并了解它是如何工作的。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lr"><img src="../Images/a59e217b3ee60aea4866846c876ff0d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T_PI7eA2MU977I5TCzorcg.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">使用Google计算引擎托管网站的示例架构</figcaption></figure><h1 id="955b" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">你会学到什么</h1><ul class=""><li id="fb11" class="kx ky hi kd b ke kf kh ki kk lw ko lx ks ly kw lz lf lg lh bi translated">通过五个简单的步骤，使用托管实例组创建网站。</li></ul><h1 id="7acd" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">先决条件</h1><ul class=""><li id="4e07" class="kx ky hi kd b ke kf kh ki kk lw ko lx ks ly kw lz lf lg lh bi translated">阅读<a class="ae li" rel="noopener" href="/@pvergadia/hosting-web-applications-on-google-cloud-an-overview-46f5605eb3a6">第一篇文章</a>，它涵盖了关于在Google Cloud上建立网站的高级概念。</li><li id="a1cd" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw lz lf lg lh bi translated">查看之前关于使用谷歌计算引擎部署网站的5个步骤的文章。</li></ul><h1 id="d7fc" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">看看这个视频</h1><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ma mb l"/></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">在Google计算引擎上扩展Web应用程序</figcaption></figure><h1 id="a4bc" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">什么是实例模板？</h1><blockquote class="mc"><p id="6f41" class="md me hi bd mf mg mh mi mj mk ml kw dx translated">实例模板旨在创建具有相同配置的实例。</p></blockquote><figure class="mn mo mp mq mr jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mm"><img src="../Images/8926807dafa6d7c1c91c8e9a7c42e073.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kIHgrax1NQcz-8_bE9quLQ.png"/></div></div></figure><p id="d5d7" class="pw-post-body-paragraph kb kc hi kd b ke kz ij kg kh la im kj kk lo km kn ko lp kq kr ks lq ku kv kw hb bi translated">实例模板是一种资源，可用于创建虚拟机实例和托管实例组。实例模板定义机器类型、引导磁盘映像或容器映像、标签和其他实例属性。然后，您可以使用一个实例模板来创建一个<a class="ae li" href="https://cloud.google.com/compute/docs/instance-groups/creating-groups-of-managed-instances" rel="noopener ugc nofollow" target="_blank">托管实例组</a>或者创建<a class="ae li" href="https://cloud.google.com/compute/docs/instances/create-vm-from-instance-template" rel="noopener ugc nofollow" target="_blank">单独的虚拟机实例</a>。实例模板是保存虚拟机实例配置的一种便捷方式，因此您可以在以后使用它来创建新的虚拟机实例或虚拟机实例组。你可以在这里了解更多关于实例模板<a class="ae li" href="https://cloud.google.com/compute/docs/instance-templates/" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><h1 id="ed76" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">什么是托管实例组？</h1><p id="9bd6" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">托管实例组(MIG)包含基于<a class="ae li" href="https://cloud.google.com/compute/docs/instance-templates" rel="noopener ugc nofollow" target="_blank">实例模板</a>的相同实例。托管实例组通过主动保持实例可用(即处于<code class="du ms mt mu mv b">RUNNING</code>状态)来维护应用的高可用性。托管实例组支持<a class="ae li" href="https://cloud.google.com/compute/docs/instance-groups/autohealing-instances-in-migs" rel="noopener ugc nofollow" target="_blank">自动修复</a>、<a class="ae li" href="https://cloud.google.com/compute/docs/instance-groups/adding-an-instance-group-to-a-load-balancer" rel="noopener ugc nofollow" target="_blank">负载平衡</a>、<a class="ae li" href="https://cloud.google.com/compute/docs/autoscaler/" rel="noopener ugc nofollow" target="_blank">自动伸缩</a>和<a class="ae li" href="https://cloud.google.com/compute/docs/instance-groups/rolling-out-updates-to-managed-instance-groups" rel="noopener ugc nofollow" target="_blank">自动更新</a>。</p><h1 id="c538" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">自动缩放策略</h1><blockquote class="mc"><p id="7d43" class="md me hi bd mf mg mh mi mj mk ml kw dx translated">自动缩放策略提供了一种根据需要添加或删除实例的方法。</p></blockquote><p id="8d59" class="pw-post-body-paragraph kb kc hi kd b ke mw ij kg kh mx im kj kk my km kn ko mz kq kr ks na ku kv kw hb bi translated">自动缩放策略的影响是双重的:</p><ul class=""><li id="1add" class="kx ky hi kd b ke kz kh la kk lb ko lc ks ld kw lz lf lg lh bi translated">您的用户在使用您的应用程序时会获得很好的体验，因为总是有足够的资源来满足需求。</li><li id="d3b2" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw lz lf lg lh bi translated">您可以更好地控制成本，因为当需求低于指定阈值时，自动缩放会删除实例。</li></ul><p id="8fe2" class="pw-post-body-paragraph kb kc hi kd b ke kz ij kg kh la im kj kk lo km kn ko lp kq kr ks lq ku kv kw hb bi translated">要创建自动缩放器，您必须指定自动缩放器用来确定何时缩放组的<strong class="kd hj">自动缩放策略</strong>和<strong class="kd hj">目标利用率</strong>级别。</p><p id="98dc" class="pw-post-body-paragraph kb kc hi kd b ke kz ij kg kh la im kj kk lo km kn ko lp kq kr ks lq ku kv kw hb bi translated">您可以选择使用以下标准进行扩展，这可以基于利用率或每秒请求数:</p><ul class=""><li id="074d" class="kx ky hi kd b ke kz kh la kk lb ko lc ks ld kw lz lf lg lh bi translated">平均CPU利用率</li><li id="ecbd" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw lz lf lg lh bi translated">堆栈驱动程序监控指标</li><li id="c922" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw lz lf lg lh bi translated">HTTP负载平衡服务容量</li><li id="defa" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw lz lf lg lh bi translated">网络负载平衡</li></ul><p id="1722" class="pw-post-body-paragraph kb kc hi kd b ke kz ij kg kh la im kj kk lo km kn ko lp kq kr ks lq ku kv kw hb bi translated">自动缩放器根据策略持续收集使用信息，将实际利用率与您希望的目标利用率进行比较，并确定是否需要扩大或缩小组。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nb"><img src="../Images/268785617896dcc2b564e0067e37c5fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HD4HjbLxyKHWjF3bnY3unA.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">基于CPU利用率的自动扩展</figcaption></figure><p id="576f" class="pw-post-body-paragraph kb kc hi kd b ke kz ij kg kh la im kj kk lo km kn ko lp kq kr ks lq ku kv kw hb bi translated">例如，如果您基于CPU利用率进行扩展，您可以将您的目标利用率水平设置为80%，autoscaler将轮询CPU利用率并检查它是否&gt; 80%，如果是，它会将新实例添加到实例组，如果CPU利用率&lt; 80 then it removes an instance form the group, making sure the capacity is maintained.</p><h1 id="019f" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">Autoscaling + Load Balancing</h1><p id="1618" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">You can use autoscaling in conjunction with load balancing by setting up an autoscaler that scales based on the load of your instances.</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nc"><img src="../Images/6aa971b9d73edccf9899cc75f8b4b52c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ggO2un8pmO9UfY_CT1sohw.png"/></div></div></figure><p id="4cb1" class="pw-post-body-paragraph kb kc hi kd b ke kz ij kg kh la im kj kk lo km kn ko lp kq kr ks lq ku kv kw hb bi translated">For example, assume the load balancing serving capacity of a managed instance group is defined as 100 RPS per instance. If you create an autoscaler with the HTTP(S) load balancing policy and set it to maintain a target utilization level of 0.8 or 80%, the autoscaler will add or remove instances from the managed instance group to maintain 80% of the serving capacity, or 80 RPS per instance.</p><p id="f5e2" class="pw-post-body-paragraph kb kc hi kd b ke kz ij kg kh la im kj kk lo km kn ko lp kq kr ks lq ku kv kw hb bi translated">The architecture needs to automatically replace instances that have failed or have become unavailable. And when the new instance comes online it should:</p><ul class=""><li id="643d" class="kx ky hi kd b ke kz kh la kk lb ko lc ks ld kw lz lf lg lh bi translated">Understand its role in the system</li><li id="e836" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw lz lf lg lh bi translated">Configure itself automatically</li><li id="c346" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw lz lf lg lh bi translated">Discover any of the dependencies</li><li id="33e2" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw lz lf lg lh bi translated">Start handling requests automatically</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nd"><img src="../Images/fa088f3e3c2abeff13639621d72e3004.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WwKVEAzeW1HiA3XN0v8V3A.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">Automatically replacing instances</figcaption></figure><p id="db23" class="pw-post-body-paragraph kb kc hi kd b ke kz ij kg kh la im kj kk lo km kn ko lp kq kr ks lq ku kv kw hb bi translated">To replace a failed instance automatically, we can use several compute engine components together. You could create instance templates that use a public image and a startup script to prepare the instance after it starts running. But, we recommend that you use deterministic instance templates , which minimize risk and unexpected behavior from your instance templates.</p><p id="0ab4" class="pw-post-body-paragraph kb kc hi kd b ke kz ij kg kh la im kj kk lo km kn ko lp kq kr ks lq ku kv kw hb bi translated">Thanks to Managed Instance Groups, now we have a system that can replace unhealthy instances with new ones.</p><p id="3094" class="pw-post-body-paragraph kb kc hi kd b ke kz ij kg kh la im kj kk lo km kn ko lp kq kr ks lq ku kv kw hb bi translated">But, we still have a challenge, how are we going to know which instance to replace?</p><h1 id="1653" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">Health Checks</h1><p id="d684" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">In order to know which instance to replace, we need to define what is an unhealthy instance, and to do that, we use health checks! It is recommend that you use separate health checks for load balancing and for autohealing. Autohealing health checks are set up at the managed instance group level.</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ne"><img src="../Images/707d34c07e75582d25e438df46abff80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YB31WFIYx0NHp29zgB2b_Q.png"/></div></div></figure><p id="8bc8" class="pw-post-body-paragraph kb kc hi kd b ke kz ij kg kh la im kj kk lo km kn ko lp kq kr ks lq ku kv kw hb bi translated">You create a health check that looks for a response on port 80 and that can tolerate some failure before it marks instances as unhealthy and causes them to be recreated.</p><p id="dcf5" class="pw-post-body-paragraph kb kc hi kd b ke kz ij kg kh la im kj kk lo km kn ko lp kq kr ks lq ku kv kw hb bi translated">In this example, an instance is marked as healthy if it returns successfully two times. It is marked as unhealthy if it returns unsuccessfully 3 consecutive times.</p><h1 id="0f37" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">Conclusion</h1><p id="1ce8" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">You have learned some tricks to make a web architecture resilient by spinning up new instances and taking them down if computer resources fail or your traffic grows!</p><h1 id="be47" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">Next steps</h1><ul class=""><li id="1f37" class="kx ky hi kd b ke kf kh ki kk lw ko lx ks ly kw lz lf lg lh bi translated">Follow this blog series on <a class="ae li" href="https://medium.com/google-cloud" rel="noopener">Google Cloud Platform Medium</a>。</li><li id="9472" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw lz lf lg lh bi translated">关注<a class="ae li" href="https://www.youtube.com/watch?v=pxp7uYUjH_M" rel="noopener ugc nofollow" target="_blank">云烹饪</a>视频系列，订阅谷歌云平台YouTube频道</li><li id="ce78" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw lz lf lg lh bi translated">想要更多的故事？查看我的<a class="ae li" rel="noopener" href="/@pvergadia/">媒体</a>，<a class="ae li" href="https://twitter.com/pvergadia" rel="noopener ugc nofollow" target="_blank">在twitter上关注我</a>。</li><li id="e7ba" class="kx ky hi kd b ke lj kh lk kk ll ko lm ks ln kw lz lf lg lh bi translated">与我们一起享受这个系列的旅程，并了解更多关于Google Cloud的信息:)</li></ul></div></div>    
</body>
</html>