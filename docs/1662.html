<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://medium.com/google-cloud/database-migration-service-connectivity-a-technical-introspective-19f3bb71a0c7?source=collection_archive---------3-----------------------#2020-11-13">https://medium.com/google-cloud/database-migration-service-connectivity-a-technical-introspective-19f3bb71a0c7?source=collection_archive---------3-----------------------#2020-11-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/b7db046a3f2ce2f833c5672ec28aa1d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DN9ci74Wqj1SZh7EZ1WGLw.png"/></div></div></figure><p id="b6f2" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">嗨，朋友们！</p><p id="6ad7" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">希望你已经听说了我们发布的新产品:数据库迁移服务(DMS)。如果你还没有，你应该看看<a class="ae iq" href="https://cloud.google.com/blog/products/databases/database-migration-service-now-available-for-cloud-sql-and-more" rel="noopener ugc nofollow" target="_blank">公告博客</a>。TL；DR，其理念是尽可能简单安全地将您的数据库可靠地迁移到完全托管的云SQL实例中。</p><p id="73bf" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">在这篇文章中，我将会谈论很多关于MySQL(预览版)和PostgreSQL(预览版，点击<a class="ae iq" href="https://docs.google.com/forms/d/1AoVGFHke8KUWRHwjMpRUPHbV15KqQb4Hbu11dvRZDqQ/edit?ts=5f8be009&amp;gxids=7826" rel="noopener ugc nofollow" target="_blank">链接</a>注册)的内容。我没有冷落SQL Server，只是在我写这篇博客的时候，DMS还不支持SQL Server，但它会支持的！稍后寻找支持声明。</p><p id="96e2" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">因此，您已经有了一个想要迁移到云中的数据库。或者可能它在云中，但还没有被云SQL管理。我们聊一会儿，好吗？</p><p id="6983" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">做出迁移决策以及为应用程序的数据存储迁移做准备需要做大量的工作。本文假设您已经做出了迁移的决定，您正在评估(或者已经评估并准备好了)DMS来完成迁移，并且您已经做好了准备，一旦数据库迁移完成，您的应用程序就可以切换并指向全新的云SQL实例。</p><p id="b3d0" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">今天我想和大家谈的是连通性。我知道，我知道，<a class="ae iq" href="https://talesofatech.com/2017/03/rule-1-its-always-dns/" rel="noopener ugc nofollow" target="_blank">总是DNS </a>。但是，万一不是DNS呢？我们谈谈吧。DMS通过几个旋钮指导您完成该过程，您可以调整这些旋钮来适应如何以满足您组织的安全策略的方式管理您的源和托管云SQL数据库之间的连接。</p><p id="4c9f" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">在我深入连接兔子洞之前，我想提醒一下，在你到达这里之前，有些事情你需要去做和思考。您需要考虑为迁移准备数据库和应用程序，并了解DMS迁移完成后的后续步骤。请留意其他一些深入报道这些话题的博客。特别是其中一个，它涵盖了<a class="ae iq" href="https://cloud.google.com/blog/products/databases/tips-for-migrating-across-compatible-database-engines" rel="noopener ugc nofollow" target="_blank">同构迁移</a>最佳实践，很好地进入了我的下一部分…</p><h1 id="59b6" class="ir is ht bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">预防性故障排除</h1><p id="cee1" class="pw-post-body-paragraph hr hs ht hu b hv jp hx hy hz jq ib ic id jr if ig ih js ij ik il jt in io ip hb bi translated">对于准备工作来说非常重要的几个部分，我也想在这里指出，因为如果你错过了它们，它们会导致失败。它们在我上面链接的博客中有深入的介绍，并且作为迁移所需的配置出现在DMS UI中，但是它们非常重要，值得重复！</p><p id="464f" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated"><strong class="hu ju">服务器标识配置</strong></p><p id="c34e" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">如果您正在迁移MySQL(我可能碰到过几次，我说的几次是指很多次)，不要忘记更改您的源数据库的<code class="du jv jw jx jy b">server_id</code>。TL；灾难恢复是指当您设置副本时，每个数据库必须有一个不同的<code class="du jv jw jx jy b">server_id</code>。你可以用几种不同的方法来改变它。如果您是手动或通过脚本启动mysqld进程，您可以用<code class="du jv jw jx jy b">--server-id=#</code>标志来启动它。您可以使用客户端连接到db并运行<code class="du jv jw jx jy b">SET GLOBAL server_id=#</code>，但是注意如果您这样做，您必须记住每次服务器重置时都要重新执行。最后，您可以在my.cnf文件中设置:</p><pre class="jz ka kb kc fd kd jy ke kf aw kg bi"><span id="a46e" class="kh is ht jy b fi ki kj l kk kl">[mysqld]<br/>server_id = #</span></pre><p id="3055" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated"><strong class="hu ju">绑定地址配置</strong></p><p id="2bbf" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">另一个需要注意的大问题是数据库的<code class="du jv jw jx jy b">bind-address</code>,我也提到过几次。同样，这在其他帖子中有更详细的介绍，但要修复它(注意这里你应该小心，因为它可能是一个安全风险)，你需要在你的配置中将其从默认的(至少对于MySQL)127 . 0 . 0 . 1更改为0.0.0.0。这就是为什么它可以允许来自任何地方的连接，而不仅仅是本地连接。您还可以尝试更有针对性地输入创建的云SQL数据库的IP地址，但是确切的IP地址可能有点难以确定。云SQL不保证传出IP地址，因此指定当前地址可能不起作用。</p><p id="1874" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">对于server_id和bind-address，不要忘记，如果您正在更改配置文件，您需要重新启动数据库服务，以便更改生效。</p><h1 id="ac2c" class="ir is ht bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">连接选项和设置</h1><p id="0adc" class="pw-post-body-paragraph hr hs ht hu b hv jp hx hy hz jq ib ic id jr if ig ih js ij ik il jt in io ip hb bi translated">DMS提供了一个矩阵，说明如何将源数据库连接到迁移设置中创建的新云SQL实例。选择最适合源数据库所在位置、组织的安全策略和迁移要求的方法。</p><figure class="jz ka kb kc fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es km"><img src="../Images/0b2d5dc9c75afc2b55b2780d86e74241.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2G0983pefuZLKqBZHnTpjw.png"/></div></div></figure><p id="4f2c" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">如您所见，大多数决定都归结于您需要多安全。例如，考虑使用IP allowlist方法意味着在网络的防火墙上戳一个洞来接收流量。根据您公司的安全策略，这可能是不可能的。</p><p id="d8c4" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">让我们开始吧。</p><h1 id="4718" class="ir is ht bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">DMS连接配置文件</h1><p id="90db" class="pw-post-body-paragraph hr hs ht hu b hv jp hx hy hz jq ib ic id jr if ig ih js ij ik il jt in io ip hb bi translated">定义源时，创建一个连接配置文件，该文件定义了用于连接源数据库的信息。</p><figure class="jz ka kb kc fd hk er es paragraph-image"><div class="er es kn"><img src="../Images/a373fdf08dac6fa325c826475d716d35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/0*HLpUi6rYLE3jOKoZ"/></div></figure><p id="04c3" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">这些连接配置文件是独立的资源，因此一旦创建了一个，就可以在将来的迁移中重用。重用的用例可能是这样的，作为对数据库进行分片的一个步骤，您可能希望将同一个数据库迁移到多个目标云SQL实例，这些实例位于某种代理或负载平衡器之后。然后，您可以将每个单独的实例削减到每个实例中只包含您想要的分片数据，而不是小心翼翼地只从主实例中提取分片数据。</p><p id="a817" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">连接配置文件由以下组件组成:源数据库引擎、名称和ID、数据库本身的连接信息(主机、端口、用户名、密码)以及是否要对连接实施SSL加密。这里的一切都很简单，除了SSL连接，如果您不熟悉SSL配置，这可能会令人困惑。DMS支持不加密、仅服务器加密或服务器-客户端加密。关于这一点的<a class="ae iq" href="https://cloud.google.com/sql/docs/mysql/replication/external-server?&amp;_ga=2.138198707.-2094339598.1602876430#ssltls_configuration" rel="noopener ugc nofollow" target="_blank">文档</a>很好的解释了这一点！</p><p id="4a2b" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">简而言之:Server-only告诉云验证您的源数据库，server-client告诉两者互相验证。最佳实践当然是始终加密和验证。如果你真的只是玩玩，不想处理生成SSL密钥，那么当然，不要加密。但是，如果这是所有生产数据，或任何形式的敏感数据，特别是如果您使用公共连接进行连接，请务必进行加密和验证。</p><p id="3b02" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">当您想要的时候，这里最困难的部分是生成和使用正确的密钥。DMS使用<a class="ae iq" href="https://www.ssl.com/faqs/what-is-an-x-509-certificate/" rel="noopener ugc nofollow" target="_blank"> x509格式的SSL密钥</a>。关于使用SSL生成和保护实例的信息，如果您以前没有做过，可以在MySQL的<a class="ae iq" href="https://dev.mysql.com/doc/refman/5.7/en/creating-ssl-rsa-files-using-mysql.html" rel="noopener ugc nofollow" target="_blank">这里</a>和PostgreSQL的<a class="ae iq" href="https://www.postgresql.org/docs/9.5/ssl-tcp.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。无论哪种方式，作为迁移准备的一部分，您都需要确保准备好您的密钥。例如，在MySQL上，您可以运行<code class="du jv jw jx jy b">mysql_ssl_rsa_setup</code>来获取实例的密钥，它会给出一串:</p><pre class="jz ka kb kc fd kd jy ke kf aw kg bi"><span id="c40b" class="kh is ht jy b fi ki kj l kk kl">ca.pem<br/>ca-key.pem<br/>client-cert.pem<br/>client-key.pem<br/>private_key.pem<br/>public_key.pem<br/>server-cert.pem<br/>server-key.pem</span></pre><p id="ceb6" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">如果您和我一样，相对来说是一个设置服务器SSL的新手，那么您可以通过使用客户机通过SSL进行连接来进行测试，以确保您已经正确设置了SSL。例如，对于MySQL，你可以:<code class="du jv jw jx jy b">mysql -u root -h localhost — ssl-ca=ca.pem — ssl-cert=client-cert.pem — ssl-key=client-key.pem — ssl-mode=REQUIRED -p</code>强制测试你的键是否正确。</p><p id="c215" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">我在使用上传字段上传正确的格式化密钥时遇到了一点困难。它抱怨x509键的格式不正确，尽管我确认我已经正确地包装了它们(或者至少我认为我是肯定的，无论如何我都不是SSL专家)。对我来说，如果您得到同样的错误，解决方案是简单地从上传密钥文件切换到手动输入它们，并将密钥的内容复制/粘贴到字段中。那非常有效！</p><p id="fa93" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">好了，现在我们已经讨论了源端，是时候讨论我们可以用来连接源和即将创建的云SQL实例的不同方法了。</p><p id="4464" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">创建目的地很简单，因为您要指定一个云SQL实例。DMS处理设置复制和准备接收数据的所有工作。需要注意的一点是连接方法。如果使用IP allowlist，您需要为云SQL实例上的连接设置公共IP，对于反向SSH和VPC对等，您需要设置私有IP。如果您使用VPC对等，请确保将云SQL实例与源数据库所在的GCE实例放在同一个VPC中。不要担心，如果您忘记选择正确的设置或改变主意，DMS将在您选择连接设置时更新云SQL实例设置。</p><p id="af5a" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">正如我上面概述的，有三种不同的方法可以弥补这个差距:IP允许列表、反向SSH隧道和VPC对等。实际上，这个决定归结为一个考虑因素:你需要多安全。可能是因为一些行业法规、内部政策，或者只是因为数据库中涉及的数据需要安全。</p><p id="1369" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">在我们进入细节之前，请注意……迁移数据库(对我来说)最困难的部分之一，无论是在您的家用机器上，还是在您办公室服务器机房的本地服务器上，还是在其他云中，都是在各种防火墙、路由器、机器和互联网之间创建网络路径。我被困在这里的时间比我想承认的要长，直到我意识到我不仅有一个路由器，我必须在它们之间转发端口，以便它知道如何找到我的本地数据库，而且我还在我的调制解调器/路由器上有一个防火墙，它位于互联网和我的内部交换机之间，而我没有通过它转发。因此，明智的做法是，对网络上的每一跳进行三次检查，确保它是从外部正确转发的。如果您身边有网络专家可以帮忙，他们甚至可以帮助您创建连接配置文件供以后使用！</p><h1 id="9d46" class="ir is ht bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">IP允许列表</h1><figure class="jz ka kb kc fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es km"><img src="../Images/a336bb30b5d27e40c7f5d6b7f67c4025.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XD4tjWDo3gHplGol"/></div></div></figure><p id="18c2" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">从数量级来看，IP allowlisting是连接两点的最简单方法。当创建云SQL实例作为迁移设置的一部分时，您将添加一个指向源数据库IP地址的授权网络，相反，您需要在自己的防火墙上打开一个洞，以允许云SQL与源数据库对话。在我的例子中，运行本地数据库意味着搜索<a class="ae iq" href="https://www.google.com/search?q=whatsmyip" rel="noopener ugc nofollow" target="_blank">whats mimip</a>，并将ip复制到云SQL创建中的授权网络中。另一方面，我在我的防火墙上创建了一个端口转发，用于来自云SQL传出IP地址的流量，这是DMS在连接步骤中提供给我的(但我也可以从云SQL实例的详细信息页面复制)，然后到达我的本地数据库的机器，我们就出发了。除了我上面提到的关于确保检查您的网络拓扑是否有任何东西阻止路由到达您的数据库之外，我没有遇到任何关于这种方法的特殊问题。</p><p id="693b" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">IP allowlist是三种连接方法中最不安全的。我不是说它天生就没有安全感。只要您还在使用SSL加密，您可能会发现它对于您的正常用例来说仍然是非常安全的。只是与反向SSH隧道或使用VPC对等网络相比，它的安全性要差一些。都是相对的！</p><h1 id="ba91" class="ir is ht bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">通过云托管虚拟机的反向SSH隧道</h1><figure class="jz ka kb kc fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es km"><img src="../Images/8d3dab57f855b74c91823213bacf668c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8Sy-9-ZCkY97d8mj"/></div></div></figure><p id="0314" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">安全领域的下一步将是反向SSH隧道。如果你以前没用过这个，或者不知道这是什么，我真的很喜欢<a class="ae iq" href="https://unix.stackexchange.com/questions/46235/how-does-reverse-ssh-tunneling-work" rel="noopener ugc nofollow" target="_blank">这个人在栈交换上的回答</a>。这是一个很好的、彻底的解释，很容易理解发生了什么。简而言之，可以把它看作是在源数据库网络、Google Compute Engine中的一个虚拟机实例和您要迁移到的云SQL实例之间建立的一个文字隧道。这个隧道保护你的流量不受它通过的互联网的影响。</p><p id="8750" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">好了，有了这个方法，我们就有了一个额外的组件:我们用作SSH隧道的连接器的虚拟机。这又增加了一层有趣的复杂性！在很大程度上，DMS会为您处理这一过程。当您在UI中选择Reverse-SSH作为连接方法时，您可以选择使用现有的虚拟机，或者创建一个虚拟机。无论采用哪种方式，都会为您生成一个脚本，当从能够访问您的源数据库的机器上运行该脚本时，它会以这样一种方式设置VM，使得它能够成功地用作SSH隧道目标。</p><p id="69d1" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">与所有自动化的事情一样，这里有一些可能发生的问题，会导致一些相当难以诊断的阻塞。我要注意的事情:</p><p id="0a12" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated"><strong class="hu ju"> VM_ZONE </strong></p><p id="6663" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">现在UI在这方面做得很好，但是要注意，如果您设法在云SQL实例完成设置之前查看了VM设置脚本(创建云SQL实例有时可能需要大约五分钟)，那么脚本中的一个变量将无法正确设置:<code class="du jv jw jx jy b">VM_ZONE</code>。</p><figure class="jz ka kb kc fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ko"><img src="../Images/8ed4fdae4d98c97c4a0dc36c12962fd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/0*ZZ95xAIy3lpY_Cpn"/></div></div></figure><p id="968a" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">它没有正确的区域，您必须填充它，并且/或者在云SQL实例创建完成后重新点击“查看脚本”按钮来填充它。</p><p id="f498" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated"><strong class="hu ju">机器类型</strong></p><p id="bc98" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">在撰写这篇博客时，这个问题还没有得到解决，但是如果你将机器类型下拉列表作为默认设置，那么<code class="du jv jw jx jy b">VM_MACHINE_TYPE</code>也是一个错误的变量。该变量将在脚本中被设置为<code class="du jv jw jx jy b">db-n1-standard-1</code>，而实际上它应该是<code class="du jv jw jx jy b">n1-standard-1</code>。这将无法创建虚拟机。</p><p id="e1d5" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated"><strong class="hu ju">服务器ID </strong></p><p id="989e" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">如果您正在迁移MySQL，请反复检查您的server_id是否设置为非零值。我知道，我以前说过。这一步我可能忘了，也可能没忘，因为它损失了一些时间。只是说说而已。</p><p id="e3bb" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">该脚本还会立即在后台建立反向隧道，代码如下:</p><p id="9f56" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated"><code class="du jv jw jx jy b">gcloud compute ssh “${VM_NAME}” — zone=”${VM_ZONE}” — project=”${PROJECT_ID}” — -f -N -R “${VM_PORT}:${SOURCE_DB_LOCAL_IP}:${SOURCE_DB_LOCAL_PORT}”</code></p><p id="ddf4" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">注意，这个脚本将在你运行它的机器的后台运行一些东西。上面命令中的-f是导致它出现在后台的原因。我不喜欢在后台运行的东西，主要是因为如果我不想让它一直运行，我就必须记得停止它。在这种情况下，如果我进行多次迁移，可能会弄不清应该使用哪个通道，或者其他一些边缘情况。所以对我来说，我将这个命令从脚本中剥离出来，运行它来生成VM，然后在终端中运行这个没有-f的命令，替换来自脚本变量的值。</p><p id="b3f7" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">所以，运行这个脚本(尽管我没有把后台命令留在那里，但是如果你对它感到满意的话，也没关系，只是不要忘记你已经这样做了)。一旦你这样做了，在脚本的输出中，你会看到这样一行:echo <code class="du jv jw jx jy b">”VM instance ‘${VM_NAME}’ created with private ip ${private_ip}”</code>。您需要在DMS迁移步骤4的字段<code class="du jv jw jx jy b">VM server IP</code>中输入IP地址。</p><figure class="jz ka kb kc fd hk er es paragraph-image"><div class="er es kp"><img src="../Images/e07fe80314c8f81ad08d7c42dc23adc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/0*wWqlWe9he4kwZGDt"/></div></figure><p id="628f" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">还记得我说过网络连接是一项挑战吗？我没开玩笑。现在，虚拟机又增加了一层复杂性。默认情况下，Google Compute Engine虚拟机被防火墙牢牢锁定(安全！！！即使这会让我们的生活变得更复杂，但它们是好的。为了让reverse-SSH工作，我们需要为我们的VM打开一个针孔，以便与我们创建的云SQL实例进行通信，即使是在内部网络上。为此，我们需要创建一个新的防火墙规则。</p><p id="4dd2" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">首先，我们想尽可能地把事情控制住。为此，请转到您刚刚创建的虚拟机的详细信息页面。这里的虚拟机列表是<a class="ae iq" href="https://console.cloud.google.com/compute/instances" rel="noopener ugc nofollow" target="_blank"/>。编辑您的虚拟机，向下滚动找到网络标签部分:</p><figure class="jz ka kb kc fd hk er es paragraph-image"><div class="er es kq"><img src="../Images/a31c14ef55c180cfedc3fa1036200238.png" data-original-src="https://miro.medium.com/v2/resize:fit:482/0*6T7DRCV0eqAI-zrW"/></div></figure><p id="acac" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">这使您可以通过防火墙规则精确定位这个实例。标签可以是任何东西，但是记住下一步要用什么。</p><p id="afe8" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">前往控制台的防火墙区域。在网络-&gt; VPC网络-&gt;防火墙下面。或者直接点击<a class="ae iq" href="https://console.cloud.google.com/networking/firewalls" rel="noopener ugc nofollow" target="_blank">这里</a>。创建新的防火墙规则。给它一个名字，如果你使用不同于默认的VPC进行迁移，确保在<code class="du jv jw jx jy b">Network</code>下拉菜单中选择正确的。然后在Targets字段中，将它保留在<code class="du jv jw jx jy b">Specified target tags</code>上，并在下面的字段中，放置您添加到VM中的相同标记。现在，对于源滤波器，我们有一点奇怪。</p><p id="c282" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">让我解释一下。流量来自云SQL，通过隧道返回到您的源，以确保连接性。您可以回顾一下本节开头的图表，看看它是什么样子的。</p><p id="0ff2" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">这意味着云SQL将尝试穿过防火墙到达虚拟机，这就是我们需要这样做的原因。这里有一个陷阱。您看到的云SQL的IP地址，您可能认为是您需要放入我们防火墙的IP范围过滤器中的，但实际上并不是云SQL用于传出流量的IP地址。这导致的情况是，我们不知道需要在这里过滤的IP地址。云SQL不保证传出云SQL流量的静态地址。</p><p id="f6f7" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">因此，为了解决这个问题，我们需要允许云SQL使用整个IP地址块。通过将<code class="du jv jw jx jy b">10.121.1.0/24</code>放入<code class="du jv jw jx jy b">Source IP ranges</code>字段来实现。不幸的是，这是不可避免的灾祸。为了进一步锁定它，如果你对这样做感到紧张(它们是内部IP，所以真的没那么糟糕)，你可以在你的防火墙的<code class="du jv jw jx jy b">Protocols and ports</code>部分，只允许<code class="du jv jw jx jy b">tcp</code>作为你的数据库引擎的默认端口(MySQL是3306，PostgreSQL是5432)。因此，防火墙将只允许来自该内部IP范围的流量，并且只允许您的数据库引擎端口上的流量，并且只允许我们创建的那台虚拟机的流量。</p><p id="4cda" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">防火墙到此为止，继续点击<code class="du jv jw jx jy b">Create</code>。理论上，我们现在应该准备好了！如果您没有在脚本中运行实际的命令来设置隧道，那么现在运行它(这是我们在这里讨论的命令:<code class="du jv jw jx jy b">gcloud compute ssh “${VM_NAME}” — zone=”${VM_ZONE}” — project=”${PROJECT_ID}” — -N -R “${VM_PORT}:${SOURCE_DB_LOCAL_IP}:${SOURCE_DB_LOCAL_PORT}”</code>)。</p><p id="b023" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">一旦开始，你就可以点击<code class="du jv jw jx jy b">Configure &amp; Continue</code>开始测试工作了！假设所有的明星都站在一起，网络之神也支持你，点击“测试工作”应该会导致一个成功的测试，你就可以迁移了！</p><h1 id="b686" class="ir is ht bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">VPC对等</h1><p id="e16e" class="pw-post-body-paragraph hr hs ht hu b hv jp hx hy hz jq ib ic id jr if ig ih js ij ik il jt in io ip hb bi translated">唷，好吧。两个方法搞定了，还有一个。</p><figure class="jz ka kb kc fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kr"><img src="../Images/06f09748800e888cfaf3bffdc307e262.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pjXiRiJpJMWIYJlD"/></div></div></figure><p id="3ff8" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">VPC对等类似于IP允许列表，非常简单，只要你不忘记我上面提到的基本原则。Server_id，确保源数据库的绑定地址设置为允许来自目标数据库的连接，等等。</p><p id="7938" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">有两种情况(可能更多，但主要是两种)需要使用VPC对等:</p><ol class=""><li id="a656" class="ks kt ht hu b hv hw hz ia id ku ih kv il kw ip kx ky kz la bi translated">您的源数据库已经在Google Cloud上运行，就像在计算引擎实例上一样。</li><li id="c3ee" class="ks kt ht hu b hv lb hz lc id ld ih le il lf ip kx ky kz la bi translated">您已经建立了一些网络，使用类似于<a class="ae iq" href="https://cloud.google.com/network-connectivity/docs/vpn" rel="noopener ugc nofollow" target="_blank">云VPN </a>或<a class="ae iq" href="https://cloud.google.com/network-connectivity/docs/interconnect" rel="noopener ugc nofollow" target="_blank">云互联</a>的东西将您的源数据库网络对等到Google云网络。</li></ol><p id="9930" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">窥视外部网络进入GCP还有另一个深不可测的问题。在某些情况下，它涉及到区域内的硬件路由、成本与吞吐量的考虑等。这有点超出了这篇博文的范围，因为可能的组合往往会带来非常具体的要求，这篇博文最终会成为一篇中篇小说。所以现在，我要掩饰一下，只是说将您的外部网络加入到Google Cloud的内部网络并使用VPC对等技术以这种方式进行迁移是完全可能的。在我们的文档中有一页是用一个例子来谈论它的，如果你想在这里挖掘更多的<a class="ae iq" href="https://cloud.google.com/database-migration/docs/mysql/configure-connectivity-vpns?hl=en" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="3a8b" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">然而，VPC对等的一个更传统的用法是，当您有一个运行在计算引擎上的数据库，并且想要切换到更易于管理的云SQL解决方案时。您最初希望在计算引擎上运行数据库有几个原因。你所依赖的一个特殊标志在Cloud SQL上是不可变的，或者你需要的MySQL或PostgreSQL的一个版本是不可用的，等等。</p><p id="7a07" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">无论出于什么原因，您将它放在GCE上，现在您会希望它在云SQL上进行管理，而VPC对等是一条可行之路。在这里，您需要仔细检查数据库上的配置设置，以确保它已经准备好，就像我之前提到的那样。当创建源连接配置文件时，IP地址将是GCE VM的内部IP，而不是外部IP(保持在私有网络内部)。您将需要与我描述的反向SSH隧道一样的防火墙设置。请注意，当您使用VPC时，您需要允许进入GCE实例的云SQL实例的IP地址将不是标准的云SQL范围(10.121.1.0/24 ),因为它将在VPC中被分配一个IP范围。因此，您需要前往云SQL <a class="ae iq" href="https://console.cloud.google.com/sql/instances" rel="noopener ugc nofollow" target="_blank">实例页面</a>，获取那里的读取副本的内部IP地址。如果您没有看到您在DMS目标步骤中创建的实例，或者如果没有指定内部IP地址，它可能还没有创建。确实需要几分钟。</p><p id="c8b1" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">最后一点就是要确保无论你想在VPC发生什么，所有的部分都需要在同一个网络中。您创建的云SQL目的地，以及保存源数据库的GCE实例。这意味着如果你愿意的话，你可能需要先把它们都搬到一个新的VPC。在默认的VPC这样做肯定没有错，但是注意如果这是一个非常老的项目，那么你可能会有一个<em class="lg">遗产</em>默认VPC。如果您这样做，这将不起作用，您将需要创建一个新的VPC来进行迁移。</p><h1 id="ec54" class="ir is ht bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">额外故障排除</h1><p id="3cef" class="pw-post-body-paragraph hr hs ht hu b hv jp hx hy hz jq ib ic id jr if ig ih js ij ik il jt in io ip hb bi translated">如果你有任何关于连接的问题，这是很复杂的，所以这里的机会大于零，除了我上面已经提到的，还有一些事情一定要尝试和检查。</p><p id="0a08" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">1)日志记录。这里有两个地方可以帮忙。在托管数据库的GCE实例或反向SSH隧道的主机的详细信息中，有一个指向<code class="du jv jw jx jy b">Cloud Logging</code>的链接。</p><figure class="jz ka kb kc fd hk er es paragraph-image"><div class="er es lh"><img src="../Images/2fb3cb2cbe7b24e9d1e58dfee87cee13.png" data-original-src="https://miro.medium.com/v2/resize:fit:738/0*2JxHjRSgSIl2OOfB"/></div></figure><p id="b839" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">单击它会直接将您带到对该GCE条目的日志过滤。那么第二个位置是在你使用的VPC网络的子网上。您可以到<a class="ae iq" href="https://console.cloud.google.com/networking/networks/list" rel="noopener ugc nofollow" target="_blank">这里</a>，然后点击您的GCE实例所在的区域，编辑它，并打开流日志。完成后，您可以重新尝试迁移测试，然后检查日志，看是否有任何可疑之处。</p><p id="3f4d" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">2) <a class="ae iq" href="https://cloud.google.com/network-intelligence-center/docs/connectivity-tests" rel="noopener ugc nofollow" target="_blank">连通性测试</a>。在我使用DMS之前，我并不知道这一点，它非常方便。它允许您指定两个不同的IP地址(源和目的地)，一个您想要查看的端口(MySQL 3306，PostgreSQL 5432)，并且它将为您提供一个拓扑，显示从a点到b点经过了哪些跳，应用了哪些防火墙规则来允许或拒绝流量。超级好玩。你可以在控制台<a class="ae iq" href="https://console.cloud.google.com/net-intelligence/connectivity/tests/list" rel="noopener ugc nofollow" target="_blank">这里</a>直接去玩它。它确实需要网络管理API来支持它。</p><h1 id="3150" class="ir is ht bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo bi translated">结论</h1><p id="ff29" class="pw-post-body-paragraph hr hs ht hu b hv jp hx hy hz jq ib ic id jr if ig ih js ij ik il jt in io ip hb bi translated">就是这样！希望我已经为您介绍了如何将源数据库连接到DMS以便将数据库迁移到云SQL的基础知识。一旦你完成了迁移，还有一些事情要处理，我们即将发布的博客文章也会涉及到这些细节。</p><p id="bcf8" class="pw-post-body-paragraph hr hs ht hu b hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip hb bi translated">如果您有任何问题、建议或投诉，请在下方评论或通过<a class="ae iq" href="https://twitter.com/GabeWeiss_" rel="noopener ugc nofollow" target="_blank"> Twitter </a>联系我，我的DMs是开放的！感谢阅读。</p></div></div>    
</body>
</html>