<html>
<head>
<title>Monitor VPC-SC violations on your GCP org with Data Studio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Data Studio监控您的GCP组织违反VPC-SC的情况</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/create-a-data-studio-dashboard-to-monitor-vpc-sc-violations-on-your-google-cloud-organization-bf8f3bead691?source=collection_archive---------1-----------------------#2021-01-05">https://medium.com/google-cloud/create-a-data-studio-dashboard-to-monitor-vpc-sc-violations-on-your-google-cloud-organization-bf8f3bead691?source=collection_archive---------1-----------------------#2021-01-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6f70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">TL；DR: <a class="ae jd" href="https://cloud.google.com/vpc-service-controls" rel="noopener ugc nofollow" target="_blank"> Google Cloud VPC服务控制</a>是减少您组织中数据泄露的关键功能。在现有项目中实施这种方法可能会面临挑战:您可能会使资源不可用，或者中断生产应用程序和工作负载。在这篇文章中，我想分享一些提示，以尽量减少激活它时的问题，使用Data Studio(*)监控VPC-SC违规。</p><p id="6c8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(*)注意:一旦您启用了VPC-SC，Data Studio将无法工作，如果BigQuery数据集是由VPC-SC执行的，您将需要使用不同的工具。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/cba68bacd34c37610c3d8adfdb58ccd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k6RNw5RnxTjdMMqq2d50Cg.png"/></div></div></figure><p id="1071" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了减少数据泄露，您的组织可能已经将<a class="ae jd" href="https://cloud.google.com/vpc-service-controls" rel="noopener ugc nofollow" target="_blank"> VPC服务控制</a>确定为在您的GCP组织中启用的关键功能。该功能将帮助您在项目周围创建安全<a class="ae jd" href="https://cloud.google.com/vpc-service-controls/docs/service-perimeters" rel="noopener ugc nofollow" target="_blank">周界</a>。在这些范围内，您将能够决定哪些服务可以访问，哪些是允许的源(基于<a class="ae jd" href="https://cloud.google.com/access-context-manager/docs/overview#user_identity" rel="noopener ugc nofollow" target="_blank">用户身份</a>、<a class="ae jd" href="https://cloud.google.com/access-context-manager/docs/overview#ip_address" rel="noopener ugc nofollow" target="_blank"> IP </a>或<a class="ae jd" href="https://cloud.google.com/access-context-manager/docs/overview#device_type" rel="noopener ugc nofollow" target="_blank">设备类型</a>)。</p><p id="3e95" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您打算在有实时生产GCP工作负载的组织上启用该特性，这可能会很有挑战性。如果您错误地配置了VPC-SC，您可能最终会阻止需要通信的资源之间的通信。</p><p id="3bee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了缓解这些问题，我建议采取三步走的方法:</p><ol class=""><li id="5d18" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc jv jw jx jy bi translated">熟悉该功能</li><li id="0b47" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc jv jw jx jy bi translated">设计您的外围架构</li><li id="d444" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc jv jw jx jy bi translated">设置模拟运行模式，监控并修复违规情况</li></ol><p id="400d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我将深入讨论修复VPC-SC违规的重要性，并分享我写的一个仪表板来帮助监控和分组它们。</p><h1 id="6436" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">熟悉该功能</h1><p id="96ef" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">你可以找到很多关于这个的<a class="ae jd" href="https://cloud.google.com/vpc-service-controls" rel="noopener ugc nofollow" target="_blank">文档。我不想在这篇文章中讨论VPC-SC的特性，但是根据我的经验，VPC-SC是一个容易被误解的特性，我真的建议您熟悉它，并在您的组织上做一些测试。</a></p><p id="db36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我建议测试简单的场景，例如:</p><ul class=""><li id="7190" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc lh jw jx jy bi translated">VPC-南卡罗来纳州边界内项目中的GCS存储桶或Bigquery数据集:如果我从边界内访问资源，会发生什么情况？从外围看呢？</li><li id="5504" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc lh jw jx jy bi translated">访问级别支持什么？</li><li id="36d0" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc lh jw jx jy bi translated">VPC-SC和共享VPC是如何干涉的？</li></ul><h1 id="0752" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">设计您的外围架构</h1><p id="ba57" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">一旦您熟悉了VPC-SC的功能，您就可以开始设计您的外围架构。列出您的业务需求，并确定VPC-SC的特性来满足每一项需求。下面你可以找到我在几个组织中看到的一些模式:</p><ul class=""><li id="2f39" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc lh jw jx jy bi translated">为组织中配置的每个共享VPC创建一个边界。</li><li id="7f5a" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc lh jw jx jy bi translated">为每个环境(生产、集成、开发等)创建一个边界，但不如您的共享VPC配置精细。</li><li id="1034" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc lh jw jx jy bi translated">为您公司的Internet代理创建访问级别。该访问级别将允许您的员工在连接到公司网络时访问GCP控制台上的资源。</li><li id="aef9" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc lh jw jx jy bi translated">为landing项目创建一个边界，并在landing项目和prod / no prod项目之间桥接边界，以让onprem资源访问受VPC服务控制保护的GCP资源。</li></ul><p id="72bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个架构示例:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es li"><img src="../Images/bab2fff6965270f4fb6d30e8392034a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w3WbdUxS4RLsDHHMugg3NQ.png"/></div></div></figure><h1 id="1645" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">设置模拟运行模式，监控并修复违规情况</h1><p id="bdb9" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">一旦你确定了你的VPC-SC架构，就在试运行模式下实现它，并监控你的日志来检查你是否能够捕获你的所有用例，以及你的架构是否满足你的所有需求。</p><p id="74be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">跨项目检查日志可能具有挑战性。我的建议是在文件夹或组织级别创建一个<a class="ae jd" href="https://cloud.google.com/logging/docs/export" rel="noopener ugc nofollow" target="_blank">日志导出同步</a>到<a class="ae jd" href="https://cloud.google.com/logging/docs/export/bigquery" rel="noopener ugc nofollow" target="_blank"> Bigquery </a>。您可以使用以下gcloud命令创建一个:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="0750" class="lo kf hi lk b fi lp lq l lr ls">gcloud beta logging sinks create SINK_NAME\<br/>bigquery.googleapis.com/projects/PROJECT_ID/datasets/DATASET_NAME \<br/> - folder=FOLDER_ID \<br/> - include-children \<br/> - log-filter='protoPayload.metadata.<a class="ae jd" href="http://twitter.com/type" rel="noopener ugc nofollow" target="_blank">@type</a>:"type.googleapis.com/google.cloud.audit.VpcServiceControlAuditMetadata"' \<br/> - use-partitioned-tables</span></pre><p id="3d89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从现在开始，GCP会将您的日志复制到指定的Bigquery数据集:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lt"><img src="../Images/21d79b74a69c7f50af8d4cdfc386551e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IsKFxOrCIiyzM_WegWsCMw.png"/></div></div></figure><p id="0846" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要轻松导航和分组日志，您可以创建一个简单的Data Studio仪表板:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lu"><img src="../Images/f40d07cda21c68a26673e00e906e5246.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-oCuLgGUUm2G0wRxqstflg.png"/></div></div></figure><p id="70ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用以下查询创建Data Studio数据集:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="d704" class="lo kf hi lk b fi lp lq l lr ls">SELECT<br/>   *,<br/>    CASE<br/>      WHEN REGEXP_CONTAINS(protopayload_auditlog.status.message,'(Dry Run Mode)*') THEN 'Dry Run'<br/>      ELSE 'Enforced'<br/>    END enforced_type,<br/>    CASE<br/>      WHEN REGEXP_CONTAINS(protopayload_auditlog.requestMetadata.callerIp, r"(^127\.)|(^10\.)|(^172\.1[6-9]\.)|(^172\.2[0-9]\.)|(^172\.3[0-1]\.)|(^192\.168\.)") OR protopayload_auditlog.requestMetadata.callerIp = 'private' THEN 1<br/>      ELSE 0<br/>    END internal_ip,<br/>    REGEXP_EXTRACT(protopayload_auditlog.metadataJson, r'servicePerimeterName":"[a-zA-Z]+\/[\d]+\/[a-zA-Z]+\/([a-zA-Z]+)') as perimeter,<br/>    REGEXP_EXTRACT(protopayload_auditlog.metadataJson, r'violationReason":"([a-zA-Z_]+)') as violation_reason,    <br/>FROM <br/>  `PROJECT_ID.DATASET_NAME.cloudaudit_googleapis_com_policy`</span></pre><p id="cdc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并根据上面的查询复制<a class="ae jd" href="https://datastudio.google.com/s/lHElSSxQq_k" rel="noopener ugc nofollow" target="_blank">示例仪表板</a>。</p><p id="dc11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在仪表板中，您可以在几个维度上对违规进行分组:</p><ul class=""><li id="7b73" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc lh jw jx jy bi translated">按项目</li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lv"><img src="../Images/b6a7eab00dbbcf28aaa94a669cfcbc39.png" data-original-src="https://miro.medium.com/v2/resize:fit:678/format:webp/1*zsEz2Iix1opOYyrgUJ31lg.png"/></div></figure><ul class=""><li id="6b22" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc lh jw jx jy bi translated">按周长</li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lw"><img src="../Images/62f2cdcd2dd54e2e0c605b22b4d169d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/format:webp/1*v4c26ZNihx7J1xdDiGNTdg.png"/></div></figure><ul class=""><li id="0fd8" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc lh jw jx jy bi translated">按违规原因</li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lx"><img src="../Images/bc2ff5f4b728da1b9a2880bdb791da1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:586/format:webp/1*P-0IAw_FwADPxdHZ56eyhg.png"/></div></figure><p id="a10e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以创建最有助于加快修复意外违规的操作的分组标准。</p><h1 id="8c13" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">后续步骤</h1><p id="8f01" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">一旦您修复了VPC SC日志中的所有意外违规，请强制执行您的配置，并在您的GCP资源上更安全地保存您的所有数据。现在，您可以通过限制可以访问您的数据的设备类型或IP来减少GCP资源上的数据泄漏！！！</p></div></div>    
</body>
</html>