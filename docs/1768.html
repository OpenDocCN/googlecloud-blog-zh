<html>
<head>
<title>A quick GKE logs primer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GKE原木快速入门</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/a-quick-gke-logs-primer-a978f60daa7?source=collection_archive---------0-----------------------#2021-01-22">https://medium.com/google-cloud/a-quick-gke-logs-primer-a978f60daa7?source=collection_archive---------0-----------------------#2021-01-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="030f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用GKE时，一个不可避免的话题是如何利用其与谷歌云运营的整合。这是一个重要的话题，不仅对于计划将多租户集群及其安装到GCP基金会的客户来说如此，对于排除单个集群或部署的故障来说也是如此。</p><p id="9970" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦对不同类型的日志和资源有了清晰的了解，将GKE日志记录的范围缩小到表面审计、安全和健康信号并不像看起来那么难。这篇文章将为您提供一个快速入门，希望足以让您开始并消除处理GKE日志的最初痛苦。</p><p id="02c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">开始之前有一点需要注意:讨论登录GKE的不同选项超出了本文的范围，我们假设您的集群已经启用了<a class="ae jd" href="https://cloud.google.com/stackdriver/docs/solutions/gke/installing" rel="noopener ugc nofollow" target="_blank">登录到云操作</a>(这是新集群的默认设置)。</p><h1 id="3242" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">日志名称和资源</h1><p id="7369" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在处理实际的日志之前，让我们快速回顾一下我们将在<a class="ae jd" href="https://cloud.google.com/logging/docs/view/advanced-queries" rel="noopener ugc nofollow" target="_blank">日志查询</a>中用来隔离特定信息的两个关键字段。</p><p id="cc30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我最喜欢的领域是<code class="du kh ki kj kk b"><a class="ae jd" href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry#FIELDS.log_name" rel="noopener ugc nofollow" target="_blank">logName</a></code>，尤其是在处理一般级别的日志时(例如，当设置组织接收器时，或者像我们在这里所做的那样，计算出什么信息最终在哪里)。该字段是唯一的句柄，用于标识特定日志流的“资源名称”,并允许您清晰、快速地隔离属于单一日志类型(审核、实例日志等)的记录组。).</p><p id="aac9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一个非常有用的字段当然是<code class="du kh ki kj kk b">resource</code>，特别是<code class="du kh ki kj kk b"><a class="ae jd" href="https://cloud.google.com/logging/docs/reference/v2/rest/v2/MonitoredResource#FIELDS.type" rel="noopener ugc nofollow" target="_blank">resource.type</a></code>属性，它允许过滤特定GCP资源(集群、实例等)发出的记录。).</p><p id="e4c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将在查询中使用一些其他字段，当然，GKE日志记录代理还包括日志记录中的资源和Kubernetes元数据，这些元数据可以在过滤器中使用，但是基本的内容已经完成，让我们开始查看实际的日志。</p><h2 id="595a" class="kl jf hi bd jg km kn ko jk kp kq kr jo iq ks kt js iu ku kv jw iy kw kx ka ky bi translated">活动日志</h2><p id="40f0" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">最重要的当然是<a class="ae jd" href="https://cloud.google.com/logging/docs/audit" rel="noopener ugc nofollow" target="_blank">审计日志家族</a>中的活动日志，它不能被禁用，并跟踪所有改变资源状态的操作。这是第一个(通常也是唯一一个)导出到本地系统或出于存档目的而存储的日志，因为它跟踪了谁(哪个身份)何时在哪个资源上做了什么(创建、修改或删除)。</p><p id="4b7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">活动日志通常通过特定项目的<code class="du kh ki kj kk b">logName</code>过滤器进行查询:</p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="8e28" class="kl jf hi kk b fi lh li l lj lk">logName="projects/myprj/logs/cloudaudit.googleapis.com%2Factivity"</span></pre><p id="b8c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者通过<code class="du kh ki kj kk b"><a class="ae jd" href="https://cloud.google.com/logging/docs/view/advanced-queries#log_id" rel="noopener ugc nofollow" target="_blank">log_id</a></code>功能:</p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="a7f6" class="kl jf hi kk b fi lh li l lj lk">log_id("cloudaudit.googleapis.com/activity")</span></pre><p id="77cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于GKE，活动日志包含两个独立的信息流</p><ul class=""><li id="852f" class="ll lm hi ih b ii ij im in iq ln iu lo iy lp jc lq lr ls lt bi translated">在GCP集群资源上完成的操作(创建集群等。)</li><li id="ee75" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">在集群“内部”的Kubernetes对象上完成的操作</li></ul><p id="cac9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一个信息流是所有其他GCP资源共有的，而第二个信息流是GKE特有的，通过利用<a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/concepts/audit-policy" rel="noopener ugc nofollow" target="_blank"> Kubernetes审计政策</a>来实现。简单地说，集群中修改Kubernetes对象的任何操作都会在活动日志中产生一个日志条目，而读取操作会被记录到数据访问日志中，但前提是它在项目级别被特别启用。</p><p id="6eaa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这在实践中意味着，考虑到Kubernetes集群的非常动态的性质，其中控制器不断地操纵对象，一旦您开始使用GKE，您的超级重要的活动日志的大小至少会膨胀一个数量级，这对日志导出(特别是在本地系统是目标的情况下)和分析有明显的影响。</p><p id="0717" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里是<code class="du kh ki kj kk b">resource.type</code>字段发挥作用的地方，它允许我们将活动日志分成两个独立的流:</p><ul class=""><li id="1e39" class="ll lm hi ih b ii ij im in iq ln iu lo iy lp jc lq lr ls lt bi translated">GCP资源视图，过滤<code class="du kh ki kj kk b">gke_cluster</code>资源类型，以及</li><li id="4378" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">Kubernetes视图，过滤<code class="du kh ki kj kk b">k8s_cluster</code>资源类型</li></ul><p id="88ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，如果您只想在审核日志导出中包括群集资源级别的事件，而排除群集内部的审核事件，则可以使用此筛选器:</p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="171b" class="kl jf hi kk b fi lh li l lj lk">log_id("cloudaudit.googleapis.com/activity")<br/>resource.type != "k8s_cluster"</span></pre><p id="0110" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了隔离与Kubernetes对象相关的集群内部审计事件，匹配的过滤器当然是:</p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="9a7f" class="kl jf hi kk b fi lh li l lj lk">log_id("cloudaudit.googleapis.com/activity")<br/>resource.type="k8s_cluster"</span></pre><p id="ca38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种区别非常重要，我经常看到客户实现它，因为它允许您限制审计导出的大小，并确保它只包含资源级事件，同时仍然能够为特定于Kubernetes的审计事件运行并行查询或接收器。</p><p id="0d3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于Kubernetes审计事件，还需要考虑一点:上面的过滤器选择所有修改集群对象的<strong class="ih hj">操作，包括由系统组件进行的操作。如果这不是您想要的(并且通常没有给出它们的详细程度)，可以在执行操作的身份上添加一个额外的过滤器，以便只包括用户或机器身份:</strong></p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="12f4" class="kl jf hi kk b fi lh li l lj lk">log_id("cloudaudit.googleapis.com/activity")<br/>resource.type="k8s_cluster"<br/>NOT protoPayload.authenticationInfo.principalEmail: "system"</span></pre><p id="eae0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后一个有用的过滤器允许选择导致身份验证失败的操作:</p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="2eb7" class="kl jf hi kk b fi lh li l lj lk">log_id("cloudaudit.googleapis.com/activity")<br/>resource.type="k8s_cluster"<br/>protoPayload.authenticationInfo.principalEmail="system:anonymous"</span></pre><p id="98bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们对GKE活动日志的概述到此结束。如果您需要更多的粒度来显示审计日志中的特定事件，我们的文档中使用日志浏览器  <em class="lz"> </em>页面的<a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/audit-logging#example_filters_for_your_admin_activity_log" rel="noopener ugc nofollow" target="_blank"> <em class="lz">访问审计日志</em> </a>和<a class="ae jd" href="https://cloud.google.com/logging/docs/view/query-library-preview#kubernetes-filters" rel="noopener ugc nofollow" target="_blank"> <em class="lz">示例查询有几个查询示例。现在让我们来看看更具体的GKE日志。</em></a></p><h1 id="0d75" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">事件日志</h1><p id="6ffc" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">您可能知道，<em class="lz">“Kubernetes事件是提供集群内部正在发生的事情的洞察力的对象，例如调度程序做出了什么决定，或者为什么一些pods被逐出节点”</em>。事件是了解集群内部发生的事情的重要方式，因此毫不奇怪，云操作为它们提供了特定的日志类型，并在Kubernetes OSS文档中有一个<a class="ae jd" href="https://kubernetes.io/docs/tasks/debug-application-cluster/events-stackdriver/" rel="noopener ugc nofollow" target="_blank">专用页面(引用了上面的引文)。</a></p><p id="16f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该过滤器允许隔离GKE事件:</p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="6555" class="kl jf hi kk b fi lh li l lj lk">logName="projects/myprj/logs/events</span></pre><p id="a9c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者更简单地说:</p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="87b6" class="kl jf hi kk b fi lh li l lj lk">log_id("events")</span></pre><p id="49e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该日志的用途与通过<code class="du kh ki kj kk b">kubectl</code>使用Kubernetes events几乎相同，并具有云操作提供的额外优势:更大的保留策略、通过Logs Explorer的可搜索性/聚合性、导出自定义事件指标(并可能设置警报)的能力等。</p><p id="6997" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一些事件特定于GKE，并通知管理员潜在的配置问题。例如，当GKE服务代理无法为新的负载平衡器创建防火墙规则时(这在严格控制的共享VPC设置中很常见)，会创建一个事件并将相应的警告记录到事件日志中，以便管理员可以运行等效的命令。这是一个例子:</p><figure class="kz la lb lc fd mb er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es ma"><img src="../Images/aba7ed3c217d154d0de4fa2b9eaabf08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uqU7aYK3aBvvLTV8rOfJdQ.png"/></div></div></figure><h1 id="a697" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">节点日志</h1><p id="1d0f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">运行在GKE节点上的服务(kubelet，<a class="ae jd" href="https://cloud.google.com/container-optimized-os/docs/how-to/monitoring" rel="noopener ugc nofollow" target="_blank">节点问题检测器</a>，容器运行时等)。)发出它们自己的日志，这些日志被捕获并存储，每个日志都有一个对应于组件名的单独的日志名，并且都使用相同的资源类型<code class="du kh ki kj kk b">k8s_node</code>。</p><p id="57ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以查看资源上的聚合节点组件日志过滤:</p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="7fdf" class="kl jf hi kk b fi lh li l lj lk">resource.type="k8s_node"</span></pre><p id="e1db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者在他们的<code class="du kh ki kj kk b">logName</code>上过滤单个日志:</p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="fc74" class="kl jf hi kk b fi lh li l lj lk">log_id("kubelet")</span></pre><p id="17ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，您可以组合不同的过滤器，通过实例id、标签等来缩小特定节点的范围。这是查看<code class="du kh ki kj kk b">kube-node-configurator</code>日志的一个例子:</p><figure class="kz la lb lc fd mb er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mi"><img src="../Images/c4a117ada5a6040bf364d86a6a595dde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PYxFDU6qHPUpkA81on-dMQ.png"/></div></div></figure><h1 id="f78f" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">集装箱日志</h1><p id="db11" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">容器<code class="du kh ki kj kk b">stdout</code>和<code class="du kh ki kj kk b">stderr</code>流被捕获到两个独立的日志中，资源类型为<code class="du kh ki kj kk b">k8s_container</code>:</p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="87af" class="kl jf hi kk b fi lh li l lj lk">log_id("stdout")</span></pre><p id="a995" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和</p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="d861" class="kl jf hi kk b fi lh li l lj lk">log_id("stderr")</span></pre><p id="b08e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个日志记录中的Resource和Kubernetes标签允许轻松地深入到特定的名称空间、应用程序、容器等。stdout日志记录如下所示:</p><figure class="kz la lb lc fd mb er es paragraph-image"><div class="er es mj"><img src="../Images/75700ac723f36e25229d673b83c5f454.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*cnSur0yVpkCj6PQiIfnSFQ.png"/></div></figure><h1 id="500c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">实例日志</h1><p id="390d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">除非遇到配置问题，否则这可能不是非常重要，但这里仍然值得一提的是<a class="ae jd" href="https://cloud.google.com/compute/docs/instances/viewing-serial-port-output" rel="noopener ugc nofollow" target="_blank">串行控制台日志</a>，其中GKE节点像任何其他计算引擎虚拟机一样存储串行控制台输出(当然，除非您明确禁用了它)。</p><p id="16fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它的过滤器是:</p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="181e" class="kl jf hi kk b fi lh li l lj lk">log_id("serialconsole.googleapis.com/serial_port_1_output")</span></pre><p id="0159" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果需要隔离特定节点的日志，当然可以使用它的实例id:</p><pre class="kz la lb lc fd ld kk le lf aw lg bi"><span id="d3f6" class="kl jf hi kk b fi lh li l lj lk">log_id("serialconsole.googleapis.com/serial_port_1_output")<br/>resource.labels.instance_id="2139255898313623576"</span></pre><p id="5b53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该日志中特定于GKE的信息与Kubelet引导进程相关，它有助于缩小与IAM或服务帐户配置错误相关的问题，这些问题有时会导致节点无法在集群中注册。希望这不是您每天都需要做的事情，但是当您这样做时，类似于下图所示的查询可能会为您指出正确的方向:</p><figure class="kz la lb lc fd mb er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mk"><img src="../Images/8ff72c24e876f407f13d1951a428d18a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*miT2umHznzAQ30TRiiPiEA.png"/></div></div></figure><p id="88d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一个值得指出的与实例相关的日志是<a class="ae jd" href="https://cloud.google.com/kubernetes-engine/docs/how-to/linux-auditd-logging" rel="noopener ugc nofollow" target="_blank"> Linux审计日志</a>，它可以在基于容器优化操作系统的节点上被可选地启用。</p></div><div class="ab cl ml mm gp mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="hb hc hd he hf"><p id="0440" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们只触及了GKE日志的表面，但希望这能让您快速了解从哪里入手，理解您的集群行为。</p></div></div>    
</body>
</html>