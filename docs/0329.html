<html>
<head>
<title>Google Cloud Load Balancer Setup Tweaking and Observations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云负载平衡器设置调整和观察</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-load-balancer-setup-tweaking-and-observations-c12d704e6d52?source=collection_archive---------0-----------------------#2017-07-06">https://medium.com/google-cloud/google-cloud-load-balancer-setup-tweaking-and-observations-c12d704e6d52?source=collection_archive---------0-----------------------#2017-07-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="b71a" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">概述和测试当今最强大的云负载平衡器</h2></div><p id="012a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">谷歌云负载平衡器(GCLB)是一个软件定义的全球分布式负载平衡服务。它使GCP用户能够在世界各地分发应用程序，并以极少的配置和成本扩展和缩减计算。它允许每秒0到100万个请求(rps ),没有预热。具有自动扩展功能的全球任播(单个IP)的起价为0.025美元/小时或0.6美元/天或18美元/月。这是一项低成本且功能强大的技术，现在任何人都可以免费测试。</p><p id="d012" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这篇文章中，我将测试和演示https://cloud.google.com/load-balancing/的<a class="ae jt" href="https://cloud.google.com/load-balancing/" rel="noopener ugc nofollow" target="_blank">上突出显示的一些产品特性</a></p><h1 id="6e38" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated"><strong class="ak">概述和设置</strong></h1><p id="dd57" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">GCP负载平衡器服务有几种部署类型。<br/>全局外部:<strong class="iz hj"> <br/> </strong> 1。HTTP(S) —仅公共、单区域或多区域<br/> 2。SSL代理、TCP代理—仅公共、单区域或多区域<br/>区域外部:<strong class="iz hj"> <br/> </strong> 3 .网络—公共、TCP/UDP、单区域<br/>区域内部:<strong class="iz hj"> <br/> </strong> 4。网络—仅限内部，TCP/UDP。可以与#1 HTTP GCLB结合使用。</p><p id="3e67" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本文中，我们将测试#1 HTTP公共负载平衡。</p><p id="d2eb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">借助谷歌庞大网络的力量，GCLB可以帮助改善最终用户的延迟。查看本文<a class="ae jt" href="https://cloud.google.com/compute/docs/load-balancing/optimize-app-latency" rel="noopener ugc nofollow" target="_blank">此处</a>了解更多测量和比较不同GCLB部署类型的延迟的详细信息。</p><blockquote class="kr ks kt"><p id="10bc" class="ix iy ku iz b ja jb ij jc jd je im jf kv jh ji jj kw jl jm jn kx jp jq jr js hb bi translated">健康检查、后端和前端是GCLB的核心要素。如果您希望快速设置负载平衡，请关注这些。</p></blockquote><p id="1d48" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">健康检查</strong> <br/>你应该了解两种健康检查。负载平衡器需要#1，而#2是额外的，以确保实例组的健康(自动修复)。<br/> 1。由负载平衡器使用，确保请求只发送到启动并运行的实例<br/> 2。由实例组用来重新创建按照您设置的标准不正常的实例。例如:HTTP健康检查端口80；如果web服务器失败，实例将被终止并重新创建。</p><p id="5038" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行状况检查设置在UI的计算引擎中，因为它们在GCP的多个地方使用。您也可以在没有负载平衡器的情况下对实例组运行健康检查。如果运行状况检查发现实例不正常，它将终止并重新创建。</p><p id="d70c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">GCLB将为您管理实例运行状况，实例组将管理自动伸缩，因此请确保您已经根据自己的要求进行了配置和调整。你可以保持他们的基本；HTTP端口80，如果web服务器或实例失败，实例组将终止并重新创建一个新的。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es ky"><img src="../Images/6141d43162b5b6146420818a705c69fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FimLTA8_BG5UCri19VTlAA.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">基本运行状况检查，确保web服务器启动并对实例做出响应</figcaption></figure><p id="0ddb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">后端服务<br/> </strong>这些是将传入流量导向实例组的服务。单个负载平衡器的后端服务可以包含许多后端或桶。您可以将一个后端服务分配给多个实例组。每个后端实际上是一个到实例组的链接，您希望在这些实例组之间分配流量。</p><p id="90be" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设您计划在HTTP(S)负载平衡器后面设置3个实例组(美国、EMEA、亚洲),它们配置了1个后端服务。下面是后端服务使用我们之前创建的health TCP health check配置了3个实例组(后端)的样子。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lo"><img src="../Images/92292226b9fb087f4ba175adabf0abaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9GsW9Q18u4RSpatlt62HuA.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">负载平衡器编辑后端服务</figcaption></figure><p id="92db" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">主机和路径规则</strong> <br/>这是你可以发送子域或者不同主机到不同后端的地方。例如，如果我有eu.mydomain.com，我可以将这些请求直接发送到我的autocomplete-demo-eu实例组。主机和路径规则会自动配置为*发送到您创建的后端服务，因此如果您正在进行基本的http负载平衡，就不必担心配置这些规则。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lp"><img src="../Images/bc5b944f3eda0a3f6ebf4261709a8923.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fmIihTifiCneDx1nsCI5kA.png"/></div></div></figure><p id="65e8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">前端<br/> </strong>前端就是你的虚拟IP (VIP)或者在GCP叫做anycast IP。一个前端可以服务多个区域(后端)。在大多数情况下，您会想要一个静态或保留的IP，而不是默认的临时IP。这样，您可以轻松地将云DNS区域文件上的a记录指向您的负载平衡器IP。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lq"><img src="../Images/beefb4122e189ca4e93ddb0742709866.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NZWdpsgkChQgu24bTBokYg.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">负载平衡器前端配置</figcaption></figure><p id="deae" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就是GCP负载均衡器的配置。简单吧。在几分钟内检查并更新配置后，您将有流量通过前端到达您的实例组。</p><h1 id="e0f0" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">调整GCLB</h1><p id="ca87" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated"><strong class="iz hj">运行状况检查<br/> </strong>在将运行状况检查添加到实例组之后，门户提供⚠️建议。提供的警告是，您可能希望增加检查间隔和不健康阈值，如下所示。这有助于您减少服务在高负载下可能出现的误报数量。如果您刚刚开始，请考虑将检查间隔从2s更改为10s，将不健康阈值从2次尝试更改为6次尝试。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div class="er es lr"><img src="../Images/2641b5715b89fc4e6ee44af8b6623312.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/format:webp/1*m9gMeKLZ6_URNiAG5WdiWQ.png"/></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">默认运行状况检查值警告</figcaption></figure><figure class="kz la lb lc fd ld er es paragraph-image"><div class="er es ls"><img src="../Images/097dfb06bbd3da0f68509ecf57d1fe51.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*qZiAKKdIkKie0PTqXqloOA.png"/></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">听听门户网站的建议！</figcaption></figure><p id="17e3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">初始延迟<br/> </strong>这是实例组配置中的一项设置，用于指定实例被替换后再次运行健康检查的延迟时间。默认值为300秒，即5分钟。希望您的实例足够轻，可以在1分钟左右启动。如果您认为在通过实例组自动缩放操作进行初始引导后，您的应用程序可能需要更多的时间来联机，那么增加初始延迟。</p><p id="0e4f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">路由<br/> </strong>传入的客户端请求被发送到离用户最近的区域，假设该区域有容量。如果多个区域配置了后端，流量将分布在每个区域中。请查看以下我的行为观察，了解更多详情。在区域内，请求通过循环调度来分发。您可以通过配置关联性来覆盖区域中的循环调度。</p><p id="dc08" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">典型地，LB将把新的请求路由到任何实例，并且来自一个连接的流量将路由到相同的实例。假设您想要设置粘性，以确保来自一个客户端的所有连接都指向同一个实例。配置与客户端IP的会话相似性。也可以通过cookie设置。GCLB在第一个客户端请求时发送一个cookie，以后带有该cookie的传入请求将被发送到同一个实例。</p><p id="60cf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">回扩实例或维护<br/>或</strong>容易，只需删除一个实例组的实例数。GCE使该组中的所有实例脱机，并且不再向您收费。现在，您可以缩减规模或执行维护，也许可以将一个实例模板更改为某个地区的新版本软件。通过从负载平衡器后端删除实例组，使某个区域停止服务，以执行维护、测试或升级软件。然后重新添加该组，并在其他地区推行更改。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div class="er es lt"><img src="../Images/619e6210f8ca82bf50a1bcbcd1f24798.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*DPgCurakCz3J2ZRQYYGXiw.png"/></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">通过将实例数量降至0，我的europe-west1实例组很快停止服务。</figcaption></figure><p id="b2f5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">最小规模<br/>对于LB来说，获取新的实例信息会有一点延迟，所以运行一个至少有2个实例的1个实例组的后端可能不是一个好主意。多个实例组应该可以包含1-2个实例，只需注意并测试GCLB在拾取添加到组中的新实例时的轻微延迟。如果需要运行少量实例，调整初始延迟阈值。</strong></p><p id="4a90" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> IPv6支持<br/> </strong>您可以将IPv6 Ip连接到GCLB，并拥有与IPv4相同的全球路由类型。一种策略是为GCLB配置一个IPv6地址来处理所有IPv6流量。只需使用IPv6地址创建一个额外的转发规则。然后，您可以将IPv6和IPv4与同一个负载平衡器和后端实例相关联。更多关于IPv6支持的信息请点击这里。</p><h1 id="0024" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">观察</h1><p id="434d" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">GCLB是一项托管服务，旨在为您做出关于路由和流量整形的智能决策。下面是一些针对基本http负载平衡观察到的特定服务行为。</p><p id="256a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我使用Apache Bench从美国和欧盟实例进行连接测试。Apache Bench (ab)包含在apache2包中。更多关于Apache Bench测试的信息请点击这里。</p><p id="7b9d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">基于位置的路由和流量负载分布<br/> </strong>第一个测试是从ab-tester美国实例发送10，000个请求，并发100个，GCLB直接路由到我的us-east1实例组。所以GCLB路由在✔️.很管用</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lu"><img src="../Images/57708523d14c0638ee9b1a6fd599be10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HF6QI4RmH8eChbb2TpUcKw.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">去往美国实例组的美国东部Apache Bench tester实例流量</figcaption></figure><p id="bcc5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这次，将来自欧盟ab测试人员的请求从10，000个增加到100，000个，最初路由到europe-west1实例组(蓝色)，然后分布到所有3个实例组以更好地处理负载。与此同时，我在欧盟的实例组扩展到7个实例，以接受大部分流量。具有最小配置和无缝自动扩展的智能负载平衡在✔️.非常有效</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lv"><img src="../Images/f87cc0076591d6e5c77311615a6dfa72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UgLdHK68-QGsjH1G0dl2UQ.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">欧盟Apache bench tester实例将转到欧盟实例组</figcaption></figure><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lw"><img src="../Images/d91dbbe7eaab27cd9d183852191f20db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d3HsZePvMmWDrj51wQYm0A.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">来自一个EU实例的100，000个请求最初流向我的Europe实例组(蓝色),随着请求的增加，峰值分布在所有3个可用的实例组中。</figcaption></figure><p id="5f02" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">大约30分钟后，100，000个查询的高峰过去了，实例组开始稳定下来并适度地缩减。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lx"><img src="../Images/e131093584b67d2d6165c722d691d3e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sODZKLTQ4uCYfkxugyDykQ.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">在流量高峰时，EU实例组为7个实例</figcaption></figure><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es ly"><img src="../Images/ccc5817fe7bb0af8d7b6ae059a1bd64a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zEX4XR8wjwSkLb1XujVGXQ.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">事件发生后，欧盟实例小组缩小了规模</figcaption></figure><p id="7af0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">利用智能自动扩展✔️.扩展和缩减资源</p><p id="9fa1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我打算对GCLB进行高达100万rps的压力测试，只是为了亲眼看看它的表现。在对超过500，000个rps实例做了更多测试后，我发现同样的行为得到了证实:跨区域的流量的完美路由和平衡。我很快就获得了对这项服务的信任，并为自己节省了测试成本。通过信任平台省了钱。✔️</p><div class="kz la lb lc fd ab cb"><figure class="lz ld ma mb mc md me paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><img src="../Images/a2d5ecf2a1f731b1bbe87347e8125504.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*FdC9gQYKnz8DKpvI2wOMiQ.png"/></div></figure><figure class="lz ld mf mb mc md me paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><img src="../Images/85d0eff5f10e7346149c0c129f09b605.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/format:webp/1*UiioPFrvTeELNZY1rG_RAA.png"/></div><figcaption class="lk ll et er es lm ln bd b be z dx mg di mh mi translated">使用Apache Bench和GCLB进行更多负载测试</figcaption></figure></div><p id="8a99" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">FWIW，这里是HTTP负载平衡示例的图表，显示了本文中涉及的一些元素以及每个元素所在的位置。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es mj"><img src="../Images/87a64be4ec814b82af19df2c69b05ecc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iuax6wRpcmjLhtNCTTYiBQ.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">这篇文章描述了GCLB系统的高级别</figcaption></figure><p id="9966" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你想了解更多关于GCLB的信息，请点击这里查看Prajakta Joshi总理为GCP网络团队举办的Google Cloud Next’17会议。她非常出色地详细解释了服务的背景和特点。</p><p id="cfec" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">特别感谢Prajakta和Jens对本文的反馈。</p><p id="9d9a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">感谢阅读，并与GCP玩得开心！</p></div></div>    
</body>
</html>