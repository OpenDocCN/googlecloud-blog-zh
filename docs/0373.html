<html>
<head>
<title>Global Kubernetes in 3 Steps on GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP三步走全球Kubernetes</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/global-kubernetes-in-3-steps-on-gcp-8a3585ec8547?source=collection_archive---------0-----------------------#2017-09-08">https://medium.com/google-cloud/global-kubernetes-in-3-steps-on-gcp-8a3585ec8547?source=collection_archive---------0-----------------------#2017-09-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b187" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个全球联合的Kubernetes集群可能听起来令人生畏，但实际上只需要几个小步骤。</p><ul class=""><li id="f7a0" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">创建项目和集群</li><li id="da45" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">安装并加入kubefed</li><li id="a774" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">全球部署</li></ul><p id="6747" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jr"> kubefed </em> </strong>实用程序在这个过程中花费了大部分精力。如果您想深入了解幕后发生的事情，请查看Kelsey Hightower的<a class="ae js" href="https://github.com/kelseyhightower/kubernetes-cluster-federation/blob/master/README.md" rel="noopener ugc nofollow" target="_blank"> Kubernetes集群联盟。我在这里写的很多东西都是模仿凯尔西和</a><a class="ae js" rel="noopener" href="/google-cloud/planet-scale-microservices-with-cluster-federation-and-global-load-balancing-on-kubernetes-and-a8e7ef5efa5e">桑迪普的原始文章</a>的，只是根据我的需要进行了简化和调整。</p><p id="eae9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">TL；DR </strong></p><h1 id="ccd8" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">先决条件</h1><p id="3631" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated"><strong class="ih hj">库贝菲德</strong></p><ul class=""><li id="74f1" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">本教程使用一个名为Kubefed的实用程序来自动化联邦。<a class="ae js" href="https://kubernetes.io/docs/tasks/federation/set-up-cluster-federation-kubefed/#getting-kubefed" rel="noopener ugc nofollow" target="_blank">点击这里获取Kubefed】</a></li></ul><p id="315d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">域名服务器(Domain Name Server)</p><ul class=""><li id="dee3" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">kube-dns是在这个过程中安装的，用于设置和管理服务的dns条目。为了有效地使用它，您需要有一个dns区域可供使用。记下区域名称(带有尾随点),并将其设置在下面的变量中</li></ul><p id="a0f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们设置一些变量，以便稍后在命令中使用</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="cefe" class="lf ju hi lb b fi lg lh l li lj">export PROJECT=your-projectname<br/>export DNS_ZONE=your.domain.com.</span></pre><h1 id="7764" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">步骤1 —创建集群</h1><p id="78b0" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">在东部和西部创建集群</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="7749" class="lf ju hi lb b fi lg lh l li lj">gcloud container clusters create west-cluster \<br/>--<!-- -->zone us-west1-a <!-- -->--<!-- -->scopes “cloud-platform,storage-ro,logging-write,monitoring-write,service-control,service-management,<a class="ae js" href="https://www.googleapis.com/auth/ndev.clouddns.readwrite" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/ndev.clouddns.readwrite</a>"</span><span id="49f8" class="lf ju hi lb b fi lk lh l li lj">gcloud container clusters create east-cluster \<br/>--<!-- -->zone us-east1-b <!-- -->--<!-- -->scopes “cloud-platform,storage-ro,logging-write,monitoring-write,service-control,service-management,<a class="ae js" href="https://www.googleapis.com/auth/ndev.clouddns.readwrite" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/ndev.clouddns.readwrite</a>"</span></pre><p id="cd24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">获取凭据</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="123b" class="lf ju hi lb b fi lg lh l li lj"># Workaround for RBAC error<br/># <a class="ae js" href="https://github.com/kubernetes/kubernetes/issues/42559" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes/kubernetes/issues/42559</a><br/>gcloud config set container/use_client_certificate True<br/>export CLOUDSDK_CONTAINER_USE_CLIENT_CERTIFICATE=True</span><span id="b7c7" class="lf ju hi lb b fi lk lh l li lj"># Get credentials<br/>gcloud container clusters get-credentials west-cluster --zone=us-west1-a<br/>gcloud container clusters get-credentials east-cluster --zone=us-east1-b</span></pre><p id="5b50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建别名</strong></p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="d7ec" class="lf ju hi lb b fi lg lh l li lj">kubectl config set-context east <!-- -->--<!-- -->cluster=gke_${PROJECT}_us-east1-b_east-cluster <!-- -->--<!-- -->user=gke_${PROJECT}_us-east1-b_east-cluster</span><span id="3703" class="lf ju hi lb b fi lk lh l li lj">kubectl config set-context west <!-- -->--<!-- -->cluster=gke_${PROJECT}_us-west1-a_west-cluster <!-- -->--<!-- -->user=gke_${PROJECT}_us-west1-a_west-cluster</span></pre><h1 id="0fc0" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">步骤2 —安装并加入kubefed</h1><p id="6619" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">这里我们使用kubefed来初始化使用“east”上下文的联邦</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="9875" class="lf ju hi lb b fi lg lh l li lj">kubefed init kfed \<br/> <!-- -->--<!-- -->host-cluster-context=east \<br/> <!-- -->--<!-- -->dns-zone-name=${DNS_ZONE} \<br/> <!-- -->--<!-- -->dns-provider=google-clouddns</span><span id="8fab" class="lf ju hi lb b fi lk lh l li lj">kubectl config use-context kfed</span></pre><p id="b112" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“kfed”上下文应该用于所有联合部署。您可以独立地检查各个集群，但是所有的操作都应该在联邦上下文中执行。</p><p id="12ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">将集群加入联盟</strong> <br/>向联盟服务器提供加入集群的上下文</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="7436" class="lf ju hi lb b fi lg lh l li lj">kubefed <!-- -->--<!-- -->context=kfed join east-cluster \<br/>--<!-- -->cluster-context=east \<br/>--<!-- -->host-cluster-context=east</span><span id="3702" class="lf ju hi lb b fi lk lh l li lj">kubefed <!-- -->--<!-- -->context=kfed join west-cluster \<br/>--<!-- -->cluster-context=west \<br/>--<!-- -->host-cluster-context=east</span></pre><blockquote class="ll lm ln"><p id="8d16" class="if ig jr ih b ii ij ik il im in io ip lo ir is it lp iv iw ix lq iz ja jb jc hb bi translated">注意:在联盟中添加来自欧洲的集群时，由于某种原因，我无法使用别名。我将原来的上下文名称替换回参数<code class="du lr ls lt lb b">-cluster-context</code>,它完美地连接起来</p></blockquote><p id="7139" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建默认名称空间</strong></p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="ea8c" class="lf ju hi lb b fi lg lh l li lj">kubectl <!-- -->--<!-- -->context=kfed create ns default</span></pre><p id="41ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">查看集群是否已加入</strong></p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="b04f" class="lf ju hi lb b fi lg lh l li lj">kubectl <!-- -->--<!-- -->context=kfed get clusters</span></pre><h1 id="d039" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">步骤3 —部署您的应用程序</h1><p id="776f" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">让我们部署一个简单的应用程序来看看这一点</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="d084" class="lf ju hi lb b fi lg lh l li lj">kubectl <!-- -->--<!-- -->context=kfed create deployment nginx <!-- -->--<!-- -->image=nginx &amp;&amp; \<br/> kubectl <!-- -->--<!-- -->context=kfed scale deployment nginx <!-- -->--<!-- -->replicas=4</span></pre><p id="c3fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看到它在两个集群中自动部署</p><p id="0140" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们查看一下<strong class="ih hj">东</strong>和<strong class="ih hj">西</strong>星团的豆荚</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="af7a" class="lf ju hi lb b fi lg lh l li lj"><strong class="lb hj">kubectl </strong>--<strong class="lb hj">context=east get pods</strong><br/>NAME READY STATUS RESTARTS AGE<br/>nginx-167110513–83gdg 1/1 Running 0 32s<br/>nginx-167110513-s30vs 1/1 Running 0 32s</span><span id="97d9" class="lf ju hi lb b fi lk lh l li lj"><strong class="lb hj">kubectl </strong>--<strong class="lb hj">context=west get pods</strong><br/>NAME READY STATUS RESTARTS AGE<br/>nginx-167110513–1wrjz 1/1 Running 0 38s<br/>nginx-167110513-v71h2 1/1 Running 0 38s</span></pre><h1 id="d434" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">结论</h1><p id="7925" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">很好很容易！设置一个全球分布的应用程序并不需要太多的努力。通过Kubenetes集群联合，您可以将多个集群视为一个实体。只需几个简单的步骤，设置就完成了，可以使用了。</p><p id="732a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果这还不够简单的话，下面是一个脚本中的全部内容</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="6964" class="lf ju hi lb b fi lg lh l li lj">## Requires these variables to be set<br/># export PROJECT=your-projectname<br/># export DNS_ZONE=your.domain.com.</span><span id="dd5f" class="lf ju hi lb b fi lk lh l li lj">[[ -z “$PROJECT” ]] &amp;&amp; { echo “Env var PROJECT is missing, please export PROJECT=your-project” ; exit 1; }<br/>[[ -z “$DNS_ZONE” ]] &amp;&amp; { echo “Env var DNS_ZONE is missing, please export DNS_ZONE=your.domain.com.” ; exit 1; }</span><span id="141c" class="lf ju hi lb b fi lk lh l li lj"># Create Clusters<br/>gcloud container clusters create west-cluster <!-- -->--<!-- -->zone us-west1-a <!-- -->--<!-- -->scopes “cloud-platform,storage-ro,logging-write,monitoring-write,service-control,service-management,<a class="ae js" href="https://www.googleapis.com/auth/ndev.clouddns.readwrite" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/ndev.clouddns.readwrite</a>"<br/>gcloud container clusters create east-cluster <!-- -->--<!-- -->zone us-east1-b <!-- -->--<!-- -->scopes “cloud-platform,storage-ro,logging-write,monitoring-write,service-control,service-management,<a class="ae js" href="https://www.googleapis.com/auth/ndev.clouddns.readwrite" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/ndev.clouddns.readwrite</a>"</span><span id="a56f" class="lf ju hi lb b fi lk lh l li lj">gcloud config set container/use_client_certificate True<br/>export CLOUDSDK_CONTAINER_USE_CLIENT_CERTIFICATE=True</span><span id="b4f5" class="lf ju hi lb b fi lk lh l li lj"># Get credentials<br/>gcloud container clusters get-credentials west-cluster --zone=us-west1-a<br/>gcloud container clusters get-credentials east-cluster --zone=us-east1-b</span><span id="171c" class="lf ju hi lb b fi lk lh l li lj"># Make Aliases<br/>kubectl config set-context east <!-- -->--<!-- -->cluster=gke_${PROJECT}_us-east1-b_east-cluster <!-- -->--<!-- -->user=gke_${PROJECT}_us-east1-b_east-cluster<br/>kubectl config set-context west <!-- -->--<!-- -->cluster=gke_${PROJECT}_us-west1-a_west-cluster <!-- -->--<!-- -->user=gke_${PROJECT}_us-west1-a_west-cluster</span><span id="e23b" class="lf ju hi lb b fi lk lh l li lj"># Install and join the federation<br/>kubefed init kfed <!-- -->--<!-- -->host-cluster-context=east <!-- -->--<!-- -->dns-zone-name=${DNS_ZONE} <!-- -->--<!-- -->dns-provider=google-clouddns<br/>kubefed <!-- -->--<!-- -->context=kfed join east-cluster <!-- -->--<!-- -->cluster-context=east <!-- -->--<!-- -->host-cluster-context=east<br/>kubefed <!-- -->--<!-- -->context=kfed join west-cluster <!-- -->--<!-- -->cluster-context=west <!-- -->--<!-- -->host-cluster-context=east<br/>kubectl <!-- -->--<!-- -->context=kfed create ns default</span><span id="7e3f" class="lf ju hi lb b fi lk lh l li lj"># Use kfed context to create resources and deployments<br/>kubectl config use-context kfed</span><span id="79c2" class="lf ju hi lb b fi lk lh l li lj"># Show me the money<br/>echo “kubectl <!-- -->--<!-- -->context=kfed get clusters “<br/>kubectl <!-- -->--<!-- -->context=kfed get clusters</span></pre></div></div>    
</body>
</html>