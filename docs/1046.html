<html>
<head>
<title>GCP VPC SC with Shared VPC Network</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP VPC SC共享VPC网络</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-vpc-sc-with-shared-vpc-network-526f85377cdd?source=collection_archive---------0-----------------------#2019-06-26">https://medium.com/google-cloud/gcp-vpc-sc-with-shared-vpc-network-526f85377cdd?source=collection_archive---------0-----------------------#2019-06-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/c221fc6bb5d9fa77d1095010e10099e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:602/format:webp/1*7MpDhFKjH0jWt9LD9EhodA.png"/></div></figure><h1 id="cce8" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">快速总结(TL；博士)</h1><p id="dac0" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">本文描述了在谷歌云平台中使用VPC服务控制(VPC-SC)和共享VPC的局限性和解决方案。</p><p id="9f3d" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">问题源于VPC-SC将服务项目虚拟机视为共享VPC的资源(而非服务项目资源)。一方面，如果仅使用服务项目启用VPC-SC，则它自己的虚拟机将被视为外围资源。另一方面，如果共享VPC与服务项目包含在同一个VPC-SC中，则使用该共享VPC的其他服务项目的虚拟机也包含在同一个边界中。因此，其他服务项目虚拟机无法连接到资源。这些问题将在下面的章节中详细解释。</p><p id="7663" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated"><strong class="jm hj">解决方法</strong>解决方案是仅在服务项目上创建VPC-SC，然后通过添加公共IP来连接GCP虚拟机的访问，以访问上下文管理器。更多详情请见下文。</p><h1 id="8585" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">什么是VPC-SC (VPC服务控制)</h1><p id="6740" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">通俗地说，就是针对GCS、BigQuery、Bigtable等支持服务的防火墙。它让信息安全团队高枕无忧，没有人能够从未经授权的网络访问这些服务中包含的数据。换句话说，它禁止数据渗透。谷歌云文档<a class="ae kn" href="https://cloud.google.com/vpc-service-controls/" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><h1 id="cde0" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">什么是共享VPC网络</h1><p id="209e" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">顾名思义，共享VPC是在GCP项目中创建的VPC网络，并为多个其他项目所共享。包含共享VPC的项目称为共享VPC主机，使用其网络的项目称为服务项目。GCP文档<a class="ae kn" href="https://cloud.google.com/vpc/docs/shared-vpc" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><h1 id="0859" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">在共享VPC的情况下实施VPC-供应链的问题</h1><p id="3f98" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">通常在共享VPC的情况下，多个独立的工作负载/应用程序使用相同的共享VPC。其中一个团队需要VPC SC，而其他团队不需要。</p><p id="b6fc" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">下图描述了VPC-SC如何观察当前的设置。</p><figure class="kp kq kr ks fd ij er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es ko"><img src="../Images/f4ae4fd5dcea58f1452d69dd60e6c9c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*49z87biRvEcrApoSPrdGZA.jpeg"/></div></div></figure><p id="1e57" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">在上图中，我们假设只有项目A在GCS和BQ中有敏感数据，因此需要VPC-SC。这可以通过以下方式实现:</p><ol class=""><li id="271f" class="kx ky hi jm b jn ki jr kj jv kz jz la kd lb kh lc ld le lf bi translated">VPC SC周边，共享VPC主机项目+服务项目A +带外部网络公共IP的访问上下文管理器(ACM)。缺点是服务项目B虚拟机将无法与自己项目中的GCS或BQ对话。</li><li id="33c3" class="kx ky hi jm b jn lg jr lh jv li jz lj kd lk kh lc ld le lf bi translated">VPC-共享VPC主机的SC+所有服务项目+外部网络的ACM。缺点是一些产品与VPC-SC(此处记录为<a class="ae kn" href="https://cloud.google.com/vpc-service-controls/docs/supported-products" rel="noopener ugc nofollow" target="_blank"/>)不兼容，如AppEngine、云功能、数据流等。这可能会限制其他不需要VPC-SC但仍想使用无服务器服务的团队。第二个缺点是，每个团队缺少多个VPC-SC。这增加了攻击面，因为突破防线会造成更大的伤害。</li><li id="bba6" class="kx ky hi jm b jn lg jr lh jv li jz lj kd lk kh lc ld le lf bi translated">VPC-SC，服务项目A +外部网络的ACM+共享网络虚拟机公共IP的ACM。虽然这适合大多数用例，但缺点是要在ACM中维护虚拟机的公共IP列表，因为新虚拟机随时可能启动。(我们将在解决方案中修复这一缺陷)。</li></ol><h1 id="c6c2" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">通过共享VPC使用VPC-SC的解决方案</h1><figure class="kp kq kr ks fd ij er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es ko"><img src="../Images/6686cf811fe91845f4a4b35eb2029adf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZuWA_UGYHcWET1GPSCWpQ.jpeg"/></div></div></figure><p id="0baa" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">一个简单的解决方案是使用服务项目A +具有外部网络IP的ACM+具有共享网络虚拟机公共IP的ACM创建VPC-SC。然而，为了使它实际上有用，我们需要减轻它的缺点，这是需要在ACM中维护虚拟机的公共IP列表，因为新的虚拟机可以随时启动。上述缺点解决方法是使用NAT网关。</p><p id="444f" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">使用ACM，我们可以将允许访问VPC-SC边界的公共IP列入白名单。因此，我们创建了一个包含NAT公共IP的ACM列表。因此，共享网络上托管的任何虚拟机都将被允许与VPC-SC内部的资源进行通信。</p><p id="1659" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">实施该解决方案的主要步骤是:</p><ol class=""><li id="d475" class="kx ky hi jm b jn ki jr kj jv kz jz la kd lb kh lc ld le lf bi translated">使用计算引擎虚拟机在共享VPC项目中创建NAT网关。将静态外部IP分配给NAT虚拟机。创建所需的路线。此处描述了<a class="ae kn" href="https://cloud.google.com/vpc/docs/special-configurations#natgateway" rel="noopener ugc nofollow" target="_blank">NAT网关的逐步实现。<br/>T5】注意:云NAT还不能和这个变通办法一起工作。(撰写日期:2019年6月25日)。</a></li><li id="2ac7" class="kx ky hi jm b jn lg jr lh jv li jz lj kd lk kh lc ld le lf bi translated">服务项目虚拟机都不应有外部IP，而应仅使用NAT网关。</li><li id="06eb" class="kx ky hi jm b jn lg jr lh jv li jz lj kd lk kh lc ld le lf bi translated">创建访问上下文管理器(ACM ),用于将共享网络的NAT IPs(以及任何其他授权网络的公共IP)列入白名单。</li><li id="2b44" class="kx ky hi jm b jn lg jr lh jv li jz lj kd lk kh lc ld le lf bi translated">仅使用服务项目创建VPC-SC，并将其链接到上面的ACM。</li></ol><h2 id="138c" class="ll in hi bd io lm ln lo is lp lq lr iw jv ls lt ja jz lu lv je kd lw lx ji ly bi translated">什么是NAT网关</h2><p id="8363" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">它允许我们使用一个外部IP地址从多个虚拟机实例发送流量，但只将一个虚拟机暴露给互联网。NAT网关的其他好处是能够轻松监控逃到互联网的流量。</p></div></div>    
</body>
</html>