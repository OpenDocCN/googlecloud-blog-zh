<html>
<head>
<title>The antiforgery token could not be decrypted — Running ASP.NET core on Google Cloud.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无法解密防伪令牌——在谷歌云上运行ASP.NET核心。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/antiforgery-tokens-asp-net-core-and-google-cloud-7ac6a5c7842b?source=collection_archive---------0-----------------------#2019-04-25">https://medium.com/google-cloud/antiforgery-tokens-asp-net-core-and-google-cloud-7ac6a5c7842b?source=collection_archive---------0-----------------------#2019-04-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b75b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我用ASP.NET构建了一个非常简单的应用程序。它基本上是一个带有表单的“hello world”。看起来是这样的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/edabd0309e9bed4178efc6cf67b2ad39.png" data-original-src="https://miro.medium.com/v2/resize:fit:958/format:webp/1*Er7y5GSeAnwPciCTvmLadg.png"/></div></figure><p id="0010" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我输入我的名字，点击提交，然后看到一个自定义的问候语:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jl"><img src="../Images/67ad6fc01ab22dc6ac1d22dd74205612.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/format:webp/1*1pEFAZbgeAQsSk4L1xpQ2Q.png"/></div></figure><p id="a77b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它在我的机器上运行得很好，但是当我把它部署到<a class="ae jm" href="https://cloud.google.com/appengine/docs/flexible/dotnet/" rel="noopener ugc nofollow" target="_blank">谷歌应用引擎</a>时，我看到了这个错误:</p><pre class="je jf jg jh fd jn jo jp jq aw jr bi"><span id="9e3c" class="js jt hi jo b fi ju jv l jw jx">System.Security.Cryptography.CryptographicException: The key {12471710-d939-4a6f-a408-54eb7efcaf33} was not found in the key ring.<br/>at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.UnprotectCore<br/>at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.DangerousUnprotect<br/>at Microsoft.AspNetCore.DataProtection.KeyManagement.KeyRingBasedDataProtector.Unprotect<br/>at Microsoft.AspNetCore.Antiforgery.Internal.DefaultAntiforgeryTokenSerializer.Deserialize</span></pre><p id="904a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我甚至没有使用加密技术。这是怎么回事？</p><p id="ff18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最强的提示在上面堆栈跟踪的底部:<code class="du jy jz ka jo b">DefaultAntiforgeryTokenSerializer.Deserialize</code>。</p><p id="fd0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">防伪令牌是对<a class="ae jm" href="https://en.wikipedia.org/wiki/Cross-site_request_forgery" rel="noopener ugc nofollow" target="_blank">跨站点请求伪造(CSRF) </a>攻击的防御。攻击者使用CSRF来欺骗用户执行对攻击者有利而让用户付出代价的操作。<a class="ae jm" href="https://en.wikipedia.org/wiki/Cross-site_request_forgery" rel="noopener ugc nofollow" target="_blank">Wikipedia.org</a>和<a class="ae jm" href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)" rel="noopener ugc nofollow" target="_blank">owasp.org</a>很好地详细解释了这次攻击。</p><p id="d850" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好消息是，ASP.NET核心有一个针对CSRF攻击的内置对策。在docs.microsoft.com<a class="ae jm" href="https://docs.microsoft.com/en-us/aspnet/core/security/anti-request-forgery?view=aspnetcore-2.2" rel="noopener ugc nofollow" target="_blank">有完整的记录。我总是通过向接收表单POSTs的控制器方法添加<code class="du jy jz ka jo b">ValidateAntiForgeryToken</code>属性来使用这种对策:</a></p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="f6d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">坏消息是(对于在谷歌应用引擎上运行应用程序来说)，<code class="du jy jz ka jo b">ValidateAntiForgeryToken</code>背后的代码使用了加密，默认情况下，它将加密密钥存储在本地网络服务器上。当我的桌面上只有一个web服务器运行时，它运行得非常好。但是，当我在App Engine上运行多个web服务器时，每个web服务器都有自己的密钥。我看到了<code class="du jy jz ka jo b">CryptographicException</code>,因为我获取表单的GET请求和提交表单的POST请求是由不同的web服务器服务的，而这些web服务器有不同的键。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="ab fe cl kd"><img src="../Images/034bedbc69524dd61bc74816f804a77c.png" data-original-src="https://miro.medium.com/v2/format:webp/1*NbgzQ9lLPQmuVxauxZOXOg.png"/></div></figure><p id="ef2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在之前的<a class="ae jm" rel="noopener" href="/google-cloud/adding-social-login-to-your-asp-net-core-2-1-google-cloud-platform-application-1baae89f1dc8">帖子</a>中，我描述了这个问题的手工编码解决方案。它工作可靠，但是偏离了在docs.microsoft.com记录的通常模式。这是通常的模式:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="kb kc l"/></div></figure><h1 id="8351" class="ke jt hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">宣布谷歌的两个新图书馆</h1><p id="33ed" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">谷歌刚刚发布了<a class="ae jm" href="https://www.nuget.org/packages?q=Google.Cloud.AspNetCore" rel="noopener ugc nofollow" target="_blank">的alpha版本，两个新的库</a>解决了这个问题，并且符合上面显示的通常模式。<code class="du jy jz ka jo b"><a class="ae jm" href="https://www.nuget.org/packages/Google.Cloud.AspNetCore.DataProtection.Storage/1.0.0-alpha02" rel="noopener ugc nofollow" target="_blank">Google.Cloud.AspNetCore.DataProtection.Storage</a></code>将密钥保存到<a class="ae jm" href="https://cloud.google.com/storage/" rel="noopener ugc nofollow" target="_blank">谷歌云存储</a>中，<code class="du jy jz ka jo b"><a class="ae jm" href="https://www.nuget.org/packages/Google.Cloud.AspNetCore.DataProtection.Kms/1.0.0-alpha02" rel="noopener ugc nofollow" target="_blank">Google.Cloud.AspNetCore.DataProtection.Kms</a></code>使用<a class="ae jm" href="https://cloud.google.com/kms/" rel="noopener ugc nofollow" target="_blank">谷歌云密钥管理服务</a>保护密钥。以下是如何使用它们:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="d7c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些新的库旨在节省开发人员的时间，无论您的应用程序在哪里运行，甚至在Google Cloud之外，都可以快速一致地解决这个问题！例如，我已经使用<code class="du jy jz ka jo b"><a class="ae jm" href="https://www.nuget.org/packages/Google.Cloud.AspNetCore.DataProtection.Kms/1.0.0-alpha02" rel="noopener ugc nofollow" target="_blank">Google.Cloud.AspNetCore.DataProtection.Kms</a></code>来保护存储在本地机器上的密钥。</p><h2 id="85da" class="js jt hi bd kf lg lh li kj lj lk ll kn iq lm ln kr iu lo lp kv iy lq lr kz ls bi translated">试试代码！</h2><p id="28bf" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">我们想听听你使用这些新库的体验，所以请给他们一个机会，并报告关于<a class="ae jm" href="https://github.com/GoogleCloudPlatform/google-cloud-dotnet-powerpack" rel="noopener ugc nofollow" target="_blank">github.com回购</a>的问题。</p><p id="1a5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jm" href="https://github.com/GoogleCloudPlatform/dotnet-docs-samples/tree/master/appengine/flexible/AntiForgery" rel="noopener ugc nofollow" target="_blank">示例应用程序</a>包含一个设置脚本<code class="du jy jz ka jo b"><a class="ae jm" href="https://github.com/GoogleCloudPlatform/dotnet-docs-samples/blob/master/appengine/flexible/AntiForgery/Set-Up.ps1" rel="noopener ugc nofollow" target="_blank">Set-Up.ps1</a></code>，它将创建<a class="ae jm" href="https://cloud.google.com/storage/" rel="noopener ugc nofollow" target="_blank"> Google云存储</a>桶，创建<a class="ae jm" href="https://cloud.google.com/kms/" rel="noopener ugc nofollow" target="_blank"> KMS </a>主密钥，并为App Engine设置加密和解密密钥所需的最小权限。</p></div></div>    
</body>
</html>