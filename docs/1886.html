<html>
<head>
<title>Cloud Spanner w/ Autoscaler: A zero compromise &amp; zero downtime database platform.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有Autoscaler的Cloud Spanner:一个零妥协和零停机的数据库平台。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-spanner-w-autoscaler-a-zero-compromise-zero-downtime-database-platform-a83339bbf315?source=collection_archive---------4-----------------------#2021-05-18">https://medium.com/google-cloud/cloud-spanner-w-autoscaler-a-zero-compromise-zero-downtime-database-platform-a83339bbf315?source=collection_archive---------4-----------------------#2021-05-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4b15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你不知道Google Cloud Spanner数据库，或者没有查看我在<a class="ae jd" rel="noopener" href="/google-cloud/why-google-cloud-spanner-and-ways-you-can-access-it-with-zero-to-minimal-app-code-change-aef72c700013">上的上一篇文章《为什么是Google Cloud Spanner </a>》,我强烈建议你在继续之前先查看一下。只需要5分钟。但将对Google Cloud Spanner数据库做一个很好的概述，并帮助您理解我为什么向我的客户强烈推荐它，其业务目标如下:</p><ul class=""><li id="e821" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">从小规模开始，然后根据需要快速扩展的灵活性，零宕机。</li><li id="e683" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">需要高度一致并符合ACID属性的关系结构。</li><li id="1ce5" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">带有同步复制的区域和多区域分布式数据库。</li><li id="7085" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">没有维护开销的数据库平台。</li></ul><p id="3d9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">话虽如此，但让我向您介绍另一个来自Google stable的开源工具:<a class="ae jd" href="https://github.com/cloudspannerecosystem/autoscaler" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">【自动缩放器】</strong> </a>，它是云扳手的真正伴侣，让您可以根据针对数据库指标设置的阈值自动扩展或缩小节点数量。</p><blockquote class="js jt ju"><p id="8ad0" class="if ig jv ih b ii ij ik il im in io ip jw ir is it jx iv iw ix jy iz ja jb jc hb bi translated">此外，这是一个关于如何利用不同的GCP技术进行创新的无聊例子，这是一种真正的多语言方法，在实施之前，让我们快速浏览一下它的实施流程。</p></blockquote><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es jz"><img src="../Images/aa023d2d7f83c03ef1cfb502a724ff71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*frbGcyX_ZcrSaI5YQV-JHQ.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated"><a class="ae jd" href="https://github.com/cloudspannerecosystem/autoscaler/blob/master/README.md#configuration" rel="noopener ugc nofollow" target="_blank">自动缩放架构</a></figcaption></figure><p id="bb0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Cloud Spanner Autoscaler利用5项谷歌云服务，即:</strong></p><ul class=""><li id="9838" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated"><strong class="ih hj">云调度器:</strong>定期启动作业，检查扳手使用情况。</li><li id="e121" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><strong class="ih hj">Cloud Pub/Sub:</strong>Cloud Scheduler将定义的Cloud Spanner Autoscaler配置作为JSON有效负载推送到轮询Pub/Sub主题中。</li><li id="b863" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><strong class="ih hj">云函数(Poller): </strong>读取有效负载，查询云监控API检索Spanner数据库利用率度量，并将其推送到scaler发布/订阅主题。</li><li id="5f2e" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><strong class="ih hj">云函数(Scaler): </strong>从Scaler发布/订阅主题中读取有效负载，并根据针对利用率指标设置的阈值执行扳手数据库的新配置参数。</li><li id="b199" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><strong class="ih hj"> Cloud Firestore: </strong>一旦Scaler函数执行了Spanner实例的伸缩，它将检索实例伸缩时的时间戳，并将其存储在Cloud Firestore中，以确定再次启动任何伸缩之前的冷却期，还可用于分析伸缩业务需求。</li></ul><p id="220a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">现在让我们开始实施:</strong></p><ul class=""><li id="0763" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">从GitHub中克隆<strong class="ih hj"> </strong> <a class="ae jd" href="https://github.com/cloudspannerecosystem/autoscaler" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">【自动缩放】</strong> </a>工具。</li></ul><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="c0f8" class="ku kv hi kq b fi kw kx l ky kz">git clone <a class="ae jd" href="https://github.com/cloudspannerecosystem/autoscaler.git" rel="noopener ugc nofollow" target="_blank">https://github.com/cloudspannerecosystem/autoscaler.git</a></span></pre><ul class=""><li id="06e6" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">它支持3种部署模式:<strong class="ih hj">按项目</strong> (Autoscaler &amp;云扳手托管在同一项目中)<strong class="ih hj">集中式</strong> (Autoscaler &amp;云扳手托管在不同项目中)<strong class="ih hj">分布式</strong> (Autoscaler &amp;云扳手托管在不同项目中，但不包括云调度程序)，以便云扳手团队可以管理向内扩展或向外扩展的配置参数。)</li><li id="d580" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">设置环境变量:</li></ul><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="34b8" class="ku kv hi kq b fi kw kx l ky kz">export PROJECT_ID=&lt;INSERT_YOUR_PROJECT_ID&gt;<br/>gcloud config set project "${PROJECT_ID}"<br/>export REGION=us-central1<br/>export ZONE=us-central1-c<br/>export APP_ENGINE_LOCATION=us-central</span><span id="293f" class="ku kv hi kq b fi la kx l ky kz"><em class="jv"># Set corresponding Terraform environment variables.</em><br/>export TF_VAR_project_id="${PROJECT_ID}"<br/>export TF_VAR_region="${REGION}"<br/>export TF_VAR_zone="${ZONE}"</span><span id="60ca" class="ku kv hi kq b fi la kx l ky kz"><em class="jv"># Provide your Spanner Instance Name.</em><br/>export TF_VAR_spanner_name=&lt;INSERT_YOUR_SPANNER_INSTANCE_NAME&gt;</span></pre><ul class=""><li id="2d00" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">用您现有的扳手实例详细信息更新Terraform配置文件。(如果要为1个以上的云扳手实例配置Autoscaler，请重复以下代码。)</li></ul><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="530b" class="ku kv hi kq b fi kw kx l ky kz">gcloud spanner instances list</span><span id="7813" class="ku kv hi kq b fi la kx l ky kz">SPANNER_INSTANCE_NAME=&lt;YOUR_SPANNER_INSTANCE_NAME&gt;</span><span id="eff4" class="ku kv hi kq b fi la kx l ky kz">echo "resource \"google_spanner_instance\" \"${SPANNER_INSTANCE_NAME}\" {}" &gt; "${SPANNER_INSTANCE_NAME}.tf"</span><span id="8619" class="ku kv hi kq b fi la kx l ky kz">terraform import "google_spanner_instance.${SPANNER_INSTANCE_NAME}" "${SPANNER_INSTANCE_NAME}"</span><span id="f0ec" class="ku kv hi kq b fi la kx l ky kz">terraform state show -no-color "google_spanner_instance.${SPANNER_INSTANCE_NAME}" \<br/>  | grep -vE "(id|num_nodes|state|timeouts).*(=|\{)" \<br/>  &gt; "${SPANNER_INSTANCE_NAME}.tf"</span></pre><ul class=""><li id="7451" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">启用所需的云API，并创建应用引擎和firestore实例。</li></ul><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="09e8" class="ku kv hi kq b fi kw kx l ky kz">gcloud app create --region="${APP_ENGINE_LOCATION}"</span><span id="ea75" class="ku kv hi kq b fi la kx l ky kz">gcloud alpha firestore databases create --region="${APP_ENGINE_LOCATION}"</span></pre><ul class=""><li id="7e87" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">初始化Terraform每个项目的目录(您可以根据需要选择其他部署模型)并创建Autoscaler基础架构。</li></ul><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="fe1d" class="ku kv hi kq b fi kw kx l ky kz">cd "${AUTOSCALER_DIR}"</span><span id="95ad" class="ku kv hi kq b fi la kx l ky kz">terraform init</span><span id="ae82" class="ku kv hi kq b fi la kx l ky kz">terraform import module.scheduler.google_app_engine_application.app "${PROJECT_ID}"</span><span id="93e6" class="ku kv hi kq b fi la kx l ky kz">terraform apply -parallelism=2</span></pre><p id="e751" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">一旦Autoscaler部署成功，将产生以下Google云资源:</strong></p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es lb"><img src="../Images/69c4859ffc0578af523a3c3d1b9194a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wWN0eFsB5r6oCSf46lBD2w.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated"><strong class="bd lc"> Firestore实例</strong></figcaption></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es lb"><img src="../Images/dbf17ef63f59bc4a9bcdb0381545dcfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FPUfAf4-0TImIyEqg2a11A.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated"><strong class="bd lc">谷歌云发布/订阅消息队列</strong></figcaption></figure><p id="450f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi ld translated"><span class="l le lf lg bm lh li lj lk ll di"> P </span></p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es lb"><img src="../Images/741e25916f767c659ee13fcdd5e0412b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xsMS5f39sTI_CqFWzrXADg.png"/></div></div></figure><p id="0825" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi ld translated">然后，scaler函数接收来自Scaler-Pub/Sub主题的消息，并将指标与提供的阈值进行比较，如果发现超出范围，Scaler函数将相应地调整扳手实例节点。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es lm"><img src="../Images/1bd38c45c557545f6f85fb7d75da34a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jnpWJgLMr3AdK6bCz-PATQ.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated"><strong class="bd lc">谷歌云调度作业</strong></figcaption></figure><p id="0ab6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Autoscaler将为CloudScheduler作业<strong class="ih hj">“poll-main-instance-metrics”</strong>提供定义的负载作为JSON数组。您也可以根据需要<a class="ae jd" href="https://github.com/cloudspannerecosystem/autoscaler/blob/master/poller/README.md" rel="noopener ugc nofollow" target="_blank">定义自定义指标</a>。</p><h2 id="647d" class="ku kv hi bd lc ln lo lp lq lr ls lt lu iq lv lw lx iu ly lz ma iy mb mc md me bi translated">现在，既然所有必需的服务都已提供，让我们测试一下:</h2><p id="12d2" class="pw-post-body-paragraph if ig hi ih b ii mf ik il im mg io ip iq mh is it iu mi iw ix iy mj ja jb jc hb bi translated">作为我上一篇博客的延续，我已经编写了一个小Python程序来使用<a class="ae jd" href="https://github.com/cloudspannerecosystem/pgadapter" rel="noopener ugc nofollow" target="_blank"> PGAdapter </a>在我的CloudSpanner实例上生成负载，或者你也可以配置用于YCSB 的<a class="ae jd" href="https://github.com/brianfrankcooper/YCSB/tree/master/cloudspanner" rel="noopener ugc nofollow" target="_blank"> CloudSpanner驱动程序来进行快速负载测试，这是一个简单的实用程序，但是如果你想要指导，请在评论部分留下注释，我将写一篇关于如何设置和执行它的快速博客。</a></p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es mk"><img src="../Images/bd87b2e4e7334f2cca21c4a1b24bc825.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FfhyVXifdIsgzlXhGQhY_g.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated"><strong class="bd lc">云扳手实例“test-1”带有“testdb”数据库</strong></figcaption></figure><p id="8c58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了展示Cloud Spanner的优势，我刚刚创建了一个具有以下模式的单个表“employee_data ”,并将使用多个线程(会话)加载单个表，每个线程插入100，000条记录。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es ml"><img src="../Images/f9877d0b12bcf6e55630bf3f106cf286.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*99JLZVqfAlDbOt_RMxxsrQ.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated"><strong class="bd lc">表:员工数据</strong></figcaption></figure><p id="d95d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们初始化10个线程，每个线程插入100，000条记录，少数线程更新表employee_data中现有的1000条记录。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es mm"><img src="../Images/71137db18c0cce7fd66da72851c47bb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BEkJdP3XyxgHJ3RWqPU2XA.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated"><strong class="bd lc">对扳手实例进行负载测试的Python作业</strong></figcaption></figure><p id="587d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当负载开始在“testdb”上构建并达到大约。61%的CPU，下一个autoscaler作业将启动轮询器功能来捕获利用率指标，该指标由scaler功能进一步验证，当它发现Spanner实例的CPU利用率高于阈值时，它会将Spanner实例扩展到配置的max_nodes (3)。</p><p id="3bcf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">autoscaler流量和利用率指标也可以通过Google Cloud日志记录和监控工具进行验证。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es mn"><img src="../Images/187873232d7036e9aab539eaf09de1ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yWunhb5_cGEcTe0ooT182A.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated"><strong class="bd lc">谷歌云日志</strong></figcaption></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es mo"><img src="../Images/006f1c3c969bf3dfa5cf20ef7e76b112.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QLFmHe_kLrmENlTjjpz3og.png"/></div></div><figcaption class="kl km et er es kn ko bd b be z dx translated"><strong class="bd lc">谷歌云监控</strong></figcaption></figure><p id="0be8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的测试运行中，我强调了单个表“employee_data ”,它具有10万次插入和多达10k次更新，以及多会话模型中的select语句和3个spanner节点，能够处理这个负载@ approx。19%的利用率，请求延迟大约为。第95百分位时为13毫秒。以此类推，这些节点可以处理超过3倍的负载，但利用率仍低于80%。</p><p id="716e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在传统模式中，如果您遇到如此巨大的负载，它要么会影响您的业务并削弱您的市场竞争力，要么会带来更高的总拥有成本，因为您别无选择，只能停机并纵向扩展您的关系数据库平台，或者不得不预先过度配置来管理这种情况。然而，有了Cloud Spanner，您甚至不需要担心这一点，这意味着更低的总拥有成本和更多的创新时间。</p><p id="a7d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，这是一个示例，说明了Cloud Spanner如何在大规模下提供最高级别的可用性和一致性，即使对于峰值工作负载也是如此，而且没有任何手动分片或故障切换或维护停机的开销。</p></div></div>    
</body>
</html>