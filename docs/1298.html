<html>
<head>
<title>How to build chatbots for Hangouts with Dialogflow by using custom payloads and cards.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何通过使用自定义的有效负载和卡来构建带有Dialogflow的聊天机器人。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-build-chatbots-for-hangouts-with-dialogflow-by-using-custom-payloads-and-cards-2006a11b578?source=collection_archive---------1-----------------------#2020-02-21">https://medium.com/google-cloud/how-to-build-chatbots-for-hangouts-with-dialogflow-by-using-custom-payloads-and-cards-2006a11b578?source=collection_archive---------1-----------------------#2020-02-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c187" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Dialogflow Hangouts集成允许您创建可以包含在一对一聊天以及聊天室中的机器人。从左侧的Integrations菜单中，您可以启用该功能并选择您的代理环境。</p><p id="340e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以按照本指南了解更多信息:<a class="ae jd" href="https://cloud.google.com/dialogflow/docs/integrations/hangouts" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/dialog flow/docs/integrations/hangouts</a></p><p id="85d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但你可能在这里，找出如何将它与卡片、格式化文本、图像或自定义有效载荷等丰富的信息集成在一起。也许你甚至试图通过你的履行代码来实现这一点。我掩护你。</p><h1 id="fe78" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">丰富的信息</h1><p id="d1c9" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">当Hangouts Chat向bot发送事件时，它会在事件有效负载中包含某些数据；确切的负载取决于事件类型。该事件和负载包含在发送到bot注册URL的HTTP调用中。</p><p id="d250" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于一些事件，机器人可以响应于该事件向聊天发送消息。该消息是一个JSON对象，其内容取决于消息的类型:</p><h1 id="c3be" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">Google Hangouts集成在Dialogflow UI控制台中</h1><p id="e3ab" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">开箱即用，在Dialogflow UI控制台中，您可以通过单击<strong class="ih hj">响应</strong>块中的+按钮来选择自定义Hangout响应:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/76c8c564bcd81e5f66b47351cf080b06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YaAyVGrY9A3jYPaW"/></div></div></figure><p id="6f4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这允许您创建4种不同类型的响应:</p><ul class=""><li id="2451" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">格式化文本响应</li><li id="421b" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">形象</li><li id="84c7" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">卡片</li><li id="fcf3" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">自定义有效负载</li></ul><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/c0a4df037b63e1dfa7ddff33efae4c33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2U3Q_AjG5VK8K22S"/></div></div></figure><p id="bf74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Hangouts <strong class="ih hj">文本响应</strong>，在视觉上看起来与Dialogflow UI控制台中的<strong class="ih hj">默认文本响应</strong>相同。然而，原始api响应看起来有点不同，因为它还将平台配置设置为“GOOGLE_HANGOUTS”，这在构建多渠道代理时可能会很有趣。</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="194a" class="lm jf hi li b fi ln lo l lp lq">"fulfillmentMessages": [</span><span id="c9cc" class="lm jf hi li b fi lr lo l lp lq">{</span><span id="0dfe" class="lm jf hi li b fi lr lo l lp lq">    "text": {</span><span id="139e" class="lm jf hi li b fi lr lo l lp lq">    "text": [</span><span id="403b" class="lm jf hi li b fi lr lo l lp lq">         "This is a test."</span><span id="d91a" class="lm jf hi li b fi lr lo l lp lq">    ]</span><span id="a2e6" class="lm jf hi li b fi lr lo l lp lq">},</span><span id="9bb8" class="lm jf hi li b fi lr lo l lp lq">   "platform": "GOOGLE_HANGOUTS"</span><span id="cf11" class="lm jf hi li b fi lr lo l lp lq">},</span><span id="f3ef" class="lm jf hi li b fi lr lo l lp lq">...</span></pre><p id="9b19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除此之外，您还可以更改文本格式。参见<a class="ae jd" href="https://developers.google.com/hangouts/chat/reference/message-formats/basic" rel="noopener ugc nofollow" target="_blank"> SimpleText </a>例如，您可以通过将文本包裹在某些符号中来使文本成为<strong class="ih hj">粗体</strong>或<em class="ls">斜体</em>。</p><p id="b2ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Hangouts <strong class="ih hj"> Image </strong>，顾名思义会在Hangouts中插入图像。您可以指定图像url。</p><p id="7cfd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Hangouts <strong class="ih hj">卡</strong>允许您创建一个基本的简单卡。您可以设置一个<strong class="ih hj">标题</strong>，一个<strong class="ih hj">副标题</strong>，一个<strong class="ih hj">图片</strong> <strong class="ih hj"> url </strong>和<strong class="ih hj">多个</strong> <strong class="ih hj">按钮</strong>(一个标签和一个url):</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/2d25f3dbde65e7e127060e72e6b67ce6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lP4zxoRxsU6enke9"/></div></div></figure><p id="7fb6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Google Hangouts中会是这样的:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/ebc146bf051e169b8fd75c2504570a39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*T_aRue9LmbXn5AYX"/></div></div></figure><p id="c3e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，有一个选项可以指定一个Hangouts <strong class="ih hj">自定义有效载荷</strong>，<em class="ls">现在这就是魔术发生的地方，以便创建高级卡</em>。一张卡可以有一个或多个部分。每个部分都可以有一个标题。</p><p id="94de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以看看hangouts消息格式卡参考指南，看看你可以用这个创建一些组合:<a class="ae jd" href="https://developers.google.com/hangouts/chat/reference/message-formats/cards" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/hangouts/chat/reference/message-formats/cards</a></p><p id="c65b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，使用定制的有效负载意味着您必须提供JSON格式。</p><p id="c7b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果您将参考指南的示例复制并粘贴到Dialogflow中的自定义有效负载框中，您需要注意以下几点:</p><ul class=""><li id="5172" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">第一把钥匙不能叫<strong class="ih hj">牌</strong>，但必须命名为:<strong class="ih hj"> hangouts </strong></li><li id="aac9" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated"><strong class="ih hj"> hangouts </strong>键指向一个对象，而不是(卡片的)数组</li><li id="7088" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">确保编辑器不包含任何林挺错误</li><li id="8054" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">您不能在对话流<em class="ls">立即尝试控制台</em>中测试结果，您必须直接在Hangouts聊天中测试</li></ul><p id="b1bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个工作示例:</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="lt lu l"/></div><figcaption class="lv lw et er es lx ly bd b be z dx translated">Hangouts高级富卡的Dialogflow自定义有效负载</figcaption></figure><h1 id="bbe2" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">Google Hangouts集成在Dialogflow实现代码中</h1><p id="9613" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">除非您为Hangouts聊天创建静态FAQ聊天代理，否则您可能会从服务器获取结果并在组件中显示它。为此，您将需要后端实现代码(要么在云功能中(例如由内嵌编辑器提供)，要么通过指定webhook url。</p><p id="e005" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无论哪种方式，如果您使用JavaScript/Node，在聊天中集成Hangouts卡的最简单方法是使用<strong class="ih hj">dialog flow-fulfillment</strong>NPM库:<a class="ae jd" href="https://www.npmjs.com/package/dialogflow-fulfillment" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/dialogflow-fulfillment</a></p><p id="2949" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ls">(注意:你不能使用actions-on-google npm包，因为这个库是为Google Assistant代理准备的。)</em></p><p id="3dd3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保使用0.6.1版(或更高版本)。尽管0.6.1版本没有特定的Google Hangouts平台识别，但默认的Dialogflow卡、图像和有效负载响应将开箱即用:</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="6a85" class="lm jf hi li b fi ln lo l lp lq">var card = new Card({</span><span id="c6f1" class="lm jf hi li b fi lr lo l lp lq">    title: 'hello',</span><span id="4899" class="lm jf hi li b fi lr lo l lp lq">    text: 'test',</span><span id="9ae3" class="lm jf hi li b fi lr lo l lp lq">    imageUrl: 'https://goo.gl/aeDtrS',</span><span id="0513" class="lm jf hi li b fi lr lo l lp lq">    buttonText: 'Details',</span><span id="2ed9" class="lm jf hi li b fi lr lo l lp lq">    buttonUrl: 'https://assistant.google.com/'</span><span id="ccba" class="lm jf hi li b fi lr lo l lp lq">});</span><span id="23f9" class="lm jf hi li b fi lr lo l lp lq">var image = new Image({</span><span id="e0c8" class="lm jf hi li b fi lr lo l lp lq">    imageUrl: 'https://goo.gl/aeDtrS',</span><span id="a2d7" class="lm jf hi li b fi lr lo l lp lq">});</span></pre><p id="ad30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(建议筹码在Hangouts中不起作用，因为它们不存在于Hangouts聊天中。…但是你可以用按钮来实现。)</p><p id="712c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是假设你想要比这些更复杂一点的卡，你将不得不使用定制的有效载荷。假设我们在Dialogflow fulfillment编辑器中编写了以下云函数:</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="f276" class="lm jf hi li b fi ln lo l lp lq">const { WebhookClient, Payload } = require('dialogflow-fulfillment');</span><span id="faa2" class="lm jf hi li b fi lr lo l lp lq">exports.dialogflowFirebaseFulfillment = functions.https.onRequest((request, response) =&gt; {</span><span id="40b9" class="lm jf hi li b fi lr lo l lp lq">   let agent = new WebhookClient({ request, response });</span><span id="0079" class="lm jf hi li b fi lr lo l lp lq">   let intentMap = new Map();</span><span id="78d5" class="lm jf hi li b fi lr lo l lp lq">   intentMap.set('test', test);</span><span id="0fe7" class="lm jf hi li b fi lr lo l lp lq">   agent.handleRequest(intentMap);</span><span id="3e5e" class="lm jf hi li b fi lr lo l lp lq">});</span></pre><p id="cecd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Dialogflow中，我们创建了一个名为'<strong class="ih hj"> test </strong>'的意图，它启用了fulfillment webhook。</p><p id="bc46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用我在本文前面使用的<a class="ae jd" href="https://gist.github.com/savelee/612450be03f64a69cc2d4b2b4a5b9d32" rel="noopener ugc nofollow" target="_blank"> rich卡示例</a>。取而代之的是一个函数<strong class="ih hj"> getCard </strong>，返回这个定制的有效载荷对象。</p><p id="e268" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">测试方法应该是这样的:</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="2831" class="lm jf hi li b fi ln lo l lp lq">function test(agent){</span><span id="bee5" class="lm jf hi li b fi lr lo l lp lq">    let json = getCard();</span><span id="dc49" class="lm jf hi li b fi lr lo l lp lq">    let payload = new Payload(</span><span id="5003" class="lm jf hi li b fi lr lo l lp lq">        'hangouts',</span><span id="7d61" class="lm jf hi li b fi lr lo l lp lq">        json,</span><span id="7970" class="lm jf hi li b fi lr lo l lp lq">        { rawPayload: true, sendAsMessage: true}</span><span id="be02" class="lm jf hi li b fi lr lo l lp lq">    );</span><span id="4e99" class="lm jf hi li b fi lr lo l lp lq">    agent.add(payload);</span><span id="1bc4" class="lm jf hi li b fi lr lo l lp lq">}</span></pre><p id="c055" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们正在创建一个<strong class="ih hj">有效载荷</strong>对象。将平台指定为字符串很重要:<strong class="ih hj"> hangouts </strong>以确保它会出现在Google Hangouts中。</p><p id="cd63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第二个参数是前面提到的自定义有效负载。</p><p id="4132" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将需要指定第三个对象，它将<strong class="ih hj"> rawPayload </strong>设置为<strong class="ih hj"> true </strong>，并确保它将作为消息发送<strong class="ih hj">。</strong></p><p id="64ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">去吧，测试一下。应该能行！</p></div></div>    
</body>
</html>