<html>
<head>
<title>Airflow meets bigquery-to-datastore</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">气流满足大型数据存储查询</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/airflow-meets-bigquery-to-datastore-6ac8eb460566?source=collection_archive---------2-----------------------#2017-10-26">https://medium.com/google-cloud/airflow-meets-bigquery-to-datastore-6ac8eb460566?source=collection_archive---------2-----------------------#2017-10-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8be1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在文章的<a class="ae jd" rel="noopener" href="/google-cloud/export-bigquery-to-google-datastore-with-apache-beam-google-dataflow-7fff1566f345">中描述了一个将BigQuery表导出到Google Datastore的工具。当然，当您通过CLI制作数据产品的新版本时，该工具会很有帮助。</a></p><p id="5d7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我将描述气流可以增强<code class="du je jf jg jh b">bigquery-to-datastore</code>，使其成为一个预定的工作。我想给你一个在生产中使用<code class="du je jf jg jh b">bigquery-to-datastore</code>的提示。</p><h1 id="6aef" class="ji jj hi bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">什么是<code class="du je jf jg jh b">bigquery-to-datastore</code></h1><p id="0701" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">bigquery-to-datastore是一个将bigquery表导出到Google Datastore的工具。我们不必被它的模式所困扰，我们只需执行一个命令就可以了。</p><div class="kl km ez fb kn ko"><a href="https://github.com/yu-iskw/bigquery-to-datastore" rel="noopener  ugc nofollow" target="_blank"><div class="kp ab dw"><div class="kq ab kr cl cj ks"><h2 class="bd hj fi z dy kt ea eb ku ed ef hh bi translated">Yu-iskw/大查询到数据存储</h2><div class="kv l"><h3 class="bd b fi z dy kt ea eb ku ed ef dx translated">bigquery-to-Datastore——使用Apache Beam/Google数据流将整个big query表导出到Google Datastore</h3></div><div class="kw l"><p class="bd b fp z dy kt ea eb ku ed ef dx translated">github.com</p></div></div></div></a></div><p id="a5cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这方面，我觉得可以把BigQuery不仅仅看作是一个数据分析平台，更可以看作是一个分布式处理平台。如你所知，BigQuery速度非常快，有很多方便的功能，而且简单易学。许多人可以参与开发可伸缩的数据产品。</p><h1 id="93a0" class="ji jj hi bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">带气流的BigQuery</h1><p id="c262" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">您可能知道，apache airflow有一个与BigQuery相关的各种运算符:<code class="du je jf jg jh b">BigQueryOperator</code>执行bigquery SQL查询。它允许我们将查询结果存储到bigquery表中；<code class="du je jf jg jh b">BigQueryTableDeleteOperator</code>可以删除bigquery表；<code class="du je jf jg jh b">BigQueryToBigQueryOperator</code>允许我们从一个bigquery表复制到另一个；以及<code class="du je jf jg jh b">BigQueryValueCheckOperator</code>和<code class="du je jf jg jh b">BigQueryIntervalCheckOperator</code>允许我们检查bigquery SQL查询的结果。这就是为什么我们基本上不需要在airflow中为bigquery实现任何功能。</p><h1 id="d7c7" class="ji jj hi bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">气流符合<code class="du je jf jg jh b">bigquery-to-datastore</code></h1><p id="09d3" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">正如我上面描述的，我们完全可以用气流操作bigquery。我们能够充分利用airflow的bigquery操作符和<code class="du je jf jg jh b">bigquery-to-datastore</code>来进行调度作业。我会给你一个使用它的例子。</p><p id="3448" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，考虑我们想要在像Medium这样的博客站点中给出用户的统计页面。此外，统计页面包括每天阅读页面的用户数量。为此，我们必须计算统计数据，然后将结果存储到任何数据存储中。</p><figure class="ky kz la lb fd lc er es paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="er es kx"><img src="../Images/191a5130f9a88291fdcd50d34af894b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v55rAs9tE92gX9MPNU1S0Q.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">气流流向的有向无环图</figcaption></figure><p id="7440" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在示例DAG(有向无环图)中，有三个任务。首先，<code class="du je jf jg jh b">BigQueryTableDeleteOperator</code>任务删除一个bigquery表，如果已经存在的话。不幸的是，气流1.8.2下的<code class="du je jf jg jh b">BigQueryOperater</code>不支持写配置，比如<code class="du je jf jg jh b">WRITE_TRUNCATE</code>。因此，我们不能通过直接执行查询来重写表。这就是为什么我们需要事先删除一个以防万一。其次，<code class="du je jf jg jh b">BigQueryOperator</code>的任务将一个查询的结果存储到另一个任务中。最后，将执行一个任务<code class="du je jf jg jh b">bigquery-to-datastore</code>将表传输到Google Datastore。</p><pre class="ky kz la lb fd ln jh lo lp aw lq bi"><span id="d39c" class="lr jj hi jh b fi ls lt l lu lv"><em class="lw"># Delete a BigQuqery table in just case</em><br/>delete_table_task = BigQueryTableDeleteOperator(<br/>    dag=dag,<br/>    task_id='delete_table',<br/>    deletion_dataset_table="stats.page_views",<br/>    bigquery_conn_id='google_cloud_default',<br/>    ignore_if_missing=True,<br/>)</span></pre><p id="2ac0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其中<code class="du je jf jg jh b">deletion_dataset_table</code>选项表示我们要删除的目标bigquery表，<code class="du je jf jg jh b">ignore_if_missing</code>选项表示当目标表不存在时任务将忽略。</p><pre class="ky kz la lb fd ln jh lo lp aw lq bi"><span id="4ebe" class="lr jj hi jh b fi ls lt l lu lv">query = """<br/>SELECT<br/>  page,<br/>  DATE(event_time) AS dt,<br/>  COUNT(DISTINCT user_id) AS users<br/>FROM event_log<br/>WHERE DATE_DIFF(CURRENT_DATE(), dt, DAY) &lt;= 30<br/>GROUP BY 1<br/>"""<br/>insert_table_task = BigQueryOperator(<br/>    dag=dag,<br/>    task_id='insert_table',<br/>    bigquery_conn_id='google_cloud_default',<br/>    bql=query,<br/>    destination_dataset_table="stats.page_views",<br/>    allow_large_results=True,<br/>    use_legacy_sql=False)</span></pre><p id="861a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其中<code class="du je jf jg jh b">destination_dataset_table</code>表示我们希望存储bigquery SQL查询结果的bigquery表，<code class="du je jf jg jh b">user_legacy_sql=False</code>表示该查询作为标准SQL执行。</p><pre class="ky kz la lb fd ln jh lo lp aw lq bi"><span id="d70b" class="lr jj hi jh b fi ls lt l lu lv">bash_command = """<br/>java -cp /var/lib/dataflow/bigquery-to-datastore-bundled.jar<br/>  com.github.yuiskw.beam.BigQuery2Datastore <br/>  --project=YOUR_GCP_PROJECT<br/>  --runner=DataflowRunner<br/>  --gcpTempLocation=gs://dataflow/dataflow-staging/ <br/>  --tempLocation=gs://udataflow/dataflow-staging/<br/>  --inputBigQueryDataset=stats <br/>  --inputBigQueryTable=page_views<br/>  --outputDatastoreNamespace=stats<br/>  --outputDatastoreKind=PageViews<br/>  --keyColumn=page<br/>  --workerMachineType=n1-standard-4<br/>  --maxNumWorkers=5<br/>bigquery_to_datastore_task = BashOperator(<br/>    dag=dag,<br/>    task_id="bigquery_to_datastore",<br/>    bash_command=bash_command,<br/>)</span></pre><p id="4a8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们只需定义这些任务之间的依赖关系。</p><pre class="ky kz la lb fd ln jh lo lp aw lq bi"><span id="b3d4" class="lr jj hi jh b fi ls lt l lu lv">delete_table_task.set_downstream(insert_table_task)<br/>insert_table_task.set_downstream(bigquery_to_datastore_task)</span></pre><h1 id="0caa" class="ji jj hi bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">结论</h1><p id="21ed" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">在本文中，我描述了如何将气流与<code class="du je jf jg jh b">bigquery-to-datastore</code>结合起来。我们能够使用airflow和<code class="du je jf jg jh b">bigquery-to-datastore</code>非常轻松地制作可扩展的数据产品。我知道它不能满足你所有的要求。但是，如果您可以避免系统不使用，它允许不太熟悉大数据产品的人构建可扩展的数据产品。</p><p id="7bac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们不需要用机器学习做所有的事情。如果不用机器学习就能造出东西，那就更好了。在这种情况下，我确信我在文章中描述的内容会有所帮助。</p></div></div>    
</body>
</html>