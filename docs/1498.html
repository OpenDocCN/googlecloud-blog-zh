<html>
<head>
<title>6 Steps to Migrate to Cloud Spanner</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">迁移到云扳手的6个步骤</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/6-steps-to-migrate-to-cloud-spanner-8b83d497c847?source=collection_archive---------3-----------------------#2020-07-06">https://medium.com/google-cloud/6-steps-to-migrate-to-cloud-spanner-8b83d497c847?source=collection_archive---------3-----------------------#2020-07-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/509941a7b1ab146b48f80a1fb82b8915.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fDFFI5tHLHl-382t"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">雅利安·辛格在<a class="ae hv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><div class=""/><p id="8f66" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jt">这是迁移到Cloud Spanner的必要步骤的概述，其中有一些应用程序停机时间(使用Cloud Spanner也可以实现零停机时间迁移，但不在本文讨论范围之内)。我们假设您已经评估了Cloud Spanner(也许使用我们的免费模拟器— </em> <a class="ae hv" href="https://cloud.google.com/spanner/docs/emulator" rel="noopener ugc nofollow" target="_blank"> <em class="jt">在这里试试吧！</em> </a> <em class="jt">)并确定它最适合您的用例。这篇博客旨在为迁移过程提供一个框架。根据您的特定源数据库，有些步骤可能比其他步骤更复杂。</em></p><figure class="jv jw jx jy fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ju"><img src="../Images/c02bfdcd1c09a311e5574f1bde9b1913.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SXUh9y5z98biZwkaIBbfsw.png"/></div></div></figure></div><div class="ab cl jz ka gp kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hb hc hd he hf"><h1 id="75a7" class="kg kh hy bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">步骤1:确定实例大小并准备应用程序</h1><p id="60c3" class="pw-post-body-paragraph iv iw hy ix b iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo li jq jr js hb bi translated">根据您的QPS和数据大小要求，确定您将需要的扳手节点的数量。您可以使用每个spanner节点10，000次QPS读取/ 2，000次QPS写入作为起点，但请注意，实际QPS会根据您的请求大小和读写混合情况而有所不同。</p><p id="2c42" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要准备您的应用程序进行迁移，请为您的原始数据库创建一个数据库访问对象，并为spanner创建一个数据库访问对象。您应该能够通过一个标志轻松地在这两者之间切换。这将在迁移过程中对您有很大帮助。或者，您可以设置双重写入(写入原始数据库和spanner ),以在迁移不成功的情况下减少对用户的影响。注意:这种双重写入的目的是作为一种后备机制，而不是减少应用程序经历的停机时间。</p><h1 id="2822" class="kg kh hy bd ki kj lj kl km kn lk kp kq kr ll kt ku kv lm kx ky kz ln lb lc ld bi translated">步骤2:负载测试</h1><p id="eb00" class="pw-post-body-paragraph iv iw hy ix b iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo li jq jr js hb bi translated">为了确保您已经为您的工作负载提供了足够的实例，您将需要在具有一些合成代表性工作负载的实例上执行负载测试。需要注意的是QPS、P50、P95、P99读写延迟、吞吐量、CPU利用率以及您感兴趣的任何其他指标。如果您发现区域性实例的CPU利用率超过65%,或者多区域性实例的CPU利用率超过45%,那么您将需要扩展您的实例。负载测试需要运行很长一段时间(几个小时)才能获得可靠的结果。这是因为实例需要时间来调整自身以适应工作负载，从而获得最佳性能。我们还建议在更大和更小的实例大小上重新运行测试。当有疑问时，宁可在实例中有更多的节点。</p><h1 id="9c32" class="kg kh hy bd ki kj lj kl km kn lk kp kq kr ll kt ku kv lm kx ky kz ln lb lc ld bi translated">步骤3:批量迁移</h1><p id="4e2a" class="pw-post-body-paragraph iv iw hy ix b iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo li jq jr js hb bi translated">获取当前数据库的快照/导出，并将其导入到spanner中(如果您只是在没有增量的情况下进行批量迁移，那么您应该在获取快照之前关闭应用程序)。如果您正在从另一个Google云数据库(或另一个Cloud Spanner实例——比如从一个区域实例迁移到一个多区域实例)迁移，我们建议您使用数据流来完成这一任务。按照这里的说明，如何从你的原始数据库<a class="ae hv" href="https://cloud.google.com/spanner/docs/export" rel="noopener ugc nofollow" target="_blank">导出</a>和<a class="ae hv" href="https://cloud.google.com/spanner/docs/import" rel="noopener ugc nofollow" target="_blank">导入</a>到扳手。如果您从非Google云资源迁移，请参考您当前数据库的文档，了解如何最好地执行此步骤。</p><p id="3e71" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果移动整个数据集所需的时间超过了应用程序允许的停机时间，您将需要执行一次批量迁移和一次增量迁移。</p><blockquote class="lo lp lq"><p id="551c" class="iv iw jt ix b iy iz ja jb jc jd je jf lr jh ji jj ls jl jm jn lt jp jq jr js hb bi translated"><em class="hy">提示1:在这个阶段，您可以扩大spanner实例的规模，以减少数据迁移所需的时间，并在迁移后缩小规模。进行一些测试，了解随着节点数量的增加，迁移时间是如何变化的。</em></p><p id="60cc" class="iv iw jt ix b iy iz ja jb jc jd je jf lr jh ji jj ls jl jm jn lt jp jq jr js hb bi translated">技巧2:一次性批量迁移比批量+增量迁移简单得多。将您的数据库想象成一个表的集合，确定在应用程序仍然运行时是否可以预先迁移一些表，并计算允许的停机时间是否只适合那些将经历快速变化的表。例如，可以预先移动日志数据/只写数据。</p></blockquote><p id="354a" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果需要增量迁移，您将需要打开变更数据捕获(CDC ),或者找到一种方法来计算自批量迁移完成以来哪些数据发生了变更(时间戳等)。</p><p id="9c56" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">步骤3b:增量迁移(可选—仅适用于允许停机时间少于整个数据集移动时间的应用程序)</p><p id="1e59" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">批量迁移完成并通过验证后，关闭应用程序。通过移动自快照/导出以来传入的新数据开始增量迁移。我们建议您为此也使用数据流模板来并行化迁移。</p><h1 id="efae" class="kg kh hy bd ki kj lj kl km kn lk kp kq kr ll kt ku kv lm kx ky kz ln lb lc ld bi translated">第四步:验证</h1><p id="7fab" class="pw-post-body-paragraph iv iw hy ix b iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo li jq jr js hb bi translated">增量迁移完成后，我们建议您运行一些验证查询，以确保迁移成功。如果出现任何问题，您可以回到您的原始数据库。</p><h1 id="a488" class="kg kh hy bd ki kj lj kl km kn lk kp kq kr ll kt ku kv lm kx ky kz ln lb lc ld bi translated">步骤5:预热扳手+激活应用程序</h1><p id="a70a" class="pw-post-body-paragraph iv iw hy ix b iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo li jq jr js hb bi translated">如果您可以分阶段向用户激活您的应用程序(例如，只允许10%的用户访问，增加到20%，等等)，那么您就不需要预热Spanner。否则，我们建议您在激活您的应用程序之前，使用模拟生产流量运行30分钟到1小时(注意:非代表性流量可能最终会使延迟变得更糟)。这是为了让Spanner调整自己，以最好地服务于您的工作负载。如果没有预热，您可能会在激活应用程序后立即体验到很高的尾部延迟，尽管它最终会稳定下来。</p><p id="3d7d" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">读取和写入现在应该完全由Spanner提供。或者，如果您激活了双重写入，则在出现问题时，您可以回退到原始数据库。您还可以验证Spanner和您的原始数据库是否返回相同的结果。</p><p id="d13a" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jt">如果您还有其他问题，请联系我们</em> <a class="ae hv" href="https://cloud.google.com/contact" rel="noopener ugc nofollow" target="_blank"> <em class="jt">这里</em> </a> <em class="jt">！</em></p></div></div>    
</body>
</html>