<html>
<head>
<title>Firebase: Separating configuration from code in Admin SDK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Firebase:在Admin SDK中将配置与代码分离</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/firebase-separating-configuration-from-code-in-admin-sdk-d2bcd2e87de6?source=collection_archive---------1-----------------------#2018-01-16">https://medium.com/google-cloud/firebase-separating-configuration-from-code-in-admin-sdk-d2bcd2e87de6?source=collection_archive---------1-----------------------#2018-01-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/3792090230a81d453c78befc8e2a0535.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wPeRfeY7wbUchG30GfBFYg.jpeg"/></div></div></figure><div class=""/><p id="3e56" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://firebase.google.com/docs/admin/setup" rel="noopener ugc nofollow" target="_blank">Firebase Admin SDK</a>用于从可信的服务器端环境访问<a class="ae jo" href="https://firebase.google.com/" rel="noopener ugc nofollow" target="_blank"> Firebase </a>服务。然而，在访问任何Firebase服务之前，必须用一组有效的Google凭证初始化Admin SDK。谷歌证书有几种形式，它们授权应用程序访问Firebase和其他各种<a class="ae jo" href="https://cloud.google.com" rel="noopener ugc nofollow" target="_blank">谷歌云平台(GCP) </a>服务。</p><p id="9f44" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/compute/docs/access/service-accounts" rel="noopener ugc nofollow" target="_blank">服务账户凭证</a>是最常用的谷歌凭证类型之一。这些凭证可以作为JSON文件从GCP控制台或Firebase控制台下载，并显式地传递给Admin SDK，如清单1所示。</p><figure class="jp jq jr js fd hk"><div class="bz dy l di"><div class="jt ju l"/></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">清单1:用服务帐户初始化Admin SDK</figcaption></figure><p id="948a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">虽然这种方法开始起来相当简单，但从长远来看，它会带来一些挑战:</p><ol class=""><li id="543a" class="jz ka ht is b it iu ix iy jb kb jf kc jj kd jn ke kf kg kh bi translated">服务帐户凭证必须与代码一起打包和部署，这使得相关的DevOps过程变得复杂。</li><li id="41ac" class="jz ka ht is b it ki ix kj jb kk jf kl jj km jn ke kf kg kh bi translated">服务帐户凭据文件的意外泄露可能会给应用程序和数据安全带来严重后果。</li></ol><p id="c5c3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，使用隐式形式的凭证通常是个好主意，比如Google <a class="ae jo" href="https://developers.google.com/identity/protocols/application-default-credentials" rel="noopener ugc nofollow" target="_blank">应用程序默认凭证(ADC) </a>。ADC使开发人员不必将有形的凭证文件与代码一起发送。相反，ADC使应用能够从其运行时环境中自动<em class="kn">发现</em>凭证。由于在部署过程中没有可能意外暴露的敏感资产，ADC还可以提高部署的应用程序的安全级别。</p><h2 id="a46c" class="ko kp ht bd kq kr ks kt ku kv kw kx ky jb kz la lb jf lc ld le jj lf lg lh li bi translated">使用应用程序默认凭据</h2><p id="3697" class="pw-post-body-paragraph iq ir ht is b it lj iv iw ix lk iz ja jb ll jd je jf lm jh ji jj ln jl jm jn hb bi translated">当应用程序代码部署在GCP环境(如应用程序引擎、计算引擎和云功能)中时，ADC发现即开即用。对于本地测试，有两种方法可以用Google凭证播种环境，以便ADC发现能够成功:</p><ol class=""><li id="d308" class="jz ka ht is b it iu ix iy jb kb jf kc jj kd jn ke kf kg kh bi translated">将服务帐户凭证文件保存到本地文件系统中的安全位置，并设置指向该文件的<code class="du lo lp lq lr b">GOOGLE_APPLICATION_CREDENTIALS</code>环境变量。</li><li id="2fd9" class="jz ka ht is b it ki ix kj jb kk jf kl jj km jn ke kf kg kh bi translated">安装<a class="ae jo" href="https://cloud.google.com/sdk/" rel="noopener ugc nofollow" target="_blank"> Google Cloud SDK </a>，执行<code class="du lo lp lq lr b">gcloud auth application-default login</code>命令。</li></ol><p id="fc4f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一种方法既适合本地测试，也适合GCP以外的生产部署。后者严格用于本地测试。一旦以这两种方式之一设置了开发环境，就可以用ADC初始化Firebase Admin SDK，如清单2所示。</p><figure class="jp jq jr js fd hk"><div class="bz dy l di"><div class="jt ju l"/></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">清单2:用应用程序默认凭证初始化Admin SDK</figcaption></figure><p id="72ac" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，我们不再需要将文件路径硬编码到应用程序中。一旦您在本地测试了您的代码，您可以简单地将它转移到GCP，在那里它将继续工作，不需要任何额外的配置。</p><p id="2ee6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用ADC时，有一点值得注意。当用ADC初始化Firebase Admin SDK时，涉及加密签名数据的功能不起作用。<a class="ae jo" href="https://firebase.google.com/docs/auth/admin/create-custom-tokens" rel="noopener ugc nofollow" target="_blank">定制令牌铸造</a>和<a class="ae jo" href="https://cloud.google.com/storage/docs/access-control/create-signed-urls-program" rel="noopener ugc nofollow" target="_blank">为云存储对象生成签名的URL</a>是这种特性最显著的特征。签名数据需要私钥，目前Admin SDK只能从服务帐户凭据获取私钥。这一限制可能会在未来得到解决，从而使ADC的使用更加不受限制。</p><h2 id="e3b1" class="ko kp ht bd kq kr ks kt ku kv kw kx ky jb kz la lb jf lc ld le jj lf lg lh li bi translated">从环境中加载其他Firebase选项</h2><p id="92a0" class="pw-post-body-paragraph iq ir ht is b it lj iv iw ix lk iz ja jb ll jd je jf lm jh ji jj ln jl jm jn hb bi translated">ADC使我们能够从应用程序中取出Google凭证。但是其他的Firebase设置呢？清单2显示我们仍然需要将Firebase数据库URL硬编码到应用程序中。其他Firebase选项也是如此，比如云存储桶和GCP项目ID。如果Admin SDK可以从环境中自动发现这些参数，这样您就可以将代码从配置中完全分离出来，这不是很好吗？事实上，现在你可以！</p><p id="7430" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Firebase团队刚刚<a class="ae jo" href="https://firebase.google.com/support/releases#january_11_2018" rel="noopener ugc nofollow" target="_blank">发布了</a>Admin SDK中的一个新特性，允许从环境中加载所有Firebase配置选项。只需创建一个类似清单3的JSON文件，包含必要的设置，并设置环境变量<code class="du lo lp lq lr b">FIREBASE_CONFIG</code>指向它。</p><figure class="jp jq jr js fd hk"><div class="bz dy l di"><div class="jt ju l"/></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">清单Admin SDK的示例Firebase配置文件</figcaption></figure><p id="d9bf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在可以不用任何参数初始化Firebase Admin SDK，如清单4所示。</p><figure class="jp jq jr js fd hk"><div class="bz dy l di"><div class="jt ju l"/></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">清单4:在没有显式参数的情况下初始化管理SDK</figcaption></figure><p id="59be" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这指示SDK从环境中获取Firebase选项，同时使用ADC进行授权。类似的API现在可以在Admin SDK支持的所有编程语言中使用(Node.js、Java、Python和Go)。然而，这是一个新特性，GCP还不支持开箱即用。但是您可以在您的开发环境中使用它，并在您认为合适的时候在非GCP部署Firebase Admin SDK。</p><p id="bb67" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您希望在GCP立即使用这个特性，您可以通过在您的云实例中设置<code class="du lo lp lq lr b">FIREBASE_CONFIG</code>环境变量来实现。这在计算引擎和<a class="ae jo" href="https://cloud.google.com/appengine/docs/flexible/nodejs/configuring-your-app-with-app-yaml#Node.js_app_yaml_Defining_environment_variables" rel="noopener ugc nofollow" target="_blank">应用引擎</a>中很容易实现。如果没有该变量，您的应用程序将不会自动发现Firebase选项，但ADC发现将照常工作。因此，目前这一功能可能看起来不如ADC强大。然而，它提供了一个简单的和语言中立的机制来将Firebase选项从应用程序代码中分离出来。随着时间的推移，随着它在GCP变得标准化，它将会得到自己的认可。</p><h2 id="4d77" class="ko kp ht bd kq kr ks kt ku kv kw kx ky jb kz la lb jf lc ld le jj lf lg lh li bi translated">结论</h2><p id="0d78" class="pw-post-body-paragraph iq ir ht is b it lj iv iw ix lk iz ja jb ll jd je jf lm jh ji jj ln jl jm jn hb bi translated">将配置从代码中分离出来是一种广泛使用的软件工程实践，它可以使代码更简单、更易于维护。有了应用程序默认凭证和新的Admin SDK初始化API，开发人员可以清楚地将Google凭证和Firebase选项从他们的应用程序中分离出来。我希望这篇文章鼓励更多的开发人员利用这些特性，这简化了开发，同时使应用程序在不同的环境中更加可移植。愉快的编码，让我知道你对新的Admin SDK初始化API的看法。</p></div></div>    
</body>
</html>