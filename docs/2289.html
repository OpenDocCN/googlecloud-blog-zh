<html>
<head>
<title>GitLab integration with GCP cloud build for CI/CD</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GitLab与GCP CI/CD云构建的集成</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gitlab-integration-with-gcp-cloud-build-for-ci-cd-9a3915bc1f92?source=collection_archive---------3-----------------------#2022-08-05">https://medium.com/google-cloud/gitlab-integration-with-gcp-cloud-build-for-ci-cd-9a3915bc1f92?source=collection_archive---------3-----------------------#2022-08-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/53e03828afd9a6882eb23068d2fd8ecc.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/1*P1M1nAF9VZlzQA89eGCFPw.jpeg"/></div></figure><p id="9ae1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这篇博客中，我们将讨论如何使用webhook触发器将云构建与GitLab集成，构建Docker映像，并将其部署到云运行中。</p><h2 id="0c9e" class="jk jl hi bd jm jn jo jp jq jr js jt ju ix jv jw jx jb jy jz ka jf kb kc kd ke bi translated">问题陈述:</h2><p id="847e" class="pw-post-body-paragraph im in hi io b ip kf ir is it kg iv iw ix kh iz ja jb ki jd je jf kj jh ji jj hb bi translated">我们的一个客户希望使用云构建实现CI/CD管道，以便在云运行上部署Docker映像。他们将应用程序代码托管在GitLab上。Cloud build提供了与Cloud Source Repository、GitHub和BitBucket的直接集成，但是没有与GitLab的直接集成。</p><h2 id="122c" class="jk jl hi bd jm jn jo jp jq jr js jt ju ix jv jw jx jb jy jz ka jf kb kc kd ke bi translated"><strong class="ak">整合:</strong></h2><p id="92be" class="pw-post-body-paragraph im in hi io b ip kf ir is it kg iv iw ix kh iz ja jb ki jd je jf kj jh ji jj hb bi translated">要在GitLab上创建一个webhook触发器，我们需要创建一个SSH密钥来验证您到GitLab的连接。您需要在内联构建配置中检索SSH密钥来访问GitLab上的代码。</p><p id="cddc" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">将云构建与GitLab集成的步骤如下:</p><ol class=""><li id="3f34" class="kk kl hi io b ip iq it iu ix km jb kn jf ko jj kp kq kr ks bi translated">创建SSH密钥。</li><li id="530f" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">在GitLab上添加您的公共SSH访问密钥。</li><li id="991a" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">在Secret Manager中存储您的私有SSH密钥。</li><li id="42b0" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">正在创建Webhook触发器。</li><li id="4cf0" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">在GitLab中创建webhook。</li></ol><h2 id="725e" class="jk jl hi bd jm jn jo jp jq jr js jt ju ix jv jw jx jb jy jz ka jf kb kc kd ke bi translated">实施:</h2><p id="8229" class="pw-post-body-paragraph im in hi io b ip kf ir is it kg iv iw ix kh iz ja jb ki jd je jf kj jh ji jj hb bi translated"><strong class="io hj">第一步:创建SSH密钥</strong></p><p id="69af" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">创建一个新的GitLab SSH密钥，其中“gitlab.com”是您的GitLab存储库的URL。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="71b7" class="jk jl hi ld b fi lh li l lj lk">ssh-keygen -t rsa -b 4096 -N ‘’ -C gitlab.com -f id_gitlab</span></pre><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ll"><img src="../Images/b3fc0853dbbdd3e3680b519f9abf2ff2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iC4Xcg-Ep3cEh5Ku"/></div></div></figure><p id="9035" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这将生成两个密钥文件，一个是公共文件“id_gitlab.pub”，另一个是私有密钥文件“id_gitlab”。</p><p id="0ee2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">第二步:</strong> <strong class="io hj">在GitLab上添加你的公共SSH访问密钥</strong></p><p id="2292" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，我们需要添加一个公共SSH密钥(。pub ),它是在GitLab的第一步中生成的，用于安全操作。为此，请遵循以下步骤。</p><ul class=""><li id="b1d0" class="kk kl hi io b ip iq it iu ix km jb kn jf ko jj lq kq kr ks bi translated">登录GitLab。</li><li id="54af" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">选择顶部栏右上角的<strong class="io hj">首选项</strong>。</li><li id="5e42" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">选择左侧边栏上的<strong class="io hj"> SSH键、</strong>。</li><li id="f26c" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">将您的公钥内容粘贴到<strong class="io hj">密钥</strong>框中。如果您手动复制了密钥，请确保复制了整个密钥，以<em class="lr"> ssh-rsa、ssh-dss、ssh-ed25519、ecdsa-sha2-nistp256、ecdsa-sha2-nistp521、sk-ecdsa-sha2-nistp256@openssh.com、</em>或<em class="lr">sk-ssh-ed25519@openssh.com</em>、<em class="lr"> ecdsa-sha2-nistp384 </em>开始，并可能以注释结束。</li><li id="c8ee" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">在<strong class="io hj">标题</strong>框中，键入描述，如云构建或云构建配置项。</li><li id="9b75" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">在<strong class="io hj">到期日期</strong>框中，选择一个到期日期(可选)。</li></ul><p id="b4b4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">第三步:</strong> S <strong class="io hj">在秘密管理器中存放你的私有SSH密钥</strong></p><p id="4d4a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们需要在GCP的秘密管理器中存储在步骤1中生成的秘密SSH密钥。</p><ul class=""><li id="6be4" class="kk kl hi io b ip iq it iu ix km jb kn jf ko jj lq kq kr ks bi translated">转到云控制台中的秘密管理器页面</li><li id="e7d6" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">在“机密管理器”页面上，单击“创建机密”。</li><li id="99fe" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">在Create secret页面的Name下，输入您的秘密的名称，比如<strong class="io hj"> gitlab-ssh-secret-key </strong>。</li><li id="e20a" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">在“秘密值”字段中，粘贴您的私钥内容。</li><li id="85da" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">保持区域部分不变。</li><li id="a182" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">单击“创建密码”按钮创建您的密码。</li></ul><p id="abe0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">步骤4:创建webhook触发器</strong></p><p id="f5ec" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在是时候创建一个从GitLab调用构建的webhook触发器了。</p><ul class=""><li id="a9da" class="kk kl hi io b ip iq it iu ix km jb kn jf ko jj lq kq kr ks bi translated">打开触发器页面。</li><li id="83ed" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">单击创建触发器。</li><li id="3d1f" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">输入以下触发设置:</li></ul><p id="5e3e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">i) <strong class="io hj">名称:</strong>您的触发器的名称。</p><p id="0b60" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">ii) <strong class="io hj">地区</strong>:默认设置为全球。保持原样。</p><p id="b476" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">iii) <strong class="io hj">描述</strong>(可选):对你的触发器的描述。</p><p id="d32f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">iv) <strong class="io hj">事件</strong>:选择<strong class="io hj"> Webhook </strong>事件来设置您的触发器，以启动构建来响应传入的Webhook事件。</p><p id="a78a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">v) <strong class="io hj"> Webhook URL </strong>:使用Webhook URL来认证传入的Webhook事件。</p><ul class=""><li id="63da" class="kk kl hi io b ip iq it iu ix km jb kn jf ko jj lq kq kr ks bi translated"><strong class="io hj">秘密</strong>:你需要一个秘密来认证进入的webhook事件。您可以创建新密码或使用现有密码。</li></ul><p id="5d78" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要创建新的秘密:</p><p id="d0b7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">a.选择<strong class="io hj">创建新的</strong>。</p><p id="dde7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">b.点击<strong class="io hj">创建密码</strong>。你会看到<strong class="io hj">创建一个webhook秘密</strong>弹出框。</p><p id="6ab4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">c.在<strong class="io hj">机密名称</strong>字段中，输入您的机密名称，比如<strong class="io hj"> gitlab-webhook-secret </strong>。</p><p id="2502" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">d.点击<strong class="io hj">创建密码</strong>保存您的密码，该密码将自动创建并保存在密码管理器中</p><p id="ee14" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要使用现有机密:</p><p id="91c9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">a.选择<strong class="io hj">使用现有的</strong>。</p><p id="c71f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">b.在<strong class="io hj">机密</strong>字段中，从下拉菜单中选择您想要使用的机密名称，或者按照说明通过资源ID添加机密。</p><p id="18e0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">c.在<strong class="io hj">机密版本</strong>字段中，从下拉菜单中选择您的机密版本。</p><p id="8126" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在您创建或选择了您的秘密后，您将会看到一个<strong class="io hj"> Webhook URL预览</strong>。您的URL将包含由云构建生成的API密钥和您的秘密。</p><ul class=""><li id="a9d8" class="kk kl hi io b ip iq it iu ix km jb kn jf ko jj lq kq kr ks bi translated"><strong class="io hj"> Source </strong>(可选):webhook触发器运行时要构建的存储库。将此字段留空。</li><li id="378b" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated"><strong class="io hj">配置</strong>:在Google Cloud控制台中创建一个内联构建配置。</li></ul><p id="2918" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在内联YAML文件中添加如下所示的三个步骤，内联构建配置中的前两个步骤首先使用您的SSH密钥验证您到GitLab的连接，并访问您指定的存储库。第三步检查调用该构建的特定提交。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="533b" class="jk jl hi ld b fi lh li l lj lk">steps:<br/># first, setup SSH:<br/># 1- save the SSH key from Secret Manager to a file<br/># 2- add the host key to the known_hosts file<br/>- name: gcr.io/cloud-builders/git<br/>  args:<br/>  - ‘-c’<br/>  - |<br/>    echo “$$SSHKEY” &gt; /root/.ssh/id_rsa<br/>    chmod 400 /root/.ssh/id_rsa<br/>    ssh-keyscan gitlab.com &gt; /root/.ssh/known_hosts<br/>  entrypoint: bash<br/>  secretEnv:<br/>  - SSHKEY<br/>  volumes:<br/>  - name: ssh<br/>    path: /root/.ssh</span><span id="44b1" class="jk jl hi ld b fi ls li l lj lk"># second, clone the repository<br/>- name: gcr.io/cloud-builders/git<br/>  args:<br/>  - clone<br/>  - ‘-n’<br/>  - ‘git@gitlab.com:pranavdhopey/springapp.git’<br/>  - .<br/>  volumes:<br/>  - name: ssh<br/>    path: /root/.ssh</span><span id="2265" class="jk jl hi ld b fi ls li l lj lk"># third, checkout the specific commit that invoked this build<br/>- name: gcr.io/cloud-builders/git<br/>  args:<br/>  - checkout<br/>  - $_TO_SHA</span><span id="a713" class="jk jl hi ld b fi ls li l lj lk">availableSecrets:<br/>  secretManager:<br/>  - versionName: projects/&lt;project_no&gt;/secrets/&lt;secret-name&gt;/versions/latest<br/>  env: SSHKEY</span></pre><ul class=""><li id="799e" class="kk kl hi io b ip iq it iu ix km jb kn jf ko jj lq kq kr ks bi translated"><strong class="io hj">替换</strong>(可选):我们可以使用该字段定义特定于触发器的替换变量。</li></ul><p id="4394" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在我们的例子中，我们创建了两个替换变量' _BRANCH '和' _TO_SHA '。假设您想要观察与提交ID相关联的特定分支名称，然后在构建定义中切换到该分支名称。为了获得这些数据，您可以使用有效负载绑定来创建替代变量，以保存分支名称。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="2e1f" class="jk jl hi ld b fi lh li l lj lk">‘_BRANCH’: $(body.ref)<br/>‘_TO_SHA’: $(body.after)</span></pre><ul class=""><li id="d3e5" class="kk kl hi io b ip iq it iu ix km jb kn jf ko jj lq kq kr ks bi translated"><strong class="io hj"> Filters </strong>(可选):您可以在一个触发器中创建一个规则，该规则决定您的触发器是否将基于您的替代变量执行构建。</li></ul><p id="d784" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">因为我们希望触发器在分支名称与dev匹配时执行构建，所以我们使用了“==”操作符来检查精确匹配。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="f8aa" class="jk jl hi ld b fi lh li l lj lk">“_BRANCH == refs/heads/dev”</span></pre><ul class=""><li id="5d47" class="kk kl hi io b ip iq it iu ix km jb kn jf ko jj lq kq kr ks bi translated">点击<strong class="io hj">创建</strong>来创建你的构建触发器。</li></ul><figure class="ky kz la lb fd ij er es paragraph-image"><div class="er es lt"><img src="../Images/0b058d39ea074cd5ee261fbc77e8688f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/0*dR9Fk-b7fONq_tAm"/></div></figure><figure class="ky kz la lb fd ij er es paragraph-image"><div class="er es lu"><img src="../Images/c83d533c7f44e1927e230fd9dd44cb45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/0*Boln5O-dr8zE6Sug"/></div></figure><figure class="ky kz la lb fd ij er es paragraph-image"><div class="er es lv"><img src="../Images/3721773c7142bad97df993dfdfa1c0c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/0*BCf3QCcJGlTe-smj"/></div></figure><figure class="ky kz la lb fd ij er es paragraph-image"><div class="er es lw"><img src="../Images/d7469b137c17b35426e7a182f09e80be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/0*4LjW6VZMoYMgxIDM"/></div></figure><p id="4726" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">第五步:在GitLab中创建一个web hook</strong></p><p id="73ee" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这一步中，我们将把上一步中生成的Webhook URL添加到GitLab项目中。</p><ol class=""><li id="44bb" class="kk kl hi io b ip iq it iu ix km jb kn jf ko jj kp kq kr ks bi translated">在您的项目或组中，在左侧栏中，选择<strong class="io hj">设置&gt; Webhooks </strong>。</li><li id="481b" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">在URL中，输入webhook端点的URL。如果URL包含一个或多个特殊字符，则必须使用百分比编码。</li><li id="f8bb" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">在<strong class="io hj">触发</strong>部分，选择触发webhook的事件。</li><li id="26b5" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">可选。清除<strong class="io hj">启用SSL验证</strong>复选框以禁用SSL验证。</li><li id="ac55" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">选择<strong class="io hj">添加webhook </strong></li></ol><p id="5e8e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这就是我们如何将云构建与GitLab集成并建立CI/CD管道。</p></div><div class="ab cl lx ly gp lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hb hc hd he hf"><figure class="ky kz la lb fd ij er es paragraph-image"><div class="er es me"><img src="../Images/dfd6a4ee3f4fa6ff66d51fd92573145b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*0VUi-VLQzSknZsUipCW1Lg.png"/></div></figure><p id="fbf7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们用一个例子来理解这个。我们在GitLab存储库中托管了一个spring-boot应用程序。您可以从我的<a class="ae mf" href="https://github.com/pranavdhopey/springapp.git" rel="noopener ugc nofollow" target="_blank"> GitHub </a>库复制一个示例代码，并将其托管在您的GitLab中。</p><p id="41d0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，按照上面的步骤将GitLab存储库与Cloud Build集成，并按照步骤中的说明配置触发器。</p><p id="7086" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">工作流程:</strong></p><p id="ccbc" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">1.持续集成(CI渠道):</p><ul class=""><li id="8b34" class="kk kl hi io b ip iq it iu ix km jb kn jf ko jj lq kq kr ks bi translated">开发人员对代码进行更改，修复错误，并将其推送到应用程序存储库。</li><li id="681a" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">然后，Cloud build通过存储库上的webhook事件自动调用触发器。</li><li id="189b" class="kk kl hi io b ip kt it ku ix kv jb kw jf kx jj lq kq kr ks bi translated">一旦触发器被任何事件调用，cloud build就会执行内嵌编辑器中编写的指令，例如从提供的Dockerfile构建docker映像，并将其推送到配置的容器注册表中。</li></ul><p id="954e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">2.持续部署(CD管道)</p><ul class=""><li id="a652" class="kk kl hi io b ip iq it iu ix km jb kn jf ko jj lq kq kr ks bi translated">一旦Docker映像被推送到容器注册中心，云构建将使用给定的配置将映像部署到云运行，最后，云运行将在无服务器平台上托管应用程序。</li></ul><p id="88d2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在云构建触发器的内联编辑器中复制以下代码。</p><figure class="ky kz la lb fd ij"><div class="bz dy l di"><div class="mg mh l"/></div></figure><p id="7a42" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">第一步，内联构建配置使用您的SSH密钥验证您到GitLab的连接，并访问您指定的存储库。接下来，在第二步和第三步中，它会克隆存储库，并根据您在触发器上设置的过滤器检查调用webhook的提交。</p><p id="ad5c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">上述内联构建配置文件的第四步将从代码中构建一个docker映像，该映像的标签为'<strong class="io hj"> latest </strong>，提交id从替换变量`<strong class="io hj"> _TO_SHA </strong>'中提取，并将映像推送到容器注册表中。现在，在最后一步中，docker映像将使用提供的配置部署到云运行，并创建一个云运行服务。</p><p id="5b8e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">每当开发人员进行更改时，云构建触发器就会被webhook事件调用，并执行内联构建配置文件中的步骤，该文件将构建名为“springapp”的docker映像，并以“latest”和“commit id”作为标签，然后将其推送到GCR。</p><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mi"><img src="../Images/ee42a4436b401fb8ab5b59a885c6c7fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E2GHa41fc4_QHcxkj9Pa8g.jpeg"/></div></div></figure><p id="1b13" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在图像被推送后，它将被部署在一个云服务器上，并将获得一个触发URL来测试它。</p><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mj"><img src="../Images/cce049c450fd5dab44336de6466d4350.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*du1EhE_d3eyKcJVM07gtUA.jpeg"/></div></div></figure><p id="b766" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下面是云运行触发器URL的截图。</p><figure class="ky kz la lb fd ij er es paragraph-image"><div class="er es mk"><img src="../Images/7e1833c5cbb49329d16b20fc292562d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*OrKmFv0XVPAg8nZ30rNK4Q.png"/></div></figure><h2 id="917a" class="jk jl hi bd jm jn jo jp jq jr js jt ju ix jv jw jx jb jy jz ka jf kb kc kd ke bi translated"><strong class="ak">结论:</strong></h2><p id="4beb" class="pw-post-body-paragraph im in hi io b ip kf ir is it kg iv iw ix kh iz ja jb ki jd je jf kj jh ji jj hb bi translated">我们已经看到了Docker Image在云上的端到端部署，使用Cloud Build作为CI/CD工具，与外部源代码管理系统GitLab集成，并托管了一个示例spring boot应用程序。</p></div></div>    
</body>
</html>