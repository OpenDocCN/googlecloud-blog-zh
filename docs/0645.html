<html>
<head>
<title>Safer `gcloud` and `kubectl`</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">更安全的“gcloud”和“kubectl”</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/context-light-gcloud-and-kubectl-89185d38ce82?source=collection_archive---------1-----------------------#2018-06-13">https://medium.com/google-cloud/context-light-gcloud-and-kubectl-89185d38ce82?source=collection_archive---------1-----------------------#2018-06-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="c3bd" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">如何保护自己不被自己伤害</h2></div><p id="1dd5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">好吧，这有它自己的故事！</p><p id="b15c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我一直在寻找一个与<code class="du jt ju jv jw b">kubectl</code>的安全网，我一直在与<code class="du jt ju jv jw b">gcloud</code>一起使用。今天，我意识到它一直在那里，只是我没有意识到。</p><p id="e800" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我可以:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="a483" class="kf kg hi jw b fi kh ki l kj kk">kubectl get nodes<br/>The connection to the server localhost:8080 was refused - did you specify the right host or port?</span><span id="9b00" class="kf kg hi jw b fi kl ki l kj kk">kubectl get pods<br/>The connection to the server localhost:8080 was refused - did you specify the right host or port?</span></pre><p id="b428" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">…这让我很开心！</p><p id="a21d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我支持一下…因为我认为这是一个不错的做法，我已经和<code class="du jt ju jv jw b">gcloud</code>一起使用很久了。</p><h2 id="0267" class="kf kg hi bd km kn ko kp kq kr ks kt ku jg kv kw kx jk ky kz la jo lb lc ld le bi translated">gcloud</h2><p id="d754" class="pw-post-body-paragraph ix iy hi iz b ja lf ij jc jd lg im jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">像<code class="du jt ju jv jw b">kubectl</code>这样的Google云平台的CLI(非正式的叫<code class="du jt ju jv jw b">gcloud</code>)想通过持久化|假设上下文来节省时间。你会经常看到:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="caed" class="kf kg hi jw b fi kh ki l kj kk">gcloud config set project ${PROJECT}<br/>gcloud [[ create marvels]]<br/>gcloud [[ delete marvels]]<br/>gcloud project delete</span></pre><p id="1aa3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一切都好。</p><p id="174f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">问题是——如果像我一样——你会犯错误，有时你喜欢发号施令，而<code class="du jt ju jv jw b">gcloud [[ delete ]]</code>并没有指向你想要的东西。</p><p id="2a1e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">那么你不快乐。</p><p id="65b4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以，我用了一个最小的<code class="du jt ju jv jw b">gcloud config</code>。这是斯堪的纳维亚式的配置文件设计:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="87b0" class="kf kg hi jw b fi kh ki l kj kk">gcloud config list<br/>[core]<br/>account = dazwilkin@google.com</span></pre><p id="4cc9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不过这需要我非常明确地使用我的<code class="du jt ju jv jw b">gcloud</code>命令:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="250e" class="kf kg hi jw b fi kh ki l kj kk">gcloud container clusters create ... --project=${PROJECT} ...</span></pre><p id="89ce" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">或许更重要的是，对坏人非常明确:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="fd77" class="kf kg hi jw b fi kh ki l kj kk">gcloud container clusters delete ... --project=${PROJECT} ...</span></pre><p id="cbba" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">是的，我仍然可以通过<code class="du jt ju jv jw b">--project=${PROJECT}</code>获得点击快感，但是，这种方法进一步支持的一件事是，我维护了一个本地会话状态，因此，只要我不被多个shells冲昏头脑，我通常能够知道我正在操作哪些资源:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="878c" class="kf kg hi jw b fi kh ki l kj kk">PROJECT=[[TODAY's PROJECT]]<br/>REGION=[[ALWAYS-US-WEST1-COS-I'M-WEIRD-LIKE-THAT]]<br/>ZONE=${REGION}-c</span></pre><p id="2bd6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">感谢Preston第一次向我展示了这个技巧，你可以在例如<code class="du jt ju jv jw b">env.sh</code>中插入这种东西，然后，当你进入项目目录时，你可以不受惩罚地<code class="du jt ju jv jw b">source ./env.sh</code>。</p><p id="534d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以，是的，更多的打字，但更多的控制和信心。</p><p id="9b32" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你有一个模糊的<code class="du jt ju jv jw b">gcloud config list</code>，你可以<code class="du jt ju jv jw b">gcloud config unset [section]/[property]</code>或者，如果你有信心，直接编辑文件。很可能<code class="du jt ju jv jw b">~/.config/gcloud/configurations/config_default</code>所以也许:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="6ca0" class="kf kg hi jw b fi kh ki l kj kk">CONFIG="${HOME}/.config/gcloud/configurations/config_default"<br/>cp ${CONFIG} ${CONFIG}.$(date '+%y%m%d') &amp;&amp; \<br/>nano ${CONFIG}</span></pre><h2 id="aebd" class="kf kg hi bd km kn ko kp kq kr ks kt ku jg kv kw kx jk ky kz la jo lb lc ld le bi translated">库贝特尔</h2><p id="2ca0" class="pw-post-body-paragraph ix iy hi iz b ja lf ij jc jd lg im jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">直到你可以一般(！)使用<code class="du jt ju jv jw b">kubectl</code>获得类似的结果。</p><p id="4b4b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">需要注意的是，当您创建和删除集群时，<code class="du jt ju jv jw b">gcloud container clusters</code>会改变<code class="du jt ju jv jw b">kubectl</code>配置。这将重置您的默认集群。您可以通过以下方式取消设置默认集群:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="5e3e" class="kf kg hi jw b fi kh ki l kj kk">kubectl config unset current-context</span></pre><p id="41c8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后一切将打破良好；-)</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="5cb3" class="kf kg hi jw b fi kh ki l kj kk">kubectl get nodes<br/>The connection to the server localhost:8080 was refused - did you specify the right host or port?</span></pre><p id="b2db" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这在功能上等同于取消设置项目和区域等。在<code class="du jt ju jv jw b">gcloud</code>中。现在，我们可以在每次使用<code class="du jt ju jv jw b">kubectl</code>时显式引用一个上下文(以及一个集群)。例如:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="0478" class="kf kg hi jw b fi kh ki l kj kk">kubectl get nodes --context=[[YOUR-CONTEXT]]</span></pre><p id="17a4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是如何知道哪些上下文可用呢？</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="3375" class="kf kg hi jw b fi kh ki l kj kk">kubectl config get-contexts</span><span id="cddc" class="kf kg hi jw b fi kl ki l kj kk">kubectl config get-contexts<br/>CURRENT   NAME          CLUSTER        AUTHINFO    NAMESPACE<br/>          black         black-180612   dazwilkin   <br/>          white         white-180612   dazwilkin</span></pre><blockquote class="lk ll lm"><p id="78b8" class="ix iy ln iz b ja jb ij jc jd je im jf lo jh ji jj lp jl jm jn lq jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong>您的上下文和集群名称——特别是如果它们是由Kubernetes引擎唯一生成的——将<strong class="iz hj">不会</strong>这么漂亮。</p></blockquote><p id="93e4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不要害怕，因为我们可以:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="ebcb" class="kf kg hi jw b fi kh ki l kj kk">kubectl config rename-context white dev<br/>kubectl config get-context</span><span id="5697" class="kf kg hi jw b fi kl ki l kj kk">kubectl config get-contexts<br/>CURRENT   NAME          CLUSTER        AUTHINFO    NAMESPACE<br/>          black         black-180612   dazwilkin   <br/>          dev           white-180612   dazwilkin</span></pre><p id="d2b4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，当然，你可以:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="a912" class="kf kg hi jw b fi kh ki l kj kk">kubectl delete namespace/next-game --context=dev</span></pre><p id="4cff" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">那更让人放心，不是吗？</p><p id="d5be" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">是的，这需要更多的输入，但是—再一次—我们可以使用我们的shell环境来帮助我们:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="fa14" class="kf kg hi jw b fi kh ki l kj kk">CONTEXT=dev<br/>kubectl get pods --context=${CONTEXT}</span></pre><p id="eebc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我能拯救一个人一次那种删除错误信息的可怕、沮丧的感觉，我会很开心！</p><h2 id="39e7" class="kf kg hi bd km kn ko kp kq kr ks kt ku jg kv kw kx jk ky kz la jo lb lc ld le bi translated">更新180614:重命名|删除</h2><p id="cab0" class="pw-post-body-paragraph ix iy hi iz b ja lf ij jc jd lg im jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">我一直迂腐地(通常只是完全删除，但通常只是)编辑<code class="du jt ju jv jw b">~/.kube/config</code>以保持整洁。有一种更简单的方法(使用kubectl自动完成更好，见下文)。</p><p id="abc2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设您有一堆Kubernetes引擎生成的独特但冗长的上下文:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="0075" class="kf kg hi jw b fi kh ki l kj kk">kubectl config get-contexts<br/>CURRENT   NAME                                     CLUSTER ...<br/>          gke_[[PROJECT]]_[[REGION]]_[[NAME]]      ...<br/>          gke_[[PROJECT]]_[[REGION]]_[[NAME]]      ...<br/>          gke_[[PROJECT]]_[[REGION]]_[[NAME]]      ...</span></pre><p id="ca93" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以简单地:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="b5a6" class="kf kg hi jw b fi kh ki l kj kk">kubectl config rename-context gke_... [[ALIAS]]</span></pre><p id="12f8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">而且，如果你已经启用了自动补全，你可以简单地在<code class="du jt ju jv jw b">ku</code>之后开始按TAB键获取<code class="du jt ju jv jw b">kubectl</code>，在<code class="du jt ju jv jw b">conf</code>之后获取<code class="du jt ju jv jw b">kubectl config</code>，在<code class="du jt ju jv jw b">gke_</code>之后开始枚举以<code class="du jt ju jv jw b">gke</code>为前缀的上下文。一旦选择了所需的上下文，就可以将其重命名为更有用的别名。</p><blockquote class="lk ll lm"><p id="daa3" class="ix iy ln iz b ja jb ij jc jd je im jf lo jh ji jj lp jl jm jn lq jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong> Kubernetes引擎对上下文、集群和authinfo(通常是重复的)部分使用相同的名称。</p></blockquote><p id="923b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">类似地，如果枚举你的上下文，列出孤儿，你可以用<code class="du jt ju jv jw b">kubectl delete-context</code>整理它们。当然，注意这样做，不要删除重要的上下文。在许多情况下，您可以通过重新运行<code class="du jt ju jv jw b">gcloud container clusters get-credentials ...</code>来恢复Kubernetes引擎上下文。</p><h2 id="b309" class="kf kg hi bd km kn ko kp kq kr ks kt ku jg kv kw kx jk ky kz la jo lb lc ld le bi translated">启用自动完成</h2><p id="74d2" class="pw-post-body-paragraph ix iy hi iz b ja lf ij jc jd lg im jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">这太好了:</p><p id="fe30" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae lr" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#enabling-shell-autocompletion" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/tasks/tools/install-kubectl/# enabling-shell-autocompletion</a></p></div></div>    
</body>
</html>