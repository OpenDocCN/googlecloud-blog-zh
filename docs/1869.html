<html>
<head>
<title>gRPC on Cloud Run</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云运行上的gRPC</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/grpc-on-cloud-run-743ed586d4ad?source=collection_archive---------1-----------------------#2021-05-04">https://medium.com/google-cloud/grpc-on-cloud-run-743ed586d4ad?source=collection_archive---------1-----------------------#2021-05-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/afe0883521bf1d8f78d238bd2759b9a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HbJzC05ublu_-VKXHFTDxQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">gRPC +云运行</figcaption></figure><p id="f90a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">gRPC是一个现代的、开源的、高性能的远程过程调用(RPC)框架，可以在任何环境中运行。它允许您直接调用客户端应用程序，就像它是一个本地服务一样。您还可以在服务之间高效地传输数据。此外，Google APIs通过gRPC支持请求，允许您构建高效、高吞吐量的系统。</p><p id="e3e7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在这篇博文中，我们将介绍gRPC协议以及如何在云运行中使用它们！</p><h2 id="4267" class="js jt hi bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">了解gRPC</h2><p id="b96c" class="pw-post-body-paragraph iu iv hi iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">gRPC客户端和服务器可以在各种环境中运行并相互对话——从Google内部的服务器到您自己的桌面——并且可以用gRPC支持的任何语言编写。例如，您可以轻松地用Java创建gRPC服务器，用Go、Python或Ruby创建客户机。</p><p id="bb16" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这是一张图片:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ks"><img src="../Images/c9071ea889c7de08abb0ef9255f1455c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZfPP10Wnfe8OEKqpbn96xA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">一个C++ gRPC服务器与一个Ruby和Android客户端对话。</figcaption></figure><p id="6693" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">默认情况下，gRPC使用<a class="ae kx" href="https://developers.google.com/protocol-buffers" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hj">协议缓冲区</strong> </a>进行数据序列化。使用协议缓冲区的第一步是为我们要在<code class="du kz la lb lc b">.proto</code>文件中发送的数据定义<em class="ky">结构</em>，消息包括如下字段:</p><pre class="kt ku kv kw fd ld lc le lf aw lg bi"><span id="5d16" class="js jt hi lc b fi lh li l lj lk">// A Person message.<br/>// Numbers are used to <em class="ky">identify</em> fields in the binary encoded data.<strong class="lc hj"><br/>message</strong> <strong class="lc hj">Person</strong> {<br/>  <strong class="lc hj">string</strong> name = 1;<br/>  <strong class="lc hj">int32</strong> id = 2;<br/>  <strong class="lc hj">bool</strong> likes_dogecoin = 3;<br/>}</span></pre><p id="e667" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><code class="du kz la lb lc b">protoc</code>工具可以基于这个<code class="du kz la lb lc b">proto</code>文件生成语言定义。</p><blockquote class="ll lm ln"><p id="b80c" class="iu iv ky iw b ix iy iz ja jb jc jd je lo jg jh ji lp jk jl jm lq jo jp jq jr hb bi translated">注:<code class="du kz la lb lc b">protoc</code>可以用<code class="du kz la lb lc b">brew install protobuf</code>和<a class="ae kx" href="https://grpc.io/docs/protoc-installation/" rel="noopener ugc nofollow" target="_blank">其他方式</a>安装。</p></blockquote><h2 id="4521" class="js jt hi bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">示例应用程序:计算器</h2><p id="c2ee" class="pw-post-body-paragraph iu iv hi iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">让我们构建一个示例应用程序——一个通过gRPC接受计算请求的计算器。首先，让我们看看<code class="du kz la lb lc b">calculator.proto</code>的定义:</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="lr ls l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">包含消息和服务的样本原型文件。</figcaption></figure><p id="e12a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">原型文件从一些定义和服务RPC接口开始。与普通的函数调用一样，<code class="du kz la lb lc b">Calculate</code> rpc接受两个浮点数和<code class="du kz la lb lc b">ADD</code>或<code class="du kz la lb lc b">SUBTRACT</code>的操作。该服务期待一个<code class="du kz la lb lc b">BinaryOperation</code>消息并返回一个<code class="du kz la lb lc b">CalculationResult</code>消息。</p><p id="59a5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后，我们可以编写一个这样的节点服务来侦听gRPC请求(不是HTTP请求):</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="lr ls l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">带有计算器服务的gRPC服务器。</figcaption></figure><blockquote class="ll lm ln"><p id="d3af" class="iu iv ky iw b ix iy iz ja jb jc jd je lo jg jh ji lp jk jl jm lq jo jp jq jr hb bi translated">注意，我们在这里使用了<code class="du kz la lb lc b">createInsecure</code>方法。Cloud Run的代理为我们提供了一个TLS加密的代理，为我们处理设置证书的麻烦事。从代理到装有gRPC服务器的容器的流量通过一个加密的隧道，所以我们不需要担心自己处理它。Cloud Run原生处理HTTP/2，所以gRPC的传输得到了很好的支持。</p></blockquote><p id="c5f7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">当您使用<code class="du kz la lb lc b">server.addService</code>时，您正在向服务器添加<em class="ky"> proto </em>服务，这将调用<code class="du kz la lb lc b">calculate</code>函数:</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="lr ls l"/></div></figure><blockquote class="ll lm ln"><p id="f534" class="iu iv ky iw b ix iy iz ja jb jc jd je lo jg jh ji lp jk jl jm lq jo jp jq jr hb bi translated">完整代码在<a class="ae kx" href="https://github.com/grpc-ecosystem/grpc-cloud-run-example/tree/master/node" rel="noopener ugc nofollow" target="_blank">https://github . com/grpc-ecosystem/grpc-cloud-run-example/tree/master/node</a></p></blockquote><h2 id="595e" class="js jt hi bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">部署到云运行</h2><p id="521e" class="pw-post-body-paragraph iu iv hi iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr hb bi translated">让我们将这个服务部署到Cloud Run。如果没有Dockerfile，源代码将使用<a class="ae kx" href="https://github.com/GoogleCloudPlatform/buildpacks" rel="noopener ugc nofollow" target="_blank"> Google Cloud Buildpacks </a>，它将自动检测我们的语言(因为<code class="du kz la lb lc b">package.json</code>而成为节点)并构建我们的容器。</p><p id="626f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用Cloud Run的一个好处是它支持gRPC开箱即用，部署时不需要额外的标志。</p><blockquote class="ll lm ln"><p id="eaa3" class="iu iv ky iw b ix iy iz ja jb jc jd je lo jg jh ji lp jk jl jm lq jo jp jq jr hb bi translated">注意:如果你想用HTTP/2流gRPCs，添加标志<code class="du kz la lb lc b">--use-http2</code> <a class="ae kx" href="https://cloud.google.com/run/docs/configuring/http2" rel="noopener ugc nofollow" target="_blank">🔗</a>。</p></blockquote><p id="b9f0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用<code class="du kz la lb lc b">—-source</code>标志部署云跑应用程序:</p><pre class="kt ku kv kw fd ld lc le lf aw lg bi"><span id="9e48" class="js jt hi lc b fi lh li l lj lk">gcloud beta run deploy --source .</span></pre><p id="5871" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为了测试服务，我们可以首先获得运行端点，然后使用<code class="du kz la lb lc b"><a class="ae kx" href="https://github.com/fullstorydev/grpcurl" rel="noopener ugc nofollow" target="_blank">grpcurl</a></code>，一个类似cURL的工具，但是对于gRPC:</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="lr ls l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">一个用于云运行测试的便捷脚本</figcaption></figure><p id="7a5a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">嘣。现在你有了一个自动缩放计算器gRPC服务！</p></div><div class="ab cl lt lu gp lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="hb hc hd he hf"><p id="0844" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们做到了！如果您想了解更多信息，请查看以下链接:</p><ul class=""><li id="c003" class="ma mb hi iw b ix iy jb jc jf mc jj md jn me jr mf mg mh mi bi translated">🐙<a class="ae kx" href="https://github.com/grpc-ecosystem/grpc-cloud-run-example" rel="noopener ugc nofollow" target="_blank">https://github.com/grpc-ecosystem/grpc-cloud-run-example</a></li><li id="f473" class="ma mb hi iw b ix mj jb mk jf ml jj mm jn mn jr mf mg mh mi bi translated">📄<a class="ae kx" href="https://cloud.google.com/run/docs/triggering/grpc" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/run/docs/triggering/grpc</a></li></ul></div></div>    
</body>
</html>