<html>
<head>
<title>Secure Google Cloud SQL Instances using Private IP: Gotchas &amp; troubleshooting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用私有IP保护Google Cloud SQL实例:疑难解答</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/secure-google-cloud-sql-instances-using-private-ip-gotchas-troubleshooting-f7cf6dfe1bbb?source=collection_archive---------0-----------------------#2022-02-14">https://medium.com/google-cloud/secure-google-cloud-sql-instances-using-private-ip-gotchas-troubleshooting-f7cf6dfe1bbb?source=collection_archive---------0-----------------------#2022-02-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><pre class="if ig ih ii fd ij ik il im aw in bi"><span id="4ba6" class="io ip hi ik b fi iq ir l is it"><strong class="ik hj">Disclaimer:</strong> <em class="iu">Views, thoughts, and opinions expressed in the blog belong solely to the author, and not necessarily to the author’s employer, organisation, committee or other group or individual.</em></span></pre><p id="b59e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae jt" href="https://cloud.google.com/sql/" rel="noopener ugc nofollow" target="_blank">云SQL </a>是Google Cloud针对MySQL、PostgreSQL和SQL Server的全托管关系数据库服务。如果您计划使用私有IP部署云SQL实例和/或打算了解更多关于使用私有IP配置云SQL实例的注意事项，那么这篇博客是为您准备的。关于在云SQL服务上配置私有IP的<a class="ae jt" href="https://cloud.google.com/sql/docs/sqlserver/configure-private-ip" rel="noopener ugc nofollow" target="_blank">官方文档</a>准确地涵盖了大多数方面，然而这篇博客解释了在计划使用私有IP在一个或多个区域部署云SQL实例时必须考虑的不同场景。此博客还有助于构建网络设计的前瞻性方法，这是任何工作负载的关键基础。</p><p id="4033" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">范围:</strong>blog的范围适用于所有风格的云SQL，如MySQL、PostgreSQL和SQL server，因为所有引擎的行为都独立于底层网络。虽然本博客提供了Cloud SQL MySQL的工件，但是您可以使用Cloud SQL PostgreSQL和SQL server的概念和场景。</p><p id="42dc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">先决条件:</strong>作为这篇博客的先决条件，你应该了解云SQL服务和<a class="ae jt" href="https://cloud.google.com/vpc" rel="noopener ugc nofollow" target="_blank">虚拟私有云(VPC) </a>如何在谷歌云平台(GCP)上工作。如果您没有GCP访问权限，请从这里开始<a class="ae jt" href="https://cloud.google.com/gcp/getting-started" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="657b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">假设:</strong>以下是本博客考虑的假设。</p><ol class=""><li id="d7bf" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated">目的是在孟买地区部署具有HA(高可用性)配置的云SQL MySQL实例，并在德里地区部署跨地区读取副本。</li><li id="0eb2" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated">主实例可能需要也可能不需要读取复制副本或跨区域复制副本实例。</li><li id="9532" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated">假设网络配置只有专用IP，不应该使用互联网进行通信。如果您已经熟悉VPC配置部分，请随意忽略它。</li></ol><h1 id="a140" class="ki ip hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated"><strong class="ak">关于概念思维的简短说明</strong></h1><p id="cde9" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">GCP在谷歌提供的VPC及其各自的子网中管理云SQL服务。客户VPC和谷歌管理的VPC是两个不同的组成部分，当谈到利用托管服务，如GCP上的云SQL。谷歌在VPC启动并管理云SQL实例，被称为服务提供商VPC或子网。当客户创建云SQL实例时，Google托管的VPC及其各自的子网IP范围配置应该已经就绪。如果没有此云，SQL创建操作将失败，并出现错误“<strong class="ix hj">无法创建子网。在分配的IP范围内找不到空闲块。请为此服务提供商分配新的范围。求助令牌:… </strong>"</p><p id="aa0f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">根据这个先决条件VPC和子网配置，创建活动将继承云SQL DB实例的IP地址。这种配置应该作为每个地区的云SQL的每种类型的DB引擎(MySQL、PostgreSQL、SQL Server)的先决条件来完成。这被称为每个所需区域中相应云SQL DB引擎的私有服务访问(PSA)配置。例如，如果计划在孟买和德里地区为MySQL和PostgreSQL部署云SQL实例，则需要4个PSA配置。孟买和德里地区的MySQL和PostgreSQL各一个。PSA配置就绪后，GCP将自动在客户和服务提供商VPC子网之间建立VPC对等。在您创建云SQL实例之前，我们需要确保PSA已经建立。我们将在随后的部分中逐步完成创建PSA的步骤。这些概念在<a class="ae jt" href="https://cloud.google.com/sql/docs/sqlserver/configure-private-services-access" rel="noopener ugc nofollow" target="_blank">官方文档</a>中有很好的解释，所以在此排除那些内容。我强烈建议在继续之前阅读这些文档。</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lk"><img src="../Images/a4f6b1d685d5a2c63a28d236fe5265a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JkkPj8K6z9nRjcwR-j0GwQ.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">起搏分析仪配置</figcaption></figure><p id="7b48" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">根据这些概念和前提条件，在相应的区域和VPC必须有至少“/24”CIDR范围大小的自由CIDR IP范围。在撰写这篇博客时，根据文档，“/24”CIDR范围大小只能容纳不超过50个云SQL实例。请参考<a class="ae jt" href="https://cloud.google.com/sql/docs/sqlserver/private-ip#allocated_range_size" rel="noopener ugc nofollow" target="_blank">此处的</a>了解更多关于IP CIDR块大小和每个块支持的最大实例数量的详细信息。请注意，如果您要提供IP CIDR范围，请确保它不会与当前使用的VPC中的任何其他范围重叠，不会跨越其所有子网。本博客将在后续章节中更详细地解释这一场景。</p><p id="11bc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在让我们用VPC配置来构建基础。我们将按顺序做以下事情，以确保我们有适当的基础来重现场景:</p><ol class=""><li id="72a7" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated">我不使用“默认”VPC，因为大多数组织不使用它，作为一种最佳实践。</li><li id="8df9" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated">在Mumbai地区创建VPC，并为其分配一个子网，我们计划在这个子网中部署数据库实例。稍后，当我们再次讨论这些场景时，让我们创建其他子网。</li><li id="100c" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated">我们还将确保从数据库实例到客户端虚拟机的所有连接都保持私有，仅使用私有IP地址，我们将从客户端虚拟机测试到数据库的连接。因此，我们还将安装NAT(在各自的区域安装路由器)连接到我们的VPC，这样我们就可以安装MySQL客户端。只有这部分是外部的，但通过设计保持安全。</li></ol><p id="8837" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是这个博客中使用的VPC配置。</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lw"><img src="../Images/1ba3230f9c5dbd37e41ad4d57fb4e094.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EYKpUGEtt82gEnFz"/></div></div></figure><p id="d49e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">确保根据您的要求设置防火墙规则，并为每个区域创建NAT和路由器，以便私有虚拟机能够从外部网络下载所需的补丁或软件包。</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lx"><img src="../Images/d21ffb055005804bf7f667b4b635de1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Dkb_uPE2OufHTtSG"/></div></div></figure><figure class="if ig ih ii fd ll er es paragraph-image"><div class="er es ly"><img src="../Images/804a8c34503d71c8d2cb388974f733de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/0*l7ZG1F5811-YZA5E"/></div></figure><p id="9bfa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">既然网络基础已经准备好，让我们逐一演练每个场景:</p><ol class=""><li id="7c9b" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated">在孟买地区使用一个CIDR IP范围为“/24”大小的PSA(私有服务访问)创建云SQL MySQL实例。</li><li id="bcd6" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated">使用现有IP范围为PostgreSQL和SQL server创建带有专用IP配置的云SQL实例，然后修复它。</li><li id="fd29" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated">在没有或耗尽了PSA IP CIDR范围的区域中创建云SQL实例。</li><li id="131e" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated">当我们在与主服务器相同的区域中创建云SQL读取副本时的考虑事项。</li><li id="b24b" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated">创建跨区域读取副本时的注意事项。</li></ol><h1 id="f785" class="ki ip hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated"><strong class="ak">使用私有IP配置和创建云SQL MySQL实例</strong></h1><p id="b5af" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">让我们在孟买地区创建一个云SQL MySQL实例，在这里我们已经在VPC下定义了一个子网。由于我们不想在云SQL实例中使用公共IP，我们应该使用<a class="ae jt" href="https://cloud.google.com/sql/docs/sqlserver/private-ip#allocated_ip_address_ranges" rel="noopener ugc nofollow" target="_blank"> PSA配置</a>来定义其私有IP范围。一旦在使用预先存在的PSA配置创建云SQL实例期间分配了私有IP，为云SQL实例分配的IP就变成静态的。文档显示，使用一个“/24”大小的CIDR范围创建的PSA可以安全地容纳50个云SQL MySQL实例。对于SQL server和PostgreSQL实例，创建单独的PSA配置或IP范围。每个地区的每个DB引擎都需要单独的IP范围。50个实例的上限是安全的，因为每个实例都为HA、维护等配置保留了多个私有IP。</p><p id="5f28" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">从起搏分析仪配置开始</strong></p><p id="899a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">进入VPC控制台，选择VPC并打开“<em class="iu">私人服务连接</em>选项卡。在子选项卡“为服务分配的IP范围”下，单击“分配IP范围”并给出如下所示的IP范围。您可以选择自定义选项来指定您定义的范围，但为简单起见，自动选项用于CIDR范围块大小为24。</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lz"><img src="../Images/ffe5e97a25fe987764b271ae89ef3fb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xtytDnDdl0Mo8sTw"/></div></div></figure><p id="f322" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，IP范围被命名为“psa-ip-reserved-for-cloud-sql”只是为了给出一个有意义的名称。请忽略“描述”。同样，您可以定义适合您的组织的命名约定。点击“分配”后，请查看以下回答:</p><figure class="if ig ih ii fd ll er es paragraph-image"><div class="er es ma"><img src="../Images/2908015ba38c4380fbc1e325440de7fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/0*8SUKqwLOQ1lMR1Lq"/></div></figure><p id="bf12" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">通过此操作，GCP创建了一个具有指定IP范围的VPC子网，现在是时候使用VPC对等连接Google定义的VPC和客户(您的)定义的VPC了。当在下一个选项卡中创建连接时，这将在后台自动完成。</p><p id="ef78" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在您连接之前，请检查我们有多少VPC对等网络，如下所示，目前一个也没有:</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mb"><img src="../Images/649a2f32b1ba288aa0d1dcc59656b38e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NE3TMiFDiSjnywfL"/></div></div></figure><p id="a92e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要在服务提供商和客户VPC之间创建专用连接，请转到“<strong class="ix hj"> <em class="iu">专用服务连接</em> </strong>”选项卡，然后转到子选项卡“<strong class="ix hj"> <em class="iu">专用服务连接</em> </strong>”，并选择下面VPC控制台中的“<strong class="ix hj"> <em class="iu">创建连接</em> </strong>”。</p><figure class="if ig ih ii fd ll er es paragraph-image"><div class="er es mc"><img src="../Images/44cabfe329b47aa5b3bfa52ffaa8fcf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/0*kQdhCl6o-GOhwMq0"/></div></figure><p id="7611" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">选择上一步创建的IP范围，点击“<strong class="ix hj">连接</strong></p><figure class="if ig ih ii fd ll er es paragraph-image"><div class="er es md"><img src="../Images/6c2b8ff0bd6469049773a9226537d2c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:778/0*foZms0-qUW7HrUo9"/></div></figure><p id="47e6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建后，用连接名验证“<strong class="ix hj"> <em class="iu">分配的分配</em> </strong>”名称。</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es me"><img src="../Images/b3e9883ec856d5d93f66dca898894757.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PGCKFU2pJ5Ih2mC0"/></div></div></figure><p id="24a6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意分配的IP范围为“10.177.255.0/24”，因此在创建实例时，任何后续的云SQL实例都将被分配一个此范围内的私有IP。创建连接后，将出现VPC对等，这是作为连接创建的一部分创建的，请参见VPC对等控制台上的以下屏幕截图:</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mf"><img src="../Images/fb1b75365540f8b73067a9fe93d39272.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YmOtI5ouqtUECQZo"/></div></div></figure><p id="6330" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建云SQL MySQL实例，并在连接配置中选择私有IP，如下所示。选择孟买作为地区。</p><figure class="if ig ih ii fd ll er es paragraph-image"><div class="er es mg"><img src="../Images/8b990458f992bba3f70dcfa9192df651.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/0*axMS15Y3Llu2ghSB"/></div></figure><p id="ff0c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在“<strong class="ix hj"> <em class="iu">自定义实例</em> </strong>”部分下，取消选中“<strong class="ix hj"> <em class="iu">公共IP </em> </strong>”，选择“<strong class="ix hj"> <em class="iu">私有IP </em> </strong>”，从网络下拉列表中选择VPC名称“<em class="iu"> db-vpc </em>，从“<em class="iu">分配的IP范围</em>中选择PSA范围选项</p><figure class="if ig ih ii fd ll er es paragraph-image"><div class="er es mh"><img src="../Images/53000ce804fa7cc9358f19c717538ad6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/0*szd3BoI7JKvIgEOk"/></div></figure><p id="9400" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">单击创建实例开始创建数据库实例。</p><p id="a6f1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">同时，云SQL MySQL实例正在创建过程中，让我们快速检查一下，如果我尝试在与私有IP配置相同的CIDR范围内为SQL server和PostgreSQL创建云SQL会怎样。让我们这样做，我得到了下面的错误，并看到控制台与MySQL实例上分配的IP地址和SQL Server和PostgreSQL上的错误标记。请验证孟买地区的云SQL MySQL实例私有IP，如果它从现有范围获取相同的IP，并且下面的截图确认了这一点。</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mi"><img src="../Images/16d423037cf035d4b711961ebc4d0d03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oveVriYEQCo2DdGJ"/></div></div></figure><p id="c44c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请检查以下导致PostgreSQL和SQL server实例创建失败的错误:</p><pre class="if ig ih ii fd ij ik il im aw in bi"><span id="146b" class="io ip hi ik b fi iq ir l is it"><strong class="ik hj">Failed to create subnetwork. Couldn’t find free blocks in allocated IP ranges. <em class="iu">Please allocate new ranges for this service provider. Help Token......</em></strong></span></pre><p id="a893" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">修复错误</strong> —要修复此错误，请按照我们之前为MySQL实例创建的相同过程，为孟买地区的每个数据库引擎创建单独的IP范围。最后，我们应该会看到VPC专用服务连接配置中的数据库引擎各有3个条目，如下所示，其中我使用有意义的命名约定创建了另外2个IP范围，表示一个用于PostgreSQL，另一个用于SQL Server。验证IP范围，并在列中看到这些范围仍然不是VPC对等的一部分:</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mj"><img src="../Images/9fea6c2d0fc18355cf0d4b835ecaadfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*W0J9Trj0pklzKbIg"/></div></div></figure><p id="2ce2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要添加上述两个新的IP CIDR范围作为PCA配置和VPC对等的一部分，请转到“服务的专用连接”选项卡，并单击“<em class="iu">服务联网-googleapis-com </em>”上的链接，更新如下所示的新IP范围，然后单击更新。</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mk"><img src="../Images/e67ad711ce74527f2c51f8b7424afe46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*82rFda80LmUyP2Fq"/></div></div></figure><p id="e0f4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此步骤将为现有的PCA分配新的IP范围，作为服务网络的一部分验证IP范围，如下所示:</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ml"><img src="../Images/cbcf90c6ff9cedb03a6ed6af34f6ccd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rkvsTFyKCnHjJSQZ"/></div></div></figure><p id="8583" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">另外，在“为服务分配的IP范围”选项卡中验证，如下所示:</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mm"><img src="../Images/d2eef2b81a4482e2ff58f7666dbee297.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nXf6zfk5KfcGwcTr"/></div></div></figure><p id="d586" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，通过创建第一个云SQL PostgreSQL来验证这些配置，在随后的屏幕截图中选择下面的配置，然后是云SQL SQL Server:</p><figure class="if ig ih ii fd ll er es paragraph-image"><div class="er es mg"><img src="../Images/2de3cdd36698cabc6b073d5b65c908b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/0*oVyyBo25qYzmGEZw"/></div></figure><p id="7a78" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于云SQL SQLserver</p><figure class="if ig ih ii fd ll er es paragraph-image"><div class="er es mn"><img src="../Images/3695aec3317af0012a34ab6ecc385a42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/0*GWtx9Q7zmKYpHOqI"/></div></figure><p id="c3c8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">数据库实例创建完成后，根据我们在创建这些实例时分配IP的方式来验证分配的私有IP。</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mo"><img src="../Images/c2aad4fc3a00f09efec6eee24117a1d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Zjvk7XCEZgRQ37xZ"/></div></div></figure><p id="9911" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">如果现有PSA私有IP CIDR范围达到it极限，如何处理？</strong></p><p id="e359" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果现有的PSA私有IP CIDR范围达到其极限，那么在相应的区域使用额外的私有IP CIDR范围创建数据库实例，在我们的例子中，该区域是孟买。下面我们来看看如何添加额外的私有IP范围。与添加新IP范围和更新服务网络之前的步骤相似，如下面“私有服务连接”选项卡中VPC的屏幕截图所示:</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mp"><img src="../Images/d8cc1b4de219683c305dbc6790a2d60c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-c3zFiLnyH_py154"/></div></div></figure><p id="0704" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后将此IP范围添加到现有服务网络，如下所示:</p><figure class="if ig ih ii fd ll er es paragraph-image"><div class="er es mq"><img src="../Images/d3790642da3ca4bd3ffff34f633b56f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/0*Ir8sdcHmikPEN8h6"/></div></figure><p id="622d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更新后，这将出现在部分服务网络中:</p><p id="2023" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">也在分配的IP范围选项卡中验证，如下所示:</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mr"><img src="../Images/7d9a6f680800f4ccbd67af3651350433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8Dg_-c6htyTQ6v6j"/></div></div></figure><p id="3f4f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果在现有服务网络中添加或删除IP范围时出现错误，请使用“强制”选项，了解更多信息<a class="ae jt" href="https://cloud.google.com/sql/docs/troubleshooting#creating-instances" rel="noopener ugc nofollow" target="_blank">或从命令行使用强制选项来删除或添加IP范围。</a></p><pre class="if ig ih ii fd ij ik il im aw in bi"><span id="4e5b" class="io ip hi ik b fi iq ir l is it">gcloud services vpc-peerings update \<br/>service=servicenetworking.googleapis.com \<br/>-ranges=OLD_RESERVED_RANGE_NAME,NEW_RESERVED_RANGE_NAME \<br/>-network=VPC_NETWORK \<br/>-project=PROJECT_ID \<br/>-force</span></pre><p id="f01b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，通过在孟买地区使用以下网络连接选项创建一个云SQL MySQL DB实例来测试上述配置:</p><figure class="if ig ih ii fd ll er es paragraph-image"><div class="er es ms"><img src="../Images/7a11f273b565838361db49a55b603511.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/0*DOlQEe1_O5UMcqXN"/></div></figure><p id="1f10" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在下面创建的数据库实例列表的屏幕截图中验证分配的IP:</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mt"><img src="../Images/6852b91373092edaddd4f35f99a52cef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uUNsBm1ylD-wBFi2"/></div></div></figure><p id="444f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">还有几个故障排除场景，您应该记住:</p><ol class=""><li id="11aa" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated">如果区域与主实例相同，读取复制副本将从主实例继承专用IP。<strong class="ix hj">从起搏分析仪配置的角度来看，这种情况不需要采取任何措施。</strong></li><li id="c5c3" class="ju jv hi ix b iy kd jc ke jg kf jk kg jo kh js jz ka kb kc bi translated">当您添加跨区域复制副本时，请确保读取复制副本区域应该具有配置有空专用IP范围的专用服务访问(PSA ),或者预定区域应该已经具有带有专用IP的相同类型的数据库实例，并且在IP CIDR范围内有额外的空间。例如，如下面的屏幕截图所示，我已经添加了一个IP范围，我将在德里地区创建一个跨地区副本，因此它已经为其选择了新分配的IP。</li></ol><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mu"><img src="../Images/b3150e669071414d325e5377cecea2b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FafekCeq8y7zVjGa"/></div></div></figure><p id="43c3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">跨区域读取复制副本创建如下，IP从新创建的PSA IP CIDR范围分配:</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mv"><img src="../Images/3a1bb8f07cdd71298002b5c662ef844d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6hfCdoNG2SJY_o_f"/></div></div></figure><p id="638d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.您可能会遇到错误“<em class="iu">无法创建子网。在分配的IP范围内找不到空闲块。请为此服务提供商分配新的范围。</em>"创建数据库实例时，在以下任何情况下:</p><pre class="if ig ih ii fd ij ik il im aw in bi"><span id="4f27" class="io ip hi ik b fi iq ir l is it">a) On Private IP option only, creating DB instance or cross region read replica in a region without PSA configuration.</span><span id="185f" class="io ip hi ik b fi mw ir l is it">b) Private Service Connect IP range is exhausted or if its IP range overlapped with another existing part of the VPC network, check you may have one or more subnets with overlapped IP range.</span></pre><h1 id="2b3f" class="ki ip hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated"><strong class="ak">小窍门</strong></h1><p id="69dd" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">接下来，以下是你可以有效跟踪它的方法。</p><ol class=""><li id="00cb" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated">使用下面的<em class="iu"> gcloud </em>命令列出每个区域的对等路由:</li></ol><pre class="if ig ih ii fd ij ik il im aw in bi"><span id="4914" class="io ip hi ik b fi iq ir l is it"><strong class="ik hj">gcloud compute networks peerings list-routes servicenetworking-googleapis-com — network=db-vpc — region=asia-south1 — direction=INCOMING</strong></span></pre><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mx"><img src="../Images/ed5088fc71ac9fc2691731de37b8f4c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*73wna-yOZe3zMkDs"/></div></div></figure><p id="ac01" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.您还可以使用<a class="ae jt" href="https://cloud.google.com/asset-inventory/docs/overview" rel="noopener ugc nofollow" target="_blank">云库存API或控制台</a>使用IAM控制台跟踪相同的内容，并选择“资产库存”。</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es my"><img src="../Images/04efa081b32c0e186a71cc5e0bc95758.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*244gvsfCET3oElD3"/></div></div></figure><p id="5860" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后选择其中一个IP范围来查看它的详细元数据。参考<a class="ae jt" rel="noopener" href="/google-cloud/using-gcp-cloud-asset-inventory-export-to-keep-track-of-your-gcp-resources-over-time-20fb6fa63c68">这篇</a>博客，了解如何创建数据管道来做更多的事情。</p><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es mz"><img src="../Images/95b5aecc736f27d8a2088211c4a1ad7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*y1W8tafGnoFPFprB"/></div></div></figure><p id="3cde" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.使用下面的<em class="iu"> gcloud </em>命令列出用于PSA配置的IP范围:</p><pre class="if ig ih ii fd ij ik il im aw in bi"><span id="5f6b" class="io ip hi ik b fi iq ir l is it"><strong class="ik hj">gcloud compute addresses list — global — filter=”purpose=VPC_PEERING”</strong></span></pre><figure class="if ig ih ii fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es na"><img src="../Images/0c1dc1ce078af7c6be16ea6081ec2951.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Z4v4sqEvkIW0EVG2"/></div></div></figure><p id="b278" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">成本考虑:</strong>如果您不使用Google Cloud <a class="ae jt" href="https://cloud.google.com/free" rel="noopener ugc nofollow" target="_blank">免费层</a>或者您的使用超出了免费层，您将产生启动云SQL实例、NAT路由器和网络出口费用的成本，请使用<a class="ae jt" href="https://cloud.google.com/products/calculator" rel="noopener ugc nofollow" target="_blank"> GCP定价计算器</a>进行估算。</p><p id="4567" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">行动要求:</strong>尝试这些场景以了解私有服务访问行为，在使用私有IP启动或规划生产云SQL实例之前，必须了解这些行为。参考GCP社区指南第<a class="ae jt" href="https://cloud.google.com/support/docs/community" rel="noopener ugc nofollow" target="_blank">页</a>获得更多帮助。</p><p id="b2dc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">干杯！！</strong></p></div></div>    
</body>
</html>