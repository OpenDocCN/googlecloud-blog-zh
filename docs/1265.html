<html>
<head>
<title>Serverless Deployment on Cloud Run using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform在云上运行无服务器部署</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/deploying-docker-images-to-cloud-run-using-terraform-ee8ae4ecb72e?source=collection_archive---------0-----------------------#2020-01-23">https://medium.com/google-cloud/deploying-docker-images-to-cloud-run-using-terraform-ee8ae4ecb72e?source=collection_archive---------0-----------------------#2020-01-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/4adeed60ce4aaa19bce58db41f5ea101.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RMCKkdd6bbPT5LctVVv5dw.png"/></div></div></figure><blockquote class="iq"><p id="9336" class="ir is hi bd it iu iv iw ix iy iz ja dx translated">在本文中，我们将把一个无服务器的Flask web应用程序部署到Cloud Run，方法是将它的<a class="ae jb" href="https://github.com/Timtech4u/ghost3-docker" rel="noopener ugc nofollow" target="_blank"> Docker映像</a>构建到Container Registry中，并使用Terraform将我们的部署配置为代码。</p></blockquote><blockquote class="jc jd je"><p id="66e3" class="jf jg jh ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc ja hb bi translated"><a class="ae jb" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>是一个基础设施代码工具，用于跨各种云提供商安全高效地构建、更改和版本控制基础设施。</p><p id="5acc" class="jf jg jh ji b jj kd jl jm jn ke jp jq jr kf jt ju jv kg jx jy jz kh kb kc ja hb bi translated"><a class="ae jb" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank"> Cloud Run </a>是一个托管计算平台，使您能够运行可自动扩展的无状态无服务器容器。</p><p id="4748" class="jf jg jh ji b jj kd jl jm jn ke jp jq jr kf jt ju jv kg jx jy jz kh kb kc ja hb bi translated"><a class="ae jb" href="https://cloud.google.com/container-registry" rel="noopener ugc nofollow" target="_blank">容器注册中心</a>是一个私有的容器映像注册中心，运行在Google Cloud上。</p><p id="18e0" class="jf jg jh ji b jj kd jl jm jn ke jp jq jr kf jt ju jv kg jx jy jz kh kb kc ja hb bi translated"><a class="ae jb" href="https://github.com/pallets/flask" rel="noopener ugc nofollow" target="_blank"> Flask </a>是一个用Python编写的微型web框架。</p></blockquote><h1 id="5a14" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">先决条件</h1><ul class=""><li id="a12b" class="lg lh hi ji b jj li jn lj lk ll lm ln lo lp ja lq lr ls lt bi translated">创建一个<a class="ae jb" href="https://console.cloud.google.com/project" rel="noopener ugc nofollow" target="_blank">谷歌云平台(GCP)项目</a>，或者使用一个现有的项目。</li><li id="ee2f" class="lg lh hi ji b jj lu jn lv lk lw lm lx lo ly ja lq lr ls lt bi translated">设置<a class="ae jb" href="https://cloud.google.com/sdk/" rel="noopener ugc nofollow" target="_blank">云SDK </a>，或者使用<a class="ae jb" href="https://cloud.google.com/shell/" rel="noopener ugc nofollow" target="_blank">云外壳</a>。</li><li id="1a5b" class="lg lh hi ji b jj lu jn lv lk lw lm lx lo ly ja lq lr ls lt bi translated">启用<a class="ae jb" href="https://console.developers.google.com/apis/api/run.googleapis.com/overview" rel="noopener ugc nofollow" target="_blank">云运行API </a>。</li><li id="0576" class="lg lh hi ji b jj lu jn lv lk lw lm lx lo ly ja lq lr ls lt bi translated">启用<a class="ae jb" href="https://console.developers.google.com/apis/api/containerregistry.googleapis.com/overview" rel="noopener ugc nofollow" target="_blank">容器注册API </a>。</li><li id="f31e" class="lg lh hi ji b jj lu jn lv lk lw lm lx lo ly ja lq lr ls lt bi translated">克隆<a class="ae jb" href="https://github.com/Timtech4u/flask-docker" rel="noopener ugc nofollow" target="_blank">样本代码</a>或者用<em class="jh"> Dockerfile </em>设置你自己的代码。</li></ul><p id="c9b8" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">对于本指南，我将坚持使用默认启用了Terraform的Cloud Shell。</p><p id="3d53" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">如果您在本地PC上使用Cloud SDK，您需要一个服务帐户来使用Terraform，请在此处创建一个<a class="ae jb" href="https://console.cloud.google.com/apis/credentials/serviceaccountkey" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="5660" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated"><em class="jh">注意</em><strong class="ji hj"><em class="jh">terra form-Cr</em></strong><em class="jh">是我的GCP项目ID，你应该用你的替换它。</em></p><h1 id="09e6" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">将Docker图像推送到容器注册表</h1><p id="ae97" class="pw-post-body-paragraph jf jg hi ji b jj li jl jm jn lj jp jq lk lz jt ju lm ma jx jy lo mb kb kc ja hb bi translated">我们需要构建Docker映像并将其推送到项目的容器注册表中，以便Terraform可以访问它。</p><p id="ed30" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">您可以将源代码克隆到Cloud Shell中，并在其目录中执行以下命令。</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="8648" class="ml kj hi mh b fi mm mn l mo mp">$ <!-- -->docker build -t gcr.io/<!-- -->terraform-cr<!-- -->/webapp .<br/>$ docker push gcr.io/terraform-cr/webapp</span></pre><figure class="mc md me mf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mq"><img src="../Images/a592fe2bd05ec4f735187423f4fd386c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hc8Qc_Xv4W7RqMP-CtCI1A.png"/></div></div><figcaption class="mr ms et er es mt mu bd b be z dx translated">输出</figcaption></figure><p id="812a" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">如果这对你不起作用，请查看官方文档中的其他步骤<a class="ae jb" href="https://cloud.google.com/container-registry/docs/pushing-and-pulling" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="7021" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">云运行将仅检索托管在容器注册表中的容器，而不从其他来源检索。</p><p id="112d" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">如果你的Docker图像在<a class="ae jb" href="http://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>上，我制作了一个简短的视频，讲述了如何将Docker图像推送到容器注册表。请订阅😉</p><figure class="mc md me mf fd ij"><div class="bz dy l di"><div class="mv mw l"/></div><figcaption class="mr ms et er es mt mu bd b be z dx translated">将Docker映像部署到Google云运行</figcaption></figure><h1 id="09c1" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">使用Terraform部署到云运行</h1><p id="bcb3" class="pw-post-body-paragraph jf jg hi ji b jj li jl jm jn lj jp jq lk lz jt ju lm ma jx jy lo mb kb kc ja hb bi translated">云壳上启用了Terraform，可以通过执行<strong class="ji hj"> <em class="jh"> terraform -v </em> </strong>命令进行验证。安装的Terraform版本是v0.12.9。</p><figure class="mc md me mf fd ij er es paragraph-image"><div class="er es mx"><img src="../Images/3ab9c8027ac7d5296402e8e324d0a0b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*TgCaXl1nVkw99ARRjWLG6g.png"/></div><figcaption class="mr ms et er es mt mu bd b be z dx translated">地形版本</figcaption></figure><p id="d5ac" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">如果你想了解这一部分的更多细节，请查阅<a class="ae jb" href="https://www.terraform.io/docs/providers/google/r/cloud_run_service.html" rel="noopener ugc nofollow" target="_blank">云运行-地形资源文档</a>。</p><p id="bc78" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">下一步是创建一个<strong class="ji hj"> main.tf </strong>文件，这是一个Terraform配置文件，你可以在这里找到我的:</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="f683" class="ml kj hi mh b fi mm mn l mo mp"># Filename: main.tf</span><span id="7bf3" class="ml kj hi mh b fi my mn l mo mp"># Configure GCP project<br/>provider "google" {<br/>  project = "terraform-cr"<br/>}</span><span id="a21c" class="ml kj hi mh b fi my mn l mo mp"># Deploy image to Cloud Run<br/>resource "google_cloud_run_service" "mywebapp" {<br/>  name     = "mywebapp"<br/>  location = "us-central1"<br/>  template {<br/>    spec {<br/>      containers {<br/>        image = "gcr.io/terraform-cr/webapp"<br/>      }<br/>    }<br/>  }<br/>  traffic {<br/>    percent         = 100<br/>    latest_revision = true<br/>  }<br/>}</span><span id="2de8" class="ml kj hi mh b fi my mn l mo mp"># Create public access<br/>data "google_iam_policy" "noauth" {<br/>  binding {<br/>    role = "roles/run.invoker"<br/>    members = [<br/>      "allUsers",<br/>    ]<br/>  }<br/>}</span><span id="5693" class="ml kj hi mh b fi my mn l mo mp"># Enable public access on Cloud Run service<br/>resource "google_cloud_run_service_iam_policy" "noauth" {<br/>  location    = google_cloud_run_service.mywebapp.location<br/>  project     = google_cloud_run_service.mywebapp.project<br/>  service     = google_cloud_run_service.mywebapp.name<br/>  policy_data = data.google_iam_policy.noauth.policy_data<br/>}</span><span id="7285" class="ml kj hi mh b fi my mn l mo mp"># Return service URL<br/>output "url" {<br/>  value = "${google_cloud_run_service.mywebapp.status[0].url}"<br/>}</span></pre><p id="5137" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">现在让我们在谷歌云壳上初始化Terraform。</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="6b3a" class="ml kj hi mh b fi mm mn l mo mp">$ terraform init</span></pre><figure class="mc md me mf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mz"><img src="../Images/9fc2f23f8e3e801ebca6ba942b623181.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*gqPXlWuvIpabg26YdMS_dg.png"/></div></div><figcaption class="mr ms et er es mt mu bd b be z dx translated">输出</figcaption></figure><p id="7557" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">然后，让我们在<strong class="ji hj"> main.tf </strong>文件中规划代码，看看基础设施是什么样子的:</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="82e5" class="ml kj hi mh b fi mm mn l mo mp">$ terraform plan</span></pre><figure class="mc md me mf fd ij er es paragraph-image"><div class="er es na"><img src="../Images/49c8c879145ca7e93dedf6693b465666.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*SZLjZpScDhwaGdQQPA0p4g.png"/></div><figcaption class="mr ms et er es mt mu bd b be z dx translated">截断输出</figcaption></figure><p id="dd63" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">最后，我们可以申请执行，请确保输入'<strong class="ji hj">是</strong>'进行批准。</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="787c" class="ml kj hi mh b fi mm mn l mo mp">$ terraform apply</span></pre><figure class="mc md me mf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nb"><img src="../Images/4257b7597f5c990eedff9adb339bc911.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tj5Xuj8JymgyStzP1nE6lw.png"/></div></div><figcaption class="mr ms et er es mt mu bd b be z dx translated">截断输出</figcaption></figure><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="d054" class="ml kj hi mh b fi mm mn l mo mp">Outputs:</span><span id="75b7" class="ml kj hi mh b fi my mn l mo mp">url = <a class="ae jb" href="https://mywebapp-mxxduub7tq-uc.a.run.app" rel="noopener ugc nofollow" target="_blank">https://mywebapp-mxxduub7tq-uc.a.run.app</a></span></pre><h1 id="63eb" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">后续步骤</h1><p id="dceb" class="pw-post-body-paragraph jf jg hi ji b jj li jl jm jn lj jp jq lk lz jt ju lm ma jx jy lo mb kb kc ja hb bi translated">Terraform允许您删除使用的每个资源(包括GCP项目)，为此，执行以下命令，确保输入'<strong class="ji hj"> yes </strong>进行批准。</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="93d9" class="ml kj hi mh b fi mm mn l mo mp">$ terraform destroy</span></pre><p id="11ee" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">到目前为止，我们已经能够使用Terraform将我们的部署作为代码提供给云运行。这可以帮助您更快地部署应用程序。</p><p id="5519" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">如果你想在Google Cloud上自动化更多的工作流程，下面的资源会派上用场。</p><ul class=""><li id="05b7" class="lg lh hi ji b jj kd jn ke lk nc lm nd lo ne ja lq lr ls lt bi translated"><a class="ae jb" href="https://www.terraform.io/docs/providers/google/index.html" rel="noopener ugc nofollow" target="_blank"> Terraform Google云提供商文档</a></li><li id="86c3" class="lg lh hi ji b jj lu jn lv lk lw lm lx lo ly ja lq lr ls lt bi translated"><a class="ae jb" href="https://cloud.google.com/cloud-build/docs/" rel="noopener ugc nofollow" target="_blank">谷歌云构建文档</a></li><li id="bc3f" class="lg lh hi ji b jj lu jn lv lk lw lm lx lo ly ja lq lr ls lt bi translated">我博客上的自动化技巧。</li></ul></div></div>    
</body>
</html>