<html>
<head>
<title>Serverless Deployment on Cloud Run using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨Terraformåœ¨äº‘ä¸Šè¿è¡Œæ— æœåŠ¡å™¨éƒ¨ç½²</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/google-cloud/deploying-docker-images-to-cloud-run-using-terraform-ee8ae4ecb72e?source=collection_archive---------0-----------------------#2020-01-23">https://medium.com/google-cloud/deploying-docker-images-to-cloud-run-using-terraform-ee8ae4ecb72e?source=collection_archive---------0-----------------------#2020-01-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/4adeed60ce4aaa19bce58db41f5ea101.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RMCKkdd6bbPT5LctVVv5dw.png"/></div></div></figure><blockquote class="iq"><p id="9336" class="ir is hi bd it iu iv iw ix iy iz ja dx translated">åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æŠŠä¸€ä¸ªæ— æœåŠ¡å™¨çš„Flask webåº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°Cloud Runï¼Œæ–¹æ³•æ˜¯å°†å®ƒçš„<a class="ae jb" href="https://github.com/Timtech4u/ghost3-docker" rel="noopener ugc nofollow" target="_blank"> Dockeræ˜ åƒ</a>æ„å»ºåˆ°Container Registryä¸­ï¼Œå¹¶ä½¿ç”¨Terraformå°†æˆ‘ä»¬çš„éƒ¨ç½²é…ç½®ä¸ºä»£ç ã€‚</p></blockquote><blockquote class="jc jd je"><p id="66e3" class="jf jg jh ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc ja hb bi translated"><a class="ae jb" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>æ˜¯ä¸€ä¸ªåŸºç¡€è®¾æ–½ä»£ç å·¥å…·ï¼Œç”¨äºè·¨å„ç§äº‘æä¾›å•†å®‰å…¨é«˜æ•ˆåœ°æ„å»ºã€æ›´æ”¹å’Œç‰ˆæœ¬æ§åˆ¶åŸºç¡€è®¾æ–½ã€‚</p><p id="5acc" class="jf jg jh ji b jj kd jl jm jn ke jp jq jr kf jt ju jv kg jx jy jz kh kb kc ja hb bi translated"><a class="ae jb" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank"> Cloud Run </a>æ˜¯ä¸€ä¸ªæ‰˜ç®¡è®¡ç®—å¹³å°ï¼Œä½¿æ‚¨èƒ½å¤Ÿè¿è¡Œå¯è‡ªåŠ¨æ‰©å±•çš„æ— çŠ¶æ€æ— æœåŠ¡å™¨å®¹å™¨ã€‚</p><p id="4748" class="jf jg jh ji b jj kd jl jm jn ke jp jq jr kf jt ju jv kg jx jy jz kh kb kc ja hb bi translated"><a class="ae jb" href="https://cloud.google.com/container-registry" rel="noopener ugc nofollow" target="_blank">å®¹å™¨æ³¨å†Œä¸­å¿ƒ</a>æ˜¯ä¸€ä¸ªç§æœ‰çš„å®¹å™¨æ˜ åƒæ³¨å†Œä¸­å¿ƒï¼Œè¿è¡Œåœ¨Google Cloudä¸Šã€‚</p><p id="18e0" class="jf jg jh ji b jj kd jl jm jn ke jp jq jr kf jt ju jv kg jx jy jz kh kb kc ja hb bi translated"><a class="ae jb" href="https://github.com/pallets/flask" rel="noopener ugc nofollow" target="_blank"> Flask </a>æ˜¯ä¸€ä¸ªç”¨Pythonç¼–å†™çš„å¾®å‹webæ¡†æ¶ã€‚</p></blockquote><h1 id="5a14" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">å…ˆå†³æ¡ä»¶</h1><ul class=""><li id="a12b" class="lg lh hi ji b jj li jn lj lk ll lm ln lo lp ja lq lr ls lt bi translated">åˆ›å»ºä¸€ä¸ª<a class="ae jb" href="https://console.cloud.google.com/project" rel="noopener ugc nofollow" target="_blank">è°·æ­Œäº‘å¹³å°(GCP)é¡¹ç›®</a>ï¼Œæˆ–è€…ä½¿ç”¨ä¸€ä¸ªç°æœ‰çš„é¡¹ç›®ã€‚</li><li id="ee2f" class="lg lh hi ji b jj lu jn lv lk lw lm lx lo ly ja lq lr ls lt bi translated">è®¾ç½®<a class="ae jb" href="https://cloud.google.com/sdk/" rel="noopener ugc nofollow" target="_blank">äº‘SDK </a>ï¼Œæˆ–è€…ä½¿ç”¨<a class="ae jb" href="https://cloud.google.com/shell/" rel="noopener ugc nofollow" target="_blank">äº‘å¤–å£³</a>ã€‚</li><li id="1a5b" class="lg lh hi ji b jj lu jn lv lk lw lm lx lo ly ja lq lr ls lt bi translated">å¯ç”¨<a class="ae jb" href="https://console.developers.google.com/apis/api/run.googleapis.com/overview" rel="noopener ugc nofollow" target="_blank">äº‘è¿è¡ŒAPI </a>ã€‚</li><li id="0576" class="lg lh hi ji b jj lu jn lv lk lw lm lx lo ly ja lq lr ls lt bi translated">å¯ç”¨<a class="ae jb" href="https://console.developers.google.com/apis/api/containerregistry.googleapis.com/overview" rel="noopener ugc nofollow" target="_blank">å®¹å™¨æ³¨å†ŒAPI </a>ã€‚</li><li id="f31e" class="lg lh hi ji b jj lu jn lv lk lw lm lx lo ly ja lq lr ls lt bi translated">å…‹éš†<a class="ae jb" href="https://github.com/Timtech4u/flask-docker" rel="noopener ugc nofollow" target="_blank">æ ·æœ¬ä»£ç </a>æˆ–è€…ç”¨<em class="jh"> Dockerfile </em>è®¾ç½®ä½ è‡ªå·±çš„ä»£ç ã€‚</li></ul><p id="c9b8" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">å¯¹äºæœ¬æŒ‡å—ï¼Œæˆ‘å°†åšæŒä½¿ç”¨é»˜è®¤å¯ç”¨äº†Terraformçš„Cloud Shellã€‚</p><p id="3d53" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">å¦‚æœæ‚¨åœ¨æœ¬åœ°PCä¸Šä½¿ç”¨Cloud SDKï¼Œæ‚¨éœ€è¦ä¸€ä¸ªæœåŠ¡å¸æˆ·æ¥ä½¿ç”¨Terraformï¼Œè¯·åœ¨æ­¤å¤„åˆ›å»ºä¸€ä¸ª<a class="ae jb" href="https://console.cloud.google.com/apis/credentials/serviceaccountkey" rel="noopener ugc nofollow" target="_blank"/>ã€‚</p><p id="5660" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated"><em class="jh">æ³¨æ„</em><strong class="ji hj"><em class="jh">terra form-Cr</em></strong><em class="jh">æ˜¯æˆ‘çš„GCPé¡¹ç›®IDï¼Œä½ åº”è¯¥ç”¨ä½ çš„æ›¿æ¢å®ƒã€‚</em></p><h1 id="09e6" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">å°†Dockerå›¾åƒæ¨é€åˆ°å®¹å™¨æ³¨å†Œè¡¨</h1><p id="ae97" class="pw-post-body-paragraph jf jg hi ji b jj li jl jm jn lj jp jq lk lz jt ju lm ma jx jy lo mb kb kc ja hb bi translated">æˆ‘ä»¬éœ€è¦æ„å»ºDockeræ˜ åƒå¹¶å°†å…¶æ¨é€åˆ°é¡¹ç›®çš„å®¹å™¨æ³¨å†Œè¡¨ä¸­ï¼Œä»¥ä¾¿Terraformå¯ä»¥è®¿é—®å®ƒã€‚</p><p id="ed30" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">æ‚¨å¯ä»¥å°†æºä»£ç å…‹éš†åˆ°Cloud Shellä¸­ï¼Œå¹¶åœ¨å…¶ç›®å½•ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ã€‚</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="8648" class="ml kj hi mh b fi mm mn l mo mp">$ <!-- -->docker build -t gcr.io/<!-- -->terraform-cr<!-- -->/webapp .<br/>$ docker push gcr.io/terraform-cr/webapp</span></pre><figure class="mc md me mf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mq"><img src="../Images/a592fe2bd05ec4f735187423f4fd386c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hc8Qc_Xv4W7RqMP-CtCI1A.png"/></div></div><figcaption class="mr ms et er es mt mu bd b be z dx translated">è¾“å‡º</figcaption></figure><p id="812a" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">å¦‚æœè¿™å¯¹ä½ ä¸èµ·ä½œç”¨ï¼Œè¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ä¸­çš„å…¶ä»–æ­¥éª¤<a class="ae jb" href="https://cloud.google.com/container-registry/docs/pushing-and-pulling" rel="noopener ugc nofollow" target="_blank">è¿™é‡Œ</a>ã€‚</p><p id="7021" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">äº‘è¿è¡Œå°†ä»…æ£€ç´¢æ‰˜ç®¡åœ¨å®¹å™¨æ³¨å†Œè¡¨ä¸­çš„å®¹å™¨ï¼Œè€Œä¸ä»å…¶ä»–æ¥æºæ£€ç´¢ã€‚</p><p id="112d" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">å¦‚æœä½ çš„Dockerå›¾åƒåœ¨<a class="ae jb" href="http://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>ä¸Šï¼Œæˆ‘åˆ¶ä½œäº†ä¸€ä¸ªç®€çŸ­çš„è§†é¢‘ï¼Œè®²è¿°äº†å¦‚ä½•å°†Dockerå›¾åƒæ¨é€åˆ°å®¹å™¨æ³¨å†Œè¡¨ã€‚è¯·è®¢é˜…ğŸ˜‰</p><figure class="mc md me mf fd ij"><div class="bz dy l di"><div class="mv mw l"/></div><figcaption class="mr ms et er es mt mu bd b be z dx translated">å°†Dockeræ˜ åƒéƒ¨ç½²åˆ°Googleäº‘è¿è¡Œ</figcaption></figure><h1 id="09c1" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">ä½¿ç”¨Terraforméƒ¨ç½²åˆ°äº‘è¿è¡Œ</h1><p id="bcb3" class="pw-post-body-paragraph jf jg hi ji b jj li jl jm jn lj jp jq lk lz jt ju lm ma jx jy lo mb kb kc ja hb bi translated">äº‘å£³ä¸Šå¯ç”¨äº†Terraformï¼Œå¯ä»¥é€šè¿‡æ‰§è¡Œ<strong class="ji hj"> <em class="jh"> terraform -v </em> </strong>å‘½ä»¤è¿›è¡ŒéªŒè¯ã€‚å®‰è£…çš„Terraformç‰ˆæœ¬æ˜¯v0.12.9ã€‚</p><figure class="mc md me mf fd ij er es paragraph-image"><div class="er es mx"><img src="../Images/3ab9c8027ac7d5296402e8e324d0a0b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*TgCaXl1nVkw99ARRjWLG6g.png"/></div><figcaption class="mr ms et er es mt mu bd b be z dx translated">åœ°å½¢ç‰ˆæœ¬</figcaption></figure><p id="d5ac" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">å¦‚æœä½ æƒ³äº†è§£è¿™ä¸€éƒ¨åˆ†çš„æ›´å¤šç»†èŠ‚ï¼Œè¯·æŸ¥é˜…<a class="ae jb" href="https://www.terraform.io/docs/providers/google/r/cloud_run_service.html" rel="noopener ugc nofollow" target="_blank">äº‘è¿è¡Œ-åœ°å½¢èµ„æºæ–‡æ¡£</a>ã€‚</p><p id="bc78" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">ä¸‹ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ª<strong class="ji hj"> main.tf </strong>æ–‡ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªTerraformé…ç½®æ–‡ä»¶ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°æˆ‘çš„:</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="f683" class="ml kj hi mh b fi mm mn l mo mp"># Filename: main.tf</span><span id="7bf3" class="ml kj hi mh b fi my mn l mo mp"># Configure GCP project<br/>provider "google" {<br/>  project = "terraform-cr"<br/>}</span><span id="a21c" class="ml kj hi mh b fi my mn l mo mp"># Deploy image to Cloud Run<br/>resource "google_cloud_run_service" "mywebapp" {<br/>  name     = "mywebapp"<br/>  location = "us-central1"<br/>  template {<br/>    spec {<br/>      containers {<br/>        image = "gcr.io/terraform-cr/webapp"<br/>      }<br/>    }<br/>  }<br/>  traffic {<br/>    percent         = 100<br/>    latest_revision = true<br/>  }<br/>}</span><span id="2de8" class="ml kj hi mh b fi my mn l mo mp"># Create public access<br/>data "google_iam_policy" "noauth" {<br/>  binding {<br/>    role = "roles/run.invoker"<br/>    members = [<br/>      "allUsers",<br/>    ]<br/>  }<br/>}</span><span id="5693" class="ml kj hi mh b fi my mn l mo mp"># Enable public access on Cloud Run service<br/>resource "google_cloud_run_service_iam_policy" "noauth" {<br/>  location    = google_cloud_run_service.mywebapp.location<br/>  project     = google_cloud_run_service.mywebapp.project<br/>  service     = google_cloud_run_service.mywebapp.name<br/>  policy_data = data.google_iam_policy.noauth.policy_data<br/>}</span><span id="7285" class="ml kj hi mh b fi my mn l mo mp"># Return service URL<br/>output "url" {<br/>  value = "${google_cloud_run_service.mywebapp.status[0].url}"<br/>}</span></pre><p id="5137" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">ç°åœ¨è®©æˆ‘ä»¬åœ¨è°·æ­Œäº‘å£³ä¸Šåˆå§‹åŒ–Terraformã€‚</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="6b3a" class="ml kj hi mh b fi mm mn l mo mp">$ terraform init</span></pre><figure class="mc md me mf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mz"><img src="../Images/9fc2f23f8e3e801ebca6ba942b623181.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*gqPXlWuvIpabg26YdMS_dg.png"/></div></div><figcaption class="mr ms et er es mt mu bd b be z dx translated">è¾“å‡º</figcaption></figure><p id="7557" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">ç„¶åï¼Œè®©æˆ‘ä»¬åœ¨<strong class="ji hj"> main.tf </strong>æ–‡ä»¶ä¸­è§„åˆ’ä»£ç ï¼Œçœ‹çœ‹åŸºç¡€è®¾æ–½æ˜¯ä»€ä¹ˆæ ·å­çš„:</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="82e5" class="ml kj hi mh b fi mm mn l mo mp">$ terraform plan</span></pre><figure class="mc md me mf fd ij er es paragraph-image"><div class="er es na"><img src="../Images/49c8c879145ca7e93dedf6693b465666.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*SZLjZpScDhwaGdQQPA0p4g.png"/></div><figcaption class="mr ms et er es mt mu bd b be z dx translated">æˆªæ–­è¾“å‡º</figcaption></figure><p id="dd63" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ç”³è¯·æ‰§è¡Œï¼Œè¯·ç¡®ä¿è¾“å…¥'<strong class="ji hj">æ˜¯</strong>'è¿›è¡Œæ‰¹å‡†ã€‚</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="787c" class="ml kj hi mh b fi mm mn l mo mp">$ terraform apply</span></pre><figure class="mc md me mf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nb"><img src="../Images/4257b7597f5c990eedff9adb339bc911.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tj5Xuj8JymgyStzP1nE6lw.png"/></div></div><figcaption class="mr ms et er es mt mu bd b be z dx translated">æˆªæ–­è¾“å‡º</figcaption></figure><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="d054" class="ml kj hi mh b fi mm mn l mo mp">Outputs:</span><span id="75b7" class="ml kj hi mh b fi my mn l mo mp">url = <a class="ae jb" href="https://mywebapp-mxxduub7tq-uc.a.run.app" rel="noopener ugc nofollow" target="_blank">https://mywebapp-mxxduub7tq-uc.a.run.app</a></span></pre><h1 id="63eb" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">åç»­æ­¥éª¤</h1><p id="dceb" class="pw-post-body-paragraph jf jg hi ji b jj li jl jm jn lj jp jq lk lz jt ju lm ma jx jy lo mb kb kc ja hb bi translated">Terraformå…è®¸æ‚¨åˆ é™¤ä½¿ç”¨çš„æ¯ä¸ªèµ„æº(åŒ…æ‹¬GCPé¡¹ç›®)ï¼Œä¸ºæ­¤ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç¡®ä¿è¾“å…¥'<strong class="ji hj"> yes </strong>è¿›è¡Œæ‰¹å‡†ã€‚</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="93d9" class="ml kj hi mh b fi mm mn l mo mp">$ terraform destroy</span></pre><p id="11ee" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿä½¿ç”¨Terraformå°†æˆ‘ä»¬çš„éƒ¨ç½²ä½œä¸ºä»£ç æä¾›ç»™äº‘è¿è¡Œã€‚è¿™å¯ä»¥å¸®åŠ©æ‚¨æ›´å¿«åœ°éƒ¨ç½²åº”ç”¨ç¨‹åºã€‚</p><p id="5519" class="pw-post-body-paragraph jf jg hi ji b jj kd jl jm jn ke jp jq lk kf jt ju lm kg jx jy lo kh kb kc ja hb bi translated">å¦‚æœä½ æƒ³åœ¨Google Cloudä¸Šè‡ªåŠ¨åŒ–æ›´å¤šçš„å·¥ä½œæµç¨‹ï¼Œä¸‹é¢çš„èµ„æºä¼šæ´¾ä¸Šç”¨åœºã€‚</p><ul class=""><li id="05b7" class="lg lh hi ji b jj kd jn ke lk nc lm nd lo ne ja lq lr ls lt bi translated"><a class="ae jb" href="https://www.terraform.io/docs/providers/google/index.html" rel="noopener ugc nofollow" target="_blank"> Terraform Googleäº‘æä¾›å•†æ–‡æ¡£</a></li><li id="86c3" class="lg lh hi ji b jj lu jn lv lk lw lm lx lo ly ja lq lr ls lt bi translated"><a class="ae jb" href="https://cloud.google.com/cloud-build/docs/" rel="noopener ugc nofollow" target="_blank">è°·æ­Œäº‘æ„å»ºæ–‡æ¡£</a></li><li id="bc3f" class="lg lh hi ji b jj lu jn lv lk lw lm lx lo ly ja lq lr ls lt bi translated">æˆ‘åšå®¢ä¸Šçš„è‡ªåŠ¨åŒ–æŠ€å·§ã€‚</li></ul></div></div>    
</body>
</html>