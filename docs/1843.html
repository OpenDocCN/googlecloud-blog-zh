<html>
<head>
<title>How to apply GitOps CD with GKE and Cloud-build in 5 minutes!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在5分钟内将GitOps CD应用于GKE和云构建！</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-apply-gitops-cd-with-gke-and-cloud-build-in-5-minutes-58455a2bf063?source=collection_archive---------0-----------------------#2021-04-04">https://medium.com/google-cloud/how-to-apply-gitops-cd-with-gke-and-cloud-build-in-5-minutes-58455a2bf063?source=collection_archive---------0-----------------------#2021-04-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/490ea935beb6e56d920f1d6ad2fe1375.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RLcGyanmtkde8jU2KA0gnA.jpeg"/></div></div></figure><p id="30a5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">高效的工程师总是喜欢先完成高杠杆的工作，高杠杆的工作是一种时间投资，它需要花费一些时间和努力来建立一些在未来节省大量时间或防止许多人为错误的东西，这些良好的投资之一是CI/CD管道。</p><p id="069a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">CI/CD管道从来都不是大团队才有的需求，即使是单个开发人员也需要它，不管是什么项目，然而，根据团队规模和需求，它可能有几个或许多步骤。</p><h1 id="e79c" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">Kubernetes和云原生应用</h1><p id="b183" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我假设您的应用程序是构建在微服务之上的云原生应用程序，每个微服务都由不同的编程语言构建，并且它以一种有组织的方式与其他微服务进行通信。</p><p id="1ce4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当我们谈论云原生应用和微服务时，可能意味着我们使用容器和容器编排(Kubernetes)，我不会在本文中谈论Kubernetes的所有好处，但我会提到IAC(作为代码的基础设施)的伟大之处，当有代码描述您的基础设施的当前状态时，您可以轻松地移动它或在几秒/几分钟内重新构建。</p><h1 id="aff8" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">什么是GitOps？</h1><blockquote class="kr ks kt"><p id="b169" class="iq ir ku is b it iu iv iw ix iy iz ja kv jc jd je kw jg jh ji kx jk jl jm jn hb bi translated">GitOps是实现云原生应用持续部署的一种方式。它通过使用开发人员已经熟悉的工具，包括Git和持续部署工具，关注操作基础设施时以开发人员为中心的体验。—<a class="ae ky" href="https://www.gitops.tech/" rel="noopener ugc nofollow" target="_blank">https://www.gitops.tech/</a></p></blockquote><p id="524c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">主要想法是有一个Git repo(环境Repo)来托管基础设施的当前状态(Kubernetes的清单)，然后在环境Repo与Kubernetes集群同步后，在云上更改应用程序将来自对环境Repo所做的更改。</p><h1 id="c5d1" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">GitOps的优点</h1><ul class=""><li id="1011" class="kz la hi is b it km ix kn jb lb jf lc jj ld jn le lf lg lh bi translated">在云上部署速度更快，无需配置您的本地机器，这在您管理多个环境时非常有用</li><li id="8517" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">因为它是基于Git的，所以只恢复最后一次提交的数据！</li><li id="762a" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">安全，不需要在本地机器上存储基础设施的凭证</li><li id="e203" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">使用Git权限知道谁可以读写</li><li id="8c9e" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">使用Git历史来了解发生了什么以及何时发生的</li></ul><h1 id="bdf4" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">GitOps的方法</h1><p id="e05f" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在准备好环境报告并将运行应用程序所需的所有清单放到Kubernetes上之后，我们必须将这些清单与Kubernetes集群同步，这意味着环境报告上发生的任何变化都应该反映在当前运行的基础设施上。</p><ul class=""><li id="70c3" class="kz la hi is b it iu ix iy jb ln jf lo jj lp jn le lf lg lh bi translated">基于推送的更新:环境报告上的更改将触发一个作业来更新当前的Kubernetes状态，以跟随环境报告中的新状态。</li><li id="8ecb" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">基于拉的更新:Kubernetes集群将定期运行一个作业来检查/观察环境报告中描述的当前状态，并在需要时进行自我更新。</li></ul><h1 id="36e5" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">GitOps示例</h1><figure class="lr ls lt lu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/40158b139bee39a1a80217aa1a6d16f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Iw-m54OybVsmLF3gStVNw.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx translated">来源:<a class="ae ky" href="https://www.gitops.tech/" rel="noopener ugc nofollow" target="_blank">https://www.gitops.tech/</a></figcaption></figure><p id="b69c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我的简单示例是关于web应用程序回购和环境回购，我使用<a class="ae ky" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank"> GKE </a>来管理我的Kubernetes集群，这里我们需要两个<a class="ae ky" href="https://cloud.google.com/build" rel="noopener ugc nofollow" target="_blank">云构建</a>触发器:</p><ul class=""><li id="4586" class="kz la hi is b it iu ix iy jb ln jf lo jj lp jn le lf lg lh bi translated">应用程序repo触发器:它将构建一个新的docker映像，将其推送到<a class="ae ky" href="https://cloud.google.com/container-registry" rel="noopener ugc nofollow" target="_blank">容器注册表</a> / <a class="ae ky" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker hub </a>，最后但同样重要的是，它将更新环境repo以使用最新的web应用程序映像而不是旧映像。</li><li id="1d4f" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">环境报告触发器:当有一个新的提交来应用Kubernetes集群上的最新更改时，它将运行。</li></ul><p id="7b44" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">环境回购将如下所示:</p><figure class="lr ls lt lu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lz"><img src="../Images/1dde6f2a62aa6e906c9a0552a319439c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ysmrs08B_jwf3z1bcu7lfQ.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx translated">环境报告</figcaption></figure><figure class="lr ls lt lu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/15be7b43d59df482a0e52b3c28c5d97a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zsC4jS57nKtSxYWdDRUfkg.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx translated">演示应用程序部署，此处图像被视为一个变量</figcaption></figure><figure class="lr ls lt lu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/3077f0541feb5d7d4d0b6ebce09f6f11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*krOZgVncDJNymevQiJIo1g.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx translated">创建Kubernetes对象的kustomization文件将使用特定的构建标记替换image变量</figcaption></figure><p id="fa7f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我正在使用Kubernetes的kustomize，它将使更改Kubernetes对象的部分变得更容易，例如，如果你有许多cronjobs，并且它们都使用相同的映像，你需要使用一个更新的映像，你必须更新许多YAML文件并应用它们，但是如果你正在使用kustomize，你更新并应用一个文件，这将更新所有的cronjobs！非常好！。</p></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="8998" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是应用程序报告(演示API)中需要实现的更改</p><figure class="lr ls lt lu fd ij"><div class="bz dy l di"><div class="mj mk l"/></div></figure><p id="0595" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个cloudbuild.yaml应该添加到应用程序repo的顶层。</p><p id="c47a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">ENV_REPO_FILES:这些是您想要在环境报告中更新的定制化文件的路径。</p><p id="bbe0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我使用了一个自定义步骤<code class="du ml mm mn mo b">omegaes/kubci</code>作为概念验证如何为云构建构建一个自定义步骤，该步骤将完成三项任务:</p><ul class=""><li id="bc17" class="kz la hi is b it iu ix iy jb ln jf lo jj lp jn le lf lg lh bi translated">克隆环境repo，签出目标分支以进行所需的更改</li><li id="ab52" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">更新Kustomiztion文件，更改应用程序部署的图像标签</li><li id="8fa0" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">提交这些更改，并将它们与环境报告中的主分支合并。</li></ul><blockquote class="kr ks kt"><p id="8bd6" class="iq ir ku is b it iu iv iw ix iy iz ja kv jc jd je kw jg jh ji kx jk jl jm jn hb bi translated">*最好将构建任务分成多个步骤。</p><p id="ab9c" class="iq ir ku is b it iu iv iw ix iy iz ja kv jc jd je kw jg jh ji kx jk jl jm jn hb bi translated">*最好让应用程序管道从环境回购的主分支创建目标分支，目标分支上的另一个触发器将检查是否可以应用这些更改，如果可以，它将应用并合并到环境回购的主分支。</p></blockquote></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><figure class="lr ls lt lu fd ij"><div class="bz dy l di"><div class="mj mk l"/></div></figure><p id="ee92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个cloudbuild.yaml应该添加到您的环境报告的顶层。</p></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="8e59" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，创建两个云构建触发器和秘密的“Environment-repo-auth-URL”:</p><figure class="lr ls lt lu fd ij"><div class="bz dy l di"><div class="mj mk l"/></div></figure><p id="912a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">“Environment-repo-auth-URL”将在前面的自定义步骤中使用，以克隆环境repo并在那里推送新的图像标记。</p><p id="e53a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们对应用程序回购做一个小小的改变:</p><div class="lr ls lt lu fd ab cb"><figure class="mp ij mq mr ms mt mu paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/22eef1d5f61727b997086a80878b92c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:376/format:webp/1*F132tPBKeYmMDDE7CXRtzg.png"/></div></figure><figure class="mp ij mv mr ms mt mu paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/bb69095ffbc8cd1763fc412b88e5b56d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1022/format:webp/1*7pzWb-fxnS_0kEaMblMS-g.png"/></div></figure><figure class="mp ij mw mr ms mt mu paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/eda824891b4a0c0bfcfc0a1a7337f9ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:606/format:webp/1*6hRuT-uhv1dP--_v8nGE5A.png"/></div><figcaption class="lv lw et er es lx ly bd b be z dx mx di my mz translated">应用程序回收触发器，更新基础结构代码的提交和环境回收触发器，</figcaption></figure></div><h1 id="8ec4" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">结论</h1><p id="f612" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我们所经历的只是GitOps的一个简单示例，在现实世界的项目中，您会发现许多困难，这种方法对我从环境Git存储库控制多个Kubernetes集群很有帮助，请不要犹豫询问任何澄清或分享您的想法！！</p><p id="eced" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以查看这些Github库，看看我是如何在这里构建演示的:</p><ul class=""><li id="3915" class="kz la hi is b it iu ix iy jb ln jf lo jj lp jn le lf lg lh bi translated"><a class="ae ky" href="https://github.com/omegaes/GKE-Demo-App" rel="noopener ugc nofollow" target="_blank"> GKE演示App</a>(node . js中的Hello World)</li><li id="0e08" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated"><a class="ae ky" href="https://github.com/omegaes/GKE-Demo-Environment" rel="noopener ugc nofollow" target="_blank">GKE-演示-环境</a>(宿主Kubernetes对象清单)</li><li id="75cd" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated"><a class="ae ky" href="https://github.com/omegaes/Kubci" rel="noopener ugc nofollow" target="_blank">Kubci</a>(Docker映像旨在用作云构建中的自定义步骤，这将克隆环境报告，更新kustomization yaml并将这些更改推回环境报告)</li></ul><p id="4357" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">激发我灵感的资源:</p><div class="na nb ez fb nc nd"><a href="https://www.gitops.tech/" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab dw"><div class="nf ab ng cl cj nh"><h2 class="bd hj fi z dy ni ea eb nj ed ef hh bi translated">GitOps</h2><div class="nk l"><h3 class="bd b fi z dy ni ea eb nj ed ef dx translated">自2017年由Weaveworks推出以来，GitOps在Twitter和KubeCon上引起了相当大的轰动。这个网站…</h3></div><div class="nl l"><p class="bd b fp z dy ni ea eb nj ed ef dx translated">www.gitops.tech</p></div></div><div class="nm l"><div class="nn l no np nq nm nr io nd"/></div></div></a></div><div class="na nb ez fb nc nd"><a href="https://cloud.google.com/kubernetes-engine/docs/tutorials/gitops-cloud-build" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab dw"><div class="nf ab ng cl cj nh"><h2 class="bd hj fi z dy ni ea eb nj ed ef hh bi translated">通过云构建| Kubernetes引擎实现GitOps风格的持续交付</h2><div class="nk l"><h3 class="bd b fi z dy ni ea eb nj ed ef dx translated">发送反馈本页解释了如何在Google Cloud上创建持续集成和交付(CI/CD)管道…</h3></div><div class="nl l"><p class="bd b fp z dy ni ea eb nj ed ef dx translated">cloud.google.com</p></div></div><div class="nm l"><div class="ns l no np nq nm nr io nd"/></div></div></a></div></div></div>    
</body>
</html>