<html>
<head>
<title>Scheduling BigQuery Slots</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">调度BigQuery槽</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/scheduling-bigquery-slots-2a2beba42711?source=collection_archive---------1-----------------------#2020-09-29">https://medium.com/google-cloud/scheduling-bigquery-slots-2a2beba42711?source=collection_archive---------1-----------------------#2020-09-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="22a4" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">根据计划可靠地添加和删除短期时隙容量</h2></div><p id="f651" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">跟进<a class="ae jt" rel="noopener" href="/google-cloud/optimize-bigquery-costs-with-flex-slots-e06ec5e4aa90">早先关于通过客户端库创建和分配Flex Slots承诺的帖子</a>。已经在利用<a class="ae jt" href="https://cloud.google.com/bigquery/pricing#flat_rate_pricing" rel="noopener ugc nofollow" target="_blank">统一费率定价</a>的用户经常询问他们如何能够自动化<a class="ae jt" href="https://cloud.google.com/blog/products/data-analytics/introducing-bigquery-flex-slots" rel="noopener ugc nofollow" target="_blank">弹性时段</a>的购买以实现短期容量增加。</p><p id="3a1a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于使用统一费率定价的组织来说，在关键的工作时间内，时隙调度是一种简单的增加容量的方法，同时确保了充分理解的成本上限。</p><p id="a3d7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于其他常见的用例，如在复杂的ELT工作中减轻性能约束；相反，组织应该考虑在像<a class="ae jt" href="https://cloud.google.com/composer" rel="noopener ugc nofollow" target="_blank"> Cloud Composer </a>这样的系统中，调用预订API来购买和删除承诺，作为作业编排的一部分。</p><p id="6772" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里有一个快速教程，不仅可以安排购买插槽承诺，还可以确保这些资源被干净地删除。</p><h2 id="33f4" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">体系结构</h2><p id="249b" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated"><em class="ku">本指南描述了从本</em><a class="ae jt" href="https://github.com/pdunn/bq-slot-scheduler" rel="noopener ugc nofollow" target="_blank"><em class="ku">GitHub repo</em></a><em class="ku">部署App Engine代码，这比云函数版本的代码</em>在部署和安全方面都更简单</p><p id="e924" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">架构非常简单。<a class="ae jt" href="https://cloud.google.com/scheduler" rel="noopener ugc nofollow" target="_blank">云调度器</a>用于调用App Engine中的添加容量端点，该端点购买承诺并使用<a class="ae jt" href="https://cloud.google.com/tasks" rel="noopener ugc nofollow" target="_blank">云任务</a>来调度容量的移除。然后，云任务将触发App Engine中的删除容量端点来删除指定的承诺。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es kv"><img src="../Images/00246dd0f5538e1a305650572a63da32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*ukVRH9A3sPSv3mqsIaI4nQ.png"/></div></figure><h2 id="32ab" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">理解代码</h2><p id="3748" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">示例代码添加了额外的插槽，这些插槽将在管理项目中的预先存在的保留中自动共享。对于更高级的应用，代码可以很容易地调整现有<a class="ae jt" href="https://cloud.google.com/bigquery/docs/reference/reservations/rest/v1/projects.locations.reservations" rel="noopener ugc nofollow" target="_blank">预留</a>的时隙容量，或者修改甚至修改<a class="ae jt" href="https://cloud.google.com/bigquery/docs/reference/reservations/rest/v1/projects.locations.reservations.assignments#resource:-assignment" rel="noopener ugc nofollow" target="_blank">分配</a>。</p><p id="20c4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">增加容量</strong></p><p id="d97b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du ld le lf lg b">add_capacity_request()</code>函数解析json有效负载，购买所需数量的承诺，如果成功创建了承诺，调度一个任务删除它。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="lh li l"/></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">app-engine-sched/main.py中添加容量功能的摘录</figcaption></figure><p id="1133" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">add <code class="du ld le lf lg b">add_capacity()</code>函数购买实际的承诺。该功能包括一个额外的检查来限制<code class="du ld le lf lg b">add_capacity_request()</code>可以购买的总项目级别。如果<code class="du ld le lf lg b">/add_capacity</code>端点被意外触发多次，或者团队管理员直接在控制台上购物。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="lh li l"/></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">app-engine-sched/main.py中添加容量功能的摘录</figcaption></figure><p id="fd05" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">添加容量执行流程的最后一部分是安排一个云任务来删除购买的承诺。该函数创建一个云任务，它将在指定的分钟数后调用该应用程序的<code class="du ld le lf lg b">/del_capacity</code>端点。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="lh li l"/></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">app-engine-sched/main.py中添加容量功能的摘录</figcaption></figure><p id="942e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">删除容量</strong></p><p id="64f6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du ld le lf lg b">delete_capacity_request()</code>功能比添加容量执行流程简单得多。json负载被解析为完全限定的提交名，删除调用被执行。该函数没有其他副作用，只能影响指定的提交。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="lh li l"/></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">从app-engine-sched/main.py中删除容量函数</figcaption></figure><h2 id="63d0" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">配置资源</h2><p id="1cd6" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated"><em class="ku">设置说明使用gcloud CLI，但也可以使用Terraform或部署管理器。</em></p><p id="b911" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">来自预订管理项目中的云外壳。</p><p id="1b48" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将目录克隆并更改到存储库中。</p><pre class="kw kx ky kz fd ln lg lo lp aw lq bi"><span id="bd31" class="ju jv hi lg b fi lr ls l lt lu">git clone <a class="ae jt" href="https://github.com/pdunn/bq-slot-scheduler.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pdunn/bq-slot-scheduler.git</a><br/>cd bq-slot-scheduler/app-engine-sched/</span></pre><p id="25e2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在选定的GCP地区创建应用引擎环境，并创建云任务队列。</p><pre class="kw kx ky kz fd ln lg lo lp aw lq bi"><span id="2033" class="ju jv hi lg b fi lr ls l lt lu">gcloud app create --region='us-central1'<br/>gcloud tasks queues create commit-delete-queue</span></pre><p id="7de6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">部署应用程序并<a class="ae jt" href="https://cloud.google.com/appengine/docs/standard/python3/creating-firewalls#allowing_requests_from_your_services" rel="noopener ugc nofollow" target="_blank">设置防火墙</a>以阻止外部访问。</p><pre class="kw kx ky kz fd ln lg lo lp aw lq bi"><span id="f736" class="ju jv hi lg b fi lr ls l lt lu">#update app.yaml with project and queue name<br/>vi app.yaml<br/>gcloud app deploy<br/>gcloud app firewall-rules update default --action=DENY</span></pre><p id="64b6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">授予app engine服务帐户购买和删除槽承诺的权限。</p><pre class="kw kx ky kz fd ln lg lo lp aw lq bi"><span id="b99e" class="ju jv hi lg b fi lr ls l lt lu">SERV_ACCT=`gcloud iam service-accounts list --format="value(email)" | grep appspot.gserviceaccount.com`</span><span id="1694" class="ju jv hi lg b fi lv ls l lt lu">gcloud projects add-iam-policy-binding $DEVSHELL_PROJECT_ID \<br/>--member="serviceAccount:${SERV_ACCT}" \<br/>--role='roles/bigquery.resourceAdmin'</span></pre><p id="86dc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，配置云调度程序作业，以便在需要时增加容量。示例配置在星期一上午9点运行，并在BigQuery US地区部署100个额外的插槽，持续3个小时。</p><pre class="kw kx ky kz fd ln lg lo lp aw lq bi"><span id="3223" class="ju jv hi lg b fi lr ls l lt lu">gcloud scheduler jobs create app-engine add-slots \<br/>--schedule='* 9 * * 1' \<br/>--http-method='POST' \<br/>--relative-url='/add_capacity' \<br/>--message-body='{"region":"US", "extra_slots":100, "minutes":180}'</span></pre><h2 id="451d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated"><strong class="ak">结论</strong></h2><p id="0746" class="pw-post-body-paragraph ix iy hi iz b ja kp ij jc jd kq im jf jg kr ji jj jk ks jm jn jo kt jq jr js hb bi translated">如果您已经遵循了这些步骤，那么您应该有一个基本的调度系统来临时向您的管理项目添加插槽。</p><p id="5225" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此外，本教程中使用的组件在Google Cloud控制台中有图形界面，可用于监控和调整应用程序的行为。</p></div></div>    
</body>
</html>