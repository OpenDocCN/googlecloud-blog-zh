<html>
<head>
<title>Deployment on GKE with Flagger using GCP Log Based Metrics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用基于GCP日志的指标在GKE上部署Flagger</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/deployment-on-gke-with-flagger-using-gcp-log-based-metrics-9daf951348d1?source=collection_archive---------10-----------------------#2022-11-15">https://medium.com/google-cloud/deployment-on-gke-with-flagger-using-gcp-log-based-metrics-9daf951348d1?source=collection_archive---------10-----------------------#2022-11-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="67dc" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated"><strong class="ak">概述</strong></h2></div><p id="b40b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Flagger是一个渐进式交付工具，它将使用Kubernetes的应用程序的发布过程转换为自动操作。flagger工具可用于执行部署策略(淡黄色、A/B、蓝绿色)。flagger部署是在指标分析阶段执行的。我们可以使用基于GCP日志的指标来定义自定义指标，这些指标可用于控制GKE集群中的部署。在这篇博客中，我们将介绍如何使用flagger工具，使用基于GCP日志的指标作为flagger指标来执行canary部署。</p><h2 id="624d" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">先决条件</h2><ol class=""><li id="2069" class="ko kp hi iz b ja kq jd kr jg ks jk kt jo ku js kv kw kx ky bi translated">安装了Istio并启用了工作负载标识的GKE集群。</li><li id="a747" class="ko kp hi iz b ja kz jd la jg lb jk lc jo ld js kv kw kx ky bi translated">Flagger需要Kubernetes cluster <strong class="iz hj"> v1.16 </strong>或更新版本，Istio <strong class="iz hj"> v1.5 </strong>或更新版本。</li><li id="79e4" class="ko kp hi iz b ja kz jd la jg lb jk lc jo ld js kv kw kx ky bi translated"><a class="ae le" href="https://www.caseywylie.io/kubernetes/configure-istio-accesslog/" rel="noopener ugc nofollow" target="_blank">启用JSON类型的Istio访问日志。</a></li><li id="7c8f" class="ko kp hi iz b ja kz jd la jg lb jk lc jo ld js kv kw kx ky bi translated"><a class="ae le" href="https://istio.io/latest/docs/setup/platform-setup/gke/?_ga=2.93334686.242401394.1668493301-1767011036.1668493301#:~:text=For%20private%20GKE%20clusters" rel="noopener ugc nofollow" target="_blank">更新GKE集群防火墙，为专用GKE集群打开端口15017。</a></li></ol><h2 id="3121" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">步伐</h2><ol class=""><li id="e40a" class="ko kp hi iz b ja kq jd kr jg ks jk kt jo ku js kv kw kx ky bi translated">在istio-system命名空间中使用以下命令在GKE集群上安装flagger:</li></ol><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="f4c0" class="lo ju hi lk b be lp lq l lr ls">kubectl apply -k github.com/fluxcd/flagger//kustomize/istio</span></pre><p id="8707" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.在测试命名空间中部署带有测试窗格的示例应用程序:</p><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="22ef" class="lo ju hi lk b be lp lq l lr ls">kubectl create ns test<br/>kubectl label namespace test istio-injection=enabled<br/>kubectl apply -k https://github.com/fluxcd/flagger//kustomize/podinfo?ref=main<br/>kubectl apply -k https://github.com/fluxcd/flagger//kustomize/tester?ref=main</span></pre><p id="0a0d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.使用入口网关公开示例应用程序:</p><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="795d" class="lo ju hi lk b be lp lq l lr ls">apiVersion: networking.istio.io/v1alpha3<br/>kind: Gateway<br/>metadata:<br/>  name: public-gateway<br/>  namespace: istio-system<br/>spec:<br/>  selector:<br/>    istio: ingressgateway<br/>  servers:<br/>    - port:<br/>        number: 80<br/>        name: http<br/>        protocol: HTTP<br/>      hosts:<br/>        - "*"</span></pre><p id="6d2a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.使用以下云日志记录查询创建一个基于日志的分布类型指标，以从istio访问日志中获取示例应用程序的canary pods(使用名为jsonPayload.duration的字段)的延迟:</p><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="6a47" class="lo ju hi lk b be lp lq l lt ls">resource.type="k8s_container"<br/>resource.labels.project_id="&lt;GCP_PROJECT_ID&gt;"<br/>resource.labels.location="&lt;GKE_LOCATION&gt;"<br/>resource.labels.cluster_name="&lt;GKE_CLUSTER_NAME&gt;"<br/>resource.labels.namespace_name="test"<br/>resource.labels.container_name="istio-proxy"<br/>jsonPayload.authority="podinfo-canary.test:9898"<br/>jsonPayload.duration&gt;0</span></pre><p id="533a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">5.从GCP IAM页面创建具有监控管理员角色的服务帐户(GCP_SA)。</p><p id="f687" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">6.在启用了工作量标识的GKE集群中执行以下步骤:</p><p id="74d5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">a)在flagger服务帐户和GCP服务帐户之间添加IAM策略绑定。此绑定允许flagger Kubernetes服务帐户充当IAM服务帐户:</p><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="3e01" class="lo ju hi lk b be lp lq l lr ls">gcloud iam service-accounts add-iam-policy-binding &lt;GCP_SA&gt; \    <br/>--role roles/iam.workloadIdentityUser \<br/>--member "serviceAccount:&lt;GCP_PROJECT_ID&gt;.svc.id.goog[&lt;NAMESPACE&gt;/&lt;FLAGGER_KUBERNETES_SA&gt;]"</span></pre><p id="b7a4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">b)注释flagger Kubernetes服务帐户:</p><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="beb2" class="lo ju hi lk b be lp lq l lr ls">kubectl annotate serviceaccount &lt;FLAGGER_KUBERNETES_SA&gt; \<br/>--namespace &lt;NAMESPACE&gt; \<br/>iam.gke.io/gcp-service-account=&lt;GCP_SA&gt;</span></pre><p id="f48a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">7.使用基于GCP日志的度量创建度量模板，以从步骤4中创建的基于GCP日志的度量中获取延迟。</p><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="6006" class="lo ju hi lk b be lp lq l lr ls">apiVersion: flagger.app/v1beta1<br/>kind: MetricTemplate<br/>metadata:<br/>  name: canary-latency<br/>  namespace: test<br/>spec:<br/>  provider:<br/>    type: stackdriver<br/>    secretRef: <br/>      name: gcloud-sa<br/>  query: |<br/>    fetch k8s_container<br/>    | metric 'logging.googleapis.com/user/podinfo-canary-latency'<br/>    | every 1m<br/>    | group_by [], <br/>        [value_response_latencies_percentile:<br/>            percentile(value.latency,99 )]</span></pre><p id="75d5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">8.使用gcloud项目ID创建kubernetes秘密:</p><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="013c" class="lo ju hi lk b be lp lq l lr ls">kubectl create secret generic gcloud-sa --from-literal=project=&lt;project-id&gt; -n test</span></pre><p id="1cd8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">9.应用具有以下配置的加那利YAML文件，如果需要，更新清单中的主机和网关参数:</p><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="8073" class="lo ju hi lk b be lp lq l lr ls">apiVersion: flagger.app/v1beta1<br/>kind: Canary<br/>metadata:<br/>  name: podinfo<br/>  namespace: test<br/>spec:<br/>  # deployment reference<br/>  targetRef:<br/>    apiVersion: apps/v1<br/>    kind: Deployment<br/>    # Mention the deployment name for which Canary has to be triggered<br/>    name: podinfo<br/>  service:<br/>    # service port number<br/>    port: 9898<br/>    # container port number or name (optional)<br/>    targetPort: 9898<br/>    # Istio gateways (optional)<br/>    gateways:<br/>    - public-gateway.istio-system.svc.cluster.local<br/>    - istio-ingressgateway<br/>    # Istio virtual service host names (optional)<br/>    hosts:<br/>    # - app.example.com<br/>    - "*"<br/>    # Istio traffic policy (optional)<br/>    trafficPolicy:<br/>      tls:<br/>        # use ISTIO_MUTUAL when mTLS is enabled<br/>        mode: DISABLE<br/>  analysis:<br/>    # schedule interval (default 60s)<br/>    interval: 30s<br/>    # max number of failed metric checks before rollback<br/>    threshold: 10<br/>    # max traffic percentage routed to canary<br/>    # percentage (0-100)<br/>    maxWeight: 100<br/>    # canary increment step<br/>    # percentage (0-100)<br/>    stepWeight: 5<br/>    match:<br/>      - headers:<br/>          cookie:<br/>            regex: "^(.*?;)?(type=insider)(;.*)?$"<br/>    metrics:<br/>      - name: "GCP log based metrics for canary podinfo"<br/>        templateRef:<br/>          name: canary-latency<br/>          namespace: test<br/>        thresholdRange:<br/>          max: 100<br/>        interval: 30s<br/>    webhooks:<br/>      - name: load-test<br/>        url: http://flagger-loadtester.test/<br/>        timeout: 15s<br/>        metadata:<br/>          cmd: "hey -z 10m -q 10 -c 2 -H 'Cookie: type=insider' http://podinfo-canary.test:9898/"<br/>      - name: "promotion gate"<br/>        type: confirm-promotion<br/>        url: http://flagger-loadtester.test/gate/approve</span></pre></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><p id="6466" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="mb">注:</em> <a class="ae le" href="https://docs.flagger.app/usage/how-it-works" rel="noopener ugc nofollow" target="_blank"> <em class="mb">根据需要配置金丝雀YAML文件的各个参数。</em>T15】</a></p></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><p id="2cce" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">10.通过更新示例应用程序的映像版本来触发canary部署:</p><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="25dd" class="lo ju hi lk b be lp lq l lr ls">kubectl -n test set image deployment/podinfo podinfod=stefanprodan/podinfo:6.0.1</span></pre><p id="604e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">11.一旦金丝雀被初始化，金丝雀部署将开始，如果指标分析成功，部署的新版本将以权重5的增量进行部署。</p><p id="69b4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">12.canary的指标分析检查基于GCP日志的指标的延迟是否低于新canary版本的阈值100。如果度量分析条件为真，则金丝雀卷展栏会增加第5步。金丝雀以步长权重5递增，直到全部100%的流量被路由到较新的金丝雀版本。</p></div></div>    
</body>
</html>