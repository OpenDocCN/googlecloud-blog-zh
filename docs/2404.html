<html>
<head>
<title>Securing Software Supply Chain on Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保护谷歌云上的软件供应链</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/securing-software-supply-chain-on-google-cloud-b7b485fa023b?source=collection_archive---------1-----------------------#2022-10-05">https://medium.com/google-cloud/securing-software-supply-chain-on-google-cloud-b7b485fa023b?source=collection_archive---------1-----------------------#2022-10-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="58f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这最初是由Balesh Kumar写的，不幸的是，在我们有时间开源相关代码之前，他已经离开了我的团队。</p><h1 id="6c9b" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">介绍</h1><p id="0395" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">本文档的目的是提供一个分步指南和相关工件，为容器化的工作负载设置一个安全的CI/CD管道。虽然整体生态系统安全性涉及多个层面，从保护底层物理基础设施到实际代码，但本文主要关注可在CI/CD管道中实现自动化的应用程序/容器安全性。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/3fd0aca3c27af52a3503da5d32460752.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*s9QID90h6iyH0hQE"/></div></div></figure><h1 id="3fdc" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">系统概况</h1><p id="eb7a" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在本演示中，我们使用一个简单的java应用程序(带有Gradle build工具),该应用程序通过Dockerfile进行容器化，CI/CD管道通过cloudbuild.yaml进行配置。用于实施此CI/CD管道的其他技术/服务包括:</p><ol class=""><li id="5242" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated"><a class="ae jd" href="https://cloud.google.com/container-registry/docs" rel="noopener ugc nofollow" target="_blank">云源储存库</a></li><li id="f44f" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated"><a class="ae jd" href="https://cloud.google.com/artifact-registry/docs" rel="noopener ugc nofollow" target="_blank">神器登记处</a></li><li id="06b0" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated"><a class="ae jd" href="https://cloud.google.com/build/docs/concepts" rel="noopener ugc nofollow" target="_blank">云构建</a></li><li id="2653" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated"><a class="ae jd" href="https://cloud.google.com/container-analysis/docs/container-analysis" rel="noopener ugc nofollow" target="_blank">容器分析</a></li><li id="86c1" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated"><a class="ae jd" href="https://cloud.google.com/binary-authorization/docs" rel="noopener ugc nofollow" target="_blank">二进制授权</a></li><li id="9001" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated"><a class="ae jd" href="https://github.com/hadolint/hadolint" rel="noopener ugc nofollow" target="_blank">强力霉素</a></li><li id="bedc" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated"><a class="ae jd" href="https://kubesec.io/" rel="noopener ugc nofollow" target="_blank">库贝塞克</a></li><li id="48be" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated"><a class="ae jd" href="https://www.conftest.dev/" rel="noopener ugc nofollow" target="_blank">测试</a></li><li id="e41f" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated"><a class="ae jd" href="https://www.sonarqube.org/" rel="noopener ugc nofollow" target="_blank">声纳座</a></li></ol><h1 id="8413" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">云构建步骤:</h1><h1 id="9339" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">标准CI/CD管道</h1><p id="5d22" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">标准的CI/CD管道通常由4-5个阶段组成。例如，构建、测试、静态代码分析和QA阶段。这些阶段更侧重于开发人员，它只确保代码构建成功，它遵循一般的编码指南，并满足功能需求。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/3348ddf03d491e1b2f102310e095a61f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*obghEqG_bPXxOUXX"/></div></div></figure><p id="71b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些阶段中使用的工件如下:</p><ul class=""><li id="e81d" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc lh kz la lb bi translated">应用代码</li><li id="fa2e" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">Dockerfile文件</li><li id="5fe8" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">容器图像</li><li id="216f" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">Kubernetes清单文件</li></ul><p id="9422" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有这些人工制品都容易受到安全失误的影响。以下是它们可能引入的漏洞列表。</p><p id="cfc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">申请代码</strong></p><ul class=""><li id="ec91" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc lh kz la lb bi translated">SQL注入</li><li id="e0bb" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">跨站点脚本</li><li id="8546" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">代码注入</li><li id="0e77" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">没有“HttpOnly”标志的敏感Cookies</li><li id="3e25" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">还有更多</li></ul><p id="bc5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">扫描工具:<a class="ae jd" href="https://www.sonarqube.org/" rel="noopener ugc nofollow" target="_blank">声纳座</a></p><p id="db83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Dockerfile </strong></p><ul class=""><li id="df86" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc lh kz la lb bi translated">增加攻击面不必要的库和包</li><li id="70ce" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">易受攻击的非官方基础映像</li><li id="bad5" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">没有标签的图像使应用程序不一致</li><li id="1a73" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">还有更多</li></ul><p id="5134" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">扫描工具:<a class="ae jd" href="https://github.com/hadolint/hadolint" rel="noopener ugc nofollow" target="_blank"> Hadolint </a>，<a class="ae jd" href="https://www.conftest.dev/" rel="noopener ugc nofollow" target="_blank"> Confest </a></p><p id="eece" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">集装箱图像</strong></p><ul class=""><li id="4b4e" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc lh kz la lb bi translated">可能导致拒绝服务的缓冲区溢出</li><li id="2d90" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">可能影响机密性的整数溢出</li><li id="c291" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">命令注入</li><li id="f54f" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">还有更多</li></ul><p id="eb01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">扫描工具:<a class="ae jd" href="https://cloud.google.com/container-analysis/docs/container-analysis" rel="noopener ugc nofollow" target="_blank">容器分析</a></p><p id="7503" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Kubernetes清单文件</strong></p><ul class=""><li id="0fe3" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc lh kz la lb bi translated">违反最小特权原则</li><li id="3835" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">可变文件系统增加了攻击面</li><li id="2a4b" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">对CPU和内存没有限制会通过资源耗尽导致DOS</li><li id="7df8" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">赋予容器不必要的能力会导致系统调用攻击面的增加</li></ul><p id="2dda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">扫描工具:<a class="ae jd" href="https://kubesec.io/" rel="noopener ugc nofollow" target="_blank"> Kubesec </a>，<a class="ae jd" href="https://www.conftest.dev/" rel="noopener ugc nofollow" target="_blank"> Confest </a></p><h1 id="83d9" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">安全的CI/CD管道</h1><p id="f3d4" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">再努力一点，我们就可以处理上一节中讨论的所有漏洞。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/74c72879e010f48b27f39303ab2c7c64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WNaVUK4-jZarvD2o"/></div></div></figure><h1 id="7cac" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">演示范围和输出</h1><p id="ec96" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">本演示的CI/CD渠道由11个步骤组成，其中7个步骤旨在提高供应链的安全性。</p><p id="f84b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">构建步骤可以分为几类，如<em class="li">静态代码分析</em>、<em class="li">构建+推送</em>、<em class="li">漏洞扫描+证明</em>和<em class="li">生成Kubernetes清单+部署</em>。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lj"><img src="../Images/cb42a3ca26b32e20d153699e4407861c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OMv25eDbHgduW1Xk"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">云构建步骤</figcaption></figure><h1 id="55af" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">演示设置</h1><p id="1bce" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">首先创建一个项目，或将现有项目设置为默认项目:</p><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="a135" class="lt jf hi lp b fi lu lv l lw lx">gcloud projects create $PROJECT_ID –set-as-default</span></pre><p id="fadc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更改以下以<strong class="ih hj">粗体</strong>显示的变量，以匹配您的项目名称、地区和区域:</p><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="1515" class="lt jf hi lp b fi lu lv l lw lx">PROJECT_ID=<strong class="lp hj">sec-soft-chain</strong><br/>REGION=<strong class="lp hj">australia-southeast1</strong><br/>ZONE=<strong class="lp hj">australia-southeast1-b</strong></span></pre><p id="7e63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后运行这个脚本，脚本中的注释解释功能</p><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="3f30" class="lt jf hi lp b fi lu lv l lw lx"># Enable the Required API’s<br/>gcloud services enable container.googleapis.com<br/>gcloud services enable artifactregistry.googleapis.com<br/>gcloud services enable ondemandscanning.googleapis.com<br/>gcloud services enable cloudkms.googleapis.com<br/>gcloud services enable binaryauthorization.googleapis.com</span><span id="ebbf" class="lt jf hi lp b fi ly lv l lw lx"># Create a cluster for this demo, note these settings should not be used for a production cluster <br/>gcloud beta container - project $PROJECT_ID clusters create "software-secure-supply" - zone $ZONE - no-enable-basic-auth - cluster-version "1.22.8-gke.201" - release-channel "regular" - machine-type "e2-standard-4" - image-type "COS_CONTAINERD" - disk-type "pd-standard" - disk-size "100" - metadata disable-legacy-endpoints=true - scopes "<a class="ae jd" href="https://www.googleapis.com/auth/devstorage.read_only" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/devstorage.read_only</a>","<a class="ae jd" href="https://www.googleapis.com/auth/logging.write" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/logging.write</a>","<a class="ae jd" href="https://www.googleapis.com/auth/monitoring" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/monitoring</a>","<a class="ae jd" href="https://www.googleapis.com/auth/servicecontrol" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/servicecontrol</a>","<a class="ae jd" href="https://www.googleapis.com/auth/service.management.readonly" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/service.management.readonly</a>","<a class="ae jd" href="https://www.googleapis.com/auth/trace.append" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/trace.append</a>" - max-pods-per-node "110" - num-nodes "2" - logging=SYSTEM,WORKLOAD - monitoring=SYSTEM - enable-ip-alias - network "projects/$PROJECT_ID/global/networks/default" - subnetwork "projects/$PROJECT_ID/regions/$REGION/subnetworks/default" - no-enable-intra-node-visibility - default-max-pods-per-node "110" - no-enable-master-authorized-networks - addons HorizontalPodAutoscaling,HttpLoadBalancing,GcePersistentDiskCsiDriver - enable-autoupgrade - enable-autorepair - max-surge-upgrade 1 - max-unavailable-upgrade 1 - enable-shielded-nodes - node-locations $ZONE - enable-binauthz</span><span id="15dc" class="lt jf hi lp b fi ly lv l lw lx"># Create an Artifact Repository<br/>gcloud artifacts repositories create "${PROJECT_ID}-repo" - location=$REGION - repository-format=docker</span><span id="eed1" class="lt jf hi lp b fi ly lv l lw lx"># Allow the Cloud Build Service Account to run scans<br/>gcloud projects add-iam-policy-binding $PROJECT_ID - member=serviceAccount:$(gcloud projects describe $PROJECT_ID - format="value(projectNumber)")<a class="ae jd" href="http://twitter.com/cloudbuild" rel="noopener ugc nofollow" target="_blank">@cloudbuild</a>.gserviceaccount.com - role=roles/ondemandscanning.admin</span><span id="4f64" class="lt jf hi lp b fi ly lv l lw lx"># Allow the Cloud Build Service Account to deploy to GKE<br/>gcloud projects add-iam-policy-binding $PROJECT_ID - member=serviceAccount:$(gcloud projects describe $PROJECT_ID - format="value(projectNumber)")<a class="ae jd" href="http://twitter.com/cloudbuild" rel="noopener ugc nofollow" target="_blank">@cloudbuild</a>.gserviceaccount.com - role=roles/container.developer</span><span id="6962" class="lt jf hi lp b fi ly lv l lw lx"># Allow Cloud Build Service Account the permission to attest<br/>gcloud projects add-iam-policy-binding $PROJECT_ID - member=serviceAccount:$(gcloud projects describe $PROJECT_ID - format="value(projectNumber)")<a class="ae jd" href="http://twitter.com/cloudbuild" rel="noopener ugc nofollow" target="_blank">@cloudbuild</a>.gserviceaccount.com - role=roles/containeranalysis.notes.attacher</span></pre><h1 id="a90d" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置云源存储库</h1><ol class=""><li id="e76d" class="kt ku hi ih b ii kc im kd iq lz iu ma iy mb jc ky kz la lb bi translated">将<a class="ae jd" href="https://github.com/GoogleCloudPlatform/cloud-build-software-delivery" rel="noopener ugc nofollow" target="_blank">演示库</a>克隆到您的本地机器上，并将其复制到您自己的<a class="ae jd" href="https://source.cloud.google.com/repo/create" rel="noopener ugc nofollow" target="_blank">云资源</a>库中</li></ol><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="aebb" class="lt jf hi lp b fi lu lv l lw lx">git clone <a class="ae jd" href="https://github.com/GoogleCloudPlatform/cloud-build-software-delivery" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/cloud-build-software-delivery</a></span></pre><p id="c7dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.将克隆的回购推送到您自己的<a class="ae jd" href="https://source.cloud.google.com/repo/create)" rel="noopener ugc nofollow" target="_blank">云资源</a>存储库中:</p><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="4c5e" class="lt jf hi lp b fi lu lv l lw lx"># Create a repo called sec-soft-chain<br/>gcloud source repos create sec-soft-chain</span><span id="9216" class="lt jf hi lp b fi ly lv l lw lx"># Configure credentials<br/>gcloud init &amp;&amp; git config — global credential.<a class="ae jd" href="https://source.developers.google.com.helper" rel="noopener ugc nofollow" target="_blank">https://source.developers.google.com.helper</a> gcloud.sh</span><span id="6714" class="lt jf hi lp b fi ly lv l lw lx"># Add your new repo as a remote repo called google<br/>git remote add google <a class="ae jd" href="https://source.developers.google.com/p/$PROJECT_ID/r/sec-soft-chain" rel="noopener ugc nofollow" target="_blank">https://source.developers.google.com/p/$PROJECT_ID/r/sec-soft-chain</a></span><span id="4d90" class="lt jf hi lp b fi ly lv l lw lx"># Push code to the new repo called google<br/>git push — all google</span></pre><h1 id="c581" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">创建云构建触发器</h1><ol class=""><li id="d5d7" class="kt ku hi ih b ii kc im kd iq lz iu ma iy mb jc ky kz la lb bi translated">在云控制台中，转到<a class="ae jd" href="https://console.cloud.google.com/cloud-build/triggers" rel="noopener ugc nofollow" target="_blank">云构建触发器</a></li><li id="46d6" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">启用API(如果尚未启用)</li><li id="99e5" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">单击创建触发器</li><li id="f72f" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">在触发器设置窗口中，输入以下详细信息:</li></ol><ul class=""><li id="e557" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc lh kz la lb bi translated">在名称字段中，输入build-vulnz-deploy</li><li id="46fb" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">对于事件，选择“推送到分支”</li><li id="abf9" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">在存储库字段中，从菜单中选择您的存储库</li><li id="68ac" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">在“分行”字段中，输入“^main$”</li><li id="26d3" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">对于配置，选择云构建配置文件(yaml或json)</li><li id="4243" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">在Location中，选择Repository，输入默认值/cloudbuild.yaml</li></ul><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es mc"><img src="../Images/20ad8410efdd803ba9aaa5da85e9818f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1154/format:webp/1*RfSGZfjNH6f8emmV7LwF7A.png"/></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">云构建触发器</figcaption></figure><p id="7e82" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.添加以下替代变量对:</p><ul class=""><li id="2bf5" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc lh kz la lb bi translated">_IMAGE_NAME与来自云源存储库的图像</li><li id="7887" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">_COMPUTE_REGION的值为australia-southeast1(或您在开始时选择的区域)。</li><li id="e9eb" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">值为binauthz的_ KMS _密钥环</li><li id="4011" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">_KMS_LOCATION，值为澳大利亚-东南部1(或您在开始时选择的地区)。</li><li id="946c" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">值为VULNZ-证明者的_ VULNZ _证明者</li><li id="2b80" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">值为vulnz-signer的_VULNZ_KMS_KEY</li><li id="4fbb" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">_ VULNZ _ KMS _密钥_版本，值为1</li><li id="2e0b" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">_SONAR_LOGIN目前可以为空</li><li id="fb91" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">_SONAR_PROJECT目前可以是空白的</li><li id="8a91" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">_SONAR_ORG目前可以为空</li></ul><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es md"><img src="../Images/6c46918a50bc61c21be07f41bbe682f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*-OxIJAv1nYXLhqEoDj1blQ.png"/></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">替代变量</figcaption></figure><p id="9cbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.单击创建。</p><p id="21ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">恭喜你！！！</strong></p><p id="0fd3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">至此，您已经成功配置了CI/CD管道的大部分内容，不包括下面突出显示的两个阶段，您可以在此暂停，通过注释掉cloudbuild.yaml中的最后两个阶段来测试工作(第17–24行和第62–78行)。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/24fc3dfc8c0b6be7a686d49fc19f67b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RPDAq6fctl4cgRGl"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">强调2个步骤的安全CI/CD渠道</figcaption></figure><p id="8df7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将配置:</p><ol class=""><li id="8676" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">用于静态代码分析的Sonarqube</li><li id="a323" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">二元授权</li></ol><h1 id="6548" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">配置Sonarqube立方体</h1><h2 id="12dd" class="lt jf hi bd jg me mf mg jk mh mi mj jo iq mk ml js iu mm mn jw iy mo mp ka mq bi translated">修改cloudbuild.yaml</h2><p id="95cb" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">repo中的Cloudbuild.yaml文件需要一些更改，这些更改可以通过替换以下变量的每个实例来手动完成:</p><ul class=""><li id="9b3e" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc lh kz la lb bi translated"><zone/></li><li id="68dc" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated"><region/></li><li id="ec2e" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated"><repo/></li><li id="2882" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated"><image/></li><li id="36f7" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated"><project_id/></li></ul><p id="1c83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者下面的脚本应该按照前面配置的变量来设置这些:giot</p><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="951c" class="lt jf hi lp b fi lu lv l lw lx">sed -i “s/&lt;ZONE&gt;/$ZONE/g” cloudbuild.yaml<br/>sed -i “s/&lt;REGION&gt;/$REGION/g” cloudbuild.yaml<br/>sed -i “s/&lt;PROJECT_ID&gt;/$PROJECT_ID/g” cloudbuild.yaml<br/>sed -i “s/&lt;REPO&gt;/$PROJECT_ID-repo/g” cloudbuild.yaml<br/>sed -i “s/&lt;IMAGE&gt;/image/g” cloudbuild.yaml<br/>&lt;PROJECT_ID&gt;/&lt;REPO&gt;/&lt;IMAGE&gt;<br/>“${PROJECT_ID}-repo”<br/>$REGION-docker.pkg.dev/$PROJECT_ID/$PROJECT_ID-repo/</span></pre><h2 id="d556" class="lt jf hi bd jg me mf mg jk mh mi mj jo iq mk ml js iu mm mn jw iy mo mp ka mq bi translated">设置Sonarqube</h2><ol class=""><li id="5339" class="kt ku hi ih b ii kc im kd iq lz iu ma iy mb jc ky kz la lb bi translated">克隆<a class="ae jd" href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/sonarqube" rel="noopener ugc nofollow" target="_blank">sonar cube云构建器</a>库</li><li id="76fd" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">通过运行以下命令创建自定义生成器:</li></ol><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="e1c0" class="lt jf hi lp b fi lu lv l lw lx">git clone <a class="ae jd" href="https://github.com/GoogleCloudPlatform/cloud-builders-community" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/cloud-builders-community</a><br/>cd sonarqube<br/>gcloud builds submit . — config=cloudbuild.yaml</span></pre><p id="b0d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.配置sonar cube(我们将在线配置sonar cube，但是您也可以设置自己的sonar cube服务器并进行配置)。</p><p id="10e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用您的github帐户登录到<a class="ae jd" href="https://sonarcloud.io/" rel="noopener ugc nofollow" target="_blank"> https://sonarcloud.io </a></p><ul class=""><li id="f86a" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc lh kz la lb bi translated">通过导航到帐户页面创建令牌，然后单击安全选项卡</li><li id="d520" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">接下来，我们需要使用“分析新项目”选项在sonarcloud中设置项目。注意:使用手动设置选项</li><li id="85f4" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">记下您创建的令牌、项目密钥和组织名称</li><li id="801c" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">更新云构建触发变量:</li><li id="b693" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">_声纳_组织</li><li id="b409" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">_声纳_项目</li><li id="b4f1" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc lh kz la lb bi translated">_声纳_登录</li></ul><h1 id="65b6" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">二元授权</h1><p id="9831" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">注意:下面给出了从<a class="ae jd" href="https://cloud.google.com/architecture/binary-auth-with-cloud-build-and-gke" rel="noopener ugc nofollow" target="_blank">该</a>链接借用的简化动作列表</p><h2 id="5cf7" class="lt jf hi bd jg me mf mg jk mh mi mj jo iq mk ml js iu mm mn jw iy mo mp ka mq bi translated">使用云构建构建并注册自定义构建步骤</h2><ol class=""><li id="223e" class="kt ku hi ih b ii kc im kd iq lz iu ma iy mb jc ky kz la lb bi translated">克隆Google Cloud build社区回购:</li></ol><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="ad7e" class="lt jf hi lp b fi lu lv l lw lx"><em class="li">git clone </em><a class="ae jd" href="https://github.com/GoogleCloudPlatform/gke-binary-auth-tools" rel="noopener ugc nofollow" target="_blank"><em class="li">https://github.com/GoogleCloudPlatform/gke-binary-auth-tools</em></a><em class="li"> ~/binauthz-tools</em></span></pre><p id="3eb1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.为云构建配置二进制授权签名器:<br/>在使用之前，定制构建步骤的代码必须构建到一个容器中，并推送到云构建。为此，请运行以下命令:</p><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="3d98" class="lt jf hi lp b fi lu lv l lw lx"><em class="li">gcloud builds submit — project $PROJECT_ID — tag “gcr.io/$PROJECT_ID/cloudbuild-attestor” ~/binauthz-tools</em></span></pre><p id="87f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.定制构建步骤被推送到您当前项目的Google容器注册表中，现在可以使用了</p><h2 id="b2c9" class="lt jf hi bd jg me mf mg jk mh mi mj jo iq mk ml js iu mm mn jw iy mo mp ka mq bi translated">为签名证明创建云KMS <a class="ae jd" href="https://cloud.google.com/kms/docs/create-validate-signatures" rel="noopener ugc nofollow" target="_blank">非对称密钥</a>。</h2><ol class=""><li id="cf9c" class="kt ku hi ih b ii kc im kd iq lz iu ma iy mb jc ky kz la lb bi translated">在云Shell中，创建一个名为binauthz的云KMS密匙环:</li></ol><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="3147" class="lt jf hi lp b fi lu lv l lw lx">gcloud kms keyrings create “binauthz” \<br/> — project “${PROJECT_ID}” \<br/> — location “${REGION}”</span></pre><ol class=""><li id="6e15" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">创建名为vulnz-signer的非对称云KMS密钥，该密钥将用于签署和验证漏洞扫描证明:</li></ol><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="48b6" class="lt jf hi lp b fi lu lv l lw lx">gcloud kms keys create “vulnz-signer” \<br/> — project “${PROJECT_ID}” \<br/> — location “${REGION}” \<br/> — keyring “binauthz” \<br/> — purpose “asymmetric-signing” \<br/> — default-algorithm “rsa-sign-pkcs1–4096-sha512”</span></pre><h2 id="fab5" class="lt jf hi bd jg me mf mg jk mh mi mj jo iq mk ml js iu mm mn jw iy mo mp ka mq bi translated">创建一个名为vulnz-note的容器分析注释</h2><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="9488" class="lt jf hi lp b fi lu lv l lw lx">curl “<a class="ae jd" href="https://containeranalysis.googleapis.com/v1/projects/${PROJECT_ID}/notes/?noteId=vulnz-note" rel="noopener ugc nofollow" target="_blank">https://containeranalysis.googleapis.com/v1/projects/${PROJECT_ID}/notes/?noteId=vulnz-note</a>" \<br/> — request “POST” \<br/> — header “Content-Type: application/json” \<br/> — header “Authorization: Bearer $(gcloud auth print-access-token)” \<br/> — header “X-Goog-User-Project: ${PROJECT_ID}” \<br/> — data-binary @- &lt;&lt;EOF<br/>{<br/>“name”: “projects/${PROJECT_ID}/notes/vulnz-note”,<br/>“attestation”: {<br/>“hint”: {<br/>“human_readable_name”: “Vulnerability scan note”<br/>}<br/>}<br/>}<br/>EOF</span></pre><h2 id="e595" class="lt jf hi bd jg me mf mg jk mh mi mj jo iq mk ml js iu mm mn jw iy mo mp ka mq bi translated">在注释上授予CloudBuild服务帐户名权限</h2><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="8567" class="lt jf hi lp b fi lu lv l lw lx">​​curl “<a class="ae jd" href="https://containeranalysis.googleapis.com/v1/projects/${PROJECT_ID}/notes/vulnz-note:setIamPolicy" rel="noopener ugc nofollow" target="_blank">https://containeranalysis.googleapis.com/v1/projects/${PROJECT_ID}/notes/vulnz-note:setIamPolicy</a>" \<br/> — request POST \<br/> — header “Content-Type: application/json” \<br/> — header “Authorization: Bearer $(gcloud auth print-access-token)” \<br/> — header “X-Goog-User-Project: ${PROJECT_ID}” \<br/> — data-binary @- &lt;&lt;EOF<br/>{<br/>“resource”: “projects/${PROJECT_ID}/notes/vulnz-note”,<br/>“policy”: {<br/>“bindings”: [<br/>{<br/>“role”: “roles/containeranalysis.notes.occurrences.viewer”,<br/>“members”: [<br/>“serviceAccount:${CLOUD_BUILD_SA_EMAIL}”<br/>]<br/>},<br/>{<br/>“role”: “roles/containeranalysis.notes.attacher”,<br/>“members”: [<br/>“serviceAccount:${CLOUD_BUILD_SA_EMAIL}”<br/>]<br/>}<br/>]<br/>}<br/>}<br/>EOF</span></pre><h2 id="ce59" class="lt jf hi bd jg me mf mg jk mh mi mj jo iq mk ml js iu mm mn jw iy mo mp ka mq bi translated">创建漏洞扫描证明者:</h2><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="d95d" class="lt jf hi lp b fi lu lv l lw lx">gcloud container binauthz attestors create “vulnz-attestor” \<br/> — project “${PROJECT_ID}” \<br/> — attestation-authority-note-project “${PROJECT_ID}” \<br/> — attestation-authority-note “vulnz-note” \<br/> — description “Vulnerability scan attestor”</span></pre><h2 id="a26e" class="lt jf hi bd jg me mf mg jk mh mi mj jo iq mk ml js iu mm mn jw iy mo mp ka mq bi translated">为证明者的签名密钥添加公钥:</h2><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="e025" class="lt jf hi lp b fi lu lv l lw lx">gcloud beta container binauthz attestors public-keys add \<br/> — project “${PROJECT_ID}” \<br/> — attestor “vulnz-attestor” \<br/> — keyversion “1” \<br/> — keyversion-key “vulnz-signer” \<br/> — keyversion-keyring “binauthz” \<br/> — keyversion-location “${REGION}” \<br/> — keyversion-project “${PROJECT_ID}”</span></pre><h2 id="e220" class="lt jf hi bd jg me mf mg jk mh mi mj jo iq mk ml js iu mm mn jw iy mo mp ka mq bi translated">授予云构建服务帐户验证vulnz-证明者所做证明的权限:</h2><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="7536" class="lt jf hi lp b fi lu lv l lw lx">gcloud container binauthz attestors add-iam-policy-binding “vulnz-attestor” \<br/> — project “${PROJECT_ID}” \<br/> — member=serviceAccount:$(gcloud projects describe $PROJECT_ID — format=”value(projectNumber)”)<a class="ae jd" href="http://twitter.com/cloudbuild" rel="noopener ugc nofollow" target="_blank">@cloudbuild</a>.gserviceaccount.com \<br/> — role “roles/binaryauthorization.attestorsViewer”</span></pre><h2 id="8956" class="lt jf hi bd jg me mf mg jk mh mi mj jo iq mk ml js iu mm mn jw iy mo mp ka mq bi translated">授予云构建服务帐户使用vulnz-signer密钥对对象进行签名的权限:</h2><pre class="ki kj kk kl fd lo lp lq lr aw ls bi"><span id="1cc8" class="lt jf hi lp b fi lu lv l lw lx">gcloud kms keys add-iam-policy-binding “vulnz-signer” \<br/> — project “${PROJECT_ID}” \<br/> — location “${REGION}” \<br/> — keyring “binauthz” \<br/> — member serviceAccount:$(gcloud projects describe $PROJECT_ID — format=”value(projectNumber)”)<a class="ae jd" href="http://twitter.com/cloudbuild" rel="noopener ugc nofollow" target="_blank">@cloudbuild</a>.gserviceaccount.com \<br/> — role ‘roles/cloudkms.signerVerifier’</span></pre><h2 id="ff71" class="lt jf hi bd jg me mf mg jk mh mi mj jo iq mk ml js iu mm mn jw iy mo mp ka mq bi translated">配置二进制授权默认策略，如下所示</h2><figure class="ki kj kk kl fd km er es paragraph-image"><div class="ab fe cl mr"><img src="../Images/b0d82ccbf05f5723e1f2c6f486ba27af.png" data-original-src="https://miro.medium.com/v2/format:webp/1*zqwg_ydiDr9xMY0EqEVrUQ.png"/></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">二元授权策略</figcaption></figure><h1 id="7bf0" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">进一步的考虑</h1><ol class=""><li id="2086" class="kt ku hi ih b ii kc im kd iq lz iu ma iy mb jc ky kz la lb bi translated">专门构建的操作系统映像</li><li id="ca2b" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">减少攻击面(限制/禁用端口/用户/服务/包)</li><li id="6819" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">使用AppArmor &amp; Seccomp进行内核强化</li><li id="8f39" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">行为分析/Falco</li><li id="e628" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">管理秘密</li><li id="316a" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">定期升级</li><li id="35bb" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">限制API服务器访问</li><li id="bdd1" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">使用RBAC的最低权限访问</li><li id="89e6" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">小心使用服务帐户</li><li id="1f1a" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">CIS标杆管理</li><li id="b730" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">安全仪表板</li><li id="b74a" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">安全进入集群</li><li id="1d14" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">网络策略</li><li id="8923" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">审计</li></ol><p id="a1d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，这也贴在了我的<a class="ae jd" href="https://www.aviato.consulting/blog/" rel="noopener ugc nofollow" target="_blank">博客</a>和<a class="ae jd" href="https://github.com/GoogleCloudPlatform/cloud-build-software-delivery" rel="noopener ugc nofollow" target="_blank"> github </a>自述中的说明上</p></div></div>    
</body>
</html>