<html>
<head>
<title>ODBC, Private Service Connect and Proxies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ODBC、专用服务连接和代理</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/odbc-private-service-connect-and-proxies-fe041077b867?source=collection_archive---------0-----------------------#2021-10-22">https://medium.com/google-cloud/odbc-private-service-connect-and-proxies-fe041077b867?source=collection_archive---------0-----------------------#2021-10-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/31ce382cb57f688c6a6e45c44c961283.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9qWwTtZRzntxNR9DPlaGMQ.png"/></div></div></figure><p id="ea0e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最近，一个客户给了我一个难题。客户端有一个连接到GCP的本地网络，如下图所示。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jo"><img src="../Images/9a11e76c1c8cebed256745433e5df661.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LD88POFa0uNurmSR"/></div></div></figure><p id="6ba2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">客户网络上的笔记本电脑与局域网相连，当它们想访问互联网时，要通过一个出站代理服务器。内部网络也通过VPN连接到GCP VPC，该配置了一个<a class="ae jt" href="https://cloud.google.com/vpc/docs/private-service-connect" rel="noopener ugc nofollow" target="_blank">私有服务连接</a> (PSC)实例，提供到BigQuery的路由，该路由不涉及互联网上的路由。客户端还使用<a class="ae jt" href="https://cloud.google.com/vpc-service-controls" rel="noopener ugc nofollow" target="_blank"> VPC服务控件</a>到<em class="ju">来阻止</em>任何从互联网对BigQuery的访问，因为BigQuery数据库托管着极其敏感的数据。</p><p id="44dc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在笔记本电脑上，客户端使用一个SQL应用程序，该应用程序使用<a class="ae jt" href="https://cloud.google.com/bigquery/docs/reference/odbc-jdbc-drivers" rel="noopener ugc nofollow" target="_blank"> Simba ODBC驱动程序</a>访问BigQuery。当客户端运行他们的应用程序时，它无法连接到BigQuery。当我们检查这个难题时，我们发现Simba ODBC被硬编码为通过向<code class="du jv jw jx jy b">bigquery.googleapis.com</code>发送HTTPS请求来访问BigQuery。由于该域名解析为公共IP地址，笔记本电脑通过内部代理向互联网发送出站请求。GCP收到后拒绝了这一请求，因为它是通过因特网而不是通过VPC在国内发出的。这一限制是由PSC设置的。</p><p id="4ab1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们想要实现的是将来自笔记本电脑的BigQuery API请求路由到PSC进行处理。我们考虑了许多方法。</p><p id="9609" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一个是编辑本地笔记本电脑上的hosts文件，将域名解析<code class="du jv jw jx jy b">bigquery.googleapis.com</code>指向PSC的RFC 1918 IP地址。这是可行的，但是要求用户编辑文件的工作量和风险被认为太高了。</p><p id="c1d4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第二种可能性是覆盖整个企业的DNS名称服务器配置，创建从<code class="du jv jw jx jy b">bigquery.googleapis.com</code>到PSC的RFC 1918地址的映射。再次，这是经过测试和工作，但有一些不愉快的副作用。Simba ODBC文档要求映射:</p><ul class=""><li id="e298" class="jz ka hi is b it iu ix iy jb kb jf kc jj kd jn ke kf kg kh bi translated">bigquery.googleapis.com</li><li id="514c" class="jz ka hi is b it ki ix kj jb kk jf kl jj km jn ke kf kg kh bi translated">bigquerystorage.googleapis.com</li><li id="6e97" class="jz ka hi is b it ki ix kj jb kk jf kl jj km jn ke kf kg kh bi translated">oauth2.googleapis.com</li><li id="cbf8" class="jz ka hi is b it ki ix kj jb kk jf kl jj km jn ke kf kg kh bi translated"><a class="ae jt" href="http://www.googleapis.com" rel="noopener ugc nofollow" target="_blank">www.googleapis.com</a></li><li id="9cb8" class="jz ka hi is b it ki ix kj jb kk jf kl jj km jn ke kf kg kh bi translated">accounts.google.com</li></ul><p id="eceb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们改变企业范围的DNS映射，那么我们实际上是要求<strong class="is hj">整个<strong class="is hj">企业中的所有</strong>流量通过PSC为这些名称进行路由，这可能会产生比我们想要实现的更广泛的影响，而不仅仅是为了我们自己的ODBC使用。</strong></p><p id="eb67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">经过更深入的调查，一种新的方法出现了。Simba ODBC驱动程序允许配置HTTP代理。这意味着，当驱动程序希望发出一个API请求(例如对BigQuery)时，驱动程序将把请求发送给HTTP代理，HTTP代理将代表驱动程序发出请求，而不是直接发出请求<em class="ju"/>。</p><p id="1dae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以形象地看到这一点。当源系统向目标系统发出HTTP请求时，源系统通常会直接发出请求。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es kn"><img src="../Images/edd58e06865fecf8d1fcfbb0633100df.png" data-original-src="https://miro.medium.com/v2/resize:fit:740/0*OBNovhkSKysqCGf3"/></div></figure><p id="a3b4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当引入代理时，画面变为:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es kn"><img src="../Images/8308924254eb5cdea30769040bd5c18e.png" data-original-src="https://miro.medium.com/v2/resize:fit:740/0*lDYyDxxs-9_lGXcD"/></div></figure><p id="31c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如前所述，源<em class="ju">认为</em>它正在向目标发送请求，但是请求被发送到代理，代理向前发送请求。代理可以选择改变<em class="ju">实际</em>路线的走向。这意味着代理可以将源<em class="ju">认为</em>正在发送给<code class="du jv jw jx jy b">bigquery.googleapis.com</code>的请求发送到其他地方。这样做的价值在于，不需要在源位置进行任何配置更改。</p><p id="f1de" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们将它添加到我们的图中，我们现在可以看到在GCP中引入了一个代理，它成为Simba ODBC驱动程序的目标，该驱动程序知道将请求路由到PSC。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/2daf525c2afc0783f69e52bf999016e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*04vCcrS-odgGrIp8"/></div></div></figure><p id="2bb9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这感觉像是一个优雅的解决方案。一个缺点是我们需要配置和管理代理。现在让我们浏览一个示例配置，看看它是如何工作的。</p><ol class=""><li id="35ea" class="jz ka hi is b it iu ix iy jb kb jf kc jj kd jn kp kf kg kh bi translated">在IP地址10.1.0.1创建专用服务连接定义。</li><li id="bb0d" class="jz ka hi is b it ki ix kj jb kk jf kl jj km jn kp kf kg kh bi translated">创建一个运行Linux的计算引擎，作为我们的代理。</li><li id="ca9d" class="jz ka hi is b it ki ix kj jb kk jf kl jj km jn kp kf kg kh bi translated">安装代理服务器。在我们的例子中，我们将使用<a class="ae jt" href="http://tinyproxy.github.io/" rel="noopener ugc nofollow" target="_blank"> tinyproxy </a>:</li></ol><pre class="jp jq jr js fd kq jy kr ks aw kt bi"><span id="98ee" class="ku kv hi jy b fi kw kx l ky kz">sudo apt-get install tinyproxy</span></pre><p id="beab" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.编辑<code class="du jv jw jx jy b">/etc/tinyproxy/tinyproxy.conf</code>文件</p><p id="d3af" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">加注释</p><p id="42cf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jv jw jx jy b">Allow 127.0.0.1</code></p><p id="7b75" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">变原注释为软件一部分</p><p id="7e14" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jv jw jx jy b">Filter "/etc/tinyproxy/filter"</code></p><p id="adee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">变原注释为软件一部分</p><p id="fd92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jv jw jx jy b">FilterDefaultDeny Yes</code></p><p id="9582" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.编辑<code class="du jv jw jx jy b">/etc/tinyproxy/filter</code></p><p id="e50f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">指定我们希望允许的域名。所有其他域名将被阻止。这将确保没有恶意访问可以使用代理。</p><pre class="jp jq jr js fd kq jy kr ks aw kt bi"><span id="309a" class="ku kv hi jy b fi kw kx l ky kz">^bigquery\.googleapis\.com$<br/>^oauth2\.googleapis\.com$</span></pre><p id="2e85" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.编辑<code class="du jv jw jx jy b">/etc/hosts</code>并更改:</p><pre class="jp jq jr js fd kq jy kr ks aw kt bi"><span id="366f" class="ku kv hi jy b fi kw kx l ky kz">10.1.0.1 bigquery.googleapis.com<br/>10.1.0.1 oauth2.googleapis.com</span></pre><p id="3e4a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将导致这些域名的解析指向10.1.0.1的PSC条目。</p><p id="e7e0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">7.停止tinyproxy以使更改生效。</p><pre class="jp jq jr js fd kq jy kr ks aw kt bi"><span id="af2a" class="ku kv hi jy b fi kw kx l ky kz">sudo service tinyproxy stop</span></pre><p id="fd46" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">8.重新启动tinyproxy以启动服务请求。</p><pre class="jp jq jr js fd kq jy kr ks aw kt bi"><span id="60aa" class="ku kv hi jy b fi kw kx l ky kz">sudo service tinyproxy start</span></pre><p id="b360" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">9.在Windows机器上，打开ODBC定义并设置代理条目:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es la"><img src="../Images/e6334df689be01d8aa71c5813aa88ae0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*p4yXUSl_gUtdw_H9"/></div></div></figure><p id="ba9e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为<code class="du jv jw jx jy b">Proxy Host</code>指定计算引擎的IP地址，为<code class="du jv jw jx jy b">Proxy Port</code>指定8888。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es lb"><img src="../Images/bc502dc85cd779ed08914c83676fddce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/0*KaNSvvmIaOKlMJFZ"/></div></figure><p id="9128" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">单击test按钮，我们应该会看到结果:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es lc"><img src="../Images/f2501522e8c848f2077bad5e2b3d579c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/0*Mn61z5xJCjGAhDrB"/></div></figure><p id="a2b8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">10.使用ODBC SQL工具查看表的内容，例如<a class="ae jt" href="https://razorsql.com/" rel="noopener ugc nofollow" target="_blank"> RazorSQL </a>。</p><p id="cf3d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">总结</strong>:按照这个方法，我们已经展示了我们可以配置Simba ODBC驱动程序来使用我们已经安装在计算引擎上的HTTP代理。计算引擎上域名解析导致源自Simba ODBC的API调用被发送到私有服务连接IP地址，从而无需通过互联网且无需在托管Simba ODBC驱动程序的机器上“修补”DNS名称就能得到满足。</p><figure class="jp jq jr js fd ij"><div class="bz dy l di"><div class="ld le l"/></div></figure></div></div>    
</body>
</html>