<html>
<head>
<title>Build the world’s largest IoT with RasPi and Google BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用RasPi和Google BigQuery构建世界上最大的物联网</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/build-the-world-s-largest-iot-with-raspi-and-google-bigquery-169b332d02b1?source=collection_archive---------2-----------------------#2015-07-17">https://medium.com/google-cloud/build-the-world-s-largest-iot-with-raspi-and-google-bigquery-169b332d02b1?source=collection_archive---------2-----------------------#2015-07-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="804a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我用拉斯皮建造的气象站。我在周末只花了几个小时就建成了这个，但它已经能够部署世界上最大的物联网平台。为什么？因为它直接将指标发送给<a class="ae jd" href="https://cloud.google.com/bigquery/" rel="noopener ugc nofollow" target="_blank"> Google BigQuery </a>，这个来自Google云平台的大规模并行查询引擎能够每秒收集<strong class="ih hj">一百万行指标</strong>，并在10秒内对<strong class="ih hj">万亿字节的数据执行查询</strong>。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/9a616ea767bd4c8d116519ae2b419494.png" data-original-src="https://miro.medium.com/v2/resize:fit:932/format:webp/0*AC4y23wNyqKVFebj.png"/></div></figure><p id="3bce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以，你现在就可以开始部署数百万个这样的盒子来收集世界各地的温度、湿度和大气压力(或者任何指标，如果你加上传感器的话)。我不需要再做任何事情来构建大型分布式前端、负载平衡器、应用服务器和超快速数据库集群，以及扩展、故障转移、复制等，这些都是构建大型生产物联网平台所需的复杂性。BigQuery在谷歌最大的数据中心拥有谷歌的规模和质量。</p><p id="83a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">RasPi box运行一个简单的<a class="ae jd" href="https://github.com/kazunori279/raspi/tree/master/weather_report" rel="noopener ugc nofollow" target="_blank"> Python代码</a>将指标发送给BigQuery，big query将汇总这些指标并在Google电子表格上显示为图形。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="er es jm"><img src="../Images/ef9a0dcf6964beeb39afd09e4701788c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eyRzMqyFJ5-UqtAZ.png"/></div></div></figure><p id="1529" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">建造这个的总成本不到100美元。你只需要买RasPi盒子，买几个传感器就行了。谷歌电子表格是免费的。Google BigQuery非常便宜:存储成本是20美分/ GB /月，每次查询1亿行的查询成本是几美分。最重要的是，这是一项完全托管的服务。你不必雇佣数十名高级工程师来构建和运营世界上最大的大数据集群。</p><p id="471a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们来看看你如何在周末建造这个盒子。</p><h1 id="426b" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">将传感器连接到RasPi</h1><p id="0c9a" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">以下是您需要购买的零件:</p><ul class=""><li id="c82f" class="ku kv hi ih b ii ij im in iq kw iu kx iy ky jc kz la lb lc bi translated"><a class="ae jd" href="http://amzn.com/B00T2U7R7I" rel="noopener ugc nofollow" target="_blank"> RasPi </a>，<a class="ae jd" href="http://amzn.com/B00ELL7F1G" rel="noopener ugc nofollow" target="_blank"> NOOBS SD卡</a>，<a class="ae jd" href="http://amzn.com/B003MTTJOY" rel="noopener ugc nofollow" target="_blank"> USB WiFi </a></li><li id="3ceb" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">RasPi的USB电源</li><li id="6c5a" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae jd" href="http://amzn.com/B00SK6940I" rel="noopener ugc nofollow" target="_blank"> DHT22 </a>，温湿度传感器</li><li id="9638" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">DHT 22的电阻器(5K至10K欧姆)</li><li id="4990" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae jd" href="http://www.mouser.com/newproducts/newproductsmanufacturers.aspx?mfg=stmicroelectronics&amp;virtualdir=stmlps331/" rel="noopener ugc nofollow" target="_blank"> LPS331 </a>，大气压力传感器</li><li id="9530" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">试验板和跳线</li></ul><p id="dd9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过使用NOOBS的SD卡，它很容易设置RasPi。USB WiFi也应该很容易用操作系统的配置工具来设置。</p><p id="0bef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要将传感器连接到RasPi，请参考以下页面:</p><ul class=""><li id="df7c" class="ku kv hi ih b ii ij im in iq kw iu kx iy ky jc kz la lb lc bi translated"><a class="ae jd" href="https://learn.adafruit.com/dht-humidity-sensing-on-raspberry-pi-with-gdocs-logging/overview" rel="noopener ugc nofollow" target="_blank">树莓皮上的DHT湿度感应</a></li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es li"><img src="../Images/cb1d3277eb0e902bdf29bb5a1625cead.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/0*VnUp7SONa9cZO9T7.png"/></div></figure><p id="4f9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">来自<a class="ae jd" href="https://learn.adafruit.com/dht-humidity-sensing-on-raspberry-pi-with-gdocs-logging/overview" rel="noopener ugc nofollow" target="_blank">树莓皮上的DHT湿度感应</a></p><p id="c622" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不需要特殊的电路。您可以用试验板将RasPi的GPIO引脚连接到传感器。一个警告是，你必须让DHT22远离RasPi box，以避免来自CPU的热量。对于LPS331，您可以使用能够连接到RasPi的任何其他压力传感器。</p><h1 id="6a19" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">用Ansible安装驱动程序</h1><p id="4de2" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">为传感器编写驱动程序并不容易。尤其是DHT22需要一点努力。但是使用RasPi很酷的一点是你可以在GitHub 上找到它们<a class="ae jd" href="https://learn.adafruit.com/dht-humidity-sensing-on-raspberry-pi-with-gdocs-logging/software-install-updated" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="ed83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一件很酷的事情是RasPi是一个Linux。您可以使用如下的Ansible Playbook在GitHub上为传感器安装驱动程序。</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="b1e4" class="lo js hi lk b fi lp lq l lr ls">    # Adafruit DHT drivers<br/>    - git: repo=git@github.com:adafruit/Adafruit_Python_DHT.git<br/>           dest={{ dht_dir }} accept_hostkey=yes<br/>      sudo: no<br/>    - command: python setup.py install chdir={{ dht_dir }}</span></pre><p id="48f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽管您可能需要等待一段时间才能完成行动手册的执行:)</p><h1 id="d44f" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">用Python解码传感器值</h1><p id="f270" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">LPS331压力传感器使用I2C总线协议进行通信。使用Python，可以使用i2ctools命令从传感器读取值。</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="9cc9" class="lo js hi lk b fi lp lq l lr ls">def cmd_exec(cmd):<br/>    p = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)<br/>    stdout, stderr = p.communicate()<br/>    if stderr != None and len(stderr.strip()) &gt; 0:<br/>        raise IOError("Error on executing cmd: " + stderr)<br/>    return stdout.strip()<br/><br/>def i2cget(reg):<br/>    return cmd_exec("i2cget -y 1 " + LPS331_ADRS + " " + reg)</span></pre><p id="01b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该代码允许您将i2cget命令作为子进程执行。这样你就可以从I2C电阻器上读取数值来计算压力值。</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="b9bf" class="lo js hi lk b fi lp lq l lr ls">def read_lps():<br/><br/>    # reading from LPS<br/>    out0 = i2cget("0x28")<br/>    out1 = i2cget("0x29")<br/>    out2 = i2cget("0x2a")<br/><br/>    # decoding the value<br/>    return (int(out0, 16) + (int(out1, 16) * 0x100) + (int(out2, 16) * 0x10000)) / 4096.0</span></pre><p id="67b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用Adafruit Python驱动程序可以轻松读取DHT22温度和湿度传感器。</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="9683" class="lo js hi lk b fi lp lq l lr ls"># read humidity and temp from DHT <br/>humidity, temp = Adafruit_DHT.read_retry(Adafruit_DHT.DHT22, DHT22_GPIO)</span></pre><h1 id="ff26" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">使用Fluentd发送到BigQuery</h1><p id="23dc" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">现在已经准备好将指标发送给BigQuery了。您可以使用流行的开源日志收集器<a class="ae jd" href="https://cloud.google.com/solutions/real-time/fluentd-bigquery" rel="noopener ugc nofollow" target="_blank"> Fluentd </a>来完成这项工作。以下是安装Fluentd及其BigQuery插件的Ansible行动手册:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="7c47" class="lo js hi lk b fi lp lq l lr ls">    # Fluentd<br/>    - command: aptitude install ruby-dev<br/>    - command: gem install fluentd<br/><br/>    # pip, fluent-logger-python, fluent-plugin-bigquery<br/>    - command: aptitude install python-pip<br/>    - command: pip install fluent-logger<br/>    - command: fluent-gem install fluent-plugin-bigquery</span></pre><p id="5590" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在fluentd.conf上，可以添加以下配置来接收来自fluent-logger-python的事件日志，并将其转发给fluent-plugin-bigquery。</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="450c" class="lo js hi lk b fi lp lq l lr ls">&lt;source&gt;<br/>  type forward <br/>  port 24224<br/>&lt;/source&gt;<br/><br/>&lt;match weather.**&gt;<br/>  type bigquery<br/><br/>  method insert<br/><br/>  auth_method private_key<br/>  email YOUR_SERVICE_ACCOUNT_EMAIL <br/>  private_key_path YOUR_PRIVATE_KEY_FILE_PATH <br/><br/>  project YOUR_PROJECT_ID <br/>  dataset YOUR_DATASET <br/>  table YOUR_TABLE_NAME <br/><br/>  time_format %s<br/>  time_field time<br/><br/>  fetch_schema true<br/>  field_integer time<br/>&lt;/match&gt;</span></pre><p id="da4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Python代码中，使用fluent-logger-python API将指标发送到Fluentd。</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="998f" class="lo js hi lk b fi lp lq l lr ls">    # write metrics to local fluentd<br/>    event.Event("metrics", {<br/>        "atmos": atmos,<br/>        "hum": humidity,<br/>        "temp": temp<br/>    })</span></pre><h1 id="3670" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">在BigQuery上创建一个表和键</h1><p id="7170" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">接下来，设置BigQuery从Fluentd接收事件日志。如果这是你第一次开始使用查询服务，请看看<a class="ae jd" href="https://cloud.google.com/bigquery/sign-up" rel="noopener ugc nofollow" target="_blank">入门指南</a>准备一个Google云平台项目和BigQuery数据集。</p><p id="5c93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于这个演示，我创建了一个BigQuery表来接收指标。如果您想从多个设备收集指标，可能需要添加一个列来保存每个设备的id。</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="c4f5" class="lo js hi lk b fi lp lq l lr ls">[<br/>  {<br/>    "name": "time",<br/>    "type": "INTEGER"<br/>  },<br/>  {<br/>    "name": "hum",<br/>    "type": "FLOAT"<br/>  },<br/>  {<br/>    "name": "temp",<br/>    "type": "FLOAT"<br/>  },<br/>  {<br/>    "name": "atmos",<br/>    "type": "FLOAT"<br/>  }<br/>]</span></pre><p id="b94e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过使用<a class="ae jd" href="https://cloud.google.com/bigquery/bq-command-line-tool" rel="noopener ugc nofollow" target="_blank"> bq命令</a>，执行下面一行来创建一个具有上述模式的表。</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="7533" class="lo js hi lk b fi lp lq l lr ls">&gt; bq mk -t &lt;your-project-id&gt;:&lt;your_dataset&gt;.weather_report wr_bqschema.json</span></pre><p id="f0de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，创建一个私钥，从RasPi框连接到BigQuery。在Google开发者控制台，打开API和auth菜单，为服务帐户创建一个新的客户端ID。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lt"><img src="../Images/1a080bdc888caf189b2f37da699c1e24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/format:webp/0*L-deP62kpdI_RMgb.png"/></div></figure><p id="21d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将开始下载私钥。将密钥复制到RasPi框，并编辑fluentd.conf以将private_key_path字段设置为密钥文件的路径。此外，将电子邮件字段设置为服务帐户的电子邮件地址。</p><h1 id="59f4" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">在BigQuery上执行查询</h1><p id="f770" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">现在它准备尝试。在RasPi上，执行以下命令来启动Fluentd。</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="df57" class="lo js hi lk b fi lp lq l lr ls">&gt; fluentd -c fluentd.conf</span></pre><p id="8d96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并打开另一个shell来执行python代码。</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="5ace" class="lo js hi lk b fi lp lq l lr ls">&gt; sudo python weather_report.py</span></pre><p id="4d81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果运行成功，您将在控制台上看到任何内容。转到BigQuery控制台并执行以下SQL。</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="cd31" class="lo js hi lk b fi lp lq l lr ls">SELECT <br/>  LEFT(STRING(SEC_TO_TIMESTAMP(time)), 15) + '0:00' as time,   <br/>  AVG(temp) as temp,<br/>  AVG(hum) as hum, <br/>  AVG(atmos) as atmos <br/>FROM [YOUR_PROJ:YOUR_DATASET.weather_report] <br/>GROUP BY time <br/>ORDER BY time DESC</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="er es lu"><img src="../Images/a2b926fa4e9149a06774326941ac04db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nbEYrqP2yI1hIcSD.png"/></div></div></figure><p id="3e74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">听起来很有效！这个查询聚集了10分钟的平均指标，并使用时间戳对它们进行排序。</p><p id="f896" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为它运行在BigQuery上，所以即使您收集了1000亿行指标，您也可以在10秒钟内获得这个查询的结果。请参见<a class="ae jd" href="https://cloud.google.com/files/BigQueryTechnicalWP.pdf" rel="noopener ugc nofollow" target="_blank">这份白皮书</a>，了解为什么这是可能的。简而言之，该服务为每一个查询并行运行<strong class="ih hj">数千个服务器</strong>。</p><p id="3c6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以将任意数量的物联网设备(电器、汽车、移动设备、工厂机械等中的传感器)的任何指标发送到BigQuery，而无需担心可扩展性和可用性。</p><h1 id="ca61" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">用谷歌电子表格绘制图表</h1><p id="4cbe" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">通过使用Google Spreadsheet和它的Google Apps脚本，您可以从中执行BigQuery查询，并根据结果绘制图表。请查看<a class="ae jd" href="https://cloud.google.com/solutions/real-time/fluentd-bigquery" rel="noopener ugc nofollow" target="_blank">使用Fluentd和BigQuery的实时日志分析</a>来了解如何做到这一点。不需要自己写剧本。你只需复制文档中的工作表和脚本，并使用它来绘制这样的图形。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lv"><img src="../Images/5bae0b6c31a66afb64d0a3b29c46044a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/0*cU8WtB9oDXt4yGFb.png"/></div></figure><p id="fa4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如您在本文中看到的，使用RasPi非常有趣，尤其是当您将它与强大的云工具(如BigQuery和Fluentd)连接起来时。即使这只是周末的一个爱好，你也可以在不花太多钱的情况下获得完全托管、高度可扩展和可用的物联网平台。</p><p id="6fa7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本演示的示例代码可在<a class="ae jd" href="https://github.com/kazunori279/raspi/tree/master/weather_report" rel="noopener ugc nofollow" target="_blank"> my GitHub repo </a>上获得。</p></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><p id="9af1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="md">原载于</em><a class="ae jd" href="http://qiita.com/kazunori279/items/0f8d827ac9966c9804ab" rel="noopener ugc nofollow" target="_blank"><em class="md">qiita.com</em></a><em class="md">。</em></p></div></div>    
</body>
</html>