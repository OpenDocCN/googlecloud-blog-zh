<html>
<head>
<title>[Python] Fast export large database tables — using GCP Serverless Dataproc</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">[Python]快速导出大型数据库表—使用GCP无服务器Dataproc</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/python-fast-export-large-database-tables-using-gcp-serverless-dataproc-bfe77a132485?source=collection_archive---------2-----------------------#2022-09-15">https://medium.com/google-cloud/python-fast-export-large-database-tables-using-gcp-serverless-dataproc-bfe77a132485?source=collection_archive---------2-----------------------#2022-09-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="83e3" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">将大型表从任何JDBC (MySQL、PostgreSQL、MSSQL)导入到BigQuery</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ix"><img src="../Images/d3f8dbf55fd5fc77050ec4617d611801.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dy-kK-Nea0XDZyOcOJJ99A.png"/></div></figure><p id="42ce" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">Dataproc Serverless是Google Cloud Dataproc平台的一个很好的补充。它允许用户运行Spark工作负载，而无需配置或管理集群。Dataproc Serverless只是在幕后管理所有需要的基础设施。</p><p id="59c3" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">Dataproc模板为我们提供了这些工作负载的常见用例，而不需要我们自己开发。这些模板也让我们快速定制和运行它们。</p><h2 id="03b8" class="kb kc hi bd kd ke kf kg kh ki kj kk kl jo km kn ko js kp kq kr jw ks kt ku kv bi translated">介绍</h2><p id="3fe4" class="pw-post-body-paragraph jf jg hi jh b ji kw ij jk jl kx im jn jo ky jq jr js kz ju jv jw la jy jz ka hb bi translated">如果您需要快速导入/导出100 GBs-TBs的大型表，请采用多线程并行导入/导出数据的方法，并使用可靠、成熟、开源和加固的机制。这篇文章可能对你有所帮助。</p><p id="ea49" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">让我们使用<a class="ae lb" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/python/dataproc_templates/jdbc/README.md" rel="noopener ugc nofollow" target="_blank"> JDBCToBigQuery </a>模板以快速、高效和多线程的方式导出表格。</p><h2 id="d9a8" class="kb kc hi bd kd ke kf kg kh ki kj kk kl jo km kn ko js kp kq kr jw ks kt ku kv bi translated">要求</h2><ul class=""><li id="54cd" class="lc ld hi jh b ji kw jl kx jo le js lf jw lg ka lh li lj lk bi translated">使用任何预装Python 3.7+，Git和<a class="ae lb" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank"> gcloud CLI </a>的机器。<br/>或者使用预装了这些工具的云壳。</li><li id="ba0a" class="lc ld hi jh b ji ll jl lm jo ln js lo jw lp ka lh li lj lk bi translated">启用了专用Google访问的VPC子网。默认子网是合适的，只要启用了私有Google访问。您可以在这里查看所有的Dataproc无服务器网络需求<a class="ae lb" href="https://cloud.google.com/dataproc-serverless/docs/concepts/network" rel="noopener ugc nofollow" target="_blank"/>。</li></ul><h1 id="2322" class="lq kc hi bd kd lr ls lt kh lu lv lw kl io lx ip ko ir ly is kr iu lz iv ku ma bi translated">简单用法</h1><p id="6f73" class="pw-post-body-paragraph jf jg hi jh b ji kw ij jk jl kx im jn jo ky jq jr js kz ju jv jw la jy jz ka hb bi translated">这种方法不是多线程的，所以它适用于小于1Gb的表。</p><ol class=""><li id="4c08" class="lc ld hi jh b ji jj jl jm jo mb js mc jw md ka me li lj lk bi translated">[建议]克隆您的活动实例，或创建读取副本。出于一致性目的，建议暂停对源数据库的写入。</li><li id="1253" class="lc ld hi jh b ji ll jl lm jo ln js lo jw lp ka me li lj lk bi translated">确保可以从VPC网络访问您的数据库。如果使用公共数据库，请确保启用云NAT。请参考<a class="ae lb" href="https://cloud.google.com/dataproc-serverless/docs/concepts/network" rel="noopener ugc nofollow" target="_blank">本</a>了解更多信息。</li><li id="f4f4" class="lc ld hi jh b ji ll jl lm jo ln js lo jw lp ka me li lj lk bi translated">为jar文件创建一个GCS存储桶和暂存位置。为各自的源数据库下载<a class="ae lb" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/python/dataproc_templates/jdbc/README.md" rel="noopener ugc nofollow" target="_blank"> JDBC驱动jar </a>，以及<a class="ae lb" href="https://cloud.google.com/dataproc/docs/tutorials/bigquery-connector-spark-example" rel="noopener ugc nofollow" target="_blank">big query connector with Spark</a>。将这些jar文件上传到GCS Bucket中。</li><li id="3372" class="lc ld hi jh b ji ll jl lm jo ln js lo jw lp ka me li lj lk bi translated">克隆Dataproc模板git repo:</li></ol><pre class="iy iz ja jb fd mf mg mh mi aw mj bi"><span id="3175" class="kb kc hi mg b fi mk ml l mm mn">git clone <a class="ae lb" href="https://github.com/GoogleCloudPlatform/dataproc-templates.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/dataproc-templates.git</a><br/>cd dataproc-templates/python</span></pre><p id="7ec8" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">5.获取身份验证凭据:</p><pre class="iy iz ja jb fd mf mg mh mi aw mj bi"><span id="15a2" class="kb kc hi mg b fi mk ml l mm mn">gcloud auth application-default login</span></pre><p id="b970" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">6.执行模板，有关更多详细信息，请参考<a class="ae lb" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/python/dataproc_templates/jdbc/README.md" rel="noopener ugc nofollow" target="_blank"> JDBCToBigQuery </a>文档。替换环境值以匹配您的情况(gcp项目、区域、jdbc url、jar路径等。)</p><pre class="iy iz ja jb fd mf mg mh mi aw mj bi"><span id="def7" class="kb kc hi mg b fi mk ml l mm mn">export GCP_PROJECT=my-gcp-proj \<br/>export REGION=us-central1  \<br/>export SUBNET=projects/my-gcp-proj/regions/us-central1/subnetworks/default   \<br/>export GCS_STAGING_LOCATION=gs://my-gcp-proj/mysql-export/staging \<br/>export JARS="gs://my-gcp-proj/mysql-export/mysql-connector-java-8.0.17.jar,gs://my-gcp-proj/bigquery-jar/spark-bigquery-with-dependencies_2.12-0.23.2.jar"</span><span id="e21d" class="kb kc hi mg b fi mo ml l mm mn">./bin/start.sh \<br/>-- --template=JDBCTOBIGQUERY \<br/>--jdbc.bigquery.input.url="jdbc:mysql://1.1.1.1:3306/mydb?user=root&amp;password=password123" \<br/>--jdbc.bigquery.input.driver="com.mysql.cj.jdbc.Driver" \<br/>--jdbc.bigquery.input.table="(select * from employees where id &lt; 10) as employees" \<br/>--jdbc.bigquery.output.mode="overwrite" \<br/>--jdbc.bigquery.output.dataset="bq-dataset" \<br/>--jdbc.bigquery.output.table="bq-table" \<br/>--jdbc.bigquery.temp.bucket.name="temp-bq-bucket-name"</span></pre><p id="0156" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">注意</strong>:如果还没有启用，它会要求您启用Dataproc API。</p><h1 id="7245" class="lq kc hi bd kd lr ls lt kh lu lv lw kl io lx ip ko ir ly is kr iu lz iv ku ma bi translated">高级用法(多线程导出/导入)</h1><p id="b69f" class="pw-post-body-paragraph jf jg hi jh b ji kw ij jk jl kx im jn jo ky jq jr js kz ju jv jw la jy jz ka hb bi translated">假设您在mysql数据库中有一个Employee表模式，如下所示:</p><pre class="iy iz ja jb fd mf mg mh mi aw mj bi"><span id="4368" class="kb kc hi mg b fi mk ml l mm mn">CREATE TABLE `employee` (<br/>  `id` bigint(20) unsigned NOT NULL,<br/>  `name` varchar(100) NOT NULL,<br/>  `email` varchar(100) NOT NULL,<br/>  `current_salary` int unsigned DEFAULT NULL,<br/>  `account_id` bigint(20) unsigned NOT NULL,<br/>  `department` varchar(100) DEFAULT NULL,<br/>  `created_at` datetime NOT NULL,<br/>  `updated_at` datetime NOT NULL,<br/>  PRIMARY KEY (`id`)<br/>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;</span></pre><p id="473e" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">假设最大雇员id为1亿(用于upperBound参数)。</p><p id="7f0c" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">按照上一节所述执行步骤1-4。<br/>通过指定分区属性来更改步骤6。</p><p id="ef0a" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">执行spark作业和分区参数，示例如下:</p><pre class="iy iz ja jb fd mf mg mh mi aw mj bi"><span id="e158" class="kb kc hi mg b fi mk ml l mm mn">export GCP_PROJECT=my-gcp-proj \<br/>export REGION=us-central1  \<br/>export SUBNET=projects/my-gcp-proj/regions/us-central1/subnetworks/default   \<br/>export GCS_STAGING_LOCATION=gs://my-gcp-proj/mysql-export/staging \<br/>export JARS="gs://my-gcp-proj/mysql-export/mysql-connector-java-8.0.17.jar,gs://my-gcp-proj/bigquery-jar/spark-bigquery-with-dependencies_2.12-0.23.2.jar"</span><span id="589d" class="kb kc hi mg b fi mo ml l mm mn">./bin/start.sh \<br/>-- --template=JDBCTOBIGQUERY \<br/>--jdbc.bigquery.input.url="jdbc:mysql://1.1.1.1:3306/mydb?user=root&amp;password=password123" \<br/>--jdbc.bigquery.input.driver="com.mysql.cj.jdbc.Driver" \<br/>--jdbc.bigquery.input.table="(select * from employees where id &lt; 10) as employees" \<br/>--jdbc.bigquery.output.mode="overwrite" \<br/>--jdbc.bigquery.output.dataset="bq-dataset" \<br/>--jdbc.bigquery.output.table="bq-table" \<br/>--jdbc.bigquery.temp.bucket.name="temp-bq-bucket-name" \<br/><strong class="mg hj">--jdbc.bigquery.input.partitioncolumn=id \<br/>--jdbc.bigquery.input.lowerbound=0 \<br/>--jdbc.bigquery.input.upperbound=100000000 \<br/>--jdbc.bigquery.input.numpartitions=400 \</strong></span></pre><h1 id="3a78" class="lq kc hi bd kd lr ls lt kh lu lv lw kl io lx ip ko ir ly is kr iu lz iv ku ma bi translated">另一个目标</h1><ol class=""><li id="26df" class="lc ld hi jh b ji kw jl kx jo le js lf jw lg ka me li lj lk bi translated"><strong class="jh hj">另一个数据库</strong> <br/> Spark JDBC原生支持以下数据库MySQL / MariaDB、Postgresql、DB2、Oracle。使用<a class="ae lb" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/main/java/src/main/java/com/google/cloud/dataproc/templates/gcs/README.md#3-gcs-to-jdbc" rel="noopener ugc nofollow" target="_blank"> <strong class="jh hj"> GCSToJDBC </strong> </a>模板(<a class="ae lb" rel="noopener" href="/google-cloud/importing-data-from-gcs-to-databases-via-jdbc-using-dataproc-serverless-7ed75eab93ba"> blogpost </a>)您可以将数据摄取到其中任何一个模板中。</li><li id="8728" class="lc ld hi jh b ji ll jl lm jo ln js lo jw lp ka me li lj lk bi translated">从Java环境运行<a class="ae lb" rel="noopener" href="/@sjlva/java-fast-export-large-database-tables-using-gcp-serverless-dataproc-fe6ffffe28b5"> JDBCToBigQuery </a>。</li></ol><h1 id="4c51" class="lq kc hi bd kd lr ls lt kh lu lv lw kl io lx ip ko ir ly is kr iu lz iv ku ma bi translated">参考</h1><ul class=""><li id="827b" class="lc ld hi jh b ji kw jl kx jo le js lf jw lg ka lh li lj lk bi translated"><a class="ae lb" href="https://cloud.google.com/dataproc-serverless/docs/overview" rel="noopener ugc nofollow" target="_blank"> Dataproc无服务</a></li><li id="e237" class="lc ld hi jh b ji ll jl lm jo ln js lo jw lp ka lh li lj lk bi translated"><a class="ae lb" href="https://github.com/GoogleCloudPlatform/dataproc-templates" rel="noopener ugc nofollow" target="_blank"> Dataproc模板库</a></li></ul></div></div>    
</body>
</html>