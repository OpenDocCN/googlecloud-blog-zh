<html>
<head>
<title>How to get the project ID in a Java Cloud Function?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何获取Java云函数中的项目ID？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-get-the-project-id-in-a-java-cloud-function-ffa0eab32ddb?source=collection_archive---------1-----------------------#2022-01-31">https://medium.com/google-cloud/how-to-get-the-project-id-in-a-java-cloud-function-ffa0eab32ddb?source=collection_archive---------1-----------------------#2022-01-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="72fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我和我的同事Sara Ford为即将到来的“第二代”产品测试云函数运行时时，基于T2云运行平台，我为Java运行时写了一些简单的函数。在其中一个Java函数中，我想使用Google云存储，从一个桶中下载一个文件。我看了看现有的<a class="ae jd" href="https://github.com/googleapis/google-cloud-java/blob/main/google-cloud-examples/src/main/java/com/google/cloud/examples/storage/objects/DownloadObject.java" rel="noopener ugc nofollow" target="_blank">样本</a>下载了一个对象:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="e6dd" class="jn jo hi jj b fi jp jq l jr js">Storage storage = StorageOptions.newBuilder()<br/>    .setProjectId(projectId)<br/>    .build()<br/>    .getService();</span><span id="e6a4" class="jn jo hi jj b fi jt jq l jr js">Blob blob = storage.get(BlobId.of(bucketName, objectName));<br/>blob.downloadTo(Paths.get(destFilePath));</span></pre><p id="4be7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我知道bucket的名称，文件的名称，我将把文件存储在本地文件系统中。所以我有了所有需要的信息…除了我在其中部署Java cloud函数的项目ID。那么，在云函数环境中，我如何用Java获得项目ID呢？</p><p id="57da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云函数的前一次迭代有各种有用的环境变量，包括项目ID。所以您可以通过System.getenv()调用来检索ID。然而，由于各种运行时之间的各种兼容性原因，随着开源项目的发展，这个变量消失了。</p><p id="83f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，我知道项目ID也是内部<a class="ae jd" href="https://cloud.google.com/appengine/docs/standard/java/accessing-instance-metadata" rel="noopener ugc nofollow" target="_blank">计算元数据</a>的一部分，可以通过一个特殊的URL访问:</p><p id="9060" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://metadata.google.internal/computeMetadata/v1/project/project-id" rel="noopener ugc nofollow" target="_blank">http://metadata . Google . internal/computeMetadata/v1/project/project-id</a></p><p id="c4a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了这些知识，我想我可以简单地发出一个快速的HTTP请求来获取这些信息:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="cc0b" class="jn jo hi jj b fi jp jq l jr js">private String getProjectId() { <br/>    String projectId = null; <br/>    HttpURLConnection conn = null; <br/>    try {<br/>        URL url = new URL("http://metadata.google.internal/computeMetadata/v1/project/project-id"); <br/>        conn = (HttpURLConnection)(url.openConnection());<br/>        conn.setRequestProperty("Metadata-Flavor", "Google"); <br/>        projectId = new String(conn.getInputStream().readAllBytes(), <br/>                               StandardCharsets.UTF_8); <br/>        conn.disconnect(); <br/>    } catch (Throwable t) {} <br/>    return projectId;<br/>}</span></pre><p id="0214" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了使调用工作，必须设置您在上面看到的Metadata-Flavor头。我使用Java的内置HttpURLConnection来完成这项工作。还有其他的HTTP库可以使代码更简单，但是一开始，我不想带另一个HTTP客户端，只是为了检索一个简单的项目元信息。</p><p id="68b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我是为Java 设计<a class="ae jd" href="https://github.com/GoogleCloudPlatform/functions-framework-java" rel="noopener ugc nofollow" target="_blank">函数框架的开发人员之一，该框架用于在Java中创建云函数，然而，我也使用Node.js编写了不少函数。在节点生态系统中，实际上有一个NPM模块，其职责是检索此类项目元数据。使用</a><a class="ae jd" href="https://www.npmjs.com/package/gcp-metadata" rel="noopener ugc nofollow" target="_blank"> gcp-metadata </a>模块，您可以需要它，然后使用以下命令获取项目ID:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="0ade" class="jn jo hi jj b fi jp jq l jr js">const gcpMetadata = require('gcp-metadata');<br/>const projectId = await gcpMetadata.project('project-id');</span></pre><p id="c138" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我很惊讶我不能很容易地在Java中找到一个等价的库。我花了一段时间才找到它，但它实际上也存在！那就是<a class="ae jd" href="https://googleapis.dev/java/google-cloud-core/latest/index.html" rel="noopener ugc nofollow" target="_blank">com . Google . cloud:Google-cloud-core</a>库！使用起来很简单:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="f603" class="jn jo hi jj b fi jp jq l jr js">import com.google.cloud.ServiceOptions;</span><span id="b696" class="jn jo hi jj b fi jt jq l jr js">String projectId = ServiceOptions.getDefaultProjectId();</span></pre><p id="ab0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的pom.xml中的一个额外的依赖项，一个对ServiceOptions的导入和一个静态方法调用，我就可以获得GCP项目ID！因此，我现在可以将项目ID传递给我的StorageOptions builder。</p><p id="1ed3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是出于某种原因，我记得在我编写的一些其他项目中，我并不真正需要项目ID信息，因为我使用的库足够智能，可以从环境中推断出这样的信息。让我们从头再看一下存储选项。如果我只是省略setProjectId()方法调用会怎么样？你瞧……事实上，它实际上是不需要的，项目ID是透明地推断出来的。所以我根本不需要搜索如何检索这个项目ID！实际上，您可以进一步简化存储选项的创建，具体如下:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="4853" class="jn jo hi jj b fi jp jq l jr js">Storage storage = StorageOptions<br/>    .getDefaultInstance()<br/>    .getService();</span></pre><p id="b8b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">至少，现在，我知道如何在Java中检索项目ID，以防库或环境本身不提供这样的细节！</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><p id="e112" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kb">原载于</em><a class="ae jd" href="https://glaforge.appspot.com/article/how-to-get-the-project-id-in-a-java-cloud-function" rel="noopener ugc nofollow" target="_blank"><em class="kb">https://glaforge.appspot.com</em></a><em class="kb">。</em></p></div></div>    
</body>
</html>