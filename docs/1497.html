<html>
<head>
<title>Using Cloud Asset Inventory feeds for dynamic configuration and policy enforcement</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用云资产清单馈送进行动态配置和策略实施</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-cloud-asset-inventory-feeds-for-dynamic-configuration-and-policy-enforcement-c37b6a590c49?source=collection_archive---------2-----------------------#2020-07-06">https://medium.com/google-cloud/using-cloud-asset-inventory-feeds-for-dynamic-configuration-and-policy-enforcement-c37b6a590c49?source=collection_archive---------2-----------------------#2020-07-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/2c7bf649c8f85fbf3a2f119a3c05ea89.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*9CqUz9Yfoa_1TPlVZEhcRg.jpeg"/></div></figure><p id="6e92" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" href="https://cloud.google.com/asset-inventory/docs/overview" rel="noopener ugc nofollow" target="_blank">云资产清单</a>的一个未被重视的功能是<a class="ae jk" href="https://cloud.google.com/asset-inventory/docs/monitoring-asset-changes" rel="noopener ugc nofollow" target="_blank">源</a>，它通过发布到PubSub队列的一系列事件实时监控资源和策略的变化。</p><p id="f353" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">它们连接到云功能，在每个消息中公开完整的资源属性集，允许使用最少的代码进行简单的资源跟踪、动态配置或策略实施，并可用于解决一些常见的用例:</p><ul class=""><li id="5d84" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">根据资源变化更新远程数据源，例如企业CMDB</li><li id="386c" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">管理相关资源，例如实例和转发规则的自定义云DNS记录</li><li id="b494" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">对关键资源或IAM绑定的更改触发警报</li><li id="0597" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">在特定资源的配置上实施预定义的策略，例如后端服务上的云防护策略</li></ul><p id="a67e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">此处显示的代码属于最后一类，通过近乎实时地检测和恢复不合规的更改，在虚拟机网络标记上实施预定义的策略。当使用标记来确定防火墙规则的范围时，这是一种灵活而简单的方法来添加额外的控制措施。</p><p id="e5ac" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">该示例被设计为最小化和自包含的，在实际使用中当然需要一些更改:将云功能的feed和IAM自定义角色/绑定的范围限定到组织或文件夹；调整函数的重试和错误处理；并采用单独的方式定期运行全面检查(可能使用云资产导出)。</p><p id="1ee8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这是示例代码将创建的资源的高级概述:</p><figure class="ka kb kc kd fd ij er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es jz"><img src="../Images/febaeb68fa8b3c07048595032d376101.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YwVq1Jhcpad-9CO4IICvSg.png"/></div></div></figure></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><p id="d4b2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要运行这个例子，首先克隆<a class="ae jk" href="https://github.com/terraform-google-modules/cloud-foundation-fabric" rel="noopener ugc nofollow" target="_blank">存储库</a>，并切换到example文件夹。如果您喜欢使用云Shell，<a class="ae jk" href="https://ssh.cloud.google.com/cloudshell/editor?cloudshell_git_repo=https%3A%2F%2Fgithub.com%2Fterraform-google-modules%2Fcloud-foundation-fabric&amp;cloudshell_print=cloud-shell-readme.txt&amp;cloudshell_working_dir=examples%2Fcloud-operations%2Fasset-inventory-feed-remediation" rel="noopener ugc nofollow" target="_blank">这个链接</a>将为您运行Git克隆，并切换到正确的文件夹，以便您可以跳过下面的初始步骤。</p><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="4789" class="ku kv hi kq b fi kw kx l ky kz">git clone <a class="ae jk" href="https://github.com/terraform-google-modules/cloud-foundation-fabric.git" rel="noopener ugc nofollow" target="_blank">https://github.com/terraform-google-modules/cloud-foundation-fabric.git</a><br/>cd examples/cloud-operations/asset-inventory-feed-remediation</span></pre><p id="02f2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦在正确的文件夹中，运行Terraform，只需提供将在其中创建所需资源的项目id(我们稍后会清理，不要担心)。以下命令中的<code class="du la lb lc kq b">$GOOGLE_PROJECT_ID</code>变量由云壳设置为云控制台中的当前项目，如果您不在云壳中或想要使用不同的项目，请将其替换为实际的项目id。</p><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="1b9a" class="ku kv hi kq b fi kw kx l ky kz">terraform init<br/># answer 'yes' when prompted after running apply<br/>terraform apply -var project_id=$GOOGLE_PROJECT_ID</span></pre><p id="61a7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当Terraform完成运行时，它将打印测试所需的几个<code class="du la lb lc kq b">gcloud</code>命令，以及创建Google Terraform provider尚不支持的feed的命令(如果您滚动过这些命令，请运行<code class="du la lb lc kq b">terraform output</code>在屏幕上再次打印这些命令)。</p><p id="b42c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">复制并运行<code class="du la lb lc kq b">feed_create</code>输出中的命令，应该类似于这样(不要从这里复制粘贴！):</p><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="5b9d" class="ku kv hi kq b fi kw kx l ky kz">gcloud asset feeds create feeds-test \<br/>  --pubsub-topic projects/feeds-test/topics/feeds-test \<br/>  --asset-types compute.googleapis.com/Instance \<br/>  --content-type resource \<br/>  --project feeds-test</span></pre><p id="1292" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们现在准备测试这个例子。</p></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><p id="4658" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，下面是标签策略在云函数中是如何实现的:</p><ul class=""><li id="7c61" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">每次一个实例被创建或改变(状态改变不是<code class="du la lb lc kq b">RUNNING</code>或<code class="du la lb lc kq b">TERMINATED</code>)时，云函数检查它的标签</li><li id="0044" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">它会丢弃任何不以预设前缀(<code class="du la lb lc kq b">shared-</code>或<code class="du la lb lc kq b">gke-cluster-</code>)或项目id开头的标签</li><li id="127a" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">然后将过滤后的标签与实例上的标签进行比较，如果发现差异，它会调用<code class="du la lb lc kq b">setTags</code>计算引擎API方法来删除不符合的标签</li></ul><p id="a4fb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了测试该功能，通过控制台或使用Terraform输出中显示的<code class="du la lb lc kq b">tag_add</code>命令，向实例添加一个不兼容的标签。然后再次通过控制台或Terraform输出中的<code class="du la lb lc kq b">cf_logs</code>命令检查云函数日志。</p><p id="d1f9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您应该看到两个独立的函数调用:第一个更改添加了不兼容的标记，第二个更改由函数删除它。这些是来自同一个函数的实际日志条目，顺序相反(<code class="du la lb lc kq b">gcloud logging read</code>命令默认为降序排序),为了清楚起见，稍微做了编辑:</p><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="a2a7" class="ku kv hi kq b fi kw kx l ky kz">DEBUG Function execution started<br/>INFO  parsing event data<br/>INFO  checking <a class="ae jk" href="https://www.googleapis.com/compute/v1/projects/xxxxx/zones/europe-west1-b/instances/feeds-test-1" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/.../feeds-test-1</a><br/>INFO  tags <strong class="kq hj">['foobar', 'shared-test-feed', 'xxxxx-test-feed']</strong><br/>INFO  <strong class="kq hj">modify tags</strong> xxxxx europe-west1-b feeds-test-1 XrN1ewa5m98= <strong class="kq hj">['shared-test-feed', 'tf-playground-simple-test-feed']</strong><br/>DEBUG Function execution took 6153 ms, finished with status: 'ok'</span><span id="091c" class="ku kv hi kq b fi ld kx l ky kz">DEBUG Function execution started<br/>INFO  parsing event data<br/>INFO  checking <a class="ae jk" href="https://www.googleapis.com/compute/v1/projects/xxxxx/zones/europe-west1-b/instances/feeds-test-1" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/.../feeds-test-1</a><br/>INFO  <strong class="kq hj">tags ['shared-test-feed', 'xxxxx-test-feed']</strong><br/>INFO  <strong class="kq hj">all tags are valid</strong><br/>DEBUG Function execution took 14 ms, finished with status: 'ok'</span></pre><p id="8004" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可以通过使用<code class="du la lb lc kq b">tag show</code>命令查看实例细节来确认该函数执行的更改是否成功:</p><pre class="ka kb kc kd fd kp kq kr ks aw kt bi"><span id="5723" class="ku kv hi kq b fi kw kx l ky kz">tags:<br/>  fingerprint: HwowTSTO_e8=<br/>  items:<br/>  - shared-test-feed<br/>  - xxxxx-test-feed</span></pre><p id="a1ea" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当您完成测试后，只需运行<code class="du la lb lc kq b">terraform destroy</code>删除所有创建资源，然后使用<code class="du la lb lc kq b">gcloud asset feeds delete [feed name] --project [project id]</code>手动删除提要。</p></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><p id="2729" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我希望这个简短的例子足以展示云资产提要的强大功能，并为您使用它们提供一个良好的开端。</p></div></div>    
</body>
</html>