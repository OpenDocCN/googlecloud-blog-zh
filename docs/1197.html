<html>
<head>
<title>Debugging Serverless Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">调试无服务器功能</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/debugging-serverless-functions-53f99a7f3cb2?source=collection_archive---------0-----------------------#2019-11-09">https://medium.com/google-cloud/debugging-serverless-functions-53f99a7f3cb2?source=collection_archive---------0-----------------------#2019-11-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/1e2cfcc8ec4934100dbd36071b7cf0ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1J_sL18JGH-2_jg1DZ_90w.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">对于无服务器计算，真正的工作是有效的调试</figcaption></figure><p id="5245" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">…上接<a class="ae js" rel="noopener" href="/google-cloud/serverless-computing-made-easy-40e534ae410e">无服务器计算变得简单</a></p><p id="4db7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi jt translated"><span class="l ju jv jw bm jx jy jz ka kb di"> G </span> oogle云函数是实现无服务器计算的一种强大方式。完全使用这个工具需要一种调试代码的可靠方法。在这篇博文中，我们使用了Python 3云函数，并介绍了一种可靠的故障排除方法。</p><p id="848d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下面调试练习的示例代码可以在Github 的<a class="ae js" href="https://github.com/waheedbrown/serverless" rel="noopener ugc nofollow" target="_blank">这里找到。这是在</a><a class="ae js" rel="noopener" href="/google-cloud/serverless-computing-made-easy-40e534ae410e">之前的博客文章</a>中使用的同一个存储库。此外，还假设您遵循了博客文章或repo自述文件中的安装步骤。测试云功能将引用安装过程中创建的谷歌云平台(GCP)资源。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kc"><img src="../Images/bda467ec6951a6ce04c53822a4ad140b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*68NJK_JenlaPakXJYcXdYg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Github上有源代码和调试设置说明(<a class="ae js" href="https://github.com/waheedbrown/serverless" rel="noopener ugc nofollow" target="_blank">点击这里</a>)</figcaption></figure><p id="b15a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">参考repo自述文件，调试安装说明如下:</p><p id="b016" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">1.将此存储库克隆到您的工作区</p><p id="ec12" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">2.导航到调试文件夹</p><p id="e847" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">3.编辑prepare_log.sh脚本，在您的Google云平台(GCP)中添加项目ID、区域、地区和虚拟机(VM)实例ID的特定值</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kh"><img src="../Images/9f8c393f8698022de24254db02b19247.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VeBiKEyape9wC8t3c4V9MQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">在prepare_log.sh中添加您的GCP值，INSTANCE_ID位于虚拟机详细信息页面上</figcaption></figure><figure class="kd ke kf kg fd ij er es paragraph-image"><div class="er es ki"><img src="../Images/5c00d158b488da90b1490b1580147de6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/1*VHEzCiIPHjgqGTJhg4S4zQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">VM实例ID是Stackdriver日志中使用的唯一数字标识符</figcaption></figure><p id="28fc" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用sed命令交换变量值的脚本。一个更干净的方法是使用<a class="ae js" href="https://unix.stackexchange.com/questions/294835/replace-environment-variables-in-a-file-with-their-actual-values" rel="noopener ugc nofollow" target="_blank"> envsubst </a>，但是我无法在我的Ubuntu环境中使用它。如果您想编写自己的日志准备脚本，这是值得一试的。</p><p id="d067" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">丰富的一个重要部分是如何创建<a class="ae js" href="https://github.com/waheedbrown/serverless/blob/master/debugging/sample_log.json" rel="noopener ugc nofollow" target="_blank"> sample_log.json </a>中的样本日志数据。流程是下载一个现有的Stackdriver日志，该日志触发您的生产云功能:</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kj"><img src="../Images/08d8ef1e26e815166eb6dad40d102f3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8O-tsWgluOljGS8PS6WlBw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">筛选您需要的日志；Github repo中提供了一个示例过滤器，advanced _ filter _ static _ IP _ event . txt</figcaption></figure><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kk"><img src="../Images/04f0584f14040bc858a12afc01c60241.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z8faMZQBrprZa66YmDl9tQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">“在新选项卡中查看”或“下载”来查看所需Stackdriver日志条目的原始JSON文本</figcaption></figure><p id="b66f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">准备您自己的测试日志的下一步是删除前后的方括号“[”和“]”。最后，您需要缩小JSON，删除所有新的行字符。当包含新的行字符时，云函数测试器会中断。请参见Github repo中的debugging/sample_log.json，以获得一个干净的示例日志文件(尽管存在shell变量)。</p><p id="c4ce" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">4.运行prepare_log.sh，这将生成一个名为prepared_log.json的文件</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kl"><img src="../Images/d3027e812632b762ff953d55537e0e43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZW-53lWPMKQjHtTG9I8Zxw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">云壳用于克隆repo并创建prepared_log.json，这是他的GCP特定值</figcaption></figure><p id="8e02" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">5.在GCP控制台中，创建一个Python 3云函数，“触发器”将是“Cloud Pub/Sub”，“主题”将是上面安装步骤中创建的那个；对于“源代码”,选择“内联编辑器”,对于“运行时”,选择“Python 3.x”</p><p id="8814" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">6.将debugger/main.py的内容复制粘贴到“main.py”字段中</p><p id="e2f7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">注意:</strong>当您尝试复制prepared_log.json的内容时，您的终端可能会换行。如果云函数“测试”标签给你错误，这可能是原因。您必须使JSON文本成为一个连续的字符串，没有换行符，这样“Testing”选项卡才能接受它。</p><p id="b7a2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">7.继续创建云函数，将它和“要执行的函数”命名为test_migrate_vm</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div class="er es km"><img src="../Images/61d32f47123b97baee4dbae678f82883.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*dTqRUeOACrOpiRVqwSSudA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">Python def名称与“要执行的函数”名称匹配是至关重要的</figcaption></figure><p id="a84e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">注意Python代码中的第5、12和13行，在Github repo中也可以作为debugging/main.py获得。在第5行中，我们必须重命名已定义的函数(同样还有“要执行的函数”)。我们不希望测试云功能与生产云功能有命名冲突。</p><p id="5847" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">第12行期望Stackdriver日志行直接来自Stackdriver日志接收器。发布到接收器(或发布/订阅主题)的Stackdriver日志是Base64编码的。然而，我们的测试数据是纯文本，Python认为它是一个简单的集合。注意测试数据是如何用大括号“{”和“}”括起来的，用逗号分隔键值字符串对。这使得元素易于引用，如第14行所示。</p><p id="64bc" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">8.创建云函数后，导航到“测试”子选项卡</p><p id="c02b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">9.将prepared_log.sh的内容复制粘贴到“触发事件”文本框中</p><p id="0600" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">10.点击“测试功能”按钮</p><p id="e543" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">11.在正确执行时,“输出”应该是“OK ”,并且应该生成日志</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div class="er es kn"><img src="../Images/b70bf41b69d7d783569d8768249472db.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*3Xlh0AV7yQRo8Ix5zS7bZA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">如果该功能摄取了测试数据并正确执行，则它输出“OK”</figcaption></figure><p id="ca71" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">12.Python代码末尾的print语句将输出到Stackdriver日志。您添加的打印语句，如print("test_string ")，也输出到Stackdriver。在Stackdriver Logging页面上，确保选择“云函数”过滤器下拉资源，然后选择云函数名称。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/0f179eddf147cc0fba31c90e5658fecb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VLIFCXkisJJcYrdys4MWNQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">在Stackdriver日志记录中,“云函数”筛选器下拉资源会将您带到输出</figcaption></figure><p id="8e66" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">希望上面的调试方法能够帮助您解决自己的云功能问题。请记住，关键是依靠Stackdriver为您提供测试数据输入，并捕获您的云函数输出。print语句也可以用于调试，它们的输出也可以在Stackdriver中捕获。</p></div></div>    
</body>
</html>