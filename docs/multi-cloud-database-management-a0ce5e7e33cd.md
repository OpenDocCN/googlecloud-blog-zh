# 多云数据库管理

> 原文：<https://medium.com/google-cloud/multi-cloud-database-management-a0ce5e7e33cd?source=collection_archive---------1----------------------->

## 为多云使用案例选择数据库

*注:本博客内容与* [*同名*](/series/multi-cloud-database-management-6ff07110ebbd) *系列相同。随着 medium.com 系列的* [*被弃用*](https://help.medium.com/hc/en-us/articles/115004916427-Medium-Series-feature-deprecation) *，我在这里发布与常规博客相同的内容。*

本系列讨论了多云数据库管理的各个方面:

*   什么是多云数据库管理？
*   在不同的公共云和私有云之内和之间管理数据库有哪些使用案例？
*   有哪些类型的数据库管理系统可以满足多云用例？
*   哪些部署架构支持多种云使用情形？

…以及更多。

☁️:如果你感兴趣，请关注这个系列的发展。

## 一个小小的请求…

这是我第一次使用 medium.com[系列](/blogging-guide/what-is-a-medium-series-f2b382a958b1)逐步讨论技术内容。

Medium.com 优化了该系列卡片在手机上的显示，这样你作为读者可以通过左右滑动屏幕来阅读该系列，而不是从上到下阅读网页。

让我知道这是否有效，是否有用和有帮助。请给我留下您的反馈、体验、印象和建议。

谢谢你。

## 多云

*   **【大众】** [**云**](https://en.wikipedia.org/wiki/Cloud_computing) 。公共云是提供由许多组织共享的计算资源的环境。一个例子是[谷歌云](https://cloud.google.com/)。
*   **内部部署(私有云)**。由单个组织拥有或专用的云或计算环境。
*   [**混合云**](https://cloud.google.com/solutions/hybrid-and-multi-cloud-patterns-and-practices#hybrid_cloud_and_multi-cloud) 。组织使用的公共云和私有云(内部)的组合。
*   [**多云**](https://cloud.google.com/solutions/hybrid-and-multi-cloud-patterns-and-practices#hybrid_cloud_and_multi-cloud) 。至少两个公共云，可能包括私有云。

![](img/891a2c43a350c184c1a2b432d2a25b79.png)

图 1:混合云和多重云

## 数据库应用

一个数据库应用程序使用一个数据库来管理它的持久状态。它有以下组件

*   **用户界面**。在大多数情况下，它是浏览器客户端、移动客户端或已安装客户端。
*   **应用逻辑**。它实现业务逻辑并运行在任何计算环境上，如[虚拟机](https://cloud.google.com/compute)、 [Kubernetes](https://cloud.google.com/kubernetes-engine) 、[云功能](https://cloud.google.com/functions)、[云运行](https://cloud.google.com/run)等。
*   **数据库**。数据库实现数据管理功能，数据库应用程序使用它来管理其持久状态。

![](img/2f186159cccc50bec2854dbcbec164cf.png)

图 2:数据库应用程序

## 建立工作关系网

它隐含地假设使用多种云设置的组织需要各种相关的云能够相互通信。云通常不是孤立使用的，因为部署的应用程序共享配置元数据、管理功能或业务数据。

一种方法是使用 VPN 连接。[这里的](/google-cloud/multi-cloud-vpn-and-multi-zone-subnetworks-preparation-for-multi-cloud-database-deployments-c43272336a8f)是在两个公共云之间建立 VPN 连接的示例。

## 多种云使用案例

数据库应用程序有许多不同的多云使用案例。

在下文中，我将仅更详细地讨论选择的几个来说明现有的光谱。一份更详细、更完整的清单将随后公布。

很自然，重点将放在数据库方面(参见前面的数据库应用程序组件)，而应用程序逻辑和客户端方面根本没有详细说明。

开始了…

## 用例:云爆炸

一个重要的用例是云爆发。此使用案例在混合云案例中最有意思，在这种情况下，基本的稳定状态负载可以由私有的内部数据中心处理。

根据行业的不同，在一年中的某些时期，客户端活动的增加超过了数据中心的容量，云提供了额外的容量来满足激增的需求。

在突发期间，应用程序逻辑也在云中运行，以增加容量。在数据库方面，本地数据库可能足以处理突发事件。

如果这还不够，那么还要在云中部署一个数据库。对于两个数据库，同步变得很重要。最简单的是分布式多主数据库，更困难的是在两个云数据库之间进行数据分区以避免冲突。最具挑战性的是双向复制模型，它需要在并发更新相同数据的情况下解决冲突。

## 用例:最佳服务选择

云在许多方面彼此非常不同，尤其是仅在特定云中可用的特定于提供商的技术。

如果遵循同类最佳的策略，应用程序逻辑的不同部分可能会在不同的云上运行。

从数据库的角度来看，这可能有几种形式:

*   数据是分区的，不同云中的部分之间不存在任何关系。
*   数据被复制，其中一个云包含主要业务数据，而另一个云只需要一个副本。
*   数据是共享的，必须在两个云中保持一致。在这种情况下，多主分布式数据库是最简单的模型。
*   共享数据的一种变体是双向复制，在两个云中同时更新相同数据的情况下，使用显式冲突解决方案。

一般来说，这个用例也支持两个以上的云。

## 用例:跨云可移植性

为了避免锁定，一个策略是以这样一种方式实现应用程序逻辑和数据库，即应用程序可以在任何时候被移植到任何云。

在一个变体中，这个用例可能需要在所有云中使用完全相同的技术。这迫使采用最小公分母方法，因为只能使用所有云中可用的云服务和技术。从数据库的角度来看，必须选择可以部署到所有云中的数据库。

另一个不同的变体是不要将可移植性建立在所使用技术的可移植性上，而是建立在模型和模式的可移植性上。例如，在数据库的情况下，关系或文档模型可以用作可移植性的手段，任何支持关系模型的数据库都可以。然而，只有那些被任何云中的技术支持的模型元素可以被选择。它将成为模型而不是技术的共同特征。

## 使用案例:灾难恢复

为了防止因云故障而停机，可以实施灾难恢复策略，支持主云和辅助云之间的故障转移和回退。

对于最低的 [RPO 和 RTO](https://en.wikipedia.org/wiki/Disaster_recovery) ,需要一个所谓的热-热备用部署，该部署要求应用程序逻辑和数据库可用，并准备好在所有相关云中承担客户端流量。

从数据库的角度来看，为了最大限度地降低 r to 和 RPO，应该主动将数据从主云复制到备用云。

如果可以容忍一些事务丢失，异步复制的数据库系统就足够了。如果 RPO 应该为零，同步复制的主-主数据库系统是最佳选择。

## 其他使用案例

除了上述使用案例之外，以下是几个仅简要讨论的案例:

*   **应用迁移**。数据库应用程序从一个云迁移到另一个云。在这个用例中，将数据从一个数据库迁移到另一个数据库的过程涉及到两个数据库。[零停机数据库](https://cloud.google.com/solutions/database-migration-concepts-principles-part-1#migration_downtime_zero_versus_minimal_versus_significant)迁移是首选方法。
*   **分布式计算**。在这个用例中，服务部署在不止一个云中，并且在所有云中为客户端请求提供服务。
*   **成本优化**。一个非常极端的用例(用今天的术语来说)是基于成本模型在云之间切换。只要成本基础发生变化，就会进行评估，应用程序就会迁移到最便宜的替代方案。

在多云数据库应用程序的上下文中有更多的用例，以及这里讨论的那些用例的其他变体。对于下面的分析，所讨论的列表就足够了。

## 用例讨论

用例可以分为暂时涉及几个云的用例(如爆发)或在正常生产操作期间持续涉及几个云的用例(同类最佳)。

此外，可以组合用例，例如，云爆发和灾难恢复。当组合用例时，理想情况下，一个单一的设计和实现同时服务于所有的用例。

通过分析模式中数据库的使用，可以得出下面要讨论的四种基本模式。

## 多云数据库管理模式

用例导致以下基本的多云数据库管理模式:

*   **分区无跨数据库依赖**。这种模式是最简单的:每个位置或云都有一个数据库，数据库包含相互不依赖的分区数据集。这种模式的一个例子是多租户应用程序。
*   **异步单向复制**。这个模式包含一个复制到辅助数据库的主数据库。辅助数据库用于读取访问。这种模式的一个例子是同类最佳，将辅助节点用于分析。
*   **带冲突解决的双向复制**。该模式包含两个彼此异步复制的主数据库。在同一时间写入的相同数据(例如，相同的主键)导致写-写冲突的情况下，冲突解决方案必须在复制期间决定哪个状态是最后的状态。这种模式可以用在很少发生写-写冲突的情况下。
*   **完全主从同步分布式系统**。该模式包含一个具有主-主设置的数据库，因此任何主服务器上的数据更新在事务上是一致的，并且是同步复制的。这种模式用于分布式计算用例中。

## 按部署架构的数据库系统

从多云数据库管理的角度来看，数据库管理系统的部署架构主要有四类。这些是

*   **云原生数据库**。云原生数据库是以这样一种方式设计和构建的，即它们最适合在云技术的环境中工作。例如[cocroach db](https://www.cockroachlabs.com/)或 [YugaByte](https://www.yugabyte.com/) ，它们可以部署到任何支持容器的云中。
*   **云提供商管理的数据库**。云提供商管理的数据库建立在云提供商特定的技术之上，由特定的云提供商作为数据库服务进行管理。例如[云扳手](https://cloud.google.com/spanner)和[云 Bigtable](https://cloud.google.com/bigtable) 。
*   **云前数据库**。前云数据库在云技术发展之前就已经存在(有时已经存在很长时间了)，并且主要运行在裸机硬件和虚拟机上。例子有 [PostgreSQL](https://www.postgresql.org/) 和 [MySQL](https://www.mysql.com/) 。
*   **云合作伙伴管理的数据库**。一些公共云有数据库合作伙伴，他们在公共云中安装和管理客户的数据库。因此，客户不必自己管理这些数据库。例如 [MongoDB Atlas](https://cloud.google.com/mongodb) 和 [MariaDB](https://mariadb.com/products/skysql/google-cloud-platform/) 。

## 分布式数据库系统

不同的数据库管理系统在其体系结构中遵循不同的分布模型来实现。数据库最重要的模型是

*   **单实例**。单个数据库实例运行在一个虚拟机或一个容器上，基本上是一个集中式系统。单个实例不能连接到任何其他单个实例，这意味着数据库系统不支持复制。
*   **多实例主动-被动**。常见的体系结构是多实例系统，其中几个数据库实例链接在一起。最常见的链接是主动-被动关系，其中一个实例是支持写入和读取的主动数据库实例。
*   **多实例主动-主动**。一种不太常见的体系结构是多实例系统，其中每个实例都是一个活动实例。在这种情况下，每个实例都可以执行读写事务，同时提供整体数据一致性。
*   **多实例主动-主动冲突解决**。另一种不太常见的变体是多实例部署，其中每个实例都可以进行读写访问。但是，数据库是以异步模式同步的。这允许同一数据项的并发更新导致不一致的状态。冲突解决策略必须决定哪个状态被认为是正确的一致状态。

## 数据库分片呢？

正交分布的一个方面是多实例分片。分片是基于管理(不相交的)数据分区。每个分区由一个单独的数据库实例管理。一方面，随着时间的推移，可以动态添加更多的分片，这是可伸缩的，另一方面，跨分片查询可能是不可能的。

上述每个分发模型原则上都可以支持分片，并且是一个分片系统。然而，并不是所有的系统都提供分片选项，因为许多系统并不是为此而设计的。

## 数据库系统到多云数据库管理模式的映射

对于给定的用例，如云爆发和为其选择的数据库管理模式，可以根据数据库部署架构和数据库分布模型来选择数据库系统。

在以下示例中，将分别讨论两种不同的云爆发方法。首先，选择数据库管理模式，然后是数据库。

## 示例:具有单个数据库的云爆发

第一个例子基于只使用一个数据库系统的需求。

*   **图案**。该模式是完全分区的，主云中只有一个数据库系统，辅助云中没有主系统。这意味着代码会爆炸，但数据库不会。所有数据库访问都由单个数据库提供服务。
*   **数据库选择**:主云中支持的任何数据库都是竞争者，因为辅助云中没有第二个数据库。任何部署架构和任何分发模型都满足这些要求。

## 示例:具有完整数据库复制的云爆发

第二个示例基于完全复制的状态，因此主云和辅助云 100%一致。

*   **图案**。该模式是“完全主-主同步的分布式系统”或“带冲突解决的双向复制”,因为只有这两种模式支持多个实例的同步。
*   **数据库选择**。必须检查每个部署架构中的每个可用数据库，看它是否支持跨两个云的分布模型。如果根据工作负载行为预计会有很多冲突，那么实现冲突解决的数据库可能不是最佳选择。

## 多云数据库选择

基于前面讨论的多云数据库管理模式、数据库系统部署架构和分布模型，高级数据库选择决策树支持以下两个出发点:

*   **现有数据库系统**。如果您在生产中有一个现有的数据库系统，从这一点开始。
*   **新的数据库系统**。如果您没有现有的数据库或者您正在寻找不同的选择，请从这一点开始。

在下面的内容中，您会发现两个入口点各有一个单独的部分。

## 决策树:现有的数据库系统

决策树的这一部分相当简单:

*   如果您现有的数据库系统支持多云用例，并且您想要保留它，那么就没有其他事情需要决定了。如果数据库运行可靠，并且可以顺利管理，那么保留现有数据库系统是最好的选择。
*   即使您已经有了一个现有的数据库系统，您也可能会决定改变这个系统或者寻找替代系统。如果当前系统不能以最佳方式支持用例(例如，它不能提供开箱即用的复制，或者不能在两个云中运行)，或者您可以预见即将到来的挑战，例如，它不能按要求扩展，则此决策可能很重要。

在后一种情况下，继续下一步讨论的新数据库系统的决策树入口点。

## 决策树:新的数据库系统

主要根据两个云中的数据之间的关系来选择一个新的(或几个)数据库系统:

*   **分区数据**。如果数据是分区的，并且云中的数据之间不存在关系，请为每个云选择一个数据库系统。这可以是同一个数据库系统，也可以是不同的系统，具体取决于工作负载的要求。
*   **单向复制**。如果一个云从另一个云接收复制的数据，可以选择实施复制的数据库系统(主动-被动系统)，或者找到一个复制系统作为单独的技术，如果数据库系统本身不支持复制，它可以从源数据库读取数据并复制(写入)到目标数据库。
*   **双向复制**。如果用例要求数据在两个云之间完全同步，那么应该选择一个提供事务同步一致性的数据库系统。或者，如果冲突解决方案是可接受的，则数据库系统可以双向复制，并具有检测和解决冲突的能力。

## 混合的多种云使用情形

你有可能同时拥有或者将要拥有不止一个用例。在这种情况下，在开始数据库选择过程之前，必须做出总体架构决策:是一个数据库系统必须支持所有用例，还是每个用例都有自己的数据库系统？

在前一种情况下，具有最严格需求的用例将推动选择。例如，如果您有一个分区用例以及一个完全同步的用例，那么所选择的数据库必须支持完全同步的用例。根据定义，这个系统也将支持分区用例。

在后者中，对于每个用例，必须进行单独的数据库系统选择。

混合场景也是可能的，其中一些用例需要专用的数据库，而其他用例由一个数据库系统一起支持。

## 摘要

本系列文章首先向您介绍了云计算概念的定义和术语，以及几个云计算用例。基于用例分析，确定了几种多云数据库管理模式。然后，本系列继续介绍与多云用例相关的两种数据库分类，以及数据库到模式的映射。最后，决策树为您提供了一个为您的多云用例选择数据库系统的起点。

本系列为您的云计算数据库之旅奠定了坚实的基础，并从数据库的角度为您提供了成功的云计算架构需要考虑的关键方面和关键决策点。

## 承认

我要感谢 James Brookbank 的全面审查和许多评论，以提高这一内容的准确性。

## 放弃

Christoph Bussler 是谷歌公司(Google Cloud)的解决方案架构师。这里陈述的观点是我自己的，而不是谷歌公司的。