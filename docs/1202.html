<html>
<head>
<title>What’s the best way to log errors (in Node.js)?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">记录错误的最好方法是什么(在Node.js中)？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/whats-the-best-way-to-log-errors-in-node-js-b3dfd2fe07a7?source=collection_archive---------0-----------------------#2019-11-15">https://medium.com/google-cloud/whats-the-best-way-to-log-errors-in-node-js-b3dfd2fe07a7?source=collection_archive---------0-----------------------#2019-11-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="13eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想回答另一个主要在我脑海中的系列问题，题目是“人们经常问我的事情”。本系列今天的内容是关于将错误记录到Stackdriver中。具体来说，我发现人们对错误日志记录的多种选项有些困惑，当他们想要了解如何记录和跟踪异常时，情况就更是如此。我的观点是，这部分是由于Stackdriver提供了支持这一点的多个特性——错误报告和日志记录。这更加令人困惑，因为错误报告在某种程度上是日志记录的一个子集。因此，当我试图在一个示例Node.js <a class="ae jd" href="https://github.com/yuriatgoogle/stack-doctor/tree/master/error-reporting-demo" rel="noopener ugc nofollow" target="_blank"> app </a>中使用日志记录和错误报告来记录错误和异常时，我开始探索到底会发生什么。让我们看看我发现了什么！</p><h1 id="e0d1" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">记录错误</h1><p id="85a0" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我认为人们面临的困惑始于这样一个事实，即Stackdriver实际上支持登录Node.js的三种不同的<a class="ae jd" href="https://cloud.google.com/logging/docs/setup/nodejs" rel="noopener ugc nofollow" target="_blank">选项</a>——Bunyan、Winston和API客户端库。我想看看前两个是如何处理错误日志的。在这一点上，我不认为我们建议直接使用客户端库(就像我们建议使用OpenCensus进行度量遥测一样，而不是直接调用监控API)。</p><h1 id="60e6" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">用班扬语伐木</h1><p id="d342" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/logging/docs/setup/nodejs" rel="noopener ugc nofollow" target="_blank">文档</a>非常简单——在我的应用中设置班扬日志非常容易。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="3353" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从此，记录错误消息就像下面这样简单:</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="4992" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我运行我的应用程序时，我在控制台中看到了以下日志输出:</p><pre class="kh ki kj kk fd ko kp kq kr aw ks bi"><span id="ae45" class="kt jf hi kp b fi ku kv l kw kx">{"name":"node-error-reporting","hostname":"ygrinshteyn-macbookpro1.roam.corp.google.com","pid":5539,"level":50,"msg":"Bunyan error logged","time":"2019-11-15T17:19:58.001Z","v":0}</span></pre><p id="bdfa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Stackdriver日志中:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es ky"><img src="../Images/d8c4676682e88db2102b27e56a2422d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mcjH3n9DCijOHEbO"/></div></div></figure><p id="49c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，该日志条目是针对“全局”资源创建的，因为该日志条目是从我的本地机器发送的，该机器没有运行在GCP上，并且日志名是bunyan_log。输出的结构很好，严重性设置为ERROR。</p><h1 id="86d3" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">与温斯顿一起记录</h1><p id="5f74" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我再次按照文档设置Winston客户机:</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="c6d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我记录了一个错误:</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="3412" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一次，控制台输出更加简洁:</p><pre class="kh ki kj kk fd ko kp kq kr aw ks bi"><span id="4ce7" class="kt jf hi kp b fi ku kv l kw kx">{"message":"Winston error logged","level":"error"}</span></pre><p id="84e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是我在日志查看器中看到的内容:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lf"><img src="../Images/04ccfcda3d7c687acda7b666b2005185.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Mzg2JYOvfgWt_rzd"/></div></div></figure><p id="f55e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">严重性再次被正确设置，但是这个条目中的信息要少得多。例如，我的主机名没有被记录。对于那些希望减少记录的数据量，同时仍然保留足够的有用信息的人来说，这可能是一个不错的选择。</p><h1 id="14ad" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">错误报告</h1><p id="2e41" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">至此，我对记录错误的工作原理有了很好的理解。接下来，我想研究为此目的使用错误报告是否会提供额外的价值。首先，我在应用程序中设置了错误报告:</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="cdd4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我使用客户端发送了一个错误:</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="25fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一次，控制台中没有输出，也没有任何内容被记录到Stackdriver日志中。我去错误报告找到我的错误:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lg"><img src="../Images/597832afef93b4ca62b97ede2e7af767.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*u8kguaUZQpD4UEnw"/></div></div></figure><p id="d9cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我点击错误时，我能够得到很多细节:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lg"><img src="../Images/531e62df112af9a3a669e42903a8ba85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8k0TFy7giqizZIwN"/></div></div></figure><p id="09f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这很好，因为我可以看到错误何时开始发生，如果错误继续发生，我会得到一个直方图，并且我会得到一个完整的堆栈跟踪，显示我的代码中错误发生的确切位置——这些都是非常有价值的信息，我无法通过简单地记录错误严重性来获得这些信息。</p><p id="2bd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里的权衡是，该消息永远不会到达Stackdriver日志。这意味着我不能使用通过错误报告报告的错误，例如，创建基于<a class="ae jd" href="https://dev.to/yurigrinshteyn/can-you-alert-on-logs-in-stackdriver-1lp8" rel="noopener ugc nofollow" target="_blank">日志的指标</a>，这可能会产生很好的SLI和/或警报策略条件。</p><h1 id="076d" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">记录异常</h1><p id="f3ef" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">接下来，我想研究如果我的应用程序抛出一个异常并记录下来会发生什么——它会如何出现？我使用Bunyan记录了一个异常:</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="b0a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">控制台输出包含整个异常:</p><pre class="kh ki kj kk fd ko kp kq kr aw ks bi"><span id="c46f" class="kt jf hi kp b fi ku kv l kw kx">{"name":"node-error-reporting","hostname":"&lt;hostname&gt;","pid":5539,"level":50,"err":{"message":"exception logged","name":"Error","stack":"Error: exception logged\n    at app.get (/Users/ygrinshteyn/src/error-reporting-demo/app.js:72:22)\n    at Layer.handle [as handle_request] (/Users/ygrinshteyn/src/error-reporting-demo/node_modules/express/lib/router/layer.js:95:5)\n    at next (/Users/ygrinshteyn/src/error-reporting-demo/node_modules/express/lib/router/route.js:137:13)\n    at Route.dispatch (/Users/ygrinshteyn/src/error-reporting-demo/node_modules/express/lib/router/route.js:112:3)\n    at Layer.handle [as handle_request] (/Users/ygrinshteyn/src/error-reporting-demo/node_modules/express/lib/router/layer.js:95:5)\n    at /Users/ygrinshteyn/src/error-reporting-demo/node_modules/express/lib/router/index.js:281:22\n    at Function.process_params (/Users/ygrinshteyn/src/error-reporting-demo/node_modules/express/lib/router/index.js:335:12)\n    at next (/Users/ygrinshteyn/src/error-reporting-demo/node_modules/express/lib/router/index.js:275:10)\n    at expressInit (/Users/ygrinshteyn/src/error-reporting-demo/node_modules/express/lib/middleware/init.js:40:5)\n    at Layer.handle [as handle_request] (/Users/ygrinshteyn/src/error-reporting-demo/node_modules/express/lib/router/layer.js:95:5)"},"msg":"exception logged","time":"2019-11-15T17:47:50.981Z","v":0}</span></pre><p id="471a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">日志条目如下所示:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lg"><img src="../Images/47c98205b64106165273469ca4c7bd19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8xh4iSjCE3Rv5JZ9"/></div></div></figure><p id="5b87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">jsonPayload包含一个异常:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lg"><img src="../Images/4088e3d6e4dda2b80d4007792b76ab03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*a0RUqe7jYoLUGQSG"/></div></div></figure><p id="a53d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这绝对是很多有用的数据。接下来，我想看看错误报告是否像<a class="ae jd" href="https://cloud.google.com/error-reporting/docs/setup/nodejs" rel="noopener ugc nofollow" target="_blank">宣传的那样有效，并在日志中将这个异常识别为一个错误。仔细阅读文档后，我意识到这个功能特别适用于GCE、GKE、App Engine和云函数，而我只是在本地桌面上运行我的代码。我尝试在Cloud Shell中运行代码，并立即在错误报告中获得了一个新条目:</a></p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lh"><img src="../Images/fc55ced2dec6df081a299dfa5b54eb0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PgPE-RpeC0HkNAZx"/></div></div></figure><p id="4f24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">详细视图中提供了异常的完整堆栈跟踪:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lg"><img src="../Images/8316ccfc6c66061b87519e8fc7b0c7bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6KENY7zU7BDh0jU3"/></div></div></figure><p id="d2e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，记录一个异常给了我最好的<strong class="ih hj">和</strong>两个世界——我得到了一个日志条目，可以用于基于日志的度量，我还得到一个错误报告条目，可以用于分析和跟踪。</p><h1 id="daf0" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">报告异常</h1><p id="6af7" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">接下来我想看看如果我使用错误报告来报告相同的异常会发生什么。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="cd69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同样，没有控制台输出。我的错误立即出现在错误报告中:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lg"><img src="../Images/f8411396c1f31b739a2b0174b4f8f5bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1OrKFSJt4k2sjzKF"/></div></div></figure><p id="1435" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">令我有些惊讶的是，我还能在日志中看到一个条目:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es lg"><img src="../Images/506d2cef42305fb4f1afa9ab8a241c1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pgPREWhN9jBNCHmI"/></div></div></figure><p id="6950" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">事实证明，异常记录在错误报告和日志记录中——无论您使用哪一个来发送它们。</p><h1 id="ad0e" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">那么，现在怎么办？</h1><p id="7a6f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">以下是我从这个练习中学到的东西:</p><ol class=""><li id="9f13" class="li lj hi ih b ii ij im in iq lk iu ll iy lm jc ln lo lp lq bi translated">Bunyan日志记录比Winston日志记录更详细，如果成本是个问题，可以考虑这一点。</li><li id="7555" class="li lj hi ih b ii lr im ls iq lt iu lu iy lv jc ln lo lp lq bi translated"><strong class="ih hj">异常</strong>可以通过日志或错误报告发送到Stackdriver它们将在两者中都可用。</li><li id="adaa" class="li lj hi ih b ii lr im ls iq lt iu lu iy lv jc ln lo lp lq bi translated">使用错误报告来报告<strong class="ih hj">非异常</strong>错误为开发人员增加了很多价值，但是对于需要使用度量或sli日志的sre或ops人员来说，却失去了价值。</li></ol><p id="efca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢您的加入—欢迎再次光临！</p></div></div>    
</body>
</html>