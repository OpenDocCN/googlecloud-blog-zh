<html>
<head>
<title>Migrate Oracle Autonomous Transaction to CloudSQL for PostgreSQL.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Oracle自治事务迁移到CloudSQL for PostgreSQL。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/migrate-oracle-autonomous-transaction-to-cloudsql-for-postgresql-adbc35152ba2?source=collection_archive---------1-----------------------#2022-08-04">https://medium.com/google-cloud/migrate-oracle-autonomous-transaction-to-cloudsql-for-postgresql-adbc35152ba2?source=collection_archive---------1-----------------------#2022-08-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0287" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从Oracle迁移到PostgreSQL compatible最常见的迁移模式之一是自治事务。自治事务提供了实现子程序的功能，这些子程序可以独立于父事务进行事务提交或回滚。PostgreSQL本身不提供类似的特性。</p><p id="c251" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为构建迁移模式以在PostgreSQL compatible中实现类似功能的一部分，我们遵循以下准则。</p><ol class=""><li id="3710" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">重构在应用程序内的自治事务中实现的功能，或者向后工作以理解需求，并在可行的情况下作为云原生实现。</li><li id="6e33" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">如果重构或替代解决方案不可行，则利用CloudSQL支持的PostgreSQL扩展，如dblink。</li></ol><p id="e03c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本帖中，我们将使用dblink扩展实现类似的功能，并使用云sql数据库标志来避免将dblink本地连接的密码传递给同一个实例。</p><h2 id="454a" class="jr js hi bd jt ju jv jw jx jy jz ka kb iq kc kd ke iu kf kg kh iy ki kj kk kl bi translated">Oracle中的自主事务</h2><p id="629f" class="pw-post-body-paragraph if ig hi ih b ii km ik il im kn io ip iq ko is it iu kp iw ix iy kq ja jb jc hb bi translated">让我们创建一个模拟代码来理解Oracle中的自治事务行为。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="2ca3" class="jr js hi kw b fi la lb l lc ld">create table sample_tbl (col1 integer);</span><span id="ac19" class="jr js hi kw b fi le lb l lc ld">create table sample_tbl_calls(col1 varchar2(10) , col2 date);</span><span id="794e" class="jr js hi kw b fi le lb l lc ld">CREATE OR REPLACE PROCEDURE sample_proc_auto_trans<br/>AS<br/>PRAGMA AUTONOMOUS_TRANSACTION;<br/>BEGIN<br/>INSERT INTO sample_tbl_calls VALUES(‘called’,sysdate);<br/>commit;<br/>END sample_proc_auto_trans;<br/>/</span></pre><p id="79f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PRAGMA是Oracle中的编译器指令。AUTONOMOUS_TRANSACTION强调程序块独立于父事务，并在自己定义的事务范围内运行。</p><p id="541f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用下面的plsql代码块模拟自治事务调用，并通过引发随机异常回滚父插入。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="4f2d" class="jr js hi kw b fi la lb l lc ld">begin<br/>insert into sample_tbl values (1);<br/>sample_proc_auto_trans();<br/>raise ZERO_DIVIDE;<br/>commit;<br/>exception when others then<br/><strong class="kw hj">rollback;</strong><br/>end;</span></pre><p id="98cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们回滚了实际的插入，但是自治过程内的插入被提交。</p><figure class="kr ks kt ku fd lg er es paragraph-image"><div class="er es lf"><img src="../Images/dceac7edaca364372a5c74135346867f.png" data-original-src="https://miro.medium.com/v2/resize:fit:794/format:webp/1*nML9T-aJQ76QDwkjWbNk6g.png"/></div></figure><p id="b032" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PostgreSQL中的扩展增强了数据库提供的整体功能。C <a class="ae lj" href="https://cloud.google.com/sql/docs/postgres/extensions#postgresql-extensions-supported-by-cloud-sql" rel="noopener ugc nofollow" target="_blank">点击这里</a>查看Cloud SQL支持的扩展的完整列表。</p><p id="8af1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PostgreSQL中的dblink将显式打开一个新连接，并在其自己的事务范围内执行一个自治组件。就需要考虑总体影响的新连接而言，它有自己的开销。</p><p id="2d7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从在数据库中创建扩展开始。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="59e7" class="jr js hi kw b fi la lb l lc ld">dblinksample=&gt; create extension dblink;<br/>create extension dblink;<br/>CREATE EXTENSION</span></pre><figure class="kr ks kt ku fd lg er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lk"><img src="../Images/26d0cf5c4dc17b3d8dff4c2b281b5072.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EStVoX4vAl3pNJXY2O1B5g.png"/></div></div></figure><p id="3a80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦添加了dblink扩展，我们就可以通过传递必要的细节来调用远程调用。对于自治事务，远程调用是使用dblink实现的，但它连接到同一个数据库和实例。</p><p id="96bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">典型的自治事务转换函数如下所示。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="fa7c" class="jr js hi kw b fi la lb l lc ld">CREATE OR REPLACE FUNCTION sample_proc_auto_trans()<br/>RETURNS void<br/>AS<br/>$BODY$<br/>DECLARE<br/>v_sql text;<br/>BEGIN<br/>PERFORM dblink_connect('conn','dbname=dbuser user=postgres password=********** port=5432');</span><span id="ed01" class="jr js hi kw b fi le lb l lc ld">v_sql := 'INSERT INTO sample_tbl_calls VALUES (''called'',clock_timestamp())';</span><span id="1e5b" class="jr js hi kw b fi le lb l lc ld">PERFORM dblink_exec('conn', v_sql);<br/>PERFORM dblink_disconnect(‘conn’);<br/>END;<br/>$BODY$<br/>LANGUAGE plpgsql;</span></pre><p id="d66a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意:-我们已经显式传递了数据库用户的凭据，并且没有传递实例详细信息，因为它将连接到同一个实例。</p><p id="9f3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们在pl\pgsql块下面运行，它将在异常时触发回滚。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="1a4d" class="jr js hi kw b fi la lb l lc ld">DO $$<br/>BEGIN<br/>insert into sample_tbl values (1);<br/>PERFORM sample_proc_auto_trans();<br/>raise;<br/>END$$;</span></pre><p id="e2d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它在异常时隐式回滚，但来自sample_proc_auto_trans的dml被提交。</p><figure class="kr ks kt ku fd lg er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lp"><img src="../Images/59ab7bb0ed0fd6cc0446f583176aab8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JHIO2c4m9T4V1Fo_8Bv08A.png"/></div></div></figure><p id="07ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种实现的一个主要问题是硬编码的密码作为过程代码逻辑的一部分被传递。</p><p id="ef46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">CloudSQL提供了一个数据库标志“<em class="lq">allow _ password _ local _ connections</em>”，可以在不需要传递密码的情况下实现本地连接。我们可以启用它，并更改以前的代码逻辑，使其不包括密码，如下所示。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="5627" class="jr js hi kw b fi la lb l lc ld">PERFORM dblink_connect('conn','dbname=dblinksample user=postgres port=5432');</span></pre><p id="86c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦设置了数据库标志，我们就可以对所有本地连接使用dblink，而无需传递用户凭据。</p><figure class="kr ks kt ku fd lg er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lr"><img src="../Images/b0c8f90c16ca2f1df75d5d3374bdcd0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LJmgxkFbW8CvTzRWzlmZzQ.png"/></div></div></figure><figure class="kr ks kt ku fd lg er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es ls"><img src="../Images/5dec573580a29f23e3e1dab2a2bde6a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l7ID0-89FsHxnbIEo_dMbA.png"/></div></div></figure><p id="8058" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以在创建外部服务器和用户映射时扩展类似的行为。它可用于来自dblink的任何本地连接。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="9b7d" class="jr js hi kw b fi la lb l lc ld">CREATE SERVER loopback_dblink FOREIGN DATA WRAPPER dblink_fdw OPTIONS (dbname 'dblinksample');<br/>CREATE USER MAPPING FOR postgres SERVER loopback_dblink<br/>OPTIONS (user 'dbuser');</span></pre><figure class="kr ks kt ku fd lg er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lt"><img src="../Images/fa4b47dab7ad7a6257b7714ed9542123.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sCnG4hSZhORGJkMB3iomdw.png"/></div></div></figure><p id="683e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">带有云sql标志的整体dblink实现有助于我们实现与Oracle中自治事务类似的行为。由于不需要使用CloudSQL提供的标志的密码，我们可以避免从dblink作为部分或本地连接传递。<br/>它还增加了额外的连接开销，因此在实现模块之前需要进行测试并相应地衡量影响。</p></div></div>    
</body>
</html>