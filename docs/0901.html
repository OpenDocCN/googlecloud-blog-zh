<html>
<head>
<title>Hands on Knative — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">动手实践—第一部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/hands-on-knative-part-1-f2d5ce89944e?source=collection_archive---------0-----------------------#2019-02-04">https://medium.com/google-cloud/hands-on-knative-part-1-f2d5ce89944e?source=collection_archive---------0-----------------------#2019-02-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/a44d1c252742d6d171494cd9adceace2.png" data-original-src="https://miro.medium.com/v2/resize:fit:400/format:webp/1*cTktfYF4u0fHBmZLTYjnKA.png"/></div></figure><p id="4911" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最近我一直在调查<a class="ae jk" href="https://github.com/knative/docs" rel="noopener ugc nofollow" target="_blank"> Knative </a>。在这个由3部分组成的博客系列中，我想解释一下我的收获，并展示一些我在GitHub上发布的<a class="ae jk" href="https://github.com/meteatamel/knative-tutorial" rel="noopener ugc nofollow" target="_blank">技巧教程</a>中的例子。</p><h1 id="a536" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">Knative到底是什么？</h1><p id="2221" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">Knative 是一个开源构建块集合，用于运行在Kubernetes上的无服务器容器。</p><p id="2f83" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">此时，您可能想知道:“Kubernetes，无服务器，这是怎么回事？”但是，仔细想想，还是有道理的。Kubernetes是非常受欢迎的容器管理平台。应用程序开发人员希望以无服务器方式运行他们的代码。Knative通过一组构建模块将两个世界结合在一起。</p><p id="2db7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">谈到构造块，它由3个主要组件组成:</p><ul class=""><li id="cc55" class="ko kp hi io b ip iq it iu ix kq jb kr jf ks jj kt ku kv kw bi translated"><a class="ae jk" href="https://github.com/knative/docs/tree/master/serving" rel="noopener ugc nofollow" target="_blank"> Knative Serving </a>用于无服务器容器的快速部署和自动扩展。</li><li id="0285" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj kt ku kv kw bi translated"><a class="ae jk" href="https://github.com/knative/docs/tree/master/eventing" rel="noopener ugc nofollow" target="_blank"> Knative Eventing </a>用于松散耦合、事件驱动的服务。</li><li id="3f5d" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj kt ku kv kw bi translated"><a class="ae jk" href="https://github.com/knative/docs/tree/master/build" rel="noopener ugc nofollow" target="_blank"> Knative Build </a>轻松实现代码到注册中心容器的工作流。</li></ul><p id="97b9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们从被动发球开始。</p><h1 id="1e4f" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">什么是Knative发球？</h1><p id="8e0c" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">简而言之，Knative Serving允许快速部署和自动伸缩无服务器容器。您只需指定要部署的容器，Knative负责如何创建该容器以及将流量路由到该容器的细节。一旦你把你的无服务器容器部署成一个Knative服务，你就可以获得自动伸缩、每次配置改变的修改、不同修改之间的流量分流等特性。</p><h1 id="9434" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">Hello World上菜</h1><p id="3783" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">要将您的代码部署为Knative服务，您需要:</p><ol class=""><li id="c36b" class="ko kp hi io b ip iq it iu ix kq jb kr jf ks jj lc ku kv kw bi translated">将你的代码容器化，并将图像推送到公共注册中心。</li><li id="ea11" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lc ku kv kw bi translated">创建一个服务yaml文件，告诉Knative在哪里可以找到容器映像及其任何配置。</li></ol><p id="fcfb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在我的Knative教程的<a class="ae jk" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/01-helloworldserving.md" rel="noopener ugc nofollow" target="_blank"> Hello World Serving </a>部分，我详细描述了这些步骤，但在这里重述一下，这是最小Knative服务定义<code class="du ld le lf lg b">service-v1.yaml</code>的样子:</p><pre class="lh li lj lk fd ll lg lm ln aw lo bi"><span id="b275" class="lp jm hi lg b fi lq lr l ls lt">apiVersion: serving.knative.dev/v1alpha1<br/>kind: Service<br/>metadata:<br/>  name: helloworld-csharp<br/>  namespace: default<br/>spec:<br/>  runLatest:<br/>    configuration:<br/>      revisionTemplate:<br/>        spec:<br/>          container:<br/>            # replace {username} with your DockerHub <br/>            image: docker.io/{username}/helloworld-csharp:v1<br/>            env:<br/>              - name: TARGET<br/>                value: "C# Sample v1"</span></pre><p id="18cd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du ld le lf lg b">runLatest</code>暗示我们希望使用指定的容器和配置立即部署最新版本的代码。部署服务:</p><pre class="lh li lj lk fd ll lg lm ln aw lo bi"><span id="9178" class="lp jm hi lg b fi lq lr l ls lt">kubectl apply -f service-v1.yaml</span></pre><p id="8dac" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这一点上，你会看到一些东西被创建。首先，创建一个Knative服务及其pod。其次，创建一个配置来捕获Knative服务的当前配置。第三，创建修订作为当前配置的快照。最后，创建一个路由，将流量定向到新创建的Knative服务:</p><pre class="lh li lj lk fd ll lg lm ln aw lo bi"><span id="bd17" class="lp jm hi lg b fi lq lr l ls lt">kubectl get pod,ksvc,configuration,revision,route<br/>NAME                                                      READY     STATUS    RESTARTS   <br/>pod/helloworld-csharp-00001-deployment-7fdb5c5dc9-wf2bp   3/3       Running   0          <br/><br/>NAME                                            <br/>service.serving.knative.dev/helloworld-csharp   <br/><br/>NAME                                                  <br/>configuration.serving.knative.dev/helloworld-csharp   <br/><br/>NAME                                                   <br/>revision.serving.knative.dev/helloworld-csharp-00001   <br/><br/>NAME                                          <br/>route.serving.knative.dev/helloworld-csharp</span></pre><h1 id="1038" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">更改配置</h1><p id="3630" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">在Knative Serving中，每当您更改<a class="ae jk" href="https://github.com/knative/serving/blob/master/docs/spec/spec.md#service" rel="noopener ugc nofollow" target="_blank">服务</a>的<a class="ae jk" href="https://github.com/knative/serving/blob/master/docs/spec/spec.md#configuration" rel="noopener ugc nofollow" target="_blank">配置</a>时，它都会创建一个新的<a class="ae jk" href="https://github.com/knative/serving/blob/master/docs/spec/spec.md#revision" rel="noopener ugc nofollow" target="_blank">版本</a>，这是代码的一个时间点快照。它还创建了一条新的<a class="ae jk" href="https://github.com/knative/serving/blob/master/docs/spec/spec.md#route" rel="noopener ugc nofollow" target="_blank">路由</a>，新版本将开始接收流量。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div class="er es lu"><img src="../Images/53e6eb4d3a7d2e5dc808680c4540c27a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*B6PXYFlpWOYNBDU-lpic4g.png"/></div></figure><p id="6837" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在我的Knative教程的<a class="ae jk" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/03-changeconfig.md" rel="noopener ugc nofollow" target="_blank"> Change Configuration </a>部分，您可以看到更改Knative服务的环境变量或容器映像是如何触发新版本的创建的。</p><h1 id="2266" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">流量分流</h1><p id="cb3c" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">在Knative中，您可以非常容易地在不同版本的服务之间划分流量。例如，如果您想要推出新版本(0004)并将20%的流量路由到该版本，您可以执行以下操作:</p><pre class="lh li lj lk fd ll lg lm ln aw lo bi"><span id="077b" class="lp jm hi lg b fi lq lr l ls lt">apiVersion: serving.knative.dev/v1alpha1<br/>kind: Service<br/>metadata:<br/>  name: helloworld-csharp<br/>  namespace: default<br/>spec:<br/>  release:<br/>    # Ordered list of 1 or 2 revisions. <br/>    # First revision is traffic target "current"<br/>    # Second revision is traffic target "candidate"<br/>    revisions: ["helloworld-csharp-00001", "helloworld-csharp-00004"]<br/>    rolloutPercent: 20 # Percent [0-99] of traffic to route to "candidate" revision<br/>    configuration:<br/>      revisionTemplate:<br/>        spec:<br/>          container:<br/>            # Replace {username} with your actual DockerHub<br/>            image: docker.io/{username}/helloworld-csharp:v1<br/>            env:<br/>              - name: TARGET<br/>                value: "C# Sample v4"</span></pre><p id="493d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请注意，我们从<code class="du ld le lf lg b">runLatest</code>模式更改为<code class="du ld le lf lg b">release</code>模式，以便为我们的服务分流流量。</p><p id="132c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我的Knative教程中的<a class="ae jk" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/04-trafficsplitting.md" rel="noopener ugc nofollow" target="_blank">流量分割</a>部分有更多的例子，比如如何在现有版本之间分割流量。</p><h1 id="5ff0" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">与其他服务集成</h1><p id="d2b3" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">Knative服务非常适合与其他服务集成。例如，您可以使用Knative服务作为Twilio等外部服务的webhook。如果您有Twilio号码，您可以回复通过电话服务发送到该号码的短信。</p><p id="b216" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" href="https://github.com/meteatamel/knative-tutorial/blob/master/docs/05-twiliointegration.md" rel="noopener ugc nofollow" target="_blank">与Twilio集成</a>我的Knative教程中有详细的步骤，但本质上可以归结为创建代码来处理Twilio消息:</p><pre class="lh li lj lk fd ll lg lm ln aw lo bi"><span id="3169" class="lp jm hi lg b fi lq lr l ls lt">[Route("[controller]")]<br/>    public class SmsController : TwilioController<br/>    {<br/>        [HttpGet]<br/>        public TwiMLResult Index(SmsRequest incomingMessage)<br/>        {<br/>            var messagingResponse = new MessagingResponse();<br/>            messagingResponse.Message("The Knative copy cat says: " + incomingMessage.Body);<br/>            return TwiML(messagingResponse);<br/>        }<br/>    }</span></pre><p id="1d83" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">从it中定义有价值的服务:</p><pre class="lh li lj lk fd ll lg lm ln aw lo bi"><span id="4f52" class="lp jm hi lg b fi lq lr l ls lt">apiVersion: serving.knative.dev/v1alpha1<br/>kind: Service<br/>metadata:<br/>  name: twilio-csharp<br/>  namespace: default<br/>spec:<br/>  runLatest:<br/>    configuration:<br/>      revisionTemplate:<br/>        spec:<br/>          container:<br/>            # Replace {username} with your actual DockerHub<br/>            image: docker.io/{username}/twilio-csharp:v1</span></pre><p id="0045" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后将Knative服务指定为Twilio SMS消息的webhook:</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es lv"><img src="../Images/3842538adbc7c7e1161208d164634d4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5lFMRZBcT8NsL_S0mESqSA.png"/></div></div></figure></div><div class="ab cl ma mb gp mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hb hc hd he hf"><p id="208c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">就这样了。在下一篇文章中，我将谈论<a class="ae jk" href="https://github.com/knative/docs/tree/master/eventing" rel="noopener ugc nofollow" target="_blank">决定性事件</a>。</p></div></div>    
</body>
</html>