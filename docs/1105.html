<html>
<head>
<title>Continuous Deployment to Cloud Run Services based on a New Container Image.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于新的容器映像持续部署到云运行服务。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/continuous-deployment-to-cloud-run-services-based-on-a-new-container-image-bccd776b7357?source=collection_archive---------0-----------------------#2019-08-05">https://medium.com/google-cloud/continuous-deployment-to-cloud-run-services-based-on-a-new-container-image-bccd776b7357?source=collection_archive---------0-----------------------#2019-08-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ed66cd5ed2d6eb4e8dd8445e3ecd5aa0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wptZbznyhyxnGfel7c_xvw.jpeg"/></div></div></figure><blockquote class="iq ir is"><p id="5014" class="it iu iv iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="hi">本文介绍了一种基于新容器映像持续部署云运行服务修订版的方法。</em></p></blockquote><h1 id="11f9" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">持续部署</h1><p id="09e1" class="pw-post-body-paragraph it iu hi iw b ix kq iz ja jb kr jd je ks kt jh ji ku kv jl jm kw kx jp jq jr hb bi translated">持续部署是软件发布的一种策略，其中任何通过自动化测试阶段的代码提交都被自动发布到生产环境中，做出对软件用户可见的更改。</p><h1 id="6635" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">云运行</h1><p id="0191" class="pw-post-body-paragraph it iu hi iw b ix kq iz ja jb kr jd je ks kt jh ji ku kv jl jm kw kx jp jq jr hb bi translated">Cloud Run是一个托管计算平台，使您能够在其无服务器环境中运行无状态容器，并抽象出所有基础架构管理，因此您可以专注于最重要的事情—构建优秀的应用程序。</p><p id="41ab" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je ks jg jh ji ku jk jl jm kw jo jp jq jr hb bi translated">如果你是云运行的新手，可以在这里随意阅读它的文档<a class="ae ky" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="a057" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je ks jg jh ji ku jk jl jm kw jo jp jq jr hb bi translated"><strong class="iw hj">基于一个容器映像跨多个未知服务在云上连续部署可能会很有挑战性。</strong></p><blockquote class="kz"><p id="62d4" class="la lb hi bd lc ld le lf lg lh li jr dx translated"><em class="lj">当您将新图像推送到标签引用时，Google Cloud Run不会自动部署修订。有很多很好的理由说明它不会。</em></p><p id="991b" class="la lb hi bd lc ld le lf lg lh li jr dx translated"><em class="lj">部署云运行修订版时，它会计算映像引用的sha256哈希。</em></p><p id="dd54" class="la lb hi bd lc ld le lf lg lh li jr dx translated"><em class="lj">因此，当您使用:latest标记指定容器映像时，Cloud Run使用其sha256引用来部署和扩展您服务的修订版。当您更新:latest标记以指向新图像时，云运行仍将使用以前的图像。否则，这将是一个危险的滑坡。— </em> <a class="ae ky" href="https://stackoverflow.com/a/56919456/4620227" rel="noopener ugc nofollow" target="_blank"> <em class="lj">阿赫迈特上SO </em> </a></p></blockquote><h1 id="2919" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp bi translated">单一云运行服务的持续部署</h1><p id="20a7" class="pw-post-body-paragraph it iu hi iw b ix kq iz ja jb kr jd je ks kt jh ji ku kv jl jm kw kx jp jq jr hb bi translated">Google Cloud构建触发器可用于在代码更新时构建和推送新的容器映像，您还可以在构建配置中添加另一个步骤，以实现持续部署。</p><p id="071e" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je ks jg jh ji ku jk jl jm kw jo jp jq jr hb bi translated">这是一个云构建配置的例子，它构建新的图像并将其推送到谷歌容器注册中心(GCR)，它还部署了一个新版本的云运行服务<strong class="iw hj">仪表板</strong>。</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="1d7f" class="lw jt hi ls b fi lx ly l lz ma"># cloudbuild.yaml<br/># Build and Push New Image to Google Container Registry<br/>- name: "gcr.io/kaniko-project/executor:latest"<br/>  args: ["--cache=true", "--cache-ttl=48h", "--destination=gcr.io/project/dashboard:latest"]</span><span id="6bf6" class="lw jt hi ls b fi mb ly l lz ma"># Extra step to Deploy New Revision to Cloud Run<br/>- name: "gcr.io/cloud-builders/gcloud"<br/>  args: ['beta', 'run', 'deploy', 'dashboard', '--image', 'gcr.io/project/dashboard:latest', '--region', 'us-central1', '--allow-unauthenticated', '--platform', 'managed']</span></pre><h1 id="60aa" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">多个云运行服务的持续部署</h1><p id="a678" class="pw-post-body-paragraph it iu hi iw b ix kq iz ja jb kr jd je ks kt jh ji ku kv jl jm kw kx jp jq jr hb bi translated">如果您需要更新多个云运行服务，只要您知道每个云运行服务的服务名称，就可以在您的云构建配置中有额外的步骤来部署云运行服务。</p><blockquote class="iq ir is"><p id="9b72" class="it iu iv iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="hi">在</em><a class="ae ky" href="https://mercurie.ng" rel="noopener ugc nofollow" target="_blank"><em class="hi">Mercurie</em></a><em class="hi">，我们将云运行用于多租户—这涉及到为每个新客户端(或租户)自动创建新服务。</em></p></blockquote><p id="c113" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je ks jg jh ji ku jk jl jm kw jo jp jq jr hb bi translated">为了实现跨商店的连续部署，您可以编写一个云函数，用更新后的容器映像将新的版本部署到您的多个云运行服务。其工作原理是通过发布/订阅订阅云构建的通知，然后触发云功能。</p><h1 id="4593" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">更新云运行服务的云功能</h1><p id="b95d" class="pw-post-body-paragraph it iu hi iw b ix kq iz ja jb kr jd je ks kt jh ji ku kv jl jm kw kx jp jq jr hb bi translated">云函数允许用户编写一次性的编程函数来监听云事件，比如构建。当云事件发生时，触发器通过执行一个动作来响应，例如发送云发布/订阅消息。</p><p id="f7c5" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je ks jg jh ji ku jk jl jm kw jo jp jq jr hb bi translated">当您的构建状态改变时，例如当您的构建被创建时，当您的构建转换到工作状态时，以及当您的构建完成时，Cloud Build在Google Cloud Pub/Sub主题上发布消息。</p><p id="109f" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je ks jg jh ji ku jk jl jm kw jo jp jq jr hb bi translated">Cloud Build将这些构建更新消息发布到的发布/订阅主题称为<strong class="iw hj"> cloud-builds </strong>，当您启用Cloud Build API时，它会自动为您创建。每条消息都包含构建资源的JSON表示，消息的属性字段包含构建的惟一ID和构建的状态。</p><p id="a34a" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je ks jg jh ji ku jk jl jm kw jo jp jq jr hb bi translated">访问<a class="ae ky" href="https://console.cloud.google.com/functions/" rel="noopener ugc nofollow" target="_blank">云功能</a>和<em class="iv">创建功能</em></p><ul class=""><li id="c3bd" class="mc md hi iw b ix iy jb jc ks me ku mf kw mg jr mh mi mj mk bi translated">输入您的函数名:<strong class="iw hj"> updateCloudRunServices </strong></li><li id="bc1f" class="mc md hi iw b ix ml jb mm ks mn ku mo kw mp jr mh mi mj mk bi translated">设置<em class="iv">内存分配</em> : <strong class="iw hj"> 256MB </strong></li><li id="2c70" class="mc md hi iw b ix ml jb mm ks mn ku mo kw mp jr mh mi mj mk bi translated">设置<em class="iv">触发</em> : <strong class="iw hj">云发布/订阅</strong></li><li id="5b75" class="mc md hi iw b ix ml jb mm ks mn ku mo kw mp jr mh mi mj mk bi translated">设置<em class="iv">主题</em> : <strong class="iw hj">云构建</strong></li><li id="eba1" class="mc md hi iw b ix ml jb mm ks mn ku mo kw mp jr mh mi mj mk bi translated"><em class="iv">源代码</em>:选择— <strong class="iw hj">行内编辑器</strong></li><li id="99ba" class="mc md hi iw b ix ml jb mm ks mn ku mo kw mp jr mh mi mj mk bi translated"><em class="iv">运行时</em> : <strong class="iw hj"> Node.js 8 </strong></li><li id="1a35" class="mc md hi iw b ix ml jb mm ks mn ku mo kw mp jr mh mi mj mk bi translated"><em class="iv">执行</em>的函数:<strong class="iw hj"> updateCloudRunServices </strong></li></ul><p id="dae8" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je ks jg jh ji ku jk jl jm kw jo jp jq jr hb bi translated">将以下代码片段粘贴到内联编辑器中，并创建您的函数。</p><figure class="ln lo lp lq fd ij"><div class="bz dy l di"><div class="mq mr l"/></div></figure><p id="6b43" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je ks jg jh ji ku jk jl jm kw jo jp jq jr hb bi translated">您现在有了一个云函数，它在源代码更新时监听来自云构建的发布/订阅通知，这还会构建一个新的容器映像，并使用云构建触发器推送到GCR。</p><p id="f05b" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je ks jg jh ji ku jk jl jm kw jo jp jq jr hb bi translated">它检查更新是否针对<strong class="iw hj">仪表板</strong>源代码回购，以及构建状态是否为<strong class="iw hj">成功</strong>，然后调用<strong class="iw hj">updateDashboardRevisions</strong>方法，该方法使用<strong class="iw hj">令牌</strong>向云运行发出API请求，获取所有服务，使用容器映像<a class="ae ky" href="https://hashnode.com/util/redirect?url=http://gcr.io/project/dashboard:latest" rel="noopener ugc nofollow" target="_blank"><strong class="iw hj">【gcr.io/project/dashboard:latest】</strong></a>过滤它们以仅获取服务。</p><p id="7680" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je ks jg jh ji ku jk jl jm kw jo jp jq jr hb bi translated">然后创建包含步骤的新构建配置，并通过其API提交给云构建。这成功地更新了所有基于我们的容器映像<a class="ae ky" href="https://hashnode.com/util/redirect?url=http://gcr.io/project/dashboard:latest" rel="noopener ugc nofollow" target="_blank"><strong class="iw hj"/></a>的云运行服务。</p><h2 id="3290" class="lw jt hi bd ju ms mt mu jy mv mw mx kc ks my mz kg ku na nb kk kw nc nd ko ne bi translated">额外资源</h2><ul class=""><li id="3099" class="mc md hi iw b ix kq jb kr ks nf ku ng kw nh jr mh mi mj mk bi translated"><a class="ae ky" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank">谷歌云运行</a></li><li id="930b" class="mc md hi iw b ix ml jb mm ks mn ku mo kw mp jr mh mi mj mk bi translated"><a class="ae ky" href="https://cloud.google.com/cloud-build" rel="noopener ugc nofollow" target="_blank">谷歌云构建</a></li><li id="3960" class="mc md hi iw b ix ml jb mm ks mn ku mo kw mp jr mh mi mj mk bi translated"><a class="ae ky" href="https://cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">谷歌云功能</a></li><li id="8c2b" class="mc md hi iw b ix ml jb mm ks mn ku mo kw mp jr mh mi mj mk bi translated"><a class="ae ky" href="https://cloud.google.com/pubsub/" rel="noopener ugc nofollow" target="_blank">谷歌云发布/订阅</a></li><li id="ec17" class="mc md hi iw b ix ml jb mm ks mn ku mo kw mp jr mh mi mj mk bi translated"><a class="ae ky" href="https://github.com/GoogleCloudPlatform/awesome-google-cloud" rel="noopener ugc nofollow" target="_blank">牛逼的谷歌云平台</a></li></ul><blockquote class="kz"><p id="bfd4" class="la lb hi bd lc ld ni nj nk nl nm jr dx translated"><em class="lj">感谢通读！如果我错过了任何步骤，如果有些事情不太适合你，或者如果这个指南有帮助，请告诉我。</em></p></blockquote></div></div>    
</body>
</html>