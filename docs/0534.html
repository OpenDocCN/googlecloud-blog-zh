<html>
<head>
<title>Kubernetes NodePort vs LoadBalancer vs Ingress? When should I use what?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes节点端口vs负载平衡器vs入口？什么时候该用什么？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0?source=collection_archive---------0-----------------------#2018-03-11">https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0?source=collection_archive---------0-----------------------#2018-03-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="332a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最近有人问我NodePorts，LoadBalancers，Ingress有什么区别。它们都是将外部流量引入您的集群的不同方式，并且都是以不同的方式实现的。让我们来看看它们是如何工作的，以及何时使用它们。</p><p id="0864" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">注:</em> </strong> <em class="jd">这里的一切都适用于</em> <a class="ae je" href="https://cloud.google.com/gke" rel="noopener ugc nofollow" target="_blank"> <em class="jd"> Google Kubernetes引擎。</em> </a> <em class="jd">如果你运行在另一个云上，在prem上，用minikube，或者别的什么，这些会略有不同。我也不打算深入探讨技术细节。如果你有兴趣了解更多，那么</em> <a class="ae je" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank"> <em class="jd">官方文档</em> </a> <em class="jd">是一个很棒的资源！</em></p><h1 id="5653" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">ClusterIP</h1><p id="c6c9" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">ClusterIP服务是默认的Kubernetes服务。它为您提供了集群内的服务，集群内的其他应用程序可以访问该服务。没有外部访问。</p><p id="b1e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">ClusterIP服务的YAML如下所示:</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="bf5f" class="kr jg hi kn b fi ks kt l ku kv">apiVersion: v1<br/>kind: Service<br/>metadata:  <br/>  name: my-internal-service<br/>spec:<br/>  selector:    <br/>    app: my-app<br/>  type: ClusterIP<br/>  ports:  <br/>  - name: http<br/>    port: 80<br/>    targetPort: 80<br/>    protocol: TCP</span></pre><p id="c2fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您不能从互联网访问ClusterIP服务，我为什么要谈论它？原来您可以使用Kubernetes代理来访问它！</p><figure class="ki kj kk kl fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/8e30429577c86112a4f55665e9da79f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I4j4xaaxsuchdvO66V3lAg.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">感谢Ahmet Alp Balkan 提供的图表</figcaption></figure><p id="70a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启动Kubernetes代理:</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="b3e2" class="kr jg hi kn b fi ks kt l ku kv">$ kubectl proxy --port=8080</span></pre><p id="ace3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以通过Kubernetes API使用这个方案来访问这个服务:</p><p id="8ff7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">http://localhost:8080/API/v1/proxy/namespaces/<namespace>/services/<service-name>:<port-name>/</port-name></service-name></namespace></p><p id="d70b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，要访问我们上面定义的服务，您可以使用以下地址:</p><p id="be16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">http://localhost:8080/API/v1/proxy/namespaces/default/services/my-internal-service:http/</p><h2 id="d39f" class="kr jg hi bd jh lk ll lm jl ln lo lp jp iq lq lr jt iu ls lt jx iy lu lv kb lw bi translated">你什么时候会用这个？</h2><p id="45f3" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">在一些场景中，您会使用Kubernetes代理来访问您的服务。</p><ol class=""><li id="d81b" class="lx ly hi ih b ii ij im in iq lz iu ma iy mb jc mc md me mf bi translated">调试您的服务，或者出于某种原因从您的笔记本电脑直接连接到它们</li><li id="194b" class="lx ly hi ih b ii mg im mh iq mi iu mj iy mk jc mc md me mf bi translated">允许内部流量、显示内部仪表盘等。</li></ol><p id="1d6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为这种方法要求您以经过身份验证的用户身份运行kubectl，所以您不应该使用这种方法将您的服务公开给internet，或者将其用于生产服务。</p><h1 id="25af" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">节点端口</h1><p id="e879" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">节点端口服务是将外部流量直接发送到您的服务的最原始的方式。顾名思义，NodePort在所有节点(虚拟机)上打开一个特定的端口，发送到该端口的任何流量都会被转发到该服务。</p><figure class="ki kj kk kl fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es ml"><img src="../Images/ccf4e44999cd07fc47ae0e054a91a1bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CdyUtG-8CfGu2oFC5s0KwA.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">这不是技术上最准确的图表，但我认为它说明了节点端口的工作原理</figcaption></figure><p id="3dca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">节点端口服务的YAML如下所示:</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="8085" class="kr jg hi kn b fi ks kt l ku kv">apiVersion: v1<br/>kind: Service<br/>metadata:  <br/>  name: my-nodeport-service<br/>spec:<br/>  selector:    <br/>    app: my-app<br/>  type: NodePort<br/>  ports:  <br/>  - name: http<br/>    port: 80<br/>    targetPort: 80<br/>    nodePort: 30036<br/>    protocol: TCP</span></pre><p id="4e14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本上，节点端口服务与普通的“ClusterIP”服务有两个不同之处。首先，类型是“节点端口”还有一个名为nodePort的附加端口，它指定在节点上打开哪个端口。如果你不指定这个端口，它会随机选择一个端口。大多数时候你应该让Kubernetes选择端口；正如thockin所说，有许多关于你可以使用哪些端口的警告。</p><h2 id="6ed8" class="kr jg hi bd jh lk ll lm jl ln lo lp jp iq lq lr jt iu ls lt jx iy lu lv kb lw bi translated">你什么时候会用这个？</h2><p id="9731" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">这种方法有很多缺点:</p><ol class=""><li id="e956" class="lx ly hi ih b ii ij im in iq lz iu ma iy mb jc mc md me mf bi translated">每个端口只能有一个服务</li><li id="672d" class="lx ly hi ih b ii mg im mh iq mi iu mj iy mk jc mc md me mf bi translated">您只能使用30000–32767端口</li><li id="03be" class="lx ly hi ih b ii mg im mh iq mi iu mj iy mk jc mc md me mf bi translated">如果您节点/虚拟机IP地址发生变化，您需要处理它</li></ol><p id="b606" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于这些原因，我不建议在生产中使用这种方法来直接公开您的服务。如果您正在运行一项不一定总是可用的服务，或者您对成本非常敏感，这种方法将适合您。这种应用程序的一个很好的例子是演示应用程序或临时的东西。</p><h1 id="0d96" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">负载平衡器</h1><p id="a163" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">负载平衡器服务是向互联网公开服务的标准方式。在GKE，这会启动一个<a class="ae je" href="https://cloud.google.com/compute/docs/load-balancing/network/" rel="noopener ugc nofollow" target="_blank">网络负载平衡器</a>，它会给你一个单一的IP地址，将所有流量转发给你的服务。</p><figure class="ki kj kk kl fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mm"><img src="../Images/7ebbe053e6a8c54a3850f8ecf1785912.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P-10bQg_1VheU9DRlvHBTQ.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">感谢<a class="li lj ge" href="https://medium.com/u/2cac56571879?source=post_page-----922f010849e0--------------------------------" rel="noopener" target="_blank"> Ahmet Alp Balkan </a>提供的图表</figcaption></figure><h2 id="d489" class="kr jg hi bd jh lk ll lm jl ln lo lp jp iq lq lr jt iu ls lt jx iy lu lv kb lw bi translated">你什么时候会用这个？</h2><p id="9151" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">如果您想直接公开服务，这是默认方法。您指定的端口上的所有流量都将被转发到服务。没有过滤，没有路由等。这意味着您可以向它发送几乎任何类型的流量，如HTTP、TCP、UDP、Websockets、gRPC或任何其他类型的流量。</p><p id="15ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最大的缺点是，您使用负载均衡器公开的每个服务都将获得自己的IP地址，并且您必须为每个公开的服务支付负载均衡器，这可能会非常昂贵！</p><h1 id="d3d1" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">进入</h1><p id="32f5" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">与上述所有例子不同，入口实际上不是一种服务。相反，它位于多个服务的前面，充当“智能路由器”或进入集群的入口点。</p><p id="c736" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用入口做许多不同的事情，并且有许多类型的入口控制器具有不同的功能。</p><p id="a7c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认的GKE入口控制器将为您启动一个<a class="ae je" href="https://cloud.google.com/compute/docs/load-balancing/http/" rel="noopener ugc nofollow" target="_blank"> HTTP(S)负载平衡器</a>。这将允许你基于路径和子域路由到后端服务。例如，您可以将foo.yourdomain.com上的所有内容发送给foo服务，将yourdomain.com/bar/路径下的所有内容发送给bar服务。</p><figure class="ki kj kk kl fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mn"><img src="../Images/43e4612e26cd1be4f5d82e31e49f2d99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KIVa4hUVZxg-8Ncabo8pdg.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">感谢<a class="li lj ge" href="https://medium.com/u/2cac56571879?source=post_page-----922f010849e0--------------------------------" rel="noopener" target="_blank"> Ahmet Alp Balkan </a>提供图表</figcaption></figure><p id="6ead" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">带有<a class="ae je" href="https://cloud.google.com/compute/docs/load-balancing/http/" rel="noopener ugc nofollow" target="_blank"> L7 HTTP负载平衡器</a>的GKE入口对象的YAML可能如下所示:</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="f505" class="kr jg hi kn b fi ks kt l ku kv">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: my-ingress<br/>spec:<br/>  backend:<br/>    serviceName: other<br/>    servicePort: 8080<br/>  rules:<br/>  - host: foo.mydomain.com<strong class="kn hj"><br/></strong>    http:<br/>      paths:<br/>      - backend:<br/>          serviceName: foo<br/>          servicePort: 8080<strong class="kn hj"><br/></strong>  - <!-- -->host: mydomain.com<br/>    http:<br/>      paths:<br/>      - path: /bar/*<br/>        backend:<br/>          serviceName: bar<br/>          servicePort: 8080</span></pre><h2 id="6ea6" class="kr jg hi bd jh lk ll lm jl ln lo lp jp iq lq lr jt iu ls lt jx iy lu lv kb lw bi translated">你什么时候会用这个？</h2><p id="c997" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">Ingress可能是公开您的服务的最强大的方法，但也可能是最复杂的。入口控制器有很多种，从<a class="ae je" href="https://cloud.google.com/kubernetes-engine/docs/tutorials/http-balancer" rel="noopener ugc nofollow" target="_blank">谷歌云负载平衡器</a>、<a class="ae je" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"> Nginx </a>、<a class="ae je" href="https://github.com/heptio/contour" rel="noopener ugc nofollow" target="_blank"> Contour </a>、<a class="ae je" href="https://istio.io/docs/tasks/traffic-management/ingress.html" rel="noopener ugc nofollow" target="_blank"> Istio </a>等等。还有入口控制器插件，如<a class="ae je" href="https://github.com/jetstack/cert-manager" rel="noopener ugc nofollow" target="_blank"> cert-manager </a>，它可以自动为您的服务提供SSL证书。</p><p id="c3b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果要在同一个IP地址下公开多个服务，并且这些服务都使用同一个L7协议(一般是HTTP)，那么Ingress是最有用的。如果您使用原生GCP集成，您只需支付一个负载均衡器，因为Ingress是“智能”的，您可以获得许多开箱即用的功能(如SSL、Auth、路由等)</p></div></div>    
</body>
</html>