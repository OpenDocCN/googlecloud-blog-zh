<html>
<head>
<title>Installing Tensorflow-GPU with NVIDIA CUDA on a Google Cloud Platform VM instance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google云平台虚拟机实例上安装Tensorflow-GPU和NVIDIA CUDA</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/installing-tensorflow-gpu-with-nvidia-cuda-on-a-google-cloud-platform-vm-instance-95521db9a957?source=collection_archive---------2-----------------------#2018-05-31">https://medium.com/google-cloud/installing-tensorflow-gpu-with-nvidia-cuda-on-a-google-cloud-platform-vm-instance-95521db9a957?source=collection_archive---------2-----------------------#2018-05-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="6100" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><em class="hi">作者:</em><a class="jh ji ge" href="https://medium.com/u/f9f20c8d4212?source=post_page-----95521db9a957--------------------------------" rel="noopener" target="_blank"><em class="hi">Megha Desai</em></a><em class="hi">，Searce软件工程师— ML/AI。最初发表于</em> <a class="ae jj" rel="noopener" href="/searce/installing-tensorflow-gpu-with-nvidia-cuda-on-a-google-cloud-platform-vm-instance-b059ea47e55c"> <em class="hi"> Searce工程博客</em> </a></p></blockquote><p id="9e6f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">作为一名软件工程师和Searce分析和机器学习团队的一部分，我试图在谷歌云平台上用Tensorflow-GPU和NVIDIA CUDA配置的VM实例构建一个项目。在设置过程中，我面临着许多挑战，我找不到一个合适的资源来整合每个步骤以实现目标。所以，我在这里写这篇文章，将详细描述每个步骤。我希望这将有助于那些试图在GCP做类似事情的人。</p><p id="56ab" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated"><em class="ik">详细步骤:</em></p><p id="6596" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated"><strong class="il hj"> <em class="ik"> 1。设置一个Google Cloud实例:</em> </strong>用自己选择的名称和地区创建一个实例(虽然不是所有地区都提供GPU)。我选择了<strong class="il hj"> <em class="ik">美国-西方1 </em> </strong>作为地区。在机器类型中，选择<strong class="il hj"> <em class="ik"> 4个vCPUs。</em> </strong>通过选择图形处理器的数量定制您的机器类型。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="ab fe cl js"><img src="../Images/5ceafe027cec568604c2cf706593a8ea.png" data-original-src="https://miro.medium.com/v2/format:webp/1*STeUVRGm57v7kWHVMb1-kg.png"/></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">实例配置</figcaption></figure><p id="8d09" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">在引导磁盘选项中，将操作系统映像更改为<strong class="il hj"> <em class="ik"> Ubuntu16.04 LTS。</em> </strong>你也可以增加引导盘大小。默认情况下是10 GB。我已经增加到50 GB了。允许实例的HTTP和HTTPS流量。之后点击<a class="ae jj" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="il hj"> <em class="ik">【管理】【磁盘】【联网】【SSH】按键</em> </strong> </a> <strong class="il hj"> <em class="ik"> </em> </strong>选项<strong class="il hj"> <em class="ik">。</em> </strong>您需要添加启动脚本，该脚本会自动下载显卡所需的NVIDIA GPU驱动程序。最新版本的脚本可以在这里找到<a class="ae jj" href="https://cloud.google.com/compute/docs/gpus/add-gpus" rel="noopener ugc nofollow" target="_blank"><strong class="il hj"><em class="ik"/></strong></a><strong class="il hj"><em class="ik"/></strong>或者你可以在GCP控制台本身的帮助选项中键入“gpu脚本”。为ubuntu-16.04 LTS和CUDA-9选择脚本。将以下脚本粘贴到<em class="ik">启动脚本</em>选项中。你可以在<em class="ik">启动脚本</em>选项中添加这个脚本，或者从<a class="ae jj" href="https://developer.nvidia.com/rdp/cudnn-download" rel="noopener ugc nofollow" target="_blank"> <strong class="il hj"> <em class="ik">站点</em></strong></a><strong class="il hj"><em class="ik"/></strong>安装CUDA驱动程序，但是我推荐使用下面的脚本。</p><p id="0da4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated"><strong class="il hj"> <em class="ik"> 2。连接到SSH服务器:</em> </strong>一旦实例设置完成，点击SSH按钮连接SSH服务器。要保持SSH服务器的最新状态，请点击命令。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="9470" class="ke kf hi ka b fi kg kh l ki kj">sudo apt-get update</span></pre><p id="a5af" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">完成后就可以去官方<a class="ae jj" href="https://www.tensorflow.org/install/install_linux#nvidia_requirements_to_run_tensorflow_with_gpu_support" rel="noopener ugc nofollow" target="_blank"> <strong class="il hj"> <em class="ik"> Tensorflow网站</em> </strong> </a>进行GPU安装了。在我们的情况下，已经满足了第一和第二指令。要获得CUDA的cuDNN库副本，我们需要获得NVIDIA会员资格。使用他们的官方<a class="ae jj" href="https://developer.nvidia.com/rdp/form/cudnn-download-survey" rel="noopener ugc nofollow" target="_blank"> <strong class="il hj"> <em class="ik">网站</em> </strong> </a> <strong class="il hj"> <em class="ik">可以免费成为NVIDIA开发者。完成后，您需要为您的实例下载一个合适的cuDNN版本。不同的操作系统有不同的选择。在我们的例子中，我们将使用<a class="ae jj" href="https://developer.nvidia.com/compute/machine-learning/cudnn/secure/v7.1.4/prod/9.0_20180516/cudnn-9.0-linux-x64-v7.1" rel="noopener ugc nofollow" target="_blank"> <em class="ik"> cuDNN v7.1.4库用于Linux </em> </a> <em class="ik">。</em>这是最重要的一步，因为对这个cuDNN版本有很多依赖。这个cuDNN版本是针对CUDA 9.0版本的。</em></strong></p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="ab fe cl js"><img src="../Images/f7be2c882fe69bd6f3e451a01effcb12.png" data-original-src="https://miro.medium.com/v2/format:webp/1*GtaYfSPS_cG0rRew0wJPZg.png"/></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">NVIDIA cuDNN下载</figcaption></figure><p id="881b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated"><strong class="il hj"> <em class="ik"> 3。上传并解包cuDNN tar文件:</em> </strong>要将cuDNN tar文件夹上传到您的实例，运行以下google cloud命令，</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="11a3" class="ke kf hi ka b fi kg kh l ki kj">gcloud compute scp /Users/meghadesai/Desktop/cudnn-9.0-linux-x64-v7.1.tgz &lt;username&gt;@test-gpu:~/</span></pre><p id="85ea" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">要检查文件是否上传到正确的目的地，使用<strong class="il hj"> <em class="ik"> ls </em> </strong>命令。你应该能找到。tar文件。要解包这个文件，使用下面的命令。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="2a93" class="ke kf hi ka b fi kg kh l ki kj">tar -xzvf cudnn-9.0-linux-x64-v7.1.tgz</span></pre><p id="1e0b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">解压文件后，使用下面的命令将其复制到cuda目录。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="3e52" class="ke kf hi ka b fi kg kh l ki kj">sudo cp cuda/include/cudnn.h /usr/local/cuda/include<br/>sudo cp cuda/lib64/libcudnn* /usr/local/cuda/lib64<br/>sudo chmod a+r /usr/local/cuda/include/cudnn.h /usr/local/cuda/lib64/libcudnn*</span></pre><p id="3194" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated"><strong class="il hj"> <em class="ik"> 4。安装所有必要的python包:</em> </strong>在下载cuDNN库的同时，我们可以安装所有必要的python包，将来可能会用到。使用以下命令安装<strong class="il hj"> <em class="ik"> ipython </em> </strong>和<strong class="il hj"> <em class="ik"> pip </em> </strong>。对于每个是/否问题，按<strong class="il hj"><em class="ik">【y】</em></strong>安装。确保您正在为<strong class="il hj"> <em class="ik"> python3 </em> </strong> <em class="ik">获取<strong class="il hj"> <em class="ik"> pip </em> </strong>。</em></p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="cf1c" class="ke kf hi ka b fi kg kh l ki kj">sudo apt-get install ipython</span><span id="7735" class="ke kf hi ka b fi kk kh l ki kj">sudo apt-get install python3-pip</span></pre><p id="ef33" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">我将来会用到的更多python包有<strong class="il hj"> <em class="ik"> numpy，pandas，scipy </em> </strong>。您可以根据需要安装这些包，但是我建议安装基本的python包。使用以下命令安装。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="609d" class="ke kf hi ka b fi kg kh l ki kj">sudo pip3 install numpy scipy matplotlib ipython jupyter pandas sympy nose</span></pre><p id="2150" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">安装所有这些软件包可能需要一些时间。同时，你可以在这里   <strong class="il hj"> <em class="ik">了解更多关于NVIDIA cuDNN库及其特性<a class="ae jj" href="https://developer.nvidia.com/cudnn" rel="noopener ugc nofollow" target="_blank"> <strong class="il hj"> <em class="ik">。</em>T9】</strong></a></em></strong></p><p id="8792" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">安装完以上所有软件包后，运行以下命令。这个命令是必需的，因为我们将从源使用Tensorflow。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="947b" class="ke kf hi ka b fi kg kh l ki kj">sudo apt-get install openjdk-8-jdk git python-dev python3-dev python-numpy python3-numpy python-six python3-six build-essential python-pip python3-pip python-virtualenv swig python-wheel python3-wheel libcurl3-dev libcupti-dev</span></pre><p id="e5dd" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">现在，运行下面的命令。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="8c7b" class="ke kf hi ka b fi kg kh l ki kj">nano ~/.bashrc</span></pre><p id="8f84" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">添加下面两行代码，以确保我们的VM实例知道我们在上一步中上传和解包的CUDA文件在哪里。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="4af7" class="ke kf hi ka b fi kg kh l ki kj">export LD_LIBRARY_PATH=”$LD_LIBRARY_PATH:/usr/local/cuda/lib64:/usr/local/cuda/extras/CUPTI/lib64" <br/>export CUDA_HOME=/usr/local/cuda</span></pre><p id="29c1" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">然后，使用source命令重新加载该文件。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="065e" class="ke kf hi ka b fi kg kh l ki kj">source ~/.bashrc</span></pre><p id="53c0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">现在，我们正在为google cloud apis添加<strong class="il hj"> <em class="ik"> bazel </em> </strong>库。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="b39e" class="ke kf hi ka b fi kg kh l ki kj">echo “deb [arch=amd64] <a class="ae jj" href="https://www.youtube.com/redirect?redir_token=Y03xwRj9jpR5xoyUmQ7BbZtTfs98MTUyNzc2MDU3MkAxNTI3Njc0MTcy&amp;event=video_description&amp;v=abEf3wQJBmE&amp;q=http%3A%2F%2Fstorage.googleapis.com%2Fbazel-apt" rel="noopener ugc nofollow" target="_blank">http://storage.googleapis.com/bazel-apt</a> stable jdk1.8” | sudo tee /etc/apt/sources.list.d/bazel.list</span><span id="3c3a" class="ke kf hi ka b fi kk kh l ki kj">curl <a class="ae jj" href="https://www.youtube.com/redirect?redir_token=Y03xwRj9jpR5xoyUmQ7BbZtTfs98MTUyNzc2MDU3MkAxNTI3Njc0MTcy&amp;event=video_description&amp;v=abEf3wQJBmE&amp;q=https%3A%2F%2Fbazel.build%2Fbazel-release.pub.gpg" rel="noopener ugc nofollow" target="_blank">https://bazel.build/bazel-release.pub...</a> | sudo apt-key add -</span><span id="3eb0" class="ke kf hi ka b fi kk kh l ki kj">sudo apt-get install bazel<br/>sudo apt-get upgrade bazel</span></pre><p id="b60f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated"><strong class="il hj"> <em class="ik"> 5。在实例上安装Tensorflow:</em></strong>现在，使用以下命令将tensor flow的git目录克隆到您的实例。它将安装最新版本的tensorflow。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="cfec" class="ke kf hi ka b fi kg kh l ki kj">git clone <a class="ae jj" href="https://www.youtube.com/redirect?redir_token=Y03xwRj9jpR5xoyUmQ7BbZtTfs98MTUyNzc2MDU3MkAxNTI3Njc0MTcy&amp;event=video_description&amp;v=abEf3wQJBmE&amp;q=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow" rel="noopener ugc nofollow" target="_blank">https://github.com/tensorflow/tensorflow</a></span><span id="6bfa" class="ke kf hi ka b fi kk kh l ki kj">cd ~/tensorflow</span><span id="badc" class="ke kf hi ka b fi kk kh l ki kj">./configure</span></pre><p id="c8dc" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">现在，按照这个特定的顺序运行以下命令。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="27b3" class="ke kf hi ka b fi kg kh l ki kj">/usr/bin/python3.5</span></pre><p id="1c99" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">运行该命令后，按<em class="ik">回车</em>直到出现<em class="ik">请输入想要使用的Python库路径</em>。点击下面的命令。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="7242" class="ke kf hi ka b fi kg kh l ki kj">/usr/local/lib/python3.5/dist-packages</span></pre><p id="25b2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">按下<em class="ik">键，输入</em>键，直到到达<em class="ik">是否希望使用CUDA支持构建TensorFlow？</em>"按下'<strong class="il hj"> <em class="ik"> y </em> </strong>'作为回复，并回车。然后，运行以下命令将文件复制到tensorflow temp文件夹。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="05ef" class="ke kf hi ka b fi kg kh l ki kj">bazel build — config=opt — config=cuda //tensorflow/tools/pip_package:build_pip_package</span><span id="3e46" class="ke kf hi ka b fi kk kh l ki kj">bazel-bin/tensorflow/tools/pip_package/build_pip_package /tmp/tensorflow_pkg</span></pre><p id="e810" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">这可能需要一些时间来运行，但请记住<strong class="il hj"> <em class="ik">耐心是关键！:))</em>T33】</strong></p><p id="82f5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">一旦成功实现了用于<strong class="il hj"> <em class="ik"> bazel </em> </strong>文件的命令，运行以下命令并退出SSH窗口。</p><pre class="jn jo jp jq fd jz ka kb kc aw kd bi"><span id="c010" class="ke kf hi ka b fi kg kh l ki kj">sudo pip3 install /tmp/tensorflow_pkg/tensorflow [PRESS TAB TO COMPLETE FILENAME]</span></pre><p id="feda" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">现在，再次连接到SSH服务器窗口，尝试以下代码来检查GPU是否已设置并被使用。键入<em class="ik"/><strong class="il hj"><em class="ik">python 3</em></strong>。它将打开python解释器并实现以下代码。</p><figure class="jn jo jp jq fd jr"><div class="bz dy l di"><div class="kl km l"/></div></figure><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="ab fe cl js"><img src="../Images/069e66bd9a7a54c1ba32f9acc5e64de3.png" data-original-src="https://miro.medium.com/v2/format:webp/1*xrP6gDwKAumZF73MMC6DDQ.png"/></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">代码的输出</figcaption></figure><p id="90b6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">如果您得到类似的输出，那么您已经成功地设置了GPU，您就大功告成了！！！</p><p id="7876" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">感谢您阅读本文，我希望您在下一个超级下一代项目的VM实例上成功安装了CUDA。</p><p id="3f9a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">谢谢大家！</p></div></div>    
</body>
</html>