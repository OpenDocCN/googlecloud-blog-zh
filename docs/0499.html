<html>
<head>
<title>OpenCensus w/ Prometheus &amp; Stackdriver</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开放人口普查，带普罗米修斯和斯塔克德瑞</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/opencensus-and-prometheus-66812a7503f?source=collection_archive---------0-----------------------#2018-01-22">https://medium.com/google-cloud/opencensus-and-prometheus-66812a7503f?source=collection_archive---------0-----------------------#2018-01-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="3110" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">2018<strong class="il hj">–02–13</strong>:自从写了这个帖子，Golang SDK就在发展，这里提到的bug也解决了。我写了一篇新的<a class="ae jh" rel="noopener" href="/@DazWilkin/return-to-opencensus-42623f1b55b8">帖子</a>来反映@JDB对图书馆的更新。请阅读那个帖子。感谢<a class="ji jj ge" href="https://medium.com/u/1737b4e67578?source=post_page-----66812a7503f--------------------------------" rel="noopener" target="_blank"> JBD </a>！</p></blockquote><p id="25e2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">我的一个客户的建筑师告诉我OpenCensus的存在。我想我应该在我将Kubernetes部署到我的Raspberry Pi集群的时候检查一下(见Alex Ellis的精彩<a class="ae jh" href="https://gist.github.com/alexellis/fdbc90de7691a1b9edb545c17da2d975" rel="noopener ugc nofollow" target="_blank">帖子</a>)。</p><p id="b62e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">OpenCensus是谷歌发起的一个项目，“自动从你的应用程序中收集轨迹和指标，在本地显示，并将其发送给任何分析工具”。</p><p id="d909" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">我将向您展示使用Golang与<a class="ae jh" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>和<a class="ae jh" href="https://cloud.google.com/stackdriver/" rel="noopener ugc nofollow" target="_blank"> Stackdriver </a>的两种工作方式……这是一个小骗局，因为区别实际上是一行代码的更改，但这展示了该工具的实用性。</p><h2 id="4d22" class="jn jo hi bd jp jq jr js jt ju jv jw jx jk jy jz ka jl kb kc kd jm ke kf kg kh bi translated">设置</h2><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="402e" class="jn jo hi kn b fi kr ks l kt ku">PROJECT=[[YOUR-PROJECT]] # Only needed for Stackdriver<br/>DIR="/tmp/OpenCensus"</span><span id="dcbc" class="jn jo hi kn b fi kv ks l kt ku">mkdir -p ${DIR}/go<br/>export GOPATH=${DIR}/go<br/>export PATH=${PATH}:${GOPATH}/bin</span><span id="4c99" class="jn jo hi kn b fi kv ks l kt ku">go get -u go.opencensus.io/...</span></pre><h2 id="ad23" class="jn jo hi bd jp jq jr js jt ju jv jw jx jk jy jz ka jl kb kc kd jm ke kf kg kh bi translated">公开普查</h2><p id="9cbf" class="pw-post-body-paragraph ii ij hi il b im kw io ip iq kx is it jk ky iw ix jl kz ja jb jm la je jf jg hb bi translated">Golang SDK中有一个<a class="ae jh" href="https://github.com/census-instrumentation/opencensus-go/pull/191" rel="noopener ugc nofollow" target="_blank"> bug </a>，当创建多个度量时会出现这个bug。目前，这里的普罗米修斯<a class="ae jh" href="https://github.com/census-instrumentation/opencensus-go/blob/master/examples/stats/prometheus/main.go" rel="noopener ugc nofollow" target="_blank">样本</a>简化为使用一个单一的测量；这是对示例的一个小改动，这样它就可以工作了:</p><figure class="ki kj kk kl fd lb"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="0e53" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">你可以在<code class="du le lf lg kn b">${DIR}/go/src</code>下的任何地方创建这个文件。惯例是，如果你有一个，你就在<code class="du le lf lg kn b">github.com/[YOUR-GITHUB]</code>下创建它。但是，如果你愿意，你可以简单地在<code class="du le lf lg kn b">${DIR}/go/src</code>下创建一个名为prometheus.go的文件。</p><p id="c193" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">从该目录中:</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="5cf8" class="jn jo hi kn b fi kr ks l kt ku">go run [YOUR-FILENAME].go</span></pre><p id="f510" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">应报告:</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="7505" class="jn jo hi kn b fi kr ks l kt ku">2018/01/21 16:02:37 Serving at :9999</span></pre><p id="0cde" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">然后你可以卷曲或浏览到终点:</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="d71a" class="jn jo hi kn b fi kr ks l kt ku">curl localhost:9999/metrics</span><span id="e212" class="jn jo hi kn b fi kv ks l kt ku"># HELP opencensus_video_cum processed video size over time<br/># TYPE opencensus_video_cum histogram<br/>opencensus_video_cum_bucket{le="0"} 0<br/>opencensus_video_cum_bucket{le="65536"} 0<br/>opencensus_video_cum_bucket{le="4.294967296e+09"} 0<br/>opencensus_video_cum_bucket{le="+Inf"} 11<br/>opencensus_video_cum_sum 3.753271169191e+19<br/>opencensus_video_cum_count 11</span></pre><p id="5c1e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">这个(指标)数据是普罗米修斯的<a class="ae jh" href="https://prometheus.io/docs/instrumenting/exporters/" rel="noopener ugc nofollow" target="_blank">出口商</a>格式，这意味着我们可以将普罗米修斯服务器指向这个端点。因此，让我们创建一个Prometheus配置并运行一个Prometheus服务器。请让您的代码运行。</p><h2 id="73ac" class="jn jo hi bd jp jq jr js jt ju jv jw jx jk jy jz ka jl kb kc kd jm ke kf kg kh bi translated">普罗米修斯</h2><p id="c2d0" class="pw-post-body-paragraph ii ij hi il b im kw io ip iq kx is it jk ky iw ix jl kz ja jb jm la je jf jg hb bi translated">Prometheus是用prometheus.yml文件配置的(按照惯例)。以下文件是一个简单的配置。它定义了两个scrape _ configs。首先是让普罗米修斯监控自己(<code class="du le lf lg kn b">localhost:9090</code>)。第二是让普罗米修斯监控我们刚刚创建的公开普查措施。我建议您在创建Go文件的同一个目录中创建这个文件。</p><figure class="ki kj kk kl fd lb"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="ef0d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">现在，从该目录运行以下Docker命令，启动使用此配置的Prometheus服务器:</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="a37d" class="jn jo hi kn b fi kr ks l kt ku">docker run \<br/>--net=host \<br/>--publish=9090:9090 \<br/>--volume=$PWD/prometheus.yml:/etc/prometheus/prometheus.yml \<br/>prom/prometheus</span></pre><p id="6209" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">然后，您应该能够浏览(不要使用curl)Prometheus服务器:</p><p id="64ab" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated"><a class="ae jh" href="http://localhost:9090" rel="noopener ugc nofollow" target="_blank"> http://localhost:9090 </a></p><figure class="ki kj kk kl fd lb er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lh"><img src="../Images/78e95af3eab4eafd8da2dd5fbd7c6449.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ahT5q8khz6yKb9NvxnFqUQ.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">普罗米修斯“图”</figcaption></figure><p id="e67c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">要确认Prometheus服务器正在监控自身和OpenCensus端点，请单击“状态”,然后单击“目标”,或者:</p><p id="98b5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated"><a class="ae jh" href="http://localhost:9090/targets" rel="noopener ugc nofollow" target="_blank">http://localhost:9090/targets</a></p><figure class="ki kj kk kl fd lb er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es ls"><img src="../Images/aa45ecfa5a8b46f81923f18580ffc0a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LajaIn695YBwlI_jPpmntg.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">普罗米修斯“目标”</figcaption></figure><p id="1c8b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">这表明普罗米修斯正确地(<code class="du le lf lg kn b">State==”UP”</code>)监控着“公开普查”目标(在<code class="du le lf lg kn b">localhost:9999/metrics</code>)和它自己“普罗米修斯”(在<code class="du le lf lg kn b">localhost:9090/metrics</code>)。例如，您可以单击这些URL中的任何一个来查看OpenCensus指标:</p><p id="ca8e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated"><a class="ae jh" href="http://localhost:9999/metrics" rel="noopener ugc nofollow" target="_blank">http://localhost:9999/metrics</a></p><figure class="ki kj kk kl fd lb er es paragraph-image"><div class="er es lt"><img src="../Images/906b6b89653f6df854b56a89f3988cdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:966/format:webp/1*7N665JjMl0oOEdD3qVPndA.png"/></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">OpenCensus“示例”</figcaption></figure><p id="809c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">Golang示例包括一个go-routine，它在几毫秒的随机时间后测量随机大小的视频。每次你刷新<code class="du le lf lg kn b">localhost:9999/metrics</code>，你会看到，例如，opencensus_video-cum_count增加。我们将使用这个值来显示Prometheus的内置图形。</p><p id="d2a0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">返回到<a class="ae jh" href="http://localhost:9090/graph" rel="noopener ugc nofollow" target="_blank">http://localhost:9090/graph</a>，开始输入“opencensus”。选择“opencensus_video_cum_count”:</p><figure class="ki kj kk kl fd lb er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lu"><img src="../Images/e45761d4daa3d4c90ab840041c2c0e02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6krg9qKyQb1HvmrgYYNQwg.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">普罗米修斯:过滤“公开普查”</figcaption></figure><p id="880d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">点击“执行”并选择“图形”:</p><figure class="ki kj kk kl fd lb er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lh"><img src="../Images/654e71751add8abb2786025b22eee0a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U54W3T1T5v5QZThztHUHLA.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">普罗米修斯" opencensus_video_cum_count "</figcaption></figure><p id="c4e8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">当你完成后，你可以CTRL-C来终止Prometheus服务器和你的Golang样本。</p><h2 id="d5f6" class="jn jo hi bd jp jq jr js jt ju jv jw jx jk jy jz ka jl kb kc kd jm ke kf kg kh bi translated">堆栈驱动程序</h2><p id="fad2" class="pw-post-body-paragraph ii ij hi il b im kw io ip iq kx is it jk ky iw ix jl kz ja jb jm la je jf jg hb bi translated">Stackdriver (accounts)必须通过控制台创建。因此，我们将采取不同的轨迹，使用谷歌云控制台(console.cloud.google.com)创建一个项目，然后创建一个Stackdriver帐户。然后，我们将更改Golang示例中的几行，重新运行它并显示向Stackdriver报告的度量。</p><p id="d389" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">创建一个谷歌云平台项目:</p><p id="d1a7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated"><a class="ae jh" href="https://console.cloud.google.com/projectcreate" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/projectcreate</a></p><figure class="ki kj kk kl fd lb er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lv"><img src="../Images/6988e1921d17128c77caf6e6e31a869c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yeizW010SGyIjraxynMKkw.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">Google云控制台“[[您的项目]]”</figcaption></figure><p id="0024" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">然后创建一个Stackdriver帐户:</p><p id="1bd2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated"><a class="ae jh" href="https://console.cloud.google.com/monitoring?project=dazwilkin-180121-opencensus" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/monitoring?project=</a>[[你的项目]]</p><p id="ee3e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">一旦Stackdriver控制台准备就绪，选择“Resources”和“Metric Explorer”:</p><figure class="ki kj kk kl fd lb er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lw"><img src="../Images/196a5439e8b0f8f46435ae4e1564a1c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VnAN8xO8NdQDx1tCyDujKA.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">Stackdriver:度量浏览器</figcaption></figure><p id="8304" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">这一次，我们将使用OpenCensus Stackdriver <a class="ae jh" href="https://github.com/census-instrumentation/opencensus-go/blob/master/examples/stats/stackdriver/main.go" rel="noopener ugc nofollow" target="_blank">示例</a>作为我们代码的基础。我们将修改Golang导入(“stackdriver”而不是“prometheus”)并创建一个stackdriver。NewExporter而不是Prometheus . new exporter。stack driver exporter需要配置我们的GCP项目ID:</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="f529" class="jn jo hi kn b fi kr ks l kt ku">exporter, err := stackdriver.NewExporter(stackdriver.Options{<br/>  ProjectID: "[[YOUR-PROJECT]]",<br/> })</span></pre><blockquote class="if ig ih"><p id="120a" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">度量和视图的代码保持不变，这正是我们所期望的。</p></blockquote><p id="7a54" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">Prometheus和Stackdriver模型还有一个不同之处。普罗米修斯是一个基于民意调查的解决方案。Prometheus希望轮询端点(如<code class="du le lf lg kn b">localhost:9999</code>)以获取指标数据。Stackdriver是一个基于推送的解决方案。</p><p id="162a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">因此，我们还将删除Prometheus示例中使用的http服务器，它按需提供度量，并让Stackdriver示例运行一段时间，在生成度量时将度量记录到Stackdriver中。</p><p id="8cc5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">下面的代码运行15分钟:</p><figure class="ki kj kk kl fd lb"><div class="bz dy l di"><div class="lc ld l"/></div></figure><blockquote class="if ig ih"><p id="983a" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><strong class="il hj"> NB </strong>别忘了用你的Google云平台项目ID替换第18行的项目ID值。</p></blockquote><p id="5c9f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">和以前一样，您可以运行示例:</p><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="d953" class="jn jo hi kn b fi kr ks l kt ku">go run [YOUR-FILENAME].go</span></pre><p id="a91d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">Stackdriver示例运行后，返回Stackdriver控制台，刷新页面并搜索以“OpenCensus”开头的指标:</p><figure class="ki kj kk kl fd lb er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lx"><img src="../Images/01b144d15385d2b172d55028e3b9acee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*udbptIEBUhST82FkCUt2aA.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">堆栈驱动度量资源管理器“OpenCensus”</figcaption></figure><p id="7940" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">经过足够长的时间后，一些指标变得可用，单击refresh，您应该会在图上看到数据:</p><figure class="ki kj kk kl fd lb er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lw"><img src="../Images/01c5387f7b58e4adaffb4c78346d27af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LPkaaLNINl3wqODgDaJNpg.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">stack driver " open census/video _ cum "</figcaption></figure><p id="fd41" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated"><strong class="il hj">结论</strong></p><p id="b783" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">OpenCensus提供了一个引人注目的解决方案，用于为您的代码提供度量和跟踪(我们在这里没有涉及跟踪)。该解决方案支持多种语言(包括Golang)，并支持Prometheus和Stackdriver进行监控。它还支持Zipkin和Stackdriver进行跟踪。看看吧！</p><p id="de9f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jk iv iw ix jl iz ja jb jm jd je jf jg hb bi translated">一如既往，欢迎反馈。</p></div></div>    
</body>
</html>