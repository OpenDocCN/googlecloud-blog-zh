<html>
<head>
<title>Continuous deployment to Cloud Run on Google Kubernetes Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">持续部署到在Google Kubernetes引擎上运行的云</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/continuous-deployment-to-cloud-run-on-google-kubernetes-engine-ebe49bd956bf?source=collection_archive---------1-----------------------#2020-04-29">https://medium.com/google-cloud/continuous-deployment-to-cloud-run-on-google-kubernetes-engine-ebe49bd956bf?source=collection_archive---------1-----------------------#2020-04-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/05433bbc9de27b5a1236bce4cc6852c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XJue-fepRM_TMmYG_Dkwjg.png"/></div></div></figure><blockquote class="iq"><p id="236b" class="ir is hi bd it iu iv iw ix iy iz ja dx translated">在本教程中，您将学习如何为运行在Google Kubernetes引擎(GKE)上的云应用程序设置持续部署。</p></blockquote><blockquote class="jb jc jd"><p id="37a7" class="je jf jg jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb ja hb bi translated">Google Kubernetes Engine (GKE)为使用Google基础设施部署、管理和扩展您的容器化应用程序提供了一个托管环境。</p><p id="b334" class="je jf jg jh b ji kc jk jl jm kd jo jp jq ke js jt ju kf jw jx jy kg ka kb ja hb bi translated">Cloud Run是Google Cloud Platform提供的一项服务，可以运行你的无状态HTTP容器，而不用担心配置机器、集群或自动伸缩。</p></blockquote><h1 id="5ccd" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">先决条件</h1><ul class=""><li id="acd1" class="lf lg hi jh b ji lh jm li lj lk ll lm ln lo ja lp lq lr ls bi translated">创建一个<a class="ae lt" href="https://console.cloud.google.com/project" rel="noopener ugc nofollow" target="_blank">谷歌云平台(GCP)项目</a>，或者使用一个现有的项目。</li><li id="bfe5" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja lp lq lr ls bi translated">启用<a class="ae lt" href="https://console.developers.google.com/apis/api/run.googleapis.com/overview" rel="noopener ugc nofollow" target="_blank">云运行API </a>。</li><li id="d09c" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja lp lq lr ls bi translated">启用<a class="ae lt" href="https://console.developers.google.com/apis/api/containerregistry.googleapis.com/overview" rel="noopener ugc nofollow" target="_blank">集装箱注册API </a>。</li><li id="f132" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja lp lq lr ls bi translated">启用<a class="ae lt" href="https://console.developers.google.com/apis/api/container.googleapis.com/overview" rel="noopener ugc nofollow" target="_blank"> Kubernetes引擎API </a>。</li><li id="c0be" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja lp lq lr ls bi translated">克隆<a class="ae lt" href="https://github.com/Timtech4u/vuejs-dockerized" rel="noopener ugc nofollow" target="_blank">样本代码</a>或使用<em class="jg">docker文件设置您自己的代码。</em></li></ul><p id="2e9e" class="pw-post-body-paragraph je jf hi jh b ji kc jk jl jm kd jo jp lj ke js jt ll kf jw jx ln kg ka kb ja hb bi translated">除了易于部署、可伸缩性、无服务器执行以及Cloud Run提供的其他优势之外，在Gooogle Kubernetes引擎上运行Cloud Run还增加了对容器编排的每个方面(如网络、存储、监控)进行完全控制的优势。</p><p id="69e1" class="pw-post-body-paragraph je jf hi jh b ji kc jk jl jm kd jo jp lj ke js jt ll kf jw jx ln kg ka kb ja hb bi translated">工作流程将非常简单，您将集成<a class="ae lt" href="https://cloud.google.com/cloud-build/" rel="noopener ugc nofollow" target="_blank">云构建</a>，这是谷歌的一个连续交付工具，它在谷歌云平台的基础设施上执行您的构建。</p><p id="81ee" class="pw-post-body-paragraph je jf hi jh b ji kc jk jl jm kd jo jp lj ke js jt ll kf jw jx ln kg ka kb ja hb bi">‌</p><figure class="ma mb mc md fd ij er es paragraph-image"><div class="er es lz"><img src="../Images/a430edc13390bcb45bff2a2f3374997a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/0*vJ0eDDHADgWmpFq2.jpg"/></div><figcaption class="me mf et er es mg mh bd b be z dx translated">流动</figcaption></figure><p id="c526" class="pw-post-body-paragraph je jf hi jh b ji kc jk jl jm kd jo jp lj ke js jt ll kf jw jx ln kg ka kb ja hb bi translated">您需要建立一个源代码存储库，其中包含应用程序代码、Dockerfile和包含云构建说明的构建配置文件。‌ <br/> ‌You可以在这里找到我自己在本教程<a class="ae lt" href="https://github.com/Timtech4u/vuejs-dockerized" rel="noopener ugc nofollow" target="_blank">中使用的源代码。</a></p><p id="a156" class="pw-post-body-paragraph je jf hi jh b ji kc jk jl jm kd jo jp lj ke js jt ll kf jw jx ln kg ka kb ja hb bi translated">云构建触发器将与源代码库集成，并配置为在推送代码时进行构建。这将触发构建配置文件中的构建步骤。</p><p id="31bb" class="pw-post-body-paragraph je jf hi jh b ji kc jk jl jm kd jo jp lj ke js jt ll kf jw jx ln kg ka kb ja hb bi translated">构建配置的步骤包括从存储库中克隆源代码，构建映像并将其推送到<a class="ae lt" href="https://cloud.google.com/container-registry" rel="noopener ugc nofollow" target="_blank">Google Container Registry</a>，然后部署到Google Kubernetes引擎上的云上。</p><h1 id="1623" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">为云运行设置Google Kubernetes引擎集群</h1><p id="4dad" class="pw-post-body-paragraph je jf hi jh b ji lh jk jl jm li jo jp lj mi js jt ll mj jw jx ln mk ka kb ja hb bi translated">要创建集群并启用云运行，请执行以下步骤:</p><ol class=""><li id="9564" class="lf lg hi jh b ji kc jm kd lj ml ll mm ln mn ja mo lq lr ls bi translated">进入云控制台中的<a class="ae lt" href="https://console.cloud.google.com/kubernetes?_ga=2.238711938.389965162.1587363196-691912164.1581463010" rel="noopener ugc nofollow" target="_blank"> Google Kubernetes引擎</a>页面:</li><li id="c5a4" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja mo lq lr ls bi translated">点击<strong class="jh hj">创建集群</strong>打开<em class="jg">创建Kubernetes集群</em>页面。</li><li id="85c1" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja mo lq lr ls bi translated">在<strong class="jh hj">集群基础</strong>菜单下，设置以下值:</li></ol><ul class=""><li id="821b" class="lf lg hi jh b ji kc jm kd lj ml ll mm ln mn ja lp lq lr ls bi translated">输入您想要的群集名称。</li><li id="c717" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja lp lq lr ls bi translated">选择<em class="jg">区域</em>或<em class="jg">区域</em>作为位置类型。</li><li id="eb66" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja lp lq lr ls bi translated">为集群选择一个区域或地区。</li></ul><p id="040c" class="pw-post-body-paragraph je jf hi jh b ji kc jk jl jm kd jo jp lj ke js jt ll kf jw jx ln kg ka kb ja hb bi translated">4.在<strong class="jh hj">节点池&gt;默认-池&gt;节点</strong>下，将机器类型设置为<strong class="jh hj">n1-标准-2 </strong></p><p id="524b" class="pw-post-body-paragraph je jf hi jh b ji kc jk jl jm kd jo jp lj ke js jt ll kf jw jx ln kg ka kb ja hb bi translated">5.在<strong class="jh hj">集群&gt;功能</strong>菜单下，选择复选框<strong class="jh hj">为Anthos </strong>启用云运行。</p><p id="7b64" class="pw-post-body-paragraph je jf hi jh b ji kc jk jl jm kd jo jp lj ke js jt ll kf jw jx ln kg ka kb ja hb bi translated">6.接受更改并单击<strong class="jh hj"> Create </strong>来创建和配置集群。</p><div class="ma mb mc md fd ab cb"><figure class="mp ij mq mr ms mt mu paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/57008ad35d121a597e6138298a3b0fb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/format:webp/0*VHC1daqAuFnt43x7.png"/></div></figure><figure class="mp ij mv mr ms mt mu paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/08f87236e7af797dc844ac23091435e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:582/format:webp/0*7d5rOjMMytYhZrW8.png"/></div></figure><figure class="mp ij mw mr ms mt mu paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/a4ea31ddd4b0d5ea64f399d022e5d233.png" data-original-src="https://miro.medium.com/v2/resize:fit:702/format:webp/0*id4wVYLVXnMAAIM2.png"/></div><figcaption class="me mf et er es mg mh bd b be z dx mx di my mz translated">集群创建页面</figcaption></figure></div><h1 id="34a4" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">为持续部署设置云构建触发器</h1><p id="ea48" class="pw-post-body-paragraph je jf hi jh b ji lh jk jl jm li jo jp lj mi js jt ll mj jw jx ln mk ka kb ja hb bi translated">每当您对源代码进行任何更改时，云构建触发器都会自动启动构建。我们将使用以下配置文件进行云构建。</p><pre class="ma mb mc md fd na nb nc nd aw ne bi"><span id="c552" class="nf ki hi nb b fi ng nh l ni nj"># cloudbuild.yaml</span><span id="daf4" class="nf ki hi nb b fi nk nh l ni nj">steps:<br/>  # build the container image<br/>- name: 'gcr.io/cloud-builders/docker'<br/>  args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/demo', '.' ]<br/>  # push the container image<br/>- name: 'gcr.io/cloud-builders/docker'<br/>  args: [ 'push', 'gcr.io/$PROJECT_ID/demo']<br/>  # deploy to cloud run on GKE<br/>- name: "gcr.io/cloud-builders/gcloud"<br/>  args: ['run', 'deploy', 'demo-ui', '--image', 'gcr.io/$PROJECT_ID/demo', '--cluster', 'cloudrun-cluster', '--cluster-location', 'us-central1-c', '--namespace', 'default', '--platform', 'gke']</span></pre><h2 id="5e6d" class="nf ki hi bd kj nl nm nn kn no np nq kr lj nr ns kv ll nt nu kz ln nv nw ld nx bi translated">‌Connecting到源存储库</h2><p id="423d" class="pw-post-body-paragraph je jf hi jh b ji lh jk jl jm li jo jp lj mi js jt ll mj jw jx ln mk ka kb ja hb bi translated">使用以下步骤配置触发器，以在对源存储库进行任何更改的基础上构建您的代码:</p><ol class=""><li id="43a0" class="lf lg hi jh b ji kc jm kd lj ml ll mm ln mn ja mo lq lr ls bi translated">在谷歌云控制台中打开<a class="ae lt" href="https://console.cloud.google.com/cloud-build/triggers?_ga=2.29020222.389965162.1587363196-691912164.1581463010" rel="noopener ugc nofollow" target="_blank"> <strong class="jh hj">触发器</strong> </a>页面。</li><li id="4f58" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja mo lq lr ls bi translated">点击<strong class="jh hj">连接储存库</strong>。</li><li id="589f" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja mo lq lr ls bi translated">选择存储源代码的存储库。</li><li id="2920" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja mo lq lr ls bi translated">点击<strong class="jh hj">继续</strong>。</li><li id="556a" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja mo lq lr ls bi translated">向您的源存储库进行身份验证。</li><li id="23cb" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja mo lq lr ls bi translated">从可用存储库列表中，选择所需的存储库，然后点击<strong class="jh hj">连接存储库</strong>。</li><li id="3f25" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja mo lq lr ls bi translated">点击<strong class="jh hj">完成</strong>(跳过创建默认触发器)。</li></ol><h1 id="90aa" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">创建生成触发器</h1><ol class=""><li id="521d" class="lf lg hi jh b ji lh jm li lj lk ll lm ln lo ja mo lq lr ls bi translated">在谷歌云控制台打开<a class="ae lt" href="https://console.cloud.google.com/cloud-build/triggers?_ga=2.27393214.389965162.1587363196-691912164.1581463010" rel="noopener ugc nofollow" target="_blank"> <strong class="jh hj">触发器</strong> </a>页面。</li><li id="ad8d" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja mo lq lr ls bi translated">点击<strong class="jh hj">创建触发器</strong>。</li><li id="138f" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja mo lq lr ls bi translated">输入以下触发设置:</li></ol><ul class=""><li id="5d40" class="lf lg hi jh b ji kc jm kd lj ml ll mm ln mn ja lp lq lr ls bi translated">设置触发器名称</li><li id="1afe" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja lp lq lr ls bi translated">选择连接源存储库</li><li id="3427" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja lp lq lr ls bi translated">配置分支，我们将使用:^master$</li><li id="0057" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja lp lq lr ls bi translated">将<strong class="jh hj">构建配置文件</strong>设置为云构建配置文件:<em class="jg"> cloudbuild.yaml </em></li></ul><p id="df5c" class="pw-post-body-paragraph je jf hi jh b ji kc jk jl jm kd jo jp lj ke js jt ll kf jw jx ln kg ka kb ja hb bi translated">4.通过提供必要的详细信息进行配置，并点击<strong class="jh hj">创建触发器。</strong></p><figure class="ma mb mc md fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ny"><img src="../Images/c8c0f6d6dfee6bcdb98ef5c0235b3e3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*d4s9qfO4kGV_6Xer.png"/></div></div></figure><p id="1d4f" class="pw-post-body-paragraph je jf hi jh b ji kc jk jl jm kd jo jp lj ke js jt ll kf jw jx ln kg ka kb ja hb bi translated">你点击<strong class="jh hj">运行触发器</strong>或者推送至你的源代码库并监控构建日志。</p><p id="c465" class="pw-post-body-paragraph je jf hi jh b ji kc jk jl jm kd jo jp lj ke js jt ll kf jw jx ln kg ka kb ja hb bi translated">从今以后，无论何时您推送至您的存储库，Cloud Build都会自动触发一个构建，并部署到您在Google Kubernetes引擎集群上运行的云运行服务。</p><p id="8efd" class="pw-post-body-paragraph je jf hi jh b ji kc jk jl jm kd jo jp lj ke js jt ll kf jw jx ln kg ka kb ja hb bi translated">如果你想在Google Cloud上自动化更多的容器工作流，下面的资源会很有帮助。</p><h1 id="ae6e" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">有用的链接</h1><ul class=""><li id="83d0" class="lf lg hi jh b ji lh jm li lj lk ll lm ln lo ja lp lq lr ls bi translated"><a class="ae lt" href="https://cloud.google.com/cloud-build/docs/" rel="noopener ugc nofollow" target="_blank">谷歌云构建</a></li><li id="57ba" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja lp lq lr ls bi translated"><a class="ae lt" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank">谷歌云运行</a></li><li id="5e66" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja lp lq lr ls bi translated"><a class="ae lt" href="https://github.com/ramitsurana/awesome-kubernetes" rel="noopener ugc nofollow" target="_blank">牛逼的库伯内特斯</a></li><li id="a152" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja lp lq lr ls bi translated"><a class="ae lt" href="https://kubernetes.io/docs/" rel="noopener ugc nofollow" target="_blank"> Kubernetes文档</a></li><li id="0840" class="lf lg hi jh b ji lu jm lv lj lw ll lx ln ly ja lp lq lr ls bi translated"><a class="ae lt" href="https://cloud.google.com/kubernetes-engine/docs" rel="noopener ugc nofollow" target="_blank">谷歌Kubernetes引擎文档</a></li></ul></div></div>    
</body>
</html>