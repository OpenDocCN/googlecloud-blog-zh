<html>
<head>
<title>Google Cloud Functions Python Overview and Data Processing Example</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Cloud Functions Python概述和数据处理示例</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-functions-python-overview-and-data-processing-example-b36ebde5f4fd?source=collection_archive---------0-----------------------#2018-12-27">https://medium.com/google-cloud/google-cloud-functions-python-overview-and-data-processing-example-b36ebde5f4fd?source=collection_archive---------0-----------------------#2018-12-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="72b2" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">事件驱动的无服务器功能即服务</h2></div><h1 id="dcc9" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">介绍</h1><p id="b910" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">无服务器、FaaS(功能即服务)和Python是2019年任何构建或利用云服务的人的重要知识领域。云功能是一种轻量级的托管服务，您可以使用它来提高使用云的敏捷性。您可能希望为新架构考虑云功能，或者在使用多个云平台服务对现有工作流进行现代化时考虑云功能。</p><h2 id="2e27" class="kl iy hi bd iz km kn ko jd kp kq kr jh jy ks kt jj kc ku kv jl kg kw kx jn ky bi translated">本文旨在让您熟悉Google Cloud Functions，并演示Cloud Functions Python runtime的一些实际用法。</h2><p id="5027" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">云函数是无服务器的，所以你可以运行代码而不用担心管理或扩展服务器。云功能可以很容易地与谷歌云平台(GCP)服务集成，你只需在代码运行时为资源付费。它们由您指定的触发器调用，并等待特定的事件或HTTP端点调用。</p><p id="878f" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated">无服务器并不意味着你把现有的代码分割成函数来获得更低的成本和即时的自动伸缩。采用无服务器方法意味着利用托管服务，并允许您的提供商处理您的服务或应用的基本功能，然后使用云功能在这些服务之间充当粘合剂，以交付商业价值。</p><p id="df9c" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated">云功能支持微服务架构、数据管理管道，并允许您轻松地将AI集成到应用程序中。正如本文将进一步展示的那样，它们可以像胶水一样将Google云平台中的多个服务粘在一起，以交付一个服务，通过ML构建洞察，或者帮助数据流向BigQuery。</p><p id="eebe" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated">由于云函数的执行时间约为100毫秒，因此可以实现近乎实时的流管道。它们应该是快速的代码片段，必要时很容易失败。主要先决条件是您在node.js或Python方面具有中等水平的技能。在本文中，我们将关注Python运行时。</p><p id="e691" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated">有两种不同类型的云函数:HTTP函数和后台函数。HTTP函数由HTTP触发端点触发；后台功能由GCP服务的事件触发器触发。</p><p id="bf34" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated"><strong class="jr hj">你可以用云函数做什么？</strong></p><ul class=""><li id="8671" class="le lf hi jr b js kz jv la jy lg kc lh kg li kk lj lk ll lm bi translated"><strong class="jr hj">应用后端任务- </strong>响应来自云基础设施内部的事件。<br/>示例:消息发布到云发布/订阅，然后启动二级工作流。</li><li id="9c02" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated"><strong class="jr hj">数据处理- </strong>运行代码以响应数据的变化。<br/>示例:文件上传到Google云存储，然后在Cloud SQL中更新元数据存储库。</li><li id="7d42" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated"><strong class="jr hj">将人工智能集成到应用程序中- </strong>集成<a class="ae ls" href="https://cloud.google.com/products/ai/" rel="noopener ugc nofollow" target="_blank">谷歌云ML API</a>对图像进行分类，分析视频，将语音转换为文本。<br/>示例:运行自然语言API来检测上传到Google云存储的CSV中的支持服务台票证摘要的情感。</li></ul><h1 id="9d5d" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">执行环境和依赖性</h1><ul class=""><li id="8833" class="le lf hi jr b js jt jv jw jy lt kc lu kg lv kk lj lk ll lm bi translated">在撰写本文时，云函数Python运行时基于Python 3.7.1。</li><li id="bef5" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated">在撰写本文时，云函数服务使用基于Ubuntu 18.04的执行环境。</li><li id="9ce8" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated">您的函数将包含在main.py中</li><li id="592a" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated">您的函数可以使用第三方库和依赖项，并且应该包含在函数附带的requirements.txt中，每个库一行:</li></ul><figure class="lx ly lz ma fd mb er es paragraph-image"><div class="er es lw"><img src="../Images/7e1339300fe4e372a8cd7907efbdfc28.png" data-original-src="https://miro.medium.com/v2/resize:fit:662/format:webp/1*OiiAFoBapJBfNhdGDRIIFw.png"/></div></figure><ul class=""><li id="84a8" class="le lf hi jr b js kz jv la jy lg kc lh kg li kk lj lk ll lm bi translated">当您部署您的功能时，云功能服务使用pip下载并安装requirements.txt中声明的依赖项。</li><li id="7f88" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated">如果您需要使用特定版本的pip、wheel或任何标准Python包，请确保在requirements.txt文件中指定。</li></ul><h1 id="83f3" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">调用云函数</h1><p id="0f87" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">触发器决定了函数执行的方式和时间。当您部署云功能时，您必须选择一个将调用您的代码的触发器。这些是您将识别并计划随后发生的行动的独特事件。</p><p id="32d7" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated"><strong class="jr hj">事件触发类型</strong></p><ul class=""><li id="2a04" class="le lf hi jr b js kz jv la jy lg kc lh kg li kk lj lk ll lm bi translated">超文本传送协议</li><li id="354c" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated">云发布/订阅</li><li id="a470" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated"><a class="ae ls" href="https://cloud.google.com/scheduler/docs/tut-pub-sub" rel="noopener ugc nofollow" target="_blank">云发布/订阅和云调度</a></li><li id="eb18" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated">云存储</li><li id="e7ee" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated">Cloud Firestore(撰写本文时是测试版)</li><li id="fbde" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated">Firebase身份验证(撰写本文时是测试版)</li><li id="65fd" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated">Firebase分析(撰写本文时是测试版)</li><li id="337a" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated">实时数据库(撰写本文时是测试版)</li><li id="0b99" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated">远程配置(撰写本文时是测试版)</li></ul><p id="7710" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated"><strong class="jr hj">其他触发器<br/> </strong>您可以利用GCP服务的本地功能发挥创造力，进一步扩展支持发布/订阅的服务或任何提供webhooks的服务的触发器。</p><p id="2605" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated"><strong class="jr hj">从任何支持云发布/订阅的服务中触发</strong> <br/>因为发送到发布/订阅主题的消息可以调用云功能，所以很容易将云功能与其他支持发布/订阅的Google服务集成。例如，您可以将stack driver<a class="ae ls" href="https://cloud.google.com/logging/docs/export/configure_export_v2" rel="noopener ugc nofollow" target="_blank">Cloud Logging</a>导出到Cloud Pub/Sub主题作为接收目的地，一旦消息发布到该Pub/Sub主题，您就可以执行某个功能。这对于与一个服务(比如PagerDuty)集成以保持在关键日志通知之前是很有趣的。</p><figure class="lx ly lz ma fd mb er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es me"><img src="../Images/9db3854ab50a3e4d5fffd7299f2fc414.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aOmU_YrT1mpyGCMrSUqWVw.png"/></div></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">从GCP日志事件到页面责任的无服务器通知</figcaption></figure><p id="20d1" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated"><a class="ae ls" href="https://developers.google.com/gmail/api/guides/push" rel="noopener ugc nofollow" target="_blank"> Gmail推送通知</a>可以配置为在Gmail收件箱发生变化时向发布/订阅主题发送消息。您是否使用Gmail收件箱来管理发票或部门活动？现在，您可以根据Gmail中的事件(收到的邮件)使用云功能启动辅助工作流程。</p><h1 id="8cc9" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">示例—云存储AVRO/CSV追加到BigQuery</h1><p id="7644" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">我喜欢的数据处理工作流的一个例子是使用云功能来执行无服务器的数据仓库更新。我只能找到由 <a class="mn mo ge" href="https://medium.com/u/cbc1f8582fd7?source=post_page-----b36ebde5f4fd--------------------------------" rel="noopener" target="_blank">阿萨哈兰德</a>在node.js中完成的<a class="ae ls" rel="noopener" href="/@asajharland/effective-data-loading-with-bigquery-batch-loading-flat-files-bf2fd0ebb325">这个场景，所以在这里用Python为你呈现。</a></p><p id="a0aa" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated"><em class="mp">用例</em>:假设你有一个精通Python的数据科学团队在Jupyter笔记本或<a class="ae ls" href="https://cloud.google.com/datalab/" rel="noopener ugc nofollow" target="_blank">云数据实验室</a>中工作。您的组织在BigQuery中有一个数据仓库，您正在通过笔记本使用它。您需要新的更新数据，因为您正在处理的样本集是静态的，已经有一段时间没有更新了。通过使用云存储作为您的源，一个介于两者之间的云功能，以及BigQuery作为您的目的地，您拥有了一个基本的数据管道，为您的分析和洞察提供新的数据。</p><p id="e63b" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated">使用<a class="ae ls" href="https://cloud.google.com/functions/docs/calling/storage#object_finalize" rel="noopener ugc nofollow" target="_blank"> object.finalize </a>触发器每当新的CSV或AVRO被上传到指定的云存储桶时，云函数就使用BigQuery API将行添加到函数代码中的指定表。</p><p id="06c3" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated">下面是该体系结构寻找数据处理管道的方式:</p><figure class="lx ly lz ma fd mb er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es mq"><img src="../Images/a9d6b4e403fa9c04e676fe675a756b7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MtcgnQsD2nZh-zzoMqMJ_w.png"/></div></div></figure><p id="4759" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated">下面是将云存储中的新CSV或AVROs追加到BigQuery表的函数代码:</p><figure class="lx ly lz ma fd mb"><div class="bz dy l di"><div class="mr ms l"/></div></figure><ul class=""><li id="37ea" class="le lf hi jr b js kz jv la jy lg kc lh kg li kk lj lk ll lm bi translated">确保将第1行中的UPDATE_DATASET_HERE和UPDATE_TABLE_HERE替换为您希望函数向其中追加行的BQ数据集和表名。</li><li id="84d8" class="le lf hi jr b js ln jv lo jy lp kc lq kg lr kk lj lk ll lm bi translated">确保您上传的CSV或AVRO的第一行作为您的列标题(字段名称),与BQ中的目标表相匹配。</li></ul><figure class="lx ly lz ma fd mb er es paragraph-image"><div class="er es mt"><img src="../Images/3a8f4013a1d0089680953a70854ade8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/1*tCgWcpLEDUQcHrJLVUWWfQ.png"/></div></figure><p id="c00c" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated">现在，通过在源存储桶上设置函数，每当上传新的CSV增量时，CSV中的行将自动追加到您指定的表中。</p><h1 id="b9a7" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">包扎</h1><p id="c0c9" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">本文的目标是帮助您理解在Google云平台上构建新的现代架构时的无服务器选项，比如云功能。如今，在构建新的应用程序或服务时，有许多托管选项可以为您提供不同类型的灵活性。云功能是粘合代码，可以使您的托管服务支持的应用程序或工作流更高效、更有洞察力。</p><p id="526b" class="pw-post-body-paragraph jp jq hi jr b js kz ij ju jv la im jx jy lb ka kb kc lc ke kf kg ld ki kj kk hb bi translated">扎克·坎特在<a class="ae ls" href="https://techcrunch.com/2018/12/15/the-business-case-for-serverless/" rel="noopener ugc nofollow" target="_blank">上发表了一篇关于无服务器的商业案例</a>的精彩文章，这要归功于<a class="mn mo ge" href="https://medium.com/u/514692b11743?source=post_page-----b36ebde5f4fd--------------------------------" rel="noopener" target="_blank">。这篇文章中使用的一些概念和描述改编自他的文章。</a></p></div></div>    
</body>
</html>