<html>
<head>
<title>Setting up your GCP foundations through Terraform — Chapter 3 — Deploying the bootstrap and CI/CD Projects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Terraform建立您的GCP基础—第3章—部署bootstrap和CI/CD项目</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/setting-up-your-gcp-foundations-through-terraform-chapter-3-deploying-the-bootstrap-and-ci-cd-db8db9d3e61a?source=collection_archive---------2-----------------------#2022-06-29">https://medium.com/google-cloud/setting-up-your-gcp-foundations-through-terraform-chapter-3-deploying-the-bootstrap-and-ci-cd-db8db9d3e61a?source=collection_archive---------2-----------------------#2022-06-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="a2aa" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">简介:</h1><p id="5a0c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在本章中，我们将通过Terraform部署<a class="ae kb" href="https://github.com/terraform-google-modules/terraform-example-foundation" rel="noopener ugc nofollow" target="_blank"> seed和CI/CD项目</a>。这两个项目是基础，允许我们在云中维护terraform状态，并开始在GitOps模型中工作，以通过Terraform部署我们环境的其余部分。</p><p id="3ca3" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">最后，在浏览了GCP模块的实现之后，我将讨论一些我认为我们需要实现的改进，这些将是本系列下一篇文章的主题。</p><p id="7398" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">如果你喜欢这个系列，并且很高兴继续一起学习和建设，请确保关注和/或订阅<a class="ae kb" rel="noopener" href="/@goodmanjoel2017">媒体</a>、<a class="ae kb" href="https://www.linkedin.com/in/thejoelgoodman/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>&amp;<a class="ae kb" href="https://twitter.com/JoelGoo86772117" rel="noopener ugc nofollow" target="_blank">Twitter</a>。</p><p id="54e9" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">如果您对我们如何使该系列更好有任何问题、意见或建议，请在文章底部留下您的评论——我非常期待您的回复！</p><h1 id="f14e" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">让我们开始工作:</h1><p id="a149" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">*这一部分是Github页面上的指导，并有一些额外的说明和截图。</p><ol class=""><li id="79c2" class="kh ki hi jf b jg kc jk kd jo kj js kk jw kl ka km kn ko kp bi translated">确保你已经完成了<a class="ae kb" href="https://github.com/terraform-google-modules/terraform-example-foundation/blob/master/0-bootstrap/README.md#prerequisites" rel="noopener ugc nofollow" target="_blank">先决条件</a></li></ol><p id="e9b9" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">2.使用具有所需权限的用户登录到GCP控制台-&gt;确保您在您的组织节点上-&gt;单击云外壳图标以访问您的云外壳环境</p><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es kq"><img src="../Images/c4881ba31ddd41ed6be79361843f49ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*q8AXSCcMAJsGKjhE"/></div></div></figure><p id="faf0" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">3.一旦您的云shell环境启动并运行——点击<strong class="jf hj">“打开编辑器”</strong></p><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es kq"><img src="../Images/6abb2b8e1b16ad70d13c1a1814206744.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*19hId2w2A3Iph0aq"/></div></div></figure><p id="da80" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">4.点击"<strong class="jf hj">终端"</strong>-&gt;-<strong class="jf hj">"新终端"</strong>，在您的开发环境中打开一个终端</p><p id="3d3a" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">5.在终端输入<strong class="jf hj"> git克隆</strong><a class="ae kb" href="https://github.com/terraform-google-modules/terraform-example-foundation.git." rel="noopener ugc nofollow" target="_blank"><strong class="jf hj">https://github . com/terra form-Google-modules/terra form-Example-Foundation<strong class="jf hj"/></strong></a>克隆<a class="ae kb" href="https://github.com/terraform-google-modules/terraform-example-foundation" rel="noopener ugc nofollow" target="_blank">GCP-terra form-Example-Foundation。你应该会看到一个新文件夹出现在你的导航栏中。</a></p><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es lc"><img src="../Images/ffa4356ed961db29239099b8d3783c7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MsJN7QzCklXeH6u1"/></div></div></figure><p id="84be" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">6.点击下拉箭头，导航至<strong class="jf hj">地形-范例-基础</strong>-&gt;-<strong class="jf hj">0-引导</strong></p><p id="8b16" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">7.<strong class="jf hj">右键</strong>点击<strong class="jf hj">上的【terraform . example . TF vars</strong>-&gt;点击<strong class="jf hj">重命名</strong>-&gt;<strong class="jf hj">teraform . TF vars</strong></p><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es lc"><img src="../Images/33070d7f4bf947ee577cc175b1ecb1e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YoQvnRP6u-r7v_3Z"/></div></div></figure><p id="858e" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">8.点击新编辑的<strong class="jf hj"> terraform.tfvars </strong>这将在屏幕右侧打开编辑窗口。编辑此文件中的参数以匹配您组织的设置。org_id，billing_account，group_org_admins，group_billing_admins，default_region。<br/>如果您在现有组织中构建此our，并且不想在根节点级别创建此资源文件夹，您还可以取消对第32行“parent_folder”的注释，并提供您的parent_folder id</p><p id="662e" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">9.在终端中，通过键入<strong class="jf hj">CD terra form-example-foundation/0-bootstrap</strong>确保您位于0-bootstrap文件夹中</p><p id="68c9" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">10.运行<strong class="jf hj">地形初始化</strong></p><p id="12cd" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">11.运行<strong class="jf hj">地形图</strong></p><p id="8069" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">12.这将打印出将应用于您的环境的所有更改。<strong class="jf hj">我对这个命令的结果有些担心，我们将在指南的后面讨论。</strong></p><p id="6723" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">13.我将<strong class="jf hj">跳过设置terraform-validator，</strong>因为我不喜欢在我的生产环境中运行pre-GA代码，尤其是不喜欢在文件夹和项目中运行，它们将是我整个组织的基础。</p><p id="35d4" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">14.运行<strong class="jf hj">地形应用</strong></p><p id="cd47" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">15.运行<strong class="jf hj">terra form output terra form _ service _ account</strong>获取管理员的电子邮件地址。在后面的过程中，您需要此地址。</p><p id="1c54" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">16.运行<strong class="jf hj"> terraform输出gcs_bucket_tfstate </strong>从terraform的状态中获取你的Google云桶名称。</p><p id="405e" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">17.复制后端:<strong class="jf hj">CP back end . TF . example back end . TF</strong></p><p id="a99a" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">18.用您的云存储桶的名称更新backend.tf。</p><p id="eba1" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">19.重新运行<strong class="jf hj">地形初始化</strong>。当系统提示您时，同意将状态复制到云存储。</p><p id="a670" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">20.运行<strong class="jf hj"> terraform apply </strong>验证状态配置正确。您应该看不到先前状态的变化。</p><h1 id="4b29" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">我们建造了什么:</h1><p id="4362" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">按照这个过程，我们已经建立了一个包含两个项目的文件夹。</p><ul class=""><li id="551f" class="kh ki hi jf b jg kc jk kd jo kj js kk jw kl ka ld kn ko kp bi translated">其中一个项目是seed项目，它包含用于维护我们在云中的terraform状态的GCS bucket、服务帐户和启用的核心API。</li><li id="6266" class="kh ki hi jf b jg le jk lf jo lg js lh jw li ka ld kn ko kp bi translated">CI/CD管道的第二个项目，我们有云构建、我们的云资源存储库和用于云工件的GCS存储桶。</li></ul><h1 id="90e1" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">建议的改进:</h1><p id="1408" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">虽然谷歌在这方面做了一些惊人的工作，建立了回购协议，以帮助新客户更快地登陆GCP，但我认为我们可以做一些事情来改善整体流程。</p><p id="1234" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">我之前在帖子中指出的一点是terraform plan命令的输出长度。当一个terraform计划长达数百行时，没有人能够真正阅读和理解对环境做了什么，这将导致混乱并最终导致停机。</p><p id="d9d0" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">话虽如此，如果你面临一个截止日期，你需要完成一些事情，我建议你继续与GCP CFT合作，这是一个很好的资源！</p><p id="6c74" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">基于<a class="ae kb" href="https://www.doit-intl.com/refactor-terraform-into-modules-the-right-way/" rel="noopener ugc nofollow" target="_blank">重构平台的最佳实践</a>(由前DoiT国际工程师Ami Mahloof撰写)，这是我认为我们应该做的。</p><ol class=""><li id="8563" class="kh ki hi jf b jg kc jk kd jo kj js kk jw kl ka km kn ko kp bi translated">构建repo本身以匹配terraform最佳实践，在环境、模块和资源之间拆分文件夹。</li><li id="b553" class="kh ki hi jf b jg le jk lf jo lg js lh jw li ka km kn ko kp bi translated">重构代码以使用已经存在的用于<a class="ae kb" href="https://github.com/terraform-google-modules/terraform-google-folders" rel="noopener ugc nofollow" target="_blank">文件夹</a>、<a class="ae kb" href="https://github.com/terraform-google-modules/terraform-google-project-factory" rel="noopener ugc nofollow" target="_blank">项目-工厂</a>、<a class="ae kb" href="https://github.com/terraform-google-modules/terraform-google-cloud-storage" rel="noopener ugc nofollow" target="_blank"> GCS </a> &amp; <a class="ae kb" href="https://github.com/terraform-google-modules/terraform-google-service-accounts" rel="noopener ugc nofollow" target="_blank">服务账户</a>的GCP模块</li><li id="2b45" class="kh ki hi jf b jg le jk lf jo lg js lh jw li ka km kn ko kp bi translated">使用Terragrunt保持terraform代码干燥</li><li id="4d6e" class="kh ki hi jf b jg le jk lf jo lg js lh jw li ka km kn ko kp bi translated">使用Terratest构建自动化测试</li><li id="4a6c" class="kh ki hi jf b jg le jk lf jo lg js lh jw li ka km kn ko kp bi translated">逐步部署架构的各个部分，这样我们就可以学习和理解我们在做什么。</li></ol><h1 id="ca07" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">接下来是:</h1><ul class=""><li id="e9ff" class="kh ki hi jf b jg jh jk jl jo lj js lk jw ll ka ld kn ko kp bi translated">从头开始构建我们的引导环境，首先创建我们的文件夹，并将所需的权限分配给文件夹上所需的组。</li></ul><h1 id="1629" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">资源:</h1><ul class=""><li id="355d" class="kh ki hi jf b jg jh jk jl jo lj js lk jw ll ka ld kn ko kp bi translated"><a class="ae kb" href="https://github.com/terraform-google-modules/terraform-example-foundation" rel="noopener ugc nofollow" target="_blank">GCP-地形-范例-基础</a></li><li id="7501" class="kh ki hi jf b jg le jk lf jo lg js lh jw li ka ld kn ko kp bi translated"><a class="ae kb" href="https://www.doit-intl.com/refactor-terraform-into-modules-the-right-way/" rel="noopener ugc nofollow" target="_blank">重构平台的最佳实践</a></li><li id="d88c" class="kh ki hi jf b jg le jk lf jo lg js lh jw li ka ld kn ko kp bi translated">GCP地形模块:<a class="ae kb" href="https://github.com/terraform-google-modules/terraform-google-folders" rel="noopener ugc nofollow" target="_blank">文件夹</a>、<a class="ae kb" href="https://github.com/terraform-google-modules/terraform-google-project-factory" rel="noopener ugc nofollow" target="_blank">项目-工厂</a>、<a class="ae kb" href="https://github.com/terraform-google-modules/terraform-google-cloud-storage" rel="noopener ugc nofollow" target="_blank"> GCS </a> &amp; <a class="ae kb" href="https://github.com/terraform-google-modules/terraform-google-service-accounts" rel="noopener ugc nofollow" target="_blank">服务账户</a></li></ul></div></div>    
</body>
</html>