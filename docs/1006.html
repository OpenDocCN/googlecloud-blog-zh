<html>
<head>
<title>HTTPS with Cert-Manager on GKE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HTTPS与GKE证书管理器</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/https-with-cert-manager-on-gke-49a70985d99b?source=collection_archive---------0-----------------------#2019-05-21">https://medium.com/google-cloud/https-with-cert-manager-on-gke-49a70985d99b?source=collection_archive---------0-----------------------#2019-05-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/228eb42706b8d3004c58798faa852beb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5PQ1AUihX7cstiqj"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><a class="ae hv" href="https://unsplash.com/@milkovi?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米尔科维</a>在<a class="ae hv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><div class=""/><p id="517b" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在某些时候，通常是在发布的时候，你开始担心像HTTPS这样的事情，以及如何向外界公开你的应用程序。在如何为您的域创建和管理您的证书方面，您有几个选项，但实际上最好的方式是您不必管理这些东西的方式—这意味着使用Cert-Manager并让在您的集群内加密。</p><p id="3f8e" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我想指出的是，我在这篇文章中写的所有东西都在外面，我只是发现它们很模糊而且分散，所以在第一次终于弄清楚之后，然后一次又一次地重复这个过程一个多月，我觉得在一个地方写出来是有帮助的，并希望可以省去其他人在凌晨4点发布代码时的麻烦。</p><p id="d1a2" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jt">如果你没有通读甚至没有读过本系列</em>  <em class="jt">的第一部分</em> <a class="ae hv" rel="noopener" href="/@jonbcampos/kubernetes-day-one-30a80b5dcb29"> <em class="jt">，你可能会感到困惑，对代码在哪里或者之前做了什么有疑问。记住这里假设你正在使用</em></a><a class="ae hv" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank"><em class="jt">GCP</em></a><em class="jt">和</em><a class="ae hv" href="https://cloud.google.com/kubernetes-engine/" rel="noopener ugc nofollow" target="_blank"><em class="jt">GKE</em></a><em class="jt">。我将始终提供代码和如何测试代码是按预期工作。</em></p><div class="hh hi ez fb hj ju"><a rel="noopener follow" target="_blank" href="/google-cloud/kubernetes-day-one-30a80b5dcb29"><div class="jv ab dw"><div class="jw ab jx cl cj jy"><h2 class="bd hz fi z dy jz ea eb ka ed ef hx bi translated">Kubernetes:第一天</h2><div class="kb l"><h3 class="bd b fi z dy jz ea eb ka ed ef dx translated">这是Kubernetes帖子的必选步骤之一。如果你对Kubernetes感兴趣，你可能已经读过100本了…</h3></div><div class="kc l"><p class="bd b fp z dy jz ea eb ka ed ef dx translated">medium.com</p></div></div><div class="kd l"><div class="ke l kf kg kh kd ki hp ju"/></div></div></a></div><h1 id="952c" class="kj kk hy bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">HTTP01 vs DNS01</h1><p id="3fc7" class="pw-post-body-paragraph iv iw hy ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">如果您去阅读文档，<a class="ae hv" href="https://cert-manager.readthedocs.io" rel="noopener ugc nofollow" target="_blank">并且您应该在某个时间点</a>，您将看到有两种方法可以验证您是您的域的所有者，并且Cert-Manager应该将正确的证书安装到您的集群中:<a class="ae hv" href="https://cert-manager.readthedocs.io/en/latest/tutorials/acme/http-validation.html" rel="noopener ugc nofollow" target="_blank"> HTTP01 </a>和<a class="ae hv" href="https://cert-manager.readthedocs.io/en/latest/tutorials/acme/dns-validation.html" rel="noopener ugc nofollow" target="_blank"> DNS01 </a>。</p><p id="6d12" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用HTTP01，您必须以正确的顺序设置所有内容，以便Cert-Manager和Let's Encrypt可以在颁发您的证书之前验证您的站点已启动并正在运行。此外，你<strong class="ix hz">必须</strong>在你的域名的根处有可用的<strong class="ix hz">，否则<strong class="ix hz">验证将失败</strong>。</strong></p><p id="0ad3" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用DNS01，您必须创建一个GCP服务帐户，并将信息提供给Cert-Manager，以便让我们加密可以直接与您的DNS对话以验证该域。</p><p id="83c8" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我现在告诉你，DNS01可能看起来更难，但它是更容易的方法。用DNS01就行了。</p><blockquote class="lm ln lo"><p id="dd1f" class="iv iw jt ix b iy iz ja jb jc jd je jf lp jh ji jj lq jl jm jn lr jp jq jr js hb bi translated">开始这个过程时，我假设您有一个带有部署和服务的Kubernetes集群，就是这样。显然，你可以有更多，但在本文的后面，我们将增加入口。好了，我们开始吧。</p></blockquote><h1 id="8081" class="kj kk hy bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">创建服务帐户</h1><p id="cf1a" class="pw-post-body-paragraph iv iw hy ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">因为我们走的是简单的路线，使用DNS01验证，我们首先需要创建一个服务帐户。这是一个多步骤的过程，首先在GCP创建一个服务帐户，下载该帐户，并使用下载的帐户作为Kubernetes集群中的秘密。</p><p id="5182" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，在Google Cloud Shell中创建一个服务帐户。</p><figure class="ls lt lu lv fd hk"><div class="bz dy l di"><div class="lw lx l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">为您的DNS创建服务帐户</figcaption></figure><h1 id="376a" class="kj kk hy bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">创建证书的秘密</h1><p id="fda2" class="pw-post-body-paragraph iv iw hy ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">下载完这个文件后，我们只需要把它变成Kubernetes集群中的一个秘密。</p><figure class="ls lt lu lv fd hk"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="6852" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将服务帐户作为秘密安全地存储在Kubernetes集群中之后，您就可以进入下一步，为Let's Encrypt和Cert-Manager创建证书颁发者了。</p><h1 id="45cb" class="kj kk hy bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">安装舵和证书管理器</h1><p id="5cd3" class="pw-post-body-paragraph iv iw hy ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">现在我们需要将Cert-Manager安装到您的Kubernetes集群中。为此，我们将<a class="ae hv" rel="noopener" href="/google-cloud/install-secure-helm-in-gke-254d520061f7">使用Helm，因为它使复杂的安装变得轻而易举</a>。如果你对Helm不熟悉，你应该看看关于这个问题的另一个帖子。</p><div class="hh hi ez fb hj ju"><a rel="noopener follow" target="_blank" href="/google-cloud/install-secure-helm-in-gke-254d520061f7"><div class="jv ab dw"><div class="jw ab jx cl cj jy"><h2 class="bd hz fi z dy jz ea eb ka ed ef hx bi translated">在谷歌Kubernetes引擎(GKE)安装安全头盔</h2><div class="kb l"><h3 class="bd b fi z dy jz ea eb ka ed ef dx translated">在我的上一篇文章中，我谈了很多关于Helm的乐趣以及为什么你应该花时间把它安装到你的…</h3></div><div class="kc l"><p class="bd b fp z dy jz ea eb ka ed ef dx translated">medium.com</p></div></div><div class="kd l"><div class="ly l kf kg kh kd ki hp ju"/></div></div></a></div><p id="1b39" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设您的Kubernetes集群中安装了Helm，我们可以用一行代码安装Cert-Manager。神奇！</p><figure class="ls lt lu lv fd hk"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="da5c" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">仅仅几行代码就能做这么多事情，这真的令人惊讶。我们已经完成了一半，最困难的部分都完成了！</p><h1 id="ba1a" class="kj kk hy bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">申请发行人</h1><p id="126a" class="pw-post-body-paragraph iv iw hy ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">使用“让我们加密”时，您需要提供“让我们加密”和证书颁发者的联系信息。奇妙的是，Cert-Manager处理与Let's Encrypt的通信，所以只要您向Kubernetes集群提供一个Issuer文件，其余的就由您处理了。</p><p id="56e3" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们看看您需要创建的发行者文件。</p><figure class="ls lt lu lv fd hk"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="5781" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将创建一个准备和生产<code class="du lz ma mb mc b">ClusterIssuer</code>文件，供Cert-Manager使用。我们将只真正使用生产文件<code class="du lz ma mb mc b">ClusterIssuer</code>,但是如果您想使用它的话，另一个文件也不错。重要的是更新电子邮件地址，成为您组织的联系人。</p><p id="ae5e" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有了这个文件，我们只需要将它应用到我们的集群。</p><figure class="ls lt lu lv fd hk"><div class="bz dy l di"><div class="lw lx l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">申请发行人</figcaption></figure><p id="d60a" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">很简单！下一步是创建实际的证书。</p><h1 id="9086" class="kj kk hy bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">应用证书</h1><p id="e8f8" class="pw-post-body-paragraph iv iw hy ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">现在是真正令人兴奋的部分——这也需要一点耐心。我们将创建一个新的证书，它将通过Cert-Manager发起一个请求，让我们加密以获得TLS证书。</p><p id="4c4f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">与发行者一样，首先，我们创建Kuberenetes文件。</p><figure class="ls lt lu lv fd hk"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="263b" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后我们应用文件。</p><figure class="ls lt lu lv fd hk"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="d862" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在真正令人兴奋的事情开始发生了。您可以通过连续运行以下命令来观察进度。</p><figure class="ls lt lu lv fd hk"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="b426" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们一遍又一遍地调用这个函数，看着Cert-Manager代表我们与Let's Encrypt通信。如果你在<code class="du lz ma mb mc b">ClusterIssuer</code>或<code class="du lz ma mb mc b">Certificate</code>上搞砸了，这是你发现的时候了。通过阅读输出，我们可能会发现域设置不正确或其他一些问题。这些很容易修复和重新部署文件。每当您重新部署任何文件时，请确保也重新部署certificate.yaml。</p><figure class="ls lt lu lv fd hk"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="b1c3" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">大约10-15分钟后，您将最终看到您所希望的最惊人的输出，一条成功的消息！</p><figure class="ls lt lu lv fd hk"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="178c" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这真的很神奇！完成这些后，我们只需要几个简单的步骤，就可以放下凌晨4点的工作了！</p><h1 id="15de" class="kj kk hy bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">创建一个全球IP地址</h1><p id="a343" class="pw-post-body-paragraph iv iw hy ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">为了实现这一切，我们需要为您的Kubernetes集群创建一个固定的IP地址，以满足其所有的入口需求。GKE提供给Kubernetes集群的默认IP地址是短暂的，这意味着它随时都会改变，所以这是行不通的。我们需要在GCP为您的集群创建一个静态IP地址。这真的很简单，只需要一行脚本。</p><figure class="ls lt lu lv fd hk"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="63ce" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这可能要花一点时间，但你会有你的IP地址路由到你的DNS更多关于这一点。</p><h1 id="c54b" class="kj kk hy bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">将您的域名指向您的IP地址</h1><p id="91ac" class="pw-post-body-paragraph iv iw hy ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">有了您的IP地址，我们现在需要转到您的DNS，并将DNS名称设置为指向您的IP地址。出于我的需要，我使用云DNS作为GCP的一部分。我不打算重复这些步骤，因为<a class="ae hv" href="https://cloud.google.com/dns/docs/quickstart" rel="noopener ugc nofollow" target="_blank">谷歌在记录快速入门</a>的步骤方面做得很好。基本上，只需使用CName将您的IP地址指向DNS条目。</p><div class="hh hi ez fb hj ju"><a href="https://cloud.google.com/dns/docs/quickstart" rel="noopener  ugc nofollow" target="_blank"><div class="jv ab dw"><div class="jw ab jx cl cj jy"><h2 class="bd hz fi z dy jz ea eb ka ed ef hx bi translated">快速入门|云DNS文档| Google云</h2><div class="kb l"><h3 class="bd b fi z dy jz ea eb ka ed ef dx translated">无论您的企业是刚刚踏上数字化转型之旅，还是已经走上数字化转型之路，谷歌云的解决方案…</h3></div><div class="kc l"><p class="bd b fp z dy jz ea eb ka ed ef dx translated">cloud.google.com</p></div></div><div class="kd l"><div class="md l kf kg kh kd ki hp ju"/></div></div></a></div><h1 id="a86a" class="kj kk hy bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">在您的入口中包含TLS</h1><p id="8e98" class="pw-post-body-paragraph iv iw hy ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">在整个过程中，我们假设您有一个部署和一个服务，现在我们添加入口资源以路由到您的服务。</p><figure class="ls lt lu lv fd hk"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="3b1c" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这为您的主机建立了一条安全的路径，您的所有服务都可以利用由您的<code class="du lz ma mb mc b">my-certs</code>证书管理的秘密来使用这条路径。你完了！</p><h1 id="98f5" class="kj kk hy bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">结论</h1><p id="ddac" class="pw-post-body-paragraph iv iw hy ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">这是很多步骤，但它们是值得的。尤其是现在你的SSL证书将自动由Cert-Manager管理，并由Let's Encypt发布，你不必担心。您可以获得所有的安全性，而不会持续头痛。这是值得的一次性设置成本。</p><p id="8e0f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您阅读了这篇文章，并有任何问题，请随时联系我们。我知道这可能很复杂，我已经经历了这些步骤很多很多次了。</p></div><div class="ab cl me mf gp mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="hb hc hd he hf"><p id="ed9a" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae hv" href="http://jonbcampos.com/" rel="noopener ugc nofollow" target="_blank">乔纳森·坎波斯</a>是一个狂热的开发者，也是学习新事物的爱好者。我相信我们应该不断学习、成长和失败。我总是开发社区的支持者，并且总是愿意提供帮助。因此，如果您对这个故事有任何问题或评论，请在下面添加。通过<a class="ae hv" href="https://www.linkedin.com/in/jonbcampos/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>或<a class="ae hv" href="https://twitter.com/jonbcampos" rel="noopener ugc nofollow" target="_blank"> Twitter </a>与我联系，并提及这个故事。</p></div></div>    
</body>
</html>