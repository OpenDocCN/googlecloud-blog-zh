<html>
<head>
<title>BigQuery Table Comparison</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery表比较</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bigquery-table-comparison-cea802a3c64d?source=collection_archive---------0-----------------------#2019-09-30">https://medium.com/google-cloud/bigquery-table-comparison-cea802a3c64d?source=collection_archive---------0-----------------------#2019-09-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="737b" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="0c15" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">有时需要比较两个BigQuery表中的数据。您可能希望这样做(逐行匹配整行)，有时通过键进行比较。这比你想象的要容易得多！</p><h1 id="6077" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">抽样资料</h1><p id="554b" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">注意:您需要这个SQL的<strong class="jf hj">事务</strong>数据集。</p><p id="93ac" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">创建一个包含一百万行的left_table。这将包含用于比较的基表。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="a8b8" class="kp ig hi kl b fi kq kr l ks kt">CREATE OR REPLACE TABLE `transactions.left_table` AS<br/>SELECT<br/>  r AS id,<br/>  CAST(r AS STRING) AS col1,<br/>  CAST(FLOOR(RAND() * 1000) AS STRING) AS col2,<br/>  'x' AS col3,<br/>  'y' AS col4<br/>FROM<br/>  UNNEST(GENERATE_ARRAY(1, 1000000)) r;</span></pre><p id="eab7" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">用几乎相同的数据创建一个right_table，但是有一些删除、更新和插入。有一个概率用于删除和更新，而100行只是简单地插入。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="2a57" class="kp ig hi kl b fi kq kr l ks kt">CREATE OR REPLACE TABLE `transactions.right_table` AS<br/>WITH<br/>  DataChanges AS (<br/>    SELECT<br/>      * EXCEPT (col3, col4),<br/>      IF(RAND() &lt; 0.001, 'new-x', col3) AS col3,<br/>      col4<br/>    FROM<br/>      `transactions.left_table`<br/>    WHERE<br/>      RAND() &gt; 0.001<br/>  ),<br/>  NewData AS (<br/>    SELECT<br/>      r AS id,<br/>      CAST(r AS STRING) AS col1,<br/>      CAST(FLOOR(RAND() * 1000) AS STRING) AS col2,<br/>      'x' AS col3,<br/>      'y' AS col4<br/>    FROM<br/>      UNNEST(GENERATE_ARRAY(1000000, 1000100)) r<br/>  )<br/>SELECT * FROM DataChanges<br/>UNION ALL<br/>SELECT * FROM NewData;</span></pre><h1 id="4aef" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">全表比较</h1><p id="b6bd" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">整个表比较将在每行生成一个FARM_FINGERPRINT。这将允许我们在这个散列上做一个完整的外部连接，并查看有哪些值存在于一端而不存在于另一端。</p><p id="7487" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">请注意，如果没有键，我们就无法判断一行是否已被更新。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="2c8b" class="kp ig hi kl b fi kq kr l ks kt">WITH<br/>  LeftData AS (<br/>    SELECT<br/>      a AS data,<br/>      FARM_FINGERPRINT(FORMAT("%T", a)) AS h<br/>    FROM<br/>      `transactions.left_table` AS a<br/>  ),<br/>  RightData AS (<br/>    SELECT<br/>      b AS data,<br/>      FARM_FINGERPRINT(FORMAT("%T", b)) AS h<br/>    FROM<br/>      `transactions.right_table` AS b<br/>  )<br/>SELECT<br/>  IF(l.h IS NULL,"New on right","New on left") AS Change,<br/>  IF(l.h IS NULL,r.data,l.data).*<br/>FROM<br/>  LeftData l<br/>  FULL OUTER JOIN RightData r<br/>  ON l.h = r.h<br/>WHERE<br/>  l.h IS NULL OR<br/>  r.h IS NULL</span></pre><p id="cc45" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">上面的代码可以修改，这样它就可以用GROUP BY对行进行计数，而不是列出行。</p><h1 id="1ecc" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">逐键比较</h1><p id="b286" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们希望逐行比较，而不只是比较整个表。所以我们将使用这个键来确定它是插入、更新还是删除。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="aee1" class="kp ig hi kl b fi kq kr l ks kt">SELECT<br/>  CASE<br/>    WHEN a.id IS NULL AND b.id IS NOT NULL THEN "I"<br/>    WHEN a.id IS NOT NULL AND b.id IS NULL THEN "D"<br/>    ELSE "U"<br/>  END AS op,<br/>  IF(b.id IS NULL, a, b).*<br/>FROM<br/>  `transactions.left_table` a<br/>  FULL OUTER JOIN `transactions.right_table` b<br/>  ON a.id = b.id<br/>WHERE<br/>  a.id IS NULL OR<br/>  b.id IS NULL OR<br/>  FARM_FINGERPRINT(FORMAT("%T", a)) &lt;&gt;<br/>  FARM_FINGERPRINT(FORMAT("%T", b));</span></pre><p id="5950" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这将在left_table和right_table之间生成类似于更改数据捕获的日志。下面是运行这个的输出示例。</p><figure class="kg kh ki kj fd kv er es paragraph-image"><div class="er es ku"><img src="../Images/b0213763af2d871154880c5de6229f65.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/format:webp/1*K5TSZAwRGnaAgIjv-Ytc1Q.png"/></div></figure><h1 id="1c14" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">结论</h1><p id="49f6" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">BigQuery可用于创建测试用例，验证您的数据，从快照生成CDC日志相当容易。这可以在没有显式的逐列比较的情况下完成。</p><p id="f863" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><em class="ky">感谢</em> <a class="ae kz" href="http://www.medium.com/@thinhha" rel="noopener"> <em class="ky">薄哈</em> </a> <em class="ky">的比较查询。</em></p></div></div>    
</body>
</html>