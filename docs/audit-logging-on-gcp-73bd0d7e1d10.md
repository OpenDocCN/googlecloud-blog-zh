# GCP 上的审核日志记录

> 原文：<https://medium.com/google-cloud/audit-logging-on-gcp-73bd0d7e1d10?source=collection_archive---------4----------------------->

两周前在 Google Cloud Next 上，我有机会与许多使用或试用 Google 产品的人聊天。关于变更管理和审计日志的问题经常出现。有些人想要配置更改的通知。其他人想要一种快速简单的方法来查看谁在做什么，以便进行审计。许多与会者不知道 Google Cloud 现有的审计日志功能，也不知道如何对特定的审计事件设置警报。如果你需要做这些类型的任务，这篇博客应该可以帮助你开始。

## 第一:警觉哲学

有许多方法可以发出警报。根据我多年来随身携带寻呼机的经验，我对什么类型的提醒是有用的和合适的有自己的看法。

我的基本原则是警报应该是可操作的。这是一种普遍的哲学。保罗·纽森(SRE 倡导者)告诉我，提醒的媒介应该与提醒的紧急程度相匹配。页面应该是需要立即关注的东西。应该在未来 12 小时内处理的项目可能会进入票务系统。不紧急的警报可能会被发送到电子邮件中，而不会被阅读。

我还希望我的监控系统具有良好的信噪比。任何不可操作的警报或者由于其他情况我可以忽略的警报都会增加噪音。我知道很多人最终会把电话或寻呼机放在冰箱里过夜，因为它会不停地重复一个错误的页面。

监控方法涉及的内容还很多。以上想法是在设置系统时需要考虑的一些事情。查看 SRE 图书[中关于监控分布式系统的章节](https://landing.google.com/sre/book/chapters/monitoring-distributed-systems.html)，了解更多关于谷歌如何进行监控的信息。

## 查看审计日志

要查看审计日志，请从云控制台主页开始，然后单击“活动”这会将您带到“审计日志摘要”页面。有两种审计日志:管理活动和数据访问。管理活动包括资源创建、更新和删除。管理活动还包括通过 gcloud SDK 或使用 web UI 对系统进行的 API 调用。支持管理活动日志的产品列表是[这里是](https://cloud.google.com/logging/docs/audit/#admin_activity_logs)。

数据访问日志跟踪对数据库和其他数据存储中用户提供的数据的访问。目前，唯一支持数据访问日志的产品是 BigQuery。数据访问日志在审计日志摘要的默认视图中不可见。

所有项目成员都可以看到管理活动日志。数据访问日志仅对拥有私有日志查看者 IAM 角色的用户可见。

审核日志摘要允许您查看生成日志的操作以及执行该操作的用户(由其电子邮件地址标识)。您可以一次查看多个项目的日志，并将视图限制为特定类型的资源、日志类型和时间范围。

## 查看堆栈驱动程序日志中的审核日志

摘要视图的数据量相对有限。如果您需要高级过滤或者想要查看整个日志消息，您应该使用 [Stackdriver Logging](https://console.cloud.google.com/logs) 。在 Stackdriver Logging 中，选择您感兴趣的资源类型，然后在包含不同日志类型的下拉列表中选择“activity”。

如果展开日志消息，您可以看到身份验证信息、调用的方法、事件消息以及关于请求的其他信息。需要注意的一件重要事情是，每个管理操作都有两个关联的日志。一个事件记录操作的开始，另一个事件记录操作的完成。您可以使用顶部的自由文本字段来搜索特定的日志，或者您可以单击 eventMessage 或 methodName 之类的字段，并选择显示或隐藏类似的消息。

## 审计日志警报

在审核日志上设置警报与设置其他形式的基于日志的警报相同。您需要从 Stackdriver 日志日志查看器开始。然后，您可以使用上述方法构建过滤器，以缩小您想要警报的特定消息的范围。

缩小搜索范围后，使用“创建指标”按钮创建一个[指标](https://cloud.google.com/logging/docs/view/logs_based_metrics)。度量是基于特定日志记录查询的数据，日志记录将这些数据提供给 Stackdriver Monitoring。

一旦您创建了指标，请转到[堆栈驱动程序监控](http://console.cloud.google.com/monitoring)并单击“创建警报策略”当您为警报设置条件时，选择“日志度量”作为资源，您将在日志查看器中看到您之前创建的度量。然后，您可以根据紧急程度设置通知方法。Webhook alerts 非常适合将 Stackdriver 监控连接到您的票务系统。信息提示如果出现在 HipChat 这样的团队聊天程序中可能是最好的。我还喜欢包含一些文档，告诉我在收到这个警告时应该做什么，这样如果有一堆东西正在燃烧，我就可以快速提醒我从哪里开始寻找。

*原载于*[*Thagomizer——命运之刺*](http://thagomizer.com/blog/2017/03/23/audit-logging-on-gcp.html)