<html>
<head>
<title>Serverless Computing Made Easy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器计算变得简单</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/serverless-computing-made-easy-40e534ae410e?source=collection_archive---------0-----------------------#2019-11-08">https://medium.com/google-cloud/serverless-computing-made-easy-40e534ae410e?source=collection_archive---------0-----------------------#2019-11-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e50571c2a130cea1e8a6541288493da3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ckdxbfVw24k4717w7kaVKQ.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">谷歌云平台的云功能是一种无需服务器的便捷方式</figcaption></figure><p id="976a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi js translated">谷歌云平台(GCP)具有强大的无服务器计算功能。云函数不仅允许按需进行函数式编程，它们还可以作为云范围内的事件处理程序。</p><p id="203d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">将我们的讨论缩小到一个常见的用例，我们可以从Stackdriver中记录的事件触发云功能。在这种情况下，我们将使用一个我们可以轻松控制的事件；将外部IP连接到虚拟机。当检测到静态IP更改时，受影响的虚拟机将在GCP环境中迁移。这样做的实际目的是修复无法注册新静态IP地址的虚拟机。</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kb"><img src="../Images/f4e15c53224b3ae2a4612eb3533942cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QKv4Tay4PBMKpc1wE3_srg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">将静态外部IP连接到虚拟机会创建堆栈驱动程序日志记录事件</figcaption></figure><p id="7f9b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这篇博文的源代码可以在Github 的<a class="ae kg" href="https://github.com/waheedbrown/serverless" rel="noopener ugc nofollow" target="_blank">这里找到。提供了一个安装脚本(</a><a class="ae kg" href="https://github.com/waheedbrown/serverless/blob/master/gcloud_script.sh" rel="noopener ugc nofollow" target="_blank"> gcloud_script.sh </a>)，以及自述文件中的说明。安装脚本将为读者配置所有必需的GCP资源。请注意安装脚本开始时的Linux shell脚本变量。您至少需要为您自己的GCP项目添加PROJECT_ID。</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kh"><img src="../Images/be28279b16f4df6db056587dc6d3632d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CcCt1bjtq3d6u7SnQji0uA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Github上的源代码(<a class="ae kg" href="https://github.com/waheedbrown/serverless" rel="noopener ugc nofollow" target="_blank">点击这里</a>)</figcaption></figure><p id="cb08" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">浏览安装脚本，有一系列gcloud命令。这些命令的应用通常对GCP工具箱是有用的。特别感兴趣的是创建日志接收器和GCP云函数的命令:</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ki"><img src="../Images/6381696060e34b46a2b6932fa89c4ee2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uXCd_L7IzZOUgScHty5ohw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">日志接收器将Stackdriver连接到Pub/Sub</figcaption></figure><figure class="kc kd ke kf fd ij er es paragraph-image"><div class="er es kj"><img src="../Images/e5af0cd993339a695bdc93c143f0b961.png" data-original-src="https://miro.medium.com/v2/resize:fit:1042/format:webp/1*hCum18QoNigdDIuQ3ivw1Q.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">云功能由发布/订阅主题触发，由日志接收器写入</figcaption></figure><p id="401a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">日志接收器实际上是为云功能连接一切的东西。Stackdriver日志过滤器实时捕获匹配的日志记录条目。这些条目随后被日志接收器捕获，然后发布到发布/订阅主题。关于发布/订阅的深入讨论超出了这篇博文的范围，这也是提供安装脚本的原因。同样，安装脚本创建了云函数。</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kk"><img src="../Images/5cde18f51f6efde889daff6b48093c23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SbixjaNCqSDpo4zUNup1Wg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Stackdriver日志记录接收器的目的地是一个发布/订阅主题，在GCP控制台中可见</figcaption></figure><p id="1f62" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">云功能是存在于临时可用的VM资源上的代码片段。这不是由用户控制的虚拟机，在GCP控制台中也不可见。可见的是专门执行云功能的Google Cloud App Engine服务账号。</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kl"><img src="../Images/b74c7034928b51dbbb6e6ebe04b7d561.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WqeAaxyjB-nycwHul0Q0gg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">App Engine服务帐户代表用户执行云功能</figcaption></figure><p id="dc7f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">云函数的主体包含在Github存储库中的main.py中。这个名称很重要，因为gcloud在创建云函数本身时会查找这个特定的名称。gcloud还会将main.py上传到您的GCP项目中的云函数工作区。然后，该函数被赋予您指定的名称。虽然云函数创建的机制超出了本文的范围，但是重要的是创建语法。使用安装脚本中的语法是创建云函数的一种可靠方式。存在其他方法，但是它们经常提供非描述性的错误。</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ki"><img src="../Images/8bb857598e923e4a18284bde20d7d5f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Me4qjh1V26tnBJswiB85uQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">main.py包含云函数体，在本例中是用Python编写的</figcaption></figure><p id="ab9f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">仔细看看云函数体，最重要的一步是第8行。在这里，云函数根据Google Cloud进行认证。由于App Engine服务帐户已经拥有必要的权限，因此这一步非常简单。相比之下，如果我们编写一个在云功能之外执行的脚本，认证将需要更多的劳动。</p><p id="9092" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">第11行说明Stackdriver日志是base64编码的。第12行说明了以JSON格式保存的Stackdriver日志。第15到17行访问JSON树中的各种元素，每组括号代表树的深度。</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es km"><img src="../Images/20e492a2b887c7959cb92d82ad116c17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vx-RhhF2PeKh6bI9jzvmUA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">在云控制台的Stackdriver日志记录页面上，单击小三角形并进入高级过滤模式</figcaption></figure><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kn"><img src="../Images/86ca4a0126f153d8092a47f88d88c06b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NroAh5kW1hLoobAV_xTcTg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">从gcloud_script.sh安装文件中输入高级日志过滤器(去掉引号)</figcaption></figure><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/006e3a1f0d6b092fa44c2dea28343eef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HqN4V-_-eI_NDMZXctfUYg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">resource是JSON根节点，labels和project_id是一层和两层</figcaption></figure><p id="ffb1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">云函数中的第20行触发了虚拟机迁移。</p><p id="6b10" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">了解了所有这些，就可以将一个静态IP附加到一个虚拟机上来触发云功能。gcloud_script.sh安装脚本创建了两个静态ip，static-ip-1和static-ip-2。将其中任何一个分配给脚本创建的虚拟机都会触发云功能。</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kb"><img src="../Images/f4e15c53224b3ae2a4612eb3533942cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QKv4Tay4PBMKpc1wE3_srg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">在GCP控制台的“VPC网络，外部IP地址”部分，可以手动将静态IP分配给虚拟机</figcaption></figure><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kp"><img src="../Images/e1ca4f23ba6cf3ac1d0d2f13af18005f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pDD-RtwpaMVPab5wXnr6Ow.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">调用了云函数，如调用图上的尖峰所示</figcaption></figure><p id="8eae" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">最后，云函数本身会创建一个Stackdriver事件。这有助于确认云功能是否确实有效。对于应用引擎服务帐户，包含“GCE_OPERATION_DONE”的日志条目将提供此确认。为了方便起见，本文中使用的Stackdriver日志过滤器也在Github存储库中。</p><p id="9f77" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">注意:</strong>云函数的执行和它在Stackdriver中的日志记录之间偶尔会有滞后。如果你怀疑有一个合理的错误，向下滚动到调试文章的链接。</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kq"><img src="../Images/7ce1e627286d58f4621e19a68c159013.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5mkDihNMOdis9hP_PNP_hQ.png"/></div></div></figure><p id="a096" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下一篇文章将介绍<a class="ae kg" rel="noopener" href="/google-cloud/debugging-serverless-functions-53f99a7f3cb2">调试无服务器功能</a>，这将使您自信地走向无服务器。</p></div></div>    
</body>
</html>