<html>
<head>
<title>Live Ethereum and Bitcoin Data in Google BigQuery and Pub/Sub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google BigQuery和Pub/Sub中的实时以太坊和比特币数据</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/live-ethereum-and-bitcoin-data-in-google-bigquery-and-pub-sub-765b71cd57b5?source=collection_archive---------0-----------------------#2019-10-07">https://medium.com/google-cloud/live-ethereum-and-bitcoin-data-in-google-bigquery-and-pub-sub-765b71cd57b5?source=collection_archive---------0-----------------------#2019-10-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="44f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">BigQuery中的<a class="ae jd" href="https://console.cloud.google.com/bigquery?p=bigquery-public-data&amp;d=crypto_ethereum&amp;t=transactions&amp;page=table" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">crypto _ ether eum</strong></a><strong class="ih hj"/>和<strong class="ih hj"/><a class="ae jd" href="https://console.cloud.google.com/bigquery?p=bigquery-public-data&amp;d=crypto_bitcoin&amp;t=transactions&amp;page=table" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">crypto _ bit coin</strong></a><strong class="ih hj"/>数据集现在使用<a class="ae jd" href="https://cloud.google.com/bigquery/streaming-data-into-bigquery" rel="noopener ugc nofollow" target="_blank">流技术</a>进行更新。您还可以订阅为这些表提供信息的公共发布/订阅主题。</p><p id="ab18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">总体架构如下所示:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/4f39bb0a43f3ab49bcfac8ff22971ff1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tBPZtceVi6iPl8mK"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">区块链ETL架构</figcaption></figure><p id="e86f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">涵盖了以下区块链:</p><ul class=""><li id="de1a" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">以太坊</li><li id="72ae" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">比特币</li><li id="129e" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">ZCash</li><li id="d123" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">莱特币</li><li id="5714" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">总督</li><li id="e5c5" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">破折号</li></ul><p id="4b50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们为每个区块链添加了延迟，以防止链重组导致的孤立块流。你可以在Github库<a class="ae jd" href="https://github.com/blockchain-etl/blockchain-etl-streaming/tree/master/overlays/bitcoin" rel="noopener ugc nofollow" target="_blank">https://github.com/blockchain-etl-streaming</a>的配置文件中的<code class="du ki kj kk kl b">LAG_BLOCKS</code>参数中查找我们落后链顶端多少块。这些值是根据去年最长的孤立链乘以安全系数计算出来的。对于以太坊，我们以相当于大约4分钟滞后的偏移结束。对于比特币来说，这个值相当于30分钟的滞后。</p><p id="1dca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们目前正在开发一个解决方案，它将使用额外的消息类型来处理链重组，并允许订阅最新的数据。</p><h2 id="7a56" class="km kn hi bd ko kp kq kr ks kt ku kv kw iq kx ky kz iu la lb lc iy ld le lf lg bi translated">订阅实时数据馈送</h2><p id="d4ed" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/sdk/docs/downloads-interactive" rel="noopener ugc nofollow" target="_blank">安装谷歌云SDK </a>:</p><pre class="jf jg jh ji fd lm kl ln lo aw lp bi"><span id="cf46" class="km kn hi kl b fi lq lr l ls lt">&gt; curl https://sdk.cloud.google.com | bash<br/>&gt; exec -l $SHELL<br/>&gt; gcloud init</span></pre><p id="087c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为以太坊内部交易创建发布/订阅:</p><pre class="jf jg jh ji fd lm kl ln lo aw lp bi"><span id="7941" class="km kn hi kl b fi lq lr l ls lt">&gt; gcloud pubsub subscriptions create <strong class="kl hj">crypto_ethereum.traces.test</strong> --topic=<strong class="kl hj">crypto_ethereum.traces</strong> --topic-project=<strong class="kl hj">crypto-public-data</strong></span></pre><p id="31ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">阅读订阅中的一条消息来测试它是否有效:</p><pre class="jf jg jh ji fd lm kl ln lo aw lp bi"><span id="2cdd" class="km kn hi kl b fi lq lr l ls lt">&gt; gcloud pubsub subscriptions pull <strong class="kl hj">crypto_ethereum.traces.test</strong></span></pre><p id="b2fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以使用以下Python脚本运行订阅者并处理订阅中的消息:</p><p id="e985" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lu"> subscribe.py </em></p><pre class="jf jg jh ji fd lm kl ln lo aw lp bi"><span id="997f" class="km kn hi kl b fi lq lr l ls lt">import time</span><span id="3c52" class="km kn hi kl b fi lv lr l ls lt">from google.cloud import pubsub_v1</span><span id="9936" class="km kn hi kl b fi lv lr l ls lt"><strong class="kl hj"># TODO project_id = "Set Your Google Cloud Project ID Here"</strong><br/>subscription_name = "crypto_ethereum.traces.test"</span><span id="2e2f" class="km kn hi kl b fi lv lr l ls lt">subscriber = pubsub_v1.SubscriberClient()<br/># The `subscription_path` method creates a fully qualified identifier<br/># in the form `projects/{project_id}/subscriptions/{subscription_name}`<br/>subscription_path = subscriber.subscription_path(<br/>    project_id, subscription_name)</span><span id="6757" class="km kn hi kl b fi lv lr l ls lt">def callback(message):<br/>    print('Received message: {}'.format(message))<br/>    message.ack()</span><span id="263a" class="km kn hi kl b fi lv lr l ls lt">subscriber.subscribe(subscription_path, callback=callback)</span><span id="0560" class="km kn hi kl b fi lv lr l ls lt"># The subscriber is non-blocking. We must keep the main thread from<br/># exiting to allow it to process messages asynchronously in the background.<br/>print('Listening for messages on {}'.format(subscription_path))<br/>while True:<br/>    time.sleep(60)</span></pre><p id="3475" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装依赖项并运行脚本:</p><pre class="jf jg jh ji fd lm kl ln lo aw lp bi"><span id="cd00" class="km kn hi kl b fi lq lr l ls lt">&gt; pip install google-cloud-pubsub==1.0.1<br/>&gt; python subscribe.py</span><span id="6351" class="km kn hi kl b fi lv lr l ls lt">Listening for messages...<br/>Received message: Message {<br/>  data: b'{"type": "trace", "transaction_index": 158, "from_...'<br/>  attributes: {<br/>    "item_id": "trace_call_0xce2ce80594f7601726d03114366161a0050d4a0beedd8628655f1a19319f203d_"<br/>  }<br/>}<br/>Received message: Message {<br/>  data: b'{"type": "trace", "transaction_index": 159, "from_...'<br/>  attributes: {<br/>    "item_id": "trace_call_0x7d121090c65c93ac6ba99764bae40ef384c388a139578194c503b92228ccfb3d_"<br/>  }<br/>}<br/>...</span></pre><p id="d8b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">也可以用Go、Java、Node.js或者c#:<a class="ae jd" href="https://cloud.google.com/pubsub/docs/pull" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/pubsub/docs/pull</a>。</p><p id="b22c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Pub/Sub中的前10GB数据是免费的，之后你需要支付大约40美元/TB。平均每月有40GB以太坊痕迹，相当于每月约1美元。</p><p id="6c89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还可以订阅比特币区块和交易以及以太坊区块、交易、日志、合约、代币等主题。主题名称遵循BigQuery表的命名约定，因此您可以很容易地找到它们:<code class="du ki kj kk kl b">projects/crypto-public-data/topics/crypto_{chain}.{table_name}</code>，其中:</p><ul class=""><li id="6e28" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated"><code class="du ki kj kk kl b">chain</code>可以是<code class="du ki kj kk kl b">ethereum</code>、<code class="du ki kj kk kl b">bitcoin</code>、<code class="du ki kj kk kl b">zcash</code>、<code class="du ki kj kk kl b">litecoin</code>、<code class="du ki kj kk kl b">dogecoin</code>或<code class="du ki kj kk kl b">dash</code>中的一种。</li><li id="d21e" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><code class="du ki kj kk kl b">table_name</code>可以是<code class="du ki kj kk kl b">blocks</code>或<code class="du ki kj kk kl b">transactions</code>中的一种。另外对于以太坊:<code class="du ki kj kk kl b">logs</code>、<code class="du ki kj kk kl b">token_transfers</code>、<code class="du ki kj kk kl b">traces</code>、<code class="du ki kj kk kl b">contracts</code>和<code class="du ki kj kk kl b">tokens</code>。</li></ul><p id="9afc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来是一篇关于Twitter机器人的文章，它使用<a class="ae jd" href="https://cloud.google.com/dataflow" rel="noopener ugc nofollow" target="_blank">数据流</a>和<a class="ae jd" href="https://cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">云函数</a>发布异常交易。</p><h2 id="7b3e" class="km kn hi bd ko kp kq kr ks kt ku kv kw iq kx ky kz iu la lb lc iy ld le lf lg bi translated">另请参阅:</h2><ul class=""><li id="547c" class="ju jv hi ih b ii lh im li iq lw iu lx iy ly jc jz ka kb kc bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/how-to-query-balances-for-all-ethereum-addresses-in-bigquery-fb594e4034a7">如何查询所有以太坊地址的余额</a></li><li id="a9fc" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/calculating-gini-coefficient-in-bigquery-3bc162c82168">在BigQuery中计算基尼系数</a></li><li id="8381" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><a class="ae jd" href="https://cloud.google.com/blog/products/data-analytics/ethereum-bigquery-how-we-built-dataset" rel="noopener ugc nofollow" target="_blank">big query中的以太坊:我们如何构建这个数据集</a></li><li id="730b" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/real-time-ethereum-notifications-for-everyone-for-free-a76e72e45026">实时以太坊免费通知大家</a></li></ul><p id="6e2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在推特上关注我们:<a class="ae jd" href="https://twitter.com/BlockchainETL" rel="noopener ugc nofollow" target="_blank">https://twitter.com/BlockchainETL</a></p></div></div>    
</body>
</html>