<html>
<head>
<title>Incremental MySQL loads to BigQuery using Matillion</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Matillion将MySQL增量加载到BigQuery</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/incremental-mysql-loads-to-bigquery-using-matillion-d3b182773b00?source=collection_archive---------2-----------------------#2018-02-15">https://medium.com/google-cloud/incremental-mysql-loads-to-bigquery-using-matillion-d3b182773b00?source=collection_archive---------2-----------------------#2018-02-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3362" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为为我们的一个客户构建企业数据仓库的一部分，我们必须以30分钟的间隔将一堆表从MySQL复制从属服务器同步到BigQuery。考虑到其他非关系数据源的范围也是这个负载的一部分，我们选择了Matillion作为ETL工具。Matillion易于设置(只需供应虚拟机并开始创作作业)，集成列表很长，因此很有意义。</p><p id="32d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章解释了如何构建一个具有以下功能的物料作业:</p><ol class=""><li id="0afc" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">满载</li><li id="7e28" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">对具有较大行数的表进行增量加载，并且自上次加载以来可以查找新行的<code class="du jr js jt ju b">ID</code>。</li></ol><p id="c252" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你在Google上搜索Matillion——我假设你已经完成了实例的设置，默认项目的设置等等，所以我跳过这些。虽然Matillion附带了PostgreSQL驱动程序，但出于某种原因，它没有MYSQL驱动程序——你必须首先设置它们。</p><ul class=""><li id="6abd" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc jv jj jk jl bi translated">从这里下载驱动<a class="ae jw" href="https://dev.mysql.com/downloads/connector/j/" rel="noopener ugc nofollow" target="_blank"/>。解压缩到jar文件</li><li id="507b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc jv jj jk jl bi translated">在Matillion中，进入<strong class="ih hj">项目- &gt;管理数据库驱动程序，</strong>上传jar文件和<strong class="ih hj">测试。你现在可以走了。</strong></li></ul><p id="bf1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们有一堆有几千条记录的表。即使我们每次都加载整个表，每个表也只需要不到两秒钟时间——所以我们采用了这种方法。在Matillion上这样做很简单。</p><p id="c61f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择<code class="du jr js jt ju b">Database Query</code>组件，并用源和目标配置它。</p><figure class="jx jy jz ka fd kb er es paragraph-image"><div class="ab fe cl kc"><img src="../Images/2ec52e2dbe8b8e0300857617cfb275be.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ShsloYR8cvkfIafo3cWZUw.png"/></div></figure><figure class="jx jy jz ka fd kb er es paragraph-image"><div class="ab fe cl kc"><img src="../Images/fd24c79b34ab62dc14b37b1831370e63.png" data-original-src="https://miro.medium.com/v2/format:webp/1*utcgX9LN18Y0qG5K11nuAQ.png"/></div></figure><p id="e55e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Matillion负责在BQ上创建目标表，即使它们不存在——这很酷。但是请记住，这个组件总是重新创建目标表，您不应该对增量表这样做。</p><p id="3daf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还有一些行数超过5000万的表，而且它们还在不断增长。在这种情况下，满载需要很多时间。幸运的是，我们有一个<code class="du jr js jt ju b">id</code>列，所有这些表上的主键，允许对<code class="du jr js jt ju b">MAX(ID)</code>执行查找，并且只导入自上次加载以来添加的新行。Matillion的文档中有针对多个表的Amazon RDS实现这一点的<a class="ae jw" href="https://redshiftsupport.matillion.com/customer/en/portal/articles/2506598-incremental-or-high-watermark-data-loading" rel="noopener ugc nofollow" target="_blank">步骤</a>，但与我们的用例不太一样。</p><p id="b125" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，涉及的步骤如下:</p><ol class=""><li id="c331" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">首先执行目标表的完全装载。您可以使用<code class="du jr js jt ju b">Database Query</code>组件来完成这项工作。假设mysql上的源表名是<code class="du jr js jt ju b">orders</code>，在这一步中，您将在BigQuery中对<code class="du jr js jt ju b">stg_orders </code>执行完全加载。这是一次性的，您可以在加载后删除组件。</li><li id="35d6" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">使用Python脚本组件在BigQuery上从<code class="du jr js jt ju b">stg_orders</code>表中查找MAX(ID ),将其存储在一个变量中。Python组件中需要以下代码片段。这将当前maxid值存储在<code class="du jr js jt ju b">maxid</code>变量中，可用于下一步。</li></ol><pre class="jx jy jz ka fd kf ju kg kh aw ki bi"><span id="a76c" class="kj kk hi ju b fi kl km l kn ko">cursor = context.cursor()<br/>cursor.execute(‘select max(id) from stg_orders’)<br/>result = cursor.fetchone()<br/>context.updateVariable(“maxid”, str(result[0]))</span></pre><p id="8962" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.在BQ上创建一个临时表，在每次装载时存放新行。您可以再次使用<code class="du jr js jt ju b">Database Query</code>组件。让我们称我们的临时表为<code class="du jr js jt ju b">stg_orders_tmp</code>。在组件配置中，只需编辑SQL查询以返回大于maxid的行。</p><figure class="jx jy jz ka fd kb er es paragraph-image"><div class="ab fe cl kc"><img src="../Images/c628838ba474d08c6488210c070473fc.png" data-original-src="https://miro.medium.com/v2/format:webp/1*HJoF0_N7QQd1m3s6ZrLplA.png"/></div></figure><p id="df9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.接下来，创建一个转换作业，从上面创建的临时表中读取数据并进行更新。我们将使用的组件是，<code class="du jr js jt ju b">Table Input</code>和<code class="du jr js jt ju b">Table Update</code>。表输入从上一步读取数据，并用组件的<code class="du jr js jt ju b">Update/Insert </code>更新策略更新BQ上的目标表。</p><figure class="jx jy jz ka fd kb er es paragraph-image"><div class="ab fe cl kc"><img src="../Images/995983926d05aa5ab30facee5771a41f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*VpNHug35Lo_F4FuSRk1-tQ.png"/></div></figure><p id="ec5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.现在，回到编排作业，并在下一步添加转换作业。所以这个工作看起来像这样。流量的右侧是满负荷，而左侧是增量负荷。</p><figure class="jx jy jz ka fd kb er es paragraph-image"><div class="ab fe cl kc"><img src="../Images/4ccc6e33ae8afd238bf30999c90f2e4a.png" data-original-src="https://miro.medium.com/v2/format:webp/1*lMcEJyycp-rJjSi6Ba4p-g.png"/></div></figure><p id="dc1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这对你有用。快乐装货！:)</p></div><div class="ab cl kp kq gp kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="hb hc hd he hf"><p id="f73b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kw">原载于2018年2月15日</em> <a class="ae jw" rel="noopener" href="/searce/incremental-mysql-loads-to-bigquery-using-matillion-d496b021e903"> <em class="kw"> Searce工程博客</em> </a> <em class="kw">。</em></p></div></div>    
</body>
</html>