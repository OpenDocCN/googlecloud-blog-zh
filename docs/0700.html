<html>
<head>
<title>How to load geographic data like shapefiles into BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将shapefiles等地理数据加载到BigQuery中</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-load-geographic-data-like-zipcode-boundaries-into-bigquery-25e4be4391c8?source=collection_archive---------0-----------------------#2018-07-26">https://medium.com/google-cloud/how-to-load-geographic-data-like-zipcode-boundaries-into-bigquery-25e4be4391c8?source=collection_archive---------0-----------------------#2018-07-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6b07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然BigQuery支持GIS查询，那么让我们看看如何将地理数据加载到BigQuery中。我将使用一个上传对应于美国邮政编码的边界多边形的例子。<em class="jd">注意，这只是一个例子zipcode多边形在BigQuery中已经是一个公共数据集，所以你不用上传数据；你可以简单地使用它。</em></p><p id="e55f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每年，人口普查局都会公布他们用于人口普查的<a class="ae je" href="https://www.census.gov/geo/maps-data/data/cbf/cbf_zcta.html" rel="noopener ugc nofollow" target="_blank">地图边界</a>。有一个适用于制图的概化集(50 MB)和一个适用于GIS分析的详细集(500 MB)。让我们将它们都加载到BigQuery中。</p><p id="d517" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">什么？为什么邮政编码每年都变？为什么有两个边界文件？嗯……美国的邮政编码实际上不是多边形。相反，它们是邮路的集合，因此边界是可以改变的。此外，因为它们是邮政路线的集合，所以可以绘制无限多的多边形来适应这些邮政路线。</p><h2 id="ce98" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">1.设置GCE虚拟机</h2><p id="5908" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">启动Google计算引擎(GCE)实例。更改虚拟机以访问所有云平台API:</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div class="er es kf"><img src="../Images/3a91943947956ab61600f4490ee8f81b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*A7tqywcwSz7Mf7nWcGxvmQ.png"/></div></figure><p id="93f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，接受所有缺省值并启动实例。</p><p id="43c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦实例启动，ssh到GCE实例并安装zip和gdal:</p><pre class="kg kh ki kj fd kn ko kp kq aw kr bi"><span id="b90f" class="jf jg hi ko b fi ks kt l ku kv">sudo apt-get install gdal-bin unzip</span></pre><h2 id="b353" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">2.下载zip文件</h2><p id="3bee" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">然后，从人口普查局下载两个文件:</p><pre class="kg kh ki kj fd kn ko kp kq aw kr bi"><span id="6df4" class="jf jg hi ko b fi ks kt l ku kv">curl -O <!-- -->ftp://ftp2.census.gov/geo/tiger/TIGER2017/ZCTA5/tl_2017_us_zcta510.zip<br/>curl -O <a class="ae je" href="http://www2.census.gov/geo/tiger/GENZ2017/shp/cb_2017_us_zcta510_500k.zip" rel="noopener ugc nofollow" target="_blank">http://www2.census.gov/geo/tiger/GENZ2017/shp/cb_2017_us_zcta510_500k.zip</a></span></pre><p id="d030" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一个压缩文件是综合数据(500 MB)，第二个压缩文件是概化多边形数据(50 MB)。</p><p id="d4be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果第二个Curl命令不起作用(http服务器似乎会周期性地拒绝http请求)，您可能需要使用浏览器下载并上传到VM(可能通过Google云存储)。</p><h2 id="ed08" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">3.展开zip文件</h2><pre class="kg kh ki kj fd kn ko kp kq aw kr bi"><span id="685c" class="jf jg hi ko b fi ks kt l ku kv">unzip <!-- -->tl_2017_us_zcta510.zip<br/>unzip <a class="ae je" href="http://www2.census.gov/geo/tiger/GENZ2017/shp/cb_2017_us_zcta510_500k.zip" rel="noopener ugc nofollow" target="_blank">cb_2017_us_zcta510_500k.zip</a></span></pre><h2 id="7837" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">4.转换为GeoJSON</h2><p id="f893" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">这些数据以shapefiles的形式发布，这是一种用于GIS软件的<a class="ae je" href="https://en.wikipedia.org/wiki/Shapefile" rel="noopener ugc nofollow" target="_blank">“基本上”开放的</a>数据格式。BigQuery理解GeoJSON，一个开放的标准。所以，我们需要把人口普查局提供的形状文件转换成GeoJSON。这就是我让您安装gdal的原因——它附带了一个名为ogr2ogr的有用工具:</p><pre class="kg kh ki kj fd kn ko kp kq aw kr bi"><span id="ee57" class="jf jg hi ko b fi ks kt l ku kv">ogr2ogr -f csv -dialect sqlite -sql "select AsGeoJSON(geometry) AS geom, * from cb_2017_us_zcta510_500k" zipcode_polygon2017.csv cb_2017_us_zcta510_500k.shp</span><span id="c178" class="jf jg hi ko b fi kw kt l ku kv">ogr2ogr -f csv -dialect sqlite -sql "select AsGeoJSON(geometry) AS geom, * from tl_2017_us_zcta510" zipcode_polygon_detailed2017.csv tl_2017_us_zcta510.shp</span></pre><p id="eefa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的命令将shapefiles转换为CSV文件中GeoJSON编码的地理位置。</p><p id="dcb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>:这篇博文的早期版本推荐创建知名文本(WKT)，但是现在BigQuery支持GeoJSON，最好使用GeoJSON。原因与如何处理平面几何图形的技术细节有关。</p><h2 id="47ab" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">5.将CSV文件上传到GCS</h2><p id="e22c" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">因为CSV文件相当大，所以多线程上传Google云存储并从那里加载到BigQuery会更快/更安全:</p><pre class="kg kh ki kj fd kn ko kp kq aw kr bi"><span id="02dd" class="jf jg hi ko b fi ks kt l ku kv">gsutil -m cp *.csv gs://BUCKET/</span></pre><h2 id="fd30" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">6.将数据加载到BigQuery</h2><p id="6a1a" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">在BigQuery中创建数据集:</p><pre class="kg kh ki kj fd kn ko kp kq aw kr bi"><span id="c309" class="jf jg hi ko b fi ks kt l ku kv">bq mk demos</span></pre><p id="67a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用bq-load将数据加载到BigQuery中，要求BigQuery从CSV文件中自动检测模式:</p><pre class="kg kh ki kj fd kn ko kp kq aw kr bi"><span id="6598" class="jf jg hi ko b fi ks kt l ku kv">bq load --autodetect --replace demos.zipcode_polygon2017 gs://BUCKET/zipcode_polygon2017.csv</span><span id="80b4" class="jf jg hi ko b fi kw kt l ku kv">bq load --autodetect --replace demos.zipcode_polygon_detailed2017 gs://BUCKET/zipcode_polygon_detailed2017.csv</span></pre><h2 id="1ecb" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">7.向表格中添加信息</h2><p id="ae36" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">去控制台添加一些关于列的信息是一个好主意。关键因素包括:</p><pre class="kg kh ki kj fd kn ko kp kq aw kr bi"><span id="dba8" class="jf jg hi ko b fi ks kt l ku kv">geom: Polygon geometry of the zipcode<br/>ZCTA: Zipcode tabulation areas (5-digit zipcode)<br/>GEOID: See https://www.census.gov/geo/reference/geoidentifiers.html<br/>ALAND: Land/Water area in square meters</span></pre><h2 id="fc3e" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">8.尝试查询</h2><p id="a6d9" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">您可以使用ST_GeogFromGeoJson将Json列解析为多边形，然后对其应用ST_Distance和ST_DWithin等方法。这是一个查找特定邮政编码10公里范围内的气象站的查询:</p><pre class="kg kh ki kj fd kn ko kp kq aw kr bi"><span id="53f0" class="jf jg hi ko b fi ks kt l ku kv">#standardsql<br/>WITH params AS (<br/>  SELECT 60626 AS zipcode,<br/>         10    AS maxdist_km<br/>),</span><span id="5f9d" class="jf jg hi ko b fi kw kt l ku kv">zipcode AS (<br/>   <strong class="ko hj">SELECT ST_GeogFromGeoJson(geom) AS polygon </strong><br/>   FROM demos.zipcode_polygon2017, params <br/>   WHERE ZCTA5CE10 = params.zipcode<br/>),</span><span id="eaef" class="jf jg hi ko b fi kw kt l ku kv">stations AS (<br/>  SELECT<br/>    id,<br/>    name,<br/>    ST_GeogPoint(longitude, latitude) AS loc,<br/>    ST_Distance(ST_GeogPoint(longitude, latitude), zipcode.polygon) AS dist_meters<br/>  FROM<br/>    `bigquery-public-data.ghcn_d.ghcnd_stations`,<br/>    params,<br/>    zipcode<br/>  WHERE ST_DWithin(ST_GeogPoint(longitude, latitude), zipcode.polygon, params.maxdist_km*1000)<br/>)</span><span id="70d4" class="jf jg hi ko b fi kw kt l ku kv">SELECT * from stations<br/>ORDER BY dist_meters ASC<br/>LIMIT 100</span></pre><h2 id="42d1" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">9.将GeoJSON字符串转换为地理类型</h2><p id="ff09" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">与将面存储为字符串并每次都执行ST_GeogFromGeoJson不同，首先将数据存储为地理类型会更有效。我们可以使用SQL来做到这一点:</p><pre class="kg kh ki kj fd kn ko kp kq aw kr bi"><span id="1efc" class="jf jg hi ko b fi ks kt l ku kv">CREATE OR REPLACE TABLE demos.us_zipcodes AS</span><span id="cf4f" class="jf jg hi ko b fi kw kt l ku kv">SELECT * EXCEPT(geom), <strong class="ko hj">ST_GeogFromGeoJson(geom) AS polygon</strong><br/>FROM demos.zipcode_polygon2017</span></pre><p id="22a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的查询现在变成了:</p><pre class="kg kh ki kj fd kn ko kp kq aw kr bi"><span id="473c" class="jf jg hi ko b fi ks kt l ku kv">#standardsql<br/>WITH params AS (<br/>  SELECT 60626 AS zipcode,<br/>         10    AS maxdist_km<br/>),</span><span id="e15a" class="jf jg hi ko b fi kw kt l ku kv">zipcode AS (<br/>   <strong class="ko hj">SELECT polygon </strong><br/>   FROM <strong class="ko hj">demos.us_zipcodes</strong>, params <br/>   WHERE ZCTA5CE10 = params.zipcode<br/>),</span><span id="8e00" class="jf jg hi ko b fi kw kt l ku kv">stations AS (<br/>  SELECT<br/>    id,<br/>    name,<br/>    ST_GeogPoint(longitude, latitude) AS loc,<br/>    ST_Distance(ST_GeogPoint(longitude, latitude), zipcode.polygon) AS dist_meters<br/>  FROM<br/>    `bigquery-public-data.ghcn_d.ghcnd_stations`,<br/>    params,<br/>    zipcode<br/>  WHERE ST_DWithin(ST_GeogPoint(longitude, latitude), zipcode.polygon, params.maxdist_km*1000)<br/>)</span><span id="2582" class="jf jg hi ko b fi kw kt l ku kv">SELECT * from stations<br/>ORDER BY dist_meters ASC<br/>LIMIT 100</span></pre><p id="1e3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我这样做时，这个查询在6.3秒内完成(相比之下，在查询本身中执行ST_GeogFromGeoJson的查询需要16.8秒)。这是近3倍的加速！</p><h2 id="b8e3" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">10.可视化地理数据</h2><p id="8e4d" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">您可以使用BigQuery Geo Viz可视化上述数据。只需运行上面的查询，选择“loc”作为几何列，并根据需要指定基于其他列的样式。这是一个看起来像什么的例子:</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kx"><img src="../Images/5f44e4f8ec9aa891569aacb7b8ce3ce9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XPoDIhHvhuhNK5_hrVru2g.png"/></div></div><figcaption class="lc ld et er es le lf bd b be z dx translated">芝加哥邮政编码10公里范围内的气象站</figcaption></figure><h2 id="4645" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">10.使用邮政编码的公共数据集</h2><p id="155a" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">可视化工具相当酷。这是另一个视觉效果，这次用邮政编码边界加入了公共人口普查数据。该查询是:</p><pre class="kg kh ki kj fd kn ko kp kq aw kr bi"><span id="af53" class="jf jg hi ko b fi ks kt l ku kv">#standardsql<br/>with zipcodes as (<br/>SELECT<br/>  zip_census.zipcode as zipcode,<br/>  population,<br/>  zcta_geom as geometry<br/>FROM<br/>  `bigquery-public-data.census_bureau_usa.population_by_zip_2010` AS zip_census<br/>  join `bigquery-public-data.geo_us_boundaries.us_zip_codes` as zip_geom<br/>  on zip_census.zipcode = zip_geom.zip_code<br/>WHERE<br/>   gender IS NULL and<br/>   minimum_age is NULL and<br/>   maximum_age is NULL<br/>)<br/>SELECT<br/>  zipcodes.*,<br/>  state_code,<br/>  city,<br/>  county<br/>FROM<br/>  `bigquery-public-data.utility_us.zipcode_area` as zip_area<br/>  join zipcodes on zip_area.zipcode = zipcodes.zipcode<br/>where <br/>  ST_DWITHIN(geometry, ST_GeogPoint(-122.3321,47.6062), 10000)</span></pre><p id="0fc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个图像:</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lg"><img src="../Images/e77dc73ba9baf1d9e676adf1b397b3df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H1krO9gchFTnmeDRHSprBw.png"/></div></div></figure><p id="45e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您仔细查看表名，您会注意到该表实际上是一个公共数据集，而不是我们刚刚上传的那个。此外，公共数据集将面存储为地理类型，以提供3倍的加速。是的，邮政编码多边形信息已经是一个BigQuery公共数据集(但本文解释了如何将自己的地理数据上传到BigQuery)。</p><p id="5685" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽情享受吧！</p></div></div>    
</body>
</html>