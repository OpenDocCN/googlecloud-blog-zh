<html>
<head>
<title>Learning from Log4j 2 Vulnerability — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Log4j 2漏洞中吸取教训—第2部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/learning-from-log4j-2-vulnerability-eba946d31980?source=collection_archive---------4-----------------------#2022-02-09">https://medium.com/google-cloud/learning-from-log4j-2-vulnerability-eba946d31980?source=collection_archive---------4-----------------------#2022-02-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="4c65" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">如何使用BigQuery检测和调查威胁</h2></div><p id="5758" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本博客系列的第二部分。参见第一部分 <a class="ae ju" rel="noopener" href="/google-cloud/learning-from-log4j-2-vulnerability-f1eabd06329e"> <em class="jt">此处</em> </a> <em class="jt">。</em></p><p id="d95f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">好吧…我们需要谈谈从Log4j 2漏洞和您的云原生威胁防御中学到的东西。</p><p id="2c29" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在<a class="ae ju" rel="noopener" href="/google-cloud/learning-from-log4j-2-vulnerability-f1eabd06329e">之前的一篇文章</a>中，我讨论了如何在Google Cloud中使用负载平衡器功能保护您的应用程序(在下面的黄色复选标记中)，以及如何使用云日志检测未来Log4j漏洞利用尝试的&amp;警报(在下面的绿色复选标记中)。在本文中，我们将把日志导出并分析到BigQuery，以获得高级分析、更长的保留期和更便宜的存储。</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es jv"><img src="../Images/4512379ce208cf104f60d1bae3d1b30a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZGyeMcPHuQh3e2QgmvPZpg.png"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx translated"><em class="kl"> GCP深度防御类似Log4j: Prevent，Protect &amp; Detect </em></figcaption></figure><p id="f666" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">确保您在所有面向互联网的HTTP(S)负载平衡器上启用了100%采样的日志记录<a class="ae ju" href="https://cloud.google.com/load-balancing/docs/https/https-logging-monitoring" rel="noopener ugc nofollow" target="_blank">。到目前为止，您大概已经修补了您的应用程序，并启用了上图中突出显示的云防护和身份感知代理(如果适用)等关键保护。</a></p><p id="fdbe" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用云日志记录和云监控，我们能够快速检测威胁，并为未来的尝试设置连续警报。但是更高级的用例呢:</p><ul class=""><li id="ff20" class="km kn hi iz b ja jb jd je jg ko jk kp jo kq js kr ks kt ku bi translated">如果您需要进行更多<strong class="iz hj">深度分析</strong>如过滤或关联，该怎么办？例如，您可能希望过滤掉Log4j扫描，这些扫描可能来自良好的参与者，如Google Cloud自己的Web安全扫描器(上图中突出显示的安全命令中心的一部分)，它可以标记易受攻击的资源和应用程序。您可能还想对剩余的被过滤的攻击进行地理定位，以找出攻击实际上来自哪里，等等。</li><li id="17b1" class="km kn hi iz b ja kv jd kw jg kx jk ky jo kz js kr ks kt ku bi translated">如果您需要进行超过过去30天的<strong class="iz hj">历史分析</strong>，这是默认的日志存储桶保留时间，该怎么办？分析较长时间内的日志可能会发现不久前开始的攻击链。出于合规性目的，也可能需要它。</li></ul><p id="1e1a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就是为什么在本文中，我们将使用BigQuery来补充我们在Logs Explorer 中进行的<a class="ae ju" rel="noopener" href="/google-cloud/learning-from-log4j-2-vulnerability-f1eabd06329e">特别分析，以便进行更深入的分析。</a></p><p id="e264" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，<a class="ae ju" href="https://cloud.google.com/architecture/exporting-stackdriver-logging-for-security-and-access-analytics#configure_the_logging_export" rel="noopener ugc nofollow" target="_blank">按照这些说明</a>来设置一个从云日志到BigQuery的本地日志接收器。确保您的日志过滤器没有排除位于<code class="du la lb lc ld b">requests</code>日志，即<code class="du la lb lc ld b">logName="/projects/[PROJECT_ID]/logs/requests"</code>中的HTTPS负载平衡器日志</p><p id="ceb8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">注</strong>:参见<a class="ae ju" href="https://cloud.google.com/architecture/exporting-stackdriver-logging-for-security-and-access-analytics#log_scoping_tool" rel="noopener ugc nofollow" target="_blank">日志范围界定工具</a>帮助生成全面的日志过滤器，不仅包括HTTPS LB日志，还包括您可能需要的其他安全相关日志，如DNS查询、VPC流日志和防火墙规则日志。在本文中，我们将只分析HTTPS LB日志。</p><h1 id="85e5" class="le lf hi bd lg lh li lj lk ll lm ln lo io lp ip lq ir lr is ls iu lt iv lu lv bi translated">搜索所有Log4j漏洞利用尝试</h1><p id="7197" class="pw-post-body-paragraph ix iy hi iz b ja lw ij jc jd lx im jf jg ly ji jj jk lz jm jn jo ma jq jr js hb bi translated">BigQuery日志接收器自动将日志(包括HTTP(S) LB请求日志)从云日志路由到BigQuery表，遵循此<a class="ae ju" href="https://cloud.google.com/logging/docs/export/bigquery#partition-table-organization" rel="noopener ugc nofollow" target="_blank">日志到表名映射</a>约定。因为我们将日志接收器配置为使用分区表，所以HTTP(S) LB日志位于一个统一的<strong class="iz hj">请求</strong>表中。换句话说，所有HTTP(S) LB日志的目的表是<code class="du la lb lc ld b">[LOG_SINK_BQ_PROJECT].[LOG_SINK_BQ_DATASET].requests</code>，其中<code class="du la lb lc ld b">LOG_SINK_BQ_PROJECT</code>和<code class="du la lb lc ld b">LOG_SINK_BQ_DATASET</code>是您在创建日志接收器时指定的Google Cloud项目和BigQuery数据集。</p><p id="7186" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们转到BigQuery控制台中的SQL工作区，在用各自的值替换了<code class="du la lb lc ld b">LOG_SINK_BQ_PROJECT</code>和<code class="du la lb lc ld b">LOG_SINK_BQ_DATASET</code>之后，运行下面的查询:</p><figure class="jw jx jy jz fd ka"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="867e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将返回过去30天内所有Log4j漏洞利用尝试。假设您在相同的时间窗口内运行，您应该获得与您在Logs Explorer中查询相同的日志条目(在<a class="ae ju" rel="noopener" href="/@arsan/learning-from-log4j-2-vulnerability-f1eabd06329e">第1部分</a>)。在我们的例子中，我们在大约0.5秒内从大约61.8k的请求中检索出同样的33个日志条目:</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es md"><img src="../Images/98e152f75dabf3d3ae7f6c30b15b00db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AaowJRF0sNBQQstYev3F_g.png"/></div></div></figure><h1 id="bff4" class="le lf hi bd lg lh li lj lk ll lm ln lo io lp ip lq ir lr is ls iu lt iv lu lv bi translated">筛选出好演员</h1><p id="2095" class="pw-post-body-paragraph ix iy hi iz b ja lw ij jc jd lx im jf jg ly ji jj jk lz jm jn jo ma jq jr js hb bi translated">如前所述，这些Log4j扫描可能来自恶意或善良的参与者。例如，你可能已经在使用谷歌云的<a class="ae ju" href="https://cloud.google.com/security-command-center/docs/concepts-web-security-scanner-overview" rel="noopener ugc nofollow" target="_blank">网络安全扫描仪</a>。在这种情况下，您希望过滤出相应的记录的<a class="ae ju" href="https://cloud.google.com/security-command-center/docs/how-to-use-web-security-scanner#static_ip_address_ranges_for_managed_scans" rel="noopener ugc nofollow" target="_blank">静态IP地址范围</a>。为此，我们可以用JavaScript创建一个BigQuery用户定义函数(UDF ),进行一些逐位数学运算，确定给定的IPv4地址是否在给定的CIDR范围内。</p><p id="e77e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行下面的查询来创建一个名为<code class="du la lb lc ld b">Ip4AddressInRanges()</code>的新函数。它遍历每个CIDR范围，如果IPv4输入字符串属于任何传递的CIDR范围，则返回TRUE:</p><figure class="jw jx jy jz fd ka"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="d27f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您的项目中有了一个可用的BigQuery函数。它接受一个输入IPv4字符串，即一个或多个CDIR范围字符串的数组，并根据该IPv4地址是否在任何范围内返回TRUE或FALSE。</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div class="er es me"><img src="../Images/f2f1ee979e04ab79d97040f453a6667a.png" data-original-src="https://miro.medium.com/v2/resize:fit:520/format:webp/1*wakAketCXrBVyTpbEz5mYQ.png"/></div><figcaption class="kh ki et er es kj kk bd b be z dx translated">正在创建名为Ip4AddressInRanges()的新BigQuery用户定义函数(UDF)</figcaption></figure><p id="e15c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，让我们回到原始查询，在WHERE子句中添加以下语句，以过滤出Web Security Scanner IP范围和/或您可能拥有的任何其他合法IP范围:</p><figure class="jw jx jy jz fd ka"><div class="bz dy l di"><div class="mb mc l"/></div></figure><h1 id="087b" class="le lf hi bd lg lh li lj lk ll lm ln lo io lp ip lq ir lr is ls iu lt iv lu lv bi translated">按违规IP分组</h1><p id="bcfb" class="pw-post-body-paragraph ix iy hi iz b ja lw ij jc jd lx im jf jg ly ji jj jk lz jm jn jo ma jq jr js hb bi translated">为了识别潜在的攻击者，让我们首先按照远程IP地址对这些请求进行分组，并按照最活跃的请求进行排序:</p><figure class="jw jx jy jz fd ka"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="a915" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">查询结果应该类似于(部分编辑的IP地址):</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div class="er es mf"><img src="../Images/6d9e03e5e4d365062433ddba690514dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*lwRZSkbA9CbHD0w6r-HccA.png"/></div><figcaption class="kh ki et er es kj kk bd b be z dx translated">试图利用Log4j漏洞的顶级违规IP</figcaption></figure><h1 id="2d84" class="le lf hi bd lg lh li lj lk ll lm ln lo io lp ip lq ir lr is ls iu lt iv lu lv bi translated">地理定位攻击</h1><p id="c42e" class="pw-post-body-paragraph ix iy hi iz b ja lw ij jc jd lx im jf jg ly ji jj jk lz jm jn jo ma jq jr js hb bi translated">现在，让我们从地理上确定这些攻击实际上来自哪里。键入以下查询，将违规IP的结果列表与在<a class="ae ju" href="https://dev.maxmind.com/geoip/geoip2/geolite2/" rel="noopener ugc nofollow" target="_blank"> GeoLite2 </a>地理位置表中找到的位置数据相关联(详细信息将在此Google <a class="ae ju" href="https://cloud.google.com/blog/products/data-analytics/geolocation-with-bigquery-de-identify-76-million-ip-addresses-in-20-seconds" rel="noopener ugc nofollow" target="_blank">博客</a>中进一步描述)。确保将前一部分中的查询作为子查询进行粘贴，以使用排名靠前的违规IP结果填充下面的<code class="du la lb lc ld b">log4j_exploit_attempts</code>临时表。</p><figure class="jw jx jy jz fd ka"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="919f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">查询结果应如下所示，其中国家/地区和城市名称附加到每一行的地理定位IP地址中:</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div class="er es mg"><img src="../Images/5212d6b33fa32ca7ebc972845124c7af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*0QYkyrPU-gtucoNiOg3GzA.png"/></div><figcaption class="kh ki et er es kj kk bd b be z dx translated">尝试利用富含地理位置数据的Log4j漏洞的顶级违规IP</figcaption></figure><p id="54bb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如您所见，除了第一个IP地址之外，所有IP地址的地理位置信息都找到了。GeoLite2数据库<a class="ae ju" href="https://dev.maxmind.com/geoip/geolite2-free-geolocation-data" rel="noopener ugc nofollow" target="_blank">是免费的，但不如MaxMind的GeoIp2数据库</a>精确，这里使用的后处理GeoLite2 BigQuery表是历史快照。</p><p id="0e90" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">也就是说，事实证明，第一个IP地址“[redacted].149”位于俄罗斯。因此，这些利用漏洞的尝试大多来自俄罗斯或中国，也有一些来自美国和瑞典。幸运的是，正如您可以从响应状态详细信息中看到的，绝大多数都被我们的云防御成功阻止了。由于我们已经配置了我们的云装甲安全策略和我们的身份感知代理访问控制，这些尝试都没有到达我们的后端应用程序。</p><p id="41d2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">注意</strong>:这个BigQuery地理编码示例是为了说明的目的而展示的。您可能希望使用更新的GeoLite2或GeoIP2后处理BigQuery表，或者您自己的下游可视化或BI工具(如Looker或Tableau)中可用的其他地理编码方法。</p><h1 id="9fe6" class="le lf hi bd lg lh li lj lk ll lm ln lo io lp ip lq ir lr is ls iu lt iv lu lv bi translated">下一步是什么？</h1><p id="bc3f" class="pw-post-body-paragraph ix iy hi iz b ja lw ij jc jd lx im jf jg ly ji jj jk lz jm jn jo ma jq jr js hb bi translated">现在，您应该更熟悉使用Google Cloud的HTTPS负载平衡器日志来预防、检测和警告潜在的Log4j和其他web漏洞利用。借助BigQuery的强大功能，您可以快速分析和调查这些威胁。</p><p id="4afe" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你对这个和其他安全或合规性问题感兴趣，请查看社区支持的代码为 repo for Google Cloud的<a class="ae ju" href="https://github.com/GoogleCloudPlatform/threat-detection-as-code" rel="noopener ugc nofollow" target="_blank">威胁检测，您可以使用和扩展更多开箱即用的威胁检测查询。这些基本的示例查询不仅涵盖网络活动(如本博客所示)，还涵盖其他类别，如登录模式、密钥管理、配置活动以及数据或工作负载使用情况。</a></p><p id="13e0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">狩猎愉快！</p></div></div>    
</body>
</html>