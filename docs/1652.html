<html>
<head>
<title>Connecting Securely to Google Compute Engine VMs without a Public IP or VPN</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无需公共IP或VPN即可安全连接到Google计算引擎虚拟机</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/connecting-securely-to-google-compute-engine-vms-without-a-public-ip-or-vpn-720e53d1978e?source=collection_archive---------0-----------------------#2020-11-10">https://medium.com/google-cloud/connecting-securely-to-google-compute-engine-vms-without-a-public-ip-or-vpn-720e53d1978e?source=collection_archive---------0-----------------------#2020-11-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c962" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我将向您展示如何在没有公共IP或VPN连接的GCE上建立到虚拟机的安全RDP、ssh和VNC连接。</p><p id="692d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提议的基于代理的配置减少了GCE虚拟机的攻击面，因为它们不必暴露给外界。对于Windows节点，远程桌面协议(RDP)是恶意行为者最常用的攻击媒介之一。对于Linux节点，强力ssh攻击是获得未授权访问的常见方法。该配置还允许在单个虚拟机的粒度上控制远程访问。这解决了VPN的一个缺点，即在假设网络是有效的安全边界的情况下，允许访问VPN后面的所有系统。</p><p id="9293" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然重点是RDP和ssh协议，但所描述的隧道方法适用于所有TCP端口。</p><p id="851d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">谷歌云平台(GCP)的身份感知代理(IAP) </strong></p><p id="b713" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于TCP连接，GCP的<a class="ae jd" href="https://cloud.google.com/iap" rel="noopener ugc nofollow" target="_blank">身份识别代理(IAP) </a>支持通过其私有IP从互联网访问GCE虚拟机。当试图建立到代理的HTTPS加密隧道时，代理执行认证和授权检查。在成功的认证和授权之后，来自客户端的流量通过代理在Google的内部网络上被转发到VM实例。换句话说，代理充当对外界开放的传入流量的看门人，而VM只需要允许来自Google内部网络上的代理的连接。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/fcf822223d8944911e8e29d50f108317.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C9NOdbvhH5wZRH3vcXKQwQ.png"/></div></div></figure><p id="c96d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将首先描述基本的IAP配置。然后我们会覆盖</p><ul class=""><li id="502b" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc jv jw jx jy bi translated">使用ssh的Linux到Linux连接</li><li id="f6ed" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc jv jw jx jy bi translated">与VNC的Linux到Linux连接</li><li id="6367" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc jv jw jx jy bi translated">与RDP的Windows到Windows连接</li><li id="ec5c" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc jv jw jx jy bi translated">从Linux到Windows的RDP连接</li></ul><p id="9d4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在讨论了基本配置和设置之后，我们将讨论如何结合IAM条件使用GCP的<a class="ae jd" href="https://cloud.google.com/access-context-manager/docs/overview" rel="noopener ugc nofollow" target="_blank">访问上下文管理器</a>进行访问控制。访问上下文管理器根据请求属性授予访问级别，例如尝试建立连接的客户端的IP。最后，我们将介绍一个基本的云NAT配置，它可以为您的虚拟机实现出站连接。</p><p id="bc7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">隧道配置</strong></p><p id="5ea1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了配置IAP通道，我假设您有以下条件</p><ul class=""><li id="cebd" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc jv jw jx jy bi translated">您拥有的GCP项目，带有正在运行的GCE虚拟机，对于Windows虚拟机，登录和密码—确保在创建虚拟机时禁用公共ip的分配—对于Windows节点，确保在创建虚拟机后不要忘记指定用户名和密码</li><li id="60e6" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc jv jw jx jy bi translated">安装在您想要连接的系统上的<a class="ae jd" href="https://cloud.google.com/sdk" rel="noopener ugc nofollow" target="_blank"> Google Cloud SDK </a></li></ul><p id="f711" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们开始之前，请确保您的项目和用户帐户设置正确。您可以使用“<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/config/list" rel="noopener ugc nofollow" target="_blank"> gcloud配置列表</a>验证您的设置是否正确，如有必要，更改您使用“<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/auth/login" rel="noopener ugc nofollow" target="_blank"> gcloud auth login </a>登录的帐户。项目可以用'<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/config/set" rel="noopener ugc nofollow" target="_blank">g cloud config set core/project</a>来设置。如果你在公司代理的后面，你可能必须<a class="ae jd" href="https://cloud.google.com/iap/docs/faq#what_domain_does_for_tcp_use" rel="noopener ugc nofollow" target="_blank">将IAP用于TCP的域‘tunnel . cloud proxy . app’列入白名单</a>。在大多数情况下，我将通过CLI描述配置，但是大多数任务也可以通过GCP控制台UI来完成。</p><p id="aa5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要创建一个防火墙规则，以支持从IAP到VM的流量。IAP使用范围35.235.240.0/20作为转发流量的源地址。我们允许端口22 (ssh)、3389 (rdp)和5900 (vnc)。您可以根据您需要的协议挑选端口号。</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="e0e2" class="kj kk hi kf b fi kl km l kn ko">gcloud compute firewall-rules create allow-ingress-from-iap \<br/>--direction=INGRESS \<br/>--action=allow \<br/>--rules=tcp:3389,tcp:22,tcp:5901 \<br/>--source-ranges=35.235.240.0/20</span></pre><p id="a7e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该命令允许从代理连接到项目中的所有节点。如果您不想为项目中的所有虚拟机打开防火墙，您可以<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/compute/instances/add-tags" rel="noopener ugc nofollow" target="_blank">将标签</a>附加到您希望应用规则的虚拟机，并使用'— target-tags=TAG '作为附加选项指定该标签。</p><p id="4362" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们需要添加一个IAM策略，允许用户建立隧道连接。我们将IAM角色iap.tunnelResourceAccessor授予所有被授权使用隧道的用户和/或用户组。在这个例子中，这个角色是在项目级别设置的。这允许用户建立到项目中应用上述防火墙规则的所有虚拟机的连接。我们将在后面看到如何更有选择性地只启用到特定实例的隧道，而不改变防火墙配置。</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="56a4" class="kj kk hi kf b fi kl km l kn ko">gcloud projects add-iam-policy-binding iap-access-test \<br/>--member=user:<a class="ae jd" href="mailto:testuser@example.com" rel="noopener ugc nofollow" target="_blank">testuser@example.com</a> \<br/>--role=roles/iap.tunnelResourceAccessor</span></pre><p id="eefd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用户还需要拥有compute.viewer角色</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="95c5" class="kj kk hi kf b fi kl km l kn ko">gcloud projects add-iam-policy-binding iap-access-test \<br/>--member=user:<a class="ae jd" href="mailto:testuser@example.com" rel="noopener ugc nofollow" target="_blank">testuser@example.com</a> \<br/>--role=roles/compute.viewer</span></pre><p id="8f6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">连接SSH:Linux-GCE上的Linux</strong></p><p id="8349" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想通过VNC协议连接到一个Linux节点，您需要为端口5901建立隧道，这是iap-test-ubuntu托管的第一个VNC会话的端口号</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="6e32" class="kj kk hi kf b fi kl km l kn ko">gcloud compute start-iap-tunnel iap-test-ubuntu 5901 \<br/>--local-host-port=localhost:5901</span></pre><p id="ae7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，您也可以通过ssh使用端口转发</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="052a" class="kj kk hi kf b fi kl km l kn ko">gcloud compute ssh iap-test-ubuntu --project iap-access-test \<br/>--zone us-central1-a --ssh-flag "-L 5901:localhost:5901"</span></pre><p id="59e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">建立隧道后，您可以将VNC客户端，例如<a class="ae jd" href="https://remmina.org/" rel="noopener ugc nofollow" target="_blank"> Remmina </a>或<a class="ae jd" href="https://www.realvnc.com/en/connect/download/viewer/" rel="noopener ugc nofollow" target="_blank"> VNC查看器</a>指向本地主机上的端口5901，通过您的隧道连接到您的虚拟机实例。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es kp"><img src="../Images/5173ebdcc1e1a5d5f863c1e5bdb6b163.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/0*2gD_gnC7Oe08hktl"/></div></figure><p id="7302" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想通过Remmina实现“点击式”连接，你可以创建一个简短的启动脚本。在编写脚本之前，您需要为连接创建一个配置文件。打开Remmina桌面客户端，点击左上角的“+”添加新的连接配置文件。我们需要指定的只是连接的类型(Remmina VNC插件)，配置文件名和localhost:5901作为服务器端口。本地主机是通过IAP到Windows虚拟机的隧道的起点。“保存”以确保保存连接设置。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kq"><img src="../Images/6ef9257820a5fae2a83c24dea455b945.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aFPtZtaeacAjdqdb"/></div></div></figure><p id="bc5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">新描述文件存储在~/中。本地/共享/remmina。现在，您可以创建一个小的启动脚本，并将其放在桌面上进行即时访问。</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="c006" class="kj kk hi kf b fi kl km l kn ko">#!/bin/bash<br/>gcloud config set core/project iap-access-test<br/>gcloud compute start-iap-tunnel iap-test-ubuntu 5901 \<br/>--local-host-port=localhost:5901 --zone=us-central1-a &amp;<br/>sleep 2<br/>remmina -c /home/adittmer/.local/share/remmina/1604188073948.remmina</span></pre><p id="af4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们不会在这里描述如何在GCE实例上安装像Gnome这样的桌面。我们也不包括服务器端VNC配置。<a class="ae jd" href="https://subscription.packtpub.com/book/big_data_and_business_intelligence/9781788474221/1/ch01lvl1sec15/installing-and-configuring-ubuntu-desktop-for-google-cloud-platform" rel="noopener ugc nofollow" target="_blank">这篇文章</a>是一个很好的起点，如果你在~/中添加以下内容的话。文中建议的vnc/xstartup文件。</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="5be8" class="kj kk hi kf b fi kl km l kn ko">gnome-panel &amp;<br/>gnome-settings-daemon &amp;<br/>metacity &amp;<br/>nautilus &amp;</span></pre><p id="bb3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">连接RDP:GCE上的Linux-Windows</strong></p><p id="4fb1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了连接到Windows VM实例，我还使用了<a class="ae jd" href="https://remmina.org/" rel="noopener ugc nofollow" target="_blank"> Remmina </a>客户端。与VNC客户端示例的唯一区别显然是端口号以及Remmina UI中的一些小差异。对于我们运行的隧道设置</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="5065" class="kj kk hi kf b fi kl km l kn ko">gcloud compute start-iap-tunnel iap-test-windows 3389 \<br/>--local-host-port=localhost:3389</span></pre><p id="bfa1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按照上述说明创建Remmina配置文件时，您需要将RDP指定为协议。对于“服务器”,您只需输入“本地主机”,无需端口号。您可以使用上面的脚本，但是需要将端口号5901更改为3389，修改虚拟机的主机名，并为RDP连接引用正确的配置文件。</p><p id="a0ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">与RDP连接:GCE上的Windows-Windows</strong></p><p id="13ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于来自Windows客户端的RDP连接来说,<a class="ae jd" href="https://github.com/GoogleCloudPlatform/iap-desktop/releases/tag/2.7.315" rel="noopener ugc nofollow" target="_blank"> IAP Desktop </a>是一个很棒很简单的解决方案。安装向导会启动一个Oauth流程来验证您的Google用户帐户。初始化后，它会显示可用的虚拟机。双击虚拟机实例会创建一个隧道和一个RDP连接。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kr"><img src="../Images/07fec1e49c72e1254fe7dd41e7f56435.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*l1iNm2oGr9z40Nv7"/></div></div></figure><p id="81b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">终止IAP隧道连接</strong></p><p id="124d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用gcloud从shell启动的连接可以通过CTRL-C终止</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="450d" class="kj kk hi kf b fi kl km l kn ko">kill $(lsof -ti tcp:&lt;port number&gt;)</span></pre></div><div class="ab cl ks kt gp ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="hb hc hd he hf"><p id="6647" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">访问级别</strong></p><p id="18f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想对可以建立IAP隧道的设备有更多的限制，你可以结合使用<a class="ae jd" href="https://cloud.google.com/access-context-manager/docs/overview" rel="noopener ugc nofollow" target="_blank">访问级别</a>和<a class="ae jd" href="https://cloud.google.com/iam/docs/conditions-overview" rel="noopener ugc nofollow" target="_blank"> IAM条件</a>。IAP根据请求的属性授予访问级别。例如，IAP可以根据请求的源IP，为发起隧道连接的请求分配访问级别。如果为请求用户分配了访问级别，并且该访问级别与IAM条件中为“iap.tunnelResourceAccessor”角色指定的级别相匹配，则建立隧道。</p><p id="2fac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">访问级别是通过<a class="ae jd" href="https://cloud.google.com/access-context-manager/docs" rel="noopener ugc nofollow" target="_blank">访问上下文管理器</a>定义的，是组织级别的构造。这意味着所有访问级别在所有项目中都是可见的。访问上下文管理器支持基本和自定义访问级别。基本访问级别只允许“与”或“或”组合的条件。自定义级别允许更复杂的表达式，并支持基于请求类型和属性进行过滤的通用表达式语言(CEL)。自定义访问级别仅作为付费企业安全订阅的一部分提供。对于本例，我们将定义一个基本访问级别。</p><p id="6e8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">被授权创建访问级别的用户需要具有资源管理器组织编辑者角色以及访问上下文管理器策略管理员角色。这些角色可以由组织管理员(角色为roles/resource manager . organization admin的个人)分配。可通过'<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/organizations/list" rel="noopener ugc nofollow" target="_blank"> gcloud organizations list </a>'获取组织ID。</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="5888" class="kj kk hi kf b fi kl km l kn ko">gcloud organizations add-iam-policy-binding 505850696945 \<br/>--member="user:<a class="ae jd" href="mailto:newuser@example.com" rel="noopener ugc nofollow" target="_blank">newuser@example.com</a>" \<br/>--role roles/editor</span><span id="422a" class="kj kk hi kf b fi kz km l kn ko">gcloud organizations add-iam-policy-binding 505850696945 \<br/>--member="user:<a class="ae jd" href="mailto:newuser@example.com" rel="noopener ugc nofollow" target="_blank">newuser@example.com</a>" \<br/>--role roles/accesscontextmanager.policyAdmin</span></pre><p id="a5e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们继续并探索如何为创建隧道设置限制之前，我们需要撤销我们之前通过“g cloud projects add-iam-policy-binding”授予的广泛访问权限，该权限授予所有虚拟机iap.tunnelResourceAccessor角色，除了用户已通过身份验证之外，没有任何其他条件。</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="ae86" class="kj kk hi kf b fi kl km l kn ko">gcloud projects remove-iam-policy-binding iap-access-test \<br/>--member testuser@example.com \<br/>--role "roles/iap.tunnelResourceAccessor”</span></pre><p id="c800" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，项目所有者将始终可以不受限制地使用隧道。</p><p id="afde" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">通过源IP和地理位置限制访问</strong></p><p id="0b2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的使用案例是，我经常去加拿大旅行，希望创建一个策略，只允许来自加拿大或美国的特定IP的隧道创建。我创建了下面的YAML文件，该文件将访问级别“secureaccess”分配给来自各个地区的指定(修订)IP地址的请求。默认情况下，两个IP地址和地理位置是“或”组合，IP范围和区域是“和”组合。这可以通过'<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/access-context-manager/levels/create" rel="noopener ugc nofollow" target="_blank">g cloud access-context-manager levels create</a>'命令的-combine-function参数进行更改。</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="4baa" class="kj kk hi kf b fi kl km l kn ko">- ipSubnetworks:<br/>     - 73.21.45.151/32<br/>     - 201.23.121.234/32<br/>- regions:<br/>     - US<br/>     - CA</span></pre><p id="c766" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们创建访问级别</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="59f1" class="kj kk hi kf b fi kl km l kn ko">gcloud access-context-manager levels create secureaccess \<br/>--title myaccesspolicy \<br/>--basic-level-spec access-canada-us.yaml</span></pre><p id="8c2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在GCP控制台中，如果转到“安全性|访问上下文管理器”，您可以创建和编辑访问级别</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es la"><img src="../Images/869b7d90026595139afc348ba1b5c5e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*v1iwfzuROzErzdAl"/></div></div></figure><p id="5860" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们创建一个IAM条件，如果请求的访问级别为“secureaccess”，则向用户授予“隧道用户”(iap.tunnelResourceAccessor)角色。必须为其应用的资源设置具有IAM条件的“隧道用户”角色。不幸的是，目前还没有办法通过gcloud CLI来实现这一点，所以我们使用控制台。</p><ol class=""><li id="faa9" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc lb jw jx jy bi translated">转到“安全|身份识别代理”并选择您的项目。</li><li id="819e" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc lb jw jx jy bi translated">选择“SSH和TCP RESOURCES ”,您将看到隧道资源的资源层次结构——通过复选框，您可以指定即将创建的IAM条件的范围——您可以将IAM条件应用于项目或区域中的所有隧道或特定的虚拟机实例。</li><li id="e884" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc lb jw jx jy bi translated">点击“添加会员”并输入用户的身份(【testuser@example.com】T2)，</li><li id="944e" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc lb jw jx jy bi translated">选择角色IAP安全隧道，并</li><li id="4667" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc lb jw jx jy bi translated">使用条件生成器或编辑器添加IAM条件(参见下面的屏幕截图)</li><li id="5e3c" class="jq jr hi ih b ii jz im ka iq kb iu kc iy kd jc lb jw jx jy bi translated">'保存'</li></ol><p id="097b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从项目到区域再到虚拟机的继承层次结构，防止您覆盖和阻止为层次结构中的更高级别设置的策略。例如，您不能删除或修改为项目中的一个虚拟机设置的IAM条件。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lc"><img src="../Images/c7e497941e54a6bfe4d67f60d1806e32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/0*kYRmbSUWkzYxXyiJ"/></div></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ld"><img src="../Images/6a6a51188a54f2a6ea1ecb8f1cae57cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/0*LJGf_tLvRbXEaRYz"/></div></figure><p id="1a68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您需要从命令行为资源上的iap.tunnelResourceAccessor设置IAM条件，您可以为IAP 使用<a class="ae jd" href="https://cloud.google.com/iap/docs/reference/rest" rel="noopener ugc nofollow" target="_blank"> REST API。与我们通过下拉列表中的标题来标识访问级别的UI相反，API使用长访问级别名称。您可以通过“g cloud access-context-manager levels list-format list”获得长名称</a></p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="666e" class="kj kk hi kf b fi kl km l kn ko">curl -H "Authorization: Bearer $(gcloud auth print-access-token)" -H "content-type: application/json" -X POST <a class="ae jd" href="https://iap.googleapis.com/v1beta1/projects/307931860343/iap_tunnel:setIamPolicy" rel="noopener ugc nofollow" target="_blank">https://iap.googleapis.com/v1beta1/projects/307931860343/iap_tunnel:setIamPolicy</a> -d '{"policy":{"bindings":[{"role":"roles/iap.tunnelResourceAccessor","members":["user:testuser@example.com"],"condition": {"description": "Test","expression": "\"accessPolicies/78305086638/accessLevels/secureaccess\" in request.auth.access_levels","title": "restricted access"}}]}}'</span></pre><p id="d33a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想要在特定实例级别分配策略，可以通过将请求的URL更改为您想要启用访问的VM实例的URL来实现，</p><p id="0fa0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">https://iap.googleapis.com/v1beta1/projects/<project_id>/IAP _ tunnel/zones/<vm zone="">/instances/<instance-name>:setIamPolicy</instance-name></vm></project_id></p><p id="0a49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如</p><p id="106e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://iap.googleapis.com/v1beta1/projects/185772708261/iap_tunnel/zones/us-central1-a/instances/my-instance:setIamPolicy" rel="noopener ugc nofollow" target="_blank">https://IAP . Google APIs . com/v1 beta 1/projects/185772708261/IAP _ tunnel/zones/us-central 1-a/instances/my-instance:setIamPolicy</a></p><p id="e223" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果要将条件应用于区域，URL格式为</p><p id="7b7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">https://iap.googleapis.com/v1beta1/projects/<project_id>/IAP _隧道/区域/ <vm zone=""/></project_id></p><p id="4d49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，API调用会覆盖为相应资源设置的任何策略，但从资源层次结构的较高层继承的策略除外。</p><p id="7989" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">通过GCP云NAT为您的GCE虚拟机启用出站连接</strong></p><p id="66c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你需要从你的GCE虚拟机到互联网的出站访问，你可以使用GCP的<a class="ae jd" href="https://cloud.google.com/nat/docs/overview" rel="noopener ugc nofollow" target="_blank">云NAT </a>。云NAT为没有外部IP地址的虚拟机提供源网络地址转换(SNAT)。云NAT还为已建立的入站响应数据包提供目的网络地址转换(d NAT)。</p><p id="7f1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们首先创建一个<a class="ae jd" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview" rel="noopener ugc nofollow" target="_blank">云路由器</a>实例</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="f7d7" class="kj kk hi kf b fi kl km l kn ko">gcloud compute routers create mycloudrouter \<br/>--project=iap-access-test \<br/>--region=us-central1 --network=default</span></pre><p id="9f4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们为云路由器设置了NAT配置</p><pre class="jf jg jh ji fd ke kf kg kh aw ki bi"><span id="bfe4" class="kj kk hi kf b fi kl km l kn ko">gcloud compute routers nats create mynatconfig \<br/>--router=mycloudrouter --nat-all-subnet-ip-ranges --enable-logging \<br/>--auto-allocate-nat-external-ips</span></pre><p id="c49b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">auto-allocate-nat-external-ips标志确保自动分配SNAT地址。nat-all-subnet-ip-ranges允许命名区域内所有子网的所有ip范围，包括主要和次要范围。这些说明只是涵盖了一个相对简单的配置。更多信息请参考<a class="ae jd" href="https://cloud.google.com/nat/docs" rel="noopener ugc nofollow" target="_blank"> GCP文档</a>。</p><p id="0ef2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">总结</strong></p><p id="e8a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在这篇文章中涉及了相当多的内容。我们首先讨论了GCP的IAP，然后创建了一个基本配置，允许通过代理将流量转发到您的虚拟机，从任何地方访问虚拟机。然后，我们通过访问级别研究了访问控制，并通过一个例子说明了只有当请求来自指定的IP和地理位置时才建立隧道。我们还看到了如何将访问限制在特定区域的虚拟机以及特定的虚拟机。最后，我们快速配置了GCP云NAT，以防您的虚拟机需要出站访问。</p></div></div>    
</body>
</html>