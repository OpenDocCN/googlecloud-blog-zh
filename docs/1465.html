<html>
<head>
<title>PubSub message filter: small feature for big improvements</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PubSub消息过滤器:小功能大改进</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/pubsub-message-filter-small-feature-for-big-improvements-3d2d690b94a2?source=collection_archive---------0-----------------------#2020-06-09">https://medium.com/google-cloud/pubsub-message-filter-small-feature-for-big-improvements-3d2d690b94a2?source=collection_archive---------0-----------------------#2020-06-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/74d06debc31d3a901e16c9178e40c62d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DZZCpE1tzQcCIrIhxhimsg.png"/></div></div></figure><p id="20f2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在Google Cloud上，<a class="ae jo" href="https://cloud.google.com/pubsub" rel="noopener ugc nofollow" target="_blank"> PubSub是事件消息排队平台</a>。<strong class="is hj">无服务器、全球化、高吞吐量</strong>(每秒多达100万条消息)<strong class="is hj">负担得起、可定制重试</strong>，PubSub是<strong class="is hj">谷歌云上所有应用</strong>的支柱之一。</p><p id="5526" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以<strong class="is hj">在您的架构中使用PubSub作为事件总线</strong>，并<strong class="is hj">异步触发不同的其他无服务器服务</strong>，如Cloud Run、Cloud Function或App Engine。您还可以<strong class="is hj">使用数据流</strong> 在 <a class="ae jo" href="https://cloud.google.com/dataflow/docs/concepts/streaming-with-cloud-pubsub" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">中消费这些事件。</strong></a></p><blockquote class="jp jq jr"><p id="9d7c" class="iq ir js is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated">PubSub上有一个解释核心行为的Youtube视频系列</p></blockquote><h1 id="1da0" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">缺失的特征</h1><p id="f69c" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">最近几个月，PubSub ( <a class="ae jo" href="https://cloud.google.com/pubsub/docs/push#authentication_and_authorization_by_the_push_endpoint" rel="noopener ugc nofollow" target="_blank">推送订阅身份</a>、<a class="ae jo" href="https://cloud.google.com/pubsub/docs/dead-letter-topics" rel="noopener ugc nofollow" target="_blank">死信主题</a>、<a class="ae jo" href="https://cloud.google.com/pubsub/docs/replay-overview" rel="noopener ugc nofollow" target="_blank">快照</a>)中定期添加了一些功能，但还缺少一项功能:<strong class="is hj">过滤消息的功能。</strong></p><p id="adf7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">事实上，当你触发一个计算组件时，比如云运行、云功能或应用引擎，<strong class="is hj">你想调用它来做正确的工作</strong>而不是无用消息上的<strong class="is hj">。</strong></p><h1 id="0a2f" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">消息过滤能力</h1><p id="5624" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">这个特性非常简单，您现在可以根据消息属性过滤PubSub事件。</p><ul class=""><li id="0daa" class="kz la hi is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh bi translated">检查属性的<strong class="is hj">存在，无论其值如何</strong></li><li id="3b7e" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">检查属性的<strong class="is hj">精确值</strong></li><li id="5f36" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">检查属性的<strong class="is hj">前缀值</strong></li><li id="2d37" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated"><strong class="is hj">二元构成(AND、OR、NOT运算符)</strong>这3个检查</li></ul><p id="c667" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以使用命令行或控制台来设置该过滤器。</p><h2 id="ab20" class="ln jx hi bd jy lo lp lq kc lr ls lt kg jb lu lv kk jf lw lx ko jj ly lz ks ma bi translated">限制</h2><p id="7e9a" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">今天(2020年6月)，<strong class="is hj">功能刚刚在测试版</strong>中发布，有一些限制。</p><p id="61bd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你<strong class="is hj">不能过滤有效载荷内容</strong>只有属性可用。<br/>另外，你<strong class="is hj">不能在比<code class="du mb mc md me b">hasPrefix</code>更复杂的表达式</strong>上定义过滤器，比如一个<a class="ae jo" href="https://en.wikipedia.org/wiki/Regular_expression" rel="noopener ugc nofollow" target="_blank">正则表达式</a>。<em class="js">此功能有助于对blob名称后缀进行过滤，例如，了解扩展名值。</em></p><p id="46c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，只有<strong class="is hj"> PubSub定义的订阅可以接受过滤器</strong>。如果<a class="ae jo" href="https://cloud.google.com/functions/docs/calling/pubsub" rel="noopener ugc nofollow" target="_blank">你直接在PubSub主题</a>(命令行参数中的<code class="du mb mc md me b">--trigger-topic=&lt;topic&gt;</code>)上插入一个云函数，你还不能定义一个过滤器。<br/> <em class="js">解决方法是</em> <a class="ae jo" href="https://cloud.google.com/functions/docs/calling/http" rel="noopener ugc nofollow" target="_blank"> <em class="js">定义云函数HTTP </em> </a> <em class="js">(命令行参数中的</em> <code class="du mb mc md me b"><em class="js">--trigger-http</em></code> <em class="js">)，并在其上定义一个PubSub推送订阅。</em></p><p id="d42e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，<strong class="is hj">不能更新滤镜</strong>。您必须删除并重新创建带有过滤器更新的订阅。</p></div><div class="ab cl mf mg gp mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="hb hc hd he hf"><p id="b403" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了解释为什么这个特性很棒，我们可以举一个最常见的用例。</p><blockquote class="jp jq jr"><p id="c93c" class="iq ir js is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated">云存储事件管理和blob处理</p></blockquote><h1 id="a52b" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">云存储使用案例</h1><p id="0c56" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">在这个用例示例中，您希望<a class="ae jo" href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage" rel="noopener ugc nofollow" target="_blank">执行一个加载作业，将创建到<code class="du mb mc md me b">gs://mybucket/path/to/directory/</code>目录中的blob加载到BigQuery </a>中。</p><p id="6226" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，您可以<a class="ae jo" href="https://cloud.google.com/storage/docs/reporting-changes" rel="noopener ugc nofollow" target="_blank">在PubSub </a>上发布云存储事件，这意味着每次创建、删除、更新blob(元数据)时，<strong class="is hj">都会有一个事件发布到PubSub中。</strong></p><h2 id="10c1" class="ln jx hi bd jy lo lp lq kc lr ls lt kg jb lu lv kk jf lw lx ko jj ly lz ks ma bi translated">没有消息过滤功能</h2><p id="027c" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">如果没有过滤功能，问题是云存储桶上的任何事件都会发布到PubSub中，而不仅仅是所需目录的事件。因此，直到现在，你不得不这样</p><pre class="mm mn mo mp fd mq me mr ms aw mt bi"><span id="8329" class="ln jx hi me b fi mu mv l mw mx">if (It's a blob creation) AND (it's the correct directory){<br/>  Perform the job<br/>}<br/>exit</span></pre><p id="df75" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该流程的<strong class="is hj">问题是</strong></p><ul class=""><li id="8452" class="kz la hi is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh bi translated">你必须<strong class="is hj">在你的代码</strong>中实现检查并维护这个部分。</li><li id="0ab9" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">你必须<strong class="is hj">在所有需要过滤/选择的事件处理程序中重复这几行代码</strong>。</li><li id="43f6" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated"><strong class="is hj">处理部分负责检查和选择</strong>要处理的正确斑点。<em class="js">不应该是它关心的事情</em>。</li><li id="03fa" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">你的计算服务(云运行、云功能、应用引擎)被<strong class="is hj">调用，只需很短的时间就能完成</strong>的处理。您将根据调用次数和处理时间支付<strong class="is hj">费用，四舍五入至最大值(云功能和云运行为100毫秒，应用引擎为15分钟)</strong></li></ul><p id="1d1a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="js">注:云运行、云功能和App引擎</em> <strong class="is hj"> <em class="js">提供了慷慨的免费层</em> </strong> <em class="js">对于低流量，还有</em> <strong class="is hj"> <em class="js">不算任何额外费用</em> </strong> <em class="js">。</em></p><h2 id="f953" class="ln jx hi bd jy lo lp lq kc lr ls lt kg jb lu lv kk jf lw lx ko jj ly lz ks ma bi translated">邮件过滤器的改进</h2><p id="2562" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">现在，云存储用例更简单了。你<strong class="is hj">可以删除校验码</strong>和<strong class="is hj">定义一个简单的过滤器</strong>像这样，然后调用你的<code class="du mb mc md me b"><a class="ae jo" href="https://myendpoint/i" rel="noopener ugc nofollow" target="_blank">https://myEndpoint/</a></code> <br/>比如，在控制台中</p><figure class="mm mn mo mp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es my"><img src="../Images/17191b38abb7825a44af823d8af3621d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qQ1YCNI_Y3gSOFPu_rGJ1Q.png"/></div></div></figure><p id="82dd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者使用命令行</p><pre class="mm mn mo mp fd mq me mr ms aw mt bi"><span id="3f76" class="ln jx hi me b fi mu mv l mw mx">gcloud beta pubsub subscriptions create \<br/>  --topic=&lt;myTopic&gt; \<br/>  --push-endpoint=https://myEndpoint/ \<br/>  --message-filter='attributes.eventType="OBJECT_FINALIZE" AND \ <br/>  hasPrefix(attributes.objectId,"path/to/directory/")'\<br/>  &lt;mySubscriptionName&gt;</span></pre><p id="0b55" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">仅此而已。现在，只有当一个事件与过滤器匹配时，你的<code class="du mb mc md me b">https://myEndpoint/</code> <strong class="is hj">才会被调用，这里是在<code class="du mb mc md me b">path/to/directory</code>目录下创建一个文件。</strong></p></div><div class="ab cl mf mg gp mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="hb hc hd he hf"><h1 id="79ea" class="jw jx hi bd jy jz mz kb kc kd na kf kg kh nb kj kk kl nc kn ko kp nd kr ks kt bi translated">过滤更多以更智能地处理</h1><p id="2bfd" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">在很长一段时间里，我乞求谷歌有这个功能。现在，我有了它，它简化了很多工作，减少了处理时间！</p><p id="fdad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于一个伟大的产品来说，这是一个非常好的改进。我强烈建议你试一试。</p></div></div>    
</body>
</html>