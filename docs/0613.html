<html>
<head>
<title>Monitoring End-to-End Message Latency with Stackdriver</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Stackdriver监控端到端消息延迟</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/monitoring-end-to-end-message-latency-with-stackdriver-7f81c56e739d?source=collection_archive---------1-----------------------#2018-05-22">https://medium.com/google-cloud/monitoring-end-to-end-message-latency-with-stackdriver-7f81c56e739d?source=collection_archive---------1-----------------------#2018-05-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="81d8" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">摘要</h1><p id="3775" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">本文描述了一个使用Stackdriver监控异步消息端到端延迟的简单系统。这些消息是通过谷歌云<a class="ae kb" href="https://cloud.google.com/pubsub/" rel="noopener ugc nofollow" target="_blank">发布/订阅</a>发送的。使用通过Stackdriver monitoring Python客户端API库收集的<a class="ae kb" href="https://cloud.google.com/stackdriver/" rel="noopener ugc nofollow" target="_blank"> Stackdriver </a>自定义指标来监控延迟。在<a class="ae kb" href="https://gist.github.com/alexamies/9592ccba1860f3db852919e789c007e1" rel="noopener ugc nofollow" target="_blank">这个Github Gist </a>中提供了附随代码。</p><h1 id="ee47" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">背景</h1><p id="d599" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">优化用户体验的最佳实践是最小化用户等待的同步请求的延迟。实现这一点的常用模式是异步通信。例如，如果用户向朋友发送自拍，那么服务器可以将消息卸载到交付服务，如Google Pub/Sub，然后立即向用户返回确认。通过这种方式，用户不会被阻止等待后端完成最终交付自拍所需的所有不同事情。</p><p id="e0b9" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">这很好，但是端到端的交付时间可能仍然很重要。例如，假设有人正在等待接收图像。这促使我们监控交货时间。使用Stackdriver <a class="ae kb" href="https://cloud.google.com/monitoring/custom-metrics/" rel="noopener ugc nofollow" target="_blank">自定义指标</a>和Stackdriver monitoring Python客户端API，Gist中的示例和代码可以很容易地适用于其他需要特定应用计时测量的用例。</p><p id="2628" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">作为一个比发送自拍更现实的场景，这可能还需要ApplePush和<a class="ae kb" href="https://firebase.google.com/docs/cloud-messaging/" rel="noopener ugc nofollow" target="_blank"> Firebase云消息</a>(适用于Android和iOS)，考虑通过发布/订阅来批量处理大量数据，例如，使用云存储的<a class="ae kb" href="https://cloud.google.com/storage/docs/pubsub-notifications" rel="noopener ugc nofollow" target="_blank">云发布/订阅通知</a>。这里描述的探测器可以为您提供一个性能基线。</p><h1 id="a6f3" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">解决办法</h1><p id="d07d" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">该解决方案将发送时间与收到消息的时间进行比较，将两者之差(即端到端延迟)写入Stackdriver。要设置它，在控制台中有几个简单的步骤，如要点中提供的README.md文件中所解释的。您需要启用Stackdriver API，为监视探测器创建一个服务帐户，并启用Stackdriver premium。自述文件中提供了所需的详细命令。</p><p id="bf5b" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">gist中有三个简短的Python程序:设置脚本、发送方和接收方。每个程序都有一个相应的Dockerfile在容器中运行。设置脚本定义了自定义指标。发送方每分钟发送PubSub消息，并在消息中添加一个时间戳作为属性。接收方读取并确认消息，计算端到端延迟，然后将其写入Stackdriver自定义度量时间序列。如下图所示。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/88bb4fb8699c124d417e916915441d9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/format:webp/1*j-4SsuFrkb6Pb4XfLxDIwA.png"/></div></figure><p id="7edf" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">按照gist README.md文件中的命令，使用Docker在本地或在Kubernetes集群中运行程序。Kubernetes集群是长时间运行探测的最方便的方式。要点中提供了Kubenetes命令。</p><p id="5907" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">要查看数据，请在Stackdriver控制台中添加一个自定义仪表板。Stackdriver中显示“custom . googleapis . com/pubsube2e”指标的详细信息如下所示。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es kp"><img src="../Images/15ca48ed438a3cfebfb8dd19331d59c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZGSjs6kRSRpoTsK9ey1o8g.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated"><strong class="bd ih">图:为自定义指标添加Stackdriver图表</strong></figcaption></figure><p id="ba28" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">请注意，在Stackdriver Monitoring v3 API中不再需要“global”资源，正如上面对话框中所提示的那样。有关设置仪表板和图表的详细信息，请参见<a class="ae kb" href="https://cloud.google.com/monitoring/charts/" rel="noopener ugc nofollow" target="_blank"> Stackdriver文档</a>。</p><h1 id="8517" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">使用监控数据检查问题</h1><p id="7aaf" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">如果您有设置问题，请按照要点中的步骤对程序的正确操作进行故障排除。</p><p id="9c30" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">假设在成功设置后，您发现延迟的变化影响了最终用户体验。你如何调查原因？您可以使用stack driver<a class="ae kb" href="https://cloud.google.com/monitoring/api/resources#tag_consumed_api" rel="noopener ugc nofollow" target="_blank">Consumed API</a>指标来查看平台是否有相应的变化。为此，在Stackdriver用户界面中创建一个自定义仪表板。在“度量”下，选择具有度量“请求延迟”的资源类型“消耗的API”。然后按服务= pubsub.googleapis.com进行筛选，并按第50、95或99个百分点进行聚合。这在下面的截图中显示。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es ky"><img src="../Images/d130d3550d472eb8c66f26380b98c5cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PdgTRlrrHtdRUmXWXRn5YQ.png"/></div></div></figure><p id="c141" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">除了平台之外，延迟变化的其他原因可能是负载大小、系统处理大规模工作负载的能力以及应用程序的总体健康状况。您应该能够找到现有的<a class="ae kb" href="https://cloud.google.com/monitoring/api/metrics" rel="noopener ugc nofollow" target="_blank">支持的指标</a>或者定义新的自定义指标来确定速度变慢的原因。</p><h1 id="2473" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">使得解决方案更加健壮</h1><p id="7262" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">该代码不包括主题或订阅管理。当接收器启动时，它创建一个对主题的订阅，并附加一个随机数，这样它就不会在重启时失败。但是，如果您重新启动多次，您将拥有一个订阅者集合，其中一些订阅者没有做任何事情。更强大的解决方案将包括更强大的管理。</p><h1 id="b51f" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">限制</h1><p id="e6e2" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">您可以使用平台提供的Pub/Sub Message.publish_time字段，而不是将您的时间戳作为属性添加到Pub/Sub消息中。然而，这样做的一个潜在问题是漂移。gist中使用的方法的优点是，如果发送方和接收方在同一台机器上，并且使用相同的python调用time.time()来获得时间戳的秒表示，则生成的时间戳将是一致的。当您使用来自多台机器的时间戳时，您需要更加小心地测量时间，以避免由于时钟漂移造成的系统差异。</p><h1 id="0c95" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">资源</h1><ol class=""><li id="38da" class="kz la hi jf b jg jh jk jl jo lb js lc jw ld ka le lf lg lh bi translated">栈驱动监控客户端库:<a class="ae kb" href="https://cloud.google.com/monitoring/docs/reference/libraries" rel="noopener ugc nofollow" target="_blank">Python和其他语言的GCP文档</a></li><li id="e3bd" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">Publisher Guide: <a class="ae kb" href="https://cloud.google.com/pubsub/docs/publisher" rel="noopener ugc nofollow" target="_blank">多语言的GCP文档</a></li><li id="efef" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">PubSub Pull订阅指南:<a class="ae kb" href="https://cloud.google.com/pubsub/docs/pull" rel="noopener ugc nofollow" target="_blank"> GCP多语言文档</a></li><li id="393c" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">Stackdriver consumed_api度量:<a class="ae kb" href="https://cloud.google.com/monitoring/api/resources#tag_consumed_api" rel="noopener ugc nofollow" target="_blank"> Stackdriver支持的度量列表</a></li><li id="fd4c" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">GCP API认证— <a class="ae kb" href="https://developers.google.com/accounts/docs/application-default-credentials" rel="noopener ugc nofollow" target="_blank"> GCP应用默认凭证</a></li><li id="76ca" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">PubSub gcloud命令— <a class="ae kb" href="https://cloud.google.com/sdk/gcloud/reference/beta/pubsub/" rel="noopener ugc nofollow" target="_blank"> gcloud参考</a></li><li id="7fed" class="kz la hi jf b jg li jk lj jo lk js ll jw lm ka le lf lg lh bi translated">监控API Python客户端库实现— <a class="ae kb" href="https://github.com/googleapis/googleapis/tree/master/google/api" rel="noopener ugc nofollow" target="_blank"> GitHub项目</a></li></ol></div></div>    
</body>
</html>