<html>
<head>
<title>Particle, OpenCensus &amp; MicroK8s</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">粒子、OpenCensus和MicroK8s</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/particle-opencensus-microk8s-17d886d535e?source=collection_archive---------1-----------------------#2019-06-26">https://medium.com/google-cloud/particle-opencensus-microk8s-17d886d535e?source=collection_archive---------1-----------------------#2019-06-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a876" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我用<a class="jd je ge" href="https://medium.com/u/865200fae862?source=post_page-----17d886d535e--------------------------------" rel="noopener" target="_blank">尼克·英格曼</a>的<a class="ae jf" href="https://blog.particle.io/2019/05/06/learn-how-to-build-in-plants-a-mesh-connected-soil-monitoring-system/" rel="noopener ugc nofollow" target="_blank">为盆景安装了一个湿度传感器，学习如何建立室内植物，一个网状连接的土壤监测系统</a>。该解决方案将粒子设备数据发布到ThingSpeak。</p><p id="df6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想将解决方案扩展到Google的数据库服务，但是在应用数据(这是)和测量数据(这是)之间有一条细微的界限。对于测量，我们有监控解决方案。我感兴趣的一个监测框架是OpenCensus。</p><p id="fda4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，在这里，<a class="ae jf" href="http://particle.io" rel="noopener ugc nofollow" target="_blank">粒子</a>设备事件数据与谷歌云函数挂钩，该函数从数据中创建OpenCensus测量，并将其发送到运行在MicroK8s上的OpenCensus代理(“因为它很酷”)，并使其作为Prometheus(也很酷)度量端点和Stackdriver(“因为我试图成为一名优秀的谷歌人”)。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es jg"><img src="../Images/6f77c21cd7295fc0bdd1516969847974.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4j98dflrOAossQuWzJ5cHQ.jpeg"/></div></div></figure><p id="7598" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">跟随Nick的帖子，让自己了解一个可以定期测量和发布水分数据的particle.io设备。如果设备正在向ThingSpeak发布数据，那么你就很好:</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div class="er es js"><img src="../Images/aec196956de9cf3e70e7e52d64dd434b.png" data-original-src="https://miro.medium.com/v2/resize:fit:952/format:webp/1*fm9G0F3sGkjKjkcrttXjfA.png"/></div></figure><h2 id="47b7" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">公开普查</h2><p id="f188" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">OpenCensus拥有独立于监控服务的客户端SDK。这些将数据发送到OpenCensus代理，该代理被配置为将数据转换并发送到您首选的监控(和跟踪)服务。我正在集中精力监视和使用Stackdriver和Prometheus。下面是代理配置:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="89b5" class="jt ju hi ku b fi ky kz l la lb">receivers:<br/>  opencensus:<br/>    address: ":<strong class="ku hj">55678</strong>"</span><span id="3bc4" class="jt ju hi ku b fi lc kz l la lb">exporters:<br/>  stackdriver:<br/>    project: "[[YOUR-PROJECT]]"<br/>    enable_tracing: false<br/>    enable_metrics: true<br/>  prometheus:<br/>    address: ":<strong class="ku hj">8999</strong>"</span><span id="7b21" class="jt ju hi ku b fi lc kz l la lb">zpages:<br/>    port: <strong class="ku hj">8888</strong></span></pre><p id="defa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在本地运行代理进行测试，但如果您希望将数据导出到Stackdriver，则需要一个带有<code class="du ld le lf ku b">roles/monitoring.metricWriter</code>的Google服务帐户。我是这样做的:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="6baa" class="jt ju hi ku b fi ky kz l la lb">PROJECT=[[YOUR-PROJECT]]<br/>ROBOT=opencensus<br/>FILE=${PWD}/${ROBOT}.json</span><span id="7aa2" class="jt ju hi ku b fi lc kz l la lb">gcloud iam service-accounts create $ROBOT \<br/>--display-name=$ROBOT \<br/>--project=$PROJECT</span><span id="1c7f" class="jt ju hi ku b fi lc kz l la lb">gcloud iam service-accounts keys create ${FILE} \<br/>--iam-account=${ROBOT}@${PROJECT}.iam.gserviceaccount.com \<br/>--project=$PROJECT</span><span id="5edb" class="jt ju hi ku b fi lc kz l la lb">gcloud projects add-iam-policy-binding $PROJECT --member=serviceAccount:${ROBOT}@${PROJECT}.iam.gserviceaccount.com --role=roles/monitoring.metricWriter</span></pre><p id="c51f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="d526" class="jt ju hi ku b fi ky kz l la lb">docker run \<br/>--interactive --tty \<br/>--volume=$PWD/ocagent.yaml:/configs/ocagent.yaml \<br/>--volume=$PWD/opencensus.json:/secrets/opencensus.json \<br/>--publish=8888:<strong class="ku hj">8888</strong> \<br/>--publish=8999:<strong class="ku hj">8999</strong> \<br/>--publish=55678:<strong class="ku hj">55678</strong> \<br/>--env=GOOGLE_APPLICATION_CREDENTIALS=/secrets/opencensus.json \<br/>omnition/opencensus-agent:0.1.8 \<br/>  --config=/configs/ocagent.yaml</span></pre><p id="bd16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们来看看这个配置是如何映射到Kubernetes配置文件的:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="246b" class="jt ju hi ku b fi ky kz l la lb">---<br/>apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: ocagent<br/>data:<br/>  ocagent.yaml: |<br/>    receivers:<br/>      opencensus:<br/>        address: ":<strong class="ku hj">55678</strong>"</span><span id="b12e" class="jt ju hi ku b fi lc kz l la lb">exporters:<br/>      stackdriver:<br/>        project: "[[YOUR-PROJECT]]"<br/>        enable_tracing: false<br/>        enable_metrics: true<br/>      prometheus:<br/>        address: ":<strong class="ku hj">8999</strong>"</span><span id="9990" class="jt ju hi ku b fi lc kz l la lb">zpages:<br/>        port: <strong class="ku hj">8888</strong><br/>...<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  labels:<br/>    project: particle.io<br/>  name: ocagent<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      project: particle.io<br/>      app: agent<br/>  template:<br/>    metadata:<br/>      labels:<br/>        project: particle.io<br/>        app: agent<br/>    spec:<br/>      volumes:<br/>      - name: ocagent<br/>        configMap:<br/>          name: ocagent<br/>      - name: opencensus-key<br/>        secret:<br/>          secretName: opencensus-key<br/>      containers:<br/>      - name: ocagent<br/>        image: omnition/opencensus-agent:0.1.8<br/>        imagePullPolicy: IfNotPresent<br/>        args:<br/>        - --config=/configs/ocagent.yaml<br/>        volumeMounts:<br/>        - name: ocagent<br/>          mountPath: /configs/<br/>        - name: opencensus-key<br/>          mountPath: /var/secrets/google<br/>        env:<br/>        - name: GOOGLE_APPLICATION_CREDENTIALS<br/>          value: /var/secrets/google/opencensus.json<br/>...<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    project: particle.io<br/>  name: ocagent<br/>spec:<br/>  selector:<br/>    project: particle.io<br/>    app: agent<br/>  ports:<br/>  - name: zpages<br/>    port: <strong class="ku hj">8888</strong><br/>  - name: prometheus<br/>    port: <strong class="ku hj">8999</strong><br/>  - name: grpc<br/>    port: <strong class="ku hj">55678</strong><br/>  type: NodePort<br/>...</span></pre><h2 id="d014" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">云函数</h2><p id="6146" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">我们需要一种方法来接收来自Particle的Webhooks，并将它们转换成OpenCensus。我用的是谷歌云功能和Golang。函数如下:</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="lg lh l"/></div></figure><p id="7ec6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以及附带的go.mod:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="3c3a" class="jt ju hi ku b fi ky kz l la lb">module cloudfunction</span><span id="f219" class="jt ju hi ku b fi lc kz l la lb">go 1.12</span><span id="2746" class="jt ju hi ku b fi lc kz l la lb">require (<br/> contrib.go.opencensus.io/exporter/ocagent v0.5.0<br/> go.opencensus.io v0.21.0<br/>)</span></pre><p id="c6e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于本地开发，我建议将它们放在一个子目录中，为了一致起见，我们称之为“<code class="du ld le lf ku b">p</code>”。在一个姊妹子目录中，创建一个“<code class="du ld le lf ku b">server</code>”，并在其中放置<code class="du ld le lf ku b">main.go</code>:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="00a2" class="jt ju hi ku b fi ky kz l la lb">package main</span><span id="18db" class="jt ju hi ku b fi lc kz l la lb">import (<br/> "log"<br/> "net/http"</span><span id="fe6e" class="jt ju hi ku b fi lc kz l la lb">"github.com/[[YOUR-ACCOUNT]]/webhook/p"<br/>)</span><span id="2171" class="jt ju hi ku b fi lc kz l la lb">func main() {<br/> log.Println("main")<br/> http.HandleFunc("/", p.Percent)<br/> log.Fatal(http.ListenAndServe(":9999", nil))<br/>}</span></pre><p id="51fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这只是提供了一个方便的包装器，以便我们可以在本地测试我们的功能。OpenCensus代理运行后，启动服务器:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="c926" class="jt ju hi ku b fi ky kz l la lb">SERVICE_NAME=test \<br/>AGENT_ENDPOINT=:55678 \<br/>go run server/main.go</span></pre><p id="8a4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以在服务中抛出一些测试数据:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="996b" class="jt ju hi ku b fi ky kz l la lb">#!/bin/bash</span><span id="9b1e" class="jt ju hi ku b fi lc kz l la lb">ENDPOINT="localhost:9999"<br/>for TEST in {1..100}<br/>do<br/>  PERCENT=$(bc &lt;&lt;&lt; "scale=2; ${TEST}/100")<br/>  DATE=$(date --rfc-3339=seconds)<br/>  DATA="\<br/>    {\"event\":\"test\",\<br/>    \"data\":\"${PERCENT}\",\<br/>    \"published_at\":\"${DATE}\",\<br/>    \"coreid\":\"TEST\"}"<br/>  RESULT=$(\<br/>    curl \<br/>    --silent \<br/>    --request POST \<br/>    --header "Content-Type:application/json" \<br/>    --data "${DATA}" \<br/>    ${ENDPOINT})<br/>  printf "%s [%s]\n" ${PERCENT} ${RESULT}<br/>done</span></pre><p id="0e49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦生成了一些数据，您就可以查看zPages:</p><p id="44c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ld le lf ku b"><a class="ae jf" href="http://localhost:8888/debug/rpcz" rel="noopener ugc nofollow" target="_blank">http://localhost:8888/debug/rpcz</a></code></p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es li"><img src="../Images/24a99f027c42ca6524bb4f1ca8cfa61a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fNNFbdGE-ZvJ0sDy-3K5gg.png"/></div></div></figure><p id="0580" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">普罗米修斯:</p><p id="696d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ld le lf ku b">http://localhost:8999/metrics</code></p><figure class="jh ji jj jk fd jl er es paragraph-image"><div class="er es lj"><img src="../Images/a864866b3315c6ef85419e899a215b54.png" data-original-src="https://miro.medium.com/v2/resize:fit:634/format:webp/1*ySFjRiTtuikcD3Reih7psA.png"/></div></figure><p id="0c09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还有斯塔克德瑞。使用“指标浏览器”，您应该能够浏览“开放人口普查/百分比”:</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lk"><img src="../Images/dd3c8c1315cdb1ff26bf656c00a9af5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jGmSLAwphBUpZlRTcna7Pg.png"/></div></div></figure><h2 id="4a56" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">库伯内特斯</h2><p id="e1ef" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">使用Kubernetes托管OpenCensus代理有点过分了，但是Kubernetes为使用容器共享文件(例如ocagent.yaml)的问题提供了一个优雅的解决方案。出于这个原因，我在容器图像上使用micro k8s(<a class="ae jf" rel="noopener" href="/google-cloud/microk8s-on-google-cloud-platform-d8b7a71a3ef">链接</a>)。</p><p id="c2ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们希望群集能够对Stackdriver进行身份验证。为此，我们将服务帐户密钥复制到集群实例，从中创建一个Kubernetes秘密，然后将该秘密(作为卷挂载中的文件)提供给部署。从您的工作站:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="c5fb" class="jt ju hi ku b fi ky kz l la lb">gcloud compute scp \<br/>  ${PWD}/opencensus.json \<br/>  ${INSTANCE}: \<br/>--project=${PROJECT} \<br/>--zone=${ZONE}</span></pre><p id="d83d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du ld le lf ku b">${INSTANCE}</code>内:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="a715" class="jt ju hi ku b fi ky kz l la lb">microk8s.kubectl create secret generic opencensus-key \<br/>--from-file=<strong class="ku hj">opencensus.json</strong>=${PWD}/opencensus.json</span><span id="a1a9" class="jt ju hi ku b fi lc kz l la lb">secret/opencensus-key created</span></pre><blockquote class="ll lm ln"><p id="68b3" class="if ig lo ih b ii ij ik il im in io ip lp ir is it lq iv iw ix lr iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>为了简单起见，我在秘密中保留了密钥的文件名(<code class="du ld le lf ku b">opencensus.json</code>)。但是，您也可以使用此命令重命名该文件。</p></blockquote><p id="b8d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="3765" class="jt ju hi ku b fi ky kz l la lb">microk8s.kubectl apply --filename=kubernetes.yaml</span></pre><p id="99fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要OpenCensus代理的gRPC端点的节点端口来配置云功能:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="b504" class="jt ju hi ku b fi ky kz l la lb">GRPC=$(\<br/>  microk8s.kubectl get services/ocagent \<br/>  --output=jsonpath='{.spec.ports[?(@.name=="grpc")].nodePort}') &amp;&amp; \<br/>echo ${GRPC}</span></pre><blockquote class="ll lm ln"><p id="40fe" class="if ig lo ih b ii ij ik il im in io ip lp ir is it lq iv iw ix lr iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>如果你愿意，你也可以确定zPages(用<code class="du ld le lf ku b">ZPGS</code>和<code class="du ld le lf ku b">name=="zpages"</code>替换<code class="du ld le lf ku b">GRPC</code>)和Prometheus(用<code class="du ld le lf ku b">PROM</code>和<code class="du ld le lf ku b">name=="prometheus"</code>替换<code class="du ld le lf ku b">GRPC</code>)的节点端口</p></blockquote><p id="8600" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您创建MicroK8s VM时，您应该有一个实例名(<code class="du ld le lf ku b">${INSTANCE}</code>)。我们可以用这个，<code class="du ld le lf ku b">${PROJECT}</code>和<code class="du ld le lf ku b">${ZONE}</code>来获取公共IP地址:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="d00c" class="jt ju hi ku b fi ky kz l la lb">MICROK8S=$(\<br/>  gcloud compute instances describe ${INSTANCE} \<br/>  --project=${PROJECT} \<br/>  --zone=${ZONE} \<br/>  --format="value(networkInterfaces.accessConfigs[0].natIP)") &amp;&amp; \<br/>echo ${MICROK8S)</span></pre><p id="fa83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你需要在防火墙上打一个洞，这样云功能就可以访问服务:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="d777" class="jt ju hi ku b fi ky kz l la lb">gcloud compute firewall-rules create particle-demo \<br/>--direction=INGRESS \<br/>--priority=1000 \<br/>--network=default \<br/>--action=ALLOW \<br/>--rules=tcp:${GRPC}<strong class="ku hj">,tcp:${ZPGS},tcp:${PROM}</strong> \<br/>--source-ranges=0.0.0.0/0 \<br/>--project=${PROJECT}</span></pre><blockquote class="ll lm ln"><p id="6448" class="if ig lo ih b ii ij ik il im in io ip lp ir is it lq iv iw ix lr iz ja jb jc hb bi translated">如果您想通过外部IP使用zPage和Prometheus端口，请仅包括它们。</p></blockquote><h2 id="f5c9" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">云函数</h2><p id="413e" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">一旦您对本地测试感到满意，您就可以部署到云功能:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="ff2f" class="jt ju hi ku b fi ky kz l la lb">PROJECT=[[YOUR-PROJECT]]<br/>REGION=[[YOUR-REGION]] # Perhaps 'us-central1'</span><span id="6661" class="jt ju hi ku b fi lc kz l la lb">gcloud services enable functions.googleapis.com \<br/>--project=${PROJECT}</span><span id="d70c" class="jt ju hi ku b fi lc kz l la lb">gcloud functions deploy webhook \<br/>--region=${REGION} \<br/>--project=${PROJECT} \<br/>--runtime=<strong class="ku hj">go112</strong> \<br/>--trigger-http \<br/>--entry-point=Percent \<br/>--set-env-vars=\<br/>SERVICE_NAME=particle.io,\<br/>AGENT_ENDPOINT=${MICROK8S}:${GRPC}</span></pre><p id="76a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦部署，云功能可以像以前一样使用bash脚本进行最好的测试，但是添加一个新的Particle Webhook也一样快。</p><h2 id="fc54" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">Webhook</h2><p id="8097" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">使用粒子控制台:</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es ls"><img src="../Images/a9b709141c32d9a44f40069e61a0ba97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YNdjyDV5oTBWMyq1yKF64A.png"/></div></div></figure><p id="1d19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几分钟后，配置好的Webhook将会报告——希望如此——成功接收到事件，如下所示。</p><h2 id="f7ed" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">测试</h2><p id="e508" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">检查粒子设备是否正在发布事件。您可以使用粒子控制台来完成此操作:</p><p id="6333" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后检查Webhook是否正在将事件发送到云函数:</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div class="er es lt"><img src="../Images/5f208e371b737cf308b2845339799359.png" data-original-src="https://miro.medium.com/v2/resize:fit:890/format:webp/1*I96gHPGG2z29kbF-gCcA8w.png"/></div></figure><p id="3957" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看云功能控制台或日志:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="e855" class="jt ju hi ku b fi ky kz l la lb">gcloud logging read 'resource.type="cloud_function"' \<br/>--project=${PROJECT} \<br/>--format=json --limit=25 \<br/>| jq -r .[].textPayload</span><span id="8a31" class="jt ju hi ku b fi lc kz l la lb">Function execution took 3 ms, finished with status code: 200<br/>value: 20.122101<br/>percent<br/>Function execution started<br/>Function execution took 4 ms, finished with status code: 200<br/>value: 20.415140<br/>percent<br/>Function execution started<br/>Function execution took 3 ms, finished with status code: 200<br/>value: 20.317461<br/>percent<br/>Function execution started<br/>Function execution took 4 ms, finished with status code: 200<br/>value: 20.561661<br/>percent<br/>Function execution started<br/>Function execution took 8 ms, finished with status code: 200<br/>value: 20.366301<br/>percent<br/>Function execution started<br/>Function execution took 4 ms, finished with status code: 200<br/>value: 20.317461<br/>percent<br/>Function execution started<br/>Function execution took 3 ms, finished with status code: 200</span></pre><p id="6cae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确认MicroK8s服务(pod)正在侦听:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="4f5d" class="jt ju hi ku b fi ky kz l la lb">POD=$(\<br/>  microk8s.kubectl get pods \<br/>  --selector=project=particle.io \<br/>  --output=jsonpath="{.items[0].metadata.name}")</span><span id="f8a8" class="jt ju hi ku b fi lc kz l la lb">microk8s.kubectl get logs pod/${POD}</span><span id="40ef" class="jt ju hi ku b fi lc kz l la lb">Setting Stackdriver default location to "[[YOUR-PROJECT]]"<br/>{..."msg":"Metrics Exporter enabled","exporter":"stackdriver"}<br/>{..."msg":"Metrics Exporter enabled","exporter":"prometheus"}<br/>Running OpenCensus Trace and Metrics receivers as a gRPC service at ":55678"<br/>Running zPages on port 8888</span></pre><p id="3288" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您公开了<code class="du ld le lf ku b">${ZPGS}</code>和<code class="du ld le lf ku b">${PROM}</code>端口，您可以查看这两个端口，以确认数据正在通过代理推送:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="feaa" class="jt ju hi ku b fi ky kz l la lb">google-chrome ${MICROK8S}:${ZPGS}/debug/rpcz<br/>google-chrome ${MICROK8S}:${PROM}/metrics</span></pre><p id="c799" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将让您配置一个Prometheus服务器来定位OpenCensus Prometheus端点。</p><p id="8e8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个堆栈驱动图:</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lu"><img src="../Images/7a2652e56508f8b24b098eeb0968b271.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rViLqrqJVlgLDOpqKNdMuA.png"/></div></div></figure><h2 id="7f38" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">结论</h2><p id="d184" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">在这个故事中，我们通过使用Google Cloud函数创建Webhook服务来扩展Nick的解决方案，该服务创建OpenCensus测量值，将这些测量值发送到部署在MicroK8s上的OpenCensus代理，并向Stackdriver和Prometheus提供测量值。</p><p id="3857" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">OpenCensus的优势之一是它将生产者和消费者的关注点分开。既然粒子数据被公开为OpenCensus数据，那么重新配置代理以将数据公开给Datadog、AWS、Azure和任何其他支持的监控服务就是一件小事。</p><p id="e420" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仅此而已！</p><h2 id="c17e" class="jt ju hi bd jv jw jx jy jz ka kb kc kd iq ke kf kg iu kh ki kj iy kk kl km kn bi translated">整理</h2><p id="b372" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">焦土方案将删除所有内容，包括项目…</p><p id="3200" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">小心行事…</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="c427" class="jt ju hi ku b fi ky kz l la lb">gcloud projects delete ${PROJECT}</span></pre><p id="8179" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，您可以选择以下某个子集来删除特定资源:</p><pre class="jh ji jj jk fd kt ku kv kw aw kx bi"><span id="5238" class="jt ju hi ku b fi ky kz l la lb">gcloud functions delete webhook \<br/>--region=us-central1 \<br/>--project=${PROJECT}</span><span id="a805" class="jt ju hi ku b fi lc kz l la lb">gcloud compute instances delete ${INSTANCE} \<br/>--zone=${ZONE} \<br/>--project=${PROJECT}</span><span id="2c31" class="jt ju hi ku b fi lc kz l la lb">gcloud compute firewall-rules delete particle-demo \<br/>--project=${PROJECT}</span></pre></div></div>    
</body>
</html>