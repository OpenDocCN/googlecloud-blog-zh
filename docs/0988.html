<html>
<head>
<title>App Engine Flex || Cloud Run</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">App Engine Flex ||云运行</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/app-engine-flex-cloud-run-56efb8e206e9?source=collection_archive---------0-----------------------#2019-05-02">https://medium.com/google-cloud/app-engine-flex-cloud-run-56efb8e206e9?source=collection_archive---------0-----------------------#2019-05-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="46cb" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">在GCP部署容器化应用的三种方式</h2></div><p id="2def" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我的一个更受欢迎的故事展示了能够将应用部署到App Engine Flex(在<code class="du jt ju jv jw b">:8080</code>的容器中)然后将映像重新部署到Kubernetes Engine(<a class="ae jx" rel="noopener" href="/google-cloud/app-engine-flex-container-engine-946fbc2fe00a">App Engine Flex | | Kubernetes Engine-？</a>)。</p><p id="33f8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">随着Cloud Run的发展，我认为重新利用这个故事并看看这个规则是否继续适用会很有趣。</p><p id="1ced" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">提示</strong>:确实如此(当然！)</p><h2 id="7f85" class="jy jz hi bd ka kb kc kd ke kf kg kh ki jg kj kk kl jk km kn ko jo kp kq kr ks bi translated">App Engine Flex</h2><p id="f953" class="pw-post-body-paragraph ix iy hi iz b ja kt ij jc jd ku im jf jg kv ji jj jk kw jm jn jo kx jq jr js hb bi translated">一些变化:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="89c4" class="jy jz hi jw b fi lg lh l li lj">for SERVICE in firestore run<br/>do<br/>  gcloud services enable ${SERVICE}.googleapis.com \<br/>  --project=${PROJECT}<br/>done</span></pre><p id="9ed4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你还需要选择是否从云控制台以“数据存储模式”(是)或“本机模式”运行Firestore(因为——boo——没有公共API来支持这项服务)。我们将使用数据存储模式，因为该示例使用数据存储SDK|API。</p><p id="7d06" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您愿意，您可以通过删除app.yaml <code class="du jt ju jv jw b">env_variables</code>部分、删除<code class="du jt ju jv jw b">projectID := os.Getenv(“GCLOUD_DATASET_ID”)</code>并将<code class="du jt ju jv jw b">NewClient</code>修改为:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="c86b" class="jy jz hi jw b fi lg lh l li lj">datastoreClient,err = datastore.NewClient(ctx, <strong class="jw hj">datastore.DetectProjectID</strong>)</span></pre><p id="8dd9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这使用了一个sentinel <code class="du jt ju jv jw b">DetectProjectID</code>来检测项目ID，这在Flex和Cloud Run上都有效。</p><p id="040b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我建议我们通过用<code class="du jt ju jv jw b">log.Fatal(http.ListenAndServe(":8080", nil))</code>替换<code class="du jt ju jv jw b">appengine.Main()</code>来删除代码中的(不再需要的)App Engine特性</p><p id="c445" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了正确支持与云运行的契约，代码应该在运行时绑定到<code class="du jt ju jv jw b">${PORT}</code>的值，而不是假设它将是<code class="du jt ju jv jw b">:8080</code>，所以:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="1d37" class="jy jz hi jw b fi lg lh l li lj">port := os.Getenv("PORT")<br/>if port == "" {<br/> port = "8080"<br/>}<br/>...</span><span id="91ee" class="jy jz hi jw b fi lk lh l li lj">...<br/>log.Fatal(http.ListenAndServe(fmt.Sprintf(":%s", port), nil))</span></pre><p id="c4c3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">像以前一样部署和测试应用程序:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="c3e6" class="jy jz hi jw b fi lg lh l li lj">gcloud app deploy --project=$PROJECT --quiet</span></pre><p id="e76a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="e794" class="jy jz hi jw b fi lg lh l li lj">google-chrome <a class="ae jx" href="https://${PROJECT}.appspot.com/" rel="noopener ugc nofollow" target="_blank">https://${PROJECT}.appspot.com/</a></span></pre><figure class="ky kz la lb fd lm er es paragraph-image"><div class="er es ll"><img src="../Images/e8612621da6f0cf853499f9dc26056b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:940/format:webp/1*HCiJA7rLbtMUU57n3PJT7Q.png"/></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">浏览器</figcaption></figure><p id="f1fe" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">或者:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="1f5b" class="jy jz hi jw b fi lg lh l li lj">curl --request GET <a class="ae jx" href="https://${PROJECT}.appspot.com/" rel="noopener ugc nofollow" target="_blank">https://${PROJECT}.appspot.com/</a></span><span id="01da" class="jy jz hi jw b fi lk lh l li lj">Previous visits:<br/>[2019-05-01 21:28:59.877794 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:28:50.05074 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:28:49.055906 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:28:48.078109 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:28:46.903447 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:28:43.24112 +0000 UTC] 127.0.0.1:80</span><span id="11b6" class="jy jz hi jw b fi lk lh l li lj">Successfully stored an entry of the current request.</span></pre><p id="9803" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如他们所说，一切都井然有序！</p><h2 id="3f18" class="jy jz hi bd ka kb kc kd ke kf kg kh ki jg kj kk kl jk km kn ko jo kp kq kr ks bi translated">云运行</h2><p id="effd" class="pw-post-body-paragraph ix iy hi iz b ja kt ij jc jd ku im jf jg kv ji jj jk kw jm jn jo kx jq jr js hb bi translated">查找由App Engine Flex部署生成的容器映像。在我的例子中，使用美国地区:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="a30b" class="jy jz hi jw b fi lg lh l li lj">gcloud container images list \<br/>--repository=<strong class="jw hj">us</strong>.gcr.io/${PROJECT}/<strong class="jw hj">appengine</strong></span><span id="b9db" class="jy jz hi jw b fi lk lh l li lj">NAME<br/>us.gcr.io/${PROJECT}/appengine/default.20190501t123456</span></pre><p id="df41" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后(假设你只部署过一次应用):</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="0ac7" class="jy jz hi jw b fi lg lh l li lj">NAME="datastore"<br/>IMAGE=$(\<br/>  gcloud container images list \<br/>  --repository=us.gcr.io/${PROJECT}/appengine \<br/>  --project=${PROJECT} \<br/>  --format="value(name)"\<br/>)</span><span id="03e9" class="jy jz hi jw b fi lk lh l li lj">gcloud beta run deploy ${NAME} \<br/>--image=${IMAGE} \<br/>--allow-unauthenticated \<br/>--set-env-vars=GCLOUD_DATASET_ID=${PROJECT} \<br/>--region=us-central1 \<br/>--project=${PROJECT}</span></pre><p id="704c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦部署完毕:</p><figure class="ky kz la lb fd lm er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es lt"><img src="../Images/efde7846b94f3c5de3dea1a0295ecdd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u9x24YNL-PvzQhQkVbtU-Q.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">云运行</figcaption></figure><p id="ff6a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您应该能够用以下方式卷曲其端点:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="4733" class="jy jz hi jw b fi lg lh l li lj">ENDPOINT=$(\<br/>  gcloud beta run routes describe ${NAME} \<br/>  --region=us-central1 \<br/>  --project=${PROJECT} \<br/>  --format="value(status.address.hostname)"\<br/>)</span><span id="909e" class="jy jz hi jw b fi lk lh l li lj">curl --request GET ${ENDPOINT}</span></pre><p id="8664" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果一切顺利，您将获得:</p><pre class="ky kz la lb fd lc jw ld le aw lf bi"><span id="fcc1" class="jy jz hi jw b fi lg lh l li lj">Previous visits:<br/>[2019-05-01 21:46:27.600745 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:46:22.739562 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:46:09.907737 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:46:04.40004 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:44:57.54126 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:44:56.896966 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:29:01.646265 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:28:59.877794 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:28:50.05074 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:28:49.055906 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:28:48.078109 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:28:46.903447 +0000 UTC] 127.0.0.1:80<br/>[2019-05-01 21:28:43.24112 +0000 UTC] 127.0.0.1:80</span><span id="0a02" class="jy jz hi jw b fi lk lh l li lj">Successfully stored an entry of the current request.</span></pre><h2 id="37d7" class="jy jz hi bd ka kb kc kd ke kf kg kh ki jg kj kk kl jk km kn ko jo kp kq kr ks bi translated">在旁边</h2><p id="cdb9" class="pw-post-body-paragraph ix iy hi iz b ja kt ij jc jd ku im jf jg kv ji jj jk kw jm jn jo kx jq jr js hb bi translated">一旦App Engine Flex部署构建了容器映像并将其推送到容器注册表，您当然可以获取映像并将其部署到云运行。</p><p id="a429" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">具有讽刺意味且令人惊讶的是，由于控制平面不应如此不同，因此很容易在App Engine Flex编程完成之前将服务部署到云运行:-(</p><h2 id="687a" class="jy jz hi bd ka kb kc kd ke kf kg kh ki jg kj kk kl jk km kn ko jo kp kq kr ks bi translated">结论</h2><p id="3402" class="pw-post-body-paragraph ix iy hi iz b ja kt ij jc jd ku im jf jg kv ji jj jk kw jm jn jo kx jq jr js hb bi translated">正如我以前的教授常说的“在UNIX中，[ed:是的，我有那么老！]一切都是文件！”。结果是，如果你有操作文件的知识和工具，你可以用操作系统做任何事情。</p><p id="efc7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">容器是(云)服务的一个类似的抽象，和文件一样，一旦你知道如何操作容器，在云中做任何与计算相关的事情就变得相对简单了。</p><p id="a573" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">希望这篇后续文章有助于展示(谷歌的)容器服务的一致性。</p><p id="7a51" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">仅此而已！</p></div></div>    
</body>
</html>