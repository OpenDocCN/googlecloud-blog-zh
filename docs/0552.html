<html>
<head>
<title>Cloudprober</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云探测器</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloudprober-1c16b2d05835?source=collection_archive---------1-----------------------#2018-03-31">https://medium.com/google-cloud/cloudprober-1c16b2d05835?source=collection_archive---------1-----------------------#2018-03-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="cee0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个客户的架构师需要工具来帮助他诊断Kubernetes引擎集群中服务之间的尾部延迟的来源。我的同事给我指了指<a class="ae jd" href="https://cloudprober.github.io/" rel="noopener ugc nofollow" target="_blank">云探测器</a>。在我试图领先客户一步的徒劳尝试中，我想我应该用今天的深度学习时间来探索它。是谷歌OSS。这是用戈兰语写的。它浮出水面<a class="ae jd" href="https://prometheus.io" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a>端点。有什么不喜欢的！？很整洁！</p><h2 id="97b2" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">码头工人</h2><p id="7f9e" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">Cloudprober可以作为一个容器映像*使用，但是*我认为这个映像需要一个小的调整，以便能够提供定制配置和更好地支持Kubernetes。如果您对<code class="du ke kf kg kh b">cloudprober/cloudprober</code>图像有疑问，您可以使用<code class="du ke kf kg kh b">dazwilkin/cloudprober:0.9.3-32-g21f071e</code>。我将在此使用我的图像。</p><p id="f818" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">调整只是使用<code class="du ke kf kg kh b">ENTRYPOINT</code>来运行<code class="du ke kf kg kh b">cloudprober</code>而不是<code class="du ke kf kg kh b">CMD</code>，因为这允许我们自由地使用不同的标志来运行<code class="du ke kf kg kh b">cloudprober</code>。</p><h2 id="24dc" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">库伯内特斯</h2><p id="141b" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">我<a class="ae jd" rel="noopener" href="/@DazWilkin/stackdriver-profiler-671fb481236d">昨天写了</a>关于<a class="ae jd" href="https://cloud.google.com/profiler/" rel="noopener ugc nofollow" target="_blank"> Stackdriver Profiler </a>并提供了2个样本(Golang，Node。JS ),我将其作为服务部署到Kubernetes。从这里开始(但希望您可以适应您的Kubernetes服务)，我将为这些表面的HTTP端点(在端口<code class="du ke kf kg kh b">8080</code>上)配置探测器。主要是为了测试Cloudprober。</p><p id="1137" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的服务都部署到了<code class="du ke kf kg kh b">default</code>(我很懒)名称空间。Golang分析器被公开为一个名为<code class="du ke kf kg kh b">golang-profiler</code>的服务(这个服务有一个集群内DNS名称<code class="du ke kf kg kh b">golang-profiler.default.svc</code>)。节点。JS profiler被公开为一个名为<code class="du ke kf kg kh b">nodejs-profiler</code>的服务(该服务的集群内DNS名称为<code class="du ke kf kg kh b">nodejs-profiler.default.svc</code>)。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ki"><img src="../Images/1abec0024685cb006fc357bdfbffadab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UZ0aw29zHCdZ-4UJMvWpxw.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated">Kubernetes仪表板:“默认”名称空间服务</figcaption></figure><h2 id="00cf" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">旁白:左舷向前</h2><p id="5a1a" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">您可能希望跳过这一步，但是为了在本地测试cloud probe，一个简单但很好的技巧是通过ssh将cloud probe移植到服务的节点端口，检查配置，如果满意，将cloud probe部署到Kubernetes，并对它的工作更有信心。</p><p id="8b97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的bash命令获取集群中第一个节点的实例名、两个服务的节点端口，然后使用<code class="du ke kf kg kh b">gcloud</code>设置SSH端口转发，以便这些服务在<code class="du ke kf kg kh b">localhost</code>上的这些端口上可用:</p><pre class="kj kk kl km fd ky kh kz la aw lb bi"><span id="d4b7" class="je jf hi kh b fi lc ld l le lf">NODE_HOST=$(\<br/>  kubectl get nodes \<br/>  --output=jsonpath="{.items[0].metadata.name}")</span><span id="0de2" class="je jf hi kh b fi lg ld l le lf">GOLANG_PORT=$(\<br/>  kubectl get services/golang-profiler \<br/>  --output=jsonpath="{.spec.ports[0].nodePort}")</span><span id="6eef" class="je jf hi kh b fi lg ld l le lf">NODEJS_PORT=$(\<br/>  kubectl get services/nodejs-profiler \<br/>  --output=jsonpath="{.spec.ports[0].nodePort}")</span><span id="5632" class="je jf hi kh b fi lg ld l le lf">gcloud compute ssh ${NODE_HOST} \<br/>--project=${GOOGLE_PROJECT_ID} \<br/>--ssh-flag="-L ${GOLANG_PORT}:localhost:${GOLANG_PORT}" \<br/>--ssh-flag="-L ${NODEJS_PORT}:localhost:${NODEJS_PORT}"<br/></span></pre><p id="3f4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以我们现在可以编写一个Cloudprober配置文件(暂时使用这些端口)来测试Cloudprober:</p><p id="89f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">cloudprober.profilers.cfg:</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="lh li l"/></div></figure><blockquote class="lj lk ll"><p id="a7f9" class="if ig lm ih b ii ij ik il im in io ip ln ir is it lo iv iw ix lp iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>您需要用系统中的值替换第9行的<code class="du ke kf kg kh b">${GOLANG_PORT}</code>和第23行的<code class="du ke kf kg kh b">${NODEJS_PORT}</code>。</p><p id="991c" class="if ig lm ih b ii ij ik il im in io ip ln ir is it lo iv iw ix lp iz ja jb jc hb bi translated">第5行和第19行中的<code class="du ke kf kg kh b">host_names</code>值都是<code class="du ke kf kg kh b">localhost</code>，因为我们已经在本地对这些Kubernetes节点端口进行了端口转发。我已经留下了注释，当我部署到Kubernetes时，我们将需要使用(我的服务)这些值。</p></blockquote><p id="8541" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好的。我认为这不会起作用，除非你使用我的Cloudprober容器映像的调整版本。所以:</p><pre class="kj kk kl km fd ky kh kz la aw lb bi"><span id="ce21" class="je jf hi kh b fi lc ld l le lf">docker run \<br/>--net=host \<br/>--publish=9313:9313 \<br/>--volume=$PWD/cloudprober.profilers.cfg:/cloudprober.cfg \<br/>dazwilkin/cloudprober:0.9.3-32-g21f071e \<br/>  --config_file=/cloudprober.cfg \<br/>  --logtostderr</span></pre><blockquote class="lj lk ll"><p id="f30a" class="if ig lm ih b ii ij ik il im in io ip ln ir is it lo iv iw ix lp iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>需要<code class="du ke kf kg kh b">--net=host</code>标志，因为容器需要访问主机的<code class="du ke kf kg kh b">${GOLANG_PORT}</code>和<code class="du ke kf kg kh b">${NODEJS_PORT</code>端口。</p></blockquote><p id="765f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果一切正常，您将看到日志输出。更有用的是，您可能希望访问Cloudprober的Prometheus metrics端点。这将在以下位置提供:</p><p id="1d41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://localhost:9313" rel="noopener ugc nofollow" target="_blank">http://localhost:9313</a>/公制</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lq"><img src="../Images/dd72976ce0019465df94a9a1397a1f4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kTxjIouVrnxVKlb8onjQqg.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated">Cloudprober的普罗米修斯指标端点</figcaption></figure><p id="42e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想通过普罗米修斯查看这些数据:</p><p id="93cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">prometheus.yml:</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="96e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>和以前一样，请用你系统上的值替换第5行的<code class="du ke kf kg kh b">${GOLANG_PORT}</code>和lin 9中的<code class="du ke kf kg kh b">$(NODEJS_PORT}</code>。</p><p id="46fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么你可以在本地运行Prometheus(！)针对这些本地端点:</p><pre class="kj kk kl km fd ky kh kz la aw lb bi"><span id="4190" class="je jf hi kh b fi lc ld l le lf">docker run \<br/>--net=host \<br/>--publish=9090:9090 \<br/>--volume=$PWD/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus</span></pre><p id="7f57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并访问Prometheus目标以确认它们配置正确:</p><p id="749a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://localhost:9090/targets" rel="noopener ugc nofollow" target="_blank">http://localhost:9090/targets</a></p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lr"><img src="../Images/f416c14dd1bda246bfa63646789c70c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i5In1mT9pVhHky--oNrjTA.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated">普罗米修斯“目标”</figcaption></figure><p id="e9e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我会让你玩图形的神奇之处，但是:</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ls"><img src="../Images/7e45de2345c4ea5c36d07f1f13c70ca9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZPalLdZWnWsfb7k-wK6aQ.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated">普罗米修斯“图”</figcaption></figure><p id="e72b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好的。一切正常。</p><p id="6c19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你在这里完成了，你可以终止普罗米修斯集装箱，终止<code class="du ke kf kg kh b">gcloud compute ssh</code>港口-前进，整理，拍拍自己的背，继续前进。</p><p id="8576" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们部署到Kubernetes！</p><h2 id="afcf" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">库伯内特斯</h2><p id="9fc5" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">我们只需要修改Cloudprober配置来反映我们服务的集群内名称。</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="lh li l"/></div></figure><blockquote class="lj lk ll"><p id="2ce0" class="if ig lm ih b ii ij ik il im in io ip ln ir is it lo iv iw ix lp iz ja jb jc hb bi translated">N <strong class="ih hj"> B </strong>我已经修改了第5行和第19行的<code class="du ke kf kg kh b">host_names</code>值，以反映完整的(！)集群内DNS名称。我恢复了第9行和第23行中的<code class="du ke kf kg kh b">port</code>值，以反映服务端口(而不是用于脱离集群访问的节点端口)。</p></blockquote><p id="69fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要将Cloudprober映像部署到Kubernetes，但在此之前，我们需要上传配置。我们将使用配置映射来保存配置文件:</p><pre class="kj kk kl km fd ky kh kz la aw lb bi"><span id="708d" class="je jf hi kh b fi lc ld l le lf">kubectl create configmap cloudprober-profilers-config \<br/>--from-file=cloudprober.cfg=cloudprober.profilers.cfg</span></pre><p id="7a91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在您只需要一个部署。yaml:</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="9b4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以:</p><pre class="kj kk kl km fd ky kh kz la aw lb bi"><span id="b264" class="je jf hi kh b fi lc ld l le lf">kubectl apply --filename=deployment.yaml</span></pre><p id="a347" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好的……如果你愿意，你可以像我们之前做的那样，将<code class="du ke kf kg kh b">cloudprober</code>服务的节点端口进行端口转发。在这种情况下，让我们只看一下它的日志:</p><pre class="kj kk kl km fd ky kh kz la aw lb bi"><span id="ef51" class="je jf hi kh b fi lc ld l le lf">POD=$(\<br/>  kubectl get pods \<br/>  --selector=app=cloudprober-profilers \<br/>  --namespace=default \<br/>  --output=jsonpath="{.items[0].metadata.name}")</span><span id="f507" class="je jf hi kh b fi lg ld l le lf">kubectl logs pods/$POD cloudprober --follow</span></pre><p id="0233" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个(编辑的)日志示例:</p><pre class="kj kk kl km fd ky kh kz la aw lb bi"><span id="abf4" class="je jf hi kh b fi lc ld l le lf">cloudprober 1522451121742369580 1522451141 labels=ptype=http<br/>probe=nodejs-profiler<br/>dst=nodejs-profiler.default.svc.cluster.local total=1 success=1<br/>latency=97108.784 timeouts=0<br/>resp-code=map:code,200:1 resp-body=map:resp</span><span id="a51f" class="je jf hi kh b fi lg ld l le lf">cloudprober 1522451121742369585 1522451141 labels=ptype=http<br/>probe=golang-profiler<br/>dst=golang-profiler.default.svc.cluster.local total=1 success=1 latency=92348.214 timeouts=0<br/>resp-code=map:code,200:1 resp-body=map:resp</span><span id="5620" class="je jf hi kh b fi lg ld l le lf">cloudprober 1522451121742369592 1522451161 labels=ptype=http<br/>probe=nodejs-profiler<br/>dst=nodejs-profiler.default.svc.cluster.local total=2 success=2 latency=197668.887 timeouts=0<br/>resp-code=map:code,200:2 resp-body=map:resp</span><span id="3881" class="je jf hi kh b fi lg ld l le lf">cloudprober 1522451121742369593 1522451161 labels=ptype=http<br/>probe=golang-profiler<br/>dst=golang-profiler.default.svc.cluster.local total=2 success=2 latency=180111.898 timeouts=0<br/>resp-code=map:code,200:2 resp-body=map:resp</span></pre><p id="9776" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">伴随服务提供了一个提供Prometheus指标的端点。我将让您将Prometheus部署到您的集群并进行配置。</p><h2 id="5dd6" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">戈朗</h2><p id="1ea6" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">今天没有Golang代码:-(嗯，这不完全正确。只是还没准备好。我认为让Cloudprober基于特定名称空间中发布的服务进行自动配置会很有用。我有一个代码工作的粗略铸造，并希望下周在这里发表一些东西。我会及时更新这篇文章。</p><h2 id="f760" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">结论</h2><p id="348d" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">Cloudprober是一个有趣的工具，我打算在接下来的一周里花更多的时间来掌握它。</p></div></div>    
</body>
</html>