<html>
<head>
<title>How to build a recommendation system on e-commerce data using BigQuery ML</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用BigQuery ML构建基于电子商务数据的推荐系统</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-build-a-recommendation-system-on-e-commerce-data-using-bigquery-ml-df9af2b8c110?source=collection_archive---------0-----------------------#2020-07-13">https://medium.com/google-cloud/how-to-build-a-recommendation-system-on-e-commerce-data-using-bigquery-ml-df9af2b8c110?source=collection_archive---------0-----------------------#2020-07-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3682" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了BigQuery中的数据，机器学习工作流现在比以往任何时候都更容易。在这篇文章中，你将学习如何使用矩阵分解在零售场景中构建产品推荐系统，以及如何使用预测的推荐来推动营销活动。</p><h1 id="25d7" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">为什么推荐系统如此重要？</h1><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/cc6f1d846d207551e5849fc8c191d152.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sZTLfKzKRmMOSL-2"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx translated">照片由<a class="kr ks ge" href="https://medium.com/u/92410629f98b?source=post_page-----df9af2b8c110--------------------------------" rel="noopener" target="_blank">茹碧森</a>:【https://unsplash.com/photos/Q59HmzK38eQ T2】拍摄</figcaption></figure><p id="1153" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如今，大多数消费者都期望个性化，希望看到与其兴趣相关的产品和服务。自然，他们也可以帮助企业。通过学习用户的行为和偏好，企业可以通过各种方式提供他们的建议，包括个性化优惠券、营销电子邮件和搜索结果，或有针对性的广告。最终，这使得企业能够通过有针对性的交叉销售或追加销售来吸引更多的客户支出，同时通过营销不相关的产品来降低不必要的成本。</p><blockquote class="ku kv kw"><p id="fad2" class="if ig kx ih b ii ij ik il im in io ip ky ir is it kz iv iw ix la iz ja jb jc hb bi translated"><em class="hi">“未能向客户展示他们了解他们以及他们的购买偏好的公司，可能会将业务输给更了解客户需求的竞争对手。”<br/>——哈佛商业评论。“个性化时代”。2018年9月</em></p></blockquote><h1 id="0a79" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">推荐系统是如何工作的？</h1><p id="88e0" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">基于用户偏好，矩阵分解(协同过滤)是创建推荐系统的最常见和最有效的方法之一。有关它们如何工作的更多信息，请参见<a class="ae kt" href="https://developers.google.com/machine-learning/recommendation/collaborative/matrix" rel="noopener ugc nofollow" target="_blank">这里的推荐系统介绍</a>。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es lg"><img src="../Images/03e56e4b60e4cca8a05cbc00a8256df6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pf7sy-QuSW6Ig88qpQ8vkw.png"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx translated"><a class="ae kt" href="https://developers.google.com/machine-learning/recommendation/collaborative/matrix" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/machine-learning/recommendation/collaborative/matrix</a></figcaption></figure><h1 id="97c4" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">什么是BigQuery ML？</h1><p id="6435" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated"><a class="ae kt" href="https://cloud.google.com/bigquery-ml/docs/bigqueryml-intro" rel="noopener ugc nofollow" target="_blank"> BigQuery ML </a>使用户能够通过使用标准的SQL查询在BigQuery中创建和执行机器学习模型。这意味着，如果你的数据已经在BigQuery中，你不需要导出你的数据来训练和部署机器学习模型——通过训练，你也在同一步骤中进行部署。结合BigQuery的计算资源自动扩展功能，您将不必担心启动集群或构建模型培训和部署管道。这意味着您将节省构建机器学习管道的时间，使您的企业能够更多地关注机器学习的价值，而不是花时间建立基础设施。</p><p id="894c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可能也听说过<a class="ae kt" href="https://cloud.google.com/recommendations" rel="noopener ugc nofollow" target="_blank">推荐AI </a>，这是一款谷歌云产品，专门用于在网站上使用最先进的深度学习模型进行实时推荐。另一方面，使用BigQuery ML的矩阵分解是一种更通用的ML算法，可用于离线和在线推荐(例如，个性化电子邮件活动)。</p><h1 id="3e51" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">使用BigQuery ML在电子商务数据上训练和部署矩阵分解模型</h1><p id="6684" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">让我们来看一个例子，如何根据用户在网上商店浏览某个产品的时间来确定你会向用户推荐哪些其他产品。你也可以点击查看这篇博文的<a class="ae kt" href="https://github.com/GoogleCloudPlatform/analytics-componentized-patterns/blob/master/retail/recommendation-system/bqml/bqml_retail_recommendation_system.ipynb" rel="noopener ugc nofollow" target="_blank"> Jupyter笔记本版本。</a></p><h1 id="52c3" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">数据</h1><p id="6b4c" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">在BigQuery上公开托管的<a class="ae kt" href="https://console.cloud.google.com/marketplace/details/obfuscated-ga360-data/obfuscated-ga360-data?filter=solution-type:dataset" rel="noopener ugc nofollow" target="_blank">谷歌分析样本数据集</a>是一个数据集，它提供了12个月(2016年8月至2017年8月)来自<a class="ae kt" href="https://www.googlemerchandisestore.com/" rel="noopener ugc nofollow" target="_blank">谷歌商品商店</a>的模糊谷歌分析360数据，这是一个销售谷歌品牌商品的真实电子商务商店。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es lh"><img src="../Images/7a1dfc2de41aa1a476455ac7a606b5f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QlzMX9HAkGcAB9dHrLQ0Eg.png"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx translated">来自<a class="ae kt" href="http://www.googlemerchandisestore.com" rel="noopener ugc nofollow" target="_blank">谷歌商品商店</a>的截图。</figcaption></figure><p id="e4db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是来自谷歌分析的一些原始数据样本:</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es li"><img src="../Images/8dcf0dadaa6498b06f1feaac2ced7541.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_Rc-Q3bBtv2GSBTY"/></div></div></figure><h1 id="4615" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">预处理数据</h1><p id="bfe1" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">基于用户反馈的种类，有两种类型的矩阵分解:显式和隐式。通过显式反馈，数据集必须表明用户对产品的偏好，比如1到5颗星之间的评级。</p><p id="3b49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除非大量用户提供产品评论，否则没有或没有足够的明确反馈来说明用户对产品的喜欢程度。在这种情况下，需要使用其他行为指标来<em class="kx">推断</em>他们的隐含偏好。推断对产品的兴趣的一种方式是考虑用户在产品详情页面上花费的总时间(例如，会话持续时间)。</p><h2 id="f3c4" class="lj je hi bd jf lk ll lm jj ln lo lp jn iq lq lr jr iu ls lt jv iy lu lv jz lw bi translated">训练数据应该是什么样的？</h2><p id="911b" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">使用矩阵分解，为了训练模型，您将需要一个包含<strong class="ih hj"> userId </strong>、<strong class="ih hj"> itemId </strong>和<strong class="ih hj"> rating </strong>的表。在本例中，产品页面上的会话持续时间将用作隐式评级。如果您有其他指标(例如，页面浏览量的频率)，您可以简单地使用加权和将这些指标组合在一起，以计算评级值。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es lx"><img src="../Images/c13a763fdf5660e582ca11d0c0d878a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xhKsTfQg0AKBiku5"/></div></div></figure><p id="614c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kx">用于矩阵分解的已清理训练数据的示例，<br/>其中产品页面上的会话持续时间(以毫秒计)被用作隐式评级</em></p><p id="e486" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用Google Analytics示例，我们可以创建一个包含预处理培训数据的表:</p><pre class="kc kd ke kf fd ly lz ma mb aw mc bi"><span id="045b" class="lj je hi lz b fi md me l mf mg">## follows schema from <a class="ae kt" href="https://support.google.com/analytics/answer/3437719?hl=en&amp;ref_topic=3416089" rel="noopener ugc nofollow" target="_blank">https://support.google.com/analytics/answer/3437719?hl=en&amp;ref_topic=3416089</a></span><span id="c0eb" class="lj je hi lz b fi mh me l mf mg">CREATE OR REPLACE TABLE bqml.aggregate_web_stats AS (<br/>  WITH<br/>    durations AS (<br/>      --calculate pageview durations<br/>      SELECT<br/>        CONCAT(fullVisitorID,'-', <br/>             CAST(visitNumber AS STRING),'-', <br/>             CAST(hitNumber AS STRING) ) AS visitorId_session_hit,<br/>        LEAD(time, 1) OVER (<br/>          PARTITION BY CONCAT(fullVisitorID,'-',CAST(visitNumber AS STRING))<br/>          ORDER BY<br/>          time ASC ) - time AS pageview_duration<br/>      FROM<br/>        `bigquery-public-data.google_analytics_sample.ga_sessions_2016*`,<br/>        UNNEST(hits) AS hit <br/>    ),<br/>      <br/>    prodview_durations AS (<br/>      --filter for product detail pages only<br/>      SELECT<br/>        CONCAT(fullVisitorID,'-',CAST(visitNumber AS STRING)) AS visitorId,<br/>        productSKU AS itemId,<br/>        IFNULL(dur.pageview_duration,<br/>          1) AS pageview_duration,<br/>      FROM<br/>        `bigquery-public-data.google_analytics_sample.ga_sessions_2016*` t,<br/>        UNNEST(hits) AS hits,<br/>        UNNEST(hits.product) AS hits_product<br/>      JOIN<br/>        durations dur<br/>      ON<br/>        CONCAT(fullVisitorID,'-',<br/>               CAST(visitNumber AS STRING),'-',<br/>               CAST(hitNumber AS STRING)) = dur.visitorId_session_hit<br/>      WHERE<br/>      #action_type: Product detail views = 2<br/>      eCommerceAction.action_type = "2" <br/>    ),<br/>    <br/>    aggregate_web_stats AS(<br/>      --sum pageview durations by visitorId, itemId<br/>      SELECT<br/>        visitorId,<br/>        itemId,<br/>        SUM(pageview_duration) AS session_duration<br/>      FROM<br/>        prodview_durations<br/>      GROUP BY<br/>        visitorId,<br/>        itemId )<br/>    SELECT<br/>      *<br/>    FROM<br/>      aggregate_web_stats<br/>);</span><span id="6abf" class="lj je hi lz b fi mh me l mf mg">-- Show table<br/>SELECT<br/>  *<br/>FROM<br/>  bqml.aggregate_web_stats<br/>LIMIT<br/>  10</span></pre><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es mi"><img src="../Images/b7fcaadfc9f9569b1ad80591b77db6e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*npI10bbRfRSt22c6"/></div></div></figure><p id="2043" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们准备训练矩阵分解模型。</p><p id="d114" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你喜欢用Jupyter笔记本格式看这篇博文，你可以直接在Github上查看:</p><p id="dc65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae kt" href="https://github.com/GoogleCloudPlatform/analytics-componentized-patterns/blob/master/retail/recommendation-system/bqml/bqml_retail_recommendation_system.ipynb" rel="noopener ugc nofollow" target="_blank">https://github . com/Google cloud platform/analytics-componented-patterns/blob/master/retail/recommendation-system/bqml/bqml _ retail _ recommendation _ system . ipynb</a></p><h1 id="0faf" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">在BigQuery ML中训练矩阵分解模型</h1><p id="78a6" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">若要定型矩阵分解模型(使用隐式反馈)，您需要设置选项:</p><ul class=""><li id="348e" class="mj mk hi ih b ii ij im in iq ml iu mm iy mn jc mo mp mq mr bi translated"><code class="du ms mt mu lz b">model_type</code>:‘矩阵分解’</li><li id="3660" class="mj mk hi ih b ii mv im mw iq mx iu my iy mz jc mo mp mq mr bi translated"><code class="du ms mt mu lz b">user_col</code> : &lt;用户栏目名称&gt;</li><li id="e22a" class="mj mk hi ih b ii mv im mw iq mx iu my iy mz jc mo mp mq mr bi translated"><code class="du ms mt mu lz b">item_col</code> : &lt;项目列名&gt;</li><li id="5c64" class="mj mk hi ih b ii mv im mw iq mx iu my iy mz jc mo mp mq mr bi translated"><code class="du ms mt mu lz b">rating_col</code> : &lt;评级栏目名称&gt;</li><li id="417f" class="mj mk hi ih b ii mv im mw iq mx iu my iy mz jc mo mp mq mr bi translated"><code class="du ms mt mu lz b">feedback_type</code>:‘隐式’(默认为‘显式’)</li></ul><p id="a163" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要了解训练模型时参数的更多信息，请阅读关于矩阵分解的CREATE MODEL语句的<a class="ae kt" href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create-matrix-factorization" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><pre class="kc kd ke kf fd ly lz ma mb aw mc bi"><span id="4c05" class="lj je hi lz b fi md me l mf mg">CREATE OR REPLACE MODEL bqml.retail_recommender<br/>OPTIONS(model_type='matrix_factorization', <br/>        user_col='visitorId', <br/>        item_col='itemId',<br/>        rating_col='session_duration',<br/>        feedback_type='implicit'<br/>        )<br/>AS<br/>SELECT * FROM bqml.aggregate_web_stats</span></pre><p id="609c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kx">注意</em> : <em class="kx">您可能需要设置预约时段。有关更多信息，您可以阅读如何以编程方式</em>  <em class="kx">或通过</em><a class="ae kt" href="https://cloud.google.com/bigquery/docs/reservations-workload-management#getting-started-with-bigquery-reservations" rel="noopener ugc nofollow" target="_blank"><em class="kx">big query UI</em></a><em class="kx">设置flex slots </em> <a class="ae kt" rel="noopener" href="/google-cloud/optimize-bigquery-costs-with-flex-slots-e06ec5e4aa90">。</a></p><h1 id="ea41" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">模型评估</h1><p id="e82d" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">完成培训后，我们的模型现在已经部署好了(作为bqml.retail_commender)。您可以检查从模型评估中得到的度量。</p><p id="f0c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有关这些指标的更多信息，请阅读<a class="ae kt" href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate" rel="noopener ugc nofollow" target="_blank"> ML。在此评估文档</a>。</p><pre class="kc kd ke kf fd ly lz ma mb aw mc bi"><span id="328b" class="lj je hi lz b fi md me l mf mg">SELECT<br/>  *<br/>FROM<br/>  ML.EVALUATE(MODEL bqml.retail_recommender)</span></pre><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es li"><img src="../Images/308787706f3a922de0f4abc02af1f792.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Dd04r-kPk3bjWCPR"/></div></div></figure><h1 id="15ae" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">超参数调谐</h1><p id="8242" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">如果您想要改进您的模型，您可以调整的一些超参数是:</p><ul class=""><li id="b0ef" class="mj mk hi ih b ii ij im in iq ml iu mm iy mn jc mo mp mq mr bi translated"><code class="du ms mt mu lz b">NUM_FACTORS</code>:指定用于矩阵分解模型的潜在因子数(int64_value)</li><li id="2dd8" class="mj mk hi ih b ii mv im mw iq mx iu my iy mz jc mo mp mq mr bi translated"><code class="du ms mt mu lz b">L2_REG</code>:应用的L2正则化量(float64_value)</li><li id="c1cc" class="mj mk hi ih b ii mv im mw iq mx iu my iy mz jc mo mp mq mr bi translated"><code class="du ms mt mu lz b">WALS_ALPHA</code>:隐式矩阵分解模型的超参数(float64_value)</li></ul><p id="c0b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看<a class="ae kt" href="https://towardsdatascience.com/how-to-do-hyperparameter-tuning-of-a-bigquery-ml-model-29ba273a6563" rel="noopener" target="_blank">这篇博文，了解BigQuery ML </a>中超参数调优的更多信息。</p><h1 id="1b47" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">使用ML进行预测。推荐</h1><p id="3e66" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">让我们快速检查一下产生的建议是什么样的。您可以向特定访问者推荐的前5项是什么？请注意，我使用了一点儿<a class="ae kt" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting" rel="noopener ugc nofollow" target="_blank"> SQL脚本</a>来帮助我们检查特定的访问者。</p><pre class="kc kd ke kf fd ly lz ma mb aw mc bi"><span id="248b" class="lj je hi lz b fi md me l mf mg">DECLARE MY_VISITORID STRING DEFAULT "0824461277962362623-1";</span><span id="40ed" class="lj je hi lz b fi mh me l mf mg">SELECT<br/>  *<br/>FROM<br/>  ML.RECOMMEND(MODEL `bqml.retail_recommender`,<br/>      (SELECT MY_VISITORID as visitorID)<br/>              )<br/>ORDER BY predicted_session_duration_confidence DESC<br/>LIMIT 5</span></pre><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es na"><img src="../Images/dddd07c6405706a0b04655017a513c96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hfBwu8PG5a-_PiK8"/></div></div></figure><p id="680b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按照可信度分数降序排列，显示了这个特定访问者Id的前5个项目。</p><p id="0a26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们通过加入productSKU来添加产品名称，这样我们就可以看到推荐的产品实际上是什么:</p><pre class="kc kd ke kf fd ly lz ma mb aw mc bi"><span id="17fd" class="lj je hi lz b fi md me l mf mg">DECLARE<br/>  MY_VISITORID STRING DEFAULT "6499749315992064304-2";<br/>WITH<br/>  product_details AS(<br/>  SELECT<br/>    productSKU,<br/>    v2ProductName,<br/>  FROM<br/>    `bigquery-public-data.google_analytics_sample.ga_sessions_2016*`,<br/>    UNNEST(hits) AS hits,<br/>    UNNEST(hits.product) AS hits_product<br/>  GROUP BY<br/>    2,<br/>    1 )<br/>SELECT<br/>  r.*,<br/>  d.v2ProductName<br/>FROM<br/>  ML.RECOMMEND(MODEL `bqml.retail_recommender`,<br/>    (<br/>    SELECT<br/>      MY_VISITORID AS visitorId)) r<br/>JOIN<br/>  product_details d<br/>ON<br/>  r.itemId = d.productSKU<br/>ORDER BY<br/>  predicted_session_duration_confidence DESC<br/>LIMIT<br/>  5</span></pre><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es nb"><img src="../Images/e03a719143d3f1baefd7fda77c35aa5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WkDXrTWLJ5nV3AX4HCw4PQ.png"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx translated">向该访客推荐的产品</figcaption></figure><p id="f32a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对所有游客呢？由于结果输出可能有点大，我将结果输出到一个表中:</p><pre class="kc kd ke kf fd ly lz ma mb aw mc bi"><span id="c506" class="lj je hi lz b fi md me l mf mg">-- Create output table of top 5 predictions<br/>CREATE OR REPLACE TABLE bqml.prod_recommendations AS (<br/>WITH predictions AS (<br/>    SELECT <br/>      visitorId, <br/>      ARRAY_AGG(STRUCT(itemId, <br/>                       predicted_session_duration_confidence)<br/>                ORDER BY <br/>                  predicted_session_duration_confidence DESC<br/>                LIMIT 5) as recommended<br/>    FROM ML.RECOMMEND(MODEL bqml.retail_recommender)<br/>    GROUP BY visitorId<br/>)</span><span id="727b" class="lj je hi lz b fi mh me l mf mg">SELECT<br/>  visitorId,<br/>  itemId,<br/>  predicted_session_duration_confidence<br/>FROM<br/>  predictions p,<br/>  UNNEST(recommended)<br/>);</span><span id="be0e" class="lj je hi lz b fi mh me l mf mg">-- Show table<br/>SELECT<br/>  *<br/>FROM<br/>  bqml.prod_recommendations<br/>ORDER BY <br/>  visitorId<br/>LIMIT<br/>  10</span></pre><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es nc"><img src="../Images/3c6b2c92e234925f40091a91800ac4c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*88AmXuScgzTOB7Td"/></div></div></figure><h1 id="804a" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">在生产中使用预测的建议</h1><p id="7a66" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">一旦有了建议，插入生产管道将取决于您的用例。</p><p id="7ae3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是一些可能帮助你开始的方法:</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es nd"><img src="../Images/4960ff7bb9e4d080eb92f7087237d45c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_udFSQH3cMp7eMEERFY9SQ.png"/></div></div></figure><p id="a039" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> A .营销激活的出口建议</strong></p><ol class=""><li id="67bb" class="mj mk hi ih b ii ij im in iq ml iu mm iy mn jc ne mp mq mr bi translated">通过谷歌广告、显示和视频360和搜索广告360激活</li><li id="0b4e" class="mj mk hi ih b ii mv im mw iq mx iu my iy mz jc ne mp mq mr bi translated">通过电子邮件激活</li></ol><p id="0c18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> B .从BigQuery导出建议的其他方式</strong></p><ol class=""><li id="0dbd" class="mj mk hi ih b ii ij im in iq ml iu mm iy mn jc ne mp mq mr bi translated">对熊猫数据帧的大查询</li><li id="76d1" class="mj mk hi ih b ii mv im mw iq mx iu my iy mz jc ne mp mq mr bi translated">将预测导出到Google云存储</li></ol><p id="0b62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过将来自BigQuery ML的预测结果导出回Google Analytics，您将能够通过广告、搜索或电子邮件激活更有效地产生定制的再营销受众和目标客户。</p><h1 id="8d76" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">A-1。将推荐导出到Google Analytics 360 (Google营销平台)</h1><h2 id="da0a" class="lj je hi bd jf lk ll lm jj ln lo lp jn iq lq lr jr iu ls lt jv iy lu lv jz lw bi translated">为Google Analytics 360格式化数据</h2><p id="e8b3" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">您可能需要将数据输出格式化为Google Analytics可以直接使用的格式，例如:</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es nf"><img src="../Images/14b70c1e509ca651996227fc468a4889.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RKf5Qx8w79Q4zBUi"/></div></div></figure><p id="ad1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个针对itemId <code class="du ms mt mu lz b">GGOEYOLR018699</code>的示例查询，它使用<a class="ae kt" href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-preprocessing-functions#mlmin_max_scaler" rel="noopener ugc nofollow" target="_blank"> ML对0和1之间的置信度得分进行归一化。最小_最大_缩放器</a>:</p><pre class="kc kd ke kf fd ly lz ma mb aw mc bi"><span id="e15d" class="lj je hi lz b fi md me l mf mg">WITH predictions AS (<br/>    SELECT <br/>      visitorId, <br/>      ARRAY_AGG(STRUCT(itemId, <br/>                       predicted_session_duration_confidence)<br/>                ORDER BY <br/>                  predicted_session_duration_confidence) as recommended<br/>    FROM ML.RECOMMEND(MODEL bqml.retail_recommender)<br/>    WHERE itemId = "GGOEYOLR018699"<br/>    GROUP BY visitorId<br/>)<br/>  <br/>SELECT<br/>  visitorId,<br/>  ML.MIN_MAX_SCALER(predicted_session_duration_confidence) OVER() as GGOEYOLR018699<br/>FROM<br/>  predictions p,<br/>  UNNEST(recommended)<br/>ORDER BY GGOEYOLR018699 DESC</span></pre><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es ng"><img src="../Images/aaeb6344d0c40b47f628f3348721c039.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iw97o6Sn_x3JdzRx"/></div></div></figure><p id="ddcc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要为每个产品创建一个列，您可以使用pivot()函数，如<a class="ae kt" href="https://towardsdatascience.com/easy-pivot-in-bigquery-one-step-5a1f13c6c710" rel="noopener" target="_blank">这篇博文</a>中所述。</p><p id="6e86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于Google Analytics数据导入，建议您使用clientId作为关键字，以及显示一些倾向得分的各个列。换句话说，您可能需要为您感兴趣推荐的每个产品创建一个新的专栏，并在Google Analytics中创建一个自定义维度，然后用于建立您的受众。最好确保每个clientId有一行。如果您知道要将预测导出到Google Analytics，建议您直接使用clientId而不是visitorId来训练您的模型。</p><p id="5fd3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">将数据从BigQuery导出到Google Analytics 360 </strong></p><p id="9cdc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将BigQuery ML预测从BigQuery表导出到Google Analytics 360的最简单方法是使用<a class="ae kt" href="https://github.com/google/modem" rel="noopener ugc nofollow" target="_blank">调制解调器(营销模型部署)</a>参考实现。MoDeM帮助您将数据加载到Google Analytics中，以便最终在Google Ads中激活，显示&amp;视频360和搜索广告360</p><p id="2b28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要从BigQuery导出到Google Analytics 360:</p><ul class=""><li id="cf04" class="mj mk hi ih b ii ij im in iq ml iu mm iy mn jc mo mp mq mr bi translated"><a class="ae kt" href="https://github.com/google/modem/tree/master/bqml" rel="noopener ugc nofollow" target="_blank">按照这里的逐步说明</a>使用调制解调器构建从BigQuery ML到Google Analytics的ETL管道。您也可以在本<a class="ae kt" href="https://colab.research.google.com/github/google/modem/blob/master/bqml/utils/BQML_Deployment_Template_Cloud_Function.ipynb" rel="noopener ugc nofollow" target="_blank">笔记本</a>中查看互动说明。</li></ul><h2 id="5c6f" class="lj je hi bd jf lk ll lm jj ln lo lp jn iq lq lr jr iu ls lt jv iy lu lv jz lw bi translated">A-2。使用Salesforce营销云激活电子邮件</h2><p id="68df" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">由于Google Analytics不包含电子邮件地址，您可能需要与Salesforce Marketing Cloud等第三方平台集成来激活电子邮件。</p><p id="2088" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Analytics 360客户可以在Salesforce直销渠道(电子邮件和短信)上的营销云中激活他们的Analytics 360受众。这使您的营销团队能够基于在线网络行为建立受众，并通过电子邮件和短信与这些客户互动。</p><p id="48f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">遵循此处的<a class="ae kt" href="https://support.google.com/analytics/answer/9250031?hl=en" rel="noopener ugc nofollow" target="_blank">逐步说明</a>将Google Analytics 360与Salesforce营销云集成，或通过Salesforce Trailhead 了解更多关于<a class="ae kt" href="https://trailhead.salesforce.com/content/learn/modules/google-analytics-360-integration-for-marketing-cloud" rel="noopener ugc nofollow" target="_blank">受众激活的信息。</a></p><h1 id="472a" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">B.从BigQuery导出建议的其他方法</h1><h2 id="4174" class="lj je hi bd jf lk ll lm jj ln lo lp jn iq lq lr jr iu ls lt jv iy lu lv jz lw bi translated">B-1。对熊猫数据帧的大查询</h2><p id="8325" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">将预测存储在一个单独的表中，您可以使用BigQuery存储API将数据导出到Pandas dataframe中(参见<a class="ae kt" href="https://cloud.google.com/bigquery/docs/bigquery-storage-python-pandas#download_table_data_using_the_client_library" rel="noopener ugc nofollow" target="_blank">文档和代码示例</a>)。也可以使用<a class="ae kt" href="https://cloud.google.com/bigquery/docs/reference/libraries" rel="noopener ugc nofollow" target="_blank">其他BigQuery客户端库</a>。</p><h2 id="cc3c" class="lj je hi bd jf lk ll lm jj ln lo lp jn iq lq lr jr iu ls lt jv iy lu lv jz lw bi translated">B-2。将预测表导出到Google云存储</h2><p id="f445" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">有几种方法可以将预测表导出到Google云存储，以便您可以在单独的服务中使用它们。此<a class="ae kt" href="https://cloud.google.com/bigquery/docs/exporting-data#exporting_table_data" rel="noopener ugc nofollow" target="_blank">文档</a>向您展示了如何使用<code class="du ms mt mu lz b">bq extract</code>命令导出。</p><h1 id="6643" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">摘要</h1><p id="3d83" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">恭喜你！现在，您已经知道如何使用BigQuery ML训练您的推荐系统，评估您的模型，调优超参数和部署您的模型，并在生产中使用结果。现在，您的企业离为客户提供更加个性化的服务又近了一步。</p><h1 id="35e0" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">想要更多吗？</h1><p id="1bf5" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">请给我留下您的意见和任何建议或更正。</p><p id="b207" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我是Polong Lin，谷歌云的开发者倡导者。在<a class="ae kt" href="http://www.twitter.com/polonglin" rel="noopener ugc nofollow" target="_blank"> @polonglin </a>上关注我，以及所有关于reddit.com/r/bigquery.的BigQuery</p><p id="5184" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">感谢审稿人</strong> : Abhishek Kashyap，Lak Lakshmanan，Tai Conley，Rebecca Gutteridge，Oly Bhaumik，Marc Cohen，Tahir Fayyaz，Felipe Hoffa。</p></div></div>    
</body>
</html>