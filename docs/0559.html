<html>
<head>
<title>Stackdriver Custom Metrics in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python中的Stackdriver自定义指标</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/stackdriver-custom-metrics-in-python-30fafb585a1d?source=collection_archive---------1-----------------------#2018-04-04">https://medium.com/google-cloud/stackdriver-custom-metrics-in-python-30fafb585a1d?source=collection_archive---------1-----------------------#2018-04-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1261" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为<a class="ae jd" href="https://youtube.com/GCPLive" rel="noopener ugc nofollow" target="_blank"> GCP直播</a>团队的一员，我最近在这个会议上介绍了Stackdriver监控API的基础知识，并展示了如何在Node.js(或者是node.js？).</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="jj jk l"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">GCP在线会议#51:堆栈驱动自定义指标</figcaption></figure><p id="a92f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">会议结束后，我意识到我总是在Node中做这些事情，而Node实际上似乎并不像Python那样广泛用于这种“快速点击”演示。因此，在对Python几乎一无所知的情况下，我开始在那里复制一个类似的演示。</p><p id="6f5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你有兴趣看到结果，你可以在这里看到GitHub回购<a class="ae jd" href="https://github.com/yuriatgoogle/stackdriver-custom-metrics" rel="noopener ugc nofollow" target="_blank">。它现在包含了原始的Node.js代码和我将在这里介绍的Python代码。</a></p><p id="2e8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用了两种资源来完成这项工作。第一个是Miguel Grinberg的这个神奇的烧瓶教程。我需要这个，因为当我开始的时候，我完全不知道如何用Python构建一个简单的web应用程序。第二个是Stackdriver监控客户端<a class="ae jd" href="https://cloud.google.com/monitoring/docs/reference/libraries" rel="noopener ugc nofollow" target="_blank">文档</a>的Python部分。有了这两个，我就有足够的时间来构建一个非常简单的带有表单输入的web页面，它接受输入的值，并将其作为自定义的时间序列度量发送给Stackdriver。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jp"><img src="../Images/42ee0d084d5bf2d3ae6520d1acb7a02a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ssLIHu7o7S4pM3POG7e0TQ.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">一个孤独的数据点</figcaption></figure><p id="deae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用乔恩·洛维特的不朽名言来说——让我们开始吧。</p><p id="dc98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第1部分—环境设置</strong></p><p id="d34a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我完全不知道我在用Python做什么，所以我不得不从头开始。谢天谢地，米格尔的<a class="ae jd" href="https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world" rel="noopener ugc nofollow" target="_blank">教程</a>也从那里开始。我真的不需要在这里重现，但基本步骤包括:</p><ol class=""><li id="3b9f" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kb kc kd ke bi translated">安装Python——我没有这样做，因为我的Mac已经安装了它。</li><li id="394a" class="jw jx hi ih b ii kf im kg iq kh iu ki iy kj jc kb kc kd ke bi translated">创建虚拟环境——这是Python特有的事情(我从未在Node.js中做过类似的事情，它将包保存在项目的本地)。</li><li id="6b1a" class="jw jx hi ih b ii kf im kg iq kh iu ki iy kj jc kb kc kd ke bi translated">安装Flask和其他几个包——在没有它的情况下，我遇到了一堆权限问题，于是我使用了<code class="du kk kl km kn b">--user</code>选项。</li></ol><p id="c7a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第2部分—网络“应用程序”</strong></p><p id="6a87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在这里把“app”放在引号中，因为我构建的东西勉强够得上这个名字。我四处询问，被告知Flask是我应该使用的框架，因为我对Express有点满意，它看起来很适合，特别是因为它使用了(我认为的)相同的路由概念。当然，我弄错了，它们实际上并不是一回事——但这足以让我绞尽脑汁。</p><p id="1eb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我真正关心的事情是调用监控API，所以我没有花太多时间来使应用程序本身有吸引力，特别是功能性，或者以任何方式有趣。看起来是这样的:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ko"><img src="../Images/8290642996aacd3be58391512a95e5a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/format:webp/1*ettjH9e2B_DNCqphoxyP2Q.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">现代网络表单的典范</figcaption></figure><p id="998a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我真的不认为有人在这里是为了Python教程中的Flask和/或Web开发，所以我将再次向您推荐Miguel的优秀作品。你可以在<a class="ae jd" href="https://github.com/yuriatgoogle/stackdriver-custom-metrics" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上看到我实现的细节，但这是这个应用程序如何构建的主要要点:</p><ul class=""><li id="7936" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kp kc kd ke bi translated"><a class="ae jd" href="https://github.com/yuriatgoogle/stackdriver-custom-metrics/blob/master/app/__init__.py" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> __init__。py </strong> </a>文件相当简单:</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kq"><img src="../Images/3083fdd74f3f8afda5bb24e8144e9590.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4CGd2zieEm9WgZTqXXq1ig.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">__init__。巴拉圭</figcaption></figure><ul class=""><li id="52ab" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kp kc kd ke bi translated">输入表单在<a class="ae jd" href="https://github.com/yuriatgoogle/stackdriver-custom-metrics/blob/master/app/forms.py" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> forms.py </strong> </a>中定义:</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kr"><img src="../Images/649064d9ce647be11cbc0ce00a684c17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EmjychIeE3dey31ggfOxHw.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">forms.py</figcaption></figure><ul class=""><li id="5d9c" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kp kc kd ke bi translated">接下来，这里是要提供的实际的<a class="ae jd" href="https://github.com/yuriatgoogle/stackdriver-custom-metrics/blob/master/app/templates/index_python.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> html </strong> </a>页面:</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ks"><img src="../Images/a194b3a1394d936632eae6960c8998bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qzzJbgaEnfjA6HzEqsYR4w.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">超文本标记语言</figcaption></figure><ul class=""><li id="7344" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kp kc kd ke bi translated">最后，<a class="ae jd" href="https://github.com/yuriatgoogle/stackdriver-custom-metrics/blob/master/app/routes.py" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> routes.py </strong> </a>是实际app逻辑所在</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kt"><img src="../Images/14c67e704fe998718c1ad07d970cce60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0EpRXuLrvcKPkPq_lcAdwg.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">处理初始GET、后续的表单POST和…</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ku"><img src="../Images/4ca41a1e7298113fab49481109f16175.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ULXj4gg1ZvEDBgwE1sbZng.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">…处理完表单数据后，重定向回原始页面</figcaption></figure><p id="23e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第3部分—调用监控API </strong></p><p id="f66d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们有了一个可以运行的应用程序</p><ul class=""><li id="75c0" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kp kc kd ke bi translated">为主页服务</li><li id="5320" class="jw jx hi ih b ii kf im kg iq kh iu ki iy kj jc kp kc kd ke bi translated">接受单个输入</li><li id="0c83" class="jw jx hi ih b ii kf im kg iq kh iu ki iy kj jc kp kc kd ke bi translated">处理输入的内容(尽管不对其进行任何有意义的验证)</li></ul><p id="2301" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以接受该输入并调用Stackdriver监控API来创建一个定制的指标。为此，我们需要:</p><ul class=""><li id="3db9" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kp kc kd ke bi translated">添加谷歌云监控<strong class="ih hj">库</strong></li></ul><pre class="je jf jg jh fd kv kn kw kx aw ky bi"><span id="ba54" class="kz la hi kn b fi lb lc l ld le">from google.cloud import monitoring</span></pre><ul class=""><li id="68da" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kp kc kd ke bi translated">在<code class="du kk kl km kn b">POST</code>路径中实例化我们的<strong class="ih hj">客户端</strong></li></ul><pre class="je jf jg jh fd kv kn kw kx aw ky bi"><span id="7eff" class="kz la hi kn b fi lb lc l ld le">client = monitoring.Client()</span></pre><ul class=""><li id="2564" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kp kc kd ke bi translated">定义我们正在编写的度量标准。我只是使用一个基本的指标名称，但是您可以使用一个更复杂的路径，一旦您开始使用许多定制指标，这将非常有用。</li></ul><pre class="je jf jg jh fd kv kn kw kx aw ky bi"><span id="42dd" class="kz la hi kn b fi lb lc l ld le">metric = client.metric(<br/>  <!-- -->type_='custom.googleapis.com/numeric_value',<br/>  labels={}<br/>)</span></pre><ul class=""><li id="3dc1" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kp kc kd ke bi translated">定义我们编写这个指标所依据的<strong class="ih hj">资源</strong>。我只是根据<code class="du kk kl km kn b">global</code>资源来写，但是你可以根据需要提供特定的GCP资源。</li><li id="198e" class="jw jx hi ih b ii kf im kg iq kh iu ki iy kj jc kp kc kd ke bi translated"><strong class="ih hj">警告— </strong>为了简单起见，我针对“全局”资源来编写这个指标。如果这个代码要在多个地方执行，例如在多个容器单元中，可能会有潜在的冲突。在实际的生产部署中，请确保针对指定的资源而不是“全局”进行写入。</li></ul><pre class="je jf jg jh fd kv kn kw kx aw ky bi"><span id="15f5" class="kz la hi kn b fi lb lc l ld le">resource = client.resource(<br/>  type_='global',<br/>  labels={}<br/>)</span></pre><ul class=""><li id="c841" class="jw jx hi ih b ii ij im in iq jy iu jz iy ka jc kp kc kd ke bi translated">写度量值！</li></ul><pre class="je jf jg jh fd kv kn kw kx aw ky bi"><span id="6bf5" class="kz la hi kn b fi lb lc l ld le">client.write_point(metric, resource, int(form.metric.data))</span></pre><p id="f44d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有两点需要注意。首先，我使用表单输入的<code class="du kk kl km kn b">.data</code>属性来获取输入的值。第二个是我(实际上我不确定这是否有必要)在写之前把它转换成<code class="du kk kl km kn b">int</code>。</p><p id="5763" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果一切都做得正确，你可以确保你有你的GCP证书排序(我用了<code class="du kk kl km kn b">gcloud auth application-default login, </code>)，启动你的应用程序，并测试输入。如果它工作正常，您可以到Stackdriver中的Metric Explorer查看您的度量！</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es lf"><img src="../Images/f705760fd3d7e7cb293885eb59def255.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Xe38QHCDXViI7ss2SGMAw.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">太美了。</figcaption></figure><p id="4286" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您不熟悉Python、Stackdriver或监控API，我希望这对您有用！</p></div></div>    
</body>
</html>