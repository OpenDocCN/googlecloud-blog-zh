<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://medium.com/google-cloud/deploy-python-application-to-google-cloud-with-docker-and-kubernetes-db33ee9fbed3?source=collection_archive---------0-----------------------#2017-07-23">https://medium.com/google-cloud/deploy-python-application-to-google-cloud-with-docker-and-kubernetes-db33ee9fbed3?source=collection_archive---------0-----------------------#2017-07-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><p id="5d1e" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated"><strong class="hj if">用Docker和Kubernetes将Python应用部署到Google Cloud。</strong></p><p id="9de0" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">在这篇文章中，我将尝试将我的一个python应用程序部署到Google Cloud。我决定使用现有的应用程序，以避免浪费太多时间来演示如何创建应用程序。所以让我们开始吧。</p><p id="fedc" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">先决条件:</p><p id="fe4c" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">在谷歌云上创建一个项目。</p><p id="776e" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">如果您还没有google cloud帐户，请登录并创建一个新项目。我创建了一个名为bucketlist的项目。</p><p id="2376" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">按照链接查看如何安装它们</p><ul class=""><li id="e10a" class="ig ih hi hj b hk hl ho hp hs ii hw ij ia ik ie il im in io bi translated"><a class="ae ip" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank">码头工人</a></li><li id="3dbd" class="ig ih hi hj b hk iq ho ir hs is hw it ia iu ie il im in io bi translated"><a class="ae ip" href="https://cloud.google.com/sdk/downloads#mac" rel="noopener ugc nofollow" target="_blank"> gcloud </a></li><li id="847b" class="ig ih hi hj b hk iq ho ir hs is hw it ia iu ie il im in io bi translated">kubernetes —用<code class="du iv iw ix iy b">gcloud components install kubectl</code>安装</li></ul><p id="5b78" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated"><strong class="hj if">将app打包在容器中，然后推送谷歌云注册表。</strong></p><p id="94ff" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">既然我们已经有了申请，<a class="ae ip" href="https://github.com/andela-skanyi/bucketlist_api" rel="noopener ugc nofollow" target="_blank">https://github.com/andela-skanyi/bucketlist_api</a></p><p id="133d" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">现在我们在根目录中创建Dockerfile文件。</p><blockquote class="iz ja jb"><p id="6ad9" class="hg hh jc hj b hk hl hm hn ho hp hq hr jd ht hu hv je hx hy hz jf ib ic id ie hb bi translated">来自python:3.5.2-slim</p><p id="9777" class="hg hh jc hj b hk hl hm hn ho hp hq hr jd ht hu hv je hx hy hz jf ib ic id ie hb bi translated">运行mkdir -p /usr/src/app</p><p id="ac6b" class="hg hh jc hj b hk hl hm hn ho hp hq hr jd ht hu hv je hx hy hz jf ib ic id ie hb bi translated">工作目录/usr/src/app</p><p id="5264" class="hg hh jc hj b hk hl hm hn ho hp hq hr jd ht hu hv je hx hy hz jf ib ic id ie hb bi translated">复制requirements.txt /usr/src/app</p><p id="0daf" class="hg hh jc hj b hk hl hm hn ho hp hq hr jd ht hu hv je hx hy hz jf ib ic id ie hb bi translated">运行apt-get更新&amp;&amp; \</p><p id="a7a8" class="hg hh jc hj b hk hl hm hn ho hp hq hr jd ht hu hv je hx hy hz jf ib ic id ie hb bi translated">apt-get install-y PostgreSQL python-psycopg 2 libpq-dev cy thon &amp; &amp; \</p><p id="f7d5" class="hg hh jc hj b hk hl hm hn ho hp hq hr jd ht hu hv je hx hy hz jf ib ic id ie hb bi translated">pip安装—升级pip &amp;&amp; pip安装要求. txt</p><p id="2859" class="hg hh jc hj b hk hl hm hn ho hp hq hr jd ht hu hv je hx hy hz jf ib ic id ie hb bi translated">收到。/usr/src/app</p><p id="171c" class="hg hh jc hj b hk hl hm hn ho hp hq hr jd ht hu hv je hx hy hz jf ib ic id ie hb bi translated">曝光50050</p><p id="def9" class="hg hh jc hj b hk hl hm hn ho hp hq hr jd ht hu hv je hx hy hz jf ib ic id ie hb bi translated">入口点["python3"]</p><p id="888c" class="hg hh jc hj b hk hl hm hn ho hp hq hr jd ht hu hv je hx hy hz jf ib ic id ie hb bi translated">CMD ["manage.py" ]</p></blockquote><p id="abeb" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">然后构建我们将推送到谷歌云的图像。为此，我们将使用docker。Docker有一个build命令，因为我们将把映像推送到google cloud，所以我们将根据google cloud指南创建映像。</p><p id="13d2" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">他们有一个命名约定，<code class="du iv iw ix iy b">gcr.io/[YOUR_PROJECT_ID]/[YOUR_APPLICATION_NAME]</code></p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="99b9" class="jo jp hi iy b fi jq jr l js jt">docker build -t [DOCKER_IMAGE_NAME]  -f [DOCKERFILE_LOCATION] [APPLICATION_FILE_PATH]<!-- --> </span></pre><p id="6021" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">在我们例子中，这被翻译成类似于“docker build -t <code class="du iv iw ix iy b">gcr.io/[YOUR_PROJECT_ID]/[YOUR_APPLICATION_NAME]:v1</code>”的东西</p><p id="f7dc" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">现在，我们已经建立了图像，我们现在要把它推到谷歌注册。列出你所有的照片。</p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="c1c0" class="jo jp hi iy b fi jq jr l js jt">docker images</span></pre><p id="f42b" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">为了推送图像，</p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="3db0" class="jo jp hi iy b fi jq jr l js jt">gcloud docker -- push gcr.io/your-project-id/image-name</span></pre><p id="df52" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">如果您收到这个错误，</p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="035e" class="jo jp hi iy b fi jq jr l js jt">denied: Please enable Google Container Registry API in Cloud Console at <a class="ae ip" href="https://console.cloud.google.com/apis/api/containerregistry.googleapis.com/overview?project=bucketlist-174407" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/apis/api/containerregistry.googleapis.com/overview?project=y</a>our-project-id before performing this operation.</span></pre><p id="6c7f" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">转到该链接，单击“启用”并重试再次推送。</p><p id="4a09" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">创建集群有关如何创建集群的完整指南，请查看<a class="ae ip" href="https://cloud.google.com/container-engine/docs/clusters/operations" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/container-engine/docs/clusters/operations</a></p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="3e56" class="jo jp hi iy b fi jq jr l js jt">gcloud container clusters create staging <!-- -->--zone ZONE</span></pre><p id="29e7" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">上述命令将在您指定的区域中创建一个名为staging的集群。</p><p id="d2d6" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">如果您有多个项目，您可能希望设置要在其中创建集群的项目，</p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="0e84" class="jo jp hi iy b fi jq jr l js jt">gcloud config set project &lt;project-id&gt;</span></pre><h1 id="77b5" class="ju jp hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">配置kubectl</h1><p id="8f1a" class="pw-post-body-paragraph hg hh hi hj b hk kr hm hn ho ks hq hr hs kt hu hv hw ku hy hz ia kv ic id ie hb bi translated">我们将配置kubectl，以便它能够知道以哪个集群为目标。</p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="0b15" class="jo jp hi iy b fi jq jr l js jt">gcloud config set project &lt;project-id&gt;<br/>gcloud  config set container/cluster staging<br/>gcloud config set compute/zone us-east1-c<br/>gcloud container clusters get-credentials staging</span></pre><p id="3bdd" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">您可以将所有这些命令组合成一个命令，</p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="22b2" class="jo jp hi iy b fi jq jr l js jt">gcloud container clusters get-credentials staging --zone us-east1-c --project &lt;project-name&gt;</span></pre><p id="1b5a" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">将应用程序部署到集群。</p><p id="9c2e" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">关于如何实现这一目标，我们有两种选择。</p><ul class=""><li id="81ed" class="ig ih hi hj b hk hl ho hp hs ii hw ij ia ik ie il im in io bi translated">在命令行上</li><li id="f835" class="ig ih hi hj b hk iq ho ir hs is hw it ia iu ie il im in io bi translated">使用配置文件部署</li></ul><p id="4818" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">选项A:</p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="a23d" class="jo jp hi iy b fi jq jr l js jt">kubectl run {deployment_name} --image=gcr.io/$PROJECT_ID/{image-name}:{tag} --port={port}</span></pre><p id="4dcc" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">在我们的例子中，</p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="366f" class="jo jp hi iy b fi jq jr l js jt">kubectl run bucketlist-api --image=<!-- -->gcr.io/bucketlist-174407/bucketlistapi<!-- -->:latest --port=<!-- -->50050</span></pre><p id="20a4" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">成功的部署应该返回创建的部署“bucketlist-api”。您可以向部署中添加不同的变量，如— env等。</p><p id="2ae5" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">为了获得部署，ku bectl get deployment bucket list-API。</p><p id="6817" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">要观察应用程序部署是否已启动并正在运行，请检查状态是否应为正在运行。</p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="ca4a" class="jo jp hi iy b fi jq jr l js jt">kubectl get po <br/>or <br/>watch kubectl get po</span></pre><p id="9c8b" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">选项B:</p><p id="33b6" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">我们将创建一个名为deployment.yml的部署文件，在这里我们可以操作一些东西，比如环境变量等等。</p><figure class="jg jh ji jj fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/6d7e1ee89f117cd1b3d26135356947df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ezBqbedSILTtHvhxj_Ctjw.png"/></div></div></figure><p id="7b24" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">注意，我从secretKeyRef获得了密钥，我创建了一个秘密部署文件。</p><figure class="jg jh ji jj fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es le"><img src="../Images/c9f83ed2cd37babd81eda28b381bacd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9ZgMIt_hQrFO9AJLqHv71g.png"/></div></div></figure><p id="a542" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">现在，应用程序已经启动并运行。</p><figure class="jg jh ji jj fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lf"><img src="../Images/b1b6ac534b269ff93bff9857a253b859.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O3KI2aprzkE9q9hKvwODzQ.png"/></div></div></figure><p id="e175" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated"><strong class="hj if">将应用程序暴露在互联网上</strong></p><p id="c2f7" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">我们也可以在终端中这样做，或者创建一个服务文件，</p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="2b33" class="jo jp hi iy b fi jq jr l js jt">kubectl expose deployment <!-- -->bucketlist-api<!-- --> --type<strong class="iy if">=</strong>"LoadBalancer"</span></pre><p id="aae8" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">有了服务文件，</p><figure class="jg jh ji jj fd kx er es paragraph-image"><div class="er es lg"><img src="../Images/9782f5efcd93eec2940b63b0dd97bf65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*JYXwsP99mq8dMpv4WzHRbw.png"/></div></figure><p id="62e8" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">要创建服务，请运行</p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="a0c7" class="jo jp hi iy b fi jq jr l js jt">kubectl create -f service.yml</span></pre><p id="7a82" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">要列出可用的服务，请使用</p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="a2c7" class="jo jp hi iy b fi jq jr l js jt">kubectl get services</span></pre><p id="5944" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">使用外部IP地址和端口来访问应用程序。</p><p id="6385" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated"><strong class="hj if">更新或删除部署</strong></p><pre class="jg jh ji jj fd jk iy jl jm aw jn bi"><span id="f442" class="jo jp hi iy b fi jq jr l js jt">kubectl edit deployment &lt;name-of-your-deployment&gt;</span><span id="37be" class="jo jp hi iy b fi lh jr l js jt">kubectl delete deployment &lt;name-of-your-deployment&gt;</span></pre><p id="e1ba" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated"><strong class="hj if">结论，</strong></p><p id="7ebf" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">我们现在已经部署了我们的应用程序，并向外界公开了它。</p><p id="83f1" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">步骤:</p><ul class=""><li id="5de2" class="ig ih hi hj b hk hl ho hp hs ii hw ij ia ik ie il im in io bi translated">创建dockerfile文件</li><li id="acde" class="ig ih hi hj b hk iq ho ir hs is hw it ia iu ie il im in io bi translated">建立形象</li><li id="ec2b" class="ig ih hi hj b hk iq ho ir hs is hw it ia iu ie il im in io bi translated">推到谷歌注册表</li><li id="9737" class="ig ih hi hj b hk iq ho ir hs is hw it ia iu ie il im in io bi translated">创建部署文件</li><li id="5797" class="ig ih hi hj b hk iq ho ir hs is hw it ia iu ie il im in io bi translated">创建机密部署文件来存储环境变量</li><li id="642e" class="ig ih hi hj b hk iq ho ir hs is hw it ia iu ie il im in io bi translated">使用kubernetes部署应用程序</li><li id="f1f7" class="ig ih hi hj b hk iq ho ir hs is hw it ia iu ie il im in io bi translated">创建一个服务部署文件来公开应用程序</li><li id="83b7" class="ig ih hi hj b hk iq ho ir hs is hw it ia iu ie il im in io bi translated">可以编辑部署</li><li id="ae2d" class="ig ih hi hj b hk iq ho ir hs is hw it ia iu ie il im in io bi translated">也可以删除部署</li></ul><p id="5b9a" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">你可以做很多事情，包括缩放应用程序，甚至设置自动缩放。请随意探索。</p><p id="ad60" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">下一步是什么？</p><p id="439c" class="pw-post-body-paragraph hg hh hi hj b hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ie hb bi translated">我将自动化部署管道，当开发人员将代码从他们的本地机器推到部署的应用程序，而不会因为引入的更改而破坏应用程序。</p></div></div>    
</body>
</html>