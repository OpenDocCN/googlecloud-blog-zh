<html>
<head>
<title>Using Google APIs with Firebase Auth and Firebase UI on the Web</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Web上使用带有Firebase Auth和Firebase UI的Google APIs</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-google-apis-with-firebase-auth-and-firebase-ui-on-the-web-46e6189cf571?source=collection_archive---------0-----------------------#2018-01-03">https://medium.com/google-cloud/using-google-apis-with-firebase-auth-and-firebase-ui-on-the-web-46e6189cf571?source=collection_archive---------0-----------------------#2018-01-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f6a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2021更新:我不再推荐这种方法。虽然它在技术上仍然有效，但在最近的一个项目</strong><a class="ae jd" href="http://kbee.app" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"/></a><strong class="ih hj">中使用它时，我们遇到了很多陈旧的登录问题。</strong></p><p id="4c37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">相反，您应该反过来使用gapi登录将凭证传递给Firebase。</strong></p><p id="6a04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">我在这里推荐按照说明:</strong><a class="ae jd" href="https://github.com/msukmanowsky/gapi-firebase" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">https://github.com/msukmanowsky/gapi-firebase</strong></a></p><p id="2a8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">我也推荐用这个helper模块加载gapi:</strong><a class="ae jd" href="https://www.npmjs.com/package/gapi-script" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">https://www.npmjs.com/package/gapi-script</strong></a></p><h1 id="d348" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">原帖:</h1><p id="8139" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">如果你正在构建一个需要与用户的谷歌账户交互的网络应用，你很可能会发现OAuth的痛苦。在做任何有用的事情之前，您需要获得一个OAuth令牌并将其传递给Google API库。</p><p id="8cef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谢天谢地，用Firebase Auth做所有的登录工作都非常容易，而<a class="ae jd" href="https://github.com/firebase/firebaseui-web" rel="noopener ugc nofollow" target="_blank"> Firebase UI </a>让这变得更加容易。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/40dc7806137f41de9a44a6a14825fa94.png" data-original-src="https://miro.medium.com/v2/resize:fit:544/format:webp/1*zBpmnu_GmOuagTE9ahrFsQ.png"/></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">尼斯eeeee</figcaption></figure><p id="9873" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Firebase UI 基本上是一个简单的库，为你自动完成所有的UI(按钮等)和重定向逻辑，支持所有的Firebase OAuth提供者(谷歌、脸书、GitHub等)。</p><p id="c184" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">问题是，当你想做的不仅仅是登录，事情变得模糊不清。假设您想要创建一个管理用户日历的应用程序。如何指定访问其他Google服务所需的范围？如何从Firebase UI获得OAuth令牌，以便在Google API客户机中使用？</p><p id="c35d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谢天谢地，托德·范德林写了一篇很棒的文章修复了这些问题。以此为基础，让我们看看如何让Firebase UI和Google API客户端协同工作！</p><h1 id="9b07" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置库</h1><p id="254a" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">第一步是安装Firebase和Firebase UI。你可以遵循官方的指示，或者跟随这里。</p><p id="97fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将以下内容添加到HTML中的部分:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="49eb" class="ky jf hi ku b fi kz la l lb lc">&lt;script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"&gt;&lt;/script&gt;<br/>&lt;script src="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.js"&gt;&lt;/script&gt;<br/>&lt;link rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.css" /&gt;</span></pre><p id="1b51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将从Google的CDN中加载所有的依赖项。</p><h1 id="6aeb" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置配置</h1><p id="798d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">首先，确保在Firebase控制台中启用Google登录:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es ld"><img src="../Images/2f8beea868784ce6beb365a71e74233a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*VCHOrXXJRJXkx65z-28DQw.gif"/></div></div></figure><p id="8c1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到Firebase控制台，获取应用程序的配置数据。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es li"><img src="../Images/d2872dc9f87c86c136e331a8833d98da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*SDY3jCWNK8My0z2EhtrPzQ.gif"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">复制此配置对象</figcaption></figure><p id="ee53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它应该是这样的:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="cfff" class="ky jf hi ku b fi kz la l lb lc">var config = {<br/>    apiKey: "RANDOM_STRING",<br/>    authDomain: "APPNAME.firebaseapp.com",<br/>    databaseURL: "https://APPNAME.firebaseio.com",<br/>    projectId: "APPNAME",<br/>    storageBucket: "APPNAME.appspot.com",<br/>    messagingSenderId: "1234567890"<br/>  };</span></pre><p id="d9d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用这个配置对象来配置Google APIs和Firebase。为此，您需要向该对象添加更多的字段。</p><h2 id="5e4a" class="ky jf hi bd jg lj lk ll jk lm ln lo jo iq lp lq js iu lr ls jw iy lt lu ka lv bi translated">ClientID</h2><p id="8305" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">您需要做的第一件事是获取您的OAuth客户端ID。要做到这一点，你需要去谷歌开发者控制台。</p><p id="8c8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://console.developers.google.com/apis/credentials" rel="noopener ugc nofollow" target="_blank">console.developers.google.com/apis/credentials</a></p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lw"><img src="../Images/fc217a2537c3c8681b37fa5f80a645a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I3Zx6lIbrG-xrPXVW-HEcg.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">复制完整的ClientID</figcaption></figure><p id="99c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在将它添加到您的配置对象中</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="3a84" class="ky jf hi ku b fi kz la l lb lc">var config = {<br/>    apiKey: "RANDOM_STRING",<br/>    authDomain: "APPNAME.firebaseapp.com",<br/>    databaseURL: "https://APPNAME.firebaseio.com",<br/>    projectId: "APPNAME",<br/>    storageBucket: "APPNAME.appspot.com",<br/>    messagingSenderId: "1234567890",</span><span id="c298" class="ky jf hi ku b fi lx la l lb lc">    clientId: "RANDOM_STRING.apps.googleusercontent.com"</span><span id="bee9" class="ky jf hi ku b fi lx la l lb lc">  };</span></pre><h2 id="8e5c" class="ky jf hi bd jg lj lk ll jk lm ln lo jo iq lp lq js iu lr ls jw iy lt lu ka lv bi translated">领域</h2><p id="86e2" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">接下来，您需要添加您想要修改的服务的范围。在这个例子中，我想获得用户的个人资料信息(电子邮件，姓名等)，并有能力修改和阅读他们的日历。</p><p id="6b25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了找到正确的范围名称，这里有一个所有可用Google范围的列表:</p><p id="9b66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://developers.google.com/identity/protocols/googlescopes" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/identity/protocols/Google scopes</a></p><p id="d91c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在搜索你需要的望远镜。一些服务(如Gmail)有非常具体的范围，给你完成任务所需的最低访问权限。始终确保使用您需要的最少权限！</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es ly"><img src="../Images/b32349a74fff531a3c66f058b6c404c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*VsHuTWPw02TMulsgABHQxQ.gif"/></div></div></figure><p id="3920" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，在这个示例中，有三个范围要包括:“电子邮件”、“个人资料”和“https://www . Google APIs . com/auth/calendar”</p><p id="9efb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用这些值在配置对象中创建一个数组:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="0385" class="ky jf hi ku b fi kz la l lb lc">var config = {<br/>    apiKey: "RANDOM_STRING",<br/>    authDomain: "APPNAME.firebaseapp.com",<br/>    databaseURL: "https://APPNAME.firebaseio.com",<br/>    projectId: "APPNAME",<br/>    storageBucket: "APPNAME.appspot.com",<br/>    messagingSenderId: "1234567890",</span><span id="6d8b" class="ky jf hi ku b fi lx la l lb lc">    clientId: "RANDOM_STRING.apps.googleusercontent.com",</span><span id="ef7b" class="ky jf hi ku b fi lx la l lb lc">    scopes: [<br/>             "email",<br/>             "profile",<br/>             "https://www.googleapis.com/auth/calendar"<br/>    ]<br/>};</span></pre><h2 id="e011" class="ky jf hi bd jg lj lk ll jk lm ln lo jo iq lp lq js iu lr ls jw iy lt lu ka lv bi translated">发现文档</h2><p id="8f5a" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">到了最后一步。为了让Google API客户端知道要加载哪些库，您需要传入相应的发现文档。电子邮件和个人资料内置在Firebase中，但是我们希望能够用Google API客户端修改日历，所以我们需要它的discovery doc。</p><p id="53a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要找到正确的发现文档，您可以使用以下服务:</p><p id="0c06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://developers.google.com/discovery/v1/reference/apis/list?apix=true" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/discovery/v1/reference/APIs/list？apix =真</a></p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es lz"><img src="../Images/a05a95fb410dd073ec0c2b111ed8c9ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*9wzQU2LdjJMlFEUHWhVuvA.gif"/></div></div></figure><p id="f410" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同样，创建一个数组并添加您需要的所有发现文档</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="c8d3" class="ky jf hi ku b fi kz la l lb lc">var config = {<br/>    apiKey: "RANDOM_STRING",<br/>    authDomain: "APPNAME.firebaseapp.com",<br/>    databaseURL: "https://APPNAME.firebaseio.com",<br/>    projectId: "APPNAME",<br/>    storageBucket: "APPNAME.appspot.com",<br/>    messagingSenderId: "1234567890",</span><span id="7adf" class="ky jf hi ku b fi lx la l lb lc">    clientId: "RANDOM_STRING.apps.googleusercontent.com",</span><span id="1bb1" class="ky jf hi ku b fi lx la l lb lc">    scopes: [<br/>             "email",<br/>             "profile",<br/>             "https://www.googleapis.com/auth/calendar"<br/>    ],<br/>    discoveryDocs: [<br/>    "<a class="ae jd" href="https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest</a>"<br/>    ]<br/>};</span></pre><p id="e266" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">终于完成了所有疯狂的配置！</p><h1 id="0ecb" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置Firebase用户界面</h1><p id="464a" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><em class="ma">注意:</em> <a class="ae jd" href="https://gist.github.com/thesandlord/4740bfaca43d67fe6865c097db2a4016" rel="noopener ugc nofollow" target="_blank"> <em class="ma">这里可以看到完整的代码</em> </a></p><p id="04ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">遵循Firebase UI的官方设置。唯一的区别在于“登录选项”字段。将其更改为包含您在配置对象中指定的范围:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="b9d0" class="ky jf hi ku b fi kz la l lb lc">var uiConfig = {<br/> signInSuccessUrl: “&lt;url-to-redirect-to-on-success&gt;”,<br/> signInOptions: [{<br/>   provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,<br/>   scopes: config.scopes<br/> }],<br/> // Terms of service url.<br/> tosUrl: “&lt;your-tos-url&gt;”<br/>};</span></pre><h1 id="7691" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设置Google API客户端</h1><p id="5abc" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">Firebase UI将处理所有的登录流程细节。登录完成后，Firebase会自动触发一个功能。在这个函数中，我们将加载Google API客户端。</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="d0fa" class="ky jf hi ku b fi kz la l lb lc">// This function will trigger when there is a login event<br/>firebase.auth().onAuthStateChanged(function(user) {</span><span id="6895" class="ky jf hi ku b fi lx la l lb lc">  // Make sure there is a valid user object<br/>  if(user){<br/>    var script = document.createElement('script');<br/>    script.type = 'text/javascript';<br/>    script.src = '<a class="ae jd" href="https://apis.google.com/js/api.js'" rel="noopener ugc nofollow" target="_blank">https://apis.google.com/js/api.js'</a>;</span><span id="45c5" class="ky jf hi ku b fi lx la l lb lc">    // Once the Google API Client is loaded, you can run your code<br/>    script.onload = function(e){</span><span id="6b1b" class="ky jf hi ku b fi lx la l lb lc">     // Initialize the Google API Client with the config object<br/>     gapi.client.init({<br/>       apiKey: config.apiKey,<br/>       clientId: config.clientID,<br/>       discoveryDocs: config.discoveryDocs,<br/>       scope: config.scopes.join(' '),<br/>     })</span><span id="c121" class="ky jf hi ku b fi lx la l lb lc">     // Loading is finished, so start the app<br/>     .then(function() {</span><span id="baf6" class="ky jf hi ku b fi lx la l lb lc">      // Make sure the Google API Client is properly signed in<br/>      if (gapi.auth2.getAuthInstance().isSignedIn.get()) {<br/>        startApp(user);<br/>      } else {<br/>        firebase.auth().signOut(); // Something went wrong, sign out<br/>      }</span><span id="6d35" class="ky jf hi ku b fi lx la l lb lc">     })</span><span id="b47f" class="ky jf hi ku b fi lx la l lb lc">    }</span><span id="2ec4" class="ky jf hi ku b fi lx la l lb lc">    // Add to the document<br/>    document.getElementsByTagName('head')[0].appendChild(script);  <br/>  }<br/>})</span></pre><h1 id="4c88" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">把这一切联系在一起</h1><p id="6e50" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">所有的“样板文件”都完成了。您现在可以毫无问题地使用Google API客户端了！</p><p id="079f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>在调用之前检查OAuth令牌是否仍然有效，或者在调用API之前刷新令牌，这一点很重要。这是因为Firebase会自动刷新令牌，而Google API客户端不会。</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="7be9" class="ky jf hi ku b fi kz la l lb lc">// Print out the User and the 10 latest calendar events<br/>function startApp(user) {<br/>  console.log(user);<br/>  firebase.auth().currentUser.getToken()<br/>  .then(function(token) {<br/>    return gapi.client.calendar.events.list({<br/>     calendarId: "primary",<br/>     timeMin: new Date().toISOString(),<br/>     showDeleted: false,<br/>     singleEvents: true,<br/>     maxResults: 10,<br/>     orderBy: "startTime"<br/>    })  <br/>   })<br/>  .then(function(response) {<br/>    console.log(response);  <br/>  });<br/>}</span></pre><h1 id="f270" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">完整代码:</h1><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="mb mc l"/></div></figure></div></div>    
</body>
</html>