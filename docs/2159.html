<html>
<head>
<title>Login to GCP VM Instance without Public IP using Identity-Aware proxy (IAP)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用身份识别代理(IAP)登录到没有公共IP的GCP虚拟机实例</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/login-to-gcp-vm-instance-without-public-ip-31cc01ee152b?source=collection_archive---------0-----------------------#2022-04-14">https://medium.com/google-cloud/login-to-gcp-vm-instance-without-public-ip-31cc01ee152b?source=collection_archive---------0-----------------------#2022-04-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="afc5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">简介</strong></p><p id="e4b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文将尝试向您解释我们如何使用<strong class="ih hj">身份感知代理</strong> (IAP)在没有公共/外部IP的情况下登录GCE实例。身份识别代理(IAP) TCP转发，允许对没有外部IP地址或不允许通过internet直接访问的虚拟机实例进行管理访问。在本文中，我将首先尝试重现该问题，然后引导您完成解决方案。</p><p id="47f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于IAP的更多信息— <a class="ae jd" href="https://cloud.google.com/iap/docs/using-tcp-forwarding" rel="noopener ugc nofollow" target="_blank">点击此处</a></p><p id="ef1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">先决条件</strong></p><ol class=""><li id="ace3" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">编辑者/所有者访问GCP项目</li></ol><p id="4adc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">资源创建</strong></p><ol class=""><li id="15be" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">创建自定义VPC ex。<strong class="ih hj"> dev-vpc </strong>，子网位于所需区域。</li></ol><figure class="jo jp jq jr fd js er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es jn"><img src="../Images/556d2ea72d81ee61d215497e2fdd5bce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BLQEvgfkZUZ8SdF-yg4Dew.png"/></div></div><figcaption class="jz ka et er es kb kc bd b be z dx translated">自定义VPC</figcaption></figure><p id="65e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.使用自定义VPC网络创建一个GCE实例，并在创建如下实例时保持外部IP为<strong class="ih hj"> none </strong>。</p><figure class="jo jp jq jr fd js er es paragraph-image"><div class="er es kd"><img src="../Images/11903623527451b70888408fd3332bf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*NjZZ-3efCqWFvQpsNkESKw.png"/></div><figcaption class="jz ka et er es kb kc bd b be z dx translated">网络结构</figcaption></figure><p id="5051" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.使用网络标签ex。创建实例时出现“iap-demo”。</p><figure class="jo jp jq jr fd js er es paragraph-image"><div class="er es ke"><img src="../Images/83183738209bf347b2a0634b6bfb21fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*iEflm1ruw5r4Zuoyt7Boig.png"/></div></figure><p id="5c0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.现在实例已经创建并处于运行状态。然而<strong class="ih hj"> ssh </strong>按钮被禁用。</p><figure class="jo jp jq jr fd js er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es kf"><img src="../Images/4f2248778dbac5371e147f6c7149a806.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TQNIQ9BfKtSolUZXzoKMhQ.png"/></div></div></figure><p id="f29f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.现在使用IAP从API和服务中启用身份感知代理API。</p><figure class="jo jp jq jr fd js er es paragraph-image"><div class="er es kg"><img src="../Images/26767b409aa7791086a8e8031c927829.png" data-original-src="https://miro.medium.com/v2/resize:fit:682/format:webp/1*MruHmvZim-8XOPcfrdF2gw.png"/></div><figcaption class="jz ka et er es kb kc bd b be z dx translated">导航至API和服务</figcaption></figure><p id="64d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在库中搜索以下IAP API并点击<strong class="ih hj">启用</strong></p><figure class="jo jp jq jr fd js er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es kh"><img src="../Images/6cf6483db7caebc3a1a541b56fdd3a38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n_fmAhf6htsa1dwwS8Icvw.png"/></div></div></figure><p id="2452" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.分配用户角色—<strong class="ih hj">IAP-安全隧道用户</strong>来自<strong class="ih hj"> </strong> IAM</p><p id="992c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.现在<strong class="ih hj"> ssh </strong>选项在分配上述角色后可用。</p><figure class="jo jp jq jr fd js er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es ca"><img src="../Images/049b879d3a475a42655fbd197238987f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UwKRWMQeo8TuWvz-C3EKIA.png"/></div></div></figure><p id="ec5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">8.现在尝试ssh，(连接将失败，出现以下错误)</p><figure class="jo jp jq jr fd js er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es ki"><img src="../Images/2a36a6b88e753074892d005ba0d1af0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cAkTbhXrzFnyzXUlwDQoKQ.png"/></div></div></figure><p id="1fd0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">9.要解决此错误，我们需要创建防火墙规则，允许来自IP范围<code class="du kj kk kl km b">35.235.240.0/20</code>的流量进入。这个范围包含IAP用于TCP转发的所有IP地址。</p><figure class="jo jp jq jr fd js er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es kn"><img src="../Images/95a41697d5de0e884352fd8a4ed7296c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JizD1FeWGCaEm3EuALdWuQ.png"/></div></div><figcaption class="jz ka et er es kb kc bd b be z dx translated">允许IAP连接的防火墙规则</figcaption></figure><p id="cfa4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">10.现在尝试ssh到GCE实例，这将创建成功的ssh连接，并允许用户登录到GCE实例。</p><figure class="jo jp jq jr fd js er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es ko"><img src="../Images/44af430c41d86af34ef686bbbaeea675.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3F8TX67yF2XOCPGNbXcHsw.png"/></div></div></figure><p id="9760" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">总结</strong></p><ol class=""><li id="e794" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">身份识别代理(IAP) TCP转发，允许对没有外部IP地址或不允许通过internet直接访问的虚拟机实例进行管理访问。</li><li id="4b33" class="je jf hi ih b ii kp im kq iq kr iu ks iy kt jc jj jk jl jm bi translated">要启用IAP，我们需要-</li><li id="f560" class="je jf hi ih b ii kp im kq iq kr iu ks iy kt jc jj jk jl jm bi translated">启用<strong class="ih hj">云身份感知代理</strong> API <br/> 2)向用户分配<strong class="ih hj">角色/IAP . tunnelresourceaccessor</strong>角色<br/> 3)创建防火墙以允许来自IP范围<strong class="ih hj"> 35.235.240.0/20 </strong>的ssh流量这是google提供的固定IP范围。</li></ol><p id="0dd7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">跟随下面的YouTube视频进行演示。</p><figure class="jo jp jq jr fd js"><div class="bz dy l di"><div class="ku kv l"/></div></figure></div></div>    
</body>
</html>