<html>
<head>
<title>Triggering Cloud Functions deployments</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">触发云功能部署</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/triggering-cloud-functions-deployments-97691f9b5416?source=collection_archive---------2-----------------------#2017-12-21">https://medium.com/google-cloud/triggering-cloud-functions-deployments-97691f9b5416?source=collection_archive---------2-----------------------#2017-12-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="c2d7" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">云功能的进一步探索</h2></div><p id="07a7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">2018–08–23更新</strong></p><p id="305f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">感谢Marcus为这篇文章指出了一个突破性的改变，也感谢我的同事为我指出了文档的改变(<a class="ae jt" href="https://cloud.google.com/functions/docs/reference/iam/roles#adding_the_iam_service_account_user_role_to_the_runtime_service_account" rel="noopener ugc nofollow" target="_blank">链接</a>)。现在，您还必须授予云(née容器)构建服务帐户在<code class="du ju jv jw jx b">appspot</code>服务帐户上的<code class="du ju jv jw jx b">serviceAccountUser</code>角色:</p><pre class="jy jz ka kb fd kc jx kd ke aw kf bi"><span id="ed77" class="kg kh hi jx b fi ki kj l kk kl">gcloud iam service-accounts add-iam-policy-binding <strong class="jx hj">${PROJECT_ID</strong>}<a class="ae jt" href="http://twitter.com/appspot" rel="noopener ugc nofollow" target="_blank">@appspot</a>.gserviceaccount.com \<br/>--member=serviceAccount:<strong class="jx hj">${NUM}</strong><a class="ae jt" href="http://twitter.com/cloudbuild" rel="noopener ugc nofollow" target="_blank">@cloudbuild</a>.gserviceaccount.com \<br/>--role=roles/<strong class="jx hj">iam.serviceAccountUser</strong> \<br/>--project=${PROJECT}</span></pre><blockquote class="km kn ko"><p id="01cd" class="ix iy kp iz b ja jb ij jc jd je im jf kq jh ji jj kr jl jm jn ks jp jq jr js hb bi translated"><strong class="iz hj">注意</strong>参见下面的原文，但是<code class="du ju jv jw jx b">${PROJECT_ID}</code>对应于你的项目ID，而<code class="du ju jv jw jx b">${NUM}</code>对应于项目编号。</p></blockquote><p id="7ab9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此外，<code class="du ju jv jw jx b">gcloud beta functions deploy</code>的一个新的有用特性是它将从当前目录部署。因为构建触发器将repo复制到云构建<code class="du ju jv jw jx b">/workspace</code>目录中，所以您可以从<code class="du ju jv jw jx b">cloudbuild.yaml</code>中的命令中删除<code class="du ju jv jw jx b">--source=...</code>标志。</p><h2 id="5db9" class="kg kh hi bd kt ku kv kw kx ky kz la lb jg lc ld le jk lf lg lh jo li lj lk ll bi translated">原始帖子</h2><p id="0528" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">当我签入Google云源代码库的变更时，我可以不使用<a class="ae jt" href="https://cloud.google.com/container-builder" rel="noopener ugc nofollow" target="_blank"> Google Container Builder </a>来触发云功能部署吗？我想我可以。让我们试试…</p><p id="1e8d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">延续昨天<a class="ae jt" rel="noopener" href="/@DazWilkin/google-cloud-storage-downsizer-af0048591e40">裁员</a>的帖子。</p><h2 id="b0df" class="kg kh hi bd kt ku kv kw kx ky kz la lb jg lc ld le jk lf lg lh jo li lj lk ll bi translated">集装箱建造商</h2><p id="7568" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">启用容器生成器:</p><pre class="jy jz ka kb fd kc jx kd ke aw kf bi"><span id="9770" class="kg kh hi jx b fi ki kj l kk kl">gcloud services enable cloudbuild.googleapis.com --project=$PROJECT</span></pre><blockquote class="km kn ko"><p id="8173" class="ix iy kp iz b ja jb ij jc jd je im jf kq jh ji jj kr jl jm jn ks jp jq jr js hb bi translated"><strong class="iz hj">注意</strong>端点是“cloudbuild ”,但是服务被称为容器构建器</p></blockquote><p id="12e8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，确定Container Builder的服务帐户，并赋予其允许云功能部署的额外角色:</p><pre class="jy jz ka kb fd kc jx kd ke aw kf bi"><span id="8701" class="kg kh hi jx b fi ki kj l kk kl">NUM=$(gcloud projects describe $PROJECT \<br/>--format='value(projectNumber)')</span><span id="53e5" class="kg kh hi jx b fi lr kj l kk kl">gcloud projects add-iam-policy-binding ${PROJECT} \<br/>--member=serviceAccount:${NUM}<a class="ae jt" href="http://twitter.com/cloudbuild" rel="noopener ugc nofollow" target="_blank">@cloudbuild</a>.gserviceaccount.com \<br/>--role=roles/cloudfunctions.developer</span></pre><p id="82dc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要向云源存储库添加容器构建器规范(<code class="du ju jv jw jx b">cloudbuild.yaml</code>)来创建触发器。我们将使用添加它的提交来测试它是否工作。</p><p id="52d0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当我们对我们的云资源存储库进行更改时，包括向其中添加cloudbuild.yaml文件，我们希望触发云功能部署。您还记得部署是通过gcloud命令实现的，我们可以使用容器构建器“gcloud”步骤来实现这一目的。虽然已经YAMLized，但这对于昨天的部署命令来说应该非常熟悉。</p><p id="e014" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">cloudbuild.yaml:</p><pre class="jy jz ka kb fd kc jx kd ke aw kf bi"><span id="6acb" class="kg kh hi jx b fi ki kj l kk kl">steps:<br/>- name: gcr.io/cloud-builders/gcloud<br/>  args: [<br/>      'beta',<br/>      'functions',<br/>      'deploy','${_NAME}',<br/>      '--source=<a class="ae jt" href="https://source.developers.google.com/projects/${PROJECT_ID}/repos/default/moveable-aliases/master/paths/'" rel="noopener ugc nofollow" target="_blank">https://source.developers.google.com/projects/${PROJECT_ID}/repos/default/moveable-aliases/master/paths/'</a>,<br/>      '--trigger-bucket=${_ROOT}-trigger',<br/>      '--entry-point=thumbnail',<br/>      '--project=${PROJECT_ID}'<br/>  ]</span></pre><p id="671c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">规范引用了容器构建器的环境变量的“友好”变体，我们过去用云函数构建这些变量，但是容器构建器要求用户定义的变量以“_”为前缀，所以我们在这里有<code class="du ju jv jw jx b">_NAME</code>和<code class="du ju jv jw jx b">_ROOT</code>，当我们定义tigger时，我们将这些映射到我们的bash变量。集装箱建造商为我们提供了<code class="du ju jv jw jx b">PROJECT_ID</code>。</p><p id="100d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们这样做</p><pre class="jy jz ka kb fd kc jx kd ke aw kf bi"><span id="b905" class="kg kh hi jx b fi ki kj l kk kl"><a class="ae jt" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/</a><a class="ae jt" href="https://pantheon.corp.google.com/gcr/builds?project=dazwilkin-171219-multi-domain" rel="noopener ugc nofollow" target="_blank">gcr/builds?project=$</a>{PROJECT}</span></pre><figure class="jy jz ka kb fd lt er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es ls"><img src="../Images/3ee236c48d1e887f749c722921af6e8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F4O8_zMr9q8INgtuyi9_6Q.png"/></div></div><figcaption class="ma mb et er es mc md bd b be z dx translated">容器注册表:触发源</figcaption></figure><p id="d463" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">选择“云资源存储库”，然后保留“默认”:</p><figure class="jy jz ka kb fd lt er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es ls"><img src="../Images/af0723ef0a96085daebc9d1d12ea0a15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Y0fdjPBd7QonnRh2Cq9tA.png"/></div></div><figcaption class="ma mb et er es mc md bd b be z dx translated">容器注册表:触发器存储库</figcaption></figure><p id="861c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后根据这里的示例完成细节，您需要为“构建配置”选择“cloudbuild.yaml”:</p><figure class="jy jz ka kb fd lt er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es me"><img src="../Images/c696aa7e9291833ebf42d8cbcfe3aa8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PRYJgeISdLujVAuCT8yDGw.png"/></div></div><figcaption class="ma mb et er es mc md bd b be z dx translated">容器注册表:创建触发器</figcaption></figure><blockquote class="km kn ko"><p id="0ed7" class="ix iy kp iz b ja jb ij jc jd je im jf kq jh ji jj kr jl jm jn ks jp jq jr js hb bi translated"><strong class="iz hj"> NB </strong>我们正在将部署名称“downsizer”的现有部署值映射到云构建者的名称，将＄ROOT映射到_ROOT。不要忘记在这一步中用它的值替换$ROOT。</p></blockquote><p id="abdd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后“创建触发器”:</p><figure class="jy jz ka kb fd lt er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es me"><img src="../Images/e36a80a6fc47e4d581fbe670cf76e990.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hs0IcHlIngXNe-1OjU3T_w.png"/></div></div></figure><p id="9492" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">好的。剩下要做的就是触发部署，因为我们需要将“cloudbuild.yaml”添加到我们的存储库中，所以让我们同时做这两件事:</p><pre class="jy jz ka kb fd kc jx kd ke aw kf bi"><span id="4fc8" class="kg kh hi jx b fi ki kj l kk kl">git add cloudbuild.yaml<br/>git commit --message "Add cloudbuild.yaml and trigger deployment"<br/>git push -u origin master</span></pre><figure class="jy jz ka kb fd lt er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es mf"><img src="../Images/f1610136657f654223ce117417907d65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kk4Dvh5wHsBDLakN1I8SPQ.png"/></div></div></figure><p id="6cc2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">看到推送触发了新的构建，并检查我们是否有部署:</p><pre class="jy jz ka kb fd kc jx kd ke aw kf bi"><span id="d920" class="kg kh hi jx b fi ki kj l kk kl"><a class="ae jt" href="https://pantheon.corp.google.com/functions/list?project=dazwilkin-171219-multi-domain" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/functions/list?project=$</a>{PROJECT}</span></pre><figure class="jy jz ka kb fd lt er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es mg"><img src="../Images/0027f80297e8f53fd50fc1cf76ec8470.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BV0xtuV88xCl0_0xYAa8_A.png"/></div></div><figcaption class="ma mb et er es mc md bd b be z dx translated">云功能:已部署！</figcaption></figure><p id="ade8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在…如果我们能够在部署完成后对云功能进行测试，那该多好啊…请关注这个领域！</p><h2 id="1539" class="kg kh hi bd kt ku kv kw kx ky kz la lb jg lc ld le jk lf lg lh jo li lj lk ll bi translated">结论</h2><p id="bca0" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">我认为昨天缺失的一个特性是在签入云资源存储库时触发云功能部署的能力。它没有丢失:-)</p></div></div>    
</body>
</html>