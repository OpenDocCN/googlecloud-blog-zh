<html>
<head>
<title>Using preemptible VMs to cut Kubernetes Engine bills in half</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用可抢占的虚拟机将Kubernetes引擎账单削减一半</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-preemptible-vms-to-cut-kubernetes-engine-bills-in-half-de2481b8e814?source=collection_archive---------0-----------------------#2018-01-08">https://medium.com/google-cloud/using-preemptible-vms-to-cut-kubernetes-engine-bills-in-half-de2481b8e814?source=collection_archive---------0-----------------------#2018-01-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1fc6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可抢占虚拟机的固定价格高达常规实例的80%,但不幸的是，它们大多被宣传为运行短期批处理作业。在这篇博文中，我们将看到在Google云平台上混合使用可抢占的和常规的Kubernetes节点如何在不牺牲应用程序稳定性的情况下节省大量资金。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="1c79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，<strong class="ih hj">它对任何应用都不起作用</strong>。这不是银弹！您的应用程序应该对一些pod的意外故障具有<strong class="ih hj">容忍度</strong>。让我们看一个例子，我们的意思是什么。</p><p id="f792" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们的例子中，我们在Kubernetes引擎上运行Cirrus CI。Cirrus CI由20个微服务和其他一些很酷的技术支持。每项服务都由至少两个配置了<a class="ae jk" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" rel="noopener ugc nofollow" target="_blank">水平机架自动缩放器</a>的机架提供支持，以便在需要时进行纵向扩展。除了两个微服务之外，所有微服务都是无状态的，可以容忍任何pod的故障。其他两个一般来说也是无状态的，但是在他们的情况下，我们希望最小化意外的pod故障，因为客户端重新连接并继续使用它们的成本非常高。例如，其中一个负责从CI代理上传缓存，如果发生故障，重新上传缓存的成本会高得不合理。</p><p id="8e45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">想法很简单:我们希望调度pods，我们可以容忍可抢占节点上的故障。</strong>我们还需要确保我们永远不会在可抢占节点上调度我们不能容忍的pods故障。</p><h1 id="d943" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">Kubernetes引擎设置</h1><p id="ed2f" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">您的Kubernetes集群应该有一个可抢占的节点池。如果没有，这里有一个<code class="du ko kp kq kr b">gcloud</code>命令来创建一个可自动扩展的可预优化虚拟机节点池:</p><pre class="ks kt ku kv fd kw kr kx ky aw kz bi"><span id="4a20" class="la jm hi kr b fi lb lc l ld le"><em class="lf">gcloud </em>container node-pools create preemtible-pool \<br/>  --cluster $CLUSTER_NAME \<br/>  --zone $CLUSTER_ZONE \<br/>  --scopes cloud-platform \<br/>  --enable-autoupgrade \<br/>  --preemptible \<br/>  --num-nodes 1 --machine-type n1-standard-8 \<br/>  --enable-autoscaling --min-nodes=0 --max-nodes=6</span></pre><p id="9e9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>可抢占池中的节点将有<code class="du ko kp kq kr b">cloud.google.com/gke-preeptible: true</code>标签。</p><h1 id="51a5" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">节点关联性</h1><p id="bd32" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">为了控制pods的调度我们可以使用<a class="ae jk" href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#node-affinity-beta-feature" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> <em class="lf">节点亲和</em> </strong> </a>功能。通过节点关联，我们可以为pod的调度设置硬偏好和软偏好。</p><h2 id="125f" class="la jm hi bd jn lg lh li jr lj lk ll jv iq lm ln jz iu lo lp kd iy lq lr kh ls bi translated">硬性偏好</h2><p id="f74c" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">硬首选项是确保某些pods永远不会被安排在可抢占的节点上的理想选择。我们不能容忍的失败。使用<code class="du ko kp kq kr b">requiredDuringSchedulingIgnoreDuringExecution</code>,我们可以确保pods不会被安排在带有<code class="du ko kp kq kr b">cloud.google.com/gke-preeptible</code>标签的节点上。只需将以下几行添加到您的<em class="lf">吊舱</em>或<em class="lf">部署</em>规范中:</p><pre class="ks kt ku kv fd kw kr kx ky aw kz bi"><span id="6857" class="la jm hi kr b fi lb lc l ld le">affinity:<br/>  nodeAffinity:<br/>    requiredDuringSchedulingIgnoredDuringExecution:<br/>      nodeSelectorTerms:<br/>      - matchExpressions:<br/>        - key: cloud.google.com/gke-preemptible<br/>          operator: DoesNotExist</span></pre><h2 id="0691" class="la jm hi bd jn lg lh li jr lj lk ll jv iq lm ln jz iu lo lp kd iy lq lr kh ls bi translated">软偏好</h2><p id="5e94" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">另一方面，软偏好只是告诉Kubernetes调度的偏好。例如<strong class="ih hj">Google计算引擎不能保证可抢占的虚拟机始终可用</strong>。对于我们的用例，我们只想告诉Kubernetes类似“如果可以的话，请在带有<code class="du ko kp kq kr b">cloud.google.com/gke-preemptible</code>标签的节点上安排这些pods。如果不是，那就无所谓了”。以下是如何修改您的<em class="lf">吊舱</em>或<em class="lf">部署</em>规格，以便使用<code class="du ko kp kq kr b">preferredDuringSchedulingIgnoreDuringExecution</code>实现这一点:</p><pre class="ks kt ku kv fd kw kr kx ky aw kz bi"><span id="b3d2" class="la jm hi kr b fi lb lc l ld le">affinity:<br/>  nodeAffinity:<br/>    preferredDuringSchedulingIgnoredDuringExecution:<br/>    - preference:<br/>        matchExpressions:<br/>        - key: cloud.google.com/gke-preemptible<br/>          operator: Exists<br/>      weight: 100 </span></pre><h1 id="2f0c" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">结果</h1><p id="492c" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">对于我们的18个无状态微服务，我们有这样的软偏好，而对于我们上面描述的两个特殊情况，我们有硬偏好。结果令人印象深刻！<strong class="ih hj">平均而言，我们75%的生产工作负载运行在可抢占的节点上，这可以节省50%的GCP费用。</strong></p><p id="87d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请<a class="ae jk" href="https://twitter.com/cirrus_labs" rel="noopener ugc nofollow" target="_blank">在Twitter上关注我们</a>,如果您有任何问题，请随时提问！</p></div></div>    
</body>
</html>