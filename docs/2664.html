<html>
<head>
<title>Centralized dashboard for data fusion pipelines monitoring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于数据融合管道监控的集中式仪表板</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/centralised-dashboard-for-data-fusion-pipeline-monitoring-90dc6a5797cf?source=collection_archive---------11-----------------------#2022-12-21">https://medium.com/google-cloud/centralised-dashboard-for-data-fusion-pipeline-monitoring-90dc6a5797cf?source=collection_archive---------11-----------------------#2022-12-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4d84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/data-fusion" rel="noopener ugc nofollow" target="_blank">云数据融合</a>是一种基于GUI的数据集成服务，用于构建和管理数据管道。它基于<a class="ae jd" href="https://github.com/cdapio/cdap" rel="noopener ugc nofollow" target="_blank"> CDAP </a>，这是一个为内部和云资源构建数据分析应用的开源框架。它为GCP、其他公共云和内部资源提供了各种现成的连接器。</p><p id="c087" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">用例</strong></p><p id="a454" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">客户有多个数据融合实例，部署了2500多个数据融合管道。每个实例都有多个名称空间来在功能上隔离管道。</p><p id="13eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以想象运营团队管理如此庞大的部署所涉及的复杂性。为了更好地理解它，让我们看看在数据融合实例中如何管理管道，</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/58f67ce0623dd9761fc1b2593a139cf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sMGbiblIMVIMa25Gah4tVw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">数据融合实例中的命名空间</figcaption></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ju"><img src="../Images/4a4952081ee7307782a617960be73bbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QA5FLHMhlKQ3eOIZix4SbA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">命名空间“默认”下的管道</figcaption></figure><p id="da19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以看到，必须打开每个名称空间才能看到所有部署的管道及其运行状态。当名称空间的数量很大并且每个名称空间包含数百个管道时，这变得复杂。</p><p id="6bb9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">简化流程，减少运营团队的痛苦。我们已经开发了一个解决方案，我们将在这个博客中详细讨论。</p><p id="97fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">解决方案</strong></p><p id="8289" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在data studio上构建一个集中的监控仪表板。Dashboard显示跨数据融合实例运行的所有管道，并提供各种过滤器来查看基于特定日期、基于实例名称等的管道。</p><p id="cfe3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们看看我们是如何构建这个控制面板的，在非常高的层面上，解决方案涉及创建一个基于日志的Bigquery接收器，并使所有数据融合管道日志在BQ表中可用。准备一个视图查询，该查询将被提供给data studio报表以呈现仪表板。</p><ol class=""><li id="797f" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ka kb kc kd bi translated">创建BQ日志接收器</li><li id="cd1f" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">创建BQ视图</li><li id="75db" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">创建映射BQ表</li><li id="7d98" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">构建data studio仪表板</li></ol><p id="9d1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们深入研究上面提到的每一个步骤，</p><p id="028e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建BQ日志接收器</strong></p><ol class=""><li id="10fd" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ka kb kc kd bi translated">在云控制台中，转到日志记录&gt;日志浏览器页面。</li><li id="de2b" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">选择现有的云项目、文件夹或组织。</li><li id="395a" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">打开日志浏览器主页后，单击左侧窗格中的日志路由器，然后单击页面顶部可见的“创建接收器”。</li><li id="2e2e" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">提供接收器名称和描述。</li><li id="6964" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">选择“BigQuery dataset”作为接收器目标，并选择现有数据集或从提供的选项中创建新数据集。</li><li id="009d" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">在下一个选项“选择要包含在接收器中的日志”中，为数据融合管道日志提供过滤器，即</li></ol><p id="1356" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">日志名:“数据融合-管道-日志”</p><p id="264d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.单击“创建接收器”按钮，等待接收器成功创建。</p><p id="ba28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将把所有数据融合管道日志推送到一个BigQuery表中。对于这篇博文，我们假设表的名称是<strong class="ih hj"> DF_PIPELINE_LOGS。</strong>下面是该表的样本o/p</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kj"><img src="../Images/3d3e5a011f3b3c11dd3c7c201225a785.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5FYngpkmZjBrQvxk_CvQ5w.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">BQ表—数据融合管道日志</figcaption></figure><p id="ab30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> BQ元数据表</strong> —数据融合实例和管道映射的映射表</p><p id="bc87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果所有管道都部署并运行到单个数据融合实例，则这可能是一个可选表。然而，在我们的用例中，管道被分配给多个数据融合实例。因此，准备一个映射表来将管道与部署它们的数据融合实例进行映射。</p><p id="81c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于我们的blogpost，我们将此表称为<strong class="ih hj">DF _ INST _管道_注册表</strong>，下面是示例条目。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kk"><img src="../Images/b861ff46e36e9babe83cd05f967b10ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RDkI9ODV9yBNKEi6o9KNsA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">BQ映射表</figcaption></figure><p id="4ec2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>:当管道移动到不同的实例时，该表必须手动更新。</p><p id="79aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">【Data studio报告的大查询视图</p><p id="1ea9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们构建一个Bigquery视图，该视图将连接<strong class="ih hj"> DF_PIPELINE_LOGS </strong>和<strong class="ih hj">DF _ INST _ PIPELINE _ REGISTRY</strong>表，并为data studio报告生成一个可供使用的输出。对于这个博客，我们将视图命名为<strong class="ih hj"> DF_PIPELINE_STATUS_VW </strong>。</p><p id="4b9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">视图定义:DF_PIPELINE_STATUS_VW </strong></p><pre class="jf jg jh ji fd kl km kn bn ko kp bi"><span id="285e" class="kq kr hi km b be ks kt l ku kv">WITH dfPipelineLogs AS (<br/>SELECT DISTINCT labels._applicationid as pipelineName,<br/>         labels._runid as run_id,<br/>         CASE WHEN resource.type = 'cloud_dataproc_cluster' THEN resource.labels.cluster_name ELSE NULL END as dataproc_cluster,<br/>         CASE WHEN jsonPayload.message like "Pipeline % running%" THEN "RUNNING" WHEN jsonPayload.message like "Pipeline % succeeded%" THEN "SUCCEEDED" WHEN jsonPayload.message like "Pipeline % failed%"<br/>         or jsonpayload_v1beta1_reportederrorevent.message like "Pipeline % failed%" THEN "FAILED" WHEN jsonPayload.message like "Pipeline % started%" THEN "STARTED" ELSE NULL END as Status,<br/>         FORMAT_DATETIME(<br/>           "%b-%d-%Y",<br/>           datetime(timestamp)<br/>         ) as log_date,<br/>         FORMAT_DATETIME(<br/>           "%H:%M:%S",<br/>           datetime(timestamp)<br/>         ) as log_time,<br/>         labels._namespaceid AS namespace,<br/>         resource.labels.project_id AS project_id,<br/>       FROM<br/>         `&lt;project_id&gt;.&lt;dataset_id&gt;.datafusion_pipeline_logs`<br/>       WHERE<br/>         DATE(timestamp) &gt;= DATE_ADD(<br/>           DATE(current_timestamp),<br/>           INTERVAL -30 DAY<br/>         )<br/>),namespaceInstanceMapping AS(<br/>   SELECT distinct REG.INSTANCE_ID as datafusion_instance,B.pipelineName as pipelineName from `&lt;project_id&gt;.&lt;dataset_id&gt;.DF_INST_PIPELINE_REGISTRY`<br/>)<br/>SELECT<br/> pipelineName,<br/> run_id,<br/> Status,<br/> datafusion_instance,<br/> dataproc_cluster,<br/> log_date,<br/> log_time,<br/> CASE WHEN r_n = 1 THEN 1 ELSE 0 END current_state,<br/> 'use4' as region_id,<br/> namespace,<br/> project_id,<br/> startTime,<br/> endTime,<br/> execution_time_minutes<br/>FROM<br/> (<br/>   SELECT<br/>         A.pipelineName as pipelineName,<br/>         run_id,<br/>         datafusion_instance,<br/>         dataproc_cluster,<br/>         A.Status,<br/>         log_date,<br/>         log_time ,<br/>         ROW_NUMBER() OVER(<br/>         PARTITION BY A.run_id<br/>         ORDER BY<br/>         log_date,<br/>         log_time DESC<br/>     ) as r_<br/>     A.namespace,<br/>     A.project_id,<br/>     startTime,endTime,TIMESTAMP_DIFF(endTime, startTime, MINUTE) as execution_time_minutes<br/>       FROM<br/>         datafusionlogs A<br/>         JOIN namespaceInstanceMapping B ON A.pipelineName = B.pipelineName<br/>   WHERE<br/>     A.Status IS NOT NULL<br/> ) where r_n = 1</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kw"><img src="../Images/bc1c87f8a31570e579c8670a33dbfd5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H1ZxErtDB6aBPhZRj0bxmg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">BQ视图的示例输出</figcaption></figure><p id="ccf0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Data Studio仪表盘</strong></p><p id="1c9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们通过使用Bigquery视图作为源数据集来构建一个仪表板，</p><p id="7c6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为BQ来源创建新控制面板应遵循的步骤</p><ol class=""><li id="b270" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ka kb kc kd bi translated">去谷歌数据工作室，<a class="ae jd" href="https://datastudio.google.com" rel="noopener ugc nofollow" target="_blank">https://datastudio.google.com</a></li><li id="86ff" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">选择一份空白报告，报告打开后，单击顶部栏中的“添加数据”选项。</li><li id="1af7" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">选择“大查询”选项</li><li id="b4b9" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">选择项目、数据集，然后选择要将报表连接到的表或视图。</li><li id="2b13" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">一旦报表连接到数据源，在右窗格中所有字段都将可见。</li><li id="9a1d" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">一旦添加了数据源，我们就可以使用相同的数据添加图表、图块和控件。</li></ol><p id="5442" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是仪表板的样子，</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kx"><img src="../Images/7ed790c210cb0212774b73de622a2ad4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eQyV7EgqEn-9bsugzDzuRg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">数据融合管道仪表板</figcaption></figure><p id="5871" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">数据过滤器可用于过滤特定日期的报告，类似地，还有管道名称和数据融合实例等过滤器。</strong></p><p id="ef2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仪表板中几个图表、表格和过滤器的摘要</p><ul class=""><li id="86ef" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ky kb kc kd bi translated"><strong class="ih hj">成功管道</strong>:默认显示30天内成功运行的管道总数。</li><li id="9399" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ky kb kc kd bi translated"><strong class="ih hj">失败的管道:</strong>显示一段时间内失败的运行总数。</li><li id="2699" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ky kb kc kd bi translated"><strong class="ih hj">正在执行的管道:</strong>当前正在执行的管道总数。</li><li id="ebe9" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ky kb kc kd bi translated"><strong class="ih hj">当前状态下管道运行的分布:</strong>这是一个饼图，显示管道在成功、失败、运行和启动等状态下的百分比分布</li><li id="4c9e" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ky kb kc kd bi translated"><strong class="ih hj">管道在dataproc集群上的分布:</strong>这是一个饼图，显示管道在执行时所使用的dataproc集群上的百分比分布。</li><li id="eee7" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ky kb kc kd bi translated"><strong class="ih hj">运行在数据融合实例上的管道分布:</strong>显示运行在不同数据融合实例上的管道的百分比分布。</li><li id="2806" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ky kb kc kd bi translated">最后一个表显示了一段时间内管道运行及其状态的详细信息。</li></ul><p id="9829" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此报告每1分钟刷新一次，并相应地显示最新数据。Data studio dashboard有一个按需手动刷新数据的选项。</p><p id="c8cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这篇文章对你有帮助！！！快乐学习！！！</p></div></div>    
</body>
</html>