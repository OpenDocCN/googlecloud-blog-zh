<html>
<head>
<title>Exposing the client behind PSC</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">公开PSC背后的客户端</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/exposing-the-client-behind-psc-2471a851ae23?source=collection_archive---------0-----------------------#2021-11-16">https://medium.com/google-cloud/exposing-the-client-behind-psc-2471a851ae23?source=collection_archive---------0-----------------------#2021-11-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/0bcb6ddb83a3ae2a0843d73ddee58943.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CWtRH16xQkDPPcBkq6VEsA.png"/></div></div></figure><p id="7831" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/vpc/docs/private-service-connect?hl=en" rel="noopener ugc nofollow" target="_blank">私有服务连接</a> (PSC)为VPC<strong class="is hj">中的服务启用生产者-消费者模型，它们之间没有网络连接</strong>。GCP使之成为可能，但它意味着将客户端隐藏在请求后面。对于需要发出请求的客户机的源IP的服务来说，这是一个问题。在本文中，我将解释一种向服务公开客户端的方法。</p><h1 id="a913" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">以云的方式连接</h1><p id="54f8" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在GCP，你可以使用<a class="ae jo" href="https://cloud.google.com/vpc/docs/vpc-peering" rel="noopener ugc nofollow" target="_blank"> VPC网络对等</a>或VPN在服务生产者的VPC和服务消费者的VPC之间实现私有连接。这两种方法存在于不同的用例中，有各自的优点和一些限制。值得注意的是，需要不重叠的IP范围。</p><p id="ab3d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">PSC克服了其中的许多限制，允许<em class="ks">私有</em>跨属于不同项目或组织的多个VPC网络消费服务。当然，你不能要求多个组织在给他们的项目分配IP范围时进行协调。PSC不要求。</p><p id="d4b0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我不会分析PSC相对于其他解决方案的所有优势和局限性，但我会简要描述它是如何工作的，以便为接下来的讨论奠定基础。考虑到PSC有几种风格，这里我将讨论“<a class="ae jo" href="https://cloud.google.com/vpc/docs/private-service-connect?hl=en#benefits-services" rel="noopener ugc nofollow" target="_blank"> PSC发布和消费服务</a>”。</p><h1 id="6887" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">PSC架构</h1><p id="967a" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">PSC最简单的形式非常简单。生产者VPC提供服务，消费者VPC将消费该服务。生产者创建一个<em class="ks">服务附件</em>来公开服务，消费者创建一个<em class="ks">端点</em>来定位这个附件。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kt"><img src="../Images/64685befcc551a82ff82bcbd13ef8d2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ESNqbOvPURA5j-GZ7ZjWnA.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">基本PSC架构。</figcaption></figure><p id="72e4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该服务需要是负载平衡的服务，对于GCP，这可以是L4或L7内部负载平衡器(ILB)。服务附件指向该负载均衡器的<a class="ae jo" href="https://cloud.google.com/load-balancing/docs/forwarding-rule-concepts" rel="noopener ugc nofollow" target="_blank"> <em class="ks">转发规则</em> </a>。端点本身是一个转发规则，其目标是服务附件URI，而不是后端服务或代理。</p><p id="fbf8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，这些VPC之间没有第3层网络连接，每个VPC都有自己独立的网络域。你只需要处理API来建立关系，GCP的软件定义网络平台Andromeda会处理剩下的事情。现在，这些VPC可以使用相同的IP范围，重叠不再是问题。事实上，PSC允许部署多租户模型，在该模型中，您的服务由多个消费者使用，而不管他们的子网范围。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lc"><img src="../Images/c19983a1617b0f2917d31b653243d3a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0sZ2DlAqclJh4sBOhFG9RQ.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">具有重叠地址的多租户模型。</figcaption></figure><h1 id="9a44" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">事情可能会发生的地方</h1><p id="df57" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我提到PSC公开了L4或L7 ILB背后的服务。L7 ILB是一个HTTP代理，因此后端会将代理IP视为请求中的源IP。如果他们需要发出请求的客户端的原始源IP，则报头“X-Forwarded-For”包含该信息。</p><p id="c106" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">L4 ILB不是一个代理虽然。服务附件需要定义一个NAT范围，PSC使用该范围将请求的源IP转换为生产者VPC的一部分。后端会将该NAT范围内的IP视为来源，这意味着通常非HTTP应用程序不会看到原始的客户端IP。</p><p id="d83c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不过有一个变通办法。<a class="ae jo" href="http://www.haproxy.org/download/1.8/doc/proxy-protocol.txt" rel="noopener ugc nofollow" target="_blank">代理</a>协议被设计用来将信息从客户端连接转发到下一个主机。这是通过在每个连接开始时在L4添加报头来实现的。PSC与代理协议兼容，因此您可以在创建服务附件时启用它。当然，接收该信息的后端应用程序应该与该协议兼容，否则连接将失败。</p><p id="0e5c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是事情变得复杂的地方。许多应用程序与代理协议不兼容，如果您有这样的应用程序，并且需要保留原始的客户端IP，PSC和NAT通常会成为一个问题。这个用例是本文的重点。</p><h1 id="aa0f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">测试部署</h1><p id="5250" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我将部署一个测试场景来向您展示这一切是如何进行的。尽管我提到过地址重叠不是问题，但为了便于理解，我将使用不同的子网范围。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ld"><img src="../Images/a2cf58e4adfe7117764d31223a96df12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VPx_Jb_lfovlWm5NdLID7Q.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">初始测试场景。</figcaption></figure><p id="75f5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我不会在这里键入所有的安装说明，只是那些与PSC和测试它更相关的说明。我认为你能够填补这些空白。</p><h2 id="56a3" class="le jq hi bd jr lf lg lh jv li lj lk jz jb ll lm kd jf ln lo kh jj lp lq kl lr bi translated">*服务</h2><p id="8189" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">该服务由作为实例组一部分的两个虚拟机和指向它的名为“ilb-myservice”的内部TCP/UDP负载平衡器组成。出于测试目的，我在每台服务器上运行了一个简单的HTTP服务器。正如我所说的，本文的重点是L3/L4应用程序，但是对于测试来说，使用一些日志和工具curl运行一个简单的web服务器是非常方便的:</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="2eda" class="le jq hi lt b fi lx ly l lz ma">$ python3 -m http.server 8080</span></pre><h2 id="a895" class="le jq hi bd jr lf lg lh jv li lj lk jz jb ll lm kd jf ln lo kh jj lp lq kl lr bi translated">*服务附件</h2><p id="bb98" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">首先，您需要一个用于服务附件的NAT子网。此子网仅用于PSC，不能用于虚拟机等其他资源:</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="e834" class="le jq hi lt b fi lx ly l lz ma">$ gcloud compute networks subnets create producer-subnet-psc --network vpc-producer --region europe-west1 --range 10.10.0.0/24 --purpose PRIVATE_SERVICE_CONNECT</span></pre><p id="2ca8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">服务附件指向“ilb-myservice-forwarding-rule”，使用之前的NAT子网“producer-subnet-PSC”(10 . 10 . 0 . 0/24):</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="2d5a" class="le jq hi lt b fi lx ly l lz ma">$ gcloud compute service-attachments create myservice-attachment --region europe-west1 --producer-forwarding-rule ilb-myservice-forwarding-rule --connection-preference=ACCEPT_AUTOMATIC --nat-subnets producer-subnet-psc</span></pre><h2 id="be56" class="le jq hi bd jr lf lg lh jv li lj lk jz jb ll lm kd jf ln lo kh jj lp lq kl lr bi translated">*端点</h2><p id="b23b" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">为消费者VPC中的端点保留内部IP地址:</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="d5d2" class="le jq hi lt b fi lx ly l lz ma">$ gcloud compute addresses create ip-psc-endpoint --region europe-west1 --subnet consumer-subnet-1 --addresses 172.16.0.10</span></pre><p id="5d52" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建转发规则以将端点连接到生成器的服务附件:</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="9c42" class="le jq hi lt b fi lx ly l lz ma">$ gcloud compute forwarding-rules create fr-psc-endpoint --region europe-west1 --network vpc-consumer --address ip-psc-endpoint --target-service-attachment projects/[PRODUCER_PROJECT_ID]/regions/europe-west1/serviceAttachments/myservice-attachment</span></pre><h2 id="00c6" class="le jq hi bd jr lf lg lh jv li lj lk jz jb ll lm kd jf ln lo kh jj lp lq kl lr bi translated">*测试连接</h2><p id="2ece" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">如果我们通过端点从消费虚拟机向服务发出请求，我们可以检查它是否工作，尽管VPC没有连接！</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/26185ec329b46aaa21d8a9fe72559b2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KLivNqJvOKUcLBBtvYiPqA.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">从消费者到生产者VPC的连接测试。</figcaption></figure><p id="2c51" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意该请求是如何被视为来自IP 10.10.0.6，来自NAT范围的。该请求也发送到端点IP 172 . 16 . 0 . 10，但是它通过ILB VIP 10 . 1 . 0 . 50到达后端。你可以用' tcpdump '或者<a class="ae jo" href="https://cloud.google.com/vpc/docs/flow-logs" rel="noopener ugc nofollow" target="_blank"> VPC流量日志</a>如果你不信任我:)</p><h1 id="825d" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">公开客户端</h1><p id="10c4" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">PSC是在云中连接消费者和服务的一种很好的方式，因此对于那些需要知道客户端IP的应用程序来说，也值得利用它。我们需要使用代理协议来恢复这些信息，但是由于我们正在考虑不兼容的应用程序，我们需要一个代理服务来理解代理协议并为它们处理它，还需要一些管道。</p><p id="c0ba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我将部署一个运行<a class="ae jo" href="https://www.haproxy.com/" rel="noopener ugc nofollow" target="_blank"> HAProxy </a>的代理虚拟机。我选择这个软件是因为它是一个伟大的TCP/HTTP代理和负载均衡器，一个HAProxy开发者设计了代理协议，所以它得到了很好的支持。您可以使用免费版或付费版来获得更多的企业功能和支持。</p><p id="6700" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">其思想是代理将通过服务附件中启用的代理协议接收连接及其信息。然后，我将使用这些信息来翻译请求并连接到服务。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/a0ad372e1f37c45f898dcbfb70bd92bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VxXxKfRcWBcfp1ty2HlQzw.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">通过代理服务公开客户端。注意，现在有两个TCP连接。</figcaption></figure><h2 id="5576" class="le jq hi bd jr lf lg lh jv li lj lk jz jb ll lm kd jf ln lo kh jj lp lq kl lr bi translated">*配置代理虚拟机</h2><p id="f0a6" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">代理虚拟机将转发来源不同于其内部IP的数据包，因此它需要在虚拟机级别启用IP转发:</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="e940" class="le jq hi lt b fi lx ly l lz ma">$ gcloud compute instances create ... --can-ip-forward</span></pre><p id="b5f9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，它还需要接受对这些来源的回应。为此我们将配置<em class="ks"> AnyIP </em>功能:</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="e621" class="le jq hi lt b fi lx ly l lz ma">proxy$ sudo ip route add local 172.16.0.0/24 dev lo</span></pre><p id="435f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们正在为消费者IP范围添加一个本地路由，这样我们的虚拟机将接受IP上未明确配置的流量。要删除与消费者VPC的相关性，您可以使用172.16.0.0/12这样的范围。</p><h2 id="fabb" class="le jq hi bd jr lf lg lh jv li lj lk jz jb ll lm kd jf ln lo kh jj lp lq kl lr bi translated">*安装和配置HAProxy</h2><p id="813e" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在此按照<a class="ae jo" href="https://haproxy.debian.net/" rel="noopener ugc nofollow" target="_blank">中的说明安装HAProxy。它带有一个默认配置，通常位于“/etc/haproxy/haproxy.cfg”中。HAProxy有很多</a><a class="ae jo" href="http://cbonte.github.io/haproxy-dconv/2.4/configuration.html" rel="noopener ugc nofollow" target="_blank">特性和选项</a>我就不一一介绍了，只有你需要修改的最少部分才能让我们的设置工作:</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="0056" class="le jq hi lt b fi lx ly l lz ma">global<br/>  # Comment out these two lines to be root and spoof client IP<br/>  #user haproxy<br/>  #group haproxy</span><span id="de9f" class="le jq hi lt b fi md ly l lz ma">defaults<br/>  # Use TCP load balancing<br/>  #mode http<br/>  #option httplog<br/>  mode tcp<br/>  option tcplog</span><span id="2efa" class="le jq hi lt b fi md ly l lz ma">frontend myfrontend<br/>  # Accept PSC connections on this port. Enable PROXY protocol, PSC will send client connection information on it<br/>  bind :8080 accept-proxy<br/>  # Dispatch the accepted connections to this backend<br/>  default_backend myservice</span><span id="8210" class="le jq hi lt b fi md ly l lz ma">backend myservice<br/>  # Set source address for outgoing connections, using source IP (and port) from client connection<br/>  source 0.0.0.0 usesrc client<br/>  # The backend is the ILB<br/>  server fw_rule 10.1.0.50</span></pre><p id="b345" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">保存文件并重新启动服务:</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="94d0" class="le jq hi lt b fi lx ly l lz ma">proxy$ sudo systemctl restart haproxy</span></pre><h2 id="b0d9" class="le jq hi bd jr lf lg lh jv li lj lk jz jb ll lm kd jf ln lo kh jj lp lq kl lr bi translated">*更多管道</h2><p id="4788" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">使代理虚拟机成为实例组的一部分，并放置一个指向它的内部TCP/UDP负载平衡器，称为“ilb-proxy”。它将由PSC使用。您还需要在生产者VPC中创建一个到该ILB的路由，以将流量发送回来:</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="e2e5" class="le jq hi lt b fi lx ly l lz ma">$ gcloud compute routes create route-via-proxy --network=vpc-producer --destination-range=172.16.0.0/24 --next-hop-ilb=ilb-proxy-forwarding-rule</span></pre><p id="744a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">同样，这里您可以使用172.16.0.0/12这样的范围，这样您就不需要为每个消费者指定新的路由。</p><h2 id="b0f7" class="le jq hi bd jr lf lg lh jv li lj lk jz jb ll lm kd jf ln lo kh jj lp lq kl lr bi translated">*配置PSC</h2><p id="3a8d" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">删除以前的服务附件，创建一个指向“ilb-proxy-forwarding-rule”的新服务附件，这次启用代理协议:</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="083b" class="le jq hi lt b fi lx ly l lz ma">$ gcloud compute service-attachments create myservice-attachment --region europe-west1 --producer-forwarding-rule ilb-proxy-forwarding-rule --connection-preference=ACCEPT_AUTOMATIC --nat-subnets producer-subnet-psc --enable-proxy-protocol</span></pre><p id="2dac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于附件已更改，您需要删除端点并重新创建它:</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="a27a" class="le jq hi lt b fi lx ly l lz ma">$ gcloud compute forwarding-rules create fr-psc-endpoint --region europe-west1 --network vpc-consumer --address ip-psc-endpoint --target-service-attachment projects/[PRODUCER_PROJECT_ID]/regions/europe-west1/serviceAttachments/myservice-attachment</span></pre><h2 id="321f" class="le jq hi bd jr lf lg lh jv li lj lk jz jb ll lm kd jf ln lo kh jj lp lq kl lr bi translated">*试金石</h2><p id="dfde" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">让我们从消费者虚拟机发出一个请求。如果一切正常，后端应该将客户机IP视为请求源。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/83040da036c2a9f3b10b4a78be924419.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-TZU6iEIq5MlwVzy1JTwBQ.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">使用代理协议的连接测试。</figcaption></figure><p id="c06b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">\o/</p><h1 id="8ad1" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">让它可用</h1><p id="c4c6" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">现在我们已经有了从客户端转发请求的HAProxy，下一个合乎逻辑的步骤是通过部署多个代理来提高系统的可用性。我会让读者这样做，但有一些警告要考虑。</p><p id="7ad8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我说过PSC允许部署多租户模型，其中重叠的IP范围不是问题。然而，当我们使用代理协议来公开客户端IP时，情况就不同了。想想看，后端想要通过IP来识别客户端，如果多个客户端使用同一个IP，这怎么可能呢？</p><p id="a190" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">部署几个代理提出了一个相关的问题。如果两个代理可以伪造对相同IP范围的请求，来自后端的响应可能会命中错误的代理。</p><p id="fde8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对此的一个解决方案是部署主动/被动配置。我们可以在ILB上配置第二个代理作为故障切换后端。当主后端不正常时，GCP会执行故障切换，新连接会定向到备份虚拟机。如果主虚拟机恢复并通过运行状况检查，GCP会执行回切。这样，您在任何时候都只有一个活动代理。</p><p id="661f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我提到了健康检查。直到现在，我也没说怎么给HAProxy配置，因为它不是必不可少的。但是您需要它来使故障转移正常工作。“/etc/haproxy/haproxy.cfg”的以下代码片段显示了在端口8081上配置对运行状况检查的响应的示例:</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="a105" class="le jq hi lt b fi lx ly l lz ma">frontend health-checks<br/>  mode http<br/>  bind :8081<br/>  http-request return</span></pre><p id="1692" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">HAProxy将绑定到端口8081，您需要在那里进行ILB健康检查，并将立即向GCP探测器返回200 OK。</p><p id="9495" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">部署故障转移后端后，您可以通过简单地停止和启动主后端上的HAProxy服务并观察流量采用的不同路由来测试它的工作情况(‘tcpdump’是您的朋友；):</p><pre class="ku kv kw kx fd ls lt lu lv aw lw bi"><span id="e6d1" class="le jq hi lt b fi lx ly l lz ma">proxy$ sudo systemctl stop haproxy<br/>proxy$ sudo systemctl start haproxy</span></pre><h1 id="8c03" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">最终注释</h1><p id="5acc" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">你应该考虑到PSC有一些限制。其中一些在将来可能会被删除(也许在你读这篇文章的时候它们还不是一个限制)。例如:</p><ul class=""><li id="59d2" class="mf mg hi is b it iu ix iy jb mh jf mi jj mj jn mk ml mm mn bi translated">PSC只支持TCP服务的代理协议，不支持UDP。</li><li id="1693" class="mf mg hi is b it mo ix mp jb mq jf mr jj ms jn mk ml mm mn bi translated">PSC端点必须与服务附件位于同一区域。</li><li id="f25d" class="mf mg hi is b it mo ix mp jb mq jf mr jj ms jn mk ml mm mn bi translated">不支持使用互连附件(VLANs)从内部访问PSC端点。</li></ul><p id="6d2e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请参考<a class="ae jo" href="https://cloud.google.com/vpc/docs/private-service-connect?hl=en" rel="noopener ugc nofollow" target="_blank">公开文档</a>获取最新信息。</p><p id="b0b9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">总之，港口国监督仍有改进的余地，但它是在GCP建立生产者-消费者模式的一个很好的方式。我希望你看完这篇文章后会开始更多地使用它。</p></div></div>    
</body>
</html>