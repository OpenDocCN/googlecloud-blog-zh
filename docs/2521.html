<html>
<head>
<title>High-resolution user-defined metrics for Google Managed Prometheus with managed collector</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有托管收集器的Google托管Prometheus的高分辨率用户定义指标</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/high-resolution-user-defined-metrics-for-google-managed-prometheus-with-managed-collector-5a917c68fe22?source=collection_archive---------2-----------------------#2022-11-17">https://medium.com/google-cloud/high-resolution-user-defined-metrics-for-google-managed-prometheus-with-managed-collector-5a917c68fe22?source=collection_archive---------2-----------------------#2022-11-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="75d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文与<a class="ae jd" href="https://tw.linkedin.com/in/scott-hsieh" rel="noopener ugc nofollow" target="_blank"> Scott Hsieh </a>、<a class="ae jd" href="https://sg.linkedin.com/in/samazit" rel="noopener ugc nofollow" target="_blank"> Salem Amazit </a>、<a class="ae jd" href="https://id.linkedin.com/in/trinquiervannick" rel="noopener ugc nofollow" target="_blank"> Vannick Trinquier </a>和<a class="ae jd" href="https://sg.linkedin.com/in/feng-han-381595102" rel="noopener ugc nofollow" target="_blank"> Ethan Han </a>合作发表。</p><h1 id="6225" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">背景</h1><p id="b773" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">本指南介绍了一个解决方案，以解决带有托管收集器的<a class="ae jd" href="https://cloud.google.com/stackdriver/docs/managed-prometheus/setup-managed" rel="noopener ugc nofollow" target="_blank">Google Cloud Managed Service for Prometheus(GMP)的局限性。本文中讨论的解决方案为带有托管收集器的GMP提供了额外的灵活性。它允许用户调整刮擦间隔，以更高的分辨率收集细粒度指标。</a></p><p id="8780" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">带托管收集器的GMP原生支持<a class="ae jd" href="https://github.com/GoogleCloudPlatform/prometheus-engine/blob/v0.4.3-gke.0/doc/api.md#podmonitoring" rel="noopener ugc nofollow" target="_blank"> PodMonitoring </a>中的刮擦间隔调整。用户可以使用PodMonitoring资源中的interval参数来调整GMP监控的应用程序的刮擦时间间隔。具有受管收集器的GMP禁用了配置，以覆盖受管prometheus的<a class="ae jd" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/" rel="noopener ugc nofollow" target="_blank">全局刮擦间隔</a>。默认全局擦除时间间隔配置为60秒。</p><p id="90a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">带有托管收集器的GMP的默认行为不支持<a class="ae jd" href="https://github.com/google/cadvisor" rel="noopener ugc nofollow" target="_blank"> cadvisor </a>的更高分辨率指标或其他Kubernetes系统指标。</p><p id="6de5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更高分辨率的指标对于监控动态变化的环境至关重要。任务关键型系统就是这种情况，例如:</p><ul class=""><li id="00fb" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">金融服务业，</li><li id="8fa6" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">在Kubernetes集群上自动扩展突发工作负载</li></ul><h1 id="28af" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">设计</h1><p id="403e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">通过使用定制的Prometheus exporter和expose metrics in application来解决GMP对托管收集器的限制，可以实现高频率的收集。</p><p id="2790" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">自定义Prometheus导出器可以用官方的<a class="ae jd" href="https://prometheus.io/docs/instrumenting/clientlibs/" rel="noopener ugc nofollow" target="_blank"> Prometheus客户端库</a>以支持的语言编写，并以Prometheus格式公开自定义指标。</p><p id="3220" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如:</p><ul class=""><li id="9096" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">CPU/内存使用率</li><li id="74f9" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">HTTP请求成功/失败计数</li><li id="7f76" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">API调用延迟</li></ul><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/344cfe30a398d118e3ef79813d722017.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*taJ2cQKveAiogVLG"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated"><a class="ae jd" href="https://cloud.google.com/stackdriver/docs/managed-prometheus" rel="noopener ugc nofollow" target="_blank">托管Prometheus</a></figcaption></figure><p id="8aa5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">托管收集可以通过使用<a class="ae jd" href="https://github.com/GoogleCloudPlatform/prometheus-engine/blob/v0.4.3-gke.0/doc/api.md#podmonitoring" rel="noopener ugc nofollow" target="_blank"> PodMonitoring </a>以最小5秒的采样间隔收集这些自定义指标。</p><h1 id="d888" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">逐步指南</h1><h2 id="6078" class="ll jf hi bd jg lm ln lo jk lp lq lr jo iq ls lt js iu lu lv jw iy lw lx ka ly bi translated">先决条件</h2><p id="a61d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">您需要具备以下先决条件才能开始创建prometheus自定义导出器:</p><ul class=""><li id="c9f8" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae jd" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" rel="noopener ugc nofollow" target="_blank">谷歌云项目</a></li><li id="c3fd" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">对<a class="ae jd" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank"> Google Kubernetes引擎</a>的基本了解</li><li id="13e5" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">对<a class="ae jd" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank">码头工人</a>的基本了解</li><li id="5bf0" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">对<a class="ae jd" href="http://prometheus" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a>的基本认识</li></ul><p id="6c22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启用了以下API:</p><ul class=""><li id="c536" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">服务:container.googleapis.com</li></ul><h2 id="1658" class="ll jf hi bd jg lm ln lo jk lp lq lr jo iq ls lt js iu lu lv jw iy lw lx ka ly bi translated">项目设置</h2><p id="cac8" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">客户导出器是用Python写的，你可以使用其他语言，比如Java，或者去写自定义导出器。</p><p id="5850" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有关项目相关参数和配置，请参考以下配置。请相应地更改配置。</p><blockquote class="lz ma mb"><p id="eb19" class="if ig mc ih b ii ij ik il im in io ip md ir is it me iv iw ix mf iz ja jb jc hb bi translated"><strong class="ih hj">区域</strong>:亚洲-东南亚1-a</p><p id="5465" class="if ig mc ih b ii ij ik il im in io ip md ir is it me iv iw ix mf iz ja jb jc hb bi translated"><strong class="ih hj">项目ID </strong> : gmp-demo-project</p><p id="5ed8" class="if ig mc ih b ii ij ik il im in io ip md ir is it me iv iw ix mf iz ja jb jc hb bi translated"><strong class="ih hj"> GKE集群名称</strong>:GMP-集群</p><p id="85ad" class="if ig mc ih b ii ij ik il im in io ip md ir is it me iv iw ix mf iz ja jb jc hb bi translated"><strong class="ih hj"> GKE集群命名空间</strong> : gmp-test</p></blockquote><p id="5da2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有命令都将在<a class="ae jd" href="https://cloud.google.com/shell" rel="noopener ugc nofollow" target="_blank">云壳</a>中执行。</p><h2 id="c064" class="ll jf hi bd jg lm ln lo jk lp lq lr jo iq ls lt js iu lu lv jw iy lw lx ka ly bi translated">初始化项目</h2><p id="040e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">您可以将每个值替换为您自己的配置。</p><ol class=""><li id="a940" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc mg kn ko kp bi translated">将<em class="mc">项目ID </em>值配置为<em class="mc"> gmp-demo-project </em></li></ol><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="230e" class="mm jf hi mi b be mn mo l mp mq">export PROJECT_ID=gmp-demo-project</span></pre><p id="482f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.将<em class="mc">区域</em>值配置为<em class="mc">亚洲-东南1-a </em></p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="6853" class="mm jf hi mi b be mn mo l mp mq">export ZONE=asia-southeast1-a</span></pre><p id="72f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.将<em class="mc">集群</em>值配置为<em class="mc">GMP-集群</em></p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="8d3d" class="mm jf hi mi b be mn mo l mp mq">export CLUSTER=gmp-cluster</span></pre><p id="ab2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.将<em class="mc">名称空间</em>值配置为<em class="mc">GMP-测试</em></p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="519f" class="mm jf hi mi b be mn mo l mp mq">export NAMESPACE=gmp-test</span></pre><h2 id="0095" class="ll jf hi bd jg lm ln lo jk lp lq lr jo iq ls lt js iu lu lv jw iy lw lx ka ly bi translated">部署Kubernetes集群</h2><ol class=""><li id="5a80" class="kh ki hi ih b ii kc im kd iq mr iu ms iy mt jc mg kn ko kp bi translated">使用环境变量<em class="mc"> PROJECT_ID </em>将项目设置为<em class="mc"> gmp-demo-project </em>。</li></ol><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="c8d5" class="mm jf hi mi b be mn mo l mp mq">gcloud config set project $PROJECT_ID</span></pre><p id="3fbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.部署启用了托管prometheus的GKE集群。GKE集群将部署在<em class="mc">亚洲-东南亚1-a </em>区域<em class="mc">环境可变</em>。</p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="8dc0" class="mm jf hi mi b be mn mo l mp mq">gcloud beta container clusters create $CLUSTER --num-nodes=3 --zone $ZONE --enable-managed-prometheus</span></pre><p id="6c44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.检索GKE集群身份证明</p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="f0f0" class="mm jf hi mi b be mn mo l mp mq">gcloud container clusters get-credentials $CLUSTER --zone $ZONE --project $PROJECT_ID</span></pre><p id="40b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.为GKE集群创建命名空间</p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="80d3" class="mm jf hi mi b be mn mo l mp mq">kubectl create ns $NAMESPACE</span></pre><h2 id="3618" class="ll jf hi bd jg lm ln lo jk lp lq lr jo iq ls lt js iu lu lv jw iy lw lx ka ly bi translated">包装定制出口商</h2><p id="25a6" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我们需要创建一个应用程序，打包并存储在<a class="ae jd" href="https://cloud.google.com/container-registry" rel="noopener ugc nofollow" target="_blank">容器注册表</a>中。</p><ol class=""><li id="4c7c" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc mg kn ko kp bi translated">创建一个文件夹<em class="mc">GMP-演示-应用</em></li></ol><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="8135" class="mm jf hi mi b be mn mo l mp mq">mkdir gmp-demo-application &amp;&amp; cd gmp-demo-application</span></pre><p id="e8d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.在<em class="mc"> gmp-demo-application </em>中，创建一个python文件，命名为<em class="mc"> app.py </em>。该应用程序将收集Pod CPU利用率，并通过指标端点公开。</p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="6ada" class="mm jf hi mi b be mn mo l mp mq">#The content of this page is licensed under the Creative Commons Attribution <br/>#4.0 License, and code samples are licensed under the Apache 2.0 License<br/><br/>import logging<br/>import random<br/>import time<br/><br/>import psutil<br/>from flask import Flask<br/>from prometheus_client import Counter, Gauge, generate_latest, Histogram, REGISTRY<br/><br/>logger = logging.getLogger(__name__)<br/><br/>app = Flask(__name__)<br/><br/>CONTENT_TYPE_LATEST = str('text/plain; version=0.0.4; charset=utf-8')<br/><br/>number_of_requests = Counter(<br/>    'number_of_requests',<br/>    'The number of requests, a counter so the value can increase or reset to zero.'<br/>)<br/><br/>custom_collector_cpu_usage = Gauge(<br/>    'custom_collector_cpu_usage',<br/>    'The current value of cpu usage, a gauge so it can go up or down.',<br/>    ['server_name']<br/>)<br/><br/>PYTHON_REQUESTS_COUNTER = Counter("python_requests", "total requests")<br/>PYTHON_FAILED_REQUESTS_COUNTER = Counter("python_failed_requests", "failed requests")<br/>PYTHON_LATENCIES_HISTOGRAM = Histogram(<br/>    "python_request_latency", "request latency by path"<br/>)<br/><br/><br/>@app.route('/metrics', methods=['GET'])<br/>def get_data():<br/>    """Returns all data as plaintext."""<br/>    number_of_requests.inc()<br/>    custom_collector_cpu_usage.labels('custom_collector_cpu_usage').set(int(psutil.cpu_percent() * 10))<br/>    return generate_latest(REGISTRY), 200<br/><br/><br/>@app.route("/")<br/># [START monitoring_sli_metrics_prometheus_latency]<br/>@PYTHON_LATENCIES_HISTOGRAM.time()<br/># [END monitoring_sli_metrics_prometheus_latency]<br/>def homepage():<br/>    # count request<br/>    PYTHON_REQUESTS_COUNTER.inc()<br/>    # fail 10% of the time<br/>    if random.randint(0, 100) &gt; 90:<br/>        PYTHON_FAILED_REQUESTS_COUNTER.inc()<br/>        # [END monitoring_sli_metrics_prometheus_counts]<br/>        return ("error!", 500)<br/>    else:<br/>        random_delay = random.randint(0, 5000) / 1000<br/>        # delay for a bit to vary latency measurement<br/>        time.sleep(random_delay)<br/>        return "home page"<br/><br/><br/>if __name__ == '__main__':<br/>    app.run(host='0.0.0.0', port=8080)<br/></span></pre><p id="7cd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.用以下内容创建一个<em class="mc"> Dockerfile </em>。</p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="4b45" class="mm jf hi mi b be mn mo l mp mq">#The content of this page is licensed under the Creative Commons Attribution <br/>#4.0 License, and code samples are licensed under the Apache 2.0 License<br/>FROM python:latest<br/><br/>COPY . .<br/><br/>RUN pip3 install -r requirements.txt<br/><br/>EXPOSE 8080<br/><br/>CMD python3 app.py</span></pre><p id="f8e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.用以下内容创建一个<em class="mc"> requirements.txt </em>。</p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="50bb" class="mm jf hi mi b be mn mo l mp mq">prometheus_client<br/>psutil<br/>flask</span></pre><p id="7b91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.通过执行以下命令构建Docker容器</p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="0b22" class="mm jf hi mi b be mn mo l mp mq">docker build -t custom-collector-demo:0.1 .</span></pre><p id="92bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.标记Docker容器。</p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="6365" class="mm jf hi mi b be mn mo l mp mq"><br/>docker tag custom-collector-demo:0.1 gcr.io/$PROJECT_ID/custom-collector-demo:0.1</span></pre><p id="a681" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.在你的项目下将码头集装箱推到GCR。</p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="0e2c" class="mm jf hi mi b be mn mo l mp mq">docker push gcr.io/$PROJECT_ID/custom-collector-demo:0.1</span></pre><h2 id="cdeb" class="ll jf hi bd jg lm ln lo jk lp lq lr jo iq ls lt js iu lu lv jw iy lw lx ka ly bi translated">将海关出口商部署到GKE</h2><p id="ba74" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在，我们将为应用程序创建一个部署，并部署一个<a class="ae jd" href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/design.md" rel="noopener ugc nofollow" target="_blank"> PodMonitoring定制资源</a> (CRs)。</p><ol class=""><li id="a8a3" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc mg kn ko kp bi translated">创建一个部署yaml文件，命名为<em class="mc">GMP-custom-exporter-deployment . YAML</em>。记得将<em class="mc"> gmp-demo-project </em>更改为您的<em class="mc">项目ID。</em></li></ol><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="f0d2" class="mm jf hi mi b be mn mo l mp mq"># The content of this page is licensed under the Creative Commons Attribution # 4.0<br/># License, and code samples are licensed under the Apache 2.0 License<br/><br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: flask-example<br/>  labels:<br/>    app: flask-example<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: flask-example<br/>  replicas: 3<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: flask-example<br/>    spec:<br/>      containers:<br/>      - image: gcr.io/gmp-demo-project/custom-collector-demo:0.1<br/>        name: flask-example<br/>        ports:<br/>        - name: metrics<br/>          containerPort: 8080</span></pre><p id="3538" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.创建一个自定义资源，并将其命名为gmp-podmonitoring.yaml。您可以调整内部值来控制采样频率，截至编写日期，最小采样间隔为5秒。</p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="0156" class="mm jf hi mi b be mn mo l mp mq"># The content of this page is licensed under the Creative Commons Attribution 4.0<br/># License, and code samples are licensed under the Apache 2.0 License<br/><br/>apiVersion: monitoring.googleapis.com/v1<br/>kind: PodMonitoring<br/>metadata:<br/>  name: flask-example<br/>  labels:<br/>    app.kubernetes.io/name: flask-example<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: flask-example<br/>  endpoints:<br/>  - port: metrics<br/>    interval: 5s</span></pre><p id="e334" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.部署部署和PodMonitoring资源。</p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="474f" class="mm jf hi mi b be mn mo l mp mq">kubectl -n $NAMESPACE apply -f gmp-custom-exporter-deployment.yaml<br/>kubectl -n $NAMESPACE apply -f gmp-podmonitoring.yaml</span></pre><p id="eba8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.可选步骤，您可以检查Pod部署状态。</p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="a4c0" class="mm jf hi mi b be mn mo l mp mq">kubectl get pods -n $NAMESPACE -w</span></pre><h2 id="81b1" class="ll jf hi bd jg lm ln lo jk lp lq lr jo iq ls lt js iu lu lv jw iy lw lx ka ly bi translated">在监控仪表板中可视化</h2><p id="d57b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在这一步中，我们将从Metrics Explore中检索自定义指标。</p><ol class=""><li id="cb46" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc mg kn ko kp bi translated">访问“监控”页面，并选择度量浏览器。</li></ol><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mu"><img src="../Images/26a5061a06cb06c9d456b5894e0b1d98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hC2Rz1qjkV1HBHy4FPsC2g.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">监控仪表板</figcaption></figure><p id="5717" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.单击MQL并键入以下查询。<em class="mc">custom _ collector _ CPU _ usage</em>是我们在<em class="mc"> app.py </em>中定义的自定义指标。单击运行查询，您将看到收集的指标出现在控制面板上。</p><pre class="kw kx ky kz fd mh mi mj bn mk ml bi"><span id="59a7" class="mm jf hi mi b be mn mo l mp mq">fetch prometheus_target<br/>| metric 'prometheus.googleapis.com/custom_collector_cpu_usage/gauge'</span></pre><p id="049a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.您可以放大查看仪表板中的值，以便仅显示30秒的结果。下面的两个图表显示了以5秒为间隔的CPU利用率。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mv"><img src="../Images/3a0e73af97af5deb4b8a3a9b059f6d30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X91sXQzxxofVftzzPD6rqw.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">数据点1</figcaption></figure><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mw"><img src="../Images/539a8ff1e080ac2f8ca95b2e7f2eee7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PlD0aVZ4UJQSKdu-Jy1YEA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">数据点2</figcaption></figure></div></div>    
</body>
</html>