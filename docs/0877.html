<html>
<head>
<title>StatsD OpenCensus backend</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">StatsD开放普查后端</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/statsd-opencensus-backend-33297c6a58b5?source=collection_archive---------1-----------------------#2019-01-12">https://medium.com/google-cloud/statsd-opencensus-backend-33297c6a58b5?source=collection_archive---------1-----------------------#2019-01-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7286" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Datadog的OpenCensus <a class="ae jd" href="https://github.com/DataDog/opencensus-go-exporter-datadog" rel="noopener ugc nofollow" target="_blank">实现</a>利用Datadog的<a class="ae jd" href="https://docs.datadoghq.com/agent" rel="noopener ugc nofollow" target="_blank">代理</a>将指标数据路由到它的服务。具体来说，它的OpenCensus客户端使用代理的<a class="ae jd" href="https://docs.datadoghq.com/developers/dogstatsd/" rel="noopener ugc nofollow" target="_blank"> DogStatsD </a>实现。本质上，DogStatsD是一个带铃铛的StatsD客户端。</p><p id="e0b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这让我想到，通用的<a class="ae jd" href="https://github.com/etsy/statsd" rel="noopener ugc nofollow" target="_blank"> StatsD </a>后端对<a class="ae jd" href="http://opencensus.io" rel="noopener ugc nofollow" target="_blank"> OpenCensus </a>有用吗？谁知道呢！但是我开始玩一个。叫做<a class="ae jd" href="https://github.com/DazWilkin/statsd-opencensus-backend" rel="noopener ugc nofollow" target="_blank">statsd-open census-back end</a>。</p><p id="ac3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">完全公开</strong>:它目前不能与Stackdriver(调试)一起工作，但可以与Prometheus一起工作。</p><p id="f0cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更新:它对斯塔克怀特和普罗米修斯都有效。我应该听从我自己的建议。如果您不为您的GCP项目分配计费，将不会报告指标！:-)</p><p id="810a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">要求</strong></p><p id="338d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于普罗米修斯，你不需要额外的东西。</p><p id="817c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于Stackdriver，你需要一个谷歌云平台账户(和账单)；可以写入Stackdriver的服务帐户；和一个Stackdriver工作区(目前只能使用浏览器客户端grr！):</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="f5ef" class="jn jo hi jj b fi jp jq l jr js">PROJECT=[[YOUR-PROJECT]]<br/>BILLING=[[YOUR-BILLING]]<br/>ACCOUNT=[[YOUR-SERVICE-ACCOUNT]]<br/>ADDRESS=${ACCOUNT}@${PROJECT}.iam.gserviceaccount.com</span><span id="95e5" class="jn jo hi jj b fi jt jq l jr js">WORK=[[YOUR-WORKING-DIRECTORY]]<br/>FILE="${WORK}/${ACCOUNT}.key.json"</span><span id="6807" class="jn jo hi jj b fi jt jq l jr js">gcloud projects create ${PROJECT}</span><span id="2f86" class="jn jo hi jj b fi jt jq l jr js">gcloud beta billing projects link ${PROJECT} \<br/>--billing-account=${BILLING}</span><span id="c3d4" class="jn jo hi jj b fi jt jq l jr js">gcloud iam service-accounts create ${ACCOUNT} \<br/>--display-name=${ACCOUNT} \<br/>--project=${PROJECT}</span><span id="2197" class="jn jo hi jj b fi jt jq l jr js">gcloud iam service-accounts keys create ${FILE} \<br/>--iam-account=${ACCOUNT}@${PROJECT}.iam.gserviceaccount.com \<br/>--project=${PROJECT}</span><span id="5cd2" class="jn jo hi jj b fi jt jq l jr js">gcloud projects add-iam-policy-binding ${PROJECT} \<br/>--member=serviceAccount:${ADDRESS} \<br/>--role=roles/monitoring.metricWriter</span></pre><p id="113a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要访问以下链接来提供Stackdriver工作区:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="9fd1" class="jn jo hi jj b fi jp jq l jr js">google-chrome console.cloud.google.com/monitoring/?project=${PROJECT}</span></pre><p id="8fb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">试试看</strong></p><p id="6904" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">克隆Etsy的statsd项目和<a class="ae jd" href="https://github.com/DazWilkin/statsd-opencensus-backend" rel="noopener ugc nofollow" target="_blank">statsd-open census-back end</a>:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="dfd2" class="jn jo hi jj b fi jp jq l jr js">cd ${WORK}<br/>git clone <a class="ae jd" href="https://github.com/DazWilkin/statsd-opencensus-backend" rel="noopener ugc nofollow" target="_blank">https://github.com/DazWilkin/statsd-opencensus-backend</a></span><span id="38d7" class="jn jo hi jj b fi jt jq l jr js">cd statsd-opencensus-backend<br/>npm install</span><span id="75ba" class="jn jo hi jj b fi jt jq l jr js">cd ${WORK}<br/>git clone <a class="ae jd" href="https://github.com/etsy/statsd" rel="noopener ugc nofollow" target="_blank">https://github.com/etsy/statsd</a><br/>cd statsd<br/>npm install</span></pre><p id="7e58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该为statsd定义一个配置文件。在<code class="du ju jv jw jj b">${WORK}/statsd</code>中创建一个名为<code class="du ju jv jw jj b">myConfig.js</code>的文件:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="a752" class="jn jo hi jj b fi jp jq l jr js">{<br/>    flushInterval: 5000,<br/>    backends: [<br/>        "../statsd-opencensus-backend"<br/>    ],<br/>    opencensus:{<br/>        prometheus: {<br/>            port: 9464<br/>        },<br/>        stackdriver: {<br/>            projectId:"[[YOUR-PROJECT]]"<br/>        }<br/>    }<br/>}</span></pre><blockquote class="jx jy jz"><p id="08ba" class="if ig ka ih b ii ij ik il im in io ip kb ir is it kc iv iw ix kd iz ja jb jc hb bi translated">请用您的GCP项目ID替换<code class="du ju jv jw jj b">[[YOUR-PROJECT]]</code>的值；<code class="du ju jv jw jj b">${PROJECT}</code>的值。</p></blockquote><p id="a182" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您应该能够运行statsd服务器:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="ec33" class="jn jo hi jj b fi jp jq l jr js">node stats.js ./myConfig.js</span></pre><p id="dc64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该立即看到类似于以下内容的日志记录:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="e6c5" class="jn jo hi jj b fi jp jq l jr js">[110588] reading config file: ./dazConfig.js<br/>server is up INFO<br/>DEBUG: [OpenCensus:cons] Entered<br/>DEBUG: [Opencensus:cons] Creating Stackdriver Exporter<br/>DEBUG: [Opencensus:cons] Creating Prometheus Exporter<br/>DEBUG: [Opencensus:cons] Registering stackdriver<br/>DEBUG: [Opencensus:cons] Registering prometheus<br/>DEBUG: Attaching 'flush'<br/>DEBUG: Attaching 'status'<br/>DEBUG: [OpenCensus:cons] Exited</span></pre><p id="1996" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您需要生成一些计数器和一些计量器。</p><p id="0604" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在一个终端中，要创建一个名为<code class="du ju jv jw jj b">foo</code>的[ <strong class="ih hj"> c </strong>计数器并每秒递增一次，请运行:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="47bf" class="jn jo hi jj b fi jp jq l jr js">while true<br/>do<br/>  echo "<strong class="jj hj">foo</strong>:1|<strong class="jj hj">c</strong>" | nc -u -w0 127.0.0.1 8125<br/>  sleep 1s<br/>done</span></pre><p id="6633" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在另一个终端中，创建一个名为<code class="du ju jv jw jj b">bar</code>的[ <strong class="ih hj"> g] </strong> auge，并将其设置为每秒随机(0:99)值，运行:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="5f25" class="jn jo hi jj b fi jp jq l jr js">while true<br/>do<br/>  GAUGE="<strong class="jj hj">bar</strong>:$(awk -v min=0 -v max=99 'BEGIN{srand(); print min+rand()*(max-min+1)}')|<strong class="jj hj">g</strong>"<br/>  echo ${GAUGE}<br/>  echo ${GAUGE} |  nc -u -w0 127.0.0.1 8125<br/>  sleep 1s<br/>done</span></pre><p id="2947" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该开始看到度量值被发送到导出器:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="022c" class="jn jo hi jj b fi jp jq l jr js">DEBUG: Flushing stats at Sat Jan 12 2019 13:06:12 GMT-0800 (Pacific Standard Time)<br/>DEBUG: Counter: statsd.bad_lines_seen: 0<br/>DEBUG: [Opencensus:flush] Creating counter: statsd_bad_lines_seen<br/>DEBUG: [Opencensus:flush] Creating view: statsd_bad_lines_seen<br/>DEBUG: Counter: statsd.packets_received: 119<br/>DEBUG: [Opencensus:flush] Creating counter: statsd_packets_received<br/>DEBUG: [Opencensus:flush] Creating view: statsd_packets_received<br/>DEBUG: Counter: statsd.metrics_received: 119<br/>DEBUG: [Opencensus:flush] Creating counter: statsd_metrics_received<br/>DEBUG: [Opencensus:flush] Creating view: statsd_metrics_received<br/>DEBUG: <strong class="jj hj">Counter: foo: 60</strong><br/>DEBUG: [Opencensus:flush] Creating counter: foo<br/>DEBUG: [Opencensus:flush] Creating view: foo<br/>DEBUG: <strong class="jj hj">Gauge: bar: 12.0405</strong><br/>DEBUG: [Opencensus:flush] Creating gauge: bar<br/>DEBUG: [Opencensus:flush] Creating view: bar<br/>DEBUG: [OpenCensus:flush] Exited</span></pre><p id="4a18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">堆栈驱动</strong></p><p id="38cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是Stackdriver的指标浏览器中的<code class="du ju jv jw jj b">foo</code>:</p><figure class="je jf jg jh fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es ke"><img src="../Images/9c320c19132fbe72a4f67627c91aab37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nTptBXIiWN4UBRBD6IXEiw.png"/></div></div><figcaption class="km kn et er es ko kp bd b be z dx translated">公制:custom.googleapis.com/opencensus/foo</figcaption></figure><p id="df7d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是Stackdriver的指标浏览器中的<code class="du ju jv jw jj b">bar</code>:</p><figure class="je jf jg jh fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es ke"><img src="../Images/51f753b374db37d681e251ce4fddb3db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xBatthmLhDK7AXCSRCTm4g.png"/></div></div><figcaption class="km kn et er es ko kp bd b be z dx translated">公制:custom.googleapis.com/opencensus/bar</figcaption></figure><p id="60a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">而且，由于<code class="du ju jv jw jj b">bar</code>更有趣，这里是使用谷歌(牛逼)APIs Explorer的时间序列查询结果:</p><figure class="je jf jg jh fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es kq"><img src="../Images/33c2cc3f23a583c403bc33a28f64a793.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U_CQBNUmX1Wjmnir2FSwOg.png"/></div></div></figure><p id="1474" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要亲自尝试，以下URL将带您找到该方法:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="af15" class="jn jo hi jj b fi jp jq l jr js">google-chrome <a class="ae jd" href="https://developers.google.com/apis-explorer/#search/timeseries/m/monitoring/v3/monitoring.projects.timeSeries.list" rel="noopener ugc nofollow" target="_blank">https://developers.google.com/apis-explorer/#search/timeseries/m/monitoring/v3/monitoring.projects.timeSeries.list</a></span></pre><p id="4395" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，替换以下值:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="2841" class="jn jo hi jj b fi jp jq l jr js">name: projects/${PROJECT}<br/>filter: metric.type="custom.googleapis.com/opencensus/foo"<br/>interval.endTime: 2019-01-12T23:59:59-08:00<br/>interval.startTime: 2019-01-12T00:00:00-08:00</span></pre><blockquote class="jx jy jz"><p id="2c00" class="if ig ka ih b ii ij ik il im in io ip kb ir is it kc iv iw ix kd iz ja jb jc hb bi translated"><strong class="ih hj"> NB </strong>用其值替换<code class="du ju jv jw jj b">${PROJECT}</code>。您可以在过滤器中使用<code class="du ju jv jw jj b">foo</code>或<code class="du ju jv jw jj b">bar</code>。开始和结束时间应该与您现在的时间相对应。我的值是太平洋时间(<code class="du ju jv jw jj b">-08:00</code>)2019年1月12日全天(<code class="du ju jv jw jj b">00:00:00</code>–<code class="du ju jv jw jj b">23:59:59</code>)。</p></blockquote><p id="2630" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">普罗米修斯</strong></p><p id="973b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能会在端口<code class="du ju jv jw jj b">9464</code>上观察到指标导出器:</p><figure class="je jf jg jh fd kf er es paragraph-image"><div class="er es kr"><img src="../Images/e0fd8e017a83fee6853c58ea25600ebf.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*_48j2XFPF6sAJoa3KdRJeQ.png"/></div><figcaption class="km kn et er es ko kp bd b be z dx translated">普罗米修斯度量输出器</figcaption></figure><p id="f442" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里你可以看到计数器<code class="du ju jv jw jj b">foo</code>(我创建了一个虚拟标签<code class="du ju jv jw jj b">status</code>)和它当时的值16，以及计量器<code class="du ju jv jw jj b">bar</code>(相同的虚拟标签)和它当时的值<code class="du ju jv jw jj b">773.7858…</code></p><p id="d10f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">显然，需要做更多的工作；-)</p><p id="ccfa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">遛狗的时间到了！</p></div></div>    
</body>
</html>