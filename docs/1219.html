<html>
<head>
<title>Resolving getting locked out of a Compute Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解决被计算引擎锁定的问题</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/resolving-getting-locked-out-of-a-compute-engine-85800251890b?source=collection_archive---------0-----------------------#2019-12-09">https://medium.com/google-cloud/resolving-getting-locked-out-of-a-compute-engine-85800251890b?source=collection_archive---------0-----------------------#2019-12-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/1437d3a7f940f6f2810c80f5b06ba582.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8If-xzdl15WTEjetFFTwzA.png"/></div></div></figure><p id="76f6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">想象一下，您因为犯了某种管理错误而被“锁定”在Linux计算引擎之外，比如在机器上本地禁用SSH或通过防火墙阻止SSH(例如ufw的iptables)。如何登录以进行调查和修复？因为我们通常使用SSH登录，并且我们的前提是SSH不可用，所以我们似乎被卡住了。</p><p id="607a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一种解决方案是使用串行控制台的概念。在物理Linux机器上，我们将能够在控制台登录。在这里，我们将看到友好的“登录:”提示。历史上，Unix机器有通过串行电缆连接的终端阵列。与每个终端相关联，将有一个名为<a class="ae jo" href="https://en.wikipedia.org/wiki/Getty_(Unix)" rel="noopener ugc nofollow" target="_blank"> getty </a>的Unix进程为每个终端运行。正是这个过程负责生成允许我们登录的登录。</p><p id="1f7c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于计算引擎是一个物理上的远程虚拟机，显然没有我们可以使用的附加终端，但是GCP提供了一个逻辑上的等效物，称为串行控制台。我们可以通过云控制台访问计算引擎的串行控制台。默认情况下，它向我们显示系统启动期间生成的日志，但阻止我们与之交互。换句话说，它是只读的。我们可以启用它来输入允许我们登录。为此，我们可以将<code class="du jp jq jr js b">serial-port-enable</code>元数据设置为<code class="du jp jq jr js b">1</code>的值。默认值(即使省略，也是值<code class="du jp jq jr js b">0</code>)。</p><p id="5b27" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">启用后，我们会看到一个登录提示，在这里我们可以输入登录用户id/密码对。但是我们可以使用什么凭证登录呢？默认情况下，我们没有可用的登录凭据。我们需要做的是显式地定义一个用户和相关的密码，我们可以用它来登录。然而，我们有一个自举问题。假设我们被锁定在计算引擎之外，我们无法登录来添加允许我们登录的用户id/密码。</p><p id="be1a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">解决方案是创建一个添加用户id/密码对的启动脚本。如果我们定义此脚本，然后重新启动我们的计算引擎，在引导过程的后期，启动脚本将运行，它可以创建我们的身份，然后我们可以使用该身份登录。一旦启动脚本完成并且VM实例启动，我们就可以通过串行端口登录。</p><p id="583f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里是这些步骤的演练，假设在开始时我们被锁定。我们假设机器能够正确启动。</p><p id="238f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们创建了一个Ubuntu计算引擎实例并运行:</p><pre class="jt ju jv jw fd jx js jy jz aw ka bi"><span id="303c" class="kb kc hi js b fi kd ke l kf kg">sudo iptables -A INPUT -p tcp --destination-port 22 -j DROP</span></pre><p id="85f9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这阻塞了端口22。这是一个被“锁在外面”的模拟。</p><p id="0009" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们通过将计算引擎实例元数据<code class="du jp jq jr js b">serial-port-enable</code>设置为<code class="du jp jq jr js b">1</code>来启用串行端口登录。在云控制台中，有一个复选框区域使这变得简单:</p><figure class="jt ju jv jw fd ij er es paragraph-image"><div class="er es kh"><img src="../Images/f9d9ab5a17c0f65959ae03ad6576e07f.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*latY_MHKYmKlwV5ScZ4V1Q.png"/></div></figure><p id="7896" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们关闭计算引擎实例。</p><p id="6849" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦关闭，我们可以通过添加自定义元数据来定义我们的启动脚本，元数据的关键字为<code class="du jp jq jr js b">startup-script</code>，值为:</p><pre class="jt ju jv jw fd jx js jy jz aw ka bi"><span id="2b30" class="kb kc hi js b fi kd ke l kf kg">#!/bin/bash<br/>useradd --groups google-sudoers tempuser<br/>echo "tempuser:password" | chpasswd</span></pre><figure class="jt ju jv jw fd ij er es paragraph-image"><div class="er es ki"><img src="../Images/38a1775e868dcbcca3314b791cecc94f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*MIOlsR1quNEPB78vc5j40A.png"/></div></figure><p id="0f89" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们重新启动计算引擎。这将导致启动脚本执行，这将添加我们的临时用户。当计算引擎启动时，我们将在控制台中看到一个按钮，显示实例的详细信息。</p><figure class="jt ju jv jw fd ij er es paragraph-image"><div class="er es kj"><img src="../Images/f98d55b48a121452b6432946bfe9f91f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1066/format:webp/1*gc9tfmERsRUnWzcjHQAMhg.png"/></div></figure><p id="4250" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们必须在出现的窗口中按一次enter键，以显示登录提示:</p><figure class="jt ju jv jw fd ij er es paragraph-image"><div class="er es kk"><img src="../Images/614e85a5bffc4030ea8c75e86ddd08f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/format:webp/1*_WSzg6vfFwMPHt1HdODdJQ.png"/></div></figure><p id="6cb9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在可以输入我们的用户标识和密码(如临时用户/密码)。我们将以临时用户的身份登录。我们现在可以使用以下命令切换到根用户shell:</p><pre class="jt ju jv jw fd jx js jy jz aw ka bi"><span id="f151" class="kb kc hi js b fi kd ke l kf kg">sudo bash</span></pre><p id="d961" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这一点上，我们现在在机器中拥有我们可能需要的所有权限。我们可以进行调查和修复。当我们对环境已经修复感到满意时，我们应该关闭虚拟机实例并删除创建临时用户id的启动脚本，我们还应该取消选中启用串行端口登录的复选框。</p><figure class="jt ju jv jw fd ij er es paragraph-image"><div class="er es kl"><img src="../Images/dae82bf8c1c6f6476d757e6090cf752a.png" data-original-src="https://miro.medium.com/v2/resize:fit:738/format:webp/1*_yJT8MSGG13J3OcVT1T01A.png"/></div></figure><p id="6295" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们应该再次重启虚拟机，使用SSH登录，并明确删除我们的临时用户:</p><pre class="jt ju jv jw fd jx js jy jz aw ka bi"><span id="c5b4" class="kb kc hi js b fi kd ke l kf kg">deluser tempuser</span></pre><p id="6343" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">食谱到此结束。我们展示了使用云控制台管理界面调整我们的VM实例配置，但是我们也可以使用<code class="du jp jq jr js b">gcloud</code>命令行界面执行相同的任务。</p><p id="e59c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另请参见:</p><ul class=""><li id="e08a" class="km kn hi is b it iu ix iy jb ko jf kp jj kq jn kr ks kt ku bi translated"><a class="ae jo" href="https://www.youtube.com/watch?v=GSksIUqBJPo" rel="noopener ugc nofollow" target="_blank">如何使用串行控制台对谷歌计算引擎实例进行故障排除</a></li></ul></div></div>    
</body>
</html>