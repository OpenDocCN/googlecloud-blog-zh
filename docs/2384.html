<html>
<head>
<title>IAM based authentication for CloudSql and how to connect to CloudSql with private ip from local machine.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于IAM的CloudSql认证以及如何从本地机器使用私有ip连接到CloudSql。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/iam-based-authentication-for-cloudsql-and-how-to-connect-to-cloudsql-with-private-ip-from-local-bf2644a14cef?source=collection_archive---------1-----------------------#2022-09-26">https://medium.com/google-cloud/iam-based-authentication-for-cloudsql-and-how-to-connect-to-cloudsql-with-private-ip-from-local-bf2644a14cef?source=collection_archive---------1-----------------------#2022-09-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e8cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud CloudSQL原生支持IAM集成。因此，用户可以使用他们的电子邮件云身份登录到云SQL，并且可以管理用户对数据库的权限。此过程使用短期身份验证令牌，不需要密码。日志中会跟踪用户的登录活动。</p><p id="3f78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对您的所有数据库实施Cloud SQL IAM数据库身份验证使数据库的用户管理更加安全、高效。</p><p id="7932" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们讨论如何在云Sql中设置IAM数据库认证。</p><p id="242c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一步是在CloudSql实例上启用基于IAM的身份验证，下面是可以用来实现这一点的命令</p><p id="ab65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">cloudsql.iam_authentication=on</p><p id="66ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从控制台，我们也可以通过设置标志来启用它</p><p id="f6f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">IAM身份验证允许用户使用他们的云身份连接到CloudSql。任何数据库级别的授权都需要在数据库本身中处理。</p><p id="0fda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">即授予对表、模式、数据库的读访问或写访问权限，仍然需要作为数据库命令而不是IAM角色来授予。</p><p id="5ca3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦IAM身份验证标志设置为on，下一步就是向用户或组授予“云SQL实例用户”角色。该角色允许用户使用他们的云身份认证到cloudsql。</p><p id="a101" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">授予角色后，下一步是将用户或组添加到CloudSql实例，如下所示，</p><p id="9e2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导航到“控制台→ SQL →选择实例→用户→添加用户帐户→云IAM →输入电子邮件地址→添加”</p><p id="6a58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，用户可以连接到CloudSql并登录数据库。尽管如此，这并不能授予用户查询表或模式所需的访问权限。这仅包括认证部分，授权访问需要在数据库端被授予。</p><p id="aaa8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看如何创建一个角色，并将其授予云身份或组。</p><p id="dced" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建角色role _ ro</p><p id="817e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">\ connect databaseName</p><p id="0867" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将数据库databaseName上的CONNECT授予role _ ro</p><p id="8bed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">向role_ro授予对架构schemaName的使用权；</p><p id="d98d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将SCHEMA schemaName中所有表上的SELECT权限授予role _ ro</p><p id="fd1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建角色后，下一步是将角色授予用户或组。</p><p id="1ea6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将role_ro授予<a class="ae jd" href="mailto:user@example.com" rel="noopener ugc nofollow" target="_blank">user@example.com</a></p><p id="8e1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">连接到云SQL使用</strong> g <strong class="ih hj"> IAM数据库认证</strong></p><p id="e583" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">连接到云SQL实例的安全方式是通过<a class="ae jd" href="https://cloud.google.com/sql/docs/postgres/sql-proxy" rel="noopener ugc nofollow" target="_blank"> CloudSQL Auth proxy </a>或使用Java/Python Native client。</p><p id="326e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博客中，我们将讨论如何使用Auth proxy连接到具有公共和私有ip的CloudSQL实例。</p><p id="c8ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要安装最新版本的Cloud SQL auth代理二进制文件，然后认证到Google Cloud IAM。</p><p id="ecfc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">$ gcloud授权登录</p><p id="881b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">登录成功后，让启动代理连接</p><ul class=""><li id="a31c" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">具有公共IP的实例</li></ul><p id="1adf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">。/cloud _ SQL _ proxy-enable _ iam _ log in-instances = PROJECT:REGION:cloud SQL _ INSTANCE _ NAME = TCP:port</p><p id="34e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦连接建立，现在我们可以使用云身份连接到数据库。</p><p id="4301" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">psql " host = 127 . 0 . 0 . 1 port = $ CLOUDSQLPROXYPORT DBNAME = $ DBNAME user=user@example.com SSL mode = disable "</p><p id="f7b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的命令从下面的环境变量中获取凭据。</p><p id="2b4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GOOGLE _应用程序_凭据</p><p id="4435" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们是公开连接到CloudSQL实例，所以它需要一个SSL证书——因此，slmode参数被设置为disable。但是，云SQL Auth代理确实提供了加密连接。</p><ul class=""><li id="2f5c" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">具有私有IP的实例</li></ul><p id="cb4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您有到gcp网络的VPN连接或到GCP网络的专用互连，上述方法对于privateIp实例同样有效。</p><p id="77d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您没有vpn或互联网连接，则无法从您的机器启动代理并连接到CloudSql。有一个仅用于测试目的的解决方法，即在与CloudSql实例相同的网络中创建一个虚拟机，并使用CloudIAP隧道连接到该虚拟机。从虚拟机上，我们可以启动Cloudproxy。同样，这是一个权宜之计，应该只用于开发环境。</p><p id="93e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于TCP连接，GCP的<a class="ae jd" href="https://cloud.google.com/iap" rel="noopener ugc nofollow" target="_blank">身份识别代理(IAP) </a>支持通过私有IP从互联网访问GCE虚拟机。当试图建立到代理的HTTPS加密隧道时，代理执行认证和授权检查。在成功的认证和授权之后，来自客户端的流量通过代理在Google的内部网络上被转发到VM实例。换句话说，代理充当对外界开放的传入流量的看门人，而VM只需要允许来自Google内部网络上的代理的连接。</p><p id="a06c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">隧道配置</p><p id="16b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了配置IAP通道，我假设您有以下条件</p><ul class=""><li id="6c31" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">您拥有的GCP项目，带有正在运行的GCE虚拟机，对于Windows虚拟机，登录和密码—确保在创建虚拟机时禁用公共ip的分配—对于Windows节点，确保在创建虚拟机后不要忘记指定用户名和密码</li><li id="5a0f" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">安装在您想要连接的系统上的<a class="ae jd" href="https://cloud.google.com/sdk" rel="noopener ugc nofollow" target="_blank"> Google Cloud SDK </a></li><li id="8322" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">如果你是公司代理，你可能需要<a class="ae jd" href="https://cloud.google.com/iap/docs/faq#what_domain_does_for_tcp_use" rel="noopener ugc nofollow" target="_blank">将IAP用于TC的域名“tunnel.cloudproxy.app”列入白名单</a></li></ul><p id="df4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们首先创建一个防火墙规则，允许流量从IAP流向VM。IAP使用范围35.235.240.0/20作为转发流量的源地址。我们允许端口22 (ssh)。</p><p id="9f99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">g cloud compute firewall-rules create allow-INGRESS-from-IAP \-direction = INGRESS \-action = allow-rules = TCP:3389，tcp:22，TCP:5901 \-source-ranges = 35 . 235 . 240 . 0/20</p><p id="f98e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的命令允许从代理到项目中所有节点的连接。如果您不想为项目中的所有虚拟机打开防火墙，您可以<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/compute/instances/add-tags" rel="noopener ugc nofollow" target="_blank">将标签</a>附加到您希望应用规则的虚拟机，并使用'— target-tags=TAG '作为附加选项指定该标签。</p><p id="83be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，用户需要被授予IAM策略，以允许他们建立隧道连接。为此，我们需要向授权用户和/或用户组授予iap.tunnelResourceAccessor角色。在这个例子中，这个角色是在项目级别设置的。这允许用户建立到项目中应用上述防火墙规则的所有虚拟机的连接。</p><p id="3e6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">gcloud项目添加-iam-策略绑定IAP-访问-测试\</p><p id="8980" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">—member=user:user@example.com</p><p id="b585" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">—role = roles/IAP . tunnelresourceactor</p><p id="f0ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用户还需要拥有compute.viewer角色</p><p id="9f2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">gcloud项目添加-iam-策略绑定IAP-访问-测试\</p><p id="8575" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">—member=user:user@example.com</p><p id="0cc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">—角色=角色/计算.查看器</p><p id="ae4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">连接SSH:Linux-GCE上的Linux</strong></p><p id="24b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想通过ssh上的端口转发连接到Linux节点，请使用下面的命令。</p><p id="00d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">g cloud compute ssh IAP-test-Ubuntu—项目iap-access-test \</p><p id="7bcf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">—区域us-central 1-a—ssh-flag "-L 5901:localhost:5901 "</p><p id="5630" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您将能够ssh到与CloudSql实例位于同一个VPC网络中的VM，您可以按照上一节中的cloudSql代理设置进行操作，并且能够在不登录VM的情况下测试您的连接和db设置。</p></div></div>    
</body>
</html>