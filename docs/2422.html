<html>
<head>
<title>Approach 2 - Mirroring CSR and Gitlab Repository to Create Cloud Build Triggers and automate the CICD pipelines with GKE.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">方法2 -镜像CSR和Gitlab存储库以创建云构建触发器，并通过GKE自动化CICD管道。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/approach2-mirroring-csr-and-gitlab-repository-to-create-cloud-build-triggers-and-automate-the-cicd-524c743ee669?source=collection_archive---------1-----------------------#2022-10-14">https://medium.com/google-cloud/approach2-mirroring-csr-and-gitlab-repository-to-create-cloud-build-triggers-and-automate-the-cicd-524c743ee669?source=collection_archive---------1-----------------------#2022-10-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b1ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大家好👋，在这篇博客中，我们将为Gitlab创建带有云构建触发器的CI/CD管道作为源代码库。</p><p id="d93f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将讨论如何通过在Google Source Repository和Gitlab repository之间建立镜像来构建Gitlab repository。<br/>正如我们在<a class="ae jd" rel="noopener" href="/@sanketbisne/approach-1-integrating-gitlab-repository-with-cloud-build-triggers-via-webhook-and-creating-ci-cd-2f9d3327936b">方法1 </a>中所讨论的，通过创建webhook，我们可以触发Gitlab的ClouBuild作为我们的源代码库，但是它缺少一些我们在开发和生产环境中经常使用的功能。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/428ba482d5acd55ad52cef9a21857d58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6SAsCqz87M-j-oC_qhAzug.jpeg"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">艾米·赫希在<a class="ae jd" href="https://unsplash.com/s/photos/screen?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="3fce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">需要用Gitlab库镜像CSR</strong></p><p id="047a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云构建触发器不直接支持Gitlab作为源代码库。另外，为了克服webhook方法的局限性，以及$SHORT_SHA、$COMMIT_SHA、$TAG_NAME等特性和其他替换变量，我们对Gitlab库进行了镜像，以便与GSR一起使用。</p><p id="bdae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，所有执行的行动都将直接以CSR为来源。我们所有的分支、标签、提交都将从Gitlab资源库复制到Google Cloud Source资源库。</p><p id="11a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">架构流程(方法2) </strong></p><ul class=""><li id="da7b" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">每当开发人员将他/她的代码放入Gitlab资源库时，该资源库将首先镜像到Google Source Repository。</li><li id="e5f8" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">之后，云构建触发器将触发基于事件的构建，如push to branch/tag和take Source as Google Source Repository。</li><li id="dac6" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">将执行cloudbuild.yaml中的步骤来构建缓存的映像，对其进行标记并将其推送到gcr/artifact registry，在最后一步，推送的映像将被部署到我们的GKE集群。</li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ki"><img src="../Images/60b7e8731e661f4f58fd39328bfc16e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DuDmMTCwbyzp3b12TAQJGg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">CICD流程的架构流程</figcaption></figure><p id="dd1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">先决条件:</strong></p><ul class=""><li id="73db" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">从下面的Shell脚本中启用以下API。</li><li id="8d52" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">提供基础设施，如VPC，子网，服务帐户，谷歌Kubernetes引擎从下面的仓库。</li></ul><p id="d589" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">克隆以下存储库:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kj"><img src="../Images/05593d2ab2867e56777f493ae6c5f3c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yqgW3oREDHQQvt1L6VGzgw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">地形资源</figcaption></figure><pre class="jf jg jh ji fd kk kl km kn aw ko bi"><span id="81cd" class="kp kq hi kl b fi kr ks l kt ku">git clone <a class="ae jd" href="https://github.com/sanketbisne/gcp-terraform-resources.git" rel="noopener ugc nofollow" target="_blank">https://github.com/sanketbisne/gcp-terraform-resources.git</a></span><span id="711d" class="kp kq hi kl b fi kv ks l kt ku">cd gcp-terraform-resources</span><span id="460a" class="kp kq hi kl b fi kv ks l kt ku">git checkout main</span></pre><div class="kw kx ez fb ky kz"><a href="https://github.com/sanketbisne/gcp-terraform-resources" rel="noopener  ugc nofollow" target="_blank"><div class="la ab dw"><div class="lb ab lc cl cj ld"><h2 class="bd hj fi z dy le ea eb lf ed ef hh bi translated">GitHub-sanketbisne/GCP-terra form-resources</h2><div class="lg l"><h3 class="bd b fi z dy le ea eb lf ed ef dx translated">此库包括以下资源的地形模块:将有两个目录子模块-&gt;…</h3></div><div class="lh l"><p class="bd b fp z dy le ea eb lf ed ef dx translated">github.com</p></div></div><div class="li l"><div class="lj l lk ll lm li ln jo kz"/></div></div></a></div><p id="454c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行以下shell脚本，该脚本将启用执行以下任务所需的所有API。</p><pre class="jf jg jh ji fd kk kl km kn aw ko bi"><span id="5963" class="kp kq hi kl b fi kr ks l kt ku">./<a class="ae jd" href="https://github.com/sanketbisne/gcp-terraform-resources/blob/main/enable-api.sh" rel="noopener ugc nofollow" target="_blank">enable-api.sh</a></span></pre><p id="a7fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤1:在Gitlab和Google cloud Source Repository中创建存储库。</strong> <br/>在Gitlab和CSR中创建repo。<br/>进入外壳/控制台，执行以下命令</p><pre class="jf jg jh ji fd kk kl km kn aw ko bi"><span id="097c" class="kp kq hi kl b fi kr ks l kt ku">gcloud init<br/>gcloud source repos create REPOSITORY_NAME</span></pre><p id="84f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第二步:</strong> <strong class="ih hj"> Google源码库和Gitlab </strong> <br/> Go云端源码库之间的认证。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lo"><img src="../Images/3f6c659440315877aca6d6ede70b8c5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bkp2vxCKxqgCXZcs5ev3fQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">手动生成的凭据部分。</figcaption></figure><ul class=""><li id="e558" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">继续手动生成凭证</li><li id="f5eb" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">点击<strong class="ih hj"> 1。“生成并存储您的Git凭证”</strong></li><li id="7ba0" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">这将弹出一个窗口来验证您的gcp帐户</li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lp"><img src="../Images/d53cd3d9d22f03527bb65cee425c50ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:858/format:webp/1*euDbKEb9MLE4_zsxOf27Zg.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">我们用户的验证步骤</figcaption></figure><p id="3262" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单击Allow，我们将被重定向到配置Git。<br/>选择您的认证方式，我们可以选择云壳或者我们的本地终端来存储您的用户名和密码。</p><blockquote class="lq lr ls"><p id="0dc9" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated">为什么我们需要存储用户名和密码？</p><p id="3c6a" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated"><em class="hi">为了告诉Gitlab repository，这是一个您必须复制全部内容的存储库，我们需要一些认证机制。</em></p><p id="975a" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated"><em class="hi">我们需要用户名和密码。我们的用户名和密码将绑定到我们的谷歌帐户用户，如果万一用户访问被取消从云身份或谷歌云项目。google源存储库和Gitlab存储库之间的镜像停止。因为这里不支持服务帐户。</em></p><p id="a1a3" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated"><em class="hi">我们必须在我们的云身份中创建一个用户，其访问权限将永远在组织中，并在项目级别授予它(源存储库管理员/作者)。</em></p></blockquote><ul class=""><li id="e7ea" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">从下面的代码块配置Git。这将自动填充中的用户名和密码。在主目录中创建gitcookies文件。</li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lx"><img src="../Images/a56b7bbfdf7cab5edec95da0cebe3237.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MLAoMha7lezBNOr9Dz53Cg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">在您的云shell中使用cookie配置Git</figcaption></figure><p id="3914" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤3:创建我们的凭证。</strong></p><p id="32a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将代码从上面的程序块复制到你的终端。下图仅供参考。</p><p id="47ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们需要打开我们的云壳/本地终端</p><pre class="jf jg jh ji fd kk kl km kn aw ko bi"><span id="4a22" class="kp kq hi kl b fi kr ks l kt ku">  mkdir Credentials &amp;&amp; cd Credentials </span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ly"><img src="../Images/41ae37581a8cb4b3ebaa87832d36813f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7K1avRHqz7xnbY3VaWdgrA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">复制此代码块并进入云壳</figcaption></figure><ul class=""><li id="fb2d" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">我们的凭据(如用户名和密码)将存储在。位于主目录中的gitcookie文件。</li></ul><pre class="jf jg jh ji fd kk kl km kn aw ko bi"><span id="6e5c" class="kp kq hi kl b fi kr ks l kt ku">cat .gitcookies</span></pre><ul class=""><li id="cf21" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">在最后一列中，我们可以看到这里有两个字段，第一个是用户id，另一个是我们的密码。<br/>我们将提取用户名和密码，并将其输入Gitlab存储库部分。</li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lx"><img src="../Images/baf1e54add7a1d99c4eca95fb522b753.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mXVdh3a-2tCsyCQ9hnyYmQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">在中生成的凭据。gitcookies文件</figcaption></figure><p id="7e91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">从下面的命令中提取密码</strong>。</p><pre class="jf jg jh ji fd kk kl km kn aw ko bi"><span id="e8e1" class="kp kq hi kl b fi kr ks l kt ku">grep ‘source.developers.google.com’ ~/.gitcookies | tail -1 | cut -d= -f2</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lz"><img src="../Images/4e8a5cb8b439531cae483bac2b275b64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Eg7eDWgEv0MbSDgLKkVOGw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">从中提取密码。gitcookies</figcaption></figure><p id="979d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">将用户名</strong>存储在环境变量中</p><pre class="jf jg jh ji fd kk kl km kn aw ko bi"><span id="b584" class="kp kq hi kl b fi kr ks l kt ku">CSR_USER=$(grep ‘source.developers.google.com’ ~/.gitcookies | \</span><span id="16c0" class="kp kq hi kl b fi kv ks l kt ku">tail -1 | cut -d$’\t’ -f7 | cut -d= -f1)</span></pre><p id="366d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">将源存储库</strong>值存储在CSR_REPO中</p><pre class="jf jg jh ji fd kk kl km kn aw ko bi"><span id="3144" class="kp kq hi kl b fi kr ks l kt ku">CSR_REPO=$(gcloud source repos describe gitlab-csr-mirror --format="value(url)")</span></pre><p id="b4f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">从下面的命令中获取用户名</strong>。</p><pre class="jf jg jh ji fd kk kl km kn aw ko bi"><span id="06de" class="kp kq hi kl b fi kr ks l kt ku">echo $CSR_REPO | sed "s/:\/\//:\/\/${CSR_USER}@/"</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ma"><img src="../Images/38891578cb0b93a37f910152dad985d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m5aJckvzM56znVHleZlkVQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">从提取用户名。gitcookies</figcaption></figure><p id="048f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">复制上面生成的用户名和密码，进入Gitlab镜像存储库部分</p><blockquote class="lq lr ls"><p id="a038" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated">下面是您的用户名和密码的参考示例。</p><p id="5d86" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated"><strong class="ih hj">用户名:</strong>https://git-&lt;your-username&gt;@ source . developers . Google . com/p/&lt;project _ id&gt;/r/&lt;your-Google-cloud-source-repository-name&gt;</p><p id="0f74" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated"><strong class="ih hj">密码:</strong> 1//0 &lt; random_id &gt;</p></blockquote><p id="96fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第四步:</strong>将上面生成的凭证添加到Gitlab存储库中。</p><p id="d55b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到Gitlab &gt;&gt;存储库&gt; &gt;镜像存储库</p><p id="c885" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输入用户名和密码，保留其他默认选项。<br/>并点击镜像库。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lx"><img src="../Images/8619dd6a482847934ccdbec7811a076f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AZcv_yQfktnRMlMbbFURTw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">在Gitlab镜像部分添加用户名和密码</figcaption></figure><p id="f47d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果镜像与Google Source Repository同步，我们现在可以看到镜像的状态。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lx"><img src="../Images/0f97a4324b0da3fea0a746549bcaf555.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*85vs6TrnOBKbvXH4cEkX7A.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">Google云源代码库和Gitlab库之间的同步</figcaption></figure><blockquote class="lq lr ls"><p id="04b2" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated">Gitlab每7分钟与GCS同步一次，它跟踪每个分支、提交和发生的变化。我们可以通过单击“立即同步”按钮来强制同步更改。</p></blockquote><p id="1e05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证分支、Git标签、数据、文件夹、提交是否从Gitlab复制到Google Source repository。将一些更改推送到Gitlab，它会自动将所有数据复制到CSR。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lx"><img src="../Images/11ca38726a7edd93c96106f8cedb00ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mvFLqm0M50NdeDEugA18Tg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">Git标签和分支</figcaption></figure><p id="7f02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以在右侧匹配最新的短提交sha，即<em class="lt"> 6c58e647 </em></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lx"><img src="../Images/1fdd5db1e9d20b59963cd4d17650d5f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TVacVnw8n05Qr7aCGNQ-yg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">相同的标签从Gitlab repo复制到云源存储库</figcaption></figure><p id="320b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我们所见，数据、提交、分支和标签都是从Gitlab复制到Google Source Repositories的。</p><p id="caa6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经将代码复制到CSR，让我们从配置云构建触发器开始。</p><p id="a068" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">设置云构建触发器并使用云构建自动部署</strong></p><p id="4711" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤1: </strong>准备cloudbuild.yaml文件<br/> Cloudbuild.yaml有3个步骤</p><ul class=""><li id="0743" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">构建我们的代码并用latest+short_sha+git_tag标记它</li><li id="abdd" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">将我们的代码推入Google容器注册表/工件注册表。</li><li id="0336" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">将映像部署到我们的kubernetes集群的特定名称空间中。<br/> <br/>为了达到最佳效果，所有变量都被替换，并且可以在新的存储库中重用。</li></ul><p id="9c1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤2: </strong>为云构建创建一个服务帐户，并授予其所需的权限。</p><p id="18c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">授予服务账户的角色:</strong></p><ul class=""><li id="2c71" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated"><strong class="ih hj"> <em class="lt"> Kubernetes引擎开发人员</em> </strong> —提供对集群内Kubernetes API对象的访问。</li><li id="9bdc" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><strong class="ih hj"> <em class="lt">日志写入器</em> </strong> —提供写入日志条目的权限。</li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lx"><img src="../Images/41c94db5ebe5ea07e1fc9fd6d2ba847a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gaC_DbVEphP2bNNt2SpjBw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">授予云构建服务帐户的角色</figcaption></figure><ul class=""><li id="aa0b" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated"><strong class="ih hj"> <em class="lt">源存储库阅读器</em> </strong> —提供列出、克隆、获取和浏览存储库的权限</li><li id="f66b" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><strong class="ih hj"> <em class="lt">存储管理员</em> </strong> —授予将映像推入GCR的权限，并授予对对象和存储桶的完全控制权。</li></ul><p id="e7b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">为开发环境创建触发器。</strong></p><ul class=""><li id="730b" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">点击触发器-&gt;创建新的触发器。<br/>选择事件—推送到分支</li></ul><p id="0c8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用<strong class="ih hj"> push to a branch </strong>事件来为开发/试运行部署部署我们的工作负载。和<strong class="ih hj">为我们的生产部署推出新标签</strong>事件</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mb"><img src="../Images/1545cec057c6b573354762101dbe0b27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BID8Ki3OrzF8bUNKBRWwag.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">云构建触发器</figcaption></figure><ul class=""><li id="640a" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">选择Dockerfile所在的存储库和分支，并将cloudbuild.yaml放在指定的目录中。</li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mb"><img src="../Images/152f35bc0e9abd6392899c583f879023.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0fPrIrmuQp2iWgXw_WKGyA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">添加替代变量。</figcaption></figure><ul class=""><li id="45f4" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">选择cloudbuild.yaml文件和服务帐户</li><li id="a87d" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">根据需要启用和禁用触发器</li></ul><blockquote class="lq lr ls"><p id="da69" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated"><strong class="ih hj">使能触发器</strong> - &gt;如果我们希望每当有代码变更时，触发cloudbuild.yaml文件中指定的cloudbuild步骤，我们可以将触发器设置为使能。</p><p id="911e" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated"><strong class="ih hj">禁用触发器</strong> - &gt;如果我们不想在代码发生变化时触发我们的cloudbuild，我们可以将触发器设置为禁用。</p></blockquote><p id="f3ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单击触发器，将一些更改推送到存储库中</p><blockquote class="lq lr ls"><p id="d680" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated"><strong class="ih hj">注意:每当我们将一些更改推入我们的Gitlab存储库时，需要7分钟来同步哪个Google云存储库。</strong></p></blockquote><p id="beba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦云构建被触发，我们就可以在history部分查看构建步骤所用的时间。</p><ul class=""><li id="0031" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">单击Build id，我们可以看到运行时执行的步骤。</li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lx"><img src="../Images/a95890300dd0fcb3a6950d68230e623d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zXpwhc41whOKYA9P9vyseA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">自动触发的构建历史</figcaption></figure><p id="d02b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以看到已执行构建的构建摘要，以及执行这些步骤的构建持续时间。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lx"><img src="../Images/1910d679ebfdb7d93386dad608c8d378.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eHPitWjlFcSGJRreddBeXw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">构建步骤详细信息。</figcaption></figure><ul class=""><li id="6b1e" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">进入GCR，查看标记有最新提交id (SHORT_SHA)的图像</li><li id="ab48" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">这是开发环境的触发构建，它在特定名称空间的GKE集群中使用(latest+short_sha)自动构建、标记、推送和部署我们的映像。</li></ul><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lx"><img src="../Images/01b72b434225000dd261749dd1b02fb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PWSN3S15JuqyUsoWx5nLyw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图片在GCR推送，标签为[ short_sha和最新]</figcaption></figure><p id="f2bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于标签(Regex模式)为<strong class="ih hj">生产环境创建触发器。</strong></p><ul class=""><li id="8b52" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">我们可以选择标签事件并过滤掉，只允许<strong class="ih hj"> (PRODUCTION_RELEASE_*) </strong>被触发。</li><li id="df6e" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">事件将用新标签推送</li><li id="9b4a" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">使用下面的命令创建一个标签，并将标签放入Gitlab存储库中</li></ul><blockquote class="lq lr ls"><p id="29d4" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated">- git标签<strong class="ih hj">PRODUCTION _ RELASE _ 2022 _ 08 _ 17</strong></p><p id="a1ce" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated">- git推送原点<strong class="ih hj">生产_发布_2022_08_17 </strong></p></blockquote><p id="411b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每当我们推送带有此前缀<strong class="ih hj"> PRODUCTION_RELEASE* </strong>的代码时，只有这样我们的构建才会被云构建触发器触发，其他前缀或标签将被丢弃。</p><p id="52ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于生产环境，我们将基于git标签推送事件。对于使用Tag -&gt; PRODUCTION_RELEASE*构建和推送映像，我们可以看到，当我们选择标记时，标记值会自动填充。</p><p id="3927" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">基于标签的触发器</strong></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mc"><img src="../Images/de7ee0eca9fbb0dddb0db496455f65d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*JGdT8Gxcez9zQKf5WvkV7g.jpeg"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">基于标签的触发器。</figcaption></figure><p id="819c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个触发器调用cloudbuild来构建、标记和推送图像到Google容器注册中心。</p><p id="1400" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在GKE集群中部署映像的步骤。</p><p id="7db8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是cloudbuild.yaml文件，描述了构建缓存映像、标记映像、将映像推送到GCR，以及每当我们将代码推送到Gitlab存储库时将映像部署到特定命名空间中的GKE集群的步骤。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="6040" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">去GCR看看图片的标签。我们可以看到下面的输出。<br/>该映像现在被标记为SHORT_SHA、latest和PRODUCTION_RELEASE*标签。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mf"><img src="../Images/f7ededdbc5b06d4c0473eef19f07c517.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*taX864M5ZPWPyWb7ruXR8Q.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">带有最新+ short_sha + PRODUCTION_RELEASE*星号的标记图像</figcaption></figure><p id="e3dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我们已经为开发和生产环境设置了触发器。以及基于分支和标记的自动部署。</p><h2 id="d641" class="kp kq hi bd mg mh mi mj mk ml mm mn mo iq mp mq mr iu ms mt mu iy mv mw mx my bi translated">摘要</h2><p id="bf7c" class="pw-post-body-paragraph if ig hi ih b ii mz ik il im na io ip iq nb is it iu nc iw ix iy nd ja jb jc hb bi translated">在这篇博客中，我们通过介绍镜像方法克服了webhook方法的局限性，并了解了如何使用云资源存储库的特性来构建基于分支和标签的用于暂存和生产环境的CI/CD管道。</p><p id="3d75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">参考文献:</strong></p><ul class=""><li id="56b5" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated"><a class="ae jd" href="https://cloud.google.com/architecture/mirroring-gitlab-repositories-to-cloud-source-repositories" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/architecture/mirroring-git lab-repositories-to-cloud-source-repositories</a></li><li id="fa84" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><a class="ae jd" href="https://cloud.google.com/build/docs/automating-builds/create-manage-triggers" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/build/docs/automating-builds/create-manage-triggers</a></li></ul><p id="c090" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">有什么问题吗？如果你有任何问题，我很乐意在评论中阅读。在<a class="ae jd" rel="noopener" href="/@sanketbisne">中</a>或<a class="ae jd" href="https://www.linkedin.com/in/sanketbisne/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上关注我。</strong></p><p id="a713" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谢谢，祝你有美好的一天😊</p></div></div>    
</body>
</html>