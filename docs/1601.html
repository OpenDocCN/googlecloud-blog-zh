<html>
<head>
<title>Cloud Tasks or Pub/Sub ?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云任务还是发布/订阅？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-tasks-or-pub-sub-8dcca67e2f7a?source=collection_archive---------0-----------------------#2020-09-27">https://medium.com/google-cloud/cloud-tasks-or-pub-sub-8dcca67e2f7a?source=collection_archive---------0-----------------------#2020-09-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="cb0e" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">微服务中的异步通信</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/68db118913a8cbe907fe292601316d92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RBqyrDT6P4I88DI7"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">阿德里安·德尔福吉在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="3710" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">介绍</h1><p id="c673" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">在微服务的世界里，大的应用程序分裂成松散耦合的服务，这些服务可以独立开发、部署和维护。微服务通常不通过直接的请求/响应相互对话，而是异步的，允许服务独立扩展。</p><p id="62ad" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">异步执行是减少请求延迟并提高应用程序响应速度的一种成熟方法。云任务和云发布/订阅都可以用来实现异步执行。</p><p id="0e76" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">在这篇博客中，我们将看到哪种产品适合您的使用案例。</p><h1 id="5bda" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">什么是云任务？</h1><p id="f820" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">云任务是一项完全托管的服务，允许您管理大量分布式任务的执行、调度和交付。</p><p id="9ba4" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">以下是云任务的功能</p><ul class=""><li id="1be1" class="lh li hi ki b kj lc km ld kp lj kt lk kx ll lb lm ln lo lp bi translated">可扩展和全面管理</li><li id="ad4a" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">HTTP目标:添加针对在云运行、应用引擎、云功能或计算引擎上运行的任何HTTP服务的任务。</li><li id="12e3" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">安全:它可以通过OAuth/OIDC认证调用安全端点。</li><li id="b530" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">速率和重试控制:您可以通过设置任务调度的速率、最大尝试次数和两次尝试之间的最短等待时间来控制执行。</li><li id="b174" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">未来计划:您可以控制任务运行的时间。</li><li id="1f30" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">任务重复数据删除:任务可以多次添加，但只能调度一次。</li><li id="222d" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">保证交付:任务至少保证一次。</li></ul><h1 id="704d" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">什么是Pub/Sub？</h1><p id="7c80" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">Pub/Sub是一个完全托管的实时消息服务，允许您在独立的应用程序之间发送和接收消息。</p><p id="471b" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">云发布/订阅将来自某个主题的消息分别转发给它的所有订阅。每个订阅要么通过云发布/订阅将消息推送到订阅者选择的端点，要么通过订阅者从服务中获取消息。<br/>订阅者接收来自其订阅的未决消息，并向云发布/订阅服务确认每个消息。<br/>当消息被订阅者确认后，它将从订阅的消息队列中删除。</p><p id="262e" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">以下是发布/订阅的主要功能。</p><ul class=""><li id="0bb1" class="lh li hi ki b kj lc km ld kp lj kt lk kx ll lb lm ln lo lp bi translated">可扩展和全面管理</li><li id="e74e" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">全球信息传递</li><li id="8a82" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">拉和推模式。</li><li id="f5bd" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">有序交付(测试版)。</li><li id="2e88" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">至少一次交货</li><li id="3786" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">死信主题:订阅者应用程序无法处理的消息将被搁置起来进行脱机调试。</li><li id="986d" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">过滤:发布/订阅可以根据属性过滤消息，以减少发送给订阅者的数量。</li></ul><h1 id="4deb" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">发布/订阅与云任务</h1><p id="a2aa" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">云任务和发布/订阅都可以作为传统服务集成的消息中间件，或者作为现代微服务的简单通信媒介。</p><blockquote class="lv"><p id="0980" class="lw lx hi bd ly lz ma mb mc md me lb dx translated">“云发布/订阅和云任务之间的核心区别是<strong class="ak">隐式和显式</strong>调用的概念”</p></blockquote><p id="2ea1" class="pw-post-body-paragraph kg kh hi ki b kj mf ij kl km mg im ko kp mh kr ks kt mi kv kw kx mj kz la lb hb bi translated"><strong class="ki hj">隐含</strong>:发布者无法控制消息的传递。发布/订阅旨在分离事件的发布者和订阅者。发布者不需要知道关于他们的订阅者的任何事情。</p><p id="670a" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated"><strong class="ki hj">显式</strong>:相比之下，云任务旨在<strong class="ki hj">显式</strong>调用，发布者保留对执行的完全控制。</p><p id="d243" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">云任务的额外好处是能够控制任务执行的速率，以及重试任务的频率和可以同时执行多少个并发任务。因为您可以控制从队列中发送任务的速率，所以您可以控制工作人员的伸缩行为，从而控制您的成本。</p><p id="3147" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">例如，我们已经使用<a class="ae jn" href="https://developers.google.com/admin-sdk" rel="noopener ugc nofollow" target="_blank">Google Admin SDK</a>Directory API来创建和提供Google帐户。这个API有1500/100秒的配额。<br/>因此，我们通过设置字段<strong class="ki hj"> max-dispatches-per-second来控制使用云任务队列对API的调用。</strong></p><p id="ec4c" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated"><strong class="ki hj">速率限制</strong>允许您定义一个队列可以调度的最大速率和最大并发任务数</p><pre class="iy iz ja jb fd mk ml mm mn aw mo bi"><span id="bddc" class="mp jp hi ml b fi mq mr l ms mt">gcloud tasks queues update [QUEUE_ID] \<br/>  --max-dispatches-per-second=[MAX_DISPATCHES_PER_SECOND] \<br/>  --max-concurrent-dispatches=[MAX_CONCURRENT_DISPATCHES]</span></pre><p id="9aed" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated"><strong class="ki hj">重试参数</strong>允许您指定重试失败任务的最大次数，设置重试尝试的时间限制，并控制尝试之间的间隔。</p><pre class="iy iz ja jb fd mk ml mm mn aw mo bi"><span id="b7fd" class="mp jp hi ml b fi mq mr l ms mt">gcloud tasks queues update [QUEUE_ID] \<br/>  --max-attempts=[MAX_ATTEMPTS] \<br/>  --min-backoff=[MIN_BACKOFF] \<br/>  --max-backoff=[MAX_BACKOFF] \<br/>  --max-doublings=[MAX_DOUBLINGS] \<br/>  --max-retry-duration=[MAX_RETRY_DURATION]</span></pre><p id="e327" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">云任务的另一个好处是，您可以使用云控制台和CLI命令暂停/恢复队列，以停止/启动任务的处理。</p><p id="6321" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">Pull方法在App Engine (Python2)任务队列中可用，但在云任务中不可用。发布/订阅有可用的请求订阅。</p><p id="a6ea" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">云任务和发布/订阅的详细比较</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mu"><img src="../Images/c0abafd4a9d2c77c4176904a85cb8b1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sfh25pRnvy4NrVJN60Q-bA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated"><a class="ae jn" href="https://cloud.google.com/pubsub/docs/choosing-pubsub-or-cloud-tasks" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/pubsub/docs/choosing-pubsub-or-cloud-tasks</a></figcaption></figure><h2 id="d3b4" class="mp jp hi bd jq mv mw mx ju my mz na jy kp nb nc ka kt nd ne kc kx nf ng ke nh bi translated">云任务的用例</h2><ul class=""><li id="c37f" class="lh li hi ki b kj kk km kn kp ni kt nj kx nk lb lm ln lo lp bi translated"><strong class="ki hj">点-2点通信</strong>:2个微服务之间的异步调用。</li><li id="3bc3" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">c:需要控制速率，以便工人的可伸缩性得到控制。例如推送异步图像处理作业。</li><li id="fead" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated"><strong class="ki hj">调度</strong>:需要调度作业。例如，在注册试用期后1个月发送电子邮件。</li><li id="8ba8" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated">在一定次数的重试后停止重试。</li></ul><h2 id="966d" class="mp jp hi bd jq mv mw mx ju my mz na jy kp nb nc ka kt nd ne kc kx nf ng ke nh bi translated">发布/订阅的用例</h2><ul class=""><li id="e0fd" class="lh li hi ki b kj kk km kn kp ni kt nj kx nk lb lm ln lo lp bi translated"><strong class="ki hj">一对多</strong>:发布消息给多个订阅者。例如，一旦下了订单，向有多个订阅者的主题发布消息，如包装、运输、电子邮件通知、短信提醒。</li><li id="55a2" class="lh li hi ki b kj lq km lr kp ls kt lt kx lu lb lm ln lo lp bi translated"><strong class="ki hj">拉订阅</strong>:没有HTTP端点的订阅者可以按时间间隔或流拉来拉消息。</li></ul><h1 id="e103" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">示例使用案例</h1><p id="63b5" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">源应用程序发送加入组织的新员工列表。云运行验证数据，并将单个消息分派到云任务中进行并行处理。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nl"><img src="../Images/86d6ab4da17ee8aa535b294fa29103b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r6ocSbFr11kbeUJuQoHlmQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">体系结构</figcaption></figure><p id="605f" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">在上面的用例中，我们需要控制API调用，因为有一个与Google Admin SDK API相关的配额。例如每100秒1500次呼叫。<br/>所以我们引入了<strong class="ki hj">云任务</strong>，其中<strong class="ki hj">每秒最大分派数</strong>字段设置为15 <strong class="ki hj">。</strong></p><p id="7323" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">此外，一旦数据得到处理，我们需要更新所有的供应商。所以我们引入了<strong class="ki hj"> Pub/Sub </strong>，这样用户就可以拉或者推消息。</p><h1 id="82ff" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">结论</h1><p id="22dc" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">我们讨论了两个服务之间的异步通信，以及云任务和发布/订阅如何适合它。还研究了对消息分发的隐式控制和显式控制。</p><p id="8891" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">发布/订阅也主要用于流处理，如物联网消息流，然后可以由云数据流处理并存储在BigQuery中以供进一步分析。</p><h1 id="1393" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">参考</h1><div class="nm nn ez fb no np"><a href="https://cloud.google.com/tasks/docs/reference/rest/" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab dw"><div class="nr ab ns cl cj nt"><h2 class="bd hj fi z dy nu ea eb nv ed ef hh bi translated">云任务API |云任务文档|谷歌云</h2><div class="nw l"><h3 class="bd b fi z dy nu ea eb nv ed ef dx translated">管理大量分布式请求的执行。我们建议您使用以下方式调用此服务…</h3></div><div class="nx l"><p class="bd b fp z dy nu ea eb nv ed ef dx translated">cloud.google.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od jh np"/></div></div></a></div><div class="nm nn ez fb no np"><a href="https://cloud.google.com/pubsub/docs/overview" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab dw"><div class="nr ab ns cl cj nt"><h2 class="bd hj fi z dy nu ea eb nv ed ef hh bi translated">什么是Pub/Sub？|云发布/订阅文档|谷歌云</h2><div class="nw l"><h3 class="bd b fi z dy nu ea eb nv ed ef dx translated">发布/订阅是一种异步消息服务，它将产生事件的服务与处理事件的服务分离开来</h3></div><div class="nx l"><p class="bd b fp z dy nu ea eb nv ed ef dx translated">cloud.google.com</p></div></div><div class="ny l"><div class="oe l oa ob oc ny od jh np"/></div></div></a></div></div></div>    
</body>
</html>