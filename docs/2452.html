<html>
<head>
<title>Terraform Cloud/Enterprise and GCP Workload Identity Federation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform云/企业和GCP工作负载身份联盟</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/terraform-cloud-enterprise-and-gcp-workload-identity-federation-fbb84a3dfbeb?source=collection_archive---------0-----------------------#2022-10-26">https://medium.com/google-cloud/terraform-cloud-enterprise-and-gcp-workload-identity-federation-fbb84a3dfbeb?source=collection_archive---------0-----------------------#2022-10-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7551" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">注意:本文已更新，最初的文章主要基于GCP工作负载身份的集成和</em><a class="ae je" href="https://developer.hashicorp.com/terraform/enterprise/releases/2022/v202208-1" rel="noopener ugc nofollow" target="_blank"><em class="jd">terra form Cloud OpenID Connect(OIDC)</em></a><em class="jd">集成。今天有一种更清洁的方式叫做</em> <a class="ae je" href="https://www.hashicorp.com/blog/terraform-cloud-adds-dynamic-provider-credentials-vault-official-cloud-providers" rel="noopener ugc nofollow" target="_blank"> <em class="jd"> Terraform云动态提供者凭证</em> </a> <em class="jd">，在引擎盖下是一样的，但是在TFC runner端更加自动化。</em></p><p id="15d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你看到这篇文章，你可能会使用<a class="ae je" href="https://cloud.hashicorp.com/products/terraform" rel="noopener ugc nofollow" target="_blank"> Terraform Cloud </a>或<a class="ae je" href="https://developer.hashicorp.com/terraform/enterprise" rel="noopener ugc nofollow" target="_blank"> Terraform Enterprise </a>自托管实例。很长一段时间以来，利用Terraform Cloud进行Google云部署的唯一方法是<a class="ae je" href="https://support.hashicorp.com/hc/en-us/articles/4406586874387-How-to-set-up-Google-Cloud-GCP-credentials-in-Terraform-Cloud" rel="noopener ugc nofollow" target="_blank">上传一个服务帐户Json密钥</a>。自托管Terraform Enterprise实例有更多选项，虽然它托管在GCP上，但它可以利用连接到托管计算引擎实例的服务帐户，并模拟特定于工作流的服务帐户。但即使这样也不理想，因为没有适当的控制来防止工作流模仿其他工作流打算使用的其他服务帐户。</p><p id="6b50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么，发生了什么变化？作为<a class="ae je" href="https://developer.hashicorp.com/terraform/enterprise/releases/2022/v202208-1" rel="noopener ugc nofollow" target="_blank"> TFE版本v 202208–1(647)</a>的一部分，OpenID Connect (OIDC)被引入Terraform Enterprise/Cloud。我想知道这是否能与GCP工作负载身份联盟一起工作，该联盟本身支持OIDC作为外部身份提供者。长话短说，确实有效！</p><p id="a709" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，Terraform Cloud还引入了<a class="ae je" href="https://developer.hashicorp.com/terraform/cloud-docs/workspaces/dynamic-provider-credentials?product_intent=terraform" rel="noopener ugc nofollow" target="_blank">动态提供商证书</a>，这是一个简化层，用于设置与主要云提供商的OIDC集成。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/09fdf86975936afcb03ed61c90cf5d7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1YQypo8QcO2ybcBfdcjNuQ.jpeg"/></div></div></figure><h1 id="42b5" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">为Terraform云和企业工作流配置GCP工作负载身份联盟</h1><p id="4e7d" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">要运行这个示例，首先克隆<a class="ae je" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric" rel="noopener ugc nofollow" target="_blank">存储库</a>并切换到示例文件夹。</p><pre class="jg jh ji jj fd ku kv kw kx aw ky bi"><span id="7606" class="kz js hi kv b fi la lb l lc ld">git clone <a class="ae je" href="https://github.com/GoogleCloudPlatform/cloud-foundation-fabric.git" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/cloud-foundation-fabric.git</a><br/>cd cloud-foundation-fabric/blueprints/cloud-operations/terraform-cloud-dynamic-credentials</span></pre><h2 id="4ef0" class="kz js hi bd jt le lf lg jx lh li lj kb iq lk ll kf iu lm ln kj iy lo lp kn lq bi translated">创建Terraform云工作流</h2><p id="3d50" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">如果你没有现成的Terraform云组织，你可以注册一个<a class="ae je" href="https://app.terraform.io/public/signup/account" rel="noopener ugc nofollow" target="_blank">免费试用</a>账户。</p><p id="3fc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为<a class="ae je" href="https://developer.hashicorp.com/terraform/cloud-docs/run/cli" rel="noopener ugc nofollow" target="_blank"> CLI驱动的</a>工作流创建一个新的工作区。工作负载身份联合适用于任何工作流类型，但为了简化蓝图，我们使用CLI驱动的工作流。请注意工作区名称和id，我们将在后面的阶段使用它们(您的值会有所不同)。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es lr"><img src="../Images/55122dc121c54a1799d093049f074375.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tRgUbEsOnLkOCotlVy8G3w.png"/></div></div></figure><p id="ea32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到组织设置并记下组织名称和id(您的值将会不同)。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es ls"><img src="../Images/2070d0462a8484ae782566f868d25fe2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I_Uj7TMhCW8BAc8OTcDeRA.png"/></div></div></figure><h2 id="55aa" class="kz js hi bd jt le lf lg jx lh li lj kb iq lk ll kf iu lm ln kj iy lo lp kn lq bi translated">为Terraform云集成部署GCP工作负载身份池提供程序</h2><p id="f53a" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated"><em class="jd">注意:</em> <em class="jd">这是准备部分，需要有足够权限的用户代表执行。</em></p><p id="0bb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建新项目时所需的权限:</p><ul class=""><li id="b312" class="lt lu hi ih b ii ij im in iq lv iu lw iy lx jc ly lz ma mb bi translated">父GCP文件夹/组织的项目创建者</li></ul><p id="d3f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用现有项目时所需的权限:</p><ul class=""><li id="99d9" class="lt lu hi ih b ii ij im in iq lv iu lw iy lx jc ly lz ma mb bi translated">GCP项目层的工作量身份管理</li><li id="d204" class="lt lu hi ih b ii mc im md iq me iu mf iy mg jc ly lz ma mb bi translated">GCP项目层的项目IAM管理</li></ul><p id="14cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">填写必需的变量，使用前面步骤中的TFE组织和工作区id(id不是as名称):</p><pre class="jg jh ji jj fd ku kv kw kx aw ky bi"><span id="e684" class="kz js hi kv b fi la lb l lc ld">cd gcp-workload-identity-provider<br/>mv terraform.auto.tfvars.template terraform.auto.tfvars<br/>vi terraform.auto.tfvars</span></pre><p id="ff70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用应用程序默认凭证进行身份验证，执行terraform代码并部署资源</p><pre class="jg jh ji jj fd ku kv kw kx aw ky bi"><span id="7efe" class="kz js hi kv b fi la lb l lc ld">gcloud auth application-default login<br/>terraform init<br/>terraform apply</span></pre><p id="1255" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，将生成一组输出(您的值会有所不同)，记下该输出，我们将在接下来的步骤中使用它。</p><pre class="jg jh ji jj fd ku kv mh bn mi mj bi"><span id="52f9" class="mk js hi kv b be ml mm l lc ld">project_id = "tfc-dynamic-creds-gcp"<br/>tfc_workspace_wariables = {<br/>  "TFC_GCP_PROJECT_NUMBER" = "200635100209"<br/>  "TFC_GCP_PROVIDER_AUTH" = "true"<br/>  "TFC_GCP_RUN_SERVICE_ACCOUNT_EMAIL" = "sa-tfc@tfc-dynamic-creds-gcp.iam.gserviceaccount.com"<br/>  "TFC_GCP_WORKLOAD_POOL_ID" = "tfc-pool"<br/>  "TFC_GCP_WORKLOAD_PROVIDER_ID" = "tfc-provider"<br/>}</span></pre><p id="8815" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为部署的一部分，我们有以下内容:</p><ul class=""><li id="0f8c" class="lt lu hi ih b ii ij im in iq lv iu lw iy lx jc ly lz ma mb bi translated">GCP工作量身份池和提供者。</li><li id="f51c" class="lt lu hi ih b ii mc im md iq me iu mf iy mg jc ly lz ma mb bi translated">提供商有一个属性条件，以确保只有在特定的TFC组织生成的OIDC令牌可以使用。</li><li id="8f3a" class="lt lu hi ih b ii mc im md iq me iu mf iy mg jc ly lz ma mb bi translated">用于模拟的服务帐户，其中我们仅允许基于令牌属性的特定TFC工作流进行模拟。</li><li id="b880" class="lt lu hi ih b ii mc im md iq me iu mf iy mg jc ly lz ma mb bi translated">对于测试步骤，我们授予服务帐户存储管理权限。</li></ul><h2 id="f5be" class="kz js hi bd jt le lf lg jx lh li lj kb iq lk ll kf iu lm ln kj iy lo lp kn lq bi translated">为您的TFC工作流配置动态提供商凭据</h2><p id="d9f0" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">要为TFC工作流配置<a class="ae je" href="https://developer.hashicorp.com/terraform/cloud-docs/workspaces/dynamic-provider-credentials/gcp-configuration" rel="noopener ugc nofollow" target="_blank"> GCP动态提供者凭证</a>，您需要设置一组环境变量:</p><ul class=""><li id="d228" class="lt lu hi ih b ii ij im in iq lv iu lw iy lx jc ly lz ma mb bi translated"><code class="du mn mo mp kv b">TFC_GCP_PROVIDER_AUTH</code></li><li id="e489" class="lt lu hi ih b ii mc im md iq me iu mf iy mg jc ly lz ma mb bi translated"><code class="du mn mo mp kv b">TFC_GCP_PROJECT_NUMBER</code></li><li id="6d17" class="lt lu hi ih b ii mc im md iq me iu mf iy mg jc ly lz ma mb bi translated"><code class="du mn mo mp kv b">TFC_GCP_RUN_SERVICE_ACCOUNT_EMAIL</code></li><li id="9553" class="lt lu hi ih b ii mc im md iq me iu mf iy mg jc ly lz ma mb bi translated"><code class="du mn mo mp kv b">TFC_GCP_WORKLOAD_POOL_ID</code></li><li id="db85" class="lt lu hi ih b ii mc im md iq me iu mf iy mg jc ly lz ma mb bi translated"><code class="du mn mo mp kv b">TFC_GCP_WORKLOAD_PROVIDER_ID</code></li></ul><p id="67f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到工作流-&gt;变量页面，然后单击+添加变量按钮。对于变量类型，选择<code class="du mn mo mp kv b"> Environment variable</code>。上面列出的变量名是您需要设置的变量名。上一步中terraform输出中提供的值是您需要为每个变量提供的值。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es mq"><img src="../Images/c21fb4b1326be8c01746798e58820b88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pbQwtWflZ-GwqnRK_5Lnlg.png"/></div></div></figure><p id="38cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，我们设置GCP身份联盟来信任TFC生成的OIDC令牌，工作流应该能够使用动态提供者凭据来模拟GCP服务帐户。</p></div><div class="ab cl mr ms gp mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="hb hc hd he hf"><h2 id="34bc" class="kz js hi bd jt le lf lg jx lh li lj kb iq lk ll kf iu lm ln kj iy lo lp kn lq bi translated">测试结果</h2><p id="8765" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">为了测试该设置，我们将从上一步中创建的TFC工作流中部署一个GCS bucket。这将允许我们验证工作流是否可以使用TFC动态提供者凭据成功地与GCP服务进行交互。</p><p id="6f9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们跳转到<em class="jd"> tfc-workflow-using-wif </em>目录，配置terraform backend指向我们的工作区，使用TFE组织名称和工作区名称(名称与id不同):</p><pre class="jg jh ji jj fd ku kv kw kx aw ky bi"><span id="a77b" class="kz js hi kv b fi la lb l lc ld">cd ../tfc-workflow-using-wif<br/>mv backend.tf.template backend.tf<br/>vi backend.tf</span></pre><p id="59cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据准备步骤的结果填写变量:</p><pre class="jg jh ji jj fd ku kv kw kx aw ky bi"><span id="848f" class="kz js hi kv b fi la lb l lc ld">mv terraform.auto.tfvars.template terraform.auto.tfvars<br/>vi terraform.auto.tfvars</span></pre><h2 id="ee12" class="kz js hi bd jt le lf lg jx lh li lj kb iq lk ll kf iu lm ln kj iy lo lp kn lq bi translated">验证terraform以触发CLI驱动的工作流</h2><p id="9735" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">按照此<a class="ae je" href="https://learn.hashicorp.com/tutorials/terraform/cloud-login" rel="noopener ugc nofollow" target="_blank">文档</a>从CLI登录ti terraform cloud并触发工作流执行:</p><pre class="jg jh ji jj fd ku kv kw kx aw ky bi"><span id="ccc7" class="kz js hi kv b fi la lb l lc ld">terraform login<br/>terraform init<br/>terraform apply</span></pre><p id="3d6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我们使用工作负载身份联合成功部署了Terraform Cloud workflow的GCS bucket。</p><p id="94d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦完成测试，您可以通过首先在<em class="jd"> tfc-workflow-using-wif </em>中运行<em class="jd"> terraform destroy </em>，然后运行<em class="jd">GCP-workload-identity-provider</em>文件夹来清理资源。</p></div></div>    
</body>
</html>