<html>
<head>
<title>Google Kubernetes Engine, load-testing and auto-scaling with Locust</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌Kubernetes引擎，负载测试和自动缩放与蝗虫</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-kubernetes-engine-load-testing-and-auto-scaling-with-locust-ceefc088c5b3?source=collection_archive---------0-----------------------#2018-05-30">https://medium.com/google-cloud/google-kubernetes-engine-load-testing-and-auto-scaling-with-locust-ceefc088c5b3?source=collection_archive---------0-----------------------#2018-05-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="abef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我之前聚会的博客版本，在爱丁堡的DevOps游乐场展示。找到我们在<a class="ae jd" href="https://www.meetup.com/DevOpsPlayground/" rel="noopener ugc nofollow" target="_blank">伦敦</a>和<a class="ae jd" href="https://www.meetup.com/DevOps-Playground-Edinburgh/" rel="noopener ugc nofollow" target="_blank">爱丁堡</a>的下一次聚会！<br/>您也可以关注<a class="je jf ge" href="https://medium.com/u/964e556b3496?source=post_page-----ceefc088c5b3--------------------------------" rel="noopener" target="_blank"> ECS Digital </a>了解我们接下来的计划。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es jg"><img src="../Images/57c9877ce289010deb4114a37a2df496.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OUoJD4q7DnuRCLzWyG-VYw.png"/></div></div></figure><h1 id="c0e6" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">概观</h1><p id="f4ad" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">在这个meetup中，我们将在Google云平台上创建一个Kubernetes集群，使用Google Kubernetes引擎和可抢占的实例。我们将创建一个应用程序，构建一个Docker映像，并将该映像推送到Google容器注册表，然后在集群上运行该映像，然后对其进行负载测试。我们将降低应用程序的性能以看到集群向上扩展，然后提高性能以看到集群向下扩展。我们将使用滚动更新对应用程序进行更改。</p><h2 id="56b0" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">关于可抢占实例的一个注记</h2><p id="3e1c" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">可抢占实例是比GCP上的普通实例便宜80%的实例，但谷歌会在24小时内要求它们返回，当它们的平台需要更多计算时。只要基础设施上运行的应用程序支持，这是一个省钱的好方法。</p><h1 id="ada2" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">GCP入门</h1><h2 id="0f8a" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">注册</h2><p id="6c31" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated"><a class="ae jd" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/</a></p><h2 id="553a" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">开始免费试用</h2><p id="85e1" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">开始免费试用</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/bfc0e5cef01382c45b5876f095595852.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9sU5g12cyeyrFoA2.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/a0c6a7ef501d5d0570c8aa2bfe7f9d79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B5zBj7SMTAybi8k_.png"/></div></div></figure><p id="8bc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您需要填写您的详细信息。一旦一切完成，你将被带到这个屏幕。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/53953a3b4e0bc485a21cf18ad4c5f902.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wF1Z7hD-vs9awuYn.png"/></div></div></figure><h2 id="c288" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">选择您的项目</h2><p id="3ceb" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">在顶部选择你的项目，你会看到一个类似的屏幕。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/c27b38b0d4137bb6348009e980ec2356.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kk6IIvV0Wmxq4lx9.png"/></div></div></figure><h1 id="bd2b" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">谷歌Kubernetes引擎</h1><p id="512e" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">使用左侧的汉堡菜单导航到Kubernetes引擎。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/80c9ba35d65ade6b2199dd957a3c79f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UAHhUVGmOmXObVxr.png"/></div></div></figure><h1 id="24a2" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">启动谷歌云外壳</h1><p id="cd4c" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">Google Cloud Shell是一个面向Google云平台的交互式Shell环境。它使您可以轻松管理您的项目和资源，而不必在您的系统上安装Google Cloud SDK和其他工具。有了Cloud Shell，Cloud SDK gcloud命令行工具和其他你需要的实用工具在你需要的时候随时可用。</p><p id="614a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云壳提供以下功能:</p><ul class=""><li id="9376" class="lk ll hi ih b ii ij im in iq lm iu ln iy lo jc lp lq lr ls bi translated">临时计算引擎虚拟机实例</li><li id="dcd3" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated">从web浏览器对实例的命令行访问</li><li id="16d1" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated">内置代码编辑器测试版</li><li id="59ce" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated">5 GB的永久磁盘存储</li><li id="721f" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated">预装谷歌云SDK等工具</li><li id="6afe" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated">语言支持Java，Go，Python，Node.js，PHP，Ruby和。网</li><li id="02ab" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated">Web预览功能</li><li id="8437" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated">访问GCP控制台项目和资源的内置授权</li></ul><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/d5970475885d2ba6a981a9715d9452d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*iOUXg31Lj2ZrXgJM.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/0564199d552a23fd3925fd1c14f53061.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CWvCgUN6Qxe_AvP0.png"/></div></div></figure><h1 id="cef3" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">创建您的GKE集群</h1><p id="6bb7" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">如果您刚刚创建了新帐户，可能需要5-10分钟才能创建新的群集。</p><h2 id="1e39" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">命令</h2><p id="5a78" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">运行以下命令，这将设置稍后将使用的PROJECT_IT变量，创建集群，并获取集群的凭据。</p><pre class="jh ji jj jk fd ly lz ma mb aw mc bi"><span id="3bb5" class="kv jt hi lz b fi md me l mf mg">gcloud config set container/use_v1_api false<br/>export PROJECT_ID="$(gcloud config get-value project -q)"</span><span id="9850" class="kv jt hi lz b fi mh me l mf mg">gcloud beta container --project ${PROJECT_ID} clusters create "playground" --region "us-east1-b" --username "admin" --cluster-version "1.8.8-gke.0" --machine-type "f1-micro" --image-type "COS" --disk-size "10" --scopes "https://www.googleapis.com/auth/compute","https://www.googleapis.com/auth/devstorage.read_only","https://www.googleapis.com/auth/logging.write","https://www.googleapis.com/auth/monitoring","https://www.googleapis.com/auth/servicecontrol","https://www.googleapis.com/auth/service.management.readonly","https://www.googleapis.com/auth/trace.append" --preemptible --num-nodes "3" --network "default" --no-enable-cloud-logging --enable-cloud-monitoring --subnetwork "default" --enable-autoscaling --min-nodes "3" --max-nodes "7" --addons HorizontalPodAutoscaling,HttpLoadBalancing --enable-autorepair</span><span id="dedc" class="kv jt hi lz b fi mh me l mf mg">gcloud container clusters get-credentials playground --zone us-east1-b --project ${PROJECT_ID}</span></pre><p id="878d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成此命令大约需要5分钟。</p><p id="8640" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">记住，如果你打开一个新的云Shell，你将需要再次运行<code class="du mi mj mk lz b">export PROJECT_ID="$(gcloud config get-value project -q)"</code>命令。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/65a78b52b1a7ff90626e2cf4beea0aa2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*E3NBVuuBLBq3ShCZ.png"/></div></div></figure><p id="2994" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与此同时，在菜单中，打开Stackdriver下的Monitoring，并为您的帐户启用它(如果尚未启用)。这将允许它在后台监控您的集群。</p><h2 id="1cfe" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">细节</h2><ul class=""><li id="34ac" class="lk ll hi ih b ii kq im kr iq ml iu mm iy mn jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">gcloud beta container</code>:我们使用一些测试版功能</li><li id="dd9a" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--project ${PROJECT_ID}</code>:我们指定创建集群的项目</li><li id="aba9" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">clusters create "playground"</code>:我们指定要创建一个名为“playground”的新集群</li><li id="8135" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--region "us-east1-b"</code>:将创建集群的区域</li><li id="2750" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--username "admin"</code> : Root用户名</li><li id="6ea7" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--cluster-version "1.8.8-gke.0"</code> : Kubernetes版本</li><li id="f0f9" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--machine-type "f1-micro"</code>:底层虚拟机实例的大小</li><li id="c90e" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--image-type "COS"</code>:虚拟机上运行的映像，容器优化的操作系统</li><li id="025d" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--scopes ...</code>:授予虚拟机的API访问类型和级别</li><li id="cbbc" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--preemptible</code>:用户可抢占的虚拟机，如果需要更多计算，谷歌可以终止这些虚拟机。<a class="ae jd" href="https://cloud.google.com/preemptible-vms/" rel="noopener ugc nofollow" target="_blank">查看更多...</a></li><li id="235b" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--num-nodes "3"</code>:集群需要3个虚拟机</li><li id="90f4" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--network "default" --subnetwork "default"</code>:使用默认网络和子网</li><li id="c8dc" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--no-enable-cloud-logging --enable-cloud-monitoring</code>:禁用日志记录，但启用对Stackdriver的监控</li><li id="8d46" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--enable-autoscaling</code>:使集群能够根据pod所需的资源进行伸缩</li><li id="8af1" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--min-nodes "3" --max-nodes "7"</code>:集群可以在3到7个节点之间扩展</li><li id="51f2" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--addons HorizontalPodAutoscaling,HttpLoadBalancing</code>:允许集群扩展pod并使用Google Cloud负载平衡所必需的。</li><li id="bbda" class="lk ll hi ih b ii lt im lu iq lv iu lw iy lx jc lp lq lr ls bi translated"><code class="du mi mj mk lz b">--enable-autorepair</code>:让GKE修复不健康的节点</li></ul><h1 id="edfb" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">构建您的应用程序映像</h1><h2 id="5b52" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">打开cloudshell编辑器</h2><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/493d1cf4bb4bd2af36937501ab021121.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vARoHH8xqE586f7G.png"/></div></div></figure><h2 id="3d64" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">创建操场文件夹</h2><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/98da6b282c01a5cf1a1ec8ede3dff4a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eK94IllbwVocnVOt.png"/></div></div></figure><h2 id="c656" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">创建应用程序文件</h2><p id="3422" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">你的申请是用Golang写的，会写到文件<code class="du mi mj mk lz b">main.go</code>里。首先创建main.go文件</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/a99ba26a9a2866cf6ee7e8eefa5f30aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*k8dRm8L2Iesimu8e.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/41b4d236c8a40a9cc404c9084f34202c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*d_v_f30oguyVVMVV.png"/></div></div></figure><p id="7d7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将此作为文件内容粘贴:</p><pre class="jh ji jj jk fd ly lz ma mb aw mc bi"><span id="8785" class="kv jt hi lz b fi md me l mf mg">package main<br/>import (<br/>        "fmt"<br/>        "log"<br/>        "net/http"<br/>        "os"<br/>        "time"<br/>)</span><span id="530f" class="kv jt hi lz b fi mh me l mf mg">func main() {<br/>        port := "8080"</span><span id="3289" class="kv jt hi lz b fi mh me l mf mg">        server := http.NewServeMux()<br/>        server.HandleFunc("/", app)</span><span id="b294" class="kv jt hi lz b fi mh me l mf mg">        log.Printf("Server listening on the port %s", port)</span><span id="2500" class="kv jt hi lz b fi mh me l mf mg">        err := http.ListenAndServe(":"+port, server)<br/>        log.Fatal(err)<br/>}</span><span id="71fe" class="kv jt hi lz b fi mh me l mf mg">func app(w http.ResponseWriter, r *http.Request) {<br/>        log.Printf("Serving request: %s", r.URL.Path)<br/>        host, _ := os.Hostname()</span><span id="0d24" class="kv jt hi lz b fi mh me l mf mg">        fmt.Fprintf(w, "Hello, Edinburgh!\n")<br/>        fmt.Fprintf(w, "Pod Name: %s\n", host)</span><span id="f1a9" class="kv jt hi lz b fi mh me l mf mg">        time.Sleep(time.Second)<br/>}</span></pre><h2 id="64a7" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">创建您的docker文件</h2><p id="5f6a" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">创建另一个名为<code class="du mi mj mk lz b">Dockerfile</code>的文件，并粘贴以下内容。该文件将用于创建您的应用程序的映像，该映像将在集群上运行。</p><pre class="jh ji jj jk fd ly lz ma mb aw mc bi"><span id="636d" class="kv jt hi lz b fi md me l mf mg">FROM golang:1.8-alpine<br/>ADD . /go/src/app<br/>RUN go install app</span><span id="4f8b" class="kv jt hi lz b fi mh me l mf mg">FROM alpine:latest<br/>COPY --from=0 /go/bin/app .<br/>ENV PORT 8080<br/>CMD ["./app"]</span></pre><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/c51dabc277655a6bd8afafb19e5dbf8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AVsdBVe3emHHXl_G.png"/></div></div></figure><h2 id="57cd" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">创建你的码头形象</h2><p id="7a6c" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">我们现在要构建图像。</p><pre class="jh ji jj jk fd ly lz ma mb aw mc bi"><span id="ef21" class="kv jt hi lz b fi md me l mf mg">cd playground<br/>docker build -t gcr.io/${PROJECT_ID}/app:v1 .</span></pre><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/3f2fe17a9cb76d382ff6d7ff69a3266c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vIoVFd_RjJvBHakW.png"/></div></div></figure><h2 id="399a" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">在本地测试映像</h2><p id="8e73" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">尝试在本地端口8080上运行您的映像。<code class="du mi mj mk lz b">docker run --rm -p 8080:8080 gcr.io/${PROJECT_ID}/app:v1</code>然后在8080端口预览app。Cloud Shell有一个方便的快捷方式。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/49d29bfcf9275d92101bb58818a3e6cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*f_rPEYCThWWRZEFA.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/debaf934da17fc4756d3d7f076b689ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RtG8F27DrcQHVYun.png"/></div></div></figure><p id="bfff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关闭标签并运行<code class="du mi mj mk lz b">ctrl+C</code>来停止网页预览</p><h2 id="1198" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">将图像推送到Google容器注册表</h2><p id="be55" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">当你的图像工作时，是时候把它推送到谷歌容器注册处了<code class="du mi mj mk lz b">gcloud docker -- push gcr.io/${PROJECT_ID}/app:v1</code></p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/c1dbf3aac756ddc48de96ff9532d2784.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*v74FtQ926boU0NdG.png"/></div></div></figure><h1 id="ee0b" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">在集群中运行映像，并公开部署</h1><h2 id="65e0" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">创建部署</h2><p id="c03a" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">既然映像已经在注册表中，我们可以简单地在我们的集群<code class="du mi mj mk lz b">kubectl run app --image=gcr.io/${PROJECT_ID}/app:v1 --port 8080 --requests="cpu=100m"</code>上运行它</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/92ed7a24b82efd07cec0d5c1e5c525ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aSIdnkZs5M1byoRP.png"/></div></div></figure><h2 id="9389" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">公开部署</h2><p id="71f0" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">应用程序正在运行，但是我们还不能从外部访问它，我们需要公开它。</p><p id="9847" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过端口80上的负载平衡器公开应用部署。<code class="du mi mj mk lz b">kubectl expose deployment app --type=LoadBalancer --port 80 --target-port 8080</code>返回GKE选项卡，进入服务页面</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/c573d7497e3c2a8cb8b23c1a9a77cc79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qtzLGBKRxVmIuspF.png"/></div></div></figure><p id="ab65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">50秒后，您的公共IP将可用，如果您按下刷新按钮，您可以简单地点击链接。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/d80f30966ffd1d8570035276602eed45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tMbBrN7VqGU9hCOe.png"/></div></div></figure><p id="3968" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者运行<code class="du mi mj mk lz b">kubectl get svc app</code>，复制外部IP，在另一个选项卡中访问。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/184cf37e0908d519a549dd643b29e258.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7vfEWjFI7ExSpKMV.png"/></div></div></figure><p id="5669" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Tada，你的应用程序起作用了！</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/b909e072938d00514a4102a8a15cc72f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JUe5_7vItOtaHBSs.png"/></div></div></figure><h2 id="a49b" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">为应用部署启用自动缩放</h2><p id="537d" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">我们将让GKE知道，我们希望我们的pod保持在80%左右的负载，因此如果负载超过此阈值，它可以创建更多的pod，最多可达30个，如果负载低于80%，则它可以删除一些pod。</p><p id="19c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du mi mj mk lz b">kubectl autoscale deployment app --cpu-percent=80 --min=1 --max=30</code></p><p id="5f2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在“工作负载”页面上，查看应用程序部署，注意当前负载，以及当前运行应用程序的单元数量。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/aee98e84ccf3781a605bc2feda410f45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*p5K1Fb9xMiC2SfhK.png"/></div></div></figure><h1 id="ec13" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">负载测试</h1><h2 id="1031" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">创建负载测试群集</h2><p id="4c90" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">现在应用程序正在运行，让我们看看它对负载的反应。我们将首先创建一个单独的集群，负责处理负载测试。我们将集群分开，这样负载测试就不会耗尽资源。</p><pre class="jh ji jj jk fd ly lz ma mb aw mc bi"><span id="b21c" class="kv jt hi lz b fi md me l mf mg">gcloud beta container --project ${PROJECT_ID} clusters create "loadtesting" --zone "us-east1-b" --username "admin" --cluster-version "1.8.8-gke.0" --machine-type "custom-8-8192" --image-type "COS" --disk-size "10" --scopes "https://www.googleapis.com/auth/compute","https://www.googleapis.com/auth/devstorage.read_only","https://www.googleapis.com/auth/logging.write","https://www.googleapis.com/auth/monitoring","https://www.googleapis.com/auth/servicecontrol","https://www.googleapis.com/auth/service.management.readonly","https://www.googleapis.com/auth/trace.append" --preemptible --num-nodes "1" --network "default" --no-enable-cloud-logging --enable-cloud-monitoring --subnetwork "default" --addons HorizontalPodAutoscaling,HttpLoadBalancing --enable-autorepair<br/>gcloud container clusters get-credentials loadtesting --zone us-east1-b --project ${PROJECT_ID}</span></pre><p id="650b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将需要5分钟才能完成。</p><h2 id="cd91" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">创建负载测试复制控制器和服务</h2><p id="4a1e" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">我们现在将创建一个名为<code class="du mi mj mk lz b">loadtest-deployment.yaml</code>的文件，它包含我们的负载测试将需要的三个元素。</p><pre class="jh ji jj jk fd ly lz ma mb aw mc bi"><span id="327d" class="kv jt hi lz b fi md me l mf mg">kind: ReplicationController<br/>apiVersion: v1<br/>metadata:<br/>  name: locust-master<br/>  labels:<br/>    name: locust<br/>    role: master<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    name: locust<br/>    role: master<br/>  template:<br/>    metadata:<br/>      labels:<br/>        name: locust<br/>        role: master<br/>    spec:<br/>      containers:<br/>        - name: locust<br/>          image: gcr.io/cloud-solutions-images/locust-tasks:latest<br/>          env:<br/>            - name: LOCUST_MODE<br/>              value: master<br/>            - name: TARGET_HOST<br/>              value: http://app.ip.address<br/>          ports:<br/>            - name: loc-master-web<br/>              containerPort: 8089<br/>              protocol: TCP<br/>            - name: loc-master-p1<br/>              containerPort: 5557<br/>              protocol: TCP<br/>            - name: loc-master-p2<br/>              containerPort: 5558<br/>              protocol: TCP<br/>---<br/>kind: ReplicationController<br/>apiVersion: v1<br/>metadata:<br/>  name: locust-worker<br/>  labels:<br/>    name: locust<br/>    role: worker<br/>spec:<br/>  replicas: 30<br/>  selector:<br/>    name: locust<br/>    role: worker<br/>  template:<br/>    metadata:<br/>      labels:<br/>        name: locust<br/>        role: worker<br/>    spec:<br/>      containers:<br/>        - name: locust<br/>          image: gcr.io/cloud-solutions-images/locust-tasks:latest<br/>          env:<br/>            - name: LOCUST_MODE<br/>              value: worker<br/>            - name: LOCUST_MASTER<br/>              value: locust-master<br/>            - name: TARGET_HOST<br/>              value: http://app.ip.address<br/>---<br/>kind: Service<br/>apiVersion: v1<br/>metadata:<br/>  name: locust-master<br/>  labels:<br/>    name: locust<br/>    role: master<br/>spec:<br/>  ports:<br/>    - port: 8089<br/>      targetPort: loc-master-web<br/>      protocol: TCP<br/>      name: loc-master-web<br/>    - port: 5557<br/>      targetPort: loc-master-p1<br/>      protocol: TCP<br/>      name: loc-master-p1<br/>    - port: 5558<br/>      targetPort: loc-master-p2<br/>      protocol: TCP<br/>      name: loc-master-p2<br/>  selector:<br/>    name: locust<br/>    role: master<br/>  type: LoadBalancer</span></pre><p id="821b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将<code class="du mi mj mk lz b">app.ip.address</code>替换为您的应用部署的IP地址。</p><p id="d48c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在继续使用下面的命令<code class="du mi mj mk lz b">kubectl create -f loadtest-deployment.yaml</code>创建这些元素。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/271d10a93f1d328b964c26fcfa6d1fa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IWC77rH043ez5PQe.png"/></div></div></figure><p id="de98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在回到服务页面，或者运行<code class="du mi mj mk lz b">kubectl get svc locust-master</code>，然后转到端口8089上的外部IP。</p><p id="2faf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">欢迎来到蝗虫</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/6ca41591c316f6859c137f0aaa9119ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mZFIuWybvPWp_ACY.png"/></div></div></figure><p id="0c05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用10个用户和10的孵化率运行一个测试。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/4b7eeaf549d08868151f0c0186247d3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MHeoBmokXgXboiQg.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/437c7a3f4dedf4be5b81fb1943272a39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*D-RFWa0Isytt933Y.png"/></div></div></figure><p id="35e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它似乎没有给应用程序或集群带来太大的压力，所以用1000个用户和100个孵化率再试一次。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/db7b613d87e9322e128f073d862aa153.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kaNPQk6u9BeScBb1.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/9c17a0e27a6ce926d5d111da79f4cd96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mP_PA6zAp2bS7ZPD.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/9f9ef89891a89356c9813bcf9cd19cd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*i5Z0DiU_4FD6aKpc.png"/></div></div></figure><p id="2050" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该应用程序非常简单，运行速度非常快，可以很容易地并发运行，所以我们需要放慢一点。(如果你在prod里也有同样的问题，就不要按照接下来的步骤去做了，直接开一瓶啤酒，放松一下！)</p><h1 id="d293" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">减慢我们的应用程序</h1><h2 id="d948" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">更改代码</h2><p id="336e" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">在main.go中，用以下内容替换app函数的结尾。这将导致pod在2秒钟内使用100%的CPU。</p><pre class="jh ji jj jk fd ly lz ma mb aw mc bi"><span id="1f5b" class="kv jt hi lz b fi md me l mf mg">done := make(chan int) <br/>  for i := 0; i &lt; 2; i++ { <br/>    go func() { <br/>      for { <br/>        select { <br/>          case &lt;-done: return <br/>          default: <br/>        } <br/>      } <br/>    }()<br/>  }<br/>  time.Sleep(time.Second)<br/>}</span></pre><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/bf16e31dffc6983bf68160f2873e15d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JPx8yiqPUSIzpK8U.png"/></div></div></figure><h2 id="cdc7" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">建立形象</h2><p id="6a48" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">构建新版本的图像。<code class="du mi mj mk lz b">docker build -t gcr.io/${PROJECT_ID}/app:v2 .</code></p><h2 id="f0ee" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">将新版本推送到Google容器注册表</h2><p id="8957" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">把它推到谷歌容器注册处<code class="du mi mj mk lz b">gcloud docker -- push gcr.io/${PROJECT_ID}/app:v2</code></p><p id="360a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以运行以下命令来获取现有的窗格并观察更改，这将有助于显示窗格是何时创建或删除的:<code class="du mi mj mk lz b">kubectl get pods -w</code></p><h2 id="dd97" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">执行滚动更新</h2><p id="91f6" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">现在更改您的部署使用的映像版本。GKE允许你一次更新一个pod使用的图像版本，或者按X组更新，由你设置X应该是什么。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/4b84fdc59320a67131247aa29c6b0dd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*U2ncl_gs0pkyMOB2.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/ce10f097100bba40a5db6adfdaf96932.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9ei15x6a3QG9QRvV.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/c10b3ae41267b6a32f11c1b4c8eb5b74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*v3HZydNDKeVWS7cL.png"/></div></div></figure><h2 id="d066" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">执行另一个负载测试</h2><p id="f3a3" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">用10个用户再次测试</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/f81839cabfc59781baf80a7a5794fe8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5u9FimaKQPOTFrvf.png"/></div></div></figure><p id="dde1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让负载在后台运行。</p><h1 id="205b" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">按比例放大</h1><p id="14ad" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">几分钟后，你可以看到豆荚的数量在增加</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/dea8777a2ad07ea86393b61b8c62a014.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6ksMd_mfiETNOWnV.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/9e4103c7fdbf419ddca93445e08558ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7t784t6ZLQqQWRLl.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/ae345d9ecabd333ffc7247d6f0b33db5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Rsb7AwOZ9Zeje5v2.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/49f79c8438977e1fccf237cf5475a02e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W1KUhA9jbd3pYV4T.png"/></div></div></figure><p id="4a92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再等一会儿，您会看到作为集群的一部分运行的实例数量增加了</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/236a78e61bb72041a9062db78e079ee4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LgvFMUC35h6ARmiE.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/8e55c630c31dc061b24562d0a16eb7f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*z5hi1goK8Ft_fZy7.png"/></div></div></figure><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/28079157d14eed1b9bf9b332d48b0708.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*In_3dvX4yo95nsHI.png"/></div></div></figure><p id="88e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看Stackdriver可以从另一个角度了解集群的负载。</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/9dbab051894803f8d7971d6856892eaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5KmZYzIuYwJRLWiX.png"/></div></div></figure><p id="3ca4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，应用程序实际上表现很差，所以让我们稍微提高一下它的性能。</p><h2 id="7fe3" class="kv jt hi bd ju kw kx ky jy kz la lb kc iq lc ld kg iu le lf kk iy lg lh ko li bi translated">将应用程序的性能提高一倍</h2><p id="d17f" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">更改我们添加到<code class="du mi mj mk lz b">i &lt; 1;</code>的代码片段中的<code class="du mi mj mk lz b">i &lt; 2;</code>，这将使应用程序的性能翻倍。</p><p id="2696" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后构建您的映像的新版本。<code class="du mi mj mk lz b">docker build -t gcr.io/${PROJECT_ID}/app:v3 .</code></p><p id="65ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将其推送到Google容器注册表<code class="du mi mj mk lz b">gcloud docker -- push gcr.io/${PROJECT_ID}/app:v3</code></p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/efe9e6872693106c6d0607752ac3a1a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bMp63r6XHE990wL8.png"/></div></div></figure><p id="25ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后再做一次滚动更新，允许一次更新5个pod</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/07bdca52ca0fe1f40508353fe74a4532.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*afA1uNPkC6TGdHhl.png"/></div></div></figure><p id="2f1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在这样更好了。但是让我们回到我们的原始版本，它工作得更快，因此需要更少的pod来响应相同数量的请求。保持locust运行，以查看负载测试如何受到实时升级的影响。</p><h1 id="d55f" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">分频</h1><p id="4d9b" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">使用应用程序的v1进行另一次滚动更新。</p><p id="9ca8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你关注蝗虫，你会看到RPS变慢，因为pod被终止，然后上升，因为它们被运行更高性能应用的pod取代。</p><p id="ac6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您让它运行一段时间，您会看到部署减少了它使用的单元数量，集群减少了它使用的节点数量。</p><h1 id="1ccf" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">清理</h1><p id="ff2c" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">删除操场集群<code class="du mi mj mk lz b">gcloud beta container --project ${PROJECT_ID} clusters delete "playground" --region "us-east1-b" --async</code></p><p id="0ee7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除负载测试集群<code class="du mi mj mk lz b">gcloud beta container --project ${PROJECT_ID} clusters delete loadtesting --zone us-east1-b --async</code></p><p id="90f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除你的图片<code class="du mi mj mk lz b">gcloud container images delete gcr.io/${PROJECT_ID}/app:v1 --force-delete-tags</code></p><p id="9038" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，可能仍然存在一些转发规则，随着时间的推移，这些规则会花费您一些钱，所以请查看并删除任何仍然存在的规则网络服务&gt;负载平衡&gt;高级菜单&gt;转发规则</p></div></div>    
</body>
</html>