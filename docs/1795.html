<html>
<head>
<title>Centrally Managing Artifact Registry Container Image Vulnerabilities on Google Cloud: Part Two</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google Cloud上集中管理工件注册表容器映像漏洞:第二部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/centrally-managing-artifact-registry-container-image-vulnerabilities-on-google-cloud-part-two-ad730e7cf649?source=collection_archive---------0-----------------------#2021-02-11">https://medium.com/google-cloud/centrally-managing-artifact-registry-container-image-vulnerabilities-on-google-cloud-part-two-ad730e7cf649?source=collection_archive---------0-----------------------#2021-02-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2c7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇由两部分组成的文章的第一部分中，我们看到了如何使用发布/订阅和云函数从跨多个项目的工件/容器注册表中聚集容器映像漏洞，并将它们写到一个集中的位置。这样做的目的是提供一种方法来集中管理整个组织中的所有映像漏洞，而不需要访问使用容器映像的每个项目。</p><p id="efa4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们的演示中，我们使用Google云存储空间作为存储位置。在现实世界中，您可能希望使用安全指挥中心或您自己的SIEM等解决方案。</p><p id="a09d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第二部分中，我们将修改第一部分中创建的云函数，将漏洞直接写入安全命令中心(SCC)。我们还将讨论你将如何根据自己的SIEM进行写作。</p><p id="b7ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该架构将如下所示:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/a698a005c7e3fe40733c1deda95afd15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-z0usoZ6FSFmmO9Nx0wiZg.jpeg"/></div></div></figure><p id="7473" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae jd" href="https://cloud.google.com/security-command-center/docs/concepts-security-command-center-overview" rel="noopener ugc nofollow" target="_blank">安全指挥中心</a>的资源实质上充当了安全发现的容器。SCC有许多内置资源，如安全健康分析、Web安全扫描程序和事件威胁检测。此外，还提供了许多第三方来源。我们将创建一个自定义源，作为容器映像漏洞发现的容器。</p><p id="e473" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">重要提示:来源和发现不能删除。创建后，它们将继续存在于您的组织帐户中，并且无法删除。建议您使用沙盒域进行任何测试。</strong></p><p id="9d6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，快速设置一下。我们需要在我们的源项目上启用SCC API。在Cloud Shell中运行以下内容。</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="87a9" class="jv jw hi jr b fi jx jy l jz ka">gcloud config set project <em class="kb">&lt;project-id-source&gt;</em></span><span id="f337" class="jv jw hi jr b fi kc jy l jz ka">gcloud services enable securitycenter.googleapis.com</span></pre><p id="ab4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们创建自定义源。不幸的是，gcloud客户端不支持创建源代码，所以我们需要通过客户端库使用<a class="ae jd" href="https://cloud.google.com/security-command-center/docs/reference/rest" rel="noopener ugc nofollow" target="_blank"> SCC REST API </a>。我们将创建一个Python虚拟环境，安装SCC客户端库，并运行一个简短的Python脚本来创建自定义源代码。在Cloud Shell中运行以下命令:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="ecc5" class="jv jw hi jr b fi jx jy l jz ka">pip install virtualenv</span><span id="51dc" class="jv jw hi jr b fi kc jy l jz ka">virtualenv env</span><span id="787e" class="jv jw hi jr b fi kc jy l jz ka">source env/bin/activate</span><span id="75ae" class="jv jw hi jr b fi kc jy l jz ka">env/bin/pip install google-cloud-securitycenter</span></pre><p id="b7aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一步我们需要组织id。在Cloud Shell中运行以下gcloud命令，并复制您正在使用的域的id。在我们的脚本中，我们将其称为<em class="kb"> &lt; org-id &gt; </em>。</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="576d" class="jv jw hi jr b fi jx jy l jz ka">gcloud organizations list</span></pre><p id="ad1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的主目录中，在云外壳代码编辑器中创建一个名为create_source.py的文件，粘贴以下代码，并用您的组织id替换<em class="kb"> &lt; org-id &gt; </em>:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="3437" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在运行之前，安全命令中心API不允许用户帐户，因此我们需要在服务帐户的上下文中运行。我们将使用我们在第一部分中创建的那个。首先，我们需要授予它IAM权限，以便能够创建SCC源和结果。您将需要第一部分中的<em class="kb"> &lt;服务-账户-来源&gt; </em>和<em class="kb"> &lt;项目-id-来源&gt; </em>的值。如果您没有它们，您可以轻松地返回到云控制台中的项目，并查看服务帐户以获得服务帐户名称。</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="97db" class="jv jw hi jr b fi jx jy l jz ka">gcloud organizations add-iam-policy-binding <em class="kb">&lt;org-id&gt;</em> \<br/>--member=serviceAccount:<em class="kb">&lt;service-account-source&gt;</em>@<em class="kb">&lt;project-id-source&gt;</em>.iam.gserviceaccount.com \<br/>--role=roles/securitycenter.adminEditor</span></pre><p id="31a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下内容创建并下载服务帐户密钥:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="124c" class="jv jw hi jr b fi jx jy l jz ka">gcloud iam service-accounts keys create sa-creds.json \<br/>--iam-account=<em class="kb">&lt;service-account-source&gt;</em>@<em class="kb">&lt;project-id-source&gt;</em>.iam.gserviceaccount.com</span><span id="0cfb" class="jv jw hi jr b fi kc jy l jz ka">export GOOGLE_APPLICATION_CREDENTIALS=./sa-creds.json</span></pre><p id="f63c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们可以执行我们的Python代码了:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="4f0e" class="jv jw hi jr b fi jx jy l jz ka">python3 ./create_source.py</span></pre><p id="a5be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">复制命令的输出，因为它包含新的源id，格式如下:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="2325" class="jv jw hi jr b fi jx jy l jz ka">organizations/&lt;org-id&gt;/sources/&lt;source-id&gt;</span></pre><p id="1d9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们不再需要服务帐户密钥，所以让我们整理一下:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="6137" class="jv jw hi jr b fi jx jy l jz ka">rm ./sa-creds.json</span></pre><p id="1f68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们准备好更新我们的云函数，将漏洞事件作为SCC中的发现写入，而不是写入GCS存储桶。在云控制台中，转到第一部分中的源项目，并导航到云函数。点击功能“image-vuln-cf-trigger ”,然后点击编辑。</p><p id="c3ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">展开变量、网络和高级设置部分，然后选择环境变量选项卡。添加一个名为SOURCE_ID的运行时环境变量，以及您刚刚创建的源的值，格式为<em class="kb">organizations/&lt;org-ID&gt;/sources/&lt;SOURCE-ID&gt;</em>。</p><p id="be51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单击下一步。</p><p id="13a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在main.py文件中，用以下代码替换现有代码:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="f1e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并将requirements.txt替换为:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="22de" class="jv jw hi jr b fi jx jy l jz ka">google-cloud-securitycenter</span><span id="7ebb" class="jv jw hi jr b fi kc jy l jz ka">google-cloud-containeranalysis</span></pre><p id="b665" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单击部署。</p><h1 id="d504" class="kf jw hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">将映像推送到工件注册表，并在SCC中查看结果</h1><p id="fa37" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">我们现在准备测试推送映像并查看SCC中的漏洞。</p><p id="51ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Cloud Shell中，使用以下代码创建一个名为DOCKERFILE的文件:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="2fec" class="jv jw hi jr b fi jx jy l jz ka">FROM nginx</span></pre><p id="fec3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在命令行上运行:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="325f" class="jv jw hi jr b fi jx jy l jz ka">gcloud auth configure-docker us-central1-docker.pkg.dev</span><span id="b79c" class="jv jw hi jr b fi kc jy l jz ka">docker build --tag nginx-scc .</span><span id="9b51" class="jv jw hi jr b fi kc jy l jz ka">docker tag nginx-scc us-central1-docker.pkg.dev/<em class="kb">&lt;project-id-source&gt;</em>/<em class="kb">&lt;repo-name&gt;</em>/nginx-test-scc:staging</span><span id="5ee2" class="jv jw hi jr b fi kc jy l jz ka">docker push us-central1-docker.pkg.dev/<em class="kb">&lt;project-id-source&gt;</em>/<em class="kb">&lt;repo-name&gt;</em>/nginx-test-scc:staging</span></pre><p id="95f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们可以转到控制台，在源项目的工件注册表中查看推送的图像。单击映像名称，注意发现的漏洞(扫描可能正在进行)。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lh"><img src="../Images/068c6dd29d60ef7d42251f6b03b487ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*05V7-_WGiTyUQ-rzm8A_Iw.png"/></div></div></figure><p id="19f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以点击并检查图像中发现的每个漏洞。</p><p id="024a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在导航到云控制台的安全部分中的SCC，并切换到组织级别。单击“Findings”选项卡，您应该会看到根据图像扫描中发现的漏洞创建的许多新发现。您可以单击查看每个调查结果，并查看源属性以查看诸如严重性、CVSS分数和受影响图像的链接等信息。</p><p id="5b24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以单击“按源类型查看”来仅过滤容器映像漏洞。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es li"><img src="../Images/b02703c22420002baa8898a4ec1a3d0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8uWte5nwixXHF-p64X8zQA.png"/></div></div></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lj"><img src="../Images/46cef929f5be68132c8190d11c328655.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A9Q4DAyaISHGa9_TZQsTVQ.png"/></div></div></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lk"><img src="../Images/d5cf53de1d0e2b85c73515dd229d8dfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*koh91dNRrS13rAb4VH9utw.png"/></div></div></figure><h1 id="a0db" class="kf jw hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">摘要</h1><p id="6b49" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">现在，您已经将所有映像漏洞发布为SCC中的调查结果，您可以像管理所有其他调查结果一样管理它们，向调查结果添加安全标记，并在修补漏洞后将其设置为非活动状态。每项调查结果都提供了有关受影响图像、项目和CVE信息的信息。SCC提供了一种简单的方法来列出所有仍然有效的漏洞发现，为组织提供跨所有项目的Artifact Registry中容器映像的所有未修补漏洞的视图。</p><p id="e880" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇由两部分组成的文章中，我们首先将GCS作为我们的存储解决方案，然后转向SCC。然而，修改我们的云函数，将漏洞写入您的本地SIEM或大型查询数据集，会相对简单。你可以在这里找到漏洞发生模式<a class="ae jd" href="https://cloud.google.com/container-analysis/docs/reference/rest/v1beta1/projects.occurrences#Details" rel="noopener ugc nofollow" target="_blank">。</a></p><div class="ll lm ez fb ln lo"><a href="https://cloud.google.com/security-command-center/docs/reference/rest" rel="noopener  ugc nofollow" target="_blank"><div class="lp ab dw"><div class="lq ab lr cl cj ls"><h2 class="bd hj fi z dy lt ea eb lu ed ef hh bi translated">安全指挥中心API |谷歌云</h2><div class="lv l"><h3 class="bd b fi z dy lt ea eb lu ed ef dx translated">无论您的企业是刚刚踏上数字化转型之旅，还是已经走上数字化转型之路，谷歌云的解决方案…</h3></div><div class="lw l"><p class="bd b fp z dy lt ea eb lu ed ef dx translated">cloud.google.com</p></div></div><div class="lx l"><div class="ly l lz ma mb lx mc jo lo"/></div></div></a></div></div></div>    
</body>
</html>