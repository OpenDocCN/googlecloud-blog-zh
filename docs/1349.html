<html>
<head>
<title>Secret to securing your Kubernetes networking in 9 steps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">确保Kubernetes网络安全的9个步骤</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/secure-kubernetes-internal-networking-5f2556f7efde?source=collection_archive---------1-----------------------#2020-03-31">https://medium.com/google-cloud/secure-kubernetes-internal-networking-5f2556f7efde?source=collection_archive---------1-----------------------#2020-03-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b8e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为集群内的安全通信配置Kubernetes安全性可能会非常混乱。朱莉娅·埃文斯在她的博客上写道:</p><blockquote class="je jf jg"><p id="8421" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">各种Kubernetes组件有很多不同的地方，您可以在那里放置证书/证书授权。当我们建立一个集群时，我感觉有100亿个不同的命令行参数用于证书、密钥和认证机构，我不明白它们是如何组合在一起的。</p></blockquote><h1 id="fc8a" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">那么，集群中存在哪些与此讨论相关的组件呢？</h1><p id="3841" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">Kubernetes集群组件包括一个主节点，它具有以下组件:</p><ul class=""><li id="2d7e" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc kt ku kv kw bi translated">Kube api服务器——负责集群的整体功能并与用户交互。这基本上是您的集群的控制中心</li><li id="63fd" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">etcd —存储您的kubernetes证书并维护集群的状态。</li><li id="a7ea" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">kube-scheduler——负责与pod相关的调度决策</li><li id="73b5" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">kube-控制器-管理器-管理所有控制器</li></ul><p id="6dc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">工作节点:</p><ul class=""><li id="8e1b" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc kt ku kv kw bi translated">kube let——负责确保工作负载按照它们应该运行的方式运行</li><li id="5231" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">kube dns——负责为您的kubernetes服务设置DNS地址之类的东西</li><li id="6e19" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">kube-proxy——负责为服务路由配置网络组件，如iptables</li><li id="fa9c" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">pod和容器—您的实际工作负载</li></ul><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lc"><img src="../Images/340c33af4ab3b98571f05da0503da272.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*at5J6PffAcjrOUv5uuE6UA.jpeg"/></div></div></figure><p id="ce9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将看到不同的部分如何相互通信是安全的。</p><h1 id="cd8a" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">那么，我应该关注哪些沟通呢？</h1><p id="f526" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">在上述所有组件中，API服务、kubelet和etcd是最关键的组件。比方说，pod需要一个证书，它会与kubelet对话，然后kubelet会与API服务器通信，以访问存储在etcd中的证书。</p><p id="0788" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与主服务器的所有通信都通过API服务器进行。类似地，与worker节点的所有通信都通过kubelet进行。Etcd保存了集群的所有重要信息。所以任何与etcd通讯的东西都要好好保护。</p><p id="aca5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以让我们一个一个地挑选案例。</p><p id="e6c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">案例API服务器与kubelet的通信</strong></p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lc"><img src="../Images/243f1a78a8074920ab04da172b2ad5d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*94bE1E5g-TFHS_OOLwQReg.jpeg"/></div></div></figure><p id="8887" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">API服务器与kubelet进行通信，比如获取日志，从用户那里获取配置，并与kubelet进行通信，使之成为现实。</p><p id="ed9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，从API服务器到kubelet的通信是通过未经认证的TLS进行的。这使得在不受信任的网络上运行集群变得不安全，因为这种通信容易受到中间人攻击。如果你在你的私人网络上运行，这种行为应该是可以接受的。但是，如果您愿意，可以使用标志“kubelet-certificate-authority”来验证kubelet的服务器证书。注意SSH隧道已被弃用，因此不再是推荐的解决方案。</p><p id="63c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">案例2:从kubelet到API服务器的通信</strong></p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lc"><img src="../Images/ee84c67bf5dde7fbcc2ab8ed0e9eddd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wFn3ahQWlmdX7fxdYxlCZA.jpeg"/></div></div></figure><p id="9a55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种情况会发生在诸如当一个新节点联机并且该节点需要一个新的证书来与API服务器通信的情况下。API服务器有一个Kubernetes API，它允许获取由您可以控制的CA签名的TLS证书。</p><p id="7fad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请求使用相互TLS，API服务器监听端口443。因此默认情况下，主服务器可以在不受信任的网络上运行。</p><p id="c67e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里需要注意的另一点是，您需要为您的kubelet证书设置证书轮换。默认情况下，它们的有效期为1年。</p><pre class="ld le lf lg fd lo lp lq lr aw ls bi"><span id="77b5" class="lt jm hi lp b fi lu lv l lw lx">kubeadm alpha certs check-expiration</span></pre><p id="af23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">kubelet旋转证书的命令是- rotate-certificates</p><p id="ef8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">案例3:用户/管理员与API服务器的通信</strong></p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lc"><img src="../Images/ed4ee8ddeca2d908c8dae7219e84daea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hpeuc8UPfi4ww_XGVROfIQ.jpeg"/></div></div></figure><p id="99fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">管理员与各种实例上的API服务器进行交互，以管理集群。</p><p id="d7e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此通信的身份验证方法取决于您的需求。有几个选项，例如:</p><ul class=""><li id="5dd8" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc kt ku kv kw bi translated">静态用户名密码。</li><li id="b10e" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">认证代理</li><li id="82de" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">x509客户端证书</li><li id="65ea" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">OAuth令牌</li></ul><p id="8021" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">案例4a:从API服务器到etcd的通信</strong></p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lc"><img src="../Images/b10479f40e4a7fe98dc331ecfa96a539.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oIwC1mvf51hpVgc0u4X1iA.jpeg"/></div></div></figure><p id="9e55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这可能发生在特定节点或pod向ku elet请求证书的情况下，ku elet向API服务器发出请求，然后API服务器从etcd获取该请求。</p><p id="c836" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与etcd的通信通过本地主机的端口80进行，没有经过身份验证或加密。您应该为这部分通信设置TLS，通过指定标志“etcd-certfile”来验证etcd实例与etcd服务器的身份。</p><p id="360c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">相反，API服务器监听安全的HTTPS端口443。</p><p id="bf39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">案例4b:从etcd到API服务器的通信</strong></p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es ly"><img src="../Images/2e84351cb7035bb66d0be8c4e9fecc10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p5GvzerYk3U2lMFsuqGXSA.png"/></div></div></figure><p id="f865" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">API服务器监听安全的HTTPS端口443。</p><p id="9ebb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">案例etcd的两个实例之间的通信</strong></p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lc"><img src="../Images/818a134b5e736fdeda97ca7a8d530a44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GRZOeqa4wltN7IHmuvDTBw.jpeg"/></div></div></figure><p id="a277" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Etcd实例相互通信以保持状态同步。</p><p id="0815" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">etcd的实例已经通过相互TLS进行通信，因此这部分集群在不受信任的网络上运行也应该是安全的。</p><p id="34df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">案例6:两个吊舱之间</strong></p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lc"><img src="../Images/2bff74d669150376a67d602874661b30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fDdrmAh5qtQH_LBzcq_RwA.jpeg"/></div></div></figure><p id="de15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如您所知，不同或相同节点中的pod可以无缝地相互通信而不会停滞，这是Kubernetes网络的基本原则之一。所以这是另一个重要的交流途径。</p><p id="590f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前，这种通信没有加密，也没有认证。有一些方法可以使它更加安全，例如使用一些网络策略提供商，如<a class="ae jd" href="https://www.tigera.io/tigera-products/calico/" rel="noopener ugc nofollow" target="_blank"> Tigera的Calico </a>或<a class="ae jd" href="https://cilium.io/blog/2018/09/19/kubernetes-network-policies/" rel="noopener ugc nofollow" target="_blank"> Cilium </a>来保护服务到服务的流量。至少，强烈建议根据您的应用程序使用一些网络策略提供程序。</p><p id="4e4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以使用类似于<a class="ae jd" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio </a>的服务网格来为服务之间的流量实施相互TLS。使用一个完整的服务网格来执行服务到服务通信之间的相互TLS可能看起来是一个巨大的要求，因此可以使用一个网络策略提供商来提供相同的服务，而不需要在每个pod前使用代理。</p><p id="fc6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里要推荐的一个明显的东西是Pod安全策略。我将在另一篇博文中详细阐述这个问题。</p><p id="2532" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种沟通途径非常重要，可能需要一整篇文章。</p><p id="a0ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">案例7:从pod到API服务器</strong></p><p id="bb7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种类型的通信是通过普通的HTTP完成的，但实际上这种类型的通信甚至不应该直接发生。</p><p id="f6ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">案例8:其他组件如kubescheduler，kube-controller-manager与API服务器对话。</strong></p><p id="bf0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这发生在本地主机上，您也可以在这里设置安全通信。使用</p><pre class="ld le lf lg fd lo lp lq lr aw ls bi"><span id="9787" class="lt jm hi lp b fi lu lv l lw lx">--secure-port</span></pre><p id="a18b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用于保护从kube控制器管理器到API服务器的通信。默认情况下，它使用端口10259，并使用HTTPS身份验证。您还可以设置选项和许多其他选项:</p><pre class="ld le lf lg fd lo lp lq lr aw ls bi"><span id="ddf8" class="lt jm hi lp b fi lu lv l lw lx">--tls-version-min</span></pre><p id="84ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从Kubernetes 1.13开始，安全端口10259可以用于从kube-scheduler到api服务器的安全连接。</p><p id="948f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">情况9:两个节点之间</strong></p><p id="2c46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果希望确保节点到节点的通信也使用证书，可以使用相同的证书签名API。</p><h1 id="cff5" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">结论</h1><p id="5dbd" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">在表格中为您总结所有这些信息:</p><figure class="ld le lf lg fd lh"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="2e04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你发现以上有任何错误，我们很乐意纠正它们，或者如果你有任何反馈，我们很乐意听到更多！</p></div></div>    
</body>
</html>