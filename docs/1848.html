<html>
<head>
<title>GCP — SQL Server AO-AG with Single Subnet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP —带单子网的SQL Server AO-AG</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-sql-server-ao-ag-with-single-subnet-30f9b98816ce?source=collection_archive---------1-----------------------#2021-04-09">https://medium.com/google-cloud/gcp-sql-server-ao-ag-with-single-subnet-30f9b98816ce?source=collection_archive---------1-----------------------#2021-04-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="92d8" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="ce46" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">SQL Server始终在线可用性组(AOAG)允许用户使用SQL Server数据库部署高可用性和自动化故障切换。它通常使用Google Cloud中的多个子网进行部署。</p><p id="d02b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">但是，有时可能希望将其部署在单个子网配置中。这可能是因为网络设计仅计划每个区域有一个子网，添加新子网可能很困难。</p><p id="a5b1" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">注:</strong><a class="ae kg" href="https://cloud.google.com/solutions/deploy-multi-subnet-sql-server" rel="noopener ugc nofollow" target="_blank">多子网部署配置</a>比单子网配置更简单(组件更少)。因此，如果可能的话，最好使用多子网。</p><h1 id="9506" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">了解单一子网的问题</h1><p id="4cdd" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">通常，单个子网内的可用性组需要有浮动ip。在GCP真正的<a class="ae kg" href="https://cloud.google.com/community/tutorials/sql-server-ao-single-subnet" rel="noopener ugc nofollow" target="_blank">浮动IPs是不可用的</a>。因此，以下解决方案是通过使用GCP的内部负载平衡器(ILB)组件来模拟浮动ip的变通办法。</p><h1 id="51b4" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">体系结构</h1><p id="47f5" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">SQL Server节点将是Windows Server故障转移群集(WSFC)组的一部分，并且始终处于启用状态。AG-侦听器的IP与ILB(内部负载平衡器)的IP一致。这意味着，任何发送到ILB的流量都将被路由到AG-Listener。这造成了一种错觉(对于SQL Server ),即侦听器IP在节点之间浮动。实际上，IP(例如下图中的10.128.0.20)只连接到ILB，而不连接到SQL Server节点。在WSFC层创建运行状况检查，ILB能够使用它将流量路由到当前主节点。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/bcf5c01eebc9d85b549d7569e3f4b4d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VQ2VSnhhjl1nnfKGElhwTg.png"/></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">单个子网中的SQL Server可用性组</figcaption></figure><p id="fc7f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这里，资源部署的顺序很重要，AG-Listener应该首先创建，ILB应该在此之后创建。创建AG-Listener时，windows/sql server会自动检查该IP是否已被使用。因此，如果首先创建ILB，AG-Listener创建将会失败。</p><p id="8fd7" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">WSFC上的运行状况检查是通过WSFC群集上的以下powershell配置创建的。健康检查代码示例如下。它使端口59997能够接受任何sql server主节点上的连接。</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="64d8" class="ky ig hi ku b fi kz la l lb lc">$cluster_network_name = 'Cluster Network 1'<br/>$ip_resource_name = 'sql-ag_10.128.0.20'<br/>$load_balancer_ip = '10.128.0.20'<br/>[int]$health_check_port = 59997<br/>Get-ClusterResource $ip_resource_name |<br/>  Set-ClusterParameter -Multiple @{ 'Address'=$load_balancer_ip;<br/>                                    'ProbePort'=$health_check_port;<br/>                                    'SubnetMask'='255.255.240.0';<br/>                                    'Network'=$cluster_network_name;<br/>                                    'EnableDhcp'=0; }</span></pre><p id="498d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">与上图相对应的是ILB层上的健康检查配置需求，以探测59997端口并确定主节点。</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="c6a3" class="ky ig hi ku b fi kz la l lb lc">gcloud compute health-checks create tcp sql-healthcheck \<br/>    --check-interval="2s" \<br/>    --healthy-threshold=1 \<br/>    --unhealthy-threshold=2 \<br/>    --port=59997 \<br/>    --request=10.128.0.20 \<br/>    --timeout="1s"</span></pre><h1 id="0f2d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">详细的实施步骤</h1><p id="ee38" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><a class="ae kg" href="https://cloud.google.com/community/tutorials/sql-server-ao-single-subnet" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/community/tutorials/SQL-server-ao-single-subnet</a><br/>我已经公布了如上详细的分步说明。</p></div></div>    
</body>
</html>