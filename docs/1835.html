<html>
<head>
<title>Secret Manager: protect your secrets from inside threats</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">秘密经理:保护您的秘密免受内部威胁</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/secret-manager-protect-your-secrets-from-inside-threats-e2486f8e9bab?source=collection_archive---------0-----------------------#2021-03-25">https://medium.com/google-cloud/secret-manager-protect-your-secrets-from-inside-threats-e2486f8e9bab?source=collection_archive---------0-----------------------#2021-03-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d403fa5a77f591b1b4fe0cb457aa5704.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qoLmxf90o3OXY16ObhX37g.png"/></div></div></figure><p id="6996" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">秘密是<strong class="is hj">保护</strong>的终极武器:密码、API密钥、私钥、根证书……秘密有几种类型，但<strong class="is hj">都需要保持安全和私密</strong>。在Google Cloud上，Secret Manager服务通过IAM 对秘密进行加密和保护来帮助实现这个<strong class="is hj">。</strong></p><h1 id="d970" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">IAM秘密保护</h1><p id="692b" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">开箱即用，Secret Manager提供了一个细粒度的策略来<strong class="is hj">授予对单个机密的访问权</strong>以执行最小特权原则。像这样，只有<strong class="is hj">需要访问某些秘密的帐户(用户帐户，或服务帐户)才允许</strong>访问它们，但是它们<strong class="is hj">不能访问其他秘密，</strong>即使在同一个项目中。<br/> <em class="kr">对于访问者角色(读取机密)来说是如此，但对于创建新的机密版本来说也是如此。</em></p><p id="4d52" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Seth Vargo已经发布了一个关于这个话题的视频。</p></div><div class="ab cl kv kw gp kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hb hc hd he hf"><p id="daa6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，当<strong class="is hj">几组用户需要管理秘密</strong>时，困难就开始了。假设:</p><ul class=""><li id="c0da" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">DevOps团队管理证书资源、数据库以及与它们相关的机密。</li><li id="399e" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">开发团队使用API密钥来访问第三方服务，并需要保证这个秘密的安全。</li></ul><p id="fdbf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所有的项目都很长，<strong class="is hj">有些秘密不再存在，必须由每个团队在他们的范围内创造。并且<strong class="is hj">因为秘密不再存在</strong>，你<strong class="is hj">不能授予我对它们的角色</strong>并获得之前描述的最小特权。</strong></p><p id="1ca3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此<strong class="is hj">团队在项目级别有一个秘密管理者角色</strong>，因此<strong class="is hj">可以查看和删除项目</strong>中的任何秘密！</p><blockquote class="lq"><p id="92b3" class="lr ls hi bd lt lu lv lw lx ly lz jn dx translated">当两个团队从事同一个项目时，如何实现最小特权原则？</p></blockquote><p id="182f" class="pw-post-body-paragraph iq ir hi is b it ma iv iw ix mb iz ja jb mc jd je jf md jh ji jj me jl jm jn hb bi translated">有解决方案，比如“<em class="kr">创建一个新项目</em>”或者“<em class="kr">让DevOps团队完成所有的秘密创建</em>”。<br/>有，但是还有<strong class="is hj">另一种方式:</strong> <a class="ae ku" href="https://cloud.google.com/iam/docs/conditions-overview" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> IAM条件</strong> </a> <strong class="is hj">。</strong></p><h1 id="78a1" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">秘密管理器的IAM条件</h1><p id="3637" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">IAM服务有一个名为“条件”的特性。显而易见，只有在满足条件时，才能<strong class="is hj">授予角色。</strong></p><p id="d337" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了在我们的用例中应用它，有2个需求</p><ul class=""><li id="33e4" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">用户帐户(或组)<strong class="is hj">没有遗留角色</strong>(查看者、所有者、编辑者)。IAM条件不能应用于传统角色。</li><li id="801e" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">每组用户<strong class="is hj">使用一个命名约定，并为所有秘密</strong>加上相同的前缀值。<em class="kr">例如，</em> <code class="du mf mg mh mi b"><em class="kr">devops-</em></code> <em class="kr">用于devops团队，</em> <code class="du mf mg mh mi b"><em class="kr">dev-</em></code> <em class="kr">用于dev团队。</em></li></ul></div><div class="ab cl kv kw gp kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hb hc hd he hf"><p id="56e3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，使用IAM条件来配置访问。</p><ul class=""><li id="443c" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">devops账户只能访问<code class="du mf mg mh mi b">devops-</code>前缀的秘密</li><li id="33b2" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">开发者账户只能访问前缀为<code class="du mf mg mh mi b">dev-</code>的秘密</li></ul><p id="4d25" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">转到IAM页面，单击“添加”按钮。对于开发团队，你可以拥有它</p><figure class="mk ml mm mn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/15581040448fab64d695de4217382815.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c3XVad5xXYlgz8e5v6Uzhw.png"/></div></div></figure><p id="5450" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击<code class="du mf mg mh mi b">Add condition</code>。选择<code class="du mf mg mh mi b">Resource</code>-&gt;-<code class="du mf mg mh mi b">Name</code>类型的条件</p><figure class="mk ml mm mn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/ec39c6eb1b60531ada787a34a7b77d63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qMFiOg2HPeFIEdv0BAreSg.png"/></div></div></figure><p id="70b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后是操作符<code class="du mf mg mh mi b">Starts with</code>，最后是秘密前缀</p><figure class="mk ml mm mn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/554c4bb1624325956c9ca48bf9f12ba9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KU8LBwom4NZ1Wa1LXSwmmg.png"/></div></div></figure><h2 id="a3ed" class="mq jp hi bd jq mr ms mt ju mu mv mw jy jb mx my kc jf mz na kg jj nb nc kk nd bi translated"><strong class="ak">！！！停下来。！！</strong></h2><p id="5f62" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated"><strong class="is hj">不行</strong>。几个原因</p><ul class=""><li id="9499" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">该值必须是具有此模式的机密的完全限定名</li></ul><pre class="mk ml mm mn fd ne mi nf ng aw nh bi"><span id="6e0e" class="mq jp hi mi b fi ni nj l nk nl">projects/&lt;projectNb&gt;/secrets/dev-</span></pre><p id="6b42" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kr">注意</em> <strong class="is hj"> <em class="kr">项目号是必需的</em> </strong> <em class="kr">，不是项目ID！！</em></p><ul class=""><li id="e95f" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">该规则意味着“<em class="kr">当机密的全名以… </em>开头时，您拥有机密管理员的管理角色”。但是，当<strong class="is hj">你想创建一个秘密</strong>的时候，<strong class="is hj">秘密名称已经不存在了</strong>，你要创建它！<em class="kr">所以你也需要没有秘密存在时的角色</em></li></ul><h2 id="10f8" class="mq jp hi bd jq mr ms mt ju mu mv mw jy jb mx my kc jf mz na kg jj nb nc kk nd bi translated">更正IAM条件表达式</h2><p id="9baa" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">要解决这个问题，你需要表达相反的意思:</p><ul class=""><li id="71b6" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated"><strong class="is hj">开发者账号无权访问</strong> <code class="du mf mg mh mi b"><strong class="is hj">devops-</strong></code>前缀的秘密</li></ul><p id="c2d5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，您需要转到<code class="du mf mg mh mi b">condition Editor</code>选项卡，并输入该条件</p><pre class="mk ml mm mn fd ne mi nf ng aw nh bi"><span id="1e0b" class="mq jp hi mi b fi ni nj l nk nl">!(resource.name.startsWith("projects/&lt;projectNb&gt;/secrets/devops-"))</span></pre><figure class="mk ml mm mn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nm"><img src="../Images/27b3867e18953f90ec013c8b20d9257a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HR33pAYEecXimS9lMmFUAw.png"/></div></div></figure><p id="02cc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">命名条件，保存它并验证IAM角色。</p></div><div class="ab cl kv kw gp kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hb hc hd he hf"><p id="cb02" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您喜欢CLI，您可以这样做</p><pre class="mk ml mm mn fd ne mi nf ng aw nh bi"><span id="2590" class="mq jp hi mi b fi ni nj l nk nl">gcloud projects add-iam-policy-binding &lt;projectId&gt; \<br/>  --condition=expression='!(resource.name.startsWith("projects/&lt;pojectNb&gt;/secrets/devops"))',\<br/>title='no devops secret access' \<br/>  --role=roles/secretmanager.admin \<br/>  --member=group:<a class="ae ku" href="mailto:devops-accounts@gblaquiere.com" rel="noopener ugc nofollow" target="_blank">dev-accounts@gblaquiere.</a>dev</span></pre></div><div class="ab cl kv kw gp kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hb hc hd he hf"><p id="5eac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，<strong class="is hj">开发者账户没有权限访问devops秘密</strong>，条件是devops团队正确命名秘密。<br/>和<strong class="is hj">开发者账号也可以创建新的秘密</strong></p><h1 id="52b9" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">随时保护您的秘密</h1><p id="494d" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">有了秘密管理器，你的<strong class="is hj">秘密是安全的，你可以信任这项服务。</strong></p><p id="d8d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，你需要聪明地配置你在项目中的角色和权限，以防止秘密泄露和安全漏洞，甚至是从内部。</p><p id="f4a5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> IAM condition是实现此用例的一种优雅方式</strong>,<strong class="is hj">可以做得更多！</strong></p></div></div>    
</body>
</html>