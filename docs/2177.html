<html>
<head>
<title>GCP Routing Adventures (Vol. 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP路线历险记(第1卷)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gcp-routing-adventures-vol-1-44a57806f739?source=collection_archive---------0-----------------------#2022-05-04">https://medium.com/google-cloud/gcp-routing-adventures-vol-1-44a57806f739?source=collection_archive---------0-----------------------#2022-05-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3288" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“我完全理解GCP路由是如何工作的！”。这是我每次开始新的网络设计时不断重复的话。虽然不像每次都从零开始，但我总是需要刷新一些基本概念，这些概念是正确掌握主题的关键，然后才能正确设计。</p><p id="a6e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">经过几天漫长的实验(再次！)和其他队友一起，我决定写这篇文章，这样我就可以为自己提供一个快速参考，并希望对更广泛的受众有用。</p><p id="33e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将在本文中尝试解决的关键问题包括:</p><ul class=""><li id="9764" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">VPC路由基础</li><li id="e966" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">动态路由模式:全局与区域</li><li id="3947" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">静态和动态路由的效果</li><li id="4a7f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">路线优先级:基本成本和c <a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview#guidance_for_base_priorities" rel="noopener ugc nofollow" target="_blank">跨区域(区域到区域)罚款</a></li><li id="a95d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">多区域部署路由基础知识</li></ul><h1 id="c49e" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">VPC、云路由器和路由表</h1><p id="a7c9" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">让我们从一些基本概念开始:</p><ul class=""><li id="a2b6" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><a class="ae jr" href="https://cloud.google.com/vpc" rel="noopener ugc nofollow" target="_blank"> GCP虚拟专用云(VPCs) </a>是<em class="kv">全球虚拟网络</em>，横跨所有GCP地区。假设防火墙规则到位，同一VPC网络中的资源可以相互通信。</li><li id="ae20" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">在VPC网络中，我们可以创建区域性<a class="ae jr" href="https://cloud.google.com/vpc/docs/subnets" rel="noopener ugc nofollow" target="_blank">子网。</a>每个子网都有一个关联的CIDR(不包括别名范围)。CIDRs在子网和VPC网络中是唯一的。</li><li id="74ef" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview" rel="noopener ugc nofollow" target="_blank">云路由器(CR) </a>是<em class="kv">区域资源</em>，允许在VPC网络或其他第三方路由器之间交换动态(BGP)路由。</li><li id="f993" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">VPC网络中的路由具有相关联的<em class="kv">路由优先级</em>。路由优先级会受到许多因素的影响，本文将对其中的许多因素进行研究。优先级通常也称为(路线)成本，因此我们将继续使用这两个术语。</li></ul><blockquote class="kw kx ky"><p id="f128" class="if ig kv ih b ii ij ik il im in io ip kz ir is it la iv iw ix lb iz ja jb jc hb bi translated"><strong class="ih hj">第一个重要的误解是假设每个VPC网络都与一个全局路由表相关联</strong>。</p></blockquote><p id="bf00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这通常是由于路由条目在GCP控制台中的图形化表示方式:实际上，是一堆条目放在一个表中。</p><p id="db25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">事实证明这并不完全正确。在深入探讨之前，我们应该在这里暂停一下，了解一下什么是<em class="kv">动态路由模式</em>。</p><h1 id="4da7" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">动态路由模式</h1><p id="acae" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">您可能已经注意到，VPC网络有一个名为<a class="ae jr" href="https://cloud.google.com/vpc/docs/vpc#routing_for_hybrid_networks" rel="noopener ugc nofollow" target="_blank"> <em class="kv">动态路由模式</em> </a>的参数，可以在创建时设置，也可以在创建后设置。</p><p id="120c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此参数规定如何在同一个VPC网络内将动态路由(读取BGP路由，无论它们是否来自第三方网络设备、VPN、互连)从一个区域交换到另一个区域，以及如何在底层网络中对这些路由进行编程。</p><p id="c8ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是可用的选项及其对动态路由的影响。</p><p id="8702" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在VPC网络中，如果动态路由模式被设置为<strong class="ih hj">区域</strong>，云路由器<strong class="ih hj">会让它们学习到的路由只对同一区域内的实例可用</strong></p><p id="50b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一方面，如果动态路由模式被设置为<strong class="ih hj">全局</strong>，同一VPC网络<strong class="ih hj">内的云路由器使它们学习的路由对VPC网络</strong>中的任何实例(即VM)可用，而不管云路由器的区域或实例的区域</p><h1 id="79ed" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">路由和路由表的实用方法</h1><p id="790e" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">那么，<a class="ae jr" href="https://cloud.google.com/vpc/docs/routes" rel="noopener ugc nofollow" target="_blank"> VPC网络的路由表</a>如何能够是全局的，如果在特定条件下，云路由器使路由只对它们相同区域的实例可用？</p><p id="5724" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如前所述，这个假设并不完全正确。<br/>随着时间的推移，我建立了一个心理模型，帮助我合理地解释事情是如何工作的:我喜欢想象<strong class="ih hj"> VPC网络有多个区域路由表。</strong></p><p id="b14a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当静态路由(我们手动添加的路由)创建时，它们在所有区域路由表中的优先级相同。因此，所有实例都将能够利用这些路由，无论它们位于何处。</p><p id="3450" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于动态路线，<em class="kv">取决于</em>:</p><ul class=""><li id="6026" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">如果动态路由模式是区域的，则动态路由仅在云路由器所在的区域路由表中编程(因此它们仅在该区域的实例上有效)</li><li id="5f5e" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">如果动态路由模式设置为全局，则动态路由(理想情况下)存储在每个区域路由表中，以便这些路由可用于VPC中的任何实例。</li></ul><p id="cdb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使全局选项更有趣的是与动态路由相关联的优先级，因为这些路由会被传播。这就是我们在下一段要关注的。</p><h1 id="bbd2" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">动态路线优先和跨区域惩罚</h1><p id="8c16" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">虽然静态路由在所有区域路由表中都具有相同的优先级，但动态路由并非如此。</p><p id="4fd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在这种情况下使用的心理规则是:</p><blockquote class="kw kx ky"><p id="0969" class="if ig kv ih b ii ij ik il im in io ip kz ir is it la iv iw ix lb iz ja jb jc hb bi translated"><strong class="ih hj">每当动态路由从一个区域传播到另一个区域时，增加一个</strong> <a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview#guidance_for_base_priorities" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">跨区域惩罚</strong> </a> <strong class="ih hj">。</strong></p></blockquote><p id="e93e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview#guidance_for_base_priorities" rel="noopener ugc nofollow" target="_blank">跨区域(<em class="kv"> XR </em>)惩罚</a>(也称为<a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview#guidance_for_base_priorities" rel="noopener ugc nofollow" target="_blank">区域间成本</a>)是路径上跨区域发送流量“我们付出”的额外成本。<br/>想想……这不是逻辑吗？跨区域意味着在到达目的地之前，交通要行驶更远的距离。<br/>实例(即虚拟机)和其他路由器必须意识到这一点，并利用优先级(总成本)，考虑延长路径。</p><p id="a2f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请记住，<a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview#guidance_for_base_priorities" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">跨地区罚款</strong> </a> <strong class="ih hj">在每对地区之间是不同的，它是动态的</strong>，这意味着它会随着时间的推移而变化。其值在<a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview#advertised-prefixes-and-priorities" rel="noopener ugc nofollow" target="_blank"> 201和9999(含)之间</a>。</p><p id="a05a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">深入研究这个问题的最简单的方法是跳到一个实际的例子，看看云路由器和VPC网络在路由设置改变时是如何表现的。</p><h1 id="0211" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">第一个示例:区域路由</h1><p id="8e37" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">让我们从简单开始，随着我们的发展，我们会增加更多。</p><p id="62c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在图中，我们看到两个VPC网络(左侧和右侧)，动态路由模式设置为<em class="kv">区域</em>。</p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lc"><img src="../Images/d5aa964361bb5667e8f635808770a8af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3xG8AnnlWbuoOiH2QbsKLA.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">两个VPC网络配置为动态路由模式设置为区域。</figcaption></figure><p id="12f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个VPC网络都有两个子网:上层子网配置在europe-west3 (ew3)中，下层子网配置在europe-west4 (ew4)中。</p><p id="eba6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">VPC网络通过<a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/vpn/concepts/overview#:~:text=HA%20VPN%20is%20a%20high,SLA%20of%2099.99%25%20service%20availability." rel="noopener ugc nofollow" target="_blank"> HA VPN </a>(及相关云路由器)连接，设置在ew3的子网之间。在这个场景中，左边的云路由器将VPC网络<a class="ae jr" href="https://cloud.google.com/vpc/docs/routes#types_of_routes" rel="noopener ugc nofollow" target="_blank">子网路由</a>通告给右边的云路由器(反之亦然)。</p><p id="924b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们观察一下<em class="kv">右侧的VPC网络</em>及其按地区划分的路由表。这些显示在图表的右侧。</p><p id="6c35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">右边的云路由器只接收一条路由:192.168.0.0/24，其下一跳是VPN隧道的另一端。<br/>这是从左到右的广告，基本开销为100(GCP默认的基本优先级)。</p><p id="45b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">值得注意的是，由于动态路由模式是区域性的</p><ol class=""><li id="581a" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ls jj jk jl bi translated">左边的云路由器只向右边的云路由器通告其所在区域的子网</li><li id="0745" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ls jj jk jl bi translated">ew4中右侧的VPC网络路由表为空(该图不包括本地<a class="ae jr" href="https://cloud.google.com/vpc/docs/routes#types_of_routes" rel="noopener ugc nofollow" target="_blank">子网路由</a>，因为ew3中的云路由器没有传播到其他区域的路由</li><li id="deef" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ls jj jk jl bi translated">右VPC网络(ew4)中的实例无法联系左VPC网络(ew3)中的实例，因为右VPC网络的区域路由表中不存在路由(ew4联系左VPC网络— ew3中的实例)</li></ol><p id="20b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们再添加一个片段:让我们指示位于左侧VPC的CR也向右侧VPC的CR通告一个<a class="ae jr" href="https://cloud.google.com/vpc/docs/routes#types_of_routes" rel="noopener ugc nofollow" target="_blank">自定义路由</a>，0.0.0.0/0。</p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lt"><img src="../Images/8acd9dc5769869e1a5a105caa8bdef93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vcq9Pa2VkPzY3tZpC2zp6w.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">左侧VPC网络中的云路由器也向右侧VPC网络中的云路由器通告自定义路由通告0.0.0.0/0。</figcaption></figure><p id="381e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，右边的云路由器也收到了这个新广告，其<a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview#guidance_for_base_priorities" rel="noopener ugc nofollow" target="_blank">基本开销为100 </a>。</p><p id="8f11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们在ew4中添加第二个VPN隧道，看看情况如何变化。</p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lt"><img src="../Images/1a9dcfe370d8cd8cb0602217e9024caf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ijpcTdx3uP9Wzs4g3z-SEw.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">第二个HA VPN隧道建立在欧洲-西方4地区的两个VPC之间。</figcaption></figure><p id="f960" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">新隧道在右VPC网络路由表(在ew4中)中安装了一个新条目，因此它的实例可以与同一区域内左VPC中的实例进行通信。请注意，右侧VPC网络(ew4)中的实例仍然无法到达左侧VPC网络(ew3)中的实例。</p><h1 id="758c" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">第二个示例:全局路由</h1><p id="4587" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">让我们从头开始练习，但这次我们将VPCs动态路由模式设置为全局。</p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lu"><img src="../Images/9be0bbe41ece711a43891bd72e53f181.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1j1jxT_w4cUiGX6LHq-Hlg.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">两个VPC配置为动态路由模式设置为全局。</figcaption></figure><p id="c120" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再次查看右侧VPC网络的路由表，我们可以看到路由传播的不同之处。</p><p id="2151" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设动态路由模式设置为全局，很少会发生以下情况:</p><ul class=""><li id="f01d" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">左VPC网络(ew3)中的云路由器通告来自其所在的VPC所有地区的路由。在这种情况下，ew4。这就是我们在右侧VPC网络(ew3)的路由表中找到第二个条目192.168.128.0/24的原因</li><li id="4fd3" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">当左VPC云路由器通告来自其他区域(ew4)的路由时，它向基本路由开销添加了<a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview#guidance_for_base_priorities" rel="noopener ugc nofollow" target="_blank">跨区域代价</a>。在本例中，<a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview#guidance_for_base_priorities" rel="noopener ugc nofollow" target="_blank">跨区域成本</a>(在撰写本文时，ew3和ew4之间的成本为208)与基本成本相加为308。这是与条目192.168.128.0/24相关联的优先级，存储在右侧VPC网络(ew3)的路由表中</li><li id="958b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">正确的VPC网络路由器不仅在路由器所在的路由表中编程路由，还在ew4的路由表中编程路由</li><li id="1d1b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">在对其他地区(特别是ew4)的路由进行编程时，右侧VPC网络中的云路由器为其路由增加了额外的地区间成本(是的，这是第二次为192.168.128.0/24！).观察VPC右边的路由表— ew4:对于ew3中相同VPC中的相同条目，优先级增加到308</li></ul><p id="2167" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们指示左侧VPC网络中的云路由器发送(除了<a class="ae jr" href="https://cloud.google.com/vpc/docs/routes#types_of_routes" rel="noopener ugc nofollow" target="_blank">子网路由</a>之外)自定义广告<a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/how-to/advertising-overview" rel="noopener ugc nofollow" target="_blank">0 . 0 . 0 . 0/0，会发生什么？</a></p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lv"><img src="../Images/d01e0baa543c0711a0269017d50c9891.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lc03LojtNgEL5rYQlSYByQ.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">左侧VPC网络中的云路由器也向右侧VPC网络中的云路由器通告自定义路由通告0.0.0.0/0。</figcaption></figure><p id="59c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如在上面的区域示例中发生的那样，<a class="ae jr" href="https://cloud.google.com/vpc/docs/routes#types_of_routes" rel="noopener ugc nofollow" target="_blank">自定义路由</a>被通告给正确的路由器。没有惊喜。但是同样，假设动态路由模式被设置为全局，那么<a class="ae jr" href="https://cloud.google.com/vpc/docs/routes#types_of_routes" rel="noopener ugc nofollow" target="_blank">定制路由</a>也被编程在右VPC网络(ew4)中，并具有208的附加<a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview#guidance_for_base_priorities" rel="noopener ugc nofollow" target="_blank">跨区域惩罚</a>。</p><p id="ba7d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，在左侧VPC网络(ew4)中，0.0.0.0/0路由不是<em class="kv">而不是</em>被<em class="kv">编程</em>，因为这不是<a class="ae jr" href="https://cloud.google.com/vpc/docs/routes#types_of_routes" rel="noopener ugc nofollow" target="_blank">子网路由</a>。我们只是指示左边的云路由器将这条额外的路由作为<a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/how-to/advertising-overview" rel="noopener ugc nofollow" target="_blank">自定义广告</a>通告给右边的VPC网络。</p><p id="ad2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们让事情变得更加有趣:让我们在ew4地区的两个VPC网络之间添加第二个VPN。</p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lw"><img src="../Images/84baaf8969095070ac9825f8738de790.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DUOKRyjzK7P3dJcbAiqhRQ.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">第二个HA VPN隧道建立在欧洲-西方4地区的两个VPC网络之间。</figcaption></figure><p id="c50c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再次查看路由表，新的VPN创建了一组新的条目，这些条目可能不容易理解。</p><ul class=""><li id="37ad" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><em class="kv">ew3路由表有新条目192.168.128.0/24，下一跳为tun2 (ew4)，优先级为308。</em> <br/>该路由最初是从左VPC网络(ew4)中的云路由器获知的，没有增加任何额外的跨区域开销，是来自云路由器所在区域的路由。右侧VPC网络(ew4)中的云路由器也在ew3中编程路由，增加了<a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview#guidance_for_base_priorities" rel="noopener ugc nofollow" target="_blank">跨区域惩罚</a>。</li></ul><p id="c2b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对称地…</p><ul class=""><li id="175a" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><em class="kv">ew4路由表有新条目192.168.0.0/24，下一跳为tun1 (ew3)，优先级为308。</em> <br/>该路由最初是从左VPC网络(ew3)云路由器获知的，没有增加任何额外的跨区域开销，是来自云路由器所在区域的路由。右侧VPC网络(ew3)中的云路由器也在ew4中编程路由，增加了<a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview#guidance_for_base_priorities" rel="noopener ugc nofollow" target="_blank">跨区域惩罚</a>。</li></ul><p id="8f19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意</p><ul class=""><li id="2d6c" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><strong class="ih hj">具有相同前缀和相同优先级的路由都保存在路由表中</strong>(阅读下面关于ECMP的更多信息)</li><li id="a82d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><strong class="ih hj">如果相同前缀的多个路由以不同的优先级被学习，只有优先级最低的一个(或多个)仍然可见。一旦优先级最低的路线被撤回，其他路线将再次出现</strong></li></ul><p id="39c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">事实上，以下路线尚未规划:</p><p id="b633" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">欧洲-西方3 <br/> 192.168.0.0/24，下一跳tun2 (ew4)，优先级516</p><p id="7221" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">欧洲-西方4 <br/> 192.168.128.0/24，下一跳tun1 (ew3)，优先级516</p><p id="9a46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是因为对于同一目的地(100) ，区域路由表已经具有具有<em class="kv">较低优先级</em> <em class="kv">的条目。</em></p><h1 id="306f" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">我的路线在哪里？</h1><p id="cb5f" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">好吧，我想复制卢卡刚才给我看的东西！你打开试验台，到GCP控制台，你看不到我之前给你看的所有路线。Ups，惊喜！并非所有这些路线都可以从谷歌云控制台(GUI)上看到。</p><p id="e881" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你看不到的是由目的地VPC网络中的云路由器编程的动态跨区域路由。参考上面的例子，我们在上图中看到的例子，当我们在ew4中添加第二个VPN隧道时。</p><p id="1a74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要查看这些，您需要使用<a class="ae jr" href="https://cloud.google.com/sdk/gcloud/reference/compute/routers/get-status" rel="noopener ugc nofollow" target="_blank"> gcloud CLI </a>:</p><pre class="ld le lf lg fd lx ly lz ma aw mb bi"><span id="c9ce" class="mc jt hi ly b fi md me l mf mg">gcloud compute routers get-status ROUTER_NAME --region=REGION --project PROJECT_ID</span></pre><p id="87d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输出将向您展示</p><ul class=""><li id="5caf" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">云路由器正在通告什么路由(bgpPeerStatus/ <em class="kv">通告路由</em></li><li id="3735" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">云路由器从别人那里学到了什么路由(第<em class="kv">节最佳路由路由器</em></li><li id="e36f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">区域路由表中编程了哪些路由，包括您在GCP控制台中错过的路由(第<em class="kv">节最佳路由</em></li></ul><h1 id="9f0d" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">路径实施</h1><p id="f378" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">在最后一个示例中，我们看到了在给定路由设置的情况下，流量如何通过多条路径到达同一个目的地。</p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lw"><img src="../Images/84baaf8969095070ac9825f8738de790.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DUOKRyjzK7P3dJcbAiqhRQ.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">两个VPC网络，每个网络有两个区域子网。几个HA VPN网关(和云路由器)连接每个地区的VPC网络。右侧显示了右侧VPC网络的区域路由表。</figcaption></figure><p id="39e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，如果右VPC网络(ew4)中的一个实例想要到达左VPC网络(ew3)中的另一个实例，它将采用什么路径？</p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mh"><img src="../Images/4af066983ac7259bc8fad793a343d528.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dFaE4_yWAlQ9zVAbEqmvZg.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">从右侧VPC网络(ew4)到左侧VPC网络(ew3)有两条路径。</figcaption></figure><p id="edc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看一下右边的VPC网络(ew4)路由表，我们可以看到<em class="kv"> 192.168.0.0/24有两个条目:</em></p><ul class=""><li id="34a7" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">下一跳tun1 (ew3) /优先级308</li><li id="7dd9" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">下一跳tun2 (ew4) /优先级308</li></ul><p id="3fd0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这意味着，当两条隧道开通时，<a class="ae jr" href="https://wikipedia.org/wiki/Equal-cost_multi-path_routing" rel="noopener ugc nofollow" target="_blank">等成本多路径(ECMP) </a>将用于向目的地发送流量。如果两条隧道中的一条关闭，所有的交通将通过保持开启的那条。</p><p id="a3d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们想要强制流量通过特定的路径，即使两条隧道都是打开的，该怎么办？我们需要<a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/how-to/updating-priority" rel="noopener ugc nofollow" target="_blank">对基本开销进行操作，以便我们更改最终路由优先级(在“目的地”区域路由表中)</a>。</p><p id="abef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们希望流量始终通过tun1 (ew3 ),即使ew4中的VPN开启。从正确的VPC网络角度来看，这意味着我们总是先跨区域，然后通过tun1 (ew3)穿越VPN。</p><p id="41e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，我们需要在左侧VPC网络(ew4)中通告来自CR的具有较高基本优先级的路由。高多少？</p><figure class="ld le lf lg fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mi"><img src="../Images/62ab6f56c4a717e90ac6097b3f64eb55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VaH8U4XR_hkb12IRjG5j3Q.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">左VPC网络(ew4)云路由器通告基本优先级为101(而不是默认的100)的子网路由。</figcaption></figure><p id="bb6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在基础成本上增加1点就足够了</strong>使具有下一跳tun1 (ew3)的路由优先于经过tun2 (ew4)的路由。</p><p id="c9c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">考虑到</strong> <a class="ae jr" href="https://cloud.google.com/network-connectivity/docs/router/concepts/overview#guidance_for_base_priorities" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">跨区域惩罚</strong> </a> <strong class="ih hj">(从201到9999不等)的动态性质，将delta设置为高于1肯定是更好的方法。</strong>例如，10000将保证您要更改其值的路由将始终被视为优先级低于GCP为相同前缀自动传播的任何其他路由。</p><p id="7ded" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的路线的成本为<br/>基本成本+增量= 100 + 10000 = <strong class="ih hj"> 10100 </strong></p><p id="b594" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GCP生成的路线(具有可能的最大跨区域罚金)的成本为<br/>基本成本+跨区域罚金= 100 + 9999 = <strong class="ih hj"> 10099 </strong></p><h1 id="23cf" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">结论</h1><p id="2ce7" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">正如人们所说，魔鬼总是在细节中。正如您所看到的，高层次上看似简单的东西隐藏了大量的技术细节，为了正确设计复杂的网络基础设施，应该仔细评估这些细节。</p><p id="4c76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望你喜欢这本书，这篇介绍GCP路由的文章对你很有用，对我也一样，每次我开始(再次)质疑我是否真的了解GCP网络时。</p><p id="a633" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一如既往地关注官方文档的最新更新，最重要的是和GCP玩得开心！</p></div></div>    
</body>
</html>