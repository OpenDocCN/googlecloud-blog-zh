<html>
<head>
<title>Simplifying Microservices with Istio in Google Kubernetes Engine — Part I</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Kubernetes引擎中的Istio简化微服务—第一部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/simplifying-microservices-with-istio-in-google-kubernetes-engine-part-i-849555f922b8?source=collection_archive---------0-----------------------#2018-02-05">https://medium.com/google-cloud/simplifying-microservices-with-istio-in-google-kubernetes-engine-part-i-849555f922b8?source=collection_archive---------0-----------------------#2018-02-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex if ig ih ii"><div class="bz dy l di"><div class="ij ik l"/></div></figure><p id="12ed" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">Istio简化了服务对服务的通信、流量上升、容错、性能监控、跟踪等等。我们如何利用它从我们的微服务中抽象出基础设施和横切功能？</p><blockquote class="jj jk jl"><p id="c76b" class="il im jm in b io ip iq ir is it iu iv jn ix iy iz jo jb jc jd jp jf jg jh ji hb bi translated">我写的关于Istio的内容是Istio网站上<a class="ae jq" href="https://istio.io/docs/" rel="noopener ugc nofollow" target="_blank">精彩文档</a>的一个子集。请阅读官方文件以了解更多信息。</p><p id="cad4" class="il im jm in b io ip iq ir is it iu iv jn ix iy iz jo jb jc jd jp jf jg jh ji hb bi translated"><strong class="in hj">注意</strong>:熟悉微服务的可以跳过后台部分。</p></blockquote><p id="b909" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">在本系列的第一部分中，我们将涉及以下领域:</p><ul class=""><li id="95de" class="jr js hi in b io ip is it iw jt ja ju je jv ji jw jx jy jz bi translated"><strong class="in hj">背景</strong>:单片应用和微服务介绍</li><li id="79f4" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated"><strong class="in hj">春云网飞栈</strong>及其优点</li><li id="5ace" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated">介绍<strong class="in hj"> Istio </strong></li><li id="5e2c" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated"><strong class="in hj">使用Istio的服务-服务通信示例</strong></li></ul><h1 id="fd66" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated"><span class="l ld le lf bm lg lh li lj lk di">B</span>T14】背景:</h1><blockquote class="jj jk jl"><p id="6e60" class="il im jm in b io ip iq ir is it iu iv jn ix iy iz jo jb jc jd jp jf jg jh ji hb bi translated">在过去，我们有“无所不能”的大型单一应用程序。这是将我们的产品推向市场的一种方式，最初效果很好，因为我们只需将我们的第一个应用程序上线，我们可以随时回来改进它。部署一个大型应用程序比构建和部署多个较小的应用程序更容易。</p><p id="b968" class="il im jm in b io ip iq ir is it iu iv jn ix iy iz jo jb jc jd jp jf jg jh ji hb bi translated">然而，这样的应用程序开发导致了“大爆炸”式的工作(我们会在几个月的工作后立即部署整个应用程序)，并且由于构建/测试/部署/发布周期的复杂性，增量更改会在很长一段时间内错开。但是，如果您是产品所有者，尤其是在部署了新版本的应用程序之后发现了一个严重的bug，那么这并不是很划算。这甚至会导致应用程序回滚。将如此大的应用程序部署到云中并扩展它们也不容易，因为整个应用程序需要相对较小的组件进行扩展。</p><p id="4415" class="il im jm in b io ip iq ir is it iu iv jn ix iy iz jo jb jc jd jp jf jg jh ji hb bi translated"><strong class="in hj">进入微服务:</strong></p><p id="7931" class="il im jm in b io ip iq ir is it iu iv jn ix iy iz jo jb jc jd jp jf jg jh ji hb bi translated">微服务是在它们自己的流程中运行的独立可部署的服务套件。它们通常使用HTTP资源进行通信，并且每个服务通常负责应用程序中的一个区域。在流行的电子商务目录示例中，可以有一个ItemsService、一个ReviewService和一个RatingsService，每个都专注于一个领域。</p><p id="f563" class="il im jm in b io ip iq ir is it iu iv jn ix iy iz jo jb jc jd jp jf jg jh ji hb bi translated">这种方法帮助分布式团队为各种服务做出贡献，而不必为每个服务变更构建/测试/部署整个应用程序，也不必遍历彼此的代码。将服务部署到云也更容易，因为单个服务可以根据需要自动扩展。</p><p id="1c2c" class="il im jm in b io ip iq ir is it iu iv jn ix iy iz jo jb jc jd jp jf jg jh ji hb bi translated">多语言服务(用不同语言编写的服务)也通过这种方法成为可能，因为我们可以让Java/C++服务做更多的处理密集型工作，而Rails/Node.js服务可以用来支持前端应用程序等等。</p></blockquote><h1 id="a05c" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated"><span class="l ld le lf bm lg lh li lj lk di"> S </span>春云网飞:</h1><p id="ad78" class="pw-post-body-paragraph il im hi in b io ll iq ir is lm iu iv iw ln iy iz ja lo jc jd je lp jg jh ji hb bi translated">随着微服务的流行，出现了大量简化服务创建和管理的框架。2015年我个人最喜欢的是网飞OSS栈(<a class="ae jq" href="https://cloud.spring.io/spring-cloud-netflix/" rel="noopener ugc nofollow" target="_blank"> Spring Cloud网飞</a>)，它向我介绍了一种从我的<a class="ae jq" href="https://spring.io/tools/sts/all" rel="noopener ugc nofollow" target="_blank"> Spring工具套件</a> IDE中用Java 创建微服务<strong class="in hj">的简单方法。</strong></p><p id="acde" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">我可以从网飞套件中获得以下特性(如下图1所示):</p><ul class=""><li id="b836" class="jr js hi in b io ip is it iw jt ja ju je jv ji jw jx jy jz bi translated">使用<strong class="in hj"> Eureka </strong>的服务注册中心—用于服务的注册和发现</li><li id="9dd5" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated">使用<strong class="in hj"> Ribbon </strong>实现客户端负载平衡—客户端可以选择将请求发送到哪个服务器。</li><li id="25c0" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated">声明性REST客户端<strong class="in hj">假装</strong>与其他服务对话。在内部，它使用丝带。</li><li id="d248" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated">带有<strong class="in hj"> Zuul </strong>的API网关—管理所有API调用、路由规则等的单一入口点。我们的微服务</li><li id="acdc" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated">带<strong class="in hj">磁滞回线</strong>的断路器——处理容错，并且能够在短时间内关闭通信通道(断开电路),并在目标服务关闭时返回用户友好的响应</li><li id="a11f" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated">带有Hystrix和<strong class="in hj">涡轮</strong>的仪表盘—可视化交通和断路器</li></ul><figure class="lr ls lt lu fd ii er es paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="er es lq"><img src="../Images/acdaae29e4c8a6795464c63b5838a9c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0CPG9sbX_Eer9DWyNbOEKw.jpeg"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">图1:微服务的Spring Cloud网飞实现</figcaption></figure><p id="6609" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">然而，这种构建和部署应用程序的方法也有其自身的挑战。</p><h1 id="c650" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">挑战:</h1><blockquote class="jj jk jl"><p id="5d0b" class="il im jm in b io ip iq ir is it iu iv jn ix iy iz jo jb jc jd jp jf jg jh ji hb bi translated"><strong class="in hj"> <em class="hi">部署</em> </strong> <em class="hi">:我们如何以一致的方式将我们的服务部署到云中，确保它们始终可用，并根据我们的需求自动扩展？</em></p><p id="b5a3" class="il im jm in b io ip iq ir is it iu iv jn ix iy iz jo jb jc jd jp jf jg jh ji hb bi translated"><strong class="in hj"> <em class="hi">横切关注点</em> </strong> <em class="hi">:我们如何在对每个微服务</em>  <em class="hi">进行很少甚至没有代码更改的情况下，获得我们在上述</em>的Spring Cloud网飞实现中看到的所有特性，再加上更多的<em class="hi"> </em> <strong class="in hj"> <em class="hi">？</em> <strong class="in hj"> <em class="hi">还有，</em> </strong> <em class="hi"> </em> <strong class="in hj"> <em class="hi">我们如何处理用不同语言编写的服务？</em>T49】</strong></strong></p></blockquote><h1 id="9793" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">解决方案:</h1><blockquote class="jj jk jl"><p id="423c" class="il im jm in b io ip iq ir is it iu iv jn ix iy iz jo jb jc jd jp jf jg jh ji hb bi translated"><strong class="in hj"> <em class="hi">部署</em></strong><em class="hi">:</em><a class="ae jq" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"><em class="hi">Kubernetes</em></a><em class="hi">为在Google Kubernetes引擎(GKE)中高效部署和编排Docker容器铺平了道路。Kubernetes抽象了基础设施，并允许我们通过API与之交互。请查看本文末尾的链接了解更多细节。</em></p><p id="4b0f" class="il im jm in b io ip iq ir is it iu iv jn ix iy iz jo jb jc jd jp jf jg jh ji hb bi translated"><strong class="in hj"> <em class="hi">横切关注点:</em> </strong> <em class="hi">我们可以用</em><a class="ae jq" href="https://istio.io/docs/concepts/what-is-istio/overview.html" rel="noopener ugc nofollow" target="_blank"><strong class="in hj"><em class="hi">Istio</em></strong></a><em class="hi">。Istio网站上的官方解释说</em>“<strong class="in hj">Istio提供了一种简单的方法来创建一个部署了负载平衡、服务到服务认证、监控等服务的网络，而不需要对服务代码进行任何更改。您可以通过在整个环境中部署一个特殊的sidecar代理来为服务添加Istio支持，该代理可以拦截微服务之间的所有网络通信，并使用Istio的控制平面功能进行配置和管理</strong>。”</p></blockquote><h1 id="1b58" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">介绍组织:</h1><p id="f4be" class="pw-post-body-paragraph il im hi in b io ll iq ir is lm iu iv iw ln iy iz ja lo jc jd je lp jg jh ji hb bi translated">换句话说，通过Istio，我们可以创建我们的微服务，并将其与"<strong class="in hj">轻量级边车代理</strong>"(如下图2)一起部署，后者将处理我们的许多跨领域需求，例如:</p><ul class=""><li id="5714" class="jr js hi in b io ip is it iw jt ja ju je jv ji jw jx jy jz bi translated">服务-服务通信</li><li id="ea47" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated">描摹</li><li id="4657" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated">断路(类似Hystrix的功能)和重试</li><li id="753b" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated">性能监控和仪表板(类似于Hystrix和涡轮仪表板)</li><li id="3c49" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated">流量路由(例如:向我们应用的v2发送x%的流量)，金丝雀部署</li><li id="3d7f" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated">一个额外的好处是(特别是如果您正在处理<strong class="in hj">敏感数据</strong>，如医疗保健中的PHI)—egress(对Istio服务网格之外的外部服务进行的调用)需要明确配置，并且可以防止服务在服务网格之外进行特别调用。</li></ul><figure class="lr ls lt lu fd ii er es paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="er es mf"><img src="../Images/6e00a3d6303eb8ffb32ac7fb784baebb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ywx4FCF4923ZAZjX8a_kOQ.jpeg"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">图2:使用Envoy代理在多语言服务之间通信</figcaption></figure><p id="89b2" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">在上面的图2中，我们删除了图1中出现的许多组件，并添加了一个新组件(<a class="ae jq" href="https://www.envoyproxy.io/" rel="noopener ugc nofollow" target="_blank"> Envoy Proxy </a>)。需要与另一个服务(B)对话的每个服务(A)与其代理通信，该代理预先配置了路由到其他目的地代理的规则。代理与代理对话。因为所有的通信都是通过代理进行的，所以很容易监控流量、收集指标、应用断路器规则等。根据需要。</p><blockquote class="jj jk jl"><p id="9846" class="il im jm in b io ip iq ir is it iu iv jn ix iy iz jo jb jc jd jp jf jg jh ji hb bi translated">声明性地为横切特性配置规则和策略，而不必对我们的服务进行代码更改，这使我们能够专注于最重要的事情:构建交付业务价值的高质量服务。</p></blockquote><p id="97dd" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">总体而言，Istio具有以下组件:</p><ul class=""><li id="920d" class="jr js hi in b io ip is it iw jt ja ju je jv ji jw jx jy jz bi translated"><strong class="in hj"> Envoy </strong>:高性能、低占用空间的代理，支持服务之间的通信，并有助于负载平衡、服务发现等。</li><li id="b155" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated"><strong class="in hj"> Mixer </strong>:负责生态系统(服务网格)中所有服务的访问控制策略，并收集Envoy和其他服务发送的遥测信息</li><li id="2ba3" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated"><strong class="in hj"> Pilot </strong>:帮助服务发现、流量斜坡和容错(断路、重试等)。)</li><li id="a382" class="jr js hi in b io ka is kb iw kc ja kd je ke ji jw jx jy jz bi translated"><strong class="in hj"> Istio-Auth </strong>:用于服务-服务认证以及使用相互TLS的最终用户认证。本文中的示例没有使用Istio-Auth</li></ul><h1 id="dd7d" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">服务-与Istio的服务通信:</h1><h2 id="93c8" class="mg kg hi bd kh mh mi mj kl mk ml mm kp iw mn mo kt ja mp mq kx je mr ms lb mt bi translated">实践中来看看吧！</h2><p id="16c9" class="pw-post-body-paragraph il im hi in b io ll iq ir is lm iu iv iw ln iy iz ja lo jc jd je lp jg jh ji hb bi translated">我们举一个简单的例子，展示3个微服务通过Envoy代理进行通信。它们是在<strong class="in hj"> Node.js </strong>中创建的，但是，如前所述，它们可以是任何语言的。<a class="ae jq" href="https://github.com/nmallya/istiodemo" rel="noopener ugc nofollow" target="_blank"> <strong class="in hj"> Github </strong> </a></p><figure class="lr ls lt lu fd ii er es paragraph-image"><div class="er es mu"><img src="../Images/68c706b95e5d8cff7c9d60540fff40a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*jcZYzlqHvueD5lA-1BLcCA.jpeg"/></div><figcaption class="mb mc et er es md me bd b be z dx translated">图3:用于获取宠物详细信息的3个微服务的逻辑视图</figcaption></figure><ol class=""><li id="85b8" class="jr js hi in b io ip is it iw jt ja ju je jv ji mv jx jy jz bi translated"><strong class="in hj"> PetService </strong>:通过调用PetDetailsService和PetMedicalHistoryService返回宠物的信息和病史。它将在端口9080上运行。</li><li id="3666" class="jr js hi in b io ka is kb iw kc ja kd je ke ji mv jx jy jz bi translated"><strong class="in hj"> PetDetailsService </strong>:返回宠物信息，如名字、年龄、品种、主人等。它将在端口9081上运行。</li><li id="f2ff" class="jr js hi in b io ka is kb iw kc ja kd je ke ji mv jx jy jz bi translated"><strong class="in hj">PetMedicalHistoryService</strong>:返回宠物的病史(接种疫苗)。它将在端口9082上运行。</li></ol><h2 id="1f2c" class="mg kg hi bd kh mh mi mj kl mk ml mm kp iw mn mo kt ja mp mq kx je mr ms lb mt bi translated">步骤:</h2><p id="c475" class="pw-post-body-paragraph il im hi in b io ll iq ir is lm iu iv iw ln iy iz ja lo jc jd je lp jg jh ji hb bi translated">在GKE创建一个Kubernetes集群。确保默认服务帐户具有以下权限:</p><p id="59e5" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated"><code class="du mw mx my mz b">roles/container.admin</code> (Kubernetes引擎管理)</p><p id="7a52" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">按照<a class="ae jq" href="https://istio.io/docs/setup/kubernetes/quick-start.html" rel="noopener ugc nofollow" target="_blank">https://istio.io/docs/setup/kubernetes/quick-start.html</a>中的描述安装istio</p><ol class=""><li id="3a70" class="jr js hi in b io ip is it iw jt ja ju je jv ji mv jx jy jz bi translated">现在，我们准备将我们的应用程序(上面的3个服务)部署到GKE，并将sidecar代理注入到部署中</li><li id="ce20" class="jr js hi in b io ka is kb iw kc ja kd je ke ji mv jx jy jz bi translated">在<a class="ae jq" href="https://github.com/nmallya/istiodemo" rel="noopener ugc nofollow" target="_blank"> <strong class="in hj"> github repo </strong> </a>中，你会看到4个文件夹(我安装各种组件时创建的istio文件夹和我的微服务的3个文件夹)</li></ol><figure class="lr ls lt lu fd ii er es paragraph-image"><div class="er es na"><img src="../Images/4620349dc78b10d28e9480c38aa8c3ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*MAf0A-CzGAijfUD5qbldQA.png"/></div></figure><p id="4b17" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">5.对于每个微服务，我在petinfo.yaml文件的<strong class="in hj"> kube </strong>文件夹中创建了相应的Kubernetes <em class="jm">部署</em>和<em class="jm">服务</em>。<em class="jm">服务</em>被称为<strong class="in hj"> petservice、petdetailsservice和petmedicalhistoryservice </strong>。因为PetService是可公开访问的，所以它有一个指向<strong class="in hj"> petservice </strong> <em class="jm">服务</em>的Kubernetes <em class="jm">入口</em>。</p><p id="e63f" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">6.您可以转到每个服务文件夹，在<strong class="in hj"> deploy.sh文件</strong>中更新您的项目和集群名称并运行它。它构建服务，创建Docker映像，将其上传到Google容器注册中心，然后运行<strong class="in hj"> istioctl </strong>来注入特使代理。例如，对于PetService，它看起来像:</p><pre class="lr ls lt lu fd nb mz nc nd aw ne bi"><span id="d15f" class="mg kg hi mz b fi nf ng l nh ni">#!/usr/bin/env bash</span><span id="18b7" class="mg kg hi mz b fi nj ng l nh ni">export PROJECT=nithinistioproject <br/>export CONTAINER_VERSION=feb4v2<br/>export IMAGE=gcr.io/$PROJECT/petservice:$CONTAINER_VERSION<br/>export BUILD_HOME=.</span><span id="21a9" class="mg kg hi mz b fi nj ng l nh ni">gcloud config set project $PROJECT<br/>gcloud container clusters get-credentials nithinistiocluster --zone us-central1-a --project $PROJECT</span><span id="3c24" class="mg kg hi mz b fi nj ng l nh ni">echo $IMAGE<br/>docker build -t petservice -f "${PWD}/Dockerfile" $BUILD_HOME<br/>echo 'Successfully built ' $IMAGE</span><span id="ec8a" class="mg kg hi mz b fi nj ng l nh ni">docker tag petservice $IMAGE<br/>echo 'Successfully tagged ' $IMAGE</span><span id="004e" class="mg kg hi mz b fi nj ng l nh ni">#push to google container registry<br/>gcloud docker -- push $IMAGE<br/>echo 'Successfully pushed to Google Container Registry ' $IMAGE</span><span id="2dc9" class="mg kg hi mz b fi nj ng l nh ni"># inject envoy proxy<br/><strong class="mz hj">kubectl apply -f &lt;(istioctl kube-inject -f "${PWD}/kube/petinfo.yaml")</strong></span></pre><p id="efff" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">在上面的代码中，突出显示的行显示了我们如何使用Istio命令行工具(<strong class="in hj"> istioctl </strong>)将代理注入到我们的各种Kubernetes部署中。</p><p id="b678" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">petservice文件夹下的<strong class="in hj"> petinfo.yaml文件</strong>包含一个<em class="jm">服务</em>、一个<em class="jm">部署</em>和一个<em class="jm">入口</em>的配置。看起来像是:</p><pre class="lr ls lt lu fd nb mz nc nd aw ne bi"><span id="66ed" class="mg kg hi mz b fi nf ng l nh ni">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: petservice<br/>  labels:<br/>    app: petservice<br/>spec:<br/>  ports:<br/>  - port: 9080<br/>    name: http<br/>  selector:<br/>    app: petservice<br/>---<br/>apiVersion: extensions/v1beta1<br/>kind: Deployment<br/>metadata:<br/>  name: petservice-v1<br/>spec:<br/>  replicas: 1<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: petservice<br/>        version: v1<br/>    spec:<br/>      containers:<br/>      - name: petservice<br/>        image: gcr.io/nithinistioproject/petservice:feb4v2<br/>        imagePullPolicy: IfNotPresent<br/>        ports:<br/>        - containerPort: 9080<br/>---</span><span id="6fcd" class="mg kg hi mz b fi nj ng l nh ni">###########################################################################<br/># Ingress resource (gateway)<br/>##########################################################################<br/>apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: gateway<br/>  annotations:<br/>    kubernetes.io/ingress.class: "istio"<br/>spec:<br/>  rules:<br/>  - http:<br/>      paths:<br/>      - path: /pet/.*<br/>        backend:<br/>          serviceName: petservice<br/>          servicePort: 9080<br/>---</span></pre><p id="8ec4" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">为3个服务中的每一个运行deploy.sh <em class="jm">后，您可以通过执行以下命令来检查部署、服务和入口是否已经创建:</em></p><pre class="lr ls lt lu fd nb mz nc nd aw ne bi"><span id="f01f" class="mg kg hi mz b fi nf ng l nh ni">mallyn01$ <strong class="mz hj">kubectl get deployment</strong></span><span id="c07f" class="mg kg hi mz b fi nj ng l nh ni">NAME                          DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><span id="a974" class="mg kg hi mz b fi nj ng l nh ni">petdetailsservice-v1          1         1         1            1           1h</span><span id="94b7" class="mg kg hi mz b fi nj ng l nh ni">petmedicalhistoryservice-v1   1         1         1            1           58m</span><span id="8774" class="mg kg hi mz b fi nj ng l nh ni">petservice-v1                 1         1         1            1           54m</span><span id="f26e" class="mg kg hi mz b fi nj ng l nh ni">mallyn01$ <strong class="mz hj">kubectl get service</strong></span><span id="2219" class="mg kg hi mz b fi nj ng l nh ni">NAME                       TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span><span id="b9df" class="mg kg hi mz b fi nj ng l nh ni">kubernetes                 ClusterIP   10.51.240.1    &lt;none&gt;        443/TCP    2d</span><span id="1435" class="mg kg hi mz b fi nj ng l nh ni">petdetailsservice          ClusterIP   10.51.255.10   &lt;none&gt;        9081/TCP   1h</span><span id="7168" class="mg kg hi mz b fi nj ng l nh ni">petmedicalhistoryservice   ClusterIP   10.51.244.19   &lt;none&gt;        9082/TCP   59m</span><span id="e865" class="mg kg hi mz b fi nj ng l nh ni">petservice                 ClusterIP   10.51.242.18   &lt;none&gt;        9080/TCP   1h</span><span id="1151" class="mg kg hi mz b fi nj ng l nh ni"><br/>petservice mallyn01$ <strong class="mz hj">kubectl get ing</strong></span><span id="9d48" class="mg kg hi mz b fi nj ng l nh ni">NAME      HOSTS     ADDRESS        PORTS     AGE</span><span id="ffa3" class="mg kg hi mz b fi nj ng l nh ni">gateway   *         <strong class="mz hj">108.59.82.93</strong>   80        1h</span><span id="f950" class="mg kg hi mz b fi nj ng l nh ni">mallyn01$ <strong class="mz hj">kubectl get pods</strong></span><span id="5949" class="mg kg hi mz b fi nj ng l nh ni">NAME                                           READY     STATUS    RESTARTS   AGE</span><span id="2f60" class="mg kg hi mz b fi nj ng l nh ni">petdetailsservice-v1-5bb8c65577-jmn6r          <strong class="mz hj">2/2</strong>       Running   0          12h</span><span id="b141" class="mg kg hi mz b fi nj ng l nh ni">petmedicalhistoryservice-v1-5757f98898-tq5j8   <strong class="mz hj">2/2</strong>       Running   0          12h</span><span id="ff71" class="mg kg hi mz b fi nj ng l nh ni">petservice-v1-587696b469-qttqk                 <strong class="mz hj">2/2</strong>       Running   0          12h</span></pre><p id="f9cd" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">当您在上面的控制台输出中查看<strong class="in hj"> pods </strong>时，您会注意到<strong class="in hj"> 2/2 </strong>容器正在运行，即使您只为每个容器部署了1个服务。另一个容器是由istioctl命令注入的sidecar代理。</p><p id="23bb" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">7.一旦以上所有程序运行，您就可以使用入口的IP地址并调用一个示例端点来获取宠物的详细信息。</p><pre class="lr ls lt lu fd nb mz nc nd aw ne bi"><span id="172b" class="mg kg hi mz b fi nf ng l nh ni">mallyn01$ <strong class="mz hj">curl </strong><a class="ae jq" href="http://108.59.82.93/pet/123" rel="noopener ugc nofollow" target="_blank"><strong class="mz hj">http://108.59.82.93/pet/123</strong></a></span><span id="61d0" class="mg kg hi mz b fi nj ng l nh ni">{<br/>  "petDetails": {<br/>    "petName": "Maximus",<br/>    "petAge": 5,<br/>    "petOwner": "Nithin Mallya",<br/>    "petBreed": "Dog"<br/>  },<br/>  "petMedicalHistory": {<br/>    "vaccinationList": [<br/>      "Bordetella, Leptospirosis, Rabies, Lyme Disease"<br/>    ]<br/>  }<br/>}</span></pre><p id="26ae" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated"><strong class="in hj">注意</strong>:由于PetService调用了PetDetailsService和PetMedicalHistoryService，实际的调用看起来像这样:</p><pre class="lr ls lt lu fd nb mz nc nd aw ne bi"><span id="b4e3" class="mg kg hi mz b fi nf ng l nh ni">fetch('<a class="ae jq" href="http://petdetailsservice:9081/pet/123/details'" rel="noopener ugc nofollow" target="_blank">http://<strong class="mz hj">petdetailsservice:9081</strong>/pet/123/details'</a>)<br/>          .then(res =&gt; res.text())<br/>          .then(body =&gt; console.log(body));<br/>        ;</span><span id="a106" class="mg kg hi mz b fi nj ng l nh ni">fetch('<a class="ae jq" href="http://petmedicalhistoryservice:9082/pet/123/medicalhistory'" rel="noopener ugc nofollow" target="_blank">http://<strong class="mz hj">petmedicalhistoryservice:9082</strong>/pet/123/medicalhistory'</a>)<br/>          .then(res =&gt; res.text())<br/>          .then(body =&gt; console.log(body));<br/>        ;</span></pre><p id="da82" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated"><strong class="in hj">结论</strong>:我们讨论了很多材料(这只是第一部分！！)</p><p id="eb34" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">在随后的部分中，我将详细介绍如何使用其他Istio功能，例如将流量转移到新版本的应用程序，使用性能监控仪表板等。</p><p id="1500" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated">特别感谢<a class="nk nl ge" href="https://medium.com/u/a535baed6389?source=post_page-----849555f922b8--------------------------------" rel="noopener" target="_blank"> Ray Tsang </a>在Istio上的<a class="ae jq" href="https://www.youtube.com/watch?v=AGztKw580yQ&amp;t=231s" rel="noopener ugc nofollow" target="_blank">演讲</a></p><p id="d433" class="pw-post-body-paragraph il im hi in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji hb bi translated"><strong class="in hj">资源</strong></p><ol class=""><li id="819f" class="jr js hi in b io ip is it iw jt ja ju je jv ji mv jx jy jz bi translated">Istio主页<a class="ae jq" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank">https://istio.io/</a></li><li id="9490" class="jr js hi in b io ka is kb iw kc ja kd je ke ji mv jx jy jz bi translated">DevOxx Istio演示由<a class="nk nl ge" href="https://medium.com/u/a535baed6389?source=post_page-----849555f922b8--------------------------------" rel="noopener" target="_blank">Ray Tsang</a>:【https://www.youtube.com/watch?v=AGztKw580yQ】T2&amp;t = 231</li><li id="8a94" class="jr js hi in b io ka is kb iw kc ja kd je ke ji mv jx jy jz bi translated">Github链接到这个例子:【https://github.com/nmallya/istiodemo T4】</li><li id="1fb1" class="jr js hi in b io ka is kb iw kc ja kd je ke ji mv jx jy jz bi translated">所有的事情Kubernetes:<a class="ae jq" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/</a></li><li id="59eb" class="jr js hi in b io ka is kb iw kc ja kd je ke ji mv jx jy jz bi translated">微服务:<a class="ae jq" href="https://martinfowler.com/articles/microservices.html" rel="noopener ugc nofollow" target="_blank">https://martinfowler.com/articles/microservices.html</a></li><li id="0dd4" class="jr js hi in b io ka is kb iw kc ja kd je ke ji mv jx jy jz bi translated">春云https://github.com/spring-cloud/spring-cloud-netflix<a class="ae jq" href="https://github.com/spring-cloud/spring-cloud-netflix" rel="noopener ugc nofollow" target="_blank">网飞</a></li></ol></div></div>    
</body>
</html>