<html>
<head>
<title>Cluster Federation and Global Load Balancing on Kubernetes and Google Cloud — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes和Google Cloud上的集群联合和全局负载平衡—第2部分</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/planet-scale-microservices-with-cluster-federation-and-global-load-balancing-on-kubernetes-and-cd182f981653?source=collection_archive---------0-----------------------#2017-03-27">https://medium.com/google-cloud/planet-scale-microservices-with-cluster-federation-and-global-load-balancing-on-kubernetes-and-cd182f981653?source=collection_archive---------0-----------------------#2017-03-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="0316" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">警告:在这篇文章中描述的Kubernetes联盟将不再被支持。正在开发新的工具来取代它，当这些工具准备好的时候，我会写一篇新的博文。下面的理论上应该还是行得通的，但是我不再推荐了。</h2></div><p id="b5e6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我最近在Google Cloud Next做了一个关于使用Kubernetes在世界各地部署和管理微服务的演讲。</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="jy jz l"/></div><figcaption class="ka kb et er es kc kd bd b be z dx translated"><a class="ae ke" href="https://www.youtube.com/watch?v=kmPBm-TQBSE" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=kmPBm-TQBSE</a></figcaption></figure><p id="e29d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我已经在博客中讲述了如何<a class="ae ke" href="http://blog.kubernetes.io/2017/01/running-mongodb-on-kubernetes-with-statefulsets.html" rel="noopener ugc nofollow" target="_blank">在StatefulSet </a>中设置MongoDB，所以现在我将深入探讨如何设置集群联盟并在全球部署您的服务！</p></div><div class="ab cl kf kg gp kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hb hc hd he hf"><p id="b5b9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将特别关注三个方面，集群联合、联合入口和跨集群服务发现。我将把这些话题分成三篇博文，期待下一篇吧！</p><p id="6cb8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我假设你知道在谷歌云中创建项目的基本知识，并且已经安装并设置了<a class="ae ke" href="https://cloud.google.com/sdk/" rel="noopener ugc nofollow" target="_blank">谷歌云SDK </a>。如果没有，请查看我以前的博客帖子。</p><h2 id="d233" class="km kn hi bd ko kp kq kr ks kt ku kv kw jg kx ky kz jk la lb lc jo ld le lf lg bi translated"><a class="ae ke" rel="noopener" href="/google-cloud/planet-scale-microservices-with-cluster-federation-and-global-load-balancing-on-kubernetes-and-a8e7ef5efa5e#.xgjneibyz">第1部分:集群联盟</a></h2><p id="8dbc" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated"><a class="ae ke" href="https://cloud.google.com/container-engine/docs/cluster-federation" rel="noopener ugc nofollow" target="_blank">集群联合</a>可以用来管理多个Kubernetes集群，就像它们是一个集群一样。这意味着您可以在多个数据中心(和多个云)中创建集群，并使用联合来一次性控制它们！</p><h2 id="821f" class="km kn hi bd ko kp kq kr ks kt ku kv kw jg kx ky kz jk la lb lc jo ld le lf lg bi translated">第2部分:联合入口</h2><p id="fd22" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated"><a class="ae ke" href="https://kubernetes.io/docs/tasks/administer-federation/ingress/" rel="noopener ugc nofollow" target="_blank">联邦入口</a>超级甜，目前只支持Google Cloud。这允许您使用单个全局IP地址启动单个负载平衡器，它将自动向最近的集群动态发送流量！</p><h2 id="e59d" class="km kn hi bd ko kp kq kr ks kt ku kv kw jg kx ky kz jk la lb lc jo ld le lf lg bi translated">第3部分:跨集群通信</h2><p id="6c7b" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated"><a class="ae ke" href="http://kubernetes.io/docs/user-guide/federation/federated-services/" rel="noopener ugc nofollow" target="_blank">跨集群服务发现</a>是一个概念，让一个Kubernetes集群中的服务自动发现其他集群中的服务。我们还将看看<a class="ae ke" href="https://cloud.google.com/pubsub/" rel="noopener ugc nofollow" target="_blank"> Google Cloud Pub/Sub </a>启用异步微服务！</p></div><div class="ab cl kf kg gp kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hb hc hd he hf"><h1 id="1615" class="lm kn hi bd ko ln lo lp ks lq lr ls kw io lt ip kz ir lu is lc iu lv iv lf lw bi translated">第2部分:联合入口</h1><p id="bca3" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">现在您有了一个联合集群，您能用它做什么呢？您可以做的一件很酷的事情是联合入口。让我们更深入地了解它是如何工作的。</p><p id="6210" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">谷歌云平台上最强大的组件之一就是网络。这是人们在看云的时候经常忘记的事情。谷歌已经建立了世界上最大的私有网络之一，这让我们可以做一些令人惊奇的事情。</p><p id="e00e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当你在谷歌云上启动一个<a class="ae ke" href="https://cloud.google.com/compute/docs/load-balancing/http/" rel="noopener ugc nofollow" target="_blank"> HTTP(S)负载平衡器</a>时，你会得到一个单一的IP地址。这个IP地址是来自全球超过100个存在点的<a class="ae ke" href="https://en.wikipedia.org/wiki/Anycast" rel="noopener ugc nofollow" target="_blank"> anycast </a>，用户自动连接到最近的一个。然后，它们的流量通过Google的私有主干网络发送到最近的托管您的应用程序的数据中心！</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es lx"><img src="../Images/89c1bb3e2702ca371320eccdd05f4e48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dVn1cwXt-kcSEAXk."/></div></div><figcaption class="ka kb et er es kc kd bd b be z dx translated">这么多台词！</figcaption></figure><p id="898b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这都是自动的。没有DNS欺骗，预热，或任何复杂的参与。只有一个IP地址。最棒的是，Federated Ingress允许Kubernetes利用这一点，而无需执行任何手动设置！</p><p id="9cb0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> <em class="me">注意:如果你还没有完成</em></strong><a class="ae ke" rel="noopener" href="/google-cloud/planet-scale-microservices-with-cluster-federation-and-global-load-balancing-on-kubernetes-and-a8e7ef5efa5e"><strong class="iz hj"><em class="me">Part 1</em></strong></a><strong class="iz hj"><em class="me">，请先完成。否则，确保你知道你在做什么！</em> </strong></p><h1 id="1286" class="lm kn hi bd ko ln mf lp ks lq mg ls kw io mh ip kz ir mi is lc iu mj iv lf lw bi translated">步骤1:创建全局IP地址</h1><p id="66e4" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">第一步是为我们的入口创建一个全局静态IP地址。</p><pre class="jt ju jv jw fd mk ml mm mn aw mo bi"><span id="72ec" class="km kn hi ml b fi mp mq l mr ms">gcloud compute addresses create k-ingress --global</span></pre><p id="e507" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将创建一个新的全局IP地址，称为“k-ingress”</p><h1 id="08c5" class="lm kn hi bd ko ln mf lp ks lq mg ls kw io mh ip kz ir mi is lc iu mj iv lf lw bi translated">步骤2:创建联合部署和服务</h1><p id="7b35" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">在创建入口之前，您需要创建一个部署和服务来支持它。</p><p id="1ae6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们创建一个简单的Nginx部署，并将其扩展到4个副本:</p><pre class="jt ju jv jw fd mk ml mm mn aw mo bi"><span id="7a84" class="km kn hi ml b fi mp mq l mr ms">kubectl --context=kfed create deployment nginx --image=nginx &amp;&amp; \<br/>  kubectl --context=kfed scale deployment nginx --replicas=4</span></pre><p id="dd12" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个命令将在联邦上下文中创建一个包含4个nginx副本的部署。因为我们有两个集群，每个集群将获得2个副本！联合控制平面会自动在集群中平均分配pod。</p><p id="e364" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在创建一个服务来公开这个部署:</p><pre class="jt ju jv jw fd mk ml mm mn aw mo bi"><span id="101c" class="km kn hi ml b fi mp mq l mr ms">kubectl --context=kfed create service nodeport nginx \<br/>  --tcp=80:80 --node-port=30036</span></pre><p id="fef1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在YAML表单中，服务定义如下所示:</p><pre class="jt ju jv jw fd mk ml mm mn aw mo bi"><span id="c957" class="km kn hi ml b fi mp mq l mr ms">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nginx<br/>spec:<br/>  ports:<br/>    - port: 80<br/>      targetPort: 80<br/>      protocol: TCP<br/>      nodePort: 30036<br/>  selector:<br/>    app: nginx<br/>  type: NodePort</span></pre><p id="29c3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将创建一个服务，通过节点端口公开我们的nginx部署。</p><p id="61da" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可能习惯于使用负载平衡器来公开服务，但这将在每个数据中心创建一个具有自己的IP地址的负载平衡器，这是我们不希望的。</p><p id="c749" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">相反，节点端口直接在集群中的所有虚拟机上公开服务(在本例中是在端口30036上，但是您可以选择任何有效的端口)。然后，入口负载平衡器会将流量路由到虚拟机上的该端口。</p><h1 id="c6d2" class="lm kn hi bd ko ln mf lp ks lq mg ls kw io mh ip kz ir mi is lc iu mj iv lf lw bi translated">步骤3:创建入口</h1><p id="12b2" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">最后一步是创建入口负载平衡器！</p></div><div class="ab cl kf kg gp kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hb hc hd he hf"><p id="7cb1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">可选:</strong>我建议创建一个防火墙规则，允许您将流量从负载平衡器发送到虚拟机。虽然这不是绝对必要的，因为Kubernetes将创建自己的规则，它可以帮助防止防火墙规则的问题。运行以下命令创建规则:</p><pre class="jt ju jv jw fd mk ml mm mn aw mo bi"><span id="44c9" class="km kn hi ml b fi mp mq l mr ms">gcloud compute firewall-rules create \<br/>  federated-ingress-firewall-rule \<br/>  --source-ranges 130.211.0.0/22 \<br/>  --allow tcp:30036 --network default</span></pre></div><div class="ab cl kf kg gp kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hb hc hd he hf"><p id="0233" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将以下内容保存到一个名为<strong class="iz hj"> ingress.yaml </strong>的文件中</p><pre class="jt ju jv jw fd mk ml mm mn aw mo bi"><span id="6a8a" class="km kn hi ml b fi mp mq l mr ms">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: nginx<br/>  annotations:<br/>    kubernetes.io/ingress.global-static-ip-name: “k-ingress”<br/>spec:<br/>  backend:<br/>    serviceName: nginx<br/>    servicePort: 80</span></pre><p id="c15c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并创建入口对象:</p><pre class="jt ju jv jw fd mk ml mm mn aw mo bi"><span id="066e" class="km kn hi ml b fi mp mq l mr ms">kubectl --context=kfed create -f ingress.yaml</span></pre><p id="8c9b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">元数据中的注释确保使用您之前创建的静态IP地址创建负载平衡器，并确保只创建一个全局负载平衡器。其余的看起来像一个标准的入口YAML。我们希望来自所有路径的流量在端口80上到达nginx服务。你可以定制它并使用【ingress提供的所有普通特性，比如路由、会话关联等，但是现在它是联邦的！</p><p id="8864" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你想要HTTPs支持，我强烈推荐使用<a class="ae ke" href="https://github.com/jetstack/kube-lego" rel="noopener ugc nofollow" target="_blank"> kube-lego </a>，它会自动将<a class="ae ke" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> Let's Encrypt </a>证书添加到你的入口负载平衡器。</p><p id="7e45" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">入口负载平衡器将需要几分钟时间来启动，并确保所有后端运行状况检查都已启动和运行，并且防火墙规则已创建。</p><h1 id="a6c1" class="lm kn hi bd ko ln mf lp ks lq mg ls kw io mh ip kz ir mi is lc iu mj iv lf lw bi translated">第四步:尝试一下！</h1><p id="6d3b" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">如果您访问Google Cloud控制台中的<a class="ae ke" href="https://console.cloud.google.com/networking/loadbalancing/loadBalancers/list" rel="noopener ugc nofollow" target="_blank">负载平衡器部分</a>，您应该会看到一个为您创建的HTTP(s)负载平衡器。这里我扩展了负载平衡器的细节:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es mt"><img src="../Images/b02981434faa778b54092db86a77ecf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CFIfJ_VyWfJg6XqG."/></div></div></figure><p id="10fa" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以看到有两个实例组支持这个负载平衡器，一个在美国东部，一个在美国西部。这是两个Kubernetes星团。您还可以看到，每个集群中的三个虚拟机都很健康，这意味着负载平衡器已经启动并正在运行！</p><p id="6ca1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要获取服务的IP地址，请运行:</p><p id="0232" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">kubectl — context=kfed get ingress</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es mu"><img src="../Images/bf9e939bde1091ae5c7cad9133a5f37e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/0*Do3QkeHScXbncsZj."/></div></div></figure><p id="a6c9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当你访问IP地址的时候，你应该从Nginx上看到hello world！</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es mv"><img src="../Images/ad22f7c0b4190aec3b471bf534056539.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jNx0BUhQG2K2Sgx4."/></div></div></figure><p id="fda8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">根据您所在的位置，您的流量将从离您最近的数据中心路由。你可以在我在YouTube 上的演示中看到这个<a class="ae ke" href="https://youtu.be/kmPBm-TQBSE?t=1975" rel="noopener ugc nofollow" target="_blank">的例子。</a></p><h1 id="53a4" class="lm kn hi bd ko ln mf lp ks lq mg ls kw io mh ip kz ir mi is lc iu mj iv lf lw bi translated">结论:</h1><p id="a66f" class="pw-post-body-paragraph ix iy hi iz b ja lh ij jc jd li im jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">虽然我们在本演示中只使用了两个集群，但是入口负载平衡器可以轻松扩展到更多集群。您可以在每个Google云数据中心创建巨大的集群，单个入口负载平衡器可以自动在所有这些集群之间分配您的HTTP(s)流量。两个联合集群或20个，所有步骤都是一样的！</p><p id="d338" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当然，Federated Ingress使用的anycast magic需要你在Google云平台上运行你所有的集群。目前，还不支持其他环境。如果你运行的是混合云，确保你的网络前端由入口负载均衡器支持，都运行在谷歌云平台上。</p><p id="676a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在第3部分中，我将向您展示如何使用跨集群服务发现来访问本地集群中不存在的服务，这对这些混合部署来说是完美的！</p></div></div>    
</body>
</html>