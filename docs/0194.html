<html>
<head>
<title>Infrastructure as Code on Google Cloud Platform: Load Balancers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云平台上的基础设施代码:负载平衡器</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/infrastructure-as-code-on-google-cloud-platform-load-balancers-22591561a2ec?source=collection_archive---------1-----------------------#2017-01-25">https://medium.com/google-cloud/infrastructure-as-code-on-google-cloud-platform-load-balancers-22591561a2ec?source=collection_archive---------1-----------------------#2017-01-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6ec1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我使用谷歌部署管理器(GDM)所学到的知识的系列文章的第3部分</p><p id="9220" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">距离我的上一篇帖子已经有一段时间了，我可以把它归咎于假期或我的健康或家庭，但我不会。真正的原因是拖延症。</p><p id="2fa7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我开始这次旅程时，我一点也不知道在GDM建造负载平衡器会如此困难。事实证明，以这种方式构建时，并不存在负载平衡器这样的庞然大物。Google Cloud Console会带你完成一个很好的设置过程，但是实际上还有更多的事情要做。在我们构建HTTP(S)负载平衡器的过程中，我们将学习如何构建各种各样漂亮的小东西。</p><p id="ea2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先(也是最简单的)先做。没有IP地址，负载平衡器就没有任何价值，所以让我们创建一个IP地址。这可能是你能创建的最简单的资源。不要忘记将它添加到您的<code class="du je jf jg jh b">outputs:</code>部分，以便了解该IP地址实际上是什么。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="b747" class="jq jr hi jh b fi js jt l ju jv">resources:<br/>###################################<br/># IP addresses<br/>###################################<br/>- name: dav-ipaddress<br/>  type: compute.v1.globalAddress</span><span id="f143" class="jq jr hi jh b fi jw jt l ju jv">outputs:<br/>- name: publicIP<br/>  value: $(ref.dav-ipaddress.address)</span></pre><p id="ac46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这似乎有点违反直觉，但现在我们需要建立一个健康检查。负载平衡器将使用它来确定后端服务何时是健康的。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="02e0" class="jq jr hi jh b fi js jt l ju jv">###################################<br/># Health Checks<br/>###################################<br/>- name: dav-health-check<br/>  type: compute.v1.httpHealthCheck<br/>  properties:<br/>    requestPath: /robots.txt<br/>    port: 80<br/>    checkIntervalSec: 5<br/>    timeoutSec: 5<br/>    unhealthyThreshold: 2<br/>    healthyThreshold: 2</span></pre><p id="9476" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们创建将托管我们的应用程序的后端服务。后端服务指的是一个Google计算引擎实例组，为了今天的目的，让我们假设它已经被创建了。在您的后端定义中，您可以指定<code class="du je jf jg jh b">port</code>和<code class="du je jf jg jh b">portName</code>，但是<code class="du je jf jg jh b">port</code>已经被弃用，取而代之的是<code class="du je jf jg jh b">portName</code>，它指的是实例组上的一个命名端口，我们也假设它已经被创建。请注意，我对两个后端使用了相同的健康检查——只要所有的设置在两个实例组上都有效。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="eb37" class="jq jr hi jh b fi js jt l ju jv">###################################<br/># Backend Services<br/>###################################<br/>- name: dav-backend-svc-1<br/>  type: compute.v1.backendService<br/>  properties:<br/>    backends:<br/>    - group: 'https://www.googleapis.com/compute/v1/projects/dav-project/zones/us-central1-b/instanceGroups/dav-instance-group-1'<br/>      maxUtilization: 0.8<br/>    healthChecks:<br/>    - $(ref.dav-health-check.selfLink)<br/>    portName: dav-named-port-1<br/>- name: dav-backend-svc-2<br/>  type: compute.v1.backendService<br/>  properties:<br/>    backends:<br/>    - group: 'https://www.googleapis.com/compute/v1/projects/dav-project/zones/us-east1-b/instanceGroups/dav-instance-group-2'<br/>      maxUtilization: 0.8<br/>    healthChecks:<br/>    - $(ref.dav-health-check.selfLink)<br/>    portName: dav-named-port-2</span></pre><p id="6749" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们需要构建一个URL映射，将请求路由到正确的后端服务。在下面的示例中，路径匹配/api将路由到dav-backend-svc-2，所有其他请求将路由到dav-backend-svc-1。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="e1c6" class="jq jr hi jh b fi js jt l ju jv">###################################<br/># URL Maps<br/>###################################<br/>- name: dav-url-map<br/>  type: compute.v1.urlMap<br/>  properties:<br/>    defaultService: $(ref.dav-backend-svc-1.selfLink)<br/>    hostRules:<br/>    - hosts:<br/>      - dav.example.com<br/>      pathMatcher: path-matcher-1<br/>    pathMatchers:<br/>    - defaultService: $(ref.dav-backend-svc-1.selfLink)<br/>      name: path-matcher-1<br/>      pathRules:<br/>      - paths:<br/>        - /<br/>        service: $(ref.dav-backend-svc-1.selfLink)<br/>        - /api<br/>        service: $(ref.dav-backend-svc-2.selfLink)</span></pre><p id="4c3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们将设置HTTP(S)代理。使用下面的配置，负载平衡器会将HTTP或HTTPS请求路由到适当的后端。SSL证书(我们假设在GCP已经存在)将由负载平衡器托管，因此您不需要在所有实例上托管。负载均衡器会将<code class="du je jf jg jh b">x-forwarded-proto</code> http头添加到所有请求中，如果您愿意，您可以配置nginx或apache(或者您选择的http服务器)来强制基于该头的SSL。如果您决定重定向，请记住不要将您的健康检查路径重定向到HTTPS！</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="d07f" class="jq jr hi jh b fi js jt l ju jv">###################################<br/># HTTP Proxies<br/>###################################<br/>- name: dav-http-proxy<br/>  type: compute.v1.targetHttpProxy<br/>  properties:<br/>    urlMap: $(ref.dav-url-map.selfLink)<br/>- name: dav-https-proxy<br/>  type: compute.v1.targetHttpsProxy<br/>  properties:<br/>    urlMap: $(ref.dav-url-map.selfLink)<br/>    sslCertificates:<br/>    - 'https://www.googleapis.com/compute/v1/projects/dav-project/global/sslCertificates/star-dav-example-com'</span></pre><p id="d0cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们需要设置网络转发规则，将流量路由到我们创建的静态IP(还记得开始时的方法吗？)到适当的HTTP(S)代理。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="23dd" class="jq jr hi jh b fi js jt l ju jv">###################################<br/># Network Forwarding Rules<br/>###################################<br/>- name: dav-http-forwardingrule<br/>  type: compute.v1.globalForwardingRule<br/>  properties:<br/>    target: $(ref.dav-http-proxy.selfLink)<br/>    IPAddress: $(ref.dav-ipaddress.address)<br/>    IPProtocol: TCP<br/>    portRange: 80-80<br/>- name: dav-https-forwardingrule<br/>  type: compute.v1.globalForwardingRule<br/>  properties:<br/>    target: $(ref.dav-https-proxy.selfLink)<br/>    IPAddress: $(ref.dav-ipaddress.address)<br/>    IPProtocol: TCP<br/>    portRange: 443-443</span></pre><p id="38c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">耶！我们完了！等等——你说这对你没用？就在我们以为已经完成的时候，还有一件事要做。我们需要防火墙规则来允许所有这些流量在项目中流动。在下面的例子中，<code class="du je jf jg jh b">ports:</code>指的是后端服务上指定端口的端口号。下面<code class="du je jf jg jh b">sourceRanges:</code>中的条目是Google为其所有负载平衡器使用的CIDR地址范围，因此您可以使用下面的值。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="88fc" class="jq jr hi jh b fi js jt l ju jv">###################################<br/># Firewall Rules<br/>###################################<br/>- name: allow-port-80<br/>  type: compute.v1.firewall<br/>  properties:<br/>    allowed:<br/>      - IPProtocol: TCP<br/>        ports: [ 80 ]<br/>    sourceRanges: [ 130.211.0.0/22 ]</span></pre><p id="4e6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们结束了。应用配置后，所有到dav.example.com的HTTP(S)流量将根据请求的URL路由到我们的2个后端之一。因此，您可以将整个系统视为一个单独的配置，这里所有的配置都放在一起。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="50a5" class="jq jr hi jh b fi js jt l ju jv">resources:<br/>###################################<br/># IP addresses<br/>###################################<br/>- name: dav-ipaddress<br/>  type: compute.v1.globalAddress</span><span id="601f" class="jq jr hi jh b fi jw jt l ju jv">###################################<br/># Health Checks<br/>###################################<br/>- name: dav-health-check<br/>  type: compute.v1.httpHealthCheck<br/>  properties:<br/>    requestPath: /robots.txt<br/>    port: 80<br/>    checkIntervalSec: 5<br/>    timeoutSec: 5<br/>    unhealthyThreshold: 2<br/>    healthyThreshold: 2</span><span id="d76f" class="jq jr hi jh b fi jw jt l ju jv">###################################<br/># Backend Services<br/>###################################<br/>- name: dav-backend-svc-1<br/>  type: compute.v1.backendService<br/>  properties:<br/>    backends:<br/>    - group: 'https://www.googleapis.com/compute/v1/projects/dav-project/zones/us-central1-b/instanceGroups/dav-instance-group-1'<br/>      maxUtilization: 0.8<br/>    healthChecks:<br/>    - $(ref.dav-health-check.selfLink)<br/>    portName: dav-named-port-1<br/>- name: dav-backend-svc-2<br/>  type: compute.v1.backendService<br/>  properties:<br/>    backends:<br/>    - group: 'https://www.googleapis.com/compute/v1/projects/dav-project/zones/us-east1-b/instanceGroups/dav-instance-group-2'<br/>      maxUtilization: 0.8<br/>    healthChecks:<br/>    - $(ref.dav-health-check.selfLink)<br/>    portName: dav-named-port-2</span><span id="7066" class="jq jr hi jh b fi jw jt l ju jv">###################################<br/># URL Maps<br/>###################################<br/>- name: dav-url-map<br/>  type: compute.v1.urlMap<br/>  properties:<br/>    defaultService: $(ref.dav-backend-svc-1.selfLink)<br/>    hostRules:<br/>    - hosts:<br/>      - dav.example.com<br/>      pathMatcher: path-matcher-1<br/>    pathMatchers:<br/>    - defaultService: $(ref.dav-backend-svc-1.selfLink)<br/>      name: path-matcher-1<br/>      pathRules:<br/>      - paths:<br/>        - /<br/>        service: $(ref.dav-backend-svc-1.selfLink)<br/>        - /api<br/>        service: $(ref.dav-backend-svc-2.selfLink)</span><span id="f30e" class="jq jr hi jh b fi jw jt l ju jv">###################################<br/># HTTP Proxies<br/>###################################<br/>- name: dav-http-proxy<br/>  type: compute.v1.targetHttpProxy<br/>  properties:<br/>    urlMap: $(ref.dav-url-map.selfLink)<br/>- name: dav-https-proxy<br/>  type: compute.v1.targetHttpsProxy<br/>  properties:<br/>    urlMap: $(ref.dav-url-map.selfLink)<br/>    sslCertificates:<br/>    - 'https://www.googleapis.com/compute/v1/projects/dav-project/global/sslCertificates/star-dav-example-com'</span><span id="df4d" class="jq jr hi jh b fi jw jt l ju jv">###################################<br/># Network Forwarding Rules<br/>###################################<br/>- name: dav-http-forwardingrule<br/>  type: compute.v1.globalForwardingRule<br/>  properties:<br/>    target: $(ref.dav-http-proxy.selfLink)<br/>    IPAddress: $(ref.dav-ipaddress.address)<br/>    IPProtocol: TCP<br/>    portRange: 80-80<br/>- name: dav-https-forwardingrule<br/>  type: compute.v1.globalForwardingRule<br/>  properties:<br/>    target: $(ref.dav-https-proxy.selfLink)<br/>    IPAddress: $(ref.dav-ipaddress.address)<br/>    IPProtocol: TCP<br/>    portRange: 443-443</span><span id="2ec6" class="jq jr hi jh b fi jw jt l ju jv">###################################<br/># Firewall Rules<br/>###################################<br/>- name: allow-port-80<br/>  type: compute.v1.firewall<br/>  properties:<br/>    allowed:<br/>      - IPProtocol: TCP<br/>        ports: [ 80 ]<br/>    sourceRanges: [ 130.211.0.0/22 ]</span><span id="763c" class="jq jr hi jh b fi jw jt l ju jv">outputs:<br/>- name: publicIP<br/>  value: $(ref.dav-ipaddress.address)</span></pre><p id="e53f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能已经注意到，我对在这个配置中创建的任何资源都使用了引用。这是一个很好的实践，因为它将A)在您的配置中创建隐式的依赖关系，这样资源就不会在它们所依赖的资源之前被创建，B)您不需要尝试和预测那些值或者分多个步骤运行您的构建。</p><p id="2eeb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您设法做到了这一步，那么您可能会非常致力于使用部署管理器。如果是这种情况，请继续关注本系列的下一期文章。在过去的一周左右的时间里，我一直在学习如何使用GDM模板，一旦我有了进一步的进展，我将会发布我的经历。</p></div></div>    
</body>
</html>