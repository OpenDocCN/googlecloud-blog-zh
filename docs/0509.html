<html>
<head>
<title>Reducing Stackdriver’s Logging Resource Usage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">减少Stackdriver的日志资源使用</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/reducing-stackdrivers-logging-resource-usage-641dfe9362d9?source=collection_archive---------0-----------------------#2018-02-03">https://medium.com/google-cloud/reducing-stackdrivers-logging-resource-usage-641dfe9362d9?source=collection_archive---------0-----------------------#2018-02-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="fe12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">昨天，我收到了一封来自Google的令人担忧的邮件，通知我关于Stackdriver日志记录的新定价模型，并且我已经超过了免费层的限制。Stackdriver定价模型有一个粗略的开始，包括一些调整和延期。截至今日，预计2018年3月31日开始充电。这意味着，如果我想保持在自由层限制内，我每月不应超过50GB的日志摄入量。对于我的小型集群来说，这已经很多了，为什么还要用更多呢？</p><h1 id="dc70" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">第一眼</h1><p id="88a6" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我决定去看看情况到底有多糟糕。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/c15ecea5f68b198b1425eb917323f693.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BTN2_6uUbSgmzFmP.png"/></div></div></figure><p id="a598" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">哇哦。😱这个月的第二天早上，我已经有37GB了？还好充电还没开始。面对现实，我继续深入研究日志的来源。因为我有很大一部分日志数据，所以我很有可能在日志中找到一些东西，对吗？😉资源表清楚地告诉我要找到容易摘到的果实。资源<em class="kt"> GKE集装箱</em>的月初至今(MTD)和预计月末(EOM)数字在数量级上领先于所有其他数字。</p><h1 id="ef31" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">原因1:谷歌Kubernetes引擎Bug</h1><p id="fdb6" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">通过检查外观，我发现同步器有一个错误。几天来，它每秒钟发射多次:</p><pre class="ki kj kk kl fd ku kv kw kx aw ky bi"><span id="259d" class="kz jf hi kv b fi la lb l lc ld">09:18:54 Restarting synchronizer: kubernetes-dashboard-key-holder-kube-system.<br/>09:18:54 Synchronizer kubernetes-dashboard-key-holder-kube-system exited with error: kubernetes-dashboard-key-holder-kube-system watch ended with timeout <br/>09:18:54 Restarting synchronizer: kubernetes-dashboard-key-holder-kube-system. <br/>09:18:54 Synchronizer kubernetes-dashboard-key-holder-kube-system exited with error: kubernetes-dashboard-key-holder-kube-system watch ended with timeout <br/>09:18:54 Restarting synchronizer: kubernetes-dashboard-key-holder-kube-system. <br/>09:18:54 Synchronizer kubernetes-dashboard-key-holder-kube-system exited with error: kubernetes-dashboard-key-holder-kube-system watch ended with timeout</span></pre><p id="981d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这确实产生了相当多的日志量供Stackdriver接收，并增加了总账单。这是我发现自己喃喃自语<a class="ae jd" href="https://en.wikipedia.org/wiki/Exponential_backoff" rel="noopener ugc nofollow" target="_blank"> <em class="kt">指数后退</em></a>……</p><p id="c37e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了停止来自破损仪表板的日志行的洪流，我重新启动了kubernetes仪表板窗格。当然，困难的是:</p><pre class="ki kj kk kl fd ku kv kw kx aw ky bi"><span id="becb" class="kz jf hi kv b fi la lb l lc ld">$ kubectl -n kube-system delete pod kubernetes-dashboard-768854d6dc-j26qx</span></pre><h1 id="6347" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">原因2:冗长的服务</h1><p id="ce72" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>这一小节的数据来自一个不同的集群，该集群没有遇到前面提到的错误，但是由于不同的原因有大量的日志记录。</p><p id="b9e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在另一个集群中，我也经历了大量的日志摄入。然而，没有垃圾日志，这意味着这个集群中充满了规则的日志行。为了找出是否有比其他服务产生更多日志行的服务，我创建了一个基于日志的度量。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es le"><img src="../Images/1113a4fbbaf6ceaec2c73ba9ac67e1ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Fo6l2Za4m2k7pezP.png"/></div></div></figure><p id="a07a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个度量基本上只是一个日志行的计数器，按照资源标签<code class="du lf lg lh kv b">namespace_id</code>分组。有了这个指标，我转向Stackdriver Monitoring并创建了一个图表，该图表绘制了按名称空间分组的每秒日志行数。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es li"><img src="../Images/2f64a7d29c6c5e13dc35fbfee9dcf606.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/0*xjEoE3pxtnt6HEwu.png"/></div></figure><p id="a283" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">显然，当每个服务都被严格限制在一个名称空间时，这是最有价值的。现在，我能够找出最冗长的服务，并更深入地挖掘它们，以减少它们的冗长。</p><h1 id="feb1" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">缓解措施1:排除</h1><p id="9746" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">解决高原木摄入问题的第一个办法是少摄入原木。多么出人意料！幸运的是，有一种方法叫做<em class="kt">排除</em>。在resources页面上，我们可以创建排除规则(如果您愿意，也可以创建过滤器)来以合理的方式减少日志记录。这里的合理意味着允许重要的日志条目进入系统，同时丢弃不太有用的条目。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lj"><img src="../Images/89d316e90666ca0c6d2de797f728d060.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*306JUT4pmR4L3n7W.png"/></div></div></figure><p id="203f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，下面的规则会丢弃日志级别为<em class="kt"> INFO </em>的所有日志条目。这是一个非常简单的例子，但是，我们可以自由地使用我们从常规日志过滤活动中了解到的所有好的操作符。排除是一个强大的工具！</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lk"><img src="../Images/7e9617a011d532e8eda047e02d8912e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1daCz5-jASLaemqo.png"/></div></div></figure><p id="ca04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里是相同规则的复制粘贴友好版本。</p><pre class="ki kj kk kl fd ku kv kw kx aw ky bi"><span id="26de" class="kz jf hi kv b fi la lb l lc ld">resource.type="container" severity="INFO"</span></pre><p id="4531" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，您甚至可以通过创建排除过滤器并将丢弃率设置为小于100%的值来对日志进行采样。对于我的用例，95%的排除率为我提供了足够的样本来评估过去的问题，同时保持合理的日志摄入量。在问题分类期间，我建议暂时禁用排除，或者调整它们以至少通过所有相关日志。</p><p id="6d2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有趣的事实:Stackdriver记录操作(创建、删除等。)对排除规则执行，从而创建另一个日志源，即<em class="kt">日志排除</em>日志源。#盗梦空间</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es ll"><img src="../Images/c4d19b8f91cba683593deb48bcd52238.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/0*a-wC4DwPmrbb-ZV9.png"/></div></figure><p id="5362" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想知道是否可以为日志排除创建一个排除规则。🤔</p><h1 id="b877" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">缓解措施2:监控</h1><p id="7c54" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我想分享的下一个日志过量缓解技术使用基于日志的指标，在事情变得糟糕之前发出警报。Stackdriver附带了一些方便的系统指标。系统指标意味着，这些是来自日志系统的元数据。其中一个数据点是<code class="du lf lg lh kv b">bytes_count</code>。我在Stackdriver监控系统中使用这个指标，以便在日志接收量超过预期水平时获得早期警告。</p><p id="8f75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是我使用<em class="kt">度量阈值</em>条件的策略:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lm"><img src="../Images/5c71604894670110888d78a2888dc8a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mm_uhDvxuf1w-23K.png"/></div></div></figure><p id="6a83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们仔细看看度量阈值。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es ln"><img src="../Images/c1dfe67a48e54e96c2d2878f1bcb64eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-GM7tKTgr7DMsEai.png"/></div></div></figure><p id="cf84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我正在监视资源类型<em class="kt">日志度量</em>和“日志字节”度量。</p><p id="7fa7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于我来说，一个可接受的摄入速率是10kb/s。如果持续达到这一速率，那么在一个28天的月中，总的日志摄入大约为24.2GB，在一个31天的月中，大约为26.8GB。这两个值都为不可预见的问题和反应时间留有余地。</p><p id="65e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如您在图中看到的，我的集群在很长一段时间内都远远超过了这个阈值。这就是我之前描述的bug，我花了一些时间才找到它。有了警报，相同或类似的错误将在日志爆发的1分钟宽限期后触发警报。</p><p id="ccf9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我结束之前，有一个警告:阈值设置得太低可能会损害您的收件箱！😅去过那里，做过那个。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lo"><img src="../Images/ae8f06e10f1fe72596eafe6ca440d85d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yyFnfZbWNicfebHW.png"/></div></div></figure><h1 id="4ad9" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">结论</h1><p id="d132" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">Stackdriver的警告电子邮件听起来可能很吓人，但有一些方法可以控制日志的接收，并通过准备基于指标的警报来为不可预见的问题做好准备。</p></div><div class="ab cl lp lq gp lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="hb hc hd he hf"><p id="a5c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kt">最初发表于</em><a class="ae jd" href="https://danrl.com/blog/2018/stackdriver-logging" rel="noopener ugc nofollow" target="_blank"><em class="kt">【danrl.com】</em></a><em class="kt">。</em></p></div></div>    
</body>
</html>