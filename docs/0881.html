<html>
<head>
<title>Cloud IoT step-by-step: Cloud to device communication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云物联网循序渐进:云到设备的通信</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-iot-step-by-step-cloud-to-device-communication-655a92d548ca?source=collection_archive---------1-----------------------#2019-01-16">https://medium.com/google-cloud/cloud-iot-step-by-step-cloud-to-device-communication-655a92d548ca?source=collection_archive---------1-----------------------#2019-01-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/1c49722e0751fda0d1f1c37f2997da0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jr4LvyRnMIryL5g_ueEWYQ.png"/></div></div></figure><p id="33d2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">嗨，朋友们！</p><p id="204a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本教程建立在<a class="ae jo" rel="noopener" href="/@GabeWeiss/cloud-iot-step-by-step-connecting-raspberry-pi-python-2f27a2893ab5">上一篇</a>的基础上，并假设您已经习惯将您的设备连接到谷歌云项目。如果你不是，没关系！跟着那个链接走，做另一个，然后回来做这个。</p><p id="4a36" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以现在你有一个设备把它的数据发送到云端，但是如果你想把信息发送回你的设备呢？像所有物联网的事情一样，有许多不同的方法可以做到这一点。如果你真的想的话，你甚至可以在你的Pi上安装<a class="ae jo" href="https://www.raspberrypi.org/documentation/remote-access/web-server/apache.md" rel="noopener ugc nofollow" target="_blank"> Apache </a>或<a class="ae jo" href="https://www.raspberrypi.org/documentation/remote-access/web-server/nginx.md" rel="noopener ugc nofollow" target="_blank"> NGINX </a>并在上面运行你自己的网络服务器！对于大多数情况，这可能有点过头了，所以今天我想介绍如何将简单的消息发送回您的设备，并基于该消息做一些事情。</p><p id="7f62" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章的最后，你将会看到云把信息发送到你的设备上。</p><h1 id="1b6f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">目录:</h1><ul class=""><li id="09dc" class="kn ko hi is b it kp ix kq jb kr jf ks jj kt jn ku kv kw kx bi translated"><a class="ae jo" href="#6c93" rel="noopener ugc nofollow">来自云端的消息类型</a></li><li id="f441" class="kn ko hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated"><a class="ae jo" href="#ce60" rel="noopener ugc nofollow">设备设置和代码</a></li><li id="78b7" class="kn ko hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated"><a class="ae jo" href="#8c59" rel="noopener ugc nofollow">从云控制台发送消息</a></li><li id="a08b" class="kn ko hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated"><a class="ae jo" href="#5123" rel="noopener ugc nofollow">从谷歌云功能发送消息</a></li><li id="1b33" class="kn ko hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated"><a class="ae jo" href="#b9d7" rel="noopener ugc nofollow">创建服务账户</a></li><li id="5138" class="kn ko hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated"><a class="ae jo" href="#084c" rel="noopener ugc nofollow">完成功能</a></li><li id="ab62" class="kn ko hi is b it ky ix kz jb la jf lb jj lc jn ku kv kw kx bi translated"><a class="ae jo" href="#5b1a" rel="noopener ugc nofollow">带设备运行</a></li></ul><h2 id="6c93" class="ld jq hi bd jr le lf lg jv lh li lj jz jb lk ll kd jf lm ln kh jj lo lp kl lq bi translated">来自云的消息类型</h2><p id="77a8" class="pw-post-body-paragraph iq ir hi is b it kp iv iw ix kq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">有两种类型的消息(目前)可以通过<a class="ae jo" href="https://cloud.google.com/iot/docs/reference/cloudiot/rest/" rel="noopener ugc nofollow" target="_blank">物联网核心管理SDK </a>(也称为cloudiot REST API)从谷歌云发送回你的设备。</p><ol class=""><li id="2c8f" class="kn ko hi is b it iu ix iy jb lu jf lv jj lw jn lx kv kw kx bi translated">配置消息。它们在云中被版本化，因此您可以发送/检索消息的特定版本。当设备连接到云时，最新的配置消息将被发送到设备。因此，即使您的设备当前没有连接，这也是在设备上设置某种状态的一种方式。它有一些限制。最大的问题是每台设备每秒只能发送一条配置信息。</li><li id="5e21" class="kn ko hi is b it ky ix kz jb la jf lb jj lc jn lx kv kw kx bi translated">命令消息。这些是火和遗忘。它们没有版本控制，因此，如果在您发送其中一个时，您的设备当前没有连接到云，它就消失了。因此，它们速度更快，可以更频繁地发送。每个设备注册表每秒1000条消息(但可以根据具体情况增加)。</li></ol><p id="7abf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我的看法是，如果你想在设备上保存的话？配置。如果您的设备处于“活动”状态，您希望对哪些瞬时信息做出响应？命令。</p><h2 id="ce60" class="ld jq hi bd jr le lf lg jv lh li lj jz jb lk ll kd jf lm ln kh jj lo lp kl lq bi translated">设备设置和代码</h2><p id="a66e" class="pw-post-body-paragraph iq ir hi is b it kp iv iw ix kq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">在与上一篇帖子相同的GitHub repo中，发现<a class="ae jo" href="https://github.com/GabeWeiss/IoT_Core_Quick_Starts" rel="noopener ugc nofollow" target="_blank">在这里</a>。这篇文章的代码是02_basics.py。我们仍然使用Sense HAT，我将带您浏览上次新增的代码片段。</p><p id="d872" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如我提到的，这篇文章建立在我之前的文章之上，所以你需要确保你已经完成了<a class="ae jo" rel="noopener" href="/h2/2f27a2893ab5#c01b"> Pi设置基础</a>、<a class="ae jo" rel="noopener" href="/h2/2f27a2893ab5#50cb">库依赖设置</a>和<a class="ae jo" rel="noopener" href="/h2/2f27a2893ab5#7f07">准备谷歌云平台</a>的步骤。</p><p id="8430" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">做完了吗？太好了！</p><p id="5c9a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">和上次一样，确保您已经编辑了变量代码块，以匹配您的特定项目和证书位置。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/eec2609d21789a64b9e1d8630156e8fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*qYDJlnDdhaAKI09mkti0Pg.gif"/></div></div></figure><p id="0503" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以看到在<code class="du md me mf mg b">respondToMsg(msg)</code>方法中支持哪些值。如果你想添加更多的东西，那就从这里开始吧。</p><figure class="lz ma mb mc fd ij"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="87ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">抱歉闪烁，LED矩阵的频率与相机匹配。你看到的是我通过物联网核心将<code class="du md me mf mg b">“red”</code>和<code class="du md me mf mg b">“rainbow”</code>发送到我的Pi。抖动是因为我在输入“彩虹”的时候拿着相机。</p><p id="2ea1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有一点要注意，如果感觉头几次需要一段时间才能把信息传到设备上，不要大惊小怪。有个东西叫“冷启动”。一旦你用一个云函数做了几次，它就会被缓存并留在内存中，所以在随后的启动中会更快。</p><p id="f0c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">那么，我们如何将这些信息发送到我们的设备上呢？</p><h2 id="8c59" class="ld jq hi bd jr le lf lg jv lh li lj jz jb lk ll kd jf lm ln kh jj lo lp kl lq bi translated">从云控制台发送消息</h2><p id="0e1d" class="pw-post-body-paragraph iq ir hi is b it kp iv iw ix kq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">这是做这件事的简单方法。伟大的测试，以确保一切都连接正确和工作。还有，IMO，最没用的实用方法。因为它是从控制台手动进行的，所以对于一次性更新来说是不错的，但是就真实的用例而言呢？相当小众。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div class="er es mj"><img src="../Images/28532d81872cb6f700411d10ac869463.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*SSGz83Pm6u8U3R3cZj9vPw.png"/></div></figure><p id="c94e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从搜索栏或汉堡菜单导航到<a class="ae jo" href="https://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank">控制台</a>上的物联网核心页面。</p><p id="ed68" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">深入查看您在物联网核心中创建的设备，在设备详细信息页面上，您将看到以下选项:</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div class="er es mk"><img src="../Images/cd4ddf70deb9e39cc6cf3d04751de219.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*E6kbdjdNvFFn-RTrpPyj4g.png"/></div></figure><p id="1e1f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du md me mf mg b">update config</code>和<code class="du md me mf mg b">send command</code>都打开一个非常相似的对话框，允许你发送一个文本，或者一个base64编码的消息回你的设备。确保在该对话框中选择了<code class="du md me mf mg b">text</code>。现在，不要担心命令对话框中的子文件夹添加选项。我们不会用它。</p><p id="caa2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请记住，要接收命令，设备必须运行代码(主动连接)。对于配置，如果您的设备已连接，它将实时接收它们，此外，在连接时，设备将接收最新的配置消息。因此，例如，如果您发送了“红色”配置消息，并以另一种方式清除了LED矩阵，在连接时，您的设备将从云中获得“红色”，并将LED矩阵变为红色。</p><h2 id="5123" class="ld jq hi bd jr le lf lg jv lh li lj jz jb lk ll kd jf lm ln kh jj lo lp kl lq bi translated">从谷歌云功能发送消息</h2><p id="ee63" class="pw-post-body-paragraph iq ir hi is b it kp iv iw ix kq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">通过物联网核心API向设备发送消息的方式和调用REST API的方式一样多。我想强调的一个方法是使用云函数。它们是无服务器方法，既可以通过调用端点(HTTPS)来触发，也可以响应一些云事件(当我们创建一个时，您可以在下拉列表中看到是哪一个)。它们很好，易于设置和部署。还有一些更快的选项，我将在以后的帖子中介绍，但就设置的方便性而言，这是我的最爱(个人观点，其他人可能不同意我的观点)。</p><p id="db31" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我为这个帖子写的函数在同一个repo中，可以在这里找到<a class="ae jo" href="https://github.com/GabeWeiss/IoT_Core_Quick_Starts/tree/master/02_basics_gcf" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="9f66" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">部署云功能主要有两种方式:命令行和控制台。我今天将讨论控制台，我将在以后的帖子中讨论命令行的所有内容。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div class="er es ml"><img src="../Images/918c65c24c7b38720346e19fe74c9b51.png" data-original-src="https://miro.medium.com/v2/resize:fit:764/format:webp/1*9x9RZs8Jh0H5ryMhr6HT8A.png"/></div></figure><p id="134b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在你的<a class="ae jo" href="https://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank"> GCP控制台</a>中，搜索云功能，或者使用菜单导航到云功能。在导航汉堡中，它靠近顶部，在计算机下面。</p><p id="9159" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您从未使用过云函数，它会要求您启用API，继续操作。</p><p id="214b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击页面最上方的<code class="du md me mf mg b">Create Function</code>链接。给你的函数起个名字，不要管内存分配，也不要管触发器。我们将使用一个HTTP端点来触发我们的函数。您可以在此页面上看到触发此功能的URL。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/5457c5df288fb42034fdaed8316b6286.png" data-original-src="https://miro.medium.com/v2/resize:fit:904/format:webp/1*oFCmQWy0z3WSC3OlMcj-fw.png"/></div></div><figcaption class="mn mo et er es mp mq bd b be z dx translated">这不是一个真正的函数，它不会做任何事情。</figcaption></figure><p id="5aee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将我的GitHub中的代码剪切/粘贴到index.js的内联编辑器中，并将我的GitHub中的package.json内容复制到内联编辑器的package.json选项卡中。将代码中的变量<code class="du md me mf mg b">registryId</code>和<code class="du md me mf mg b">deviceId</code>更新到我们在上一节中创建的设备。我从环境中提取了<code class="du md me mf mg b">projectId</code>，但是你也可以显式地编辑它。对于msg变量，将<code class="du md me mf mg b">“clear”</code>替换为<code class="du md me mf mg b">“red”</code>。现在还不用担心<code class="du md me mf mg b">serviceAccount</code>或<code class="du md me mf mg b">which</code>。</p><p id="9500" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于要执行的功能框，输入<code class="du md me mf mg b">updateDevice</code>。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/674f1a2a4343da6e3e63bb50d8b41cb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:364/format:webp/1*_5CXt1sJ2x8brsJTPFxl7g.png"/></div></div></figure><p id="5efc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下一步，在要执行的功能框下面，有一个“更多”的小链接。点击它。</p><p id="9a78" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将扩展出一些我们需要调整的选项。该区域应该与您的项目相同，并且没有问题。超时没问题。</p><p id="86bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不过，我们需要谈谈服务客户。代码中有一段要求你<code class="du md me mf mg b">&lt;paste contents of the service account json blob here&gt;</code>。服务账户有很多内容，超出了这篇博文的范围。如果你想深入研究，医生们就在这里。TL；DR是这些是不记名令牌，授权你的代码访问谷歌云平台的不同部分，包括API、数据库访问等。默认情况下，当您创建项目时，您已经有了一些这样的权限，但是它们具有广泛的权限，我们不想到处都使用它们，所以我们将专门为此创建一个。您不需要更改云功能中列出的那个，我只是想提出来，因为这将是我们的下一步。继续点击最底部的<code class="du md me mf mg b">Create</code>按钮，将云功能导入系统，在我们创建服务帐户之前，不要丢失任何进度。</p><p id="c7fe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">部署这个函数需要一点时间，注意，当我们稍后调整这个函数的时候，当你的函数名旁边的旋转图标变成绿色的时候，这是一个谎言。该函数已经部署，但可能还没有完全传播它的版本。再过一分钟绿色复选框，你就可以开始了。虽然这个特殊的还没有准备好成功运行，因为我们还没有处理授权。让我们把那部分做完。</p><h2 id="b9d7" class="ld jq hi bd jr le lf lg jv lh li lj jz jb lk ll kd jf lm ln kh jj lo lp kl lq bi translated">创建服务帐户</h2><figure class="lz ma mb mc fd ij er es paragraph-image"><div class="er es ms"><img src="../Images/1dadd87c756888eb29eb795e3c509acc.png" data-original-src="https://miro.medium.com/v2/resize:fit:742/format:webp/1*2A14HJxQ06wig0-gsxp2bw.png"/></div></figure><p id="8be6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在控制台中，搜索<code class="du md me mf mg b">Service accounts</code>，它将是带有IAM &amp;管理子标题的选项(在我的图片中，它是列表中的最后一个)</p><p id="a323" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者使用汉堡菜单进入IAM &amp; admin -&gt;服务帐户。点击页面顶部的<code class="du md me mf mg b">Create service account</code>链接。给它起个名字，点击<code class="du md me mf mg b">Create</code>。在<code class="du md me mf mg b">Select a role</code>下拉菜单中，向下滚动直到找到<code class="du md me mf mg b">Cloud IoT</code>，并选择<code class="du md me mf mg b">Cloud IoT Admin</code>选项。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div class="er es mt"><img src="../Images/89e5a68f7ac5df8b4dba2591e94750b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*eslMlP_vixdg10OUERSFkg.png"/></div></figure><p id="8341" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击<code class="du md me mf mg b">Continue</code>。在下一页中，单击<code class="du md me mf mg b">Create key</code>按钮，保持JSON单选按钮处于选中状态，然后单击<code class="du md me mf mg b">Create</code>按钮。这会将一个JSON文件下载到您的计算机上。我们需要它，所以跟踪它的位置，然后点击<code class="du md me mf mg b">Done</code>按钮完成服务帐户的创建。</p><p id="786b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在有那个<code class="du md me mf mg b">&lt;paste contents of the service account json blob here&gt;</code>注释的<code class="du md me mf mg b">index.js</code>文件中，那是你想要粘贴你刚刚下载的文件内容的地方。它最终会看起来像这样:</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/dcee074f23ed868813921e44a84c4e0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RbbVY5hOPQUkqRNQ_TKuzA.png"/></div></div><figcaption class="mn mo et er es mp mq bd b be z dx translated">我已经修改了值，这些都不是真的，别想黑我了</figcaption></figure><h2 id="084c" class="ld jq hi bd jr le lf lg jv lh li lj jz jb lk ll kd jf lm ln kh jj lo lp kl lq bi translated">最终确定功能</h2><p id="719a" class="pw-post-body-paragraph iq ir hi is b it kp iv iw ix kq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">在控制台中导航回您的云功能，并在它的详细信息页面上，单击<code class="du md me mf mg b">Edit</code>。将index.js中的代码粘贴到内联编辑器中，覆盖那里的所有内容，滚动到底部并单击<code class="du md me mf mg b">Save</code>。等待额外的一分钟进行部署，您应该能够点击到<code class="du md me mf mg b">Testing</code>选项卡(靠近顶部，在版本下拉菜单下)。因为我们有逻辑默认值，所以此时您应该能够点击<code class="du md me mf mg b">Test the function</code>。如果一切正常，<code class="du md me mf mg b">Test the function</code>按钮将很快重新启用，因为它实际运行起来根本不需要很长时间，但我们所等待的是，在下面的日志部分，它会显示“获取日志”。这可能需要一点时间来完成，但是理论上，我们不应该在这里看到任何错误。如果这样做了，请仔细检查注册表和设备ID的所有变量，并确保服务JSON周围没有任何多余的引号。当我这样做的时候，这两个人咬了我一口，错误信息通常不像它们应该的那样清晰。</p><h2 id="5b1a" class="ld jq hi bd jr le lf lg jv lh li lj jz jb lk ll kd jf lm ln kh jj lo lp kl lq bi translated">使用设备运行</h2><p id="1d33" class="pw-post-body-paragraph iq ir hi is b it kp iv iw ix kq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">好了，现在打开你的设备，运行脚本。您将看到脚本的遥测发布输出。目前它被设置为向云输出四到五个有效载荷(尽管如果您没有取消对<code class="du md me mf mg b">client.publish</code>调用的注释，那么它实际上并没有向云发送任何东西，只是将有效载荷输出到控制台)，然后脚本将等待。由于我们已经运行了云功能，当设备运行脚本时，它应该会变成红色，因为这是我们设置的配置，请记住，您的设备将在连接到物联网核心时收到最新的配置消息。</p><p id="344a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以现在在你的函数中(在内联编辑器中)，返回并用<code class="du md me mf mg b">“clear”</code>替换<code class="du md me mf mg b">msg</code>变量的<code class="du md me mf mg b">“red”</code>,因为这是我们的默认值，我们希望能够在清除矩阵时使用默认值。为了测试以确保它仍然是好的，一旦它被部署(一分钟后出现绿色图标)，当脚本仍然在您的设备上运行时，从功能控制台的测试选项卡再次测试它，您应该会看到灯熄灭(不要忘记由于冷启动，在游戏的这个阶段可能需要一点静止)。</p><p id="a335" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们已经从测试中确认了它的工作…现在是真正的交易！之前的HTTP触发器，现在我们需要它，这样我们可以真正测试它。如果您没有在云功能的详细信息页面上的某个地方复制它，您可以再次找到它，请查看<code class="du md me mf mg b">Trigger</code>选项卡获取URL。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div class="er es mv"><img src="../Images/3a84e3f0ce3bd6910dc42878c8a74a82.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/format:webp/1*EmiV-qLQO3RY0_2-n-bt7A.png"/></div></figure><p id="a40f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以点击那个链接，它会打开另一个网页到你的触发器，它会火。因为所有的默认设置都是清除，所以led不会亮起，但是您会在设备上看到来自脚本的调试消息，如下所示:</p><p id="1ab7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du md me mf mg b">TESTING: clear<br/>matching message text: clear<br/>RESPONDING</code></p><p id="2c1d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在是真正的测试。在触发器URL的末尾添加一个GET变量。以我上面的示例URL为起点，它可能看起来像:</p><p id="d881" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du md me mf mg b">https://us-central1-gweiss-project.cloudfunctions.net/test-functin/index.js?message=red</code></p><p id="7ad1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">消息变量是解析代码的直接通道。所以我上面提到的所有变量都是可行的，例如<code class="du md me mf mg b">temp</code>、<code class="du md me mf mg b">rainbow</code>等等。如果您向脚本添加任何处理，那么这些也将是要传递的可行变量。</p><p id="47d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后一个变量是<code class="du md me mf mg b">which</code>变量。这是脚本是否发出配置消息和命令消息的开关。两个可能的值是<code class="du md me mf mg b">which=config</code>或<code class="du md me mf mg b">which=command</code>。需要记住的是，云功能本身会给这个管道增加延迟。所以从控制台发出配置/命令总是比通过函数更快。正如我提到的，你第一次启动一个新部署的函数也会比较慢。</p><p id="aab3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果Node.js不是你选择的语言，我现在写了一个新的帖子，增加了与我们这里相同的云函数，但使用了Python和Go。那个帖子可以在这里<a class="ae jo" rel="noopener" href="/@GabeWeiss/cloud-iot-step-by-step-functions-words-words-words-30e62edbe73c">找到。</a></p><p id="648d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这一次到此为止！在接下来的博客中，我将谈论使用谷歌云命令行工具，以及使用它可以围绕物联网工具做什么，还可以围绕解决不同问题的设备进行通信。</p><p id="4f05" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你有任何反馈，或者你渴望看到我写的东西，请在评论中告诉我。您也可以通过<a class="ae jo" href="https://twitter.com/GabeWeiss_" rel="noopener ugc nofollow" target="_blank"> Twitter </a>联系我，我的DMs是开放的。</p><p id="5b5f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" rel="noopener" href="/@GabeWeiss/cloud-iot-step-by-step-quality-of-life-tip-the-command-line-ce23046867d4">下一步:通过使用命令行进行设置和测试来提高效率</a>。</p></div></div>    
</body>
</html>