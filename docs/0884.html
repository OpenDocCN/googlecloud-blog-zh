<html>
<head>
<title>A Cloud Function to automate Google Spreadsheet CSV import</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动导入Google电子表格CSV的云功能</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/a-cloud-function-to-automate-google-spreadsheet-csv-import-d2ffb8fbe9b4?source=collection_archive---------0-----------------------#2019-01-21">https://medium.com/google-cloud/a-cloud-function-to-automate-google-spreadsheet-csv-import-d2ffb8fbe9b4?source=collection_archive---------0-----------------------#2019-01-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="482b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">更新</em> </strong> <em class="jd">:这个帖子现在有一个</em> <a class="ae je" href="https://codelabs.developers.google.com/codelabs/cloud-function2sheet" rel="noopener ugc nofollow" target="_blank"> <em class="jd">循序渐进的codelab </em> </a> <em class="jd">(最后一次更新2020年5月)。</em></p><p id="761d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，您可以将<a class="ae je" href="https://en.wikipedia.org/wiki/Comma-separated_values" rel="noopener ugc nofollow" target="_blank"> CSV </a>内容粘贴或导入到Google Sheets中，但是自动化这个过程，从而能够在文件上传到bucket时用文件内容更新工作表，这不是很好吗？这将确保您可以在电子表格中分析可用的数据(可能由另一个团队产生):</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/bcf1529e542e65600029fe1a3b282903.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mh90GOX9vRnDVeRSQRYC2g.png"/></div></div></figure><p id="bb3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我将带你了解如何编写一个<a class="ae je" href="https://cloud.google.com/functions/" rel="noopener ugc nofollow" target="_blank">云函数</a>，它对上传到<a class="ae je" href="https://cloud.google.com/storage/" rel="noopener ugc nofollow" target="_blank">云存储</a>桶的CSV文件做出反应，然后使用<a class="ae je" href="https://developers.google.com/sheets/api/" rel="noopener ugc nofollow" target="_blank"> Google Sheets API </a>用CSV数据更新你的一个电子表格。</p><p id="01a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实现如下所示:</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jr"><img src="../Images/0e095333dde221f67e4aa423fb302a96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ptQqarFnSQxs4IXdYo30Hg.png"/></div></div></figure><p id="b99e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">只是一点(安全)设置</em> </strong></p><p id="952c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们创建一个新的Sheets文档。一旦创建，记住它的标识符；它将被用作我们将要编写的函数的环境变量:</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es js"><img src="../Images/c84bc18e4e05031fb0dbe93d59798a5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xLEun0CWHBjrj-4M"/></div></div></figure><p id="e1c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从<a class="ae je" href="http://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank"> GCP控制台</a>，创建一个新项目并启用<a class="ae je" href="https://console.cloud.google.com/apis/library/sheets.googleapis.com" rel="noopener ugc nofollow" target="_blank"> Google Sheets API </a>(点击链接或转到控制台“API和服务”部分) :</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es jt"><img src="../Images/bf7263e61fd1b0abe22675f172a335d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/0*L0ssgaZ96ZzSxy7P"/></div></figure><p id="bd47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在“IAM &amp; admin”部分，导航至“服务帐户”,记下App Engine默认服务帐户的电子邮件。它的形式应该是<code class="du ju jv jw jx b"><em class="jd">your-project-id</em>@appspot.gserviceaccount.com</code>。当然，您也可以创建自己的服务帐户专门用于此操作。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es jy"><img src="../Images/92ba11fa1a77f9d865709474a3a5723a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/0*lR9T5anRlPgxoSaw"/></div></figure><p id="dc72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，只需授予该服务帐户对您的电子表格的编辑权限:</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es jz"><img src="../Images/f30bbba65f1d954652e0f7e924f07106.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/0*tShQRVoFjdPOAJGB"/></div></figure><p id="dbc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，配置为使用该服务帐户的云功能将能够请求对该电子表格文档的写访问。</p><p id="ba21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">创建云函数</em> </strong></p><p id="b04c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在可以创建一个名为<code class="du ju jv jw jx b">csv2sheet</code>的云函数，它在文件上传到特定的云存储桶时被触发。代码将使用<a class="ae je" href="https://developers.google.com/web/fundamentals/primers/async-functions" rel="noopener ugc nofollow" target="_blank">异步函数</a>在Node.js 8中编写。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es ka"><img src="../Images/77e43adb864f1cc612d017cd6c03451a.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/0*x1kY1Ytj_9uQPk74"/></div></figure><p id="230f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更改函数体以使用云存储和工作表API，将<code class="du ju jv jw jx b">csv2sheet</code>函数标记为<code class="du ju jv jw jx b">async</code>，从云存储事件元数据中获取<code class="du ju jv jw jx b">fileName</code>，并为我们将创建的新工作表派生一个名称:</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="c4fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里使用<code class="du ju jv jw jx b">async</code>需要用到<code class="du ju jv jw jx b">await</code>，我们马上就会看到。</p><p id="9914" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该功能的几个重要选项包括:</p><ul class=""><li id="3410" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated">使用的服务帐户(应该与上面讨论的相同)</li><li id="272a" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">名为<code class="du ju jv jw jx b">SPREADSHEET_ID</code>的环境变量应该与您之前创建的工作表文档相匹配:</li></ul><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es kr"><img src="../Images/db51f0068cf87a00ca7bede86403fcf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/format:webp/1*_yqAMbXeSkx6NvbwrT8uzA.png"/></div></figure><p id="bffe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为最后的设置步骤，这里是我们将使用的云存储和Google Sheet APIs作为两个依赖项的<code class="du ju jv jw jx b">package.json</code>内容:</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="f069" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你按照描述配置好一切，继续，点击“创建功能”！</p><p id="5f8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想直接跳到完整的代码，这里有<a class="ae je" href="https://gist.github.com/alexismp/86315a74cdf887003b11f4ceade924de" rel="noopener ugc nofollow" target="_blank">和</a>。否则，跟着走！</p><p id="9ae0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">T15】AuthT17】</strong></p><p id="5ebf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们进一步编码之前，我们需要阻止创建一个具有适当存储和工作表范围的Google客户端API(记住，这是一个<code class="du ju jv jw jx b">async</code>函数的一部分) :</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="254f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我们可以创建一个Sheets API客户端:</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="b9c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">创建空表</em> </strong></p><p id="8fb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用Sheets API客户端，我们可以在文档中创建一个简单的新表，但在我们继续之前，这里有一个关于词汇的快速注释:</p><ul class=""><li id="efc7" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ki kj kk kl bi translated">一个<em class="jd">电子表格</em>是实际的文档，由它的标识符引用(如上所述，在文档URL中可见)</li><li id="1fa2" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated"><em class="jd">表单</em>是文档中的选项卡之一，可以通过其名称(选项卡名称)或创建表单时生成的标识符来引用</li></ul><p id="dca9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">考虑到这一点，这里有一个函数使用Sheets API客户机在位置2(通常在默认的“Sheet1”之后)创建一个空表，有26列，2000行，第一行被冻结:</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="1586" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，我们如何依赖先前创建的<code class="du ju jv jw jx b">SPREADSHEET_ID</code>环境变量，而不是对电子表格的引用进行硬编码。</p><p id="7254" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要记住对这个特定工作表的进一步请求的<code class="du ju jv jw jx b">sheetId</code>。此外，工作表名称需要是唯一的，如果已经有一个名为<code class="du ju jv jw jx b">sheetName</code>的工作表，创建将会失败。</p><p id="5802" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">工作表API中的<code class="du ju jv jw jx b">batchUpdate</code>函数是与文档交互的一种常见方式，在这里<a class="ae je" href="https://developers.google.com/sheets/api/guides/batchupdate" rel="noopener ugc nofollow" target="_blank">对其进行了描述</a>。</p><p id="8eab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">从存储CSV文件中读取数据</em> </strong></p><p id="2597" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们有了转储数据的地方，让我们使用云存储API从刚刚上传的文件中获取实际数据，并将其存储在一个字符串中:</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="c4db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">填充新创建的工作表</em> </strong></p><p id="67b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在是时候使用相同的工作表客户机API和我们刚刚收集的数据来填充我们已经创建的工作表了。我们将借此机会为工作表的列添加一些样式(更改顶行的字体大小并将其加粗) :</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="f06d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意数据和样式是如何用多个<code class="du ju jv jw jx b">requests</code>组合成一个单一的表API <code class="du ju jv jw jx b">batchUpdate</code>调用的。这有助于更有效的原子更新。</p><p id="b551" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还要注意，我们定义了一个与我们创建的工作表大小相匹配的编辑范围。这意味着超过26列的内容将因该特定代码而失败。</p><p id="5452" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果一切顺利，此时您可以:</p><ol class=""><li id="4f4d" class="kd ke hi ih b ii ij im in iq kf iu kg iy kh jc ks kj kk kl bi translated">保存更新的功能</li><li id="f166" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ks kj kk kl bi translated">将CSV文件放入桶中</li><li id="95bd" class="kd ke hi ih b ii km im kn iq ko iu kp iy kq jc ks kj kk kl bi translated">查看电子表格中弹出的相应数据！</li></ol><p id="ba70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">将所有内容放在一起并测试流程</em> </strong></p><p id="27c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对我们刚刚讨论的函数的调用可以在<code class="du ju jv jw jx b">csv2sheet</code>函数中进行，如下所示:阻塞新工作表的创建，然后阻塞从云存储中的数据检索。然后用数据填充工作表，并修改工作表的样式:</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="eff8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦一切就绪，只需将一个CSV文件上传到正确的存储桶，就可以看到您的电子表格被一个包含文件内容的新工作表更新。如果你手头没有的话，这里有一个<a class="ae je" href="https://storage.googleapis.com/alexismp-csv-demo/random-sales.csv" rel="noopener ugc nofollow" target="_blank">样本CSV文件</a></p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kt"><img src="../Images/6f78b4d01c6d29f6319a52feb5e90978.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aqmnRMJTflAh73ZS"/></div></div></figure><p id="d123" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尝试将几个文件上传到bucket，看看会发生什么！</p><p id="5c8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完整的函数源代码可在<a class="ae je" href="https://gist.github.com/alexismp/86315a74cdf887003b11f4ceade924de" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p></div></div>    
</body>
</html>