<html>
<head>
<title>App Engine Project Cleanup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">App Engine项目清理</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/app-engine-project-cleanup-9647296e796a?source=collection_archive---------0-----------------------#2018-11-20">https://medium.com/google-cloud/app-engine-project-cleanup-9647296e796a?source=collection_archive---------0-----------------------#2018-11-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e540" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a> (GCP)项目和<a class="ae jd" href="https://cloud.google.com/appengine/" rel="noopener ugc nofollow" target="_blank">应用引擎</a>服务和版本很容易创建，并且可能会激增。随着时间的推移，一些应用引擎服务和版本可能会依赖于云服务，这些云服务已经被<a class="ae jd" href="https://cloud.google.com/appengine/docs/deprecations/" rel="noopener ugc nofollow" target="_blank">弃用</a>。当废弃的服务最终关闭时，删除旧版本以防止混乱可能是一个好的做法。这篇文章将描述一些使用<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/" rel="noopener ugc nofollow" target="_blank"> gcloud </a>命令行工具清理项目的方法。</p><p id="e0c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目标受众是开发人员，他们希望在最终删除旧版本之前，通过一些人工审查来有效地管理相对较少的版本。一个重要的例子是不赞成使用的托管虚拟机(vm:true)运行时。在<a class="ae jd" href="https://cloud.google.com/appengine/docs/flexible/python/upgrading" rel="noopener ugc nofollow" target="_blank">升级到App Engine灵活环境最新版本</a>中讨论了向Flex的迁移。请注意，迁移到Flex需要一些代码更改。如果您不想进行任何代码更改，那么您可以考虑恢复到App Engine Standard，而不是迁移到Flex。</p><p id="8614" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当托管虚拟机首次发布时，它是第一个支持Nodejs的应用引擎运行时。所以，这篇文章中的例子使用了Nodejs。然而，这些想法和命令适用于所有运行时。</p><p id="460e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">先决条件</strong> <br/>你需要一个应用引擎应用程序的GCP项目。</p><p id="2e30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/config/set" rel="noopener ugc nofollow" target="_blank"> gcloud config set </a>命令在本地设置中设置默认项目</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="7dbb" class="jn jo hi jj b fi jp jq l jr js">PROJECT=[Your project]<br/>gcloud config set project $PROJECT</span></pre><p id="d443" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您还没有一个应用程序，或者想要创建一个测试应用程序，您可以<br/>使用下面的命令创建一个，使用来自应用程序引擎标准环境中的<a class="ae jd" href="https://cloud.google.com/nodejs/getting-started/hello-world" rel="noopener ugc nofollow" target="_blank"> Quickstart for Node.js的代码:</a></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="57da" class="jn jo hi jj b fi jp jq l jr js">git clone <a class="ae jd" href="https://github.com/GoogleCloudPlatform/nodejs-docs-samples" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/nodejs-docs-samples</a><br/>cd nodejs-docs-samples/appengine/hello-world/standard<br/>gcloud app deploy</span></pre><p id="de87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将部署一个Nodejs应用程序。测试您的应用程序是否可访问。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="7ba9" class="jn jo hi jj b fi jp jq l jr js">gcloud app browse</span></pre><p id="2756" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/app/deploy" rel="noopener ugc nofollow" target="_blank"> gcloud app deploy </a>命令现在已经取代了之前的<br/> <a class="ae jd" href="https://cloud.google.com/appengine/docs/standard/python/tools/appcfg-arguments" rel="noopener ugc nofollow" target="_blank"> appcfg </a>命令。</p><p id="c570" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们对包含代码的app.js文件进行更改，然后使用基本的gcloud app deploy命令再次部署<br/>应用，那么将会自动创建第二个版本。</p><p id="d1f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，改变线路</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="bac2" class="jn jo hi jj b fi jp jq l jr js">.send(‘Hello, world!’)</span></pre><p id="3680" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="7d56" class="jn jo hi jj b fi jp jq l jr js">.send(‘Hello, world 2!’)</span></pre><p id="0d88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和执行</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="297f" class="jn jo hi jj b fi jp jq l jr js">gcloud app deploy</span></pre><p id="1f4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">会自动创建新版本的应用程序。旧版本将被保留，但不再接收流量。这在短期内很方便，但会导致许多版本的积累。</p><p id="cfd4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要检查应用程序提供的默认页面，请执行以下命令</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="3b8b" class="jn jo hi jj b fi jp jq l jr js">curl $PROJECT.appspot.com</span></pre><p id="d117" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">发现服务和版本</strong>T3<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/app/" rel="noopener ugc nofollow" target="_blank">g cloud app</a>命令可以用来获得app的概况:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="013d" class="jn jo hi jj b fi jp jq l jr js">gcloud app describe</span></pre><p id="88cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要获取服务列表:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="8a1f" class="jn jo hi jj b fi jp jq l jr js">gcloud app services list</span></pre><p id="3f80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">描述一项服务</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="5859" class="jn jo hi jj b fi jp jq l jr js">gcloud app services describe default</span></pre><p id="728a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/app/versions/list" rel="noopener ugc nofollow" target="_blank"> gcloud app版本列表</a>命令给出了流量分流百分比和服务状态。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="e1f2" class="jn jo hi jj b fi jp jq l jr js">gcloud app versions list<br/>SERVICE VERSION TRAFFIC_SPLIT LAST_DEPLOYED SERVING_STATUS<br/>default 20181119t152033 0.00 2018–11–19T15:22:04–08:00 SERVING<br/>default 20181119t154106 1.00 2018–11–19T15:42:05–08:00 SERVING</span></pre><p id="3d4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/app/versions/describe" rel="noopener ugc nofollow" target="_blank">g cloud app versions describe</a>命令可用于识别应用运行时:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="d3bb" class="jn jo hi jj b fi jp jq l jr js">gcloud app versions describe --service default 20181010t161719<br/>…<br/>env: standard<br/>…<br/>servingStatus: SERVING<br/>…</span></pre><p id="e270" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">检查流量</strong> <br/>您可以通过以下命令读取日志来检查您的应用程序是否正在接收流量</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="8e10" class="jn jo hi jj b fi jp jq l jr js">gcloud app logs read</span></pre><p id="854d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">清理</strong> <br/>删除不提供任何流量的早期版本应用执行</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="5276" class="jn jo hi jj b fi jp jq l jr js">VERSION=20181119t152033<br/>gcloud app versions delete $VERSION</span></pre><p id="3f0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查版本是否已被删除</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="21ea" class="jn jo hi jj b fi jp jq l jr js">gcloud app versions list<br/>SERVICE VERSION TRAFFIC_SPLIT LAST_DEPLOYED SERVING_STATUS<br/>default 20181119t154106 1.00 2018–11–19T15:42:05–08:00 SERVING</span></pre><p id="d419" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">迁移</strong> <br/>假设我们有一些流量，想迁移到Flex。但是，我们希望在删除旧版本之前检查一切是否正常。让我们用Quickstart应用程序的Flex迁移对此进行测试。编辑app.yaml文件，用以下行替换App Engine标准环境中Node.js的<a class="ae jd" href="https://cloud.google.com/nodejs/getting-started/hello-world" rel="noopener ugc nofollow" target="_blank">快速入门的运行时行</a></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="0fd9" class="jn jo hi jj b fi jp jq l jr js">runtime: nodejs<br/>env: flex</span></pre><p id="3df7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后执行以下命令来部署新版本，但不向其发送流量</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="3e14" class="jn jo hi jj b fi jp jq l jr js">VERSION=flexversion<br/>gcloud app deploy --no-promote --version=$VERSION --quiet</span></pre><p id="0a0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，这个命令的变体使用版本标志给<br/>版本命名。它还使用quiet标志来避免gcloud询问需要人工响应的问题，这有利于自动化。</p><p id="fba6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查版本是否已部署，但未接收流量</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="79c7" class="jn jo hi jj b fi jp jq l jr js">gcloud app versions list<br/>SERVICE VERSION TRAFFIC_SPLIT LAST_DEPLOYED SERVING_STATUS<br/>default 20181119t154106 1.00 2018–11–19T15:42:05–08:00 SERVING<br/>default flexversion 0.00 2018–11–20T08:56:26–08:00 SERVING</span></pre><p id="53f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，新版本的流量分割为0.00，因此它提供服务，但没有流量发送到它。我们可以通过在URL中包含版本名称来测试特定的版本。举个例子，</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="c528" class="jn jo hi jj b fi jp jq l jr js">VERSION=flexversion<br/>curl $VERSION-dot-$PROJECT.appspot.com</span></pre><p id="630c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可能想进行更广泛的测试。您可以使用命令浏览到特定版本的应用程序</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="9b0c" class="jn jo hi jj b fi jp jq l jr js">gcloud app browse --version=$VERSION</span></pre><p id="d2d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您正在升级应用引擎标准版本，那么您可以使用以下命令将<br/>流量迁移到该版本</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="3f74" class="jn jo hi jj b fi jp jq l jr js">gcloud app versions migrate $VERSION --quiet</span></pre><p id="57f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，对于Flex，我们需要使用gcloud app deploy命令，现在升级版本。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="28fa" class="jn jo hi jj b fi jp jq l jr js">gcloud app deploy --version=$VERSION --quiet</span></pre><p id="d96e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以多次重新部署同一个版本。检查它现在是否是默认版本</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="b8f2" class="jn jo hi jj b fi jp jq l jr js">gcloud app versions list<br/>SERVICE VERSION TRAFFIC_SPLIT LAST_DEPLOYED SERVING_STATUS<br/>default 20181119t154106 0.00 2018–11–19T15:42:05–08:00 SERVING<br/>default flexversion 1.00 2018–11–20T09:41:33–08:00 SERVING</span></pre><p id="4c29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，新版本的流量分割现在为1.00。然后删除旧版本</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="3c9d" class="jn jo hi jj b fi jp jq l jr js">VERSION=20181119t154106<br/>gcloud app versions delete $VERSION --quiet</span></pre><p id="af7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">暂时关闭一个应用</strong> <br/>假设你不确定用户是否真的在使用你的应用。也许有一些流量的日志记录，但不清楚这是否是真正的使用。你<br/>可以用<a class="ae jd" href="https://cloud.google.com/sdk/gcloud/reference/app/versions/stop" rel="noopener ugc nofollow" target="_blank"> gcloud app versions stop </a>命令停止你的应用</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="3fff" class="jn jo hi jj b fi jp jq l jr js">VERSION=flexversion<br/>gcloud app versions stop $VERSION --quiet</span></pre><p id="7824" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查它是否已停止</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="9604" class="jn jo hi jj b fi jp jq l jr js">gcloud app versions list<br/>SERVICE VERSION TRAFFIC_SPLIT LAST_DEPLOYED SERVING_STATUS<br/>default flexversion 1.00 2018–11–20T09:41:33–08:00 STOPPED</span></pre><p id="08a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果需要，您可以再次启动</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="2304" class="jn jo hi jj b fi jp jq l jr js">gcloud app versions start $VERSION — quiet</span></pre><p id="15ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">更多自动化</strong> <br/>如果你有许多旧的应用程序版本或服务需要迁移和/或清理，你可能希望实现自动化。您应该考虑使用Google App Engine管理API，如<a class="ae jd" href="https://cloud.google.com/appengine/docs/admin-api/deploying-apps" rel="noopener ugc nofollow" target="_blank">将您的应用版本部署到应用引擎</a>中所述。</p></div></div>    
</body>
</html>