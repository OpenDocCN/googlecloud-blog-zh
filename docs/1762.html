<html>
<head>
<title>Google’s GCLB doesn't comply with RFCs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌的GCLB不符合RFC</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-doesnt-comply-with-rfcs-bc239b014b05?source=collection_archive---------1-----------------------#2021-01-18">https://medium.com/google-cloud/google-doesnt-comply-with-rfcs-bc239b014b05?source=collection_archive---------1-----------------------#2021-01-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/e8955436c8bd1cd36a3a9b287996fc23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*Y4usl2CSOYnnqKbYUNC1Ew.png"/></div></figure><p id="ef0a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当你在GCP谷歌云负载均衡器(GCLB)后面部署一个后端系统时，你可以使用TLS来保护它们之间的通信。定义HTTP over TLS如何工作的RFC是<a class="ae jk" href="https://tools.ietf.org/html/rfc2818" rel="noopener ugc nofollow" target="_blank"> RFC 2818 </a>。这个机制包括从服务器(在这个例子中是后端)向客户端(GCLB)发送一个证书进行验证。结果是我们没有验证那个证书。</p><h1 id="76d9" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">矛盾的情况</h1><p id="49f9" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">GCLB是我们的HTTP(s)负载平衡器。它是一个反向代理，因此外部用户连接在它上面终止，然后创建一个从GCLB到后端的新连接。您可以选择在此通信路径上启用TLS加密(HTTPs)。</p><p id="041c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在TLS交换中，数字证书及其对应的公钥用于生成会话密钥以保护连接。你可以在<a class="ae jk" href="https://tools.ietf.org/html/rfc5246" rel="noopener ugc nofollow" target="_blank"> RFC 5246 </a>和其他相关RFC中找到所有细节。在继续之前，这个证书需要由客户端验证，但是正如我们在我们的公共<a class="ae jk" href="https://cloud.google.com/load-balancing/docs/ssl-certificates/encryption-to-the-backends#secure_backend_protocol_considerations" rel="noopener ugc nofollow" target="_blank">文档</a>中声明的:</p><blockquote class="ko kp kq"><p id="4a5f" class="im in kr io b ip iq ir is it iu iv iw ks iy iz ja kt jc jd je ku jg jh ji jj hb bi translated">当GFE连接到谷歌云中的后端时，GFE接受您的后端提供的任何证书。gfe不执行证书验证。例如，即使在以下情况下，证书也被视为有效:<br/> -证书是自签名的。<br/> -证书由未知的证书颁发机构(CA)签署。<br/> -证书已过期或尚未生效。<br/>-<code class="du kv kw kx ky b">CN</code>和<code class="du kv kw kx ky b">subjectAlternativeName</code>属性与<code class="du kv kw kx ky b">Host</code>头或DNS PTR记录不匹配。</p><p id="540d" class="im in kr io b ip iq ir is it iu iv iw ks iy iz ja kt jc jd je ku jg jh ji jj hb bi translated">注意:GFE代表谷歌前端，实现GCLB的系统</p></blockquote><p id="7893" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">什么？怎么会这样Google的安全性是一流的，您的安全是我们的头等大事。然而，这似乎是矛盾的。它违背了RFC，它不检查服务器身份，并为中间人攻击敞开了大门！</p><p id="1e50" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我确信这可能会让一些人感到紧张，尤其是负责公司安全的安全团队。不要慌，我说过这是一个悖论，让我解释一下。</p><h1 id="c2f4" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">狂野的网</h1><p id="127f" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">TLS上的HTTP和数字证书主要用于保护Internet和WWW中的通信。当然，在内部网络中也有广泛的应用，但是WWW代表了一个更通用的(更广泛的)框架。</p><p id="bbb5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">例如，当用户访问他们的在线银行账户时，他们希望确保他们到达正确的服务器，并且他们的通信不能被解密，他们的数据不能被窃取。这不是一个容易实现的任务，因为有许多威胁存在:恶意软件，DNS欺骗，BGP劫持…</p><p id="4285" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了帮助完成这项任务，我们都使用了基于证书和TLS协议的安全框架。这为我们提供了很好的保护:</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es kz"><img src="../Images/6b19e9ce1fc99d2787bad665a4c7c1b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:764/format:webp/1*ZBgK2k-xOjpySDRIoHiBYQ.png"/></div></figure><p id="707b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们还没有完全安全，复杂的攻击可能会发生，但这大大提高了安全性。</p><h1 id="4b0f" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">一个新的场景</h1><p id="8cf7" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">在GCP运行后端服务器是一个与WWW完全不同的场景。您将看到改变威胁模型的显著差异。</p><p id="c7b7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，客户端(GCLB)和服务器(后端)运行在同一个网络中，这个网络由谷歌管理和保护。我们控制系统通信并正确路由流量。这意味着之前提到的一些威胁，尤其是那些与拦截流量相关的威胁，在我们的场景中并不适用。为了更好地理解GCP VPC网络如何路由流量，你可以阅读我的关于dmz的文章。</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es le"><img src="../Images/608d8c386f0afb733d156c0886dd435a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/1*NOgwGXPA8JsIlh7ip-1nRg.png"/></div></figure><p id="abdf" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在网络层，我们的虚拟网络验证GCP境内的所有流量。这种身份验证是通过安全令牌实现的，可以保护受损主机免受网络上的欺骗数据包的攻击。数据包直接从虚拟机发送到虚拟机，安全令牌包含发送方和接收方的身份验证信息。发送端的控制平面设置令牌，接收主机验证令牌。如果主机收到来自恶意发送方的数据包，或者不是发往该主机的数据包，该数据包就会被丢弃。</p><p id="1f3c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您关心多租户架构中受损系统的相关主题，您可能想阅读我关于<a class="ae jk" rel="noopener" href="/google-cloud/confidential-computing-is-cool-1d715cf47683">机密计算</a>的文章。</p><p id="be6a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当流量超出Google物理控制的设施时，我们会在网络层以类似于IPsec的方式进行加密，从而保护通过我们数据中心的客户流量。你可以在这个<a class="ae jk" href="https://cloud.google.com/security/encryption-in-transit" rel="noopener ugc nofollow" target="_blank">文档</a>中找到更多关于谷歌云中传输加密的细节。我建议您阅读它，以了解我们在保护基础架构和客户数据方面付出了多少努力。</p><p id="56ea" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请记住，您控制着注册到GCLB的后端。无论是在集群中运行的虚拟机还是pod，这都是客户GCP配置的一部分。谷歌和GCP的其他客户都不能修改这个组件。</p><h1 id="1855" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">结论</h1><p id="55a6" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">正如您所看到的，我们有一个安全的平台和几个替代机制来确保只有真正的后端可以与GCLB进行对话，这使得没有必要像通常要求的那样验证证书及其携带的身份。这也简化了客户的设计、实施和管理。</p><p id="9453" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">实际上，这符合RFC 2818，<a class="ae jk" href="https://tools.ietf.org/html/rfc2818#section-3.1" rel="noopener ugc nofollow" target="_blank">第3.1节</a>:</p><blockquote class="ko kp kq"><p id="4de3" class="im in kr io b ip iq ir is it iu iv iw ks iy iz ja kt jc jd je ku jg jh ji jj hb bi translated">如果客户端具有关于服务器的预期身份的外部信息，则可以省略主机名检查。</p></blockquote><p id="a658" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">安全不仅仅是检查一份安全清单。这可以帮助您进行组织，但是云已经改变了一些游戏规则，您需要分析和理解这种新的环境。我希望这篇文章能对你有所帮助！</p></div></div>    
</body>
</html>