<html>
<head>
<title>Ingress in Google Kubernetes Products</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Kubernetes产品的入口</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/ingress-in-google-kubernetes-products-f22ded21f4ed?source=collection_archive---------0-----------------------#2022-12-16">https://medium.com/google-cloud/ingress-in-google-kubernetes-products-f22ded21f4ed?source=collection_archive---------0-----------------------#2022-12-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/aaddc7b2b64b3d1e2e0d2e1a8c3915f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qs4OUGmey9hdVPhDBMCZKw.png"/></div></div></figure><div class=""/><p id="ca5a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是我试图总结和消除技术讨论中经常使用的术语，这些技术讨论围绕着将网络入口流量安排到运行在谷歌云(<a class="ae jo" href="https://cloud.google.com/kubernetes-engine/docs/concepts/kubernetes-engine-overview" rel="noopener ugc nofollow" target="_blank">【GKE】</a>)或内部部署(<a class="ae jo" href="https://cloud.google.com/anthos/clusters/docs/bare-metal/latest/concepts/about-bare-metal" rel="noopener ugc nofollow" target="_blank"> Anthos on Bare Metal </a>，<a class="ae jo" href="https://cloud.google.com/anthos/clusters/docs/on-prem/latest/overview" rel="noopener ugc nofollow" target="_blank"> Anthos on VMware </a>)的[单个] Kubernetes集群。</p><p id="e9fb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面的小目录应该会引导您直接找到感兴趣的部分。</p><ul class=""><li id="74e7" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><a class="ae jo" href="#bb7b" rel="noopener ugc nofollow">选项细分</a></li><li id="df2a" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="#48d0" rel="noopener ugc nofollow">服务</a><a class="ae jo" href="#73aa" rel="noopener ugc nofollow">GKE</a>|<a class="ae jo" href="#e92f" rel="noopener ugc nofollow">Anthos</a>|<a class="ae jo" href="#40c3" rel="noopener ugc nofollow">TLS</a>|<a class="ae jo" href="#5020" rel="noopener ugc nofollow">举例</a></li><li id="92c3" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="#ac05" rel="noopener ugc nofollow">入口</a><a class="ae jo" href="#d3f7" rel="noopener ugc nofollow">GKE</a>|<a class="ae jo" href="#08eb" rel="noopener ugc nofollow">Anthos</a>|<a class="ae jo" href="#9fdb" rel="noopener ugc nofollow">TLS</a>|<a class="ae jo" href="#e81c" rel="noopener ugc nofollow">举例</a></li><li id="89d0" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="#cf3b" rel="noopener ugc nofollow">网关</a><a class="ae jo" href="#134a" rel="noopener ugc nofollow">GKE</a>| |<a class="ae jo" href="#f3f4" rel="noopener ugc nofollow">TLS</a>|<a class="ae jo" href="#bc1f" rel="noopener ugc nofollow">举例</a></li><li id="95f4" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="#e263" rel="noopener ugc nofollow">Istio Gateway</a><a class="ae jo" href="#c3e2" rel="noopener ugc nofollow">GKE</a>|<a class="ae jo" href="#9fe0" rel="noopener ugc nofollow">安托斯</a> | <a class="ae jo" href="#2d5e" rel="noopener ugc nofollow"> TLS </a> | <a class="ae jo" href="#63a5" rel="noopener ugc nofollow">举例</a></li><li id="b985" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="#5a14" rel="noopener ugc nofollow">负控制器</a><a class="ae jo" href="#4177" rel="noopener ugc nofollow">GKE</a>| |<a class="ae jo" href="#e70b" rel="noopener ugc nofollow">TLS</a>|<a class="ae jo" href="#137d" rel="noopener ugc nofollow">示例</a></li></ul><p id="d5fa" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您需要多少次将Kubernetes集群连接到外部世界，使其可以从公共互联网或您的组织内部访问，同时保持其安全性并保持对设置的控制？</p><p id="4a10" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当这种讨论开始时，往往并不清楚有哪些选择。部件名称的<strong class="is hu"><em class="kd"/></strong>和<strong class="is hu"> <em class="kd">过载术语</em> </strong>在很大程度上造成了混乱。</p><p id="0584" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kd">“我们将建立一个入口”</em> —等等，你是指一个特定的实现吗？这将在哪个系统中发生？这就是所有需要的吗？</p><p id="679e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kd">“TLS将在网关处终止”</em> —您指的是哪种网关？你确定这符合你们共同的TLS要求吗？</p><p id="d95c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kd">“谁将拥有团队中的网络入口？”— </em>我在这里指的是什么？</p><p id="d6c0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kd">“我们需要关注前面的负载均衡器吗？”— </em>关于这一点还有更多选择！</p><p id="d4fb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我经常参与这样的讨论。</p><p id="f8da" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">浏览相当模糊的术语和景观的一种方法是列出所有可能的变体并将其结构化。一旦所有可能的选项都被列出并组织好，就有可能在同一页上着陆并减少混乱。</p><p id="a03f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我将尝试提供一个简明的参考，包括这些术语的多重含义、简短的基础设施设计模式图和示例配置片段。</p><h1 id="bb7b" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">选项细分</h1><p id="3a78" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">通过按产品口味对网络流量入口选项列表进行分类，可以方便地启动它们。</p><p id="236b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">可用选项和短期含义取决于我们是在谷歌云(GKE服务)的环境中还是在谷歌云之外的Anthos集群中。<a class="ae jo" href="https://cloud.google.com/service-mesh/docs/overview" rel="noopener ugc nofollow" target="_blank"> Anthos服务网格</a> (ASM)是否可用和/或是否需要。</p><p id="4c9d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，并非所有选项都提供了设置完全成熟的相互TLS身份验证的机会。此类选项下面标有黄色问号。</p><figure class="li lj lk ll fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lh"><img src="../Images/e1f8e7a09bf6f2c1015446c5a28660b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9UEtRTR4ZcMx-LxoEmOGOg.png"/></div></div></figure><p id="bceb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是表中选项的网络流量摘要(双箭头表示可能的相互TLS设置，单箭头表示单向TLS连接):</p><figure class="li lj lk ll fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lm"><img src="../Images/95653821ff0d741921bb17da4dc9c97b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GJnw4_1SgdcWGCYPAJ0AIA.png"/></div></div></figure><p id="86e8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在将更详细地研究每一个问题。</p><h1 id="48d0" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">服务</h1><p id="64f4" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated"><a class="ae jo" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank"> Kubernetes服务</a>资源提供了定义负载平衡器类型的Kubernetes服务的选项。Kubernetes集群外部的系统负责通过查看Kubernetes服务定义来配置Kubernetes集群外部的基础设施资源。</p><p id="fc5a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通常，在这种情况下，应用服务端点直接暴露给传入(L4)流量。因此，TLS由应用程序本身终止。</p><p id="5db9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果应用程序已经有了自己的特殊组件，可以接受TLS连接并将它们路由到其他应用程序组件，那么这个选项就很有用。</p><figure class="li lj lk ll fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ln"><img src="../Images/353ea2451dd55d895651e05b2c02dc1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-ajcU50KY7627Y3g"/></div></div></figure><h1 id="73aa" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">服务— GKE</h1><p id="d5d0" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">在GKE，负载平衡器服务类型自动管理Google Cloud L4 TCP负载平衡器资源。它们将由谷歌云自动创建。</p><h1 id="e92f" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">服务— Anthos</h1><p id="ab58" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">在裸机上的Anthos中，LoadBalancer服务可以自动管理捆绑的MetalLB负载平衡器，它是Anthos安装的一部分，由运行在集群主节点上的软件组件表示。</p><h1 id="40c3" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">服务— TLS</h1><p id="9fda" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">TLS证书需要在应用服务本身中配置，例如使用<a class="ae jo" href="https://cert-manager.io/docs/" rel="noopener ugc nofollow" target="_blank"> cert-manager </a>和<a class="ae jo" href="https://github.com/jetstack/google-cas-issuer" rel="noopener ugc nofollow" target="_blank"> Google CAS Issuer </a>发布的证书。这些最终存储在Kubernetes Secrets中，通常安装在应用程序盒中。</p><h1 id="5020" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">服务—示例</h1><pre class="li lj lk ll fd lo lp lq bn lr ls bi"><span id="7297" class="lt kf ht lp b be lu lv l lw lx">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: my-service<br/>spec:<br/>  selector:<br/>    app.kubernetes.io/name: MyApp<br/>  ports:<br/>    - protocol: TCP<br/>      port: 443<br/>      targetPort: 9376<br/>  clusterIP: 10.0.171.239<br/>  type: LoadBalancer<br/>status:<br/>  loadBalancer:<br/>    ingress:<br/>    - ip: 192.0.2.127</span></pre><h1 id="ac05" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">进入</h1><p id="439d" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated"><a class="ae jo" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank"> Kubernetes Ingress </a>是一个API对象，管理对集群中服务的外部访问，通常是HTTP。Ingress可以提供负载平衡、SSL终止和基于名称的虚拟主机。</p><p id="7680" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一个<a class="ae jo" href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" rel="noopener ugc nofollow" target="_blank">入口控制器</a>负责完成入口。</p><p id="56e0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Kubernetes入口资源的局限性包括:</p><ul class=""><li id="8de9" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">无法配置入口代理和应用程序后端服务之间的相互TLS连接(Kubernetes资源定义中缺少相应的设置)</li><li id="1f37" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">包含负载平衡器和路由配置的单一入口资源不支持多租户环境中的问题分离和灵活访问配置(所有问题由一个团队负责)</li><li id="7a8b" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">在Istio入口控制器(默认情况下存在于ABM安装中)的情况下，也不可能使用TLS和加密反向代理和应用服务之间的网络流量</li></ul><p id="22e4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于其局限性，Kubernetes Ingresses的使用正逐步被劝阻，而倾向于下一章描述的Kubernetes网关资源。</p><h1 id="d3f7" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">入口— GKE</h1><p id="1082" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">在GKE，<a class="ae jo" href="https://cloud.google.com/kubernetes-engine/docs/concepts/ingress" rel="noopener ugc nofollow" target="_blank"> GKE入口控制器</a>自动管理谷歌云L7外部和L7内部负载平衡器资源。</p><p id="a699" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">传入的L7 TLS连接在GCE L7外部负载平衡器或L7区域内部负载平衡器处终止。GCE负载平衡器将传入流量转发到Kubernetes集群节点。</p><p id="f592" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/kubernetes-engine/docs/concepts/ingress#container-native_load_balancing" rel="noopener ugc nofollow" target="_blank">可以在目标Kubernetes服务对象上配置容器本地负载均衡</a>，使GCE负载均衡器将流量直接转发到pods，而不是节点端口。</p><figure class="li lj lk ll fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ln"><img src="../Images/f8d11d57e2d17c6459129314deb8d998.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uMwhIuV8iKQlOyRS"/></div></div></figure><h1 id="08eb" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">入口— Anthos</h1><p id="d0d9" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">在ABM中，<a class="ae jo" href="https://istio.io/latest/docs/tasks/traffic-management/ingress/kubernetes-ingress/" rel="noopener ugc nofollow" target="_blank"> Istio Ingress控制器</a>的默认开箱即用安装提供了一个将Istio Ingress代理进程作为Kubernetes工作负载进行自动管理的选项。不幸的是，这种开箱即用的选项具有上面列出的所有Kubernetes入口限制。</p><p id="e055" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了配置入口代理进程和具有相互TLS的应用后端服务之间的下游连接，可以可选地使用支持这种实现的Istio入口实现。其中一个实现是<a class="ae jo" href="https://docs.nginx.com/nginx-ingress-controller/" rel="noopener ugc nofollow" target="_blank"> Nginx入口控制器</a>，它可以通过自定义Kubernetes资源注释配置TLS下游连接加密和TLS客户端证书。</p><figure class="li lj lk ll fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ly"><img src="../Images/e027eac8d4371af7585cfbc266110417.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K2AtifTxwdHQXtAPdlfHyw.png"/></div></div></figure><h1 id="9fdb" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">入口— TLS</h1><p id="fa35" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">TLS配置(如入口代理服务器和客户端证书)是在Kubernetes入口资源定义中直接配置的，也可以通过附加的自定义Kubernetes资源注释进行配置。</p><p id="736c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Kubernetes入口既可以使用TLS证书，也可以使用来自类型为<code class="du lz ma mb lp b">tls</code>的被引用的Kubernetes秘密资源的私钥。在这种情况下，带有TLS证书和密钥的Kubernetes秘密可以由<a class="ae jo" href="https://cert-manager.io/docs/" rel="noopener ugc nofollow" target="_blank">证书管理器</a>和<a class="ae jo" href="https://github.com/jetstack/google-cas-issuer" rel="noopener ugc nofollow" target="_blank"> Google CAS发行者</a>管理。</p><p id="6786" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者，<a class="ae jo" href="https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-multi-ssl#pre-shared-certs" rel="noopener ugc nofollow" target="_blank">可以</a>在<code class="du lz ma mb lp b">ingress.gcp.kubernetes.io/pre-shared-cert</code> Kubernetes入口注释中指定GCE SSL证书资源名称。然后，将使用引用的预配置SSL证书来配置负载平衡器。</p><h1 id="e81c" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">入口—示例</h1><pre class="li lj lk ll fd lo lp lq bn lr ls bi"><span id="c1cc" class="lt kf ht lp b be lu lv l lw lx">apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: ingress-myservicea<br/>  annotations:<br/>    cert-manager.io/issuer: "letsencrypt-staging"<br/>spec:<br/>  tls:<br/>    - hosts:<br/>        - ingress-demo.example.com<br/>      secretName: ingress-demo-tls<br/>  rules:<br/>  - host: myservicea.foo.org<br/>    http:<br/>      paths:<br/>      - path: /<br/>        pathType: Prefix<br/>        backend:<br/>          service:<br/>            name: myservicea<br/>            port:<br/>              number: 80<br/>  ingressClassName: nginx</span></pre><h1 id="cf3b" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">门</h1><p id="170b" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated"><a class="ae jo" href="https://gateway-api.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes Gateway </a>是在Kubernetes中建模服务网络的资源集合(GatewayClass、Gateway、HTTPRoute、TCPRoute、service等。).</p><p id="61d9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Kubernetes Gateway是Kubernetes Ingress的最新替代产品，解决了其缺点和局限性，并鼓励在未来取代Kubernetes Ingress。</p><figure class="li lj lk ll fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ln"><img src="../Images/53ed2c369eba06a056e46e6820c9f19e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Rx-LET3fcKs9t57O"/></div></div></figure><h1 id="134a" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">门户— GKE</h1><p id="6ec6" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">在GKE，Kubernetes网关是由GKE网关控制器实现的。通过其Kubernetes资源配置，可以自动管理:</p><ul class=""><li id="cae5" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><code class="du lz ma mb lp b">gke-l7-rilb</code> <em class="kd"> </em>建立在<a class="ae jo" href="https://cloud.google.com/load-balancing/docs/l7-internal" rel="noopener ugc nofollow" target="_blank">内部HTTP(S)负载均衡</a>之上的区域性内部HTTP(S)负载均衡器</li><li id="7a5b" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du lz ma mb lp b">gke-l7-gxlb</code> <em class="kd"> </em>基于<a class="ae jo" href="https://cloud.google.com/load-balancing/docs/https" rel="noopener ugc nofollow" target="_blank">全局外部HTTP(S)负载平衡器(经典)的全局外部HTTP(S)负载平衡器</a></li><li id="ccc1" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du lz ma mb lp b">gke-l7-rilb-mc</code> <em class="kd"> </em>建立在<a class="ae jo" href="https://cloud.google.com/load-balancing/docs/l7-internal" rel="noopener ugc nofollow" target="_blank">内部HTTP(S)负载均衡</a>上的多集群区域负载均衡器</li><li id="5ba5" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du lz ma mb lp b">gke-l7-gxlb-mc</code> <em class="kd"> </em>基于<a class="ae jo" href="https://cloud.google.com/load-balancing/docs/https" rel="noopener ugc nofollow" target="_blank">全局外部HTTP(S)负载平衡器(经典)</a>的多集群全局负载平衡器</li><li id="2282" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du lz ma mb lp b">gke-td</code> <em class="kd"> </em>多集群<a class="ae jo" href="https://cloud.google.com/traffic-director/docs/gke-gateway-overview" rel="noopener ugc nofollow" target="_blank">交通主管服务网</a></li></ul><p id="bab8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Anthos服务网格提供了<a class="ae jo" href="https://cloud.google.com/service-mesh/docs/managed/service-mesh-cloud-gateway" rel="noopener ugc nofollow" target="_blank"> ASM云网关控制器</a>的预览。除了前面列出的Kubernetes网关类型之外，它还引入了</p><ul class=""><li id="59c6" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><code class="du lz ma mb lp b">asm-l7-xlb</code> <em class="kd"> </em>用于构建在<a class="ae jo" href="https://cloud.google.com/load-balancing/docs/https" rel="noopener ugc nofollow" target="_blank">全局外部HTTP(S)负载平衡器(经典)</a>之上的全局外部HTTP(S)负载平衡器</li></ul><p id="280f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">ASM云网关通过<a class="ae jo" href="https://gateway-api.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes网关API </a>提供统一的方式来配置Anthos服务网格入口网关和<a class="ae jo" href="https://cloud.google.com/load-balancing" rel="noopener ugc nofollow" target="_blank">云负载平衡</a>。部署此ASM网关API对象时，将发生以下情况:</p><ul class=""><li id="7f62" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">部署并配置了外部HTTP(S)负载平衡器。它可能需要几分钟才能启动，但当它启动时，网关会指示IP地址，并会用所创建的计算引擎负载平衡器资源的名称进行注释。</li><li id="55ef" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">在istio-ingress命名空间中创建一个Anthos服务网格入口网关部署。这将创建从云负载平衡器接收流量的特使代理实例。</li><li id="869d" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">云负载平衡器将加密所有流量并将其路由到Anthos服务网格入口网关。</li></ul><h1 id="f3f4" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">网关— TLS</h1><p id="3db1" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">Kubernetes网关管理的负载平衡器的TLS证书和密钥可以通过以下方法提供</p><ul class=""><li id="9b9c" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><a class="ae jo" href="https://cloud.google.com/kubernetes-engine/docs/concepts/gateway-security#kubernetes-secrets" rel="noopener ugc nofollow" target="_blank"> Kubernetes Secrets </a> —可由证书管理器和谷歌CAS发行者提供和管理</li><li id="d36f" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="https://cloud.google.com/kubernetes-engine/docs/concepts/gateway-security#ssl-certificates" rel="noopener ugc nofollow" target="_blank"> SSL证书</a> —可以独立于GKE集群进行预配置(例如使用Terraform)</li><li id="b3ba" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><a class="ae jo" href="https://cloud.google.com/kubernetes-engine/docs/concepts/gateway-security#certificate-manager" rel="noopener ugc nofollow" target="_blank">证书管理器</a></li></ul><h1 id="bc1f" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">网关—示例</h1><pre class="li lj lk ll fd lo lp lq bn lr ls bi"><span id="7a2f" class="lt kf ht lp b be lu lv l lw lx">kind: Gateway<br/>apiVersion: gateway.networking.k8s.io/v1beta1<br/>metadata:<br/>  name: my-gateway<br/>spec:<br/>  gatewayClassName: gke-l7-rilb<br/>  listeners:<br/>  - name: https<br/>    protocol: https<br/>    port: 443<br/>    tls:<br/>      mode: Terminate<br/>      options:<br/>        networking.gke.io/pre-shared-certs: store-example-com<br/>---<br/>apiVersion: gateway.networking.k8s.io/v1beta1<br/>kind: HTTPRoute<br/>metadata:<br/>  name: httproute-example<br/>spec:<br/>  parentRefs:<br/>  - name: my-gateway<br/>  hostnames:<br/>  - my.example.com<br/>  rules:<br/>  - matches:<br/>    - path:<br/>        type: PathPrefix<br/>        value: /bar<br/>    backendRefs:<br/>    - name: my-service1<br/>      port: 8080</span></pre><p id="5b75" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意单独的Kubernetes资源“Gateway”和“HTTPRoute ”,它们定义了Kubernetes网关的不同方面。这种分离允许关注点的分离和职责的分离。具有不同访问权限的不同团队现在可以负责管理入口网络流量的外部和内部方面。</p><h1 id="e263" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">Istio网关</h1><p id="89bf" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">当<a class="ae jo" href="https://cloud.google.com/service-mesh/docs/overview" rel="noopener ugc nofollow" target="_blank"> Anthos服务网格</a> (ASM)在Kubernetes集群中安装并可用时，它提供自己的方式来管理和组织进入服务网格的网络流量。</p><p id="7a37" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">ASM引入了Istio Gateway Kubernetes资源和组件。它不同于上一节中描述的Kubernetes网关资源对象。</p><p id="c945" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Anthos服务网格为您提供了部署和管理<a class="ae jo" href="https://cloud.google.com/service-mesh/docs/gateways" rel="noopener ugc nofollow" target="_blank"> Istio网关</a>的选项，作为您服务网格的一部分。网关描述了在网格边缘运行的负载平衡器，接收传入或传出的HTTP/TCP连接。网关是特使代理，为您提供对进出网格的流量的细粒度控制。网关主要用于管理入站流量，但是您也可以配置网关来管理其他类型的流量。</p><p id="a8ea" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">向外部客户端公开Istio网关有多种方式。在这篇<a class="ae jo" href="https://cloud.google.com/architecture/exposing-service-mesh-apps-through-gke-ingress" rel="noopener ugc nofollow" target="_blank">公开文章</a>中很好地描述了在GKE集群中运行的ASM网格的所有选项。</p><h1 id="c3e2" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">Istio Gateway — GKE</h1><p id="8b0a" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">向外部客户机公开运行在GKE集群中的ASM网格的基本方法是使用Kubernetes服务对象，如下图所示。在GKE上创建一个负载平衡器类型的Kubernetes服务资源对象会自动创建相应的Google Cloud L4负载平衡器。</p><figure class="li lj lk ll fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ln"><img src="../Images/714c149a25c23879b3f915f8babdada7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_yK2WpoIgbgobjGM"/></div></div></figure><p id="ba99" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，Anthos服务网格可以与<a class="ae jo" href="https://cloud.google.com/certificate-authority-service" rel="noopener ugc nofollow" target="_blank">认证中心服务</a>集成，作为网格工作负载证书的来源。</p><h1 id="9fe0" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">Istio网关— Anthos</h1><p id="543e" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">还需要一个Kubernetes服务资源对象来公开运行在Anthos on Bare Metal (ABM)集群中的ASM网格。由ABM组件自动控制的负载平衡器的类型取决于<a class="ae jo" href="https://cloud.google.com/anthos/clusters/docs/bare-metal/latest/installing/load-balance" rel="noopener ugc nofollow" target="_blank">集群安装配置</a>:</p><ul class=""><li id="7ec8" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">捆绑L2负载平衡</li><li id="f2ad" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">与BGP捆绑的L3负载平衡</li><li id="58dc" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">手动负载平衡</li></ul><p id="3eff" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下图说明了公开在ABM集群中运行的ASM网格所需的Kubernetes组件。</p><figure class="li lj lk ll fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mc"><img src="../Images/45b6901521e7f974dbd2510614c63682.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LYZjs5dogUXMyZUF17ySTA.png"/></div></div></figure><h1 id="2d5e" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">Istio网关— TLS</h1><p id="fe35" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">GKE和ABM上的ASM安装可以配置由Google<a class="ae jo" href="https://cloud.google.com/certificate-authority-service/docs" rel="noopener ugc nofollow" target="_blank">Certificate Authority Service</a>(CAS)提供的TLS证书。</p><p id="6ac3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">ASM可以在安装过程中配置CAS资源名称，并在运行时自动管理工作负载TLS证书生命周期，从提供的CAS服务池或实例中获取它们。</p><h1 id="63a5" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">例子</h1><pre class="li lj lk ll fd lo lp lq bn lr ls bi"><span id="b8e6" class="lt kf ht lp b be lu lv l lw lx">apiVersion: networking.istio.io/v1beta1<br/>kind: Gateway<br/>metadata:<br/>  name: frontend-gateway<br/>  namespace: frontend<br/>spec:<br/>  selector:<br/>    istio: ingressgateway<br/>  servers:<br/>  - port:<br/>      number: 443<br/>      name: https<br/>      protocol: HTTPS<br/>    hosts:<br/>    - ext-host.example.com<br/>    tls:<br/>      mode: SIMPLE<br/>      credentialName: ext-host-cert  # Kubernetes Secret name<br/>---<br/>apiVersion: networking.istio.io/v1beta1<br/>kind: VirtualService<br/>metadata:<br/>  name: frontend-ingress<br/>  namespace: frontend<br/>spec:<br/>  hosts:<br/>  - "*"<br/>  gateways:<br/>  - frontend-gateway<br/>  http:<br/>  - route:<br/>    - destination:<br/>        host: frontend<br/>        port:<br/>          number: 80</span></pre><p id="4210" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意我们在<a class="ae jo" href="#bc1f" rel="noopener ugc nofollow"> Kubernetes Gateway </a>部分看到的类似的cons分离级别。</p><h1 id="5a14" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">GKE NEG和AutoNEG控制器</h1><h1 id="4177" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">负控制器— GKE</h1><p id="3b96" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">GKE提供了一个<a class="ae jo" href="https://cloud.google.com/kubernetes-engine/docs/how-to/standalone-neg" rel="noopener ugc nofollow" target="_blank"> NEG控制器</a>来管理<code class="du lz ma mb lp b">GCE_VM_IP_PORT</code>网络端点组(NEG)的成员资格。您可以将它创建的neg作为后端添加到您在GKE API之外配置的负载平衡器的后端服务中。</p><p id="a09d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">带有<a class="ae jo" href="https://cloud.google.com/kubernetes-engine/docs/how-to/standalone-neg#use_cases_of_standalone_negs" rel="noopener ugc nofollow" target="_blank">独立NEGs </a>的NEG控制器涵盖了由Kubernetes Ingress自动创建的负载平衡器组件不服务于您的用例的情况。</p><p id="fc42" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">额外的<a class="ae jo" href="https://github.com/GoogleCloudPlatform/gke-autoneg-controller" rel="noopener ugc nofollow" target="_blank"> Autoneg控制器</a>在GKE和谷歌云负载平衡(外部和内部)之间提供简单的定制集成。这是一个GKE特有的Kubernetes控制器，它与GKE网络端点组(NEG)控制器协同工作，管理您的Kubernetes服务端点和GCLB后端服务之间的集成。</p><p id="dd0e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">GKE用户可能希望将来自多个集群的NEG后端注册到同一个后端服务中，或者可能希望以定制或集中的方式编排高级部署策略，或者通过受保护的公共端点和更宽松的内部端点提供相同的服务。Autoneg控制器可以支持这些用例。</p><figure class="li lj lk ll fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es md"><img src="../Images/49f416899c92e89ec9fa1db0d1a089ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fNwNDCdk1OJeI3lg"/></div></div></figure><p id="543b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> <em class="kd">使用NEG控制器和Kubernetes服务资源的好处</em> </strong>是能够进一步分离负责网络流量进入云的团队的职责，包括负载平衡器和有权访问并负责Kubernetes内部资源和工作负载的团队。</p><figure class="li lj lk ll fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es me"><img src="../Images/868048846819912c361dc7bf0ae1d7e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jC1IZK60UVV5_VO5LBLlow.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">基于NEG控制器的网络入口组件</figcaption></figure><p id="d2af" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过使用选择的基础设施即代码(IaC)系统(例如Terraform)和Kubernetes资源经由声明性的Kubernetes API来提供云资源，可以建立网络入口。</p><h1 id="e70b" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">负控制器— TLS</h1><p id="820c" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">在这个场景中，TLS连接由Google Cloud负载平衡器处理和终止。使用NEG Controller，可以重用负载平衡器组件，并将它们连接到Kubernetes集群资源中定义的Kubernetes服务。</p><p id="534f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这种情况下，TLS证书和私钥可以在Kubernetes集群之外进行管理，遵循现有的Terraform IaC方式或基于Google Cloud API的自动化。在这种情况下，Kubernetes资源不会导致负载平衡器组件以可能破坏地形状态的方式进行修改。</p><h1 id="137d" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">负控制器—示例</h1><pre class="li lj lk ll fd lo lp lq bn lr ls bi"><span id="56fe" class="lt kf ht lp b be lu lv l lw lx">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: my-service<br/>  annotations:<br/>    cloud.google.com/neg: '{"exposed_ports": {"80":{},"443":{}}}'<br/>    controller.autoneg.dev/neg: '{"backend_services":{"80":[{"name":"http-be","max_rate_per_endpoint":100}],"443":[{"name":"https-be","max_connections_per_endpoint":1000}]}}<br/>    # For L7 ILB (regional) backends <br/>    # controller.autoneg.dev/neg: '{"backend_services":{"80":[{"name":"http-be","region":"europe-west4","max_rate_per_endpoint":100}],"443":[{"name":"https-be","region":"europe-west4","max_connections_per_endpoint":1000}]}}<br/>spec:<br/>  selector:<br/>    app.kubernetes.io/name: MyApp<br/>  ports:<br/>    - protocol: TCP<br/>      port: 443<br/>      targetPort: 9376<br/>  clusterIP: 10.0.171.239<br/>  type: LoadBalancer<br/>status:<br/>  loadBalancer:<br/>    ingress:<br/>    - ip: 192.0.2.127</span></pre><h1 id="e3ae" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">结论</h1><p id="9271" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">你注意到一个错误吗？有一个有趣的或新的解决方案来安排网络进入Kubernetes集群吗？将很高兴学习和修改列表。请评论并PM我！</p></div></div>    
</body>
</html>