<html>
<head>
<title>How to properly install Knative on GKE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在GKE上正确安装Knative</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-properly-install-knative-on-gke-f39a1274cd4f?source=collection_archive---------1-----------------------#2020-01-13">https://medium.com/google-cloud/how-to-properly-install-knative-on-gke-f39a1274cd4f?source=collection_archive---------1-----------------------#2020-01-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5932" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌Kubernete引擎(GKE)的默认安装<a class="ae jd" href="https://knative.dev/docs/install/knative-with-gke/" rel="noopener ugc nofollow" target="_blank">指令</a>有问题(见bug <a class="ae jd" href="https://github.com/knative/eventing/issues/2266" rel="noopener ugc nofollow" target="_blank"> 2266 </a>)。在这篇文章中，我想概述一下问题是什么，告诉你我做了什么，并向你提供适合我的脚本，直到在gcloud或Knative中实现了一个适当的解决方案。</p><h1 id="520e" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">问题是</h1><p id="9641" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">默认的Knative安装说明告诉您创建一个GKE集群，如下所示:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="0d4a" class="kq jf hi km b fi kr ks l kt ku">gcloud beta container clusters create $CLUSTER_NAME \<br/>  --addons<strong class="km hj">=</strong>HorizontalPodAutoscaling,HttpLoadBalancing,<strong class="km hj">Istio</strong> \<br/>  --machine-type<strong class="km hj">=</strong>n1-standard-4 \<br/>  --cluster-version<strong class="km hj">=</strong>latest --zone<strong class="km hj">=</strong>$CLUSTER_ZONE \<br/>  --enable-stackdriver-kubernetes --enable-ip-alias \<br/>  --enable-autoscaling --min-nodes<strong class="km hj">=1</strong> --max-nodes<strong class="km hj">=10</strong> \<br/>  --enable-autorepair \<br/>  --scopes cloud-platform</span></pre><p id="6c26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意Istio附加组件。这个命令创建一个已经安装了Istio的Kubernetes集群。这很好，因为Istio是Knative的依赖项，但请继续阅读。</p><p id="8b05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后，您继续安装Knative Serving和Knative Eventing。在这一点上，Knative服务将工作良好。然而，你会有Knative Eventing的问题。</p><p id="d269" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我在之前的<a class="ae jd" rel="noopener" href="/google-cloud/cluster-local-issue-with-knative-eventing-v0-9-0-a1fee2215cfe">帖子</a>中解释的，在Knative Eventing中，你不能使用Knative服务作为事件接收器。例如，你不能让Knative服务通过Knative Eventing接收Google Cloud发布/订阅消息(一个纯Kubernetes服务可以工作)。</p><p id="d58f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为什么？因为您需要安装一个集群本地网关来将事件路由到Knative服务。Knative文档有一个<a class="ae jd" href="https://knative.dev/docs/install/installing-istio/#updating-your-install-to-use-cluster-local-gateway" rel="noopener ugc nofollow" target="_blank">页面</a>解释如何安装它。但是，它已经过时了，依赖于Helm。也许只是我，但是我不能使用那些指令使它工作。</p><h1 id="a3be" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">初始无解</h1><p id="7764" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在我之前的<a class="ae jd" rel="noopener" href="/google-cloud/cluster-local-issue-with-knative-eventing-v0-9-0-a1fee2215cfe">帖子</a>中，我提供了一个初步的解决方案，这个方案有点儿有效，但是现在不再有效了。概括地说，我谈到了Knative Serving中的一个第三方文件夹。在这个文件夹中，有几个版本的Istio文件夹(目前是1.3.6和1.4.2)。在这些文件夹中，有一个<code class="du kv kw kx km b">istio-knative-extras.yaml</code>文件，您可以应用它来安装集群本地网关。</p><p id="1b57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">然而，这已经不起作用了，因为GKE的Istio附加版本远远落后于1.3.6。</strong> Knative更新Istio版本的速度似乎比GKE插件更新的速度还要快。</p><h1 id="dff7" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">我的解决方案</h1><p id="dabb" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我的解决方案是基本上不再依赖GKE Istio附加软件。相反，我依赖于Knative的<a class="ae jd" href="https://github.com/knative/serving/tree/master/third_party" rel="noopener ugc nofollow" target="_blank">第三方</a>文件夹中的Istio版本，并使用其中的yaml文件安装我想要的Istio版本。同一个文件夹中还有用于安装集群本地网关的yaml文件。</p><h2 id="1981" class="kq jf hi bd jg ky kz la jk lb lc ld jo iq le lf js iu lg lh jw iy li lj ka lk bi translated">创建没有Istio插件的GKE集群</h2><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="9951" class="kq jf hi km b fi kr ks l kt ku">gcloud beta container clusters create $CLUSTER_NAME \<br/>--addons HorizontalPodAutoscaling,HttpLoadBalancing \<br/>--zone $CLUSTER_ZONE \<br/>--cluster-version $CLUSTER_MASTER_VERSION \<br/>--machine-type $CLUSTER_NODE_MACHINE_TYPE \<br/>--num-nodes $CLUSTER_START_NODE_SIZE \<br/>--min-nodes 1 \<br/>--max-nodes $CLUSTER_MAX_NODE_SIZE \<br/>--enable-ip-alias \<br/>--enable-stackdriver-kubernetes \<br/>--enable-autoscaling \<br/>--enable-autorepair \<br/>--scopes cloud-platform</span></pre><h2 id="13de" class="kq jf hi bd jg ky kz la jk lb lc ld jo iq le lf js iu lg lh jw iy li lj ka lk bi translated">使用来自Knative Serving的yaml文件手动安装Istio</h2><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="3032" class="kq jf hi km b fi kr ks l kt ku">ISTIO_VERSION=1.4.2</span><span id="8054" class="kq jf hi km b fi ll ks l kt ku">kubectl apply -f https://raw.githubusercontent.com/knative/serving/master/third_party/istio-${ISTIO_VERSION}/istio-crds.yaml</span><span id="4e07" class="kq jf hi km b fi ll ks l kt ku">kubectl apply -f https://raw.githubusercontent.com/knative/serving/master/third_party/istio-${ISTIO_VERSION}/istio-minimal.yaml</span></pre><h2 id="7771" class="kq jf hi bd jg ky kz la jk lb lc ld jo iq le lf js iu lg lh jw iy li lj ka lk bi translated">安装群集本地网关</h2><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="7586" class="kq jf hi km b fi kr ks l kt ku">kubectl apply -f https://raw.githubusercontent.com/knative/serving/master/third_party/istio-${ISTIO_VERSION}/istio-knative-extras.yaml</span></pre><h1 id="2b66" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">剧本</h1><p id="c10d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">因为我经常这样做，所以我用一个<a class="ae jd" href="https://github.com/meteatamel/knative-tutorial/tree/master/setup" rel="noopener ugc nofollow" target="_blank">设置</a>文件夹更新了我的<a class="ae jd" href="https://github.com/meteatamel/knative-tutorial" rel="noopener ugc nofollow" target="_blank"> Knative教程</a>，在那里我有在GKE上正确设置Knative的脚本。如果你对如何改进它们有任何想法，请随时使用它们并给我发送请求。</p><h1 id="fe69" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">病菌</h1><p id="1ef3" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我还在Knative上打开了这个的bug ( <a class="ae jd" href="https://github.com/knative/eventing/issues/2266" rel="noopener ugc nofollow" target="_blank"> 2266 </a>)。请投赞成票！</p></div></div>    
</body>
</html>