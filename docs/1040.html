<html>
<head>
<title>Cloud Run and Cloud Function: What do I use? And Why?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云运行和云功能:我用什么？为什么呢？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-run-and-cloud-function-what-i-use-and-why-12bb5d3798e1?source=collection_archive---------0-----------------------#2019-06-20">https://medium.com/google-cloud/cloud-run-and-cloud-function-what-i-use-and-why-12bb5d3798e1?source=collection_archive---------0-----------------------#2019-06-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d5adce10bb2e4fef2a8245229c43b5a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fCAPseRr7tYkgvnQgcg80A.png"/></div></div></figure><p id="6407" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2019年4月，在Google Next event上，Google公布了新的无服务器产品:<strong class="is hj"> Cloud Run </strong>。我是一名云运行alpha测试人员，我在许多用例上测试了这个非常棒的产品。我也很荣幸在旧金山和巴黎的舞台上(谷歌云峰会)展示我对这款产品的体验。</p><p id="6cc4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> Cloud Run </strong>是谷歌其他无服务器产品的补充，尤其是云功能。即使每个产品都有一个典型的用例及建议，一些用例也可以用几种产品以几种方式实现。那么，我在目前的开发中使用的是什么？我为什么要做这个选择？</p><p id="e958" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在继续之前，这里有一个每个产品的快速概述</p><h1 id="2d77" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">云函数</h1><p id="3cfb" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated"><a class="ae kr" href="https://cloud.google.com/functions/docs/" rel="noopener ugc nofollow" target="_blank">云功能</a>是无服务器、单一用途和事件驱动的解决方案。它们也可以由HTTP请求触发。每个请求/事件都由该函数的一个新实例处理，并在每次调用之间提供一个强隔离。</p><p id="cded" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">目前已正式上市。像NodeJS8、Python3.7、Go 1.11等几种语言处理；测试版中的NodeJS10在Alpha中，Go 1.12和Java</p><p id="9a0c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">只提供代码和依赖项列表，平台完成所有剩下的工作:打包、部署和运行代码。</p><p id="63bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">典型用例</strong></p><p id="e0c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">单一用途工作负载，尤其是事件驱动的工作负载(PubSub、存储、Firestore/Firebase等)，但也有HTTP触发的工作负载。可能的语言仅限于NodeJS 8/10、Go 1.11/1.12和Python3.7，并且只有依赖关系是公共可达的(Java 没有<em class="ks">)。图像转换、微批处理(持续时间不到9分钟)、流处理……是常见的使用案例</em></p><h1 id="910f" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">云运行</h1><p id="d631" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated"><a class="ae kr" href="https://cloud.google.com/run/docs/" rel="noopener ugc nofollow" target="_blank">云运行</a>建立在Knative之上，它允许以无服务器的方式为无状态容器提供服务，并且它本身是可移植的。只需要运行带有HTTP端点的无状态容器。没有语言、二进制和依赖关系的限制。</p><p id="965e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过这种方式，容器必须集成一个web服务器，并且可以同时处理几个请求，因此可以是多用途的。</p><p id="e91c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">容器包装必须在部署之前完成。为此可以使用云构建，或者在本地使用Docker或其他工具(如Kaniko或Jib)</p><p id="99bd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">典型用例</strong></p><p id="eeba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所有工作负载都在无状态模式下工作，处理时间少于15分钟，可以由一个或多个HTTP端点触发，如CRUD REST API。语言、库和二进制文件都不重要，只需要一个容器。网站后端、微批处理、ML推理……都是可能的用例</p></div><div class="ab cl kt ku gp kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hb hc hd he hf"><blockquote class="la lb lc"><p id="ea73" class="iq ir ks is b it iu iv iw ix iy iz ja ld jc jd je le jg jh ji lf jk jl jm jn hb bi translated">然而，当我想在Python、Go或NodeJS中实现由HTTP请求触发的工作负载时，比如由云调度器或单用途HTTP webhook触发的批处理，<strong class="is hj">我应该使用什么</strong>？</p></blockquote><p id="f3de" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">可以使用云函数来解决这个问题。单一目的，http触发和GA语言。但是也可以构建一个HTTP容器，并使用Cloud Run部署它。</p><p id="f409" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当我不得不应对这个问题时，<strong class="is hj">我总是使用云运行</strong>。为什么？事实上，对于单一用途来说，这种选择似乎有些过了。然而，我有两个主要原因</p><h1 id="4c5d" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">轻便</h1><p id="8106" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">当你为云运行开发时，你必须构建一个容器。该容器能够部署在任何地方:本地、库伯内特/GKE、云运行(无服务器和GKE)、虚拟机……任何地方。</p><p id="df12" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另一方面，部署在Cloud Function上的代码隐含地假设在某个地方有一个web服务器，能够将请求路由到代码。为了改变执行环境，你必须重新打包代码，也许在一个容器中，但是至少在它前面有一个web服务器。</p><p id="2c5b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当你想改变环境时，云运行在减少重复工作和重构方面有很强的优势。而且，你不那么局限于谷歌云。</p><h1 id="52f7" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">易测性</h1><p id="2e6b" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在关键任务开发中，可测试性和可靠性至关重要。我在这里不是在讨论单元测试，而是在讨论端到端测试，也称为“集成”测试。在实时物联网应用的生产环境中，我们不能接近或接受由于错误版本而丢失消息。</p><p id="bce3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过云函数，代码处理执行环境的web服务器转发的请求。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lg"><img src="../Images/f7bce2c1c21e02a91f503b711114c781.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*odpKIdRjYPJxhmpZPTTKPQ.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx translated">具有基本授权的Python回调云函数</figcaption></figure><p id="6971" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，为了测试您的功能，您必须模拟webserver请求，并正确填充代码参数中传递的请求对象。<em class="ks">不确定那是最好的方式，但是，</em> <a class="ae kr" href="https://cloud.google.com/functions/docs/bestpractices/testing#functions-testing-http-example-python" rel="noopener ugc nofollow" target="_blank"> <em class="ks">即使在GCP doc </em> </a> <em class="ks">中，也没有Python中的例子；我用我的(低)Python水平做了我能做的- &gt;我乐于接受建议！</em></p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/59ccfefe1946d0c7e1893cecc297c842.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hOWobs8kvywPHq_FlubHUg.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx translated">使用回调云函数的自定义请求测试代码</figcaption></figure><p id="2bf7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">问题来了</strong>:你怎么确定模拟的对象是正确的？您知道这个对象中传递的所有头吗？如何设置基本身份验证、不记名或API密钥？知道云函数环境下使用的请求对象的版本吗？</p><p id="a217" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"><em class="ks"/>就我个人而言，我无法回答这些问题。</strong>加入你团队的新开发人员，他有能力吗？而且，我对自己的测试代码不自信，<strong class="is hj">对测试不自信是个问题</strong>！</p><p id="36c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我解决这个问题的方法是创建一个测试文件，用一个web服务器导入函数代码。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/5fc6b88d5fc17b6b3d6d1ae8bc7b609b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dV-zyhV945hfcGgQ4kVL-g.png"/></div></div><figcaption class="ll lm et er es ln lo bd b be z dx translated">测试web服务器的云功能</figcaption></figure><p id="0bdd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要启动测试，只需用CURL命令调用web服务器。这样，web服务器将使用所有规则和参数正确格式化您的请求对象，并将其转发到您的代码。额外的好处是你可以改变你的web服务器，甚至你的开发语言，而不需要改变你的CURL测试请求。</p><p id="aa6c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">而且，正是在这个时候，<strong class="is hj">云运行才有意义</strong>。在这种背景下，云运行无非是云功能代码+简单的转发请求的webserver。只需为您的语言添加一个<a class="ae kr" href="https://cloud.google.com/run/docs/quickstarts/build-and-deploy#containerizing" rel="noopener ugc nofollow" target="_blank">标准docker文件</a>。而且结束了——你没有一个带测试服务器的云功能，而是一个打包好的容器，随时可以部署在Cloud Run上。</p><h1 id="129d" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">云每次运行！</h1><p id="461e" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">因此，云运行是云功能的简单性、端到端可测试性和可移植性的良好结合。许多痛点被解决，许多优势被获得，这就是为什么<strong class="is hj">为所有无状态HTTP容器使用并推荐云运行，</strong>甚至为像<strong class="is hj"> PubSub </strong>(为调用云运行创建推送订阅)或<strong class="is hj"> Storage </strong>(在GCS上创建PubSub通知)这样的事件。到目前为止，对于其他事件，云功能是不可避免的。</p><p id="b0ce" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，您可以考虑云运行的其他几个优势，比如在一个部署中<strong class="is hj">处理多个入口点</strong>的能力。或者，能够运行长达15分钟的<strong class="is hj">工作负载</strong>(使用云功能只需9分钟)。此外，在并发处理多个请求(最多80个)时，只对<strong class="is hj">充电一次</strong>和受冷启动影响一次<strong class="is hj">的能力，但代价是所有请求之间的隔离/内存共享损失(如果将concurrency参数设置为1，云运行也是可能的)。</strong></p><p id="b981" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，对我来说，<strong class="is hj">云运行是大多数用例的最佳解决方案</strong>。开发团队非常活跃，新功能不断增加:指标、云SQL连接、服务帐户身份……我强烈推荐您继续关注这款产品，它将成为所有用途的必需品！</p></div><div class="ab cl kt ku gp kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hb hc hd he hf"><p id="f8f8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kr" href="https://cloud.google.com/blog/products/serverless/3-cool-cloud-run-features-that-developers-love-and-that-you-will-too" rel="noopener ugc nofollow" target="_blank">Google云博客上的云运行</a> <br/> <a class="ae kr" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank">云运行产品页面</a> <br/> <a class="ae kr" href="https://cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">云功能产品页面</a></p></div></div>    
</body>
</html>