<html>
<head>
<title>BigQuery Dynamic SQL using Jinja Template</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Jinja模板的BigQuery动态SQL</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bigquery-dynamic-sql-using-jinja-template-5c1332317960?source=collection_archive---------0-----------------------#2020-10-06">https://medium.com/google-cloud/bigquery-dynamic-sql-using-jinja-template-5c1332317960?source=collection_archive---------0-----------------------#2020-10-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="6beb" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用面向Python的Jinja模板语言的动态SQL</h2></div><p id="fc21" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建手工制作的SQL既麻烦又耗时。因此，通过有效的自动化流程，我们可以克服这些挑战。Jinja模板提供了动态生成SQL查询的属性和参数，大大节省了时间和精力。这是组织用来提高SQL查询的准确性和减少IT操作依赖性的最佳技术之一。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/3f910212a8826b8ca2c6555e68780997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fnFWjE9TYkBupMde2Vvy4g.png"/></div></div></figure><p id="7ec4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以执行以下步骤来实现这种自动化。</p><ol class=""><li id="00bb" class="kf kg hi iz b ja jb jd je jg kh jk ki jo kj js kk kl km kn bi translated"><strong class="iz hj">步骤1: </strong>创建一个配置文件</li><li id="20cf" class="kf kg hi iz b ja ko jd kp jg kq jk kr jo ks js kk kl km kn bi translated"><strong class="iz hj">步骤2: </strong>创建一个Jinja模板和宏</li><li id="2e71" class="kf kg hi iz b ja ko jd kp jg kq jk kr jo ks js kk kl km kn bi translated"><strong class="iz hj">第三步:</strong> Python源代码</li></ol><h2 id="79ee" class="kt ku hi bd kv kw kx ky kz la lb lc ld jg le lf lg jk lh li lj jo lk ll lm ln bi translated"><strong class="ak">配置文件</strong></h2><p id="1793" class="pw-post-body-paragraph ix iy hi iz b ja lo ij jc jd lp im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">配置文件<strong class="iz hj"> (config.yaml) </strong>包含生成动态SQL所需的输入参数，这是唯一需要定制的文件。以下示例描述了单个BigQuery视图的创建，但是您可以通过在配置文件中扩展输入参数来一次性创建多个视图。</p><pre class="ju jv jw jx fd lt lu lv lw aw lx bi"><span id="997b" class="kt ku hi lu b fi ly lz l ma mb">- viewName: mydataset.vw_job_profile<br/>  baseTables:<br/>    - mydataset.emp_profile<br/>    - mydataset.emp_department<br/>    - mydataset.emp_payroll<br/>  joinKey: emp_id<br/>  filterConditions:<br/>    - emp_profile.management_level &gt; 87<br/>    - emp_department.dept_name = 'IT'<br/>    - emp_payroll.year = 2020<br/>  excludeColumns:<br/>    - insert_timestamp<br/>    - update_timestamp</span></pre><h2 id="ae38" class="kt ku hi bd kv kw kx ky kz la lb lc ld jg le lf lg jk lh li lj jo lk ll lm ln bi translated"><strong class="ak"> Jinja模板和宏</strong></h2><p id="569f" class="pw-post-body-paragraph ix iy hi iz b ja lo ij jc jd lp im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">Jinja模板<strong class="iz hj"> (sql_template.sql) </strong>用于动态创建BigQuery视图。模板包含变量/表达式，当呈现模板时，这些变量/表达式将被替换为值。</p><pre class="ju jv jw jx fd lt lu lv lw aw lx bi"><span id="6a5f" class="kt ku hi lu b fi ly lz l ma mb">{% from 'macro.sql' import macro_join_condition %}<br/>{% from 'macro.sql' import macro_filter_condition %}</span><span id="8f7f" class="kt ku hi lu b fi mc lz l ma mb">CREATE OR REPLACE VIEW {{ params.viewName }}<br/>AS<br/>SELECT<br/>    {{ params.viewColumnList|join(',') }}<br/>FROM<br/>    {{ params.baseTables|join(',') }}<br/>WHERE<br/>    {{ <strong class="lu hj">macro_filter_condition</strong>(params.filterConditions) }}<br/>    {% if params.tableCount &gt; 1 %}<br/>        {{ <strong class="lu hj">macro_join_condition</strong>(params.tableL, params.tableR, params.joinKey)}}<br/>    {% endif %}</span></pre><p id="417b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本解决方案中使用的Jinja宏用于设计可重用的SQL语句。标签允许跨模板定义可重用的内容片段。</p><pre class="ju jv jw jx fd lt lu lv lw aw lx bi"><span id="8650" class="kt ku hi lu b fi ly lz l ma mb">{% macro <strong class="lu hj">macro_join_condition</strong>(l_tbl, r_tbls, column) %}<br/>  {% for r_tbl in r_tbls %}<br/>    AND {{ l_tbl }}.{{ column }} = {{ r_tbl }}.{{ column }}<br/>  {% endfor %}<br/>{% endmacro %}</span><span id="7d95" class="kt ku hi lu b fi mc lz l ma mb">{% macro <strong class="lu hj">macro_filter_condition</strong>(filters) %}<br/>  {% for tbl_filter in filters %}<br/>    {% if loop.first %}<br/>      {{ tbl_filter }}<br/>    {% else %}<br/>      AND {{ tbl_filter }}<br/>    {% endif %}<br/>  {% endfor %}<br/>{% endmacro %}</span></pre><h2 id="aeb3" class="kt ku hi bd kv kw kx ky kz la lb lc ld jg le lf lg jk lh li lj jo lk ll lm ln bi translated">源代码</h2><p id="af04" class="pw-post-body-paragraph ix iy hi iz b ja lo ij jc jd lp im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">用于该解决方案的源代码执行多项任务，例如读取配置文件、从BigQuery获取元数据以及使用参数呈现Jinja SQL模板。</p><p id="eed2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">源代码(<strong class="iz hj"> main.py </strong>)</p><pre class="ju jv jw jx fd lt lu lv lw aw lx bi"><span id="edcc" class="kt ku hi lu b fi ly lz l ma mb">import yaml<br/>from jinja2 import Environment, FileSystemLoader<br/>from google.cloud import bigquery</span><span id="fbf4" class="kt ku hi lu b fi mc lz l ma mb">configList = yaml.safe_load(open("config.yaml"))<br/>env = Environment(loader=FileSystemLoader("./"))<br/>sqlTemplate = env.get_template('sql_template.sql')</span><span id="5b2d" class="kt ku hi lu b fi mc lz l ma mb">for tableConf in configList:<br/>    viewName = tableConf['viewName']<br/>    baseTables = tableConf['baseTables']<br/>    joinKey = tableConf['joinKey']<br/>    filterConditions = tableConf['filterConditions']<br/>    excludeColumns = tableConf['excludeColumns']</span><span id="6aad" class="kt ku hi lu b fi mc lz l ma mb">    tableColumnList = <strong class="lu hj">getTableColumns</strong>(baseTables)<br/>    viewColumnList = <strong class="lu hj">getViewColumns</strong>(tableColumnList, excludeColumns)</span><span id="2e67" class="kt ku hi lu b fi mc lz l ma mb">    params = {<br/>        'viewName': viewName,<br/>        'baseTables': baseTables,<br/>        'viewColumnList': viewColumnList,<br/>        'filterConditions': filterConditions,<br/>        'tableCount': len(baseTables)<br/>    }</span><span id="e919" class="kt ku hi lu b fi mc lz l ma mb">    if len(baseTables) &gt; 1:<br/>        tableL, tableR = <strong class="lu hj">getTableJoin</strong>(baseTables)<br/>        params['tableL'] = tableL<br/>        params['tableR'] = tableR<br/>        params['joinKey'] = joinKey</span><span id="0cfe" class="kt ku hi lu b fi mc lz l ma mb">    sqlQuery = sqlTemplate.render(params=params)<br/>    <strong class="lu hj">runSql</strong>(sqlQuery)</span></pre><p id="0ee1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">源代码(<strong class="iz hj">用户自定义模块</strong>)</p><pre class="ju jv jw jx fd lt lu lv lw aw lx bi"><span id="6d8d" class="kt ku hi lu b fi ly lz l ma mb">def <strong class="lu hj">getTableColumns</strong>(baseTables):<br/>    client = bigquery.Client()<br/>    columnList = []<br/>    for tables in baseTables:<br/>        datasetName = tables.split(".")[0]<br/>        tableName = tables.split(".")[1]<br/>        tableRef = client.dataset(datasetName).table(tableName)<br/>        table = client.get_table(tableRef)<br/>        for column in table.schema:<br/>            if column.name not in str(columnList):<br/>                columnList.append(tableName + "." + column.name)<br/>    return columnList</span><span id="f423" class="kt ku hi lu b fi mc lz l ma mb">def <strong class="lu hj">getViewColumns</strong>(columnList, excludeColumns):<br/>    viewColumns = set(columnList).difference(set(excludeColumns))<br/>    viewColumnList = sorted(list(viewColumns))<br/>    return viewColumnList</span><span id="00fb" class="kt ku hi lu b fi mc lz l ma mb">def <strong class="lu hj">getTableJoin</strong>(baseTables):<br/>    columnList = []<br/>    for tables in baseTables[1:]:<br/>        tableName = tables.split(".")[1]<br/>        columnList.append(tableName)</span><span id="c033" class="kt ku hi lu b fi mc lz l ma mb">    return baseTables[0].split(".")[1], columnList</span><span id="f595" class="kt ku hi lu b fi mc lz l ma mb">def <strong class="lu hj">runSql</strong>(sqlQuery):<br/>    client = bigquery.Client()<br/>    sqlJob = client.query(sqlQuery)<br/>    sqlJob.result()</span></pre><h2 id="f27a" class="kt ku hi bd kv kw kx ky kz la lb lc ld jg le lf lg jk lh li lj jo lk ll lm ln bi translated">源代码库</h2><p id="03db" class="pw-post-body-paragraph ix iy hi iz b ja lo ij jc jd lp im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated"><a class="ae md" href="https://github.com/soumendra-mishra/jinja-sql-template.git" rel="noopener ugc nofollow" target="_blank">https://github.com/soumendra-mishra/jinja-sql-template.git</a></p><h2 id="3cbb" class="kt ku hi bd kv kw kx ky kz la lb lc ld jg le lf lg jk lh li lj jo lk ll lm ln bi translated">怎么用？</h2><ol class=""><li id="41b8" class="kf kg hi iz b ja lo jd lp jg me jk mf jo mg js kk kl km kn bi translated">创建动态视图所需的BigQuery数据集和基表</li><li id="3242" class="kf kg hi iz b ja ko jd kp jg kq jk kr jo ks js kk kl km kn bi translated">从GitHub资源库下载源代码</li><li id="ccee" class="kf kg hi iz b ja ko jd kp jg kq jk kr jo ks js kk kl km kn bi translated">编辑配置文件<strong class="iz hj"> (config.yaml) </strong>并更改BigQuery数据集、表、连接键、过滤条件和排除列</li><li id="c799" class="kf kg hi iz b ja ko jd kp jg kq jk kr jo ks js kk kl km kn bi translated">运行<strong class="iz hj"> main.py </strong>文件</li></ol></div></div>    
</body>
</html>