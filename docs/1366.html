<html>
<head>
<title>Image Processing using Google Cloud Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用谷歌云功能进行图像处理</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/image-processing-using-google-cloud-functions-26bffc290c9e?source=collection_archive---------0-----------------------#2020-04-13">https://medium.com/google-cloud/image-processing-using-google-cloud-functions-26bffc290c9e?source=collection_archive---------0-----------------------#2020-04-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="bb4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博客中，我将分享如何使用谷歌云功能创建一个微服务。目标是当图像上传到谷歌云存储桶时重新格式化图像。</p><h1 id="afe5" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">设置</h1><p id="7970" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我使用谷歌云壳运行所有的命令。关于谷歌云壳的详细信息，请关注<a class="ae kg" href="https://cloud.google.com/shell/docs/" rel="noopener ugc nofollow" target="_blank">官方文档</a>。</p><h1 id="1d37" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">解决方案:</h1><p id="d8ce" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">据<a class="ae kg" href="https://cloud.google.com/storage" rel="noopener ugc nofollow" target="_blank">谷歌</a>，</p><blockquote class="kh ki kj"><p id="dbda" class="if ig kk ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">云存储提供全球范围内高度耐用的对象存储，可扩展至数十亿字节的数据。您可以从任何存储类别中即时访问数据，通过一个统一的API将存储集成到您的应用程序中，并轻松优化价格和性能。</p></blockquote><p id="535f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤1: </strong>使用gcloud命令创建两个GCS buckets。一个用于源图像序列，另一个用于处理后的图像序列。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="4c9b" class="kx je hi kt b fi ky kz l la lb">export SOURCE_BUCKET_NAME=$DEVSHELL_PROJECT_ID-source<br/>export PROCESSED_BUCKET_NAME=$DEVSHELL_PROJECT_ID-processed</span><span id="0c30" class="kx je hi kt b fi lc kz l la lb">echo "Creating source bucket: gs://$SOURCE_BUCKET_NAME"<br/>gsutil mb gs://$SOURCE_BUCKET_NAME</span><span id="b285" class="kx je hi kt b fi lc kz l la lb">echo "Creating processed bucket: gs://$PROCESSED_BUCKET_NAME"<br/>gsutil mb gs://$PROCESSED_BUCKET_NAME</span></pre><p id="7610" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第二步:</strong>使用gcloud创建一个谷歌云功能。</p><blockquote class="kh ki kj"><p id="73cf" class="if ig kk ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">Cloud Functions是Google Cloud的事件驱动的无服务器计算平台。在本地或云中运行您的代码，而无需供应服务器。借助持续交付和监控工具，从编码到部署。云功能可伸缩，因此您只需为使用的计算资源付费。通过连接现有的Google Cloud或第三方服务，轻松创建端到端的复杂开发场景。</p></blockquote><p id="9387" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们将创建一个<a class="ae kg" href="https://cloud.google.com/functions/docs/" rel="noopener ugc nofollow" target="_blank"> google cloud函数</a>，当图像上传到存储器时，它将触发<a class="ae kg" href="https://cloud.google.com/functions/docs/concepts/events-triggers" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="b544" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云函数的入口点必须在名为<code class="du ld le lf kt b">main.py</code>的Python源文件中定义。有关Python运行时的详细信息，请点击查看<a class="ae kg" href="https://cloud.google.com/functions/docs/concepts/python-runtime#source_code_structure" rel="noopener ugc nofollow" target="_blank">。给<code class="du ld le lf kt b">main.py</code>增加以下功能。</a></p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="5698" class="kx je hi kt b fi ky kz l la lb">import os<br/>import cv2<br/>import numpy as np<br/>from google.cloud import storage<br/>from tempfile import NamedTemporaryFile<br/></span><span id="1abd" class="kx je hi kt b fi lc kz l la lb">def reformat_image(event, context):<br/>    """Triggered by a change to a Cloud Storage bucket.<br/>    Args:<br/>         event (dict): Event payload.<br/>         context (google.cloud.functions.Context): Metadata for the event.<br/>    """<br/>    file = event</span><span id="7147" class="kx je hi kt b fi lc kz l la lb">    client = storage.Client()<br/>    source_bucket = client.get_bucket(file['bucket'])<br/>    source_blob = source_bucket.get_blob(file['name'])</span><span id="9c1c" class="kx je hi kt b fi lc kz l la lb">    image = np.asarray(bytearray(source_blob.download_as_string()), dtype="uint8")<br/>    image = cv2.imdecode(image, cv2.IMREAD_UNCHANGED)</span><span id="16cb" class="kx je hi kt b fi lc kz l la lb">    scale_percent = 50  # percent of original size<br/>    width = int(image.shape[1] * scale_percent / 100)<br/>    height = int(image.shape[0] * scale_percent / 100)<br/>    dim = (width, height)</span><span id="ace7" class="kx je hi kt b fi lc kz l la lb">    # resize image<br/>    resized = cv2.resize(image, dim, interpolation=cv2.INTER_AREA)</span><span id="5ef4" class="kx je hi kt b fi lc kz l la lb">    with NamedTemporaryFile() as temp:<br/>        # Extract name to the temp file<br/>        temp_file = "".join([str(temp.name), file['name']])</span><span id="f60c" class="kx je hi kt b fi lc kz l la lb">        # Save image to temp file<br/>        cv2.imwrite(temp_file, resized)</span><span id="d45f" class="kx je hi kt b fi lc kz l la lb">        # Uploading the temp image file to the bucket<br/>        dest_filename = file['name']<br/>        dest_bucket_name = os.environ.get('PROCESSED_BUCKET_NAME', 'Specified environment variable is not set.')<br/>        dest_bucket = client.get_bucket(dest_bucket_name)<br/>        dest_blob = dest_bucket.blob(dest_filename)<br/>        dest_blob.upload_from_filename(temp_file)</span></pre><p id="5254" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">增加<code class="du ld le lf kt b">requirements.txt</code>，内容如下:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="f61e" class="kx je hi kt b fi ky kz l la lb">opencv-python==4.2.0.34<br/>numpy==1.18.2<br/>google-cloud-storage==1.27.0</span></pre><p id="6ea4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第三步:</strong>部署功能</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="ebf6" class="kx je hi kt b fi ky kz l la lb">gcloud functions deploy reformat_image --set-env-vars PROCESSED_BUCKET_NAME=$PROCESSED_BUCKET_NAME --runtime python37 --trigger-resource $SOURCE_BUCKET_NAME --trigger-event google.storage.object.finalize</span></pre><p id="d7e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述命令将部署该功能。该函数将在创建存储对象时触发。有关云函数触发器的更多详情，请参见<a class="ae kg" href="https://cloud.google.com/functions/docs/calling/storage" rel="noopener ugc nofollow" target="_blank">官方文档</a>。</p><p id="9de7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们将复制一个映像到bucket来测试我们最近部署的函数。要复制映像，请运行下面提到的命令:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="a280" class="kx je hi kt b fi ky kz l la lb">gsutil cp /path/to/images gs://$SOURCE_BUCKET_NAME</span></pre><p id="b32d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面提到的命令应该在存储桶中创建一个新对象。这个事件应该会触发云功能。为了验证这一点，我们将运行以下命令并查看日志:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="ed24" class="kx je hi kt b fi ky kz l la lb">gcloud functions logs read reformat_image --limit 50</span></pre><p id="46fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们列出来自目的地桶的输出图像</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="84dc" class="kx je hi kt b fi ky kz l la lb">gsutil ls gs://$PROCESSED_BUCKET_NAME</span></pre><h1 id="e31f" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">摘要</h1><p id="1620" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">在这篇博客中，我使用谷歌云平台托管服务来调整图像大小，而没有部署任何服务器。为了避免GCP的任何费用，请确保删除GCS桶和云功能。</p><p id="2d2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这个博客能帮助你理解云的功能和它的用处。</p><p id="fd96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请在<a class="ae kg" href="https://uk.linkedin.com/in/dheerajbhadani" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>或<a class="ae kg" href="https://twitter.com/dheerajbhadani" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上分享您的反馈。</p></div></div>    
</body>
</html>