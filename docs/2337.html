<html>
<head>
<title>Running a serverless, geospatial, python app in Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在谷歌云中运行无服务器的地理空间python应用</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/running-a-serverless-geospatial-python-app-in-google-cloud-9d9d9c284c4d?source=collection_archive---------0-----------------------#2022-09-01">https://medium.com/google-cloud/running-a-serverless-geospatial-python-app-in-google-cloud-9d9d9c284c4d?source=collection_archive---------0-----------------------#2022-09-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="939d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为一名地理空间科学家，您可能想知道定制的应用程序和可视化门户如何变成运行在云中的web应用程序。警告:这可能会让你掉进一个很深的兔子洞，最终你只能从事云计算工作。</p><p id="1cad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几个月前，我偶然发现了<a class="ae jd" href="https://greppo.io/" rel="noopener ugc nofollow" target="_blank"> Greppo </a>一个用于构建GIS应用程序的开源数据科学框架，它是我在代尔夫特大学的一个老同事正在构建的。很多人可能不知道，但我是通过地理信息系统以及随之而来的所有数据准备/分析/展示进入这个领域的。我当时不知道的是，如何设计和部署我的GIS应用程序，使其作为分布式应用程序在云中运行。但是我也不能说我已经有了所有的答案。这就是为什么我认为自己正在弥合数据科学和IT运营之间的知识差距，这将我带到了应用程序开发。</p><p id="c56d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为对GCP专业<a class="ae jd" href="https://cloud.google.com/certification/cloud-devops-engineer" rel="noopener ugc nofollow" target="_blank">云开发工程师</a>和<a class="ae jd" href="https://cloud.google.com/certification/cloud-developer" rel="noopener ugc nofollow" target="_blank"> GCP专业云开发人员</a>的准备，我决定采用一个Greppo示例应用程序，并在谷歌云中自动部署它。我通常在Kubernetes上花很多时间，但这次我想了解谷歌云如何通过云运行和云功能利用无服务器计算的力量，这是受到Wietse Venema的书<a class="ae jd" href="https://wietsevenema.eu/cloud-run-book/" rel="noopener ugc nofollow" target="_blank">用谷歌云运行构建无服务器应用</a>的启发。</p><h2 id="351b" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">格雷波</h2><p id="3ab6" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">Greppo是一个python框架，用于快速创建地理空间应用程序和可视化门户。它使用了<a class="ae jd" href="https://geopandas.org/en/stable/" rel="noopener ugc nofollow" target="_blank"> geopandas </a>，这是一个流行的开源项目，简化了使用python处理地理空间数据的工作。Geopandas本身扩展了著名的<a class="ae jd" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank"> pandas </a>库中的数据类型，以允许对几何类型进行空间操作(由<a class="ae jd" href="https://shapely.readthedocs.io/en/stable/manual.html" rel="noopener ugc nofollow" target="_blank"> shapely </a>执行，并用<a class="ae jd" href="https://matplotlib.org/" rel="noopener ugc nofollow" target="_blank"> matplotlib </a>绘制)。</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es ke"><img src="../Images/9fda6b5b510c914692c2dcd6c02a29f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6DS8YbPcppMln-A3kmFlSw.png"/></div></div></figure><h2 id="2fcd" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">一个Greppo应用程序的例子是什么样的？</h2><p id="af3f" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">让我们看看关于部署Greppo应用程序的官方文档，并将我们的注意力转移到<a class="ae jd" href="https://github.com/greppo-io/greppo-demo/blob/main/Dockerfile" rel="noopener ugc nofollow" target="_blank"> greppo-demo </a>中提供的Dockerfile:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="e1e0" class="je jf hi kr b fi kv kw l kx ky"># syntax=docker/dockerfile:1<br/>FROM python:3.9-slim-buster<br/>WORKDIR /src<br/>COPY /vector-demo .<br/>RUN pip3 install -r requirements.txt<br/>CMD [“greppo”, “serve”, “app.py”, “ — host=0.0.0.0”] # Will serve on port 8080 of the container</span></pre><p id="2743" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Dockerfile相当简单，它所做的只是将应用程序代码复制到容器中，安装所需的python包(使用pip ),最后提供应用程序，在**app.py**上定义。到目前为止一切顺利，对吧？现在让我们看一下应用程序代码，重点看它是如何导入数据的:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="abf3" class="je jf hi kr b fi kv kw l kx ky">regions = gpd.read_file("./regions.geojson")<br/># Display a layer in the map "the Greppo way"<br/>app.vector_layer(<br/>    data=regions,<br/>    name="Regions of Italy",<br/>    description="Polygons showing the boundaries of regions of Italy.",<br/>    style={"fillColor": "#4daf4a"},<br/>)</span></pre><p id="d528" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以看到数据包含在geojson文件中，这些文件是从app.py所在的同一个目录中加载的。虽然这对于在笔记本电脑上运行的开发来说可能没问题，但在容器化应用程序的环境中，这无疑是一种糟糕的做法。这是为什么呢？容器的寿命并不长，这意味着当它们停止运行时，存储在其中的任何数据都会丢失。像Kubernetes这样的容器编排器用持久卷来处理这个问题，持久卷在容器启动时被附加到容器上，尽管将数据保存在Kubernetes集群之外通常是个好主意。无论如何，今天我不是来写Kubernetes的。因为我们只是运行一个简单的python应用程序，所以我们不需要整个Kubernetes集群；我们可以在Google Cloud Run中部署它。</p><h1 id="1fc3" class="kz jf hi bd jg la lb lc jk ld le lf jo lg lh li jr lj lk ll ju lm ln lo jx lp bi translated">在谷歌云中运行应用程序</h1><p id="b979" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">在这个练习中，我们将在Cloud Run中部署一个<strong class="ih hj">简单的python应用</strong>，这是Google Cloud中一个完全托管的无服务器平台，与<a class="ae jd" href="https://knative.dev/docs/" rel="noopener ugc nofollow" target="_blank"> knative </a>兼容。但是，在此之前，我们将在云存储桶中保存geojson文件，这将允许您将数据导入到您的应用程序中。我还将更进一步，展示如何<strong class="ih hj">将数据推送到BigQuery </strong>，以便您可以在应用程序中包含一些高级空间查询(类似于geopandas，但在您的数据库中进行处理)。</p><p id="e188" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了构建我们的应用程序，我们将使用这些完全托管的服务和无服务器运行时，所有这些都包含在<a class="ae jd" href="https://cloud.google.com/free" rel="noopener ugc nofollow" target="_blank">自由层</a>中:</p><p id="e8aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">— <strong class="ih hj">云存储:</strong> <em class="lq">对象存储</em>。模仿典型的文件系统，非常适合存储我们的geojson文件。可以把它想象成一个全局文件夹，通过HTTP为你的文件提供服务。<br/> — <strong class="ih hj">大查询:</strong> <em class="lq">无服务器数据仓库</em>。在我们的应用程序中包含高级地理空间查询。<br/> — <strong class="ih hj">云功能:</strong> <em class="lq">事件驱动的无服务器运行时</em>。通过HTTP调用将geojson数据从云存储推送到BigQuery。<br/> — <strong class="ih hj">云构建:</strong> <em class="lq">无服务器CI/CD管道引擎</em>。以在每次新代码被推送到我们的Github库时触发应用程序的部署。<br/> — <strong class="ih hj">集装箱注册:</strong> <em class="lq">集装箱注册</em>。我们的容器图像将存储在哪里。<br/> — <strong class="ih hj">云运行:</strong> <em class="lq">无服务器运行时</em>。运行我们的Greppo应用程序。</p><p id="1d15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们看看如何配置这些服务，以便为我们的自动化部署提供一个<strong class="ih hj">可扩展、高度可用的架构</strong>:</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es lr"><img src="../Images/e7a048520763be21d74c67f0edf441e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qUezDbuj9kEnNA5FrIm7lg.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">谷歌云中的Greppo架构</figcaption></figure><p id="8883" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将采取以下步骤来部署我们的Greppo应用程序:</p><ol class=""><li id="11b5" class="lw lx hi ih b ii ij im in iq ly iu lz iy ma jc mb mc md me bi translated"><strong class="ih hj">将geojson文件存储在云存储桶中:</strong>以便可以在您的Google Cloud项目中访问它们。</li><li id="19c4" class="lw lx hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated"><strong class="ih hj">创建一个大查询数据集</strong>。</li><li id="0b76" class="lw lx hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated"><strong class="ih hj">创建一个服务帐户:</strong>该帐户将被分配给云功能，以便它可以从云存储中提取数据并将其推送到BigQuery。</li><li id="1342" class="lw lx hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated"><strong class="ih hj">创建一个云函数来推送数据:</strong>它将根据(HTTP)请求将数据从一个存储桶推送到BigQuery。</li><li id="984d" class="lw lx hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated"><strong class="ih hj">将数据推送到BigQuery </strong>。</li><li id="4a99" class="lw lx hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated"><strong class="ih hj">在你的Github repo </strong>里安装云跑App。</li><li id="a3ab" class="lw lx hi ih b ii mf im mg iq mh iu mi iy mj jc mb mc md me bi translated"><strong class="ih hj">通过云构建</strong>自动化应用构建&amp;部署流程。</li></ol><h2 id="5bc3" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">第一步:存储。云存储桶中的geojson文件</h2><p id="1816" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">Greppo的矢量示例显示了意大利的整个道路网络、城市和地区。每个地理数据框架包含在不同的geojson文件中，该文件必须上传到云存储桶。您可以从Greppo-Demo Github repo下载它们:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="cadb" class="je jf hi kr b fi kv kw l kx ky"># Make a directory to store the files<br/>mkdir greppo-demo-data<br/># Copy the files from the original greppo-demo repo to your cloud console's disk in the newly created directory<br/>curl https://raw.githubusercontent.com/greppo-io/greppo-demo/main/vector-demo/cities.geojson -o ./greppo-demo-data/cities.geojson<br/>curl https://raw.githubusercontent.com/greppo-io/greppo-demo/main/vector-demo/roads.geojson -o ./greppo-demo-data/roads.geojson<br/>curl https://raw.githubusercontent.com/greppo-io/greppo-demo/main/vector-demo/regions.geojson -o ./greppo-demo-data/regions.geojson</span></pre><p id="3844" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建存储桶并将文件复制到其中:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="c4b4" class="je jf hi kr b fi kv kw l kx ky">gsutil mb -l &lt;YOUR_GCP_REGION&gt; gs://&lt;YOUR_BUCKET_NAME&gt;<br/>gsutil cp -r greppo-demo-data/. gs://&lt;YOUR_BUCKET_NAME&gt;/</span></pre><p id="c318" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就这样，你的。geojson文件现在位于您新创建的存储桶中。您可以从云控制台磁盘中删除这些文件，因为您不再需要它们。</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="33b2" class="je jf hi kr b fi kv kw l kx ky">rm -rf greppo-demo-data/</span></pre><p id="b99f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想保持简单，并且<strong class="ih hj">从bucket </strong>导入您的数据，您可以这样做:</p><blockquote class="mk ml mm"><p id="e986" class="if ig lq ih b ii ij ik il im in io ip mn ir is it mo iv iw ix mp iz ja jb jc hb bi translated">将文件加载到应用程序中(示例)</p></blockquote><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="ec38" class="je jf hi kr b fi kv kw l kx ky"># Get filesystem from Google Cloud project<br/>gcs_file_system = gcsfs.GCSFileSystem(project="&lt;YOUR_GCP_PROJECT_NAME&gt;")<br/># Define file location(s)<br/>file_location = "gs:/bucket/example_file.geojson"<br/># Read files as json<br/>with gcs_file_system.open(file_location) as file:<br/>  file_json = json.load(file)<br/>geodataframe = gpd.GeoDataFrame.from_features(file_json["features"])</span></pre><p id="9d74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">恭喜你！现在，您已经减少了对容器本地文件系统的依赖，这无疑是构建云原生应用程序的一个步骤。虽然您现在可以重新编写代码，并使用pandas/geopandas进行其余的数据和地理空间处理，但建议将数据推送到数据库引擎，以执行更高级的空间查询，同时将一些处理任务卸载给它。</p><h2 id="3857" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">步骤2:创建一个大查询数据集</h2><p id="1a69" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">虽然您可以创建一个云SQL并部署一个Postgres数据库实例(使用PostGIS ),但是您需要为配置该数据库所分配的资源付费。有了BigQuery，你只需为你使用的东西付费，它还可以执行<a class="ae jd" href="https://cloud.google.com/bigquery/docs/geospatial-intro" rel="noopener ugc nofollow" target="_blank">地理空间分析</a>！</p><p id="c327" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建大查询数据集:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="8f6f" class="je jf hi kr b fi kv kw l kx ky">bq mk -d &lt;YOUR_DATASET_NAME&gt; \<br/>  --location=&lt;YOUR_GCP_REGION&gt; \<br/>  --description=”&lt;DATASET_DESCRIPTION&gt;”</span></pre><h2 id="d911" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">步骤3:创建服务帐户</h2><p id="58db" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">由于您的云功能需要进行身份验证，以从云存储中读取文件并将它们推送到BigQuery，因此您需要创建一个服务帐户:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="8fd7" class="je jf hi kr b fi kv kw l kx ky">gcloud iam service-accounts create greppo-bq-data-pusher \<br/>  --description=”DESCRIPTION” \<br/>  --display-name=”Greppo BigQuery Data Pusher”</span></pre><p id="ffef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将服务帐户绑定到云存储对象查看器角色，以便它可以读取。桶中的geojson文件:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="10c1" class="je jf hi kr b fi kv kw l kx ky">gcloud projects add-iam-policy-binding &lt;YOUR_PROJECT_NAME&gt; \<br/>  --member=”serviceAccount:greppo-bq-data-pusher@&lt;YOUR_PROJECT_NAME&gt;.iam.gserviceaccount.com” \<br/>  --role=”roles/storage.objectViewer”</span></pre><p id="01c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">也将其绑定到BigQuery数据所有者角色，以便它可以创建表并将数据推送到这些表:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="f559" class="je jf hi kr b fi kv kw l kx ky">gcloud projects add-iam-policy-binding &lt;YOUR_PROJECT_NAME&gt; \<br/>  --member=”serviceAccount:greppo-bq-data-pusher@&lt;YOUR_PROJECT_NAME&gt;.iam.gserviceaccount.com” \<br/>  --role=”roles/bigquery.dataOwner”</span></pre><h2 id="91e8" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">步骤4:创建一个云函数来推送数据</h2><p id="2ade" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">克隆我的Github repo，它包含完成这个练习所需的所有代码。</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="66c5" class="je jf hi kr b fi kv kw l kx ky">git clone <a class="ae jd" href="https://github.com/mestredelpino/greppo-google-cloud" rel="noopener ugc nofollow" target="_blank">https://github.com/mestredelpino/greppo-google-cloud</a></span></pre><p id="d3fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以通过运行"<em class="lq">cat GRE PPO-Google-cloud/functions/bucket _ geo JSON _ to _ bq/bucket _ geo JSON _ to _ bq . py "</em>或者在Github中点击<a class="ae jd" href="https://github.com/mestredelpino/greppo-google-cloud/blob/main/functions/bucket_geojson_to_bq/bucket_geojson_to_bq.py" rel="noopener ugc nofollow" target="_blank">这里</a>来查看功能。</p><p id="7e9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署功能:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="e25e" class="je jf hi kr b fi kv kw l kx ky">gcloud functions deploy geojson-to-bq \<br/> --gen2 \<br/> --runtime=python39 \<br/> --region=&lt;YOUR_GCP_REGION&gt; \<br/> --source=greppo-google-cloud/functions/bucket_geojson_to_bq/ \<br/> --entry-point=geojson_to_bq \<br/> --trigger-http \<br/> --service-account=greppo-bq-data-pusher@&lt;YOUR_PROJECT_NAME&gt;.iam.gserviceaccount.com</span></pre><p id="2a07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该函数将从HTTP请求中获取以下参数:</p><p id="1843" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">— Google Cloud项目名<br/> —桶名<br/> —文件路径(在桶内)<br/> —数据集名<br/> —表名(创建数据并将其推送到)</p><h2 id="b8a2" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">步骤5:将数据推送到BigQuery</h2><p id="a993" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">通过运行以下命令将数据推送到BigQuery:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="fcc1" class="je jf hi kr b fi kv kw l kx ky">curl -m 70 -X POST &lt;SERVICE_URL&gt; \<br/> -H “Authorization:bearer $(gcloud auth print-identity-token)” \<br/> -H “Content-Type:application/json” \<br/> -d ‘{“PROJECT”:”&lt;YOUR_PROJECT_NAME&gt;”,<br/> “DATASET”:”&lt;DATASET_NAME&gt;”, <br/> “TABLE”:”&lt;NEW_TABLE_NAME&gt;”, <br/> “BUCKET”:”&lt;YOUR_BUCKET_NAME&gt;”, <br/> “PATH_TO_FILE”:”&lt;YOUR_FILE.geojson&gt;”}’</span></pre><p id="7b32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lq">在BigQuery的交互控制台中进行测试查询(示例)</em></p><p id="3a40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过对新创建的表之一运行查询，导航到BigQuery数据库，确认数据已成功上传:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="f166" class="je jf hi kr b fi kv kw l kx ky">SELECT * FROM table `&lt;YOUR_GCP_PROJECT&gt;.&lt;YOUR_DATASET&gt;.cities` LIMIT 10</span></pre><figure class="kf kg kh ki fd kj er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es mq"><img src="../Images/024feff4dc1b56384e3670a4b3039305.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uEqYZGsKG8GE07rfUyP0ig.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">查询示例</figcaption></figure><blockquote class="mk ml mm"><p id="4936" class="if ig lq ih b ii ij ik il im in io ip mn ir is it mo iv iw ix mp iz ja jb jc hb bi translated"><em class="hi">从BigQuery加载数据(示例)</em></p></blockquote><p id="ad0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以将BigQuery中的数据加载到python脚本中，如下所示:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="5830" class="je jf hi kr b fi kv kw l kx ky">import google.cloud.bigquery as bq<br/><br/>def get_geodataframe(table,columns):<br/>    sql_query = f"""<br/>        SELECT ST_GeogFrom(geometry) as geometry, {columns}<br/>        FROM {table}<br/>    """<br/>    geodataframe = bigquery_client.query(sql_query).to_geodataframe()<br/>    return geodataframe<br/><br/>cities_df = get_geodataframe(f"&lt;YOUR_GCP_PROJECT&gt;.&lt;DATASET_NAME&gt;.&lt;TABLE_NAME&gt;","&lt;COLUMNS_TO_DISPLAY&gt;")</span></pre><p id="54f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">get_geodataframe()函数提取整个表并返回一个geodataframe对象。</p><blockquote class="mk ml mm"><p id="6c92" class="if ig lq ih b ii ij ik il im in io ip mn ir is it mo iv iw ix mp iz ja jb jc hb bi translated"><em class="hi">更多示例查询</em></p></blockquote><p id="b2f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我另外创建了另外两个python函数来查询BigQuery数据集。在这种情况下，一个是仅通过名称选择地理要素，另一个是显示给定面内包含的所有点(例如，查看特定区域内有多少个城市)</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="94ee" class="je jf hi kr b fi kv kw l kx ky">def choose_feature(table,columns,feature_name):<br/>    sql_query = f"""<br/>        SELECT ST_GeogFrom(geometry) as geometry, {columns} FROM {table} WHERE reg_name = '{feature_name}'<br/>    """<br/>    geodataframe = bigquery_client.query(sql_query).to_geodataframe()<br/>    return geodataframe<br/><br/>def point_in_polygon(columns,points_table_id,polygons_table_id,polygons_key,polygons_value):<br/>    sql_query = f"""<br/>        SELECT {columns} FROM {points_table_id} as points <br/>        JOIN {polygons_table_id} as polygons <br/>        ON ST_Within(ST_GeogFrom(points.geometry), ST_GeogFrom(polygons.geometry)) <br/>        WHERE polygons.{polygons_key} = '{polygons_value}'<br/>    """<br/>    geodataframe = bigquery_client.query(sql_query).to_geodataframe()<br/>    return geodataframe</span></pre><h2 id="2f25" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">步骤6:在你的Github repo中安装云构建应用</h2><p id="5de9" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">Cloud Build是一项在Google Cloud上执行容器构建的服务。它通过从不同来源(云存储、云资源仓库、Github……)导入源代码来工作。要使Cloud Build能够使用Github作为源代码库自动构建容器，您必须在repo中安装Cloud Build应用程序。(别忘了分叉<a class="ae jd" href="https://github.com/mestredelpino/greppo-google-cloud" rel="noopener ugc nofollow" target="_blank">我的回购</a>，也就是你要安装云跑app的地方)</p><p id="a973" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，没有办法使用gcloud或git CLIs来执行安装，所以您必须使用Github的用户界面。</p><p id="55d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击<a class="ae jd" href="https://github.com/marketplace/google-cloud-build" rel="noopener ugc nofollow" target="_blank">此处</a>在你的Github repo中安装云构建应用。</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es mr"><img src="../Images/2256f40b3f5deee9ab4eee378b7e91df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KtSdMp3pVY2lbJeV08uLIg.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">Github市场中的谷歌云构建应用</figcaption></figure><h2 id="e501" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">步骤7:通过云构建自动化应用构建和部署流程</h2><p id="96b2" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">我们现在将创建一个云构建触发器，每当有新的推送到回购的“主”分支时，它将部署我们应用程序的新版本。你也可以创建更多指向其他分支的触发器，以便在把它们推到“主”分支之前测试你的应用程序的新特性。我写了一个相对简单的<a class="ae jd" href="https://github.com/mestredelpino/greppo-google-cloud/blob/main/cloud_build/config.yaml" rel="noopener ugc nofollow" target="_blank">构建配置文件</a>，它将执行这三个步骤:</p><p id="c1b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1.从源代码<br/> 2构建容器的新版本。将其推至容器注册表<br/> 3。将其作为应用程序的新版本部署到云运行</p><p id="e067" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们创建触发器:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="2d5e" class="je jf hi kr b fi kv kw l kx ky">gcloud beta builds triggers create github \<br/>    --name greppo-italy \<br/>    --branch-pattern="^main$" \<br/>    --repo-name=greppo-google-cloud \<br/>    --repo-owner=&lt;YOUR_GITHUB_USERNAME&gt; \<br/>    --build-config="./cloud_build/config.yaml" \<br/>    --substitutions _PROJECT=&lt;PROJECT_NAME&gt;,_DATASET=&lt;DATASET_NAME&gt;,_DEPLOY_REGION=&lt;YOUR_GCP_REGION&gt;,_SERVICE_NAME=&lt;YOUR_SERVICE_NAME&gt;,_MAX_INSTANCES=&lt;MAX_INSTANCES&gt;</span></pre><p id="8218" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以在云构建中看到新创建的触发器:</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es ms"><img src="../Images/4de9b8aaa4cae1851ad829163d83cc73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j8NBEQMYTf9_EqzqHfH27g.png"/></div></div></figure><p id="5c46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您现在不想对应用程序进行任何更改，您可以点击<strong class="ih hj"> RUN </strong>并手动触发构建。</p><p id="63bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您希望通过Internet访问您的应用程序，请通过运行以下命令来允许未经身份验证的用户:</p><pre class="kf kg kh ki fd kq kr ks kt aw ku bi"><span id="8dff" class="je jf hi kr b fi kv kw l kx ky">gcloud run services add-iam-policy-binding &lt;YOUR_SERVICE_NAME&gt; \<br/>    --member="allUsers" \<br/>    --role="roles/run.invoker" \<br/>    --region=&lt;YOUR_GCP_REGION&gt;</span></pre><p id="b3d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以转到云运行菜单中的应用程序，并单击外部链接，这将在新的浏览器选项卡上显示您正在运行的应用程序:</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es mt"><img src="../Images/a8eee249d1cf55a6544fb02ef10296bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m8M5naHUBIpRGN0Cnsbu1g.png"/></div></div></figure><h1 id="ad25" class="kz jf hi bd jg la lb lc jk ld le lf jo lg lh li jr lj lk ll ju lm ln lo jx lp bi translated">临终遗言</h1><p id="a0da" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">记住这一点很重要，您可以使用这种方法来部署许多不同的应用程序。我们的代码只是从BigQuery加载数据，并使用Greppo将其呈现在地图中(以及侧栏)。</p><p id="4bef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和我的许多博客一样，这对我来说既是一个学习的过程，也是一个分享我在一个特定主题上所学到的东西的机会。如果你有关于如何更好地实现的建议，请在下面的评论中告诉我。</p></div></div>    
</body>
</html>