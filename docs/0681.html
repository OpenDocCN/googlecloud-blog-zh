<html>
<head>
<title>How to push serial console output logs to Stackdriver and set alerts in GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将串行控制台输出日志推送到Stackdriver并在GCP设置警报</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-push-serial-console-output-logs-to-stackdriver-and-set-alerts-in-gcp-9c88c6401d2?source=collection_archive---------0-----------------------#2018-07-09">https://medium.com/google-cloud/how-to-push-serial-console-output-logs-to-stackdriver-and-set-alerts-in-gcp-9c88c6401d2?source=collection_archive---------0-----------------------#2018-07-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/2840f16dd7a120b3a8c149bce3bd5884.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eLrBS7_DugcA_QNKIA7a4w.jpeg"/></div></div></figure><div class=""/><p id="54f2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">GCP为所有虚拟机提供串行控制台。每个虚拟机都有4个串行端口。串行端口类似于终端窗口，支持输入和输出。它完全是基于全文的窗口，没有图形用户界面。这些端口将有助于解决引导管理器或GRUB相关问题。</p><h1 id="8362" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">我们可以从串行控制台看到哪些日志:</h1><ul class=""><li id="31f2" class="km kn ht is b it ko ix kp jb kq jf kr jj ks jn kt ku kv kw bi translated">操作系统日志(sysprep期间)</li><li id="f660" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">基本输入输出系统</li><li id="6f29" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">系统级条目</li></ul><p id="5de0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">大多数系统级条目在串行端口1中捕获。</p><p id="ccd2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要阅读更多关于串行控制台的详细信息，请参考GCP的官方文档。</p><div class="hh hi ez fb hj lc"><a href="https://cloud.google.com/compute/docs/instances/interacting-with-serial-console" rel="noopener  ugc nofollow" target="_blank"><div class="ld ab dw"><div class="le ab lf cl cj lg"><h2 class="bd hu fi z dy lh ea eb li ed ef hs bi translated">与串行控制台交互|计算引擎文档|谷歌云</h2><div class="lj l"><h3 class="bd b fi z dy lh ea eb li ed ef dx translated">一个虚拟机实例有四个虚拟串行端口。与串行端口交互类似于使用终端…</h3></div><div class="lk l"><p class="bd b fp z dy lh ea eb li ed ef dx translated">cloud.google.com</p></div></div><div class="ll l"><div class="lm l ln lo lp ll lq hp lc"/></div></div></a></div><h1 id="66a9" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">为什么我们要检查这些日志？</h1><p id="99d3" class="pw-post-body-paragraph iq ir ht is b it ko iv iw ix kp iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">我们正在私有子网中设置一个自动扩展组，并使用NAT进行外部互联网通信。在自动缩放期间，将启动Windows映像(完全加固)。sysprep完成后，它将与微软KMS服务器通信，获取新的保护密钥并激活Windows操作系统。但是在我们的例子中，与KMS的通讯失败了，在发射过程中窗户没有被激活。</p><p id="6981" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些完整的信息将由串行控制台提供。因此，我们决定将日志推送到StackDriver，并在windows未激活时设置警报。</p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lu"><img src="../Images/091fc31d576225b91c28f3bac34412f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NoQPa4hOoRFI-Kannc9hUQ.png"/></div></div></figure><h1 id="8858" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">获取串行控制台日志的方法</h1><ul class=""><li id="3f18" class="km kn ht is b it ko ix kp jb kq jf kr jj ks jn kt ku kv kw bi translated">GCP计算引擎页面</li><li id="b477" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated"><a class="ae lz" href="https://cloud.google.com/compute/docs/reference/rest/v1/instances/getSerialPortOutput" rel="noopener ugc nofollow" target="_blank">获取串行端口输出</a> api</li><li id="f935" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">gcloud cli</li></ul><h1 id="870a" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">getSerialPortOutput API有问题</h1><p id="cced" class="pw-post-body-paragraph iq ir ht is b it ko iv iw ix kp iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">要调用这个API，我们应该使用Oauth。如果我们需要使用OAuth，那么我们需要创建另一个API来生成令牌。仅仅使用由GCP凭证生成的API密钥是行不通的。您将得到下面的错误。</p><pre class="lv lw lx ly fd ma mb mc md aw me bi"><span id="bcd8" class="mf jp ht mb b fi mg mh l mi mj">{<br/>  "error": {<br/>    "errors": [<br/>      {<br/>        "domain": "global",<br/>        "reason": "required",<br/>        "message": "Login Required",<br/>        "locationType": "header",<br/>        "location": "Authorization"<br/>      }<br/>    ],<br/>    "code": 401,<br/>    "message": "Login Required"<br/>  }<br/>}</span></pre><h1 id="50ff" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">我们如何实施解决方案:</h1><ul class=""><li id="aff3" class="km kn ht is b it ko ix kp jb kq jf kr jj ks jn kt ku kv kw bi translated">将服务帐户连接到有权查看虚拟机元数据的虚拟机。</li><li id="8164" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">使用g cloud CLI<a class="ae lz" href="https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output" rel="noopener ugc nofollow" target="_blank">get-serial-port-output</a>获取启动中的日志。</li><li id="44e0" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">将这些日志推送到堆栈驱动程序日志。</li><li id="e52e" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">Grep这个词没有激活。</li><li id="72d8" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">如果发现，发送警报。</li></ul><p id="faee" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇博客中，我们将测试日志是否有启动脚本。</p><h1 id="36bb" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">创建服务帐户:</h1><p id="a14e" class="pw-post-body-paragraph iq ir ht is b it ko iv iw ix kp iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">进入IAM &amp; Admin -&gt; <a class="ae lz" href="https://console.cloud.google.com/iam-admin/serviceaccounts/" rel="noopener ugc nofollow" target="_blank">服务账户</a></p><ul class=""><li id="19d2" class="km kn ht is b it iu ix iy jb mk jf ml jj mm jn kt ku kv kw bi translated">创建服务帐户。</li><li id="cbc4" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">附加以下角色。</li></ul><pre class="lv lw lx ly fd ma mb mc md aw me bi"><span id="8ef5" class="mf jp ht mb b fi mg mh l mi mj">Compute Engine -&gt; Compute Instance Admin (v1)<br/>Logging -&gt; Logs Writer<br/>Monitoring -&gt; Monitoring Metric Writer</span></pre><h1 id="437e" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">添加启动脚本:</h1><p id="c2f5" class="pw-post-body-paragraph iq ir ht is b it ko iv iw ix kp iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">虚拟机上安装了Google Cloud SDK(如果没有，请使用Google Cloud SDK创建您的黄金映像)。</p><p id="ebd8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">用于获取Windows实例的日志:</strong></p><p id="6628" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在自定义元数据中，添加Powershell作为启动。</p><pre class="lv lw lx ly fd ma mb mc md aw me bi"><span id="15d5" class="mf jp ht mb b fi mg mh l mi mj"><strong class="mb hu"><em class="mn">Key</em></strong>: sysprep-specialize-script-ps1<br/><strong class="mb hu"><em class="mn">Value</em></strong>:$msg=gcloud compute --project=your_project_name instances get-serial-port-output vm_name --zone=instance_zone | select-string -Pattern "Starting startup scripts"  -Context 1,10<br/>$log=$msg -replace "&gt;","" -replace "\n"<br/>gcloud logging write windows-serial-log  $log --severity=ERROR</span></pre><p id="16b8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想为Linux使用捕获一些东西，请在自动化脚本中使用以下云CLI命令。</p><p id="28c5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在自动化中添加下面的脚本。</p><pre class="lv lw lx ly fd ma mb mc md aw me bi"><span id="87c6" class="mf jp ht mb b fi mg mh l mi mj">gcloud logging write linux-serial-log "$(gcloud compute --project=your_project_name instances get-serial-port-output vm_name --zone=instance_zone | awk '/Checking instance license/ ? c++ : c')" --severity=ERROR</span></pre><h1 id="32c3" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">获取StackDriver日志记录中的日志:</h1><ul class=""><li id="7a07" class="km kn ht is b it ko ix kp jb kq jf kr jj ks jn kt ku kv kw bi translated">前往日志<a class="ae lz" href="https://console.cloud.google.com/logs/viewer" rel="noopener ugc nofollow" target="_blank">查看器</a>。</li><li id="17a3" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">选择资源作为全局资源。</li><li id="2673" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">将日志分组为windows-serial-log。</li><li id="7d93" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">对于Linux，选择linux-serial-log。</li></ul><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mo"><img src="../Images/f12017eea502c695c50c73008e10ee32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q9fb-hC4JuzjiX0xu2JuNg.png"/></div></div></figure><p id="a0a2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将这些日志称为<code class="du mp mq mr mb b">--ERROR.</code></p><p id="8a81" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，这将显示为橙色标志，如果您选择<code class="du mp mq mr mb b">— -CRITICAL</code>，它将显示为红色。</p><ul class=""><li id="312e" class="km kn ht is b it iu ix iy jb mk jf ml jj mm jn kt ku kv kw bi translated">展开日志，我们可以看到启动脚本。</li></ul><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ms"><img src="../Images/6cd240424f0856cd7495da7f5b9551fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T72mtsAwh6--_D5D0vdJZg.png"/></div></div></figure><h1 id="5285" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">设置警报:</h1><ul class=""><li id="1b0b" class="km kn ht is b it ko ix kp jb kq jf kr jj ks jn kt ku kv kw bi translated">单击文本有效负载，然后单击显示匹配条目。</li><li id="bdfa" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">在筛选器框中，键入以下命令。</li><li id="ecc8" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">它会显示匹配的日志。</li><li id="07db" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">然后单击提交过滤器。</li></ul><pre class="lv lw lx ly fd ma mb mc md aw me bi"><span id="4431" class="mf jp ht mb b fi mg mh l mi mj">resource.type="global"<br/>logName="projects/YOUR_PROJECT_NAME/logs/windows-serial-log"<br/>textPayload:"Starting startup scripts"</span></pre><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mt"><img src="../Images/8e04a1f15ffb921f5e9515d4508fd8cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hR8EWptFuA3YcqviR6BHtA.png"/></div></div></figure><ul class=""><li id="41b7" class="km kn ht is b it iu ix iy jb mk jf ml jj mm jn kt ku kv kw bi translated">然后单击创建度量。</li><li id="b1dd" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">给出名称和描述。</li></ul><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mu"><img src="../Images/3745d556358266b519de3cf811f6dcaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dGKQRzAUmt4g8Xkn2ixZsA.png"/></div></div></figure><p id="ff16" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">现在是玩StackDriver的时候了。</strong></p><ul class=""><li id="c1aa" class="km kn ht is b it iu ix iy jb mk jf ml jj mm jn kt ku kv kw bi translated">转到警报-&gt;创建策略。</li></ul><figure class="lv lw lx ly fd hk er es paragraph-image"><div class="er es mv"><img src="../Images/4d6fffe78633128e714bcaf526cf3012.png" data-original-src="https://miro.medium.com/v2/resize:fit:838/format:webp/1*LvIijd9w1AmYxbIAix88Lg.png"/></div></figure><ul class=""><li id="abe9" class="km kn ht is b it iu ix iy jb mk jf ml jj mm jn kt ku kv kw bi translated">单击添加条件-&gt;指标阈值/费率变化/缺勤。</li><li id="f616" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">在目标中键入您创建的度量名称。</li></ul><figure class="lv lw lx ly fd hk er es paragraph-image"><div class="er es mw"><img src="../Images/36b561ae72410ceab82f4364689d6215.png" data-original-src="https://miro.medium.com/v2/resize:fit:708/format:webp/1*1nRVms9NLM7UDmaQqv-tAQ.png"/></div></figure><ul class=""><li id="f075" class="km kn ht is b it iu ix iy jb mk jf ml jj mm jn kt ku kv kw bi translated">在配置中，根据需要设置阈值。</li><li id="418e" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">单击保存条件。</li><li id="cfe2" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">现在，在通知中添加电子邮件地址。</li><li id="1442" class="km kn ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">给定一个名称并保存策略。</li></ul><p id="ec4a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在启动一个VM，它会将日志推送到StackDriver。如果它发现任何像<code class="du mp mq mr mb b">Starting startup scripts</code>一样的匹配模式，它会发送电子邮件。</p><figure class="lv lw lx ly fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mx"><img src="../Images/ff42aace8b7b6a2c18582551719216e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZbiLRwUvaBxOZiH6FrSeZg.png"/></div></div></figure><p id="8af9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该是你玩串行控制台日志和StackDriver的时候了。希望这对你有所帮助，如果你也打算尝试一下，请在此之前随意鼓掌:)</p></div><div class="ab cl my mz gp na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="hb hc hd he hf"><p id="cef3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">原载于2018年7月08日<a class="ae lz" rel="noopener" href="/searce/how-to-push-serial-console-output-logs-to-stackdriver-and-set-alerts-in-gcp-1a4d61da7c4c"> Searce工程博客</a>。</p></div></div>    
</body>
</html>