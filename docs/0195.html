<html>
<head>
<title>Build AWS S3 compatible cloud storage on GCP with Minio and Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Minio和Kubernetes在GCP构建AWS S3兼容云存储</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/build-aws-s3-compatible-cloud-storage-on-gcp-with-minio-and-kubernetes-2adc0a367f98?source=collection_archive---------0-----------------------#2017-01-26">https://medium.com/google-cloud/build-aws-s3-compatible-cloud-storage-on-gcp-with-minio-and-kubernetes-2adc0a367f98?source=collection_archive---------0-----------------------#2017-01-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5153" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">今天的应用程序<a class="ae jd" href="https://blog.minio.io/object-storage-what-is-it-all-about-62920ca164ca#.qfa0ylbd1" rel="noopener ugc nofollow" target="_blank">产生的数据比以往任何时候都多</a>，这种上升趋势<a class="ae jd" href="https://www.emc.com/leadership/digital-universe/2014iview/executive-summary.htm" rel="noopener ugc nofollow" target="_blank">预计将在可预见的未来保持</a>。您如何应对应用程序不断增长的存储需求？一个能够在您的应用程序运行的地方运行，并且能够以自动化的方式随之扩展的存储解决方案才是正确的选择。添加多租户功能，它变得近乎完美！</p><p id="6cb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Minio提供了一个可靠的轻量级对象存储服务。在像Kubernetes这样的编排平台上运行它，增加了自动化存储映射和多租户功能。这种设置具有清晰的关注点分离——可伸缩性的最重要参数之一。此外，在这种设置中很容易找到并隔离错误。</p><blockquote class="je"><p id="71da" class="jf jg hi bd jh ji jj jk jl jm jn jc dx translated">运行在Kubernetes等编排平台上的Minio是满足不断增长的存储需求的完美解决方案。</p></blockquote><p id="2519" class="pw-post-body-paragraph if ig hi ih b ii jo ik il im jp io ip iq jq is it iu jr iw ix iy js ja jb jc hb bi translated">在本帖中，我们将看到如何用Minio和Kubernetes在Google云平台上构建AWS S3兼容的对象存储服务器。我们还将了解如何为多租户环境扩展这种设置。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/4dcf529075f20ef67b626fd38e235fbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b1ERH92Sd7Dnn0FiQm1EjQ.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx translated">运行在GCE上的Kubernetes集群上的Minio实例</figcaption></figure><h2 id="19d8" class="kj kk hi bd kl km kn ko kp kq kr ks kt iq ku kv kw iu kx ky kz iy la lb lc ld bi translated">Minio是什么？</h2><p id="6f3f" class="pw-post-body-paragraph if ig hi ih b ii le ik il im lf io ip iq lg is it iu lh iw ix iy li ja jb jc hb bi translated">Minio是一个轻量级的、兼容AWS S3的对象存储服务器。它最适合存储照片、视频、日志文件、备份、虚拟机和容器映像等非结构化数据。对象的大小可以从几千字节到最大5TB不等。Minio的突出特点包括</p><ul class=""><li id="e70c" class="lj lk hi ih b ii ij im in iq ll iu lm iy ln jc lo lp lq lr bi translated"><a class="ae jd" href="https://docs.minio.io/docs/minio-erasure-code-quickstart-guide" rel="noopener ugc nofollow" target="_blank">用于bitrot保护的擦除编码</a>。</li><li id="29fe" class="lj lk hi ih b ii ls im lt iq lu iu lv iy lw jc lo lp lq lr bi translated"><a class="ae jd" href="https://docs.minio.io/docs/golang-client-api-reference#ListenBucketNotification" rel="noopener ugc nofollow" target="_blank"> Lambda功能</a>通过事件通知服务支持。</li><li id="ea1f" class="lj lk hi ih b ii ls im lt iq lu iu lv iy lw jc lo lp lq lr bi translated">S3版本4和S3 V2签名支持。</li><li id="fc9c" class="lj lk hi ih b ii ls im lt iq lu iu lv iy lw jc lo lp lq lr bi translated"><a class="ae jd" href="https://github.com/minio/minio/tree/master/docs/distributed" rel="noopener ugc nofollow" target="_blank">分布式模式</a>。</li></ul><h2 id="9923" class="kj kk hi bd kl km kn ko kp kq kr ks kt iq ku kv kw iu kx ky kz iy la lb lc ld bi translated">Kubernetes术语</h2><p id="b4ed" class="pw-post-body-paragraph if ig hi ih b ii le ik il im lf io ip iq lg is it iu lh iw ix iy li ja jb jc hb bi translated">对于不了解Kubernetes术语的读者，我将快速浏览一下本文中使用的所有术语。</p><p id="d79c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://kubernetes.io/docs/user-guide/pods/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">Pod</strong></a><strong class="ih hj">:</strong>Pod是Kubernetes中最小的计算单位。它是一组在共享上下文中运行的容器。</p><p id="219a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://kubernetes.io/docs/user-guide/replicasets/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">副本集</strong> </a> <strong class="ih hj"> : </strong>副本集确保特定数量的pod副本始终启动并运行。虽然副本集是独立的实体，但它们主要由<a class="ae jd" href="https://kubernetes.io/docs/user-guide/deployments/" rel="noopener ugc nofollow" target="_blank">部署</a>用作协调pod创建、删除和更新的机制。</p><p id="b01a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://kubernetes.io/docs/user-guide/deployments/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">部署</strong> </a> <strong class="ih hj"> : </strong>一个部署可以被认为是一个包含pod和ReplicaSet的抽象。</p><p id="d45d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://kubernetes.io/docs/user-guide/services/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">服务</strong> </a> <strong class="ih hj"> : </strong>服务定义了一组逻辑单元和访问它们的策略。服务所针对的pod集由标签选择器决定(在服务的yaml文件中定义)。</p><p id="0172" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://kubernetes.io/docs/user-guide/persistent-volumes/#introduction" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">持久卷</strong> </a>:持久卷(PV)是集群中的一块网络存储，抽象出了存储的具体细节。</p><p id="372c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="http://kubernetes.io/docs/user-guide/persistent-volumes/#persistentvolumeclaims" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">持久卷声明</strong> </a>:持久卷声明(PVC)是应用程序/pod对存储的请求。</p><h2 id="83a6" class="kj kk hi bd kl km kn ko kp kq kr ks kt iq ku kv kw iu kx ky kz iy la lb lc ld bi translated">Kubernetes装置</h2><p id="7c18" class="pw-post-body-paragraph if ig hi ih b ii le ik il im lf io ip iq lg is it iu lh iw ix iy li ja jb jc hb bi translated">首先，您需要一个运行在Google Compute Engine (GCE)上的Kubernetes集群。按照这些<a class="ae jd" href="http://kubernetes.io/docs/getting-started-guides/gce/" rel="noopener ugc nofollow" target="_blank">详细步骤</a>在GCE上设置Kubernetes集群。</p><h2 id="8d4e" class="kj kk hi bd kl km kn ko kp kq kr ks kt iq ku kv kw iu kx ky kz iy la lb lc ld bi translated">配置存储</h2><p id="f072" class="pw-post-body-paragraph if ig hi ih b ii le ik il im lf io ip iq lg is it iu lh iw ix iy li ja jb jc hb bi translated">通过持久卷(PV)和持久卷声明(PVC)，Kubernetes可以非常轻松地从您的应用程序中提取物理存储细节。您可以使用集群中的物理存储创建PVs，然后让您的应用程序通过PVC请求它需要的存储。由于存储请求是通过PVC发出的，Kubernetes会自动将其映射到实际存储(PVs)。</p><p id="5c08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们在Google计算引擎环境中进一步探讨这个问题。GCE有<a class="ae jd" href="https://cloud.google.com/compute/docs/disks/add-persistent-disk#create_disk" rel="noopener ugc nofollow" target="_blank">个磁盘</a>，用作计算节点的物理存储。在Kubernetes上，您可以创建使用这些磁盘作为主干物理存储的PV。</p><p id="2d05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">稍后，当您在Kubernetes集群上部署Minio时，您可以创建PVC来请求特定Minio实例所需的存储。Kubernetes自动将匹配的PV绑定到PVC。这在Kubernetes世界中被称为静态绑定，是的，也有动态绑定，但我们现在跳过它。点击阅读更多关于绑定<a class="ae jd" href="http://kubernetes.io/docs/user-guide/persistent-volumes/#binding" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><p id="c76c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在您已经清楚了事情是如何工作的，让我们从创建GCE磁盘开始。</p><pre class="ju jv jw jx fd lx ly lz ma aw mb bi"><span id="cba8" class="kj kk hi ly b fi mc md l me mf">$ gcloud compute disks create minio-1 --size=10GiB</span></pre><p id="86f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将创建一个名为<code class="du mg mh mi ly b">disk1</code>的磁盘，大小为<code class="du mg mh mi ly b">10GiB</code>。现在，基于我们刚刚创建的GCE磁盘创建一个PV。</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="mj mk l"/></div><figcaption class="kf kg et er es kh ki bd b be z dx translated"><a class="ae jd" href="https://gist.github.com/NitishT/2f55d9bc3425b7e1679d3f52d9020df3" rel="noopener ugc nofollow" target="_blank"> minio-gce-pv.yaml </a>文件</figcaption></figure><p id="1058" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://gist.githubusercontent.com/NitishT/2f55d9bc3425b7e1679d3f52d9020df3/raw/990febef8b3c321b9cde3cdac30258fc7bdd2ff1/minio-gce-pv.yaml" rel="noopener ugc nofollow" target="_blank">下载</a>并将文件保存为<em class="ml"> minio-gce-pv.yaml </em>。然后，您可以使用以下命令创建永久卷:</p><pre class="ju jv jw jx fd lx ly lz ma aw mb bi"><span id="0d5f" class="kj kk hi ly b fi mc md l me mf">$ kubectl create -f minio-gce-pv.yaml</span></pre><h2 id="90db" class="kj kk hi bd kl km kn ko kp kq kr ks kt iq ku kv kw iu kx ky kz iy la lb lc ld bi translated">部署Minio</h2><p id="47a5" class="pw-post-body-paragraph if ig hi ih b ii le ik il im lf io ip iq lg is it iu lh iw ix iy li ja jb jc hb bi translated">部署封装了副本集和pod，因此，如果一个pod关闭，副本集会确保另一个pod自动启动。这样你就不需要担心pod故障，并且有一个稳定的Minio服务可用。</p><p id="1a46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是在创建部署之前，我们需要创建一个持久卷声明(PVC)来为Minio实例请求存储。如上所述，Kubernetes在集群中寻找与PVC请求匹配的PV，并自动将其绑定到PVC。</p><p id="6c3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您需要一个具有不同存储需求的大规模多租户环境，这种自动化会非常方便。您可以加速每个租户的Minio部署(PVC请求适当的存储)。Kubernetes自动将PVC绑定到PVs。这样，您就拥有了一个多租户的、稳定的、S3兼容的对象存储服务器！</p><p id="6131" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是如何创建运行Minio Docker映像的PVC和单pod部署。</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="mj mk l"/></div><figcaption class="kf kg et er es kh ki bd b be z dx translated"><a class="ae jd" href="https://gist.github.com/NitishT/d8a32eef314d8cb826c80ecab4ddc786" rel="noopener ugc nofollow" target="_blank">minio-独立-部署。<em class="mm">YAML</em>T13】文件</a></figcaption></figure><p id="839e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://gist.githubusercontent.com/NitishT/d8a32eef314d8cb826c80ecab4ddc786/raw/b04817715628f6f68a7bea543d80d60524442609/minio-standalone-deployment.yaml" rel="noopener ugc nofollow" target="_blank">下载</a>并将文件保存为<em class="ml">minio-standalone-deployment . YAML</em>。请注意，我们首先创建PVC，然后部署使用它作为其卷。然后，您可以使用以下命令部署Minio:</p><pre class="ju jv jw jx fd lx ly lz ma aw mb bi"><span id="b335" class="kj kk hi ly b fi mc md l me mf">$ kubectl create -f minio-standalone-deployment.yaml</span></pre><h2 id="2403" class="kj kk hi bd kl km kn ko kp kq kr ks kt iq ku kv kw iu kx ky kz iy la lb lc ld bi translated">将Minio作为服务公开</h2><p id="746e" class="pw-post-body-paragraph if ig hi ih b ii le ik il im lf io ip iq lg is it iu lh iw ix iy li ja jb jc hb bi translated">现在您已经有了一个正在运行的Minio部署，您可能希望在内部(在集群内)访问它，或者将它作为一个服务公开到一个外部(在集群之外，可能是公共互联网)IP地址上，这取决于您的用例。</p><p id="7dcb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用<em class="ml">服务</em>来实现这一点。有3种主要的服务类型—默认类型是<em class="ml">集群IP </em>，它向集群内部的连接公开服务。<em class="ml">节点端口</em>和<em class="ml">负载平衡器</em>是向外部流量公开服务的两种类型。点击阅读更多关于服务<a class="ae jd" href="http://kubernetes.io/docs/user-guide/services/#publishing-services---service-types" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><p id="c2e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的yaml文件为您的Minio部署配置了一个<em class="ml">负载平衡器</em>服务。</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="mj mk l"/></div><figcaption class="kf kg et er es kh ki bd b be z dx translated"><a class="ae jd" href="https://gist.github.com/NitishT/23446d053bd4fbef1676dcaa8eed54f7" rel="noopener ugc nofollow" target="_blank">迷你服务。<em class="mm">YAML</em>T15】文件</a></figcaption></figure><p id="dbc2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://gist.githubusercontent.com/NitishT/23446d053bd4fbef1676dcaa8eed54f7/raw/061eceef5dc166b7ab2e7345fba0ca8be09b6110/minio-standalone-service.yaml" rel="noopener ugc nofollow" target="_blank">下载</a>并将该文件保存为<em class="ml"> minio-service.yaml </em>并运行命令—</p><pre class="ju jv jw jx fd lx ly lz ma aw mb bi"><span id="e843" class="kj kk hi ly b fi mc md l me mf">$ kubectl create -f minio-service.yaml</span></pre><p id="2fe8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行上述命令后，通常需要几分钟时间来创建服务的IP地址。您可以使用以下方法检查IP地址—</p><pre class="ju jv jw jx fd lx ly lz ma aw mb bi"><span id="96b5" class="kj kk hi ly b fi mc md l me mf">$ kubectl get services</span></pre><p id="155f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦您有了可用的IP地址，您就可以通过该地址访问Minio</p><p id="3748" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">http:// <service_ip_address> :9000/</service_ip_address></p><p id="7a4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">访问密钥和秘密密钥保持与在<em class="ml">minio-standalone-deployment . YAML</em>中设置的环境变量相同。</p><blockquote class="mn mo mp"><p id="b09f" class="if ig ml ih b ii ij ik il im in io ip mq ir is it mr iv iw ix ms iz ja jb jc hb bi translated">请注意，只有当底层云提供商支持外部负载平衡时，负载平衡器才会工作。</p></blockquote><h2 id="f76d" class="kj kk hi bd kl km kn ko kp kq kr ks kt iq ku kv kw iu kx ky kz iy la lb lc ld bi translated">监视</h2><p id="4d47" class="pw-post-body-paragraph if ig hi ih b ii le ik il im lf io ip iq lg is it iu lh iw ix iy li ja jb jc hb bi translated">Kubernetes附带一个整洁的仪表板。您可以通过仪表板轻松跟踪Minio pod的内存、CPU使用情况和许多其他指标。</p><p id="9b6b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要访问仪表板，请执行以下命令—</p><pre class="ju jv jw jx fd lx ly lz ma aw mb bi"><span id="3b25" class="kj kk hi ly b fi mc md l me mf">$ kubectl cluster-info</span></pre><p id="1f3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">访问kubernetes-dashboard中提到的URL。这是我的仪表板的样子</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es mt"><img src="../Images/981901e8bd1961fa65d5e0a3568cfc99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YyXgTVqkM0KuSgKraOuxzw.png"/></div></div></figure><p id="304b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要帮助吗？我们在<a class="ae jd" href="http://slack.minio.io" rel="noopener ugc nofollow" target="_blank">懈怠</a>中闲逛。加入我们吧！</p></div></div>    
</body>
</html>