<html>
<head>
<title>How to find the interior centroid of US counties using BigQuery GIS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用BigQuery GIS找到美国各县的内部质心</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-find-the-interior-centroid-of-us-counties-using-bigquery-gis-de396f0fad03?source=collection_archive---------2-----------------------#2020-04-16">https://medium.com/google-cloud/how-to-find-the-interior-centroid-of-us-counties-using-bigquery-gis-de396f0fad03?source=collection_archive---------2-----------------------#2020-04-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="bc32" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">如何处理质心在五大湖区的问题</h2></div><p id="1fd0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jt">同</em> <a class="ae ju" rel="noopener" href="/@easchmidt">同<em class="jt">施密特</em>同</a></p><p id="b3f6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在尝试使用一个刚刚推出的BigQuery数据集来绘制各县的新冠肺炎确诊病例数据时，我们注意到了一个问题。总的来说，地图看起来不错:</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es jv"><img src="../Images/8c568270326cac0f59db1809fa73b98b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YNosTEUwlgj0mpz_AczyCw.png"/></div></div></figure><h2 id="6e79" class="kh ki hi bd kj kk kl km kn ko kp kq kr jg ks kt ku jk kv kw kx jo ky kz la lb bi translated">州与州之间的海上边界带来的问题</h2><p id="9d7c" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">不过，就地图而言，细节很重要。这张地图的每个用户都会放大到他们居住的地方。任何住在上密歇根州海岸线的用户都会立即注意到一个问题:</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div class="er es lh"><img src="../Images/2f705f8768612757c9cf4c3d9996a8a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:380/format:webp/1*uGO7mcdgCAuJOCOp1a-JEg.png"/></div></figure><p id="5982" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意他们县的数据在水里！这是为什么呢？</p><p id="3312" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因为美国的县界到了州或国家的边界。通常，这不是问题，但在这里，边界是海上边界，位于五大湖的中途。这是另一个例子，这次是在美加边境:</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div class="er es li"><img src="../Images/6b078445a11c12389b08cf66b7e37e0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*5O0B7Kvef1H6Y42a3XpIYw.png"/></div></figure><p id="5052" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当你创建像新冠肺炎确诊病例这样的地图时，你希望标记在人们生活的地方，而不是在水里。在本文中，我将向您展示如何创建一个位于该县土地质心的地图标记。</p><h2 id="e8ce" class="kh ki hi bd kj kk kl km kn ko kp kq kr jg ks kt ku jk kv kw kx jo ky kz la lb bi translated">想法一:海岸线</h2><p id="2185" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">第一个想法是对海岸线边界数据集进行空间连接，然后找到县边界和海岸线之间的交叉点(公共区域)。这应该只给我们陆地面积。</p><p id="0c7f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">BigQuery拥有美国地理边界的公共数据集，因此我们可以这样做:</p><pre class="jw jx jy jz fd lj lk ll lm aw ln bi"><span id="ce29" class="kh ki hi lk b fi lo lp l lq lr">WITH land_only AS (<br/> SELECT <br/>   county_name, <br/>  <strong class="lk hj"> ST_Intersection</strong>(county_geom, coastline_geom) AS county_geom<br/> FROM `bigquery-public-data.geo_us_boundaries.counties`, <br/>      `bigquery-public-data.geo_us_boundaries.coastline`<br/> WHERE state_fips_code = '26' -- Michigan<br/>       AND ST_Intersects(county_geom, coastline_geom)<br/>)</span><span id="a16f" class="kh ki hi lk b fi ls lp l lq lr">SELECT <br/>county_name,<br/>ST_Centroid(county_geom) AS map_marker,<br/>county_geom<br/>FROM land_only</span></pre><p id="c74a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以使用BigQuery GeoViz可视化结果，这告诉我们该方法不起作用:</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div class="er es lt"><img src="../Images/037f37c89d7c0891584db8ed2bd65144.png" data-original-src="https://miro.medium.com/v2/resize:fit:754/format:webp/1*xgS4SLt2LfsZynhAzh2n-w.png"/></div></figure><p id="aefe" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，这种技术对于岛屿非常有效(因为岛屿是多边形)，但对于其他县则不然，因为一般来说，美国的海岸线是由多条线组成的，而不是多边形。</p><h2 id="065b" class="kh ki hi bd kj kk kl km kn ko kp kq kr jg ks kt ku jk kv kw kx jo ky kz la lb bi translated">想法二:加入邮政编码</h2><p id="8ff9" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">美国邮政编码实际上是一个邮路集合的边界框。由于邮局不会在水中投递邮件，我们可以把邮政编码的边界看作是由人口组成的区域。</p><p id="2dc6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们看看每个县的邮政编码是什么样的:</p><pre class="jw jx jy jz fd lj lk ll lm aw ln bi"><span id="f620" class="kh ki hi lk b fi lo lp l lq lr">SELECT<br/>    county,<br/>    TO_JSON_STRING(ARRAY_AGG(zip_code)) AS zip_codes,<br/>  FROM `bigquery-public-data`.geo_us_boundaries.zip_codes<br/>  WHERE state_fips_code = '26' -- Michigan<br/>  GROUP BY county</span></pre><h2 id="7ebc" class="kh ki hi bd kj kk kl km kn ko kp kq kr jg ks kt ku jk kv kw kx jo ky kz la lb bi translated">3.清理邮政编码数据</h2><p id="ef19" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">我们注意到一些邮政编码(如49684)覆盖几个国家:</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es lu"><img src="../Images/43d3e959019295e0fed8243f6830a4f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*82BbyIEZcNr-we-h8KlbMg.png"/></div></div></figure><p id="5895" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，我们需要拆分county字段，并将49864放入每个县。还有一个问题。在某些情况下，县名会写成Ostego、Ostego county或ostego County。因此，这里有一个函数将进行必要的清理:</p><pre class="jw jx jy jz fd lj lk ll lm aw ln bi"><span id="8902" class="kh ki hi lk b fi lo lp l lq lr">CREATE OR REPLACE FUNCTION advdata.cleanup_county_name(county_split STRING) AS<br/>(<br/>  TRIM(REPLACE(UPPER(county_split), 'COUNTY', ''))<br/>)</span></pre><p id="743e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建一个县到邮政编码的表，并对所有的几何图形进行联合:</p><pre class="jw jx jy jz fd lj lk ll lm aw ln bi"><span id="1fec" class="kh ki hi lk b fi lo lp l lq lr">CREATE OR REPLACE TABLE advdata.michigan_zipcodes AS<br/>  SELECT<br/>    advdata.cleanup_county_name(county_split) AS county,<br/>    TO_JSON_STRING(ARRAY_AGG(zip_code)) AS zip_codes,<br/>    <strong class="lk hj">ST_Union</strong>(ARRAY_AGG(zip_code_geom)) AS population_geom<br/>  FROM `bigquery-public-data`.geo_us_boundaries.zip_codes, UNNEST(SPLIT(county, ',')) AS county_split<br/>  WHERE state_fips_code = '26' -- Michigan<br/>  GROUP BY advdata.cleanup_county_name(county_split)</span></pre><h2 id="b403" class="kh ki hi bd kj kk kl km kn ko kp kq kr jg ks kt ku jk kv kw kx jo ky kz la lb bi translated">4.创建标记</h2><p id="bf46" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">现在，我们可以做标记，每个县对应一个标记，方法是根据邮政编码边界进行交叉:</p><pre class="jw jx jy jz fd lj lk ll lm aw ln bi"><span id="1459" class="kh ki hi lk b fi lo lp l lq lr">CREATE OR REPLACE TABLE advdata.michigan_landareas AS</span><span id="0bb6" class="kh ki hi lk b fi ls lp l lq lr">WITH land_only AS (<br/>  SELECT <br/>    lsad_name, int_point_geom,<br/>    ST_Intersection(county_geom, population_geom) AS county_geom<br/>  FROM `bigquery-public-data.geo_us_boundaries.counties`<br/>  JOIN advdata.michigan_zipcodes<br/>  ON advdata.cleanup_county_name(lsad_name) = county<br/>  WHERE state_fips_code = '26' -- Michigan<br/>)</span><span id="fd17" class="kh ki hi lk b fi ls lp l lq lr">SELECT <br/>  lsad_name,<br/>  int_point_geom,<br/>  ST_Centroid(county_geom) AS map_marker,<br/>  county_geom<br/>FROM land_only</span></pre><p id="9c35" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这样做之后，我们现在有了一个表，其中每个县都有一个map_marker点。我们可以用它来绘制任何基于点的县级数据。</p><h2 id="a10b" class="kh ki hi bd kj kk kl km kn ko kp kq kr jg ks kt ku jk kv kw kx jo ky kz la lb bi translated">5.扩展到所有状态</h2><p id="c65e" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">到目前为止，这些查询只针对密歇根州，因此我们可以快速地对它们进行测试。现在，不要硬编码state_fips_code='26 '，让我们对美国所有的州都这样做。我们将结果存储在名为reference的数据集中。</p><p id="095a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">县城清理功能:</p><pre class="jw jx jy jz fd lj lk ll lm aw ln bi"><span id="99f0" class="kh ki hi lk b fi lo lp l lq lr">CREATE OR REPLACE FUNCTION reference.cleanup_county_name(county_split STRING) AS<br/>(<br/>  TRIM(REPLACE(UPPER(county_split), 'COUNTY', ''))<br/>)</span></pre><p id="741d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，在where子句中，state fips被添加到组中，而Michigan被删除:</p><pre class="jw jx jy jz fd lj lk ll lm aw ln bi"><span id="473c" class="kh ki hi lk b fi lo lp l lq lr">CREATE OR REPLACE TABLE reference.zipcodes AS<br/>  SELECT<br/>    state_fips_code,<br/>    reference.cleanup_county_name(county_split) AS county,<br/>    TO_JSON_STRING(ARRAY_AGG(zip_code)) AS zip_codes,<br/>    ST_Union(ARRAY_AGG(zip_code_geom)) AS population_geom<br/>  FROM `bigquery-public-data`.geo_us_boundaries.zip_codes, UNNEST(SPLIT(county, ',')) AS county_split<br/>  GROUP BY state_fips_code, reference.cleanup_county_name(county_split)</span></pre><p id="f57c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于landareas查询也是如此:</p><pre class="jw jx jy jz fd lj lk ll lm aw ln bi"><span id="1d82" class="kh ki hi lk b fi lo lp l lq lr">CREATE OR REPLACE TABLE reference.landareas AS</span><span id="5cdf" class="kh ki hi lk b fi ls lp l lq lr"># join back using state fips and county name<br/>WITH land_only AS (<br/>  SELECT <br/>    counties.state_fips_code,<br/>    lsad_name, int_point_geom,<br/>    ST_Intersection(county_geom, population_geom) AS county_geom<br/>  FROM `bigquery-public-data.geo_us_boundaries.counties` as counties<br/>  JOIN reference.zipcodes as zips<br/>  ON reference.cleanup_county_name(lsad_name) = county<br/>    AND counties.state_fips_code = zips.state_fips_code<br/>)</span><span id="15e4" class="kh ki hi lk b fi ls lp l lq lr">SELECT <br/>  state_fips_code,<br/>  lsad_name,<br/>  int_point_geom,<br/>  ST_Centroid(county_geom) AS map_marker,<br/>  county_geom<br/>FROM land_only</span></pre><p id="e7d6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，审计该表:</p><pre class="jw jx jy jz fd lj lk ll lm aw ln bi"><span id="312b" class="kh ki hi lk b fi lo lp l lq lr">select area.* EXCEPT(county_geom), county.geo_id FROM<br/>`covid19-analytics.reference.landareas` as area<br/>FULL JOIN `bigquery-public-data.geo_us_boundaries.counties` as county<br/>ON area.state_fips_code = county.state_fips_code<br/>    and area.lsad_name = county.lsad_name</span></pre><p id="100b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">结果是，由于缺少邮政编码或在counties表中缺少信息，有7个县没有地理信息。</p><p id="16c6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">尽情享受吧！</p></div></div>    
</body>
</html>