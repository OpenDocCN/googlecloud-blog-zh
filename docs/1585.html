<html>
<head>
<title>How to build an end-to-end propensity to purchase solution using BigQuery ML and Kubeflow Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用BigQuery ML和Kubeflow管道构建端到端的购买倾向解决方案</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-build-an-end-to-end-propensity-to-purchase-solution-using-bigquery-ml-and-kubeflow-pipelines-cd4161f734d9?source=collection_archive---------0-----------------------#2020-09-08">https://medium.com/google-cloud/how-to-build-an-end-to-end-propensity-to-purchase-solution-using-bigquery-ml-and-kubeflow-pipelines-cd4161f734d9?source=collection_archive---------0-----------------------#2020-09-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="49f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">购买倾向用例广泛适用于零售、金融等多个垂直行业。在本文中，我们将向您展示如何使用<a class="ae jd" href="https://cloud.google.com/bigquery-ml/docs" rel="noopener ugc nofollow" target="_blank"> BigQuery ML </a>和<a class="ae jd" href="https://www.kubeflow.org/docs/pipelines/overview/pipelines-overview/" rel="noopener ugc nofollow" target="_blank"> Kubeflow Pipelines </a> (KFP，一个机器学习操作(MLOps)工作流工具)构建一个端到端的解决方案，使用<a class="ae jd" href="https://console.cloud.google.com/marketplace/details/obfuscated-ga360-data/obfuscated-ga360-data?filter=solution-type:dataset" rel="noopener ugc nofollow" target="_blank">谷歌分析数据集</a>来确定<strong class="ih hj">哪些客户有购买倾向</strong>。您可以使用该解决方案通过电子邮件或邮政渠道在离线活动中接触到您的目标客户。当客户在您的网站上浏览您的产品时，您也可以通过当场决策在在线活动中使用它，向客户推荐一些产品或触发个性化电子邮件。</p><p id="e653" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">购买倾向用例是个性化用例的子集。这是当今许多组织进行营销的关键驱动力。在当今不断变化的时代，您需要确保在正确的时间将正确的信息发送给正确的客户。“大规模个性化有可能创造1.7万亿至3万亿美元的新价值”(<a class="ae jd" href="https://www.mckinsey.com/business-functions/marketing-and-sales/our-insights/a-technology-blueprint-for-personalization-at-scale" rel="noopener ugc nofollow" target="_blank">麦肯锡研究</a>)。倾向建模有助于公司识别这些“正确的”客户和潜在客户，他们购买特定产品或服务的可能性很高。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/8b6a0059510e598a48dc20f6f7a9c430.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ON3Mfd2Zf9dmrP2s"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">如皮森摄:<a class="ae jd" href="https://unsplash.com/photos/kTd2PvtqE_o" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/photos/Q59HmzK38eQ</a></figcaption></figure><p id="d4f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">倾向模型很重要，因为它是一种以个性化信息为目标的销售拓展机制，因为它们是成功吸引客户注意力的关键。通过使用购买倾向模型，您可以更有效地锁定最有可能购买某些产品的客户。</p><h1 id="8b55" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">目录</h1><ul class=""><li id="56e7" class="ks kt hi ih b ii ku im kv iq kw iu kx iy ky jc kz la lb lc bi translated"><a class="ae jd" href="#75c7" rel="noopener ugc nofollow">典型的端到端解决方案架构和实施步骤</a></li><li id="02ce" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae jd" href="#c0b7" rel="noopener ugc nofollow">识别具有过去客户购买历史的数据源，并将其加载到BigQuery </a></li><li id="08e0" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae jd" href="#c478" rel="noopener ugc nofollow">为ML任务准备数据</a></li><li id="7163" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae jd" href="#4bb8" rel="noopener ugc nofollow">建立一个ML模型，以确定决定顾客购买倾向的因素</a></li><li id="c93a" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae jd" href="#dbc6" rel="noopener ugc nofollow">使用批量预测进行离线活动</a></li><li id="3331" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae jd" href="#2583" rel="noopener ugc nofollow">使用在线预测进行在线宣传</a></li><li id="aeac" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae jd" href="#8e0d" rel="noopener ugc nofollow">将客户数据加入CRM系统，以收集客户详细信息</a></li><li id="c16f" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae jd" href="#5209" rel="noopener ugc nofollow"> ML管道</a></li><li id="6257" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae jd" href="#9664" rel="noopener ugc nofollow">接下来的步骤</a></li><li id="f6bc" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><a class="ae jd" href="#0cb1" rel="noopener ugc nofollow">总结</a></li></ul><h1 id="75c7" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">典型的端到端解决方案架构和实施步骤</h1><p id="86d6" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">您将选择功能，创建标签(它会告诉您客户是否有购买倾向)，构建模型，使用BigQuery ML在BigQuery中预测批量/在线。BigQuery ML使您能够通过使用标准SQL查询在BigQuery中创建和执行机器学习模型。这意味着，您不需要导出数据来训练和部署机器学习模型-通过训练，您也可以在同一步骤中进行部署。结合BigQuery的计算资源自动扩展功能，您将不必担心启动集群或构建模型培训和部署管道。这意味着您将节省构建机器学习管道的时间，使您的企业能够更多地关注机器学习的价值，而不是花时间建立基础设施。</p><p id="cc42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了自动化这个模型构建过程，您将使用<a class="ae jd" href="https://www.kubeflow.org/docs/pipelines/overview/pipelines-overview/" rel="noopener ugc nofollow" target="_blank"> Kubeflow Pipelines </a>来编排管道，这是一个基于Docker容器来构建和部署可移植、可扩展的机器学习(ML)工作流的平台</p><p id="9ad0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图展示了整个解决方案的工作原理:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/0bc13ad1a3c1e4a193aeab4a965a7d7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YP6-azRpur2x_wq6"/></div></div></figure><p id="2299" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该解决方案包括以下步骤:</p><ol class=""><li id="742c" class="ks kt hi ih b ii ij im in iq ll iu lm iy ln jc lo la lb lc bi translated">使用过去的客户购买历史来识别数据源，并将数据加载到BigQuery</li><li id="6ad5" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc lo la lb lc bi translated">为机器学习(ML)任务准备数据。</li><li id="160b" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc lo la lb lc bi translated">建立一个确定顾客购买倾向的ML模型</li><li id="2ae5" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc lo la lb lc bi translated">将客户数据加入CRM系统，以收集客户详细信息(例如，电子邮件id等。)</li><li id="fd30" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc lo la lb lc bi translated">确定我们应该向客户推荐哪种产品</li><li id="97f5" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc lo la lb lc bi translated">利用上述数据开展渠道活动</li><li id="14f3" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc lo la lb lc bi translated">在CRM或类似系统中管理客户通信(如电子邮件)的生命周期</li><li id="9353" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc lo la lb lc bi translated">从活动结果中提炼客户终身价值</li><li id="e11f" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc lo la lb lc bi translated">监控模型以确保它们符合预期</li><li id="e91c" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc lo la lb lc bi translated">如有必要，根据新数据集或修正后的数据集重新训练模型</li></ol><p id="6b74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在将在下面详细讨论这些步骤。还有一个附带的<a class="ae jd" href="https://github.com/GoogleCloudPlatform/analytics-componentized-patterns/tree/master/retail/propensity-model/bqml" rel="noopener ugc nofollow" target="_blank">笔记本</a>，它实现了解决方案的前3个步骤。</p><h1 id="c0b7" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">确定具有过去客户购买历史的数据源，并将其加载到BigQuery</h1><p id="b615" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">您的数据存放在哪里？确定将数据导入BigQuery的最佳预处理技术。您可以在MLOps管道中自动化预处理，这将在本文后面看到。您将要使用的数据集托管在BigQuery上，提供了12个月(2016年8月至2017年8月)来自<a class="ae jd" href="https://www.googlemerchandisestore.com/shop.axd/Home?utm_source=Partners&amp;utm_medium=affiliate&amp;utm_campaign=Data%20Share%20Promo" rel="noopener ugc nofollow" target="_blank">谷歌商品商店</a>的模糊谷歌分析360数据，这是一家销售谷歌品牌商品的真实电子商务商店。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/3aeeebdeaf3dcd865922f2cf2fe8dfc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UciBIiDuMM2idVgB"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">来自<a class="ae jd" href="http://www.googlemerchandisestore.com/" rel="noopener ugc nofollow" target="_blank">谷歌商品商店</a>的截图。</figcaption></figure><p id="8f60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是来自谷歌分析的一些原始数据样本:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/aab64abcc64c9abe39662e550ff20e4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Hl_hxY6BqGPJHNEF"/></div></div></figure><h1 id="c478" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">为ML任务准备数据</h1><p id="dd57" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">现在，您已经确定了数据集，您开始为您的ML模型开发准备数据。如果要使用监督学习，请选择适当的要素和标签。在本文中，出于演示目的，您将使用几个特性。</p><p id="7a8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的查询将创建训练数据、要素(` bounds '、` time_on_site `)和标签(` will_buy_on_return_visit `)，您将在以后使用它们来构建您的模型:</p><pre class="jf jg jh ji fd lp lq lr ls aw lt bi"><span id="59f8" class="lu jv hi lq b fi lv lw l lx ly">## follows schema from <a class="ae jd" href="https://support.google.com/analytics/answer/3437719?hl=en&amp;ref_topic=3416089" rel="noopener ugc nofollow" target="_blank">https://support.google.com/analytics/answer/3437719?hl=en&amp;ref_topic=3416089</a><br/> <br/># select initial features and label to feed into your model<br/>CREATE <br/>OR REPLACE TABLE bqml.rpm_ds.rpm_ds_propensity_training_samples_tbl OPTIONS(<br/>  description = "Google Store curated Data"<br/>) AS <br/>SELECT <br/>  fullVisitorId, <br/>  bounces, <br/>  time_on_site, <br/>  will_buy_on_return_visit # &lt;--- your label<br/>FROM <br/>  # features<br/>  (<br/>    SELECT <br/>      fullVisitorId, <br/>      IFNULL(totals.bounces, 0) AS bounces, <br/>      IFNULL(totals.timeOnSite, 0) AS time_on_site <br/>    FROM <br/>      `data-to-insights.ecommerce.web_analytics` <br/>    WHERE <br/>      totals.newVisits = 1 <br/>      AND date BETWEEN '20160801' <br/>      AND '20170430'<br/>  ) # train on first 9 months<br/>  JOIN (<br/>    SELECT <br/>      fullvisitorid, <br/>      IF(<br/>        COUNTIF(<br/>          totals.transactions &gt; 0 <br/>          AND totals.newVisits IS NULL<br/>        ) &gt; 0, <br/>        1, <br/>        0<br/>      ) AS will_buy_on_return_visit <br/>    FROM <br/>      `bigquery-public-data.google_analytics_sample.*` <br/>    GROUP BY <br/>      fullvisitorid<br/>  ) USING (fullVisitorId) <br/>ORDER BY <br/>  time_on_site DESC # order by most time spent first</span></pre><p id="7f5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是运行上述查询的部分结果:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lz"><img src="../Images/51097e58417397f779501a98e02197d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/0*ESgPoYwptWqJL0fe"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">特征</figcaption></figure><h1 id="4bb8" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">建立一个ML模型来确定哪一个决定了客户的购买倾向</h1><p id="c791" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">我们应该使用哪种型号？要使用的所有功能是什么？该模型的超参数集应该是什么？这些是典型的数据科学家挑战。</p><p id="448f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果客户有购买倾向，您需要进行分类。因此，这是一项分类任务。一种常用的分类模型是逻辑回归。您将使用<a class="ae jd" href="https://cloud.google.com/bigquery-ml/docs/bigqueryml-intro" rel="noopener ugc nofollow" target="_blank"> BigQuery ML </a>构建一个逻辑回归。</p><p id="31e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下查询将创建模型:</p><pre class="jf jg jh ji fd lp lq lr ls aw lt bi"><span id="2883" class="lu jv hi lq b fi lv lw l lx ly">CREATE <br/>OR REPLACE MODEL `rpm_ds.rpm_bqml_model` OPTIONS(<br/>  MODEL_TYPE = 'logistic_reg', labels = [ 'will_buy_on_return_visit' ]<br/>) AS <br/>SELECT <br/>  * <br/>EXCEPT <br/>  (fullVisitorId) <br/>FROM <br/>  `bqml.rpm_ds.rpm_ds_propensity_training_samples_tbl`</span></pre><p id="b818" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦创建了模型，您就可以根据某些规则检查模型的执行情况。我们采用了一些经验法则(如ROC-AUC &gt; 0.9)，但您可以根据自己的具体需求进行调整。</p><p id="c3b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下查询将评估模型以检查预期ROC AUC:</p><pre class="jf jg jh ji fd lp lq lr ls aw lt bi"><span id="ac2a" class="lu jv hi lq b fi lv lw l lx ly">SELECT <br/>  roc_auc, <br/>  CASE WHEN roc_auc &gt;.9 THEN 'good' WHEN roc_auc &gt;.8 THEN 'fair' WHEN roc_auc &gt;.7 THEN 'decent' WHEN roc_auc &gt;.6 THEN 'not great' ELSE 'poor' END AS modelquality <br/>FROM <br/>  ML.EVALUATE(MODEL `rpm_ds.rpm_bqml_model`)</span></pre><p id="729f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行该查询会产生以下输出:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ma"><img src="../Images/90364905b8b737c75eb868db57d4a037.png" data-original-src="https://miro.medium.com/v2/resize:fit:506/0*XzOOeuZngqqOujKL"/></div></figure><p id="c9af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你真的认为我们成功建立了一个好的模型吗？嗯…很可能不会…因为78%的ROC_AUC被认为是一个公平的分数。这需要大量的领域知识、超参数调整、特征工程等。来建立一个谷歌模型。这不是你能创建的最好的模型，但是它给了你一个基线。由于本文的重点是构建一个端到端的管道，而不是对性能进行建模，因此对模型进行微调超出了本文的范围。</p><p id="03d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">经过培训的模型可以帮助您在离线活动或在线活动中接触到您的客户。我们将对前者使用批量预测，对后者使用在线预测。</p><p id="2283" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在BigQuery中使用训练好的模型对大型数据集进行批量预测。或者，你可以在谷歌云人工智能平台上部署模型，进行在线预测。</p><h1 id="dbc6" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">对离线活动使用批量预测</h1><p id="25bf" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">对于离线活动场景，您可以对大型数据集进行异步批量预测。让我们检查一下如何进行批量预测。您可以在BigQuery中创建一个表，并插入您想要预测的所有输入。您将在BigQuery中创建一个表“rpm _ ds _ prevention _ prediction _ input _ TBL ”,其中每一行都是一个具有反弹和time_on_site功能的客户。然后使用训练好的模型对所有输入/行进行预测。</p><p id="c1e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的查询显示了批量预测:</p><pre class="jf jg jh ji fd lp lq lr ls aw lt bi"><span id="47f8" class="lu jv hi lq b fi lv lw l lx ly"># predict the inputs (rows) from the input table<br/>SELECT <br/>fullVisitorId, predicted_will_buy_on_return_visit<br/>FROM<br/>ML.PREDICT(MODEL rpm_ds.rpm_bqml_model,<br/>(<br/>    SELECT<br/>    fullVisitorId, <br/>    bounces,<br/>    time_on_site<br/>    from bqml.rpm_ds.rpm_ds_propensity_prediction_input_tbl<br/>))</span></pre><p id="eedd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是运行上述查询的部分结果:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mb"><img src="../Images/1d357801d25bd3b5acc4ea3b35112abf.png" data-original-src="https://miro.medium.com/v2/resize:fit:764/0*VTQ0h7jw0-SF0-F6"/></div></figure><p id="afc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的输出中，模型预测这四个客户有购买倾向，因为“predicted _ will _ buy _ on _ return _ visit”返回1。</p><p id="d44a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您认为该模型预测了上述每一位客户的购买倾向吗？也许吧。可以肯定的是，你需要深入挖掘。您可能想要检查上面ML中的特性、参数、阈值(默认为<a class="ae jd" href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-predict#threshold" rel="noopener ugc nofollow" target="_blank">0.5</a>)。预测)等。来调整模型。</p><h1 id="2583" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">对在线活动使用在线预测</h1><p id="78d3" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">对于在线活动场景，我们需要在云人工智能平台中部署模型。这是一个分两步走的过程。首先，您需要导出模型，然后部署到云AI平台，该平台会公开一个REST端点来服务在线预测。</p><p id="edfc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是将<a class="ae jd" href="https://cloud.google.com/bigquery-ml/docs" rel="noopener ugc nofollow" target="_blank"> BiqQuery ML </a>模型导出到<a class="ae jd" href="https://cloud.google.com/storage" rel="noopener ugc nofollow" target="_blank"> Google云存储</a>的命令:</p><pre class="jf jg jh ji fd lp lq lr ls aw lt bi"><span id="5e49" class="lu jv hi lq b fi lv lw l lx ly"># export the model to a Google Cloud Storage bucket<br/>bq extract -m rpm_ds.rpm_bqml_model gs://bqml_sa/rpm_data_set/bqml/model/export/V_1</span></pre><p id="eec3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第二，您需要将导出的模型部署到<a class="ae jd" href="https://cloud.google.com/ai-platform/prediction/docs" rel="noopener ugc nofollow" target="_blank">云AI平台预测</a>，它托管您训练好的模型，以便您可以向它发送预测请求。</p><p id="c800" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是将模型部署到云AI平台预测的命令:</p><pre class="jf jg jh ji fd lp lq lr ls aw lt bi"><span id="636d" class="lu jv hi lq b fi lv lw l lx ly"># export the model to a Google Cloud Storage bucket<br/># deploy the above exported model<br/>gcloud ai-platform versions create --model=rpm_bqml_model V_1        --framework=tensorflow --python-version=3.7 --runtime-version=1.15        --origin=gs://bqml_sa/rpm_data_set/bqml/model/export/V_1/ --staging-bucket=gs://bqml_sa</span></pre><p id="3972" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以通过web请求/响应进行在线预测。您可以在web应用程序中使用端点来执行现场操作，例如显示个性化内容或触发异步流程，例如发送个性化电子邮件或明信片。下面是可以快速测试在线预测的命令:</p><pre class="jf jg jh ji fd lp lq lr ls aw lt bi"><span id="a931" class="lu jv hi lq b fi lv lw l lx ly"># Perform online predict (create a input table with the input features)<br/># create a json file (input.json) with the below content<br/>{"bounces": 0, "time_on_site": 7363}<br/> <br/># use the above json to predict<br/>gcloud ai-platform predict --model rpm_bqml_model --version V_1 --json-instances input.json</span></pre><p id="930f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行该命令会产生类似于以下内容的输出:</p><pre class="jf jg jh ji fd lp lq lr ls aw lt bi"><span id="2c03" class="lu jv hi lq b fi lv lw l lx ly">Predicted results for {"bounces": 0, "time_on_site": 7363} is PREDICTED_WILL_BUY_ON_RETURN_VISIT  WILL_BUY_ON_RETURN_VISIT_PROBS             WILL_BUY_ON_RETURN_VISIT_VALUES<br/>['1']                               [0.9200436491721313, 0.07995635082786867]  ['1', '0']</span></pre><p id="3d47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的输出中，模型预测该特定客户有购买倾向，因为“predicted _ WILL _ BUY _ ON _ RETURN _ visit”返回1。给定time_ont_site上“0”次反弹和“7363”秒的测试，模型告诉我们他们有92%的可能性有购买倾向。使用这些信息，您可以向客户发送优惠券(或者您可能只想向概率在0.5到0.8之间的人发放优惠券，因为如果概率很高，他们可能会在没有激励的情况下购买该商品)。</p><p id="8d42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，你不必只使用gcloud，你当然可以使用你最喜欢的工具(wget，curl，postman等等。)来快速检查REST端点。</p><h1 id="8e0d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">将客户数据与CRM系统结合起来，以收集客户详细信息</h1><p id="939f" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">因此，我们现在可以预测客户是否有批量购买或在线购买的倾向。现在怎么办？我们在数据集中使用了fullvisitorid。我们需要客户的详细信息，如电子邮件地址，因为您的数据集没有这些信息。这个想法是从客户关系管理(CRM)系统中收集他们。因此，我们需要集成一个CRM系统来实现这个目标。</p><p id="b8ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里你会对整合<a class="ae jd" href="https://support.google.com/analytics/answer/9250031?hl=en" rel="noopener ugc nofollow" target="_blank">有所了解。本文讨论了如何将Google Analytics 360集成到Salesforce营销云。该集成允许您将在Analytics 360中创建的受众发布到营销云，并在您的Salesforce电子邮件和SMS直接营销活动中使用这些受众。您需要根据您的CRM平台确定合适的集成机制。</a></p><p id="bd65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">附带的笔记本不实现这一步。</p><h1 id="a9f9" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">解决方案的其余步骤</h1><p id="d595" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">解决方案中的其余步骤是不言自明的，尽管系统的集成和互操作可能不是那么简单。但是，一般来说，这是软件开发生命周期中一个持续的挑战，不是吗？随着潜在的后续步骤继续在现有解决方案的基础上进行，您还可以查看一些指南。</p><h1 id="5209" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">ML管道</h1><p id="dd29" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">您现在将构建一个ML管道来自动化解决方案的步骤1、2和3。剩下的步骤留给专题文章或者作为读者的练习。我们将使用Kubeflow管道(KFP)，并在谷歌云上使用托管KFP、<a class="ae jd" href="https://cloud.google.com/ai-platform/pipelines/docs/" rel="noopener ugc nofollow" target="_blank">云人工智能平台管道</a>。</p><p id="6420" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是解决方案步骤的可视化表示，可在<a class="ae jd" href="https://github.com/GoogleCloudPlatform/analytics-componentized-patterns/tree/master/retail/propensity-model/bqml" rel="noopener ugc nofollow" target="_blank"> git repo </a>的Jupyter笔记本中找到:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mc"><img src="../Images/55d8d7b5fc3825fb29ec70cc8c724061.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mc9ueFQgpclP0-a3QVVruw.png"/></div></div></figure><p id="a49d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是基于当前实施的解决方案步骤的可视化表示。笔记本没有实现这些步骤:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es md"><img src="../Images/9644e27dca1edb41dcb7e099c8d6109b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KOtP9tvR48ppIa6HXD0tDw.png"/></div></div></figure><p id="90c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上图中的三个链接是:</p><ul class=""><li id="6355" class="ks kt hi ih b ii ij im in iq ll iu lm iy ln jc kz la lb lc bi translated">参考<a class="ae jd" href="https://support.google.com/analytics/answer/9250031?hl=en" rel="noopener ugc nofollow" target="_blank">文章</a>，了解如何使用CRM系统预测有购买倾向的客户。</li><li id="9d1d" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">参考<a class="ae jd" rel="noopener" href="/google-cloud/how-to-build-a-recommendation-system-on-e-commerce-data-using-bigquery-ml-df9af2b8c110">文章</a>，了解如何使用矩阵分解进行产品推荐。文章还提到了一个笔记本。本文使用了您在当前文章中使用的相同的BigQuery公共数据集。</li><li id="8632" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">参考斯坦福大学教授所著的《海量数据集的挖掘》一书的第六章“频繁项集”中的<a class="ae jd" href="http://infolab.stanford.edu/~ullman/mmds/ch6.pdf" rel="noopener ugc nofollow" target="_blank">，了解如何建立一个常用产品列表。</a></li></ul><p id="0112" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是从笔记本上运行KFP实验时<a class="ae jd" href="https://cloud.google.com/ai-platform/pipelines/docs/" rel="noopener ugc nofollow" target="_blank">云人工智能平台管道</a>的输出。当您执行实验时，您的输出可能会有所不同:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es me"><img src="../Images/45a836353f99f8ce136557114f253359.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MgM6s85B5WtxJiJz"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">实验的Kubeflow管道输出的屏幕截图</figcaption></figure><p id="8a51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个盒子代表一个KFP组件。关于函数中的语义、语法、参数传递等，你可以参考笔记本。<a class="ae jd" href="https://github.com/GoogleCloudPlatform/analytics-componentized-patterns/tree/master/retail/propensity-model/bqml" rel="noopener ugc nofollow" target="_blank">笔记本</a>展示了以下特点:</p><pre class="jf jg jh ji fd lp lq lr ls aw lt bi"><span id="2730" class="lu jv hi lq b fi lv lw l lx ly">* Environment Setup<br/>    - Setup Cloud AI Platform Pipelines (using the CloudConsole)<br/>    - Install KFP client<br/>    - Install Python packages for Google Cloud Services<br/>* Kubeflow Pipelines (KFP) Setup<br/>    - Prepare Data for the training<br/>        -- Create/Validate a Google Cloud Storage Bucket/Folder<br/>        -- Create the input table in BigQuery<br/>    - Train the model<br/>    - Evaluate the model<br/>    - Prepare the Model for batch prediction<br/>        -- Prepare a test dataset (a table)<br/>        -- Predict the model in BigQuery<br/>    - Prepare the Model for online prediction<br/>    - Create a new revision (<em class="mf">for model revision management</em>)<br/>        -- Export the BigQuery Model<br/>        -- Export the Model from BigQuery to Google Cloud Storage<br/>        -- Export the Training Stats to Google Cloud Storage<br/>        -- Export the Eval Metrics to Google Cloud Storage<br/>    - Deploy to Cloud AI Platform Prediction<br/>    - Predict the model in Cloud AI Platform Prediction<br/>* Data Exploration using BigQuery, Pandas, matplotlib<br/>* SDLC methodologies Adherence (opinionated)<br/>    - Variables naming conventions<br/>        -- Upper case Names for immutable variables<br/>        -- Lower case Names for mutable variables<br/>        -- Naming prefixes with <em class="mf">rpm_</em> or <em class="mf">RPM_</em><br/>    - Unit Tests<br/>    - Cleanup/Reset utility functions<br/>* KFP knowledge share (demonstration)<br/>    - Pass inputs params through function args<br/>    - Pass params through pipeline args<br/>    - Pass Output from one Component as input of another<br/>    - Create an external Shared Volume available to all the Comp<br/>    - Use built in Operators<br/>    - Built light weight Component<br/>    - Set Component not to cache</span></pre><h1 id="9664" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">后续步骤</h1><p id="b181" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">对于您的特定用例，您可以使用许多改进或替代方法。</p><h1 id="a82e" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">预测输入数据的替代数据源</h1><p id="28f0" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">如果合适的话，您还可以使用一个<a class="ae jd" href="https://cloud.google.com/bigquery/external-data-sources" rel="noopener ugc nofollow" target="_blank">联合数据源</a>。</p><h1 id="ed9d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">替代模型</h1><p id="1e68" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">我们在本文中使用了逻辑回归，但是您也可以使用<a class="ae jd" href="https://cloud.google.com/bigquery-ml/docs/bigqueryml-intro#supported_models_in" rel="noopener ugc nofollow" target="_blank"> XGBoost或其他</a>。您还可以并行训练多个模型，然后进行评估，以确定哪个模型在您的场景中表现更好。您可以在MLOps管道中这样做，让BigQuery为您处理训练模型所需的计算。</p><h1 id="532e" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">在线预测终点</h1><p id="9122" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">现在您已经有了在线预测的端点，您可以将API发布给web开发人员和/或监控其使用情况。你可以使用<a class="ae jd" href="https://cloud.google.com/apigee/api-management" rel="noopener ugc nofollow" target="_blank">谷歌Apigee </a>，一个API管理平台，来做这些和更多的事情。</p><h1 id="d87b" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">确定我们应该向客户推荐哪种产品</h1><p id="c82a" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">在我们确定哪些客户有购买倾向后，我们需要找出我们应该向他们推荐什么产品。我们可以发起一项活动，针对目标客户群使用个性化信息。但是，附带的笔记本并没有实现这一步。</p><p id="e7b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有许多方法可以确定我们应该向客户推荐的产品。您可以使用矩阵分解或MarketBasket FrequentItemSet技术作为起点。</p><p id="5f9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">市场购物篮模型还可以提供一个在线状态预测模型，即当客户浏览(或任何类似的行为，如添加到购物车)产品A时，您可以推荐下一个产品B，以此类推。您可以将智能嵌入到您的web应用程序中，以便更好地理解客户的意图。举例来说，如果有人正在购买尿布，你可能会建议他们购买啤酒(基于一个有趣的发现，请查看下面的第6章材料参考，了解更多信息。)或者，如果顾客在购物车中添加了盆栽土，你可以向他们推荐植物食品。你对顾客的意图了解得越多，你就能更好地推荐其他相关产品。选择是无穷无尽的…</p><h1 id="0cb1" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">摘要</h1><p id="ac23" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">恭喜你！现在，您了解了如何使用BigQuery ML构建倾向模型，以及如何在Kubeflow Pipelines中编排ML管道。你可以继续构建当前的解决方案来完成激活，但是你可以使用<a class="ae jd" href="https://github.com/GoogleCloudPlatform/analytics-componentized-patterns/tree/master/retail/propensity-model/bqml" rel="noopener ugc nofollow" target="_blank">笔记本</a>作为起点。</p><h1 id="6c10" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">想要更多吗？</h1><p id="0ddb" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">请给我留下您的意见和任何建议或更正。</p><p id="0f86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在谷歌云工作。我帮助我们的客户在谷歌云上构建解决方案。</p></div></div>    
</body>
</html>