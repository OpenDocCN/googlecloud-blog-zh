<html>
<head>
<title>Using BigQuery Flex Slots to run machine learning workloads more efficiently</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用BigQuery Flex插槽更高效地运行机器学习工作负载</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-bigquery-flex-slots-to-run-machine-learning-workloads-more-efficiently-7fc7f400f7a7?source=collection_archive---------0-----------------------#2020-05-17">https://medium.com/google-cloud/using-bigquery-flex-slots-to-run-machine-learning-workloads-more-efficiently-7fc7f400f7a7?source=collection_archive---------0-----------------------#2020-05-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="0f7d" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">创建弹性插槽，运行查询，然后删除弹性插槽</h2></div><p id="8749" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">根据您更看重什么，BigQuery大致有两种不同的定价方案:可预测的成本或效率:</p><ol class=""><li id="d49b" class="jt ju hi iz b ja jb jd je jg jv jk jw jo jx js jy jz ka kb bi translated"><strong class="iz hj">统一价格是可预测的</strong>。你购买一定数量的插槽，并支付相同的金额，无论你提交多少查询。这对于需要可预测成本的企业来说非常好。缺点是，如果您购买了1000个插槽，并且有一个通常使用500个插槽，有时需要1500个插槽的高峰工作负载，当您只使用500个插槽时，插槽会被闲置，当拥有1500个插槽会更好时，查询会运行得更慢。</li><li id="01ef" class="jt ju hi iz b ja kc jd kd jg ke jk kf jo kg js jy jz ka kb bi translated"><strong class="iz hj">按需定价在价格和性能方面都很高效</strong>。您需要为查询处理的数据量付费。这是最初的云承诺—按需付费。它非常适合尖峰工作负载，因为您不必为未使用的槽付费，并且您的查询使用了运行时所有可用的计算能力。然而，即使你可以设置成本控制，每天的价格限制等。为了限制你的暴露，许多企业不喜欢这样做，因为(a)很难为每月变化的事情做预算，以及(b)成本控制和每日限额增加了摩擦。</li></ol><p id="37df" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">总的来说，我们发现较大的企业更喜欢统一费率，而较小的数字原生用户更喜欢按需定价。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/2fef817e1683f41b2c5d55992d77c34d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ig8b6QTSX1Uv0VgffQJDKw.jpeg"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">即使您支付统一费率，弹性插槽也能让您获得有效的定价。图片由<a class="ae kx" href="https://pixabay.com/users/PublicDomainPictures-14/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2086" rel="noopener ugc nofollow" target="_blank"> PublicDomainPictures </a>提供。</figcaption></figure><h2 id="db71" class="ky kz hi bd la lb lc ld le lf lg lh li jg lj lk ll jk lm ln lo jo lp lq lr ls bi translated">灵活性</h2><p id="3bf1" class="pw-post-body-paragraph ix iy hi iz b ja lt ij jc jd lu im jf jg lv ji jj jk lw jm jn jo lx jq jr js hb bi translated">假设您可以采用统一费率定价，因为您想要可预测的成本，但是您有一个峰值工作负载。此外，您确切地知道<em class="ly">何时</em>您需要额外的容量。</p><p id="dd5a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设您每天训练一次推荐模型，这时您需要1500个位置。其余时间，你只需要500个槽。购买一个500槽的统一费率计划，但在每天进行推荐模型培训的一个小时内额外购买1000槽，这不是很好吗？这样，您的常规工作负载不会受到影响，并且建议模型有1000个插槽，因此它不会运行得更慢。</p><p id="9d08" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这被称为<a class="ae kx" href="https://cloud.google.com/blog/products/data-analytics/introducing-bigquery-flex-slots" rel="noopener ugc nofollow" target="_blank">“柔性插槽”</a>。您可以购买短至60秒的灵活插槽。它允许您在统一价格的基础上增加灵活性。</p><h2 id="66b0" class="ky kz hi bd la lb lc ld le lf lg lh li jg lj lk ll jk lm ln lo jo lp lq lr ls bi translated">即使采用按需定价，何时也要使用弹性时段</h2><p id="590d" class="pw-post-body-paragraph ix iy hi iz b ja lt ij jc jd lu im jf jg lv ji jj jk lw jm jn jo lx jq jr js hb bi translated">使用按需定价，您将为查询处理的数据量付费。如果您只是做一些基本的选择、WHERE、JOIN和GROUP BY，那么按需和统一费率的结果是一样的。对于计算量大的查询来说，按需定价很划算——如果您的查询涉及g is、正则表达式解析、JSON提取、ORDER BY等。，只为处理的字节付费是很划算的。所以，总的来说，按需定价是非常划算的。</p><p id="0aa6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">机器学习查询是个例外。机器学习模型训练需要对数据进行多次迭代，因此在按需情况下，您将根据ML模型可能需要进行的迭代次数收取费用。这意味着，如果<a class="ae kx" rel="noopener" href="/google-cloud/bigquery-ml-gets-faster-by-computing-a-closed-form-solution-sometimes-1baa5a838eb6">你知道</a>你的ML模型<a class="ae kx" href="https://towardsdatascience.com/k-means-clustering-in-bigquery-now-does-better-initialization-3d7e7567bad3" rel="noopener" target="_blank">不会</a>花费最大的时间，你最好使用统一费率预订或弹性时段——如果你为你实际使用的计算付费，BigQuery中的ML会更便宜。</p><p id="1e12" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">特别是，当数据和迭代收费时，推荐模型太昂贵了——常见的矩阵分解模型有数百万用户和数万种产品。<a class="ae kx" href="http://rakaposhi.eas.asu.edu/s01-cse494-mailarchive/msg00028.html" rel="noopener ugc nofollow" target="_blank">矩阵分解是一种O(N)算法</a>。然而实际上，收敛更快，因为你的矩阵可能很稀疏。出于这个原因，如果您需要，BigQuery拒绝进行矩阵分解，并告诉您购买flex slots，以便您可以支付实际使用的计算费用。</p><h2 id="e5b6" class="ky kz hi bd la lb lc ld le lf lg lh li jg lj lk ll jk lm ln lo jo lp lq lr ls bi translated">在Flex插槽中运行查询</h2><p id="5f62" class="pw-post-body-paragraph ix iy hi iz b ja lt ij jc jd lu im jf jg lv ji jj jk lw jm jn jo lx jq jr js hb bi translated">当然，您可以使用BigQuery控制台来创建flex插槽</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es lz"><img src="../Images/c1277b789d880f6ad7c7061ed5230ce2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*yuFMUrnqPum8j_7AT2We5w.png"/></div></figure><p id="44eb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是您可以自动化这个流程——购买一些flex slots，设置一个预订，运行ML模型训练查询，然后删除全部内容。这里有一个自动化整个过程的脚本。</p><p id="7d67" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设我们想要对美国的500个flex插槽运行查询:</p><pre class="ki kj kk kl fd ma mb mc md aw me bi"><span id="fe79" class="ky kz hi mb b fi mf mg l mh mi">LOCATION=US<br/>SLOTS=500<br/>run_query() {<br/>  cat ../bqml_recommendations/train.sql | bq query --sync -nouse_legacy_sql<br/>}</span></pre><p id="da62" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先购买具有灵活插槽的插槽容量预留:</p><pre class="ki kj kk kl fd ma mb mc md aw me bi"><span id="c8d7" class="ky kz hi mb b fi mf mg l mh mi">bq mk --project_id=${PROJECT}  --location=${LOCATION} \<br/>      --capacity_commitment --slots=${SLOTS} --plan=FLEX</span></pre><p id="c6dd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，创建一个使用这些插槽的预留:</p><pre class="ki kj kk kl fd ma mb mc md aw me bi"><span id="f832" class="ky kz hi mb b fi mf mg l mh mi">bq mk --reservation --project_id=${PROJECT} --slots=${SLOTS} \<br/>      --location=${LOCATION} ${RESERVATION} || cleanup</span></pre><p id="b1be" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果创建预留失败，请确保清理槽(稍后将详细介绍)。</p><p id="b4b8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，允许我们的项目使用此保留:</p><pre class="ki kj kk kl fd ma mb mc md aw me bi"><span id="650b" class="ky kz hi mb b fi mf mg l mh mi">bq mk --reservation_assignment \<br/>      --reservation_id=${PROJECT}:${LOCATION}.${RESERVATION} \<br/>      --job_type=QUERY --assignee_type=PROJECT \<br/>      --assignee_id=${PROJECT}</span></pre><p id="bf3d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上述三个步骤相当于您在web控制台上创建插槽、预订和分配的三个步骤:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mj"><img src="../Images/631adc55d08fee4173607fef56651ca3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jtSZ8WafHj3v7q0LLkOqnQ.png"/></div></div></figure><p id="f60b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，只需运行查询:</p><pre class="ki kj kk kl fd ma mb mc md aw me bi"><span id="a914" class="ky kz hi mb b fi mf mg l mh mi">run_query</span></pre><p id="78ee" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">查询完成后，清理分配、预留和插槽提交(与创建顺序相反)</p><pre class="ki kj kk kl fd ma mb mc md aw me bi"><span id="f706" class="ky kz hi mb b fi mf mg l mh mi">bq rm --reservation_assignment --project_id=${PROJECT} \<br/>      --location=${LOCATION} ${ASSIGNMENT} || true</span><span id="3538" class="ky kz hi mb b fi mk mg l mh mi">bq rm --reservation --project_id=${PROJECT} \<br/>      --location=${LOCATION}  ${RESERVATION} || true</span><span id="fe60" class="ky kz hi mb b fi mk mg l mh mi">until bq rm --location=${LOCATION}  --capacity_commitment ${CAPACITY}<br/>  do<br/>    echo "will try after 30 seconds to delete slots ${CAPACITY}"<br/>    sleep 30<br/>  done<br/>  CAPACITY=""</span></pre><p id="4e9e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果脚本不能删除预留、分配或时段，它不会退出。它将继续运行。请更改此行为以提醒您。</p><p id="17ce" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这不是谷歌的官方作品。正如脚本的版权所言，该软件是在“原样”的基础上发布的，没有任何形式的保证或条件，无论是明示的还是暗示的。</p><h2 id="134c" class="ky kz hi bd la lb lc ld le lf lg lh li jg lj lk ll jk lm ln lo jo lp lq lr ls bi translated">后续步骤</h2><ol class=""><li id="9a76" class="jt ju hi iz b ja lt jd lu jg ml jk mm jo mn js jy jz ka kb bi translated">阅读更多关于<a class="ae kx" href="https://cloud.google.com/blog/products/data-analytics/introducing-bigquery-flex-slots" rel="noopener ugc nofollow" target="_blank">弹性插槽</a>的信息。</li><li id="68a5" class="jt ju hi iz b ja kc jd kd jg ke jk kf jo kg js jy jz ka kb bi translated">查看我在GitHub上的<a class="ae kx" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/blogs/flex_slots/run_query_on_flex_slots.sh" rel="noopener ugc nofollow" target="_blank">脚本</a>，它包含了一个关于创建和删除flex slots预约的查询。如果你对脚本有改进的建议，请向GitHub发出请求。</li><li id="7dd8" class="jt ju hi iz b ja kc jd kd jg ke jk kf jo kg js jy jz ka kb bi translated">阅读我的同事邓梓峰的文章，他展示了Flex Slots如何降低大型查询的成本。</li><li id="ce25" class="jt ju hi iz b ja kc jd kd jg ke jk kf jo kg js jy jz ka kb bi translated">ML模型的运行速度比数据的大小快得多的情况的例子表明:<a class="ae kx" rel="noopener" href="/google-cloud/bigquery-ml-gets-faster-by-computing-a-closed-form-solution-sometimes-1baa5a838eb6">具有&lt; 1000个特性的线性回归</a>、<a class="ae kx" href="https://towardsdatascience.com/k-means-clustering-in-bigquery-now-does-better-initialization-3d7e7567bad3" rel="noopener" target="_blank"> kmeans++ </a>、早期停止以及更多不断增加的优化。</li></ol></div></div>    
</body>
</html>