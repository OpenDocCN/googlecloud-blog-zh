<html>
<head>
<title>Programmatic DNS record management for Google Cloud VMs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Cloud虚拟机的程序化DNS记录管理</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/programmatic-dns-record-management-for-google-cloud-vms-9dc07972131c?source=collection_archive---------0-----------------------#2021-09-27">https://medium.com/google-cloud/programmatic-dns-record-management-for-google-cloud-vms-9dc07972131c?source=collection_archive---------0-----------------------#2021-09-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="4e67" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">经典的DNS更改流程</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/88c715f62074cff7dd9e3ee3cfb78a33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/0*SoBBO2IjZvxeyoOX"/></div></figure><p id="7b17" class="pw-post-body-paragraph jl jm hi jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">是否还需要使用旧的DNS变更控制流程？也许不是在这个时代，当你可以现代化你的工作流程，将大部分的手工过程委托给系统。或者，如果您是一个开发/基础设施团队，正在寻找一种功能，允许您管理DNS记录，而不必等待冗长的变更控制过程来跟上您的工作节奏。</p><p id="75ac" class="pw-post-body-paragraph jl jm hi jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">毕竟，出于各种遗留原因，控制、治理和审计是必要的，但是如果我们能够使流程的一部分成为一次性交易并使其余部分自动化，我们就可以同时满足这两者。如果开发团队被列入白名单，使用一个正则表达式来满足DNS团队期望的控制，同时实现开发团队的DNS自助服务目标，会怎么样？</p><p id="5e2f" class="pw-post-body-paragraph jl jm hi jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">GCP的<a class="ae kj" href="https://cloud.google.com/dns/docs/overview/" rel="noopener ugc nofollow" target="_blank">云DNS </a>可以用来以编程方式管理DNS记录。此外，云DNS <a class="ae kj" href="https://cloud.google.com/dns/sla" rel="noopener ugc nofollow" target="_blank"> 100% SLA </a>对这种方法本身提供的弹性是一个很大的优势。如果这对你来说足够有趣，请继续阅读，我相信你会过得很愉快:)</p><h1 id="adff" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">问题陈述</h1><p id="888a" class="pw-post-body-paragraph jl jm hi jn b jo kk jq jr js kl ju jv jw km jy jz ka kn kc kd ke ko kg kh ki hb bi translated">谷歌云虚拟机的DNS管理。</p><p id="f14e" class="pw-post-body-paragraph jl jm hi jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">虚拟机生命周期事件(如创建和删除)通常需要组织处理DNS记录。一般来说，开发/基础架构团队创建虚拟机，DNS/网络团队分别生成DNS条目，如“A”和“PTR”记录。这意味着每当需要更新VM/DNS条目时，必须遵循相同的两步过程。</p><h1 id="e527" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">业务用例</h1><p id="b399" class="pw-post-body-paragraph jl jm hi jn b jo kk jq jr js kl ju jv jw km jy jz ka kn kc kd ke ko kg kh ki hb bi translated">基于GCE虚拟机创建/删除事件自动化DNS“A”和“PTR”记录管理是一种常见的使用情形，适用于希望:</p><ul class=""><li id="04a6" class="kp kq hi jn b jo jp js jt jw kr ka ks ke kt ki ku kv kw kx bi translated">对需要FQDNs和PTR记录的虚拟机自动进行DNs管理，并进行必要的控制和治理，以确保正确/允许的DNS使用。</li><li id="6abc" class="kp kq hi jn b jo ky js kz jw la ka lb ke lc ki ku kv kw kx bi translated">避免遵循两步变更流程，即开发/基础架构团队创建虚拟机(MIG ),然后单独请求创建DNS记录。</li><li id="ee7c" class="kp kq hi jn b jo ky js kz jw la ka lb ke lc ki ku kv kw kx bi translated">为开发/基础架构团队提供自助服务功能，以管理他们的DNS记录，同时还拥有自动化、治理和管理提升的IAM权限的必要控制，以跨项目全局管理DNS条目。</li></ul><h1 id="f70f" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">解决方案设计</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div class="ab fe cl ld"><img src="../Images/758cbb210499f1844e2771535848db6a.png" data-original-src="https://miro.medium.com/v2/0*OspvV9QG0cVQcMwr"/></div><figcaption class="le lf et er es lg lh bd b be z dx translated">包含所有步骤的自动化工作流程</figcaption></figure><p id="93dc" class="pw-post-body-paragraph jl jm hi jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在我们部署代码来实时测试上面的流程之前，让我们浏览几个主题来获得一些关于自动化如何工作的一般知识。</p><h1 id="7870" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">虚拟机标签</h1><p id="6e19" class="pw-post-body-paragraph jl jm hi jn b jo kk jq jr js kl ju jv jw km jy jz ka kn kc kd ke ko kg kh ki hb bi translated"><a class="ae kj" href="https://cloud.google.com/compute/docs/labeling-resources#what-are-labels" rel="noopener ugc nofollow" target="_blank"> VM标签</a>在高级别上是可以添加到VM上的键-值对，用于为检查VM的下游系统定义VM属性。因此，当您向虚拟机添加虚拟机标签时，您可以控制诸如DNS主机名、DNS区域和跳过DNS记录创建之类的事情。例如，您可能希望避免为特定虚拟机创建dns记录，当“DNS跳过记录”标签设置为真时，自动化将跳过为这些虚拟机创建DNS记录。</p><h1 id="bd1a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">需要注意的标签</h1><ul class=""><li id="87a3" class="kp kq hi jn b jo kk js kl jw li ka lj ke lk ki ku kv kw kx bi translated">"<strong class="jn hj"> dns_skip_record </strong>"将此标签设置为true将跳过为虚拟机创建dns记录。</li><li id="04f8" class="kp kq hi jn b jo ky js kz jw la ka lb ke lc ki ku kv kw kx bi translated"><strong class="jn hj">“dns _ host _ name</strong>”默认情况下，虚拟机的名称被作为DNS条目中的主机名，但是可以通过添加此标签来覆盖该默认行为。例如，在虚拟机上设置“dns _ host _ name”:“devserver”标签会将DNS条目创建为“devserver”+“.”+ providedDNSDomain。</li><li id="c833" class="kp kq hi jn b jo ky js kz jw la ka lb ke lc ki ku kv kw kx bi translated">"<strong class="jn hj"> dns_zone_name </strong>"覆盖默认dns区域名称，以防有多个DNS zone。这是GCP DNS区域名。</li><li id="117e" class="kp kq hi jn b jo ky js kz jw la ka lb ke lc ki ku kv kw kx bi translated">"<strong class="jn hj"> dns_zone_host_project </strong>"来指定dns_zone托管的project_id。</li><li id="d302" class="kp kq hi jn b jo ky js kz jw la ka lb ke lc ki ku kv kw kx bi translated"><strong class="jn hj">“dns _ domain</strong>”与dns_zone关联的DNS域。这是与上述区域名称相关联的域</li></ul><h1 id="3c88" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">部署解决方案</h1><p id="ce64" class="pw-post-body-paragraph jl jm hi jn b jo kk jq jr js kl ju jv jw km jy jz ka kn kc kd ke ko kg kh ki hb bi translated">必须预先创建正向和反向环路的DNS区域。通常企业通过IaC使用类似terraform的东西来创建它。获取以下详细信息，因为我们在稍后部署云功能时需要它们。</p><ol class=""><li id="bdda" class="kp kq hi jn b jo jp js jt jw kr ka ks ke kt ki ll kv kw kx bi translated">DNS专用/转发区域主机项目ID</li><li id="cf06" class="kp kq hi jn b jo ky js kz jw la ka lb ke lc ki ll kv kw kx bi translated">DNS专用/转发区域名称</li><li id="12d2" class="kp kq hi jn b jo ky js kz jw la ka lb ke lc ki ll kv kw kx bi translated">DNS私有/转发区域域名(用于“A”记录放置)</li><li id="8b88" class="kp kq hi jn b jo ky js kz jw la ka lb ke lc ki ll kv kw kx bi translated">DNS专用/反向区域主机项目ID</li><li id="799f" class="kp kq hi jn b jo ky js kz jw la ka lb ke lc ki ll kv kw kx bi translated">DNS私有/反向区域名称(用于“PTR”记录放置)</li></ol><h1 id="f9e1" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">部署步骤</h1><p id="f5f5" class="pw-post-body-paragraph jl jm hi jn b jo kk jq jr js kl ju jv jw km jy jz ka kn kc kd ke ko kg kh ki hb bi translated">请遵循此处的部署说明<a class="ae kj" href="https://github.com/vponnam/vm-event-based-dns-management#deploying-this-code" rel="noopener ugc nofollow" target="_blank"/></p><h1 id="a499" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">增强/可选改进</h1><ol class=""><li id="3214" class="kp kq hi jn b jo kk js kl jw li ka lj ke lk ki ll kv kw kx bi translated">这段代码中的getGCEMetadata()函数在记录虚拟机事件后立即检索虚拟机信息，这意味着在云函数或下游依赖项(如compute API)出现问题的情况下，可能会创建过时的DNS记录。这是一个边缘案例。</li></ol><blockquote class="lm ln lo"><p id="5068" class="jl jm lp jn b jo jp jq jr js jt ju jv lq jx jy jz lr kb kc kd ls kf kg kh ki hb bi translated">这可以用最少量的验证工作来处理，或者可以定期执行后端作业来检测/清除任何过时的条目。</p><p id="b3ca" class="jl jm lp jn b jo jp jq jr js jt ju jv lq jx jy jz lr kb kc kd ls kf kg kh ki hb bi translated">在数据库中维护虚拟机元数据或查询AssetAPI并使用该信息进行额外的验证和删除操作。</p></blockquote><p id="640f" class="pw-post-body-paragraph jl jm hi jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">2.当前版本的自动化仅在创建或删除虚拟机时管理DNS记录，但此自动化范围可以扩展到虚拟机更新事件，如虚拟机重启时的标签更改，以更新DNS记录。</p><p id="0735" class="pw-post-body-paragraph jl jm hi jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">3.可以支持额外的<a class="ae kj" href="https://cloud.google.com/dns/docs/overview#supported_dns_record_types" rel="noopener ugc nofollow" target="_blank">记录类型</a>。</p><h2 id="8663" class="lt ig hi bd ih lu lv lw il lx ly lz ip jw ma mb it ka mc md ix ke me mf jb mg bi translated">增强型设计</h2><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="er es mh"><img src="../Images/4e8f465d06f89192226466f77e70c835.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Nownd7w7v4u16jfb"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx translated">增强的自动化工作流程</figcaption></figure><h1 id="c184" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">常见问题</h1><h2 id="7c71" class="lt ig hi bd ih lu lv lw il lx ly lz ip jw ma mb it ka mc md ix ke me mf jb mg bi translated">管理多个区域</h2><p id="2040" class="pw-post-body-paragraph jl jm hi jn b jo kk jq jr js kl ju jv jw km jy jz ka kn kc kd ke ko kg kh ki hb bi translated">当涉及多个区域时，可以通过VM标签来控制区域，通过这些标签可以显式地提供区域、域名和项目ID。</p><h2 id="7c44" class="lt ig hi bd ih lu lv lw il lx ly lz ip jw ma mb it ka mc md ix ke me mf jb mg bi translated">多团队结构</h2><p id="8d33" class="pw-post-body-paragraph jl jm hi jn b jo kk jq jr js kl ju jv jw km jy jz ka kn kc kd ke ko kg kh ki hb bi translated">这个云功能的多个副本可以跨项目/文件夹/组织部署，以将范围限制到一个<a class="ae kj" href="https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy" rel="noopener ugc nofollow" target="_blank">资源级别</a>，并实现IAM的分离。需要为文件夹/项目级操作适当更新日志接收器过滤器。</p><h2 id="2de4" class="lt ig hi bd ih lu lv lw il lx ly lz ip jw ma mb it ka mc md ix ke me mf jb mg bi translated">PTR区域类型</h2><p id="bc42" class="pw-post-body-paragraph jl jm hi jn b jo kk jq jr js kl ju jv jw km jy jz ka kn kc kd ke ko kg kh ki hb bi translated">虽然您可以使用地址arpa.  中的“<strong class="jn hj">”为PRT记录创建一个私有区域，作为一个总括域，以避免维护特定范围的粒度区域，但建议<a class="ae kj" href="https://cloud.google.com/dns/docs/overview#ptr_records_in_private_zones" rel="noopener ugc nofollow" target="_blank"/>根据您计划的整体DNS区域管理策略创建更粒度的区域。</strong></p><h2 id="7bbd" class="lt ig hi bd ih lu lv lw il lx ly lz ip jw ma mb it ka mc md ix ke me mf jb mg bi translated">配额和限额</h2><p id="9c5a" class="pw-post-body-paragraph jl jm hi jn b jo kk jq jr js kl ju jv jw km jy jz ka kn kc kd ke ko kg kh ki hb bi translated">请注意每个用户每分钟的API查询<a class="ae kj" href="https://cloud.google.com/dns/quotas#quotas" rel="noopener ugc nofollow" target="_blank">配额</a>，可以根据需要增加，以及<a class="ae kj" href="https://cloud.google.com/dns/quotas#resource_limits" rel="noopener ugc nofollow" target="_blank">资源限制</a>。</p></div></div>    
</body>
</html>