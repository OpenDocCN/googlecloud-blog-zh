<html>
<head>
<title>Create Cloud Spanner Scheduled Backups</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建云扳手计划备份</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/create-cloud-spanner-scheduled-backups-c6f30551a6fd?source=collection_archive---------0-----------------------#2020-05-29">https://medium.com/google-cloud/create-cloud-spanner-scheduled-backups-c6f30551a6fd?source=collection_archive---------0-----------------------#2020-05-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="27b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本教程展示了如何使用<a class="ae jd" href="https://github.com/cloudspannerecosystem/scheduled-backups" rel="noopener ugc nofollow" target="_blank">计划备份</a>工具来配置云调度程序，以便定期创建云扳手备份，例如每天或每周。</p><p id="7310" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用以下GCP服务:</p><ul class=""><li id="fc30" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">云调度器:使用基于cron的调度来触发任务。</li><li id="ff7c" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">云发布/订阅:从云调度器到云功能的消息队列。</li><li id="cce8" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">云功能:开始创建云扳手备份的操作。</li><li id="f2e3" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">云日志记录:创建基于日志的指标。</li><li id="acdd" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">云监控:根据基于日志的指标的条件创建警报。</li></ul><p id="1ad8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该架构如下所示:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/74586c7082a3fd3f5fe58f401d383272.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8xteBWKNXi_PrvZn7ehF1w.png"/></div></div></figure><p id="c332" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要执行以下步骤:</p><ul class=""><li id="2929" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">创建发布/订阅主题</li><li id="816b" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">将功能部署到云功能</li><li id="c9ed" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">使用云调度程序部署计划的作业</li><li id="837d" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">设置失败的电子邮件通知</li></ul><h1 id="c65d" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">先决条件</h1><p id="149d" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">在继续本教程之前，我们需要确保</p><ul class=""><li id="df7f" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">Cloud Spanner中存在一个数据库(可以尝试这个<a class="ae jd" href="https://github.com/cloudspannerecosystem/sampledb" rel="noopener ugc nofollow" target="_blank"> sampledb </a>创建一个样本数据库)，并且</li><li id="4632" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" href="https://cloud.google.com/sdk/install" rel="noopener ugc nofollow" target="_blank">谷歌SDK </a>安装完毕。</li></ul><h1 id="d644" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">创建发布/订阅主题</h1><p id="732e" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">我们创建了一个发布/订阅主题<strong class="ih hj">云扳手计划备份</strong>:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="8d4c" class="lm kf hi li b fi ln lo l lp lq">$ gcloud pubsub topics create cloud-spanner-scheduled-backups</span></pre><p id="26d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，进入发布/订阅界面，您可以看到新创建的主题:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es lr"><img src="../Images/9de007a55086989c0fe23022a0c1500a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vQj5nYJjhSq1x5MpI_nx1g.png"/></div></div></figure><h1 id="3c6a" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">将功能部署到云功能</h1><p id="5204" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">我们在<a class="ae jd" href="https://github.com/cloudspannerecosystem/scheduled-backups/blob/master/backups.go" rel="noopener ugc nofollow" target="_blank">备份中有一个函数<strong class="ih hj"> SpannerCreateBackup </strong>。每当有发布/订阅消息传入时，就会调用<strong class="ih hj"> SpannerCreateBackup </strong>函数。发布/订阅消息包含数据库名称、备份ID和到期持续时间(至少6小时)。解析消息后，它在Cloud Spanner中启动CreateBackup操作。</a></p><p id="2d3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以通过运行以下命令来部署该功能:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="021f" class="lm kf hi li b fi ln lo l lp lq">$ gcloud functions deploy SpannerCreateBackup — trigger-topic cloud-spanner-scheduled-backups — runtime go113</span></pre><p id="c6ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到云函数UI查找函数。该函数订阅发布/订阅主题<strong class="ih hj">云扳手计划备份</strong>。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es ls"><img src="../Images/f9d159386cb687b15046d3d39ac0d16a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rwyjcImlkDfioU6Hc-7iBQ.png"/></div></div></figure><p id="3613" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以通过<strong class="ih hj"> gcloud </strong>测试它:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="18df" class="lm kf hi li b fi ln lo l lp lq">$ DATA=$(printf ‘{“database”:”projects/[PROJECT_ID]/instances/[INSTANCE_ID]/databases/[DATABASE_ID]”, “expire”: “6h”}’|base64|tr -d ‘\n’) &amp;&amp; gcloud functions call SpannerCreateBackup — data ‘{“data”:”’$DATA’”}’</span></pre><p id="f10b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将直接触发导致创建备份的功能的执行。</p><h1 id="ad78" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">使用云调度程序部署计划的作业</h1><p id="1d3d" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">注意:要使用云调度程序，我们必须<a class="ae jd" href="https://cloud.google.com/scheduler/docs#supported_regions" rel="noopener ugc nofollow" target="_blank">创建一个App Engine app </a>。</p><p id="8f7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae jd" href="https://github.com/cloudspannerecosystem/scheduled-backups" rel="noopener ugc nofollow" target="_blank">定时备份</a>下有一个定时模板文件<strong class="ih hj"> schedule-template.yaml </strong>。我们需要制作一个副本，并将其重命名为<strong class="ih hj"> schedule.config.yaml </strong>。然后，我们可以用我们的配置替换项目标识、实例标识和数据库标识:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="9c54" class="lm kf hi li b fi ln lo l lp lq">name: <strong class="li hj">PROJECT_ID</strong><br/>  instances:<br/>  — name: <strong class="li hj">INSTANCE_ID</strong><br/>    databases:<br/>      — name: <strong class="li hj">DATABASE_ID</strong><br/>        schedule: <strong class="li hj">0 * * * *</strong> # run hourly<br/>        expire: 6h # the backup will expire after 6 hours<br/>        time_zone: Australia/Sydney # optional. “utc” is the default value.</span></pre><p id="f5ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，该配置文件可用于调整时间表。在任何时候都可以更新字段，如schedule、expire和time zone，然后将作业重新部署到Cloud Scheduler。crontab guru是一个方便的网站，可以生成Cron日程表。</p><p id="ca79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更新配置后，我们可以将其部署到云调度程序:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="fa90" class="lm kf hi li b fi ln lo l lp lq">$ go run cmd/scheduler/main.go -config schedule.config.yaml</span></pre><p id="f2c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们可以在云调度器UI中找到该作业:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es lt"><img src="../Images/73bf146b96743ba8bc340f335acc7b47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eXBgp381hm9SBh_F"/></div></div></figure><h1 id="8c59" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">设置失败的电子邮件通知</h1><p id="0452" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">要获得电子邮件通知，我们需要执行三个步骤:</p><ul class=""><li id="41fe" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">设置电子邮件通知渠道</li><li id="a6ed" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">添加基于日志的指标</li><li id="7d65" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">创建警报策略</li></ul><p id="1778" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们可以按照这个<a class="ae jd" href="https://cloud.google.com/monitoring/support/notification-options#email" rel="noopener ugc nofollow" target="_blank">指南</a>来添加我们的电子邮件地址，作为云监控中的通知渠道。这需要在我们可以在警报策略中使用它们之前完成。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es lt"><img src="../Images/d01ede9cb934a78946fa564b192e6bdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ha5Vm5AHlWKwyRYY"/></div></div></figure><p id="45fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们可以通过使用<a class="ae jd" href="https://cloud.google.com/deployment-manager/docs" rel="noopener ugc nofollow" target="_blank">部署管理器</a>在云日志中添加基于日志的指标。这些自定义指标基于云函数、云调度程序和云扳手生成的过滤日志。我们可以在<a class="ae jd" href="https://github.com/cloudspannerecosystem/scheduled-backups/blob/master/metrics.yaml" rel="noopener ugc nofollow" target="_blank"> metrics.yaml </a>中找到自定义指标的定义。</p><p id="5c16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以运行以下命令来创建自定义指标:</p><pre class="jt ju jv jw fd lh li lj lk aw ll bi"><span id="fa14" class="lm kf hi li b fi ln lo l lp lq">$ gcloud deployment-manager deployments create schedule-backup-metrics-deployment — config metrics.yaml</span></pre><p id="dc0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们需要创建定义何时触发警报的警报策略。最简单的方法是转到云日志下的<strong class="ih hj">基于日志的指标</strong>，对于每个用户定义的指标，都有一个选项“<strong class="ih hj">根据指标</strong>创建警报”。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es lt"><img src="../Images/3a494bdd687361cf6c86486fcd31ab06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Qe5ewgEKnpBto6Jp"/></div></div></figure><p id="ad61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我们可以选择<strong class="ih hj"> sum </strong>作为目标度量的<strong class="ih hj">聚合器</strong>，并选择条件中的选项<strong class="ih hj">最近值</strong>，当任何时间序列违反该值大于0时，将触发警报。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es lt"><img src="../Images/4a2ea199bb1fb0401ce3a47c13436660.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*d9-y6IYLgX5QlQdL"/></div></div></figure><p id="000f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">定义条件后，我们将被带到一个站点来定义警报策略。我们需要为这个警报策略命名，并设置通知通道。每当条件中断并创建警报时，我们都会收到电子邮件通知。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es lt"><img src="../Images/ce15d97ffcb2480cc8353aee8df4413f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*joDEGQ5Jamspcx38"/></div></div></figure><h1 id="1e48" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">摘要</h1><p id="b3aa" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated"><a class="ae jd" href="https://github.com/cloudspannerecosystem/scheduled-backups" rel="noopener ugc nofollow" target="_blank">定时备份</a>向您展示如何使用云调度程序和云功能来配置创建云扳手备份的时间表。此外，它还演示了如何创建基于日志的指标和警报策略。它们用于在预定义的条件被打破时发送警报，以便我们可以获得及时的通知。整个项目提供了一个解决方案，用于按照定义的时间表创建云扳手备份。</p></div></div>    
</body>
</html>