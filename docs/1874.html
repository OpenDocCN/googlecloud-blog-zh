<html>
<head>
<title>Is there a public Pub/Sub Lite topic?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有公共的Pub/Sub Lite主题吗？</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/is-there-a-public-pub-sub-lite-topic-95a19ede4d6a?source=collection_archive---------6-----------------------#2021-05-04">https://medium.com/google-cloud/is-there-a-public-pub-sub-lite-topic-95a19ede4d6a?source=collection_archive---------6-----------------------#2021-05-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d0ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在许多谷歌云快速入门和教程中，这个公共发布/订阅主题<code class="du jd je jf jg b">projects/pubsub-public-data/topics/taxirides-realtime</code>允许任何人订阅它，并实时收听虚假的出租车乘坐数据。<strong class="ih hj">Pub/Sub Lite也存在这样的公共话题吗？</strong>在这篇博文中，我将解释为什么拥有一个公共的Pub/Sub Lite主题是不可行的，你如何仍然可以与他人共享一个Pub/Sub Lite主题资源，最后，你可以做些什么来将虚假的出租车乘车数据从Pub/Sub公共主题路由到你的Pub/Sub Lite主题。</p></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="9a8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我深入研究Pub/Sub Lite之前，让我回顾一下如何创建对Pub/Sub主题的订阅。假设我有一个项目<code class="du jd je jf jg b">bamboo-copilot-311421</code>。我可以创建公共发布/订阅主题的订阅，如下所示:</p><pre class="jo jp jq jr fd js jg jt ju aw jv bi"><span id="c673" class="jw jx hi jg b fi jy jz l ka kb">gcloud pubsub subscriptions create bobcat \<br/>  --project=bamboo-copilot-311421 \<br/>  --topic=projects/pubsub-public-data/topics/taxirides-realtime</span></pre><p id="5afd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您也可以这样做的原因是，这个公共主题资源有一个IAM绑定，专门授予<code class="du jd je jf jg b">allUsers</code>角色<code class="du jd je jf jg b">roles/pubsub.subscriber</code>，其中包括权限<code class="du jd je jf jg b">pubsub.topics.attachSubscription</code>。</p><p id="a3d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建订阅后，我可以通过以下方式从该订阅中提取消息:</p><pre class="jo jp jq jr fd js jg jt ju aw jv bi"><span id="d871" class="jw jx hi jg b fi jy jz l ka kb">gcloud pubsub subscriptions pull bobcat \<br/>  --project=bamboo-copilot-311421 \<br/>  --limit=1 \<br/>  --auto-ack=true</span></pre><p id="0304" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我可以从这个订阅中提取消息，因为我登录的帐户或我的工作电子邮件具有<code class="du jd je jf jg b">project.owner</code>角色，其中包括权限<code class="du jd je jf jg b">pubsub.subscriptions.consume</code>。</p><p id="9927" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想知道您当前在计算机上使用的是哪个<code class="du jd je jf jg b">gcloud</code>帐户和项目，请尝试:</p><pre class="jo jp jq jr fd js jg jt ju aw jv bi"><span id="95c2" class="jw jx hi jg b fi jy jz l ka kb">gcloud config list</span></pre><p id="a34d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如何看到哪些角色绑定到您的帐户？</p><pre class="jo jp jq jr fd js jg jt ju aw jv bi"><span id="d124" class="jw jx hi jg b fi jy jz l ka kb">export PROJECT=$(gcloud config get-value project)<br/>export EMAIL=$(gcloud config get-value account)</span><span id="9fc6" class="jw jx hi jg b fi kc jz l ka kb">gcloud projects get-iam-policy $PROJECT \<br/>  --format="table(bindings.members,bindings.role)" \<br/>  --flatten="bindings[].members" \<br/>  --filter="bindings.members=user:$EMAIL"</span></pre></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="5fa5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将订阅附加到现有的发布/订阅Lite主题遵循类似的步骤。假设我的项目ID <code class="du jd je jf jg b">bamboo-copilot-311421</code>有项目编号<code class="du jd je jf jg b">831370759181</code>。创建订阅我拥有的发布/订阅Lite主题的命令看起来像:</p><pre class="jo jp jq jr fd js jg jt ju aw jv bi"><span id="92f5" class="jw jx hi jg b fi jy jz l ka kb">gcloud pubsub lite-subscriptions create starfish \<br/>  --project=bamboo-copilot-311421 \<br/>  --topic=projects/831370759181/locations/us-east1-b/topics/fish \<br/>  --zone=us-east1-b</span></pre><p id="4cca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用类似的命令，您将无法在您的项目中将订阅附加到该主题，因为<strong class="ih hj"> Pub/Sub Lite不跨项目共享主题和订阅资源</strong>。你能做的最好的事情就是被允许在我的项目中创建一个Pub/Sub Lite订阅。这需要我为您的帐户添加一些IAM绑定:</p><pre class="jo jp jq jr fd js jg jt ju aw jv bi"><span id="3797" class="jw jx hi jg b fi jy jz l ka kb">gcloud projects add-iam-policy-binding bamboo-copilot-311421 \<br/>  --member='user:$YOUR-EMAIL' \<br/>  --role='roles/browser'</span><span id="a537" class="jw jx hi jg b fi kc jz l ka kb">gcloud projects add-iam-policy-binding bamboo-copilot-311421 \<br/>  --member='user:$YOUR-EMAIL' \<br/>  --role='roles/pubsublite.admin' \<br/>  --condition-from-file='conditions.json'</span></pre><p id="76ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其中<code class="du jd je jf jg b">conditions.json</code>看起来像:</p><pre class="jo jp jq jr fd js jg jt ju aw jv bi"><span id="2e81" class="jw jx hi jg b fi jy jz l ka kb">{<br/>  "title": "fish",<br/>  "description": "Allow creating subscriptions to a specific Pub/Sub topic",<br/>  "expression":<br/>     "(resource.type == 'pubsublite.googleapis.com/Topic' &amp;&amp; <br/>     resource.name == 'projects/831370759181/locations/us-central1-b/topics/fish')"<br/>}</span></pre><p id="0fb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在这里使用<code class="du jd je jf jg b">--condition-from-file</code>标志来添加IAM条件，因为它可以限制我打算打开哪个发布/订阅Lite主题的访问。在IAM <a class="ae kd" href="https://cloud.google.com/iam/docs/conditions-overview" rel="noopener ugc nofollow" target="_blank">条件</a>中可以设置更多参数。</p><p id="7f10" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于<code class="du jd je jf jg b">--member</code>，服务账户也可以。服务帐户是Google Cloud客户端库向Google Cloud services认证的推荐方式。认证是通过环境变量<code class="du jd je jf jg b">GOOGLE_APPLICATION_CREDENTIALS</code>指向的服务帐户密钥文件来完成的。</p><p id="b9a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不使用<a class="ae kd" href="https://cloud.google.com/pubsub/lite/docs/access-control#predefined_roles" rel="noopener ugc nofollow" target="_blank">预定义角色</a> <code class="du jd je jf jg b">roles/pubsublite.admin</code>，一个<a class="ae kd" href="https://cloud.google.com/pubsub/lite/docs/access-control#custom_roles" rel="noopener ugc nofollow" target="_blank">定制角色</a>也可以工作，它具有创建订阅和消费消息的较小权限集。</p><p id="6a93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一般来说，在云控制台中编辑IAM条件比在终端中使用gcloud命令容易得多。</p><p id="7a49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要创建一个所有人都可以订阅的公共Pub/Sub Lite主题，项目所有者必须将所有人的帐户(电子邮件或服务帐户)添加到他或她的项目中，并根据不同的订阅名称让所有人遵守略有不同的IAM条件。否则，人们可能会访问其他人的订阅，并从这些订阅中获取信息。此外，每个人都必须共享项目中的订阅吞吐量(最大128 MiB/s)和每个发布/订阅Lite主题分区的订阅吞吐量(4-32 MiB/s)。其他硬性限制——一个项目中的Lite主题只允许<a class="ae kd" href="https://cloud.google.com/pubsub/lite/quotas" rel="noopener ugc nofollow" target="_blank"> 1，000 </a>个订阅——也同样适用。计费方面，公共发布/订阅精简版主题的项目所有者将为每个人的发布/订阅精简版订阅和流量付费，这将不可避免地增加。综上所述，一个真正公开的发布/订阅主题是不可行的。</p></div><div class="ab cl jh ji gp jj" role="separator"><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm jn"/><span class="jk bw bk jl jm"/></div><div class="hb hc hd he hf"><p id="1e7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你有兴趣拥有自己的流媒体发布/订阅源，就像公共发布/订阅主题一样，该怎么办？我可以想到一个场景，您已经有了针对Pub/Sub进行测试的代码，并且您想看看Pub/Sub Lite在比较中的表现如何。</p><p id="6ffb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">嗯，建立一个并不太难。您可以建立一个数据流管道，不断地将消息从发布/订阅公共主题发布到发布/订阅精简主题。你只需要一个Pub/Sub Lite主题。</p><p id="bd60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当你准备好了，去数据流控制台<a class="ae kd" href="https://pantheon.corp.google.com/dataflow/createjob" rel="noopener ugc nofollow" target="_blank">创建一个模板</a>。</p><p id="e7f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在“数据流模板”下，选择“自定义模板”。然后提供我已经公开的模板文件的路径:<code class="du jd je jf jg b">gs://pubsub-public-data/templates/pubsublite-public-topic-template.json</code>。也提供你的发布/订阅主题名。如果您还没有启用Dataflow Flex模板服务，您可能需要启用它。</p><figure class="jo jp jq jr fd kf er es paragraph-image"><div class="er es ke"><img src="../Images/8963b81cb4fa72ecc955a7f1fe2acc1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/0*FXug3t_xyCpPbx_D"/></div></figure><p id="9f04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单击“运行作业”。</p><figure class="jo jp jq jr fd kf er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es ki"><img src="../Images/7ea2dacdef0b7988a7a5061269647020.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Kou9GzNOpugmHsQL"/></div></div></figure><p id="70ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据流需要一些时间来准备好管道。一旦它开始运行，您应该可以通过访问Lite主题详细信息页面或尝试从订阅中提取一些消息来查看到达您的发布/订阅主题的消息。</p><figure class="jo jp jq jr fd kf er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es ki"><img src="../Images/453cffd34a12a8efc2f36842210f64de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nZ8OMpqSLk7GjHuo"/></div></div></figure><p id="e9c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在<a class="ae kd" href="https://github.com/anguillanneuf/pubsublite-public-topic-template" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上查看我用来创建这个定制模板的代码和命令。</p><p id="988e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望我已经在这篇博客文章中阐明了为什么Pub/Sub Lite没有一个公共主题，以及你如何仍然可以与他人分享你的Pub/Sub Lite主题。也希望你发现数据流模板对你的测试用例有用。感谢您的阅读！</p></div></div>    
</body>
</html>