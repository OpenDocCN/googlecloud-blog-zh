<html>
<head>
<title>Traefik on a Google Kubernetes Engine Cluster managed by Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">由Terraform管理的Google Kubernetes引擎集群上的Traefik</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/traefik-on-a-google-kubernetes-engine-cluster-managed-by-terraform-ad871be8ee26?source=collection_archive---------0-----------------------#2018-07-06">https://medium.com/google-cloud/traefik-on-a-google-kubernetes-engine-cluster-managed-by-terraform-ad871be8ee26?source=collection_archive---------0-----------------------#2018-07-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9582" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Kubernetes引擎是一个很好的、简单的方法来探索Kubernetes，而不必担心自己创建一个集群。</p><p id="93f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在摆弄它的时候，我立即开始问自己如何自动化创建GKE集群的过程，以及如何轻松地部署强大的<a class="ae jd" href="https://traefik.io/" rel="noopener ugc nofollow" target="_blank"> Traefik </a>作为我的入口控制器。</p><h1 id="88c7" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">最初的想法</h1><p id="106a" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">首先，正如已经提到的，我想尽可能自动化。因此，我决定使用以下工具:</p><ul class=""><li id="e2db" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae jd" href="https://cloud.google.com/sdk/gcloud/" rel="noopener ugc nofollow" target="_blank"> gcloud命令行</a></li><li id="12d2" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank">地形</a></li><li id="c6c1" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated"><a class="ae jd" href="https://kubernetes.io/docs/reference/kubectl/overview/" rel="noopener ugc nofollow" target="_blank">库贝克特尔</a></li></ul><p id="1bd3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于terraform kubernetes提供程序中缺少修改集群上RBAC的功能，我偏离了最初的想法，只通过terraform部署traefik，并决定也使用kubectl。</p><h1 id="dbc4" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">要求</h1><p id="f85c" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">当然，首先我们需要一个GCP项目用于我们的小案例。在那个项目中，我们需要在<strong class="ih hj">计算API </strong>处启用<strong class="ih hj">计费</strong>。</p><p id="ac1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，我们显然需要安装上面的工具。本文中使用的所有文件都可以在github 上的这个<a class="ae jd" href="https://github.com/SantoDE/terraform-gcp-kubernetes-traefik" rel="noopener ugc nofollow" target="_blank">示例项目中获得。代码还包括一些行内注释来解释它在做什么；-)</a></p><h1 id="b0ba" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">让我们开始吧！</h1><p id="fd67" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">好了，既然一切都解决了，我们终于可以进入正题了。首先，我们需要初始化我们的gcloud命令行。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/b8b255697166b1338793da314e2f3f45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OL-B6HJcvv589K9Q3KYxBg.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">g云初始化</figcaption></figure><p id="9121" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的例子中，我已经有了一个配置，所以我会选择第一个选项。如果你没有任何配置，这个屏幕不会出现。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ll"><img src="../Images/ea676589ecc9bb0e0369b4abf003969e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KE_avPlruy87efQ0qDzaqQ.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">第一选项</figcaption></figure><p id="3c46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你看到这个屏幕，我们正处于重要的一步。请不要用你在这里选择的电子邮件地址(这是来自你的gcp帐户)。你以后会需要它的。之后，只需遍历init链。这是不言自明的。</p><p id="a70f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成初始化后，我们现在需要将sdk与您的帐户连接起来。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lm"><img src="../Images/9f595cb450254cce80f0ffc6dd613722.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mAjAUGESiKSmupMLSxMAmw.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">将gcloud sdk与您的帐户连接</figcaption></figure><p id="79e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们需要将本地terraform与我们想要使用的项目连接起来。所以只管跑</p><pre class="kw kx ky kz fd ln lo lp lq aw lr bi"><span id="4bfc" class="ls jf hi lo b fi lt lu l lv lw">export GOOGLE_PROJECT=$(gcloud config get-value project)</span></pre><p id="1316" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们的gcloud sdk和terraform已经蓄势待发。你记得你需要记下来的电子邮件地址吗？现在是使用它的时候了。</p><p id="d3ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如已经提到的，GKE有一些强有力的RBAC政策，所以我们需要在部署过程中修改它。默认情况下，您的kubectl用户没有权限自行修改RBAC，这需要下一步。</p><p id="1d18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在文件<a class="ae jd" href="https://github.com/SantoDE/terraform-gcp-kubernetes-traefik/blob/master/services/traefik/01_permissions.yml" rel="noopener ugc nofollow" target="_blank"> permissions.yml </a>中，我们需要编辑第12行，并输入您记下的电子邮件地址。</p><pre class="kw kx ky kz fd ln lo lp lq aw lr bi"><span id="8fc6" class="ls jf hi lo b fi lt lu l lv lw">subjects:<br/>- apiGroup: rbac.authorization.k8s.io<br/>  kind: User<br/>  name: &lt;yourgcpaccountemail.com&gt;</span></pre><p id="11b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦完成，我们就可以初始化地形了:-)</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lx"><img src="../Images/89a5cc483695a59c51e5ea9fb49a2c79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EbHOEEyGHwkJhyOAoCfLcQ.png"/></div></div></figure><p id="c05b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一步是应用terraform来创建集群。</p><pre class="kw kx ky kz fd ln lo lp lq aw lr bi"><span id="eeeb" class="ls jf hi lo b fi lt lu l lv lw">terraform apply</span></pre><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ly"><img src="../Images/6d8ec8dde462ed2ff84ee96104cf9133.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jYjVWsHaBWjJWtKmC38jeQ.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">地形应用</figcaption></figure><p id="2fe1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">耐心点，这需要一点时间；-)但最终，你会看到这个</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lz"><img src="../Images/4b8b3d8b33a761e849e062cddf0f73d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UviHNry44_ppJ34PQYzp0w.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">地形应用结果</figcaption></figure><p id="56da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你看到这个，你会在你的谷歌云控制台上看到一个成熟的集群。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ma"><img src="../Images/6f350ef800370326897cc30b2edb958d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o0KpZS6KpY0lR5QBGac9Sg.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">谷歌云控制台</figcaption></figure><p id="e878" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了能够部署一些服务，我们现在需要将我们的本地kubectl与GKE上产生的集群连接起来。这可以通过简单地运行</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mb"><img src="../Images/6f5d46ad489d4a68ba8fc8126868f2cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*db1nw2xkBUqEGpOeeQnFbg.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">连接kubectl</figcaption></figure><p id="1e64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们终于可以部署traefik了。使用提供的代码，这只是一个简单的</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mc"><img src="../Images/70db79abd67f3e43f9cd0d0999cd0991.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cw7fR6Jm9xjN19k9x0ND3w.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">产卵鱼</figcaption></figure><p id="4470" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">生成的traefik的配置可以在<a class="ae jd" href="https://github.com/SantoDE/terraform-gcp-kubernetes-traefik/blob/master/services/traefik/03_config.yml" rel="noopener ugc nofollow" target="_blank">她的</a> e中找到</p><p id="6562" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后但同样重要的是，只需应用两个演示服务</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es md"><img src="../Images/7b4eb7bf3b459db50f5246cb892892bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LIEwnT_vRccRikC7Z52Few.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">应用演示服务</figcaption></figure><p id="1ecb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们完事了。</p><h1 id="c76b" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">检查结果</h1><p id="2f2d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">现在是时候检查我们做了什么。首先，前往您的GKE仪表板，检查衍生的服务</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es me"><img src="../Images/36d45c5b9b355647b13da46b60a594fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lC0Endh49g7kFIe0yn_TiQ.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">GKE仪表板</figcaption></figure><p id="628d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以看到，<strong class="ih hj">trae fik-ingress-controller</strong>有一个外部ip和两个开放的端口。我们的2个演示服务部署在<strong class="ih hj">whoami . traefikkge</strong>和<strong class="ih hj">nginx . traefikkge .</strong>下。接下来，让我们检查traefik仪表板。正如你所猜测的，在公共IP和<strong class="ih hj"> 8080 </strong>端口下，这是可以到达的。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mf"><img src="../Images/c28e68e86df9790e4f6d0c5d0db9a75f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zw-FIkPWKUK-qaHcgQSY8A.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">Traefik仪表板</figcaption></figure><p id="b009" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要检查这两个服务，最好是将名为<strong class="ih hj">whoami . traefikkge</strong>和<strong class="ih hj">nginx . traefikkge</strong>的本地主机设置为上面的公共ip。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mg"><img src="../Images/ca92d71586ed04ba0587f6200ffab146.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FlMfmfo87QZc7fKAaTc2DQ.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">whoami.traefikgke</figcaption></figure><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mh"><img src="../Images/c6bcd82d44217281ca0d2291aa20e6a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Pj-1AseyIbZqdyP4KVuLg.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">nginx.traefikgke</figcaption></figure><p id="6a25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">包装</strong></p><p id="499b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如您所见，使用示例项目中的代码，事情变得非常简单。设置RBAC (ClusterRoleBindings，ServiceAccounts等)有点棘手，但通过示例代码，它应该是相对不言自明的。</p><p id="846b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">特别感谢丹尼尔·汤姆西在我迷路的时候帮助了我:-)</p><p id="0dec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你有问题或反馈，请随时通过Twitter <a class="ae jd" href="https://twitter.com/mZapfDE" rel="noopener ugc nofollow" target="_blank"> @mZapfDE </a>联系我，我将非常感谢。</p></div></div>    
</body>
</html>