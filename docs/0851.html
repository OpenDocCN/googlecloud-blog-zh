<html>
<head>
<title>Build a blog application on Google App Engine: Deploy to Google Cloud (part 8)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google App Engine上构建博客应用程序:部署到Google Cloud(第8部分)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/build-a-node-js-app-on-google-datastore-deploy-to-google-cloud-part-8-e72a8eaed9f7?source=collection_archive---------2-----------------------#2018-12-14">https://medium.com/google-cloud/build-a-node-js-app-on-google-datastore-deploy-to-google-cloud-part-8-e72a8eaed9f7?source=collection_archive---------2-----------------------#2018-12-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/dedc5a9df7ded6cf7908c4c68cb8b22b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZJLZP20wh765VXzraz3WUw.jpeg"/></div></div></figure><p id="ed43" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是关于如何使用<strong class="is hj"> Google Datastore </strong>在Node.js中构建小型博客应用程序并将其部署到<strong class="is hj"> Google App Engine </strong>的系列教程的第八部分，也是最后一部分。如果你错过了开头，<a class="ae jo" rel="noopener" href="/google-cloud/build-a-blog-application-on-google-app-engine-setup-part-1-38dab981b779">跳到第一部分</a>，在那里我解释了如何建立这个项目，在那里你可以找到教程其他部分的链接。</p><p id="00da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们的小博客完成了，看起来棒极了！在这篇文章中，我们将<strong class="is hj">将应用程序部署到Google App Engine </strong>。为此，我们将使用Google的<code class="du jp jq jr js b">gcloud</code> CLI工具，它使这个过程变得极其简单。如果您还没有在您的机器上安装它，<a class="ae jo" href="https://cloud.google.com/sdk/install" rel="noopener ugc nofollow" target="_blank">转到下载页面，首先安装</a>。</p><p id="9a0e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了部署我们的应用程序，<code class="du jp jq jr js b">gcloud</code>需要一个<em class="jt">描述符文件</em>。默认情况下，它是一个位于项目根目录下的<code class="du jp jq jr js b">app.yaml</code>文件。在这里，我们将配置我们的应用程序，设置Node.js运行时版本，分配资源，缩放规则，声明环境变量等。您可以在这里找到所有可用选项的文档。</p><h1 id="101f" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">创建数据存储索引</h1><p id="bd45" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">到目前为止，<strong class="is hj">我们一直在本地数据存储模拟器</strong>上运行我们的应用程序，它不需要声明索引来执行查询。云数据存储<strong class="is hj">确实要求我们配置索引</strong>，因为它需要提前知道<strong class="is hj">应用程序将发出哪些查询</strong>。关于索引以及我们为什么需要配置它们的更多信息，请阅读文档。</p><p id="ff7a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">与此同时，我们正在构建应用程序，每次我们对本地数据存储模拟器执行查询时，<strong class="is hj">模拟器<code class="du jp jq jr js b">WEB-INF</code>文件夹内的<code class="du jp jq jr js b">index.yaml</code>文件中会自动为我们声明</strong>需要配置的索引。如果您从项目npm脚本 ( <code class="du jp jq jr js b">npm run local-datastore</code>)启动模拟器数据存储<strong class="is hj">，您应该在<code class="du jp jq jr js b">&lt;project-folder&gt;/local-datastore/WEB-INF</code>文件夹中看到这个文件。为了简单起见，如果您的本地模拟器文件夹在不同的位置，这个文件的内容被复制到项目根目录下的"<em class="jt"> index.yaml" </em>文件中。</strong></p><p id="198c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">执行以下命令来配置实时Google Cloud数据存储上的索引:</p><pre class="kx ky kz la fd lb js lc ld aw le bi"><span id="0695" class="lf jv hi js b fi lg lh l li lj">gcloud datastore create-indexes ./index.yaml</span></pre><p id="0286" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">太好了！<strong class="is hj">我们现在准备将我们的应用程序</strong>部署到Google App Engine。</p><h1 id="7155" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">部署应用程序的gcloud</h1><p id="068b" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">下面是一些我们如何用<code class="du jp jq jr js b">gcloud</code>部署应用程序的例子。</p><pre class="kx ky kz la fd lb js lc ld aw le bi"><span id="a2ee" class="lf jv hi js b fi lg lh l li lj"># This is as simple as it gets. gcloud will look for an "app.yaml" <br/># at the root of the project, deploy the application and redirect <br/># all the traffic to it. It will also give the application a random <br/># "version" number.<br/>gcloud app deploy</span><span id="80da" class="lf jv hi js b fi lk lh l li lj"># Here again, gcloud will look for an "app.yaml", deploy the <br/># application, but it will not redirect the traffic (no-promote) to <br/># it. We also manually set the version to "1-0-0"<br/>gcloud app deploy -v 1-0-0 --no-promote</span><span id="d2c7" class="lf jv hi js b fi lk lh l li lj"># To specify a custom descriptor file, just pass it as last argument<br/>gcloud app deploy -v dev --no-promote app.dev.yaml</span></pre><p id="82da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们的例子中，我们不会直接使用<code class="du jp jq jr js b">gcloud</code>，而是使用一个<strong class="is hj"> npm脚本</strong>。这允许我们挂钩其他npm脚本(在部署之前<em class="jt">构建</em>应用程序)，在部署过程中给予我们更多的灵活性。</p><h1 id="5a3c" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">部署应用程序</h1><p id="4751" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">部署我们的应用程序并使其对我们的用户可用<strong class="is hj">将分两步完成</strong>。首先，我们将在<strong class="is hj">语义版本化</strong>之后部署到一个<strong class="is hj">独特的应用程序版本</strong>。如果你没有听说过语义版本控制<a class="ae jo" href="https://semver.org/" rel="noopener ugc nofollow" target="_blank">，请在这里阅读。在这个阶段，我们不会让用户看到部署。这将允许我们首先测试运行在谷歌云上的应用程序，确保一切运行正常。</a></p><p id="9cc7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦我们全面测试了应用程序，<strong class="is hj">第二步将是推广应用程序，并向其发送所有流量</strong>。我们开始吧！</p><h2 id="8853" class="lf jv hi bd jw ll lm ln ka lo lp lq ke jb lr ls ki jf lt lu km jj lv lw kq lx bi translated">1.部署应用程序</h2><pre class="kx ky kz la fd lb js lc ld aw le bi"><span id="8af4" class="lf jv hi js b fi lg lh l li lj">npm run deploy -- -v 1-0-0<br/># or<br/>yarn deploy -v 1-0-0</span></pre><p id="93b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为应用程序引擎不允许点“.”在应用程序版本中，我们使用“-”号代替。您将看到首先构建应用程序代码(服务器和客户端),然后从<code class="du jp jq jr js b">gcloud</code>出现一个确认部署的提示。一旦部署了应用程序，您将有一个URL来测试应用程序，看起来类似于:</p><pre class="kx ky kz la fd lb js lc ld aw le bi"><span id="0e6d" class="lf jv hi js b fi lg lh l li lj">https://1<a class="ae jo" href="https://0-1-0-dot-blog-nodejs.appspot.com" rel="noopener ugc nofollow" target="_blank">-0-0-dot-&lt;your-google-appengine-project&gt;.appspot.com</a></span></pre><p id="0174" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您现在可以测试应用程序，并确保它正常工作。如果您发现任何问题，请更正它们，并使用相同的版本重新运行上述命令。这将覆盖应用引擎中的版本。一旦你对应用程序进行了全面的测试，并且对它感到满意，你就可以<strong class="is hj">推广它了。</strong>升级一个版本会将所有流量发送给它，让你的用户可以使用。</p><h2 id="5264" class="lf jv hi bd jw ll lm ln ka lo lp lq ke jb lr ls ki jf lt lu km jj lv lw kq lx bi translated">2.推广应用</h2><pre class="kx ky kz la fd lb js lc ld aw le bi"><span id="5064" class="lf jv hi js b fi lg lh l li lj">npm run promote -- -v 1-0-0<br/># or<br/>yarn promote -v 1-0-0</span></pre><p id="cffa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">太好了！你现在应该已经有了一个运行在谷歌应用引擎上的完全正常的博客应用<strong class="is hj">！</strong></p><p id="4097" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于现实世界的应用程序，我们仍然需要改进一些东西。例如，我们需要保护认证系统后面的<code class="du jp jq jr js b">Admin</code>路由，我们可能会<a class="ae jo" href="https://cloud.google.com/appengine/docs/standard/python/mapping-custom-domains" rel="noopener ugc nofollow" target="_blank">添加一个自定义域</a>。我把这个留给你做练习。</p><p id="629f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">至此，我们完成了本教程。我希望你像我写这篇文章时一样喜欢它，并且你现在意识到在Google Cloud上启动你的下一个Node.js项目是多么容易。</p><p id="7430" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">像往常一样，如果你发现任何问题或者有什么不清楚的地方，请在评论中告诉我。</p><p id="71c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">编码快乐！</p></div></div>    
</body>
</html>