<html>
<head>
<title>EKS cluster managed by GCP Anthos</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP·安索斯管理的EKS集群</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/eks-cluster-managed-by-gcp-anthos-69cba0cb0bd0?source=collection_archive---------0-----------------------#2022-12-08">https://medium.com/google-cloud/eks-cluster-managed-by-gcp-anthos-69cba0cb0bd0?source=collection_archive---------0-----------------------#2022-12-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="34cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">跨您的环境进行现代化管理，以实现云优势</p><h2 id="9f6f" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">概观</h2><p id="3241" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">在当今基于云的世界中，SaaS服务是真正的游戏规则改变者，这一点可能不会立即显现出来，但云应用程序开发简化趋势，并引发了软件即服务的现象。</p><p id="3389" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到2019年<strong class="ih hj">，<strong class="ih hj"> 94% </strong>的企业采用云服务来运行其工作负载。<strong class="ih hj"> 84% </strong>的企业拥有<strong class="ih hj">多云</strong>战略。<strong class="ih hj"> 76% </strong>的客户表示<strong class="ih hj">云计算</strong>管理是一项重大挑战。</strong></p><p id="2ec0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">多云</strong>正在与<strong class="ih hj"> SAAS </strong>、<strong class="ih hj"> PAAS </strong>、<strong class="ih hj"> IAAS </strong>在整个<strong class="ih hj">公有</strong> &amp; <strong class="ih hj">私有</strong>领域占据一席之地。未来是<strong class="ih hj">多云</strong>和<strong class="ih hj">混合</strong>。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es kd"><img src="../Images/f9382b6d91aa5ae5d300a48b7346411c.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*C09C_RdxZC3YhUfFC2xXWQ.png"/></div></div></figure><h2 id="8297" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated"><strong class="ak">Anthos的出现</strong></h2><p id="0f0c" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">为了推动企业的数字化转型，每个组织都需要一个云计算解决方案。</p><p id="10a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当讨论多云或混合云时，Anthos就出现了。客户利用Anthos来更新应用程序并增强可伸缩性</p><p id="c734" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Anthos是一个提供众多选项的平台。</p><ul class=""><li id="6653" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc ku kv kw kx bi translated">多集群管理—任何Kubernetes集群(EKS、阿拉斯加、本地)</li><li id="36ae" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">Gitops风格的配置管理(策略、安全YAML真实报告的单一来源)</li><li id="514e" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">服务管理— Anthos服务网格</li><li id="b4dc" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">无服务器— Anthos云运行</li><li id="50c6" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">记录和监控</li></ul><h2 id="6785" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">演示</h2><p id="9d8c" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">在本文中，我们将了解如何管理AWS EKS集群或将它附加到GCP·GKE·安托什。</p><h2 id="2e6d" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">先决条件</h2><ul class=""><li id="f3f3" class="kp kq hi ih b ii jy im jz iq ld iu le iy lf jc ku kv kw kx bi translated">AWS帐户</li><li id="d526" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">GCP账户</li><li id="3aff" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">基本K8s设置</li><li id="44ac" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">将（行星）地球化（以适合人类居住）</li></ul><p id="e469" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是设置EKS集群的Terraform代码的GitHub链接:<a class="ae lg" href="https://github.com/hashicorp/learn-terraform-provision-eks-cluster" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/hashi corp/learn-terra form-provision-eks-cluster</a></p><p id="ab9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以从AWS控制台构建一个新的EKS，也可以使用现有的。</p><p id="dd28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我从控制台创建了一个</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lh"><img src="../Images/a5d6f4ebe80388873676f90adbbe04ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e7HU0nrjAIMAOkaxXbZhAg.png"/></div></div></figure><p id="ca1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行下面的命令为EKS集群设置kubectl</p><pre class="ke kf kg kh fd li lj lk bn ll lm bi"><span id="dd4a" class="ln je hi lj b be lo lp l lq lr">aws eks - region &lt;Region name&gt; update-kubeconfig - name &lt;Cluster name&gt;</span></pre><p id="298c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行<strong class="ih hj"> kubectl get ns </strong>并验证一切正常</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es ls"><img src="../Images/36ca4d386b6638aaaf4634c0496dd14a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jRgm6ts8WnT0JQJLHjPIUA.png"/></div></div></figure><p id="8a50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，集群已经准备就绪。我们将把这个集群连接到GCP·安索斯，并把GCP控制台作为一个单一的控制台。</p><p id="b1ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用下面的命令获取EKS集群的OIDC(OpenID Connect) URL。</p><pre class="ke kf kg kh fd li lj lk bn ll lm bi"><span id="9905" class="ln je hi lj b be lo lp l lq lr">export OIDC_URL=$(aws eks describe-cluster --name &lt;EKS Cluster&gt; --region &lt;Region&gt; --query "cluster.identity.oidc.issuer" --output text)</span></pre><p id="8e01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">保存当前kubeconfig上下文</p><pre class="ke kf kg kh fd li lj lk bn ll lm bi"><span id="30a5" class="ln je hi lj b be lo lp l lq lr">export KUBE_CONFIG_CONTEXT=$(kubectl config current-context)</span></pre><p id="8359" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到GCP Anthos控制台，点击注册现有集群。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lt"><img src="../Images/c6db0ae9f72e3a6c63ba748227360e4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xsnhvLkGcgbaFYbauvV4pw.png"/></div></div></figure><p id="06e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，选择<strong class="ih hj">添加外部集群</strong></p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lu"><img src="../Images/247c07f7c3f38753415204957b697331.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3y74a0ctJphwkFFIVAYQ0A.png"/></div></div></figure><p id="0682" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加<strong class="ih hj">集群名称</strong>和必要的标签，点击<strong class="ih hj">生成注册命令</strong>继续。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lv"><img src="../Images/d6542b55c33a1ca1312fe14ff9add4f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AgVkF4C-fPYyKQ5UUcTTaA.png"/></div></div></figure><p id="f9da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让命令在CLI上运行，修改命令中的必要更改</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lw"><img src="../Images/850a8843d297845a2b955a66585a698c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kGWmkGU1fc1-C53zLcY-BQ.png"/></div></div></figure><p id="d64e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">SKIP——与命令中一样，使用了<strong class="ih hj"> service-account-key-file </strong>,因此您可以创建一个服务帐户或跳过步骤。</p><pre class="ke kf kg kh fd li lj lk bn ll lm bi"><span id="271a" class="ln je hi lj b be lo lp l lq lr">gcloud iam service-accounts create &lt;SERVICE_ACCOUNT_NAME&gt; --project=PROJECT_ID<br/><br/>PROJECT_ID=&lt;PROJECT ID of GCP&gt;<br/><br/>gcloud projects add-iam-policy-binding ${PROJECT_ID} \<br/>   --member="serviceAccount:&lt;SERVICE_ACCOUNT_NAME&gt;@${PROJECT_ID}.iam.gserviceaccount.com" \<br/>   --role="roles/gkehub.connect"</span></pre><p id="c845" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下载serviceaccount JSON文件</p><pre class="ke kf kg kh fd li lj lk bn ll lm bi"><span id="c595" class="ln je hi lj b be lo lp l lq lr">gcloud iam service-accounts keys create ./service-account.json \<br/>   --iam-account=SERVICE_ACCOUNT_NAME@${PROJECT_ID}.iam.gserviceaccount.com \<br/>   --project=${PROJECT_ID}</span></pre><p id="252f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您已经在上面创建了serviceaccount，您可以运行下面的<strong class="ih hj"> gcloud </strong>命令，将EKS集群注册为anthos的成员。</p><pre class="ke kf kg kh fd li lj lk bn ll lm bi"><span id="6302" class="ln je hi lj b be lo lp l lq lr">gcloud container hub memberships register &lt;Cluster-name&gt; \<br/>            --context=$KUBE_CONFIG_CONTEXT \<br/>            --service-account-key-file=[LOCAL_KEY_PATH] \<br/>            --public-issuer-url=$OIDC_URL \<br/>            --kubeconfig="./config" \<br/>            --project=&lt;Project ID&gt;</span></pre><p id="7b9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您还没有在上面的步骤中创建serviceaccount，您可以运行下面的云来将EKS集群注册到anthos。</p><pre class="ke kf kg kh fd li lj lk bn ll lm bi"><span id="17e4" class="ln je hi lj b be lo lp l lq lr">gcloud container hub memberships register &lt;Cluster-name&gt; \<br/>            --context=$KUBE_CONFIG_CONTEXT \<br/>            --public-issuer-url=$OIDC_URL \<br/>            --kubeconfig="./config" \<br/>            --project=&lt;Project ID&gt; \<br/>            --enable-workload-identity</span></pre><p id="66a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注册成功后，您会收到消息。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lx"><img src="../Images/a2804fc88068079c7e5dfdf250c241ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4dwahAeSv0NGzQE5BTq62w.png"/></div></div></figure><p id="3a23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您也可以从GCP控制台验证成员身份。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es ly"><img src="../Images/76c6164dde80800cc18554a1352671eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N6u3-qcEWGmssaoOpHxKnQ.png"/></div></div></figure><p id="5e5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽管如此，GKE仍在等待AWS-eks-cluster Connect与谷歌的连接。这是由于EKS群集没有配额，因此在纵向扩展一个新节点后，该问题得到解决。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lz"><img src="../Images/fc6826a2884e3dabcd852892058dd453.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OwCyJA04NGxI9-Eecjni1g.png"/></div></div></figure><p id="b5ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GKE试图在K8s名称空间<strong class="ih hj"> gke-connect中创建一个部署POD。</strong></p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es ma"><img src="../Images/a2e477244229dcca1b59e4ffb8a76e83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*avzOOxnkdCQVFYmms1nXkA.png"/></div></div></figure><p id="c7b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在成功连接之后，让我们进行身份验证，并授予管理员对<strong class="ih hj"> Anthos </strong>的访问权限</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es mb"><img src="../Images/3ef03e777df55c9362cc039ef97c0eb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m5UQ8YssO8kh-wyuKvEP2w.png"/></div></div></figure><p id="9918" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Kubernetes集群中创建服务帐户，</p><pre class="ke kf kg kh fd li lj lk bn ll lm bi"><span id="8f36" class="ln je hi lj b be lo lp l lq lr">kubectl create serviceaccount -n kube-system anthos-admin <br/>kubectl create clusterrolebinding anthos-admin-binding --clusterrole cluster-admin --serviceaccount kube-system:anthos-admin </span></pre><p id="c23c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从服务帐户中获取令牌</p><pre class="ke kf kg kh fd li lj lk bn ll lm bi"><span id="d750" class="ln je hi lj b be lo lp l lq lr">SECRET_NAME=$(kubectl get serviceaccount -n kube-system anthos-admin -o jsonpath='{$.secrets[0].name}')<br/>kubectl get secret -n kube-system ${SECRET_NAME} -o jsonpath='{$.data.token}' | base64 -d | sed $'s/$/\\\n/g'</span></pre><p id="e88e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到anthos控制台，单击登录，选择令牌选项并粘贴</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es mc"><img src="../Images/7dfd21edf5d60456eda9045036562ff7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*37vZlYzheeXuaiZG_WupKg.png"/></div></div></figure><p id="5245" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以利用anthos的不同特性来管理集群。准备好了…！</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es md"><img src="../Images/2291d0581d4a8a12364e24fe8b2ef375.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iZ-myv9brgcRmFpBVuIaEg.png"/></div></div></figure></div></div>    
</body>
</html>