<html>
<head>
<title>Google CloudSQL Auth Proxy — A resilient approach</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google CloudSQL身份验证代理——一种弹性方法</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloudsql-auth-proxy-a-resilient-approach-e61c3d150cd9?source=collection_archive---------0-----------------------#2022-01-30">https://medium.com/google-cloud/google-cloudsql-auth-proxy-a-resilient-approach-e61c3d150cd9?source=collection_archive---------0-----------------------#2022-01-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="eee7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">让我们拨开围绕</em> <strong class="ih hj"> <em class="jd"> CloudSQL Auth Proxy的迷雾。</em> </strong></p><p id="a198" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Google </strong> <a class="ae je" href="https://cloud.google.com/sql/docs/mysql/sql-proxy" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">云SQL授权代理</strong> </a>是一个二进制文件，在连接到云SQL实例时提供基于IAM的授权和加密。应用程序使用数据库使用的标准数据库协议与云SQL身份验证代理进行通信，云SQL身份验证代理使用安全隧道与其在服务器上运行的伙伴进程进行通信。</p><blockquote class="jf jg jh"><p id="f532" class="if ig jd ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">围绕它有许多常见误解，这篇博客的主要目的是提供一个事实核查。</p></blockquote><h2 id="7e4c" class="jl jm hi bd jn jo jp jq jr js jt ju jv iq jw jx jy iu jz ka kb iy kc kd ke kf bi translated">一些常见的误区:</h2><ol class=""><li id="127a" class="kg kh hi ih b ii ki im kj iq kk iu kl iy km jc kn ko kp kq bi translated">用户主要担心的一个问题是，CloudSQL代理将成为单点故障，因此不符合他们的高可用性战略。</li><li id="7fde" class="kg kh hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated">如果需要连接到多个数据库实例，则需要多个CloudSQL代理实例。</li><li id="f683" class="kg kh hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated">使用CloudSQL代理会导致网络出口费用，因为它将连接到公共IP上的CloudSQL实例，因此会增加安全风险，因为CloudSQL实例暴露于公共网络。</li></ol><blockquote class="kw"><p id="c53a" class="kx ky hi bd kz la lb lc ld le lf jc dx translated">现在，这里没有给出直接的答案<em class="lg">(没有一个神话是真的😉)</em>让我们借助真实世界的用例来缓解这些误解。</p></blockquote><p id="a513" class="pw-post-body-paragraph if ig hi ih b ii lh ik il im li io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi lm translated"><span class="l ln lo lp bm lq lr ls lt lu di"> U </span> <strong class="ih hj"> se-Case: </strong>假设一个组织托管在Google云平台上，同时利用CloudSQL MySQL&amp;CloudSQL Postgres引擎，该引擎附加到他们的项目A。现在，托管在项目B中的其他业务部门的应用程序及其自己的VPC想要连接到项目A的CloudSQL实例，因此，项目B VPC与项目A VPC对等。此外，组织需要低代码数据分析平台，他们决定使用Google Cloud DataFusion来实现这一点。</p><figure class="lw lx ly lz fd ma er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es lv"><img src="../Images/bc25315a73d71a385f2c7814d5c2b099.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EA8C0FrMRpXHzRfKBEDV8A.png"/></div></div></figure><p id="76c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据设计，Google CloudSQL托管在一个内部项目中，该项目通过私有服务连接到Project-A，同样，DataFusion也托管在一个单独的项目上，该项目需要作为设置的一部分与Project-A进行对等。现在，由于VPC网络对等不可传递，Project-B实例无法与CloudSQL实例通信，DataFusion实例也无法直接与CloudSQL实例通信。</p><p id="ec3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是CloudSQL Auth Proxy的用武之地，为了消除上述误解，下图显示了部署的最佳实践。</p><figure class="lw lx ly lz fd ma er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es mh"><img src="../Images/3a387d8618c09bde661eb2cd8c4d9d0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_VjIX8cx04FAOfBzsLj9bA.png"/></div></div></figure><p id="0a81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用户可以将CloudSQL Auth Proxy配置为CloudRUN服务或托管实例组中的系统服务，托管实例组位于内部负载平衡器之后，并连接到多个CloudSQL实例。下面是实现这一目标的高级步骤:</p><ul class=""><li id="2baa" class="kg kh hi ih b ii ij im in iq mi iu mj iy mk jc ml ko kp kq bi translated">供应一个微实例，安装CloudSQL代理，并将其配置为与多个CloudSQL实例连接。</li></ul><pre class="lw lx ly lz fd mm mn mo mp aw mq bi"><span id="1942" class="jl jm hi mn b fi mr ms l mt mu"><strong class="mn hj">root@cloudsql-proxy-inst:/etc/systemd/system# </strong>cat sql_proxy.service <br/>[Unit]<br/>Description=CloudSQL Proxy Service</span><span id="3ffa" class="jl jm hi mn b fi mv ms l mt mu">[Service]<br/>Type=simple<br/>User=ravishgarg<br/>Group=ravishgarg<br/>WorkingDirectory=/home/ravishgarg<br/>ExecStart=/home/ravishgarg/cloud_sql_proxy -instances=xxxxx:asia-southeast1:mysql-inst=tcp:0.0.0.0:3306,xxxxx:asia-southeast1:pgdb-inst=tcp:0.0.0.0:5432 -ip_address_types='PRIVATE' -use_http_health_check<br/>Restart=always</span><span id="ab84" class="jl jm hi mn b fi mv ms l mt mu">[Install]<br/>WantedBy=multi-user.target</span><span id="748c" class="jl jm hi mn b fi mv ms l mt mu"><strong class="mn hj">root@cloudsql-proxy-inst:/etc/systemd/system#</strong> systemctl daemon-reload<br/><strong class="mn hj">root@cloudsql-proxy-inst:/etc/systemd/system#</strong> systemctl enable sql_proxy.service<br/><strong class="mn hj">root@cloudsql-proxy-inst:/etc/systemd/system#</strong> systemctl start sql_proxy.service<br/><strong class="mn hj">root@cloudsql-proxy-inst:/etc/systemd/system#</strong> systemctl status sql_proxy.service<br/>● <em class="jd">sql_proxy.service - CloudSQL Proxy Service<br/>     Loaded: loaded (/etc/systemd/system/sql_proxy.service; enabled; vendor preset: enabled)<br/>     Active: active (running) since Sat 2022-01-29 09:48:37 UTC; 7s ago<br/>   Main PID: 12378 (cloud_sql_proxy)<br/>      Tasks: 7 (limit: 1159)<br/>     Memory: 13.9M<br/>     CGroup: /system.slice/sql_proxy.service<br/>             └─12378 /home/ravishgarg/cloud_sql_proxy -instances=xxxxx:asia-southeast1:mysql-inst=tcp:0.0.0.0:3306,xxxxx&gt;</em></span><span id="0642" class="jl jm hi mn b fi mv ms l mt mu"><em class="jd">Jan 29 09:48:37 cloudsql-proxy-inst systemd[1]: Started CloudSQL Proxy Service.<br/>Jan 29 09:48:37 cloudsql-proxy-inst cloud_sql_proxy[12378]: 2022/01/29 09:48:37 Rlimits for file descriptors set to {Curren&gt;<br/>Jan 29 09:48:40 cloudsql-proxy-inst cloud_sql_proxy[12378]: 2022/01/29 09:48:40 Listening on 0.0.0.0:3306 for raves-ce:asia&gt;<br/>Jan 29 09:48:40 cloudsql-proxy-inst cloud_sql_proxy[12378]: 2022/01/29 09:48:40 Listening on 0.0.0.0:5432 for raves-ce:asia&gt;<br/>Jan 29 09:48:40 cloudsql-proxy-inst cloud_sql_proxy[12378]: 2022/01/29 09:48:40 Ready for new connections<br/>Jan 29 09:48:40 cloudsql-proxy-inst cloud_sql_proxy[12378]: 2022/01/29 09:48:40 Generated RSA key in 250.630103ms</em></span></pre><p id="9b54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们来理解这个命令:</p><ul class=""><li id="565a" class="kg kh hi ih b ii ij im in iq mi iu mj iy mk jc ml ko kp kq bi translated"><strong class="ih hj"><em class="jd">-实例:</em> </strong>支持逗号分隔的实例列表，这些实例可以通过TCP端口或重命名默认的Unix域套接字来公开。</li><li id="09aa" class="kg kh hi ih b ii kr im ks iq kt iu ku iy kv jc ml ko kp kq bi translated"><strong class="ih hj"> <em class="jd"> -ip地址类型:</em> </strong>用于连接实例的首选ip类型的命令分隔。就像在我们的用例中，我们要求CloudSQL Auth Proxy仅使用私有IP连接到CloudSQL实例。</li><li id="5a15" class="kg kh hi ih b ii kr im ks iq kt iu ku iy kv jc ml ko kp kq bi translated"><strong class="ih hj"><em class="jd">-use _ http _ health _ check:</em></strong>除了探测CloudSQL代理监听的TCP端口，还可以为代理启用HTTP健康检查，包括启动、活动和就绪探测。默认健康检查端口为8090，但也可以使用<em class="jd">-健康检查端口</em>标志进行配置。</li><li id="3059" class="kg kh hi ih b ii kr im ks iq kt iu ku iy kv jc ml ko kp kq bi translated">根据需要为CloudSQL Auth Proxy实例的自动扩展和自动修复设置托管实例组。</li></ul><figure class="lw lx ly lz fd ma er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es mw"><img src="../Images/6dbed098a9de22399e1cb7402889faac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lD5gPvZARCGWe3LM0teb0Q.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated"><strong class="bd jn">谷歌云托管实例组</strong></figcaption></figure><ul class=""><li id="86de" class="kg kh hi ih b ii ij im in iq mi iu mj iy mk jc ml ko kp kq bi translated">设置一个内部负载平衡器，通过它，来自其他对等项目的应用程序可以连接到各自的CloudSQL实例。</li></ul><figure class="lw lx ly lz fd ma er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es nb"><img src="../Images/910e674fffa3d25c7c1170b64eb6fee5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aorSWG6ecMEuA5IlGFPrcw.png"/></div></div><figcaption class="mx my et er es mz na bd b be z dx translated"><strong class="bd jn">谷歌云内部负载均衡器</strong></figcaption></figure><p id="4031" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，这里我们有一个高度可用的云代理设置，通过私有IP地址连接到多个CloudSQL实例。</p><h2 id="0bcb" class="jl jm hi bd jn jo jp jq jr js jt ju jv iq jw jx jy iu jz ka kb iy kc kd ke kf bi translated">使用CloudSQL Auth代理的一些额外优势:</h2><ul class=""><li id="6a1f" class="kg kh hi ih b ii ki im kj iq kk iu kl iy km jc ml ko kp kq bi translated"><strong class="ih hj">安全连接:</strong>云SQL身份验证代理使用TLS和128位AES密码自动加密进出数据库的流量。SSL证书用于验证客户端和服务器的身份，并且独立于数据库协议；您不需要管理SSL证书。</li><li id="ad9e" class="kg kh hi ih b ii kr im ks iq kt iu ku iy kv jc ml ko kp kq bi translated"><strong class="ih hj">更简单的连接授权:</strong>云SQL授权代理使用IAM权限来控制谁和什么可以连接到您的云SQL实例。因此，云SQL身份验证代理使用云SQL处理身份验证，无需提供静态IP地址。</li><li id="f2c7" class="kg kh hi ih b ii kr im ks iq kt iu ku iy kv jc ml ko kp kq bi translated"><strong class="ih hj"> IAM数据库认证</strong>。或者，云SQL Auth代理支持OAuth 2.0访问令牌的自动刷新。有关此功能的信息，请参见<a class="ae je" href="https://cloud.google.com/sql/docs/mysql/authentication" rel="noopener ugc nofollow" target="_blank">云SQL IAM数据库认证</a>。</li></ul><h2 id="5c25" class="jl jm hi bd jn jo jp jq jr js jt ju jv iq jw jx jy iu jz ka kb iy kc kd ke kf bi translated">参考资料:</h2><div class="nc nd ez fb ne nf"><a href="https://cloud.google.com/sql/docs/mysql/sql-proxy" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab dw"><div class="nh ab ni cl cj nj"><h2 class="bd hj fi z dy nk ea eb nl ed ef hh bi translated">关于云SQL身份验证代理MySQL的云SQL | Google Cloud</h2><div class="nm l"><h3 class="bd b fi z dy nk ea eb nl ed ef dx translated">此页面提供了云SQL身份验证代理的基本介绍，并描述了代理选项。对于循序渐进的…</h3></div><div class="nn l"><p class="bd b fp z dy nk ea eb nl ed ef dx translated">cloud.google.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt mf nf"/></div></div></a></div><div class="nc nd ez fb ne nf"><a href="https://github.com/GoogleCloudPlatform/cloudsql-proxy" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab dw"><div class="nh ab ni cl cj nj"><h2 class="bd hj fi z dy nk ea eb nl ed ef hh bi translated">GitHub-Google Cloud platform/Cloud sql-proxy:云SQL代理客户端和Go库</h2><div class="nm l"><h3 class="bd b fi z dy nk ea eb nl ed ef dx translated">云SQL身份验证代理是一个二进制文件，在连接到云时提供基于IAM的授权和加密…</h3></div><div class="nn l"><p class="bd b fp z dy nk ea eb nl ed ef dx translated">github.com</p></div></div><div class="no l"><div class="nu l nq nr ns no nt mf nf"/></div></div></a></div></div></div>    
</body>
</html>