<html>
<head>
<title>How to make a self-destructing VM on Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Google云平台上制作一个自毁式VM</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-make-a-self-destructing-vm-on-google-cloud-platform-b99883745b62?source=collection_archive---------2-----------------------#2019-02-20">https://medium.com/google-cloud/how-to-make-a-self-destructing-vm-on-google-cloud-platform-b99883745b62?source=collection_archive---------2-----------------------#2019-02-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="f856" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">通过启动具有预设生命周期的计算实例来节省资金。</h2></div><blockquote class="ix iy iz"><p id="7b1d" class="ja jb jc jd b je jf ij jg jh ji im jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">更新2022-12-06:GCP增加了一个名为<a class="ae jx" href="https://cloud.google.com/compute/docs/instances/limit-vm-runtime" rel="noopener ugc nofollow" target="_blank">自动终止</a>的功能，让你的虚拟机自毁变得非常简单。试试看！</p></blockquote><p id="998c" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">云的一个优点是它非常容易启动新的虚拟机(VM)。另一件不太好的事情是，忘记那些你制造的机器也非常容易，你会发现自己在为那些你并不真正需要的东西买单。在这篇文章中，我将展示如何使用<a class="ae jx" href="https://cloud.google.com/compute/" rel="noopener ugc nofollow" target="_blank"> Google Compute Engine </a> (GCE)来创建虚拟机(在GCE中也称为“实例”)，这些虚拟机在指定的时间后会自行删除，因此您可以启动它们，然后忘记它们。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/9e21a0ef98706552e87bbe6875145ee9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cmfBgwed3-6FwXY3hDKwpg@2x.png"/></div></div></figure><h1 id="78cc" class="kn ko hi bd kp kq kr ks kt ku kv kw kx io ky ip kz ir la is lb iu lc iv ld le bi translated">它是如何工作的</h1><p id="7a2d" class="pw-post-body-paragraph ja jb hi jd b je lf ij jg jh lg im jj jy lh jm jn jz li jq jr ka lj ju jv jw hb bi translated">这项技术利用了GCE的<a class="ae jx" href="https://cloud.google.com/compute/docs/startupscript" rel="noopener ugc nofollow" target="_blank">启动脚本</a>特性:当创建一个实例时，我们在<code class="du lk ll lm ln b">metadata-from-file</code>参数中提供了一个<strong class="jd hj">启动脚本</strong>。一旦实例完成引导，它就执行脚本，开始倒计时删除。为了实现这一点，脚本使用linux <code class="du lk ll lm ln b">at</code>命令调度一个任务:在预定的时间，该任务将指示GCE API删除其主机实例。</p><p id="cf4c" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">为了增加灵活性，我们可以在实例创建时将自毁间隔作为变量传递。这允许不同的寿命用于不同的目的。我们将使用一个GCE <a class="ae jx" href="https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom" rel="noopener ugc nofollow" target="_blank">定制元数据</a>字段:当创建每个实例时，在该实例上设置一个名为<code class="du lk ll lm ln b">SELF_DESTRUCT_INTERVAL_MINUTES</code>的字段。在启动时，实例将向GCE元数据服务器请求指定的时间间隔，并相应地安排其自我销毁。</p><h1 id="5b9e" class="kn ko hi bd kp kq kr ks kt ku kv kw kx io ky ip kz ir la is lb iu lc iv ld le bi translated">尝试一下</h1><p id="b1c2" class="pw-post-body-paragraph ja jb hi jd b je lf ij jg jh lg im jj jy lh jm jn jz li jq jr ka lj ju jv jw hb bi translated">在<a class="ae jx" href="https://github.com/davidstanke/samples/tree/master/self-destructing-vm" rel="noopener ugc nofollow" target="_blank"> <strong class="jd hj">这个GitHub repo </strong> </a>中，你会发现<a class="ae jx" href="https://github.com/davidstanke/samples/blob/master/self-destructing-vm/self-destruct.sh" rel="noopener ugc nofollow" target="_blank">启动脚本</a>，以及一个创建自毁实例的示例<code class="du lk ll lm ln b">gcloud</code>命令。以下是该命令的一部分，有趣的部分以粗体显示:</p><pre class="kc kd ke kf fd lo ln lp lq aw lr bi"><span id="24c0" class="ls ko hi ln b fi lt lu l lv lw">gcloud compute instances create \<br/>  self-destructing-vm \<br/>  [...] \<br/><strong class="ln hj">  --metadata SELF_DESTRUCT_INTERVAL_MINUTES=2 \<br/>  --metadata-from-file startup-script=self-destruct.sh</strong></span></pre><p id="657c" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated">您可以根据需要修改实例名称和区域。这个命令已经在Ubuntu 16.04和18.04上测试过了，可能也适用于其他Linux发行版。(类似的技术很可能被用于自删除Windows实例。)</p><h1 id="f990" class="kn ko hi bd kp kq kr ks kt ku kv kw kx io ky ip kz ir la is lb iu lc iv ld le bi translated">但是我究竟为什么要这么做呢？！？</h1><p id="f451" class="pw-post-body-paragraph ja jb hi jd b je lf ij jg jh lg im jj jy lh jm jn jz li jq jr ka lj ju jv jw hb bi translated">因为好玩！比如吹泡泡，看泡泡爆掉。但同时:有时我们需要确保我们提供的资源将被取消，这样它们就不会永远闲置，浪费金钱。也许，对于持续集成:作为CI管道的一部分，我们可以创建一个一次性使用的环境，并针对它运行测试。如果管道失败(正如管道所做的那样)，我们知道环境将在合理的时间范围内被自动删除。</p><p id="ec43" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jy jl jm jn jz jp jq jr ka jt ju jv jw hb bi translated"><em class="jc">在即将发布的帖子中，我将描述这一点:使用自毁虚拟机作为专用、短暂测试环境的CI管道。请稍后再来查看！</em></p></div></div>    
</body>
</html>