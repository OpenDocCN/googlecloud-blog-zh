<html>
<head>
<title>Creating Dynamic Composer Airflow DAGs from JSON template</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从JSON模板创建Dynamic Composer Airflow DAGs</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/creating-dynamic-composer-airflow-dags-from-json-template-90714af3b180?source=collection_archive---------0-----------------------#2021-01-28">https://medium.com/google-cloud/creating-dynamic-composer-airflow-dags-from-json-template-90714af3b180?source=collection_archive---------0-----------------------#2021-01-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5656" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如何从JSON模板管理Google Cloud Composer中的动态Dag创建:声明方式。</p><p id="bdf5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作者:米歇尔·米康科 &amp; <a class="jd je ge" href="https://medium.com/u/b4f66ff14d72?source=post_page-----90714af3b180--------------------------------" rel="noopener" target="_blank">奥尔多·洛里亚</a>—2021年1月</p><h1 id="7e16" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">放弃</h1><p id="1e43" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">这是一个基于气流的Google Cloud Composer高级教程。如果您尚未使用Airflow和Google Cloud Composer，我们强烈建议您先学习基础知识:</p><ul class=""><li id="35e6" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated"><a class="ae kr" href="https://airflow.apache.org/docs/stable/tutorial.html" rel="noopener ugc nofollow" target="_blank">气流文件</a></li><li id="bab8" class="ki kj hi ih b ii ks im kt iq ku iu kv iy kw jc kn ko kp kq bi translated"><a class="ae kr" href="https://cloud.google.com/composer/docs" rel="noopener ugc nofollow" target="_blank"> Google Cloud Composer文档</a></li></ul><p id="dd1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">欢迎分享您的反馈。</p><h1 id="8442" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">使用的技术</h1><ul class=""><li id="f110" class="ki kj hi ih b ii kd im ke iq kx iu ky iy kz jc kn ko kp kq bi translated">谷歌云编辑器1 . 13 . 0-气流-1.10.12</li><li id="4e6a" class="ki kj hi ih b ii ks im kt iq ku iu kv iy kw jc kn ko kp kq bi translated">气流1.10.12操作员</li><li id="02a4" class="ki kj hi ih b ii ks im kt iq ku iu kv iy kw jc kn ko kp kq bi translated">Python 3</li><li id="38c1" class="ki kj hi ih b ii ks im kt iq ku iu kv iy kw jc kn ko kp kq bi translated">JSON</li></ul><h1 id="df32" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">描述问题</h1><p id="ba22" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">我们希望构建一个灵活的工具来管理cloud composer实例的dag创建，并且我们确定了一些所需的功能:</p><ul class=""><li id="cdbf" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated">向非pythonic用户提供创建和编辑复杂Dag方法</li><li id="b8d1" class="ki kj hi ih b ii ks im kt iq ku iu kv iy kw jc kn ko kp kq bi translated">减少在Composer中实现python dags所需的冗余代码</li><li id="3cfd" class="ki kj hi ih b ii ks im kt iq ku iu kv iy kw jc kn ko kp kq bi translated">管理不同的环境(开发-测试-生产)</li><li id="f3fa" class="ki kj hi ih b ii ks im kt iq ku iu kv iy kw jc kn ko kp kq bi translated">轻松管理任务的相关性</li></ul><h1 id="53c2" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">描述解决方案</h1><p id="21b9" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">我们将Dag和任务的定义从python脚本中分离出来，该脚本管理Dag和环境变量的创建，这些变量允许您定制一些任务的行为。</p><p id="c91d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样，我们就有了用JSON编写的解决方案的声明部分，更容易阅读和编辑由python脚本管理的非composer技术组件。事实上，JSON由两个主要部分组成:</p><ol class=""><li id="c004" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc la ko kp kq bi translated">一个环境定义，名称为项目gcp，相对桶名</li><li id="fba3" class="ki kj hi ih b ii ks im kt iq ku iu kv iy kw jc la ko kp kq bi translated">我们的dag的定义以及组成它的相关任务。</li></ol><p id="74a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们动态定义Dag的解决方案中，我们首先从JSON文件中读取信息。“read_properties”函数从JSON文件中读取所有Dag和任务定义以及Dag计算中使用的环境和项目变量。</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lb"><img src="../Images/e1d15cc15bc349880978b694eceb5da2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6SOof6jfq7Z50cjK"/></div></div></figure><p id="b096" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ln"> airflow_path </em>、<em class="ln"> dags_file_path </em>、<em class="ln"> dags_file_name </em>和<em class="ln"> env </em>是从composer中的<em class="ln">“环境变量”</em>中读取的变量</p><figure class="lc ld le lf fd lg er es paragraph-image"><div class="er es lo"><img src="../Images/8f19a16ad6b6d0667d8ccdbe4ed74861.png" data-original-src="https://miro.medium.com/v2/resize:fit:870/0*aM9Nx7NNZJ3aRCTR"/></div></figure><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lp"><img src="../Images/270b45459703f82376b88aa9c56b6eeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TUwyc_uNfYC1l6sx"/></div></div></figure><p id="dd6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">变量"<em class="ln"> env </em>"允许在我们需要的每个环境中部署源代码，而不需要在dags源代码中修改它。</p><p id="674e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后为JSON中的每个DAG创建一个airflow.models.DAG:</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lq"><img src="../Images/d922098e7c34590167f2895788ff7afe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YiD8UxL2TTc85cZn"/></div></div></figure><p id="7075" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里我们指定了<em class="ln"> dag_id </em>、<em class="ln"> default_args </em>、一个dag <em class="ln">描述</em>、<em class="ln"> maximum_active_run </em>和dag调度，我们还可以在Composer中触发dagbag中部署的另一个dag。</p><p id="6643" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个值都是从JSON dag部分提取的，所以如果需要修改一个参数，只需编辑JSON文件。</p><p id="e4c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本例中，我们还提供了在JSON或airflow变量中指定一些属性(如“schedule_interval”或“max-active-runs”)的机会，只需使用“schedule-”前缀和dag id作为变量的关键字。这样，您只需编辑"<em class="ln"> env" </em>变量，新值将在下次运行时使用，无需上传任何内容。</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lr"><img src="../Images/2e70dbd868d2b78c05d9d378cb38cd84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CyxlTy2dyQo4pmMH"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">JSON dag定义的示例</figcaption></figure><p id="54d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于每个dag，我们将创建JSON中“<em class="ln">任务</em>属性中列出的所有任务:</p><p id="712d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于任务对象中的<em class="ln">类型</em>属性，我们为每个气流操作符使用一个函数来将任务从JSON文件映射到我们的python脚本，您将需要在python脚本中映射您想要使用的每个操作符；可以在这里查阅airflow文档<a class="ae kr" href="https://airflow.readthedocs.io/en/1.10.12/integration.html#gcp-google-cloud-platform" rel="noopener ugc nofollow" target="_blank">https://air flow . readthe docs . io/en/1 . 10 . 12/integration . html # GCP-Google-cloud-platform</a>:</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lw"><img src="../Images/96d04e138063e945a74ce1a8886cea51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qX23Iu7Fh-CZcofQ"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">BigQueryOperator的函数定义示例</figcaption></figure><p id="db8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于每个任务，可以定义与dag中其他任务的依赖关系。这可以用JSON属性“<em class="ln"> dependencies </em>”(任务id列表)来定义:</p><figure class="lc ld le lf fd lg er es paragraph-image"><div class="er es lx"><img src="../Images/f29d57d17b0f1e6a69f3f4de29f302b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:820/0*3nhGOMPtYhyMQrrl"/></div></figure><h1 id="2a90" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">结论</h1><p id="de44" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">所描述的解决方案允许通过文件JSON的定义对Dag进行简单且可管理的配置。它允许dag触发功能，可以使用分支运算符定义任务和条件任务之间的依赖关系，还可以运行多个并行dag。</p><p id="23f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用这种声明性方法的最大好处是更灵活的可维护性，为了向现有dag添加任务或在composer实例中创建新Dag，您不必编辑python脚本，所有内容都是从JSON文件中读取和处理的，这大大减少了python脚本中代码的膨胀。</p><p id="de0e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这也意味着没有python技能的用户可以添加新的查询任务，或者只需编辑相关的JSON对象就可以更改任务链。</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es ly"><img src="../Images/6b83b782787964ae2a354c8ac43731db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bJ_xMMbxhS3LsHVY"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">使用自定义开发在python中声明Dag的示例(之前)—使用JSON声明实现的相同Dag。</figcaption></figure></div></div>    
</body>
</html>