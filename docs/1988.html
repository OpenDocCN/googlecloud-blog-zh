<html>
<head>
<title>GROMACS on Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云上的GROMACS</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/gromacs-on-google-cloud-ba0eca5f107c?source=collection_archive---------0-----------------------#2021-10-23">https://medium.com/google-cloud/gromacs-on-google-cloud-ba0eca5f107c?source=collection_archive---------0-----------------------#2021-10-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/55b14a69d92d4d818e0a35bd030af3a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aFfcm2wXSzXE-QDbXIRqvw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">格罗马科斯</figcaption></figure><h1 id="aa6a" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">语境</h1><p id="09a2" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">上次在Google Cloud上将AlphaFold作为一个容器运行时，我发表了一篇文章。<a class="ae kq" href="https://cloud.google.com/life-sciences" rel="noopener ugc nofollow" target="_blank">谷歌云生命科学</a>是一个高度灵活、廉价和快速的工具，用于处理大量数据和要求高的计算能力。</p><p id="f800" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">使用与上一篇文章相同的方法，这次我将向您展示如何在Google Cloud上运行<a class="ae kq" href="http://www.gromacs.org/" rel="noopener ugc nofollow" target="_blank"> GROMACS </a>。</p><p id="9613" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">GROMACS是<a class="ae kq" href="https://en.wikipedia.org/wiki/Molecular_dynamics" rel="noopener ugc nofollow" target="_blank">分子动力学</a> (MD)的开源软件。这是一个非常受欢迎的工具，可以模拟研究机构和药物发现中原子和分子的物理运动。</p><p id="32fe" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">运行GROMACS的配置丰富的服务器成本很高。如果您只创建一次GROMACS容器映像，那么您可以在需要时立即运行它，从而加快繁重的MD处理并减少浪费的成本。</p></div><div class="ab cl kw kx gp ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="hb hc hd he hf"><h1 id="5282" class="iu iv hi bd iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn lh jp jq jr bi translated">步伐</h1><p id="7248" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">有两个工作步骤:</p><ol class=""><li id="8431" class="li lj hi ju b jv kr jz ks kd lk kh ll kl lm kp ln lo lp lq bi translated">创建GROMACS容器映像</li><li id="97ce" class="li lj hi ju b jv lr jz ls kd lt kh lu kl lv kp ln lo lp lq bi translated">运行GROMACS</li></ol><p id="b581" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">让我们按顺序来看一下这些步骤。<br/>请注意，一些步骤已经被省略，因为我不打算将本文变成一个完整的程序性文档。</p></div><div class="ab cl kw kx gp ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="hb hc hd he hf"><h1 id="96c7" class="iu iv hi bd iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn lh jp jq jr bi translated">创建GROMACS容器映像</h1><h2 id="aaf8" class="lw iv hi bd iw lx ly lz ja ma mb mc je kd md me ji kh mf mg jm kl mh mi jq mj bi translated">启用API</h2><p id="eb90" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated"><a class="ae kq" href="https://cloud.google.com/endpoints/docs/openapi/enable-api" rel="noopener ugc nofollow" target="_blank">启用</a>以下API。</p><ul class=""><li id="e8f6" class="li lj hi ju b jv kr jz ks kd lk kh ll kl lm kp mk lo lp lq bi translated">基因组API</li><li id="8c0c" class="li lj hi ju b jv lr jz ls kd lt kh lu kl lv kp mk lo lp lq bi translated">谷歌云生命科学应用编程接口</li><li id="1c6f" class="li lj hi ju b jv lr jz ls kd lt kh lu kl lv kp mk lo lp lq bi translated">Google容器注册API</li><li id="831c" class="li lj hi ju b jv lr jz ls kd lt kh lu kl lv kp mk lo lp lq bi translated">计算引擎API</li></ul><p id="1c51" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">您需要有GROMACS配置文件，如TPR文件。这次你可以从<a class="ae kq" href="https://www.mpibpc.mpg.de/grubmueller/bench" rel="noopener ugc nofollow" target="_blank"> GROMACS基准测试网站</a>下载benchMEM.tpr。</p><h2 id="cd17" class="lw iv hi bd iw lx ly lz ja ma mb mc je kd md me ji kh mf mg jm kl mh mi jq mj bi translated">为临时工作创建一个虚拟机</h2><p id="f439" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated"><a class="ae kq" href="https://cloud.google.com/compute/docs/instances/create-start-instance" rel="noopener ugc nofollow" target="_blank">创建一个具有64GB内存的虚拟机</a>(E2-standard-16)。然后<a class="ae kq" href="https://cloud.google.com/compute/docs/instances/connecting-to-instance" rel="noopener ugc nofollow" target="_blank"> SSH登录到虚拟机</a>并安装docker。</p><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="80a6" class="lw iv hi mq b fi mu mv l mw mx">sudo apt-get update</span><span id="d2fa" class="lw iv hi mq b fi my mv l mw mx">sudo apt-get install \<br/>     apt-transport-https \<br/>     ca-certificates \<br/>     curl \<br/>     gnupg \<br/>     lsb-release</span><span id="4799" class="lw iv hi mq b fi my mv l mw mx">curl -fsSL <a class="ae kq" href="https://download.docker.com/linux/debian/gpg" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/debian/gpg</a> | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><span id="ec7a" class="lw iv hi mq b fi my mv l mw mx">echo \<br/>“deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] <a class="ae kq" href="https://download.docker.com/linux/debian" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/debian</a> \<br/>$(lsb_release -cs) stable” | sudo tee \<br/>/etc/apt/sources.list.d/docker.list &gt; /dev/null</span><span id="8cf6" class="lw iv hi mq b fi my mv l mw mx">sudo apt-get update</span><span id="6ddc" class="lw iv hi mq b fi my mv l mw mx">sudo apt-get install docker-ce docker-ce-cli containerd.io</span></pre><p id="80c3" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">使自己能够以非超级用户权限使用docker命令。</p><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="785f" class="lw iv hi mq b fi mu mv l mw mx">sudo gpasswd -a $(whoami) docker</span></pre><p id="b68b" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">然后，重新登录虚拟机。</p><h2 id="54de" class="lw iv hi bd iw lx ly lz ja ma mb mc je kd md me ji kh mf mg jm kl mh mi jq mj bi translated">创建Dockerfile文件</h2><p id="9c62" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">用以下内容创建一个“Dockerfile”。请注意<a class="ae kq" href="https://manual.gromacs.org/documentation/" rel="noopener ugc nofollow" target="_blank">截止到2021年10月20日，GROMACS </a>的最新版本是2021.3。</p><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="9ea6" class="lw iv hi mq b fi mu mv l mw mx">FROM ubuntu: 18.04<br/># Copy the contents of the current directory into the container.<br/>ADD ..<br/># Install Gromacs and its dependencies.<br/>RUN apt -y update \<br/>&amp;&amp; apt install -y wget g++ libxml2-dev openmpi-bin openmpi-doc libopenmpi-dev \<br/>&amp;&amp; wget https://cmake.org/files/v3.21/cmake-3.21.2-linux-x86_64.sh \<br/>&amp;&amp; sh cmake-3.21.2-linux-x86_64.sh --skip-license --prefix=/usr \<br/>&amp;&amp; wget ftp://ftp.gromacs.org/pub/gromacs/gromacs-2021.3.tar.gz \<br/>&amp;&amp; tar xvf gromacs-2021.3.tar.gz \<br/>&amp;&amp; rm gromacs-2021.3.tar.gz \<br/>&amp;&amp; mkdir gromacs-2021.3/build \<br/>&amp;&amp; cd gromacs-2021.3/build \<br/>&amp;&amp; cmake .. -DGMX_BUILD_OWN_FFTW=ON -DCMAKE_CXX_COMPILER=/usr/bin/g++ -DGMX_THREAD_MPI=on \<br/>&amp;&amp; make -j \<br/>&amp;&amp; make install</span></pre><h2 id="ba6f" class="lw iv hi bd iw lx ly lz ja ma mb mc je kd md me ji kh mf mg jm kl mh mi jq mj bi translated">构建容器映像</h2><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="2585" class="lw iv hi mq b fi mu mv l mw mx">docker build -t gromacs_2021.3 .</span></pre><p id="259d" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">确认已创建容器映像。</p><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="8696" class="lw iv hi mq b fi mu mv l mw mx">docker images</span><span id="f6c6" class="lw iv hi mq b fi my mv l mw mx">REPOSITORY TAG IMAGE ID CREATED SIZE<br/>gromacs_2021.3 latest 8a882c6ccdda 50 seconds ago 951MB<br/>ubuntu 18.04 39a8cfeef173 4 weeks ago 63.1MB</span></pre><p id="44f0" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">在本地运行docker容器，并验证GROMACS工作正常。<br/>要检查GROMACS版本，执行如下“gmx -version”命令。</p><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="d025" class="lw iv hi mq b fi mu mv l mw mx">docker run -it gromacs_2021.3 bash</span><span id="1ec5" class="lw iv hi mq b fi my mv l mw mx">root @ 1234567890:/# gromacs-2021.3/build/bin/gmx -version<br/> :-) GROMACS — gmx, 2021.3 (-:<br/> GROMACS is written by:<br/> Andrey Alekseenko Emile Apol Rossen Apostolov <br/> Paul Bauer <br/> Herman JC Berendsen Par Bjelkmar Christian Blau Viacheslav <br/> <br/> A. Lemkul Viveca Lindahl Magnus Lundborg Erik Marklund <br/> <br/> Erik Lindahl, and David van der Spoel<br/>Copyright © 1991–2000, University of Groningen, The Netherlands.<br/>Copyright © 2001–2 019, The GROMACS development team at<br/>Uppsala University, Stockholm University and<br/>the Royal Institute of Technology, Sweden.<br/>Check out http://www.gromacs.org for more information.<br/>GROMACS is free software; you can redistribute it and / or modify it<br/>under the terms of the GNU Lesser General Public License<br/>as published by the Free Software Foundation; either version 2.1<br/>of the License, or (at your option) any later version.<br/>GROMACS: gmx, version 2021.3</span></pre><h2 id="926e" class="lw iv hi bd iw lx ly lz ja ma mb mc je kd md me ji kh mf mg jm kl mh mi jq mj bi translated">标记容器图像并将其推送到容器注册表</h2><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="3a38" class="lw iv hi mq b fi mu mv l mw mx">docker tag gromacs_2021.3 gcr.io/&lt;PROJECT_ID&gt;/gromacs_2021.3:v1</span><span id="5b3b" class="lw iv hi mq b fi my mv l mw mx">gcloud docker --push gcr.io/&lt;PROJECT_ID&gt;/gromacs_2021.3:v1</span></pre><p id="dfa0" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">至此，不再需要该虚拟机，您可以将其删除。您可以在这里使用云壳。</p><h2 id="946f" class="lw iv hi bd iw lx ly lz ja ma mb mc je kd md me ji kh mf mg jm kl mh mi jq mj bi translated">安装dsub</h2><p id="e02f" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">如果你不熟悉dsub，请看这里的<a class="ae kq" href="https://github.com/DataBiosphere/dsub" rel="noopener ugc nofollow" target="_blank"/>。</p><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="f394" class="lw iv hi mq b fi mu mv l mw mx">pip install dsub</span></pre><h2 id="36b2" class="lw iv hi bd iw lx ly lz ja ma mb mc je kd md me ji kh mf mg jm kl mh mi jq mj bi translated">创建一个桶</h2><p id="7054" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">你可以创建一桶谷歌云存储(GCS)。GROMACS执行日志和输入/输出数据通过这个桶传递。</p><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="0df5" class="lw iv hi mq b fi mu mv l mw mx">gsutil mb gs://&lt;PROJECT_ID&gt;-gromacs</span></pre><h2 id="f58f" class="lw iv hi bd iw lx ly lz ja ma mb mc je kd md me ji kh mf mg jm kl mh mi jq mj bi translated">运行Hello world(可选)</h2><p id="f482" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">让我们输出“Hello World”来确认dsub命令有效。这是一个可选步骤。</p><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="ef0f" class="lw iv hi mq b fi mu mv l mw mx">dsub \<br/> --project &lt;PROJECT_ID&gt; \<br/> —-zones “us-central1-*” \<br/> --logging gs://&lt;PROJECT_ID&gt;-gromacs/logs \<br/> --command =’echo “Hello World” &gt; “${OUTPUT}”’\<br/> --output OUTPUT=gs://&lt;PROJECT_ID&gt;-gromacs/hello_world.txt \<br/> --subnetwork default \<br/> --wait</span></pre><p id="2a01" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">您可以确认“hello_world.txt”和logs文件夹是在bucket下创建的。</p><h1 id="e67e" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">运行GROMACS</h1><p id="7abb" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">您需要将“benchMEM.tpr”文件复制到您创建的GCS bucket下。你可以使用云控制台来<a class="ae kq" href="https://cloud.google.com/storage/docs/uploading-objects" rel="noopener ugc nofollow" target="_blank">上传</a>的tpr文件。<br/>现在您已经准备好运行GROMACS了。执行以下命令。从命令(- command选项)中可以看出，它运行cd和cp，后跟“gmx mdrun”。执行结果用tar命令存档。</p><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="852a" class="lw iv hi mq b fi mu mv l mw mx">dsub --project &lt;PROJECT_ID&gt; \<br/> --zones “us-central1-*” \<br/> --logging gs://&lt;PROJECT_ID&gt;-gromacs/logs \<br/> --image=gcr.io/&lt;PROJECT_ID&gt;/gromacs_2021.3:v1 \<br/> --command=’cd /; cp ${INPUT}/benchMEM.tpr; /gromacs-2021.3/build/bin/gmx mdrun -nsteps 50000 -deffnm /benchMEM; tar cvzf $OUTPUT benchMEM.*’ \<br/> --input INPUT=gs://&lt;PROJECRT_ID&gt;-gromacs/benchMEM.tpr \<br/> --output OUTPUT=gs://&lt;PROJECT_ID&gt;-gromacs/benchMEM.tar.gz \<br/> --subnetwork default \<br/> --preemptible \<br/> --min-cores=8</span></pre><p id="4fff" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">该命令立即完成，显示作业ID，作业在后台运行。这项工作大约需要15分钟才能完成。<br/>要检查作业状态，执行以下命令。</p><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="2c08" class="lw iv hi mq b fi mu mv l mw mx">dstat --provider google-v2 \<br/> --project &lt;PROJECT_ID&gt; \<br/> --jobs ‘&lt;JOB_ID&gt;’ \<br/> --status ‘*’ \<br/> --format json</span></pre><p id="7d9d" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">在此期间，作业的状态会发生如下变化。</p><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="3abe" class="lw iv hi mq b fi mu mv l mw mx">VM starting (awaiting worker checkin)<br/>   ↓<br/>Pulling ”gcr.io/google.com/cloudsdktool/cloud-sdk:294.0.0-slim”<br/>   ↓<br/>Started running ”user-command”<br/>   ↓<br/>Success</span></pre><p id="d1f6" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">在作业过程中会临时创建一个虚拟机，但在GROMACS过程完成后会自动删除。</p><figure class="ml mm mn mo fd ij er es paragraph-image"><div class="er es mz"><img src="../Images/9487cf5904e50d811ca8f6ad5dd5c411.png" data-original-src="https://miro.medium.com/v2/resize:fit:970/0*UPrslII_9WwM-3Gb"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">GCE虚拟机正在启动</figcaption></figure><p id="756a" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">作业完成后，将在bucket下创建以下文件。</p><figure class="ml mm mn mo fd ij er es paragraph-image"><div class="er es na"><img src="../Images/d67ccfa69190bc32a18a4d7f063b9ff3.png" data-original-src="https://miro.medium.com/v2/resize:fit:950/0*vrHGXPY977W94ZQF"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">谷歌云存储</figcaption></figure><p id="474e" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">您可以在日志文件夹下看到日志文件。</p><pre class="ml mm mn mo fd mp mq mr ms aw mt bi"><span id="5ee5" class="lw iv hi mq b fi mu mv l mw mx">gs://&lt;PROJECT_ID&gt;-gromacs/logs/&lt;JOB_ID&gt;-stderr.log<br/>gs://&lt;PROJECT_ID&gt;-gromacs/logs/&lt;JOB_ID&gt;-stdout.log<br/>gs://&lt;PROJECT_ID&gt;-gromacs/logs/&lt;JOB_ID&gt;.log</span></pre><p id="1338" class="pw-post-body-paragraph js jt hi ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp hb bi translated">如果您解压缩benchMEM.tar.gz，您会看到它包含以下文件。</p><figure class="ml mm mn mo fd ij er es paragraph-image"><div class="er es nb"><img src="../Images/4ec3589c878ec8bb117cbe0973eddfbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:894/0*J-zWxpaBMHYtcDXp"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">benchMEM.tar.gz的档案</figcaption></figure><h1 id="d3d5" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">结论</h1><p id="08c6" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">和之前的<a class="ae kq" rel="noopener" href="/google-cloud/running-alphafold-with-google-cloud-life-sciences-7219db6ca99e"> AlphaFold文章</a>一样，我使用dsub运行MD工具GROMACS。步骤和上次差不多，应该很容易进行。一旦创建了容器映像，您所要做的就是将数据放在GCS bucket下，并使用dsub运行<a class="ae kq" href="https://manual.gromacs.org/documentation/5.1/onlinehelp/gmx-mdrun.html" rel="noopener ugc nofollow" target="_blank"> gmx mdrun命令</a>。<br/>有了Google Cloud，你可以高速运行大量的生命科学数据和大量的计算，快速获得新的见解，请试一试。</p></div></div>    
</body>
</html>