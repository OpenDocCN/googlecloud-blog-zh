<html>
<head>
<title>Minimal Downtime Database Migration from MariaDB Galera Cluster to CloudSQL for MySQL at Production — An Implementation Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">生产时从MariaDB Galera集群到CloudSQL for MySQL的最短停机时间数据库迁移—实施指南</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/minimal-downtime-database-migration-from-mariadb-galera-cluster-to-cloudsql-for-mysql-at-production-8f4dd9966731?source=collection_archive---------0-----------------------#2022-07-09">https://medium.com/google-cloud/minimal-downtime-database-migration-from-mariadb-galera-cluster-to-cloudsql-for-mysql-at-production-8f4dd9966731?source=collection_archive---------0-----------------------#2022-07-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="ea9c" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">A.概观</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/1076633f7b5e190bffd2c4291af3e287.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6DM4c3fHmB37NURKPAAaew.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">用链式副本方法实现数据库迁移服务。</figcaption></figure><p id="5b51" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">以前，我写了一篇与这篇文章标题相似的文章，但是有更高层次的解释。现在，我想解释一下MySQL链副本的实现和配置。你可以看看下面这篇文章:</p><div class="kr ks ez fb kt ku"><a rel="noopener follow" target="_blank" href="/niceday-dev/minimal-downtime-database-migration-from-mariadb-galera-cluster-to-cloudsql-for-mysql-at-production-4eb472e6774a"><div class="kv ab dw"><div class="kw ab kx cl cj ky"><h2 class="bd hj fi z dy kz ea eb la ed ef hh bi translated">从MariaDB Galera集群到CloudSQL for MySQL的最短停机时间数据库迁移…</h2><div class="lb l"><h3 class="bd b fi z dy kz ea eb la ed ef dx translated">概观</h3></div><div class="lc l"><p class="bd b fp z dy kz ea eb la ed ef dx translated">medium.com</p></div></div><div class="ld l"><div class="le l lf lg lh ld li jn ku"/></div></div></a></div><p id="0ce6" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">当你读完那篇文章后，你可以回到这篇文章并进入下一节。希望你能从上一篇文章中了解上下文。</p><p id="b6ac" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">快乐阅读！</p><h1 id="37ba" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">B.配置链复制</h1><p id="2098" class="pw-post-body-paragraph jt ju hi jv b jw lj jy jz ka lk kc kd ke ll kg kh ki lm kk kl km ln ko kp kq hb bi translated">假设将用于主节点到链复制的MariaDB节点称为<strong class="jv hj"> mariadb-dqs2 </strong>，MySQL链副本虚拟机的名称为<strong class="jv hj"> mysql-chain-replica-1 </strong>。</p><p id="1932" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">让我们进入下一部分。</p><h2 id="587c" class="lo ig hi bd ih lp lq lr il ls lt lu ip ke lv lw it ki lx ly ix km lz ma jb mb bi translated">B.1 .将其中一个MariaDB节点配置为主节点</h2><p id="1230" class="pw-post-body-paragraph jt ju hi jv b jw lj jy jz ka lk kc kd ke ll kg kh ki lm kk kl km ln ko kp kq hb bi translated">将这几行添加到/etc/mysql/my.conf中，以在<strong class="jv hj"> mariadb-dqs2 </strong>中启用主配置。您可以使用文本编辑器，如VIM或Nano。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="d971" class="lo ig hi md b fi mh mi l mj mk"># master node configuration</span><span id="a3fe" class="lo ig hi md b fi ml mi l mj mk">server-id = 1<br/>log_bin = /var/log/mysql/mysql-bin.log<br/>binlog_do_db = ejabberd<br/>binlog_format = row<br/>bind-address = 10.0.3.47<br/>log_slave_updates=ON</span></pre><p id="a598" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">从控制台重启<strong class="jv hj"> mariadb-dqs2 </strong>内的mysql服务。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="71fa" class="lo ig hi md b fi mh mi l mj mk">$ sudo systemctl restart mysql</span></pre><p id="6b24" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">通过MySQL控制台在<strong class="jv hj"> mariadb-dqs2 </strong>中为复制创建新的MariaDB用户。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="9f2d" class="lo ig hi md b fi mh mi l mj mk">MariaDB [(none)]&gt; SET SESSION SQL_LOG_BIN=0;<br/>MariaDB [(none)]&gt; CREATE USER 'replica'@'%' IDENTIFIED BY '&lt;&lt; password placeholder &gt;&gt;';<br/>MariaDB [(none)]&gt; GRANT REPLICATION SLAVE ON *.* TO 'replica'@'%';<br/>MariaDB [(none)]&gt; GRANT EXECUTE ON *.* TO 'replica'@'%';<br/>MariaDB [(none)]&gt; GRANT SELECT ON *.* TO 'replica'@'%';<br/>MariaDB [(none)]&gt; GRANT SHOW VIEW ON *.* TO 'replica'@'%';<br/>MariaDB [(none)]&gt; GRANT REPLICATION CLIENT ON *.* TO 'replica'@'%';<br/>MariaDB [(none)]&gt; GRANT RELOAD ON *.* TO 'replica'@'%';<br/>MariaDB [(none)]&gt; SET SESSION SQL_LOG_BIN=1;<br/>MariaDB [(none)]&gt; SHOW GRANTS FOR replica@'%'\G;<br/>*************************** 1. row ***************************<br/>Grants for replica@%: GRANT SELECT, RELOAD, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, SHOW VIEW ON *.* TO 'replica'@'%' IDENTIFIED BY PASSWORD '&lt;&lt; password placeholder &gt;&gt;'<br/>1 row in set (0.00 sec)</span></pre><h2 id="02b2" class="lo ig hi bd ih lp lq lr il ls lt lu ip ke lv lw it ki lx ly ix km lz ma jb mb bi translated">B.2 .为从节点创建数据库备份</h2><p id="04e3" class="pw-post-body-paragraph jt ju hi jv b jw lj jy jz ka lk kc kd ke ll kg kh ki lm kk kl km ln ko kp kq hb bi translated">从Galera集群通过MySQL控制台进行Desync <strong class="jv hj"> mariadb-dqs2 </strong>。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="600a" class="lo ig hi md b fi mh mi l mj mk">MariaDB [(None)]&gt; SET GLOBAL wsrep_desync = ON;</span></pre><p id="f0d8" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">通过MySQL控制台检查是否为<strong class="jv hj"> mariadb-dqs2 </strong>启用了去同步。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="017f" class="lo ig hi md b fi mh mi l mj mk">MariaDB [(none)]&gt; SHOW GLOBAL VARIABLES LIKE '%desync%';<br/>+---------------+-------+<br/>| Variable_name | Value |<br/>+---------------+-------+<br/>| wsrep_desync  | ON    |<br/>+---------------+-------+<br/>1 row in set (0.00 sec)</span><span id="b1fc" class="lo ig hi md b fi ml mi l mj mk">MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE '%desync%';<br/>+--------------------+-------+<br/>| Variable_name      | Value |<br/>+--------------------+-------+<br/>| wsrep_desync_count | 1     |<br/>+--------------------+-------+<br/>1 row in set (0.01 sec)</span></pre><p id="4dc9" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">从控制台转储来自<strong class="jv hj"> mariadb-dqs2 </strong>的聊天数据库。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="737c" class="lo ig hi md b fi mh mi l mj mk">$ time mysqldump -h 10.0.3.47 -u ejabberd -p --master-data=2 --single-transaction --quick --opt ejabberd &gt; latest.sql</span></pre><p id="df35" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">请通过您的GCP管理员创建一个新的服务帐户。服务帐户应该对存储初始备份文件的存储桶具有读写权限。当我无法将备份文件从<strong class="jv hj"> mariadb-dqs2 </strong>虚拟机转移到<strong class="jv hj"> mysql-chain-replica-1 </strong>虚拟机时，我产生了这个想法。</p><blockquote class="mm mn mo"><p id="5ee2" class="jt ju mp jv b jw jx jy jz ka kb kc kd mq kf kg kh mr kj kk kl ms kn ko kp kq hb bi translated">如果当时能找到别的方式传输文件就更好了。但是由于时间有限，我无法有效地将文件发送到另一个虚拟机。也许通过允许防火墙使用<strong class="jv hj"> scp将文件传输到<strong class="jv hj"> mysql-chain-replica-1 </strong>。非常抱歉。</strong></p></blockquote><p id="af7f" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">从控制台将<strong class="jv hj"> mariadb-dqs2 </strong>中的备份文件临时上传到Google云存储中。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="9355" class="lo ig hi md b fi mh mi l mj mk">$ <a class="ae mt" href="mailto:GCP_ACCOUNT_NAME=cloudsql-migration@sense-health.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">GCP_ACCOUNT_NAME=cloudsql-migration@sense-health.iam.gserviceaccount.com</a><br/>$ GCP_KEY_FILE=/home/ridwan/cloudsql-migration.json<br/>$ GCP_PROJECT_ID=sense-health<br/>$ gcloud auth activate-service-account $GCP_ACCOUNT_NAME  --key-file=$GCP_KEY_FILE --project=$GCP_PROJECT_ID<br/>$ gsutil -m -o GSUtil:parallel_composite_upload_threshold=150M cp latest.sql "gs://bucket-production/mariadb-dqs2/"</span></pre><h2 id="72fb" class="lo ig hi bd ih lp lq lr il ls lt lu ip ke lv lw it ki lx ly ix km lz ma jb mb bi translated">B.3 .在从节点恢复数据库备份</h2><p id="5976" class="pw-post-body-paragraph jt ju hi jv b jw lj jy jz ka lk kc kd ke ll kg kh ki lm kk kl km ln ko kp kq hb bi translated">一旦备份文件上传完成，你可以从谷歌云存储下载最新的备份文件到<strong class="jv hj"> mysql-chain-replica-1。</strong></p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="71f7" class="lo ig hi md b fi mh mi l mj mk">$ <a class="ae mt" href="mailto:GCP_ACCOUNT_NAME=cloudsql-migration@sense-health.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">GCP_ACCOUNT_NAME=cloudsql-migration@sense-health.iam.gserviceaccount.com</a><br/>$ GCP_KEY_FILE=/home/ridwan/cloudsql-migration.json<br/>$ GCP_PROJECT_ID=sense-health<br/>$ gcloud auth activate-service-account $GCP_ACCOUNT_NAME  --key-file=$GCP_KEY_FILE --project=$GCP_PROJECT_ID<br/>$ gsutil cp gs://bucket-production/mariadb-dqs2/latest.sql .</span></pre><p id="1b68" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">将聊天数据库恢复到<strong class="jv hj"> mysql-chain-replica-1 </strong>。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="5861" class="lo ig hi md b fi mh mi l mj mk">$ time mysql -u ejabberd ejabberd -p &lt; latest.sql</span></pre><p id="07b1" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">数据库恢复任务需要一段时间才能完成。</p><h2 id="94a1" class="lo ig hi bd ih lp lq lr il ls lt lu ip ke lv lw it ki lx ly ix km lz ma jb mb bi translated">B.4 .配置从节点</h2><p id="8fc5" class="pw-post-body-paragraph jt ju hi jv b jw lj jy jz ka lk kc kd ke ll kg kh ki lm kk kl km ln ko kp kq hb bi translated">从下载到<strong class="jv hj"> mysql-chain-replica-1的最新备份文件中获取master_log_file和master_log_pos值。</strong></p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="7189" class="lo ig hi md b fi mh mi l mj mk">$ head -n 50 latest.sql | grep MASTER_LOG_FILE</span><span id="52ce" class="lo ig hi md b fi ml mi l mj mk">-- CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000001', MASTER_LOG_POS=4009680;</span></pre><p id="bd16" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">将这些配置添加到<strong class="jv hj"> mysql-chain-replica-1中的<strong class="jv hj">/etc/MySQL/MySQL . conf . d/mysqld . CNF</strong>。</strong></p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="52d7" class="lo ig hi md b fi mh mi l mj mk">server-id = 2<br/>log_bin = /var/log/mysql/mysql-bin.log<br/>binlog_do_db = ejabberd<br/>binlog_format = row<br/>bind-address = 10.0.3.49<br/>relay-log = /var/log/mysql/mysql-relay-bin.log<br/>log_slave_updates = ON<br/>sync_binlog = 1<br/>read_only = 1</span></pre><p id="d42e" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">该配置将使<strong class="jv hj"> mysql-chain-replica-1 </strong>作为<strong class="jv hj"> mariadb-dqs2 </strong>(来自Galera的主节点)的从节点，并在单个实例中作为GCP数据库迁移服务的源数据库(也是主节点)。这就是我们称之为链式复制的原因。</p><p id="d94b" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">现在，重启<strong class="jv hj"> mysql-chain-replica-1 </strong>中的mysql服务。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="36b6" class="lo ig hi md b fi mh mi l mj mk">$ sudo systemctl restart mysql</span></pre><p id="09e6" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">根据本节初始步骤中的先前输出设置MASTER_LOG_FILE和MASTER_LOG_POST的值。然后，通过mysql控制台启用<strong class="jv hj"> mysql-chain-replica-1 </strong>的从配置。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="f3ca" class="lo ig hi md b fi mh mi l mj mk">mysql&gt; SET SESSION SQL_LOG_BIN=0; STOP SLAVE;<br/>mysql&gt; CHANGE MASTER TO<br/>mysql&gt; MASTER_HOST='10.0.3.47',<br/>mysql&gt; MASTER_USER='replica',<br/>mysql&gt; MASTER_PASSWORD='&lt;&lt; password &gt;&gt;’',<br/>mysql&gt; MASTER_LOG_FILE='mysql-bin.000001',<br/>mysql&gt; MASTER_LOG_POS=4009680;<br/>mysql&gt; START SLAVE; SET SESSION SQL_LOG_BIN=1;</span></pre><p id="31fb" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">检查<strong class="jv hj"> mysql-chain-replica-1 </strong>的从状态。如果应用成功，您可能会看到如下输出:</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="dfb6" class="lo ig hi md b fi mh mi l mj mk">mysql&gt; SHOW SLAVE STATUS \G;<br/>*************************** 1. row ***************************<br/>               Slave_IO_State: Waiting for master to send event<br/>                  Master_Host: 10.0.3.47<br/>                  Master_User: replica<br/>                  Master_Port: 3306<br/>                Connect_Retry: 60<br/>              Master_Log_File: mysql-bin.000001<br/>....</span><span id="6128" class="lo ig hi md b fi ml mi l mj mk">Master_Server_Id: 1<br/>                  Master_UUID: <br/>             Master_Info_File: /var/lib/mysql/master.info<br/>                    SQL_Delay: 0<br/>          SQL_Remaining_Delay: NULL<br/>      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates<br/>           Master_Retry_Count: 86400<br/>                  Master_Bind: <br/>      Last_IO_Error_Timestamp: <br/>     Last_SQL_Error_Timestamp: <br/>               Master_SSL_Crl: <br/>           Master_SSL_Crlpath: <br/>           Retrieved_Gtid_Set: <br/>            Executed_Gtid_Set: <br/>                Auto_Position: 0<br/>         Replicate_Rewrite_DB: <br/>                 Channel_Name: <br/>           Master_TLS_Version: <br/>1 row in set (0.00 sec)</span></pre><p id="909c" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">通过MySQL控制台在<strong class="jv hj"> mariadb-dqs2 </strong>检查从机状态。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="7d3b" class="lo ig hi md b fi mh mi l mj mk">MariaDB [ejabberd]&gt; show master status;<br/>+------------------+----------+------------------+------------------+<br/>| File             | Position | Binlog_Do_DB     | Binlog_Ignore_DB |<br/>+------------------+----------+------------------+------------------+<br/>| mysql-bin.000001 |      4029680 | ejabberd |                  |<br/>+------------------+----------+------------------+------------------+<br/>1 row in set (0.00 sec)</span><span id="264a" class="lo ig hi md b fi ml mi l mj mk">MariaDB [(none)]&gt; show slave hosts;<br/>+-----------+------+------+-----------+<br/>| Server_id | Host | Port | Master_id |<br/>+-----------+------+------+-----------+<br/>|         2 |      | 3306 |         1 |<br/>+-----------+------+------+-----------+<br/>1 row in set (0.00 sec)</span></pre><p id="2276" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">通过MySQL控制台禁用<strong class="jv hj"> mariadb-dqs2 </strong>的desync，因为我们已经完成了从配置，让<strong class="jv hj"> mariadb-dqs2 </strong>再次与其他Galera节点同步。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="23e5" class="lo ig hi md b fi mh mi l mj mk">MariaDB [(none)]&gt; SET GLOBAL wsrep_desync = OFF;</span></pre><p id="e2e3" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">使用mysql控制台检查<strong class="jv hj"> mariadb-dqs2 </strong>和<strong class="jv hj"> mysql-chain-replica-1 </strong>之间的聊天数据集行数，以确保复制是否如我们预期的那样应用:</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="faa8" class="lo ig hi md b fi mh mi l mj mk">mysql&gt; select count(*) from archive;<br/>+----------+<br/>| count(*) |<br/>+----------+<br/>| 48052497 |<br/>+----------+<br/>1 row in set (9.24 sec)</span><span id="cee0" class="lo ig hi md b fi ml mi l mj mk">__________________________________________________________________</span><span id="48f7" class="lo ig hi md b fi ml mi l mj mk">MariaDB [ejabberd]&gt; select count(*) from archive;<br/>+----------+<br/>| count(*) |<br/>+----------+<br/>| 48052497 |<br/>+----------+<br/>1 row in set (9.34 sec)</span></pre><p id="2863" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">恭喜你！我们已经完成了配置MariaDB节点和MySQL节点之间的链复制。让我们转到下一部分。</p><h2 id="2456" class="lo ig hi bd ih lp lq lr il ls lt lu ip ke lv lw it ki lx ly ix km lz ma jb mb bi translated">B.5 .将从节点配置为GCP数据库迁移服务的源</h2><p id="002e" class="pw-post-body-paragraph jt ju hi jv b jw lj jy jz ka lk kc kd ke ll kg kh ki lm kk kl km ln ko kp kq hb bi translated">检查<strong class="jv hj"> mysql-chain-replica-1 </strong>是否充当主节点。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="ef20" class="lo ig hi md b fi mh mi l mj mk">mysql&gt; show master status;<br/>+------------------+----------+------------------+------------------+-------------------+<br/>| File             | Position | Binlog_Do_DB     | Binlog_Ignore_DB | Executed_Gtid_Set |<br/>+------------------+----------+------------------+------------------+-------------------+<br/>| mysql-bin.000014 |      154 | ejabberd |                  |                   |<br/>+------------------+----------+------------------+------------------+-------------------+<br/>1 row in set (0.00 sec)</span></pre><p id="4c97" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">从<strong class="jv hj"> mysql-chain-replica-1 </strong>为GCP DMS创建replica_chain用户。</p><pre class="je jf jg jh fd mc md me mf aw mg bi"><span id="113b" class="lo ig hi md b fi mh mi l mj mk">mysql&gt; SET SESSION SQL_LOG_BIN=0;<br/>mysql&gt; CREATE USER 'replica_chain'@'%' IDENTIFIED BY ‘&lt;&lt; password &gt;&gt;’';<br/>mysql&gt; GRANT REPLICATION SLAVE ON *.* TO 'replica_chain'@'%';<br/>mysql&gt; GRANT EXECUTE ON *.* TO 'replica_chain'@'%';<br/>mysql&gt; GRANT SELECT ON *.* TO 'replica_chain'@'%';<br/>mysql&gt; GRANT SHOW VIEW ON *.* TO 'replica_chain'@'%';<br/>mysql&gt; GRANT REPLICATION CLIENT ON *.* TO 'replica_chain'@'%';<br/>mysql&gt; GRANT RELOAD ON *.* TO 'replica_chain'@'%';<br/>mysql&gt; SET SESSION SQL_LOG_BIN=1;</span></pre><p id="2acf" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我们差不多完成了。让我们转到“配置GCP数据库迁移服务”部分。</p><h1 id="8e72" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">C.配置GCP数据库迁移服务</h1><h2 id="c2ef" class="lo ig hi bd ih lp lq lr il ls lt lu ip ke lv lw it ki lx ly ix km lz ma jb mb bi translated">C.1 .创建数据库迁移服务</h2><p id="db89" class="pw-post-body-paragraph jt ju hi jv b jw lj jy jz ka lk kc kd ke ll kg kh ki lm kk kl km ln ko kp kq hb bi translated">创建新的数据库迁移服务。只需按照一些表单来创建服务。在<strong class="jv hj">入门</strong>表单中，您需要填写关于迁移作业的信息。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mu"><img src="../Images/8518b0cc7dab2cfa60a06ce77b97f08a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WEiRrN9tDhitBHNUUu8gSQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">在数据库迁移服务中创建迁移作业表单</figcaption></figure><p id="034b" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在<strong class="jv hj">定义源</strong>表单中，您必须指定源数据库信息，包括IP地址、数据库名称、复制用户等等。定义源时使用replica_chain用户。</p><p id="a94e" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在<strong class="jv hj">创建目的地</strong>表单中，您必须从机器类型、定位目的地数据库的网络中指定目的地数据库规格。为迁移服务的目的地创建<strong class="jv hj"> mysql-production </strong></p><p id="817c" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在<strong class="jv hj">定义连接方法</strong>表单下，您必须通过“生产”网络下的VPC对等连接我们拥有的CloudSQL副本节点<strong class="jv hj"> mysql-production </strong>和源数据库<strong class="jv hj"> mysql-chain-replica-1 </strong>。</p><p id="c88f" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在<strong class="jv hj">测试和创建迁移作业</strong>表单下，将立即创建CloudSQL，我们仍然可以配置数据库迁移服务。测试源和目标之间的连接。您可以测试和创建迁移作业。</p><p id="74bc" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">有时，您可能会面临由防火墙规则引起网络问题。即使数据库迁移服务能够创建副本节点。您仍然需要允许CloudSQL副本节点的IP地址访问源数据库。然后，在完成数据库迁移服务作业之前，再次测试连接。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mv"><img src="../Images/64c22025cc838efbb0a5252ad884c73f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*kVR3tQ3CCTVedU0I86jLlQ.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">允许从数据库迁移服务创建的CloudSQL副本节点到源数据库的网络访问的防火墙规则</figcaption></figure><p id="3519" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">创建作业后，您可以检查连接配置文件是否正确。您可以编辑或删除创建数据库迁移服务时指定的连接配置文件。在测试CloudSQL副本节点(目标)和源数据库之间的连接时，也可能会由于不正确的连接配置文件而出现错误。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mw"><img src="../Images/5c47c480334c93e7131b7956f40c7a46.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*FHPgSBTPCWwsbxkrHsqD6g.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">数据库迁移服务创建的连接配置文件示例</figcaption></figure><h2 id="041a" class="lo ig hi bd ih lp lq lr il ls lt lu ip ke lv lw it ki lx ly ix km lz ma jb mb bi translated">C.2 .运行数据库迁移服务</h2><p id="dab8" class="pw-post-body-paragraph jt ju hi jv b jw lj jy jz ka lk kc kd ke ll kg kh ki lm kk kl km ln ko kp kq hb bi translated">一旦数据库迁移服务成功连接源和目标。数据库迁移服务将执行完全转储数据库操作。这可能需要一段时间，取决于数据库的大小。由于数据库大小为50 GB，完整的转储任务需要大约1个半小时。</p><p id="06ba" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">但这并没有因为停机而影响生产服务。它运行起来没有任何问题。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mx"><img src="../Images/86e6246c53d0a3d403db5018a11663c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*em5U7pgooMuUFofor1jyDQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">从MySQL链副本节点到CloudSQL MySQL副本节点的完整转储数据库正在进行中</figcaption></figure><p id="6dd5" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">完整转储操作完成后，数据库迁移服务会将操作状态转换为CDC，使源数据库与CloudSQL副本同步，只要我们没有将CloudSQL副本提升为主节点。</p><p id="7bef" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">发送到MariaDB集群的每个新聊天消息都将被同步到CloudSQL副本节点。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es my"><img src="../Images/cc1514d08a69798de6f2beada2716a18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hqIaQx_IMgEkghFvh7VyNw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">CDC正在运行从MySQL链副本到CloudSQL MySQL副本节点的数据库迁移服务</figcaption></figure><h1 id="2041" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">D.转换</h1><h2 id="03bf" class="lo ig hi bd ih lp lq lr il ls lt lu ip ke lv lw it ki lx ly ix km lz ma jb mb bi translated">D.1 .逐步切换</h2><p id="e4d7" class="pw-post-body-paragraph jt ju hi jv b jw lj jy jz ka lk kc kd ke ll kg kh ki lm kk kl km ln ko kp kq hb bi translated">要进一步了解这一部分，您可以阅读我以前的一篇文章，该文章概述了最小停机时间数据库迁移，并附有插图gudie:</p><div class="kr ks ez fb kt ku"><a rel="noopener follow" target="_blank" href="/niceday-dev/minimal-downtime-database-migration-from-mariadb-galera-cluster-to-cloudsql-for-mysql-at-production-4eb472e6774a"><div class="kv ab dw"><div class="kw ab kx cl cj ky"><h2 class="bd hj fi z dy kz ea eb la ed ef hh bi translated">从MariaDB Galera集群到CloudSQL for MySQL的最短停机时间数据库迁移…</h2><div class="lb l"><h3 class="bd b fi z dy kz ea eb la ed ef dx translated">概观</h3></div><div class="lc l"><p class="bd b fp z dy kz ea eb la ed ef dx translated">medium.com</p></div></div><div class="ld l"><div class="le l lf lg lh ld li jn ku"/></div></div></a></div><p id="5605" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">读完那篇文章后，你可以继续阅读下一节。</p><h2 id="b693" class="lo ig hi bd ih lp lq lr il ls lt lu ip ke lv lw it ki lx ly ix km lz ma jb mb bi translated">D.2 .负载测试结果</h2><p id="f158" class="pw-post-body-paragraph jt ju hi jv b jw lj jy jz ka lk kc kd ke ll kg kh ki lm kk kl km ln ko kp kq hb bi translated">切换后，我们的后端和生产环境中的聊天服务指向CloudSQL MySQL中的新聊天数据库。在切换之前，我们对后端和聊天服务进行了负载测试。结果如下:</p><ul class=""><li id="76a9" class="mz na hi jv b jw jx ka kb ke nb ki nc km nd kq ne nf ng nh bi translated"><strong class="jv hj">时间</strong>:2022年6月12日星期日08:09 GMT+7</li><li id="f1d9" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">活跃用户</strong> : 100</li><li id="144c" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">总请求数</strong> : 31773次请求</li><li id="f21b" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">速率</strong> : 56.41个请求/秒</li><li id="32a0" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">总错误数</strong> : 1515个请求(预期，负载测试脚本中有错误)</li><li id="f44d" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">错误率</strong> : 0.05个请求/秒</li><li id="f0d5" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">最小持续时间</strong> : 0.79毫秒</li><li id="08ca" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">最大持续时间</strong> : 3084.96毫秒</li><li id="d238" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">平均持续时间</strong> : 29.89毫秒</li><li id="55d2" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">中值</strong> <strong class="jv hj">持续时间</strong> : 6.04毫秒</li><li id="86ac" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">第90百分位持续时间</strong> : 91.93毫秒</li><li id="28b7" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">第95百分位持续时间 : 155.03毫秒</li></ul><p id="96e6" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">切换后，我们还进行了负载测试，结果如下:</p><ul class=""><li id="210c" class="mz na hi jv b jw jx ka kb ke nb ki nc km nd kq ne nf ng nh bi translated">时间:2022年6月12日星期日10:39 GMT+7</li><li id="65e5" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">活跃用户数 : 100</li><li id="cc5c" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">T30请求总数:31773个请求</li><li id="89f5" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">速率</strong> : 55.62请求/秒</li><li id="0ba2" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">总错误数</strong> : 1494个请求(预期，负载测试脚本中有错误)</li><li id="8d2c" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">错误率</strong> : 0.05请求/秒</li><li id="9798" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">最小持续时间</strong> : 0.71毫秒</li><li id="920e" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">最大持续时间</strong> : 535.71毫秒</li><li id="69ae" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">平均持续时间</strong> : 47.27毫秒</li><li id="8e75" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">中值</strong> <strong class="jv hj">持续时间</strong> : 5.95毫秒</li><li id="b096" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj">第90百分位持续时间</strong> : 161.32毫秒</li><li id="4c0a" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">第95百分位持续时间 : 182.59毫秒</li></ul><p id="a6f3" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">从上面的结果，我们可以得出结论，我们没有异常切换后。我们可以认为迁移是安全的，不会导致我们的后端和聊天服务停机或失败。</p><p id="a6b8" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">自6月12日我们进行转换以来，我们还每天早上进行连续测试。我们看到根本没有异常现象。</p><h2 id="6f73" class="lo ig hi bd ih lp lq lr il ls lt lu ip ke lv lw it ki lx ly ix km lz ma jb mb bi translated">d . 3 . QA团队的烟雾测试结果</h2><p id="b0d2" class="pw-post-body-paragraph jt ju hi jv b jw lj jy jz ka lk kc kd ke ll kg kh ki lm kk kl km ln ko kp kq hb bi translated">在2022年6月13日的下一个星期一，我们得到了QA团队的大量帮助。无论是手动测试还是自动化测试。我们从Khalid (QA自动化工程师)那里得到报告，使用他们的自动化测试套件解决方案测试门户网站和移动应用程序。以下是报告:</p><ul class=""><li id="c516" class="mz na hi jv b jw jx ka kb ke nb ki nc km nd kq ne nf ng nh bi translated"><strong class="jv hj">环境</strong>:生产</li><li id="a002" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj"> iOS测试案例</strong> : 100%通过</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nn"><img src="../Images/bb3029ef9b8c49a6bc9ab720f0405475.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oBE15PdkeSMbygYdVB4asw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">在Khalid的监督下，我们在iOS平台上的移动应用获得了自动烟雾测试结果</figcaption></figure><ul class=""><li id="f73e" class="mz na hi jv b jw jx ka kb ke nb ki nc km nd kq ne nf ng nh bi translated"><strong class="jv hj">安卓测试案例</strong> : 100%通过</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es no"><img src="../Images/e061806a3fac9092f05e923ab84b1192.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JgifutMDat5sqeaDdlgjiQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">在Khalid的监督下，我们在Android上的移动应用程序的自动烟雾测试结果</figcaption></figure><ul class=""><li id="fd92" class="mz na hi jv b jw jx ka kb ke nb ki nc km nd kq ne nf ng nh bi translated">火狐浏览器测试案例 : 100%通过</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es np"><img src="../Images/cc4d55833b0aca36c89ce92400b81b7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QDhHZZ2bbhqa2wCpjo3YWA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">由Khalid监督的Firefox门户网站的自动烟雾测试结果</figcaption></figure><ul class=""><li id="da71" class="mz na hi jv b jw jx ka kb ke nb ki nc km nd kq ne nf ng nh bi translated"><strong class="jv hj"> Chrome(网页浏览器)测试案例:</strong> 100%通过</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nq"><img src="../Images/1cea0ec16378339f866d52d220a90b6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PLoGQrPt7SOYtwvph96ICw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">由Khalid监督的Chrome门户网站的自动烟雾测试结果</figcaption></figure><p id="f0c7" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">Kiky和Harry还按照他们的手动测试程序在门户网站和移动应用程序上进行冒烟测试后向我们报告:</p><ul class=""><li id="bdab" class="mz na hi jv b jw jx ka kb ke nb ki nc km nd kq ne nf ng nh bi translated"><strong class="jv hj">环境</strong>:生产</li><li id="d49e" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><strong class="jv hj"> iOS测试案例</strong> : 100%通过</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nn"><img src="../Images/7af155e5610653518f8e420a1c59d87d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dhvy2T5B5E2OEyukuN2SCA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Harry在iOS平台上对我们的移动应用进行手动烟雾测试的结果</figcaption></figure><ul class=""><li id="3443" class="mz na hi jv b jw jx ka kb ke nb ki nc km nd kq ne nf ng nh bi translated"><strong class="jv hj"> Chrome(网页浏览器)测试案例</strong> : 100%通过</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nr"><img src="../Images/b46feb94a9a0fdec1b93eb7630eaf98f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yd3i4hD-V_eWnZfJ_YKf7A.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Kiky对我们的Chrome门户网站进行的手动冒烟测试结果</figcaption></figure><h1 id="7e31" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">E.迁移结果</h1><p id="699b" class="pw-post-body-paragraph jt ju hi jv b jw lj jy jz ka lk kc kd ke ll kg kh ki lm kk kl km ln ko kp kq hb bi translated">在2022年6月12日，我们通过将CloudSQL副本提升为主节点来执行切换。升级后，数据库迁移服务状态变为“完成”。然后，升级、重启、停止和恢复按钮在升级操作后变为禁用状态。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ns"><img src="../Images/fb5f4d1eb5743b540cc9cf4b33d445fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c9AkFD7TXSr3qcasUcAx7Q.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">迁移完成时数据库迁移服务的状态</figcaption></figure><p id="2f20" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">这是将副本节点提升为主节点的最终结果。主节点具有:</p><ul class=""><li id="ca97" class="mz na hi jv b jw jx ka kb ke nb ki nc km nd kq ne nf ng nh bi translated">MySQL v5.7.x</li><li id="de77" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">自动调整磁盘大小已启用</li><li id="e69f" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">自动备份已启用</li><li id="5ffa" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">PITR已启用</li><li id="d98d" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">区域高可用性已启用。备用节点位于不同的区域。主节点的区域是欧洲-西方4-c</li><li id="a7ab" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">添加了一些数据库标志，用于优化80%缓存数据集的RAM使用(<strong class="jv hj"> innodb_log_buffer_size </strong>、<strong class="jv hj"> innodb_buffer_pool_size </strong>、<strong class="jv hj"> innodb_log_file_size </strong>、<strong class="jv hj">innodb _ write _ io _ threads</strong>)</li><li id="7a72" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">CPU (8核)、RAM (32 GB)和SSD存储(100 GB作为初始容量)的指定类似于MariaDB节点规格</li></ul><p id="b8d2" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">主节点也有它的副本节点。以下是副本节点的规范:</p><ul class=""><li id="5e4f" class="mz na hi jv b jw jx ka kb ke nb ki nc km nd kq ne nf ng nh bi translated">MySQL v5.7.x</li><li id="1179" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">自动调整磁盘大小已启用</li><li id="7de8" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">自动备份已启用</li><li id="39b4" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">PITR已启用</li><li id="4790" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">区域高可用性已启用</li><li id="6d49" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">添加了一些数据库标志，用于优化80%缓存数据集的RAM使用(<strong class="jv hj"> innodb_log_buffer_size </strong>、<strong class="jv hj">innodb _ buffer _ pool _ size</strong>、<strong class="jv hj"> innodb_log_file_size </strong>、<strong class="jv hj">innodb _ write _ io _ threads</strong>)</li><li id="eb37" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated">CPU (8核)、RAM (32 GB)和SSD存储(100 GB作为初始容量)的指定类似于MariaDB节点规格</li></ul><h1 id="1b11" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">F.结论</h1><p id="5fed" class="pw-post-body-paragraph jt ju hi jv b jw lj jy jz ka lk kc kd ke ll kg kh ki lm kk kl km ln ko kp kq hb bi translated">通过在MariaDB节点和MySQL节点之间使用MySQL标准复制，我们可以使用数据库迁移服务来执行从MariaDB Galera集群到CloudSQL for MySQL的零停机数据库迁移。</p><p id="3b76" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">从<strong class="jv hj"> mysql-chain-replica-1 </strong>到CloudSQL副本节点的数据库迁移耗时0分钟或零停机时间。但是切换持续时间大约需要12分钟，因为我们需要重新配置后端配置，启用HA需要停机时间。但是我们在SLA时间之外(周末、周六早上)执行了这个切换。</p><p id="f8c3" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">这真让我高兴。感谢基础设施团队！</p><h1 id="9168" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">参考</h1><ul class=""><li id="fd46" class="mz na hi jv b jw lj ka lk ke nt ki nu km nv kq ne nf ng nh bi translated"><a class="ae mt" href="https://ridwanfajar.medium.com/minimal-downtime-database-migration-from-mariadb-galera-cluster-to-cloudsql-for-mysql-at-production-4eb472e6774a" rel="noopener">在生产时将数据库从MariaDB Galera集群迁移到CloudSQL for MySQL的最短停机时间——谷歌云数据库迁移服务概述</a></li><li id="7b00" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><a class="ae mt" href="https://cloud.google.com/database-migration/docs/mysql/quickstart" rel="noopener ugc nofollow" target="_blank"> GCP数据库迁移服务快速入门</a></li><li id="ac19" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><a class="ae mt" href="https://mariadb.com/kb/en/using-mariadb-replication-with-mariadb-galera-cluster-using-mariadb-replica/#configuring-a-cluster-node-as-a-replication-master" rel="noopener ugc nofollow" target="_blank">通过MariaDB Galera集群使用MariaDB复制</a></li><li id="a284" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><a class="ae mt" href="https://hpmtechinc.com/daisy-chain-mysql-replication/" rel="noopener ugc nofollow" target="_blank">设置MySQL 5.1到5.7到8.0菊花链复制的7个步骤</a></li><li id="e130" class="mz na hi jv b jw ni ka nj ke nk ki nl km nm kq ne nf ng nh bi translated"><a class="ae mt" href="https://serverfault.com/questions/332339/way-to-avoid-server-downtime-when-creating-master-slave-relationship/332354#332354" rel="noopener ugc nofollow" target="_blank">如何从MySQL主节点获取最后一个日志位置</a></li></ul></div><div class="ab cl nw nx gp ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="hb hc hd he hf"><blockquote class="mm mn mo"><p id="f50d" class="jt ju mp jv b jw jx jy jz ka kb kc kd mq kf kg kh mr kj kk kl ms kn ko kp kq hb bi translated">特别感谢基础架构团队的Ricky(团队负责人)和William，他们在讨论中为我提供了很多帮助，使这次迁移成为可能。他们也在周末的转换期间帮助我。他们真的是好人。</p><p id="cb6c" class="jt ju mp jv b jw jx jy jz ka kb kc kd mq kf kg kh mr kj kk kl ms kn ko kp kq hb bi translated">还要感谢NiceDay的利益相关方，如Umar(首席技术官)、Merel(产品负责人)、Alison(产品支持团队)、Jorge(数据工程师领导)、Pambo(后端工程师领导)、Syahmia(质量保证领导)、Kiky(质量保证)、Harry(质量保证实习)和Khalid(质量保证自动化工程师)，他们参与了此次迁移，在迁移期间进行了协调，并将迁移风险降至最低。太棒了！</p></blockquote></div></div>    
</body>
</html>