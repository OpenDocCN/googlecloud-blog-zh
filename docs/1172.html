<html>
<head>
<title>Secure Cloud Run, Cloud Functions and App Engine with API Keys and Cloud Endpoint</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用API密钥和云端点保护云运行、云功能和应用引擎</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/secure-cloud-run-cloud-functions-and-app-engine-with-api-key-73c57bededd1?source=collection_archive---------0-----------------------#2019-10-21">https://medium.com/google-cloud/secure-cloud-run-cloud-functions-and-app-engine-with-api-key-73c57bededd1?source=collection_archive---------0-----------------------#2019-10-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b63c5f3f46ff209a957494a0e9b06525.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WP5YxejDphbRH09MCsW7rw.png"/></div></div></figure><p id="cdcc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">安全性是当前的主要挑战之一，云提供商提供了不同的解决方案来加强安全性。<strong class="is hj"> Google Cloud提议通过IAM角色和应用于账户的权限来保护产品</strong>；技术(服务帐户)或个人(电子邮件、群组或域范围)。</p><p id="3ea8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，当您在私有模式下部署云运行或云功能时，或者当您将App Engine与IAP一起使用时，需要<strong class="is hj">载体授权令牌来进行认证，并检查认证帐户上允许的角色和权限</strong>。</p><p id="11ce" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://oauth.net/2/" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> OAuth 2.0 </strong> </a> <strong class="is hj">是轻量级和使用简单性</strong>(在请求头添加令牌)<strong class="is hj">和可接受的安全风险</strong>(令牌生命周期短，限制了<em class="jp">中间人</em>攻击的风险)之间的最佳权衡之一。</p><p id="2253" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，大概一个月一次，在栈溢出上看到这类问题:</p><blockquote class="jq jr js"><p id="cf9a" class="iq ir jp is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated">用API Key可以达到云跑吗？</p><p id="8072" class="iq ir jp is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated">如何用API密匙保护我的函数？</p></blockquote><p id="5c82" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果<strong class="is hj"> API密钥没有被提议</strong>用于保护API端点，那是因为其<strong class="is hj">更高的安全风险</strong>。事实上，API密匙的生命周期并不短，它的循环意味着客户端和服务器之间的同步。顺便说一下，这种长生命周期<a class="ae jo" href="https://cloud.google.com/endpoints/docs/openapi/authentication-method#api_keys" rel="noopener ugc nofollow" target="_blank">增加了<em class="jp">中间人</em>攻击</a>和<a class="ae jo" href="https://cloud.google.com/docs/authentication/api-keys" rel="noopener ugc nofollow" target="_blank">的风险，不建议使用API密钥来保护API访问</a>。</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><p id="a0f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，<strong class="is hj">对于某些用例，与“无安全性”或基本HTTP认证相比，API密钥是一种平衡的安全解决方案</strong>。但是，如前所述，<strong class="is hj">谷歌云本身并不支持这种类型的认证</strong>。对了，我们还要用一个附加层:<a class="ae jo" href="https://cloud.google.com/endpoints/" rel="noopener ugc nofollow" target="_blank">云端点</a>，也叫<a class="ae jo" href="https://github.com/cloudendpoints/esp" rel="noopener ugc nofollow" target="_blank">可扩展服务代理(ESP)现在是开源产品</a>。</p><h1 id="49fd" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">云端点</h1><p id="3245" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">云端点与应用引擎一起存在了许多年，但最近，谷歌云决定<strong class="is hj">从应用引擎中提取服务，并让任何人利用它</strong>。</p><p id="875a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/endpoints/docs/openapi/tutorials" rel="noopener ugc nofollow" target="_blank">几种部署模式都是可能的</a>，我选择使用<a class="ae jo" href="https://cloud.google.com/endpoints/docs/openapi/get-started-cloud-run" rel="noopener ugc nofollow" target="_blank">云运行模式</a>。尽管有教程的描述，你不需要有几个项目，我的<strong class="is hj">部署例子更简单一些，并尽量避免所有常见的陷阱</strong>。</p><p id="a44a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，为托管端点服务的云运行服务创建一个服务帐户(<em class="jp">我将把它命名为云运行端点网关</em>)，并允许它作为部署端点容器所需的角色，创建一个具有正确角色的服务帐户<em class="jp">(用您的项目ID更改&lt;PROJECT _ ID&gt;)</em></p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="f0d2" class="lp ke hi ll b fi lq lr l ls lt">gcloud beta iam service-accounts create endpoint-id<br/>gcloud projects add-iam-policy-binding &lt;PROJECT_ID&gt; \<br/>  --role=roles/servicemanagement.configEditor --member \<br/>  serviceAccount:endpoint-id@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com</span></pre><p id="1904" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并在云运行上部署端点容器<em class="jp">(我将服务命名为</em> <code class="du lu lv lw ll b"><em class="jp">endpoint</em></code> <em class="jp"> ) </em></p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="71c8" class="lp ke hi ll b fi lq lr l ls lt">gcloud beta run deploy endpoint \<br/> --image="<a class="ae jo" href="gcr.io/endpoints-release/endpoints-runtime-serverless:1" rel="noopener ugc nofollow" target="_blank">gcr.io/endpoints-release/endpoint-runtime-serverless:1</a>" \<br/> --allow-unauthenticated --region us-central1 --platform managed \<br/> --service-account \<br/> <a class="ae jo" href="mailto:endpoint-identity@gbl-imt-homerider-basguillaueb.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">endpoint-id@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com</a></span></pre><p id="4d1e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">获取表单</em> <code class="du lu lv lw ll b"><em class="jp">https://endpoint-&lt;hash&gt;-uc.a.run.app</em></code> <em class="jp">提供的URL。我们以后会用到它，不用</em> <code class="du lu lv lw ll b"><em class="jp">https://</em></code> <em class="jp">作为</em> <code class="du lu lv lw ll b"><em class="jp">ENDPOINTS_SERVICE_NAME</em></code></p><p id="1c57" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您的云运行端点网关正在运行。我们必须部署安全的应用程序并定义路线</p><h1 id="b507" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">部署安全服务</h1><p id="438b" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">为了在各种情况下测试云端点，让我们在云运行(私有模式)、云功能(私有模式)和应用引擎(受IAP保护)上部署服务</p><h2 id="5d71" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated">源代码</h2><p id="4105" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">在开始部署服务之前，打开云外壳并克隆<a class="ae jo" href="https://github.com/guillaumeblaquiere/apikey-endpoint" rel="noopener ugc nofollow" target="_blank"> GitHub库</a></p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="ac8f" class="lp ke hi ll b fi lq lr l ls lt">git clone <a class="ae jo" href="https://github.com/guillaumeblaquiere/apikey-endpoint.git" rel="noopener ugc nofollow" target="_blank">https://github.com/guillaumeblaquiere/apikey-endpoint.git</a><br/>cd apikey-endpoint</span></pre><p id="504d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">剩下的部署将在这个目录<code class="du lu lv lw ll b">apikey-endpoint</code>中完成</p><p id="a2f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以看一下Go代码。这是一个简单的<a class="ae jo" href="https://github.com/guillaumeblaquiere/apikey-endpoint/blob/master/Server.go" rel="noopener ugc nofollow" target="_blank"><em class="jp">web server</em></a><em class="jp">与</em> <code class="du lu lv lw ll b"><a class="ae jo" href="https://github.com/guillaumeblaquiere/apikey-endpoint/blob/master/function/function.go" rel="noopener ugc nofollow" target="_blank"><em class="jp">/hello</em></a></code> <a class="ae jo" href="https://github.com/guillaumeblaquiere/apikey-endpoint/blob/master/function/function.go" rel="noopener ugc nofollow" target="_blank"> <em class="jp"> GET API，如果在查询参数中提供了</em> </a> <code class="du lu lv lw ll b"><a class="ae jo" href="https://github.com/guillaumeblaquiere/apikey-endpoint/blob/master/function/function.go" rel="noopener ugc nofollow" target="_blank"><em class="jp">name</em></a></code> <em class="jp">，以及它运行的平台(平台在环境变量中提供)</em></p><h2 id="e620" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated"><a class="ae jo" href="https://cloud.google.com/run/docs/" rel="noopener ugc nofollow" target="_blank">云润</a></h2><p id="ebf6" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated"><strong class="is hj">默认情况下，云运行部署在</strong> <a class="ae jo" href="https://cloud.google.com/run/docs/securing/managing-access" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">私有模式下</strong> </a>，这意味着未经认证的用户，或者角色为<code class="du lu lv lw ll b">roles/run.invoker</code>、<strong class="is hj">的已认证用户不能调用</strong> <em class="jp">(或者具有所需权限的另一个角色)</em></p><p id="e5b9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">部署服务有两个步骤。首先，构建容器<em class="jp">(用您的项目ID更改&lt;项目ID &gt;)。</em></p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="6c87" class="lp ke hi ll b fi lq lr l ls lt">gcloud builds submit --tag gcr.io/&lt;PROJECT_ID&gt;/apikey-endpoint</span></pre><p id="ceb7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后在私有模式下部署容器:<code class="du lu lv lw ll b">— no-allow-unauthenticated</code></p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="e15f" class="lp ke hi ll b fi lq lr l ls lt">gcloud beta run deploy apikey-endpoint --no-allow-unauthenticated \<br/>    --image gcr.io/&lt;PROJECT_ID&gt;/apikey-endpoint \<br/>    --region us-central1 --platform managed</span></pre><p id="e9cf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将提供的网址保存在某个地方。我们以后会需要它。你试着对它执行一个 <code class="du lu lv lw ll b"><em class="jp">curl</em></code> <em class="jp">来验证，如果没有认证，服务是不可访问的</em></p><h2 id="7ee7" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated"><a class="ae jo" href="https://cloud.google.com/functions/docs/" rel="noopener ugc nofollow" target="_blank">云功能</a></h2><p id="7942" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated"><strong class="is hj">默认情况下，云功能也部署在</strong> <a class="ae jo" href="https://cloud.google.com/functions/docs/securing/managing-access#controlling_access_on_a_function" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">私有模式下</strong>，</a>这意味着未经认证的用户，或者角色为<code class="du lu lv lw ll b">roles/cloudfunctions.invoker</code>，<strong class="is hj">的已认证用户不能调用</strong> <em class="jp">功能(或者具有所需权限的另一个角色)。</em></p><p id="3a3a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该部署仅获取<code class="du lu lv lw ll b">function</code>源目录中的文件。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="defb" class="lp ke hi ll b fi lq lr l ls lt">gcloud beta functions deploy apikey-endpoint --trigger-http \<br/>   --runtime go112 --source function --entry-point HelloWorld \<br/>   --region us-central1<strong class="ll hj"> </strong>--no-allow-unauthenticated \<br/>   --set-env-vars=ENV="Cloud Functions"</span></pre><p id="9124" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将提供的网址保存在某个地方。我们以后会需要它。您尝试对其执行 <code class="du lu lv lw ll b"><em class="jp">curl</em></code> <em class="jp">来验证，如果没有认证，服务是不可访问的</em></p><h2 id="5a5b" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated"><a class="ae jo" href="https://cloud.google.com/appengine/docs/standard/go112/" rel="noopener ugc nofollow" target="_blank"> App引擎标准</a></h2><p id="9b52" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated"><strong class="is hj"> App引擎默认为公共</strong>。然而，Google Cloud已经添加了一个名为 <a class="ae jo" href="https://cloud.google.com/iap/docs/managing-access" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">的安全层</strong> </a> <strong class="is hj">(或IAP) </strong>，它不允许未经认证的用户或没有角色<code class="du lu lv lw ll b">roles/iap.httpsResourceAccessor</code> <em class="jp">(或具有所需权限的另一个角色)的已认证用户访问服务。</em></p><p id="aaf2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有两个步骤。首先，部署应用引擎标准<em class="jp">(如果需要，激活应用引擎API。明智地选择你的区域，你不能改变！)</em></p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="8a83" class="lp ke hi ll b fi lq lr l ls lt">gcloud app deploy</span></pre><p id="ebe8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">把提供的网址放在某个地方。我们以后会需要它。</p><p id="3d84" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，<strong class="is hj">激活App引擎上的IAP</strong>。这没有命令行，但是你可以通过GUI<a class="ae jo" href="https://cloud.google.com/iap/docs/app-engine-quickstart#enabling_iap" rel="noopener ugc nofollow" target="_blank">来完成。</a></p><p id="5604" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">转到<code class="du lu lv lw ll b">Security</code>并选择<code class="du lu lv lw ll b">Identity-Aware Proxy</code>。用您的应用程序名称填写同意页面，并返回到上一个选项卡。这里，将滑块放在右侧<em class="jp">(忽略错误标志)</em>，点击<code class="du lu lv lw ll b">Turn on</code>确认警告信息。</p><figure class="lg lh li lj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/9ce97246c0d87935c69ab590c9d59fa2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*7VHB_K7o_9ty1Db7aoG6Qw.gif"/></div></div></figure><p id="32df" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">您尝试在上执行</em> <code class="du lu lv lw ll b"><em class="jp">curl</em></code> <em class="jp">来验证，如果没有身份验证，服务是不可访问的。</em></p><h1 id="2276" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">将云端点与服务联系起来</h1><p id="ed17" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">现在，我们必须向云端点服务声明在哪里以及如何获得服务。为此，您必须定义一个OpenAPI v2.0格式的YAML文件。有一些工具可以解决这个问题并加速开发。</p><p id="1554" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">看文件<code class="du lu lv lw ll b"><a class="ae jo" href="https://github.com/guillaumeblaquiere/apikey-endpoint/blob/master/endpoint.yaml" rel="noopener ugc nofollow" target="_blank">endpoint.yaml</a></code>。你可以定义一个<code class="du lu lv lw ll b">paths</code>列表的入口点和要到达的后端。</p><p id="22dd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先创建文件头:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="21cc" class="lp ke hi ll b fi lq lr l ls lt">swagger: '2.0'<br/>info:<br/>  title: Cloud Endpoints with API Keys<br/>  description: Sample API on Cloud Endpoints with a Cloud Run, Cloud Function and App Engine with IAP backend<br/>  version: 1.0.0<br/>host: endpoint-&lt;hash&gt;-uc.a.run.app<br/>schemes:<br/>  - https</span></pre><p id="cb83" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lu lv lw ll b">host</code>是您的云运行端点网关的<code class="du lu lv lw ll b">ENDPOINTS_SERVICE_NAME</code>的值。<code class="du lu lv lw ll b">title</code>是您的API在<code class="du lu lv lw ll b">API &amp; Services</code> <em class="jp"> </em>部分的名称。</p><h2 id="3b50" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated">云运行</h2><p id="7292" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated"><strong class="is hj">对于云运行，建议使用</strong> <code class="du lu lv lw ll b"><strong class="is hj">APPEND_PATH_TO_ADDRESS</strong></code>。此参数配置云端点，用于将路径<code class="du lu lv lw ll b">/hello</code>复制到<code class="du lu lv lw ll b">address</code>的末端，并执行“主机重写”。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="3ac3" class="lp ke hi ll b fi lq lr l ls lt">/hello:<br/>  get:<br/>    summary: Greet a user from Cloud Run<br/>    operationId: hello_cloud_run<br/>    x-google-backend:<br/>      address: https://apikey-endpoint-&lt;hash&gt;-uc.a.run.app<br/>      path_translation: APPEND_PATH_TO_ADDRESS</span></pre><h2 id="c218" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated">应用引擎</h2><p id="6618" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">对于App Engine，我们也可以使用“主机重写”。但是路径<code class="du lu lv lw ll b">/hello</code>将是双精度的。因此，<strong class="is hj">我们不指定任何</strong> <code class="du lu lv lw ll b"><strong class="is hj">path_translation</strong></code> <strong class="is hj">来执行URL重写</strong> <em class="jp">(用您的项目ID更改&lt;项目ID&gt;)</em></p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="9562" class="lp ke hi ll b fi lq lr l ls lt">/hello-gae:<br/>  get:<br/>    summary: Greet a user from App Engine<br/>    operationId: hello_gae<br/>    x-google-backend:<br/>      address: https://apikey-endpoint-dot-&lt;PROJECT_ID&gt;.appspot.com/hello</span></pre><h2 id="aa2d" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated">云函数</h2><p id="965a" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">对于云函数，为了保持与其他名称的一致性，我们也没有指定任何用于执行URL重写的<code class="du lu lv lw ll b">path_translation</code><em class="jp">(用您的项目ID</em>更改&lt; PROJECT_ID &gt;</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="c83a" class="lp ke hi ll b fi lq lr l ls lt">/hello-gcf:<br/>  get:<br/>    summary: Greet a user from Function<br/>    operationId: hello_cloud_function<br/>    x-google-backend:<br/>      address: https://us-central1-&lt;PROJECT_ID&gt;.cloudfunctions.net/apikey-endpoint</span></pre><h1 id="d7c5" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">使用API键</h1><p id="d099" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">前进是完成了，但是现在没有安全。<strong class="is hj">激活和使用API密钥进行认证需要几个动作</strong>。</p><h2 id="fc9c" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated">在云端点中添加API密钥安全性</h2><p id="00ae" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/endpoints/docs/openapi/restricting-api-access-with-api-keys" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> API密匙安全</strong> </a> <strong class="is hj">是全局添加还是在每个</strong> <code class="du lu lv lw ll b"><strong class="is hj">path</strong></code>上添加，就像我的例子。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="21d7" class="lp ke hi ll b fi lq lr l ls lt">security:<br/>    - api_key: []</span></pre><p id="9c66" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于测试，您可以用<code class="du lu lv lw ll b">x-google-allow: all</code>替换它，以禁用安全性。</p><p id="bdc2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并且<strong class="is hj">在文件</strong>的末尾添加安全定义</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="950f" class="lp ke hi ll b fi lq lr l ls lt">securityDefinitions:<br/>  api_key:<br/>    type: "apiKey"<br/>    name: "key"<br/>    in: "query"</span></pre><h2 id="b5b9" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated">部署云端点服务</h2><p id="d19e" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">现在，<code class="du lu lv lw ll b">endpoint.yaml</code>已经完全定义好了，让我们将它部署到云端点服务上</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="8b9d" class="lp ke hi ll b fi lq lr l ls lt">gcloud endpoints services deploy endpoint.yaml</span></pre><p id="eb69" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，云端点服务已经存在。为了向云运行端点网关表明这一点，我们必须用一个环境变量来更新它，该变量用值<code class="du lu lv lw ll b">ENDPOINTS_SERVICE_NAME</code>来指定这个名称。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="23f3" class="lp ke hi ll b fi lq lr l ls lt">gcloud beta run services update endpoint \<br/>--set-env-vars ENDPOINTS_SERVICE_NAME=<!-- -->endpoint-&lt;hash&gt;-uc.a.run.app<!-- --> \<br/>--region us-central1 --platform managed</span></pre><h2 id="7da2" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated">激活您的API</h2><p id="4fed" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">通过在云端点上部署配置，创建了一个新的API服务。现在，您必须在项目中激活它。您可以通过命令行来完成此操作:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="b233" class="lp ke hi ll b fi lq lr l ls lt">gcloud services enable endpoint-&lt;hash&gt;-uc.a.run.app</span></pre><p id="736a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">API服务名称是您的云运行端点网关的名称<code class="du lu lv lw ll b">ENDPOINTS_SERVICE_NAME</code></p><p id="7d18" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您也可以通过GUI激活服务。进入谷歌云控制台，进入<code class="du lu lv lw ll b">API &amp; Services</code>，选择<code class="du lu lv lw ll b">Library</code> <em class="jp">。</em>然后，搜索您的API名称(<em class="jp">带有API关键字</em>的云端点，如果您没有更改<code class="du lu lv lw ll b">endpoint.yaml</code>文件中的<code class="du lu lv lw ll b">title</code>的话)并激活它。</p><figure class="lg lh li lj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/890b95912344fa1c2e9155c9b5d7c2bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*UloU-0b4Cmjq6igKZb9akA.gif"/></div></div></figure><h2 id="b313" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated">创建API密钥</h2><p id="895a" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">为了访问服务，你必须使用一个API密匙。为此，您必须在谷歌云控制台中创建一个。</p><p id="13bd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">转到<code class="du lu lv lw ll b">API &amp; Services</code>并选择<code class="du lu lv lw ll b">Credentials</code>。点击<code class="du lu lv lw ll b">Create credentials</code> <em class="jp"> </em>并选择<code class="du lu lv lw ll b">API Key</code> <em class="jp">。</em></p><figure class="lg lh li lj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/e1062d90b0a2a6b0510ca3a157dc7f69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*WfU-W3yMAWtJIPCTAVua-A.gif"/></div></div></figure><p id="0733" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于API密钥的安全级别较低，<strong class="is hj">最佳实践是限制密钥</strong>。</p><p id="991e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">编辑密匙(点击铅笔)，在<code class="du lu lv lw ll b">API restrictions</code> <em class="jp">、</em>下点击<code class="du lu lv lw ll b">Restrict key</code>，在下拉列表中，只检查您的API名称(如果您没有在<code class="du lu lv lw ll b">endpoint.yaml</code>文件的<code class="du lu lv lw ll b">title</code>中更改，则检查带有API密匙的<em class="jp">云端点)</em></p><figure class="lg lh li lj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/207d3a317771380b59640433e089b620.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*BMS3qhfDRJoPqEh6TfkELA.gif"/></div></div></figure><p id="f641" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">保存创建并授权的API Key的键值，我们以后会用到。</em></p><h1 id="8504" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">云运行端点网关授权</h1><p id="41dc" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">让我们总结一下我们所拥有的。</p><ul class=""><li id="b5d3" class="ml mm hi is b it iu ix iy jb mn jf mo jj mp jn mq mr ms mt bi translated"><strong class="is hj">我们在云运行、云功能和App Engine上有3个服务</strong>。这些服务都是安全的，需要IAM角色来访问它们。</li><li id="244a" class="ml mm hi is b it mu ix mv jb mw jf mx jj my jn mq mr ms mt bi translated">我们还有一个<strong class="is hj">云运行端点网关，与云端点服务</strong>相链接。在这个服务上，已经部署了<strong class="is hj">将请求路由到每个服务</strong>所需的配置，并且它<strong class="is hj">需要每个路径入口点中的有效API键</strong>。</li></ul><blockquote class="jq jr js"><p id="95eb" class="iq ir jp is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated">但是，云运行端点网关如何能够到达每个安全的服务呢？</p></blockquote><p id="7bdd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，我们必须授予云运行端点网关服务帐户所需的授权</p><h2 id="39ba" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated">云运行</h2><p id="ac75" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">如前所述，通过认证用户可以使用<code class="du lu lv lw ll b">roles/run.invoker</code>访问私有云运行的服务。因此，让我们将这个角色授予云运行端点网关服务帐户。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="f836" class="lp ke hi ll b fi lq lr l ls lt">gcloud projects add-iam-policy-binding &lt;PROJECT_ID&gt; \<br/>  --role=roles/<!-- -->run.invoker<!-- --> --member \<br/>  serviceAccount:endpoint-id@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com</span></pre><h2 id="1341" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated">云函数</h2><p id="fbb3" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">与云运行一样，如前所述，通过认证的用户可以使用<code class="du lu lv lw ll b">roles/cloudfunctions.invoker</code>访问私有云功能服务。因此，让我们将这个角色授予云运行端点网关服务帐户<em class="jp">(用您的项目ID更改&lt;项目ID&gt;)</em>。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="150e" class="lp ke hi ll b fi lq lr l ls lt">gcloud projects add-iam-policy-binding &lt;PROJECT_ID&gt; \<br/>  --role=roles/<!-- -->cloudfunctions.invoker<!-- --> --member \<br/>  serviceAccount:endpoint-id@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com</span></pre><h2 id="6bc8" class="lp ke hi bd kf lx ly lz kj ma mb mc kn jb md me kr jf mf mg kv jj mh mi kz mj bi translated">应用引擎</h2><p id="0be4" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">IAP保护的App Engine略有不同。当然，角色<code class="du lu lv lw ll b">roles/iap.httpsResourceAccessor</code>已经被授予云运行端点网关服务账户<em class="jp">(用你的项目ID</em>改变&lt;项目ID &gt;)。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="dfd4" class="lp ke hi ll b fi lq lr l ls lt">gcloud projects add-iam-policy-binding &lt;PROJECT_ID&gt; \<br/>   --role=roles/iap.httpsResourceAccessor --member \ <br/>   serviceAccount:endpoint-id@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com</span></pre><p id="7ab3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您也可以通过GUI执行这种授权</p><ul class=""><li id="850b" class="ml mm hi is b it iu ix iy jb mn jf mo jj mp jn mq mr ms mt bi translated">转到<code class="du lu lv lw ll b">Security</code>并选择<code class="du lu lv lw ll b">Identity-Aware Proxy</code>。</li><li id="cee3" class="ml mm hi is b it mu ix mv jb mw jf mx jj my jn mq mr ms mt bi translated">在右侧面板上选择您的应用引擎(如果没有，点击<code class="du lu lv lw ll b">Show info panel</code>)</li><li id="1a23" class="ml mm hi is b it mu ix mv jb mw jf mx jj my jn mq mr ms mt bi translated">点击<code class="du lu lv lw ll b">Add Member</code>。</li><li id="bf34" class="ml mm hi is b it mu ix mv jb mw jf mx jj my jn mq mr ms mt bi translated">粘贴你的<code class="du lu lv lw ll b">endpoint-id@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com</code>邮箱账号，选择<code class="du lu lv lw ll b">Cloud-IAP</code>-&gt;-T7】</li></ul><figure class="lg lh li lj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/79b3c44d6b224d959f7b548b8bade08b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*tufKdq_HVq2SG8-wjKXBuw.gif"/></div></div></figure><p id="c181" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，<strong class="is hj"> IAP还检查JWT令牌</strong>的正确受众。为此，我们必须更新<code class="du lu lv lw ll b">endpoint.yaml</code>文件，以便在执行路由时向云端点服务指示正确的受众。<em class="jp">(用您的项目ID更改&lt;项目ID &gt;，并设置正确的</em> <code class="du lu lv lw ll b"><em class="jp">jwt_audience</em></code> <em class="jp"> ) </em></p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="d537" class="lp ke hi ll b fi lq lr l ls lt">x-google-backend:<br/>  address: https://apikey-endpoint-dot-&lt;PROJECT_ID&gt;.appspot.com/hello<br/>  jwt_audience: &lt;PROJECT_NUMBER&gt;-&lt;HASH&gt;.apps.googleusercontent.com</span></pre><p id="7cc7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lu lv lw ll b">jwt_audience</code>是IAP客户端ID。您可以通过转到<code class="du lu lv lw ll b">API &amp; Services</code>并选择<code class="du lu lv lw ll b">Credentials</code>找到它。在这里，查看<code class="du lu lv lw ll b">OAuth 2.0 client IDs</code>并寻找<code class="du lu lv lw ll b">IAP-App-Engine-app</code>行并复制<code class="du lu lv lw ll b">Client ID</code></p><figure class="lg lh li lj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/acee31a111089ceba9e1fe1c04269ed8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*k84fx7pvcaCt-TTeKflg1w.gif"/></div></div></figure><p id="3e52" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并将<code class="du lu lv lw ll b">endpoint.yaml</code>文件重新部署到云端点服务</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="9d82" class="lp ke hi ll b fi lq lr l ls lt">gcloud endpoints services deploy endpoint.yaml</span></pre><h1 id="8656" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">验证云端点路由</h1><p id="cf44" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">最后，<strong class="is hj">所有的设置都完成了</strong>。取回您的API密钥的密钥值，并尝试<strong class="is hj">请求云运行端点网关URL </strong>并验证路由是否按预期工作</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="4443" class="lp ke hi ll b fi lq lr l ls lt">curl https://endpoint-&lt;hash&gt;-uc.a.run.app/hello?key=&lt;API KEY&gt;<br/>curl https://endpoint-&lt;hash&gt;-uc.a.run.app/hello-gcf?key=&lt;API KEY&gt;<br/>curl https://endpoint-&lt;hash&gt;-uc.a.run.app/hello-gae?key=&lt;API KEY&gt;</span></pre></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><h1 id="2e2c" class="kd ke hi bd kf kg mz ki kj kk na km kn ko nb kq kr ks nc ku kv kw nd ky kz la bi translated">API密钥的云端点等等！</h1><p id="e8cb" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">即使谷歌云服务本身不支持<strong class="is hj"> API密钥，出于安全原因，即使<strong class="is hj">不推荐这种认证模式</strong>，如果您的用例需要，也可以<strong class="is hj">使用无服务器产品:云端点</strong>来解决它们。</strong></p><p id="faa5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我只是<strong class="is hj">展示了云端点功能</strong>的一小部分，我将它用作API网关，用于<strong class="is hj">提取认证和路由</strong>到不同的服务。并且<strong class="is hj">你不局限于谷歌云服务API</strong>。您还可以使用它在内部或其他云提供商上路由您的请求。</p><p id="7dc3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，<strong class="is hj">云端点可以做得更多</strong>。可以；</p><ul class=""><li id="9d1d" class="ml mm hi is b it iu ix iy jb mn jf mo jj mp jn mq mr ms mt bi translated">设置一个<strong class="is hj">自定义域</strong>。</li><li id="5df7" class="ml mm hi is b it mu ix mv jb mw jf mx jj my jn mq mr ms mt bi translated">将它部署在一个<strong class="is hj">虚拟机上，云功能上，GKE和Kubernetes上。</strong></li><li id="cfcc" class="ml mm hi is b it mu ix mv jb mw jf mx jj my jn mq mr ms mt bi translated">您可以定义<strong class="is hj">配额和费率限制。</strong></li><li id="7e00" class="ml mm hi is b it mu ix mv jb mw jf mx jj my jn mq mr ms mt bi translated">集成<strong class="is hj">其他认证方式如Auth0或FirebaseAuth </strong>(而且是Google Cloud decideration<a class="ae jo" href="https://cloud.google.com/identity-platform/docs/" rel="noopener ugc nofollow" target="_blank">云身份平台</a>)。</li><li id="8eed" class="ml mm hi is b it mu ix mv jb mw jf mx jj my jn mq mr ms mt bi translated"><strong class="is hj">共享一个开发者门户</strong>，在那里你的API被描述，开发者可以测试它。</li><li id="ee8a" class="ml mm hi is b it mu ix mv jb mw jf mx jj my jn mq mr ms mt bi translated">进行<strong class="is hj"> API版本控制，恢复以前的API版本</strong>并查看版本<strong class="is hj">之间的差异</strong>。</li><li id="80d1" class="ml mm hi is b it mu ix mv jb mw jf mx jj my jn mq mr ms mt bi">…</li></ul><p id="41b5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你寻找更高级的功能，像<strong class="is hj">计费和监控，</strong><a class="ae jo" href="https://cloud.google.com/apigee/" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">API gee</strong></a><strong class="is hj">是更好的解决方案</strong>。</p><p id="6fcf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，如果你正在寻找一个强大的免费API网关解决方案，那么Cloud Endpoint正适合你。我们试试吧！</p></div></div>    
</body>
</html>