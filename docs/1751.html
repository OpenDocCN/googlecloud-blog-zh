<html>
<head>
<title>Secure access to your VMs in Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">安全访问Google云中的虚拟机</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/secure-access-to-your-vms-in-google-cloud-ada97449c793?source=collection_archive---------0-----------------------#2021-01-13">https://medium.com/google-cloud/secure-access-to-your-vms-in-google-cloud-ada97449c793?source=collection_archive---------0-----------------------#2021-01-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a129" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安全访问远程机器的要求之一是方便用户管理虚拟机访问矩阵，并降低解决方案和运营成本。对于托管在谷歌云上的虚拟机来说，这很容易做到。在这篇文章中，我构建了一个基于操作系统登录和IAP隧道的工作解决方案的示例，并回顾了关于该技术和最佳实践的几个重要焦点。</p><h1 id="8a2e" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">通常是怎么做的。</h1><p id="f4f3" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">数据中心和云提供商的大多数现有解决方案使用三种结构之一:</p><ul class=""><li id="364b" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc kl km kn ko bi translated">到目标主机的SSH / RDP加密连接</li><li id="33d6" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">到堡垒主机的SSH / RDP加密连接，该主机充当到目的主机的跳转位置</li><li id="fa81" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">用户连接以访问目标主机的虚拟桌面供应商解决方案</li></ul><p id="270b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些结构几乎没有缺点。基于SSH的解决方案需要昂贵的(在金钱和精力上)SSH密钥管理，并且存在将用于执行操作的用户的主账户绑定SSH密钥的问题。基于RDP的解决方案通常需要建立VPN连接，这种连接的运营成本很高，对于最终用户来说很难使用。供应商解决方案从来都不便宜。</p><h1 id="a6ba" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">它是如何在谷歌云中完成的。</h1><p id="9bd0" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">Google Cloud允许用户使用<a class="ae ku" href="https://cloud.google.com/iap/docs/using-tcp-forwarding" rel="noopener ugc nofollow" target="_blank"> IAP隧道</a>连接到未暴露于互联网的虚拟机，而无需VPN连接。这允许消除对VPN连接的需求，同时保持虚拟机群不被外部攻击利用。使用Google Cloud，您可以在每个用户的基础上隐式管理SSH密钥，而不会将它们暴露给最终用户，从而降低与密钥管理或密钥丢失相关的风险。它还允许您将对虚拟机实例的访问权分配给主要用户。这个功能被称为<a class="ae ku" href="https://cloud.google.com/compute/docs/oslogin" rel="noopener ugc nofollow" target="_blank">操作系统登录</a>，可以为单个虚拟机实例启用，也可以为项目或组织中的所有虚拟机实例启用。操作系统登录的使用利用了Google Cloud IAM服务，并简化了用户到虚拟机的管理矩阵。使用IAP隧道和操作系统登录不会带来额外的成本。</p><p id="698e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">像所有事情一样，这个解决方案也有局限性。操作系统登录仅适用于SSH连接。它不能用于RDP。这对于现代版本的Windows来说应该不成问题，因为它们都内置了SSH支持。但是，不可能与GUI建立连接。在这种情况下，你可以利用其他谷歌云解决方案，如<a class="ae ku" href="https://cloud.google.com/compute/docs/instances/connecting-to-windows" rel="noopener ugc nofollow" target="_blank"> RDP </a>或<a class="ae ku" href="https://cloud.google.com/solutions/virtual-desktops" rel="noopener ugc nofollow" target="_blank">虚拟桌面</a>。</p><h1 id="3178" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">少说多做。</h1><p id="2597" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">有大量文章提供了演示IAP隧道和操作系统登录的代码示例。以下示例的不同之处仅在于使用了最新的Cloud SDK命令，并且很可能是极简的。</p><p id="65b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要运行它，你必须在GCP项目上拥有<strong class="ih hj">角色/编辑</strong>角色或类似的权限集，并拥有默认的VPC，并且在你的客户端机器上安装Cloud SDK<a class="ae ku" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank">。这些说明是为装有Linux操作系统的客户机提供的。让它们在Windows上运行应该很容易。</a></p><ol class=""><li id="4820" class="kg kh hi ih b ii ij im in iq ki iu kj iy kk jc kv km kn ko bi translated">通过定义区域、项目id和虚拟机实例名称来设置配置环境:</li></ol><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="94ba" class="lf je hi lb b fi lg lh l li lj"># VM_NAME=sample-destination-host; \<br/>ZONE=us-central1-a; \<br/>PROJECT_ID=&lt;your project id&gt;; \<br/>USER_ID=$(gcloud config list account --format "value(core.account)")</span></pre><p id="f7fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想使用这个例子来授权另一个Google帐户连接到目的主机，那么将该用户的电子邮件地址作为USER_ID的值。</p><p id="79a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.使用云SDK进行身份验证。同一用户将用于配置示例和连接到目标主机:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="1af8" class="lf je hi lb b fi lg lh l li lj"># gcloud auth login</span></pre><p id="ebcb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.确保启用了所有相关的API:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="0230" class="lf je hi lb b fi lg lh l li lj"># gcloud services enable compute.googleapi.com \<br/>    iap.googleapis.com \<br/>    --project $PROJECT_ID</span></pre><p id="cdcf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.创建示例目标主机:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="50f2" class="lf je hi lb b fi lg lh l li lj"># gcloud compute instances create $VM_NAME \<br/>    --network default \<br/>    --metadata enable-oslogin=TRUE \<br/>    --role roles/compute.osAdminLogin \<br/>    --zone $ZONE \<br/>    --project $PROJECT_ID</span></pre><p id="3b89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当前授权的用户被授予虚拟机实例上的<strong class="ih hj">角色/compute.osAdminLogin </strong>角色。可以授予<strong class="ih hj"> roles/compute.osLogin </strong>角色，该角色授予VM实例上的管理员权限。</p><p id="5dca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.允许用户在项目中创建SSH(端口22) IAP隧道:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="5165" class="lf je hi lb b fi lg lh l li lj"># gcloud projects add-iam-policy-binding $PROJECT_ID \<br/>    --member user:$USER_ID \<br/>    --role roles/iap.tunnelResourceAccessor \<br/>    --condition \<br/>      'title=allow-ssh-only,expression=destination.port==22'</span></pre><p id="bd0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前，Cloud SDK <a class="ae ku" href="https://cloud.google.com/iap/docs/using-tcp-forwarding" rel="noopener ugc nofollow" target="_blank">不支持</a>为单个虚拟机实例定义IAM策略。只能在云控制台中完成。该示例为项目中的用户定义了策略。</p><p id="5869" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.配置防火墙规则以允许从IAP到默认VPC网络的SSH连接。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="96c4" class="lf je hi lb b fi lg lh l li lj"># gcloud compute firewall-rules create allow-ssh-ingress-from-iap \<br/>    --network default \<br/>    --direction INGRESS \<br/>    --action allow \<br/>    --rules tcp:22 \<br/>    --source-ranges 35.235.240.0/20 \<br/>    --project $PROJECT_ID</span></pre><p id="0cdc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在可以使用当前用户凭据连接到实例:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="5827" class="lf je hi lb b fi lg lh l li lj"># gcloud compute ssh --tunnel-through-iap \<br/>    “projects/$PROJECT_ID/zones/$ZONE/instances/$VM_NAME”</span></pre><p id="700b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想要使用不同的Google帐户连接到目标主机，则在执行上述命令之前，您必须针对Cloud SDK重新进行身份验证。</p><h1 id="4d1a" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">对我们所做的和最佳实践的深入审查。</h1><p id="33b6" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">当您调用“gcloud compute ssh”时，会发生以下情况:</p><figure class="kw kx ky kz fd ll er es paragraph-image"><div class="er es lk"><img src="../Images/d4f6f862770fd2dbe0834cdf879bfbce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*6B7PRMbK3prjxC_3GYcPMg.png"/></div></figure><p id="b0b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1.客户机上的Cloud SDK通过IAP创建TCP隧道，到达目标虚拟机上的端口22。</p><p id="5d5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.IAP验证用户(客户端上Cloud SDK中的当前活动凭据)是否有权建立到目标虚拟机的IAP隧道。</p><p id="68ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.建立了到目标虚拟机的SSH连接。</p><p id="ac57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.目标虚拟机上的操作系统登录代理验证用户是否有权登录。此外，如果虚拟机具有附加的<a class="ae ku" href="https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances" rel="noopener ugc nofollow" target="_blank">服务帐户</a>，则验证用户在虚拟机上具有服务帐户用户角色。</p><p id="9db6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">IAP隧道权限可以在项目或虚拟机实例级别授予。可以使用<a class="ae ku" href="https://cloud.google.com/vpc/docs/firewall-policies" rel="noopener ugc nofollow" target="_blank">分层防火墙策略</a>在组织、文件夹或项目级别定义防火墙规则。类似地，您可以<a class="ae ku" href="https://cloud.google.com/compute/docs/instances/managing-instance-access" rel="noopener ugc nofollow" target="_blank">在实例或项目级别强制操作系统登录</a>，或者将其定义为<a class="ae ku" href="https://cloud.google.com/compute/docs/oslogin/manage-oslogin-in-an-org#set-org-policy" rel="noopener ugc nofollow" target="_blank">组织策略</a>，以便在您组织的整个虚拟机群中强制实施。</p><p id="4280" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在项目或组织级别上授予IAP隧道和操作系统登录权限使用Google服务帐户可以实现对特定虚拟机的细粒度访问控制。如果用户未被授予与虚拟机实例关联的服务帐户的服务帐户用户角色，则无法登录该实例。除非在创建时明确配置，否则虚拟机实例将拥有一个默认的计算引擎服务帐户。该帐户自动为每个项目提供，看起来像123456789-compute@developer.gserviceaccount.com。使用这个帐户被认为是一种不好的做法。<a class="ae ku" href="https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances#best_practices" rel="noopener ugc nofollow" target="_blank">推荐的实践</a>是为虚拟机实例提供专用的服务帐户。</p><h1 id="e500" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">总结…</h1><ul class=""><li id="7222" class="kg kh hi ih b ii kb im kc iq lo iu lp iy lq jc kl km kn ko bi translated">使用<a class="ae ku" href="https://cloud.google.com/compute/docs/oslogin" rel="noopener ugc nofollow" target="_blank">操作系统登录</a>消除了管理SSH密钥的负担，并缓解了密钥丢失的潜在安全问题。但是，它不能与RDP等连接方法一起使用。</li><li id="f7d0" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">使用<a class="ae ku" href="https://cloud.google.com/iap/docs/using-tcp-forwarding" rel="noopener ugc nofollow" target="_blank"> IAP隧道</a>允许将整个虚拟机群保持在私有网络地址空间中，并避免暴露虚拟机以供来自互联网的访问。</li><li id="98bf" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">遵循使用专用服务帐户的<a class="ae ku" href="https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances#best_practices" rel="noopener ugc nofollow" target="_blank">最佳实践</a>和<a class="ae ku" href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints" rel="noopener ugc nofollow" target="_blank">组织政策</a>提供现成的解决方案，用于管理您组织中的用户对Google Cloud中托管的整个虚拟机群的安全访问。</li><li id="e74e" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">该解决方案不会产生任何额外成本。</li><li id="20d2" class="kg kh hi ih b ii kp im kq iq kr iu ks iy kt jc kl km kn ko bi translated">所有操作都会自动记录到云日志中，以便进一步审核，包括启动虚拟机连接的主体的身份。可以定义警报策略来通知意外或异常的连接。</li></ul></div></div>    
</body>
</html>