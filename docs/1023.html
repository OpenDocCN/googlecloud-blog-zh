<html>
<head>
<title>How to run Python code on your BigQuery table</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在BigQuery表上运行Python代码</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-run-python-code-on-your-bigquery-table-1bbd78c69351?source=collection_archive---------2-----------------------#2019-06-06">https://medium.com/google-cloud/how-to-run-python-code-on-your-bigquery-table-1bbd78c69351?source=collection_archive---------2-----------------------#2019-06-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="25ef" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用Python 3 Apache射束管道</h2></div><p id="b787" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以用SQL做很多事情，SQL无疑非常方便，但是偶尔您会发现自己需要在BigQuery表上运行Python代码。如果您的数据很小，您可以使用Pandas(和BigQuery客户端库)，但是如果您的数据很大，最好的方法是使用Apache Beam，并通过云数据流以无服务器、自动缩放的方式执行它。</p><p id="84eb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是GitHub 中示例的<a class="ae jt" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/05_devel/statfit.ipynb" rel="noopener ugc nofollow" target="_blank">完整代码。它来自我们即将出版的关于BigQuery </a>的<a class="ae jt" href="https://www.oreilly.com/library/view/google-bigquery-the/9781492044451/" rel="noopener ugc nofollow" target="_blank">书。</a></p><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es ju"><img src="../Images/5865fb7cea3ec55be2a67112769eb562.png" data-original-src="https://miro.medium.com/v2/resize:fit:548/format:webp/1*pY5eytKNMGcjpF_qbaoKEA.jpeg"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">这里的代码来自我们关于BigQuery的新书的第5章。您可以在Safari上的早期访问中阅读它。</figcaption></figure><h2 id="0953" class="kg kh hi bd ki kj kk kl km kn ko kp kq jg kr ks kt jk ku kv kw jo kx ky kz la bi translated">Python 3 Apache Beam + BigQuery</h2><p id="e77c" class="pw-post-body-paragraph ix iy hi iz b ja lb ij jc jd lc im jf jg ld ji jj jk le jm jn jo lf jq jr js hb bi translated">下面是从BigQuery读取并写入BigQuery的关键Beam代码:</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="05f0" class="kg kh hi lh b fi ll lm l ln lo">with beam.Pipeline(RUNNER, options = opts) as p:<br/>    (p <br/>      | 'read_bq' &gt;&gt; beam.io.Read(beam.io.BigQuerySource(query=query, use_standard_sql=True))<br/>      | 'compute_fit' &gt;&gt; beam.FlatMap(compute_fit)<br/>      | 'write_bq' &gt;&gt; beam.io.gcp.bigquery.WriteToBigQuery(<br/>          'ch05eu.station_stats', schema='station_id:string,ag:FLOAT64,bg:FLOAT64,cg:FLOAT64')<br/>    )</span></pre><p id="e1ee" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本质上，我们在BigQuery表上运行查询，运行Python方法compute_fit，并将输出写入BigQuery表。</p><p id="af2a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是我的compute_fit方法。如您所见，这只是普通的Python代码:</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="c1cb" class="kg kh hi lh b fi ll lm l ln lo">def compute_fit(row):<br/>  from scipy import stats<br/>  import numpy as np<br/>  durations = row['duration_array']<br/>  ag, bg, cg = stats.gamma.fit(durations)<br/>  if np.isfinite(ag) and np.isfinite(bg) and np.isfinite(cg):<br/>      result = {}<br/>      result['station_id'] = str(row['start_station_id'])<br/>      result['ag'] = ag<br/>      result['bg'] = bg<br/>      result['cg'] = cg<br/>      yield result</span></pre><p id="b0bf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">确保在requirements.txt中指定需要安装在数据流工作器上的Python包:</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="117b" class="kg kh hi lh b fi ll lm l ln lo">%%writefile requirements.txt<br/>numpy<br/>scipy</span></pre><p id="d197" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">尽情享受吧！</p></div></div>    
</body>
</html>