<html>
<head>
<title>Importing GIS Data into BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将GIS数据导入BigQuery</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/import-gis-data-into-bigquery-8217dc370040?source=collection_archive---------1-----------------------#2022-08-05">https://medium.com/google-cloud/import-gis-data-into-bigquery-8217dc370040?source=collection_archive---------1-----------------------#2022-08-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="aa7f" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">您是否想知道如何将地理定位的数据导入BigQuery？好了，不要再想了。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/f18cad7f176d0b3200b27fe39c43d6eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Vkc_J6SYIhfrng5p"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">美国宇航局在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><h1 id="3e2b" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">介绍</h1><p id="4f91" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">大数据不是很棒吗？确实是...它打开了分析世界的许多大门，设法在我们曾经认为不存在模式的地方找到了模式。关于这个主题已经做了很多工作，但不幸的是，大部分都是关于表格数据的。地理数据呢？是的，我们有许多处理地理数据的方法，但是这些方法真的适合大数据处理吗？答案听起来是否定的。</p><p id="2be9" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">幸运的是，我们现在可以通过使用BigQuery获得基于云的大数据处理的好处。BigQuery集成了几个GIS功能，允许我们以无服务器的方式操作非常大的地理表，优化后台查询，并消除GeoFunctions产生的巨大计算开销。</p><p id="0f82" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">本文将重点关注将地理数据摄取到BigQuery环境中。</p><h1 id="8fcf" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">1.使用CSV导入</h1><p id="db02" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">尽管可以轻松地将带有WKT编码的几何图形的csv导入BigQuery，然后将其直接转换为<em class="lh">地理</em>数据类型，但是我们为什么要采取这些额外的步骤呢？</p><p id="fd37" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">我们需要确保的第一件事是，我们有一个几何列为WKT(众所周知的文本)的表。WKT是普遍接受的几何编码方式:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es li"><img src="../Images/ed9142c6ec6528302d9dcd8558554372.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oddgJ8ifdivAHAF5ukAmTQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图片提供:www.codetd.com</figcaption></figure><p id="1a34" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">通常，Python中的大多数地理空间包，如<em class="lh"> geopandas </em>或<em class="lh"> shapely </em>都具有将几何图形直接转换为WKT格式的功能。请注意，在撰写本文时，BigQuery中只允许使用WGS84坐标，因此，如果需要，您可能需要将数据重新投影到WGS84中，但这超出了本文的范围。</p><p id="0c3b" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">这里的技巧是用预定义的模式加载数据。使用自动检测功能将不起作用，因为它会错误地认为几何图形是一个<em class="lh">字符串</em>而不是一个<em class="lh">地理位置</em>。</p><p id="ba5d" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">让我们看看我的样本文件:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lj"><img src="../Images/5a182f119f7981c8d16392c3872363fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oZxWjg70M98rMwFGAv2Ttw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">作者图片</figcaption></figure><p id="2ce7" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">然后，我们转到我们信任的Google Cloud SDK，在您的终端中运行命令:</p><pre class="iy iz ja jb fd lk ll lm ln aw lo bi"><span id="3b5f" class="lp jp hi ll b fi lq lr l ls lt">&gt; bq load --source_format=CSV --skip_leading_rows=1 --schema=metaid:INTEGER,geometry:GEOGRAPHY,MM:INTEGER,SGA:INTEGER,WPT:STRING,wem:INTEGER,loc:INTEGER MDIAS.SAMPLE_GIS ~/Documents/sample_gis.csv</span></pre><ul class=""><li id="bbc9" class="lu lv hi ki b kj lc km ld kp lw kt lx kx ly lb lz ma mb mc bi translated"><strong class="ki hj"> bq load </strong>:将数据加载到BigQuery中的命令</li><li id="8829" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated"><strong class="ki hj"> — source_format=CSV </strong>:表格的格式</li><li id="ad5e" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated"><strong class="ki hj"> — skip_leading_rows=1: </strong>跳过标题(第一行)</li><li id="0859" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated"><strong class="ki hj"> —模式</strong>:表的模式和数据类型，WKT列为<em class="lh">地理</em></li><li id="9bfc" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated">MDIAS。SAMPLE_GIS :您的{数据库}。BigQuery中的{table_name}</li><li id="9431" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated"><strong class="ki hj">~/Documents/sample _ GIS . CSV:</strong>我的原始文件存放的地方。</li></ul><blockquote class="mi mj mk"><p id="45ae" class="kg kh lh ki b kj lc ij kl km ld im ko ml le kr ks mm lf kv kw mn lg kz la lb hb bi translated">在我看来，这是将地理数据导入BigQuery并从一开始就准备好地理数据类型的最简单方法。如果您有应该定期刷新的表，并且模式没有变化，那么这是最理想的方法。</p></blockquote><p id="44f1" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">现在你知道了。让我们看看geoviz中的is:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mo"><img src="../Images/d2ad0530be123ed28056d702a3944635.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LgqGTp_1dq0hZgPgM82qfw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">谷歌GeoViz。:作者图片</figcaption></figure><h1 id="e15a" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">2.使用GeoJSON线导入</h1><p id="74af" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">另一种导入数据的方式是用<strong class="ki hj">GeoJSON Sequential</strong>(GeoJsonSeq)<strong class="ki hj">，</strong>也称为<strong class="ki hj">换行符GeoJSON </strong>甚至<strong class="ki hj"> GeoJSON行</strong> (geojsonl)。</p><p id="9742" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">GeoJSON是交换地理数据的一种非常常见的格式。然而，在GIS中，非常大的数据集是常见的，GeoJSON文件的结构通常需要将整个文件读入内存并一次性解码。此外，GeoJSONL只能使用WGS84投影进行编码。</p><p id="0c73" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">您可以借助地理操作工具(如<strong class="ki hj"> GDAL)将自己的shapefile或地理数据库转换为geojsonl文件。</strong>一旦安装了GDAL，您就可以运行:</p><pre class="iy iz ja jb fd lk ll lm ln aw lo bi"><span id="e362" class="lp jp hi ll b fi lq lr l ls lt">&gt; ogr2ogr -f "GeoJSONSeq" destination_file.geojsonl source_file.{geojson,shp,etc}</span></pre><p id="ca1c" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">请注意{geojson，shp等}意味着你可以有几种不同的格式，GDAL会识别并适当转换。这里只有阳光和彩虹。您可以像我们之前看到的那样执行简单的bq加载作业，例如:</p><pre class="iy iz ja jb fd lk ll lm ln aw lo bi"><span id="43db" class="lp jp hi ll b fi lq lr l ls lt">&gt; bq load --source_format=NEWLINE_DELIMITED_JSON --json_extension=GEOJSON --autodetect MDIAS.SAMPLE_GIS ~/Documents/sample_gis.geojsonl</span></pre><ul class=""><li id="e37a" class="lu lv hi ki b kj lc km ld kp lw kt lx kx ly lb lz ma mb mc bi translated"><strong class="ki hj"> bq load </strong>:将数据加载到BigQuery中的命令</li><li id="542a" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated"><strong class="ki hj">—source _ format = NEWLINE _ DELIMITED _ JSON</strong>:表格的格式</li><li id="68b2" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated"><strong class="ki hj">—JSON _ extension = GEOJSON</strong>:因为我们用的是geo JSON</li><li id="6a43" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated"><strong class="ki hj"> —自动检测</strong>:在这种情况下，我们可以只使用自动检测作为模式</li><li id="f5cc" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated"><strong class="ki hj"> MDIAS。SAMPLE_GIS </strong>:您的{数据库}。BigQuery中的{table_name}</li><li id="7ad7" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated"><strong class="ki hj">~/Documents/sample _ GIS . geojsonl</strong>:我的原始文件存放的地方。</li></ul><blockquote class="mi mj mk"><p id="72e9" class="kg kh lh ki b kj lc ij kl km ld im ko ml le kr ks mm lf kv kw mn lg kz la lb hb bi translated">这种方式很好，但是需要做大量的预处理。此外，根据我的经验，geojson lines虽然是一个优化的geojson，但它仍然比WKT编码的csv文件大得多，这将增加加载时间。尽管如此，这也是一个很好的进口。</p></blockquote><h1 id="04bf" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">3.数据已经加载，但尚未转换</h1><p id="58ea" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">假设您在BigQuery中已经有了纬度和经度的数据，甚至还有WKT字符串或GeoJSON字符串形式的几何数据。别担心。Google让你很容易地将其转换成地理数据类型。</p><h2 id="caa7" class="lp jp hi bd jq mp mq mr ju ms mt mu jy kp mv mw ka kt mx my kc kx mz na ke nb bi translated">经纬度</h2><p id="58bc" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">如果您的表中有纬度和经度，您所要做的就是使用ST_GEOGPOINT( <em class="lh">经度，纬度</em>)来创建您的几何图形。例如:</p><pre class="iy iz ja jb fd lk ll lm ln aw lo bi"><span id="a399" class="lp jp hi ll b fi lq lr l ls lt">with raw as (<br/>select value, latitude, longitude, ST_GEOGPOINT(longitude, latitude) as geometry <br/>from MDIAS.TEST<br/>)</span><span id="1c28" class="lp jp hi ll b fi nc lr l ls lt">-- Let's get the areas with a higher density of datapoints within 50 -- meters.<br/>select st_geogfromtext(geometry), cnt from(<br/>  select st_astext(raw.geometry) as geometry, count(*) as cnt<br/>  from raw<br/>  inner join raw raw2<br/>  on st_dwithin(raw.geometry, raw2.geometry, 50) -- 50meters<br/>  group by st_astext(raw.geometry)<br/>)</span></pre><p id="193c" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">这里它被视觉化了:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nd"><img src="../Images/c277a1f387958646addbec86810dc87a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LPkcbuLXRm00raBKr4nLXg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">Google GeoViz:作者图片</figcaption></figure><h2 id="a44f" class="lp jp hi bd jq mp mq mr ju ms mt mu jy kp mv mw ka kt mx my kc kx mz na ke nb bi translated">其他字符串</h2><p id="2622" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">如果您在其他外部格式下定义了几何图形，您所要做的就是使用正确的ST函数:</p><ul class=""><li id="230b" class="lu lv hi ki b kj lc km ld kp lw kt lx kx ly lb lz ma mb mc bi translated"><strong class="ki hj"> ST_GEOGFROM: </strong>会尝试弄清楚它是什么哪种格式，然后解析它。</li><li id="bc28" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated"><strong class="ki hj"> ST_GEOGFROMTEXT: </strong>将解析普通WKT字符串中的数据。例如:“点(52.5244，-110.3823)”</li><li id="e97a" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated"><strong class="ki hj"> ST_GEOGFROMGEOJSON </strong>:将解析GEOJSON几何字符串中的几何图形。例:"<em class="lh"> { "type": "Point "，" coordinates": [6.78204，51.24976] } </em>"</li></ul><p id="b5ab" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">您还可以使用其他函数，例如地理哈希或众所周知的二进制文件。您可以随时访问BigQuery GeoFunctions的文档:<a class="ae jn" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/geography_functions" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/reference/standard-SQL/geography _ functions</a></p><h1 id="ebe0" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">结论:</h1><ul class=""><li id="41ad" class="lu lv hi ki b kj kk km kn kp ne kt nf kx ng lb lz ma mb mc bi translated">BigQuery是进行大规模地理处理的领先工具之一。</li><li id="d51a" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated">为了导入地理表，可能需要做一些预处理。</li><li id="c41e" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated">目前，可以使用csv和geojson导入地理数据。尚不支持使用Shapefile进行摄取(但它在Google的路线图上)。</li><li id="559d" class="lu lv hi ki b kj md km me kp mf kt mg kx mh lb lz ma mb mc bi translated">如果在bigquery中已经有数据，那么只要有必要的属性(纬度、经度、wkt等)，就可以将其转换成地理数据。</li></ul><div class="nh ni ez fb nj nk"><a rel="noopener follow" target="_blank" href="/mlearning-ai/mlearning-ai-submission-suggestions-b51e2b130bfb"><div class="nl ab dw"><div class="nm ab nn cl cj no"><h2 class="bd hj fi z dy np ea eb nq ed ef hh bi translated">Mlearning.ai提交建议</h2><div class="nr l"><h3 class="bd b fi z dy np ea eb nq ed ef dx translated">如何成为Mlearning.ai上的作家</h3></div><div class="ns l"><p class="bd b fp z dy np ea eb nq ed ef dx translated">medium.com</p></div></div><div class="nt l"><div class="nu l nv nw nx nt ny jh nk"/></div></div></a></div></div></div>    
</body>
</html>