<html>
<head>
<title>Analyzing Google Cloud Billing Data with BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用BigQuery分析Google云计费数据</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/analyzing-google-cloud-billing-data-with-big-query-30bae1c2aae4?source=collection_archive---------0-----------------------#2017-06-08">https://medium.com/google-cloud/analyzing-google-cloud-billing-data-with-big-query-30bae1c2aae4?source=collection_archive---------0-----------------------#2017-06-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d3ab" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated">在本教程中，我们将在BigQuery中分析您的账单数据。然后，我们将探索该模式，并通过查询数据回答一些常见问题。</p><h2 id="0b4c" class="jl jm hi bd jn jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf bi translated">目标</h2><ul class=""><li id="53e5" class="kg kh hi ip b iq ki iu kj iy kk jc kl jg km jk kn ko kp kq bi translated">模式概述</li><li id="6d34" class="kg kh hi ip b iq kr iu ks iy kt jc ku jg kv jk kn ko kp kq bi translated">嵌套记录</li><li id="d87b" class="kg kh hi ip b iq kr iu ks iy kt jc ku jg kv jk kn ko kp kq bi translated">重复记录</li><li id="bb67" class="kg kh hi ip b iq kr iu ks iy kt jc ku jg kv jk kn ko kp kq bi translated">按月查看成本</li><li id="fc88" class="kg kh hi ip b iq kr iu ks iy kt jc ku jg kv jk kn ko kp kq bi translated">按项目查看成本</li><li id="6bd8" class="kg kh hi ip b iq kr iu ks iy kt jc ku jg kv jk kn ko kp kq bi translated">按项目和资源标签查看</li><li id="cf73" class="kg kh hi ip b iq kr iu ks iy kt jc ku jg kv jk kn ko kp kq bi translated">成本预测</li></ul><h2 id="1940" class="jl jm hi bd jn jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf bi translated">开始之前</h2><p id="e9cc" class="pw-post-body-paragraph in io hi ip b iq ki is it iu kj iw ix iy kw ja jb jc kx je jf jg ky ji jj jk hb bi translated">您需要为您的项目设置billing export to BigQuery。点击查看<a class="ae kz" href="https://support.google.com/cloud/answer/7233314?hl=en" rel="noopener ugc nofollow" target="_blank">流程或观看下面的简短视频</a></p><figure class="la lb lc ld fd le"><div class="bz dy l di"><div class="lf lg l"/></div></figure><h2 id="c7a1" class="jl jm hi bd jn jo jp jq jr js jt ju jv iy jw jx jy jc jz ka kb jg kc kd ke kf bi translated">模式概述</h2><p id="e572" class="pw-post-body-paragraph in io hi ip b iq ki is it iu kj iw ix iy kw ja jb jc kx je jf jg ky ji jj jk hb bi translated">让我们熟悉一下数据集。有一个公开的数据集，我们可以用它来做演示。您需要更新这里的查询，以反映您自己的数据集名称。</p><p id="793c" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated"><a class="ae kz" href="https://bigquery.cloud.google.com/table/data-analytics-pocs:public.gcp_billing_export_EXAMPL_E0XD3A_DB33F1" rel="noopener ugc nofollow" target="_blank">计费数据集样本</a></p><p id="f8d8" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated">我喜欢做的第一件事是点击<strong class="ip hj">预览</strong>来感受我们正在处理的事情。</p><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/2d8ee6df765a6b480da0f56c4b3feea7.png" data-original-src="https://miro.medium.com/v2/format:webp/1*1kaLXntUI-yADDjBA35jUg.png"/></div></figure><p id="d46d" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated">查看模式，你会看到你所期望的:高级的<strong class="ip hj">产品</strong>区域，细粒度的<strong class="ip hj">资源类型</strong>行项目，<strong class="ip hj">开始时间</strong>，<strong class="ip hj">成本</strong></p><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/bb2a743aff35dd894b911c0465905fe5.png" data-original-src="https://miro.medium.com/v2/format:webp/1*xeE8l5xgydh_LnRpW9X8LA.png"/></div></figure><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/2b539127505fa0dc20a75b693eac22e7.png" data-original-src="https://miro.medium.com/v2/format:webp/1*1YcMKiVs5oN_mU6TBdcMcQ.png"/></div></figure><h1 id="56d9" class="lk jm hi bd jn ll lm ln jr lo lp lq jv lr ls lt jy lu lv lw kb lx ly lz ke ma bi translated">嵌套字段</h1><p id="010a" class="pw-post-body-paragraph in io hi ip b iq ki is it iu kj iw ix iy kw ja jb jc kx je jf jg ky ji jj jk hb bi translated">还有关于项目和使用的嵌套数据。这些是简单的嵌套记录，所以我们可以用点符号来访问它们</p><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/ba82bae3f77ebb44489a1bd00ccc9b14.png" data-original-src="https://miro.medium.com/v2/format:webp/1*e9jqkuRM78dNC7Evgp1NJg.png"/></div></figure><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/4d59c89148a941cd1afcfe730d730400.png" data-original-src="https://miro.medium.com/v2/format:webp/1*wCpXgI6jkMPB37VEM0Psmg.png"/></div></figure><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/d51b14df24c68e8dac04590676bd9ad3.png" data-original-src="https://miro.medium.com/v2/format:webp/1*wgRfk3vIS-6FCCl-19ty3Q.png"/></div></figure><h1 id="47fc" class="lk jm hi bd jn ll lm ln jr lo lp lq jv lr ls lt jy lu lv lw kb lx ly lz ke ma bi translated">重复字段</h1><p id="5dfb" class="pw-post-body-paragraph in io hi ip b iq ki is it iu kj iw ix iy kw ja jb jc kx je jf jg ky ji jj jk hb bi translated">在重复字段中还有一些有趣的附加信息。此数据类型包含给定行的多条记录。因此，在配额的情况下，资源费用数据集中的一个记录可能有多个相关联的配额。</p><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/b80fb10c68cf3ea673ed955f96438c2c.png" data-original-src="https://miro.medium.com/v2/format:webp/1*lPJZHaVyYyuChZlLRJPcNQ.png"/></div></figure><p id="c89b" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated">我们需要像对待一组独立的数据一样对待重复的字段。让我们将所有信用记录聚合为一个行值。为此，我们将使用UNNEST函数。我还将切换并使用StandardSQL语法中的一些可用函数。</p><blockquote class="mb mc md"><p id="1b99" class="in io me ip b iq ir is it iu iv iw ix mf iz ja jb mg jd je jf mh jh ji jj jk hb bi translated">BigQuery支持两种查询语法，LegacySQL和StandardSQL。</p><p id="328b" class="in io me ip b iq ir is it iu iv iw ix mf iz ja jb mg jd je jf mh jh ji jj jk hb bi translated">主要区别是:<br/> -引用表格的格式<br/> -在查询中使用不同的函数</p><p id="46a2" class="in io me ip b iq ir is it iu iv iw ix mf iz ja jb mg jd je jf mh jh ji jj jk hb bi translated">要明确识别您使用的语法类型，只需用#standardSQL或#legacySql开始查询</p><p id="2e22" class="in io me ip b iq ir is it iu iv iw ix mf iz ja jb mg jd je jf mh jh ji jj jk hb bi translated">今后我将使用#standardSQL</p></blockquote><pre class="la lb lc ld fd mi mj mk ml aw mm bi"><span id="cf7e" class="jl jm hi mj b fi mn mo l mp mq">#standardSQL<br/>SELECT<br/>   cost,<br/>   (SELECT SUM(amount) FROM UNNEST(credits)) credits</span><span id="3cff" class="jl jm hi mj b fi mr mo l mp mq">FROM <!-- -->data-analytics-pocs.public.gcp_billing_export_EXAMPL_E0XD3A_DB33F1</span><span id="2127" class="jl jm hi mj b fi mr mo l mp mq">LIMIT 1000</span></pre><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/21526758d6a1260c6f51fa965dffd575.png" data-original-src="https://miro.medium.com/v2/format:webp/1*5pW_KhdEbtfL_MD1AXrsEA.png"/></div></figure><p id="39d7" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated">厉害！因此，我们现在正在聚合嵌套字段，但看起来学分并不经常发生。让我们汇总所有这些数据，并按月查看</p><h1 id="e41e" class="lk jm hi bd jn ll lm ln jr lo lp lq jv lr ls lt jy lu lv lw kb lx ly lz ke ma bi translated">按月查看数据</h1><p id="2e50" class="pw-post-body-paragraph in io hi ip b iq ki is it iu kj iw ix iy kw ja jb jc kx je jf jg ky ji jj jk hb bi translated">因此，这里我们进入标准的SQL聚合模式，按字段进行分组。然而，为了获得月份，我们将在<strong class="ip hj"> start_time </strong>字段上使用<code class="du ms mt mu mj b">EXTRACT</code>函数</p><pre class="la lb lc ld fd mi mj mk ml aw mm bi"><span id="60b7" class="jl jm hi mj b fi mn mo l mp mq">#standardSQL<br/>SELECT</span><span id="58b8" class="jl jm hi mj b fi mr mo l mp mq">   EXTRACT(MONTH FROM starttime) as month,<br/>   ROUND(SUM(cost), 2) as charges,<br/>   ROUND(SUM((SELECT SUM(amount) FROM UNNEST(credits))),2) as credits</span><span id="a4ab" class="jl jm hi mj b fi mr mo l mp mq">FROM data-analytics-pocs.public.gcp_billing_export_EXAMPL_E0XD3A_DB33F1<br/>GROUP BY month<br/>ORDER by month</span></pre><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/0f21f5dab703ba6e7074ad512d71c0cc.png" data-original-src="https://miro.medium.com/v2/format:webp/1*5osIsxhtSEHTWFb2DzLM8w.png"/></div></figure><blockquote class="mb mc md"><p id="83b4" class="in io me ip b iq ir is it iu iv iw ix mf iz ja jb mg jd je jf mh jh ji jj jk hb bi translated">等等，为什么我们要加两次学分？</p><p id="f572" class="in io me ip b iq ir is it iu iv iw ix mf iz ja jb mg jd je jf mh jh ji jj jk hb bi translated">回想一下，对于数据集中的每一行，都可以有多个配额。内部总和是按行合计学分。此外，尽管这里我们是按月合计每一行，这也是外部总和的来源。然后我们把它弄圆，使它看起来更好。</p><p id="cfa6" class="in io me ip b iq ir is it iu iv iw ix mf iz ja jb mg jd je jf mh jh ji jj jk hb bi translated">从里到外分解<br/> a .从UNNEST(credits)//按行聚合<br/>中选择SUM(amount)b . SUM(a)//按(month) <br/>为分组聚合c. ROUND(b，2)作为credits //四舍五入到2位</p><p id="91cf" class="in io me ip b iq ir is it iu iv iw ix mf iz ja jb mg jd je jf mh jh ji jj jk hb bi translated">结果:<br/> ROUND(SUM((从UNNEST(credits)中选择SUM(amount)))，2)作为信用</p></blockquote><h1 id="fe5e" class="lk jm hi bd jn ll lm ln jr lo lp lq jv lr ls lt jy lu lv lw kb lx ly lz ke ma bi translated">按项目查看数据</h1><p id="ecf2" class="pw-post-body-paragraph in io hi ip b iq ki is it iu kj iw ix iy kw ja jb jc kx je jf jg ky ji jj jk hb bi translated">所以现在我们可以继续这个过程来观察数据的变化。让我们按项目、按月查看成本</p><pre class="la lb lc ld fd mi mj mk ml aw mm bi"><span id="d76f" class="jl jm hi mj b fi mn mo l mp mq">#standardSQL<br/>SELECT<br/>   project.name as project,<br/>   EXTRACT(MONTH FROM starttime) as month,<br/>   ROUND(SUM(cost), 2) as charges,<br/>   ROUND(SUM((SELECT SUM(amount) FROM UNNEST(credits))),2) as credits</span><span id="cb20" class="jl jm hi mj b fi mr mo l mp mq">FROM data-analytics-pocs.public.gcp_billing_export_EXAMPL_E0XD3A_DB33F1<br/>GROUP BY project, month<br/>ORDER by project, month</span></pre><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/b9b25a17cec27d4cbb14d76bb21e3705.png" data-original-src="https://miro.medium.com/v2/format:webp/1*UJjdeyo4l4S5SORjsSF5Lg.png"/></div></figure><h1 id="71f3" class="lk jm hi bd jn ll lm ln jr lo lp lq jv lr ls lt jy lu lv lw kb lx ly lz ke ma bi translated">按标签查看数据</h1><p id="d845" class="pw-post-body-paragraph in io hi ip b iq ki is it iu kj iw ix iy kw ja jb jc kx je jf jg ky ji jj jk hb bi translated">回头看看这个模式，我们看到了几个重复的字段，<strong class="ip hj">项目标签</strong>和<strong class="ip hj">标签</strong></p><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/6c1b0961357fd735871f8cfd4e6bf8de.png" data-original-src="https://miro.medium.com/v2/format:webp/1*0h1gQ5_6t3MBiFpJttA4MQ.png"/></div></figure><p id="7fc3" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated">谷歌提供<a class="ae kz" href="https://cloud.google.com/resource-manager/docs/using-labels" rel="noopener ugc nofollow" target="_blank">标签</a>来帮助组织资源。当您在资源上设置它们时，它们也被传递到计费数据中。</p><p id="5fed" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated"><strong class="ip hj"> project.labels </strong>包含在项目本身上设置的键/值对。<strong class="ip hj">标签</strong>包含记录行的资源上的键/值对。</p><p id="09aa" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated">让我们按project.labels分组，看看这是如何工作的</p><pre class="la lb lc ld fd mi mj mk ml aw mm bi"><span id="cc3a" class="jl jm hi mj b fi mn mo l mp mq">#standardSQL<br/>SELECT</span><span id="8413" class="jl jm hi mj b fi mr mo l mp mq">   (SELECT value from UNNEST(project.labels) where key = “env”) env,<br/>   ROUND(SUM(cost), 2) as charges,<br/>   ROUND(SUM((SELECT SUM(amount) FROM UNNEST(credits))),2) as credits</span><span id="4d74" class="jl jm hi mj b fi mr mo l mp mq">FROM data-analytics-pocs.public.gcp_billing_export_EXAMPL_E0XD3A_DB33F1<br/>GROUP BY env</span></pre><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/722302911a291b697e1276943af06232.png" data-original-src="https://miro.medium.com/v2/format:webp/1*R_N3LU7oyloHA5Nxz-2zYQ.png"/></div></figure><p id="8cb2" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated">在上面的例子中，项目用关键字env和值qa、dev、stage、prod标记。</p><p id="c193" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated">资源标签的过程是相同的</p><pre class="la lb lc ld fd mi mj mk ml aw mm bi"><span id="aee9" class="jl jm hi mj b fi mn mo l mp mq">#standardSQL<br/>SELECT<br/>   (SELECT value from UNNEST(labels) where key = “service”) service,<br/>   ROUND(SUM(cost), 2) as charges,<br/>   ROUND(SUM((SELECT SUM(amount) FROM UNNEST(credits))),2) as credits</span><span id="ba60" class="jl jm hi mj b fi mr mo l mp mq">FROM data-analytics-pocs.public.gcp_billing_export_EXAMPL_E0XD3A_DB33F1<br/>GROUP BY service</span></pre><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/a69b21c3ec9d5fe77197ad90e2109630.png" data-original-src="https://miro.medium.com/v2/format:webp/1*Mbz5TdMTo7TyDP835L3nYw.png"/></div></figure><p id="a07c" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated">在本例中，团队将他们的资源标记为应用程序或服务。通过使用标签重复字段，我们可以将成本分配回每个应用领域。</p><h1 id="030f" class="lk jm hi bd jn ll lm ln jr lo lp lq jv lr ls lt jy lu lv lw kb lx ly lz ke ma bi translated">成本预测</h1><p id="d0be" class="pw-post-body-paragraph in io hi ip b iq ki is it iu kj iw ix iy kw ja jb jc kx je jf jg ky ji jj jk hb bi translated">在这一点上你能做的真的没有止境。使用内置的sql函数，您可以根据需要进行切分。</p><p id="843a" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated">在这个由迈克·金妮和瑞安·麦克道尔提供的<a class="ae kz" href="https://bigquery.cloud.google.com/savedquery/631705076856:51948ac7b8554b5f93b222008bfdbce9" rel="noopener ugc nofollow" target="_blank">保存的查询</a>中，他们从现有的账单数据中预测未来的费用，所有这些都在BigQuery中</p><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lh"><img src="../Images/07bc09c7363af33a09896ec548eb6ea0.png" data-original-src="https://miro.medium.com/v2/format:webp/1*v3jtWjydJZq9nopanrTWuQ.png"/></div></figure><p id="1811" class="pw-post-body-paragraph in io hi ip b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk hb bi translated">快乐分析！</p></div></div>    
</body>
</html>