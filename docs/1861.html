<html>
<head>
<title>Simple Period-to-Date Comparisons in BigQuery (via Colab or Looker)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery中简单的期初至今比较(通过Colab或Looker)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/simple-period-to-date-comparisons-in-bigquery-via-colab-or-looker-1525f26d1cdd?source=collection_archive---------0-----------------------#2021-04-24">https://medium.com/google-cloud/simple-period-to-date-comparisons-in-bigquery-via-colab-or-looker-1525f26d1cdd?source=collection_archive---------0-----------------------#2021-04-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="971c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用SQL执行逐期分析似乎总是感觉很复杂。如果你和我一样，每次你需要做一些“迄今为止”的比较时，你都会在谷歌上搜索你可以利用的查询示例。希望这篇文章能让你的搜索更有收获！</p><p id="5379" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我将分解我们如何使用BigQuery来执行一个简单的分析，我们希望查看周至今(WTD)、月至今(MTD)、季至今(QTD)或年至今(YTD)的聚合，并将它们与前一期(即上周/月/季/年直到同一天)进行比较。</p><p id="28ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我将使用Google Colab 中的iPythonNotebook浏览一个Python示例。接下来我会用<a class="ae jd" href="https://docs.looker.com/data-modeling/learning-lookml/what-is-lookml" rel="noopener ugc nofollow" target="_blank"> LookML </a>、<a class="ae jd" href="https://looker.com/" rel="noopener ugc nofollow" target="_blank"> Looker的</a>造型语言来展示。在本例中，当前日期为<strong class="ih hj">2021–04–13。</strong></p><p id="4e96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用Google Colab (f </strong> <a class="ae jd" href="https://gist.github.com/leighajarett/ba348798714d2dc3f520bd3acda6c140" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">此处为</strong> </a> <strong class="ih hj"> ) </strong></p><p id="4a7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从一个用户输入的参数开始，该参数代表我们考虑的时间段—周、月、季度或年。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="660f" class="jn jo hi jj b fi jp jq l jr js">timeframe = "quarter" #@param ["week", "month", "quarter","year"]</span></pre><p id="e772" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个代码片段允许您从笔记本的下拉列表中选择时间范围。这里，我们选择了<strong class="ih hj">季度</strong>。</p><figure class="je jf jg jh fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es jt"><img src="../Images/f0bc281f0fce54bc3a50d9dfbed70af4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ApoD2kOldmLyp5ytFNBVog.png"/></div></div></figure><p id="e60f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们要做的第一件事是确定我们正在考虑的本期的<em class="kb">开始日期。在BigQuery中，我们可以使用<a class="ae jd" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/date_functions" rel="noopener ugc nofollow" target="_blank"> DATE_TRUNC </a>函数很容易地做到这一点，该函数允许我们将一个日期值截断成一个特定的时间段。BigQuery返回该时间段的第一个日期。</em></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="0e9f" class="jn jo hi jj b fi jp jq l jr js">query = "SELECT DATE_TRUNC(CURRENT_DATE(),{timeframe}) as current_period_start".format(timeframe=timeframe)</span><span id="7e29" class="jn jo hi jj b fi kc jq l jr js">&gt;&gt;&gt; 2021-04-01 (first day of the current quarter)</span></pre><p id="9d12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们需要确定前期的<em class="kb">开始日期。</em>在这种情况下，我们可以使用<a class="ae jd" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/date_functions#date_sub" rel="noopener ugc nofollow" target="_blank"> DATE_SUB </a>从当前日期中减去时间段，然后使用DATE_TRUNC函数再次获取该时间段中的第一个日期。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="fb9c" class="jn jo hi jj b fi jp jq l jr js">query = "SELECT DATE_TRUNC(DATE_SUB(CURRENT_DATE(), INTERVAL 1 {timeframe}), {timeframe}) as prior_period_start".format(timeframe=timeframe)</span><span id="f497" class="jn jo hi jj b fi kc jq l jr js">&gt;&gt;&gt; 2021-01-01 (first day of previous quarter)</span></pre><p id="d45b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们想确定前一时段的最后一天<em class="kb">。</em>我们希望本期和前期的天数相同，因此我们需要首先使用<a class="ae jd" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/date_functions#date_diff" rel="noopener ugc nofollow" target="_blank"> DATE_DIFF </a>来计算本期的总天数，然后使用<a class="ae jd" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/date_functions#date_add" rel="noopener ugc nofollow" target="_blank"> DATE_ADD </a>将结果添加到我们的前期开始。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="524a" class="jn jo hi jj b fi jp jq l jr js">query = """SELECT DATE_ADD(DATE_TRUNC(DATE_SUB(CURRENT_DATE(), INTERVAL 1 {timeframe}), {timeframe}), INTERVAL DATE_DIFF(CURRENT_DATE(), DATE_TRUNC(CURRENT_DATE(),{timeframe}), DAY) DAY) as prior_period_end""".format(timeframe=timeframe)</span><span id="4783" class="jn jo hi jj b fi kc jq l jr js">&gt;&gt;&gt; 2021-01-13 (last day that we will consider in prior quarter)</span></pre><p id="40b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们可以使用case语句将每个日期分类为在我们的<em class="kb">当前时间段</em>、<em class="kb">先前时间段</em>或<em class="kb"> NULL </em>(在我们关心的时间段之外)，并使用它作为我们的字段进行聚合。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="e980" class="jn jo hi jj b fi jp jq l jr js">query = """SELECT</span><span id="9bf9" class="jn jo hi jj b fi kc jq l jr js">--my date is after the current period start<br/>CASE WHEN {my_date_column} &gt;=  DATE_TRUNC(CURRENT_DATE(),{timeframe}) THEN 'This {timeframe} to Date'</span><span id="e67a" class="jn jo hi jj b fi kc jq l jr js">--my date is between the prior period start and end<br/>WHEN {my_date_column} &gt;= DATE_TRUNC(DATE_SUB(CURRENT_DATE(), INTERVAL 1 {timeframe}), {timeframe}) AND {my_date_column} &lt;= DATE_ADD(DATE_TRUNC(DATE_SUB(CURRENT_DATE(), INTERVAL 1 {timeframe}), {timeframe}), INTERVAL DATE_DIFF(CURRENT_DATE(), DATE_TRUNC(CURRENT_DATE(),{timeframe}), DAY) DAY) THEN 'Prior {timeframe} to Date' ELSE NULL END as time_period,</span><span id="47ec" class="jn jo hi jj b fi kc jq l jr js">--sum up the specified column and group by period to aggregate<br/>round(sum({my_summed_column}),2) as total<br/>from {my_table}<br/>group by 1""".format(timeframe=timeframe, </span><span id="b40f" class="jn jo hi jj b fi kc jq l jr js"># enter in your own values here!<br/>my_table="ecomm.order_items", my_summed_column="sale_price",      my_date_column="date(created_at)")</span><span id="0fe9" class="jn jo hi jj b fi kc jq l jr js">&gt;&gt;&gt; Prior quarter to Date: 174868.86 <br/>&gt;&gt;&gt; This quarter to Date: 179155.37<br/></span></pre><p id="597a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将所有这些放在一起，您就有了一个自助式的“期初至今”分析！</p><figure class="je jf jg jh fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kd"><img src="../Images/94cb89a9efa70acde6a8dac73989e4da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*JrUsI8IdttnUVVGGIM2udw.gif"/></div></div></figure><p id="6d53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用Looker ( </strong> <a class="ae jd" href="https://gist.github.com/leighajarett/ba348798714d2dc3f520bd3acda6c140" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">完整LookML文件此处</strong> </a> <strong class="ih hj"> ) </strong></p><p id="ad42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Looker中，我们可以使用这些查询在LookML中创建不同的维度。首先，我们创建一个参数，允许用户选择感兴趣的时间范围。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="402c" class="jn jo hi jj b fi jp jq l jr js">parameter: timeframe {<br/>    view_label: "Period over Period"<br/>    type: unquoted<br/>    allowed_value: {<br/>      label: "Week to Date"<br/>      value: "Week"<br/>    }<br/>    allowed_value: {<br/>      label: "Month to Date"<br/>      value: "Month"<br/>    }    <br/>    allowed_value: {<br/>      label: "Quarter to Date"<br/>      value: "Quarter"<br/>    }<br/>    allowed_value: {<br/>      label: "Year to Date"<br/>      value: "Year"<br/>    }<br/>    default_value: "Quarter"<br/>  }</span></pre><p id="044c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们通过将当前日期截断到我们选择的时间范围来计算当前周期的<em class="kb">开始日期</em></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="f711" class="jn jo hi jj b fi jp jq l jr js">dimension: first_date_in_period {<br/>    view_label: "Period over Period"<br/>    type: date<br/>    sql: DATE_TRUNC(CURRENT_DATE(), {% parameter timeframe %});;<br/>  }</span></pre><p id="7241" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们将通过计算当前日期和时间段中第一个日期之间的差值来计算时间段中的<em class="kb">总天数</em></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="7e77" class="jn jo hi jj b fi jp jq l jr js">dimension: days_in_period {<br/>    view_label: "Period over Period"<br/>    type: number<br/>    sql: DATE_DIFF(CURRENT_DATE(),${first_date_in_period}, DAY) ;;<br/>  }</span></pre><p id="8e0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们从当前日期中减去一个时间范围，得到前一周期中的<em class="kb">第一个日期，并将该值截断到时间范围中的第一个日期。</em></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="83e0" class="jn jo hi jj b fi jp jq l jr js">dimension: first_date_in_prior_period {<br/>    view_label: "Period over Period"<br/>    type: date<br/>    hidden: no<br/>    sql: DATE_TRUNC(DATE_SUB(CURRENT_DATE(), INTERVAL 1 {% parameter timeframe %}),{% parameter timeframe %});;<br/>  }</span></pre><p id="3cb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，通过将前一个周期的开始日期加上该周期的总天数，得到前一个周期的最后日期<em class="kb">。</em></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="b1eb" class="jn jo hi jj b fi jp jq l jr js">dimension: last_date_in_prior_period {<br/>    view_label: "Period over Period"<br/>    type: date<br/>    hidden: no<br/>    sql: DATE_ADD(${first_date_in_prior_period}, INTERVAL ${days_in_period} DAY) ;;<br/>  }</span></pre><p id="9516" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，计算每个日期属于哪个时间段。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="9b82" class="jn jo hi jj b fi jp jq l jr js">dimension: period_selected {<br/>    view_label: "Period over Period"<br/>    type: string<br/>    sql:<br/>        CASE<br/>          WHEN ${my_date} &gt;=  ${first_date_in_period}<br/>          THEN 'This {% parameter timeframe %} to Date'<br/>          WHEN ${my_date} &gt;= ${first_date_in_prior_period}<br/>          AND ${my_date} &lt;= ${last_date_in_prior_period}<br/>          THEN 'Prior {% parameter timeframe %} to Date'<br/>          ELSE NULL<br/>          END ;;<br/>  }</span></pre><p id="2b9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们的用户可以进入探索，并选择感兴趣的时间段。</p><figure class="je jf jg jh fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es ke"><img src="../Images/c4bc883cee003fb1f5887a65f1446fca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SMM-OnkYvAHwSdid8iyfig.png"/></div></div></figure><p id="9803" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你有兴趣了解更多关于BigQuery或Looker的信息，<strong class="ih hj">关注我的</strong><a class="ae jd" href="https://www.linkedin.com/in/leighajarett/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">Linkedin</strong></a><strong class="ih hj">和</strong><a class="ae jd" href="https://twitter.com/LeighaJarett" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">Twitter</strong></a><strong class="ih hj">@ LeighaJarett。</strong>请随时给我发送问题或反馈！</p></div></div>    
</body>
</html>