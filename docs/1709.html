<html>
<head>
<title>Google Apps Script deployment with Cloud Build</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用云构建的Google Apps脚本部署</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-apps-script-deployment-with-cloud-build-d9d0abf7dcf8?source=collection_archive---------0-----------------------#2020-12-13">https://medium.com/google-cloud/google-apps-script-deployment-with-cloud-build-d9d0abf7dcf8?source=collection_archive---------0-----------------------#2020-12-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8a50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Apps脚本可以超越解决问题的简单脚本。在本文中，我将展示如何在企业环境中部署Google Apps脚本代码。我将分享实际的构建文件以及必要的步骤和工具来重现我的工作流。这种方法确实需要谷歌云平台知识和信用卡。这些说明是高层次的，本文不是代码实验室。如果你卡住了，留下评论，我会尽力协助和更新文章。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/bf68427cb2eff1463523d1271ccf87e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hpGdwgTJIUJhiYwU"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">大卫·吉尔伯森在<a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="1635" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我使用Google Apps脚本解决一个问题时，我会在三个工作流之间进行选择:</p><ul class=""><li id="0216" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated"><a class="ae jt" href="https://workspaceupdates.googleblog.com/2020/12/google-apps-script-ide-better-code-editing.html" rel="noopener ugc nofollow" target="_blank">最近更新了</a>，Apps脚本IDE。</li><li id="3b4f" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><a class="ae jt" href="https://git-scm.com/" rel="noopener ugc nofollow" target="_blank"> Git </a>，<a class="ae jt" href="https://github.com/google/clasp" rel="noopener ugc nofollow" target="_blank">扣子</a>和<a class="ae jt" href="https://shell.cloud.google.com/?show=ide&amp;environment_deployment=ide" rel="noopener ugc nofollow" target="_blank">云壳编辑器</a></li><li id="7422" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated"><a class="ae jt" href="https://git-scm.com/" rel="noopener ugc nofollow" target="_blank"> Git </a>，<a class="ae jt" href="https://github.com/google/clasp" rel="noopener ugc nofollow" target="_blank"> clasp </a>，<a class="ae jt" href="https://shell.cloud.google.com/?show=ide&amp;environment_deployment=ide" rel="noopener ugc nofollow" target="_blank">云壳编辑器</a>，<a class="ae jt" href="https://cloud.google.com/source-repositories" rel="noopener ugc nofollow" target="_blank">云源库</a>，以及<a class="ae jt" href="https://cloud.google.com/cloud-build" rel="noopener ugc nofollow" target="_blank">云构建</a></li></ul><p id="156c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">新的应用程序脚本IDE非常棒。然而，它缺少企业环境所要求的一些特性，比如版本控制和持续部署(CD)。<a class="ae jt" href="https://cloud.google.com/blog/products/application-development/introducing-cloud-shell-editor" rel="noopener ugc nofollow" target="_blank">云壳编辑器</a>是一个巨大的进步。我强烈建议去https://ide.cloud.google.com试一试。Clasp和Git已经安装在终端中。</p><p id="ee78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是我们谈论的是企业级，所以为什么要保持简单。事实上，使用CD有很多好处。当CD管道就位时，部署脚本、分离职责和支持代码的多个版本和实现就变得容易了。使用Git规定了版本控制，像<a class="ae jt" href="https://keepachangelog.com/en/1.0.0/" rel="noopener ugc nofollow" target="_blank">保存一个变更日志</a>和<a class="ae jt" href="https://www.makeareadme.com/" rel="noopener ugc nofollow" target="_blank">制作一个自述文件</a>这样的项目在这样的结构中是有意义的。</p><p id="bb9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对我来说，使用CD最重要的好处是它能让我保持心态。它提供了一个环境，在这个环境中，我对在我的应用程序中创建小的增量更改感到自信和安全。播客:<a class="ae jt" href="https://cd.foundation/podcast/" rel="noopener ugc nofollow" target="_blank">The Pipeline:All things CD&amp;CD Foundation</a>的DevOps播客很好地解释了这一点。</p><h2 id="2eb3" class="ki kj hi bd kk kl km kn ko kp kq kr ks iq kt ku kv iu kw kx ky iy kz la lb lc bi translated">动手，我们如何设置它</h2><p id="ef8f" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">我通常从资源库<a class="ae jt" href="https://source.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">https://source.cloud.google.com/</a>开始。这将需要一个启用计费的GCP项目。一旦你创建了你的库，启动<a class="ae jt" href="https://ide.cloud.google.com" rel="noopener ugc nofollow" target="_blank">https://ide.cloud.google.com</a>。</p><p id="69a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开终端并创建存储库的本地克隆。使用三个选项之一来克隆存储库。一旦存储库被克隆，您就可以将新目录作为工作区打开。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es li"><img src="../Images/9a156344ba3628514021acc023f13461.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C4zLoJPm7Va2IwdlDlRluw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">存储库屏幕</figcaption></figure><p id="c270" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，您应该在工作区中打开一个空的存储库。下一步是获取clasp凭证。我们在云构建中需要这些凭证。在下面键入命令，并按照说明进行操作。使用您想要在云构建中使用的帐户进行授权。</p><pre class="je jf jg jh fd lj lk ll lm aw ln bi"><span id="107c" class="ki kj hi lk b fi lo lp l lq lr">clasp login --no-localhost</span></pre><p id="0562" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果一切顺利，凭证保存在文件~/.clasprc.json中，我们稍后会用到它。</p><h2 id="7fbf" class="ki kj hi bd kk kl km kn ko kp kq kr ks iq kt ku kv iu kw kx ky iy kz la lb lc bi translated">谷歌表单</h2><p id="6dc1" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">用clasp本身创建一个脚本是可能的，但是在这种情况下，我们将保持它的简单性并使用一个Google Sheet。因此，在这一点上，创建一个谷歌表，并打开脚本编辑器。找到脚本id，并在终端中键入以下命令:</p><pre class="je jf jg jh fd lj lk ll lm aw ln bi"><span id="eb4f" class="ki kj hi lk b fi lo lp l lq lr">clasp clone [script id]</span></pre><p id="d0e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建。git忽略文件并添加。theia和. clasp.json .接下来将来自Google Docs、Sheets、Slides或Forms 中的<a class="ae jt" href="https://developers.google.com/apps-script/guides/menus#custom_menus_in_google_docs_sheets_slides_or_forms" rel="noopener ugc nofollow" target="_blank">自定义菜单的示例代码添加到Code.js文件中。</a></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ls"><img src="../Images/3da6cbcb051edab8081680a0f6c5bdec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_7YG8HFHa9fQoONTTni17Q.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">这是您应该在编辑器中看到的内容</figcaption></figure><p id="e2ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们需要创建cloudbuild.yaml文件:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lt lu l"/></div></figure><p id="b272" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有代码现在都已就绪。在真实的实时部署中，一定要考虑<a class="ae jt" href="https://keepachangelog.com/en/1.0.0/" rel="noopener ugc nofollow" target="_blank">保留一个变更日志</a>和<a class="ae jt" href="https://www.makeareadme.com/" rel="noopener ugc nofollow" target="_blank">制作一个自述文件</a>。现在您可以提交代码了。Git将要求您进行一些配置:</p><pre class="je jf jg jh fd lj lk ll lm aw ln bi"><span id="b525" class="ki kj hi lk b fi lo lp l lq lr">git config --global user.email "git@example.com"<br/>git config --global user.name "Git Example"</span></pre><p id="f8fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">推送代码并检查代码是否在存储库中</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lv"><img src="../Images/e0c4d609e25301808e5862377db9c574.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PIWh7Qm9f4vSqo3o6BoOmw.png"/></div></div></figure><p id="c370" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们可以开始构建了。转到<a class="ae jt" href="https://cloud.google.com/cloud-build" rel="noopener ugc nofollow" target="_blank">云构建</a>并创建一个新的<a class="ae jt" href="https://console.cloud.google.com/cloud-build/triggers" rel="noopener ugc nofollow" target="_blank">触发器</a>。给触发器一个名称，并连接到正确的存储库。现在使用以下设置:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lw"><img src="../Images/7460ad1f518301ef6a568d51bb0519e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1094/format:webp/1*N_Q-SWPlUUSD4WPqKvwcBA.png"/></div></figure><p id="dae0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">也添加替代变量，使用您自己的脚本id。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lx"><img src="../Images/5486f830dbf8f3b5253a1c59c1707297.png" data-original-src="https://miro.medium.com/v2/resize:fit:1114/format:webp/1*8nQrMa-EO1ztyeCI49EOaA.png"/></div></figure><p id="295d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这一步中，我们将存储clasp的令牌。转到<a class="ae jt" href="https://console.cloud.google.com/security/secret-manager" rel="noopener ugc nofollow" target="_blank">秘密管理器</a>并创建一个新的秘密扣扣id。秘密的值是. clasprc.json文件的内容。</p><pre class="je jf jg jh fd lj lk ll lm aw ln bi"><span id="5f9a" class="ki kj hi lk b fi lo lp l lq lr">cat ~/.clasprc.json</span></pre><p id="4af8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">云构建需要访问机密，找到服务帐户并在<a class="ae jt" href="https://console.cloud.google.com/access/iam" rel="noopener ugc nofollow" target="_blank"> AIM </a>中分配角色Secret Accessor:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ly"><img src="../Images/bb66f0e80390631c1e55a5e4ea473f20.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*UyqSvZ30v7C3lAWVQp65xg.png"/></div></figure><h2 id="38cf" class="ki kj hi bd kk kl km kn ko kp kq kr ks iq kt ku kv iu kw kx ky iy kz la lb lc bi translated">深呼吸，快到了</h2><p id="04bb" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">这个装置中有许多活动部件。我们有一个谷歌表单、一个Git存储库、一个构建触发器和一个云秘密。当像v1.0-prod这样的标签被推送到Git存储库时，触发器将触发一个构建。构建将执行以下步骤:</p><ul class=""><li id="bffd" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">通过将云秘密值推入. clasprc.json文件来认证clasp</li><li id="e768" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">用脚本id创建. clasp.json文件</li><li id="355d" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">安装卡扣</li><li id="4ef9" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">将代码推送到脚本</li></ul><p id="f445" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，如果我们在终端中键入以下内容:</p><pre class="je jf jg jh fd lj lk ll lm aw ln bi"><span id="40df" class="ki kj hi lk b fi lo lp l lq lr">git tag v1.0-prod<br/>git push origin v1.0-prod</span></pre><p id="bde0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果一切顺利，你可以看到建设</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lz"><img src="../Images/9212693efa7746df24cd729aaef572d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KbDFDuFsNDS3Fz80Oop-iw.png"/></div></div></figure><h2 id="b1eb" class="ki kj hi bd kk kl km kn ko kp kq kr ks iq kt ku kv iu kw kx ky iy kz la lb lc bi translated">包扎</h2><p id="8137" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">仅仅是维护一些脚本，这看起来就有很多工作要做。如果这只是一个简单的脚本，请务必使用这个伟大的新编辑器。但是，如果不允许您访问该表呢？或者如果您想回滚更改？或者您是否希望同时部署25个工作表？</p><p id="cbee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该解决方案适用于您需要一个流程来确保一致的部署流程的情况。如果需要的话，这也使得职责分离变得容易。假设您使用云存储库，那么只有存储库和构建触发器需要在同一个项目中。您可以通过在密码中存储多个clasp令牌来使用不同帐户的身份验证。</p><p id="c712" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望这种方法能让你对Google Apps脚本和GCP的结合有所了解。如果您有任何问题，或者如果您在实现示例时遇到困难，请留下评论。</p></div></div>    
</body>
</html>