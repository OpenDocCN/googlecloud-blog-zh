<html>
<head>
<title>Let’s Encrypt and Google App Engine in 2017</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们在2017年加密和谷歌应用引擎</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/lets-encrypt-and-google-app-engine-in-2017-7cfe0928768e?source=collection_archive---------0-----------------------#2017-07-21">https://medium.com/google-cloud/lets-encrypt-and-google-app-engine-in-2017-7cfe0928768e?source=collection_archive---------0-----------------------#2017-07-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="331a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以昨天我开始和HTTPS一起保护我的谷歌应用引擎(GAE) API。我已经设置了我的Google App Engine实例。我对“让我们加密”(<a class="ae jd" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">https://letsencrypt.org/</a>)有点熟悉，尽管我从未使用过它。我还基本掌握了加密和证书中使用的密码原语。</p><p id="6315" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有很多关于这个的博客帖子，还有一堆StackOverflow的帖子，都有不同的说明。谷歌的官方版本似乎过时了，我在“让我们加密”上唯一能找到的是一个bug，大意是“请添加对GAE的支持”。我尝试了一些，通过合并其中一些步骤(以及许多挫折和最终解决的困惑)，我让它工作了。我写这篇博文主要是为了自己(这样当我需要在几个月后重新加密时，我就知道怎么做了)，但希望有人会觉得有用。</p><p id="c360" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">【https://issuetracker.google.com/issues/35900034】<strong class="ih hj"><em class="je">更新:</em> </strong> <em class="je">自动化证书管理即将推出:</em><a class="ae jd" href="https://issuetracker.google.com/issues/35900034" rel="noopener ugc nofollow" target="_blank"><em class="je"/></a><em class="je">)</em></p><h2 id="a17f" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">准备工作:</h2><ol class=""><li id="cfce" class="ka kb hi ih b ii kc im kd iq ke iu kf iy kg jc kh ki kj kk bi translated">LetsEncrypt通过自动验证您是否拥有您声称拥有的域名来颁发SSL证书。(后面更多关于如何验证。)</li><li id="b79f" class="ka kb hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">LetsEncrypt客户端后来被重命名为certbot，由EFF:<a class="ae jd" href="https://certbot.eff.org/" rel="noopener ugc nofollow" target="_blank">https://certbot.eff.org/</a>维护</li><li id="5925" class="ka kb hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">LetsEncrypt允许您在一个证书中覆盖多达100个域/子域。</li><li id="f0d6" class="ka kb hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">LetsEncrypt实现了一个名为ACME(自动管理证书环境)的协议，允许您永久更新他们的证书。</li><li id="8e10" class="ka kb hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">LetsEncrypt只发行3个月的证书。</li><li id="2350" class="ka kb hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">当LetsEncrypt ' <a class="ae jd" href="https://community.letsencrypt.org/t/web-hosting-who-support-lets-encrypt/6920" rel="noopener ugc nofollow" target="_blank">支持托管提供商</a>'时，这意味着您可以使用他们的自动化软件来更新您的证书。如果您的提供商(*cough* Google App Engine *cough*)不受支持，您仍然可以获得LetsEncrypt证书(只需要多花一点力气)，并且您需要每三个月手动更新一次。</li><li id="b4f8" class="ka kb hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">(不是必要的信息，但知道这个很好)亚马逊显然有一个<a class="ae jd" href="https://aws.amazon.com/certificate-manager/" rel="noopener ugc nofollow" target="_blank">证书管理器</a>，可以为你自动化整个过程(和更新)。</li></ol><h2 id="cfd9" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">说明:</h2><ol class=""><li id="af36" class="ka kb hi ih b ii kc im kd iq ke iu kf iy kg jc kh ki kj kk bi translated">安装CertBot，我用过(运行在Mac OSX上):</li></ol><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="e5c9" class="jf jg hi kv b fi kz la l lb lc">brew install certbot</span></pre><p id="0fa2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然有很多种安装方式:<a class="ae jd" href="https://certbot.eff.org/docs/install.html" rel="noopener ugc nofollow" target="_blank">https://certbot.eff.org/docs/install.html</a></p><p id="5656" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.决定是否要通过DNS(向您的DNS添加TXT记录，与验证Google Analytics或Google网站管理员工具的所有权相同)或HTTP(向您的应用程序上传文件)来验证您的域。</p><p id="1616" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">对于HTTP: </strong></p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="d0fa" class="jf jg hi kv b fi kz la l lb lc">sudo certbot certonly --manual</span></pre><p id="209e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">对于DNS(注意:DNS可能需要一段时间更新，所以这可能比HTTP慢):</strong></p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="2a8a" class="jf jg hi kv b fi kz la l lb lc">sudo certbot certonly --manual --preferred-challenges dns</span></pre><p id="2d9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.遵照指示！CertBot将要求您输入一个由空格或逗号分隔的域列表。然后，它会一个接一个地要求您通过您在上一步中选择的方法来验证它们(在您完成这些步骤时不要关闭终端，然后它会发出一个新的挑战)。</p><p id="a34e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">对于HTTP: </strong></p><p id="4219" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它将要求您在yourdomain.com/.well-known/acme-challenge/ABC创建一个值为XYZ的文件(注意:ABC和XYZ只是占位符，不是实际值)。在您的google app目录中创建名为letsencrypt的文件夹，在其中放置一个名为ABC的文件，内容为XYZ，并将以下处理程序添加到您的app.yaml中:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="5541" class="jf jg hi kv b fi kz la l lb lc">handlers:<br/>- url: /.well-known/acme-challenge<br/>  static_dir: letsencrypt</span><span id="4268" class="jf jg hi kv b fi ld la l lb lc">...</span></pre><p id="69fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后部署app (gcloud app deploy app.yaml)！最后验证它的工作(通过访问yourdomain.com/.well-known/acme-challenge/ABC，并确保它不404)。如果这有效，那么在等待的certbot终端上按enter键。</p><p id="31d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">对于DNS: </strong></p><p id="32f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它将要求您向_acme-challenge.yourdomain.com或_ acme-challenge . your subdomain . your domain . com添加一条TXT记录，内容为XYZ(注意:XYZ是一个占位符，不是一个真实值)。去你的域名提供商那里添加记录，因为名字很便宜</p><p id="143f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">类型:TXT <br/>主机:_acme-challenge(或_ acme-challenge . yoursubdomain)<br/>值:XYZ</p><p id="54bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后保存它，等待它传播。您将能够知道它何时完成，因为值XYZ将显示在DIG终端命令的输出中:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="9287" class="jf jg hi kv b fi kz la l lb lc">$ dig -t txt _acme-challenge.yourdomain.com</span><span id="5a3f" class="jf jg hi kv b fi ld la l lb lc">OR </span><span id="bd47" class="jf jg hi kv b fi ld la l lb lc">$ dig -t txt _acme-challenge.yoursubdomain.yourdomain.com</span></pre><p id="6db0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦出现，在certbot终端中按enter键。</p><p id="b3fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.恭喜你。Certbot刚刚祝贺您获得了全新的证书，网址为:/etc/lets encrypt/live/your domain . com/full chain . PEM</p><p id="6f71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">前往Google的App Engines SSL证书页面(App Engine &gt;设置&gt; SSL证书，或只是<a class="ae jd" href="https://console.cloud.google.com/appengine/settings/certificates" rel="noopener ugc nofollow" target="_blank">https://console . cloud . Google . com/App Engine/Settings/Certificates</a>)，在这里你会被提示复制并粘贴证书和私钥(注意:你也可以上传文件，但这比较困难，因为只有root拥有/etc/letsencrypt/live/的读取权限，而Chrome没有root权限)。证书可以按原样上传，您可以使用以下命令将其复制到剪贴板:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="7643" class="jf jg hi kv b fi kz la l lb lc">$ sudo cat /etc/letsencrypt/live/yourdomain.com/fullchain.pem | pbcopy</span></pre><p id="b906" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在你上传私钥之前，你必须把它转换成RSA私钥(不同之处请看这里:<a class="ae jd" href="https://stackoverflow.com/a/20065522/781199" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/a/20065522/781199</a>)。为此，请运行以下命令:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="ceaa" class="jf jg hi kv b fi kz la l lb lc">$ sudo openssl rsa -inform pem -in /etc/letsencrypt/live/yourdomain.com/privkey.pem -outform pem &gt; /etc/letsencrypt/live/yourdomain.com/rsaprivatekey.pem</span></pre><p id="5620" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(注意:如果您想要写出这样的文件，您将需要root权限，因为只有root在/etc/letsencrypt/live/上具有写权限，为此您可以使用“$ sudo su root”)。</p><p id="7d60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后复制并粘贴到Google App Engine上的私钥框中:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="74e6" class="jf jg hi kv b fi kz la l lb lc">$ sudo cat /etc/letsencrypt/live/yourdomain.com/rsaprivatekey.pem | pbcopy</span></pre><p id="35b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">搞定了。你的网站现在被HTTPS保护了！别忘了3个月后更新你的证书🔐</p></div></div>    
</body>
</html>