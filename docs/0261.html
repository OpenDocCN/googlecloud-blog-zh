<html>
<head>
<title>Scaling Google App Engine to No Instances (or maybe just 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Google App Engine扩展到没有实例(或者只有1个)</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/scaling-google-app-engine-to-no-instances-or-maybe-just-1-37be4e8d4230?source=collection_archive---------0-----------------------#2017-04-20">https://medium.com/google-cloud/scaling-google-app-engine-to-no-instances-or-maybe-just-1-37be4e8d4230?source=collection_archive---------0-----------------------#2017-04-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="963c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不常使用的应用程序不需要100%的时间都在运行，你也不应该为此付费。</p><p id="5472" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你在GAE上部署<a class="ae jd" rel="noopener" href="/@mediocrity/from-idea-to-deployed-on-gcp-in-24hrs-927eaf8a5939">应用</a>，你会开始注意到当你的应用运行时，你会为两个实例而不是一个实例花钱。本指南将介绍在<em class="je">灵活</em>的环境中，不需要100%的时间正常运行或有严格的可靠性/延迟限制的应用程序的单个实例。</p><h1 id="844b" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">环境:标准与灵活</h1><p id="06ac" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">在我们了解如何配置服务甚至成本数据之前，我们需要确保了解GAE提供的两种环境类型之间的差异。文档<a class="ae jd" href="https://cloud.google.com/appengine/docs/the-appengine-environments" rel="noopener ugc nofollow" target="_blank">在这里</a>概述了不同之处。有几个与成本相关的关键差异。</p><p id="05e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">灵活</strong>:在灵活的环境中，您需要为使用<strong class="ih hj"> vCPU </strong>、<strong class="ih hj">内存</strong>和<strong class="ih hj">持久磁盘</strong>付费。如果您的常规流量模式需要逐渐增加和减少<strong class="ih hj"/>，通常会更具成本效益。</p><p id="d9d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">标准</strong>:在标准环境中，您只需为您需要的东西付费(例如<em class="je">实例小时</em>)，并且在没有流量时可以扩展到<strong class="ih hj"> 0实例</strong>。对于不总是需要流量的小型应用程序来说，这通常更具成本效益。</p><p id="73e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">了解这一点后，您可以查看应用程序的<strong class="ih hj"> <em class="je"> app.yaml </em> </strong>文件，了解它们被配置为使用哪种环境。如果没有指定<strong class="ih hj"> env </strong>键，它将被部署到<strong class="ih hj">标准</strong>环境中。</p><h1 id="2c5d" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">缩减灵活的环境</h1><p id="4f16" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">如果出于技术原因或选择(比如运行Node.js或Ruby的能力)或者因为需要SSH调试(真的吗？)或拥有后台进程的能力，您仍然可以配置服务的缩放参数。</p><p id="bd05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您有一个没有指定任何缩放或资源参数的小型应用程序，这是一个很好的起点。</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="d768" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们要研究的第一个参数是<strong class="ih hj">自动缩放</strong>参数。因为我们的例子有一个运行时<em class="je"> nodejs </em>，我们将继续。</p><p id="9a8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有两个文档需要复习:1)<a class="ae jd" href="https://cloud.google.com/appengine/docs/flexible/nodejs/an-overview-of-app-engine#Instance_scaling" rel="noopener ugc nofollow" target="_blank">App Engine概述</a>，2) <a class="ae jd" href="https://cloud.google.com/appengine/docs/flexible/nodejs/configuring-your-app-with-app-yaml#automatic_scaling" rel="noopener ugc nofollow" target="_blank">用app.yaml配置你的App</a>。您可能已经打开了这些页面，或者之前已经阅读过，但它们是很好的参考资料。</p><p id="18d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您的应用程序不需要冗余或高可用性，您实际上可以将其缩减到一个<strong class="ih hj">单个</strong>实例。默认情况下，出于延迟和冗余/可靠性目的，GAE将部署<strong class="ih hj"> 2个实例</strong>。</p><p id="7e16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了能够理解如何设置参数，例如<em class="je"> max_num_instances </em>(来自上面的第二个文档)，您需要查看应用程序的实例指标，理解如果您扩展到2个实例(默认)以下，您将会受到<strong class="ih hj">延迟</strong>和<strong class="ih hj">冗余/可靠性</strong>的影响。</p><p id="4962" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Google云平台控制台中，在“应用引擎”下的“实例”下，选择您的服务。在您的服务下方的下拉列表中，您可以选择几个指标进行查看:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kp"><img src="../Images/65f4c177d2230beaa0bc55754346bbaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:910/format:webp/1*7P8RureTqnWgVQ52jlG6tw.png"/></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">实例度量</figcaption></figure><p id="a8f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将时间段设置得稍长一些，比如14天或30天，然后浏览指标。</p><p id="a945" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的示例应用程序中，我可能会缩小到单个实例(因为它不需要低延迟或严格的可靠性)，我查看了摘要、流量、VM流量、CPU利用率、实例、内存使用和磁盘字节。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es kw"><img src="../Images/8464c2f6c21eb26083836592150824d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HW2U9hnPjikrJTPc_ULWIQ.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">请求摘要</figcaption></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lb"><img src="../Images/9aed646b4c4bb227669f8a88c13b30dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6WzdEuVDqM8jtn1AJgQaiQ.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">以字节/秒表示的流量</figcaption></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lb"><img src="../Images/f69e25341e79c952fde8e142fd674054.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TnpUMrLmxrAke86r4Uzd5g.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">以字节/秒为单位的虚拟机流量</figcaption></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lc"><img src="../Images/4ee5a7c0ac38a23801d3d3e316dca8b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pnrR-Tv30_dfrJIz14SVRw.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">CPU利用率百分比</figcaption></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es kw"><img src="../Images/f59a4311805fa16ef2e5109b4b944ec7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0d_VECjjDBC23vFBDtDaLA.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">实例数量和CPU使用率</figcaption></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es ld"><img src="../Images/66ac293a9a6024add779213ce3d1d5fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JQozeiBEGY_M6wh40nL3iw.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">内存使用量(MB)</figcaption></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lc"><img src="../Images/a8f7f1f8796296a1135a53a45604ff62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_LIBS3Vi1B48OUNA-1ZfBg.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">以字节/秒为单位的磁盘字节</figcaption></figure><p id="1453" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从这些指标可以看出，这是一个相对较小的应用程序。我们不会自动扩展到超过2个实例的默认值，也不会将CPU利用率提高到10%以上。</p><p id="37eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">考虑到这一点，我很乐意将缺省值2以下的实例数量缩减为一个实例。对于这个特定的应用程序，我没有任何延迟或冗余/可靠性问题。</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure></div><div class="ab cl le lf gp lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="hb hc hd he hf"><p id="df5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还可以使用这些指标来设置我们希望应用程序使用的<strong class="ih hj">资源</strong>规模。通过设置适当的资源规模，我们将与适当的机器类型相匹配。这方面的文档在之前链接的文档中向上滚动了一点点(或者这里的<a class="ae jd" href="https://cloud.google.com/appengine/docs/flexible/nodejs/configuring-your-app-with-app-yaml#resource-settings" rel="noopener ugc nofollow" target="_blank">是</a>)。</p><p id="b531" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有三个参数我们会重点设置:<strong class="ih hj"> cpu </strong>、<strong class="ih hj"> memory_gb </strong>、<strong class="ih hj"> disk_size_gb </strong>。在本例中，我们不需要关注卷的其他参数，因为我们没有装载任何卷。</p><p id="d54c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，您获得了1个cpu内核，我们将这样设置它，因为我们几乎没有达到10%的CPU利用率。</p><p id="e127" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，你得到<strong class="ih hj"> 0.6 GB的内存</strong>。在链接的文档中有一个公式显示，您需要大约0.4GB的内存用于偷听到的内容，最少总共需要0.9GB。他们的文档中的公式是<strong class="ih hj">memory _ GB</strong>=<strong class="ih hj">CPU</strong>*[0.9–6.5]—0.4。这意味着我们可以为单核设置的绝对最小值是0.5 GB，这就是我们将要做的。</p><p id="d532" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，您会得到<strong class="ih hj"> 10 GB的磁盘</strong>，因为这是最小值，所以我们将这样设置。</p><p id="978e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最小GAE资源设置的配置可能如下所示:</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure></div><div class="ab cl le lf gp lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="hb hc hd he hf"><p id="be94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然我们已经设置了资源和扩展参数，我们就可以重新部署应用程序了(假设对此很熟悉)。</p><p id="450a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设您的应用程序重新部署成功，您可以开始在控制台和命令行中查看各种指标。我建议第一件事是确认您已经设置的配置，因为您已经更改了相当重要的参数。这可以通过如下的<em class="je">应用版本描述</em>命令来完成:</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="5699" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意<em class="je">自动缩放</em>和<em class="je">资源</em>键/值。这些应该与您设置的相匹配。</p><p id="80ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在GCP控制台中，您应该能够查看App Engine &gt; Dashboard从2个实例减少到1个实例:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es ll"><img src="../Images/45180a2c6240d91ca7bc035e375607f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h5X7s8x1-8hotVSckwS5vQ.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">实例摘要</figcaption></figure><p id="5dba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在“版本”和“实例”选项卡下，它也应该显示一个实例:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lm"><img src="../Images/12411de7bb7c301765098336b69bea3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r2CZr-ZdIZoy7EP8tvORbw.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">版本</figcaption></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es ln"><img src="../Images/4a1af5d29002a86ddc6aa01aa5b37959.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7IlZQIB-DQSsR4LGY-JbtQ.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx translated">例子</figcaption></figure><h1 id="312d" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">祝贺</h1><p id="c639" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">如果您将灵活环境中的实例数量从<strong class="ih hj">两个</strong>减少到<strong class="ih hj">一个</strong>，那么您的GAE账单可能会减半。休息一下，喝杯咖啡，庆祝一下！</p><p id="5402" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一篇文章:如何分析你的GCP账单并通过可见性节省数十亿美元。</p></div></div>    
</body>
</html>