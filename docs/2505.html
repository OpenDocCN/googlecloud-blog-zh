<html>
<head>
<title>Cloud Functions Best Practices (1/4) : Get the environment ready</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云功能最佳实践(1/4):准备好环境</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cloud-functions-best-practices-1-4-get-the-environment-ready-af666af89f62?source=collection_archive---------0-----------------------#2022-11-15">https://medium.com/google-cloud/cloud-functions-best-practices-1-4-get-the-environment-ready-af666af89f62?source=collection_archive---------0-----------------------#2022-11-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6db8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">高效构建、测试、重新测试和部署谷歌云功能</p><p id="f37c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章是4篇文章系列的一部分，其中我给出了关于Google云功能开发的各种建议。这项工作是两年日常实践、部署和监测的结果。其中一些最佳实践直接来自官方文档，另一些来自我的经验，被证明是最有效的。对于任何不同的观点，请随意评论这篇(免费)文章。谢谢！</p><p id="ac2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" rel="noopener" href="/google-cloud/cloud-functions-best-practices-2-4-optimize-the-cloud-functions-5874f9d8c8b5">云功能最佳实践(2/4):优化云功能</a> &gt; &gt; &gt;</p><p id="7d6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" href="https://beranger.medium.com/cloud-functions-best-practice-3-4-secure-the-cloud-functions-1c9642c4706" rel="noopener">云功能最佳实践(3/4):保护云功能</a> &gt; &gt; &gt;</p><p id="de23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" href="https://beranger.medium.com/cloud-functions-best-practice-4-4-monitor-and-log-the-executions-22222aa25f1b" rel="noopener">云功能最佳实践(4/4):监控和记录执行</a> &gt; &gt; &gt;</p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><h1 id="0692" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">准备好谷歌云功能环境</h1><figure class="kl km kn ko fd kp er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es kk"><img src="../Images/18661a107069685a7b292e15a1518090.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EnfZZQakR_RShVmJQ8e7Rw.png"/></div></div></figure><p id="18c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在线教程很酷，我的甚至超级酷！；)通过一堆文章，任何人都可以学习<a class="ae je" href="https://beranger.medium.com/native-implementation-of-google-secret-manager-in-cloud-functions-93a1732dd175" rel="noopener">如何在Google Cloud Functions中使用Secret Manager</a>，<a class="ae je" href="https://beranger.medium.com/secure-google-cloud-functions-with-api-gateway-848f687963ae" rel="noopener">如何保护一个Google Cloud Function </a> s，<a class="ae je" href="https://beranger.medium.com/rate-limit-google-cloud-functions-with-api-gateway-19b54bb9d9e9" rel="noopener">如何对它们进行速率限制</a>，如何使用云存储、Cloud Pub/Sub以及每一个可能的工具。</p><p id="3764" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，</p><p id="cc03" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它有一个很大的缺点教程是为一个单一的、简短的、特定的主题而制作的。</p><p id="5e35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">商业项目绝不是简短和具体的。</p><p id="f5ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">业务项目结合了多种云功能，使用各种需要尝试、测试和调试的工具，希望是高效的。</p><p id="92dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如何做到这一点在单功能教程中没有解释。</p><p id="c7bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是我在第一篇文章中介绍的内容<strong class="ih hj">准备好Google Cloud Functions环境</strong>以支持多种云功能管理和高效测试&amp;调试。</p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><h1 id="7d26" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">1功能&lt;&gt; 1文件夹&amp; 1功能&lt;&gt; 1文件</h1><p id="8dcb" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">在使用谷歌云功能几个月后，很容易陷入爱河并部署一打。</p><p id="fc27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些GCF将需要被部署，被推送到Git，被记录并被其他用户使用。</p><p id="943e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">拥有清晰高效的结构至关重要。</p><p id="9cdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">结构不良</strong></p><p id="9979" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我见过几次初学者的错误，就是把所有的Google Cloud函数放在同一个文件夹里，创建一个大的README，然后把所有的东西都推给Git。</p><p id="9988" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其结构如下所示(python):</p><figure class="kl km kn ko fd kp er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es lb"><img src="../Images/c2e783dade5f456b2163958edb93a997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aeS86-Kg8r6mGhUYdLly5A.png"/></div></div></figure><p id="cb5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个管用！这里没有什么不好，它适用于用相同语言编码的1-2-3云函数。</p><p id="eb0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于三个原因，这是有问题的，但是对于三个功能来说是可以接受的:</p><ul class=""><li id="6935" class="lc ld hi ih b ii ij im in iq le iu lf iy lg jc lh li lj lk bi translated">requirements.txt将包含所有函数使用的包。如果function_2需要一个特定的包，function_1和function_3也需要导入它。</li><li id="3ad5" class="lc ld hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated"><code class="du lq lr ls lt b">README.md</code>是3个功能的文档</li><li id="1885" class="lc ld hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated">在同一个文件夹中不可能有nodejs、python和Go函数</li></ul><p id="1858" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">良好的结构</strong></p><p id="5d72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">相反，我建议采用这种结构，它没有以前的缺点:</p><ul class=""><li id="60d1" class="lc ld hi ih b ii ij im in iq le iu lf iy lg jc lh li lj lk bi translated">每个谷歌云功能使用一个文件夹</li><li id="7180" class="lc ld hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated">向每个文件夹添加1个<code class="du lq lr ls lt b">README.md</code></li><li id="3be8" class="lc ld hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated">每个谷歌云功能增加1个<code class="du lq lr ls lt b">requirements.txt</code>或任意一个<code class="du lq lr ls lt b">package.json</code></li></ul><p id="78a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不要忘记函数本身；)</p><p id="7aef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">代码拆分</strong></p><p id="c580" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我几次看到一个函数被分成几个文件，utils文件，config文件…显然是为了清楚。为什么不呢？但谷歌云功能是为特定任务和简短功能设计的。如果一段代码太长，需要分成多个文件，可能谷歌云功能不是合适的产品。</p><p id="b648" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> gcloud忽略</strong></p><p id="22d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们采用前面的结构(我们应该这样做！)并使用命令行部署一个功能，我们会在Google Cloud Functions中看到一个<code class="du lq lr ls lt b">README.md</code>文件。我们不想那样。这是一个不需要部署的无用文件。</p><p id="1d22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以简单地在每个文件夹中添加一个<code class="du lq lr ls lt b">.gcloudignore</code>文件，这个文件包括文件本身和自述文件。</p><pre class="kl km kn ko fd lu lt lv bn lw lx bi"><span id="409d" class="ly jn hi lt b be lz ma l mb mc">README.md<br/>.gcloudignore</span></pre><p id="2d96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最终的结构看起来像这样:</p><figure class="kl km kn ko fd kp er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es lb"><img src="../Images/2b6c33a8eb2c5bc45747382083c7db2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WOP6HZtsihDy6hGOud8OmQ.png"/></div></div></figure><p id="1d92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过这个简单的结构改变，我可以:</p><ul class=""><li id="ff04" class="lc ld hi ih b ii ij im in iq le iu lf iy lg jc lh li lj lk bi translated">在同一个Github存储库中创建一个js GCF和一个py GCF</li><li id="4eba" class="lc ld hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated">为特定的功能提供不同的包</li><li id="28a6" class="lc ld hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated">每个功能都有不同的自述文件</li></ul><p id="8b76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个结构是Google Cloud在他们的Google Cloud函数样本<a class="ae je" href="https://github.com/firebase/functions-samples" rel="noopener ugc nofollow" target="_blank"> Github知识库</a>中提出的。他们甚至创建一个子文件夹来添加函数文件。老实说，我不知道他们为什么走了这么远😀</p><p id="ab33" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">最后但并非最不重要的→ Github </strong></p><p id="ab1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦建立了这种结构，很容易就会像“更新图片链接”、“更新自述文件”那样简单地将更新推送到github</p><p id="b568" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是他们在GCF示例Github repo中所做的:</p><figure class="kl km kn ko fd kp er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es md"><img src="../Images/ba56f41ff064eb26fef907a1d8753e4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SoGW23uIAtqe0AxOeZB7ow.png"/></div></div></figure><p id="2ae0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不</p><p id="3b2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">先前提议的结构混合了许多功能和许多项目，以这种方式提交并不能帮助团队了解当前的项目是什么。</p><p id="1c91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我建议在每次Github提交中包含函数名，比如:“function_1:添加属性名”、“function_2:代码重构”…</p><p id="1a73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样，就更容易看到最近开发了什么，当前的项目…</p><p id="efad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">—</p><p id="39e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望看到你提交的改变，谷歌开发者；)</p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><h1 id="352a" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">首先，不要使用谷歌云功能</h1><p id="ea47" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">在学习了关于GCF的教程之后，通常的反应是继续使用云函数环境本身进行开发，在每次更新之后进行部署。</p><p id="e421" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这不是个好主意。</p><p id="3868" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">教程是共享一个干净的代码，经过多次测试。但是当普通的开发人员在编码时，他们期望在第一次迭代中有一个干净的代码能正常运行…老实说，从来没有过这种情况。</p><p id="6def" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为每个代码变更部署一个GCF并不是一个好的实践，因为部署一个GCF需要时间，最多2分钟。加上测试时间，加上等待日志出现的时间，从更新到结果只需5分钟，这是巨大的！</p><p id="db84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个好的开发人员总是会忘记一个[或一个”或一张支票。没有什么比等待几分钟后出现“键值错误”更令人沮丧的了。</p><p id="f163" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署必须只在GCF准备部署的最后使用。当所有东西都在本地测试过之后。</p><p id="c2b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我开始一个云功能的新项目时，我总是打开一个Jupyter笔记本，编写所有代码，构建我的代码，进行所有必要的测试和检查。</p><p id="9b84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦a可以在单个笔记本单元格中执行我的全部代码…</p><p id="0041" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在还不是部署的时候…</p><p id="ba52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是时候…</p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><h1 id="63e6" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">其次，使用功能框架</h1><p id="2810" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">代码很干净，是时候运行函数了。但在部署之前，谷歌提供了一个模拟器，用于在本地运行该功能。</p><p id="4ea2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Functions-framework是一个启动本地开发服务器进行快速测试的框架。</p><p id="007f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与本地代码的区别在于，它模拟云功能服务器并响应事件。</p><p id="036f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当functions-framework命令运行时，它模拟服务器并给出一个本地地址来调用函数。</p><p id="8aa3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我解释一下python GCF的过程:</p><ul class=""><li id="6d94" class="lc ld hi ih b ii ij im in iq le iu lf iy lg jc lh li lj lk bi translated">首先，在GCF存储库中，安装functions_framework:</li></ul><pre class="kl km kn ko fd lu lt lv bn lw lx bi"><span id="51a2" class="ly jn hi lt b be lz ma l mb mc">pip install functions-framework</span></pre><ul class=""><li id="bba1" class="lc ld hi ih b ii ij im in iq le iu lf iy lg jc lh li lj lk bi translated">其次，创建一个文件夹<code class="du lq lr ls lt b">test_functions_framework</code>并包含我们之前讨论过的所有文件，该文件夹现在的结构如下:</li></ul><pre class="kl km kn ko fd lu lt lv bn lw lx bi"><span id="d33d" class="ly jn hi lt b be lz ma l mb mc">.<br/>├── .gcloudignore<br/>├── README.md<br/>├── main.py<br/>└── requirements.txt</span></pre><ul class=""><li id="a0f1" class="lc ld hi ih b ii ij im in iq le iu lf iy lg jc lh li lj lk bi translated">在<code class="du lq lr ls lt b">requirements.txt</code>中，添加这一行:</li></ul><pre class="kl km kn ko fd lu lt lv bn lw lx bi"><span id="b291" class="ly jn hi lt b be lz ma l mb mc">flask</span></pre><ul class=""><li id="bbeb" class="lc ld hi ih b ii ij im in iq le iu lf iy lg jc lh li lj lk bi translated">在<code class="du lq lr ls lt b">main.py</code>中添加这个简单的代码:</li></ul><pre class="kl km kn ko fd lu lt lv bn lw lx bi"><span id="0799" class="ly jn hi lt b be lz ma l mb mc">from flask import Response<br/>import uuid<br/><br/>def main(request):<br/><br/>    try:<br/><br/>        print("I was called !", uuid.uuid4())<br/><br/>        return Response(response = 'ok', status = 200)<br/>                <br/>    except Exception as e:<br/>        print("ERROR ", e)<br/>        return Response(response = 'AN ERROR OCCURED', status = 400)</span></pre><ul class=""><li id="138c" class="lc ld hi ih b ii ij im in iq le iu lf iy lg jc lh li lj lk bi translated">在<code class="du lq lr ls lt b">test_functions_framework</code>文件夹中，我们可以用这个命令运行functions-framework:</li></ul><pre class="kl km kn ko fd lu lt lv bn lw lx bi"><span id="6dbc" class="ly jn hi lt b be lz ma l mb mc">functions-framework --target=main --debug</span></pre><ul class=""><li id="ed99" class="lc ld hi ih b ii ij im in iq le iu lf iy lg jc lh li lj lk bi translated">它给了我们一个本地主机地址，我们只需ping，它直接给出所有日志和结果，就好像它是在线部署的一样。</li></ul><figure class="kl km kn ko fd kp er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es me"><img src="../Images/3b964bc97afb67512edd0a4c8b56be44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ap_3iRdANbur77-TmkZOLA.png"/></div></div></figure><p id="0c48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切都准备好部署了！</p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><h1 id="fbbb" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">崩溃的最后一个原因</h1><p id="22c4" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">该功能是干净的，经过测试，工作几乎完成，但仍有可能在部署后崩溃。</p><p id="0e46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为认证。</p><p id="29cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您的功能有可能与Google Cloud的实体(Secret Manager、Pub/Sub、big query……)进行交互</p><p id="0002" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在开发过程中，您可能使用服务帐户或您自己的凭证来访问这些服务。</p><p id="96b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是一旦部署，云功能就不一样了。</p><p id="7ceb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有两种可能性:</p><p id="b1f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在部署期间，您可以指定函数必须使用的服务帐户</p><p id="0b57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">否则，云功能将使用默认服务帐户作为其执行功能的身份:</p><ul class=""><li id="4b10" class="lc ld hi ih b ii ij im in iq le iu lf iy lg jc lh li lj lk bi translated">云功能(第一代)使用App Engine默认服务账号<code class="du lq lr ls lt b">PROJECT_ID@appspot.gserviceaccount.com</code>。</li><li id="02df" class="lc ld hi ih b ii ll im lm iq ln iu lo iy lp jc lh li lj lk bi translated">云功能(第二代)使用默认计算服务帐户<code class="du lq lr ls lt b">PROJECT_NUMBERcompute@developer.gserviceaccount.com</code>。</li></ul><p id="7c32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请确保这些服务帐户能够访问该功能所需的资源。</p><p id="519d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，函数没有崩溃的理由。如果它崩溃了，留下评论，告诉我原因。</p><p id="7864" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你已经准备好了，学徒！</p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><h1 id="f493" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">最后，部署！使用命令行！</h1><p id="7179" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ky is it iu kz iw ix iy la ja jb jc hb bi translated">我会说+80%的关于谷歌云功能的教程都解释了如何使用UI部署一个实例。</p><p id="f564" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它工作了。</p><p id="4a14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但如果你做到了这一点，你现在正在掌握谷歌云功能，你没有时间点击3-4个按钮，等待UI加载和功能部署。</p><p id="2729" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，如果您仔细阅读了第一部分，那么您的代码结构良好，并且您已经准备好使用命令行进行部署。</p><blockquote class="mf mg mh"><p id="718b" class="if ig jd ih b ii ij ik il im in io ip mi ir is it mj iv iw ix mk iz ja jb jc hb bi translated"><em class="hi">“学习德语和手动部署功能的时间太短了。”曾经说过一个</em> <a class="ae je" href="https://www.linkedin.com/in/beranger-natanelic/" rel="noopener ugc nofollow" target="_blank"> <em class="hi">的伟人</em> </a></p></blockquote><p id="f9f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">花5分钟时间安装<a class="ae je" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank"> gcloud SDK </a>并从终端运行部署命令。</p><p id="0265" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将需要2分钟部署，同时你可以拍50次这篇文章；)</p><p id="52c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不要忘记在运行deploy命令之前保存您的代码！；)</p><p id="0931" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">为http函数部署触发函数(python) </strong></p><pre class="kl km kn ko fd lu lt lv bn lw lx bi"><span id="094c" class="ly jn hi lt b be lz ma l mb mc">gcloud functions deploy your-function  --region=us-central1  --entry-point main --runtime python310 --trigger-http --no-allow-unauthenticated</span></pre><p id="7c29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">部署发布/订阅触发的功能(超时较长的节点)</strong></p><pre class="kl km kn ko fd lu lt lv bn lw lx bi"><span id="952b" class="ly jn hi lt b be lz ma l mb mc">gcloud functions deploy your-function  --runtime nodejs14 --memory=128MB --timeout=200s --region=europe-west2 --trigger-topic=your-function</span></pre><p id="a89b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要了解更多信息，请查看<a class="ae je" href="https://cloud.google.com/sdk/gcloud/reference/functions/deploy" rel="noopener ugc nofollow" target="_blank">部署文档</a></p><p id="0147" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一个很好的技巧是从源代码库自动化部署，每次你推送到GitHub，功能就部署在云功能上。</p><p id="10fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Bon…我不太喜欢它，因为它意味着将一个未经现场测试的代码推送到Github。</p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><p id="61ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一部分:</p><p id="24ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" rel="noopener" href="/google-cloud/cloud-functions-best-practices-2-4-optimize-the-cloud-functions-5874f9d8c8b5">云功能最佳实践(2/4):优化云功能</a> &gt; &gt; &gt;</p><p id="c265" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" href="https://beranger.medium.com/cloud-functions-best-practice-3-4-secure-the-cloud-functions-1c9642c4706" rel="noopener">云功能最佳实践(3/4):保护云功能</a> &gt; &gt; &gt;</p><p id="e0bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" href="https://beranger.medium.com/cloud-functions-best-practice-4-4-monitor-and-log-the-executions-22222aa25f1b" rel="noopener">云功能最佳实践(4/4):监控和记录执行情况</a> &gt; &gt; &gt;</p><p id="a705" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谢谢你的阅读，谢谢你为我鼓掌，谢谢你关注我！</p><p id="b57d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">别忘了要牛逼。</p></div></div>    
</body>
</html>