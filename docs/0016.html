<html>
<head>
<title>Deep Dream with Containers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">容器的深度梦</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/deep-dream-with-containers-d28a26e4c8a3?source=collection_archive---------3-----------------------#2015-07-22">https://medium.com/google-cloud/deep-dream-with-containers-d28a26e4c8a3?source=collection_archive---------3-----------------------#2015-07-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="919a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你没有听说过<a class="ae jd" href="http://googleresearch.blogspot.com/2015/06/inceptionism-going-deeper-into-neural.html" rel="noopener ugc nofollow" target="_blank">谷歌深度梦</a>——去看看吧！简而言之，它“颠倒了(神经)网络……以一种引出特定解释的方式增强输入图像”。或者，简单地说，它可视化了神经网络如何看到和找到它被训练识别的模式。</p><p id="a5ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">摄影是我的爱好。当我终于有了空闲时间，我决定从我在Flickr 上的一些<a class="ae jd" href="https://flickr.com/photos/saturnism" rel="noopener ugc nofollow" target="_blank">照片中生成深度梦境图像。</a></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/9f5f8d3e0c03e9fedd6c8920fd165818.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GoA3fspxin9O46SoOcLfew.jpeg"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated"><a class="ae jd" href="https://www.flickr.com/photos/saturnism/19453626329" rel="noopener ugc nofollow" target="_blank">Flickr上的原创</a>。</figcaption></figure><h2 id="8703" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">一场噩梦</h2><p id="aa16" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">深梦<a class="ae jd" href="http://github.com/google/deepdream" rel="noopener ugc nofollow" target="_blank">源代码在GitHub </a>上。我以为下载、安装和运行它会很容易。但事实证明这要困难得多——既没有关于如何运行源代码的说明，也没有关于如何安装依赖项的说明。</p><p id="44e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">网上流传着大量的深度梦安装说明，但每个都略有不同，而且大部分都很复杂。要安装的最复杂的依赖项是Caffe。</p><p id="0a9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了在我的笔记本电脑上只安装一次软件，我还想在虚拟机上运行。我需要有一致的和可复制的深层梦依赖的构建，这样我就可以在任何地方运行它。</p><h2 id="86fe" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">码头工人来救援了</h2><p id="5bee" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我立刻想到了Docker。使用Docker，我可以在一个<a class="ae jd" href="https://github.com/saturnism/deepdream-docker/blob/master/Dockerfile" rel="noopener ugc nofollow" target="_blank">Docker文件</a>中编写所有的安装步骤/命令，Docker将按照指令构建所有的依赖项并安装Deep Dream源代码。最终结果是一个可移植的Docker容器映像——我可以在本地运行它，或者在任何运行Docker的虚拟机中运行它。</p><p id="a981" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的<a class="ae jd" href="https://github.com/saturnism/deepdream-docker/blob/master/Dockerfile" rel="noopener ugc nofollow" target="_blank">深梦docker文件在GitHub </a>上。它将:</p><ol class=""><li id="eb7d" class="ku kv hi ih b ii ij im in iq kw iu kx iy ky jc kz la lb lc bi translated">安装编译Caffe所需的依赖项</li><li id="4059" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">编译并安装Caffe</li><li id="fa19" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">安装深梦所需的依赖项</li><li id="cf3a" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">安装最新版本的IPython笔记本</li><li id="01b0" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">下载神经网络模型</li><li id="ed4a" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">设置必要的环境变量</li><li id="8f5a" class="ku kv hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">最后，启动IPython笔记本</li></ol><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="li lj l"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated"><a class="ae jd" href="https://www.flickr.com/photos/saturnism/16828917719" rel="noopener ugc nofollow" target="_blank">Flickr上的原创</a>。</figcaption></figure><h2 id="119a" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">码头机器</h2><p id="1aee" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我亲身体会到通过低带宽连接下载Docker图像和推送图像是多么令人不快。</p><p id="0d30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在过去的几个月里，我没有使用<a class="ae jd" href="http://boot2docker.io/" rel="noopener ugc nofollow" target="_blank"> boot2docker </a>在本地构建和推送Docker映像，而是在<a class="ae jd" href="https://cloud.google.com/compute/" rel="noopener ugc nofollow" target="_blank">谷歌计算引擎</a>上使用<a class="ae jd" href="https://docs.docker.com/machine/" rel="noopener ugc nofollow" target="_blank"> Docker Machine </a>。</p><p id="c52c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看我的另一篇<a class="ae jd" rel="noopener" href="/google-cloud-platform-developer-advocates/my-slow-internet-vs-docker-7678ae1cae72?source=your-stories">文章，关于我如何在谷歌计算引擎</a>上设置Docker机器。</p><h2 id="9ced" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">做梦之前</h2><p id="66d7" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">在做深梦之前，你需要建造容器:</p><pre class="jf jg jh ji fd lk ll lm ln aw lo bi"><span id="7123" class="ju jv hi ll b fi lp lq l lr ls">$ git clone <a class="ae jd" href="https://github.com/saturnism/deepdream-docker" rel="noopener ugc nofollow" target="_blank">https://github.com/saturnism/deepdream-docker</a><br/>$ cd deepdream-docker<br/>$ docker build -t deepdream .<br/>...<br/>Successfully built ...</span></pre><p id="f3ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要运行它:</p><pre class="jf jg jh ji fd lk ll lm ln aw lo bi"><span id="efb1" class="ju jv hi ll b fi lp lq l lr ls">$ docker run -p 8888:8888 -v /tmp:/deepdream/deepdream/files -ti deepdream<br/>[I 03:25:07.724 NotebookApp] Created profile dir: u'/root/.ipython/profile_default'<br/>...<br/>[I 03:25:07.741 NotebookApp] The IPython Notebook is running at: <a class="ae jd" href="http://[all/" rel="noopener ugc nofollow" target="_blank">http://[all</a> ip addresses on your system]:8888/<br/>[I 03:25:07.741 NotebookApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).</span></pre><p id="e278" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您在远程主机上使用Docker Machine，请确保您允许端口8888访问(在我的关于在Google计算引擎中使用Docker Machine的文章<a class="ae jd" rel="noopener" href="/google-cloud-platform-developer-advocates/my-slow-internet-vs-docker-7678ae1cae72?source=your-stories">中了解如何使用)。</a></p><p id="f7d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你现在应该可以通过浏览8888端口上的Docker服务器来访问你的Deep Dream笔记本了。</p><pre class="jf jg jh ji fd lk ll lm ln aw lo bi"><span id="b0f1" class="ju jv hi ll b fi lp lq l lr ls">http://xxx.xxx.xxx.xxx:8888/notebooks/dream.ipynb</span></pre><p id="2349" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你会看到这样的东西:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lt"><img src="../Images/ed52a359bf56cd01ec73b14d0c5dc83b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZXLpcucUr8BXRB_iyIACsQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">IPython笔记本</figcaption></figure><h2 id="d709" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">你的第一个梦</h2><p id="2968" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">您可以使用默认图像，从顶部开始运行IPython笔记本中的每个单元格:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lu"><img src="../Images/cb14d39f701f30adda2d341956646357.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CLjdYiDiQO-aLDazC4ncdw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">点击<strong class="bd jw">运行单元</strong>按钮运行深度梦代码。你需要从头到尾看一遍！</figcaption></figure><p id="4fd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将从默认设置生成非常酷的图像。</p><p id="e3c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当你使用自己的形象时，乐趣才真正开始！要使用您自己的映像，您可以将映像复制到Docker主机的/tmp目录中(因为这是我们挂载它的方式——可以随意更改)。如果您在本地运行Docker容器，只需将文件复制到:</p><pre class="jf jg jh ji fd lk ll lm ln aw lo bi"><span id="4bf7" class="ju jv hi ll b fi lp lq l lr ls">$ cp myimage.jpg /tmp</span></pre><p id="c481" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您使用Docker Machine，那么您可以使用` docker-machine scp `:</p><pre class="jf jg jh ji fd lk ll lm ln aw lo bi"><span id="1d02" class="ju jv hi ll b fi lp lq l lr ls">$ docker-machine scp myimage.jpg mydockermachine:/tmp</span></pre><p id="3817" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您在IPython笔记本中向下滚动，您可以用您上传的文件替换图像文件。您需要再次点击<strong class="ih hj">运行单元</strong>按钮:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lv"><img src="../Images/c7f6b5470e38b63185782eb3c7197ac4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DhnsiGXNBGmyzg9i2otFuA.png"/></div></div></figure><p id="ecc2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">开始深度做梦吧！</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lw"><img src="../Images/7e6b9c6b111e7f20f1654bf44f68eaae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*kqsZRqUcwkHntMDmbAPoTg.jpeg"/></div></figure><h1 id="89b8" class="lx jv hi bd jw ly lz ma ka mb mc md ke me mf mg kh mh mi mj kk mk ml mm kn mn bi translated">生成深度梦境视频</h1><p id="b1fc" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">现在您已经了解了基本知识，您可以使用Deep Dream IPython笔记本获得许多乐趣！例如，您可以使用其中一个代码片段来生成100帧(或更多)，方法是递归地提供Deep Dream自己的输出，并对其应用一点缩放。它将“导致网络在培训期间看到的事物的印象源源不断”，以及一些非常酷的图像。</p><p id="edc5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以将所有生成的帧复制到容器之外:</p><pre class="jf jg jh ji fd lk ll lm ln aw lo bi"><span id="939d" class="ju jv hi ll b fi lp lq l lr ls">$ docker cp containerid:/deepdream/deepdream/frames ~/</span></pre><p id="708d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并使用ffmpeg将它们拼接在一起，以制作一个深度梦境视频:</p><pre class="jf jg jh ji fd lk ll lm ln aw lo bi"><span id="4598" class="ju jv hi ll b fi lp lq l lr ls">$ ffmpeg -framerate 30 -pattern_type glob -i '*.jpg' -c:v libx264 -r 30 -pix_fmt yuv420p out.mp4</span></pre><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mo lj l"/></div></figure><h1 id="a29f" class="lx jv hi bd jw ly lz ma ka mb mc md ke me mf mg kh mh mi mj kk mk ml mm kn mn bi translated">进入深度梦境的最简单方法</h1><p id="1720" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">运行IPython Notebook并使用UI创建深度梦境图像可能相当麻烦。我需要一种简单的方法，能够利用我的Docker机器上的CPU在谷歌计算引擎上创建深度梦境图像。为此，我创建了一个CLI友好的Docker容器，您可以在deepdream-cli-docker库下的<a class="ae jd" href="https://github.com/saturnism/deepdream-cli-docker" rel="noopener ugc nofollow" target="_blank"> my GitHub上找到源代码。</a></p><p id="8dc0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要使用它，首先构建图像:</p><pre class="jf jg jh ji fd lk ll lm ln aw lo bi"><span id="6b22" class="ju jv hi ll b fi lp lq l lr ls">$ git clone <a class="ae jd" href="https://github.com/saturnism/deepdream-cli-docker.git" rel="noopener ugc nofollow" target="_blank">https://github.com/saturnism/deepdream-cli-docker.git</a><br/>$ cd deepdream-cli-docker<br/>$ docker build -t deepdream-cli .</span></pre><p id="848c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后你可以直接从命令行生成深度梦境图像。它使用了我从使用Docker机器中学到的一些<a class="ae jd" rel="noopener" href="/google-cloud-platform-developer-advocates/my-slow-internet-vs-docker-7678ae1cae72">技巧和诀窍，这些是构建与UNIX命令行配合良好的容器的简便方法:</a></p><pre class="jf jg jh ji fd lk ll lm ln aw lo bi"><span id="1892" class="ju jv hi ll b fi lp lq l lr ls">$ cat moon.jpg | docker run -i deepdream-cli &gt; output.jpg</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lw"><img src="../Images/71218f3a83dd392b9af909a6eaaf5520.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*AmGQIbWtBiwQCKsgKeWjYw.jpeg"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">梦里的月亮。<a class="ae jd" href="https://www.flickr.com/photos/saturnism/3883002417/" rel="noopener ugc nofollow" target="_blank">Flickr上的原创</a></figcaption></figure><p id="5a48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你也可以试验一些变量，在不同的神经网络层次，用不同的迭代和八度音阶来深度做梦。生成的图像可能差异很大:</p><pre class="jf jg jh ji fd lk ll lm ln aw lo bi"><span id="a26c" class="ju jv hi ll b fi lp lq l lr ls">$ cat myimage.jpg | docker run -i deepdream-cli -l conv2/3x3 -o 6 &gt; output.jpg</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lw"><img src="../Images/4a758e48a001b8a911db690eaf34f95e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*RPX9wa4j4kjR_Zok1JqFuw.jpeg"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">梦里的月亮。<a class="ae jd" href="https://www.flickr.com/photos/saturnism/3883002417/" rel="noopener ugc nofollow" target="_blank">Flickr上的原创</a></figcaption></figure><p id="99a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就像任何命令行工具一样，您可以在这里找到所有可能的参数:</p><pre class="jf jg jh ji fd lk ll lm ln aw lo bi"><span id="dcf3" class="ju jv hi ll b fi lp lq l lr ls">$ docker run deepdream-cli -h</span></pre><p id="f5f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，深梦过程是单线程的。拥有更多CPU并不会减少生成单个图像的时间。但是，您可以一次生成多个图像，以便更好地利用资源。例如，要处理一个目录下的所有图像:</p><pre class="jf jg jh ji fd lk ll lm ln aw lo bi"><span id="7de3" class="ju jv hi ll b fi lp lq l lr ls">for f in *.jpg; \<br/>  do { cat $f | docker run -i deepdream-cli &gt; out_$f; } &amp; \<br/>done;</span></pre></div></div>    
</body>
</html>