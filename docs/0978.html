<html>
<head>
<title>Deploy Swift HTTP Serverless Container to Google Cloud Run in 5 minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">5分钟内将Swift HTTP无服务器容器部署到Google Cloud Run</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/deploy-swift-http-serverless-container-to-google-cloud-run-in-5-minutes-alfian-losari-98389d34d4b8?source=collection_archive---------1-----------------------#2019-04-23">https://medium.com/google-cloud/deploy-swift-http-serverless-container-to-google-cloud-run-in-5-minutes-alfian-losari-98389d34d4b8?source=collection_archive---------1-----------------------#2019-04-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ab3fa120ae0eb10cd4f501a6b486a984.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OVwYaKjyMrvuk6pBNjCGXA.png"/></div></div></figure><p id="98bc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你也可以使用下面的链接在我的Xcoding With Alfian博客网站上阅读这篇文章。</p><div class="jo jp ez fb jq jr"><a href="https://www.alfianlosari.com/posts/deploy-swift-http-containt-to-google-cloud-run-in-5minutes" rel="noopener  ugc nofollow" target="_blank"><div class="js ab dw"><div class="jt ab ju cl cj jv"><h2 class="bd hj fi z dy jw ea eb jx ed ef hh bi translated">将Swift HTTP无服务器容器部署到Google Cloud在5分钟内运行| Xcoding with Alfian |…</h2><div class="jy l"><h3 class="bd b fi z dy jw ea eb jx ed ef dx translated">在Google Cloud Next 2019上，谷歌刚刚推出了Google Cloud Run。这是一种无服务器计算服务，它…</h3></div><div class="jz l"><p class="bd b fp z dy jw ea eb jx ed ef dx translated">www.alfianlosari.com</p></div></div><div class="ka l"><div class="kb l kc kd ke ka kf io jr"/></div></div></a></div><p id="0bc7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在Google Cloud Next 2019上，谷歌刚刚推出了Google Cloud Run。这是一种无服务器计算服务，这意味着我们不必自己管理基础设施。它基于容器，所以我们只需要提供包含我们的HTTP服务器应用程序和部署的Dockerfile。该服务将通过来自客户端的HTTP请求进行调用，付款将使用按使用付费模式。</p><p id="8403" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Google Cloud为云运行提供了许多功能，例如:</p><ol class=""><li id="9518" class="kg kh hi is b it iu ix iy jb ki jf kj jj kk jn kl km kn ko bi translated">快速自动缩放，根据流量自动缩放我们的应用程序。</li><li id="aa25" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">基于容器，使用Docker容器来构建和部署我们的服务。</li><li id="cf04" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">没有DevOps。我们所需要做的就是部署我们的容器，谷歌云将为我们管理所有其余的事情。</li><li id="46b6" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">基于Knative，可移植性意味着我们也可以跨平台部署到Google Kubernetes引擎(GKE集群)。</li><li id="b3b8" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">用StackDriver集成日志和监控。</li><li id="b875" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">能够使用我们自己的自定义域。</li></ol><p id="9a71" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以通过下面的官方链接直接从谷歌了解更多关于Cloud Run的信息。</p><div class="jo jp ez fb jq jr"><a href="https://cloud.google.com/run/" rel="noopener  ugc nofollow" target="_blank"><div class="js ab dw"><div class="jt ab ju cl cj jv"><h2 class="bd hj fi z dy jw ea eb jx ed ef hh bi translated">云运行|谷歌云</h2><div class="jy l"><h3 class="bd b fi z dy jw ea eb jx ed ef dx translated">在完全托管的环境中或在您自己的GKE集群中运行无状态HTTP容器。</h3></div><div class="jz l"><p class="bd b fp z dy jw ea eb jx ed ef dx translated">cloud.google.com</p></div></div><div class="ka l"><div class="ku l kc kd ke ka kf io jr"/></div></div></a></div><h1 id="77d2" class="kv kw hi bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">我们将建造什么</h1><p id="973a" class="pw-post-body-paragraph iq ir hi is b it lt iv iw ix lu iz ja jb lv jd je jf lw jh ji jj lx jl jm jn hb bi translated">在本文中，我们将使用Dockerfile将一个简单的Swift HTTP Server应用程序部署到Google Cloud Run。为此，我们将使用带有命令行的Google Cloud SDK。我们只需要执行4项主要任务:</p><ol class=""><li id="e3f3" class="kg kh hi is b it iu ix iy jb ki jf kj jj kk jn kl km kn ko bi translated">准备我们的HTTP Swift应用程序。</li><li id="7d22" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">构建Dockerfile文件。</li><li id="d2ff" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">上传到容器注册表。</li><li id="96fc" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">将容器部署到Google Cloud Run。</li></ol><h1 id="d84b" class="kv kw hi bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">设置Google云</h1><p id="9dc2" class="pw-post-body-paragraph iq ir hi is b it lt iv iw ix lu iz ja jb lv jd je jf lw jh ji jj lx jl jm jn hb bi translated">在你开始之前，这里有一些你需要的东西:</p><ol class=""><li id="8b36" class="kg kh hi is b it iu ix iy jb ki jf kj jj kk jn kl km kn ko bi translated">注册并登录谷歌云平台。(<a class="ae ly" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/</a>)。</li><li id="bf5c" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">下载Google Cloud SDK并安装到您的机器上。(<a class="ae ly" href="https://cloud.google.com/sdk/install" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/sdk/install</a>)。</li><li id="f21e" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">从Google Cloud控制台创建一个新项目。</li><li id="7b7e" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">确保按照这里的所有步骤为您的项目激活Google Cloud Run API。(<a class="ae ly" href="https://cloud.google.com/run/docs/setup" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/run/docs/setup</a>)。</li></ol><h1 id="4fe0" class="kv kw hi bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">准备我们的HTTP Swift申请</h1><p id="dd1e" class="pw-post-body-paragraph iq ir hi is b it lt iv iw ix lu iz ja jb lv jd je jf lw jh ji jj lx jl jm jn hb bi translated">打开您的终端/shell，创建一个名为<code class="du lz ma mb mc b">hello-swift-cloudrun</code>的新目录，并导航到该目录。</p><pre class="md me mf mg fd mh mc mi mj aw mk bi"><span id="8944" class="ml kw hi mc b fi mm mn l mo mp">mkdir hello-swift-cloudrun<br/>cd hello-swift-cloudrun</span></pre><p id="e7dc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在目录中，创建一个新的swift包。</p><pre class="md me mf mg fd mh mc mi mj aw mk bi"><span id="cf1d" class="ml kw hi mc b fi mm mn l mo mp">swift package init --type executable</span></pre><p id="756d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，打开<code class="du lz ma mb mc b">Package.swift</code>，将下面的代码复制到文件中。我们将添加<code class="du lz ma mb mc b">Swifter</code> tiny HTTP服务器库作为在Swift中运行我们的HTTP服务器的依赖项。</p><pre class="md me mf mg fd mh mc mi mj aw mk bi"><span id="f73e" class="ml kw hi mc b fi mm mn l mo mp">/ swift-tools-version:5.0<br/>// The swift-tools-version declares the minimum version of Swift required to build this package.</span><span id="d534" class="ml kw hi mc b fi mq mn l mo mp">import PackageDescription</span><span id="8dab" class="ml kw hi mc b fi mq mn l mo mp">let package = Package(<br/>    name: "hello-swift-cloudrun",<br/>    dependencies: [<br/>        .package(url: "<a class="ae ly" href="https://github.com/httpswift/swifter.git" rel="noopener ugc nofollow" target="_blank">https://github.com/httpswift/swifter.git</a>", .upToNextMajor(from: "1.4.6"))<br/>    ],<br/>    targets: [<br/>        .target(<br/>            name: "hello-swift-cloudrun",<br/>            dependencies: ["Swifter"]),<br/>        .testTarget(<br/>            name: "hello-swift-cloudrunTests",<br/>            dependencies: ["hello-swift-cloudrun"]),<br/>    .]<br/>)</span></pre><p id="8cb3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，从<code class="du lz ma mb mc b">Sources</code>目录中打开<code class="du lz ma mb mc b">main.swift</code>文件。复制下面的代码。</p><figure class="md me mf mg fd ij"><div class="bz dy l di"><div class="mr ms l"/></div></figure><p id="bdab" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是它执行的操作:</p><ol class=""><li id="79a3" class="kg kh hi is b it iu ix iy jb ki jf kj jj kk jn kl km kn ko bi translated">注册2条路线<code class="du lz ma mb mc b">/html</code>和<code class="du lz ma mb mc b">/api</code>。这些路由将返回包含使用<code class="du lz ma mb mc b">DateFormatter</code>格式化的当前日期的响应。<code class="du lz ma mb mc b">html</code>路径将以<code class="du lz ma mb mc b">HTML</code>格式返回文本，而<code class="du lz ma mb mc b">api</code>路径将以<code class="du lz ma mb mc b">JSON</code>格式返回响应。</li><li id="b372" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">从环境变量中检索<code class="du lz ma mb mc b">PORT</code>。</li><li id="d7db" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">启动<code class="du lz ma mb mc b">HTTPServer</code>通过<code class="du lz ma mb mc b">PORT</code>监听端口中的请求。</li></ol><p id="7f7e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在终端上键入以下命令，尝试构建并运行服务器。</p><pre class="md me mf mg fd mh mc mi mj aw mk bi"><span id="69f7" class="ml kw hi mc b fi mm mn l mo mp">swift build<br/>swift run</span></pre><p id="95e5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要进行测试，请打开浏览器并导航至地址<code class="du lz ma mb mc b"><a class="ae ly" href="http://localhost:8080/html`" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/html</a></code>。您应该会在浏览器中看到显示当前时间的文本。</p><figure class="md me mf mg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mt"><img src="../Images/d49f7d7e769bc5839396eabd39e0f089.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RymCRmwFCehocAhUT2Gfkw.png"/></div></div><figcaption class="mu mv et er es mw mx bd b be z dx translated">Swift HTTP服务器</figcaption></figure><h1 id="80b5" class="kv kw hi bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">构建Dockerfile文件</h1><p id="e22f" class="pw-post-body-paragraph iq ir hi is b it lt iv iw ix lu iz ja jb lv jd je jf lw jh ji jj lx jl jm jn hb bi translated">接下来，我们将通过创建<code class="du lz ma mb mc b">Dockerfile</code>来容器化我们的应用程序。创建文件并复制下面的代码。</p><pre class="md me mf mg fd mh mc mi mj aw mk bi"><span id="4bc8" class="ml kw hi mc b fi mm mn l mo mp">FROM ibmcom/swift-ubuntu:latest</span><span id="8b30" class="ml kw hi mc b fi mq mn l mo mp">WORKDIR /usr/src/app</span><span id="fddf" class="ml kw hi mc b fi mq mn l mo mp">COPY . .</span><span id="19c5" class="ml kw hi mc b fi mq mn l mo mp">RUN swift build --configuration release</span><span id="ad12" class="ml kw hi mc b fi mq mn l mo mp">CMD [ "swift", "run", "--configuration", "release"  ]</span></pre><p id="7dc6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将把所有文件复制到容器映像，然后使用发布配置运行<code class="du lz ma mb mc b">swift build</code>。它还将在构建完成后运行服务器。</p><h1 id="a145" class="kv kw hi bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">上传到容器注册表</h1><p id="0034" class="pw-post-body-paragraph iq ir hi is b it lt iv iw ix lu iz ja jb lv jd je jf lw jh ji jj lx jl jm jn hb bi translated">接下来，我们需要将我们的容器上传到<code class="du lz ma mb mc b">Cloud Registry</code>。确保为您的项目检索您的<code class="du lz ma mb mc b">project id</code>。运行下面的命令。</p><pre class="md me mf mg fd mh mc mi mj aw mk bi"><span id="c961" class="ml kw hi mc b fi mm mn l mo mp">gcloud builds submit --tag gcr.io/[PROJECT-ID]/hello-swift-cloudrun</span></pre><p id="19f3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">等待容器构建过程完成，然后上传到容器注册表。它会将<code class="du lz ma mb mc b">success</code>消息打印到终端。</p><p id="335f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以使用此命令检查成功上传的容器列表。</p><pre class="md me mf mg fd mh mc mi mj aw mk bi"><span id="3dea" class="ml kw hi mc b fi mm mn l mo mp">gcloud container images list</span></pre><h1 id="4b15" class="kv kw hi bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">部署容器到Google Cloud Run</h1><p id="593d" class="pw-post-body-paragraph iq ir hi is b it lt iv iw ix lu iz ja jb lv jd je jf lw jh ji jj lx jl jm jn hb bi translated">最后，我们需要将图像部署到Google Cloud Run。键入以下命令。</p><pre class="md me mf mg fd mh mc mi mj aw mk bi"><span id="45f9" class="ml kw hi mc b fi mm mn l mo mp">gcloud config set run/region us-central1<br/>gcloud beta run deploy --image gcr.io/[PROJECT-ID]/hello-swift-cloudrun --memory 512M --allow-unauthenticated</span></pre><p id="58d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是它执行的几项操作:</p><ol class=""><li id="09ce" class="kg kh hi is b it iu ix iy jb ki jf kj jj kk jn kl km kn ko bi translated">将部署区域设置为<code class="du lz ma mb mc b">us-central1</code>。</li><li id="afc0" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">在本例中，从容器注册表路径部署映像<code class="du lz ma mb mc b">hello-swift-cloudrun</code>。</li><li id="e8c9" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">配置使用512M内存使用。</li><li id="a202" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated">允许未经身份验证的请求调用HTTP。</li></ol><p id="d50b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以从内存、并发性和请求超时等方面配置其他内容。查看下面的链接</p><div class="jo jp ez fb jq jr"><a href="https://cloud.google.com/run/docs/configuring/memory-limits" rel="noopener  ugc nofollow" target="_blank"><div class="js ab dw"><div class="jt ab ju cl cj jv"><h2 class="bd hj fi z dy jw ea eb jx ed ef hh bi translated">配置内存限制|云运行| Google云</h2><div class="jy l"><h3 class="bd b fi z dy jw ea eb jx ed ef dx translated">无论您的企业是刚刚踏上数字化转型之旅，还是已经走上数字化转型之路，谷歌云的解决方案…</h3></div><div class="jz l"><p class="bd b fp z dy jw ea eb jx ed ef dx translated">cloud.google.com</p></div></div><div class="ka l"><div class="my l kc kd ke ka kf io jr"/></div></div></a></div><p id="34e9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">部署成功完成后，终端会打印出我们可以使用的已部署服务的<code class="du lz ma mb mc b">URL endpoint</code>。打开浏览器并导航至:</p><ol class=""><li id="37c7" class="kg kh hi is b it iu ix iy jb ki jf kj jj kk jn kl km kn ko bi translated"><a class="ae ly" rel="noopener ugc nofollow" target="_blank" href="/$URL/html"> https://$URL/html </a></li><li id="e95d" class="kg kh hi is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko bi translated"><a class="ae ly" rel="noopener ugc nofollow" target="_blank" href="/$URL/api"> https://$URL/ </a> api</li></ol><h1 id="1f46" class="kv kw hi bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">通过仪表板监控</h1><p id="cc16" class="pw-post-body-paragraph iq ir hi is b it lt iv iw ix lu iz ja jb lv jd je jf lw jh ji jj lx jl jm jn hb bi translated">您可以从控制台仪表板查看所有部署到云运行的服务。</p><p id="50e0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae ly" href="https://console.cloud.google.com/run?project=k-alfian" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/run</a></p><div class="md me mf mg fd ab cb"><figure class="mz ij na nb nc nd ne paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/08fa833583922b75c25ec13f2b295122.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*JRv3s15dYWZrC_jr2xr-CQ.png"/></div></figure><figure class="mz ij nf nb nc nd ne paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><img src="../Images/50f4580e43af82a862bb341c58db549b.png" data-original-src="https://miro.medium.com/v2/resize:fit:854/format:webp/1*p5XcO-XzfQb9Owp5H7-Asg.png"/></div><figcaption class="mu mv et er es mw mx bd b be z dx ng di nh ni translated">云运行仪表板</figcaption></figure></div><p id="89fa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这里，您还可以管理自定义域、删除和创建服务，以及查看您部署的服务的日志。</p><p id="3dda" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">！！！确保在你完成这篇文章后删除所有你创建的资源，以避免账单！！！</strong></p><h1 id="134b" class="kv kw hi bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">结论</h1><p id="5dce" class="pw-post-body-paragraph iq ir hi is b it lt iv iw ix lu iz ja jb lv jd je jf lw jh ji jj lx jl jm jn hb bi translated">您可以在下面的存储库中克隆完成的项目。</p><div class="jo jp ez fb jq jr"><a href="https://github.com/alfianlosari/SwiftCloudRun" rel="noopener  ugc nofollow" target="_blank"><div class="js ab dw"><div class="jt ab ju cl cj jv"><h2 class="bd hj fi z dy jw ea eb jx ed ef hh bi translated">alfianlosari/SwiftCloudRun</h2><div class="jy l"><h3 class="bd b fi z dy jw ea eb jx ed ef dx translated">使用Google Cloud Run的Swift HTTP无服务器Docker部署示例- alfianlosari/SwiftCloudRun</h3></div><div class="jz l"><p class="bd b fp z dy jw ea eb jx ed ef dx translated">github.com</p></div></div><div class="ka l"><div class="nj l kc kd ke ka kf io jr"/></div></div></a></div><p id="10c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就这样，通过简单的步骤，我们已经使用Docker将我们的无服务器后端部署到Google Cloud Run managed auto scaling服务。无服务器范例为我们提供了快速执行的速度和可靠性，因为我们的应用程序的规模会随着时间的推移而增长⚡️⚡️⚡️.</p></div></div>    
</body>
</html>