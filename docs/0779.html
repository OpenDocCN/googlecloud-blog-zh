<html>
<head>
<title>Stackdriver Monitoring Automation Part 2: Alerting Policies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">堆栈驱动程序监控自动化第2部分:警报策略</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/stackdriver-monitoring-automation-part-2-alerting-policies-9f42068603c4?source=collection_archive---------0-----------------------#2018-09-28">https://medium.com/google-cloud/stackdriver-monitoring-automation-part-2-alerting-policies-9f42068603c4?source=collection_archive---------0-----------------------#2018-09-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b18f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章是Stackdriver自动化系列的第2部分。在第1部分中，我介绍了Stackdriver组的自动化管理。在这篇文章中，我将介绍您可以用来自动管理警报策略的步骤。阅读第1部分了解背景知识和先决条件。</p><h1 id="2165" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">警报策略</h1><p id="e142" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/alerts/" rel="noopener ugc nofollow" target="_blank">警报策略</a>允许您定义一组条件，当事件被触发时，这些条件将生成通知。通知可以选择性地包含文档和元数据，以向接收警报的人提供附加信息。警报策略可以是独立的，也可以附加到堆栈驱动程序组。</p><p id="9621" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有几种不同的通知渠道，包括电子邮件和短信通知，以及与第三方的集成，如PagerDuty、HipChat和Slack。或者，每当生成通知时，您可以使用webhook调用您定义的服务。<a class="ae jd" href="https://cloud.google.com/monitoring/alerts/concepts-indepth#condition-types" rel="noopener ugc nofollow" target="_blank">警报条件</a>的类型与监控过滤器一起提供了丰富的选项来定制您的通知。</p><p id="f4ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，我基于我在第1部分中描述的apache基础设施创建了警报。该应用程序本身是一个简单的网站，由负载平衡器后面的apache服务器托管。选择rational alerting需要考虑应用程序的用户和应用程序架构。我求助于<a class="ae jd" href="https://landing.google.com/sre/interview/ben-treynor.html" rel="noopener ugc nofollow" target="_blank">站点可靠性工程</a> (SRE)方法来选择用于报警的指标。</p><p id="ec1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">SRE有一个服务水平指标(SLIs)的概念，作为一种方法来跟踪你的应用程序的性能指标，通过用户影响来衡量。好的SLIs应该让你很容易知道什么时候你的应用程序的性能让你的用户感到沮丧，什么时候你的用户使用应用程序的体验很好。主要的SLI类别是延迟、可用性、数量和质量。本文使用这些sli来驱动警报。对于生产应用程序，sli的选择应该更加严格。这毕竟是一个演示应用程序！</p><h1 id="9f1a" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">SLI预警指标</h1><p id="d049" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我选择的主要堆栈驱动程序警报条件、通知和文档如下:</p><p id="c766" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">条件</strong></p><p id="8b5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kh">可用性&amp;质量:</em></p><ul class=""><li id="a8b0" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated">L7负载平衡器错误请求计数= 0/秒</li></ul><p id="a93b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kh">等待时间:</em></p><ul class=""><li id="9ab3" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated">L7负载平衡器总延迟&gt; 100毫秒</li><li id="243e" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated">L7负载平衡器前端RTT延迟&gt; 50毫秒</li><li id="345a" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated">L7负载平衡器后端RTT延迟&gt; 50毫秒</li></ul><p id="e69b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kh">为音量:</em></p><ul class=""><li id="2c60" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated">L7负载平衡器请求计数&gt; 100/秒</li></ul><p id="f6b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">通知渠道</strong></p><ul class=""><li id="0c26" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated">邮箱:【website-oncall@example.com T4】</li><li id="1c14" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated">电子邮件:support-website@example.com</li></ul><p id="5879" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">文档</strong></p><ul class=""><li id="151d" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated">描述每个警报策略的特定文本</li></ul><p id="8175" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然已经确定了要监控的具体指标和通知方法，我需要将这些规则转换成Stackdriver AlertingPolicies API接受的格式。</p><p id="ed91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.alertPolicies/create" rel="noopener ugc nofollow" target="_blank">projects . alert policies . create</a>API列出了创建警报策略所需的以下值。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="7e8f" class="lf jf hi lb b fi lg lh l li lj">{<br/>  "name": string,<br/>  "displayName": string,<br/>  "documentation": {<br/>    object(Documentation)<br/>  },<br/>  "userLabels": {<br/>    string: string,<br/>    ...<br/>  },<br/>  "conditions": [<br/>    {<br/>      object(Condition)<br/>    }<br/>  ],<br/>  "combiner": enum(ConditionCombinerType),<br/>  "enabled": boolean,<br/>  "notificationChannels": [<br/>    string<br/>  ],<br/>  "creationRecord": {<br/>    object(MutationRecord)<br/>  },<br/>  "mutationRecord": {<br/>    object(MutationRecord)<br/>  }<br/>}</span></pre><p id="1fc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">警报策略非常灵活，能够过滤、分组、聚合，然后测量指标随时间的变化。我尝试在UI中创建警报策略，然后使用<a class="ae jd" href="https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.alertPolicies/create" rel="noopener ugc nofollow" target="_blank">projects . alert policies . create</a>文档中的“Try this API”侧栏来查看结果配置。这种方法以及Stackdriver监控文档有助于将我选择的5种警报条件转化为5种警报策略。我将模板分为jinja模板和yaml文件，这样我就可以将jinja模板重新用于任何其他警报策略。</p><p id="b12b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">stack driver _ alerting policies . jinja</strong></p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="64a5" class="lf jf hi lb b fi lg lh l li lj">{% set PREFIX = env["deployment"] %}<br/>{% set NOTIFICATION_EMAILS = properties["notificationEmails"] %}<br/>{% set POLICIES = properties["policies"] %}<br/>{% set PROJECT = env["project"] %}<br/>{% set DEFAULT_MIME_TYPE = "text/markdown" %}</span><span id="7c10" class="lf jf hi lb b fi lk lh l li lj">resources:<br/>{% for email in NOTIFICATION_EMAILS %}<br/>- name: {{ PREFIX }}-email-{{ loop.index }}<br/>  type: gcp-types/monitoring-v3:projects.notificationChannels<br/>  properties:<br/>    name: projects/{{ PROJECT }}<br/>    type: email<br/>    displayName: {{ email.displayName }}<br/>    labels:<br/>      email_address: {{ email.emailAddress }}<br/>    enabled: true<br/>{% endfor %}</span><span id="2218" class="lf jf hi lb b fi lk lh l li lj">{% for policy in POLICIES %}<br/>- name: {{ PREFIX }}-alertingpolicy-{{ loop.index }}<br/>  type: gcp-types/monitoring-v3:projects.alertPolicies<br/>  properties:<br/>    displayName: {{ PREFIX }}-{{ policy.name }}<br/>    documentation:<br/>      content: {{ policy.documentation.content }}<br/>      mimeType:  {{ DEFAULT_MIME_TYPE }}<br/>    combiner: OR<br/>    conditions:<br/>{% for condition in policy.conditions %}<br/>    - displayName: {{ condition.displayName }}<br/>      conditionThreshold:<br/>        filter: {{ condition.filter }}<br/>        comparison: {{condition.comparison }}<br/>        duration: {{ condition.duration }}<br/>        thresholdValue: {{ condition.thresholdValue }}<br/>        trigger: {{ condition.trigger }}<br/>        aggregations: {{ condition.aggregations }}<br/>{% endfor  %}        <br/>    notificationChannels:<br/>{% for notification in NOTIFICATION_EMAILS %}<br/>    - $(ref.{{ PREFIX }}-email-{{ loop.index }}.name)<br/>{% endfor %}<br/>    enabled: true<br/>{% endfor %}</span></pre><p id="b085" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，我用多个通知通道和策略创建了yaml。我将电子邮件通知的创建与策略分开，并将相同的电子邮件通知添加到jinja模板中的每个策略中。</p><p id="c93c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">stack driver _ alerting policies . YAML</strong></p><p id="318e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，为了便于阅读，我在这里只包括了两个警报策略。完整的yaml文件见<a class="ae jd" href="https://github.com/charlesbaer/stackdriver-automation" rel="noopener ugc nofollow" target="_blank"> github </a> repo。</p><div class="ll lm ez fb ln lo"><a href="https://github.com/charlesbaer/stackdriver-automation" rel="noopener  ugc nofollow" target="_blank"><div class="lp ab dw"><div class="lq ab lr cl cj ls"><h2 class="bd hj fi z dy lt ea eb lu ed ef hh bi translated">Charles Baer/stack driver-自动化</h2><div class="lv l"><h3 class="bd b fi z dy lt ea eb lu ed ef dx translated">Stackdriver监控自动化中后期的配套github repo。…</h3></div><div class="lw l"><p class="bd b fp z dy lt ea eb lu ed ef dx translated">github.com</p></div></div><div class="lx l"><div class="ly l lz ma mb lx mc md lo"/></div></div></a></div><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="55a3" class="lf jf hi lb b fi lg lh l li lj">imports:<br/>- path: stackdriver_alertingpolicies.jinja<br/>resources:<br/>- name: create_alertingpolicies<br/>  type: stackdriver_alertingpolicies.jinja<br/>  properties:<br/>    notificationEmails:<br/>    - emailAddress: <a class="ae jd" href="mailto:website-oncall@example.com" rel="noopener ugc nofollow" target="_blank">website-oncall@example.com</a><br/>      displayName: "Website Oncall" <br/>    - emailAddress: <a class="ae jd" href="mailto:support-website@example.com" rel="noopener ugc nofollow" target="_blank">support-website@example.com</a><br/>      displayName: "Website Support"  <br/>    policies:<br/>    - name: "1 - Availability - Google Cloud HTTP/S Load Balancing Rule - Request count (filtered) [COUNT]"   <br/>      conditions: <br/>      - filter: "metric.type=\"loadbalancing.googleapis.com/https/request_count\" resource.type=\"https_lb_rule\" metric.label.response_code!=\"200\"" <br/>        comparison: "COMPARISON_GT"<br/>        duration: "60s" <br/>        thresholdValue: 1 <br/>        trigger:<br/>          count: 1<br/>        aggregations:<br/>        - alignmentPeriod: "60s"<br/>          perSeriesAligner: "ALIGN_RATE"<br/>          crossSeriesReducer: "REDUCE_COUNT"<br/>        displayName: "Google Cloud HTTP/S Load Balancing Rule - Request count (filtered) [COUNT]"<br/>      documentation:<br/>        content: "The load balancer rule ${condition.display_name} has generated this alert for the ${metric.display_name}."<br/>    - name: "2 - Latency - Google Cloud HTTP/S Load Balancing Rule - Total Latency (filtered) [99 percentile]"   <br/>      conditions: <br/>      - filter: "metric.type=\"loadbalancing.googleapis.com/https/total_latencies\" resource.type=\"https_lb_rule\" resource.label.url_map_name=\"web-map\"" <br/>        comparison: "COMPARISON_GT"<br/>        duration: "60s" <br/>        thresholdValue: 100 <br/>        trigger:<br/>          count: 1<br/>        aggregations:<br/>        - alignmentPeriod: "60s"<br/>          perSeriesAligner: "ALIGN_PERCENTILE_99"<br/>        displayName: "Google Cloud HTTP/S Load Balancing Rule - Total Latency (filtered) [99 percentile]"<br/>      documentation:<br/>        content: "The load balancer rule ${condition.display_name} has generated this alert for the ${metric.display_name}."</span></pre><p id="1135" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在<a class="ae jd" href="https://github.com/charlesbaer/stackdriver-automation" rel="noopener ugc nofollow" target="_blank"> github repo </a>上找到jinja和yaml文件。</p><p id="5f37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后一步是使用下面的gcloud命令行来实际创建Stackdriver警报策略。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="4791" class="lf jf hi lb b fi lg lh l li lj">$ gcloud deployment-manager deployments create stackdriver-alertingpolicies-apache --config stackdriver_alertingpolicies.yaml</span><span id="3321" class="lf jf hi lb b fi lk lh l li lj">Create operation operation-1537809007185-576a10f9b0c68-751256f4-45889de0 completed successfully.<br/>NAME                                                  TYPE                                                   STATE      ERRORS  INTENT<br/>stackdriver-alertingpolicies-apache-alertingpolicy-1  gcp-types/monitoring-v3:projects.alertPolicies         COMPLETED  []<br/>stackdriver-alertingpolicies-apache-alertingpolicy-2  gcp-types/monitoring-v3:projects.alertPolicies         COMPLETED  []<br/>stackdriver-alertingpolicies-apache-alertingpolicy-3  gcp-types/monitoring-v3:projects.alertPolicies         COMPLETED  []<br/>stackdriver-alertingpolicies-apache-alertingpolicy-4  gcp-types/monitoring-v3:projects.alertPolicies         COMPLETED  []<br/>stackdriver-alertingpolicies-apache-alertingpolicy-5  gcp-types/monitoring-v3:projects.alertPolicies         COMPLETED  []<br/>stackdriver-alertingpolicies-apache-email-1           gcp-types/monitoring-v3:projects.notificationChannels  COMPLETED  []<br/>stackdriver-alertingpolicies-apache-email-2           gcp-types/monitoring-v3:projects.notificationChannels  COMPLETED  []</span></pre><p id="bfd1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建警报策略后，我使用Stackdriver监控控制台来验证警报策略是否已成功创建。</p><figure class="kw kx ky kz fd mf er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es me"><img src="../Images/99be5ebfb93165607957feafbc8bd5b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b1P4hJjcDoz_-_ss"/></div></div></figure><h1 id="3d12" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">测试警报</h1><p id="74d5" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我有意将度量值设置得较低，以便于测试警报。在本例中，为警报选择低延迟值会生成警报，您可以使用这些警报来验证警报是否成功到达以及是否包含您想要的详细信息。这是我收到的一个警报示例。</p><figure class="kw kx ky kz fd mf er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es ml"><img src="../Images/74ee5a4f33d8414c7f728beb0a3fb901.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hq_Vqi8f5yNmqr9PCQUtVw.png"/></div></div></figure><p id="baf1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">只要导致警报的条件得到解决，警报就会自动得到解决。下面是电子邮件提醒解决方案的示例。</p><figure class="kw kx ky kz fd mf er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mm"><img src="../Images/9e332cbe113ecf8ec83f78d8870cba4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ETNEmjmQP9Kb6TWK2Qfgsw.png"/></div></div></figure><p id="b5e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本系列的第2部分到此结束。在本系列的其他文章和下面的参考资料中阅读更多关于Stackdriver监控自动化的内容。</p><ul class=""><li id="5bf8" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/stackdriver-automation-part-1-stackdriver-groups-8e51f0aa9b03"> Stackdriver自动化第1部分:Stackdriver组</a></li><li id="6cce" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae jd" rel="noopener" href="/@charles.baer/stackdriver-automation-part-3-uptime-checks-476b8507f59c">堆栈驱动自动化第3部分:堆栈驱动正常运行时间检查</a></li></ul><p id="9e2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考资料:</p><ul class=""><li id="b097" class="ki kj hi ih b ii ij im in iq kk iu kl iy km jc kn ko kp kq bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/docs/" rel="noopener ugc nofollow" target="_blank">堆栈驱动监控文件</a></li><li id="713d" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/api/ref_v3/rest/" rel="noopener ugc nofollow" target="_blank">栈驱动监控API文档</a></li><li id="3666" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/api/v3/filters" rel="noopener ugc nofollow" target="_blank">堆栈驱动监控过滤器</a></li><li id="9222" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae jd" href="https://cloud.google.com/monitoring/api/metrics_gcp" rel="noopener ugc nofollow" target="_blank">堆栈驱动程序监控指标</a></li><li id="4f2e" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae jd" href="https://cloud.google.com/deployment-manager/docs/" rel="noopener ugc nofollow" target="_blank">谷歌云部署管理器</a></li><li id="ec80" class="ki kj hi ih b ii kr im ks iq kt iu ku iy kv jc kn ko kp kq bi translated"><a class="ae jd" href="https://github.com/GoogleCloudPlatform/deploymentmanager-samples" rel="noopener ugc nofollow" target="_blank">部署管理器示例</a></li></ul></div></div>    
</body>
</html>