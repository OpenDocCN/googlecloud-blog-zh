<html>
<head>
<title>Cutting costs on Kubernetes Cluster (GKE)— Concepts Applied</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">降低Kubernetes集群(GKE)的成本—应用的概念</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/cutting-costs-on-kubernetes-cluster-gke-concepts-applied-cc340eba0bec?source=collection_archive---------0-----------------------#2019-01-06">https://medium.com/google-cloud/cutting-costs-on-kubernetes-cluster-gke-concepts-applied-cc340eba0bec?source=collection_archive---------0-----------------------#2019-01-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex if ig ih ii"><div class="bz dy l di"><div class="ij ik l"/></div></figure><blockquote class="il im in"><p id="97d1" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">免责声明:-此博客补充了参考资料部分提到的博客，以进一步降低您的基础设施成本。将所有这些放在一起将<strong class="ir hj">显著</strong>降低您的云基础设施成本。</p></blockquote><p id="bd6b" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated">降低现有基础设施成本对任何组织来说都是一项成就。在这篇博客中，让我们在K8s集群上实现这一点，毕竟它是任何现代云it基础架构的主要部分。为了实现这一点，首先想到的是—可抢占的虚拟机。您可以用可抢占的虚拟机组成您的Kubernetes集群(GKE)或它的一部分。但是现在，您一定想知道什么是“可抢占的虚拟机”？</p></div><div class="ab cl jq jr gp js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hb hc hd he hf"><blockquote class="il im in"><p id="a1a5" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated"><strong class="ir hj">什么是可抢占虚拟机及其弊端？</strong></p></blockquote><p id="846d" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated">有大量博客向您解释可抢占的虚拟机。简而言之，可抢占的虚拟机是一个实例，您可以以比普通实例低得多的价格(高达80%)创建和运行它。那么显而易见的问题是“为什么不在可抢占的虚拟机上运行一切”。这个问题的答案是，“可抢占的虚拟机也有它们的缺点”。我不会进入细节，但几个缺点包括-最大。生命周期为24小时，它们可以在任何时候被终止(您对此无能为力&amp;这只是部分事实)，并且它们不在SLA的覆盖范围内。<a class="ae jx" href="https://cloud.google.com/compute/docs/instances/preemptible" rel="noopener ugc nofollow" target="_blank">点击此处</a>了解更多关于可抢占虚拟机的信息&amp;其缺点。</p></div><div class="ab cl jq jr gp js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hb hc hd he hf"><figure class="jy jz ka kb fd ii"><div class="bz dy l di"><div class="kc ik l"/></div></figure><p id="db35" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated"><strong class="ir hj">现在让我们进入正题——削减K8s (GKE)集群的成本</strong></p><p id="c9cb" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated">在这篇博客中，我将利用以下事情来降低成本:- <strong class="ir hj"> GCP </strong>，<strong class="ir hj"> GKE </strong> (Kubernetes)，<strong class="ir hj">可抢占的虚拟机</strong>，<strong class="ir hj">谷歌云功能</strong>和<strong class="ir hj"> K8s特征验证准入Webhook </strong>(准入控制器)。</p><p id="20cb" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated">很明显，如果我想在上降低成本，我将会在(谷歌云平台)上工作。但是请记住，您也可以将我们在这里讨论的内容应用到其他云提供商及其托管版本的K8s上。</p><h2 id="8b79" class="kd ke hi bd kf kg kh ki kj kk kl km kn jn ko kp kq jo kr ks kt jp ku kv kw kx bi translated">步骤1 -构建您的GKE集群</h2><p id="b29a" class="pw-post-body-paragraph io ip hi ir b is ky iu iv iw kz iy iz jn la jc jd jo lb jg jh jp lc jk jl jm hb bi translated">在GKE上，您可以构建异构集群，这意味着您可以用普通的和<strong class="ir hj">可抢占的虚拟机组成您的GKE集群。</strong>一旦您选择了想要在GKE集群中运行的可抢占虚拟机的数量，请确保它们位于单独的节点池中。<a class="ae jx" href="https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster" rel="noopener ugc nofollow" target="_blank"> <em class="iq">点击此处</em> </a>了解如何构建GKE集群和节点池(使用特定类型的虚拟机，在我们的示例中，虚拟机类型是可抢占的虚拟机)。</p><p id="a0cd" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated">当构建上面提到的GKE集群和节点池时，确保将<a class="ae jx" href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hj"> <em class="iq">污点</em> </strong> </a>添加到您的<em class="iq">可抢占虚拟机节点池</em>。让我们假设，您添加了如下内容:-</p><pre class="jy jz ka kb fd ld le lf lg aw lh bi"><span id="b261" class="kd ke hi le b fi li lj l lk ll">NO_SCHEDULE task=preemptive</span></pre><p id="a09b" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated">在GKE上构建<em class="iq">可抢占的虚拟机节点池</em>时，需要记住三件事。<br/> 1)。选择<strong class="ir hj">启用</strong>选项— <em class="iq">可抢占节点</em>。<br/>②。选择上的<strong class="ir hj">选项— <em class="iq">自动缩放</em>。因为它对自动缩放是神圣的。<br/> 3)。点击<strong class="ir hj">+添加污点</strong>选项— <em class="iq">节点污点</em>。然后如上所述添加污点。</strong></p><p id="26e2" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated"><strong class="ir hj"> <em class="iq">注意:- </em> </strong>我们现在已经克服了上面提到的可抢占虚拟机的前两个主要缺点😎。由于可抢占的虚拟机现在是GKE节点池的一部分，每次可抢占的虚拟机终止时，都会自动创建一个替代虚拟机。很酷不是吗？</p><h2 id="41f2" class="kd ke hi bd kf kg kh ki kj kk kl km kn jn ko kp kq jo kr ks kt jp ku kv kw kx bi translated">步骤2 -增加工作负荷的容忍度</h2><p id="835a" class="pw-post-body-paragraph io ip hi ir b is ky iu iv iw kz iy iz jn la jc jd jo lb jg jh jp lc jk jl jm hb bi translated">在上一步中，您已经选择了GKE集群中的<em class="iq">可抢占虚拟机节点池</em>的大小，并将<em class="iq">污点</em>添加到该节点池中。确保添加对工作负载(部署、复制集、状态集、复制控制器等)的容差。，您认为它可以容忍在一个<em class="iq">可抢占的虚拟机节点池</em>上运行——该池仅由可抢占的虚拟机组成。例如，您可以决定像-Nginx部署这样的工作负载在<em class="iq">可抢占的VM节点池</em>上运行，使用类似下面的工作负载的容差<strong class="ir hj"><em class="iq">spec . template . spec</em></strong>(在本例中是- <em class="iq">部署</em>)。</p><pre class="jy jz ka kb fd ld le lf lg aw lh bi"><span id="86b1" class="kd ke hi le b fi li lj l lk ll">tolerations: <br/>- effect: NoSchedule<br/>  key: task<br/>  operator: Equal        <br/>  value: preemptive</span></pre><p id="4fe7" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated">将上述容忍度添加到您认为有资格在<em class="iq">可抢占虚拟机节点池</em>上运行的所有工作负载中。请记住，在<em class="iq">可抢占虚拟机节点池</em>上运行的工作负载越多，而不是在具有普通(标准)实例的节点池上运行的工作负载越多，您的成本削减就越好。说到这里，让我们进入下一步。</p><h2 id="4bf6" class="kd ke hi bd kf kg kh ki kj kk kl km kn jn ko kp kq jo kr ks kt jp ku kv kw kx bi translated">第3步-在您的GKE集群上强制削减成本</h2><p id="673a" class="pw-post-body-paragraph io ip hi ir b is ky iu iv iw kz iy iz jn la jc jd jo lb jg jh jp lc jk jl jm hb bi translated">就像我说的，在<em class="iq">可抢占的虚拟机节点池</em>上运行的工作负载越多，成本削减就越好。现在，我们变得专横一点，强制削减成本怎么样😉。这个想法很简单——允许来自暂存命名空间的工作负载只在<em class="iq">可抢占的虚拟机节点池</em>上运行，并确保这些工作负载有<em class="iq">容忍度</em>在<em class="iq">可抢占的虚拟机节点池</em>上运行，方法是使用一个web hook——在我们的例子中是一个<em class="iq">谷歌云功能</em>。</p><figure class="jy jz ka kb fd ii"><div class="bz dy l di"><div class="lm ik l"/></div></figure><p id="ba60" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated">为此，让我们使用K8s特性- ValidatingAdmissionWebhook(准入控制器)。<a class="ae jx" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook" rel="noopener ugc nofollow" target="_blank"> <em class="iq">点击此处</em> </a>进入详情，了解验证准入网钩。但简而言之，验证准入Webhook是一个K8s资源，它在通过身份验证和授权之后，但在获准进入K8s集群之前接收资源请求。现在，创建如下所示的ValidatingAdmissionWebhook配置，根据一组规则拦截来自名为<em class="iq"> test-staging-namespace </em>的临时命名空间的所有请求。当然，在您的GKE(K8s)集群中会有许多临时名称空间，所以您可以在下面的配置中随意添加它们。</p><pre class="jy jz ka kb fd ld le lf lg aw lh bi"><span id="6269" class="kd ke hi le b fi li lj l lk ll">apiVersion: admissionregistration.k8s.io/v1beta1<br/>kind: ValidatingWebhookConfiguration<br/>metadata:<br/>  name: deny-absence-of-tolerations<br/>webhooks:<br/>  - name: deny.absence.of.tolerations<br/>    rules:<br/>      - apiGroups: ["apps","extensions"]<br/>        apiVersions: ["v1","v1beta1","v1beta2"]<br/>        operations: [ "CREATE","UPDATE" ]<br/>        #operations: [ "*" ]<br/>        resources: ["deployments","<!-- -->statefulsets<!-- -->"]<br/>    namespaceSelector:<br/>      matchExpressions:<br/>      - key: namespace<br/>        operator: In<br/>        values:<br/>        - test-staging-namespace<br/>    failurePolicy: Fail<br/>    clientConfig:<br/>      url: "https://url_of_the_google_cloud_function"<br/>      caBundle: AddCAbundleValueHere</span></pre><p id="c63d" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated">基本上，上面的<code class="du ln lo lp le b">ValidatingWebhookConfiguration</code>拦截了来自<code class="du ln lo lp le b">test-staging-namespace</code>的所有部署和状态集。中断后，webhook <code class="du ln lo lp le b">"https://deny_absence_of_tolerations"</code>被调用。这个webhook只不过是我们将在下一步讨论的<em class="iq">Google cloud Function</em>——它将确保您的工作负载具有容忍度，从而隐式地强制工作负载从staging namespaces运行在<em class="iq">可抢占VM节点池</em>上。</p><h2 id="e9e3" class="kd ke hi bd kf kg kh ki kj kk kl km kn jn ko kp kq jo kr ks kt jp ku kv kw kx bi translated">第四步:-创建一个谷歌云功能作为你的网络钩子</h2><p id="be38" class="pw-post-body-paragraph io ip hi ir b is ky iu iv iw kz iy iz jn la jc jd jo lb jg jh jp lc jk jl jm hb bi translated">现在，您已经创建了ValidatingAdmissionWebhook配置。我们现在需要创建一个webhook，在我们的例子中，它不过是一个<em class="iq"> Google Cloud函数</em>。创建一个<em class="iq"> Google Cloud Function </em>非常简单，一旦你创建了它，记下它的url并在上面的Validating Admission Webhook配置中替换它。您的webhook应该如下所示，它检查您的工作负载是否存在容差，如果不存在则返回一个错误。</p><pre class="jy jz ka kb fd ld le lf lg aw lh bi"><span id="5f26" class="kd ke hi le b fi li lj l lk ll">var admissionResponse = {<br/>    allowed: false<br/>  };<br/><br/>  var found = false;<br/><br/>  if (!object.spec.template.spec.tolerations) {<br/><br/>      console.log("Workload is not using tolerations");<br/><br/>      admissionResponse.status = {<br/>        status: 'Failure',<br/>          message: "On Staging/Testing please use tolerations",<br/>        reason: " Workload ( ie.,deployment ) Requirement Failed",<br/>        code: 402<br/>      };<br/><br/>      found = true;<br/><br/>  };<br/><br/>  if (!found) {<br/>    admissionResponse.allowed = true;<br/>  }<br/><br/>  var admissionReview = {<br/>    response: admissionResponse<br/>  };<br/><br/>  res.setHeader('Content-Type', 'application/json');<br/>  res.send(JSON.stringify(admissionReview));<br/>  res.status(200).end();</span></pre><p id="9a5f" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated">你可以在这里 找到上面<a class="ae jx" href="https://github.com/ChikkannaSuhas/IngeniousTechnologiesAG/blob/master/checkForTolerations_googlecloudfunction.js" rel="noopener ugc nofollow" target="_blank"> <em class="iq">的完整代码，以备不时之需。请注意，当您运行异构集群时，您不必担心SLA，因为即使在<em class="iq">计算引擎</em>决定取走所有可抢占的虚拟机的情况下，您的工作负载仍将落在普通(标准)虚拟机节点池中。当然，您也应该为此启用自动缩放。</em></a></p><h2 id="f2c6" class="kd ke hi bd kf kg kh ki kj kk kl km kn jn ko kp kq jo kr ks kt jp ku kv kw kx bi translated">结论</h2><p id="f254" class="pw-post-body-paragraph io ip hi ir b is ky iu iv iw kz iy iz jn la jc jd jo lb jg jh jp lc jk jl jm hb bi translated">在这篇博客中，我提到了一些概念，为了有效地降低基础设施成本，您可以集体利用这些概念。这个博客是各种话题的一个很好的接触点，比如GKE，可抢占的虚拟机，谷歌云功能和验证准入网络钩子。我建议不要满足于现状，深入挖掘所有这些概念，以便更好地理解和进一步优化基础架构成本以及其他方面。希望你喜欢读这篇文章，如果你喜欢，就为这篇文章鼓掌😊。任何建议都非常感谢！。</p><blockquote class="il im in"><p id="0d5e" class="io ip iq ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated"><strong class="ir hj"> <em class="hi">参考文献</em> </strong></p></blockquote><p id="aaf2" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated"><a class="ae jx" href="https://cloud.google.com/blog/products/containers-kubernetes/cutting-costs-with-google-kubernetes-engine-using-the-cluster-autoscaler-and-preemptible-vms" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/blog/products/containers-kubernetes/cutting-costs-with-Google-kubernetes-engine-using-the-cluster-auto scaler-and-preemptable-VMs</a></p><p id="957c" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated"><a class="ae jx" href="https://itnext.io/save-costs-in-your-kubernetes-cluster-with-5-open-source-projects-7f53899a1429" rel="noopener ugc nofollow" target="_blank">https://it next . io/save-costs-in-your-kubernetes-cluster-with-5-open-source-projects-7f 53899 a 1429</a></p><p id="3d61" class="pw-post-body-paragraph io ip hi ir b is it iu iv iw ix iy iz jn jb jc jd jo jf jg jh jp jj jk jl jm hb bi translated"><a class="ae jx" href="https://www.replex.io/blog/7-things-you-can-do-today-to-reduce-aws-kubernetes-costs" rel="noopener ugc nofollow" target="_blank">https://www . replex . io/blog/7-things-you-can-do-today-to-reduce-AWS-kubernetes-costs</a></p></div></div>    
</body>
</html>