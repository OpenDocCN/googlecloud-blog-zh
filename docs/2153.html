<html>
<head>
<title>Workflows state management with Firestore</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Firestore的工作流程状态管理</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/worklows-state-management-with-firestore-99237f08c5c5?source=collection_archive---------0-----------------------#2022-04-08">https://medium.com/google-cloud/worklows-state-management-with-firestore-99237f08c5c5?source=collection_archive---------0-----------------------#2022-04-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/389a10c88fa8e4633dcdde767b36c39b.png" data-original-src="https://miro.medium.com/v2/resize:fit:926/format:webp/1*KRXfzRnmm2IpkyHRPhrVgQ.png"/></div></figure><p id="137f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在工作流中，有时，您需要在一个执行的步骤中存储一些状态，一个键/值对，然后在另一个执行的另一个步骤中读取该状态。工作流中没有内在的键/值存储。然而，你可以把Firestore作为一个关键/价值商店，这就是我想在这里向你展示的。</p><p id="af50" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你想跳过看一些样品，请查看<a class="ae jk" href="https://github.com/GoogleCloudPlatform/workflows-demos/blob/master/state-management-firestore/workflow.yaml" rel="noopener ugc nofollow" target="_blank">workflow . YAML</a>。</p><p id="fd2b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你想了解更多，请继续阅读。</p><h1 id="d572" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">Firestore工作流程设置</h1><p id="6ce3" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">在Firestore中，您通常有一个集合和该集合中的多个文档。要使用Firestore作为工作流的键/值存储，一个想法是使用工作流名称作为集合名称，并使用单个文档来存储所有的键/值对。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="9e21" class="kx jm hi kt b fi ky kz l la lb">your-workflow-name<br/> |<br/> ├── key-value-store<br/>      |<br/>      ├── key1=value1<br/>      ├── key2=true<br/>      ├── key3=1<br/>      ├── key4=1.5</span></pre><h1 id="c8e1" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">卖出价值</h1><p id="9699" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">下面是在Firestore上保存键/值对的子工作流:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="beea" class="kx jm hi kt b fi ky kz l la lb">firestore_put:<br/>    params: [key, value, valueType: "string"]<br/>    steps:<br/>        - init:<br/>            assign:<br/>            - database_root: ${"projects/" + sys.get_env("GOOGLE_CLOUD_PROJECT_ID") + "/databases/(default)/documents/" + sys.get_env("GOOGLE_CLOUD_WORKFLOW_ID") + "/"}<br/>            - doc_name: ${database_root + "key-value-store"}<br/>        - store:<br/>            call: googleapis.firestore.v1.projects.databases.documents.patch<br/>            args:<br/>                name: ${doc_name}<br/>                updateMask:<br/>                    fieldPaths: [${key}]<br/>                body:<br/>                    fields:<br/>                        ${key}:<br/>                            ${valueType + "Value"}: ${value}</span></pre><p id="b510" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在Firestore中，您需要指定要保存的变量的类型。子工作流采用字符串值类型，但您也可以传入一些其他基本类型，如boolean、integer、double。</p><h1 id="7ff1" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">获得价值</h1><p id="9ce4" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">下面是检索给定键的值的子工作流:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="f80f" class="kx jm hi kt b fi ky kz l la lb">firestore_get:<br/>    params: [key, valueType: "string"]<br/>    steps:<br/>        - init:<br/>            assign:<br/>            - database_root: ${"projects/" + sys.get_env("GOOGLE_CLOUD_PROJECT_ID") + "/databases/(default)/documents/" + sys.get_env("GOOGLE_CLOUD_WORKFLOW_ID") + "/"}<br/>            - doc_name: ${database_root + "key-value-store"}<br/>        - get:<br/>            call: googleapis.firestore.v1.projects.databases.documents.get<br/>            args:<br/>                name: ${doc_name}<br/>                mask:<br/>                    fieldPaths: [${key}]<br/>            result: getResult<br/>        - return_value:<br/>            switch:<br/>            - condition: ${not("fields" in getResult)}<br/>              return: null<br/>            - condition: true<br/>              return: ${getResult.fields[key][valueType + "Value"]}</span></pre><p id="ed8a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请注意，如果键不存在，子工作流只返回null。我认为这比抛出一个KeyNotFound错误并让用户处理它要容易得多。</p><h1 id="322f" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">清除</h1><p id="7ce0" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">您可能还想偶尔通过删除文档来清除这些键。这是一个子流程:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="fed0" class="kx jm hi kt b fi ky kz l la lb">firestore_clear:<br/>    steps:<br/>        - init:<br/>            assign:<br/>            - database_root: ${"projects/" + sys.get_env("GOOGLE_CLOUD_PROJECT_ID") + "/databases/(default)/documents/" + sys.get_env("GOOGLE_CLOUD_WORKFLOW_ID") + "/"}<br/>            - doc_name: ${database_root + "key-value-store"}<br/>        - drop:<br/>            call: googleapis.firestore.v1.projects.databases.documents.delete<br/>            args:<br/>                name: ${doc_name}</span></pre><h1 id="82ed" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">例子</h1><p id="56e8" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">现在子工作流已经就绪，这就是您可以存储不同类型的键/值对并检索结果的方式。注意最后可选的<code class="du lc ld le kt b">clear_keys</code>步骤:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="30bb" class="kx jm hi kt b fi ky kz l la lb">main:<br/>  steps:<br/>    - put_string_value:<br/>        call: firestore_put<br/>        args:<br/>            key: "key1"<br/>            value: "value1"<br/>    - get_string_value:<br/>        call: firestore_get<br/>        args:<br/>            key: "key1"<br/>        result: string_value<br/>    - put_boolean_value:<br/>        call: firestore_put<br/>        args:<br/>            key: "key2"<br/>            value: true<br/>            valueType: "boolean"<br/>    - get_boolean_value:<br/>        call: firestore_get<br/>        args:<br/>            key: "key2"<br/>            valueType: "boolean"<br/>        result: boolean_value<br/>    - put_integer_value:<br/>        call: firestore_put<br/>        args:<br/>            key: "key3"<br/>            value: 1<br/>            valueType: "integer"<br/>    - get_integer_value:<br/>        call: firestore_get<br/>        args:<br/>            key: "key3"<br/>            valueType: "integer"<br/>        result: integer_value<br/>    - put_double_value:<br/>        call: firestore_put<br/>        args:<br/>            key: "key4"<br/>            value: 1.5<br/>            valueType: "double"<br/>    - get_double_value:<br/>        call: firestore_get<br/>        args:<br/>            key: "key4"<br/>            valueType: "double"<br/>        result: double_value<br/>    - get_nonexisting_key:<br/>        call: firestore_get<br/>        args:<br/>            key: "nonexisting"<br/>        result: nonexisting_value<br/>    # - clear_keys:<br/>    #     call: firestore_clear<br/>    - return_values:<br/>        return:<br/>            string_value: ${string_value}<br/>            boolean_value: ${boolean_value}<br/>            integer_value: ${integer_value}<br/>            double_value: ${double_value}<br/>            nonexisting_value: ${nonexisting_value}</span></pre></div><div class="ab cl lf lg gp lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="hb hc hd he hf"><p id="35b4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">即使Workflows不提供内在的键/值存储，一旦你找到正确的API调用，Firestore也很容易使用。</p><p id="cdbc" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">你认为这个解决方案怎么样？如果你有改进的想法，请在Twitter上联系我<a class="ae jk" href="https://twitter.com/meteatamel" rel="noopener ugc nofollow" target="_blank"> @meteatamel </a>。</p></div><div class="ab cl lf lg gp lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="hb hc hd he hf"><p id="828e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="lm">原发布于</em><a class="ae jk" href="https://atamel.dev/posts/2022/04-08_workflows_state_firestore/" rel="noopener ugc nofollow" target="_blank"><em class="lm">https://atamel . dev</em></a><em class="lm">。</em></p></div></div>    
</body>
</html>