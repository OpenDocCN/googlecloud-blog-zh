<html>
<head>
<title>Knative 2/2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Knative 2/2</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/knative-2-2-e542d71d531d?source=collection_archive---------0-----------------------#2018-07-28">https://medium.com/google-cloud/knative-2-2-e542d71d531d?source=collection_archive---------0-----------------------#2018-07-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="8273" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">库伯内特斯历险记</h2></div><p id="5ce9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">昨天，我探索了Knative。</p><p id="a0ea" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">今天，我四处看看，以便更好地理解它。</p><h2 id="fa33" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">设置</h2><figure class="kp kq kr ks fd kt"><div class="bz dy l di"><div class="ku kv l"/></div></figure><h2 id="0149" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">伊斯迪奥</h2><p id="668d" class="pw-post-body-paragraph ix iy hi iz b ja kw ij jc jd kx im jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">Istio的一个实现细节是，我们的服务组件由一个Istio sidecar容器代理。回到昨天的<code class="du lb lc ld le b">helloworld</code> ( <strong class="iz hj"> NB </strong>矿叫<code class="du lb lc ld le b">hellohenry</code>)部署:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lf"><img src="../Images/5ae679698c14f7da01a3cf5e165f99bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kSKDZRsQ7T-hCQ6-XeD4MA.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">Kubernetes发动机控制台:hello Henry-00001-部署</figcaption></figure><p id="2f33" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Knative autoscaler最近没有看到服务的流量(因此也没有看到部署的流量)，似乎已经将服务自动缩放到零pods。让我们点击请求的端点，看看会发生什么:</p><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="c336" class="ju jv hi le b fi lu lv l lw lx">HELLO=$(\<br/>  kubectl get services.serving.knative.dev/helloworld \<br/>  --namespace=default \<br/>  --output=jsonpath="{.status.domain}") &amp;&amp; echo ${HELLO}</span><span id="1007" class="ju jv hi le b fi ly lv l lw lx">hellohenry.default.example.com</span><span id="6c17" class="ju jv hi le b fi ly lv l lw lx">INGRESS=$(\<br/>  kubectl get services/knative-ingressgateway \<br/>  --namespace=istio-system \<br/>  --output=jsonpath="{.status.loadBalancer.ingress[0].ip}")</span><span id="90cb" class="ju jv hi le b fi ly lv l lw lx">curl --header "Host: ${HELLO}" <a class="ae jt" href="http://${INGRESS" rel="noopener ugc nofollow" target="_blank">http://${INGRESS</a>}</span><span id="189b" class="ju jv hi le b fi ly lv l lw lx"># Your output will differ<br/>Hello Henry: Tada!</span></pre><p id="f43d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lz"><img src="../Images/a80a3d82a1cd04b855fc41ecded53636.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MA7ar5wRZyq70dZnDfYJUQ.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">Kubernetes发动机控制台:由autoscaler创建的一个吊舱</figcaption></figure><p id="7b14" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">autoscaler创建了一个pod来支持此服务。因为冷启动时没有pods运行，所以第一个请求的延迟更高:</p><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="acde" class="ju jv hi le b fi lu lv l lw lx">curl \<br/>--header "Host: ${HELLO}" \<br/>--write-out "<br/>lookup        %{time_namelookup}<br/>connect       %{time_connect}<br/>appconnect    %{time_appconnect}<br/>pretransfer   %{time_pretransfer}<br/>redirect      %{time_redirect}<br/>starttransfer %{time_starttransfer}<br/>total         %{time_total}\n" \<br/><a class="ae jt" href="http://${INGRESS" rel="noopener ugc nofollow" target="_blank">http://${INGRESS</a>}</span></pre><p id="3bf9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">导致:</p><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="fa4e" class="ju jv hi le b fi lu lv l lw lx">lookup        0.000048<br/>connect       0.020991<br/>appconnect    0.000000<br/>pretransfer   0.021039<br/>redirect      0.000000<br/>starttransfer <strong class="le hj">8.052199</strong><br/>total         <strong class="le hj">8.052241</strong></span></pre><blockquote class="ma mb mc"><p id="52bb" class="ix iy md iz b ja jb ij jc jd je im jf me jh ji jj mf jl jm jn mg jp jq jr js hb bi translated"><strong class="iz hj">注意</strong>Kubernetes、Knative和Istio让我们从0到1只花了大约8秒，但之后，正如你将在下面看到的，它会更快。</p></blockquote><p id="6346" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦我运行了单个pod，时机就好了:</p><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="69f0" class="ju jv hi le b fi lu lv l lw lx">lookup        0.000043<br/>connect       0.020306<br/>appconnect    0.000000<br/>pretransfer   0.020380<br/>redirect      0.000000<br/>starttransfer 0.042394<br/>total         <strong class="le hj">0.04</strong>2443</span></pre><p id="898d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">虽然我们至少有一个Pod，但让我们深入了解一下，看看它由什么组成:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lf"><img src="../Images/d94c6d1d7c4dee86cdad4190f085c86c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ihZJiXPu_1bmtYkggslCoA.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">Kubernetes引擎控制台:带Istio的Knative应用程序盒</figcaption></figure><p id="72ae" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">注意</strong>Pod由3个容器组成。列表中的第三个是用户容器，它的图像对应于我的实用程序:<code class="du lb lc ld le b">gcr.io/dazwilkin-180728-knative/knative/hellohenry</code>。Istio代理(又名sidecar)如预期的那样在那里<code class="du lb lc ld le b">gcr.io/istio-release/proxyv2</code>。这是特使。第三个容器叫做<code class="du lb lc ld le b">queue-proxy</code>，是Knative ( <code class="du lb lc ld le b">gcr.io/knative-releases/github.com/knative/serving</code>)的一部分。</p><h2 id="1046" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">贝吉塔</h2><p id="e230" class="pw-post-body-paragraph ix iy hi iz b ja kw ij jc jd kx im jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">在我的工作站上使用<a class="ae jt" href="https://github.com/tsenart/vegeta" rel="noopener ugc nofollow" target="_blank">贝吉塔</a>(= =牛逼)对服务施加一些压力会产生一条有趣的曲线:</p><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="880c" class="ju jv hi le b fi lu lv l lw lx">echo "GET <a class="ae jt" href="http://${INGRESS" rel="noopener ugc nofollow" target="_blank">http://${INGRESS</a>}" \<br/>| vegeta -cpus=12 attack -duration=300s -header "Host: ${HELLO}" \<br/>| vegeta report -reporter=plot &gt; plot.html</span></pre><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es mh"><img src="../Images/2255f847c2c4a85b309af0daf0036885.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gZwqJiRKRKHYldxetMZ-Dg.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">贝吉塔情节:5分钟</figcaption></figure><p id="d32a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如图所示，在最初的70秒左右，集群提供10个pod:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es mi"><img src="../Images/eb2b19f1c0b7c56b39d22de4920815cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MNQM7bHGkSZBOK7Cd8r-YQ.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">Knative自动缩放0 →10个pod</figcaption></figure><p id="aec2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当集群检测到负载稳定时，多余的Pods被终止，服务通过5个Pods稳定:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lf"><img src="../Images/c797b681b59975609cff7f27c6108cfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oi0S69wmjN7Rp41JduCyYg.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">5个吊舱上的Knative稳定</figcaption></figure><p id="7767" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在一次贝吉塔运行完成之后，在集群规模降回零之前，让我们运行另一个测试，这次使用文本输出:</p><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="80a8" class="ju jv hi le b fi lu lv l lw lx">echo "GET <a class="ae jt" href="http://${INGRESS" rel="noopener ugc nofollow" target="_blank">http://${INGRESS</a>}" \<br/>| vegeta -cpus=12 attack -duration=300s -header "Host: ${HELLO}" \<br/>| vegeta report -reporter=text</span><span id="23f6" class="ju jv hi le b fi ly lv l lw lx">Requests      [total, rate]            15000, 50.00<br/>Duration      [total, attack, wait]    5m0.0312787s, 4m59.980142364s, 51.136336ms<br/>Latencies     [mean, 50, 95, 99, max]  438.596801ms, 28.053121ms, 3.451233603s, 6.45897554s, 7.577021529s<br/>Bytes In      [total, mean]            284544, 18.97<br/>Bytes Out     [total, mean]            0, 0.00<br/>Success       [ratio]                  99.84%<br/>Status Codes  [code:count]             200:14976  503:24  <br/>Error Set:<br/>503 Service Unavailable</span></pre><p id="1aab" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这为我们提供了更准确的响应数据。虽然p95不到3.5s似乎很高！？</p><h2 id="977e" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">普罗米修斯</h2><p id="bba1" class="pw-post-body-paragraph ix iy hi iz b ja kw ij jc jd kx im jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">Istio捆绑普罗米修斯进行监控。Prometheus被部署到一个<code class="du lb lc ld le b">monitoring</code>名称空间，下面的代码将把您的本地端口<code class="du lb lc ld le b">9090</code>转发到服务的端口:</p><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="398b" class="ju jv hi le b fi lu lv l lw lx">kubectl port-forward $(\<br/>  kubectl get pods \<br/>  --selector=app=prometheus \<br/>  --output=jsonpath="{.items[0].metadata.name}"<br/>  --namespace=monitoring) \<br/>--namespace=monitoring \<br/>9090:9090</span></pre><p id="3ea7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并浏览<code class="du lb lc ld le b">localhost:9090/targets</code>给出:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es mj"><img src="../Images/b64e1190294e79ef58adc109f6d0b409.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x7CdE9GPgh5Pe-L5NJgY1A.png"/></div></div></figure><h2 id="4a89" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">格拉夫纳</h2><p id="a070" class="pw-post-body-paragraph ix iy hi iz b ja kw ij jc jd kx im jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">幸运的是，Knative附带了一套针对Prometheus指标配置的Grafana仪表盘:</p><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="45d0" class="ju jv hi le b fi lu lv l lw lx">kubectl port-forward $(\<br/>  kubectl get pods \<br/>  --selector=app=grafana \<br/>  --output=jsonpath="{.items..metadata.name}" \<br/>  --namespace=monitoring) \<br/>--namespace=monitoring \<br/>3000</span></pre><p id="6783" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">浏览<code class="du lb lc ld le b">localhost:3000</code>(点击<code class="du lb lc ld le b">Home</code>):</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es mk"><img src="../Images/b24d6d21964b91e1b5ecc940ca282b26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bwu50ev3os03T6Y4lo1j4A.png"/></div></div></figure><p id="9703" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并选择“无效服务—修订HTTP请求”:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es ml"><img src="../Images/ed274623a55d3d00c82f5876a93595ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JYnBeo1Utz7zffmb-RqtPQ.png"/></div></div></figure><p id="87b1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">超级好看！甚至有一个工具可以帮助进行缩放调试:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lf"><img src="../Images/471efd890f00261d7502612167ae4829.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*06gVafTiNzmrPbQ1Zg80dQ.png"/></div></div></figure><h2 id="7b3a" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">齐普金</h2><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="719d" class="ju jv hi le b fi lu lv l lw lx">kubectl port-forward $(\<br/>  kubectl get pods \<br/>  --selector=<strong class="le hj">app=zipkin</strong> \<br/>  --namespace=istio-system \<br/>  --output=jsonpath="{.items[0].metadata.name}") \<br/>--namespace=istio-system \<br/>9411:9411</span></pre><p id="8234" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并浏览至<code class="du lb lc ld le b">localhost:9411</code>:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es mm"><img src="../Images/9b15c7db2eb5369f5d1308c52b417191.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xmOJA7pM_0RHcRK_0LnAPg.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">齐普金</figcaption></figure><p id="24e2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您应该能够从<code class="du lb lc ld le b">Service Name</code>下拉列表中选择<code class="du lb lc ld le b">helloworld</code>服务，然后选择<code class="du lb lc ld le b">Find Traces</code>:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es mm"><img src="../Images/336b9a90bff229492c9a7a776675f24a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EhHx7rO5GJkHA0BpBmvzKw.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">齐普金:“hellohenry-00001”</figcaption></figure><p id="81e6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">显然，hellohenry示例没有太多内容，因为它只是直接响应传入的请求。然而，Zipkin提供了一些关于机制的见解:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es mn"><img src="../Images/0681f0249a4387b458df9a1aee830929.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wGT-2tY_ZjWAZDy3V2dMXA.png"/></div></div></figure><p id="66b3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以在这里看到请求在被路由到<code class="du lb lc ld le b">hellohenry-00001</code>之前是如何如预期的那样到达<code class="du lb lc ld le b">knative-ingressgateway</code>的。在这个表单的末尾，您可以看到接收方服务是<code class="du lb lc ld le b">hellohenry-00001-service.default.svc.cluster.local</code>并且在端口<code class="du lb lc ld le b">80</code>上。记住代码发布到<code class="du lb lc ld le b">8080</code>。</p><p id="9883" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">服务的YAML将<code class="du lb lc ld le b">80</code>绑定到pod的<code class="du lb lc ld le b">queue-port</code>:</p><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="519e" class="ju jv hi le b fi lu lv l lw lx">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  annotations:<br/>    serving.knative.dev/configurationGeneration: "1"<br/>  labels:<br/>    app: hellohenry-00001<br/>    serving.knative.dev/configuration: hellohenry<br/>    serving.knative.dev/revision: hellohenry-00001<br/>  name: hellohenry-00001-service<br/>  namespace: default<br/>spec:<br/>  externalTrafficPolicy: Cluster<br/>  ports:<br/>  - name: http<br/>    nodePort: 30057<br/>    <strong class="le hj">port: 80</strong><br/>    protocol: TCP<br/>    <strong class="le hj">targetPort: queue-port</strong><br/>  selector:<br/>    serving.knative.dev/revision: hellohenry-00001<br/>  sessionAffinity: None<br/>  type: NodePort<br/>status:<br/>  loadBalancer: {}</span></pre><p id="78af" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">深入到服务捕获的一个pod，我们可以看到队列端口是由Knative管理的，而不是由Istio或我们的服务管理的:</p><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="7ec2" class="ju jv hi le b fi lu lv l lw lx">image: gcr.io/knative-releases/github.com/<strong class="le hj">knative/serving/cmd/queue</strong><br/>name: queue-proxy<br/>ports:<br/>- containerPort: 8012<br/>  <strong class="le hj">name: queue-port</strong><br/>  protocol: TCP<br/>- containerPort: 8022<br/>  name: queueadm-port<br/>  protocol: TCP</span></pre><p id="4813" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">IIUC这个<code class="du lb lc ld le b">queue-proxy</code>是Knative自动缩放的一部分。想必(！)这个<code class="du lb lc ld le b">queue-proxy</code>也是<code class="du lb lc ld le b">istio-proxy</code>的代理，尽管我不清楚这是在哪里完成的。文献很少。</p><p id="c4d4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们看看日志:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lf"><img src="../Images/34265762cd6c5802b275b27cd53f3726.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TgZmEUmBZ_MfQ7qvhGOAgA.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">“hello Henry-00001-部署”的日志</figcaption></figure><p id="5aeb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以看到<code class="du lb lc ld le b">8080</code>与<code class="du lb lc ld le b">8012</code>和<code class="du lb lc ld le b">8022</code>一起被Istio代理捕获:</p><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="1e63" class="ju jv hi le b fi lu lv l lw lx">INBOUND_PORTS_INCLUDE=8080, 8012, 8022</span></pre><p id="7aaf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">后两个端口对应于上面显示的队列代理端口:</p><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="5bf5" class="ju jv hi le b fi lu lv l lw lx">queue-port: 8012/TCP (exposed on host)<br/>queueadm-port: 8022/TCP (exposed on host)</span></pre><p id="5f42" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这些由Istio (Envoy)代理使用iptables编程:</p><pre class="kp kq kr ks fd lq le lr ls aw lt bi"><span id="ecb7" class="ju jv hi le b fi lu lv l lw lx">A  -A ISTIO_INBOUND -p tcp -m tcp --dport 8080 -j ISTIO_IN_REDIRECT<br/>A  -A ISTIO_INBOUND -p tcp -m tcp --dport 8012 -j ISTIO_IN_REDIRECT<br/>A  -A ISTIO_INBOUND -p tcp -m tcp --dport 8022 -j ISTIO_IN_REDIRECT</span></pre><p id="542f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我缺少的是这个小三和弦的图解流程。</p><h2 id="fec1" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">仅Istio</h2><p id="0acb" class="pw-post-body-paragraph ix iy hi iz b ja kw ij jc jd kx im jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">我将花一些时间比较Istio-only和Istio w/ Knative之间的部署，看看我是否能够理解Knative服务具体添加了什么。</p><p id="837d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不带Knative的Istio的等效部署(和服务)为:</p><figure class="kp kq kr ks fd kt"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="3796" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">注意</strong>第17行的注释可以在<code class="du lb lc ld le b">true</code>和<code class="du lb lc ld le b">false</code>之间切换，前者用于将Istio代理注入到pod中，后者用于非Istio(无代理)部署。</p><p id="a9c7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">同<code class="du lb lc ld le b">sidecar.istio.io/inject: “false”</code>:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lf"><img src="../Images/f8c0d6bbc80d75cdce57ea3ba0d53a2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*98oqbNFU9MidsI8HK0m2VQ.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">无委托人(无代理人)</figcaption></figure><p id="32ce" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">用<code class="du lb lc ld le b">sidecar.istio.io/inject: “true”</code>:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lf"><img src="../Images/c488e3a7abd30909d002448e45452ad7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NUTkXoQRqdQUlw7PW09upQ.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">带Istio(代理边车)</figcaption></figure><p id="d8bc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">虽然代理和<code class="du lb lc ld le b">hellohenry</code>容器之间的集成还不清楚，但这是一个很好的起点:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lf"><img src="../Images/97cee6494634d715e4dc12101ef2afea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MgK-2BdT_WDvM9Fp0XsjqA.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">hellohenry和istio边车的日志</figcaption></figure><p id="edbe" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更快！</p><h2 id="a8a8" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">结论</h2><p id="c794" class="pw-post-body-paragraph ix iy hi iz b ja kw ij jc jd kx im jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">稍微聪明一点，但是这里有很多新的功能来让我理解。我认为，就我的理解而言，从Istio开始可能更好，一旦我搞清楚那里发生了什么，然后再加上Knative。或者，有人向我解释这一切；-)</p></div></div>    
</body>
</html>