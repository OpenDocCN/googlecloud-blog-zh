<html>
<head>
<title>Oracle to Cloud Spanner: Migrate Oracle database to Cloud Spanner using Vertex AI notebooks and GCP Dataproc Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Oracle到云扳手:使用Vertex AI笔记本和GCP Dataproc无服务器将Oracle数据库迁移到云扳手</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/oracle-to-cloud-spanner-migrate-oracle-database-to-cloud-spanner-using-vertex-ai-notebooks-and-gcp-49152ce7f4e8?source=collection_archive---------1-----------------------#2022-10-25">https://medium.com/google-cloud/oracle-to-cloud-spanner-migrate-oracle-database-to-cloud-spanner-using-vertex-ai-notebooks-and-gcp-49152ce7f4e8?source=collection_archive---------1-----------------------#2022-10-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/fb2a2d98d4bbb81ae3b9a315566c74f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e6fvEU4KsWgofb6Bg8Td0A.png"/></div></div></figure><p id="282d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正在寻找将Oracle表并行迁移到Cloud Spanner的预构建解决方案吗？别再看了。我们开发了一个Vertex AI笔记本(Jupyter notebook)解决方案，它使用dataproc无服务器进行迁移。您只需提供必要的参数，笔记本将帮助您将完整的Oracle数据库迁移到Cloud Spanner。</p><p id="934a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://github.com/GoogleCloudPlatform/dataproc-templates" rel="noopener ugc nofollow" target="_blank"> Dataproc模板</a>使用<a class="ae jo" href="https://cloud.google.com/vertex-ai/docs/tutorials/jupyter-notebooks" rel="noopener ugc nofollow" target="_blank"> VertexAI笔记本</a>和<a class="ae jo" href="https://cloud.google.com/dataproc-serverless/docs" rel="noopener ugc nofollow" target="_blank"> Dataproc无服务器</a>提供一站式解决方案，将数据直接从MySQl迁移到Cloud Spanner。</p><p id="ea97" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1.从<a class="ae jo" href="https://console.developers.google.com/" rel="noopener ugc nofollow" target="_blank"> API控制台</a>启用GCP项目中的以下服务:</p><ul class=""><li id="5cce" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">计算引擎API</li><li id="140b" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">Dataproc API</li><li id="7d79" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">顶点人工智能应用编程接口</li><li id="5029" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">顶点笔记本API</li></ul><p id="c381" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.在<a class="ae jo" href="https://pantheon.corp.google.com/vertex-ai/workbench/list/instances" rel="noopener ugc nofollow" target="_blank">顶点AI工作台中创建一个<a class="ae jo" href="https://cloud.google.com/vertex-ai/docs/workbench/user-managed/introduction" rel="noopener ugc nofollow" target="_blank">用户管理的</a>笔记本。</a></p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kd"><img src="../Images/0797998009723f7cb32338f3405816f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cLAeDO1CMSlOzy_Y"/></div></div></figure><p id="a704" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.使用GIT选项卡克隆Dataproc模板GitHub repo，如下图所示</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ki"><img src="../Images/f0e77d244e283de46973971dc8292220.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dqq90yz4HETCIBRnOuJxQg.png"/></div></div></figure><p id="79cb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者从启动窗口打开一个终端，使用git clone进行克隆。</p><p id="6cd9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">git clone<a class="ae jo" href="https://github.com/GoogleCloudPlatform/dataproc-templates.git" rel="noopener ugc nofollow" target="_blank"> https://github.com/GoogleCloudPlatform/dataproc-templates.git</a></code></p><p id="a064" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.从文件夹选项卡中，打开路径为data proc-templates/notebooks/Oracle 2 spanner的<strong class="is hj">Oracle tospanner _ notebook . ipynb</strong>notebook</p><p id="fb5e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.笔记本包含帮助将数据从Oracle迁移到Cloud Spanner的分步过程。逐一运行每个步骤。笔记本里有详细的说明。下面是迁移的步骤:</p><p id="fa87" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第一步:安装所需的软件包</strong></p><p id="8495" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">迁移所需的一些软件包需要单独安装，因为它们在笔记本中不可用，例如SQLAlchemy、JDK等。</p><p id="0714" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤2:导入库:</strong>导入所需的包</p><p id="1883" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第三步:分配参数:</strong>运行笔记本前需要设置以下配置:</p><p id="ecf7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤3.1:通用参数</strong></p><ul class=""><li id="90ee" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><code class="du kj kk kl km b">PROJECT</code> : GCP项目标识</li><li id="85c6" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">REGION</code> : GCP地区</li><li id="d299" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">GCS_STAGING_LOCATION</code> : GCS暂存位置，用于此笔记本存储工件</li><li id="5dff" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">SUBNET</code> : VPC子网</li><li id="798c" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">JARS</code>:坛子清单。对于这个笔记本，除了dataproc模板jar之外，还需要mysql连接器和avro jar</li><li id="6dbf" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">MAX_PARALLELISM</code>:并行运行作业数参数，默认值为2</li><li id="8097" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">SERVICE_ACCOUNT</code>:自定义服务帐户电子邮件，用于笔记本中提到的权限的顶点ai管道和dataproc作业</li></ul><p id="d3b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤3.2: Oracle到云扳手参数</strong></p><ul class=""><li id="bdcf" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><code class="du kj kk kl km b">ORACLE_HOST</code> : ORACLE实例ip地址</li><li id="e402" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">ORACLE_PORT</code> : ORACLE实例端口</li><li id="05b5" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">ORACLE_USERNAME</code>:甲骨文用户名</li><li id="20e6" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">ORACLE_PASSWORD</code>:甲骨文密码</li><li id="e965" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">ORACLE_DATABASE</code>:要迁移的数据库的名称</li><li id="b867" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">ORACLE_TABLE_LIST</code>:您要迁移的表的列表，例如:['table1 '，' table2']否则提供一个空列表以迁移整个数据库，例如:[]</li><li id="c1c0" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">SPANNER_INSTANCE</code>:云扳手实例名</li><li id="2e66" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">SPANNER_DATABASE</code>:云扳手数据库名称</li><li id="b28a" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">SPANNER_TABLE_PRIMARY_KEYS</code>:为Oracle中没有主键的表提供格式为{"table_name":"primary_key"}的字典</li><li id="efd4" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><code class="du kj kk kl km b">SPANNER_OUTPUT_MODE</code> : &lt;追加|覆盖&gt;</li></ul><p id="e7f9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤3.3:笔记本配置参数</strong></p><p id="9e65" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些参数包含dataproc作业所需的jar和属性的路径。除非您想要更改jar的位置，否则不需要更改这些参数。</p><p id="58ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第四步:生成Oracle表列表</strong></p><p id="469a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这一步生成要迁移的表列表。如果步骤3.2中的<code class="du kj kk kl km b">ORACLE_TABLE_LIST</code>参数为空列表，则选择数据库中的所有表格。</p><p id="c860" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤5:获取SPANNER_TABLE_PRIMARY_KEYS中不存在的表的主键</strong></p><p id="90f5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该步骤获取出现在<code class="du kj kk kl km b">ORACLE_TABLE_LIST</code>参数中的表的主键，如果这些表的主键未在步骤3.2的参数<code class="du kj kk kl km b">SPANNER_TABLE_PRIMARY_KEYS</code>中提供</p><p id="5f89" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤6:获取表的行数并识别分区列</strong></p><p id="0f4c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该步骤使用<code class="du kj kk kl km b">PARTITION_THRESHOLD</code>(默认值为1百万)参数，任何行数大于<code class="du kj kk kl km b">PARTITION_THRESHOLD</code>的表都将基于主键进行分区</p><p id="5c67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第7步:下载JAR文件并上传到GCS(只需要运行一次)</strong></p><p id="8a01" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该步骤创建所需的JAR文件，并将其上传到步骤3.1中定义的<code class="du kj kk kl km b">GCS_STAGING_LOCATION</code></p><p id="4be7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤8:计算Oracle到云扳手的并行作业</strong></p><p id="6e92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">基于步骤3.1中设置的<code class="du kj kk kl km b">MAX_PARALLELISM</code>参数，该步骤计算Oracle到Cloud Spanner迁移的并行作业。基本上是将并行迁移到Cloud Spanner的Oracle表的数量。</p><p id="96e6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤9:执行管道将表从Oracle迁移到Cloud Spanner </strong></p><p id="cd6b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这一步启动Oracle表迁移的顶点AI管道执行。为每个作业生成管道链接。我们还可以在Dataproc UI的<a class="ae jo" href="https://console.cloud.google.com/dataproc/batches?_ga=2.256091016.2085864710.1666708114-43261181.1657894175" rel="noopener ugc nofollow" target="_blank">批处理</a>部分看到作业正在运行</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kn"><img src="../Images/4b7f00ef6e4599655f38ce00eaa5749a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o-o1wakGb5rgOYTd6TO9Sg.png"/></div></div></figure><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/12e5575ad912efd885786f03d6688c1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6TxQC7_m9cSND_-dYQpIkA.png"/></div></div></figure><p id="f39b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤10:获取从Oracle迁移到Cloud Spanner的表的状态</strong></p><p id="6f94" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该步骤获取在步骤9中执行的作业的状态</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kp"><img src="../Images/69c95c188e9168dbcdac39bff44c2085.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CgewKQlRMZ7bzHAbY-yQcg.png"/></div></div></figure><p id="d4c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤11:验证从Oracle迁移到Cloud Spanner的表的行数</strong></p><p id="0121" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些步骤有助于验证从Oracle迁移到Cloud Spanner的每个表的记录数量</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kq"><img src="../Images/859c498d9f5175b56cbcf145d1c39a1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AFQZmHr9BEQ93PAOrTWSsw.png"/></div></div></figure><p id="4ac7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如有任何疑问/建议，请联系:dataproc-templates-support-external@googlegroups.com</p></div></div>    
</body>
</html>