<html>
<head>
<title>Deploy to Cloud Run using GitLab CI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GitLab CI部署到云运行</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/deploy-to-cloud-run-using-gitlab-ci-e056685b8eeb?source=collection_archive---------0-----------------------#2020-06-23">https://medium.com/google-cloud/deploy-to-cloud-run-using-gitlab-ci-e056685b8eeb?source=collection_archive---------0-----------------------#2020-06-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/9e7edc5c23ea87c83804ac321bb6f928.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m1TlJbTJ1DbcVaNIm3PJ5g.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">云运行| GitLab</figcaption></figure><blockquote class="iu"><p id="cef7" class="iv iw hi bd ix iy iz ja jb jc jd je dx translated">在本文中，我将使用<a class="ae jf" href="https://docs.gitlab.com/ee/ci/" rel="noopener ugc nofollow" target="_blank"> GitLab CI </a>和<a class="ae jf" href="https://cloud.google.com/cloud-build" rel="noopener ugc nofollow" target="_blank">云构建</a>，指导部署无服务器容器化应用到<a class="ae jf" href="https://cloud.google.com/run" rel="noopener ugc nofollow" target="_blank">云运行</a>。</p></blockquote><blockquote class="jg jh ji"><p id="5b17" class="jj jk jl jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg je hb bi translated"><em class="hi"> Cloud Run是一个托管计算平台，支持您运行可自动扩展的无状态无服务器容器。</em></p><p id="5271" class="jj jk jl jm b jn kh jp jq jr ki jt ju jv kj jx jy jz kk kb kc kd kl kf kg je hb bi translated">Cloud Build是一项在Google云平台基础设施上执行构建的服务。</p><p id="922f" class="jj jk jl jm b jn kh jp jq jr ki jt ju jv kj jx jy jz kk kb kc kd kl kf kg je hb bi translated">GitLab CI服务是GitLab的一部分，每当开发人员将代码推送到应用程序报告时，它就构建和测试软件。</p></blockquote><h1 id="bcf4" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">先决条件</h1><ul class=""><li id="d9fa" class="lk ll hi jm b jn lm jr ln lo lp lq lr ls lt je lu lv lw lx bi translated">创建一个<a class="ae jf" href="https://console.cloud.google.com/project" rel="noopener ugc nofollow" target="_blank">谷歌云平台(GCP)项目</a>，或者使用一个现有的项目。</li><li id="62cb" class="lk ll hi jm b jn ly jr lz lo ma lq mb ls mc je lu lv lw lx bi translated">创建一个<a class="ae jf" href="https://gitlab.com/projects/new" rel="noopener ugc nofollow" target="_blank"> GitLab Repo </a>。</li><li id="0a5a" class="lk ll hi jm b jn ly jr lz lo ma lq mb ls mc je lu lv lw lx bi translated">启用<a class="ae jf" href="https://console.developers.google.com/apis/api/run.googleapis.com/overview" rel="noopener ugc nofollow" target="_blank">云运行API </a>。</li><li id="3a36" class="lk ll hi jm b jn ly jr lz lo ma lq mb ls mc je lu lv lw lx bi translated">启用<a class="ae jf" href="https://console.cloud.google.com/cloud-build/builds" rel="noopener ugc nofollow" target="_blank">云构建API </a>。</li><li id="3414" class="lk ll hi jm b jn ly jr lz lo ma lq mb ls mc je lu lv lw lx bi translated">克隆<a class="ae jf" href="https://gitlab.com/Timtech4u/vue-cloudrun" rel="noopener ugc nofollow" target="_blank"> <em class="jl">样本</em>代码</a>或者用<em class="jl"> Dockerfile </em>设置你自己的代码。</li></ul><h1 id="b797" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">为Google Cloud Build创建服务帐户</h1><ul class=""><li id="b204" class="lk ll hi jm b jn lm jr ln lo lp lq lr ls lt je lu lv lw lx bi translated">在Google Cloud上，浏览<strong class="jm hj">云构建&gt;设置。</strong></li><li id="f2a5" class="lk ll hi jm b jn ly jr lz lo ma lq mb ls mc je lu lv lw lx bi translated">在<strong class="jm hj">服务账户权限下，</strong>确保<strong class="jm hj">云运行&amp;服务账户</strong>被<strong class="jm hj">启用</strong>，这允许你部署到云运行。</li></ul><figure class="me mf mg mh fd ij er es paragraph-image"><div class="er es md"><img src="../Images/38d536240e26969fb498a9d27ff792c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/format:webp/1*lq253WALRoudTmG-80DdoA.png"/></div></figure><ul class=""><li id="06ee" class="lk ll hi jm b jn kh jr ki lo mi lq mj ls mk je lu lv lw lx bi translated">因为我已经给了云构建足够的权限，所以我可以在<strong class="jm hj"> IAM &amp; Admin &gt;服务帐户上创建云构建服务帐户。<br/> </strong>我将创建一个服务帐户(名为<a class="ae jf" href="http://twitter.com/custom" rel="noopener ugc nofollow" target="_blank">@</a>PROJECT.iam.gserviceaccount.com)并给它一个<em class="jl">云构建服务代理。<br/> </em>在已创建服务账户页面，点击<strong class="jm hj">添加密钥&gt; JSON </strong>。</li></ul><figure class="me mf mg mh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ml"><img src="../Images/642ab09a50d2db22febaeadd20e05db3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qP2UdBWXH7cFKe910H6K8A.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">创建密钥后的服务帐户页面</figcaption></figure><h1 id="ae61" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">配置GitLab CI以使用服务帐户</h1><p id="1343" class="pw-post-body-paragraph jj jk hi jm b jn lm jp jq jr ln jt ju lo mm jx jy lq mn kb kc ls mo kf kg je hb bi translated">在GitLab repo上，浏览<strong class="jm hj">设置&gt; CI/CD &gt;变量。</strong></p><figure class="me mf mg mh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/a26a457623c2e5fab138f8168e5c08aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hxu_w-yRfu8sht8QUGgwzA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><strong class="bd ko"> GitLab回购设定&gt; CI/CD &gt;变量</strong></figcaption></figure><p id="e32e" class="pw-post-body-paragraph jj jk hi jm b jn kh jp jq jr ki jt ju lo kj jx jy lq kk kb kc ls kl kf kg je hb bi translated">如上所示，我为<strong class="jm hj"><em class="jl">GCP _项目_ID </em> </strong>创建了一个变量，其值为谷歌云项目ID，为<strong class="jm hj"><em class="jl">GCP _服务_密钥</em> </strong>创建了一个变量，其值为之前创建的JSON服务帐户的内容。</p><h1 id="c009" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">持续部署到云运行</h1><p id="1a79" class="pw-post-body-paragraph jj jk hi jm b jn lm jp jq jr ln jt ju lo mm jx jy lq mn kb kc ls mo kf kg je hb bi translated">只剩下几个步骤，我的应用程序将直接从我们的GitLab repo持续部署到Cloud Run。</p><p id="477e" class="pw-post-body-paragraph jj jk hi jm b jn kh jp jq jr ki jt ju lo kj jx jy lq kk kb kc ls kl kf kg je hb bi translated">我的<a class="ae jf" href="https://gitlab.com/Timtech4u/vue-cloudrun" rel="noopener ugc nofollow" target="_blank">应用</a>也有一个Dockerfile，它被配置为在端口8080(云运行的默认端口)上运行。</p><p id="e467" class="pw-post-body-paragraph jj jk hi jm b jn kh jp jq jr ki jt ju lo kj jx jy lq kk kb kc ls kl kf kg je hb bi translated">最后，我创建了一个<strong class="jm hj"><em class="jl">Cloud Build . YAML</em></strong>文件，其中包含了构建&amp; deploy by Cloud Build和<strong class="jm hj">的命令。gitlab-ci.yml </strong>文件，在推送代码时触发部署过程。</p><p id="3040" class="pw-post-body-paragraph jj jk hi jm b jn kh jp jq jr ki jt ju lo kj jx jy lq kk kb kc ls kl kf kg je hb bi translated">下面是我的云构建配置项文件的预览:</p><figure class="me mf mg mh fd ij"><div class="bz dy l di"><div class="mq mr l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">云构建配置项文件</figcaption></figure><p id="de0d" class="pw-post-body-paragraph jj jk hi jm b jn kh jp jq jr ki jt ju lo kj jx jy lq kk kb kc ls kl kf kg je hb bi translated">以下是我的GitLab CI文件的预览:</p><figure class="me mf mg mh fd ij"><div class="bz dy l di"><div class="mq mr l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">GitLab CI文件</figcaption></figure><p id="5980" class="pw-post-body-paragraph jj jk hi jm b jn kh jp jq jr ki jt ju lo kj jx jy lq kk kb kc ls kl kf kg je hb bi translated"><strong class="jm hj">关于云构建的其他资源</strong></p><ul class=""><li id="c505" class="lk ll hi jm b jn kh jr ki lo mi lq mj ls mk je lu lv lw lx bi translated"><a class="ae jf" href="https://cloud.google.com/cloud-build/docs/" rel="noopener ugc nofollow" target="_blank">云构建文档</a></li><li id="c17a" class="lk ll hi jm b jn ly jr lz lo ma lq mb ls mc je lu lv lw lx bi translated"><a class="ae jf" href="https://cloud.google.com/run/docs" rel="noopener ugc nofollow" target="_blank">云运行文档</a></li><li id="207e" class="lk ll hi jm b jn ly jr lz lo ma lq mb ls mc je lu lv lw lx bi translated"><a class="ae jf" href="https://docs.gitlab.com/ee/ci/" rel="noopener ugc nofollow" target="_blank"> GitLab CI文档</a></li></ul></div></div>    
</body>
</html>