<html>
<head>
<title>Using a multi-nic VM as a gateway between VPCs in Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用多网卡虚拟机作为Google Cloud中VPC之间的网关</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/using-a-multi-nic-vm-to-connect-vpcs-in-google-cloud-d84aa533538?source=collection_archive---------2-----------------------#2022-11-24">https://medium.com/google-cloud/using-a-multi-nic-vm-to-connect-vpcs-in-google-cloud-d84aa533538?source=collection_archive---------2-----------------------#2022-11-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="06f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">想象一下，有一个GCP项目设置，其中有多个VPC网络和计算引擎实例托管在其中。默认情况下，一个VPC中的实例无法通过私有IP与其他VPC中的实例通信。</p><p id="66dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要让不同VPC中的实例在不使用公共互联网的情况下相互通信，使用VPC对等似乎是显而易见的。</p><p id="15a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">VPC对等是这种情况下的完美解决方案，但有时组织或客户可能会有一些复杂的要求，使您无法使用VPC对等。</p><p id="e4b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您无法使用VPC对等、私有服务连接等现成服务，并且需要构建自定义内容的情况下，在多个VPC网络中部署一个连接了多个网络接口的计算引擎虚拟机可以完成这项工作。</p><p id="08d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们现在只有2个VPC。我们的想法是创建一个虚拟机，在第一个VPC中有一个网络接口，在第二个VPC中有另一个网络接口。让我们称之为网关虚拟机。我们将使用<code class="du jd je jf jg b">iptables</code>将来自第一个VPC实例的流量转发到第二个。</p><p id="3f2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">类似地，对于成功的请求，我们需要对反向流进行相同的设置。</p><p id="40a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是它可以被形象化的方式。</p><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="er es jh"><img src="../Images/da6f774dfe96d5df48a2d4aaff97b0e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cPIg1xMjsPITyqYfIVfZLw.png"/></div></div><figcaption class="jt ju et er es jv jw bd b be z dx translated">由<a class="jx jy ge" href="https://medium.com/u/3b9a10f61d50?source=post_page-----d84aa533538--------------------------------" rel="noopener" target="_blank"> Devashish Patil </a>设计</figcaption></figure><h1 id="2852" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">设置</h1><p id="594c" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">让我们看看如何设置它。</p><h2 id="060f" class="lc ka hi bd kb ld le lf kf lg lh li kj iq lj lk kn iu ll lm kr iy ln lo kv lp bi translated">VPC</h2><p id="1e0d" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">创建2个名为<code class="du jd je jf jg b">vpc-1</code>和<code class="du jd je jf jg b">vpc-2</code>的VPC，每个VPC至少有一个子网。请注意，这些VPC不能有重叠的IP地址范围。在示例中，<code class="du jd je jf jg b">vpc-1</code>中的子网具有<code class="du jd je jf jg b">10.0.0.0/24</code>地址空间，而<code class="du jd je jf jg b">vpc-2</code>中的子网具有<code class="du jd je jf jg b">172.16.0.0/24</code>地址空间。</p><h2 id="ccd5" class="lc ka hi bd kb ld le lf kf lg lh li kj iq lj lk kn iu ll lm kr iy ln lo kv lp bi translated">计算引擎</h2><p id="0029" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">除了默认配置之外，客户端和服务器虚拟机的创建都不需要额外的配置。在这个例子中，使用了基于Debian的映像。在<code class="du jd je jf jg b">vpc-1</code>中创建<code class="du jd je jf jg b">client</code>，在<code class="du jd je jf jg b">vpc-1</code>中创建<code class="du jd je jf jg b">server</code>。请记住，不要为这些虚拟机分配任何公共IP地址</p><blockquote class="lq lr ls"><p id="880b" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated">确保分配正确的网络标记和防火墙规则，以允许特定端口上的流量。对于这个例子，使用了HTTP请求。</p></blockquote><p id="8b14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于网关虚拟机，在创建过程中需要注意一些事情。让我们看看还需要做些什么。</p><p id="61e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从门户创建网关实例时，在高级选项下，单击网络，可以看到IP转发复选框。这需要启用。</p><figure class="ji jj jk jl fd jm er es paragraph-image"><div class="er es lx"><img src="../Images/1784811288c14cccb2bf9969c95cccdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*Hus-ybo_LQ7K9u2gRhpQoQ.png"/></div></figure><p id="01c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成后，导航到网络接口部分，需要添加2个网络接口，如下例所示。确保删除外部IPv4地址。</p><blockquote class="lq lr ls"><p id="8df6" class="if ig lt ih b ii ij ik il im in io ip lu ir is it lv iv iw ix lw iz ja jb jc hb bi translated">网络接口的数量受到实例中的vCPUs的限制。有关这方面的更多信息，请参考这篇文章。</p></blockquote><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="er es lz"><img src="../Images/99ea89b36660ffc85e849568d9924179.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g21P8cAYUWknhG4ViL0xig.png"/></div></div></figure><p id="919b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就这样，点击创建。一旦所有3个实例都在运行，可以看到客户端和服务器有一个私有IP地址，而网关有2个。</p><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="er es ma"><img src="../Images/36934bf5127fb3dab51417342594adbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YV8LLz2AZ7Cab6xzgquD7A.png"/></div></div></figure><p id="4ed8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于快速连接测试，SSH进入所有3个实例并执行以下操作。</p><ul class=""><li id="16cd" class="mb mc hi ih b ii ij im in iq md iu me iy mf jc mg mh mi mj bi translated">从<code class="du jd je jf jg b">Client</code>ping<code class="du jd je jf jg b">Gateway</code>，就可以了。</li><li id="bab1" class="mb mc hi ih b ii mk im ml iq mm iu mn iy mo jc mg mh mi mj bi translated">从<code class="du jd je jf jg b">Gateway</code>ping<code class="du jd je jf jg b">Server</code>，它会工作</li><li id="cf17" class="mb mc hi ih b ii mk im ml iq mm iu mn iy mo jc mg mh mi mj bi translated">Ping <code class="du jd je jf jg b">Server</code> from <code class="du jd je jf jg b">Client</code>，行不通</li></ul><p id="09fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些步骤的逆过程也是如此。可以看出，<code class="du jd je jf jg b">gateway</code>实例能够到达<code class="du jd je jf jg b">client</code>和<code class="du jd je jf jg b">server</code>实例。</p><h2 id="4e77" class="lc ka hi bd kb ld le lf kf lg lh li kj iq lj lk kn iu ll lm kr iy ln lo kv lp bi translated">IPTables</h2><p id="4bd6" class="pw-post-body-paragraph if ig hi ih b ii kx ik il im ky io ip iq kz is it iu la iw ix iy lb ja jb jc hb bi translated">现在到了需要配置网关实例的部分，来自<code class="du jd je jf jg b">nic0</code>上<code class="du jd je jf jg b">client</code>的请求需要通过<code class="du jd je jf jg b">gateway</code>实例的<code class="du jd je jf jg b">nic1</code>转发到<code class="du jd je jf jg b">server</code>实例。</p><p id="8ecd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，SSH进入<code class="du jd je jf jg b">gateway</code>实例并执行以下步骤。</p><p id="7768" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第一步:允许IP转发</strong></p><pre class="ji jj jk jl fd mp jg mq bn mr ms bi"><span id="2d28" class="mt ka hi jg b be mu mv l mw mx">sudo sysctl -w net.ipv4.ip_forward=1</span></pre><p id="20a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第二步:创建IP表规则:</strong></p><p id="86b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们理解下面提到的命令背后的逻辑。</p><ul class=""><li id="70f6" class="mb mc hi ih b ii ij im in iq md iu me iy mf jc mg mh mi mj bi translated">所有到达<code class="du jd je jf jg b">nic0</code>上的<code class="du jd je jf jg b">gateway</code>实例的请求都以<code class="du jd je jf jg b">nic0</code> IP地址为目的地。</li><li id="327d" class="mb mc hi ih b ii mk im ml iq mm iu mn iy mo jc mg mh mi mj bi translated">当请求到达<code class="du jd je jf jg b">gateway</code>实例时，在预路由规则中，目的地被修改为<code class="du jd je jf jg b">server</code>实例。</li><li id="41f8" class="mb mc hi ih b ii mk im ml iq mm iu mn iy mo jc mg mh mi mj bi translated">现在请求将能够到达<code class="du jd je jf jg b">server</code>，但是请求中的源仍然是<code class="du jd je jf jg b">client</code>的IP地址。因此，在响应流程中，<code class="du jd je jf jg b">server</code>将无法直接与<code class="du jd je jf jg b">client</code>通信。</li><li id="4abf" class="mb mc hi ih b ii mk im ml iq mm iu mn iy mo jc mg mh mi mj bi translated">但是<code class="du jd je jf jg b">server</code>可以在<code class="du jd je jf jg b">nic1</code>上将响应发送回网关。</li><li id="c355" class="mb mc hi ih b ii mk im ml iq mm iu mn iy mo jc mg mh mi mj bi translated">因此，作为POSTROUTING规则，请求中的源被更改为<code class="du jd je jf jg b">gateway</code>实例的<code class="du jd je jf jg b">nic1</code> IP地址，从而完成请求-响应循环。</li></ul><pre class="ji jj jk jl fd mp jg mq bn mr ms bi"><span id="a483" class="mt ka hi jg b be mu mv l mw mx">#Prerouting Rule<br/>sudo iptables --table nat --append PREROUTING --protocol tcp --destination 10.0.0.3 --jump DNAT --to-destination 172.16.0.2<br/><br/>#PostRouting Rule<br/>sudo iptables --table nat --append POSTROUTING --protocol tcp --destination 172.16.0.2 --jump SNAT --to-source 172.16.0.3</span></pre><p id="1efb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，所有的TCP流量都被转发。为了测试这一点，可以在<code class="du jd je jf jg b">server</code>实例中托管一个简单的HTTP服务器。SSH到<code class="du jd je jf jg b">server</code>实例，下面是如何用Python监听端口80。</p><pre class="ji jj jk jl fd mp jg mq bn mr ms bi"><span id="df30" class="mt ka hi jg b be mu mv l mw mx">sudo python3 -m http.server 80</span></pre><p id="9410" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，为了测试这一点，SSH进入客户机实例，用这个简单的curl命令点击网关实例nic0 IP。</p><pre class="ji jj jk jl fd mp jg mq bn mr ms bi"><span id="1689" class="mt ka hi jg b be mu mv l mw mx">curl 10.0.0.3</span></pre><p id="ea86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里需要一个HTML响应(带有服务器实例目录列表)来获得成功的结果。例如:</p><pre class="ji jj jk jl fd mp jg mq bn mr ms bi"><span id="f08f" class="mt ka hi jg b be mu mv l mw mx">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;<br/>&lt;title&gt;Directory listing for /&lt;/title&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;h1&gt;Directory listing for /&lt;/h1&gt;<br/>&lt;hr&gt;<br/>&lt;ul&gt;<br/>&lt;li&gt;&lt;a href=".bash_logout"&gt;.bash_logout&lt;/a&gt;&lt;/li&gt;<br/>&lt;li&gt;&lt;a href=".bashrc"&gt;.bashrc&lt;/a&gt;&lt;/li&gt;<br/>&lt;li&gt;&lt;a href=".profile"&gt;.profile&lt;/a&gt;&lt;/li&gt;<br/>&lt;li&gt;&lt;a href=".ssh/"&gt;.ssh/&lt;/a&gt;&lt;/li&gt;<br/>&lt;/ul&gt;<br/>&lt;hr&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="33b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在实现IPTables之前和之后尝试这样做，以确保流程。</p><p id="4cb6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是如何使用多NIC实例作为2个或更多VPC之间的网关。</p></div><div class="ab cl my mz gp na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="hb hc hd he hf"><h2 id="db6a" class="lc ka hi bd kb ld le lf kf lg lh li kj iq lj lk kn iu ll lm kr iy ln lo kv lp bi translated">结束注释和参考</h2><ul class=""><li id="fd38" class="mb mc hi ih b ii kx im ky iq nf iu ng iy nh jc mg mh mi mj bi translated">这只是IP转发的一个非常简单的用例，但还可以有更多。一个主要的用例是当需要自定义流量过滤时，可以使用这种方法。</li><li id="06e0" class="mb mc hi ih b ii mk im ml iq mm iu mn iy mo jc mg mh mi mj bi translated">这里只使用了一个网关实例，但是为了获得更高的可伸缩性，可以使用负载平衡器和托管实例组的组合。</li><li id="24dc" class="mb mc hi ih b ii mk im ml iq mm iu mn iy mo jc mg mh mi mj bi translated">IP表的基础知识在本文中没有涉及，要详细了解<a class="ae ly" href="https://www.youtube.com/watch?v=NAdJojxENEU" rel="noopener ugc nofollow" target="_blank">这个视频可以参考。</a></li></ul></div></div>    
</body>
</html>