<html>
<head>
<title>How to run containerized workloads in GCE VM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在GCE虚拟机中运行容器化的工作负载</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/how-to-run-containerized-workloads-in-gce-vm-7ae99d5e0975?source=collection_archive---------0-----------------------#2019-08-21">https://medium.com/google-cloud/how-to-run-containerized-workloads-in-gce-vm-7ae99d5e0975?source=collection_archive---------0-----------------------#2019-08-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c03a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然无服务器平台和长时间运行工作负载的想法起初看起来有些“不自然”，但聪明人已经在努力了(看看你的<a class="ae jd" href="http://twitter.com/KnativeProject" rel="noopener ugc nofollow" target="_blank"> @Knative </a>社区)。与此同时，有时你可能只需要一个简单的方法。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/28fbd0fe713a93e2e33d0b7d3b04967d.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*eJqGDbm4PmQSNL4yf67ewg.png"/></div></figure><p id="76e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我将阐述如何使用谷歌计算引擎(GCE)容器执行选项来运行可变持续时间的工作。这种方法支持定制虚拟机、GPU/TPU加速器和VPC网络…因此可能是GCP上其他计算选项的便捷替代方案。我还将演示如何在容器完成时自动终止创建的VM，这样您就不必为空闲的VM时间付费。</p><p id="410f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，在这个例子中，我将解析来自Google Cloud Storage (GCS)的小gzip文件，但是由于这种方法不受客户端超时的限制，所以您可以使用它来做几乎任何事情……对较大文件的转换、轻量级ETL或媒体格式编码。您甚至可以将它与<a class="ae jd" href="https://cloud.google.com/appengine/docs/standard/python/taskqueue/" rel="noopener ugc nofollow" target="_blank"> GCP任务队列</a>结合起来，用于更复杂的管道。</p><h1 id="eeea" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">先决条件</h1><p id="60d6" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">如果你还没有，创建新的GCP项目并配置<a class="ae jd" href="https://cloud.google.com/sdk/docs/" rel="noopener ugc nofollow" target="_blank"> Google Cloud SDK </a>。</p><h1 id="1cac" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">设置</h1><p id="bab4" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">首先，克隆此存储库，并导航到该目录:</p><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="d664" class="ku jn hi kq b fi kv kw l kx ky">git clone <a class="ae jd" href="https://github.com/mchmarny/long-running-job.git" rel="noopener ugc nofollow" target="_blank">https://github.com/mchmarny/long-running-job.git</a><br/>cd long-running-job</span></pre><p id="70b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，为了简化后续命令，我们将导出几个变量:</p><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="40a6" class="ku jn hi kq b fi kv kw l kx ky">export PROJECT=$(gcloud config get-value project)<br/>export APP_NAME="my-long-job"<br/>export SA_NAME="${APP_NAME}@${PROJECT}.iam.gserviceaccount.com"</span></pre><h1 id="0453" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">服务帐户</h1><p id="c5d0" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">要执行此示例，您需要一个<a class="ae jd" href="https://cloud.google.com/iam/docs/creating-managing-service-accounts" rel="noopener ugc nofollow" target="_blank"> GCP服务帐户</a>。你可以在UI中或者使用<code class="du kz la lb kq b"><strong class="ih hj">gcloud</strong></code> SDK来完成。</p><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="79c3" class="ku jn hi kq b fi kv kw l kx ky">gcloud iam service-accounts create <strong class="kq hj">$APP_NAME</strong> \<br/>  --display-name "Service Invoker Account for <strong class="kq hj">${APP_NAME}</strong>"</span></pre><p id="020f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还必须为该帐户分配必要的IAM角色:</p><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="770b" class="ku jn hi kq b fi kv kw l kx ky">gcloud projects add-iam-policy-binding $PROJECT \<br/>  --member "serviceAccount:${SA_NAME}" \<br/>  --role <strong class="kq hj">roles/logging.logWriter</strong></span><span id="dcdf" class="ku jn hi kq b fi lc kw l kx ky">gcloud projects add-iam-policy-binding $PROJECT \<br/>  --member "serviceAccount:${SA_NAME}" \<br/>  --role <strong class="kq hj">roles/cloudtrace.agent</strong></span><span id="12a7" class="ku jn hi kq b fi lc kw l kx ky">gcloud projects add-iam-policy-binding $PROJECT \<br/>  --member "serviceAccount:${SA_NAME}" \<br/>  --role <strong class="kq hj">roles/monitoring.metricWriter</strong></span><span id="7a57" class="ku jn hi kq b fi lc kw l kx ky">gcloud projects add-iam-policy-binding $PROJECT \<br/>  --member "serviceAccount:${SA_NAME}" \<br/>  --role <strong class="kq hj">roles/storage.objectViewer</strong></span><span id="fe3d" class="ku jn hi kq b fi lc kw l kx ky">gcloud projects add-iam-policy-binding $PROJECT \<br/>  --member "serviceAccount:${SA_NAME}" \<br/>  --role <strong class="kq hj">roles/pubsub.editor</strong></span><span id="bcf5" class="ku jn hi kq b fi lc kw l kx ky">gcloud projects add-iam-policy-binding $PROJECT \<br/>  --member "serviceAccount:${SA_NAME}" \<br/>  --role <strong class="kq hj">roles/compute.instanceAdmin</strong></span></pre><p id="6954" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，为了使我们的演示能够模拟该帐户，我们需要为该帐户提供一个密钥，该密钥将保存在您的主目录中。您应该保护该密钥，或者在演示结束后将其删除。</p><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="bded" class="ku jn hi kq b fi kv kw l kx ky">gcloud iam service-accounts keys create \<br/>  --iam-account $SA_NAME <strong class="kq hj">"${HOME}/.${APP_NAME}-sa.json"</strong></span></pre><h1 id="8c10" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">容器图像</h1><p id="cef9" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">本例中的工作负载单位是容器映像。在本演示中，要从源代码创建映像，首先需要供应商提供所有的依赖项:</p><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="18e9" class="ku jn hi kq b fi kv kw l kx ky">go mod tidy<br/>go mod vendor</span></pre><p id="a05e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后将映像构建请求提交给云构建:</p><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="5d7f" class="ku jn hi kq b fi kv kw l kx ky">gcloud builds submit --tag <strong class="kq hj">"gcr.io/${PROJECT}/${APP_NAME}:0.0.1"</strong></span></pre><p id="8bf1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果成功，您应该会看到一个确认，其中包含创建的映像的完全合格的URI。</p><h1 id="16b6" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">将容器部署到虚拟机</h1><p id="5347" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">现在启动一个新的虚拟机，并配置它运行上面构建的映像。该示例将使用位于公共GCS bucket(long-running-job-src-files)中的gzipped CSV文件(100-Sales-Records.csv.gz)。如果你愿意，你可以用你自己的文件替换它们。</p><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="9271" class="ku jn hi kq b fi kv kw l kx ky">gcloud compute instances create-with-container <strong class="kq hj">$APP_NAME</strong> \<br/>  --container-image=<strong class="kq hj">"gcr.io/${PROJECT}/${APP_NAME}:0.0.1"</strong> \<br/>  --machine-type=<strong class="kq hj">n1-standard-1</strong> \<br/>  --zone=<strong class="kq hj">us-central1-c</strong> \<br/>  --image-family=cos-stable \<br/>  --image-project=cos-cloud \<br/>  --maintenance-policy=MIGRATE \<br/>  --scopes=cloud-platform \<br/>  --container-privileged \<br/>  --container-env=<strong class="kq hj">"GOOGLE_APPLICATION_CREDENTIALS=/tmp/sa.pem,BUCKET=long-running-job-src-files,OBJECT=100-Sales-Records.csv.gz,TOPIC=${APP_NAME}"</strong> \<br/>  --container-mount-host-path=<strong class="kq hj">mount-path=/tmp,host-path=/tmp,mode=rw</strong></span></pre><p id="d45c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在没有办法在同一个命令中上传文件，所以之后，您需要将上面创建的服务帐户密钥复制到新的虚拟机。容器被设置为在出现故障时重启，因此当密钥在连接到我们的虚拟机的已挂载卷中可用时，它将自动使用该密钥。</p><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="97bf" class="ku jn hi kq b fi kv kw l kx ky">gcloud compute scp <strong class="kq hj">"${HOME}/.${APP_NAME}-sa.json"</strong> \<br/>  <strong class="kq hj">"${APP_NAME}:/tmp/sa.pem"</strong> --zone=<strong class="kq hj">us-central1-c</strong></span></pre><h1 id="ee38" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">集装箱日志</h1><p id="fbfc" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">一旦VM启动，您就可以监控从容器到<a class="ae jd" href="https://cloud.google.com/stackdriver/" rel="noopener ugc nofollow" target="_blank"> Stackdriver </a>的日志输出。为此，我们需要首先捕获虚拟机实例Id:</p><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="ad36" class="ku jn hi kq b fi kv kw l kx ky">export VM_INSTANCE_ID=$(gcloud compute instances describe \<br/>  <strong class="kq hj">$APP_NAME</strong> --zone=<strong class="kq hj">us-central1-c</strong> --format="value(id)")</span></pre><p id="adc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我们捕获了VM实例ID，我们现在可以查询<a class="ae jd" href="https://cloud.google.com/stackdriver/" rel="noopener ugc nofollow" target="_blank"> Stackdriver </a>来获取容器输出的日志:</p><pre class="jf jg jh ji fd kp kq kr ks aw kt bi"><span id="37ae" class="ku jn hi kq b fi kv kw l kx ky">gcloud logging read "resource.type=gce_instance AND \<br/>  logName=projects/${PROJECT}/logs/cos_containers AND \<br/>  resource.labels.instance_id=<strong class="kq hj">${VM_INSTANCE_ID}</strong> AND \<br/>  <strong class="kq hj">jsonPayload.message:\"[LRJ]\""</strong> \<br/>  --order="asc"</span></pre><blockquote class="ld le lf"><p id="e6d6" class="if ig lg ih b ii ij ik il im in io ip lh ir is it li iv iw ix lj iz ja jb jc hb bi translated"><em class="hi">注意，该命令将只打印用户代码在容器中输出的日志(内部的日志记录器在所有日志条目前加上前缀“[LRJ]”)。您可以通过移除</em> <code class="du kz la lb kq b"><em class="hi">jsonPayload.message:"[LRJ]"</em></code> <em class="hi">过滤器来查看日志条目的完整列表。</em></p></blockquote><p id="fbb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">容器存在后，VM将自动关闭，但日志仍然可以在Stackdriver中进行取证分析。</p><h1 id="a142" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">结论</h1><p id="6318" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">我希望你能发现这个对你GCP计算机工具箱有帮助的补充。你可以在https://github.com/mchmarny/long-running-job的<a class="ae jd" href="https://github.com/mchmarny/long-running-job" rel="noopener ugc nofollow" target="_blank">网站</a>找到源代码和更容易执行的脚本</p></div></div>    
</body>
</html>