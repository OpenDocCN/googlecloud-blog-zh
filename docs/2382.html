<html>
<head>
<title>Managing Cloud SQL failover in Terrafrom</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Terrafrom中管理云SQL故障转移</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/managing-cloud-sql-failover-in-terrafrom-ee34f582be97?source=collection_archive---------1-----------------------#2022-09-24">https://medium.com/google-cloud/managing-cloud-sql-failover-in-terrafrom-ee34f582be97?source=collection_archive---------1-----------------------#2022-09-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e8a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将了解如何使用Terraform以重复和自动化的方式管理云SQL副本到主服务器的升级。</p><p id="86e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> TOC </strong></p><ul class=""><li id="a95c" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">GCP云SQL中的高可用性/灾难恢复选项</li><li id="fdf7" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">将读取副本提升为主副本时要考虑的事项</li><li id="4f68" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">主&amp;副本的基础地形设置</li><li id="d3c4" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">触发故障转移并观察TF状态文件问题</li><li id="8769" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">解决方案设计要求</li><li id="2794" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">完成地形状态管理的配置更改</li><li id="c31e" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">通过CI/CD管道触发故障转移</li><li id="a047" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">使用CI/CD管道触发回切到原始状态</li></ul><p id="6195" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud为云SQL数据库提供了两个基本的故障转移选项</p><h1 id="b65c" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">GCP云SQL的高可用性/灾难恢复选项</h1><p id="48b7" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated"><strong class="ih hj">高可用性</strong> —在这种方法中，主云SQL实例在一个区域(例如:区域a)中调配，辅助实例在另一个区域(例如:区域b)中调配，但共享相同的IP地址和连接字符串。从地形的角度来看，没有变化。</p><p id="266e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">读取副本</strong> —在这种方法中，您在主分区之外的不同分区中拥有一个读取副本，或者在完全不同的区域中拥有一个读取副本。</p><ul class=""><li id="a6d3" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">读取复制副本是主实例的精确拷贝</li><li id="a021" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">仅用于读取和执行查询，不用于写入</li><li id="a5d9" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">减少主节点上的负载。你可以点击这里的链接了解更多关于读取副本和跨区域读取副本的信息<a class="ae ku" href="https://cloud.google.com/sql/docs/mysql/replication#read-replicas" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/SQL/docs/MySQL/replication # read-replicas</a></li></ul><h1 id="6471" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">将读取副本提升为主副本时要考虑的事项:</strong></h1><p id="d1b1" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">如果出现区域性中断或数据库损坏，您可能会在故障排除过程中确定主数据库无法及时恢复，并且您需要提升读取副本以接管主实例。这里有几个考虑因素:</p><ul class=""><li id="0651" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">当读取复制副本提升为主副本时，它将成为独立的数据库</li><li id="4c06" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">应用程序现在需要使用新提升的主服务器(以前的读取副本)的连接字符串或IP地址</li><li id="7cf8" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">读取副本不会回退到主副本。主数据库只能用于历史目的，一旦安全，最终应该被删除。</li></ul><h1 id="aaef" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">云SQL主服务器和读取副本的平台:</strong></h1><p id="9414" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">确保在您的GCP项目中启用了以下API</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="4867" class="le js hi la b fi lf lg l lh li">gcloud services enable servicenetworking.googleapis.com sqladmin.googleapis.com</span></pre><p id="df7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看下面的terraform配置，创建一个主数据库和一个读取副本数据库。</p><p id="89e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要提供以下值</p><ul class=""><li id="4616" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">创建一个GCS存储桶来存储Terraform状态文件</li><li id="438b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">在下面的地形配置中提供GCS存储桶名称</li><li id="a052" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">在<code class="du lj lk ll la b">terraform.tfvars</code>文件中提供云SQL区域1、区域2和VPC网络名称的值</li></ul><figure class="kv kw kx ky fd lm"><div class="bz dy l di"><div class="ln lo l"/></div></figure><figure class="kv kw kx ky fd lm"><div class="bz dy l di"><div class="ln lo l"/></div></figure><figure class="kv kw kx ky fd lm"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="a919" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">执行上述terraform后，我们将创建一个主SQL实例和一个读取副本实例，如下图所示</p><figure class="kv kw kx ky fd lm er es paragraph-image"><div class="er es lp"><img src="../Images/bb16a8ac5d790f781575da7fc0d3bd4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*GPQQ2-8JkIKAn6ndqP9D-g.png"/></div></figure><p id="eaf0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们使用<code class="du lj lk ll la b">gcloud </code>或直接在云控制台上触发副本到主服务器的手动升级</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="ce66" class="le js hi la b fi lf lg l lh li">gcloud sql instances promote-replica &lt;replica-id&gt;</span></pre><figure class="kv kw kx ky fd lm er es paragraph-image"><div class="er es ls"><img src="../Images/c56e291ff4dde5eccb51beaa83b0f6b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*dwctmSRWouTRwrI2dBFPXg.png"/></div></figure><p id="6cbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以看到副本已成为独立数据库，主数据库不再复制到读取副本实例</p><figure class="kv kw kx ky fd lm er es paragraph-image"><div class="er es lt"><img src="../Images/01f3a4e51064fb0cfce635af711781f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*4IKObWsdWQk4mZuW6LPp2A.png"/></div></figure><p id="b085" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常，当我们手动将副本提升为主副本时，terraform中不会捕捉到更改。在执行<code class="du lj lk ll la b">terraform plan</code>时，terraform将尝试用旧的主数据库和副本数据库替换数据库</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="5099" class="le js hi la b fi lf lg l lh li">resource "google_sql_database_instance" "master"<br/>resource "google_sql_database_instance" "read_replica"</span></pre><p id="ae37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为它认为GCP偏离了它的国家文件。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="87c1" class="le js hi la b fi lf lg l lh li"># google_sql_database_instance.master has been changed<br/># google_sql_database_instance.read_replica has been changed</span><span id="9b1b" class="le js hi la b fi lu lg l lh li"><strong class="la hj"># google_sql_database_instance.master must be replaced<br/># google_sql_database_instance.read_replica must be replaced</strong></span><span id="08cf" class="le js hi la b fi lu lg l lh li"><strong class="la hj">Plan: 2 to add, 0 to change, 2 to destroy</strong></span></pre><h1 id="e1ff" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">方案设计要求:</strong></h1><ul class=""><li id="875f" class="jd je hi ih b ii kp im kq iq lv iu lw iy lx jc ji jj jk jl bi translated">如何管理升级的读取副本的地形状态，该状态不应触发升级的读取副本的替换</li><li id="49b6" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">如何从提升的主实例创建新的读取副本，以便我们可以保持部署在更改之前的状态</li><li id="85a3" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">如何通过避免手动错误引入自动化、可重复性和可靠性</li><li id="daef" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">停机结束后如何回切到主区域并恢复</li></ul><p id="f7ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤1 —更改地形配置:</strong></p><p id="c30d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了避免这种情况，我们添加了块<code class="du lj lk ll la b">lifecycle {ignore_changes}</code>来指示terraform，而不是跟踪数据库名称的更改，因此在手工升级后，terraform不会强制替换主云SQL实例。重要的是保持所有其他参数相同(如<em class="ly">区域，disk_size)。下面的</em>是修改后的<code class="du lj lk ll la b">main.tf</code>文件</p><figure class="kv kw kx ky fd lm"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="8f8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤2——使用terraform状态命令对terraform状态文件进行更改</strong></p><p id="11c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里，我们将使用<code class="du lj lk ll la b">terraform state</code>命令将read_replica状态移动到主terraform资源中</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="c237" class="le js hi la b fi lf lg l lh li"># Remove the master instance from state file <br/>terraform state rm google_sql_database_instance.master     </span><span id="0c97" class="le js hi la b fi lu lg l lh li"># Remove the replica instance from state file <br/>terraform state rm google_sql_database_instance.read_replica  <br/>   <br/># Now import the state of read_replica into master terraform config<br/>terraform import google_sql_database_instance.master &lt;project_id&gt;/&lt;read-replica&gt;<br/>    <br/># Finally create a new random suffix id for the new read-replica, <br/># otherwise it will try to create it with the same name <br/>terraform state rm random_id.db_name_suffix_replica</span><span id="a958" class="le js hi la b fi lu lg l lh li">## We are checking if the master and replica were originally created ## in different region, hence trigger a rebuild of replica in the  ## primary region</span><span id="176c" class="le js hi la b fi lu lg l lh li">if [ "master_region" != "replica_region" ]; then<br/>   terraform plan -var region1=$replica_region -var region2=$master_region -out "planfile1"</span><span id="b7b3" class="le js hi la b fi lu lg l lh li">else<br/>   terraform plan -out "planfile1"<br/>fi</span></pre><p id="aefd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤3——将这些变更作为流水线步骤执行</strong></p><p id="f330" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们不应该尝试手动这样做，主要原因是在进行复制粘贴和交换名称和id时，状态文件的更改可能是灾难性的。让我们看看如何在Gitlab管道中触发这一点。在这里，我们添加了两个将被手动触发的新更改</p><figure class="kv kw kx ky fd lm er es paragraph-image"><div class="er es lz"><img src="../Images/9bb0c1f91de0172818644a9e80ae3319.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*SrNAUTquDWhOJpBaCJYeTg.png"/></div></figure><p id="8b27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du lj lk ll la b"><strong class="ih hj">promote-tf-reconcile</strong></code>流水线阶段，我们正在检索<code class="du lj lk ll la b">replica instance "name”</code>，执行状态文件更改，最后运行该阶段的最后一步，我们还将执行一个</p><p id="edf4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lj lk ll la b">terraform plan</code></p><p id="4217" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">计划输出应该只显示<strong class="ih hj">一个新的读取副本</strong>将被创建，主副本指向手动提升的实例</p><figure class="kv kw kx ky fd lm er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es ma"><img src="../Images/380e0ef8cd3a64cf2250370c6acb2dd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p95khDk_QTBqZinw-AQRhw.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx translated"><code class="du lj lk ll la b"><strong class="bd jt">promote-tf-reconcile </strong>stage</code>的管道执行示例</figcaption></figure><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="6b17" class="le js hi la b fi lf lg l lh li">Terraform will perform the following actions:</span><span id="3b1c" class="le js hi la b fi lu lg l lh li"># google_sql_database_instance.read_replica will be created</span><span id="c6b1" class="le js hi la b fi lu lg l lh li">+ resource "google_sql_database_instance" "read_replica" {<br/>+ connection_name               = (known after apply)<br/>+ database_version              = "POSTGRES_11"<br/>+ ip_address                    = (known after apply)<br/>+ master_instance_name          = "app1-db-e6d9"<br/>+ name                          = (known after apply)<br/>+ service_account_email_address = (known after apply)<br/>+ replica_configuration {<br/>+ failover_target = false<br/>      + settings {<br/>          + activation_policy     = "ALWAYS"<br/>          + availability_type     = "REGIONAL"</span><span id="63d8" class="le js hi la b fi lu lg l lh li">....<br/># random_id.db_name_suffix_replica will be created<br/>+ resource "random_id" "db_name_suffix_replica" {</span><span id="19fc" class="le js hi la b fi lu lg l lh li"><strong class="la hj">Plan: 2 to add, 0 to change, 0 to destroy.</strong><br/>Changes to Outputs:<br/>  + replica_instance_name = (known after apply)<br/>  + replica_region        = "us-central1"</span></pre><p id="6c7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤3 — </strong>一旦我们验证了计划输出，我们就可以触发管道的下一个阶段，该阶段正在应用变更</p><figure class="kv kw kx ky fd lm er es paragraph-image"><div class="er es mj"><img src="../Images/0a860d33d1586d11b78cfd8a3d181ea8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*ig7V7HVN3kdE5RWaBCgwRQ.png"/></div></figure><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="3003" class="le js hi la b fi lf lg l lh li">terraform apply</span></pre><p id="ae84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该能够在控制台中看到，新的复制副本创建已经开始。</p><figure class="kv kw kx ky fd lm er es paragraph-image"><div class="er es mk"><img src="../Images/726777b206358d7a54b3e80a19ad10e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*Zg52sjDWhkqTd7xN7LCqaw.png"/></div></figure><p id="3e2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们能够使用这种方法将状态更改安全地导入Terraform，并将云SQL实例恢复到相同的配置。</p><p id="1249" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是本例中使用的完整Gitlab管道阶段和配置</p><figure class="kv kw kx ky fd lm er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es ml"><img src="../Images/bcd4a9bf0c7ec2db90733f881eaa19c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F0L9PkZenpfzNYFAFHyX-g.png"/></div></div></figure><figure class="kv kw kx ky fd lm"><div class="bz dy l di"><div class="ln lo l"/></div></figure><h1 id="c046" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">将数据库回切到主区域(原始状态)</strong></h1><p id="95e6" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">一旦中断结束，您希望将数据库转移回主区域，您将再次执行相同的步骤。</p><ul class=""><li id="bc27" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">提升在主区域中创建的读取副本(手动—使用控制台或gcloud)。一些客户可能更喜欢使用gcloud在管道中完成这一步。</li><li id="e443" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">要在辅助区域创建新的读取副本，可以再次执行管道的最后两个阶段:</li></ul><figure class="kv kw kx ky fd lm er es paragraph-image"><div class="er es lz"><img src="../Images/9bb0c1f91de0172818644a9e80ae3319.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*SrNAUTquDWhOJpBaCJYeTg.png"/></div></figure><figure class="kv kw kx ky fd lm er es paragraph-image"><div class="er es mm"><img src="../Images/94956b2c97de265ae2bfaae695d7c11a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*HpoXBQ-ToytABoCzdvpHgg.png"/></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">回切到主服务器后的最终部署</figcaption></figure><p id="209c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，主数据库回到了<strong class="ih hj">美国中部1 </strong>，副本数据库回到了<strong class="ih hj">美国东部4 </strong></p><p id="601a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的<strong class="ih hj">起始状态参考图:</strong></p><figure class="kv kw kx ky fd lm er es paragraph-image"><div class="er es lp"><img src="../Images/bb16a8ac5d790f781575da7fc0d3bd4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*GPQQ2-8JkIKAn6ndqP9D-g.png"/></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">原始期</figcaption></figure></div></div>    
</body>
</html>