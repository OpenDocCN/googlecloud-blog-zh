<html>
<head>
<title>Continuous training with BigQuery ML and Vertex AI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用BigQuery ML和Vertex AI进行持续训练</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/continuous-training-with-bigquery-ml-and-vertex-ai-d43330b6f3ed?source=collection_archive---------0-----------------------#2022-09-02">https://medium.com/google-cloud/continuous-training-with-bigquery-ml-and-vertex-ai-d43330b6f3ed?source=collection_archive---------0-----------------------#2022-09-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/849f2234a7d14220c5766b474589464c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w9IAXIqjSzIUpvW0UMAKtg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">BigQuery、Vertex AI、云日志、云发布订阅和云功能v2</figcaption></figure><p id="815c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">当涉及到训练一个ML模型时，ML管道的一些主要步骤是:</p><ol class=""><li id="4321" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">预处理数据</li><li id="6124" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">训练模型</li><li id="1c5a" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">评估模型</li><li id="a427" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">验证模型</li></ol><p id="05cc" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">诸如数据更新的频率和数量或业务时间表等因素要求您更快地执行这些管道。这就是为什么你会考虑组织和自动化你的培训工作的原因之一。另一个关键原因是，您不希望您的数据科学家和ML工程师将他们的时间花费在重复重新训练相同模型并将其部署到生产的乏味任务上。事实上，<a class="ae kg" href="https://towardsdatascience.com/3-facts-about-time-series-forecasting-that-surprise-experienced-machine-learning-practitioners-69c18ee89387" rel="noopener" target="_blank">数据和概念漂移，以及各种高度不稳定的信号出现在大多数商业ML用例中，它们会影响模型性能</a>。</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kh"><img src="../Images/38d825a6a60184b1f9f702dd9dbef6fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eVOIJJWLcluz_-yrX_63LQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">图一。预测的时候再培训(<a class="ae kg" href="https://towardsdatascience.com/3-facts-about-time-series-forecasting-that-surprise-experienced-machine-learning-practitioners-69c18ee89387" rel="noopener" target="_blank">来源</a></figcaption></figure><p id="e318" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">所以团队需要维护他们的模型。相反，你希望他们专注于解决新的挑战，发现新的商业见解，并开发新产品。</p><p id="7b92" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在这篇文章中，我提出了一个简单的连续训练系统，它包括新的云函数v2和preview中的Vertex AI Pipeline通知电子邮件操作员。目标是让您了解如何使用Google Cloud实现可靠的再培训流程，包括触发器和通知。</p></div><div class="ab cl km kn gp ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="hb hc hd he hf"><h1 id="689c" class="kt ku hi bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">你想要更多吗？让我知道！</h1><p id="03f4" class="pw-post-body-paragraph iu iv hi iw b ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr hb bi translated">关于如何在Google Cloud 上使用<a class="ae kg" href="https://cloud.google.com/data-science" rel="noopener ugc nofollow" target="_blank">数据科学，你有希望在未来看到的话题吗？</a></p><p id="6189" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">请填写这张表格让我知道。这对我以后的博文会有帮助=)</p><p id="1bf6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">也可以在Twitter上联系到<a class="ae kg" href="https://twitter.com/IlNardo92" rel="noopener ugc nofollow" target="_blank"> @IlNardo92 </a>或<a class="ae kg" href="https://www.linkedin.com/in/ivan-nardini/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>。</p><h1 id="5626" class="kt ku hi bd kv kw lw ky kz la lx lc ld le ly lg lh li lz lk ll lm ma lo lp lq bi translated">你需要知道的是</h1><p id="4f56" class="pw-post-body-paragraph iu iv hi iw b ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr hb bi translated">本文是以下内容的后续:</p><ul class=""><li id="4f8c" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr mb jy jz ka bi translated"><a class="ae kg" href="https://cloud.google.com/blog/topics/developers-practitioners/announcing-bigquery-and-bigquery-ml-operators-vertex-ai-pipelines" rel="noopener ugc nofollow" target="_blank">宣布顶点AI管道的BigQuery和BigQuery ML操作符</a></li><li id="811c" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated">【BQML |谷歌云博客的20多家新管道运营商</li></ul><p id="15fe" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">本文假设您熟悉BigQuery和Vertex AI之间的集成。此外，它还要求您了解最新的云功能V2，这是提供更多事件、计算和控制的新一代云功能。如果您想了解更多信息，请查看以下资源:</p><ul class=""><li id="b076" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr mb jy jz ka bi translated"><a class="ae kg" href="https://cloud.google.com/blog/products/ai-machine-learning/five-integrations-between-vertex-ai-and-bigquery" rel="noopener ugc nofollow" target="_blank">Vertex AI与BigQuery的五次整合|谷歌云博客</a></li><li id="3c85" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated"><a class="ae kg" href="https://cloud.google.com/blog/products/serverless/cloud-functions-2nd-generation-now-generally-available" rel="noopener ugc nofollow" target="_blank">云功能第二代是GA，提供更多事件、计算和控制</a></li></ul></div><div class="ab cl km kn gp ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="hb hc hd he hf"><h1 id="6c1c" class="kt ku hi bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">你为什么要关心持续训练？</h1><p id="1b7a" class="pw-post-body-paragraph iu iv hi iw b ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr hb bi translated"><a class="ae kg" href="https://cloud.google.com/blog/topics/developers-practitioners/new-20-pipeline-operators-bqml" rel="noopener ugc nofollow" target="_blank">在我们的场景</a>中，你是一家专门销售新鲜易腐食品的零售商的数据科学团队或商品工程团队的成员。该公司希望最大限度地减少食物浪费，优化所有商店的库存水平。由于库存更新的频率(对于一些高销售速度的新鲜食品来说可能是每分钟一次)，<strong class="iw hj">他们希望使用BQML每小时重新训练一次需求预测模型。</strong></p><p id="7146" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果我们假设您手动训练您的模型，这意味着您需要运行</p><p id="8854" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> 3次查询运行(准备、培训、评估)x 24次培训运行= 72次运行/天</strong></p><p id="479a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">现在让我们考虑引入顶点人工智能管道的场景。</strong>每个查询成为一个组件，执行可重现的<a class="ae kg" href="https://www.kubeflow.org/docs/components/pipelines/introduction/#what-is-kubeflow-pipelines" rel="noopener ugc nofollow" target="_blank"> Kubeflow管道</a>工作流的一部分。这些管道将作为Vertex AI上的无服务器运行来执行。那你就有了</p><p id="93c4" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> 1次管道运行x 24次培训= 24次运行</strong></p><p id="6d23" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">太好了。但现在的问题是:<strong class="iw hj">还能更好吗？</strong></p><p id="8e97" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">是的，可以。</p><p id="4f08" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">事实上，您仍然需要手动运行管道培训。显然，每小时运行一个新的预测任务对于任何合理规模的数据科学或营销团队来说都是不可行的。事实上，您不会只是坐在那里等待一个查询完成，然后手动触发第二个查询(然后在第二个查询完成后触发第三个查询)。但是您将创建一个管道，并在必要时部署它。</p><blockquote class="mc"><p id="7ba3" class="md me hi bd mf mg mh mi mj mk ml jr dx translated">如果每当新的训练数据被接收到BigQuery中时，就自动执行管道，会怎么样？</p><p id="7acb" class="md me hi bd mf mg mh mi mj mk ml jr dx translated">在这种需求预测的情况下，建立一个持续的培训流程有多难？</p></blockquote><p id="454b" class="pw-post-body-paragraph iu iv hi iw b ix mm iz ja jb mn jd je jf mo jh ji jj mp jl jm jn mq jp jq jr hb bi translated">通过正确的警报，您可以为您的管道创建一个计划的触发器，以便您可以训练您的模型，并让它们始终保持最新的数据。正如你可以想象的那样，频繁地对新数据进行再训练可以让你捕捉到新的趋势和模式，并可能得到更好的模型。</p><h1 id="0209" class="kt ku hi bd kv kw lw ky kz la lx lc ld le ly lg lh li lz lk ll lm ma lo lp lq bi translated">设置连续培训</h1><p id="17ca" class="pw-post-body-paragraph iu iv hi iw b ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr hb bi translated">持续培训过程的组成部分之一是再培训触发器。正如在<a class="ae kg" href="https://services.google.com/fh/files/misc/practitioners_guide_to_mlops_whitepaper.pdf" rel="noopener ugc nofollow" target="_blank">MLOps的实践者指南:机器学习的连续交付和自动化的框架</a>中提到的，流水线运行可以由预定的作业、事件或手动调用来触发。</p><p id="dd4c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">在我们的例子中，当BigQuery中有新的库存数据时，我们希望触发新的管道运行。</strong></p><p id="1323" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">根据<a class="ae kg" href="https://cloud.google.com/vertex-ai/docs/pipelines/trigger-pubsub" rel="noopener ugc nofollow" target="_blank">顶点AI文档</a>，</p><p id="f60a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="mr">您可以使用带有云发布/订阅触发器的事件驱动云功能来部署和触发管道运行。</em></p><p id="468a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">太好了。但是<strong class="iw hj">触发管道运行的事件怎么办？</strong></p><p id="d2f6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="mr">big query中的每一次数据交互，比如给定查询作业读写的表，都会自动记录在</em> <a class="ae kg" href="https://cloud.google.com/bigquery/docs/reference/auditlogs" rel="noopener ugc nofollow" target="_blank"> <em class="mr">云日志</em> </a> <em class="mr">中，所以我们可以使用这些信息作为事件来触发管道。</em></p><p id="5059" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，需要注意的是，默认情况下每个数据交互都会被记录。</p><p id="5e53" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为什么它很重要？一如既往，细节决定成败。如果不过滤记录的事件，可能会触发意外的管道重新训练运行。这正是我在一个共享项目中实现该系统时遇到的情况，Composer和Looker也在BigQuery上读写数据。</p><p id="58e4" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="mr">为了更好地控制触发事件，我决定创建一个</em><a class="ae kg" href="https://cloud.google.com/logging/docs/export/configure_export_v2" rel="noopener ugc nofollow" target="_blank"><em class="mr"/></a><strong class="iw hj"><em class="mr">。</em> </strong></p><p id="0e50" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">有了它，您可以控制云日志如何路由事件日志。特别是，您可以使用包含筛选器来定义一个筛选器表达式，该表达式与您想要用来触发管道重新训练并将它们路由到发布/订阅的数据事件相匹配。一旦您在发布/订阅中收集了这些事件，您也可以很容易地获得用于验证目的的访问。</p><p id="3c0d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">总结</p><ul class=""><li id="ff39" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr mb jy jz ka bi translated">大查询数据事件记录在云日志中</li><li id="f2a3" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated">数据事件被过滤并路由到发布/订阅</li><li id="c304" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated">发布/订阅消息触发运行顶点人工智能再训练流水线的云函数</li></ul><p id="4866" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">最后但同样重要的是，收到管道运行状态的通知不是很好吗？</strong></p><p id="7656" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">当然，您可以考虑使用云日志、发布/订阅和云函数记录管道运行事件，就像您对BigQuery数据事件<a class="ae kg" href="https://cloud.google.com/architecture/sending-notifications-for-google-cloud-events" rel="noopener ugc nofollow" target="_blank">所做的那样。</a></p><p id="8e6b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="mr">但是从管道运行发送通知的另一种方式是使用</em><a class="ae kg" href="https://google-cloud-pipeline-components.readthedocs.io/en/google-cloud-pipeline-components-1.0.16/google_cloud_pipeline_components.experimental.vertex_notification_email.html?highlight=VertexNotificationEmailOp#google_cloud_pipeline_components.experimental.vertex_notification_email.VertexNotificationEmailOp" rel="noopener ugc nofollow" target="_blank"><em class="mr">VertexNotificationEmailOp</em></a><em class="mr">。</em></p><p id="15ce" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">当Google Cloud Pipeline组件的这个组件(目前是试验性的)作为一个<a class="ae kg" href="https://kubeflow-pipelines.readthedocs.io/en/stable/source/kfp.dsl.html?highlight=exit%20handler#kfp.dsl.ExitHandler" rel="noopener ugc nofollow" target="_blank"> ExitHandler </a>被包含时，它会向指定的接收者发送一封通知电子邮件，通知上游DAG的状态。</p><p id="fb2e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">最后，这是持续培训系统的流程。</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/f3976d1a40df997ca71399f79c56f741.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yQRDPzCjn-a0DvN10N9azA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">图二。持续培训系统</figcaption></figure><p id="9951" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">请注意，Vertex AI Pipelines与Vertex ML元数据紧密集成，这允许跟踪所有元数据和工件，以便进行调试、可再现性和沿袭分析。此外，经过训练和验证的模型将存储在Vertex AI模型注册表中，如关于如何为BQML利用新的20+管道操作符的<a class="ae kg" href="https://cloud.google.com/blog/topics/developers-practitioners/new-20-pipeline-operators-bqml" rel="noopener ugc nofollow" target="_blank">原始博客帖子</a>所示。</p><p id="d9d1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在我们已经有了系统的全貌，让我们来看看如何构建它的步骤。</p><h1 id="bc34" class="kt ku hi bd kv kw lw ky kz la lx lc ld le ly lg lh li lz lk ll lm ma lo lp lq bi translated">分三步构建持续培训体系</h1><h2 id="cd7a" class="mt ku hi bd kv mu mv mw kz mx my mz ld jf na nb lh jj nc nd ll jn ne nf lp ng bi translated">步骤1:编译管道并上传到Google云存储上的一个桶中</h2><p id="31ab" class="pw-post-body-paragraph iu iv hi iw b ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr hb bi translated">要使用云功能触发重新培训管道运行，您需要将管道上传到Google云存储。</p><p id="06ac" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">与最初的博文相比，我稍微修改了管道，以便添加<a class="ae kg" href="https://google-cloud-pipeline-components.readthedocs.io/en/google-cloud-pipeline-components-1.0.16/google_cloud_pipeline_components.experimental.vertex_notification_email.html?highlight=VertexNotificationEmailOp#google_cloud_pipeline_components.experimental.vertex_notification_email.VertexNotificationEmailOp" rel="noopener ugc nofollow" target="_blank">VertexNotificationEmailOp</a>。下面你可以看到新管道的伪代码。</p><figure class="ki kj kk kl fd ij"><div class="bz dy l di"><div class="nh ni l"/></div></figure><p id="96c4" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">其中<em class="mr">get _ evaluation _ model _ metrics _ op</em>是一个定制组件，用于获取时间序列和模型性能指标以评估模型。</p><p id="6953" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">因为模型每小时都要训练和部署，所以我决定将训练和部署实现到一个单独的管道中，该管道将通过<em class="mr"> notify_email_task </em>组件发送状态通知。</p><h2 id="1eb7" class="mt ku hi bd kv mu mv mw kz mx my mz ld jf na nb lh jj nc nd ll jn ne nf lp ng bi translated">步骤2:从云日志创建一个发布/订阅主题和一个接收器，以捕获和过滤BigQuery数据事件</h2><p id="2002" class="pw-post-body-paragraph iu iv hi iw b ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr hb bi translated">一旦您创建了一个发布/订阅主题来接收来自云日志接收器的消息</p><pre class="ki kj kk kl fd nj nk nl nm aw nn bi"><span id="c36c" class="mt ku hi nk b fi no np l nq nr">gcloud pubsub topics create bq_events_trigger</span></pre><p id="e800" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您可以使用gcloud命令创建水槽。</p><pre class="ki kj kk kl fd nj nk nl nm aw nn bi"><span id="7102" class="mt ku hi nk b fi no np l nq nr">gcloud logging sinks create bq_to_pubsub_pipeline_trigger \<br/> pubsub.googleapis.com/projects/&lt;your-project-id&gt;/topics/bq_events_trigger \<br/> --log-filter=&lt;your-log-filter&gt;</span></pre><p id="373a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">定义正确的包含过滤器(<your-log-filter>)以便仅在记录了某个事件时触发重新训练流水线作业是非常重要的。</your-log-filter></p><p id="ae5d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下面是我实现的过滤器。</p><pre class="ki kj kk kl fd nj nk nl nm aw nn bi"><span id="11c8" class="mt ku hi nk b fi no np l nq nr">'resource.type="bigquery_dataset" AND protoPayload.@type="type.googleapis.com/google.cloud.audit.AuditLog" AND protoPayload.serviceName="bigquery.googleapis.com"'AND </span><span id="4f24" class="mt ku hi nk b fi ns np l nq nr">-protoPayload.authenticationInfo.principalEmail:"looker" AND <br/>-protoPayload.authenticationInfo.principalEmail:"composer" AND protoPayload.metadata.@type="type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata" AND</span><span id="7a54" class="mt ku hi nk b fi ns np l nq nr">protoPayload.methodName="google.cloud.bigquery.v2.JobService.InsertJob" AND protoPayload.resourceName:"projects/&lt;your-project-id&gt;/datasets/&lt;your-dataset&gt;/tables/orders_" AND protoPayload.metadata.tableDataChange.insertedRowsCount&gt;=0 AND -protoPayload.resourceName:"training" AND -protoPayload.resourceName:"arima" AND -protoPayload.resourceName:"evaluate"</span></pre><p id="3e11" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">换句话说，使用此过滤器，您将只路由以下事件</p><ol class=""><li id="0064" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">使用bigquery_dataset资源从BigQuery服务审计日志中收集</li><li id="2478" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">不是由Looker和Composer服务帐户生成</li><li id="387c" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">由InsertJob表示，它以具有特定命名的表为目标并记录新数据</li></ol><p id="0780" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在下面的控制台中有日志路由器接收器。</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nt"><img src="../Images/4ee20ed4c68f4aa62a1ea558c0f2f975.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ec8MurmvVNoWfPN5"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">图三。云日志接收器</figcaption></figure><h2 id="5b32" class="mt ku hi bd kv mu mv mw kz mx my mz ld jf na nb lh jj nc nd ll jn ne nf lp ng bi translated">步骤3:在云功能v2中创建和部署再训练触发器</h2><p id="a981" class="pw-post-body-paragraph iu iv hi iw b ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr hb bi translated">现在您已经有了云日志记录接收器和Pub/Sub来过滤和发送BigQuery中的数据事件，您可以创建一个云函数，当路由新的数据事件时，将触发该云函数来执行重新训练管道运行。下面你可以看到代码:</p><figure class="ki kj kk kl fd ij"><div class="bz dy l di"><div class="nh ni l"/></div></figure><p id="df8d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">其中<em class="mr"> trigger </em>函数使用<a class="ae kg" href="https://cloud.google.com/functions/docs/calling#2nd-gen-triggers" rel="noopener ugc nofollow" target="_blank"> Eventarc </a>从事件源读取Cloud PubSub消息，进行数据质量检查(在这种情况下，它只是验证传入数据的行数)，编译管道参数并最终触发管道作业。</p><p id="5f2a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">定义重新训练管道触发器后，可以使用gcloud cli部署它。</p><pre class="ki kj kk kl fd nj nk nl nm aw nn bi"><span id="9589" class="mt ku hi nk b fi no np l nq nr">gcloud functions deploy pipeline-trigger \<br/> --gen2 \<br/> --region=$REGION \<br/> --runtime=python38 \<br/> --source=$TRIGGER_PATH \<br/> --entry-point=trigger \<br/> --trigger-topic=$PUBSUB_TOPIC</span></pre><p id="9a36" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">请注意，您需要使用<em class="mr"> gen2 </em>标志从云函数v1切换到云函数v2。下面你在控制台里有云功能。</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nu"><img src="../Images/95b6526dff1ccfd69be397b0caec5dc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-TtBKxmRzIU-MbMYlgZYfQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">图4。控制台中的云功能v2</figcaption></figure><p id="ef1b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这时候，一切都烤好了。让我们看看持续培训系统的运行情况。</p><h1 id="b24c" class="kt ku hi bd kv kw lw ky kz la lx lc ld le ly lg lh li lz lk ll lm ma lo lp lq bi translated">持续培训系统正在运行！</h1><p id="7a82" class="pw-post-body-paragraph iu iv hi iw b ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr hb bi translated">发布/订阅收集从云日志路由的BigQuery事件。该事件触发构建运行时配置的云函数，从云桶读取管道模板并提交重新训练管道运行。</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nv"><img src="../Images/f0d929912a7fb58f76389dd9132e475e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*paCF6KibAmDr4jdbFvpvmw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">图五。重新训练触发事件日志</figcaption></figure><p id="2117" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下面是Vertex AI控制台中的重新训练管道执行流程。</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nv"><img src="../Images/80ee1ea0faf476891992bbfc44725a51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C_cU2CxWrTzib3I5k3XRPw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">图六。顶点AI UI中的流水线执行</figcaption></figure><p id="f2c8" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这是您将收到的管道通知电子邮件。</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div class="er es nw"><img src="../Images/68de2a55e33faeffd8074db0c1089d97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*oRg5-tD0TCIIhpdZKWllZw.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">图7。管道通知电子邮件</figcaption></figure><h1 id="b7c8" class="kt ku hi bd kv kw lw ky kz la lx lc ld le ly lg lh li lz lk ll lm ma lo lp lq bi translated">摘要</h1><p id="456e" class="pw-post-body-paragraph iu iv hi iw b ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr hb bi translated">在本文中，我展示了一个需求预测场景中可能的持续培训系统。</p><p id="c886" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">总结一下，你可以建立一个简单的再培训系统</p><ul class=""><li id="6445" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr mb jy jz ka bi translated">大查询数据事件记录在云日志中</li><li id="b4a5" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated">数据事件被过滤并路由到发布/订阅</li><li id="39b7" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated">发布/订阅消息触发运行顶点人工智能再训练流水线的云函数</li><li id="c155" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated">Vertex AI Pipeline使用实验性的Google Cloud<a class="ae kg" href="https://google-cloud-pipeline-components.readthedocs.io/en/google-cloud-pipeline-components-1.0.16/google_cloud_pipeline_components.experimental.vertex_notification_email.html?highlight=VertexNotificationEmailOp#google_cloud_pipeline_components.experimental.vertex_notification_email.VertexNotificationEmailOp" rel="noopener ugc nofollow" target="_blank">VertexNotificationEmailOp</a>组件发送通知。</li></ul><p id="d138" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">可以想象这只是一种可能的情况。</p><p id="e246" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在架构设计方面，您也可以使用<a class="ae kg" href="https://cloud.google.com/blog/topics/developers-practitioners/demystifying-event-filters-eventarc" rel="noopener ugc nofollow" target="_blank"> Eventarc </a>直接从BigQuery或云日志中读取事件，实现我提到的相同过滤逻辑，并将它们路由到云函数。就我个人而言，我更喜欢云日志和Pub Sub架构来分离关注点(因为我发现它更直观)。</p><p id="a8e4" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在现实世界中，持续培训系统会根据频率和要处理的数据量而变化。例如，当您拥有大量数据时，每小时训练一个预测模型似乎不现实。</p><p id="93a2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">此外，预测管道没有完整的事件驱动再培训系统。但是您可能会引入一个编排层，它将协调预测过程，并在触发培训之前执行一些数据验证步骤。</p><p id="8e35" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我让你以一种你可以处理它们的方式来考虑这些问题。</p><h1 id="fba3" class="kt ku hi bd kv kw lw ky kz la lx lc ld le ly lg lh li lz lk ll lm ma lo lp lq bi translated">下一步是什么</h1><p id="a825" class="pw-post-body-paragraph iu iv hi iw b ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr hb bi translated">在Vertex AI和BigQuery之间还有许多其他可能的集成<a class="ae kg" href="https://cloud.google.com/blog/products/ai-machine-learning/five-integrations-between-vertex-ai-and-bigquery" rel="noopener ugc nofollow" target="_blank">有待探索。下面你可以找到一些资源，用它们来弄脏你的手。</a></p><p id="db70" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> Colab </strong></p><ul class=""><li id="d0fd" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr mb jy jz ka bi translated"><a class="ae kg" href="https://cloud.google.com/vertex-ai/docs/tutorials/train-tensorflow-bigquery" rel="noopener ugc nofollow" target="_blank">在BigQuery数据| Vertex AI | Google Cloud上训练TensorFlow模型</a></li></ul><p id="972d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">文档</strong></p><ul class=""><li id="4805" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr mb jy jz ka bi translated"><a class="ae kg" href="https://cloud.google.com/vertex-ai/docs/model-registry/model-registry-bqml" rel="noopener ugc nofollow" target="_blank"> BigQuery ML和Vertex AI模型注册表|谷歌云</a></li></ul><p id="bd78" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">视频</strong></p><ul class=""><li id="e8a2" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr mb jy jz ka bi translated"><a class="ae kg" href="https://www.youtube.com/watch?v=0Ys52DsiNk8&amp;list=PLIivdWyY5sqLVnGp10d9tQacZsvVh2_zM&amp;index=2" rel="noopener ugc nofollow" target="_blank">将BigQuery数据引入Vertex AI Workbench </a></li><li id="ee1b" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated"><a class="ae kg" href="https://www.youtube.com/watch?v=AVwwkqLOito" rel="noopener ugc nofollow" target="_blank">如何用顶点AI和BigQuery ML简化AI模型</a></li></ul><p id="59dc" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> GitHub </strong></p><ul class=""><li id="96c9" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr mb jy jz ka bi translated"><a class="ae kg" href="https://github.com/GoogleCloudPlatform/vertex-ai-samples/tree/main/notebooks/official" rel="noopener ugc nofollow" target="_blank">示例笔记本</a></li></ul><p id="27d8" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">培训</strong></p><ul class=""><li id="2108" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr mb jy jz ka bi translated"><a class="ae kg" href="https://www.qwiklabs.com/focuses/18940?locale=id&amp;parent=catalog" rel="noopener ugc nofollow" target="_blank">顶点AI: Qwik开始</a></li></ul><p id="1c8c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">一如既往，如果有问题和反馈，请随时联系我。</p><p id="bd69" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，感谢你阅读这篇文章。我希望你喜欢它，直到下一个帖子…</p><p id="171f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="mr">感谢Polong Lin、Tuba Islam、Steve Walker、Skander Hannachi和Valentino Miazzo的反馈和建议</em></p><h1 id="a0f0" class="kt ku hi bd kv kw lw ky kz la lx lc ld le ly lg lh li lz lk ll lm ma lo lp lq bi translated">参考</h1><ul class=""><li id="f824" class="js jt hi iw b ix lr jb ls jf nx jj ny jn nz jr mb jy jz ka bi translated"><a class="ae kg" href="https://cloud.google.com/resources/mlops-whitepaper" rel="noopener ugc nofollow" target="_blank">MLOps | Google Cloud的实践者指南</a></li><li id="a296" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated"><a class="ae kg" href="https://towardsdatascience.com/3-facts-about-time-series-forecasting-that-surprise-experienced-machine-learning-practitioners-69c18ee89387" rel="noopener" target="_blank">关于时间序列预测的3个事实让有经验的机器学习从业者大吃一惊。</a></li><li id="cba1" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated"><a class="ae kg" href="https://cloud.google.com/logging/docs" rel="noopener ugc nofollow" target="_blank">云日志文档</a></li><li id="7bc3" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated"><a class="ae kg" href="https://cloud.google.com/pubsub/docs" rel="noopener ugc nofollow" target="_blank">云发布/订阅文档</a></li><li id="36a8" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated"><a class="ae kg" href="https://cloud.google.com/functions/docs" rel="noopener ugc nofollow" target="_blank">云函数文档</a></li><li id="2260" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated"><a class="ae kg" href="https://cloud.google.com/blog/topics/developers-practitioners/how-trigger-cloud-run-actions-bigquery-events" rel="noopener ugc nofollow" target="_blank">如何在BigQuery事件上触发云运行操作|谷歌云博客</a></li><li id="e294" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated"><a class="ae kg" href="https://cloud.google.com/blog/topics/developers-practitioners/demystifying-event-filters-eventarc" rel="noopener ugc nofollow" target="_blank">揭开Eventarc | Google Cloud博客中事件过滤器的神秘面纱</a></li><li id="eb82" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated"><a class="ae kg" href="https://cloud.google.com/vertex-ai/docs/pipelines" rel="noopener ugc nofollow" target="_blank">顶点人工智能管道|谷歌云</a></li><li id="bade" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mb jy jz ka bi translated"><a class="ae kg" href="https://cloud.google.com/bigquery-ml/docs" rel="noopener ugc nofollow" target="_blank"> BigQuery ML文档|谷歌云</a></li></ul></div></div>    
</body>
</html>