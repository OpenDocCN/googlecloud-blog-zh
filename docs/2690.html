<html>
<head>
<title>Stream data from Pub/Sub to Bigtable using Dataproc Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dataproc无服务器将数据从发布/订阅流式传输到大表</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/stream-data-from-pub-sub-to-bigtable-using-dataproc-serverless-3142c1bcc22a?source=collection_archive---------8-----------------------#2022-12-27">https://medium.com/google-cloud/stream-data-from-pub-sub-to-bigtable-using-dataproc-serverless-3142c1bcc22a?source=collection_archive---------8-----------------------#2022-12-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="215d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Google Cloud Pub/Sub用于流分析和数据集成管道，以接收和分发实时/流数据。事件驱动的使用案例数不胜数，需要将数据从发布/订阅传输到Bigtable等存储设备，以实现低延迟读取。</p><p id="2ae5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在无服务器处理时代，在专用集群上运行Spark作业会增加更多的处理开销，并占用开发人员宝贵的开发时间。将完全托管的随需应变服务器与Spark jobs结合使用，有助于开发人员专注于核心应用程序逻辑，而在框架上花费很少或没有时间。Google的Dataproc Serverless就是Google云平台提供的一个这样的产品，使客户能够运行Spark工作负载，而不必创建或维护集群。一旦Spark工作负载参数被指定并且任务被提交给服务，Dataproc Serverless将在后台处理所有必要的基础设施。</p><p id="3ae5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无需从头开始创建它们，我们可以使用Java和Python在Dataproc无服务器上运行典型用例——这要感谢D <strong class="ih hj"> ataproc模板</strong>。借助这些模板，我们可以轻松定制和运行常见的Spark工作负载。在这篇文章中，我们将探索如何使用Dataproc无服务器将来自发布/订阅主题的<strong class="ih hj"> <em class="jd">数据流传输到BigTable </em> </strong></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/5213f2f0aba02c391a541cbc7f47dc78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/1*WqNLKIhaBA0A2leA6XxW7g.png"/></div><figcaption class="jm jn et er es jo jp bd b be z dx translated">发布/订阅到Bigtable</figcaption></figure><p id="ae80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">主要优势</strong></p><ul class=""><li id="6cbf" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc jv jw jx jy bi translated"><a class="ae jz" href="https://github.com/GoogleCloudPlatform/dataproc-templates/tree/GCS_to_bigtablejava/java/src/main/java/com/google/cloud/dataproc/templates/pubsub" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">publisubtobigtable</strong></a>模板在<strong class="ih hj"> Spark-Java </strong>中是开源的，完全可定制，可以随时用于简单的工作。</li><li id="e863" class="jq jr hi ih b ii ka im kb iq kc iu kd iy ke jc jv jw jx jy bi translated">您可以将数据以<strong class="ih hj"> JSON </strong>格式从Pub/Sub传输到BigTable。</li><li id="6cb8" class="jq jr hi ih b ii ka im kb iq kc iu kd iy ke jc jv jw jx jy bi translated">通过简单地改变连接参数，这些模板可以相对快速地用于具有相同需求的用例。</li></ul><p id="1db5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">基本用法</strong></p><p id="f580" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1) <a class="ae jz" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank"> Google Cloud SDK </a>安装并认证。你可以在谷歌云控制台中使用云外壳，通过这个<a class="ae jz" href="https://console.cloud.google.com/cloudshell/editor" rel="noopener ugc nofollow" target="_blank">链接</a>获得一个已经配置好的环境。</p><p id="21a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2)如果您要使用由GCP生成的“默认”VPC网络，请确保您已经启用了带有专用Google访问的子网。您仍然需要启用如下的私人访问。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es kf"><img src="../Images/f8da266a3240098d367f1ae1ac501548.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/0*ikwIn6JeicqWmxkW.png"/></div></figure><pre class="jf jg jh ji fd kg kh ki bn kj kk bi"><span id="790c" class="kl km hi kh b be kn ko l kp kq">gcloud compute networks subnets update default - region=us-central1 - enable-private-ip-google-access</span></pre><p id="5895" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3)在预装<a class="ae jz" href="https://cloud.google.com/shell/docs/how-cloud-shell-works" rel="noopener ugc nofollow" target="_blank">各种工具</a>的云壳中克隆git repo。或者，你可以使用任何预装了JDK 8+，Maven和Git的机器。</p><pre class="jf jg jh ji fd kg kh ki bn kj kk bi"><span id="89c8" class="kl km hi kh b be kn ko l kp kq">git clone https://github.com/GoogleCloudPlatform/dataproc-templates.git <br/>cd dataproc-templates/java</span></pre><p id="b10e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4)创建GCS存储桶和暂存文件夹。这个存储桶将用于存储运行无服务器集群所需的依赖项/ Jar文件</p><p id="2950" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5)创建一个发布/订阅主题。还要为此发布/订阅主题创建订阅。</p><pre class="jf jg jh ji fd kg kh ki bn kj kk bi"><span id="18e2" class="kl km hi kh b be kn ko l kp kq">gcloud pubsub topics create your-test-topic<br/>gcloud pubsub subscriptions create --topic your-test-topic your-test-topic-sub</span></pre><p id="b5d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6)在集群的实例中创建一个具有所需列族的BigTable表。(如果实例不存在，则创建实例)</p><p id="524b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7)获取认证凭证(提交Dataproc作业)。</p><pre class="jf jg jh ji fd kg kh ki bn kj kk bi"><span id="9e0b" class="kl km hi kh b be kn ko l kp kq">gcloud auth application-default login</span></pre><p id="1e6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">8)配置Dataproc无服务器作业:</p><p id="ac04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要执行dataproc作业，需要设置以下配置。</p><ul class=""><li id="21c5" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc jv jw jx jy bi translated"><code class="du kr ks kt kh b">GCP_PROJECT</code>:无服务器运行Dataproc的GCP项目。</li><li id="8a40" class="jq jr hi ih b ii ka im kb iq kc iu kd iy ke jc jv jw jx jy bi translated"><code class="du kr ks kt kh b">REGION</code>:运行Dataproc无服务器的区域。</li><li id="f8fb" class="jq jr hi ih b ii ka im kb iq kc iu kd iy ke jc jv jw jx jy bi translated"><code class="du kr ks kt kh b">GCS_STAGING_LOCATION</code>:一个GCS位置，Dataproc将在此存储登台资产。应该在之前创建的存储桶内。</li></ul><pre class="jf jg jh ji fd kg kh ki bn kj kk bi"><span id="6e54" class="kl km hi kh b be kn ko l kp kq">export GCP_PROJECT=&lt;project_id&gt;<br/>export REGION=&lt;region&gt;<br/>export GCS_STAGING_LOCATION=&lt;gcs-staging-bucket-folder&gt;</span></pre><p id="d00f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">9)对BigTable模板执行Pub/Sub，为执行指定模板和以下参数值</p><ul class=""><li id="c1a1" class="jq jr hi ih b ii ij im in iq js iu jt iy ju jc jv jw jx jy bi translated"><code class="du kr ks kt kh b">pubsub.input.project.id</code>:发布/订阅的项目id</li><li id="2c2b" class="jq jr hi ih b ii ka im kb iq kc iu kd iy ke jc jv jw jx jy bi translated"><code class="du kr ks kt kh b">pubsub.input.subscription</code>:发布/订阅订阅名称</li><li id="c222" class="jq jr hi ih b ii ka im kb iq kc iu kd iy ke jc jv jw jx jy bi translated"><code class="du kr ks kt kh b">pubsub.bigtable.output.instance.id</code>:Bigtable的实例Id</li><li id="5f90" class="jq jr hi ih b ii ka im kb iq kc iu kd iy ke jc jv jw jx jy bi translated"><code class="du kr ks kt kh b">pubsub.bigtable.output.project.id</code>:Bigtable的项目Id</li><li id="acf3" class="jq jr hi ih b ii ka im kb iq kc iu kd iy ke jc jv jw jx jy bi translated"><code class="du kr ks kt kh b">pubsub.bigtable.output.table</code> : Bigtable表名</li></ul><pre class="jf jg jh ji fd kg kh ki bn kj kk bi"><span id="dd06" class="kl km hi kh b be kn ko l kp kq">bin/start.sh \<br/>-- --template PUBSUBTOBIGTABLE \<br/>--templateProperty pubsub.input.project.id=&lt;pubsub project id&gt; \<br/>--templateProperty pubsub.input.subscription=&lt;pubsub subscription&gt; \<br/>--templateProperty pubsub.bigtable.output.instance.id=&lt;bigtable instance id&gt; \<br/>--templateProperty pubsub.bigtable.output.project.id=&lt;bigtable output project id&gt; \<br/>--templateProperty pubsub.bigtable.output.table=&lt;bigtable output table&gt;<br/><br/><br/>Here is an example submission:<br/>export GCP_PROJECT=your-project-id<br/>export REGION=your-region <br/>export GCS_STAGING_LOCATION=gs://your-bucket/temp <br/><br/>bin/start.sh -- --template PUBSUBTOBIGTABLE --templateProperty pubsub.input.project.id=your-project-id --templateProperty pubsub.input.subscription=your-test-topic-sub --templateProperty pubsub.bigtable.output.project.id=your-project-id --templateProperty pubsub.bigtable.output.instance.id=your-bt-instance --templateProperty pubsub.bigtable.output.table=your-bt-table</span></pre><p id="12a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>:如果尚未启用，它会要求您启用Dataproc Api。</p><p id="f53f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">可配置参数</strong></p><p id="e544" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是命令行或<a class="ae jz" href="https://github.com/GoogleCloudPlatform/dataproc-templates/blob/GCS_to_bigtablejava/java/src/main/resources/template.properties" rel="noopener ugc nofollow" target="_blank"> template.properties </a>文件中的一些可选可配置属性</p><pre class="jf jg jh ji fd kg kh ki bn kj kk bi"><span id="b160" class="kl km hi kh b be kn ko l kp kq">## Project that contains the input Pub/Sub subscription to be read<br/>pubsub.input.project.id=&lt;pubsub project id&gt;<br/>## PubSub subscription name<br/>pubsub.input.subscription=&lt;pubsub subscription&gt;<br/>## Stream timeout, for how long the subscription will be read<br/>pubsub.timeout.ms=60000<br/>## Streaming duration, how often wil writes to BQ be triggered<br/>pubsub.streaming.duration.seconds=15<br/>## Number of streams that will read from Pub/Sub subscription in parallel<br/>pubsub.total.receivers=5<br/>## Project that contains the output table<br/>pubsub.bigtable.output.project.id=&lt;bigtable output project id&gt;<br/>## BigTable Instance Id<br/>pubsub.bigtable.output.instance.id=&lt;bigtable instance id&gt;<br/>## BigTable output table<br/>pubsub.bigtable.output.table=&lt;bigtable output table&gt;</span></pre><p id="f862" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是发布/订阅中的输入消息和BigTable中的输出行的示例</p><pre class="jf jg jh ji fd kg kh ki bn kj kk bi"><span id="36b4" class="kl km hi kh b be kn ko l kp kq">Sample Message in Pub/sub:<br/><br/>{<br/>  "rowkey": "rk6",<br/>  "columns": [<br/>    {<br/>      "columnfamily": "cf",<br/>      "columnname": "field1",<br/>      "columnvalue": "value1"<br/>    },<br/>    {<br/>      "columnfamily": "cf",<br/>      "columnname": "field2",<br/>      "columnvalue": "value5"<br/>    },<br/>    {<br/>      "columnfamily": "cf",<br/>      "columnname": "field3",<br/>      "columnvalue": "value3"<br/>    }<br/>  ]<br/>}<br/><br/>Sample Row in BigTable:<br/><br/>rk6<br/>  cf:field1                                @ 2022/12/20-06:17:01.318000<br/>    "value1"<br/>  cf:field2                                @ 2022/12/20-06:17:01.318000<br/>    "value5"<br/>  cf:field3                                @ 2022/12/20-06:17:01.318000<br/>    "value3"<br/><br/>The below command can be used as an example to populate the message in topic T1:<br/>gcloud pubsub topics publish T1 --message='{"rowkey":"rk6","columns":[{"columnfamily":"cf","columnname":"field1","columnvalue":"value1"},{"columnfamily":"cf","columnname":"field2","columnvalue":"value5"},{"columnfamily":"cf","columnname":"field3","columnvalue":"value3"}]}'<br/><br/>Instead if messages are published in other modes like a publisher, here is the example string to use:<br/>"{ \"rowkey\":\"rk6\",\"columns\": [{\"columnfamily\":\"cf\",\"columnname\":\"field1\",\"columnvalue\":\"value1\"},{\"columnfamily\":\"cf\",\"columnname\":\"field2\",\"columnvalue\":\"value5\"},{\"columnfamily\":\"cf\",\"columnname\":\"field3\",\"columnvalue\":\"value3\"}] }"</span></pre><p id="7182" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保Pub/Sub中必须有消息，以便读取和写入BigTable，否则不会向Bigtable中写入任何内容。</p><p id="f452" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">10)监视火花批量作业</p><p id="087e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提交作业后，我们将能够在<a class="ae jz" href="https://console.cloud.google.com/dataproc/batches" rel="noopener ugc nofollow" target="_blank"> Dataproc批处理UI </a>中看到。从那里，我们可以查看作业的指标和日志。</p><p id="ec83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">参考文献</strong><br/><a class="ae jz" href="https://cloud.google.com/bigtable/docs/overview" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/bigtable/docs/overview</a><br/><a class="ae jz" href="https://cloud.google.com/pubsub/docs/overview" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/pubsub/docs/overview</a><br/><a class="ae jz" href="https://github.com/GoogleCloudPlatform/dataproc-templates" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/dataproc-templates</a></p><p id="041c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如有任何疑问/建议，请联系:<strong class="ih hj">data proc-templates-support-external</strong>@ Google groups . com</p></div></div>    
</body>
</html>