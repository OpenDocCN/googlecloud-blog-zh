<html>
<head>
<title>Respawn VMs like an RPG with Autohealing and Autoupdates</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">像具有自动修复和自动更新功能的RPG一样重生虚拟机</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/give-your-vms-a-steady-pulse-with-autohealing-and-autoupdates-ae2c0828ecc9?source=collection_archive---------1-----------------------#2020-08-26">https://medium.com/google-cloud/give-your-vms-a-steady-pulse-with-autohealing-and-autoupdates-ae2c0828ecc9?source=collection_archive---------1-----------------------#2020-08-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="bdda" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">规模季节</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/6246bd259a72726a60dd6e1064911099.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*uwuy_aAKkCoeR-tyCTIRqw.gif"/></div></div></figure><h1 id="cbd2" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">规模季节</h1><p id="bccd" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">“规模季节”是一个博客和视频系列，旨在帮助企业和开发人员在设计模式中构建规模和弹性。在这一系列文章中，我们计划向您介绍一些创建具有弹性和可伸缩性的应用程序的模式和实践，这是许多现代架构实践的两个基本目标。</p><p id="1673" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">在第1季中，我们将介绍基础架构自动化和高可用性:</p><ol class=""><li id="4c52" class="lc ld hi kd b ke kx kh ky kk le ko lf ks lg kw lh li lj lk bi translated"><a class="ae ll" rel="noopener" href="/google-cloud/scale-and-resilience-arent-just-buzzwords-ce748360e80">可扩展和弹性应用的模式</a></li><li id="b4a2" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw lh li lj lk bi translated"><a class="ae ll" rel="noopener" href="/google-cloud/why-should-you-treat-infrastructure-like-software-3865ed0e4b03">基础设施为代码</a></li><li id="f7ed" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw lh li lj lk bi translated"><a class="ae ll" rel="noopener" href="/google-cloud/sometimes-change-is-bad-immutable-infrastructure-624a8e3482d6">不变的基础设施</a></li><li id="fbe3" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw lh li lj lk bi translated"><a class="ae ll" rel="noopener" href="/@swongful/where-to-scale-your-workloads-6420150bf825">在哪里扩展您的工作负载</a></li><li id="5ff4" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw lh li lj lk bi translated"><a class="ae ll" rel="noopener" href="/google-cloud/globally-autoscaling-web-services-4b650cc6fc49">全球自动扩展web服务</a></li><li id="94d1" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw lh li lj lk bi translated"><a class="ae ll" rel="noopener" href="/@swongful/give-your-vms-a-steady-pulse-with-autohealing-and-autoupdates-ae2c0828ecc9">高可用性(自动修复&amp;自动更新)</a>(本文)</li></ol><p id="a524" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">在本文中，我将带您了解如何使用自动修复和自动更新来为GCP计算引擎实例创建健康检查和维护HA。</p><h1 id="2d19" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">看看这个视频</h1><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lr ls l"/></div></figure><h1 id="bd39" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">回顾</h1><p id="d7d3" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">到目前为止，我们已经了解了Critter Junction如何在Compute Engine上推出游戏应用并在全球推广。随着他们的日活跃用户不断增加，我们帮助他们设置了自动扩展和全局负载平衡，以处理全球分布和不断增长的流量。今天，让我们了解他们如何通过优雅地替换失败的实例来使这个社交动物应用程序更具可扩展性。</p><h2 id="8fc3" class="lt jk hi bd jl lu lv lw jp lx ly lz jt kk ma mb jv ko mc md jx ks me mf jz mg bi translated">游戏噩梦</h2><p id="2d8b" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">为了让他们的用户免于冒着日常游戏的风险，Critter Junction需要确保他们的应用程序始终可用，没有中断。</p><p id="1a68" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">一种方法是在堆栈的所有层设置高可用性或HA。虽然这可能意味着分布式数据库、网络和应用服务器，但我们关注的是运行在计算引擎上的游戏服务器。</p><p id="0d25" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我们知道托管实例组提供了诸如<a class="ae ll" href="https://cloud.google.com/compute/docs/load-balancing-and-autoscaling#:~:text=Compute%20Engine%20offers%20autoscaling%20to,need%20for%20resources%20is%20lower." rel="noopener ugc nofollow" target="_blank">自动扩展</a>、区域性(多区域)部署、自动修复和自动更新等功能。可以添加到计算引擎配置中的两个功能是自动修复和自动更新。</p><blockquote class="mh"><p id="e3ac" class="mi mj hi bd mk ml mm mn mo mp mq kw dx translated">自动修复有助于主动识别不健康的实例(没有响应)并用健康的实例替换它们。</p><p id="b0e6" class="mi mj hi bd mk ml mm mn mo mp mq kw dx translated">自动更新有助于在不中断服务的情况下更新实例</p></blockquote><figure class="ms mt mu mv mw jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mr"><img src="../Images/268123167015a40311e233180d200d51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kkQt-q12FRiFoigSBK95Fg.png"/></div></div></figure><h1 id="a5b3" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">自动愈合</h1><p id="5f4d" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">让我们稍微关注一下自动修复。</p><p id="c605" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">第一步是创建一个健康检查，它不仅检测机器是否正在运行，还检测特定于应用程序的问题，如冻结、崩溃或过载。如果某个实例被认为不正常，则托管实例组会创建新的实例。</p><p id="5dfc" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我们正在构建在<a class="ae ll" rel="noopener" href="/google-cloud/globally-autoscaling-web-services-4b650cc6fc49">上一篇文章</a>中创建的实例配置。</p><ol class=""><li id="f9e8" class="lc ld hi kd b ke kx kh ky kk le ko lf ks lg kw lh li lj lk bi translated">首先，在计算引擎中创建一个健康检查，并为其命名。</li><li id="9771" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw lh li lj lk bi translated">将协议设置为<strong class="kd hj"> HTTP </strong>。</li><li id="1c69" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw lh li lj lk bi translated">您可以在任何路径上设置健康检查，但是假设路径是/health。</li></ol><p id="e42b" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">在我们的演示应用程序中，我们添加了代码来确保/health在正常运行时返回200 OK响应，在不正常运行时返回HTTP 500内部服务器错误。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mx"><img src="../Images/9415de3a328811915d337ef12029bf39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mw9tkFYn0chnhKjjy4teMw.png"/></div></div></figure><h2 id="d712" class="lt jk hi bd jl lu lv lw jp lx ly lz jt kk ma mb jv ko mc md jx ks me mf jz mg bi translated">建立健康标准</h2><ol class=""><li id="c462" class="lc ld hi kd b ke kf kh ki kk my ko mz ks na kw lh li lj lk bi translated">将检查间隔设置为<strong class="kd hj"> 10 </strong>，这意味着每隔10秒将探测服务的健康状况。</li><li id="8df8" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw lh li lj lk bi translated">将超时设置为<strong class="kd hj"> 5 </strong>。也就是说，我们最多等待5秒钟来响应探测。</li><li id="bdec" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw lh li lj lk bi translated">将健康阈值设置为<strong class="kd hj"> 2 </strong>，它定义了连续探测的数量，该数量必须成功，实例才能被视为健康。</li><li id="959e" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw lh li lj lk bi translated">最后，将不健康阈值设置为<strong class="kd hj"> 3 </strong>，它定义了实例被认为不健康时必须失败的顺序探测的数量。</li><li id="e45f" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw lh li lj lk bi translated">然后创造。</li></ol><blockquote class="nb nc nd"><p id="c757" class="kb kc ne kd b ke kx ij kg kh ky im kj nf kz km kn ng la kq kr nh lb ku kv kw hb bi translated">作为最佳实践，您希望运行状况检查是保守的，这样您就不会先发制人地删除和重新创建实例。</p></blockquote><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ni"><img src="../Images/d36a9410cbfea4ebadc79fa6b1dfc746.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Su5vn2D5NVfC15a_JGxuVQ.png"/></div></div></figure><h2 id="107c" class="lt jk hi bd jl lu lv lw jp lx ly lz jt kk ma mb jv ko mc md jx ks me mf jz mg bi translated">向现有实例添加运行状况检查</h2><p id="619c" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">现在，让我们转到上一集创建的实例组，并向它添加一个健康检查。</p><ol class=""><li id="16a7" class="lc ld hi kd b ke kx kh ky kk le ko lf ks lg kw lh li lj lk bi translated">选择初始延迟为90秒的健康检查。</li></ol><blockquote class="nb nc nd"><p id="e5fb" class="kb kc ne kd b ke kx ij kg kh ky im kj nf kz km kn ng la kq kr nh lb ku kv kw hb bi translated">理想情况下，这个初始延迟应该足够长，以便实例完全运行并准备好健康地响应。</p></blockquote><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nj"><img src="../Images/340ed5a8db80fc6be988af6fc2591d6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*0wFtamaU1Fk2U1i58Wjn-Q.png"/></div></div></figure><h2 id="2f0f" class="lt jk hi bd jl lu lv lw jp lx ly lz jt kk ma mb jv ko mc md jx ks me mf jz mg bi translated">模拟故障</h2><p id="8054" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">现在让我们玩玩这个，模拟失败。</p><ol class=""><li id="96ca" class="lc ld hi kd b ke kx kh ky kk le ko lf ks lg kw lh li lj lk bi translated">为此，我们转到虚拟机实例，单击外部IP并使其不健康。</li><li id="04eb" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw lh li lj lk bi translated">等待自动修复程序采取行动，您将看到实例旁边的绿色复选标记变成一个微调器，表明自动修复程序已经开始重新启动该实例。</li></ol><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nk"><img src="../Images/54f8ebd6c47f1fe032497392bad1035e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tQBJ0pejiTZkfe6hEoBtBg.png"/></div></div></figure><h1 id="edcb" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">当你更新一个实例的时候呢？</h1><p id="f8ba" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">HA的另一个关注点是在不影响服务的情况下对实例应用更新。托管实例组允许您控制更新部署的速度和范围，以最大限度地减少对应用程序的中断。您还可以执行部分部署，这允许金丝雀测试。</p><p id="dfa4" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">现在让我们来看看实际情况吧！</p><ol class=""><li id="f07c" class="lc ld hi kd b ke kx kh ky kk le ko lf ks lg kw lh li lj lk bi translated">在我们的实例组中，单击滚动更新按钮。滚动意味着它用于逐步更新。</li><li id="d6be" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw lh li lj lk bi translated">为canary测试添加第二个模板，并选择目标大小为20%。</li></ol><blockquote class="nb nc nd"><p id="967d" class="kb kc ne kd b ke kx ij kg kh ky im kj nf kz km kn ng la kq kr nh lb ku kv kw hb bi translated">这意味着我们希望将20%的流量发送到新实例进行金丝雀测试</p></blockquote><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nl"><img src="../Images/7fd2595d4bcfbd49fb2ec6206f21be30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*bgQNA1Ky85wafuScdhulLQ.png"/></div></figure><p id="7d22" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">3.现在，默认情况下，更新模式是主动的，这意味着计算引擎会主动计划操作，以便在必要时将请求的更新应用到实例。在许多情况下，这通常意味着主动删除和重新创建实例。</p><ul class=""><li id="cb47" class="lc ld hi kd b ke kx kh ky kk le ko lf ks lg kw nm li lj lk bi translated">如果主动更新可能太具破坏性，您可以选择执行<strong class="kd hj">机会性</strong>更新。只有当您在选定实例上手动启动更新时，或者当托管实例组创建新实例时，才会应用机会更新。</li><li id="2172" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw nm li lj lk bi translated"><strong class="kd hj"> Max surge </strong>表示作为此次更新的一部分，你愿意增加多少实例。此处的值越高，更新速度越快，但新实例的成本也越高。所以你面临着成本和速度的权衡。</li><li id="7262" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw nm li lj lk bi translated"><strong class="kd hj">最大不可用时间和最小等待时间</strong>:将它们保持为零，但这些参数用于控制更新对您的服务的破坏程度，并控制更新部署的速度。</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nn"><img src="../Images/eb57b6f78a5e0860dfd0cd5aa89e3b18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*2-rmIqdZ37EgdVn8UN0SFA.png"/></div></figure><h1 id="614e" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">就是这样！</h1><p id="287f" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">通过我们帮助在托管实例组中设置两个高可用性特性，Critter Junction拥有了一个更具弹性的架构。自动修复主动识别不健康的实例并修复它们，而自动更新在不中断服务的情况下更新实例。请继续关注，以了解更多的生物连接商店。</p><p id="e3a8" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">记住，永远要做架构设计。</p><h1 id="4804" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">后续步骤和参考:</h1><ul class=""><li id="4e0d" class="lc ld hi kd b ke kf kh ki kk my ko mz ks na kw nm li lj lk bi translated">在<a class="ae ll" href="https://medium.com/google-cloud" rel="noopener">谷歌云平台媒体</a>上关注这个博客系列。</li><li id="f0da" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw nm li lj lk bi translated">参考:<a class="ae ll" href="https://goo.gle/3amFGm4" rel="noopener ugc nofollow" target="_blank">设置健康检查和自动修复</a>。</li><li id="5ab0" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw nm li lj lk bi translated">关注<a class="ae ll" href="http://bit.ly/seasonofscale" rel="noopener ugc nofollow" target="_blank">季Scale视频系列</a>，订阅谷歌云平台YouTube频道。</li><li id="b087" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw nm li lj lk bi translated">想要更多的故事？在<a class="ae ll" rel="noopener" href="/@swongful">媒体</a>和<a class="ae ll" href="http://twitter.com/swongful" rel="noopener ugc nofollow" target="_blank">推特</a>上给我喊话。</li><li id="8153" class="lc ld hi kd b ke lm kh ln kk lo ko lp ks lq kw nm li lj lk bi translated">与我们一起享受这个迷你系列的旅程，并了解更多关于谷歌云解决方案的信息！</li></ul></div></div>    
</body>
</html>