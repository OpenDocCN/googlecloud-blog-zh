<html>
<head>
<title>Reach Oracle DB in serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在无服务器中访问Oracle数据库</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/reach-oracle-db-in-serverless-271293f79861?source=collection_archive---------1-----------------------#2019-11-07">https://medium.com/google-cloud/reach-oracle-db-in-serverless-271293f79861?source=collection_archive---------1-----------------------#2019-11-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c6304161326296eb83532378b05666ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5r5h2fQ-kQsJykF174O0Jg.png"/></div></div></figure><p id="4098" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我之前的<a class="ae jo" rel="noopener" href="/google-cloud/how-to-reach-on-premise-resources-with-serverless-products-747ebd37dc8e">故事</a>中，我详细介绍了如何通过执行简单的ping来使用无服务器产品访问内部资源。现在，<strong class="is hj">想把这些资源用在真实的工作量上。其中一个是Oracle数据库</strong>，我想连接并查询它。</p><blockquote class="jp"><p id="6706" class="jq jr hi bd js jt ju jv jw jx jy jn dx translated">但是，使用哪种无服务器产品来访问Oracle数据库呢？云功能？云跑？App引擎？</p></blockquote></div><div class="ab cl jz ka gp kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hb hc hd he hf"><p id="cb34" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kg">为了在云中执行测试，您可以在具有公共IP的n1-standard-1虚拟机上设置一个Oracle XE数据库。别忘了打开防火墙规则！</em></p><h1 id="e1b8" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">云函数</h1><p id="a122" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">云功能是一种流行的无服务器产品。<strong class="is hj">你带来你的代码，一个函数，你运行一个</strong> <code class="du lk ll lm ln b"><strong class="is hj">gcloud</strong></code> <strong class="is hj">命令来部署它</strong>。编译、部署、向上和向下扩展(最大为0)由平台管理。</p><p id="24db" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，主要的代价是支持的<strong class="is hj">语言数量有限:Python、Go和NodeJS </strong>。反正没问题，语言不重要，我们试试用带云功能的Oracle DB。</p><h2 id="5748" class="lo ki hi bd kj lp lq lr kn ls lt lu kr jb lv lw kv jf lx ly kz jj lz ma ld mb bi translated">Oracle约束</h2><p id="78a6" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated"><strong class="is hj"> Oracle产品、工具和驱动程序不是开源的，如果没有连接到Oracle门户网站、通过身份验证并接受许可，您就无法下载它们</strong>。</p><p id="22fb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">顺便说一下，您不能轻松地自动化构建，并且Python、NodeJS或Go中没有本机库来将您的代码直接连接到Oracle数据库。您必须在您的环境中安装一个名为“即时客户端”的Oracle中间软件，以便与数据库进行通信。然后，你可以使用开源库，在你的代码和“即时客户端”软件之间建立链接。从而到达数据库</p></div><div class="ab cl jz ka gp kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hb hc hd he hf"><p id="4d89" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">总之，你必须<strong class="is hj">在云功能上部署你的代码和一个Oracle二进制文件</strong>。这是不可能的。有了云功能，你只需要<strong class="is hj">带来你的代码</strong>，而不是第三方的二进制代码。<strong class="is hj">Python、NodeJS或Go的云函数不是在无服务器</strong>中使用Oracle DB的好产品。</p><p id="f211" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kg">如果你想自己尝试部署</em>，你可以在<a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle" rel="noopener ugc nofollow" target="_blank"><em class="kg">GitHub</em></a><em class="kg">上找到代码示例</em></p><h1 id="94f3" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">云运行替代方案</h1><p id="5db6" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">2019年初宣布，<a class="ae jo" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank"> Cloud Run </a>是Google Cloud全新的无服务器产品。<strong class="is hj">云运行为容器</strong>带来无服务器能力。开发人员必须遵守两个契约:HTTP容器(托管web服务器)和无状态(没有卷/磁盘挂载)。仅此而已！</p><p id="8758" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">容器有能力打破云函数的现有限制</strong>:你可以<strong class="is hj">使用任何语言，你可以添加任何库、依赖和二进制</strong>(这里<a class="ae jo" rel="noopener" href="/google-cloud/portable-prediction-with-tensorflow-and-cloud-run-669c1c73ebd1">是一个例子</a>)。</p><p id="dad0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云运行和云功能在它们的无服务器方法上非常接近；云运行在可移植性方面更好<a class="ae jo" rel="noopener" href="/google-cloud/cloud-run-and-cloud-function-what-i-use-and-why-12bb5d3798e1">，在测试方面更好</a>，在降低成本方面更好<a class="ae jo" rel="noopener" href="/google-cloud/cloud-run-vs-cloud-functions-whats-the-lowest-cost-728d59345a2e">。</a></p><h2 id="8e9e" class="lo ki hi bd kj lp lq lr kn ls lt lu kr jb lv lw kv jf lx ly kz jj lz ma ld mb bi translated">消除云功能限制</h2><p id="f78f" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">由于容器的功能，目标很简单:<strong class="is hj">用即时客户端创建一个容器，并在其中运行代码。</strong></p><p id="37d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先编写<a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/edit/master/go/function/function.go" rel="noopener ugc nofollow" target="_blank"> Go代码</a>来测试连接。(<a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/python/function/main.py" rel="noopener ugc nofollow" target="_blank"> Python版本</a>，<a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/nodejs/function/index.js" rel="noopener ugc nofollow" target="_blank"> NodeJS版本</a>也有)</p><p id="f221" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kg">GitHub中提供了</em> <a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/go/Server.go" rel="noopener ugc nofollow" target="_blank"> <em class="kg"> webserver代码</em> </a> <em class="kg">但这里没有介绍，对这个主题没有价值。</em></p><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="35e1" class="lo ki hi ln b fi mk ml l mm mn">package function</span><span id="0b64" class="lo ki hi ln b fi mo ml l mm mn">import (<br/>	"database/sql"<br/>	"fmt"<br/>	_ "gopkg.in/goracle.v2"<br/>	"net/http"<br/>)</span><span id="638b" class="lo ki hi ln b fi mo ml l mm mn">func OracleConnection(w http.ResponseWriter, r *http.Request) {</span><span id="08c3" class="lo ki hi ln b fi mo ml l mm mn">	dbIp := os.Getenv("ORACLE_IP")<br/>	dbSchema := os.Getenv("ORACLE_SCHEMA")<br/>	dbUser := os.Getenv("ORACLE_USER")<br/>	dbPassword := os.Getenv("ORACLE_PASSWORD")</span><span id="0817" class="lo ki hi ln b fi mo ml l mm mn">	db, err := sql.Open("goracle", dbUser + "/" + dbPassword + "@" + dbIp + ":1521/" + dbSchema)<br/>	<br/>        if err != nil {<br/>		fmt.Println(err)<br/>		w.WriteHeader(http.StatusInternalServerError)<br/>		fmt.Fprintln(w, err)<br/>		return<br/>	}<br/>	defer db.Close()</span><span id="1877" class="lo ki hi ln b fi mo ml l mm mn">	rows, err := db.Query("select 'Great!' from dual")<br/>	if err != nil {<br/>		fmt.Println("Error running query")<br/>		fmt.Println(err)<br/>		w.WriteHeader(http.StatusInternalServerError)<br/>		fmt.Fprintln(w, err)<br/>		return<br/>	}<br/>	defer rows.Close()</span><span id="d206" class="lo ki hi ln b fi mo ml l mm mn">	var value string<br/>	for rows.Next() {<br/>		rows.Scan(&amp;value)<br/>	}<br/>	w.WriteHeader(http.StatusOK)<br/>	fmt.Fprintln(w, value)<br/>}</span></pre><p id="14c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将依赖关系添加到<code class="du lk ll lm ln b"><a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/go/go.mod" rel="noopener ugc nofollow" target="_blank">go.mod</a></code>(或<a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/python/requirements.txt" rel="noopener ugc nofollow" target="_blank">Python</a>T1、<a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/nodejs/package.json" rel="noopener ugc nofollow" target="_blank"> NodeJS </a> <code class="du lk ll lm ln b"><a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/nodejs/package.json" rel="noopener ugc nofollow" target="_blank">package.json</a></code>)</p><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="ada1" class="lo ki hi ln b fi mk ml l mm mn">module server</span><span id="18a8" class="lo ki hi ln b fi mo ml l mm mn">go 1.12</span><span id="3b25" class="lo ki hi ln b fi mo ml l mm mn">require (<br/>	github.com/gorilla/mux v1.7.1<br/>	gopkg.in/goracle.v2 v2.20.1<br/>)</span></pre><p id="b21d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，用<code class="du lk ll lm ln b"><a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/go/Dockerfile" rel="noopener ugc nofollow" target="_blank">Dockerfile</a></code> ( <a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/python/Dockerfile" rel="noopener ugc nofollow" target="_blank"> Python版本</a>，<a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/nodejs/Dockerfile" rel="noopener ugc nofollow" target="_blank"> NodeJS版本</a>)构建容器</p><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="7649" class="lo ki hi ln b fi mk ml l mm mn">FROM golang:1.12 as builder</span><span id="8cea" class="lo ki hi ln b fi mo ml l mm mn"># Copy local code to the container image.<br/>WORKDIR /go/src/function/<br/>COPY go.mod .<br/>ENV GO111MODULE=on<br/>RUN CGO_ENABLED=1 GOOS=linux go mod download</span><span id="bd60" class="lo ki hi ln b fi mo ml l mm mn">COPY . .<br/># Perform test for building a clean package<br/>#RUN go test -v ./...<br/>RUN CGO_ENABLED=1 GOOS=linux go build -v -o server</span><span id="24c7" class="lo ki hi ln b fi mo ml l mm mn"># Now copy it into Oracle base image.<br/>FROM oraclelinux:7-slim</span><span id="f1a1" class="lo ki hi ln b fi mo ml l mm mn">ARG release=19<br/>ARG update=3</span><span id="f770" class="lo ki hi ln b fi mo ml l mm mn">RUN  yum -y install oracle-release-el7 &amp;&amp; \<br/>  yum-config-manager --enable ol7_oracle_instantclient &amp;&amp; \<br/>  yum -y install oracle-instantclient${release}.${update}-basic &amp;&amp; \<br/>  rm -rf /var/cache/yum</span><span id="bb9b" class="lo ki hi ln b fi mo ml l mm mn">COPY --from=builder /go/src/function/server /server<br/>CMD ["/server"]</span></pre><p id="96bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">考验的时候到了！</p><ul class=""><li id="501d" class="mp mq hi is b it iu ix iy jb mr jf ms jj mt jn mu mv mw mx bi translated">构建容器(或者使用云构建，参见<code class="du lk ll lm ln b"><a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">README.md</a>)</code></li></ul><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="a474" class="lo ki hi ln b fi mk ml l mm mn">gcloud builds submit --tag gcr.io/&lt;your project&gt;/oracle-connection</span></pre><ul class=""><li id="77f1" class="mp mq hi is b it iu ix iy jb mr jf ms jj mt jn mu mv mw mx bi translated">在云上部署运行(<em class="kg">用您的值更新您的环境变量)</em></li></ul><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="7129" class="lo ki hi ln b fi mk ml l mm mn">gcloud beta run deploy oracle-connection --platform managed\<br/>    --image gcr.io/&lt;your project&gt;/oracle-connection<br/>    --region us-central1 --allow-unauthenticated<br/>    <!-- -->--set-env-vars ORACLE_IP=&lt;YOUR IP&gt;,ORACLE_SCHEMA=&lt;YOUR SCHEMA&gt;,\<br/>ORACLE_USER=&lt;YOUR USER&gt;,ORACLE_PASSWORD=&lt;YOUR PASSWORD&gt;</span></pre><ul class=""><li id="64c4" class="mp mq hi is b it iu ix iy jb mr jf ms jj mt jn mu mv mw mx bi translated">测试您的查询</li></ul><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="6370" class="lo ki hi ln b fi mk ml l mm mn">curl $(gcloud beta run services describe oracle-connection \<br/>    --region us-central1 --format "value(status.address.hostname)" \<br/>    --platform managed)</span><span id="70e3" class="lo ki hi ln b fi mo ml l mm mn">&gt; Great!</span></pre><p id="221f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">嘣，连上了！</p><h2 id="a5c8" class="lo ki hi bd kj lp lq lr kn ls lt lu kr jb lv lw kv jf lx ly kz jj lz ma ld mb bi translated">云运行权衡</h2><p id="b898" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">太好了，这很有效！！<em class="kg">嗯嗯，</em> <em class="kg">是与否</em>。是的，我可以访问部署在计算引擎上的Oracle数据库，但是我的本地Oracle数据库怎么样呢？</p><p id="2011" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">今天(2019年10月)，还不能用 <a class="ae jo" href="https://cloud.google.com/vpc/docs/configure-serverless-vpc-access" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">无服务器VPC连接器</strong> </a>将云运行服务连接到VPC。只有云功能和App引擎与之兼容。云函数达不到Oracle DB所以还是用App Engine试试吧。</p><p id="f835" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="kg">编辑(2020年5月)<br/> </em> </strong> <a class="ae jo" href="https://cloud.google.com/run/docs/configuring/connecting-vpc" rel="noopener ugc nofollow" target="_blank"> <em class="kg">云运行现已兼容无服务器VPC连接器</em> </a> <em class="kg">内测。您不再有网络限制</em></p><h1 id="dfa2" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">应用引擎解决方案</h1><p id="68da" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">App Engine是谷歌云平台上最古老的服务。它有两个版本:标准和灵活</p><h2 id="504a" class="lo ki hi bd kj lp lq lr kn ls lt lu kr jb lv lw kv jf lx ly kz jj lz ma ld mb bi translated">标准环境</h2><p id="0483" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/appengine/docs/standard/" rel="noopener ugc nofollow" target="_blank"> App引擎标准</a>允许<strong class="is hj">带给你代码，一个微服务，你运行</strong> <code class="du lk ll lm ln b"><strong class="is hj">gcloud</strong></code> <strong class="is hj">命令来部署它</strong>。编译、部署、向上和向下缩放(到0)由平台管理。</p><p id="53ae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">与my Cloud函数定义非常相似，因此主要问题也很相似:<strong class="is hj">无法在App Engine标准环境中安装Oracle软件</strong>。仍然不是正确的解决方案。</p><p id="b384" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kg">如果你想测试部署，代码存在于Go、Python和NodeJS目录中。参见</em> <code class="du lk ll lm ln b"><a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/README.md" rel="noopener ugc nofollow" target="_blank"><em class="kg">README.md</em></a></code></p><h2 id="61c9" class="lo ki hi bd kj lp lq lr kn ls lt lu kr jb lv lw kv jf lx ly kz jj lz ma ld mb bi translated">灵活的环境</h2><p id="7426" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated"><a class="ae jo" href="https://cloud.google.com/appengine/docs/flexible/" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">App Engine Flexible</strong></a><strong class="is hj">去掉了标准版</strong>的很多取舍，比如语言数量有限或者无法安装软件。怎么会？和云运行一样，<strong class="is hj"> App Engine flexible基于容器</strong>。</p><p id="decc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">很好，让我们试着在App Engine Flex上部署我们的工作容器。<em class="kg">为此，我将使用自定义运行时。</em></p><p id="e002" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从Go容器的一个<code class="du lk ll lm ln b"><a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/go/app-flexible.yaml" rel="noopener ugc nofollow" target="_blank">app-flexible.yaml</a></code>描述文件开始</p><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="b46f" class="lo ki hi ln b fi mk ml l mm mn">runtime: custom<br/>env: flex<br/>service: go-serverless-oracle-flex</span><span id="1d88" class="lo ki hi ln b fi mo ml l mm mn">env_variables:<br/>    ORACLE_IP: "&lt;YOUR IP&gt;"<br/>    ORACLE_SCHEMA: "&lt;YOUR SCHEMA&gt;"<br/>    ORACLE_USER: "&lt;YOUR USER&gt;"<br/>    ORACLE_PASSWORD: "&lt;YOUR PASSWORD&gt;"</span></pre><ul class=""><li id="8d1b" class="mp mq hi is b it iu ix iy jb mr jf ms jj mt jn mu mv mw mx bi translated">在应用引擎上灵活部署</li></ul><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="209b" class="lo ki hi ln b fi mk ml l mm mn">gcloud app deploy app-flexible.yaml</span></pre><ul class=""><li id="0421" class="mp mq hi is b it iu ix iy jb mr jf ms jj mt jn mu mv mw mx bi translated">测试您的查询</li></ul><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="384d" class="lo ki hi ln b fi mk ml l mm mn">curl $(gcloud app browse --no-launch-browser \<br/>     -s go-serverless-oracle-flex)</span><span id="001c" class="lo ki hi ln b fi mo ml l mm mn">&gt; Great!</span></pre><p id="dbe1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">厉害！那有效！App Engine与无服务器VPC连接器兼容！问题解决了！！！</p></div><div class="ab cl jz ka gp kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hb hc hd he hf"><p id="9199" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不是因为我从不满足，而是现实中，<strong class="is hj"> <em class="kg">这种解决方案并不“完美”</em> </strong>。事实上，对我来说，App Engine Flexible有一个主要的缺点:它不能扩展到0。当然，您不必关心服务器配置和纵向扩展。但你只有一个运行实例，并支付它，如果没有交通事件。</p><blockquote class="jp"><p id="f299" class="jq jr hi bd js jt ju jv jw jx jy jn dx translated">App Engine Flex不是我对无服务器的“严格”定义。我想在使用服务时付费。我们能做得更好吗？</p></blockquote><h1 id="a997" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks my ku kv kw mz ky kz la na lc ld le bi translated">我的爪哇，我的英雄！</h1><p id="7d04" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">由于功能限制，我将测试局限于Python、NodeJS和Go。但是，在App Engine上，也支持Java。目前，Java在无服务器和微服务领域并不是一种流行的语言。</p><p id="b7cf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是<strong class="is hj"> Java社区非常活跃</strong> <strong class="is hj">有几个语言口味</strong> (Kotlin，Groovy，Scala)<strong class="is hj">几个新的面向微服务的框架</strong> (Quarkus，Vertx，micron aut)<strong class="is hj">新的JIT/AOT </strong>(刚好及时/提前)<strong class="is hj">用GraalVM编译</strong>。顺便说一下，这种语言仍然是最新的，使用和测试起来非常有趣。</p><p id="a780" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://en.wikipedia.org/wiki/Sun_acquisition_by_Oracle" rel="noopener ugc nofollow" target="_blank"> Oracle和Java多年来一直保持着密切的关系</a>，不管是不是因为这个原因，令人惊讶的是<strong class="is hj"> Oracle Java库(Jar)不需要任何Oracle二进制文件就能连接到数据库</strong></p><p id="4814" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当然，您仍然需要从Oracle门户下载Jar驱动程序并保存在您的项目中(<a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/tree/master/java/src/main/resources" rel="noopener ugc nofollow" target="_blank">参见资源目录</a>)，因为它不能被<em class="kg">匿名</em>构建系统(在我的例子中是Maven)直接下载</p><h2 id="3c7e" class="lo ki hi bd kj lp lq lr kn ls lt lu kr jb lv lw kv jf lx ly kz jj lz ma ld mb bi translated">App Engine标准解决方案</h2><p id="2bd4" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">顺便说一句，符合J<a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/tree/master/appEngine8" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">ava 8</strong></a><strong class="is hj">和J</strong><a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/tree/master/java" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">ava 11</strong></a><strong class="is hj"/>的<strong class="is hj"> App引擎标准缩放至0，符合无服务器VPC连接器。厉害！让我们部署一个Java版本</strong></p><p id="96c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从<a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/java/src/main/java/dev/gblaquiere/serverlessoracle/java/function/OracleConnection.java" rel="noopener ugc nofollow" target="_blank">定义测试连接的端点</a>开始。</p><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="7303" class="lo ki hi ln b fi mk ml l mm mn">package dev.gblaquiere.serverlessoracle.java.endpoint;<br/><br/>import javax.servlet.http.HttpServlet;<br/>import javax.servlet.http.HttpServletRequest;<br/>import javax.servlet.http.HttpServletResponse;<br/>import java.io.IOException;<br/>import java.sql.Connection;<br/>import java.sql.DriverManager;<br/>import java.sql.ResultSet;<br/>import java.sql.Statement;<br/><br/>public class OracleConnection extends HttpServlet { <br/><br/>    public void doGet(HttpServletRequest request,<br/>                      HttpServletResponse response) <br/>                      throws IOException {<br/>        try {<br/>            Class.forName("oracle.jdbc.driver.OracleDriver");<br/><br/>            String dbIp = System.getenv("ORACLE_IP");<br/>            String dbSchema = System.getenv("ORACLE_SCHEMA");<br/>            String dbUser = System.getenv("ORACLE_USER");<br/>            String dbPassword = System.getenv("ORACLE_PASSWORD");<br/><br/>            Connection con = DriverManager.getConnection(<br/>                    "jdbc:oracle:thin:@" + dbIp + ":1521:" + <br/>                     dbSchema, dbUser, dbPassword);<br/><br/><br/>            Statement stmt = con.createStatement();<br/><br/>            ResultSet rs = stmt.executeQuery(<br/>                               "select 'Great!' from dual");<br/>            while (rs.next())<br/>                response.getWriter().println(rs.getString(1));<br/><br/>            con.close();<br/>            response.setStatus(HttpServletResponse.SC_OK);<br/>        } catch (Exception e) {<br/>            System.out.println(e);<br/>            response.setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);<br/>            response.getWriter().println(e.getMessage());<br/>        }<br/>    }<br/>}</span></pre><p id="0c19" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，在<code class="du lk ll lm ln b">src/main/appengine</code>目录下创建<code class="du lk ll lm ln b"><a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/blob/master/java/src/main/appengine/app.yaml" rel="noopener ugc nofollow" target="_blank">app.yaml</a></code>文件(<em class="kg">用您的值</em>更新环境变量)</p><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="db45" class="lo ki hi ln b fi mk ml l mm mn">runtime: java11<br/>service: java11-serverless-oracle</span><span id="e6a4" class="lo ki hi ln b fi mo ml l mm mn">env_variables:<br/>    ORACLE_IP: "&lt;YOUR IP&gt;"<br/>    ORACLE_SCHEMA: "&lt;YOUR SCHEMA&gt;"<br/>    ORACLE_USER: "&lt;YOUR USER&gt;"<br/>    ORACLE_PASSWORD: "&lt;YOUR PASSWORD&gt;"</span></pre><p id="ff0f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kg">运行时java11。</em> <a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle/tree/master/appEngine8" rel="noopener ugc nofollow" target="_blank"> <em class="kg"> Java8不同，同样在源代码</em> </a>中提供</p><p id="9731" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">手动安装Oracle依赖项</p><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="2307" class="lo ki hi ln b fi mk ml l mm mn">mvn install:install-file -Dfile=src/main/resources/ojdbc7.jar \<br/>    -DgroupId=com.oracle -DartifactId=ojdbc7 -Dversion=1.0.0 \<br/>    -Dpackaging=jar</span></pre><p id="1437" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用Maven进行部署(<em class="kg">不要忘记更新</em> <code class="du lk ll lm ln b"><em class="kg">pom.xml</em></code> <em class="kg">文件</em>中的 <code class="du lk ll lm ln b"><em class="kg">projectId</em></code> <em class="kg"> maven属性)</em></p><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="e02a" class="lo ki hi ln b fi mk ml l mm mn">mvn clean package appengine:deploy</span></pre><p id="1b55" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，测试一下</p><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="c244" class="lo ki hi ln b fi mk ml l mm mn">curl $(gcloud app browse -s java11-serverless-oracle \<br/>    --no-launch-browser)</span><span id="d8cc" class="lo ki hi ln b fi mo ml l mm mn">&gt; Great!</span></pre><p id="8f20" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">嘣！我拿到了。<strong class="is hj">一个无服务器平台，可扩展至0，并能够查询我的内部Oracle数据库！</strong></p><h2 id="e4d0" class="lo ki hi bd kj lp lq lr kn ls lt lu kr jb lv lw kv jf lx ly kz jj lz ma ld mb bi translated">集装箱有什么不同？</h2><p id="d2fd" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">云运行和App Engine Flexible需要一个容器。有了Java，我们不需要安装Oracle Instant Client。因此，<strong class="is hj">容器的构建更简单，但是必须手动安装Oracle Jar驱动程序(在我的例子中是使用maven的</strong>)</p><pre class="mc md me mf fd mg ln mh mi aw mj bi"><span id="f2de" class="lo ki hi ln b fi mk ml l mm mn">FROM maven:3.5-jdk-8-alpine as builder<br/><br/># Copy local code to the container image.<br/>WORKDIR /app<br/>COPY pom.xml .<br/>COPY src ./src<br/><br/># Install Oracle Jar to Maven<br/>RUN mvn install:install-file \<br/>    -Dfile=/app/src/main/resources/ojdbc7.jar \<br/>    -DgroupId=com.oracle \<br/>    -DartifactId=ojdbc7 -Dversion=1.0.0 -Dpackaging=jar<br/><br/># Build a release artifact.<br/>RUN mvn package -DskipTests<br/><br/>FROM adoptopenjdk/openjdk8:jdk8u202-b08-alpine-slim<br/><br/># Copy the jar to the production image from the builder stage.<br/>COPY --from=builder /app/target/java-*.jar /java.jar<br/><br/># Run the web service on container startup.<br/>CMD ["java","-Djava.security.egd=file:/dev/./urandom","-Dserver.port=${PORT}","-jar","/java.jar"]</span></pre><p id="22a7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后部署和测试类似于其他语言。<em class="kg"> </em> <a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle" rel="noopener ugc nofollow" target="_blank"> <em class="kg">详见源代码</em> </a> <em class="kg">。</em></p></div><div class="ab cl jz ka gp kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hb hc hd he hf"><h1 id="403d" class="kh ki hi bd kj kk nb km kn ko nc kq kr ks nd ku kv kw ne ky kz la nf lc ld le bi translated">摘要</h1><p id="b40a" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">最后，对于在无服务器平台上构建和部署解决方案，连接到Oracle数据库意味着比预期更多的限制。</p><p id="f865" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">希望容器包装能解决很多问题，但不是全部。事实上，<strong class="is hj"> Cloud Run无法访问内部资源</strong>(直到与无服务器VPC连接器兼容)<strong class="is hj"> App Engine Flex无法扩展到0 </strong>。</p><p id="356b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">出乎意料的是，<strong class="is hj"> Java解决了所有问题，可以部署在App Engine standard上，扩展到0，可以使用无服务器VPC连接器</strong>。</p><p id="c5e9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我期待着看到预期的功能正式宣布和可用。2020年将会是有趣的一年！</p></div><div class="ab cl jz ka gp kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hb hc hd he hf"><p id="2fc6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="kg">补充说明:</em> </strong> <em class="kg">除了Java，同样的</em> <a class="ae jo" href="https://github.com/guillaumeblaquiere/serverless-oracle" rel="noopener ugc nofollow" target="_blank"> <em class="kg">代码</em> </a> <em class="kg">在Node、Python、Go这4款无服务器产品(App Engine standard、App Engine flex、Cloud Run、Cloud Function)上工作。只有配置文件是定制的，很容易改变平台，以利用其特定的功能。</em></p></div></div>    
</body>
</html>