<html>
<head>
<title>Store Service Account keys in GCP Secret Manager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GCP秘密管理器中存储服务帐户密钥</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/store-service-account-keys-in-gcp-secret-manager-d74f0a1d11fc?source=collection_archive---------1-----------------------#2022-11-17">https://medium.com/google-cloud/store-service-account-keys-in-gcp-secret-manager-d74f0a1d11fc?source=collection_archive---------1-----------------------#2022-11-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4d42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">与</em> <a class="je jf ge" href="https://medium.com/u/b946360addad?source=post_page-----d74f0a1d11fc--------------------------------" rel="noopener" target="_blank"> <em class="jd">合写Bipin Upadhyaya</em></a><em class="jd">—2022年11月16日</em></p><p id="d2ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">气流Dag可能需要在运行时向其传递连接和变量，以执行操作符和传感器。传统上，Airflow开发人员使用环境变量或metastore数据库来存储和检索这些连接以及在Airflow worker pods中DAG解析或任务执行期间使用的变量。</p><p id="0669" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了这些选项，Airflow 1.10.10或更高版本还提供了对秘密后端的支持。在安全性方面，使用<a class="ae jg" href="https://airflow.apache.org/docs/apache-airflow/1.10.10/howto/use-alternative-secrets-backend.html" rel="noopener ugc nofollow" target="_blank">秘密后端</a>是一个很好的实践，因为它们提供了额外的安全层和秘密后端的所有功能，如自动旋转、自定义加密密钥等。也可以杠杆化。</p><p id="784e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cloud Composer的用户可以使用Secret Manager(一个秘密后端)将敏感变量(如密码和服务帐户密钥)安全地存储在一个集中的位置。他们还可以分配精细的权限和经审核的访问控制，以符合其组织的安全要求。</p><p id="070d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽管存储在Secret Manager中的机密可以与环境变量一起使用，但在DAG运行时，存储在Secret Manager中的详细信息优先于存储在环境变量或metastore数据库中的详细信息(如果值彼此不同)。</p><p id="d040" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本指南介绍了配置Cloud Composer环境以从Secret Manager读取连接的步骤。</p><h1 id="cf09" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">设置和要求</h1><p id="c36e" class="pw-post-body-paragraph if ig hi ih b ii kf ik il im kg io ip iq kh is it iu ki iw ix iy kj ja jb jc hb bi translated">这两个步骤创建必要的环境变量，并授予Composer服务帐户读取机密的权限。</p><p id="3639" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤1: </strong>该步骤显示了如何启用Secret Manager并授予Composer服务帐户对它的读取权限，假设已经创建了Composer环境(如果没有，请按照步骤<a class="ae jg" href="https://cloud.google.com/composer/docs/composer-2/create-environments" rel="noopener ugc nofollow" target="_blank">创建环境</a>)。在“环境配置”选项卡中，从“环境详细信息”页面获取Composer服务帐户的详细信息。</p><figure class="kl km kn ko fd kp er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es kk"><img src="../Images/a0e5e0e23926ebbf694a91054abd5058.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XYIjsvbEg8RlEBNG"/></div></div><figcaption class="kw kx et er es ky kz bd b be z dx translated"><em class="la">图Composer中环境详细信息页面上的环境配置选项卡</em></figcaption></figure><p id="ca65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的代码片段显示了如何启用Secret Manager并授予composer服务帐户权限。将&lt;<project-id>替换为配置了Secret Manager的项目，将&lt;<service-account>替换为从环境配置选项卡中复制的Composer服务帐户，并运行命令。</service-account></project-id></p><pre class="kl km kn ko fd lb lc ld bn le lf bi"><span id="4a10" class="lg ji hi lc b be lh li l lj lk">gcloud services enable secretmanager.googleapis.com<br/>gcloud projects add-iam-policy-binding &lt;&lt;project-id&gt;&gt; --member=serviceAccount:&lt;&lt;composer-service account&gt;&gt; --role=roles/secretmanager.secretAccessor</span></pre><p id="d76b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤2: </strong>使用secrets.backend和secrets.backend_kwarg的气流配置的覆盖来配置Composer。下面的代码片段显示了如何设置气流配置的秘密。</p><pre class="kl km kn ko fd lb lc ld bn le lf bi"><span id="38b3" class="lg ji hi lc b be lh li l lj lk">secrets.backend = <br/>airflow.providers.google.cloud.secrets.secret_manager.CloudSecretManagerBackend<br/>secrets.backend_kwargs = <br/>{"connections_prefix": "airflow-connections", "variables_prefix": "airflow-variables", "sep": "-","project_id"="&lt;&lt;replace-with-project-id&gt;&gt;"}</span></pre><p id="4e0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">backend_kwargs值是具有以下字段的<a class="ae jg" href="https://airflow.apache.org/docs/apache-airflow-providers-google/stable/secrets-backends/google-cloud-secret-manager-backend.html#backend-parameters" rel="noopener ugc nofollow" target="_blank"> backend_kwargs对象</a>的JSON表示:</p><ul class=""><li id="aaaa" class="ll lm hi ih b ii ij im in iq ln iu lo iy lp jc lq lr ls lt bi translated">connections_prefix:指定要读取以获取连接的秘密名称的前缀。默认为:气流-连接。</li><li id="e27c" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">variables_prefix:指定要读取以获取变量的秘密名称的前缀。默认值为:气流-变量。</li><li id="754e" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">GCP _ key _ Path:Google Cloud凭据JSON文件的路径(如果没有提供，则使用默认服务帐户)。</li><li id="0d17" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">GCP _ keyfile _ dict:Google Cloud Credential JSON字典。与gcp_key_path互斥。</li><li id="433d" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">sep:用于连接connections_prefix和conn_id的分隔符。默认值为:-。</li><li id="8071" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">project_id:存储机密的Google Cloud项目id。</li></ul><figure class="kl km kn ko fd kp er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es lz"><img src="../Images/34b5f911db73a46818d7e3e0f80c2c84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HshhM_Nz9Qckqs1p"/></div></div><figcaption class="kw kx et er es ky kz bd b be z dx translated"><em class="la">图2:Composer</em>环境详细信息页面上的气流配置覆盖选项卡</figcaption></figure><h1 id="3e8d" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">从Secret Manager访问变量</h1><p id="9839" class="pw-post-body-paragraph if ig hi ih b ii kf ik il im kg io ip iq kh is it iu ki iw ix iy kj ja jb jc hb bi translated"><strong class="ih hj">第一步:</strong>根据你的变量名称(my_secret)，在Secret Manager中创建一个条目(airlfow-variables-my-secret)。添加变量前缀为“气流-变量”</p><pre class="kl km kn ko fd lb lc ld bn le lf bi"><span id="f22c" class="lg ji hi lc b be lh li l lj lk">printf "s3cr3t" | gcloud secrets create airlfow-variables-my-secret --data-file=-</span></pre><p id="90c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤2: </strong>部署DAG。这是一个简单的例子</p><pre class="kl km kn ko fd lb lc ld bn le lf bi"><span id="6d16" class="lg ji hi lc b be lh li l lj lk">import airflow <br/>from airflow import DAG <br/>from datetime import datetime, timedelta <br/>from airflow.operators.bash_operator import BashOperator <br/><br/>YESTERDAY = datetime.combine( datetime.today() - timedelta(days=1), datetime.min.time())<br/>default_args = { <br/>'retries': 2,<br/>'retry_delay': timedelta(seconds=60), <br/>'start_date': YESTERDAY, <br/>}<br/><br/>with DAG('secrets_manager', <br/>default_args=default_args,<br/>start_date=YESTERDAY, <br/>schedule_interval='@once') as dag: <br/>  t = BashOperator( task_id="get_variable_value", bash_command='echo "MY SECRET: {{ var.value.my-secret }}" ')</span></pre><h1 id="eb61" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">基于Secret Manager中的服务帐户密钥创建气流连接</h1><p id="9d59" class="pw-post-body-paragraph if ig hi ih b ii kf ik il im kg io ip iq kh is it iu ki iw ix iy kj ja jb jc hb bi translated">在这个例子中，我们将使用一个BigQuery数据集。(按照这些<a class="ae jg" href="https://cloud.google.com/bigquery/docs/datasets" rel="noopener ugc nofollow" target="_blank">步骤</a>创建数据集)</p><p id="816b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤1: </strong>在Secret Manager中，创建将用作气流连接的密码。</p><ol class=""><li id="51ec" class="ll lm hi ih b ii ij im in iq ln iu lo iy lp jc ma lr ls lt bi translated">使用以下命令获取服务帐户JSON</li></ol><pre class="kl km kn ko fd lb lc ld bn le lf bi"><span id="6083" class="lg ji hi lc b be lh li l lj lk">gcloud iam service-accounts keys create KEY_FILE \  --iam-account=SA_NAME@PROJECT_ID.iam.gserviceaccount.com</span></pre><p id="3a22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.使用下面的示例程序(connection _ for _ Secret _ Manager . py)，可以得到可以直接上传到Secret Manager的值。</p><pre class="kl km kn ko fd lb lc ld bn le lf bi"><span id="4f98" class="lg ji hi lc b be lh li l lj lk">import sys, urllib.parse as ul<br/>import json<br/>import getopt<br/><br/>def get_content_for_secret(service_account_path, project_id):<br/>    file=open(service_account_path)<br/>    sa_value=file.read()<br/>    sa_value_deser=json.dumps(sa_value)<br/>    sa_quote_plus_value=ul.quote_plus(sa_value_deser)<br/>    first_half_extra = ul.quote_plus('{"extra__google_cloud_platform__key_path": "", "extra__google_cloud_platform__key_secret_name": "","extra__google_cloud_platform__keyfile_dict":')<br/>    second_half_extra=ul.quote_plus(', "extra__google_cloud_platform__num_retries": 5, "extra__google_cloud_platform__project": "{}", "extra__google_cloud_platform__scope": ""}}'.format(project_id))<br/>    return "google-cloud-platform://?__extra__={}{}{}".format(first_half_extra,sa_quote_plus_value,second_half_extra)<br/><br/>def main(argv):<br/>   service_account_file_path = ''<br/>   project_id = ''<br/>   try:<br/>      opts, args = getopt.getopt(argv,"hi:p:",["saPath=","projectId="])<br/>   except getopt.GetoptError:<br/>      print('connection_for_secret_manager.py -i &lt;service_account_file_path&gt; -p &lt;project_id&gt;')<br/>      sys.exit(2)<br/>   for opt, arg in opts:<br/>      if opt == '-h':<br/>         print('connection_for_secret_manager.py -i &lt;service_account_file_path&gt; -p &lt;project_id&gt;')<br/>         sys.exit()<br/>      elif opt in ("-i", "--saPath"):<br/>         service_account_file_path = arg<br/>      elif opt in ("-p", "--projectId"):<br/>         project_id = arg<br/>   return service_account_file_path, project_id<br/><br/>if __name__ == "__main__":<br/>    service_account_file_path, project_id = main(sys.argv[1:])<br/>    print(get_content_for_secret(service_account_file_path, project_id))</span></pre><pre class="mb lb lc ld bn le lf bi"><span id="68c8" class="lg ji hi lc b be lh li l lj lk">python3 connection_for_secret_manager.py -i &lt;&lt;service_account_path&gt;&gt;  -p &lt;&lt;project_id&gt;&gt; &gt; output_for_secret_manager</span></pre><p id="034d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.将输出内容上传到Secret Manager。从气流DAG开始，此连接称为conn1。在Secret Manager中，您需要创建带有前缀“airflow-connections”的条目</p><pre class="kl km kn ko fd lb lc ld bn le lf bi"><span id="fe87" class="lg ji hi lc b be lh li l lj lk">gcloud secrets versions add airflow-connections-conn1 --data-file=output_for_secret_manager</span></pre><figure class="kl km kn ko fd kp er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es mc"><img src="../Images/f10941899436c50fd195c45d80a9b427.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*III6d5f__679BnMX"/></div></div></figure><p id="6e2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤2 </strong>:导航到管理&gt;连接，创建GCP连接(连接1)。</p><figure class="kl km kn ko fd kp er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es md"><img src="../Images/1ece962409df30a45e10b18a46f19a34.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/0*TXrEhYKS-BiVQSzs"/></div></div></figure><p id="51c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单击添加新记录以创建新连接。在连接id上，输入conn1，连接类型Google Cloud，airflow-connections-conn1作为密钥文件机密名称和配置了机密管理器的项目Id。</p><figure class="kl km kn ko fd kp er es paragraph-image"><div class="er es me"><img src="../Images/5e8a98ddd5df711fe5b69f3a963c504c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/0*C6LcSIVw4hT0gJpI"/></div></figure><p id="4b12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤3: </strong>部署示例DAG(参见下面的DAG代码)并手动触发工作流。下载一个BigQuery公共数据集(<a class="ae jg" href="https://open.toronto.ca/dataset/daily-shelter-occupancy/" rel="noopener ugc nofollow" target="_blank">示例</a>)，以shelter_2020.csv的格式存储在Google云存储中，在下面的Python示例中更改bucket名称(&lt; &lt; GCS_BUCKET_NAME &gt; &gt;)。同样地更改BigQuery项目、数据集和表名(&lt; &lt; PROJECT_ID &gt; &gt;)。&lt; &lt;数据集&gt; &gt;。&lt; &lt;表&gt; &gt;)。</p><p id="ef8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Python DAG示例:</p><pre class="kl km kn ko fd lb lc ld bn le lf bi"><span id="3fb4" class="lg ji hi lc b be lh li l lj lk">from airflow import DAG<br/>from airflow.operators.dummy import DummyOperator<br/>from datetime import datetime, timedelta<br/>from airflow.hooks.base_hook import BaseHook<br/>from airflow.providers.google.cloud.transfers.gcs_to_bigquery import GCSToBigQueryOperator<br/><br/>YESTERDAY = datetime.combine( datetime.today() - timedelta(days=1), datetime.min.time())<br/>with DAG('example_secret_connections_conn1', start_date=YESTERDAY, schedule_interval=None) as dag:<br/><br/>    start = DummyOperator(<br/>        task_id='start'<br/>    )<br/>    bq_load_task = GCSToBigQueryOperator(<br/>        task_id='bqload',<br/>        bucket='&lt;&lt;GCS_BUCKET_NAME&gt;&gt;',<br/>        source_objects=["shelter_2020.csv"],<br/>     destination_project_dataset_table='&lt;&lt;PROJECT_ID&gt;&gt;.&lt;&lt;DATASET&gt;&gt;.&lt;&lt;TABLE&gt;&gt;',<br/>        skip_leading_rows=1,<br/>        schema_fields=[<br/>                { "name": "_id", "type": "INTEGER" },<br/>                { "name": "OCCUPANCY_DATE", "type": "STRING" },<br/>                { "name": "ORGANIZATION_NAME", "type": "STRING" },<br/>                { "name": "SHELTER_NAME", "type": "STRING" },<br/>                { "name": "SHELTER_ADDRESS", "type": "STRING" },<br/>                { "name": "SHELTER_CITY", "type": "STRING" },<br/>                { "name": "SHELTER_PROVINCE", "type": "STRING" },<br/>                { "name": "SHELTER_POSTAL_CODE", "type": "STRING" },<br/>                { "name": "FACILITY_NAME", "type": "STRING" },<br/>                { "name": "PROGRAM_NAME", "type": "STRING" },<br/>                { "name": "SECTOR", "type": "STRING" },<br/>                { "name": "OCCUPANCY", "type": "INTEGER" },<br/>                { "name": "CAPACITY", "type": "INTEGER" }<br/>        ],<br/>        write_disposition='WRITE_TRUNCATE',<br/>        gcp_conn_id='conn1'<br/>    )<br/>    stop = DummyOperator(<br/>        task_id='stop'<br/>    )<br/><br/>    start &gt;&gt; bq_load_task &gt;&gt; stop</span></pre><p id="d75e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">触发工作流并验证BigQuery表中的数据是否可用。</p><h1 id="6ad1" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">结论</h1><p id="010f" class="pw-post-body-paragraph if ig hi ih b ii kf ik il im kg io ip iq kh is it iu ki iw ix iy kj ja jb jc hb bi translated">使用Secrets Manager来存储传递到Dag的机密，并将其与Composer环境集成有很多好处。本指南中的步骤描述了如何配置Composer环境以从GCP Secret Manager读取连接，并提供了一些示例代码。</p><h1 id="8fc9" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">附加链接</h1><p id="c2c7" class="pw-post-body-paragraph if ig hi ih b ii kf ik il im kg io ip iq kh is it iu ki iw ix iy kj ja jb jc hb bi translated"><a class="ae jg" href="https://airflow.apache.org/docs/apache-airflow/1.10.10/howto/use-alternative-secrets-backend.html#gcp-secrets-manager-backend" rel="noopener ugc nofollow" target="_blank">https://air flow . Apache . org/docs/Apache-air flow/1 . 10 . 10/how to/use-alternative-secrets-back end . html # GCP-secrets-manager-back end</a></p></div></div>    
</body>
</html>