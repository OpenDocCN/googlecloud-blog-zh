<html>
<head>
<title>Modern Frontend CI/CD Architecture — The Missing Guide (Part. 2): The CD.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">现代前端CI/CD架构—缺失的指南(部分。2):裁谈会。</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/modern-frontend-ci-cd-architecture-the-missing-guide-part-2-d51875bd0e65?source=collection_archive---------1-----------------------#2018-11-15">https://medium.com/google-cloud/modern-frontend-ci-cd-architecture-the-missing-guide-part-2-d51875bd0e65?source=collection_archive---------1-----------------------#2018-11-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="14f8" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">这是“现代前端CI/CD架构——缺失的指南”的第二部分。我们建议您阅读关于如何建立持续集成管道的第一部分。</p></blockquote><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ji"><img src="../Images/31034175952138947c3e14f771c262a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jDOTKaVUU7cBGibSlGRdzA.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">TL；dr:前端CI/CD架构流水线的完整图。</figcaption></figure><h1 id="ed4b" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">Kubernetes是我们的CD渠道</h1><p id="1112" class="pw-post-body-paragraph ii ij hi il b im kw io ip iq kx is it ky kz iw ix la lb ja jb lc ld je jf jg hb bi translated">既然我们已经有了一个有效的持续集成，那么让我们使用Kubernetes作为部署协调器来配置持续部署。</p><blockquote class="if ig ih"><p id="3a6b" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">我们假设你熟悉Kubernetes的基础知识。如果没有，前往官方网站了解<a class="ae jh" href="https://kubernetes.io/docs/home/" rel="noopener ugc nofollow" target="_blank">更多信息</a>。</p></blockquote><p id="d260" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">首先，让我们创建一个Kubernetes集群(如果您还没有准备好的话)。出于这篇博文的目的，我们将使用GCP最近推出的新模板菜单创建一个<strong class="il hj"> g1-small </strong>实例:</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es le"><img src="../Images/6c66a9f86ac6329a61a8e06dd53dc5d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dKdf9fW_-ugxe6LRuo_mrA.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">Kubernetes集群的GCP默认模板配置</figcaption></figure><blockquote class="if ig ih"><p id="aead" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">注意:请确保您为此集群设置了至少3个节点，否则GKE可能会在升级您的pod时遇到一些问题。</p></blockquote><p id="677c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">接下来，为了让Kubernetes部署我们的容器——我们之前通过CI管道构建的快照——在每次构建之后，我们将必须创建三个组件(<strong class="il hj">这些都是我们实现目的所需要的</strong>):</p><ol class=""><li id="1719" class="lf lg hi il b im in iq ir ky lh la li lc lj jg lk ll lm ln bi translated">一个<a class="ae jh" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" rel="noopener ugc nofollow" target="_blank">部署控制器</a>；</li><li id="cbb7" class="lf lg hi il b im lo iq lp ky lq la lr lc ls jg lk ll lm ln bi translated">一个<a class="ae jh" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">服务</a>；</li><li id="4113" class="lf lg hi il b im lo iq lp ky lq la lr lc ls jg lk ll lm ln bi translated">一个<a class="ae jh" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank">入口资源</a>。</li></ol><h2 id="bba8" class="lt jz hi bd ka lu lv lw ke lx ly lz ki ky ma mb km la mc md kq lc me mf ku mg bi translated">部署控制器</h2><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="2593" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">这个部署将创建一个Kubernetes Pod，我们将按照这个定制模式命名它:<strong class="il hj"> xlayers-_SHORT_SHA_。最终的名字看起来会像这样:<strong class="il hj"> xlayers-47c200d。</strong></strong></p><blockquote class="if ig ih"><p id="62d6" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">注意1:在应用此配置之前，我们将用云构建提供的正确值替换<strong class="il hj"> _SHORT_SHA_ </strong>。</p><p id="51a4" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">注2:我们没有为部署指定<strong class="il hj">副本</strong>。所以这将默认为1。你可能想要增加<a class="ae jh" href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/" rel="noopener ugc nofollow" target="_blank">副本</a>来满足你的需求。</p></blockquote><p id="047f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">最重要的是，这个吊舱将被连接到一个名为<strong class="il hj"> xlayers </strong>的容器上，位于端口80。创建的容器基于云构建配置项推送的特定快照映像(参见上述步骤)。</p><h2 id="5bf6" class="lt jz hi bd ka lu lv lw ke lx ly lz ki ky ma mb km la mc md kq lc me mf ku mg bi translated">服务</h2><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="59ec" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">该服务指定如何访问由部署创建的pod集。目标pod由<strong class="il hj"> spec.selector.app </strong>字段定义。这里，我们需要在端口80上访问这些pod。</p><h2 id="6bdd" class="lt jz hi bd ka lu lv lw ke lx ly lz ki ky ma mb km la mc md kq lc me mf ku mg bi translated">入口资源</h2><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="5ff3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">最后，这个入口资源包含一组允许入站连接到达集群服务的规则。在我们的场景中，我们希望像https://xlayers-47c200d.angular.run/<strong class="il hj">T2这样的URL被转发到后端，也就是一个名为<strong class="il hj"> xlayers-47c200d </strong>的服务。</strong></p><h2 id="c210" class="lt jz hi bd ka lu lv lw ke lx ly lz ki ky ma mb km la mc md kq lc me mf ku mg bi translated">DNS配置</h2><p id="f327" class="pw-post-body-paragraph ii ij hi il b im kw io ip iq kx is it ky kz iw ix la lb ja jb lc ld je jf jg hb bi translated">为了能够映射子域<strong class="il hj"> *.angular.run </strong>，我们需要通过在DNS提供程序中添加以下规则来更新<strong class="il hj"> angular.run </strong> DNS记录:</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es mj"><img src="../Images/2080436b833cab15706563b2ebc111fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ydAG83LRZ4vkYniz2jiodg.png"/></div></div></figure><p id="5cb7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">这里使用的IPV4地址是与您的Kubernetes集群的负载平衡器相关联的地址。</p><blockquote class="if ig ih"><p id="f659" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">请注意，这个IP地址是短暂的！您可能想要为您的项目保留一个静态IP地址。</p></blockquote><h2 id="c6ca" class="lt jz hi bd ka lu lv lw ke lx ly lz ki ky ma mb km la mc md kq lc me mf ku mg bi translated">应用所有的东西</h2><p id="9c47" class="pw-post-body-paragraph ii ij hi il b im kw io ip iq kx is it ky kz iw ix la lb ja jb lc ld je jf jg hb bi translated">我们现在准备尝试我们的CD配置。为此，我们将相应地更新cloudbuild.yaml:</p><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="4821" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">我们使用简单的Perl search and replace命令，在构建步骤中简单而自豪地为我们的Kubernetes配置(部署、服务、入口)打补丁，该命令用云构建环境<strong class="il hj"> $SHORT_SHA </strong>提供的实际值替换我们配置文件中的<strong class="il hj"> _SHORT_SHA_ </strong>模式。</p><p id="7d4a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">瞧！</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es mk"><img src="../Images/6f916f9068a2d66890a1c0a141d9efa2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tYdtzsf3wpRzNXaPkWrEuw.png"/></div></div></figure><p id="09ae" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated">以下是我们迄今为止在裁谈会部分取得的成果:</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ml"><img src="../Images/cf8292279c06e2965b5f65db23bdc724.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ASPSR26DKroxDsr69Gh4lA.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">持续部署管道。</figcaption></figure></div><div class="ab cl mm mn gp mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="hb hc hd he hf"><h1 id="7b03" class="jy jz hi bd ka kb mt kd ke kf mu kh ki kj mv kl km kn mw kp kq kr mx kt ku kv bi translated">要阅读更多关于奖励特性的内容，请阅读本文的第3部分。</h1></div><div class="ab cl mm mn gp mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="hb hc hd he hf"><p id="320d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ky iv iw ix la iz ja jb lc jd je jf jg hb bi translated"><em class="ik">关注</em><a class="ae jh" href="https://twitter.com/manekinekko" rel="noopener ugc nofollow" target="_blank"><em class="ik">@ manekinekko</em></a><em class="ik">了解更多关于网络和云技术的更新。</em></p></div></div>    
</body>
</html>