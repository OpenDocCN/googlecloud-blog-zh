<html>
<head>
<title>BigQuery: Snapshot dataset with Cloud Workflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery:使用云工作流的快照数据集</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bigquery-snapshot-dataset-with-cloud-workflow-5175eb8df00b?source=collection_archive---------0-----------------------#2022-07-25">https://medium.com/google-cloud/bigquery-snapshot-dataset-with-cloud-workflow-5175eb8df00b?source=collection_archive---------0-----------------------#2022-07-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/1a6fe2b996d213ea5b47b99b434b51d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oG0TVlIFDVhj-IbgegBkgg.png"/></div></div></figure><p id="7fe6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据是任何公司的<strong class="is hj">金矿</strong>，而<strong class="is hj">数据仓库是存储和查询这些数据的最佳场所</strong>。在<strong class="is hj">谷歌云上，BigQuery </strong>是最受欢迎的工具:<strong class="is hj">无服务器、可扩展、按需付费</strong>；它可以在几秒钟内处理<strong class="is hj">亿字节的数据</strong>。</p><p id="4d3d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">BigQuery特性提供了<strong class="is hj"> DML语句:数据操作语言</strong>，用于插入、更新或删除数据。因为你的黄金资源是珍贵的，你想确定DML不会破坏当前的数据值</p><blockquote class="jo"><p id="23ec" class="jp jq hi bd jr js jt ju jv jw jx jn dx translated">你必须在BigQuery中备份你的数据</p></blockquote><h1 id="a014" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">表快照功能</h1><p id="d2e6" class="pw-post-body-paragraph iq ir hi is b it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj la jl jm jn hb bi translated"><a class="ae lb" href="https://cloud.google.com/bigquery/docs/table-snapshots-intro" rel="noopener ugc nofollow" target="_blank">表格快照功能</a>正是为此而设计的。您可以现在对您的数据执行<strong class="is hj">快照，或者在过去7天内的任何毫秒执行<a class="ae lb" href="https://cloud.google.com/bigquery/docs/time-travel" rel="noopener ugc nofollow" target="_blank">时间旅行功能</a>最大持续时间)。</strong></p><p id="5403" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该功能会对您的数据进行快照，<strong class="is hj">只会跟踪更新或删除字段</strong>的变化。那是卑鄙的:</p><ul class=""><li id="ab07" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated">如果您拍摄的数据<strong class="is hj">从未改变，则快照不会产生任何成本</strong>。</li><li id="e3a5" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">如果您更改了所有数据，您将为快照表的等效存储付费</li></ul><p id="e8b2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lq"/><strong class="is hj"><em class="lq">原理与Git储存库</em> </strong> <em class="lq">和提交更改历史相同。</em></p><h1 id="e277" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj lr kl km kn ls kp kq kr lt kt ku kv bi translated">表快照限制</h1><p id="8551" class="pw-post-body-paragraph iq ir hi is b it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj la jl jm jn hb bi translated">有一些<a class="ae lb" href="https://cloud.google.com/bigquery/docs/table-snapshots-intro#limitations" rel="noopener ugc nofollow" target="_blank">存在限制</a>，但它们并没有真正阻塞。最令人沮丧的是范围:</p><blockquote class="jo"><p id="07b5" class="jp jq hi bd jr js jt ju jv jw jx jn dx translated">您只能快照一个表！</p></blockquote><p id="51c4" class="pw-post-body-paragraph iq ir hi is b it lu iv iw ix lv iz ja jb lw jd je jf lx jh ji jj ly jl jm jn hb bi translated">您的<strong class="is hj">表属于一组同构的表</strong>(原始摄取数据、数据集市、暂存转换等)，这些表被分组到一个数据集中。</p><p id="9e79" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，单独的表快照没有意义，但是必须备份整个数据集。</p><h1 id="b70c" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj lr kl km kn ls kp kq kr lt kt ku kv bi translated">云工作流解决方案</h1><p id="24f5" class="pw-post-body-paragraph iq ir hi is b it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj la jl jm jn hb bi translated">我毫不怀疑BigQuery团队意识到了现实世界的局限性，这个特性总有一天会发布的。<br/>但是<strong class="is hj">在那之前</strong>，云工作流可以帮助我们满足这一需求。</p><h2 id="7174" class="lz jz hi bd ka ma mb mc ke md me mf ki jb mg mh km jf mi mj kq jj mk ml ku mm bi translated">建筑</h2><p id="4459" class="pw-post-body-paragraph iq ir hi is b it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj la jl jm jn hb bi translated">这个基本示例将一个<strong class="is hj">源数据集</strong> <em class="lq">(要拍摄快照的数据集)</em>作为参数，并且可选地将<strong class="is hj">目标数据集</strong> <em class="lq">(存储快照的位置)</em>。然后，步骤如下</p><ul class=""><li id="99ed" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated"><strong class="is hj">检查目标数据集是否存在</strong>。如果没有，使用与源数据集相同的名称创建它，并在结尾使用<code class="du mn mo mp mq b">_backup</code><br/><em class="lq">对于该示例，我将到期时间设置为7天，以便在该持续时间后自动删除快照。</em></li><li id="134a" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><strong class="is hj">列出源数据集中的表格</strong></li><li id="b8f2" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><strong class="is hj">遍历这些表，并为目标数据集中的每个表创建一个快照</strong>。<br/><em class="lq"/><a class="ae lb" href="https://cloud.google.com/workflows/docs/reference/syntax/parallel-steps" rel="noopener ugc nofollow" target="_blank"><em class="lq">为了提高性能，使用了</em> </a> <code class="du mn mo mp mq b"><a class="ae lb" href="https://cloud.google.com/workflows/docs/reference/syntax/parallel-steps" rel="noopener ugc nofollow" target="_blank"><em class="lq">Parallel</em></a></code> <a class="ae lb" href="https://cloud.google.com/workflows/docs/reference/syntax/parallel-steps" rel="noopener ugc nofollow" target="_blank"> <em class="lq">云工作流的特性</em></a><em class="lq"/></li><li id="e00a" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated">如果列表结果中有一个<code class="du mn mo mp mq b">nextPageToken</code>，<strong class="is hj">跳转到列表步骤，新的</strong> <code class="du mn mo mp mq b"><strong class="is hj">pageToken</strong></code> <strong class="is hj">值设置</strong>。</li></ul><h2 id="c888" class="lz jz hi bd ka ma mb mc ke md me mf ki jb mg mh km jf mi mj kq jj mk ml ku mm bi translated">代码</h2><p id="ea78" class="pw-post-body-paragraph iq ir hi is b it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj la jl jm jn hb bi translated">下面是一个代码示例。</p><pre class="mr ms mt mu fd mv mq mw mx aw my bi"><span id="3e94" class="lz jz hi mq b fi mz na l nb nc">main:<br/>  params: [param]<br/>  steps:<br/>    - assignStep:<br/>        assign:<br/>          - sourceDataset: ${param.source_dataset}<br/>          - targetDataset: ${default(map.get(param, "target_dataset"),sourceDataset + "_backup")}<br/>          - projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}<br/>          - location: "US"<br/>          - maxResult: 100<br/>          - pageToken: ""<br/>    - check-target-dataset:<br/>        try:<br/>          call: googleapis.bigquery.v2.datasets.get<br/>          args:<br/>            projectId: ${projectId}<br/>            datasetId: ${targetDataset}<br/>        except:<br/>          as: e<br/>          steps:<br/>            - known_errors:<br/>                switch:<br/>                  - condition: ${e.code == 404} <em class="lq">#Create dataset<br/>                    </em>steps:<br/>                      - create-target-dataset:<br/>                          call: googleapis.bigquery.v2.datasets.insert<br/>                          args:<br/>                            projectId: ${projectId}<br/>                            body:<br/>                               location: ${location}<br/>                               datasetReference:<br/>                                 datasetId: ${targetDataset}<br/>                                 projectId: ${projectId}<br/>                               defaultTableExpirationMs: 604800000 <em class="lq">#Snapshot expire after 7 days<br/>                          </em>next: list-tables<br/>            - unhandled_exception:<br/>                raise: ${e}<br/>    - list-tables:<br/>        call: googleapis.bigquery.v2.tables.list<br/>        args:<br/>          datasetId: ${sourceDataset}<br/>          projectId: ${projectId}<br/>          maxResults: ${maxResult}<br/>          pageToken: ${pageToken}<br/>        result: listResult<br/>    - perform-snapshots:<br/>        parallel:<br/>          for:<br/>            value: table<br/>            in: ${listResult.tables}<br/>            steps:<br/>              - snapshot:<br/>                  call: googleapis.bigquery.v2.jobs.insert<br/>                  args:<br/>                    projectId: ${projectId}<br/>                    body:<br/>                      configuration:<br/>                        copy:<br/>                          destinationTable:<br/>                            datasetId: ${targetDataset}<br/>                            projectId: ${projectId}<br/>                            tableId: ${table.tableReference.tableId}<br/>                          operationType: "SNAPSHOT"<br/>                          sourceTables:<br/>                            - projectId: ${projectId}<br/>                              datasetId: ${sourceDataset}<br/>                              tableId: ${table.tableReference.tableId}<br/>                          writeDisposition: "WRITE_EMPTY"<br/>    - check-iterate-pages:<br/>        switch:<br/>          - condition: ${default(map.get(listResult, "nextPageToken"),"") != ""}<br/>            steps:<br/>              - loop-over-pages:<br/>                  assign:<br/>                    - pageToken: ${listResult.nextPageToken}<br/>                  next: list-tables</span></pre><p id="d1d5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用以下命令部署您的工作流</p><pre class="mr ms mt mu fd mv mq mw mx aw my bi"><span id="4947" class="lz jz hi mq b fi mz na l nb nc">gcloud workflows deploy &lt;workflowName&gt; \<br/> --source=&lt;workflowFileName&gt; \<br/> --service-account=&lt;runtimeServiceAccountEmail&gt;</span></pre><p id="8d7c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lq">运行时服务帐户</em> <strong class="is hj"> <em class="lq">必须在目标项目上拥有BigQuery管理员角色</em> </strong> <em class="lq">才能创建目标数据集和快照；只有</em> <strong class="is hj"> <em class="lq">成为源数据集上的数据查看器</em> </strong> <em class="lq">。</em></p><p id="94e3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并运行它</p><pre class="mr ms mt mu fd mv mq mw mx aw my bi"><span id="b7d4" class="lz jz hi mq b fi mz na l nb nc">gcloud workflows run &lt;workflowName&gt; \<br/>  --data='{"source_dataset":"&lt;YourDataset&gt;"}'</span></pre><p id="30f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lq">您可以使用云调度程序定期调用该工作流</em></p><h1 id="9af8" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj lr kl km kn ls kp kq kr lt kt ku kv bi translated">保护您最珍贵的资产</h1><p id="1996" class="pw-post-body-paragraph iq ir hi is b it kw iv iw ix kx iz ja jb ky jd je jf kz jh ji jj la jl jm jn hb bi translated">这个工作流程非常简单明了。还有<strong class="is hj">限制</strong>。例如:</p><ul class=""><li id="ef91" class="lc ld hi is b it iu ix iy jb le jf lf jj lg jn lh li lj lk bi translated"><strong class="is hj">您不能连续运行工作流程两次</strong>，因为快照将会存在，并且您将会遇到<em class="lq">已经存在</em>的错误。<br/> <em class="lq">您可以在目标数据集中添加日期，例如</em></li><li id="2810" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><strong class="is hj">源项目和目标项目</strong>相同。<br/> <em class="lq">你应该希望有一个快照项目为例。</em></li><li id="61ab" class="lc ld hi is b it ll ix lm jb ln jf lo jj lp jn lh li lj lk bi translated"><strong class="is hj">目标数据集区域是硬编码的</strong>(并且必须是与源数据集相同的<strong class="is hj">)<br/><em class="lq">您可以获取源数据集，获取该区域，并在与源数据集相同的区域中创建目标数据集。</em></strong></li></ul><p id="5c4e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">无论如何，这是一个保护您公司中最珍贵的东西的基本示例:<strong class="is hj">您的数据资产</strong></p></div></div>    
</body>
</html>