<html>
<head>
<title>Kubernetes ConfigMaps and Secrets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes配置图和秘密</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/kubernetes-configmaps-and-secrets-68d061f7ab5b?source=collection_archive---------0-----------------------#2017-07-13">https://medium.com/google-cloud/kubernetes-configmaps-and-secrets-68d061f7ab5b?source=collection_archive---------0-----------------------#2017-07-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b005" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个人都需要配置应用程序。您经常需要引用“特殊”的数据，比如API密钥、令牌和其他秘密。您的应用程序可以使用配置设置进行调整，例如PHP.ini文件，或者更改应用程序逻辑的环境变量和标志。</p><p id="feb9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能想将这些引用硬编码到您的应用程序逻辑中。在小型的独立应用程序中，这可能是可以接受的，但在任何合理规模的应用程序中，这很快就变得难以管理了。</p><p id="0312" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，我们已经解决了这个问题。您可以使用环境变量和配置文件将这些信息存储在一个“中心位置”，并从我们的应用程序中引用这些信息。当您想要更改配置时，只需在文件中更改或更改环境变量，就可以了！不需要搜寻引用数据的每个位置。</p><p id="39a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个问题在容器和微服务领域变得更加严重。Docker允许您在docker文件中指定环境变量，但是如果您需要在两个不同的容器中引用相同的数据呢？如果您尝试使用主机环境，那么当您在具有多台机器的集群上运行时会发生什么？</p><p id="d9ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们来看一个硬编码配置的应用程序，将其更改为从环境变量中读取，最后设置Kubernetes来为您管理配置。</p><p id="f02c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第二部分中，我将使用一个配置文件来代替环境变量。</p><p id="d34a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">所有代码都位于此Gist:</strong><a class="ae jd" href="https://gist.github.com/thesandlord/6e297d7ceb807e6f0243255ab7885d83" rel="noopener ugc nofollow" target="_blank">https://Gist . github . com/thesandlord/6e 297d 7 CEB 807 e6f 0243255 ab 7885d 83</a></p><h1 id="34ce" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">硬编码的应用</h1><p id="af99" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这是这款应用的所有硬编码荣耀:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/f97f277ab7dd5b60787eb4648a72e158.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*czZyDkQaw4Oh0UVcn3oiJg.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated"><a class="ae jd" href="https://gist.github.com/thesandlord/6e297d7ceb807e6f0243255ab7885d83#file-hardcode-js" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/the sand Lord/6e 297d 7 CEB 807 e6f 0243255 ab 7885d 83 # file-hard code-js</a></figcaption></figure><p id="945b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想改变语言或者API键，你需要修改代码。这可能会导致错误、安全漏洞，并污染源代码历史。</p><p id="e8be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们转而使用环境变量。</p><h1 id="efe8" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">步骤1:使用环境变量</h1><p id="59bc" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">转移到环境变量很容易。大多数编程语言都有内置的阅读方式。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kx"><img src="../Images/6c696e185386b2d6816f1d05bbc908dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4H447Yh3mzxYoIeU8p8MXw.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated"><a class="ae jd" href="https://gist.github.com/thesandlord/6e297d7ceb807e6f0243255ab7885d83#file-envvars-js" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/the sand Lord/6e 297d 7 CEB 807 e6f 0243255 ab 7885d 83 # file-env vars-js</a></figcaption></figure><p id="dcf3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就够了！</p><p id="8221" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以设置这些环境变量，而不必接触应用程序的代码</p><p id="1d8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Unix系统(如MacOS和Linux)中，您可以运行此命令为当前会话设置环境变量:</p><pre class="ki kj kk kl fd ky kz la lb aw lc bi"><span id="03e0" class="ld jf hi kz b fi le lf l lg lh">export LANGUAGE=English</span><span id="74d7" class="ld jf hi kz b fi li lf l lg lh">export API_KEY=123–456–789</span></pre><p id="8fbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于Windows，您可以使用以下命令:</p><pre class="ki kj kk kl fd ky kz la lb aw lc bi"><span id="ca0a" class="ld jf hi kz b fi le lf l lg lh">setx LANGUAGE “English”</span><span id="9ee4" class="ld jf hi kz b fi li lf l lg lh">setx API_KEY “123–456–789”</span></pre><p id="3c73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您也可以在启动服务器时设置环境变量。</p><p id="1a28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，对于这个Node.js应用程序，您可以运行:</p><pre class="ki kj kk kl fd ky kz la lb aw lc bi"><span id="9d60" class="ld jf hi kz b fi le lf l lg lh">LANGUAGE=Spanish API_KEY=0987654 npm start</span></pre><p id="f733" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">而这些都会暴露在app里。</p><h1 id="ac93" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">步骤2:转移到Docker环境变量</h1><p id="5c6f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">当您转向容器化的解决方案时，您将不再依赖于主机的环境变量。每个容器都有自己的环境，所以确保正确配置容器的环境是很重要的。幸运的是，Docker使得构建内置环境变量的容器变得很容易。在docker文件中，可以用ENV指令指定它们。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lj"><img src="../Images/e66e15e4b0dfeaf3a477a50d67ec204f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WzxES06e3i0vk09cBtslYQ.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated"><a class="ae jd" href="https://gist.github.com/thesandlord/6e297d7ceb807e6f0243255ab7885d83#file-dockerfile" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/the sand Lord/6e 297d 7 CEB 807 e6f 0243255 ab 7885d 83 # file-docker file</a></figcaption></figure><p id="718e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将docker文件放在与代码相同的目录中。</p><p id="264a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后构建容器:</p><pre class="ki kj kk kl fd ky kz la lb aw lc bi"><span id="4037" class="ld jf hi kz b fi le lf l lg lh">docker build -t envtest .</span></pre><p id="a07c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">构建容器后，使用以下命令运行它:</p><pre class="ki kj kk kl fd ky kz la lb aw lc bi"><span id="5165" class="ld jf hi kz b fi le lf l lg lh">docker run -p 3000:3000 -ti envtest</span></pre><p id="34ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在命令行上运行时，也可以覆盖环境变量:</p><pre class="ki kj kk kl fd ky kz la lb aw lc bi"><span id="ccb4" class="ld jf hi kz b fi le lf l lg lh">docker run -e LANGUAGE=Spanish -e API_KEY=09876 -p 3000:3000 \<br/>           -ti envtest</span></pre><h1 id="4346" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">步骤3:转移到Kubernetes环境变量</h1><p id="5372" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">当从Docker转移到Kubernetes时，事情再次发生了变化。您可能会在多个kubernetes部署中使用同一个Docker容器，或者您可能希望在使用不同配置的同一个容器的部署中进行A/B测试。</p><p id="f6c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就像docker文件一样，您可以在Kubernetes部署YAML文件中直接指定环境变量。这意味着每个部署可以获得一个定制的环境。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lk"><img src="../Images/27244e5fcccc51b23c3c0a5b5b5f40b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PRWA_Rb229u3zvUBe5a6Kg.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated"><a class="ae jd" href="https://gist.github.com/thesandlord/6e297d7ceb807e6f0243255ab7885d83#file-embededenv-yaml" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/the sand Lord/6e 297d 7 CEB 807 e6f 0243255 ab 7885d 83 # file-embedded env-YAML</a></figcaption></figure><p id="3f27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">重要的部分是pod规范的<strong class="ih hj">包络</strong>部分。您可以在这里指定任意数量的环境变量。这两个环境变量现在都是通过Kubernetes设置的！</p><h1 id="e001" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">步骤4:使用Kubernetes秘密和配置图进行集中配置</h1><p id="6a58" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">Docker和Kubernetes环境变量的不足之处在于它们与容器或部署相关联。如果您想要更改它们，您必须重新构建容器或修改部署。更糟糕的是，如果您想在多个容器或部署中使用该变量，您必须复制数据！</p><p id="8bea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谢天谢地，Kubernetes用Secrets(针对机密数据)和ConfigMaps(针对非机密数据)解决了这个问题。</p><p id="9d87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">机密和配置映射之间的最大区别是机密是用Base64编码进行模糊处理的。将来可能会有更多的不同，但是对机密数据(如API密钥)使用Secrets，对非机密数据(如端口号)使用ConfigMaps是一种很好的做法。</p><p id="eb3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们将API密钥保存为一个秘密:</p><pre class="ki kj kk kl fd ky kz la lb aw lc bi"><span id="0b97" class="ld jf hi kz b fi le lf l lg lh">kubectl create secret generic apikey --from-literal=API_KEY=123–456</span></pre><p id="0a7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以及作为配置图的语言:</p><pre class="ki kj kk kl fd ky kz la lb aw lc bi"><span id="8d5d" class="ld jf hi kz b fi le lf l lg lh">kubectl create configmap language --from-literal=LANGUAGE=English</span></pre><p id="81ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用以下命令检查这些文件是否已创建:</p><pre class="ki kj kk kl fd ky kz la lb aw lc bi"><span id="d14b" class="ld jf hi kz b fi le lf l lg lh">kubectl get secret</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es ll"><img src="../Images/161b7a2efa250bca38de34af210a44a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dYNeYavMzde-48NveDYFWA.png"/></div></div></figure><p id="70ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和</p><pre class="ki kj kk kl fd ky kz la lb aw lc bi"><span id="bdd4" class="ld jf hi kz b fi le lf l lg lh">kubectl get configmap</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es lm"><img src="../Images/403f700b48749b49846a88ea05937470.png" data-original-src="https://miro.medium.com/v2/resize:fit:652/format:webp/1*7pywNEhe41JiIiYvd5MANw.png"/></div></figure><p id="373a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以修改Kubernetes部署来读取这些值，而不是硬编码的值。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es lk"><img src="../Images/8d0d18c00ffdc6eaff3f01c4e899c095.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W6fl4ve9pzAHHDlQmep08g.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated"><a class="ae jd" href="https://gist.github.com/thesandlord/6e297d7ceb807e6f0243255ab7885d83#file-final-yaml" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/the sand Lord/6e 297d 7 CEB 807 e6f 0243255 ab 7885d 83 # file-final-YAML</a></figcaption></figure><h1 id="33e4" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">更新机密和配置映射</h1><p id="d5a4" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">如上所述，让Kubernetes为您管理环境变量意味着当您想要更改变量值时，您不必更改代码或重新构建容器。</p><p id="1fc4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为pods在启动时缓存环境变量的值，所以这是一个两步过程。</p><p id="1f4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，更新值:</p><pre class="ki kj kk kl fd ky kz la lb aw lc bi"><span id="8f7b" class="ld jf hi kz b fi le lf l lg lh">kubectl create configmap language --from-literal=LANGUAGE=Spanish \</span><span id="a780" class="ld jf hi kz b fi li lf l lg lh">        -o yaml --dry-run | kubectl replace -f -</span><span id="912b" class="ld jf hi kz b fi li lf l lg lh">kubectl create secret generic apikey --from-literal=API_KEY=098765 \</span><span id="4703" class="ld jf hi kz b fi li lf l lg lh">        -o yaml --dry-run | kubectl replace -f -</span></pre><p id="6c8f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，重启吊舱。这可以通过多种方式实现，例如强制进行新的部署。快速简单的方法是手动删除pod，并让部署自动启动新的pod。</p><pre class="ki kj kk kl fd ky kz la lb aw lc bi"><span id="e934" class="ld jf hi kz b fi le lf l lg lh">kubectl delete pod -l name=envtest</span></pre><p id="5756" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就够了！您的应用程序现在将使用新值！</p><p id="8174" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" rel="noopener" href="/google-cloud/kubernetes-configmaps-and-secrets-part-2-3dc37111f0dc">在第二部分</a>，我将向您展示如何使用配置文件，在Kubernetes中，配置文件比环境变量更强大。</p></div></div>    
</body>
</html>