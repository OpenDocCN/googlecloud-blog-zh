<html>
<head>
<title>The Key Wars Story</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关键的战争故事</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/the-key-wars-story-a65bb9dabe56?source=collection_archive---------3-----------------------#2021-05-18">https://medium.com/google-cloud/the-key-wars-story-a65bb9dabe56?source=collection_archive---------3-----------------------#2021-05-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/74630630497ad93a37319173f2803c0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_wMoNrp_NLZNIQW_zTELnw.png"/></div></div></figure><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es iq"><img src="../Images/e24cbc952434663547dc6cc98fadc4a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lj7QSCt9v8TfeofyIOKJ8g.png"/></div></div></figure><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es iv"><img src="../Images/3348ce9e1bfadf8c6d94c38ed83a75bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DCV0ji-DQgOp3KDs2DJdlA.png"/></div></div></figure></div><div class="ab cl iw ix gp iy" role="separator"><span class="iz bw bk ja jb jc"/><span class="iz bw bk ja jb jc"/><span class="iz bw bk ja jb"/></div><div class="hb hc hd he hf"><p id="9f6e" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">但是很抱歉这不是我们生活的世界！一个你必须保护自己和资源的世界。因为我们使用云资源，所以我们选择的安全机制可能是架构中最重要的部分。</p><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kb"><img src="../Images/2b7d1d31496fe474462d71413dc0bdf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4n5JI6_6tEhqQplvXkD3GA.png"/></div></div></figure><p id="def3" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">正如您在此处看到的<a class="ae kc" href="https://cloud.google.com/blog/products/identity-security/how-to-authenticate-service-accounts-to-help-keep-applications-secure" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj"/></a>，由谷歌推荐，在为您的服务帐户使用密钥之前，您有许多不同的选项不需要密钥，例如:</p><ul class=""><li id="ebce" class="kd ke hi jf b jg jh jk jl jo kf js kg jw kh ka ki kj kk kl bi translated"><strong class="jf hj">工作量标识</strong></li><li id="9182" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated"><strong class="jf hj">服务帐户的默认凭证</strong></li></ul><p id="d945" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">但是在某些特定的用例中，您最终真的需要一个密钥…比如将您的本地遗留应用程序连接到云。</p><p id="9841" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">服务帐户密钥允许应用程序作为服务帐户进行身份验证，类似于用户使用用户名和密码进行身份验证，但不使用密码！</p><p id="370d" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">一个密钥的问题在于它的生命周期，你可以通过我写的另一篇文章<a class="ae kc" rel="noopener" href="/google-cloud/dear-keys-are-you-still-alive-ad7c73ce63b9"> <strong class="jf hj">这里</strong> </a>来监控发生了什么。</p></div><div class="ab cl iw ix gp iy" role="separator"><span class="iz bw bk ja jb jc"/><span class="iz bw bk ja jb jc"/><span class="iz bw bk ja jb"/></div><div class="hb hc hd he hf"><p id="199f" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">但是这还不够，这可能是因为在这个领域中缺少的最重要的特性是在生成密钥时设置到期日期的可能性。这在今天的GCP是不可能的(比如在Azure上是可能的)。</p><p id="2f5a" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">谷歌告诉我，这两个重要的配置必须用来解决我的问题:</p><ul class=""><li id="0e8f" class="kd ke hi jf b jg jh jk jl jo kf js kg jw kh ka ki kj kk kl bi translated"><strong class="jf hj">使用IAM下的条件设置访问截止日期</strong></li><li id="29c3" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated"><strong class="jf hj">使用密钥工厂解决方案(最著名的是Hashicorp保险库)</strong></li></ul><p id="998f" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我对这两点的看法是:</p><ul class=""><li id="c67d" class="kd ke hi jf b jg jh jk jl jo kf js kg jw kh ka ki kj kk kl bi translated">IAM条件是不够的，首先是因为BigQuery不接受数据集级别的条件，其次是因为我不想每隔XX天就必须回到IAM下更新配置。</li><li id="e329" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">密钥工厂是最好的选择，但不是Hashicorp，因为我不想为一个黑盒子付费，我也不想部署一个基于GKE +许多不同功能的复杂技术。</li></ul><p id="193e" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在我的公司里，我们尽可能地推广和喜爱无服务器技术。</p><p id="124e" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">所以现在我们来了，为什么不试着建立我们自己的<strong class="jf hj">无服务器密钥工厂</strong>？哦耶！</p><p id="09ea" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在与可能是最疯狂的安全谷歌人Seth Vargo讨论之后，我们找到了共同点！</p><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kt"><img src="../Images/a19730dfd8992d9c13be13253a5a444c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kn4kHDaY21I3NY3b1Orxrg.png"/></div></div></figure><p id="6767" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">遵循谷歌的建议:</p><p id="aabd" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><em class="ku">“安全最佳实践是定期轮换您的服务帐户密钥。您可以通过创建新密钥、切换应用程序以使用新密钥，然后删除旧密钥来轮换密钥。结合使用</em> <code class="du kv kw kx ky b"><strong class="jf hj"><em class="ku">serviceAccount.keys.create()</em></strong></code> <em class="ku">方法和</em> <code class="du kv kw kx ky b"><strong class="jf hj"><em class="ku">serviceAccount.keys.delete()</em></strong></code> <em class="ku">方法来自动旋转。”</em></p><p id="268c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><a class="ae kc" href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys" rel="noopener ugc nofollow" target="_blank"> <em class="ku">谷歌云。</em>T12】</a></p><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/117184f668e329185359424c431d60de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iffuOnBzf7aOo2kBP1FQzw.png"/></div></div></figure><p id="ecb8" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jf hj">我正在做的是:</strong></p><ul class=""><li id="ae0f" class="kd ke hi jf b jg jh jk jl jo kf js kg jw kh ka ki kj kk kl bi translated">在组织级别，我们部署了<code class="du kv kw kx ky b"><strong class="jf hj">constraints/iam.disableServiceAccountKeyCreation</strong></code>组织策略，防止用户创建用户管理的服务帐户密钥</li><li id="cfc3" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">选择一个GCP项目(我公司的每个区域或实体),在该项目中不会激活策略，并且将生成所有密钥</li><li id="fa57" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">在人类第一次请求后，部署一个管道来提供一个密钥(批准与否取决于用例),并直接向软件提供所有的密钥更新</li></ul><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es la"><img src="../Images/2306cfefed121e52b1de67ad734bf8a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1NQT8k2nPWx92BUQhChsnw.png"/></div></div></figure><p id="6d63" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这张图表需要一些解释</p><ul class=""><li id="26f2" class="kd ke hi jf b jg jh jk jl jo kf js kg jw kh ka ki kj kk kl bi translated">第一个请求是由X先生通过ServiceNow门户提出的，他试图解释为什么他真的需要一个密钥，在安全团队批准之后，就可以创建密钥了</li><li id="fe45" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">续订请求将由软件本身通过发布/订阅主题直接提出，这是经典的方式！</li><li id="c57c" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">来自工厂的功能开发被推送到CloudBuild正在观察的repo，因为我们已经将上一个云工作流版本的YAML文件放在一个桶中，以便稍后能够使用Terraform部署它(目前只允许您从GCS导入YAML文件)</li></ul></div><div class="ab cl iw ix gp iy" role="separator"><span class="iz bw bk ja jb jc"/><span class="iz bw bk ja jb jc"/><span class="iz bw bk ja jb"/></div><div class="hb hc hd he hf"><h1 id="15bb" class="lb lc hi bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">现在让我们深入工厂内部:</h1><p id="599b" class="pw-post-body-paragraph jd je hi jf b jg lz ji jj jk ma jm jn jo mb jq jr js mc ju jv jw md jy jz ka hb bi translated"><strong class="jf hj">在API网关接收到来自ServiceNow的安全调用后，云功能正在准备消息以供云构建理解:</strong></p><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/f2b437732c6ce64c7f62bb90d3bb64d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V4mzjhWeTsybLMyIKtfi-A.png"/></div></div></figure><ul class=""><li id="fef9" class="kd ke hi jf b jg jh jk jl jo kf js kg jw kh ka ki kj kk kl bi translated">第一步是在区域的特定项目中部署关键工厂(其中禁用了org策略，只有少数人有权限)，从云存储中获取YAML工作流文件，并使用Terraform进行部署</li><li id="3598" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">第二步是完全运行工作流以提供SA密钥</li><li id="b17d" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">第三步是允许请求者读取存储在秘密管理器中的密钥</li><li id="ed91" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">最后一步(如果请求来自ServiceNow)是调用ServiceNow来关闭带有请求信息的请求。</li></ul><p id="fae0" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jf hj">现在我们来深入了解一下云工作流部分(上面刚刚解释的第二步):</strong></p><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mf"><img src="../Images/8f680a1e840fe7aac81664a8181df5b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j-FtNHX86l4tUglZTPnnxA.png"/></div></div></figure><ul class=""><li id="5ab9" class="kd ke hi jf b jg jh jk jl jo kf js kg jw kh ka ki kj kk kl bi translated">如您所见，我试图知道服务协议是否已经存在(如果不存在，我创建它)</li><li id="383c" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">其次，我从SA创建密钥(即使另一个已经存在，因为可能是更新时间)</li><li id="2a00" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">第三，我创建一个与这个密钥相关的秘密(或者只是检查这个秘密是否已经存在)</li><li id="9400" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">第四，我添加密钥有效载荷作为秘密的最后版本</li><li id="8d94" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">最后是监控部分，意思是在FireStore中插入一个文档，说明:</li></ul><p id="ba1c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><em class="ku">“密钥XXX已经在2021年11月5日20:10被创建，它存储在秘密XYZ中。”</em></p><p id="a2e3" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">使用的完整云工作流代码可从<a class="ae kc" href="https://github.com/antoinecastex/key_factory/blob/main/main.yaml" rel="noopener ugc nofollow" target="_blank">这里</a>获得</p></div><div class="ab cl iw ix gp iy" role="separator"><span class="iz bw bk ja jb jc"/><span class="iz bw bk ja jb jc"/><span class="iz bw bk ja jb"/></div><div class="hb hc hd he hf"><p id="09d4" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jf hj">现在我必须通知请求者有些东西是可用的。</strong></p><p id="1728" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">请求者正在收听一个PubSub主题，这是一个好消息，因为Google刚刚引入了一个可能性，当一个秘密的新版本发布时，可以自动发布一个主题的消息(无需您的任何代码)。这里看<a class="ae kc" href="https://cloud.google.com/secret-manager/docs/event-notifications" rel="noopener ugc nofollow" target="_blank">这里看</a>。</p><p id="8408" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我的请求者(无论他们是用户还是软件)将使用它来通知他们何时可以使用他们的续订:)</p></div><div class="ab cl iw ix gp iy" role="separator"><span class="iz bw bk ja jb jc"/><span class="iz bw bk ja jb jc"/><span class="iz bw bk ja jb"/></div><div class="hb hc hd he hf"><p id="ed6c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jf hj">最后，也是最重要的，清洁部分:</strong></p><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mg"><img src="../Images/65758f08ddb86323de4d82f0b74c4389.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZgKrscXfQqrxukw4rPzZGA.png"/></div></div></figure><p id="5749" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jf hj">每天早上8点，云调度程序将调用云工作流来:</strong></p><ul class=""><li id="8d76" class="kd ke hi jf b jg jh jk jl jo kf js kg jw kh ka ki kj kk kl bi translated">询问Firestore哪些文件与超过90天的钥匙相关？</li><li id="9dac" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">删除相关的IAM键</li><li id="c7d7" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">删除相关机密</li><li id="8a37" class="kd ke hi jf b jg km jk kn jo ko js kp jw kq ka ki kj kk kl bi translated">更新firestore文档</li></ul><p id="2af9" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jf hj">结论:</strong></p><p id="6844" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我有一些非常轻的东西，可以部署在我想部署的地方，而且不需要任何成本。因为您可能知道，云工作流定价模式非常便宜(前5 000步是免费的), Secret每个版本每个位置只需0.06美元…</p><p id="6eeb" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">最后，我必须通知人们，从创建第一个密钥的那一刻起，他们有责任在接下来的90天内回来请求续订，否则当前密钥将被自动删除…</p></div></div>    
</body>
</html>