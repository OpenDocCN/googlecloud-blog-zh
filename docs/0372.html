<html>
<head>
<title>Securing Kubernetes Cluster Networking</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保护Kubernetes集群网络</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/securing-kubernetes-cluster-networking-cec708b82510?source=collection_archive---------0-----------------------#2017-09-05">https://medium.com/google-cloud/securing-kubernetes-cluster-networking-cec708b82510?source=collection_archive---------0-----------------------#2017-09-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="03ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">网络策略是Kubernetes的一项新功能，用于配置允许分组之间以及与其他网络端点之间进行通信的方式。换句话说，它在Kubernetes集群上运行的pod之间创建了防火墙。本指南旨在解释Kubernetes网络政策的未成文部分。</p><p id="8fad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个特性在Kubernetes 1.7版本中已经变得稳定。在本指南中，我将解释网络策略在理论和实践中是如何工作的。你可以直接跳转到<a class="ae jd" href="https://github.com/ahmetb/kubernetes-networkpolicy-tutorial" rel="noopener ugc nofollow" target="_blank">kubernetes-Network policy-tutorial</a>知识库获取网络政策的例子或者阅读<a class="ae jd" href="https://kubernetes.io/docs/concepts/services-networking/network-policies/" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="c407" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">你能用网络策略做什么</h1><p id="2659" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">默认情况下，Kubernetes不会限制集群内部运行的pod之间的流量。这意味着任何pod都可以连接到任何其他pod，因为没有防火墙控制群集内的流量。</p><p id="20bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">网络策略为您提供了一种以声明方式配置允许哪些pod相互连接的方法。这些策略可以很详细:您可以指定允许哪些名称空间进行通信，或者更具体地说，您可以选择在哪些端口号上实施每个策略。</p><p id="832f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前，您无法使用此功能对来自pod的传出(出口)流量实施策略。它在Kubernetes 1.8的路线图上。</p><p id="7e5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与此同时，<a class="ae jd" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio </a>开源项目是一个替代方案，它支持egress策略和更多内容，有原生的Kubernetes支持。</p><h1 id="1a86" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">为什么网络策略很酷</h1><p id="6972" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">网络策略是ACL(访问控制列表)在计算中使用了几十年的奇特说法。这是Kubernetes在pod之间进行ACLs的方式。就像任何其他Kubernetes资源一样，网络策略是通过声明性清单配置的。它们是您的应用程序的一部分，您可以在您的源代码库中修改它们，并将它们与您的应用程序一起部署到Kubernetes。</p><p id="8851" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">近乎实时地应用网络策略。</strong>如果您在pod之间有打开的连接，应用阻止该连接的网络策略将导致连接立即终止。这种近乎实时的增益伴随着网络性能的小幅下降，请阅读<a class="ae jd" href="http://blog.kubernetes.io/2016/09/high-performance-network-policies-kubernetes.html" rel="noopener ugc nofollow" target="_blank">基准测试</a>了解更多信息。</p><h1 id="d781" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">示例使用案例</h1><p id="43a7" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">以下是网络策略的常见使用案例的简要列表。您可以在GitHub上的<a class="ae jd" href="https://github.com/ahmetb/kubernetes-networkpolicy-tutorial" rel="noopener ugc nofollow" target="_blank">kubernetes-network policy-tutorial</a>中找到更多带有示例清单的用例示例。</p><ul class=""><li id="1d4f" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae jd" href="https://github.com/ahmetb/kubernetes-networkpolicy-tutorial/blob/master/01-deny-all-traffic-to-an-application.md" rel="noopener ugc nofollow" target="_blank">拒绝应用程序的所有流量</a></li></ul><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es kq"><img src="../Images/ae75201a5ccd5db8ca2c88ebb29d5eaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5--sKtvcnIXG0d3j.gif"/></div></div></figure><ul class=""><li id="3ff8" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae jd" href="https://github.com/ahmetb/kubernetes-networkpolicy-tutorial/blob/master/02-limit-traffic-to-an-application.md" rel="noopener ugc nofollow" target="_blank">限制应用程序的流量</a></li></ul><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es kq"><img src="../Images/8b55083d0b649d0a5e4f146b4e4e576c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dj-IUej8gPWi4dXp.gif"/></div></div></figure><ul class=""><li id="f1ef" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae jd" href="https://github.com/ahmetb/kubernetes-networkpolicy-tutorial/blob/master/03-deny-all-non-whitelisted-traffic-in-the-namespace.md" rel="noopener ugc nofollow" target="_blank">拒绝名称空间中所有非白名单流量</a></li></ul><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es lc"><img src="../Images/d25b3dfb0591063a4fdec69a0a75398e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*q2HdFEseEVaP4yGk.gif"/></div></div></figure><ul class=""><li id="75ff" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae jd" href="https://github.com/ahmetb/kubernetes-networkpolicy-tutorial/blob/master/04-deny-traffic-from-other-namespaces.md" rel="noopener ugc nofollow" target="_blank">拒绝来自其他名称空间的所有流量</a></li></ul><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es lc"><img src="../Images/05a4a92d24280bcc2a81bd974695d59b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yUn1ww1RDKWt40ma.gif"/></div></div></figure><ul class=""><li id="faf0" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae jd" href="https://github.com/ahmetb/kubernetes-networkpolicy-tutorial/blob/master/06-allow-traffic-from-a-namespace.md" rel="noopener ugc nofollow" target="_blank">允许来自其他名称空间的流量</a></li></ul><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es lc"><img src="../Images/8445254d3974166264f098f9887b7b13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*w2Te-dMAehsMxRN5.gif"/></div></div></figure><ul class=""><li id="8268" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated"><a class="ae jd" href="https://github.com/ahmetb/kubernetes-networkpolicy-tutorial/blob/master/08-allow-external-traffic.md" rel="noopener ugc nofollow" target="_blank">允许来自外部客户端的流量</a></li></ul><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es lc"><img src="../Images/38d3983c9905f4893f45fc8ead655b7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HM5UUn0moPgENyEv.gif"/></div></div></figure><h1 id="afd3" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">网络策略是如何实施的</h1><p id="1c30" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">网络策略实现不是Kubernetes的核心功能。尽管您可以向Kubernetes主服务器提交一个NetworkPolicy对象，但是如果您的网络插件没有实现网络策略，它将不会被执行。</p><p id="70de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请参见本页中支持网络策略的网络插件示例。支持策略的网络插件的一些例子是<a class="ae jd" href="https://kubernetes.io/docs/tasks/administer-cluster/calico-network-policy/" rel="noopener ugc nofollow" target="_blank"> Calico </a>和<a class="ae jd" href="https://kubernetes.io/docs/tasks/administer-cluster/weave-network-policy/" rel="noopener ugc nofollow" target="_blank"> Weave Net </a>。</p><p id="e457" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/container-engine" rel="noopener ugc nofollow" target="_blank">谷歌容器引擎(GKE) </a>通过在集群中预装Calico网络插件，为网络策略提供alpha支持。</p><p id="203b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">网络策略适用于连接，而不是网络数据包。注意，连接允许双向传输网络数据包。例如，如果Pod A可以连接到Pod B，则Pod B可以在同一连接上回复Pod A。这并不意味着Pod B可以启动与Pod A的连接。</p><h1 id="e6fe" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">网络策略剖析</h1><p id="abc3" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">NetworkPolicy只是Kubernetes API中的另一个对象。您可以为一个群集创建许多策略。网络策略有两个主要部分:</p><ol class=""><li id="d0f6" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc ld kn ko kp bi translated"><strong class="ih hj">目标单元:</strong>哪些单元的入口(传入)网络连接应由策略强制实施？这些窗格是根据它们的标签选择的。</li><li id="4395" class="kh ki hi ih b ii le im lf iq lg iu lh iy li jc ld kn ko kp bi translated"><strong class="ih hj">入口规则:</strong>哪些pod可以连接到目标pod？这些窗格也是通过它们的标签或名称空间来选择的。</li></ol><p id="3044" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个更具体的网络策略清单示例:</p><pre class="kr ks kt ku fd lj lk ll lm aw ln bi"><span id="a487" class="lo jf hi lk b fi lp lq l lr ls">kind: NetworkPolicy<br/>apiVersion: networking.k8s.io/v1<br/>metadata:<br/>  name: api-allow<br/>spec:<br/>  podSelector:<br/>    matchLabels:<br/>      app: bookstore<br/>      role: api<br/>  ingress:<br/>  - from:<br/>      - podSelector:<br/>          matchLabels:<br/>            app: bookstore<br/>  - from:<br/>      - podSelector:<br/>          matchLabels:<br/>            app: inventory</span></pre><p id="f1b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个示例策略允许带有<code class="du lt lu lv lk b">app=bookstore</code>或<code class="du lt lu lv lk b">app=inventory</code>标签的pod连接到带有<code class="du lt lu lv lk b">app=bookstore</code>和<code class="du lt lu lv lk b">role=api</code>标签的pod。你可以把这理解为“让书店应用的微服务访问书店API”。</p><h1 id="fe9e" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">如何评估网络策略</h1><p id="9146" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">尽管网络策略的<a class="ae jd" href="https://github.com/kubernetes/community/blob/b77ecdb66c2c77d1fc36b0b87e8caa5bca6aff88/contributors/design-proposals/network-policy.md#behavior" rel="noopener ugc nofollow" target="_blank">设计文档</a>和<a class="ae jd" href="https://kubernetes.io/docs/api-reference/v1.7/#networkpolicyspec-v1-networking" rel="noopener ugc nofollow" target="_blank"> API参考</a>可能看起来很复杂，但我还是设法将其分解为几个简单的规则:</p><ul class=""><li id="87ca" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">如果网络策略选择了一个pod，则发往该pod的流量将受到限制。</li><li id="3edf" class="kh ki hi ih b ii le im lf iq lg iu lh iy li jc km kn ko kp bi translated">如果没有为pod定义网络策略，则所有命名空间中的所有pod都可以连接到该pod。这意味着默认情况下，如果没有为特定的pod定义网络策略，则存在一个隐含的“允许全部”。</li><li id="1eb1" class="kh ki hi ih b ii le im lf iq lg iu lh iy li jc km kn ko kp bi translated">如果到Pod A的流量受到限制，而Pod B需要连接到Pod A，则至少应该有一个选择Pod A的网络策略，该策略有一个选择Pod B的入口规则</li></ul><p id="3234" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当涉及到跨名称空间网络时，事情变得有点复杂。简而言之，它是这样工作的:</p><ul class=""><li id="3c2b" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">网络策略只能对与部署网络策略的pod位于同一命名空间的连接实施规则。</li><li id="89d3" class="kh ki hi ih b ii le im lf iq lg iu lh iy li jc km kn ko kp bi translated"><code class="du lt lu lv lk b">podSelector</code>入口规则只能选择部署网络策略的同一命名空间中的pod。</li><li id="fa6c" class="kh ki hi ih b ii le im lf iq lg iu lh iy li jc km kn ko kp bi translated">如果Pod A需要连接到另一个名称空间中的Pod B，并且强制实施到Pod B的网络，则Pod B中需要有一个策略，该策略具有选择Pod A的<code class="du lt lu lv lk b">namespaceSelector</code>。</li></ul><h1 id="4c77" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">网络策略是真正的安全吗？</h1><p id="3d0c" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">网络策略限制点对点网络，这是保护群集流量和应用程序的一部分。它们不是执行深度数据包检查的防火墙。</p><p id="4ac2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您不应该仅仅依靠网络策略来保护集群中各单元之间的流量。具有相互认证的TLS(传输层安全性)等方法使您能够加密流量并在微服务之间进行认证。</p><p id="74be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看看<a class="ae jd" href="https://cloud.google.com/security/whitepaper#a_global_network_with_unique_security_benefits" rel="noopener ugc nofollow" target="_blank">谷歌云安全白皮书</a>(重点是我的):</p><blockquote class="lw lx ly"><p id="5aa7" class="if ig lz ih b ii ij ik il im in io ip ma ir is it mb iv iw ix mc iz ja jb jc hb bi translated"><em class="hi">深度防御描述了保护谷歌网络免受外部攻击的多层防御。只有满足我们安全要求的授权服务和协议才允许通过它；其他任何内容都会自动删除。</em> <strong class="ih hj"> <em class="hi">行业标准防火墙和访问控制列表(ACL)用于实施网络隔离。</em> </strong> <em class="hi">所有流量都通过定制的GFE (Google前端)服务器进行路由，以检测和阻止恶意请求和分布式拒绝服务(DDoS)攻击。此外，GFE服务器只允许与内部的受控服务器列表进行通信；</em> <strong class="ih hj"> <em class="hi">这种“默认拒绝”配置可防止GFE服务器访问非预期的资源。</em> </strong> <em class="hi"> […] </em></p><p id="6bc9" class="if ig lz ih b ii ij ik il im in io ip ma ir is it mb iv iw ix mc iz ja jb jc hb bi translated"><em class="hi">数据在互联网上或网络内传输时，容易受到未经授权的访问。[……]前面提到的谷歌前端(GFE)服务器支持</em> <strong class="ih hj"> <em class="hi">强加密协议，如TLS </em> </strong> <em class="hi">以保护客户设备与谷歌的网络服务和API之间的连接。</em></p></blockquote><p id="3b3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我前面所说的，像Istio和linkerd这样的服务网格项目在这个领域提供了有希望的进步。例如，Istio可以使用TLS加密您的微服务之间的流量，并透明地实施网络策略，而无需更改您的应用程序代码。</p><h1 id="ff06" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">了解更多信息</h1><p id="ea5c" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">如果你有兴趣尝试网络策略，最简单的开始方式是<a class="ae jd" href="https://github.com/ahmetb/kubernetes-networkpolicy-tutorial/blob/master/00-create-cluster.md" rel="noopener ugc nofollow" target="_blank">创建一个GKE集群</a>。您还可以阅读:</p><p id="f58f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢Matthew DeLio和Daniel Nardo审阅本文的草稿。</p></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="5ee1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lz">原载于</em> <a class="ae jd" href="https://ahmet.im/blog/kubernetes-network-policy/" rel="noopener ugc nofollow" target="_blank"> <em class="lz"> ahmet.im </em> </a> <em class="lz">。如果你喜欢这篇文章，你可以在Twitter上关注我，或者通过电子邮件订阅我的博客(不超过一篇文章/月)。</em></p><p id="beb9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lz">学到了什么？点击“鼓掌”👏传播消息。</em></p></div></div>    
</body>
</html>