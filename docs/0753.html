<html>
<head>
<title>Google Cloud Storage “exploder” #2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云存储“爆炸者”#2</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/google-cloud-storage-exploder-2-9870d41fcee3?source=collection_archive---------2-----------------------#2018-09-03">https://medium.com/google-cloud/google-cloud-storage-exploder-2-9870d41fcee3?source=collection_archive---------2-----------------------#2018-09-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="6130" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">Golang云函数</h2></div><p id="c5ef" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">地鼠和爆炸！？</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/1b550794b15c08cd2f74c4f658df8800.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1d7i6EWRhO0sAe-4GUUKbg.jpeg"/></div></div></figure><p id="bb1b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">参考:<a class="ae kf" href="https://www.hallmark.com/ornaments/keepsake-ornaments/caddyshack-a-dynamite-gopher-ornament-1595QXI3072.html" rel="noopener ugc nofollow" target="_blank">霍尔马克卡迪沙克地鼠饰品</a></p><p id="5698" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不完全是，但是我仍然很好…</p><p id="e392" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">差不多一年前，我写了一个概念验证节点。JS云函数(这是正确的单数形式吗？)上传到GCS所触发的解压文件:<a class="ae kf" rel="noopener" href="/google-cloud/google-cloud-storage-exploder-221c5b4d219c">爆炸器</a>。</p><p id="4b4b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">随着Golang云函数Alpha ( <a class="ae kf" href="https://docs.google.com/forms/d/e/1FAIpQLSfJ08R2z7FumQyYGGuTyK4x5M-6ch7WmJ_3uWYI5SdZUb5SBw/viewform" rel="noopener ugc nofollow" target="_blank">早期访问</a>)的推出，并受到<a class="kg kh ge" href="https://medium.com/u/1737b4e67578?source=post_page-----9870d41fcee3--------------------------------" rel="noopener" target="_blank"> JBD </a>帖子(<a class="ae kf" rel="noopener" href="/google-cloud/google-cloud-functions-for-go-57e4af9b10da">链接</a>)的启发，特此用Golang进行一次简单的(单线程)重写。</p><h2 id="1917" class="ki kj hi bd kk kl km kn ko kp kq kr ks jg kt ku kv jk kw kx ky jo kz la lb lc bi translated">设置</h2><pre class="ju jv jw jx fd ld le lf lg aw lh bi"><span id="7b51" class="ki kj hi le b fi li lj l lk ll">PROJECT=[[YOUR-PROJECT]]<br/>BILLING=[[YOUR-BILLING]]</span><span id="afe7" class="ki kj hi le b fi lm lj l lk ll">BUCKET_SRC=[[YOUR-SOURCE-BUCKET]]<br/>BUCKET_DST=[[YOUR-OUTPUT-BUCKET]]</span><span id="72fa" class="ki kj hi le b fi lm lj l lk ll">gcloud projects create ${PROJECT}</span><span id="901e" class="ki kj hi le b fi lm lj l lk ll">gcloud beta billing projects link ${PROJECT} \<br/>--billing-account=${BILLING}</span><span id="cacd" class="ki kj hi le b fi lm lj l lk ll">gcloud services enable cloudfunctions.googleapis.com \<br/>--project=${PROJECT}</span><span id="a292" class="ki kj hi le b fi lm lj l lk ll">gsutil mb -c regional -l us-west1 -p ${PROJECT} gs://${BUCKET_SRC}<br/>gsutil mb -c regional -l us-west1 -p ${PROJECT} gs://${BUCKET_DST}</span><span id="9608" class="ki kj hi le b fi lm lj l lk ll"># Go [as usual]<br/>mkdir -p go<br/>export GOPATH=${PWD}/go<br/>go get -u golang.org/x/vgo</span><span id="ac4e" class="ki kj hi le b fi lm lj l lk ll"># Vgo<br/>mkdir -p ${PWD}/vgo/exploder<br/>cd vgo/exploder<br/>touch exploder.go # Copy contents from file below<br/>touch go.mod</span><span id="bc8e" class="ki kj hi le b fi lm lj l lk ll">vgo build &amp;&amp; \<br/>go mod vendor &amp;&amp; \<br/>gcloud alpha functions deploy Exploder \<br/>--entry-point=Exploder \<br/>--runtime go111 \<br/>--set-env-vars=BUCKET_DST=${BUCKET_DST} \<br/>--trigger-resource=${BUCKET_SRC} \<br/>--trigger-event=google.storage.object.finalize \<br/>--project=${PROJECT}</span></pre><p id="8010" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且:</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="0f88" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，给自己找一个压缩文件，上传到<code class="du lp lq lr le b">${BUCKET_SRC}</code>，啜饮咖啡(红酒，取决于一天中的时间)，然后检查<code class="du lp lq lr le b">${BUCKET_DST}</code>:</p><pre class="ju jv jw jx fd ld le lf lg aw lh bi"><span id="1cf4" class="ki kj hi le b fi li lj l lk ll">gsutil cp ${FILE} gs://${BUCKET_SRC}<br/>gsutil ls -r gs://${BUCKET_DST}</span></pre><p id="9ba1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">或者使用云控制台的存储浏览器:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es ls"><img src="../Images/dbfd3beafa2fba11c4a20e3263522d81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RHj7B9F2uLy71zV8P4s_pg.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">来源</figcaption></figure><p id="1c1d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lx"><img src="../Images/16e3ebd6461c605bfc1a62c4b12eba9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Luyi-VgMjTbkqjHpjEpKKA.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">目的地</figcaption></figure><p id="5435" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，稍微复杂一点:</p><pre class="ju jv jw jx fd ld le lf lg aw lh bi"><span id="8a59" class="ki kj hi le b fi li lj l lk ll">tree x<br/>x<br/>├── a<br/>│   └── IMG_13281.jpg<br/>├── b<br/>│   └── IMG_13281.jpg<br/>└── c<br/>    ├── c1<br/>    │   └── IMG_13281.jpg<br/>    └── c2<br/>        └── IMG_13281.jpg</span></pre><p id="b1a0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且:</p><pre class="ju jv jw jx fd ld le lf lg aw lh bi"><span id="121d" class="ki kj hi le b fi li lj l lk ll">gsutil ls -r gs://${BUCKET_DST}<br/>gs://dazwilkin-180903-dst/x/a/:<br/>gs://dazwilkin-180903-dst/x/a/IMG_13281.jpg<br/>gs://dazwilkin-180903-dst/x/b/:<br/>gs://dazwilkin-180903-dst/x/b/IMG_13281.jpg<br/>gs://dazwilkin-180903-dst/x/c/:<br/>gs://dazwilkin-180903-dst/x/c/c1/:<br/>gs://dazwilkin-180903-dst/x/c/c1/IMG_13281.jpg<br/>gs://dazwilkin-180903-dst/x/c/c2/:<br/>gs://dazwilkin-180903-dst/x/c/c2/IMG_13281.jpg</span></pre><h2 id="de3c" class="ki kj hi bd kk kl km kn ko kp kq kr ks jg kt ku kv jk kw kx ky jo kz la lb lc bi translated">更新:2018-09-05-增加了开放式人口普查</h2><p id="3309" class="pw-post-body-paragraph ix iy hi iz b ja ly ij jc jd lz im jf jg ma ji jj jk mb jm jn jo mc jq jr js hb bi translated">由于<a class="kg kh ge" href="https://medium.com/u/1737b4e67578?source=post_page-----9870d41fcee3--------------------------------" rel="noopener" target="_blank"> JBD </a>写了关于使用<a class="ae kf" href="https://opencensus.io/" rel="noopener ugc nofollow" target="_blank"> OpenCensus </a>的文章，我想我应该重温一下这个故事、代码，并添加一个stat来统计解压缩文件的数量(<a class="ae kf" href="https://gist.github.com/DazWilkin/a28c246aa9892384eb3f6bb72c2a65e1" rel="noopener ugc nofollow" target="_blank">链接</a>)和一个对GCS对象创建的跟踪。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es md"><img src="../Images/88fe841563acb657fd62537cd870a942.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3sLTLh-I2jg76WqVUvYLsQ.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">堆栈驱动度量浏览器</figcaption></figure><p id="2ff3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一些结果，虽然我对明显的低比率感到困惑:(</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es me"><img src="../Images/c01a331786d96055e83e63b734b78ca8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aHVUs88npd5ZBusYAYdYbw.png"/></div></div></figure><p id="33d6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">跟踪对我来说更成问题，但我认为这是因为我在部署之间不可靠<code class="du lp lq lr le b">vgo build &amp;&amp; go mod vendor</code>。所以，当你开发代码时，请记住这一点。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es mf"><img src="../Images/3b40518a9aca4f5773fff5ab5852680b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DEjHkC0Fw3h1FqY_m91Uyg.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">堆栈驱动程序跟踪</figcaption></figure><p id="fa17" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">编码的变化是微不足道的。</p><h2 id="160d" class="ki kj hi bd kk kl km kn ko kp kq kr ks jg kt ku kv jk kw kx ky jo kz la lb lc bi translated">结论</h2><p id="8639" class="pw-post-body-paragraph ix iy hi iz b ja ly ij jc jd lz im jf jg ma ji jj jk mb jm jn jo mc jq jr js hb bi translated">Golang云函数运行时是运行时集的一个引人注目的补充(尽管已经过期)。Golang优于Node的一个显著优点是。你的函数可能是多线程的。这个例子主要是节点的直接音译。JS例子。对此的一个很好的改进是使代码多线程化(和异步化)。</p><p id="3d06" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">仅此而已！</p></div></div>    
</body>
</html>