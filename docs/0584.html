<html>
<head>
<title>Kubernetes Engine master|node versions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes引擎主|节点版本</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/kubernetes-engine-master-node-versions-b5ecd9ed0b35?source=collection_archive---------0-----------------------#2018-04-24">https://medium.com/google-cloud/kubernetes-engine-master-node-versions-b5ecd9ed0b35?source=collection_archive---------0-----------------------#2018-04-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="0a39" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">鲁布·戈德堡解决方案</h2></div><blockquote class="ix iy iz"><p id="378f" class="ja jb jc jd b je jf ij jg jh ji im jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated"><strong class="jd hj">更新18–04–25</strong>:末尾增加了一些Golang和一些Python。</p></blockquote><p id="927f" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">我是pernickety，当我创建Kubernetes引擎集群时，我生活在边缘，使用最新的|最棒的主和节点版本。Kubernetes引擎<a class="ae ka" href="https://cloud.google.com/sdk/gcloud/reference/container/clusters/create#--cluster-version" rel="noopener ugc nofollow" target="_blank">默认</a>为‘服务器指定’(<code class="du kb kc kd ke b">defaultClusterVersion</code>)版本，通常不是最新的。</p><p id="8a24" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">然而，在创建集群时，我一直在观察作为<code class="du kb kc kd ke b">cluster-version</code>值提供的版本，因为直到最近，我还不知道如何以编程方式枚举各种可能性:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="8b1d" class="kn ko hi ke b fi kp kq l kr ks">gcloud container get-server-config \<br/>--region=$REGION \<br/>--project=$PROJECT \<br/>--format="json"<br/>Fetching server config for us-west1<br/>{<br/>  "defaultClusterVersion": "1.8.8-gke.0",<br/>  "defaultImageType": "COS",<br/>  "validImageTypes": [<br/>    "COS",<br/>    "UBUNTU"<br/>  ],<br/>  "validMasterVersions": [<br/>    "1.9.6-gke.1",<br/>    "1.9.6-gke.0",<br/>    "1.9.3-gke.0",<br/>    "1.8.10-gke.0",<br/>    "1.8.8-gke.0"<br/>  ],<br/>  "validNodeVersions": [<br/>    "1.9.6-gke.1",<br/>    "1.9.6-gke.0",<br/>    "1.9.3-gke.0",<br/>    "1.9.2-gke.1",<br/>    "1.8.10-gke.0",<br/>    "1.8.8-gke.0",<br/>    "1.8.7-gke.1"<br/>  ]<br/>}</span></pre><blockquote class="ix iy iz"><p id="c376" class="ja jb jc jd b je jf ij jg jh ji im jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated"><strong class="jd hj"> NB </strong>我假设(！)主版本和节点版本同步。到今天为止，最新最好的版本应该是“1.9.6-gke.1”</p></blockquote><p id="98c2" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">那么，我该如何获取这个值呢？</p><p id="650c" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">一个假设是最新版本总是这些列表的第0个元素:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="9731" class="kn ko hi ke b fi kp kq l kr ks">gcloud container get-server-config \<br/>--region=$REGION \<br/>--project=$PROJECT \<br/>--format="value(validMasterVersions[0])"<br/>Fetching server config for us-west1<br/>1.9.6-gke.1</span></pre><p id="43f0" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">但是，这有什么意思呢？-)</p><p id="4296" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated"><a class="ae ka" href="https://stedolan.github.io/jq/" rel="noopener ugc nofollow" target="_blank"> jq </a>来救援…</p><figure class="kf kg kh ki fd kt"><div class="bz dy l di"><div class="ku kv l"/></div></figure><h2 id="4bbb" class="kn ko hi bd kw kx ky kz la lb lc ld le jx lf lg lh jy li lj lk jz ll lm ln lo bi translated">说明</h2><p id="0f84" class="pw-post-body-paragraph ja jb hi jd b je lp ij jg jh lq im jj jx lr jm jn jy ls jq jr jz lt ju jv jw hb bi translated">我们运行和以前一样的<code class="du kb kc kd ke b">gcloud container get-server-config</code>命令。这一次，我们将输出格式化为<code class="du kb kc kd ke b">JSON</code>并通过管道传输到jq。</p><p id="2951" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">为了使它稍微清楚一点，定义了两个函数<code class="du kb kc kd ke b">to_gke_semver</code>(第7+8行)和<code class="du kb kc kd ke b">from_gke_semver</code>(第9+10行)。从上面的命令输出中，您会看到它产生了形式为<code class="du kb kc kd ke b">1.9.6-gke.1</code>的字符串。这就像一个扩展的semver。我们希望能够对这种类型的字符串进行排序。因此，<code class="du kb kc kd ke b">to_gke_semver</code>将该字符串转换成JSON <code class="du kb kc kd ke b">{“major”:”1", “minor”:”9", “patch”:”6", “gke”:”1"}</code>，然后我们将使用它作为排序的基础。函数<code class="du kb kc kd ke b">from_gke_semver</code>将JSON转换回字符串。</p><p id="d03a" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">我们使用jq的<code class="du kb kc kd ke b">reduce</code>函数(第11行)，它将一个数组作为输入，一个累加器，并依次对每个数组项应用一些函数，通常将结果应用到累加器。在我们的例子中，累加器最初是最低值的GKE·塞弗<code class="du kb kc kd ke b">{“major”:”0", “minor”:”0"….}</code>(第14-19行)。我们的函数将已经转换成JSON semver对象的<code class="du kb kc kd ke b">validMasterVersion</code>(第12行)与累加器进行比较，如果累加器更大，就用item替换累加器。</p><p id="5e73" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">较大的值具有较大的<code class="du kb kc kd ke b">major</code>值。对于具有相同<code class="du kb kc kd ke b">major</code>值的两个semvers，较大的具有较大的<code class="du kb kc kd ke b">minor</code>值，等等。等等。</p><p id="9226" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">最后，我们将最大的<code class="du kb kc kd ke b">validMasterVerson</code>作为JSON对象，并将其转换回字符串(第36行)。这就是<code class="du kb kc kd ke b">${LATEST}</code>的价值。</p><p id="7ef0" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">将上面的脚本片段复制并粘贴到您的shell中。如果像我一样，今天，你会得到:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="32a2" class="kn ko hi ke b fi kp kq l kr ks">echo ${LATEST}<br/>1.9.6-gke.1</span></pre><p id="cf42" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">然后，您可以:</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="067b" class="kn ko hi ke b fi kp kq l kr ks">gcloud beta container clusters create $CLUSTER \<br/>--username="" \<br/>--cluster-version=${LATEST} \<br/>--machine-type=custom-1-4096 \<br/>--image-type=COS \<br/>--num-nodes=1 \<br/>--enable-autorepair \<br/>--enable-autoscaling \<br/>--enable-autoupgrade \<br/>--enable-cloud-logging \<br/>--enable-cloud-monitoring \<br/>--min-nodes=1 \<br/>--max-nodes=2 \<br/>--region=$REGION \<br/>--project=$PROJECT \<br/>--preemptible \<br/>--scopes="<a class="ae ka" href="https://www.googleapis.com/auth/cloud-platform" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/cloud-platform</a>"</span></pre><h2 id="6c78" class="kn ko hi bd kw kx ky kz la lb lc ld le jx lf lg lh jy li lj lk jz ll lm ln lo bi translated">结论</h2><p id="ad56" class="pw-post-body-paragraph ja jb hi jd b je lp ij jg jh lq im jj jx lr jm jn jy ls jq jr jz lt ju jv jw hb bi translated">是的，它看起来过于复杂，但是有更好的方法来确定这个值吗？</p><h2 id="0c7b" class="kn ko hi bd kw kx ky kz la lb lc ld le jx lf lg lh jy li lj lk jz ll lm ln lo bi translated">计算机编程语言</h2><p id="77e6" class="pw-post-body-paragraph ja jb hi jd b je lp ij jg jh lq im jj jx lr jm jn jy ls jq jr jz lt ju jv jw hb bi translated">感谢Sean跳出我的思维定势，提供了Python替代方案:</p><figure class="kf kg kh ki fd kt"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="f145" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">然后，与<code class="du kb kc kd ke b">jq:</code>一样</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="473d" class="kn ko hi ke b fi kp kq l kr ks">LATEST=$(\<br/>  gcloud container get-server-config \<br/>  --region=$REGION \<br/>  --project=$PROJECT \<br/>  --format="json" \<br/>  | python3 python.py) \<br/>&amp;&amp; echo ${LATEST}</span></pre><h2 id="4407" class="kn ko hi bd kw kx ky kz la lb lc ld le jx lf lg lh jy li lj lk jz ll lm ln lo bi translated">戈朗</h2><figure class="kf kg kh ki fd kt"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="6435" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">然后，和<code class="du kb kc kd ke b">jq:</code>一样</p><pre class="kf kg kh ki fd kj ke kk kl aw km bi"><span id="0528" class="kn ko hi ke b fi kp kq l kr ks">LATEST=$(\<br/>  gcloud container get-server-config \<br/>  --region=$REGION \<br/>  --project=$PROJECT \<br/>  --format="json" \<br/>  | go run main.go) \<br/>&amp;&amp; echo ${LATEST}</span></pre><p id="6728" class="pw-post-body-paragraph ja jb hi jd b je jf ij jg jh ji im jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">还是<code class="du kb kc kd ke b">go build</code>吧。</p></div></div>    
</body>
</html>