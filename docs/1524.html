<html>
<head>
<title>Service Account credentials management: how to improve your security posture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">服务帐户凭证管理:如何改善您的安全状况</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/service-account-credentials-management-how-to-improve-your-security-posture-663bca03a52?source=collection_archive---------0-----------------------#2020-07-20">https://medium.com/google-cloud/service-account-credentials-management-how-to-improve-your-security-posture-663bca03a52?source=collection_archive---------0-----------------------#2020-07-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/4723c33d575a7f75ce1ad974d59f93f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/format:webp/1*McdkzR-GACMlvQZ3p9dtPA.png"/></div></figure><h1 id="9427" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">背景</h1><p id="e1a6" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">当你想调用一个API，比如创建一个<a class="ae ki" href="https://cloud.google.com/storage" rel="noopener ugc nofollow" target="_blank"> GCS bucket </a>，你使用你的谷歌云平台(GCP)账户进行授权。那个账户就是你的身份，它有电子邮件地址的格式，就像username@yourdomain.com。如果您有适当的角色/权限，您的通话将会成功。</p><p id="949e" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">服务帐户是应用程序使用的另一种帐户，而不是人类，用来进行授权的API调用。服务帐户也使用一个电子邮件地址来标识它们，格式如下:<em class="ko">sa-name</em>@<em class="ko">project-id</em>. iam . gserviceaccount . com</p><p id="9f95" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">服务帐户与用户帐户在几个方面有所不同，特别是他们不使用密码来验证Google。相反，他们使用公钥和私钥RSA密钥对。与管理密码相比，这似乎很麻烦，但确实是更适合应用程序身份验证的机制。谷歌云负责管理这些密钥的所有细节:生成、轮换、删除、托管。</p><p id="de25" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">但是，在某些情况下，您需要自己管理这些密钥。例如，如果调用Google APIs的应用程序不是在云中的虚拟机上运行，而是在数据中心或笔记本电脑中的机器上运行，那么您需要下载包含私有RSA密钥的相应服务帐户的凭证，以便能够向Google进行身份验证。然后，您负责管理这些凭证并保证它们的安全。这不是一个简单的任务，你应该考虑使用一个秘密管理解决方案，比如<a class="ae ki" href="https://www.vaultproject.io/" rel="noopener ugc nofollow" target="_blank"> HashiCorp Vault </a>。</p><h1 id="d7f9" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">渗漏问题</h1><p id="2269" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">然而，并不是每个公司都有能力使用秘密管理解决方案。即使你使用它，这些凭证仍然有可能被泄露到你公司之外。可能的情况是，这些凭证存储在许多开发人员可以访问的存储库中(希望不是公共的)。或者，您可能需要将这些凭据传递给合作伙伴，从而失去对它们的可见性和控制。</p><p id="6ac1" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">例如，一家公司的常见情况是在内部运行CI/CD管道来部署云基础架构。他们使用高特权服务帐户来创建项目、VPC、虚拟机、防火墙规则和所有类型的资源，通常使用像<a class="ae ki" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>这样的配置工具。供应工具需要服务帐户凭证来调用API。如果凭据泄露，攻击者可以使用它们来访问您的资源和数据，从而使您的业务面临风险。</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es kp"><img src="../Images/f7fbb01362d112378fe83a0f9d161238.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7kUr9sSgJgNDLUftxJ84yA.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">凭据泄漏</figcaption></figure><h1 id="e937" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">降低风险</h1><p id="4915" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">如我所说，一旦你从GCP下载了凭证，你就有责任保证它们安全。尽管如此，如果泄漏风险很高，让您睡不好觉，或者如果您想有一个B计划以防万一，您可以利用Cloud IAM来降低风险并改善您的安全状况。</p><p id="a6e0" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">当然，服务帐户的特权越多，风险就越高。如果你能减少它的权限，你会处于一个更好的境地，因为现在有人访问你的系统并造成损害的风险会更低。但是您仍然需要完全访问权限，那么，如何同时实现这两个目标呢？</p><p id="4af6" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">那是你可以通过<em class="ko">冒充</em>服务账号得到的东西。模拟的想法是使用一个身份A充当另一个身份B，但不能访问B的凭据。这是通过授予身份A获取身份b的访问令牌的能力来实现的。这是我们将授予身份A的唯一权限，每当它想要访问任何资源时，它都必须提供访问令牌。在Google Cloud中，该权限是通过<em class="ko">服务帐户令牌创建者</em>角色授予的。它允许您为Google用来授权API调用的服务帐户创建OAuth2访问令牌(这个角色有更多的权限，我不会在本文中讨论)。</p><p id="67eb" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">让我们以通过Terraform从内部部署云基础架构为例。<em class="ko"> sa-folder@ </em>是一个高特权服务帐户，您可以使用它来访问代表环境(如生产)的文件夹中的资源。其凭据不应离开GCP，因此我们创建了另一个服务帐户<em class="ko"> sa-external@ </em>用于我们的CI/CD。我们授予此服务帐户sa-folder@上的令牌创建者角色:</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es lc"><img src="../Images/8cd4335231db0fdaf7bf05e2c0058c7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hFNjmlsC3zriuDgU03G3ng.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">通过服务帐户令牌创建者角色进行模拟</figcaption></figure><p id="f3ec" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">以下示例显示了如何通过<em class="ko">“g cloud”</em>命令实现这一点:</p><pre class="kq kr ks kt fd ld le lf lg aw lh bi"><span id="f88b" class="li in hi le b fi lj lk l ll lm"># Create the highly privileged service account<br/>$ gcloud iam service-accounts create sa-folder --project ${PROJECT_A_ID}</span><span id="5d6a" class="li in hi le b fi ln lk l ll lm"># Assign roles on production folder. Using just '<em class="ko">owner</em>' for simplicity<br/>$ gcloud resource-manager folders add-iam-policy-binding ${PROD_FOLDER_ID} \<br/> --member=serviceAccount:sa-folder@${PROJECT_A_ID}.iam.gserviceaccount.com \<br/> --role=roles/owner</span><span id="1c62" class="li in hi le b fi ln lk l ll lm"># Create the external service account<br/>$ gcloud iam service-accounts create sa-external --project ${PROJECT_B_ID}</span><span id="2402" class="li in hi le b fi ln lk l ll lm"># Assign '<em class="ko">token creator'</em> role on sa-folder@<br/>$ gcloud iam service-accounts add-iam-policy-binding <a class="ae ki" href="mailto:sa-folder@project-a-282816.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">sa-folder@</a>${PROJECT_A_ID}<a class="ae ki" href="mailto:sa-folder@project-a-282816.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">.iam.gserviceaccount.com</a> \<br/> --project ${PROJECT_A_ID} \<br/> --member=serviceAccount:<a class="ae ki" href="mailto:sa-external@project-b-282816.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">sa-external@</a>${PROJECT_B_ID}<a class="ae ki" href="mailto:sa-external@project-b-282816.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">.iam.gserviceaccount.com</a> \<br/> --role=roles/iam.serviceAccountTokenCreator</span></pre><p id="68d9" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">现在，您可以下载sa-external@的凭据来访问GCP，发出调用以获取sa-folder@的访问令牌。</p><p id="896e" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">你可能会想，这怎么比原来的情况好？仍然可以使用sa-external@来访问资源！当然是，否则我们无法满足自己的要求。然而，现在有了一个间接层，sa-external @不允许直接访问我们项目中的资源，因此任何API调用都将失败，除了为sa-folder@创建令牌。这是除了凭据之外，攻击者需要的另一条信息，增加的间接性将允许我们进行更多的安全控制。</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es lo"><img src="../Images/41bcabea284f1c23b6ca5580aa904290.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qO-KI-CUJXOfNG2y3XPMlQ.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">减轻凭证泄漏</figcaption></figure><p id="3e96" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">的确，这个过程现在有点复杂了。它需要多一个服务帐户和两步授权。然而，增加安全性的好处超过了增加的复杂性。我将在接下来的章节中详细阐述这一点。</p><p id="7f48" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">关于认证的额外步骤，它仅在开始时发生一次，并且软件流程没有实质性改变。例如，Google Terraform提供者包含了这个<a class="ae ki" href="https://www.terraform.io/docs/providers/google/d/datasource_google_service_account_access_token.html" rel="noopener ugc nofollow" target="_blank">特性</a>，并使它非常容易使用。以下代码显示了所需的步骤:</p><ul class=""><li id="5290" class="lp lq hi jm b jn kj jr kk jv lr jz ls kd lt kh lu lv lw lx bi translated">首先，声明一个Terraform <em class="ko">数据源</em>来获取高特权服务帐户sa-folder@的OAuth2访问令牌。该脚本使用sa-external@的凭据运行。</li></ul><pre class="kq kr ks kt fd ld le lf lg aw lh bi"><span id="4de4" class="li in hi le b fi lj lk l ll lm">provider "google" {<br/>  alias = "initial"<br/>}</span><span id="9218" class="li in hi le b fi ln lk l ll lm">data "google_service_account_access_token" "default" {<br/>  provider               <strong class="le hj">=</strong> google.<!-- -->initial<br/>  target_service_account <strong class="le hj">=</strong> "sa-folder@<!-- -->${PROJECT_A_ID}<!-- -->.iam.gserviceaccount.com"<br/>  scopes                 <strong class="le hj">=</strong> ["cloud-platform"]<br/>  lifetime               <strong class="le hj">=</strong> "3600s"<br/>}</span></pre><blockquote class="ly lz ma"><p id="da32" class="jk jl ko jm b jn kj jp jq jr kk jt ju mb kl jx jy mc km kb kc md kn kf kg kh hb bi translated">请注意，令牌是不可刷新的，最长生存期为1小时。</p></blockquote><ul class=""><li id="4dca" class="lp lq hi jm b jn kj jr kk jv lr jz ls kd lt kh lu lv lw lx bi translated">然后使用新的访问令牌定义一个提供者，并使用这个提供者生成任何资源。</li></ul><pre class="kq kr ks kt fd ld le lf lg aw lh bi"><span id="3e33" class="li in hi le b fi lj lk l ll lm">provider "google" {<br/>  access_token <strong class="le hj">=</strong> data.google_service_account_access_token.default.access_token<br/>}</span><span id="a86c" class="li in hi le b fi ln lk l ll lm">resource “google_compute_network” “vpc_network” {<br/>  provider = google<br/>  name  = “vpc-test”<br/>}</span></pre><h1 id="7707" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">审核访问</h1><p id="52e7" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">使用模拟时，审计也得到简化和增强。例如，审核sa-folder@的访问权限意味着您必须审核服务帐户可以访问的每个可能的资源。假设这个服务帐户可以访问多个资源，那么它的日志将会非常多，并且分布在多个项目中。但是，获取服务帐户的访问令牌的API调用会生成审计日志。这样，您就可以很容易地发现何时使用了模拟来访问任何资源，而无需搜索所有项目。来自任何被访问资源的每个审计日志还将包括模拟服务帐户(如果使用了的话),作为身份验证信息的一部分。</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es me"><img src="../Images/066bdb6db49b6293ac15c4122cbdbffd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qeXVKLpOVV-CsehM02DAmg.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">模拟API调用的审核日志</figcaption></figure><p id="d853" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">在某些情况下，此功能可用于增强您的安全性。假设您有几个合作伙伴需要对您的系统进行相同的访问。您可以拥有一个特权服务帐户，并为每个合作伙伴创建模拟服务帐户和相应的凭据。这样，如果其中一个凭据被泄露，您可以准确地指出应该改进其安全控制的特定合作伙伴。此外，通过IAM，您可以禁用该伙伴的模拟权限，而不会影响其他伙伴。获取访问令牌的审计日志包括其他信息，如<em class="ko">调用者IP </em>和<em class="ko">调用者用户代理</em>，因此您可以开发编程解决方案来进一步加强您的安全性。</p><p id="0613" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">如果你试图在不使用模仿的情况下获得类似的结果，你会发现这是多么痛苦。特别是，如果您想为同一个服务帐户创建几个凭据以分发给您的合作伙伴，这是没有用的。每个凭据都有一个密钥标识符，但该密钥id不会记录在审核日志中。</p><h1 id="32d5" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">多一层</h1><p id="a09e" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们已经看到了模拟如何以多种方式帮助降低泄漏风险，同时还改进了凭据管理。我们可以更进一步，在某些情况下，增加另一层安全性。Cloud IAM为您提供了另一种机制，您可以利用这种机制单独或结合模拟来提高您的安全状况:<a class="ae ki" href="https://cloud.google.com/iam/docs/conditions-overview" rel="noopener ugc nofollow" target="_blank"> Cloud IAM Conditions </a>。</p><p id="b22c" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">使用IAM条件，您可以指定条件来对IAM授权实施基于属性的访问控制。这意味着授予资源上的身份的角色可以根据资源的某些属性(如类型)或请求的属性(如发出API调用的IP)进行调整。您可以使用哪些属性取决于谷歌云服务，但支持它们的属性和服务的数量正在增长。</p><p id="7756" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">让我们以在内部运行CI/CD管道为例。您使用sa-folder@上的令牌创建者角色创建了sa-folder@和sa-external@。假设您只在星期一部署到生产环境中，在审查提交的变更并让您的SRE团队为意外事件做好准备之后。在这种情况下，sa-folder@上的sa-external@的永久授权实际上是不需要的，也是不必要的安全风险。但是反复授予和取消访问权限是不实际的。你可以开发一个程序化的解决方案，但是IAM Conditions提供了一个更好的方法。有了它，您可以定义自己的<em class="ko">部署窗口</em>，仅在周一工作时间授予模拟权限:</p><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ca"><img src="../Images/876a3bf2ac51a8d8406ae625ea3c4c0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5ZR2np49Joh-DkmyiIAzZA.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">应用IAM条件创建部署窗口</figcaption></figure><p id="f1c1" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">通过创建此部署窗口，您可以减少攻击者访问您系统的机会。你的SecOps团队会很欣赏这一点，并在周末感到轻松一些。从该窗口进行的任何访问都会生成一个审计日志，您可以对其进行操作。</p><p id="1720" class="pw-post-body-paragraph jk jl hi jm b jn kj jp jq jr kk jt ju jv kl jx jy jz km kb kc kd kn kf kg kh hb bi translated">如果静态部署窗口不符合您的需求，而您需要按需访问，您可以创建一个基于<a class="ae ki" href="https://cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">云功能</a>的解决方案，只需按一下按钮，即可配置IAM条件，在特定时间段内授予临时访问权限。</p><h1 id="2176" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">结论</h1><p id="9480" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">应该避免下载服务帐户的凭证，凭证的管理是一项很难正确完成的危险任务。但有时你别无选择。为了帮助减轻相关的风险，我解释了一些技术和机制，您可以很容易地应用它们来改善您的安全状况。管理秘密要尽职尽责，希望这篇文章对你有帮助！</p></div></div>    
</body>
</html>