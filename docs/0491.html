<html>
<head>
<title>Kubernetes: a story about custom images, packer and sysdig</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:一个关于自定义图像、打包器和sysdig的故事</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/kubernetes-a-story-about-custom-images-packer-and-sysdig-e18ed8d7f403?source=collection_archive---------0-----------------------#2018-01-13">https://medium.com/google-cloud/kubernetes-a-story-about-custom-images-packer-and-sysdig-e18ed8d7f403?source=collection_archive---------0-----------------------#2018-01-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9118" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们刚刚将我们的Kubernetes集群从1.5.2更新到1.9.1。自1.5.2以来，Kubernetes发生了很多变化，但最臭名昭著的，至少对我来说，是Kubernetes授权从<a class="ae jd" href="https://kubernetes.io/docs/admin/authorization/abac/" rel="noopener ugc nofollow" target="_blank"> ABAC </a>(基于属性的访问控制)到<a class="ae jd" href="https://kubernetes.io/docs/admin/authorization/rbac/" rel="noopener ugc nofollow" target="_blank"> RBAC </a>(基于角色的访问控制)。然而，今天我不打算写Kubernetes的授权，我会留到以后再写。今天，我们要用定制的操作系统映像将Kubernetes部署到GCE。</p><p id="6622" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1.5.2中默认的Kubernetes节点操作系统是Debian，但它在某个时候切换到了容器优化操作系统(COS)。在解决了上面提到的授权问题和其他一些小问题之后，我让我们的集群运行在COS上没有任何问题，除了一件事:<a class="ae jd" href="https://sysdig.com/" rel="noopener ugc nofollow" target="_blank"> sysdig </a>。正如GCP文档中所描述的，sysdig目前只在Ubuntu中受支持。COS中sysdig的一个问题是COS不提供构建sysdig内核模块所需的内核头。如果是这种情况，sysdig会尝试下载一个预编译的二进制文件，但是也不行。</p><p id="ee29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那时我意识到我必须使用Ubuntu而不是COS，所以我使用了下面的Kubernetes环境变量:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="a2e5" class="jn jo hi jj b fi jp jq l jr js">export KUBE_OS_DISTRIBUTION=ubuntu<br/>export KUBE_GCE_MASTER_PROJECT=ubuntu-os-cloud<br/>export KUBE_GCE_MASTER_IMAGE=ubuntu-1604-xenial-v20180109<br/>export KUBE_GCE_NODE_PROJECT=ubuntu-os-cloud<br/>export KUBE_GCE_NODE_IMAGE=ubuntu-1604-xenial-v20180109</span></pre><p id="3f8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，这并没有走多远，Kubernetes的部署失败了。我登录到Kubernetes主节点检查了一下，它告诉我:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="372a" class="jn jo hi jj b fi jp jq l jr js">Broken (or in progress) Kubernetes node setup!</span><span id="8e1c" class="jn jo hi jj b fi jt jq l jr js">Check the cluster initialization status using the following commands.</span><span id="6c31" class="jn jo hi jj b fi jt jq l jr js">Master instance:<br/>  - sudo systemctl status kube-master-installation<br/>  - sudo systemctl status kube-master-configuration</span></pre><p id="e51f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行<em class="ju">sudo system CTL status kube-master-installation</em>时我看到python的yaml包不存在。那现在呢。如果我尝试不同的操作系统会怎样？这就是我所做的，我改变了上面提到的Kubernetes变量来使用CoreOS(实际上它现在被称为Container Linux ),但这也很糟糕。Container Linux的问题不是缺少python包，而是最糟糕的是不再支持Container Linux脚本。有趣的是，我刚刚检查了一下，对容器Linux的支持在10小时前就被移除了。</p><p id="1e50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么，GCE Ubuntu镜像有什么问题呢？为了测试另一件事，我试着用Ubuntu启动了一个GKE集群，并且成功了。那时我意识到GCE Ubuntu的图像肯定不同于GKE的图像(现在看来很明显)。GCE one基本上是一个普通的Ubuntu，带有一些GCP特有的东西，比如内核。</p><p id="8230" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一个问题是:我如何在Kubernetes发布之前安装缺失的依赖项？由于我们手动部署Kubernetes，我最初的想法是将其添加到Kubernetes启动脚本中，但事情变得棘手，感觉不太干净。因此，我在GCP slack频道询问，有人(<em class="ju"> mickej </em>)建议建立我自己的定制形象。我不知道该怎么做，但是GCP有很好的关于<a class="ae jd" href="https://cloud.google.com/compute/docs/images/create-delete-deprecate-private-images" rel="noopener ugc nofollow" target="_blank">如何创建自定义图像</a>的文档，实际上它有很好的关于所有事情的文档。我编写了一个脚本来创建一个基于现有映像的映像，并安装Kubernetes缺少的所有依赖项。</p><figure class="je jf jg jh fd jv"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="ce89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的脚本基于现有的GCE Ubuntu映像创建一个新的实例，然后上传另一个脚本(见下文)来执行安装步骤，然后停止实例并基于实例的磁盘创建一个新的映像，最后删除实例。</p><figure class="je jf jg jh fd jv"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="7303" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止一切顺利。此时，我崭新的Kubernetes 1.9.1集群已经启动并运行，除了sysdig。那么，现在怎么办？我检查了sysdig的pod日志，驱动程序正在构建，但由于某种原因，它没有被加载到内核中。在Kubernetes minion中运行<em class="ju"> dmesg </em>向我展示了原因:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="9f27" class="jn jo hi jj b fi jp jq l jr js">[  507.078542] sysdigcloud_probe: failed to find page_fault_user tracepoint<br/>[  507.142649] sysdigcloud_probe: driver loading, sysdigcloud-probe 0.75.0</span></pre><p id="416a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的反应是:这是什么？这些<a class="ae jd" href="https://www.kernel.org/doc/Documentation/trace/tracepoints.txt" rel="noopener ugc nofollow" target="_blank">跟踪点</a>是什么？现在怎么办？我从github克隆了<a class="ae jd" href="https://github.com/draios/sysdig" rel="noopener ugc nofollow" target="_blank"> sysdig repo </a>并寻找<em class="ju"> page_fault_user </em>。代码较新，这些消息有适当的错误处理。所以，我看了看历史，瞧！提交是几个小时前的事了，是由Ubuntu最近的一个变化引起的。但是我是怎么得到的呢？嗯，还记得我的基本Ubuntu镜像的名字吗？<em class="ju">Ubuntu-1604-xenial-v 2018 01 09</em>。我只是被最近的变化所困扰。好消息是sysdig的人非常快，几个小时后sysdig代理0.76.0就出来了。sysdig现在是我们集群的快乐运行公民。</p><p id="d3b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">等等，你不是在标题里提到了<a class="ae jd" href="https://www.packer.io/" rel="noopener ugc nofollow" target="_blank"> packer </a>吗？啊，对了。嗯，在sysdig发现之后，已经是凌晨1:30了，我已经在考虑写一篇关于这一切的文章。有一件事感觉很尴尬；也许有更好的方法来创建自定义图像。我睡着了。</p><p id="380c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">今天早上，一个同事在查看我的合并请求时，说了这样的话:这很酷，但是你有没有考虑过使用packer或类似的工具？我很惭愧，但我对帕克一无所知。快速搜索后，我找到了我真正需要的东西:<a class="ae jd" href="https://www.packer.io/docs/builders/googlecompute.html" rel="noopener ugc nofollow" target="_blank">谷歌计算构建器</a>。在大约30分钟和一些评论之后，我用下面的文件调用packer，替换了<em class="ju"> create-image.sh </em>脚本:</p><figure class="je jf jg jh fd jv"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="f35f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切都结束得很好:我学习了如何创建自定义映像的手动步骤，什么是Linux内核跟踪点，关于packer和其他一些东西。这就是故事的结尾。</p></div></div>    
</body>
</html>