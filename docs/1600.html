<html>
<head>
<title>BigQuery Explained: Querying your Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery解释:查询您的数据</h1>
<blockquote>原文：<a href="https://medium.com/google-cloud/bigquery-explained-querying-your-data-9e017f2714a3?source=collection_archive---------0-----------------------#2020-09-23">https://medium.com/google-cloud/bigquery-explained-querying-your-data-9e017f2714a3?source=collection_archive---------0-----------------------#2020-09-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><blockquote class="im in io"><p id="8a41" class="ip iq ir is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在谷歌云博客上关注BigQuery解释系列<a class="ae jo" href="https://cloud.google.com/blog/topics/developers-practitioners/bigquery-explained-blog-series" rel="noopener ugc nofollow" target="_blank">。有问题或者想聊天？在</a><a class="ae jo" href="https://twitter.com/rajesh_thallam" rel="noopener ugc nofollow" target="_blank">推特</a>或<a class="ae jo" href="https://www.linkedin.com/in/rajeshthallam/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上联系。</p></blockquote></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="639f" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">在之前的BigQuery解释中，我们回顾了<a class="ae jo" rel="noopener" href="/google-cloud/bigquery-explained-overview-357055ecfda3"> BigQuery架构</a>、<a class="ae jo" rel="noopener" href="/google-cloud/bigquery-explained-storage-overview-70cac32251fa">存储管理</a>和<a class="ae jo" rel="noopener" href="/google-cloud/bigquery-explained-data-ingestion-cdc26a588d0">将数据接收到BigQuery </a>。在这篇文章中，我们将介绍使用<a class="ae jo" href="https://en.wikipedia.org/wiki/SQL" rel="noopener ugc nofollow" target="_blank"> SQL </a>在BigQuery中查询数据集，保存和共享查询，创建视图和物化视图。我们开始吧！</p><h1 id="842c" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">标准SQL</h1><p id="fc6e" class="pw-post-body-paragraph ip iq hi is b it kq iv iw ix kr iz ja jp ks jd je jq kt jh ji jr ku jl jm jn hb bi translated">BigQuery支持两种SQL方言:<a class="ae jo" href="https://cloud.google.com/bigquery/sql-reference/index?hl=sv" rel="noopener ugc nofollow" target="_blank">标准SQL </a>和<a class="ae jo" href="https://cloud.google.com/bigquery/query-reference?hl=sv" rel="noopener ugc nofollow" target="_blank">遗留SQL </a>。标准SQL是查询存储在BigQuery中的数据的首选，因为它符合ANSI SQL 2011标准。与传统SQL相比，它还有其他优势，比如针对连接操作的自动谓词下推和对相关子查询的支持。更多信息，请参考<a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/migrating-from-legacy-sql?hl=sv#standard_sql_highlights" rel="noopener ugc nofollow" target="_blank">标准SQL突出显示</a>。</p><p id="02df" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">当您在BigQuery中运行SQL查询时，它会自动创建、调度和运行查询作业。BigQuery以两种模式运行查询作业:<em class="ir">交互式</em>(默认)和<em class="ir">批处理</em>。</p><ul class=""><li id="f21e" class="kv kw hi is b it iu ix iy jp kx jq ky jr kz jn la lb lc ld bi translated"><a class="ae jo" href="https://cloud.google.com/bigquery/docs/running-queries#queries" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> <em class="ir">交互(按需)查询</em> </strong> </a>尽快执行，这些查询计入<a class="ae jo" href="https://cloud.google.com/bigquery/quotas#query_jobs" rel="noopener ugc nofollow" target="_blank">并发率限额和每日限额</a>。</li><li id="748b" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated"><a class="ae jo" href="https://cloud.google.com/bigquery/docs/running-queries#batch" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> <em class="ir">批处理查询</em> </strong> </a>一旦BigQuery共享资源池中有空闲资源，就会排队并启动，这通常发生在几分钟之内。如果BigQuery在24小时内没有启动查询，作业优先级将更改为交互式。批量查询不计入您的并发率限制。它们使用与交互式查询相同的资源。</li></ul><p id="f59c" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">除非另有说明，本文中的查询遵循标准SQL方言，并以交互模式运行。</p><h2 id="6680" class="lj jt hi bd ju lk ll lm jy ln lo lp kc jp lq lr kg jq ls lt kk jr lu lv ko lw bi translated">BigQuery表类型</h2><p id="23c3" class="pw-post-body-paragraph ip iq hi is b it kq iv iw ix kr iz ja jp ks jd je jq kt jh ji jr ku jl jm jn hb bi translated">BigQuery中的每个表都由描述列名、数据类型和其他元数据的模式定义。BigQuery支持以下表类型:</p><figure class="ly lz ma mb fd mc er es paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="er es lx"><img src="../Images/3162452b271e76e923774b294f91d8ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cn4thIDHsL8K4H8vCOuS6w.png"/></div></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">BigQuery表类型</figcaption></figure><h2 id="9e00" class="lj jt hi bd ju lk ll lm jy ln lo lp kc jp lq lr kg jq ls lt kk jr lu lv ko lw bi translated">大查询模式</h2><p id="2f9d" class="pw-post-body-paragraph ip iq hi is b it kq iv iw ix kr iz ja jp ks jd je jq kt jh ji jr ku jl jm jn hb bi translated">在BigQuery中，模式是在表级别定义的，并为数据提供结构。模式描述列定义及其名称、数据类型、描述和模式。</p><ul class=""><li id="bc1b" class="kv kw hi is b it iu ix iy jp kx jq ky jr kz jn la lb lc ld bi translated"><a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types" rel="noopener ugc nofollow" target="_blank">数据类型</a>可以是简单的数据类型，比如整数，也可以是更复杂的，比如<code class="du mn mo mp mq b">ARRAY</code>和<code class="du mn mo mp mq b">STRUCT</code>用于嵌套和重复的值。</li><li id="4f94" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated"><a class="ae jo" href="https://cloud.google.com/bigquery/docs/schemas#modes" rel="noopener ugc nofollow" target="_blank">列模式</a>可以是<code class="du mn mo mp mq b">NULLABLE</code>、<code class="du mn mo mp mq b">REQUIRED</code>或<code class="du mn mo mp mq b">REPEATED</code>。</li></ul><p id="7762" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">将数据加载到表中或创建空表时，会指定表架构。或者，在加载数据时，您可以使用模式<a class="ae jo" href="https://cloud.google.com/bigquery/docs/schema-detect#auto-detect" rel="noopener ugc nofollow" target="_blank">自动检测</a>用于<a class="ae jo" href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-parquet#parquet_schemas" rel="noopener ugc nofollow" target="_blank">自描述源数据格式</a>，例如Avro、Parquet、ORC、Cloud Firestore或Cloud Datastore导出文件。模式可以手动定义<a class="ae jo" href="https://cloud.google.com/bigquery/docs/schemas#manually_specifying_schemas" rel="noopener ugc nofollow" target="_blank">或者在如图所示的</a><a class="ae jo" href="https://cloud.google.com/bigquery/docs/schemas#specifying_a_json_schema_file" rel="noopener ugc nofollow" target="_blank"> JSON文件</a>中定义。</p><pre class="ly lz ma mb fd mr mq ms mt aw mu bi"><span id="f9a1" class="lj jt hi mq b fi mv mw l mx my">[<br/> {<br/>   "description": "[DESCRIPTION]",<br/>   "name": "[NAME]",<br/>   "type": "[TYPE]",<br/>   "mode": "[MODE]"<br/> },<br/> {<br/>   "description": "[DESCRIPTION]",<br/>   "name": "[NAME]",<br/>   "type": "[TYPE]",<br/>   "mode": "[MODE]"<br/> }<br/>]</span></pre><h1 id="713b" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">使用SQL进行分析</h1><p id="d281" class="pw-post-body-paragraph ip iq hi is b it kq iv iw ix kr iz ja jp ks jd je jq kt jh ji jr ku jl jm jn hb bi translated">现在让我们使用SQL分析一个与NCAA篮球比赛和球员相关的公共BigQuery数据集。游戏数据涵盖了自2009年以来的每一场比赛和票房成绩。我们将关注2014赛季肯塔基野猫队和圣母大学战斗爱尔兰队之间的一场具体比赛。这场比赛有一个激动人心的结局。让我们来看看是什么让它如此激动人心！</p><p id="7357" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">在你的<a class="ae jo" href="https://cloud.google.com/bigquery/docs/sandbox" rel="noopener ugc nofollow" target="_blank"> BigQuery沙箱</a>上，从公共数据集中打开<a class="ae jo" href="https://console.cloud.google.com/marketplace/details/ncaa-bb-public/ncaa-basketball" rel="noopener ugc nofollow" target="_blank"> NCAA篮球数据集</a>。单击“查看数据集”按钮，在BigQuery web UI中打开数据集。</p><figure class="ly lz ma mb fd mc er es paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="er es mz"><img src="../Images/244b89e7e67d3bc2f9fade5676dffbec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*blb7tOCWaFatoTBx"/></div></div></figure><p id="340c" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">导航到<code class="du mn mo mp mq b"><strong class="is hj">ncaa_basketball</strong></code>数据集下的表<code class="du mn mo mp mq b"><strong class="is hj">mbb_pbp_sr</strong></code>以查看模式。此表包含2013–2014赛季所有男子篮球比赛的详细信息，表中的每一行代表一场比赛中的单个事件。</p><figure class="ly lz ma mb fd mc er es paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="er es na"><img src="../Images/34a645a3cf989806c1f8bcfd310d96e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Mw2zP8m-M2IeUFWu"/></div></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">导航BigQuery UI</figcaption></figure><p id="2981" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">查看<code class="du mn mo mp mq b"><strong class="is hj">mbb_pbp_sr</strong></code>表的细节部分。大约有400万个游戏事件，总容量大约为3GB。</p><figure class="ly lz ma mb fd mc er es paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="er es nb"><img src="../Images/1dd61a609db1af3af4f11fd94782d4fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mPCrfXHKSgzlZUkN"/></div></div></figure><p id="fb3e" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">让我们运行一个查询来过滤我们感兴趣的游戏的事件。该查询从<code class="du mn mo mp mq b"><strong class="is hj">mbb_pbp_sr</strong></code>表中选择以下列:</p><ul class=""><li id="8d6e" class="kv kw hi is b it iu ix iy jp kx jq ky jr kz jn la lb lc ld bi translated"><code class="du mn mo mp mq b">game_clock</code>:比赛结束前剩余的时间</li><li id="423c" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated"><code class="du mn mo mp mq b">points_scored</code>:在一个事件中得分</li><li id="dd43" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated"><code class="du mn mo mp mq b">team_name</code>:得分队伍名称</li><li id="56c0" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated"><code class="du mn mo mp mq b">event_description</code>:事件描述</li><li id="070a" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated"><code class="du mn mo mp mq b">timestamp</code>:事件发生的时间</li></ul><figure class="ly lz ma mb fd mc"><div class="bz dy l di"><div class="nc nd l"/></div></figure><p id="9aae" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">该查询所做工作的明细:</p><ul class=""><li id="a46f" class="kv kw hi is b it iu ix iy jp kx jq ky jr kz jn la lb lc ld bi translated"><code class="du mn mo mp mq b"><strong class="is hj">SELECT</strong></code>语句检索表中的行和指定的列<code class="du mn mo mp mq b"><strong class="is hj">FROM</strong></code></li><li id="b005" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated"><code class="du mn mo mp mq b"><strong class="is hj">WHERE</strong></code>子句过滤由<code class="du mn mo mp mq b">SELECT</code>返回的行。该查询过滤返回我们感兴趣的特定游戏的行。</li><li id="14a5" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated"><code class="du mn mo mp mq b"><strong class="is hj">ORDER BY</strong> </code>语句控制结果集中各行的顺序。这个查询按照时间戳以降序对来自<code class="du mn mo mp mq b">SELECT</code>的行进行排序。</li><li id="d3b3" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated">最后，<code class="du mn mo mp mq b"><strong class="is hj">LIMIT</strong></code>限制了查询返回的数据量。对行进行排序后，该查询从结果集中返回10个事件。注意，添加<code class="du mn mo mp mq b"><a class="ae jo" href="https://cloud.google.com/bigquery/docs/best-practices-costs#limit_doesn%E2%80%99t_affect_cost" rel="noopener ugc nofollow" target="_blank">LIMIT</a></code> <a class="ae jo" href="https://cloud.google.com/bigquery/docs/best-practices-costs#limit_doesn%E2%80%99t_affect_cost" rel="noopener ugc nofollow" target="_blank">不会减少查询引擎处理的数据量</a>。</li></ul><p id="4cab" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">现在让我们看看结果。</p><figure class="ly lz ma mb fd mc er es paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="er es ne"><img src="../Images/743550b648c77e877a1e5d5ab234de73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PVXEMwTU_ix35CJs"/></div></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">从分析中查询结果</figcaption></figure><p id="19ed" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">从结果来看，在比赛还剩6秒的时候，球员安德鲁·哈里森两罚全中，得了2分。这并不能告诉我们太多，除了在比赛快结束时有得分。</p><p id="eeaa" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi nf translated"><span class="l ng nh ni bm nj nk nl nm nn di"> T </span> <strong class="is hj"> <em class="ir"> ip:避免在查询中使用</em> </strong> <code class="du mn mo mp mq b"><strong class="is hj">SELECT *</strong></code> <strong class="is hj"> <em class="ir">。相反，只查询所需的列。要仅排除某些列，请使用</em> </strong> <code class="du mn mo mp mq b"><a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax#select_except" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">SELECT * EXCEPT</strong></a></code> <strong class="is hj"> <em class="ir">。</em>T24】</strong></p><p id="098b" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">让我们使用<a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/analytic-function-concepts" rel="noopener ugc nofollow" target="_blank">分析(窗口)函数</a>来修改查询，以包括截止到事件时间的每个团队的累积分数总和。分析函数在由窗口定义的一组行上为每一行计算聚合<em class="ir">，而<a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/aggregate_functions" rel="noopener ugc nofollow" target="_blank">聚合函数</a>在一组行上计算单个聚合值。</em></p><p id="ecea" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">运行下面的查询，添加两个新列— <code class="du mn mo mp mq b"><strong class="is hj">wildcats_score</strong></code>和<code class="du mn mo mp mq b"><strong class="is hj">fighting_irish_score</strong></code>，使用<code class="du mn mo mp mq b"><strong class="is hj">points_scored</strong></code>列动态计算。</p><figure class="ly lz ma mb fd mc"><div class="bz dy l di"><div class="nc nd l"/></div></figure><p id="fd50" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">该查询所做工作的明细:</p><ul class=""><li id="dbdd" class="kv kw hi is b it iu ix iy jp kx jq ky jr kz jn la lb lc ld bi translated">计算游戏中每支队伍的累积分数<code class="du mn mo mp mq b"><strong class="is hj">SUM</strong></code>—由<code class="du mn mo mp mq b"><strong class="is hj">CASE</strong></code>语句指定</li><li id="4ca2" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated"><code class="du mn mo mp mq b"><strong class="is hj">SUM</strong></code>是在<code class="du mn mo mp mq b"><strong class="is hj">OVER</strong></code> <strong class="is hj"> </strong>子句内定义的窗口中计算分数</li><li id="8c96" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated"><code class="du mn mo mp mq b"><strong class="is hj">OVER</strong></code>子句引用一个窗口(一组行)来使用<code class="du mn mo mp mq b">SUM</code></li><li id="d19a" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated"><code class="du mn mo mp mq b"><strong class="is hj">ORDER BY</strong></code>是窗口规范的一部分，定义了分区内的排序顺序。该查询按<code class="du mn mo mp mq b">timestamp</code>对行进行排序</li><li id="c0cd" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated">定义从<strong class="is hj"> </strong> <code class="du mn mo mp mq b"><strong class="is hj">UNBOUNDED PRECEDING</strong></code>指定的游戏开始到<code class="du mn mo mp mq b"><strong class="is hj">CURRENT ROW</strong></code>的窗口框架，在此框架上分析函数<code class="du mn mo mp mq b">SUM()</code>被评估。</li></ul><figure class="ly lz ma mb fd mc er es paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="er es no"><img src="../Images/e8facd051c8ca5979191786f8dfd10d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wVXs80Enda-kPPeX"/></div></div></figure><p id="ebd6" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">从结果可以看出比赛是如何结束的。斗志昂扬的爱尔兰队在比赛还剩下4分钟时领先。野猫队的卡尔-安东尼·唐斯在比赛还剩<code class="du mn mo mp mq b"><strong class="is hj">01:12</strong></code>分钟时上篮扳平比分，安德鲁·哈里森在比赛还剩<code class="du mn mo mp mq b"><strong class="is hj">00:06</strong></code>秒时两罚全中，为野猫队的胜利奠定了基础。那真是一场扣人心弦的比赛！</p><p id="bf99" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">除了聚合和分析函数，BigQuery还支持字符串操作、日期/时间、数学函数、JSON提取等函数和操作符，如图所示。</p><figure class="ly lz ma mb fd mc er es paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="er es np"><img src="../Images/756089fa0fba81819230a3d93475e8b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TNOxcPP4ekl6ioab"/></div></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">BigQuery SQL函数</figcaption></figure><p id="621b" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated"><strong class="is hj"> <em class="ir">完整列表请参考</em></strong><a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"><em class="ir">big query SQL函数参考</em> </strong> </a> <strong class="is hj"> <em class="ir">。在接下来的文章中，我们将介绍BigQuery中的其他高级查询特性，如用户定义函数、空间函数等等。</em> </strong></p><h1 id="27ea" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">BigQuery SQL查询的生命</h1><p id="7fe5" class="pw-post-body-paragraph ip iq hi is b it kq iv iw ix kr iz ja jp ks jd je jq kt jh ji jr ku jl jm jn hb bi translated">在运行SQL查询时，它会执行以下操作:</p><ul class=""><li id="dc9c" class="kv kw hi is b it iu ix iy jp kx jq ky jr kz jn la lb lc ld bi translated">一个<a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/rest/v2/jobs/query" rel="noopener ugc nofollow" target="_blank"> QueryJob </a>被提交给BigQuery服务。正如在<a class="ae jo" rel="noopener" href="/google-cloud/bigquery-explained-overview-357055ecfda3#50f0"> BigQuery架构</a>中所回顾的，BigQuery计算与BigQuery存储是分离的，它们被设计为协同工作来组织数据，以使对大型数据集的查询更加高效。</li><li id="16d4" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated">执行的每个查询都被分成几个阶段，然后由工作线程(插槽)处理，并写回Shuffle。Shuffle提供了对工人内部故障的恢复能力，比如说工人在查询处理过程中遇到了问题。</li></ul><figure class="ly lz ma mb fd mc er es paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="er es nq"><img src="../Images/5180db46b428d6e4901529146858b2ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HrPtrpuSwH3N3t3j"/></div></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">BigQuery SQL查询的生命</figcaption></figure><ul class=""><li id="7b90" class="kv kw hi is b it iu ix iy jp kx jq ky jr kz jn la lb lc ld bi translated">BigQuery引擎利用BigQuery的<a class="ae jo" rel="noopener" href="/google-cloud/bigquery-explained-storage-overview-70cac32251fa">列存储格式</a>只扫描所需的列来运行查询。控制成本的最佳实践之一是<a class="ae jo" href="https://cloud.google.com/bigquery/docs/best-practices-costs#avoid_select_" rel="noopener ugc nofollow" target="_blank">只查询您需要的列</a>。</li><li id="5b74" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated">查询执行完成后，查询服务将结果保存到一个临时表中，web UI显示该数据。您还可以请求将结果写入永久表中。</li></ul><h1 id="233c" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">保存和共享查询</h1><h2 id="cc8f" class="lj jt hi bd ju lk ll lm jy ln lo lp kc jp lq lr kg jq ls lt kk jr lu lv ko lw bi translated">保存查询</h2><p id="484a" class="pw-post-body-paragraph ip iq hi is b it kq iv iw ix kr iz ja jp ks jd je jq kt jh ji jr ku jl jm jn hb bi translated">现在您已经运行了SQL查询来执行分析，您将如何保存这些结果呢？BigQuery将所有查询结果写入一个表中。该表由用户明确标识为目的表或临时缓存的结果表。这个临时表存储24小时，所以如果您再次运行完全相同的查询(完全字符串匹配)，并且如果结果没有不同，那么BigQuery将简单地返回一个指向缓存结果的指针。可以从缓存提供服务的查询不会产生任何费用。<em class="ir">参考</em> <a class="ae jo" href="https://cloud.google.com/bigquery/docs/cached-results" rel="noopener ugc nofollow" target="_blank"> <em class="ir">文档</em> </a> <em class="ir">了解查询缓存的限制和例外。</em></p><p id="e6aa" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">您可以从BigQuery UI上的查询历史选项卡中查看缓存的查询结果。该历史包括您向服务提交的所有查询，而不仅仅是通过web UI提交的查询。</p><figure class="ly lz ma mb fd mc er es paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="er es na"><img src="../Images/43c7ebe2b48848652b7df8727776cddd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zCZOUTBVBTSj96n2"/></div></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">查询历史</figcaption></figure><p id="b4df" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">在执行查询时，您可以从<a class="ae jo" href="https://cloud.google.com/bigquery/docs/cached-results" rel="noopener ugc nofollow" target="_blank">查询设置</a>中禁用缓存结果的检索。这需要BigQuery来计算查询结果，这将导致执行查询的费用。这通常用在基准测试场景中，比如在<a class="ae jo" rel="noopener" href="/google-cloud/bigquery-explained-storage-overview-70cac32251fa">前一篇文章</a>中，比较分区表和聚簇表与非分区表的性能。</p><p id="8ded" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">您还可以请求将查询<a class="ae jo" href="https://cloud.google.com/bigquery/docs/writing-results#permanent-table" rel="noopener ugc nofollow" target="_blank">写入目标表</a>。您可以控制何时删除该表。因为目标表是永久的，所以存储结果需要付费。</p><h2 id="dbcb" class="lj jt hi bd ju lk ll lm jy ln lo lp kc jp lq lr kg jq ls lt kk jr lu lv ko lw bi translated">共享查询</h2><p id="8110" class="pw-post-body-paragraph ip iq hi is b it kq iv iw ix kr iz ja jp ks jd je jq kt jh ji jr ku jl jm jn hb bi translated">BigQuery允许您<a class="ae jo" href="https://cloud.google.com/bigquery/docs/saving-sharing-queries#sharing_a_saved_query" rel="noopener ugc nofollow" target="_blank">与他人共享查询</a>。保存查询时，它可以是私有的(只有您可以看到)、在项目级别共享的(项目成员可以看到)或公共的(任何人都可以查看)。</p><p id="7158" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated"><strong class="is hj"> <em class="ir">查看此视频，了解如何在BigQuery中保存和分享您的查询。</em>T12】</strong></p><figure class="ly lz ma mb fd mc"><div class="bz dy l di"><div class="nr nd l"/></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">在BigQuery中保存和共享查询</figcaption></figure><h1 id="d4f2" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">标准视图</h1><p id="4ba4" class="pw-post-body-paragraph ip iq hi is b it kq iv iw ix kr iz ja jp ks jd je jq kt jh ji jr ku jl jm jn hb bi translated">视图是由SQL查询定义的虚拟表。视图具有类似于表的属性，可以作为表进行查询。视图的架构是运行查询产生的架构。视图的查询结果只包含定义视图的查询中指定的表和字段中的数据。</p><p id="4a4e" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">您可以通过使用“保存视图”按钮或使用BigQuery DDL — <code class="du mn mo mp mq b"><a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create_view_statement" rel="noopener ugc nofollow" target="_blank">CREATE VIEW</a></code> <a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create_view_statement" rel="noopener ugc nofollow" target="_blank">语句</a>从BigQuery UI保存查询来<a class="ae jo" href="https://cloud.google.com/bigquery/docs/views#creating_a_view" rel="noopener ugc nofollow" target="_blank">创建视图</a>。将查询保存为视图除了将结果缓存到一个临时表之外，不会将结果持久化，该临时表将在24小时内过期。其行为类似于对表执行的查询。</p><figure class="ly lz ma mb fd mc er es paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="er es ns"><img src="../Images/84470f8e627969073efceb46989629e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aE7RjciAnytAEeov"/></div></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">将查询另存为视图</figcaption></figure><h2 id="e514" class="lj jt hi bd ju lk ll lm jy ln lo lp kc jp lq lr kg jq ls lt kk jr lu lv ko lw bi translated">何时使用标准视图？</h2><ul class=""><li id="6e8b" class="kv kw hi is b it kq ix kr jp nt jq nu jr nv jn la lb lc ld bi translated">假设您想要向用户公开具有复杂逻辑的查询，并且您想要避免用户需要记住逻辑，那么您可以将这些查询滚动到一个视图中。</li><li id="e1de" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated">另一个用例是，视图可以放入数据集中，并提供细粒度的访问控制，以便与特定用户和组共享数据集，而无需授予他们对底层表的访问权限。这些视图被称为<a class="ae jo" href="https://cloud.google.com/bigquery/docs/share-access-views" rel="noopener ugc nofollow" target="_blank">授权视图</a>。我们将在以后的文章中详细研究保护和访问数据集。</li></ul><p id="7809" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated"><strong class="is hj"> <em class="ir">创建和管理标准视图请参考BigQuery </em> </strong> <a class="ae jo" href="https://cloud.google.com/bigquery/docs/views-intro" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> <em class="ir">文档</em> </strong> </a> <strong class="is hj"> <em class="ir">。</em> </strong></p><h1 id="bf9b" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">物化视图</h1><p id="63fb" class="pw-post-body-paragraph ip iq hi is b it kq iv iw ix kr iz ja jp ks jd je jq kt jh ji jr ku jl jm jn hb bi translated">BigQuery支持<a class="ae jo" href="https://en.wikipedia.org/wiki/Materialized_view" rel="noopener ugc nofollow" target="_blank">物化视图</a>(MV)——<em class="ir">一个beta特性</em>。MV是预先计算的视图，定期缓存查询结果以提高性能和效率。与只从基表中检索相同数据的查询相比，使用MV的查询通常速度更快，消耗的资源更少。它们可以显著提高具有常见和重复查询的工作负载的性能。</p><figure class="ly lz ma mb fd mc er es paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="er es na"><img src="../Images/237e492e6873ee6de64e49505c988178.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BV7NEt1b6SZCRJH_"/></div></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">BigQuery物化视图</figcaption></figure><p id="d5e2" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">以下是实体化视图的主要功能:</p><blockquote class="im in io"><p id="b09f" class="ip iq ir is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="hi">零点维护</em> </strong></p></blockquote><ul class=""><li id="c386" class="kv kw hi is b it iu ix iy jp kx jq ky jr kz jn la lb lc ld bi translated">BigQuery利用MV的预计算结果，并尽可能只读取基表中的增量变化来计算最新结果。它自动将数据刷新与基表中的数据更改同步。不需要用户输入。您还可以选择触发<a class="ae jo" href="https://cloud.google.com/bigquery/docs/materialized-views#manual_refresh" rel="noopener ugc nofollow" target="_blank">手动刷新</a>视图来控制刷新作业的成本。</li></ul><blockquote class="im in io"><p id="2abc" class="ip iq ir is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="hi">永远新鲜</em> </strong></p></blockquote><ul class=""><li id="4bdf" class="kv kw hi is b it iu ix iy jp kx jq ky jr kz jn la lb lc ld bi translated">MV始终与源表一致。它们可以被直接查询，也可以被BigQuery优化器用来处理对基表的查询。</li></ul><blockquote class="im in io"><p id="6b4d" class="ip iq ir is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="hi">智能调优</em> </strong></p></blockquote><ul class=""><li id="979e" class="kv kw hi is b it iu ix iy jp kx jq ky jr kz jn la lb lc ld bi translated">MV支持查询重写。如果对源表的查询可以通过查询MV来解决，那么BigQuery会将查询重写(重新路由)到MV，以获得更好的性能和/或效率。</li></ul><p id="a616" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">您使用BigQuery DDL — <code class="du mn mo mp mq b"><a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create_materialized_view_statement" rel="noopener ugc nofollow" target="_blank">CREATE MATERIALIZED VIEW</a></code> <a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create_materialized_view_statement" rel="noopener ugc nofollow" target="_blank">语句</a>创建MV。</p><h2 id="fbfc" class="lj jt hi bd ju lk ll lm jy ln lo lp kc jp lq lr kg jq ls lt kk jr lu lv ko lw bi translated">何时使用物化视图？</h2><ul class=""><li id="59e7" class="kv kw hi is b it kq ix kr jp nt jq nu jr nv jn la lb lc ld bi translated">MV适用于需要查询最新数据，同时通过重用先前计算的结果来减少延迟和成本的情况。MV充当<em class="ir">伪索引</em>，在不更新任何现有工作流的情况下加速对基表的查询。</li></ul><h2 id="d3cd" class="lj jt hi bd ju lk ll lm jy ln lo lp kc jp lq lr kg jq ls lt kk jr lu lv ko lw bi translated">物化视图的局限性</h2><ul class=""><li id="d7db" class="kv kw hi is b it kq ix kr jp nt jq nu jr nv jn la lb lc ld bi translated">在撰写本文时，MV中目前还不支持连接。但是，您可以在查询中利用MV在连接之上进行聚合。这降低了查询的成本和延迟。</li><li id="9afc" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated">MV支持一组有限的聚合函数和受限的SQL。引用物化视图支持的查询模式<a class="ae jo" href="https://cloud.google.com/bigquery/docs/materialized-views#supported_mvs" rel="noopener ugc nofollow" target="_blank"/>..</li></ul><p id="fca7" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated"><strong class="is hj"> <em class="ir">参考BigQuery </em> </strong> <a class="ae jo" href="https://cloud.google.com/bigquery/docs/materialized-views-intro" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> <em class="ir">文档</em> </strong> </a> <strong class="is hj"> <em class="ir">了解如何使用物化视图，以及最佳实践。</em> </strong></p><h1 id="55be" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">接下来呢？</h1><p id="2ce7" class="pw-post-body-paragraph ip iq hi is b it kq iv iw ix kr iz ja jp ks jd je jq kt jh ji jr ku jl jm jn hb bi translated">在这篇文章中，我们回顾了BigQuery中SQL查询的生命周期，使用窗口函数，创建标准和物化视图，保存和共享查询。</p><blockquote class="im in io"><p id="1b09" class="ip iq ir is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">参考文献</strong></p></blockquote><ul class=""><li id="4c7c" class="kv kw hi is b it iu ix iy jp kx jq ky jr kz jn la lb lc ld bi translated"><a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators" rel="noopener ugc nofollow" target="_blank"> BigQuery函数</a>引用</li><li id="8387" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated"><a class="ae jo" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/analytic-function-concepts" rel="noopener ugc nofollow" target="_blank">big query中的分析(窗口)函数</a></li><li id="2ea7" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated">BigQuery [ <a class="ae jo" href="https://cloud.google.com/bigquery/docs/views" rel="noopener ugc nofollow" target="_blank"> Docs </a> ]中的标准视图</li><li id="10a6" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated">BigQuery [ <a class="ae jo" href="https://cloud.google.com/bigquery/docs/materialized-views-intro" rel="noopener ugc nofollow" target="_blank"> Docs </a> ]中的物化视图</li><li id="5068" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated">保存和共享查询[ <a class="ae jo" href="https://www.youtube.com/watch?v=AYmoUQ_lyeg" rel="noopener ugc nofollow" target="_blank">视频</a> ] [ <a class="ae jo" href="https://cloud.google.com/bigquery/docs/saving-sharing-queries" rel="noopener ugc nofollow" target="_blank">文档</a> ]</li><li id="ca53" class="kv kw hi is b it le ix lf jp lg jq lh jr li jn la lb lc ld bi translated">BigQuery <a class="ae jo" href="https://cloud.google.com/bigquery/docs/best-practices-performance-overview" rel="noopener ugc nofollow" target="_blank">查询性能的最佳实践</a></li></ul><blockquote class="im in io"><p id="7606" class="ip iq ir is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">C <strong class="is hj"> odelab </strong></p></blockquote><ul class=""><li id="4e93" class="kv kw hi is b it iu ix iy jp kx jq ky jr kz jn la lb lc ld bi translated">试试这个<a class="ae jo" href="https://codelabs.developers.google.com/codelabs/bigquery-github/index.html" rel="noopener ugc nofollow" target="_blank"> codelab </a>基于Github档案查询大型公共数据集。</li></ul><p id="d2cc" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">在下一篇文章中，我们将深入研究连接，优化连接模式，并用嵌套和重复的数据结构去规范化数据。</p><p id="d04d" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated">敬请关注。感谢您的阅读！有问题或者想聊天？在<a class="ae jo" href="https://twitter.com/rajesh_thallam" rel="noopener ugc nofollow" target="_blank">推特</a>或<a class="ae jo" href="https://www.linkedin.com/in/rajeshthallam/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上找到我。</p><p id="fe34" class="pw-post-body-paragraph ip iq hi is b it iu iv iw ix iy iz ja jp jc jd je jq jg jh ji jr jk jl jm jn hb bi translated"><em class="ir">感谢</em> <a class="ae jo" rel="noopener" href="/@thegrinch"> <em class="ir">尤里</em> </a> <em class="ir">和</em> <a class="ae jo" rel="noopener" href="/@presactlyalicia"> <em class="ir">艾丽西娅·威廉姆斯</em> </a> <em class="ir">对帖子的帮助。</em></p></div></div>    
</body>
</html>